<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/EncoderManager.m</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../awt/shaders.metal.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="MTLClip.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/EncoderManager.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
394       [tiBuf release];
395       _aaDestination = tiBuf.texture;
396 
397       MTLTexturePoolItem *ti = [_mtlc.texturePool getTexture:dest.width
398                                                       height:dest.height
399                                                       format:_aaDestination.pixelFormat
400                                                isMultiSample:YES];
401       [cbw registerPooledTexture:ti];
402       [ti release];
403       ca.texture = ti.texture;
404       ca.resolveTexture = _aaDestination;
405       ca.clearColor = MTLClearColorMake(0.0f, 0.0f, 0.0f, 0.0f);
406       ca.loadAction = MTLLoadActionClear;
407       ca.storeAction = MTLStoreActionMultisampleResolve;
408     } else {
409       ca.texture = dest;
410       ca.loadAction = MTLLoadActionLoad;
411       ca.storeAction = MTLStoreActionStore;
412     }
413 
<span class="line-modified">414     if (_useStencil) {</span>
<span class="line-modified">415       // If you enable stencil testing or stencil writing, the</span>
<span class="line-modified">416       // MTLRenderPassDescriptor must include a stencil attachment.</span>
<span class="line-modified">417       rpd.stencilAttachment.texture = _mtlc.clip.stencilTextureRef;</span>
<span class="line-modified">418       rpd.stencilAttachment.loadAction = MTLLoadActionLoad;</span>
<span class="line-modified">419       rpd.stencilAttachment.storeAction = MTLStoreActionDontCare;</span>
420     }
421 
422     // J2dTraceLn1(J2D_TRACE_VERBOSE, &quot;created render encoder to draw on
423     // tex=%p&quot;, dest);
424     _encoder = [[cbw getCommandBuffer] renderCommandEncoderWithDescriptor:rpd];
425     [rpd release];
426 
427     [_encoderStates reset:dest
428                isDstOpaque:isOpaque
429         isDstPremultiplied:YES
430                       isAA:isAA];
431   }
432 
433   //
434   // 3. update encoder states
435   //
436   [_encoderStates updateEncoder:_encoder
437                           paint:_mtlc.paint
438                       composite:_mtlc.composite
439                       isTexture:isTexture
</pre>
<hr />
<pre>
450 - (id&lt;MTLBlitCommandEncoder&gt; _Nonnull) createBlitEncoder {
451     [self endEncoder];
452     return [[[_mtlc getCommandBufferWrapper] getCommandBuffer] blitCommandEncoder];
453 }
454 
455 - (void) endEncoder {
456     if (_encoder != nil) {
457       [_encoder endEncoding];
458       [_encoder release];
459       _encoder = nil;
460         if (_aaDestination != nil) {
461           id&lt;MTLTexture&gt; aaDest = _aaDestination;
462           _aaDestination = nil;
463           NSUInteger _w = _destination.width;
464           NSUInteger _h = _destination.height;
465           _encoder = [self getTextureEncoder:_destination
466                                  isSrcOpaque:JNI_FALSE
467                                  isDstOpaque:JNI_TRUE
468                                interpolation:INTERPOLATION_NEAREST_NEIGHBOR
469                                         isAA:JNI_TRUE];

470 
471           struct TxtVertex quadTxVerticesBuffer[] = {
472               {{0, 0}, {0, 0}},
473               {{0,_h}, {0, 1}},
474               {{_w, 0},{1, 0}},
475               {{0, _h},{0, 1}},
476               {{_w, _h}, {1, 1}},
477               {{_w, 0}, {1, 0}}
478           };
479 
480           [_encoder setVertexBytes:quadTxVerticesBuffer length:sizeof(quadTxVerticesBuffer) atIndex:MeshVertexBuffer];
481           [_encoder setFragmentTexture:aaDest atIndex: 0];
482           [_encoder drawPrimitives:MTLPrimitiveTypeTriangle vertexStart:0 vertexCount:6];
483           [_encoder endEncoding];
484           [_encoder release];
485         }
486 
487         _encoder = nil;
488         _destination = nil;
489     }
</pre>
</td>
<td>
<hr />
<pre>
394       [tiBuf release];
395       _aaDestination = tiBuf.texture;
396 
397       MTLTexturePoolItem *ti = [_mtlc.texturePool getTexture:dest.width
398                                                       height:dest.height
399                                                       format:_aaDestination.pixelFormat
400                                                isMultiSample:YES];
401       [cbw registerPooledTexture:ti];
402       [ti release];
403       ca.texture = ti.texture;
404       ca.resolveTexture = _aaDestination;
405       ca.clearColor = MTLClearColorMake(0.0f, 0.0f, 0.0f, 0.0f);
406       ca.loadAction = MTLLoadActionClear;
407       ca.storeAction = MTLStoreActionMultisampleResolve;
408     } else {
409       ca.texture = dest;
410       ca.loadAction = MTLLoadActionLoad;
411       ca.storeAction = MTLStoreActionStore;
412     }
413 
<span class="line-modified">414     if (_useStencil &amp;&amp; !isAA) {</span>
<span class="line-modified">415         // If you enable stencil testing or stencil writing, the</span>
<span class="line-modified">416         // MTLRenderPassDescriptor must include a stencil attachment.</span>
<span class="line-modified">417         rpd.stencilAttachment.loadAction = MTLLoadActionLoad;</span>
<span class="line-modified">418         rpd.stencilAttachment.storeAction = MTLStoreActionStore;</span>
<span class="line-modified">419         rpd.stencilAttachment.texture = _mtlc.clip.stencilTextureRef;</span>
420     }
421 
422     // J2dTraceLn1(J2D_TRACE_VERBOSE, &quot;created render encoder to draw on
423     // tex=%p&quot;, dest);
424     _encoder = [[cbw getCommandBuffer] renderCommandEncoderWithDescriptor:rpd];
425     [rpd release];
426 
427     [_encoderStates reset:dest
428                isDstOpaque:isOpaque
429         isDstPremultiplied:YES
430                       isAA:isAA];
431   }
432 
433   //
434   // 3. update encoder states
435   //
436   [_encoderStates updateEncoder:_encoder
437                           paint:_mtlc.paint
438                       composite:_mtlc.composite
439                       isTexture:isTexture
</pre>
<hr />
<pre>
450 - (id&lt;MTLBlitCommandEncoder&gt; _Nonnull) createBlitEncoder {
451     [self endEncoder];
452     return [[[_mtlc getCommandBufferWrapper] getCommandBuffer] blitCommandEncoder];
453 }
454 
455 - (void) endEncoder {
456     if (_encoder != nil) {
457       [_encoder endEncoding];
458       [_encoder release];
459       _encoder = nil;
460         if (_aaDestination != nil) {
461           id&lt;MTLTexture&gt; aaDest = _aaDestination;
462           _aaDestination = nil;
463           NSUInteger _w = _destination.width;
464           NSUInteger _h = _destination.height;
465           _encoder = [self getTextureEncoder:_destination
466                                  isSrcOpaque:JNI_FALSE
467                                  isDstOpaque:JNI_TRUE
468                                interpolation:INTERPOLATION_NEAREST_NEIGHBOR
469                                         isAA:JNI_TRUE];
<span class="line-added">470           [_encoder setFragmentTexture:_mtlc.clip.stencilAADataRef atIndex: 1];</span>
471 
472           struct TxtVertex quadTxVerticesBuffer[] = {
473               {{0, 0}, {0, 0}},
474               {{0,_h}, {0, 1}},
475               {{_w, 0},{1, 0}},
476               {{0, _h},{0, 1}},
477               {{_w, _h}, {1, 1}},
478               {{_w, 0}, {1, 0}}
479           };
480 
481           [_encoder setVertexBytes:quadTxVerticesBuffer length:sizeof(quadTxVerticesBuffer) atIndex:MeshVertexBuffer];
482           [_encoder setFragmentTexture:aaDest atIndex: 0];
483           [_encoder drawPrimitives:MTLPrimitiveTypeTriangle vertexStart:0 vertexCount:6];
484           [_encoder endEncoding];
485           [_encoder release];
486         }
487 
488         _encoder = nil;
489         _destination = nil;
490     }
</pre>
</td>
</tr>
</table>
<center><a href="../../awt/shaders.metal.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="MTLClip.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>