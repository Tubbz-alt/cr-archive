<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLPaints.m</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="MTLComposite.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="MTLPipelineStatesStorage.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLPaints.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #ifndef HEADLESS
 27 
 28 #include &quot;MTLPaints.h&quot;
 29 
 30 #include &quot;MTLClip.h&quot;
 31 
 32 #include &quot;common.h&quot;
 33 
 34 #include &quot;sun_java2d_SunGraphics2D.h&quot;
 35 #include &quot;sun_java2d_pipe_BufferedPaints.h&quot;

 36 
 37 #define RGBA_TO_V4(c)              \
 38 {                                  \
 39     (((c) &gt;&gt; 16) &amp; (0xFF))/255.0f, \
 40     (((c) &gt;&gt; 8) &amp; 0xFF)/255.0f,    \
 41     ((c) &amp; 0xFF)/255.0f,           \
 42     (((c) &gt;&gt; 24) &amp; 0xFF)/255.0f    \
 43 }
 44 
 45 static MTLRenderPipelineDescriptor * templateRenderPipelineDesc = nil;
 46 static MTLRenderPipelineDescriptor * templateTexturePipelineDesc = nil;
 47 static MTLRenderPipelineDescriptor * templateAATexturePipelineDesc = nil;
 48 
 49 static void initTemplatePipelineDescriptors() {
 50     if (templateRenderPipelineDesc != nil &amp;&amp; templateTexturePipelineDesc != nil)
 51         return;
 52 
 53     MTLVertexDescriptor *vertDesc = [[MTLVertexDescriptor new] autorelease];
 54     vertDesc.attributes[VertexAttributePosition].format = MTLVertexFormatFloat2;
 55     vertDesc.attributes[VertexAttributePosition].offset = 0;
</pre>
<hr />
<pre>
297     initTemplatePipelineDescriptors();
298 
299     const bool stencil = isStencilUsed == JNI_TRUE;
300 
301     id&lt;MTLRenderPipelineState&gt; pipelineState = nil;
302     if (isTexture) {
303 
304       if (_paintState == sun_java2d_SunGraphics2D_PAINT_TEXTURE) {
305         pipelineState = [pipelineStateStorage getPipelineState:templateTexturePipelineDesc
306                                                 vertexShaderId:@&quot;vert_txt_tp&quot;
307                                               fragmentShaderId:@&quot;frag_txt_tp&quot;
308                                                  compositeRule:[composite getRule]
309                                                           isAA:JNI_FALSE
310                                                       srcFlags:srcFlags
311                                                       dstFlags:dstFlags
312                                                  stencilNeeded:stencil];
313         [encoder setVertexBytes:&amp;_anchor length:sizeof(_anchor) atIndex:FrameUniformBuffer];
314         [encoder setFragmentTexture:_paintTexture atIndex: 1];
315 
316         struct TxtFrameUniforms uf = {RGBA_TO_V4(0), 0, srcFlags-&gt;isOpaque,
<span class="line-modified">317                                       dstFlags-&gt;isOpaque};</span>
318         [encoder setFragmentBytes:&amp;uf length:sizeof(uf)
319                           atIndex:FrameUniformBuffer];
320 
321       } else if (_paintState == sun_java2d_SunGraphics2D_PAINT_GRADIENT) {
322         pipelineState = [pipelineStateStorage getPipelineState:templateTexturePipelineDesc
323                                                 vertexShaderId:@&quot;vert_txt_grad&quot;
324                                               fragmentShaderId:@&quot;frag_txt_grad&quot;
325                                                  compositeRule:[composite getRule]
326                                                           isAA:JNI_FALSE
327                                                       srcFlags:srcFlags
328                                                       dstFlags:dstFlags
329                                                  stencilNeeded:stencil];
330         struct GradFrameUniforms uf = {
331             {_p0, _p1, _p3},
332             RGBA_TO_V4(_pixel1),
333             RGBA_TO_V4(_pixel2)};
334         [encoder setFragmentBytes: &amp;uf length:sizeof(uf) atIndex:0];
335 
336       } else {
337         if (isAA) {
338           pipelineState = [pipelineStateStorage
339               getPipelineState:templateAATexturePipelineDesc
340                 vertexShaderId:@&quot;vert_txt&quot;
341               fragmentShaderId:@&quot;aa_frag_txt&quot;
342                  compositeRule:[composite getRule]
343                           isAA:JNI_FALSE
344                       srcFlags:srcFlags
345                       dstFlags:dstFlags
346                  stencilNeeded:stencil];
347 
348         } else {
349           pipelineState =
350               [pipelineStateStorage getPipelineState:templateTexturePipelineDesc
351                                       vertexShaderId:@&quot;vert_txt&quot;
352                                     fragmentShaderId:@&quot;frag_txt&quot;
353                                        compositeRule:[composite getRule]

354                                                 isAA:JNI_FALSE
355                                             srcFlags:srcFlags
356                                             dstFlags:dstFlags
357                                        stencilNeeded:stencil];
358         }
359 
360         if (_paintState == sun_java2d_SunGraphics2D_PAINT_ALPHACOLOR) {
<span class="line-modified">361           struct TxtFrameUniforms uf = {RGBA_TO_V4(_color), 1, srcFlags-&gt;isOpaque, dstFlags-&gt;isOpaque };</span>

362           [encoder setFragmentBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
363         } else {
<span class="line-modified">364           struct TxtFrameUniforms uf = {RGBA_TO_V4(0), 0, srcFlags-&gt;isOpaque, dstFlags-&gt;isOpaque };</span>

365           [encoder setFragmentBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
366         }
367       }
368     } else {
369         if (_paintState == sun_java2d_SunGraphics2D_PAINT_ALPHACOLOR) {
370             pipelineState = [pipelineStateStorage getPipelineState:templateRenderPipelineDesc
371                                                     vertexShaderId:@&quot;vert_col&quot;
372                                                   fragmentShaderId:@&quot;frag_col&quot;
373                                                      compositeRule:[composite getRule]
374                                                               isAA:isAA
375                                                           srcFlags:srcFlags
376                                                           dstFlags:dstFlags
377                                                      stencilNeeded:stencil];
378 
379             struct FrameUniforms uf = {RGBA_TO_V4(_color)};
380             [encoder setVertexBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
381         } else if (_paintState == sun_java2d_SunGraphics2D_PAINT_GRADIENT) {
382             pipelineState = [pipelineStateStorage getPipelineState:templateRenderPipelineDesc
383                                                     vertexShaderId:@&quot;vert_grad&quot;
384                                                   fragmentShaderId:@&quot;frag_grad&quot;
</pre>
<hr />
<pre>
420            isStencilUsed:(jboolean)isStencilUsed
421                isTexture:(jboolean)isTexture
422                 srcFlags:(const SurfaceRasterFlags *)srcFlags
423                 dstFlags:(const SurfaceRasterFlags *)dstFlags
424     pipelineStateStorage:(MTLPipelineStatesStorage *)pipelineStateStorage {
425     initTemplatePipelineDescriptors();
426 
427     const bool stencil = isStencilUsed == JNI_TRUE;
428     jint xorColor = (jint) [composite getXorColor];
429 
430     id&lt;MTLRenderPipelineState&gt; pipelineState = nil;
431     if (isTexture) {
432           pipelineState = [pipelineStateStorage getXorModePipelineState:templateTexturePipelineDesc
433                                           vertexShaderId:@&quot;vert_txt&quot;
434                                         fragmentShaderId:@&quot;frag_txt&quot;
435                                                 srcFlags:srcFlags
436                                                 dstFlags:dstFlags
437                                            stencilNeeded:stencil];
438 
439         if (_paintState == sun_java2d_SunGraphics2D_PAINT_ALPHACOLOR) {
<span class="line-modified">440             struct TxtFrameUniforms uf = {RGBA_TO_V4(_color ^ xorColor), 1, srcFlags-&gt;isOpaque, dstFlags-&gt;isOpaque };</span>

441             [encoder setFragmentBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
442         } else {
<span class="line-modified">443             struct TxtFrameUniforms uf = {RGBA_TO_V4(0 ^ xorColor), 0, srcFlags-&gt;isOpaque, dstFlags-&gt;isOpaque };</span>

444             [encoder setFragmentBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
445         }
446         [encoder setFragmentBytes:&amp;xorColor length:sizeof(xorColor) atIndex: 0];
447     } else {
448         if (_paintState == sun_java2d_SunGraphics2D_PAINT_ALPHACOLOR) {
449 
450             pipelineState = [pipelineStateStorage getXorModePipelineState:templateRenderPipelineDesc
451                                         vertexShaderId:@&quot;vert_col&quot;
452                                       fragmentShaderId:@&quot;frag_col&quot;
453                                               srcFlags:srcFlags
454                                               dstFlags:dstFlags
455                                          stencilNeeded:stencil];
456 
457             // Calculate _color ^ xorColor for RGB components
458             // This color gets XORed with destination framebuffer pixel color
459             struct FrameUniforms uf = {RGBA_TO_V4(_color ^ xorColor)};
460             [encoder setVertexBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
461 
462         } else if (_paintState == sun_java2d_SunGraphics2D_PAINT_GRADIENT) {
463 
</pre>
</td>
<td>
<hr />
<pre>
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #ifndef HEADLESS
 27 
 28 #include &quot;MTLPaints.h&quot;
 29 
 30 #include &quot;MTLClip.h&quot;
 31 
 32 #include &quot;common.h&quot;
 33 
 34 #include &quot;sun_java2d_SunGraphics2D.h&quot;
 35 #include &quot;sun_java2d_pipe_BufferedPaints.h&quot;
<span class="line-added"> 36 #import &quot;MTLComposite.h&quot;</span>
 37 
 38 #define RGBA_TO_V4(c)              \
 39 {                                  \
 40     (((c) &gt;&gt; 16) &amp; (0xFF))/255.0f, \
 41     (((c) &gt;&gt; 8) &amp; 0xFF)/255.0f,    \
 42     ((c) &amp; 0xFF)/255.0f,           \
 43     (((c) &gt;&gt; 24) &amp; 0xFF)/255.0f    \
 44 }
 45 
 46 static MTLRenderPipelineDescriptor * templateRenderPipelineDesc = nil;
 47 static MTLRenderPipelineDescriptor * templateTexturePipelineDesc = nil;
 48 static MTLRenderPipelineDescriptor * templateAATexturePipelineDesc = nil;
 49 
 50 static void initTemplatePipelineDescriptors() {
 51     if (templateRenderPipelineDesc != nil &amp;&amp; templateTexturePipelineDesc != nil)
 52         return;
 53 
 54     MTLVertexDescriptor *vertDesc = [[MTLVertexDescriptor new] autorelease];
 55     vertDesc.attributes[VertexAttributePosition].format = MTLVertexFormatFloat2;
 56     vertDesc.attributes[VertexAttributePosition].offset = 0;
</pre>
<hr />
<pre>
298     initTemplatePipelineDescriptors();
299 
300     const bool stencil = isStencilUsed == JNI_TRUE;
301 
302     id&lt;MTLRenderPipelineState&gt; pipelineState = nil;
303     if (isTexture) {
304 
305       if (_paintState == sun_java2d_SunGraphics2D_PAINT_TEXTURE) {
306         pipelineState = [pipelineStateStorage getPipelineState:templateTexturePipelineDesc
307                                                 vertexShaderId:@&quot;vert_txt_tp&quot;
308                                               fragmentShaderId:@&quot;frag_txt_tp&quot;
309                                                  compositeRule:[composite getRule]
310                                                           isAA:JNI_FALSE
311                                                       srcFlags:srcFlags
312                                                       dstFlags:dstFlags
313                                                  stencilNeeded:stencil];
314         [encoder setVertexBytes:&amp;_anchor length:sizeof(_anchor) atIndex:FrameUniformBuffer];
315         [encoder setFragmentTexture:_paintTexture atIndex: 1];
316 
317         struct TxtFrameUniforms uf = {RGBA_TO_V4(0), 0, srcFlags-&gt;isOpaque,
<span class="line-modified">318                                       dstFlags-&gt;isOpaque, [composite getExtraAlpha]};</span>
319         [encoder setFragmentBytes:&amp;uf length:sizeof(uf)
320                           atIndex:FrameUniformBuffer];
321 
322       } else if (_paintState == sun_java2d_SunGraphics2D_PAINT_GRADIENT) {
323         pipelineState = [pipelineStateStorage getPipelineState:templateTexturePipelineDesc
324                                                 vertexShaderId:@&quot;vert_txt_grad&quot;
325                                               fragmentShaderId:@&quot;frag_txt_grad&quot;
326                                                  compositeRule:[composite getRule]
327                                                           isAA:JNI_FALSE
328                                                       srcFlags:srcFlags
329                                                       dstFlags:dstFlags
330                                                  stencilNeeded:stencil];
331         struct GradFrameUniforms uf = {
332             {_p0, _p1, _p3},
333             RGBA_TO_V4(_pixel1),
334             RGBA_TO_V4(_pixel2)};
335         [encoder setFragmentBytes: &amp;uf length:sizeof(uf) atIndex:0];
336 
337       } else {
338         if (isAA) {
339           pipelineState = [pipelineStateStorage
340               getPipelineState:templateAATexturePipelineDesc
341                 vertexShaderId:@&quot;vert_txt&quot;
342               fragmentShaderId:@&quot;aa_frag_txt&quot;
343                  compositeRule:[composite getRule]
344                           isAA:JNI_FALSE
345                       srcFlags:srcFlags
346                       dstFlags:dstFlags
347                  stencilNeeded:stencil];
348 
349         } else {
350           pipelineState =
351               [pipelineStateStorage getPipelineState:templateTexturePipelineDesc
352                                       vertexShaderId:@&quot;vert_txt&quot;
353                                     fragmentShaderId:@&quot;frag_txt&quot;
354                                        compositeRule:[composite getRule]
<span class="line-added">355                                            composite:composite</span>
356                                                 isAA:JNI_FALSE
357                                             srcFlags:srcFlags
358                                             dstFlags:dstFlags
359                                        stencilNeeded:stencil];
360         }
361 
362         if (_paintState == sun_java2d_SunGraphics2D_PAINT_ALPHACOLOR) {
<span class="line-modified">363           struct TxtFrameUniforms uf = {RGBA_TO_V4(_color), 1,</span>
<span class="line-added">364                   srcFlags-&gt;isOpaque, dstFlags-&gt;isOpaque, [composite getExtraAlpha]};</span>
365           [encoder setFragmentBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
366         } else {
<span class="line-modified">367           struct TxtFrameUniforms uf = {RGBA_TO_V4(0), 0,</span>
<span class="line-added">368                   srcFlags-&gt;isOpaque, dstFlags-&gt;isOpaque, [composite getExtraAlpha]};</span>
369           [encoder setFragmentBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
370         }
371       }
372     } else {
373         if (_paintState == sun_java2d_SunGraphics2D_PAINT_ALPHACOLOR) {
374             pipelineState = [pipelineStateStorage getPipelineState:templateRenderPipelineDesc
375                                                     vertexShaderId:@&quot;vert_col&quot;
376                                                   fragmentShaderId:@&quot;frag_col&quot;
377                                                      compositeRule:[composite getRule]
378                                                               isAA:isAA
379                                                           srcFlags:srcFlags
380                                                           dstFlags:dstFlags
381                                                      stencilNeeded:stencil];
382 
383             struct FrameUniforms uf = {RGBA_TO_V4(_color)};
384             [encoder setVertexBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
385         } else if (_paintState == sun_java2d_SunGraphics2D_PAINT_GRADIENT) {
386             pipelineState = [pipelineStateStorage getPipelineState:templateRenderPipelineDesc
387                                                     vertexShaderId:@&quot;vert_grad&quot;
388                                                   fragmentShaderId:@&quot;frag_grad&quot;
</pre>
<hr />
<pre>
424            isStencilUsed:(jboolean)isStencilUsed
425                isTexture:(jboolean)isTexture
426                 srcFlags:(const SurfaceRasterFlags *)srcFlags
427                 dstFlags:(const SurfaceRasterFlags *)dstFlags
428     pipelineStateStorage:(MTLPipelineStatesStorage *)pipelineStateStorage {
429     initTemplatePipelineDescriptors();
430 
431     const bool stencil = isStencilUsed == JNI_TRUE;
432     jint xorColor = (jint) [composite getXorColor];
433 
434     id&lt;MTLRenderPipelineState&gt; pipelineState = nil;
435     if (isTexture) {
436           pipelineState = [pipelineStateStorage getXorModePipelineState:templateTexturePipelineDesc
437                                           vertexShaderId:@&quot;vert_txt&quot;
438                                         fragmentShaderId:@&quot;frag_txt&quot;
439                                                 srcFlags:srcFlags
440                                                 dstFlags:dstFlags
441                                            stencilNeeded:stencil];
442 
443         if (_paintState == sun_java2d_SunGraphics2D_PAINT_ALPHACOLOR) {
<span class="line-modified">444             struct TxtFrameUniforms uf = {RGBA_TO_V4(_color ^ xorColor), 1,</span>
<span class="line-added">445                     srcFlags-&gt;isOpaque, dstFlags-&gt;isOpaque, [composite getExtraAlpha]};</span>
446             [encoder setFragmentBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
447         } else {
<span class="line-modified">448             struct TxtFrameUniforms uf = {RGBA_TO_V4(0 ^ xorColor), 0,</span>
<span class="line-added">449                     srcFlags-&gt;isOpaque, dstFlags-&gt;isOpaque, [composite getExtraAlpha]};</span>
450             [encoder setFragmentBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
451         }
452         [encoder setFragmentBytes:&amp;xorColor length:sizeof(xorColor) atIndex: 0];
453     } else {
454         if (_paintState == sun_java2d_SunGraphics2D_PAINT_ALPHACOLOR) {
455 
456             pipelineState = [pipelineStateStorage getXorModePipelineState:templateRenderPipelineDesc
457                                         vertexShaderId:@&quot;vert_col&quot;
458                                       fragmentShaderId:@&quot;frag_col&quot;
459                                               srcFlags:srcFlags
460                                               dstFlags:dstFlags
461                                          stencilNeeded:stencil];
462 
463             // Calculate _color ^ xorColor for RGB components
464             // This color gets XORed with destination framebuffer pixel color
465             struct FrameUniforms uf = {RGBA_TO_V4(_color ^ xorColor)};
466             [encoder setVertexBytes:&amp;uf length:sizeof(uf) atIndex:FrameUniformBuffer];
467 
468         } else if (_paintState == sun_java2d_SunGraphics2D_PAINT_GRADIENT) {
469 
</pre>
</td>
</tr>
</table>
<center><a href="MTLComposite.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="MTLPipelineStatesStorage.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>