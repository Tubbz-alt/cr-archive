<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/cpu/arm/sharedRuntime_arm.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="macroAssembler_arm.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="stubGenerator_arm.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/arm/sharedRuntime_arm.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 35,10 ***</span>
<span class="line-new-header">--- 35,11 ---</span>
  #include &quot;oops/klass.inline.hpp&quot;
  #include &quot;runtime/sharedRuntime.hpp&quot;
  #include &quot;runtime/safepointMechanism.hpp&quot;
  #include &quot;runtime/vframeArray.hpp&quot;
  #include &quot;utilities/align.hpp&quot;
<span class="line-added">+ #include &quot;utilities/powerOfTwo.hpp&quot;</span>
  #include &quot;vmreg_arm.inline.hpp&quot;
  #ifdef COMPILER1
  #include &quot;c1/c1_Runtime1.hpp&quot;
  #endif
  #ifdef COMPILER2
</pre>
<hr />
<pre>
<span class="line-old-header">*** 131,18 ***</span>
      __ push(RegisterSet(FP) | RegisterSet(LR));
    }
    __ push(SAVED_BASE_REGS);
    if (HaveVFP) {
      if (VM_Version::has_vfp3_32()) {
<span class="line-modified">!       __ fstmdbd(SP, FloatRegisterSet(D16, 16), writeback);</span>
      } else {
        if (FloatRegisterImpl::number_of_registers &gt; 32) {
          assert(FloatRegisterImpl::number_of_registers == 64, &quot;nb fp registers should be 64&quot;);
          __ sub(SP, SP, 32 * wordSize);
        }
      }
<span class="line-modified">!     __ fstmdbd(SP, FloatRegisterSet(D0, 16), writeback);</span>
    } else {
      __ sub(SP, SP, fpu_save_size * wordSize);
    }
  
    int i;
<span class="line-new-header">--- 132,18 ---</span>
      __ push(RegisterSet(FP) | RegisterSet(LR));
    }
    __ push(SAVED_BASE_REGS);
    if (HaveVFP) {
      if (VM_Version::has_vfp3_32()) {
<span class="line-modified">!       __ fpush(FloatRegisterSet(D16, 16));</span>
      } else {
        if (FloatRegisterImpl::number_of_registers &gt; 32) {
          assert(FloatRegisterImpl::number_of_registers == 64, &quot;nb fp registers should be 64&quot;);
          __ sub(SP, SP, 32 * wordSize);
        }
      }
<span class="line-modified">!     __ fpush(FloatRegisterSet(D0, 16));</span>
    } else {
      __ sub(SP, SP, fpu_save_size * wordSize);
    }
  
    int i;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 172,13 ***</span>
    return map;
  }
  
  void RegisterSaver::restore_live_registers(MacroAssembler* masm, bool restore_lr) {
    if (HaveVFP) {
<span class="line-modified">!     __ fldmiad(SP, FloatRegisterSet(D0, 16), writeback);</span>
      if (VM_Version::has_vfp3_32()) {
<span class="line-modified">!       __ fldmiad(SP, FloatRegisterSet(D16, 16), writeback);</span>
      } else {
        if (FloatRegisterImpl::number_of_registers &gt; 32) {
          assert(FloatRegisterImpl::number_of_registers == 64, &quot;nb fp registers should be 64&quot;);
          __ add(SP, SP, 32 * wordSize);
        }
<span class="line-new-header">--- 173,13 ---</span>
    return map;
  }
  
  void RegisterSaver::restore_live_registers(MacroAssembler* masm, bool restore_lr) {
    if (HaveVFP) {
<span class="line-modified">!     __ fpop(FloatRegisterSet(D0, 16));</span>
      if (VM_Version::has_vfp3_32()) {
<span class="line-modified">!       __ fpop(FloatRegisterSet(D16, 16));</span>
      } else {
        if (FloatRegisterImpl::number_of_registers &gt; 32) {
          assert(FloatRegisterImpl::number_of_registers == 64, &quot;nb fp registers should be 64&quot;);
          __ add(SP, SP, 32 * wordSize);
        }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 219,30 ***</span>
  
  static void push_param_registers(MacroAssembler* masm, int fp_regs_in_arguments) {
    // R1-R3 arguments need to be saved, but we push 4 registers for 8-byte alignment
    __ push(RegisterSet(R0, R3));
  
<span class="line-removed">- #ifdef __ABI_HARD__</span>
    // preserve arguments
    // Likely not needed as the locking code won&#39;t probably modify volatile FP registers,
    // but there is no way to guarantee that
    if (fp_regs_in_arguments) {
      // convert fp_regs_in_arguments to a number of double registers
      int double_regs_num = (fp_regs_in_arguments + 1) &gt;&gt; 1;
<span class="line-modified">!     __ fstmdbd(SP, FloatRegisterSet(D0, double_regs_num), writeback);</span>
    }
<span class="line-removed">- #endif // __ ABI_HARD__</span>
  }
  
  static void pop_param_registers(MacroAssembler* masm, int fp_regs_in_arguments) {
<span class="line-removed">- #ifdef __ABI_HARD__</span>
    if (fp_regs_in_arguments) {
      int double_regs_num = (fp_regs_in_arguments + 1) &gt;&gt; 1;
<span class="line-modified">!     __ fldmiad(SP, FloatRegisterSet(D0, double_regs_num), writeback);</span>
    }
<span class="line-removed">- #endif // __ABI_HARD__</span>
<span class="line-removed">- </span>
    __ pop(RegisterSet(R0, R3));
  }
  
  
  
<span class="line-new-header">--- 220,25 ---</span>
  
  static void push_param_registers(MacroAssembler* masm, int fp_regs_in_arguments) {
    // R1-R3 arguments need to be saved, but we push 4 registers for 8-byte alignment
    __ push(RegisterSet(R0, R3));
  
    // preserve arguments
    // Likely not needed as the locking code won&#39;t probably modify volatile FP registers,
    // but there is no way to guarantee that
    if (fp_regs_in_arguments) {
      // convert fp_regs_in_arguments to a number of double registers
      int double_regs_num = (fp_regs_in_arguments + 1) &gt;&gt; 1;
<span class="line-modified">!     __ fpush_hardfp(FloatRegisterSet(D0, double_regs_num));</span>
    }
  }
  
  static void pop_param_registers(MacroAssembler* masm, int fp_regs_in_arguments) {
    if (fp_regs_in_arguments) {
      int double_regs_num = (fp_regs_in_arguments + 1) &gt;&gt; 1;
<span class="line-modified">!     __ fpop_hardfp(FloatRegisterSet(D0, double_regs_num));</span>
    }
    __ pop(RegisterSet(R0, R3));
  }
  
  
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 460,15 ***</span>
<span class="line-new-header">--- 456,17 ---</span>
    __ cbz(Rtemp, skip);
  
    // Pushing an even number of registers for stack alignment.
    // Selecting R9, which had to be saved anyway for some platforms.
    __ push(RegisterSet(R0, R3) | R9 | LR);
<span class="line-added">+   __ fpush_hardfp(FloatRegisterSet(D0, 8));</span>
  
    __ mov(R0, Rmethod);
    __ mov(R1, LR);
    __ call(CAST_FROM_FN_PTR(address, SharedRuntime::fixup_callers_callsite));
  
<span class="line-added">+   __ fpop_hardfp(FloatRegisterSet(D0, 8));</span>
    __ pop(RegisterSet(R0, R3) | R9 | LR);
  
    __ bind(skip);
  }
  
</pre>
<center><a href="macroAssembler_arm.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="stubGenerator_arm.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>