<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/opto/doCall.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciCallSite.hpp&quot;
  27 #include &quot;ci/ciMethodHandle.hpp&quot;
  28 #include &quot;classfile/vmSymbols.hpp&quot;
  29 #include &quot;compiler/compileBroker.hpp&quot;
  30 #include &quot;compiler/compileLog.hpp&quot;
  31 #include &quot;interpreter/linkResolver.hpp&quot;
  32 #include &quot;opto/addnode.hpp&quot;
  33 #include &quot;opto/callGenerator.hpp&quot;
  34 #include &quot;opto/castnode.hpp&quot;
  35 #include &quot;opto/cfgnode.hpp&quot;
  36 #include &quot;opto/mulnode.hpp&quot;
  37 #include &quot;opto/parse.hpp&quot;
  38 #include &quot;opto/rootnode.hpp&quot;
  39 #include &quot;opto/runtime.hpp&quot;
  40 #include &quot;opto/subnode.hpp&quot;
  41 #include &quot;prims/nativeLookup.hpp&quot;
  42 #include &quot;runtime/sharedRuntime.hpp&quot;
  43 
  44 void trace_type_profile(Compile* C, ciMethod *method, int depth, int bci, ciMethod *prof_method, ciKlass *prof_klass, int site_count, int receiver_count) {
  45   if (TraceTypeProfile || C-&gt;print_inlining()) {
  46     outputStream* out = tty;
  47     if (!C-&gt;print_inlining()) {
  48       if (!PrintOpto &amp;&amp; !PrintCompilation) {
  49         method-&gt;print_short_name();
  50         tty-&gt;cr();
  51       }
  52       CompileTask::print_inlining_tty(prof_method, depth, bci);
  53     } else {
  54       out = C-&gt;print_inlining_stream();
  55     }
  56     CompileTask::print_inline_indent(depth, out);
  57     out-&gt;print(&quot; \\-&gt; TypeProfile (%d/%d counts) = &quot;, receiver_count, site_count);
  58     stringStream ss;
  59     prof_klass-&gt;name()-&gt;print_symbol_on(&amp;ss);
  60     out-&gt;print(&quot;%s&quot;, ss.as_string());
  61     out-&gt;cr();
  62   }
  63 }
  64 
  65 CallGenerator* Compile::call_generator(ciMethod* callee, int vtable_index, bool call_does_dispatch,
  66                                        JVMState* jvms, bool allow_inline,
  67                                        float prof_factor, ciKlass* speculative_receiver_type,
  68                                        bool allow_intrinsics, bool delayed_forbidden) {
  69   ciMethod*       caller   = jvms-&gt;method();
  70   int             bci      = jvms-&gt;bci();
  71   Bytecodes::Code bytecode = caller-&gt;java_code_at_bci(bci);
  72   guarantee(callee != NULL, &quot;failed method resolution&quot;);
  73 
  74   // Dtrace currently doesn&#39;t work unless all calls are vanilla
  75   if (env()-&gt;dtrace_method_probes()) {
  76     allow_inline = false;
  77   }
  78 
  79   // Note: When we get profiling during stage-1 compiles, we want to pull
  80   // from more specific profile data which pertains to this inlining.
  81   // Right now, ignore the information in jvms-&gt;caller(), and do method[bci].
  82   ciCallProfile profile = caller-&gt;call_profile_at_bci(bci);
  83 
  84   // See how many times this site has been invoked.
  85   int site_count = profile.count();
  86   int receiver_count = -1;
  87   if (call_does_dispatch &amp;&amp; UseTypeProfile &amp;&amp; profile.has_receiver(0)) {
  88     // Receivers in the profile structure are ordered by call counts
  89     // so that the most called (major) receiver is profile.receiver(0).
  90     receiver_count = profile.receiver_count(0);
  91   }
  92 
  93   CompileLog* log = this-&gt;log();
  94   if (log != NULL) {
  95     int rid = (receiver_count &gt;= 0)? log-&gt;identify(profile.receiver(0)): -1;
  96     int r2id = (rid != -1 &amp;&amp; profile.has_receiver(1))? log-&gt;identify(profile.receiver(1)):-1;
  97     log-&gt;begin_elem(&quot;call method=&#39;%d&#39; count=&#39;%d&#39; prof_factor=&#39;%f&#39;&quot;,
  98                     log-&gt;identify(callee), site_count, prof_factor);
  99     if (call_does_dispatch)  log-&gt;print(&quot; virtual=&#39;1&#39;&quot;);
 100     if (allow_inline)     log-&gt;print(&quot; inline=&#39;1&#39;&quot;);
 101     if (receiver_count &gt;= 0) {
 102       log-&gt;print(&quot; receiver=&#39;%d&#39; receiver_count=&#39;%d&#39;&quot;, rid, receiver_count);
 103       if (profile.has_receiver(1)) {
 104         log-&gt;print(&quot; receiver2=&#39;%d&#39; receiver2_count=&#39;%d&#39;&quot;, r2id, profile.receiver_count(1));
 105       }
 106     }
 107     if (callee-&gt;is_method_handle_intrinsic()) {
 108       log-&gt;print(&quot; method_handle_intrinsic=&#39;1&#39;&quot;);
 109     }
 110     log-&gt;end_elem();
 111   }
 112 
 113   // Special case the handling of certain common, profitable library
 114   // methods.  If these methods are replaced with specialized code,
 115   // then we return it as the inlined version of the call.
 116   // We do this before the strict f.p. check below because the
 117   // intrinsics handle strict f.p. correctly.
 118   CallGenerator* cg_intrinsic = NULL;
 119   if (allow_inline &amp;&amp; allow_intrinsics) {
 120     CallGenerator* cg = find_intrinsic(callee, call_does_dispatch);
 121     if (cg != NULL) {
 122       if (cg-&gt;is_predicated()) {
 123         // Code without intrinsic but, hopefully, inlined.
 124         CallGenerator* inline_cg = this-&gt;call_generator(callee,
 125               vtable_index, call_does_dispatch, jvms, allow_inline, prof_factor, speculative_receiver_type, false);
 126         if (inline_cg != NULL) {
 127           cg = CallGenerator::for_predicated_intrinsic(cg, inline_cg);
 128         }
 129       }
 130 
 131       // If intrinsic does the virtual dispatch, we try to use the type profile
 132       // first, and hopefully inline it as the regular virtual call below.
 133       // We will retry the intrinsic if nothing had claimed it afterwards.
 134       if (cg-&gt;does_virtual_dispatch()) {
 135         cg_intrinsic = cg;
 136         cg = NULL;
 137       } else {
 138         return cg;
 139       }
 140     }
 141   }
 142 
 143   // Do method handle calls.
 144   // NOTE: This must happen before normal inlining logic below since
 145   // MethodHandle.invoke* are native methods which obviously don&#39;t
 146   // have bytecodes and so normal inlining fails.
 147   if (callee-&gt;is_method_handle_intrinsic()) {
 148     CallGenerator* cg = CallGenerator::for_method_handle_call(jvms, caller, callee, delayed_forbidden);
 149     assert(cg == NULL || !delayed_forbidden || !cg-&gt;is_late_inline() || cg-&gt;is_mh_late_inline(), &quot;unexpected CallGenerator&quot;);
 150     return cg;
 151   }
 152 
<a name="1" id="anc1"></a><span class="line-modified"> 153   // Do not inline strict fp into non-strict code, or the reverse</span>
<span class="line-modified"> 154   if (caller-&gt;is_strict() ^ callee-&gt;is_strict()) {</span>

 155     allow_inline = false;
 156   }
 157 
 158   // Attempt to inline...
 159   if (allow_inline) {
 160     // The profile data is only partly attributable to this caller,
 161     // scale back the call site information.
 162     float past_uses = jvms-&gt;method()-&gt;scale_count(site_count, prof_factor);
 163     // This is the number of times we expect the call code to be used.
 164     float expected_uses = past_uses;
 165 
 166     // Try inlining a bytecoded method:
 167     if (!call_does_dispatch) {
 168       InlineTree* ilt = InlineTree::find_subtree_from_root(this-&gt;ilt(), jvms-&gt;caller(), jvms-&gt;method());
 169       WarmCallInfo scratch_ci;
 170       bool should_delay = false;
 171       WarmCallInfo* ci = ilt-&gt;ok_to_inline(callee, jvms, profile, &amp;scratch_ci, should_delay);
 172       assert(ci != &amp;scratch_ci, &quot;do not let this pointer escape&quot;);
 173       bool allow_inline   = (ci != NULL &amp;&amp; !ci-&gt;is_cold());
 174       bool require_inline = (allow_inline &amp;&amp; ci-&gt;is_hot());
 175 
 176       if (allow_inline) {
 177         CallGenerator* cg = CallGenerator::for_inline(callee, expected_uses);
 178 
 179         if (require_inline &amp;&amp; cg != NULL) {
 180           // Delay the inlining of this method to give us the
 181           // opportunity to perform some high level optimizations
 182           // first.
 183           if (should_delay_string_inlining(callee, jvms)) {
 184             assert(!delayed_forbidden, &quot;strange&quot;);
 185             return CallGenerator::for_string_late_inline(callee, cg);
 186           } else if (should_delay_boxing_inlining(callee, jvms)) {
 187             assert(!delayed_forbidden, &quot;strange&quot;);
 188             return CallGenerator::for_boxing_late_inline(callee, cg);
 189           } else if ((should_delay || AlwaysIncrementalInline) &amp;&amp; !delayed_forbidden) {
 190             return CallGenerator::for_late_inline(callee, cg);
 191           }
 192         }
 193         if (cg == NULL || should_delay) {
 194           // Fall through.
 195         } else if (require_inline || !InlineWarmCalls) {
 196           return cg;
 197         } else {
 198           CallGenerator* cold_cg = call_generator(callee, vtable_index, call_does_dispatch, jvms, false, prof_factor);
 199           return CallGenerator::for_warm_call(ci, cold_cg, cg);
 200         }
 201       }
 202     }
 203 
 204     // Try using the type profile.
 205     if (call_does_dispatch &amp;&amp; site_count &gt; 0 &amp;&amp; UseTypeProfile) {
 206       // The major receiver&#39;s count &gt;= TypeProfileMajorReceiverPercent of site_count.
 207       bool have_major_receiver = profile.has_receiver(0) &amp;&amp; (100.*profile.receiver_prob(0) &gt;= (float)TypeProfileMajorReceiverPercent);
 208       ciMethod* receiver_method = NULL;
 209 
 210       int morphism = profile.morphism();
 211       if (speculative_receiver_type != NULL) {
 212         if (!too_many_traps_or_recompiles(caller, bci, Deoptimization::Reason_speculate_class_check)) {
 213           // We have a speculative type, we should be able to resolve
 214           // the call. We do that before looking at the profiling at
 215           // this invoke because it may lead to bimorphic inlining which
 216           // a speculative type should help us avoid.
 217           receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 218                                                    speculative_receiver_type);
 219           if (receiver_method == NULL) {
 220             speculative_receiver_type = NULL;
 221           } else {
 222             morphism = 1;
 223           }
 224         } else {
 225           // speculation failed before. Use profiling at the call
 226           // (could allow bimorphic inlining for instance).
 227           speculative_receiver_type = NULL;
 228         }
 229       }
 230       if (receiver_method == NULL &amp;&amp;
 231           (have_major_receiver || morphism == 1 ||
 232            (morphism == 2 &amp;&amp; UseBimorphicInlining))) {
 233         // receiver_method = profile.method();
 234         // Profiles do not suggest methods now.  Look it up in the major receiver.
 235         receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 236                                                       profile.receiver(0));
 237       }
 238       if (receiver_method != NULL) {
 239         // The single majority receiver sufficiently outweighs the minority.
 240         CallGenerator* hit_cg = this-&gt;call_generator(receiver_method,
 241               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 242         if (hit_cg != NULL) {
 243           // Look up second receiver.
 244           CallGenerator* next_hit_cg = NULL;
 245           ciMethod* next_receiver_method = NULL;
 246           if (morphism == 2 &amp;&amp; UseBimorphicInlining) {
 247             next_receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 248                                                                profile.receiver(1));
 249             if (next_receiver_method != NULL) {
 250               next_hit_cg = this-&gt;call_generator(next_receiver_method,
 251                                   vtable_index, !call_does_dispatch, jvms,
 252                                   allow_inline, prof_factor);
 253               if (next_hit_cg != NULL &amp;&amp; !next_hit_cg-&gt;is_inline() &amp;&amp;
 254                   have_major_receiver &amp;&amp; UseOnlyInlinedBimorphic) {
 255                   // Skip if we can&#39;t inline second receiver&#39;s method
 256                   next_hit_cg = NULL;
 257               }
 258             }
 259           }
 260           CallGenerator* miss_cg;
 261           Deoptimization::DeoptReason reason = (morphism == 2
 262                                                ? Deoptimization::Reason_bimorphic
 263                                                : Deoptimization::reason_class_check(speculative_receiver_type != NULL));
 264           if ((morphism == 1 || (morphism == 2 &amp;&amp; next_hit_cg != NULL)) &amp;&amp;
 265               !too_many_traps_or_recompiles(caller, bci, reason)
 266              ) {
 267             // Generate uncommon trap for class check failure path
 268             // in case of monomorphic or bimorphic virtual call site.
 269             miss_cg = CallGenerator::for_uncommon_trap(callee, reason,
 270                         Deoptimization::Action_maybe_recompile);
 271           } else {
 272             // Generate virtual call for class check failure path
 273             // in case of polymorphic virtual call site.
 274             miss_cg = CallGenerator::for_virtual_call(callee, vtable_index);
 275           }
 276           if (miss_cg != NULL) {
 277             if (next_hit_cg != NULL) {
 278               assert(speculative_receiver_type == NULL, &quot;shouldn&#39;t end up here if we used speculation&quot;);
 279               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), next_receiver_method, profile.receiver(1), site_count, profile.receiver_count(1));
 280               // We don&#39;t need to record dependency on a receiver here and below.
 281               // Whenever we inline, the dependency is added by Parse::Parse().
 282               miss_cg = CallGenerator::for_predicted_call(profile.receiver(1), miss_cg, next_hit_cg, PROB_MAX);
 283             }
 284             if (miss_cg != NULL) {
 285               ciKlass* k = speculative_receiver_type != NULL ? speculative_receiver_type : profile.receiver(0);
 286               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), receiver_method, k, site_count, receiver_count);
 287               float hit_prob = speculative_receiver_type != NULL ? 1.0 : profile.receiver_prob(0);
 288               CallGenerator* cg = CallGenerator::for_predicted_call(k, miss_cg, hit_cg, hit_prob);
 289               if (cg != NULL)  return cg;
 290             }
 291           }
 292         }
 293       }
 294     }
 295 
 296     // If there is only one implementor of this interface then we
 297     // may be able to bind this invoke directly to the implementing
 298     // klass but we need both a dependence on the single interface
 299     // and on the method we bind to. Additionally since all we know
 300     // about the receiver type is that it&#39;s supposed to implement the
 301     // interface we have to insert a check that it&#39;s the class we
 302     // expect.  Interface types are not checked by the verifier so
 303     // they are roughly equivalent to Object.
 304     // The number of implementors for declared_interface is less or
 305     // equal to the number of implementors for target-&gt;holder() so
 306     // if number of implementors of target-&gt;holder() == 1 then
 307     // number of implementors for decl_interface is 0 or 1. If
 308     // it&#39;s 0 then no class implements decl_interface and there&#39;s
 309     // no point in inlining.
 310     if (call_does_dispatch &amp;&amp; bytecode == Bytecodes::_invokeinterface) {
 311       ciInstanceKlass* declared_interface =
 312           caller-&gt;get_declared_method_holder_at_bci(bci)-&gt;as_instance_klass();
 313       ciInstanceKlass* singleton = declared_interface-&gt;unique_implementor();
 314 
 315       if (singleton != NULL &amp;&amp;
 316           (!callee-&gt;is_default_method() || callee-&gt;is_overpass()) /* CHA doesn&#39;t support default methods yet */) {
 317         assert(singleton != declared_interface, &quot;not a unique implementor&quot;);
 318 
 319         ciMethod* cha_monomorphic_target =
 320             callee-&gt;find_monomorphic_target(caller-&gt;holder(), declared_interface, singleton);
 321 
 322         if (cha_monomorphic_target != NULL &amp;&amp;
 323             cha_monomorphic_target-&gt;holder() != env()-&gt;Object_klass()) { // subtype check against Object is useless
 324           ciKlass* holder = cha_monomorphic_target-&gt;holder();
 325 
 326           // Try to inline the method found by CHA. Inlined method is guarded by the type check.
 327           CallGenerator* hit_cg = call_generator(cha_monomorphic_target,
 328               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 329 
 330           // Deoptimize on type check fail. The interpreter will throw ICCE for us.
 331           CallGenerator* miss_cg = CallGenerator::for_uncommon_trap(callee,
 332               Deoptimization::Reason_class_check, Deoptimization::Action_none);
 333 
 334           CallGenerator* cg = CallGenerator::for_guarded_call(holder, miss_cg, hit_cg);
 335           if (hit_cg != NULL &amp;&amp; cg != NULL) {
 336             dependencies()-&gt;assert_unique_concrete_method(declared_interface, cha_monomorphic_target);
 337             return cg;
 338           }
 339         }
 340       }
 341     }
 342   }
 343 
 344   // Nothing claimed the intrinsic, we go with straight-forward inlining
 345   // for already discovered intrinsic.
 346   if (allow_inline &amp;&amp; allow_intrinsics &amp;&amp; cg_intrinsic != NULL) {
 347     assert(cg_intrinsic-&gt;does_virtual_dispatch(), &quot;sanity&quot;);
 348     return cg_intrinsic;
 349   }
 350 
 351   // There was no special inlining tactic, or it bailed out.
 352   // Use a more generic tactic, like a simple call.
 353   if (call_does_dispatch) {
 354     const char* msg = &quot;virtual call&quot;;
 355     if (PrintInlining) print_inlining(callee, jvms-&gt;depth() - 1, jvms-&gt;bci(), msg);
 356     C-&gt;log_inline_failure(msg);
 357     return CallGenerator::for_virtual_call(callee, vtable_index);
 358   } else {
 359     // Class Hierarchy Analysis or Type Profile reveals a unique target,
 360     // or it is a static or special call.
 361     return CallGenerator::for_direct_call(callee, should_delay_inlining(callee, jvms));
 362   }
 363 }
 364 
 365 // Return true for methods that shouldn&#39;t be inlined early so that
 366 // they are easier to analyze and optimize as intrinsics.
 367 bool Compile::should_delay_string_inlining(ciMethod* call_method, JVMState* jvms) {
 368   if (has_stringbuilder()) {
 369 
 370     if ((call_method-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 371          call_method-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass()) &amp;&amp;
 372         (jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 373          jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass())) {
 374       // Delay SB calls only when called from non-SB code
 375       return false;
 376     }
 377 
 378     switch (call_method-&gt;intrinsic_id()) {
 379       case vmIntrinsics::_StringBuilder_void:
 380       case vmIntrinsics::_StringBuilder_int:
 381       case vmIntrinsics::_StringBuilder_String:
 382       case vmIntrinsics::_StringBuilder_append_char:
 383       case vmIntrinsics::_StringBuilder_append_int:
 384       case vmIntrinsics::_StringBuilder_append_String:
 385       case vmIntrinsics::_StringBuilder_toString:
 386       case vmIntrinsics::_StringBuffer_void:
 387       case vmIntrinsics::_StringBuffer_int:
 388       case vmIntrinsics::_StringBuffer_String:
 389       case vmIntrinsics::_StringBuffer_append_char:
 390       case vmIntrinsics::_StringBuffer_append_int:
 391       case vmIntrinsics::_StringBuffer_append_String:
 392       case vmIntrinsics::_StringBuffer_toString:
 393       case vmIntrinsics::_Integer_toString:
 394         return true;
 395 
 396       case vmIntrinsics::_String_String:
 397         {
 398           Node* receiver = jvms-&gt;map()-&gt;in(jvms-&gt;argoff() + 1);
 399           if (receiver-&gt;is_Proj() &amp;&amp; receiver-&gt;in(0)-&gt;is_CallStaticJava()) {
 400             CallStaticJavaNode* csj = receiver-&gt;in(0)-&gt;as_CallStaticJava();
 401             ciMethod* m = csj-&gt;method();
 402             if (m != NULL &amp;&amp;
 403                 (m-&gt;intrinsic_id() == vmIntrinsics::_StringBuffer_toString ||
 404                  m-&gt;intrinsic_id() == vmIntrinsics::_StringBuilder_toString))
 405               // Delay String.&lt;init&gt;(new SB())
 406               return true;
 407           }
 408           return false;
 409         }
 410 
 411       default:
 412         return false;
 413     }
 414   }
 415   return false;
 416 }
 417 
 418 bool Compile::should_delay_boxing_inlining(ciMethod* call_method, JVMState* jvms) {
 419   if (eliminate_boxing() &amp;&amp; call_method-&gt;is_boxing_method()) {
 420     set_has_boxed_value(true);
 421     return aggressive_unboxing();
 422   }
 423   return false;
 424 }
 425 
 426 // uncommon-trap call-sites where callee is unloaded, uninitialized or will not link
 427 bool Parse::can_not_compile_call_site(ciMethod *dest_method, ciInstanceKlass* klass) {
 428   // Additional inputs to consider...
 429   // bc      = bc()
 430   // caller  = method()
 431   // iter().get_method_holder_index()
 432   assert( dest_method-&gt;is_loaded(), &quot;ciTypeFlow should not let us get here&quot; );
 433   // Interface classes can be loaded &amp; linked and never get around to
 434   // being initialized.  Uncommon-trap for not-initialized static or
 435   // v-calls.  Let interface calls happen.
 436   ciInstanceKlass* holder_klass = dest_method-&gt;holder();
 437   if (!holder_klass-&gt;is_being_initialized() &amp;&amp;
 438       !holder_klass-&gt;is_initialized() &amp;&amp;
 439       !holder_klass-&gt;is_interface()) {
 440     uncommon_trap(Deoptimization::Reason_uninitialized,
 441                   Deoptimization::Action_reinterpret,
 442                   holder_klass);
 443     return true;
 444   }
 445 
 446   assert(dest_method-&gt;is_loaded(), &quot;dest_method: typeflow responsibility&quot;);
 447   return false;
 448 }
 449 
 450 #ifdef ASSERT
 451 static bool check_call_consistency(JVMState* jvms, CallGenerator* cg) {
 452   ciMethod* symbolic_info = jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci());
 453   ciMethod* resolved_method = cg-&gt;method();
 454   if (!ciMethod::is_consistent_info(symbolic_info, resolved_method)) {
 455     tty-&gt;print_cr(&quot;JVMS:&quot;);
 456     jvms-&gt;dump();
 457     tty-&gt;print_cr(&quot;Bytecode info:&quot;);
 458     jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci())-&gt;print(); tty-&gt;cr();
 459     tty-&gt;print_cr(&quot;Resolved method:&quot;);
 460     cg-&gt;method()-&gt;print(); tty-&gt;cr();
 461     return false;
 462   }
 463   return true;
 464 }
 465 #endif // ASSERT
 466 
 467 //------------------------------do_call----------------------------------------
 468 // Handle your basic call.  Inline if we can &amp; want to, else just setup call.
 469 void Parse::do_call() {
 470   // It&#39;s likely we are going to add debug info soon.
 471   // Also, if we inline a guy who eventually needs debug info for this JVMS,
 472   // our contribution to it is cleaned up right here.
 473   kill_dead_locals();
 474 
 475   C-&gt;print_inlining_assert_ready();
 476 
 477   // Set frequently used booleans
 478   const bool is_virtual = bc() == Bytecodes::_invokevirtual;
 479   const bool is_virtual_or_interface = is_virtual || bc() == Bytecodes::_invokeinterface;
 480   const bool has_receiver = Bytecodes::has_receiver(bc());
 481 
 482   // Find target being called
 483   bool             will_link;
 484   ciSignature*     declared_signature = NULL;
 485   ciMethod*        orig_callee  = iter().get_method(will_link, &amp;declared_signature);  // callee in the bytecode
 486   ciInstanceKlass* holder_klass = orig_callee-&gt;holder();
 487   ciKlass*         holder       = iter().get_declared_method_holder();
 488   ciInstanceKlass* klass = ciEnv::get_instance_klass_for_declared_method_holder(holder);
 489   assert(declared_signature != NULL, &quot;cannot be null&quot;);
 490 
 491   // Bump max node limit for JSR292 users
 492   if (bc() == Bytecodes::_invokedynamic || orig_callee-&gt;is_method_handle_intrinsic()) {
 493     C-&gt;set_max_node_limit(3*MaxNodeLimit);
 494   }
 495 
 496   // uncommon-trap when callee is unloaded, uninitialized or will not link
 497   // bailout when too many arguments for register representation
 498   if (!will_link || can_not_compile_call_site(orig_callee, klass)) {
 499     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 500       method()-&gt;print_name(); tty-&gt;print_cr(&quot; can not compile call at bci %d to:&quot;, bci());
 501       orig_callee-&gt;print_name(); tty-&gt;cr();
 502     }
 503     return;
 504   }
 505   assert(holder_klass-&gt;is_loaded(), &quot;&quot;);
 506   //assert((bc_callee-&gt;is_static() || is_invokedynamic) == !has_receiver , &quot;must match bc&quot;);  // XXX invokehandle (cur_bc_raw)
 507   // Note: this takes into account invokeinterface of methods declared in java/lang/Object,
 508   // which should be invokevirtuals but according to the VM spec may be invokeinterfaces
 509   assert(holder_klass-&gt;is_interface() || holder_klass-&gt;super() == NULL || (bc() != Bytecodes::_invokeinterface), &quot;must match bc&quot;);
 510   // Note:  In the absence of miranda methods, an abstract class K can perform
 511   // an invokevirtual directly on an interface method I.m if K implements I.
 512 
 513   // orig_callee is the resolved callee which&#39;s signature includes the
 514   // appendix argument.
 515   const int nargs = orig_callee-&gt;arg_size();
 516   const bool is_signature_polymorphic = MethodHandles::is_signature_polymorphic(orig_callee-&gt;intrinsic_id());
 517 
 518   // Push appendix argument (MethodType, CallSite, etc.), if one.
 519   if (iter().has_appendix()) {
 520     ciObject* appendix_arg = iter().get_appendix();
 521     const TypeOopPtr* appendix_arg_type = TypeOopPtr::make_from_constant(appendix_arg, /* require_const= */ true);
 522     Node* appendix_arg_node = _gvn.makecon(appendix_arg_type);
 523     push(appendix_arg_node);
 524   }
 525 
 526   // ---------------------
 527   // Does Class Hierarchy Analysis reveal only a single target of a v-call?
 528   // Then we may inline or make a static call, but become dependent on there being only 1 target.
 529   // Does the call-site type profile reveal only one receiver?
 530   // Then we may introduce a run-time check and inline on the path where it succeeds.
 531   // The other path may uncommon_trap, check for another receiver, or do a v-call.
 532 
 533   // Try to get the most accurate receiver type
 534   ciMethod* callee             = orig_callee;
 535   int       vtable_index       = Method::invalid_vtable_index;
 536   bool      call_does_dispatch = false;
 537 
 538   // Speculative type of the receiver if any
 539   ciKlass* speculative_receiver_type = NULL;
 540   if (is_virtual_or_interface) {
 541     Node* receiver_node             = stack(sp() - nargs);
 542     const TypeOopPtr* receiver_type = _gvn.type(receiver_node)-&gt;isa_oopptr();
 543     // call_does_dispatch and vtable_index are out-parameters.  They might be changed.
 544     // For arrays, klass below is Object. When vtable calls are used,
 545     // resolving the call with Object would allow an illegal call to
 546     // finalize() on an array. We use holder instead: illegal calls to
 547     // finalize() won&#39;t be compiled as vtable calls (IC call
 548     // resolution will catch the illegal call) and the few legal calls
 549     // on array types won&#39;t be either.
 550     callee = C-&gt;optimize_virtual_call(method(), bci(), klass, holder, orig_callee,
 551                                       receiver_type, is_virtual,
 552                                       call_does_dispatch, vtable_index);  // out-parameters
 553     speculative_receiver_type = receiver_type != NULL ? receiver_type-&gt;speculative_type() : NULL;
 554   }
 555 
 556   // Additional receiver subtype checks for interface calls via invokespecial or invokeinterface.
 557   ciKlass* receiver_constraint = NULL;
 558   if (iter().cur_bc_raw() == Bytecodes::_invokespecial &amp;&amp; !orig_callee-&gt;is_object_initializer()) {
 559     ciInstanceKlass* calling_klass = method()-&gt;holder();
 560     ciInstanceKlass* sender_klass =
 561         calling_klass-&gt;is_unsafe_anonymous() ? calling_klass-&gt;unsafe_anonymous_host() :
 562                                                calling_klass;
 563     if (sender_klass-&gt;is_interface()) {
 564       receiver_constraint = sender_klass;
 565     }
 566   } else if (iter().cur_bc_raw() == Bytecodes::_invokeinterface &amp;&amp; orig_callee-&gt;is_private()) {
 567     assert(holder-&gt;is_interface(), &quot;How did we get a non-interface method here!&quot;);
 568     receiver_constraint = holder;
 569   }
 570 
 571   if (receiver_constraint != NULL) {
 572     Node* receiver_node = stack(sp() - nargs);
 573     Node* cls_node = makecon(TypeKlassPtr::make(receiver_constraint));
 574     Node* bad_type_ctrl = NULL;
 575     Node* casted_receiver = gen_checkcast(receiver_node, cls_node, &amp;bad_type_ctrl);
 576     if (bad_type_ctrl != NULL) {
 577       PreserveJVMState pjvms(this);
 578       set_control(bad_type_ctrl);
 579       uncommon_trap(Deoptimization::Reason_class_check,
 580                     Deoptimization::Action_none);
 581     }
 582     if (stopped()) {
 583       return; // MUST uncommon-trap?
 584     }
 585     set_stack(sp() - nargs, casted_receiver);
 586   }
 587 
 588   // Note:  It&#39;s OK to try to inline a virtual call.
 589   // The call generator will not attempt to inline a polymorphic call
 590   // unless it knows how to optimize the receiver dispatch.
 591   bool try_inline = (C-&gt;do_inlining() || InlineAccessors);
 592 
 593   // ---------------------
 594   dec_sp(nargs);              // Temporarily pop args for JVM state of call
 595   JVMState* jvms = sync_jvms();
 596 
 597   // ---------------------
 598   // Decide call tactic.
 599   // This call checks with CHA, the interpreter profile, intrinsics table, etc.
 600   // It decides whether inlining is desirable or not.
 601   CallGenerator* cg = C-&gt;call_generator(callee, vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type);
 602 
 603   // NOTE:  Don&#39;t use orig_callee and callee after this point!  Use cg-&gt;method() instead.
 604   orig_callee = callee = NULL;
 605 
 606   // ---------------------
 607   // Round double arguments before call
 608   round_double_arguments(cg-&gt;method());
 609 
 610   // Feed profiling data for arguments to the type system so it can
 611   // propagate it as speculative types
 612   record_profiled_arguments_for_speculation(cg-&gt;method(), bc());
 613 
 614 #ifndef PRODUCT
 615   // bump global counters for calls
 616   count_compiled_calls(/*at_method_entry*/ false, cg-&gt;is_inline());
 617 
 618   // Record first part of parsing work for this call
 619   parse_histogram()-&gt;record_change();
 620 #endif // not PRODUCT
 621 
 622   assert(jvms == this-&gt;jvms(), &quot;still operating on the right JVMS&quot;);
 623   assert(jvms_in_sync(),       &quot;jvms must carry full info into CG&quot;);
 624 
 625   // save across call, for a subsequent cast_not_null.
 626   Node* receiver = has_receiver ? argument(0) : NULL;
 627 
 628   // The extra CheckCastPPs for speculative types mess with PhaseStringOpts
 629   if (receiver != NULL &amp;&amp; !call_does_dispatch &amp;&amp; !cg-&gt;is_string_late_inline()) {
 630     // Feed profiling data for a single receiver to the type system so
 631     // it can propagate it as a speculative type
 632     receiver = record_profiled_receiver_for_speculation(receiver);
 633   }
 634 
 635   // Bump method data counters (We profile *before* the call is made
 636   // because exceptions don&#39;t return to the call site.)
 637   profile_call(receiver);
 638 
 639   JVMState* new_jvms = cg-&gt;generate(jvms);
 640   if (new_jvms == NULL) {
 641     // When inlining attempt fails (e.g., too many arguments),
 642     // it may contaminate the current compile state, making it
 643     // impossible to pull back and try again.  Once we call
 644     // cg-&gt;generate(), we are committed.  If it fails, the whole
 645     // compilation task is compromised.
 646     if (failing())  return;
 647 
 648     // This can happen if a library intrinsic is available, but refuses
 649     // the call site, perhaps because it did not match a pattern the
 650     // intrinsic was expecting to optimize. Should always be possible to
 651     // get a normal java call that may inline in that case
 652     cg = C-&gt;call_generator(cg-&gt;method(), vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type, /* allow_intrinsics= */ false);
 653     new_jvms = cg-&gt;generate(jvms);
 654     if (new_jvms == NULL) {
 655       guarantee(failing(), &quot;call failed to generate:  calls should work&quot;);
 656       return;
 657     }
 658   }
 659 
 660   if (cg-&gt;is_inline()) {
 661     // Accumulate has_loops estimate
 662     C-&gt;set_has_loops(C-&gt;has_loops() || cg-&gt;method()-&gt;has_loops());
 663     C-&gt;env()-&gt;notice_inlined_method(cg-&gt;method());
 664   }
 665 
 666   // Reset parser state from [new_]jvms, which now carries results of the call.
 667   // Return value (if any) is already pushed on the stack by the cg.
 668   add_exception_states_from(new_jvms);
 669   if (new_jvms-&gt;map()-&gt;control() == top()) {
 670     stop_and_kill_map();
 671   } else {
 672     assert(new_jvms-&gt;same_calls_as(jvms), &quot;method/bci left unchanged&quot;);
 673     set_jvms(new_jvms);
 674   }
 675 
 676   assert(check_call_consistency(jvms, cg), &quot;inconsistent info&quot;);
 677 
 678   if (!stopped()) {
 679     // This was some sort of virtual call, which did a null check for us.
 680     // Now we can assert receiver-not-null, on the normal return path.
 681     if (receiver != NULL &amp;&amp; cg-&gt;is_virtual()) {
 682       Node* cast = cast_not_null(receiver);
 683       // %%% assert(receiver == cast, &quot;should already have cast the receiver&quot;);
 684     }
 685 
 686     // Round double result after a call from strict to non-strict code
 687     round_double_result(cg-&gt;method());
 688 
 689     ciType* rtype = cg-&gt;method()-&gt;return_type();
 690     ciType* ctype = declared_signature-&gt;return_type();
 691 
 692     if (Bytecodes::has_optional_appendix(iter().cur_bc_raw()) || is_signature_polymorphic) {
 693       // Be careful here with return types.
 694       if (ctype != rtype) {
 695         BasicType rt = rtype-&gt;basic_type();
 696         BasicType ct = ctype-&gt;basic_type();
 697         if (ct == T_VOID) {
 698           // It&#39;s OK for a method  to return a value that is discarded.
 699           // The discarding does not require any special action from the caller.
 700           // The Java code knows this, at VerifyType.isNullConversion.
 701           pop_node(rt);  // whatever it was, pop it
 702         } else if (rt == T_INT || is_subword_type(rt)) {
 703           // Nothing.  These cases are handled in lambda form bytecode.
 704           assert(ct == T_INT || is_subword_type(ct), &quot;must match: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 705         } else if (is_reference_type(rt)) {
 706           assert(is_reference_type(ct), &quot;rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 707           if (ctype-&gt;is_loaded()) {
 708             const TypeOopPtr* arg_type = TypeOopPtr::make_from_klass(rtype-&gt;as_klass());
 709             const Type*       sig_type = TypeOopPtr::make_from_klass(ctype-&gt;as_klass());
 710             if (arg_type != NULL &amp;&amp; !arg_type-&gt;higher_equal(sig_type)) {
 711               Node* retnode = pop();
 712               Node* cast_obj = _gvn.transform(new CheckCastPPNode(control(), retnode, sig_type));
 713               push(cast_obj);
 714             }
 715           }
 716         } else {
 717           assert(rt == ct, &quot;unexpected mismatch: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 718           // push a zero; it&#39;s better than getting an oop/int mismatch
 719           pop_node(rt);
 720           Node* retnode = zerocon(ct);
 721           push_node(ct, retnode);
 722         }
 723         // Now that the value is well-behaved, continue with the call-site type.
 724         rtype = ctype;
 725       }
 726     } else {
 727       // Symbolic resolution enforces the types to be the same.
 728       // NOTE: We must relax the assert for unloaded types because two
 729       // different ciType instances of the same unloaded class type
 730       // can appear to be &quot;loaded&quot; by different loaders (depending on
 731       // the accessing class).
 732       assert(!rtype-&gt;is_loaded() || !ctype-&gt;is_loaded() || rtype == ctype,
 733              &quot;mismatched return types: rtype=%s, ctype=%s&quot;, rtype-&gt;name(), ctype-&gt;name());
 734     }
 735 
 736     // If the return type of the method is not loaded, assert that the
 737     // value we got is a null.  Otherwise, we need to recompile.
 738     if (!rtype-&gt;is_loaded()) {
 739       if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 740         method()-&gt;print_name(); tty-&gt;print_cr(&quot; asserting nullness of result at bci: %d&quot;, bci());
 741         cg-&gt;method()-&gt;print_name(); tty-&gt;cr();
 742       }
 743       if (C-&gt;log() != NULL) {
 744         C-&gt;log()-&gt;elem(&quot;assert_null reason=&#39;return&#39; klass=&#39;%d&#39;&quot;,
 745                        C-&gt;log()-&gt;identify(rtype));
 746       }
 747       // If there is going to be a trap, put it at the next bytecode:
 748       set_bci(iter().next_bci());
 749       null_assert(peek());
 750       set_bci(iter().cur_bci()); // put it back
 751     }
 752     BasicType ct = ctype-&gt;basic_type();
 753     if (is_reference_type(ct)) {
 754       record_profiled_return_for_speculation();
 755     }
 756   }
 757 
 758   // Restart record of parsing work after possible inlining of call
 759 #ifndef PRODUCT
 760   parse_histogram()-&gt;set_initial_state(bc());
 761 #endif
 762 }
 763 
 764 //---------------------------catch_call_exceptions-----------------------------
 765 // Put a Catch and CatchProj nodes behind a just-created call.
 766 // Send their caught exceptions to the proper handler.
 767 // This may be used after a call to the rethrow VM stub,
 768 // when it is needed to process unloaded exception classes.
 769 void Parse::catch_call_exceptions(ciExceptionHandlerStream&amp; handlers) {
 770   // Exceptions are delivered through this channel:
 771   Node* i_o = this-&gt;i_o();
 772 
 773   // Add a CatchNode.
 774   GrowableArray&lt;int&gt;* bcis = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, -1);
 775   GrowableArray&lt;const Type*&gt;* extypes = new (C-&gt;node_arena()) GrowableArray&lt;const Type*&gt;(C-&gt;node_arena(), 8, 0, NULL);
 776   GrowableArray&lt;int&gt;* saw_unloaded = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, 0);
 777 
 778   bool default_handler = false;
 779   for (; !handlers.is_done(); handlers.next()) {
 780     ciExceptionHandler* h        = handlers.handler();
 781     int                 h_bci    = h-&gt;handler_bci();
 782     ciInstanceKlass*    h_klass  = h-&gt;is_catch_all() ? env()-&gt;Throwable_klass() : h-&gt;catch_klass();
 783     // Do not introduce unloaded exception types into the graph:
 784     if (!h_klass-&gt;is_loaded()) {
 785       if (saw_unloaded-&gt;contains(h_bci)) {
 786         /* We&#39;ve already seen an unloaded exception with h_bci,
 787            so don&#39;t duplicate. Duplication will cause the CatchNode to be
 788            unnecessarily large. See 4713716. */
 789         continue;
 790       } else {
 791         saw_unloaded-&gt;append(h_bci);
 792       }
 793     }
 794     const Type*         h_extype = TypeOopPtr::make_from_klass(h_klass);
 795     // (We use make_from_klass because it respects UseUniqueSubclasses.)
 796     h_extype = h_extype-&gt;join(TypeInstPtr::NOTNULL);
 797     assert(!h_extype-&gt;empty(), &quot;sanity&quot;);
 798     // Note:  It&#39;s OK if the BCIs repeat themselves.
 799     bcis-&gt;append(h_bci);
 800     extypes-&gt;append(h_extype);
 801     if (h_bci == -1) {
 802       default_handler = true;
 803     }
 804   }
 805 
 806   if (!default_handler) {
 807     bcis-&gt;append(-1);
 808     extypes-&gt;append(TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr());
 809   }
 810 
 811   int len = bcis-&gt;length();
 812   CatchNode *cn = new CatchNode(control(), i_o, len+1);
 813   Node *catch_ = _gvn.transform(cn);
 814 
 815   // now branch with the exception state to each of the (potential)
 816   // handlers
 817   for(int i=0; i &lt; len; i++) {
 818     // Setup JVM state to enter the handler.
 819     PreserveJVMState pjvms(this);
 820     // Locals are just copied from before the call.
 821     // Get control from the CatchNode.
 822     int handler_bci = bcis-&gt;at(i);
 823     Node* ctrl = _gvn.transform( new CatchProjNode(catch_, i+1,handler_bci));
 824     // This handler cannot happen?
 825     if (ctrl == top())  continue;
 826     set_control(ctrl);
 827 
 828     // Create exception oop
 829     const TypeInstPtr* extype = extypes-&gt;at(i)-&gt;is_instptr();
 830     Node *ex_oop = _gvn.transform(new CreateExNode(extypes-&gt;at(i), ctrl, i_o));
 831 
 832     // Handle unloaded exception classes.
 833     if (saw_unloaded-&gt;contains(handler_bci)) {
 834       // An unloaded exception type is coming here.  Do an uncommon trap.
 835 #ifndef PRODUCT
 836       // We do not expect the same handler bci to take both cold unloaded
 837       // and hot loaded exceptions.  But, watch for it.
 838       if ((Verbose || WizardMode) &amp;&amp; extype-&gt;is_loaded()) {
 839         tty-&gt;print(&quot;Warning: Handler @%d takes mixed loaded/unloaded exceptions in &quot;, bci());
 840         method()-&gt;print_name(); tty-&gt;cr();
 841       } else if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 842         tty-&gt;print(&quot;Bailing out on unloaded exception type &quot;);
 843         extype-&gt;klass()-&gt;print_name();
 844         tty-&gt;print(&quot; at bci:%d in &quot;, bci());
 845         method()-&gt;print_name(); tty-&gt;cr();
 846       }
 847 #endif
 848       // Emit an uncommon trap instead of processing the block.
 849       set_bci(handler_bci);
 850       push_ex_oop(ex_oop);
 851       uncommon_trap(Deoptimization::Reason_unloaded,
 852                     Deoptimization::Action_reinterpret,
 853                     extype-&gt;klass(), &quot;!loaded exception&quot;);
 854       set_bci(iter().cur_bci()); // put it back
 855       continue;
 856     }
 857 
 858     // go to the exception handler
 859     if (handler_bci &lt; 0) {     // merge with corresponding rethrow node
 860       throw_to_exit(make_exception_state(ex_oop));
 861     } else {                      // Else jump to corresponding handle
 862       push_ex_oop(ex_oop);        // Clear stack and push just the oop.
 863       merge_exception(handler_bci);
 864     }
 865   }
 866 
 867   // The first CatchProj is for the normal return.
 868   // (Note:  If this is a call to rethrow_Java, this node goes dead.)
 869   set_control(_gvn.transform( new CatchProjNode(catch_, CatchProjNode::fall_through_index, CatchProjNode::no_handler_bci)));
 870 }
 871 
 872 
 873 //----------------------------catch_inline_exceptions--------------------------
 874 // Handle all exceptions thrown by an inlined method or individual bytecode.
 875 // Common case 1: we have no handler, so all exceptions merge right into
 876 // the rethrow case.
 877 // Case 2: we have some handlers, with loaded exception klasses that have
 878 // no subklasses.  We do a Deutsch-Shiffman style type-check on the incoming
 879 // exception oop and branch to the handler directly.
 880 // Case 3: We have some handlers with subklasses or are not loaded at
 881 // compile-time.  We have to call the runtime to resolve the exception.
 882 // So we insert a RethrowCall and all the logic that goes with it.
 883 void Parse::catch_inline_exceptions(SafePointNode* ex_map) {
 884   // Caller is responsible for saving away the map for normal control flow!
 885   assert(stopped(), &quot;call set_map(NULL) first&quot;);
 886   assert(method()-&gt;has_exception_handlers(), &quot;don&#39;t come here w/o work to do&quot;);
 887 
 888   Node* ex_node = saved_ex_oop(ex_map);
 889   if (ex_node == top()) {
 890     // No action needed.
 891     return;
 892   }
 893   const TypeInstPtr* ex_type = _gvn.type(ex_node)-&gt;isa_instptr();
 894   NOT_PRODUCT(if (ex_type==NULL) tty-&gt;print_cr(&quot;*** Exception not InstPtr&quot;));
 895   if (ex_type == NULL)
 896     ex_type = TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr();
 897 
 898   // determine potential exception handlers
 899   ciExceptionHandlerStream handlers(method(), bci(),
 900                                     ex_type-&gt;klass()-&gt;as_instance_klass(),
 901                                     ex_type-&gt;klass_is_exact());
 902 
 903   // Start executing from the given throw state.  (Keep its stack, for now.)
 904   // Get the exception oop as known at compile time.
 905   ex_node = use_exception_state(ex_map);
 906 
 907   // Get the exception oop klass from its header
 908   Node* ex_klass_node = NULL;
 909   if (has_ex_handler() &amp;&amp; !ex_type-&gt;klass_is_exact()) {
 910     Node* p = basic_plus_adr( ex_node, ex_node, oopDesc::klass_offset_in_bytes());
 911     ex_klass_node = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 912 
 913     // Compute the exception klass a little more cleverly.
 914     // Obvious solution is to simple do a LoadKlass from the &#39;ex_node&#39;.
 915     // However, if the ex_node is a PhiNode, I&#39;m going to do a LoadKlass for
 916     // each arm of the Phi.  If I know something clever about the exceptions
 917     // I&#39;m loading the class from, I can replace the LoadKlass with the
 918     // klass constant for the exception oop.
 919     if (ex_node-&gt;is_Phi()) {
 920       ex_klass_node = new PhiNode(ex_node-&gt;in(0), TypeKlassPtr::OBJECT);
 921       for (uint i = 1; i &lt; ex_node-&gt;req(); i++) {
 922         Node* ex_in = ex_node-&gt;in(i);
 923         if (ex_in == top() || ex_in == NULL) {
 924           // This path was not taken.
 925           ex_klass_node-&gt;init_req(i, top());
 926           continue;
 927         }
 928         Node* p = basic_plus_adr(ex_in, ex_in, oopDesc::klass_offset_in_bytes());
 929         Node* k = _gvn.transform( LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 930         ex_klass_node-&gt;init_req( i, k );
 931       }
 932       _gvn.set_type(ex_klass_node, TypeKlassPtr::OBJECT);
 933 
 934     }
 935   }
 936 
 937   // Scan the exception table for applicable handlers.
 938   // If none, we can call rethrow() and be done!
 939   // If precise (loaded with no subklasses), insert a D.S. style
 940   // pointer compare to the correct handler and loop back.
 941   // If imprecise, switch to the Rethrow VM-call style handling.
 942 
 943   int remaining = handlers.count_remaining();
 944 
 945   // iterate through all entries sequentially
 946   for (;!handlers.is_done(); handlers.next()) {
 947     ciExceptionHandler* handler = handlers.handler();
 948 
 949     if (handler-&gt;is_rethrow()) {
 950       // If we fell off the end of the table without finding an imprecise
 951       // exception klass (and without finding a generic handler) then we
 952       // know this exception is not handled in this method.  We just rethrow
 953       // the exception into the caller.
 954       throw_to_exit(make_exception_state(ex_node));
 955       return;
 956     }
 957 
 958     // exception handler bci range covers throw_bci =&gt; investigate further
 959     int handler_bci = handler-&gt;handler_bci();
 960 
 961     if (remaining == 1) {
 962       push_ex_oop(ex_node);        // Push exception oop for handler
 963       if (PrintOpto &amp;&amp; WizardMode) {
 964         tty-&gt;print_cr(&quot;  Catching every inline exception bci:%d -&gt; handler_bci:%d&quot;, bci(), handler_bci);
 965       }
 966       merge_exception(handler_bci); // jump to handler
 967       return;                   // No more handling to be done here!
 968     }
 969 
 970     // Get the handler&#39;s klass
 971     ciInstanceKlass* klass = handler-&gt;catch_klass();
 972 
 973     if (!klass-&gt;is_loaded()) {  // klass is not loaded?
 974       // fall through into catch_call_exceptions which will emit a
 975       // handler with an uncommon trap.
 976       break;
 977     }
 978 
 979     if (klass-&gt;is_interface())  // should not happen, but...
 980       break;                    // bail out
 981 
 982     // Check the type of the exception against the catch type
 983     const TypeKlassPtr *tk = TypeKlassPtr::make(klass);
 984     Node* con = _gvn.makecon(tk);
 985     Node* not_subtype_ctrl = gen_subtype_check(ex_klass_node, con);
 986     if (!stopped()) {
 987       PreserveJVMState pjvms(this);
 988       const TypeInstPtr* tinst = TypeOopPtr::make_from_klass_unique(klass)-&gt;cast_to_ptr_type(TypePtr::NotNull)-&gt;is_instptr();
 989       assert(klass-&gt;has_subklass() || tinst-&gt;klass_is_exact(), &quot;lost exactness&quot;);
 990       Node* ex_oop = _gvn.transform(new CheckCastPPNode(control(), ex_node, tinst));
 991       push_ex_oop(ex_oop);      // Push exception oop for handler
 992       if (PrintOpto &amp;&amp; WizardMode) {
 993         tty-&gt;print(&quot;  Catching inline exception bci:%d -&gt; handler_bci:%d -- &quot;, bci(), handler_bci);
 994         klass-&gt;print_name();
 995         tty-&gt;cr();
 996       }
 997       merge_exception(handler_bci);
 998     }
 999     set_control(not_subtype_ctrl);
1000 
1001     // Come here if exception does not match handler.
1002     // Carry on with more handler checks.
1003     --remaining;
1004   }
1005 
1006   assert(!stopped(), &quot;you should return if you finish the chain&quot;);
1007 
1008   // Oops, need to call into the VM to resolve the klasses at runtime.
1009   // Note:  This call must not deoptimize, since it is not a real at this bci!
1010   kill_dead_locals();
1011 
1012   make_runtime_call(RC_NO_LEAF | RC_MUST_THROW,
1013                     OptoRuntime::rethrow_Type(),
1014                     OptoRuntime::rethrow_stub(),
1015                     NULL, NULL,
1016                     ex_node);
1017 
1018   // Rethrow is a pure call, no side effects, only a result.
1019   // The result cannot be allocated, so we use I_O
1020 
1021   // Catch exceptions from the rethrow
1022   catch_call_exceptions(handlers);
1023 }
1024 
1025 
1026 // (Note:  Moved add_debug_info into GraphKit::add_safepoint_edges.)
1027 
1028 
1029 #ifndef PRODUCT
1030 void Parse::count_compiled_calls(bool at_method_entry, bool is_inline) {
1031   if( CountCompiledCalls ) {
1032     if( at_method_entry ) {
1033       // bump invocation counter if top method (for statistics)
1034       if (CountCompiledCalls &amp;&amp; depth() == 1) {
1035         const TypePtr* addr_type = TypeMetadataPtr::make(method());
1036         Node* adr1 = makecon(addr_type);
1037         Node* adr2 = basic_plus_adr(adr1, adr1, in_bytes(Method::compiled_invocation_counter_offset()));
1038         increment_counter(adr2);
1039       }
1040     } else if (is_inline) {
1041       switch (bc()) {
1042       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_inlined_calls_addr()); break;
1043       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_inlined_interface_calls_addr()); break;
1044       case Bytecodes::_invokestatic:
1045       case Bytecodes::_invokedynamic:
1046       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_inlined_static_calls_addr()); break;
1047       default: fatal(&quot;unexpected call bytecode&quot;);
1048       }
1049     } else {
1050       switch (bc()) {
1051       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_normal_calls_addr()); break;
1052       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_interface_calls_addr()); break;
1053       case Bytecodes::_invokestatic:
1054       case Bytecodes::_invokedynamic:
1055       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_static_calls_addr()); break;
1056       default: fatal(&quot;unexpected call bytecode&quot;);
1057       }
1058     }
1059   }
1060 }
1061 #endif //PRODUCT
1062 
1063 
1064 ciMethod* Compile::optimize_virtual_call(ciMethod* caller, int bci, ciInstanceKlass* klass,
1065                                          ciKlass* holder, ciMethod* callee,
1066                                          const TypeOopPtr* receiver_type, bool is_virtual,
1067                                          bool&amp; call_does_dispatch, int&amp; vtable_index,
1068                                          bool check_access) {
1069   // Set default values for out-parameters.
1070   call_does_dispatch = true;
1071   vtable_index       = Method::invalid_vtable_index;
1072 
1073   // Choose call strategy.
1074   ciMethod* optimized_virtual_method = optimize_inlining(caller, bci, klass, callee,
1075                                                          receiver_type, check_access);
1076 
1077   // Have the call been sufficiently improved such that it is no longer a virtual?
1078   if (optimized_virtual_method != NULL) {
1079     callee             = optimized_virtual_method;
1080     call_does_dispatch = false;
1081   } else if (!UseInlineCaches &amp;&amp; is_virtual &amp;&amp; callee-&gt;is_loaded()) {
1082     // We can make a vtable call at this site
1083     vtable_index = callee-&gt;resolve_vtable_index(caller-&gt;holder(), holder);
1084   }
1085   return callee;
1086 }
1087 
1088 // Identify possible target method and inlining style
1089 ciMethod* Compile::optimize_inlining(ciMethod* caller, int bci, ciInstanceKlass* klass,
1090                                      ciMethod* callee, const TypeOopPtr* receiver_type,
1091                                      bool check_access) {
1092   // only use for virtual or interface calls
1093 
1094   // If it is obviously final, do not bother to call find_monomorphic_target,
1095   // because the class hierarchy checks are not needed, and may fail due to
1096   // incompletely loaded classes.  Since we do our own class loading checks
1097   // in this module, we may confidently bind to any method.
1098   if (callee-&gt;can_be_statically_bound()) {
1099     return callee;
1100   }
1101 
1102   // Attempt to improve the receiver
1103   bool actual_receiver_is_exact = false;
1104   ciInstanceKlass* actual_receiver = klass;
1105   if (receiver_type != NULL) {
1106     // Array methods are all inherited from Object, and are monomorphic.
1107     // finalize() call on array is not allowed.
1108     if (receiver_type-&gt;isa_aryptr() &amp;&amp;
1109         callee-&gt;holder() == env()-&gt;Object_klass() &amp;&amp;
1110         callee-&gt;name() != ciSymbol::finalize_method_name()) {
1111       return callee;
1112     }
1113 
1114     // All other interesting cases are instance klasses.
1115     if (!receiver_type-&gt;isa_instptr()) {
1116       return NULL;
1117     }
1118 
1119     ciInstanceKlass *ikl = receiver_type-&gt;klass()-&gt;as_instance_klass();
1120     if (ikl-&gt;is_loaded() &amp;&amp; ikl-&gt;is_initialized() &amp;&amp; !ikl-&gt;is_interface() &amp;&amp;
1121         (ikl == actual_receiver || ikl-&gt;is_subtype_of(actual_receiver))) {
1122       // ikl is a same or better type than the original actual_receiver,
1123       // e.g. static receiver from bytecodes.
1124       actual_receiver = ikl;
1125       // Is the actual_receiver exact?
1126       actual_receiver_is_exact = receiver_type-&gt;klass_is_exact();
1127     }
1128   }
1129 
1130   ciInstanceKlass*   calling_klass = caller-&gt;holder();
1131   ciMethod* cha_monomorphic_target = callee-&gt;find_monomorphic_target(calling_klass, klass, actual_receiver, check_access);
1132   if (cha_monomorphic_target != NULL) {
1133     assert(!cha_monomorphic_target-&gt;is_abstract(), &quot;&quot;);
1134     // Look at the method-receiver type.  Does it add &quot;too much information&quot;?
1135     ciKlass*    mr_klass = cha_monomorphic_target-&gt;holder();
1136     const Type* mr_type  = TypeInstPtr::make(TypePtr::BotPTR, mr_klass);
1137     if (receiver_type == NULL || !receiver_type-&gt;higher_equal(mr_type)) {
1138       // Calling this method would include an implicit cast to its holder.
1139       // %%% Not yet implemented.  Would throw minor asserts at present.
1140       // %%% The most common wins are already gained by +UseUniqueSubclasses.
1141       // To fix, put the higher_equal check at the call of this routine,
1142       // and add a CheckCastPP to the receiver.
1143       if (TraceDependencies) {
1144         tty-&gt;print_cr(&quot;found unique CHA method, but could not cast up&quot;);
1145         tty-&gt;print(&quot;  method  = &quot;);
1146         cha_monomorphic_target-&gt;print();
1147         tty-&gt;cr();
1148       }
1149       if (log() != NULL) {
1150         log()-&gt;elem(&quot;missed_CHA_opportunity klass=&#39;%d&#39; method=&#39;%d&#39;&quot;,
1151                        log()-&gt;identify(klass),
1152                        log()-&gt;identify(cha_monomorphic_target));
1153       }
1154       cha_monomorphic_target = NULL;
1155     }
1156   }
1157 
1158   if (cha_monomorphic_target != NULL) {
1159     // Hardwiring a virtual.
1160     assert(!callee-&gt;can_be_statically_bound(), &quot;should have been handled earlier&quot;);
1161     assert(!cha_monomorphic_target-&gt;is_abstract(), &quot;&quot;);
1162     if (!cha_monomorphic_target-&gt;can_be_statically_bound(actual_receiver)) {
1163       // If we inlined because CHA revealed only a single target method,
1164       // then we are dependent on that target method not getting overridden
1165       // by dynamic class loading.  Be sure to test the &quot;static&quot; receiver
1166       // dest_method here, as opposed to the actual receiver, which may
1167       // falsely lead us to believe that the receiver is final or private.
1168       dependencies()-&gt;assert_unique_concrete_method(actual_receiver, cha_monomorphic_target);
1169     }
1170     return cha_monomorphic_target;
1171   }
1172 
1173   // If the type is exact, we can still bind the method w/o a vcall.
1174   // (This case comes after CHA so we can see how much extra work it does.)
1175   if (actual_receiver_is_exact) {
1176     // In case of evolution, there is a dependence on every inlined method, since each
1177     // such method can be changed when its class is redefined.
1178     ciMethod* exact_method = callee-&gt;resolve_invoke(calling_klass, actual_receiver);
1179     if (exact_method != NULL) {
1180       if (PrintOpto) {
1181         tty-&gt;print(&quot;  Calling method via exact type @%d --- &quot;, bci);
1182         exact_method-&gt;print_name();
1183         tty-&gt;cr();
1184       }
1185       return exact_method;
1186     }
1187   }
1188 
1189   return NULL;
1190 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>