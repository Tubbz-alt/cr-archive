<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/prims/jvmtiEnv.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="jvm.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmtiRedefineClasses.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/prims/jvmtiEnv.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderExt.hpp&quot;
  27 #include &quot;classfile/javaClasses.inline.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/modules.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;interpreter/bytecodeStream.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;

  34 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logConfiguration.hpp&quot;
  37 #include &quot;memory/resourceArea.hpp&quot;
  38 #include &quot;memory/universe.hpp&quot;
  39 #include &quot;oops/instanceKlass.hpp&quot;
  40 #include &quot;oops/objArrayOop.inline.hpp&quot;
  41 #include &quot;oops/oop.inline.hpp&quot;
  42 #include &quot;prims/jniCheck.hpp&quot;
  43 #include &quot;prims/jvm_misc.hpp&quot;
  44 #include &quot;prims/jvmtiAgentThread.hpp&quot;
  45 #include &quot;prims/jvmtiClassFileReconstituter.hpp&quot;
  46 #include &quot;prims/jvmtiCodeBlobEvents.hpp&quot;
  47 #include &quot;prims/jvmtiExtensions.hpp&quot;
  48 #include &quot;prims/jvmtiGetLoadedClasses.hpp&quot;
  49 #include &quot;prims/jvmtiImpl.hpp&quot;
  50 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  51 #include &quot;prims/jvmtiRawMonitor.hpp&quot;
  52 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  53 #include &quot;prims/jvmtiTagMap.hpp&quot;
</pre>
<hr />
<pre>
 429     if (ik-&gt;get_cached_class_file_bytes() == NULL) {
 430       // Not cached, we need to reconstitute the class file from the
 431       // VM representation. We don&#39;t attach the reconstituted class
 432       // bytes to the InstanceKlass here because they have not been
 433       // validated and we&#39;re not at a safepoint.
 434       JvmtiClassFileReconstituter reconstituter(ik);
 435       if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
 436         return reconstituter.get_error();
 437       }
 438 
 439       class_definitions[index].class_byte_count = (jint)reconstituter.class_file_size();
 440       class_definitions[index].class_bytes      = (unsigned char*)
 441                                                        reconstituter.class_file_bytes();
 442     } else {
 443       // it is cached, get it from the cache
 444       class_definitions[index].class_byte_count = ik-&gt;get_cached_class_file_len();
 445       class_definitions[index].class_bytes      = ik-&gt;get_cached_class_file_bytes();
 446     }
 447     class_definitions[index].klass              = jcls;
 448   }

 449   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_retransform);
 450   VMThread::execute(&amp;op);
<span class="line-modified"> 451   return (op.check_error());</span>






 452 } /* end RetransformClasses */
 453 
 454 
 455 // class_count - pre-checked to be greater than or equal to 0
 456 // class_definitions - pre-checked for NULL
 457 jvmtiError
 458 JvmtiEnv::RedefineClasses(jint class_count, const jvmtiClassDefinition* class_definitions) {
 459 //TODO: add locking

 460   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_redefine);
 461   VMThread::execute(&amp;op);
<span class="line-modified"> 462   return (op.check_error());</span>






 463 } /* end RedefineClasses */
 464 
 465 
 466   //
 467   // Object functions
 468   //
 469 
 470 // size_ptr - pre-checked for NULL
 471 jvmtiError
 472 JvmtiEnv::GetObjectSize(jobject object, jlong* size_ptr) {
 473   oop mirror = JNIHandles::resolve_external_guard(object);
 474   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
 475   *size_ptr = (jlong)Universe::heap()-&gt;obj_size(mirror) * wordSize;
 476   return JVMTI_ERROR_NONE;
 477 } /* end GetObjectSize */
 478 
 479   //
 480   // Method functions
 481   //
 482 
</pre>
</td>
<td>
<hr />
<pre>
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderExt.hpp&quot;
  27 #include &quot;classfile/javaClasses.inline.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;classfile/modules.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;interpreter/bytecodeStream.hpp&quot;
  33 #include &quot;interpreter/interpreter.hpp&quot;
<span class="line-added">  34 #include &quot;jfr/jfrEvents.hpp&quot;</span>
  35 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  36 #include &quot;logging/log.hpp&quot;
  37 #include &quot;logging/logConfiguration.hpp&quot;
  38 #include &quot;memory/resourceArea.hpp&quot;
  39 #include &quot;memory/universe.hpp&quot;
  40 #include &quot;oops/instanceKlass.hpp&quot;
  41 #include &quot;oops/objArrayOop.inline.hpp&quot;
  42 #include &quot;oops/oop.inline.hpp&quot;
  43 #include &quot;prims/jniCheck.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;prims/jvmtiAgentThread.hpp&quot;
  46 #include &quot;prims/jvmtiClassFileReconstituter.hpp&quot;
  47 #include &quot;prims/jvmtiCodeBlobEvents.hpp&quot;
  48 #include &quot;prims/jvmtiExtensions.hpp&quot;
  49 #include &quot;prims/jvmtiGetLoadedClasses.hpp&quot;
  50 #include &quot;prims/jvmtiImpl.hpp&quot;
  51 #include &quot;prims/jvmtiManageCapabilities.hpp&quot;
  52 #include &quot;prims/jvmtiRawMonitor.hpp&quot;
  53 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  54 #include &quot;prims/jvmtiTagMap.hpp&quot;
</pre>
<hr />
<pre>
 430     if (ik-&gt;get_cached_class_file_bytes() == NULL) {
 431       // Not cached, we need to reconstitute the class file from the
 432       // VM representation. We don&#39;t attach the reconstituted class
 433       // bytes to the InstanceKlass here because they have not been
 434       // validated and we&#39;re not at a safepoint.
 435       JvmtiClassFileReconstituter reconstituter(ik);
 436       if (reconstituter.get_error() != JVMTI_ERROR_NONE) {
 437         return reconstituter.get_error();
 438       }
 439 
 440       class_definitions[index].class_byte_count = (jint)reconstituter.class_file_size();
 441       class_definitions[index].class_bytes      = (unsigned char*)
 442                                                        reconstituter.class_file_bytes();
 443     } else {
 444       // it is cached, get it from the cache
 445       class_definitions[index].class_byte_count = ik-&gt;get_cached_class_file_len();
 446       class_definitions[index].class_bytes      = ik-&gt;get_cached_class_file_bytes();
 447     }
 448     class_definitions[index].klass              = jcls;
 449   }
<span class="line-added"> 450   EventRetransformClasses event;</span>
 451   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_retransform);
 452   VMThread::execute(&amp;op);
<span class="line-modified"> 453   jvmtiError error = op.check_error();</span>
<span class="line-added"> 454   if (error == JVMTI_ERROR_NONE) {</span>
<span class="line-added"> 455     event.set_classCount(class_count);</span>
<span class="line-added"> 456     event.set_redefinitionId(op.id());</span>
<span class="line-added"> 457     event.commit();</span>
<span class="line-added"> 458   }</span>
<span class="line-added"> 459   return error;</span>
 460 } /* end RetransformClasses */
 461 
 462 
 463 // class_count - pre-checked to be greater than or equal to 0
 464 // class_definitions - pre-checked for NULL
 465 jvmtiError
 466 JvmtiEnv::RedefineClasses(jint class_count, const jvmtiClassDefinition* class_definitions) {
 467 //TODO: add locking
<span class="line-added"> 468   EventRedefineClasses event;</span>
 469   VM_RedefineClasses op(class_count, class_definitions, jvmti_class_load_kind_redefine);
 470   VMThread::execute(&amp;op);
<span class="line-modified"> 471   jvmtiError error = op.check_error();</span>
<span class="line-added"> 472   if (error == JVMTI_ERROR_NONE) {</span>
<span class="line-added"> 473     event.set_classCount(class_count);</span>
<span class="line-added"> 474     event.set_redefinitionId(op.id());</span>
<span class="line-added"> 475     event.commit();</span>
<span class="line-added"> 476   }</span>
<span class="line-added"> 477   return error;</span>
 478 } /* end RedefineClasses */
 479 
 480 
 481   //
 482   // Object functions
 483   //
 484 
 485 // size_ptr - pre-checked for NULL
 486 jvmtiError
 487 JvmtiEnv::GetObjectSize(jobject object, jlong* size_ptr) {
 488   oop mirror = JNIHandles::resolve_external_guard(object);
 489   NULL_CHECK(mirror, JVMTI_ERROR_INVALID_OBJECT);
 490   *size_ptr = (jlong)Universe::heap()-&gt;obj_size(mirror) * wordSize;
 491   return JVMTI_ERROR_NONE;
 492 } /* end GetObjectSize */
 493 
 494   //
 495   // Method functions
 496   //
 497 
</pre>
</td>
</tr>
</table>
<center><a href="jvm.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="jvmtiRedefineClasses.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>