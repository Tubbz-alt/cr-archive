<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/share/compiler/tieredThresholdPolicy.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="oopMap.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../gc/g1/g1BiasedArray.hpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/compiler/tieredThresholdPolicy.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 362     return CompLevel_full_profile;
 363   } else if (CompilationModeFlag::quick_only()) {
 364     return CompLevel_simple;
 365   } else if (CompilationModeFlag::high_only()) {
 366     return CompLevel_full_optimization;
 367   } else if (CompilationModeFlag::high_only_quick_internal()) {
 368     if (force_comp_at_level_simple(method)) {
 369       return CompLevel_simple;
 370     } else {
 371       return CompLevel_full_optimization;
 372     }
 373   }
 374   ShouldNotReachHere();
 375   return CompLevel_any;
 376 }
 377 
 378 CompLevel TieredThresholdPolicy::initial_compile_level(const methodHandle&amp; method) {
 379   return limit_level(initial_compile_level_helper(method));
 380 }
 381 
<span class="line-removed"> 382 void TieredThresholdPolicy::set_carry_if_necessary(InvocationCounter *counter) {</span>
<span class="line-removed"> 383   if (!counter-&gt;carry() &amp;&amp; counter-&gt;count() &gt; InvocationCounter::count_limit / 2) {</span>
<span class="line-removed"> 384     counter-&gt;set_carry_flag();</span>
<span class="line-removed"> 385   }</span>
<span class="line-removed"> 386 }</span>
<span class="line-removed"> 387 </span>
 388 // Set carry flags on the counters if necessary
 389 void TieredThresholdPolicy::handle_counter_overflow(Method* method) {
 390   MethodCounters *mcs = method-&gt;method_counters();
 391   if (mcs != NULL) {
<span class="line-modified"> 392     set_carry_if_necessary(mcs-&gt;invocation_counter());</span>
<span class="line-modified"> 393     set_carry_if_necessary(mcs-&gt;backedge_counter());</span>
 394   }
 395   MethodData* mdo = method-&gt;method_data();
 396   if (mdo != NULL) {
<span class="line-modified"> 397     set_carry_if_necessary(mdo-&gt;invocation_counter());</span>
<span class="line-modified"> 398     set_carry_if_necessary(mdo-&gt;backedge_counter());</span>
 399   }
 400 }
 401 
 402 // Called with the queue locked and with at least one element
 403 CompileTask* TieredThresholdPolicy::select_task(CompileQueue* compile_queue) {
 404   CompileTask *max_blocking_task = NULL;
 405   CompileTask *max_task = NULL;
 406   Method* max_method = NULL;
 407   jlong t = nanos_to_millis(os::javaTimeNanos());
 408   // Iterate through the queue and find a method with a maximum rate.
 409   for (CompileTask* task = compile_queue-&gt;first(); task != NULL;) {
 410     CompileTask* next_task = task-&gt;next();
 411     Method* method = task-&gt;method();
 412     // If a method was unloaded or has been stale for some time, remove it from the queue.
 413     // Blocking tasks and tasks submitted from whitebox API don&#39;t become stale
 414     if (task-&gt;is_unloaded() || (task-&gt;can_become_stale() &amp;&amp; is_stale(t, TieredCompileTaskTimeout, method) &amp;&amp; !is_old(method))) {
 415       if (!task-&gt;is_unloaded()) {
 416         if (PrintTieredEvents) {
 417           print_event(REMOVE_FROM_QUEUE, method, method, task-&gt;osr_bci(), (CompLevel) task-&gt;comp_level());
 418         }
</pre>
</td>
<td>
<hr />
<pre>
 362     return CompLevel_full_profile;
 363   } else if (CompilationModeFlag::quick_only()) {
 364     return CompLevel_simple;
 365   } else if (CompilationModeFlag::high_only()) {
 366     return CompLevel_full_optimization;
 367   } else if (CompilationModeFlag::high_only_quick_internal()) {
 368     if (force_comp_at_level_simple(method)) {
 369       return CompLevel_simple;
 370     } else {
 371       return CompLevel_full_optimization;
 372     }
 373   }
 374   ShouldNotReachHere();
 375   return CompLevel_any;
 376 }
 377 
 378 CompLevel TieredThresholdPolicy::initial_compile_level(const methodHandle&amp; method) {
 379   return limit_level(initial_compile_level_helper(method));
 380 }
 381 






 382 // Set carry flags on the counters if necessary
 383 void TieredThresholdPolicy::handle_counter_overflow(Method* method) {
 384   MethodCounters *mcs = method-&gt;method_counters();
 385   if (mcs != NULL) {
<span class="line-modified"> 386     mcs-&gt;invocation_counter()-&gt;set_carry_on_overflow();</span>
<span class="line-modified"> 387     mcs-&gt;backedge_counter()-&gt;set_carry_on_overflow();</span>
 388   }
 389   MethodData* mdo = method-&gt;method_data();
 390   if (mdo != NULL) {
<span class="line-modified"> 391     mdo-&gt;invocation_counter()-&gt;set_carry_on_overflow();</span>
<span class="line-modified"> 392     mdo-&gt;backedge_counter()-&gt;set_carry_on_overflow();</span>
 393   }
 394 }
 395 
 396 // Called with the queue locked and with at least one element
 397 CompileTask* TieredThresholdPolicy::select_task(CompileQueue* compile_queue) {
 398   CompileTask *max_blocking_task = NULL;
 399   CompileTask *max_task = NULL;
 400   Method* max_method = NULL;
 401   jlong t = nanos_to_millis(os::javaTimeNanos());
 402   // Iterate through the queue and find a method with a maximum rate.
 403   for (CompileTask* task = compile_queue-&gt;first(); task != NULL;) {
 404     CompileTask* next_task = task-&gt;next();
 405     Method* method = task-&gt;method();
 406     // If a method was unloaded or has been stale for some time, remove it from the queue.
 407     // Blocking tasks and tasks submitted from whitebox API don&#39;t become stale
 408     if (task-&gt;is_unloaded() || (task-&gt;can_become_stale() &amp;&amp; is_stale(t, TieredCompileTaskTimeout, method) &amp;&amp; !is_old(method))) {
 409       if (!task-&gt;is_unloaded()) {
 410         if (PrintTieredEvents) {
 411           print_event(REMOVE_FROM_QUEUE, method, method, task-&gt;osr_bci(), (CompLevel) task-&gt;comp_level());
 412         }
</pre>
</td>
</tr>
</table>
<center><a href="oopMap.hpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="../gc/g1/g1BiasedArray.hpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>