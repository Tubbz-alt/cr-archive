<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/os.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/javaClasses.hpp&quot;
  29 #include &quot;classfile/moduleEntry.hpp&quot;
  30 #include &quot;classfile/systemDictionary.hpp&quot;
  31 #include &quot;classfile/vmSymbols.hpp&quot;
  32 #include &quot;code/codeCache.hpp&quot;
  33 #include &quot;code/icBuffer.hpp&quot;
  34 #include &quot;code/vtableStubs.hpp&quot;
  35 #include &quot;gc/shared/gcVMOperations.hpp&quot;
  36 #include &quot;logging/log.hpp&quot;
  37 #include &quot;interpreter/interpreter.hpp&quot;
  38 #include &quot;logging/log.hpp&quot;
  39 #include &quot;logging/logStream.hpp&quot;
  40 #include &quot;memory/allocation.inline.hpp&quot;
  41 #include &quot;memory/guardedMemory.hpp&quot;
  42 #include &quot;memory/resourceArea.hpp&quot;
  43 #include &quot;memory/universe.hpp&quot;
  44 #include &quot;oops/compressedOops.inline.hpp&quot;
  45 #include &quot;oops/oop.inline.hpp&quot;
  46 #include &quot;prims/jvm_misc.hpp&quot;
  47 #include &quot;runtime/arguments.hpp&quot;
  48 #include &quot;runtime/atomic.hpp&quot;
  49 #include &quot;runtime/frame.inline.hpp&quot;
  50 #include &quot;runtime/handles.inline.hpp&quot;
  51 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  52 #include &quot;runtime/java.hpp&quot;
  53 #include &quot;runtime/javaCalls.hpp&quot;
  54 #include &quot;runtime/mutexLocker.hpp&quot;
  55 #include &quot;runtime/os.inline.hpp&quot;
  56 #include &quot;runtime/sharedRuntime.hpp&quot;
  57 #include &quot;runtime/stubRoutines.hpp&quot;
  58 #include &quot;runtime/thread.inline.hpp&quot;
  59 #include &quot;runtime/threadSMR.hpp&quot;
  60 #include &quot;runtime/vm_version.hpp&quot;
  61 #include &quot;services/attachListener.hpp&quot;
  62 #include &quot;services/mallocTracker.hpp&quot;
  63 #include &quot;services/memTracker.hpp&quot;
  64 #include &quot;services/nmtCommon.hpp&quot;
  65 #include &quot;services/threadService.hpp&quot;
  66 #include &quot;utilities/align.hpp&quot;
  67 #include &quot;utilities/defaultStream.hpp&quot;
  68 #include &quot;utilities/events.hpp&quot;
  69 
  70 # include &lt;signal.h&gt;
  71 # include &lt;errno.h&gt;
  72 
  73 OSThread*         os::_starting_thread    = NULL;
  74 address           os::_polling_page       = NULL;
  75 volatile unsigned int os::_rand_seed      = 1;
  76 int               os::_processor_count    = 0;
  77 int               os::_initial_active_processor_count = 0;
  78 size_t            os::_page_sizes[os::page_sizes_max];
  79 
  80 #ifndef PRODUCT
  81 julong os::num_mallocs = 0;         // # of calls to malloc/realloc
  82 julong os::alloc_bytes = 0;         // # of bytes allocated
  83 julong os::num_frees = 0;           // # of calls to free
  84 julong os::free_bytes = 0;          // # of bytes freed
  85 #endif
  86 
  87 static size_t cur_malloc_words = 0;  // current size for MallocMaxTestWords
  88 
  89 DEBUG_ONLY(bool os::_mutex_init_done = false;)
  90 
  91 static time_t get_timezone(const struct tm* time_struct) {
  92 #if defined(_ALLBSD_SOURCE)
  93   return time_struct-&gt;tm_gmtoff;
  94 #elif defined(_WINDOWS)
  95   long zone;
  96   _get_timezone(&amp;zone);
  97   return static_cast&lt;time_t&gt;(zone);
  98 #else
  99   return timezone;
 100 #endif
 101 }
 102 
 103 int os::snprintf(char* buf, size_t len, const char* fmt, ...) {
 104   va_list args;
 105   va_start(args, fmt);
 106   int result = os::vsnprintf(buf, len, fmt, args);
 107   va_end(args);
 108   return result;
 109 }
 110 
 111 // Fill in buffer with current local time as an ISO-8601 string.
 112 // E.g., yyyy-mm-ddThh:mm:ss-zzzz.
 113 // Returns buffer, or NULL if it failed.
 114 // This would mostly be a call to
 115 //     strftime(...., &quot;%Y-%m-%d&quot; &quot;T&quot; &quot;%H:%M:%S&quot; &quot;%z&quot;, ....)
 116 // except that on Windows the %z behaves badly, so we do it ourselves.
 117 // Also, people wanted milliseconds on there,
 118 // and strftime doesn&#39;t do milliseconds.
 119 char* os::iso8601_time(char* buffer, size_t buffer_length, bool utc) {
 120   // Output will be of the form &quot;YYYY-MM-DDThh:mm:ss.mmm+zzzz\0&quot;
 121   //                                      1         2
 122   //                             12345678901234567890123456789
 123   // format string: &quot;%04d-%02d-%02dT%02d:%02d:%02d.%03d%c%02d%02d&quot;
 124   static const size_t needed_buffer = 29;
 125 
 126   // Sanity check the arguments
 127   if (buffer == NULL) {
 128     assert(false, &quot;NULL buffer&quot;);
 129     return NULL;
 130   }
 131   if (buffer_length &lt; needed_buffer) {
 132     assert(false, &quot;buffer_length too small&quot;);
 133     return NULL;
 134   }
 135   // Get the current time
 136   jlong milliseconds_since_19700101 = javaTimeMillis();
 137   const int milliseconds_per_microsecond = 1000;
 138   const time_t seconds_since_19700101 =
 139     milliseconds_since_19700101 / milliseconds_per_microsecond;
 140   const int milliseconds_after_second =
 141     milliseconds_since_19700101 % milliseconds_per_microsecond;
 142   // Convert the time value to a tm and timezone variable
 143   struct tm time_struct;
 144   if (utc) {
 145     if (gmtime_pd(&amp;seconds_since_19700101, &amp;time_struct) == NULL) {
 146       assert(false, &quot;Failed gmtime_pd&quot;);
 147       return NULL;
 148     }
 149   } else {
 150     if (localtime_pd(&amp;seconds_since_19700101, &amp;time_struct) == NULL) {
 151       assert(false, &quot;Failed localtime_pd&quot;);
 152       return NULL;
 153     }
 154   }
 155   const time_t zone = get_timezone(&amp;time_struct);
 156 
 157   // If daylight savings time is in effect,
 158   // we are 1 hour East of our time zone
 159   const time_t seconds_per_minute = 60;
 160   const time_t minutes_per_hour = 60;
 161   const time_t seconds_per_hour = seconds_per_minute * minutes_per_hour;
 162   time_t UTC_to_local = zone;
 163   if (time_struct.tm_isdst &gt; 0) {
 164     UTC_to_local = UTC_to_local - seconds_per_hour;
 165   }
 166 
 167   // No offset when dealing with UTC
 168   if (utc) {
 169     UTC_to_local = 0;
 170   }
 171 
 172   // Compute the time zone offset.
 173   //    localtime_pd() sets timezone to the difference (in seconds)
 174   //    between UTC and and local time.
 175   //    ISO 8601 says we need the difference between local time and UTC,
 176   //    we change the sign of the localtime_pd() result.
 177   const time_t local_to_UTC = -(UTC_to_local);
 178   // Then we have to figure out if if we are ahead (+) or behind (-) UTC.
 179   char sign_local_to_UTC = &#39;+&#39;;
 180   time_t abs_local_to_UTC = local_to_UTC;
 181   if (local_to_UTC &lt; 0) {
 182     sign_local_to_UTC = &#39;-&#39;;
 183     abs_local_to_UTC = -(abs_local_to_UTC);
 184   }
 185   // Convert time zone offset seconds to hours and minutes.
 186   const time_t zone_hours = (abs_local_to_UTC / seconds_per_hour);
 187   const time_t zone_min =
 188     ((abs_local_to_UTC % seconds_per_hour) / seconds_per_minute);
 189 
 190   // Print an ISO 8601 date and time stamp into the buffer
 191   const int year = 1900 + time_struct.tm_year;
 192   const int month = 1 + time_struct.tm_mon;
 193   const int printed = jio_snprintf(buffer, buffer_length,
 194                                    &quot;%04d-%02d-%02dT%02d:%02d:%02d.%03d%c%02d%02d&quot;,
 195                                    year,
 196                                    month,
 197                                    time_struct.tm_mday,
 198                                    time_struct.tm_hour,
 199                                    time_struct.tm_min,
 200                                    time_struct.tm_sec,
 201                                    milliseconds_after_second,
 202                                    sign_local_to_UTC,
 203                                    zone_hours,
 204                                    zone_min);
 205   if (printed == 0) {
 206     assert(false, &quot;Failed jio_printf&quot;);
 207     return NULL;
 208   }
 209   return buffer;
 210 }
 211 
 212 OSReturn os::set_priority(Thread* thread, ThreadPriority p) {
 213   debug_only(Thread::check_for_dangling_thread_pointer(thread);)
 214 
 215   if ((p &gt;= MinPriority &amp;&amp; p &lt;= MaxPriority) ||
 216       (p == CriticalPriority &amp;&amp; thread-&gt;is_ConcurrentGC_thread())) {
 217     int priority = java_to_os_priority[p];
 218     return set_native_priority(thread, priority);
 219   } else {
 220     assert(false, &quot;Should not happen&quot;);
 221     return OS_ERR;
 222   }
 223 }
 224 
 225 // The mapping from OS priority back to Java priority may be inexact because
 226 // Java priorities can map M:1 with native priorities. If you want the definite
 227 // Java priority then use JavaThread::java_priority()
 228 OSReturn os::get_priority(const Thread* const thread, ThreadPriority&amp; priority) {
 229   int p;
 230   int os_prio;
 231   OSReturn ret = get_native_priority(thread, &amp;os_prio);
 232   if (ret != OS_OK) return ret;
 233 
 234   if (java_to_os_priority[MaxPriority] &gt; java_to_os_priority[MinPriority]) {
 235     for (p = MaxPriority; p &gt; MinPriority &amp;&amp; java_to_os_priority[p] &gt; os_prio; p--) ;
 236   } else {
 237     // niceness values are in reverse order
 238     for (p = MaxPriority; p &gt; MinPriority &amp;&amp; java_to_os_priority[p] &lt; os_prio; p--) ;
 239   }
 240   priority = (ThreadPriority)p;
 241   return OS_OK;
 242 }
 243 
 244 bool os::dll_build_name(char* buffer, size_t size, const char* fname) {
 245   int n = jio_snprintf(buffer, size, &quot;%s%s%s&quot;, JNI_LIB_PREFIX, fname, JNI_LIB_SUFFIX);
 246   return (n != -1);
 247 }
 248 
 249 #if !defined(LINUX) &amp;&amp; !defined(_WINDOWS)
 250 bool os::committed_in_range(address start, size_t size, address&amp; committed_start, size_t&amp; committed_size) {
 251   committed_start = start;
 252   committed_size = size;
 253   return true;
 254 }
 255 #endif
 256 
 257 // Helper for dll_locate_lib.
 258 // Pass buffer and printbuffer as we already printed the path to buffer
 259 // when we called get_current_directory. This way we avoid another buffer
 260 // of size MAX_PATH.
 261 static bool conc_path_file_and_check(char *buffer, char *printbuffer, size_t printbuflen,
 262                                      const char* pname, char lastchar, const char* fname) {
 263 
 264   // Concatenate path and file name, but don&#39;t print double path separators.
 265   const char *filesep = (WINDOWS_ONLY(lastchar == &#39;:&#39; ||) lastchar == os::file_separator()[0]) ?
 266                         &quot;&quot; : os::file_separator();
 267   int ret = jio_snprintf(printbuffer, printbuflen, &quot;%s%s%s&quot;, pname, filesep, fname);
 268   // Check whether file exists.
 269   if (ret != -1) {
 270     struct stat statbuf;
 271     return os::stat(buffer, &amp;statbuf) == 0;
 272   }
 273   return false;
 274 }
 275 
 276 // Frees all memory allocated on the heap for the
 277 // supplied array of arrays of chars (a), where n
 278 // is the number of elements in the array.
 279 static void free_array_of_char_arrays(char** a, size_t n) {
 280       while (n &gt; 0) {
 281           n--;
 282           if (a[n] != NULL) {
 283             FREE_C_HEAP_ARRAY(char, a[n]);
 284           }
 285       }
 286       FREE_C_HEAP_ARRAY(char*, a);
 287 }
 288 
 289 bool os::dll_locate_lib(char *buffer, size_t buflen,
 290                         const char* pname, const char* fname) {
 291   bool retval = false;
 292 
 293   size_t fullfnamelen = strlen(JNI_LIB_PREFIX) + strlen(fname) + strlen(JNI_LIB_SUFFIX);
 294   char* fullfname = NEW_C_HEAP_ARRAY(char, fullfnamelen + 1, mtInternal);
 295   if (dll_build_name(fullfname, fullfnamelen + 1, fname)) {
 296     const size_t pnamelen = pname ? strlen(pname) : 0;
 297 
 298     if (pnamelen == 0) {
 299       // If no path given, use current working directory.
 300       const char* p = get_current_directory(buffer, buflen);
 301       if (p != NULL) {
 302         const size_t plen = strlen(buffer);
 303         const char lastchar = buffer[plen - 1];
 304         retval = conc_path_file_and_check(buffer, &amp;buffer[plen], buflen - plen,
 305                                           &quot;&quot;, lastchar, fullfname);
 306       }
 307     } else if (strchr(pname, *os::path_separator()) != NULL) {
 308       // A list of paths. Search for the path that contains the library.
 309       size_t n;
 310       char** pelements = split_path(pname, &amp;n, fullfnamelen);
 311       if (pelements != NULL) {
 312         for (size_t i = 0; i &lt; n; i++) {
 313           char* path = pelements[i];
 314           // Really shouldn&#39;t be NULL, but check can&#39;t hurt.
 315           size_t plen = (path == NULL) ? 0 : strlen(path);
 316           if (plen == 0) {
 317             continue; // Skip the empty path values.
 318           }
 319           const char lastchar = path[plen - 1];
 320           retval = conc_path_file_and_check(buffer, buffer, buflen, path, lastchar, fullfname);
 321           if (retval) break;
 322         }
 323         // Release the storage allocated by split_path.
 324         free_array_of_char_arrays(pelements, n);
 325       }
 326     } else {
 327       // A definite path.
 328       const char lastchar = pname[pnamelen-1];
 329       retval = conc_path_file_and_check(buffer, buffer, buflen, pname, lastchar, fullfname);
 330     }
 331   }
 332 
 333   FREE_C_HEAP_ARRAY(char*, fullfname);
 334   return retval;
 335 }
 336 
 337 // --------------------- sun.misc.Signal (optional) ---------------------
 338 
 339 
 340 // SIGBREAK is sent by the keyboard to query the VM state
 341 #ifndef SIGBREAK
 342 #define SIGBREAK SIGQUIT
 343 #endif
 344 
 345 // sigexitnum_pd is a platform-specific special signal used for terminating the Signal thread.
 346 
 347 
 348 static void signal_thread_entry(JavaThread* thread, TRAPS) {
 349   os::set_priority(thread, NearMaxPriority);
 350   while (true) {
 351     int sig;
 352     {
 353       // FIXME : Currently we have not decided what should be the status
 354       //         for this java thread blocked here. Once we decide about
 355       //         that we should fix this.
 356       sig = os::signal_wait();
 357     }
 358     if (sig == os::sigexitnum_pd()) {
 359        // Terminate the signal thread
 360        return;
 361     }
 362 
 363     switch (sig) {
 364       case SIGBREAK: {
 365 #if INCLUDE_SERVICES
 366         // Check if the signal is a trigger to start the Attach Listener - in that
 367         // case don&#39;t print stack traces.
 368         if (!DisableAttachMechanism) {
 369           // Attempt to transit state to AL_INITIALIZING.
 370           AttachListenerState cur_state = AttachListener::transit_state(AL_INITIALIZING, AL_NOT_INITIALIZED);
 371           if (cur_state == AL_INITIALIZING) {
 372             // Attach Listener has been started to initialize. Ignore this signal.
 373             continue;
 374           } else if (cur_state == AL_NOT_INITIALIZED) {
 375             // Start to initialize.
 376             if (AttachListener::is_init_trigger()) {
 377               // Attach Listener has been initialized.
 378               // Accept subsequent request.
 379               continue;
 380             } else {
 381               // Attach Listener could not be started.
 382               // So we need to transit the state to AL_NOT_INITIALIZED.
 383               AttachListener::set_state(AL_NOT_INITIALIZED);
 384             }
 385           } else if (AttachListener::check_socket_file()) {
 386             // Attach Listener has been started, but unix domain socket file
 387             // does not exist. So restart Attach Listener.
 388             continue;
 389           }
 390         }
 391 #endif
 392         // Print stack traces
 393         // Any SIGBREAK operations added here should make sure to flush
 394         // the output stream (e.g. tty-&gt;flush()) after output.  See 4803766.
 395         // Each module also prints an extra carriage return after its output.
 396         VM_PrintThreads op;
 397         VMThread::execute(&amp;op);
 398         VM_PrintJNI jni_op;
 399         VMThread::execute(&amp;jni_op);
 400         VM_FindDeadlocks op1(tty);
 401         VMThread::execute(&amp;op1);
 402         Universe::print_heap_at_SIGBREAK();
 403         if (PrintClassHistogram) {
 404           VM_GC_HeapInspection op1(tty, true /* force full GC before heap inspection */);
 405           VMThread::execute(&amp;op1);
 406         }
 407         if (JvmtiExport::should_post_data_dump()) {
 408           JvmtiExport::post_data_dump();
 409         }
 410         break;
 411       }
 412       default: {
 413         // Dispatch the signal to java
 414         HandleMark hm(THREAD);
 415         Klass* klass = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_misc_Signal(), THREAD);
 416         if (klass != NULL) {
 417           JavaValue result(T_VOID);
 418           JavaCallArguments args;
 419           args.push_int(sig);
 420           JavaCalls::call_static(
 421             &amp;result,
 422             klass,
 423             vmSymbols::dispatch_name(),
 424             vmSymbols::int_void_signature(),
 425             &amp;args,
 426             THREAD
 427           );
 428         }
 429         if (HAS_PENDING_EXCEPTION) {
 430           // tty is initialized early so we don&#39;t expect it to be null, but
 431           // if it is we can&#39;t risk doing an initialization that might
 432           // trigger additional out-of-memory conditions
 433           if (tty != NULL) {
 434             char klass_name[256];
 435             char tmp_sig_name[16];
 436             const char* sig_name = &quot;UNKNOWN&quot;;
 437             InstanceKlass::cast(PENDING_EXCEPTION-&gt;klass())-&gt;
 438               name()-&gt;as_klass_external_name(klass_name, 256);
 439             if (os::exception_name(sig, tmp_sig_name, 16) != NULL)
 440               sig_name = tmp_sig_name;
 441             warning(&quot;Exception %s occurred dispatching signal %s to handler&quot;
 442                     &quot;- the VM may need to be forcibly terminated&quot;,
 443                     klass_name, sig_name );
 444           }
 445           CLEAR_PENDING_EXCEPTION;
 446         }
 447       }
 448     }
 449   }
 450 }
 451 
 452 void os::init_before_ergo() {
 453   initialize_initial_active_processor_count();
 454   // We need to initialize large page support here because ergonomics takes some
 455   // decisions depending on large page support and the calculated large page size.
 456   large_page_init();
 457 
 458   // We need to adapt the configured number of stack protection pages given
 459   // in 4K pages to the actual os page size. We must do this before setting
 460   // up minimal stack sizes etc. in os::init_2().
 461   JavaThread::set_stack_red_zone_size     (align_up(StackRedPages      * 4 * K, vm_page_size()));
 462   JavaThread::set_stack_yellow_zone_size  (align_up(StackYellowPages   * 4 * K, vm_page_size()));
 463   JavaThread::set_stack_reserved_zone_size(align_up(StackReservedPages * 4 * K, vm_page_size()));
 464   JavaThread::set_stack_shadow_zone_size  (align_up(StackShadowPages   * 4 * K, vm_page_size()));
 465 
 466   // VM version initialization identifies some characteristics of the
 467   // platform that are used during ergonomic decisions.
 468   VM_Version::init_before_ergo();
 469 }
 470 
 471 void os::initialize_jdk_signal_support(TRAPS) {
 472   if (!ReduceSignalUsage) {
 473     // Setup JavaThread for processing signals
 474     const char thread_name[] = &quot;Signal Dispatcher&quot;;
 475     Handle string = java_lang_String::create_from_str(thread_name, CHECK);
 476 
 477     // Initialize thread_oop to put it into the system threadGroup
 478     Handle thread_group (THREAD, Universe::system_thread_group());
 479     Handle thread_oop = JavaCalls::construct_new_instance(SystemDictionary::Thread_klass(),
 480                            vmSymbols::threadgroup_string_void_signature(),
 481                            thread_group,
 482                            string,
 483                            CHECK);
 484 
 485     Klass* group = SystemDictionary::ThreadGroup_klass();
 486     JavaValue result(T_VOID);
 487     JavaCalls::call_special(&amp;result,
 488                             thread_group,
 489                             group,
 490                             vmSymbols::add_method_name(),
 491                             vmSymbols::thread_void_signature(),
 492                             thread_oop,
 493                             CHECK);
 494 
 495     { MutexLocker mu(THREAD, Threads_lock);
 496       JavaThread* signal_thread = new JavaThread(&amp;signal_thread_entry);
 497 
 498       // At this point it may be possible that no osthread was created for the
 499       // JavaThread due to lack of memory. We would have to throw an exception
 500       // in that case. However, since this must work and we do not allow
 501       // exceptions anyway, check and abort if this fails.
 502       if (signal_thread == NULL || signal_thread-&gt;osthread() == NULL) {
 503         vm_exit_during_initialization(&quot;java.lang.OutOfMemoryError&quot;,
 504                                       os::native_thread_creation_failed_msg());
 505       }
 506 
 507       java_lang_Thread::set_thread(thread_oop(), signal_thread);
 508       java_lang_Thread::set_priority(thread_oop(), NearMaxPriority);
 509       java_lang_Thread::set_daemon(thread_oop());
 510 
 511       signal_thread-&gt;set_threadObj(thread_oop());
 512       Threads::add(signal_thread);
 513       Thread::start(signal_thread);
 514     }
 515     // Handle ^BREAK
 516     os::signal(SIGBREAK, os::user_handler());
 517   }
 518 }
 519 
 520 
 521 void os::terminate_signal_thread() {
 522   if (!ReduceSignalUsage)
 523     signal_notify(sigexitnum_pd());
 524 }
 525 
 526 
 527 // --------------------- loading libraries ---------------------
 528 
 529 typedef jint (JNICALL *JNI_OnLoad_t)(JavaVM *, void *);
 530 extern struct JavaVM_ main_vm;
 531 
 532 static void* _native_java_library = NULL;
 533 
 534 void* os::native_java_library() {
 535   if (_native_java_library == NULL) {
 536     char buffer[JVM_MAXPATHLEN];
 537     char ebuf[1024];
 538 
 539     // Load java dll
 540     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
 541                        &quot;java&quot;)) {
 542       _native_java_library = dll_load(buffer, ebuf, sizeof(ebuf));
 543     }
 544     if (_native_java_library == NULL) {
 545       vm_exit_during_initialization(&quot;Unable to load native library&quot;, ebuf);
 546     }
 547 
 548 #if defined(__OpenBSD__)
 549     // Work-around OpenBSD&#39;s lack of $ORIGIN support by pre-loading libnet.so
 550     // ignore errors
 551     if (dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
 552                        &quot;net&quot;)) {
 553       dll_load(buffer, ebuf, sizeof(ebuf));
 554     }
 555 #endif
 556   }
 557   return _native_java_library;
 558 }
 559 
 560 /*
 561  * Support for finding Agent_On(Un)Load/Attach&lt;_lib_name&gt; if it exists.
 562  * If check_lib == true then we are looking for an
 563  * Agent_OnLoad_lib_name or Agent_OnAttach_lib_name function to determine if
 564  * this library is statically linked into the image.
 565  * If check_lib == false then we will look for the appropriate symbol in the
 566  * executable if agent_lib-&gt;is_static_lib() == true or in the shared library
 567  * referenced by &#39;handle&#39;.
 568  */
 569 void* os::find_agent_function(AgentLibrary *agent_lib, bool check_lib,
 570                               const char *syms[], size_t syms_len) {
 571   assert(agent_lib != NULL, &quot;sanity check&quot;);
 572   const char *lib_name;
 573   void *handle = agent_lib-&gt;os_lib();
 574   void *entryName = NULL;
 575   char *agent_function_name;
 576   size_t i;
 577 
 578   // If checking then use the agent name otherwise test is_static_lib() to
 579   // see how to process this lookup
 580   lib_name = ((check_lib || agent_lib-&gt;is_static_lib()) ? agent_lib-&gt;name() : NULL);
 581   for (i = 0; i &lt; syms_len; i++) {
 582     agent_function_name = build_agent_function_name(syms[i], lib_name, agent_lib-&gt;is_absolute_path());
 583     if (agent_function_name == NULL) {
 584       break;
 585     }
 586     entryName = dll_lookup(handle, agent_function_name);
 587     FREE_C_HEAP_ARRAY(char, agent_function_name);
 588     if (entryName != NULL) {
 589       break;
 590     }
 591   }
 592   return entryName;
 593 }
 594 
 595 // See if the passed in agent is statically linked into the VM image.
 596 bool os::find_builtin_agent(AgentLibrary *agent_lib, const char *syms[],
 597                             size_t syms_len) {
 598   void *ret;
 599   void *proc_handle;
 600   void *save_handle;
 601 
 602   assert(agent_lib != NULL, &quot;sanity check&quot;);
 603   if (agent_lib-&gt;name() == NULL) {
 604     return false;
 605   }
 606   proc_handle = get_default_process_handle();
 607   // Check for Agent_OnLoad/Attach_lib_name function
 608   save_handle = agent_lib-&gt;os_lib();
 609   // We want to look in this process&#39; symbol table.
 610   agent_lib-&gt;set_os_lib(proc_handle);
 611   ret = find_agent_function(agent_lib, true, syms, syms_len);
 612   if (ret != NULL) {
 613     // Found an entry point like Agent_OnLoad_lib_name so we have a static agent
 614     agent_lib-&gt;set_valid();
 615     agent_lib-&gt;set_static_lib(true);
 616     return true;
 617   }
 618   agent_lib-&gt;set_os_lib(save_handle);
 619   return false;
 620 }
 621 
 622 // --------------------- heap allocation utilities ---------------------
 623 
 624 char *os::strdup(const char *str, MEMFLAGS flags) {
 625   size_t size = strlen(str);
 626   char *dup_str = (char *)malloc(size + 1, flags);
 627   if (dup_str == NULL) return NULL;
 628   strcpy(dup_str, str);
 629   return dup_str;
 630 }
 631 
 632 char* os::strdup_check_oom(const char* str, MEMFLAGS flags) {
 633   char* p = os::strdup(str, flags);
 634   if (p == NULL) {
 635     vm_exit_out_of_memory(strlen(str) + 1, OOM_MALLOC_ERROR, &quot;os::strdup_check_oom&quot;);
 636   }
 637   return p;
 638 }
 639 
 640 
 641 #define paranoid                 0  /* only set to 1 if you suspect checking code has bug */
 642 
 643 #ifdef ASSERT
 644 
 645 static void verify_memory(void* ptr) {
 646   GuardedMemory guarded(ptr);
 647   if (!guarded.verify_guards()) {
 648     LogTarget(Warning, malloc, free) lt;
 649     ResourceMark rm;
 650     LogStream ls(lt);
 651     ls.print_cr(&quot;## nof_mallocs = &quot; UINT64_FORMAT &quot;, nof_frees = &quot; UINT64_FORMAT, os::num_mallocs, os::num_frees);
 652     ls.print_cr(&quot;## memory stomp:&quot;);
 653     guarded.print_on(&amp;ls);
 654     fatal(&quot;memory stomping error&quot;);
 655   }
 656 }
 657 
 658 #endif
 659 
 660 //
 661 // This function supports testing of the malloc out of memory
 662 // condition without really running the system out of memory.
 663 //
 664 static bool has_reached_max_malloc_test_peak(size_t alloc_size) {
 665   if (MallocMaxTestWords &gt; 0) {
 666     size_t words = (alloc_size / BytesPerWord);
 667 
 668     if ((cur_malloc_words + words) &gt; MallocMaxTestWords) {
 669       return true;
 670     }
 671     Atomic::add(&amp;cur_malloc_words, words);
 672   }
 673   return false;
 674 }
 675 
 676 void* os::malloc(size_t size, MEMFLAGS flags) {
 677   return os::malloc(size, flags, CALLER_PC);
 678 }
 679 
 680 void* os::malloc(size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {
 681   NOT_PRODUCT(inc_stat_counter(&amp;num_mallocs, 1));
 682   NOT_PRODUCT(inc_stat_counter(&amp;alloc_bytes, size));
 683 
 684   // Since os::malloc can be called when the libjvm.{dll,so} is
 685   // first loaded and we don&#39;t have a thread yet we must accept NULL also here.
 686   assert(!os::ThreadCrashProtection::is_crash_protected(Thread::current_or_null()),
 687          &quot;malloc() not allowed when crash protection is set&quot;);
 688 
 689   if (size == 0) {
 690     // return a valid pointer if size is zero
 691     // if NULL is returned the calling functions assume out of memory.
 692     size = 1;
 693   }
 694 
 695   // NMT support
 696   NMT_TrackingLevel level = MemTracker::tracking_level();
 697   size_t            nmt_header_size = MemTracker::malloc_header_size(level);
 698 
 699 #ifndef ASSERT
 700   const size_t alloc_size = size + nmt_header_size;
 701 #else
 702   const size_t alloc_size = GuardedMemory::get_total_size(size + nmt_header_size);
 703   if (size + nmt_header_size &gt; alloc_size) { // Check for rollover.
 704     return NULL;
 705   }
 706 #endif
 707 
 708   // For the test flag -XX:MallocMaxTestWords
 709   if (has_reached_max_malloc_test_peak(size)) {
 710     return NULL;
 711   }
 712 
 713   u_char* ptr;
 714   ptr = (u_char*)::malloc(alloc_size);
 715 
 716 #ifdef ASSERT
 717   if (ptr == NULL) {
 718     return NULL;
 719   }
 720   // Wrap memory with guard
 721   GuardedMemory guarded(ptr, size + nmt_header_size);
 722   ptr = guarded.get_user_ptr();
 723 
 724   if ((intptr_t)ptr == (intptr_t)MallocCatchPtr) {
 725     log_warning(malloc, free)(&quot;os::malloc caught, &quot; SIZE_FORMAT &quot; bytes --&gt; &quot; PTR_FORMAT, size, p2i(ptr));
 726     breakpoint();
 727   }
 728   if (paranoid) {
 729     verify_memory(ptr);
 730   }
 731 #endif
 732 
 733   // we do not track guard memory
 734   return MemTracker::record_malloc((address)ptr, size, memflags, stack, level);
 735 }
 736 
 737 void* os::realloc(void *memblock, size_t size, MEMFLAGS flags) {
 738   return os::realloc(memblock, size, flags, CALLER_PC);
 739 }
 740 
 741 void* os::realloc(void *memblock, size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) {
 742 
 743   // For the test flag -XX:MallocMaxTestWords
 744   if (has_reached_max_malloc_test_peak(size)) {
 745     return NULL;
 746   }
 747 
 748   if (size == 0) {
 749     // return a valid pointer if size is zero
 750     // if NULL is returned the calling functions assume out of memory.
 751     size = 1;
 752   }
 753 
 754 #ifndef ASSERT
 755   NOT_PRODUCT(inc_stat_counter(&amp;num_mallocs, 1));
 756   NOT_PRODUCT(inc_stat_counter(&amp;alloc_bytes, size));
 757    // NMT support
 758   NMT_TrackingLevel level = MemTracker::tracking_level();
 759   void* membase = MemTracker::record_free(memblock, level);
 760   size_t  nmt_header_size = MemTracker::malloc_header_size(level);
 761   void* ptr = ::realloc(membase, size + nmt_header_size);
 762   return MemTracker::record_malloc(ptr, size, memflags, stack, level);
 763 #else
 764   if (memblock == NULL) {
 765     return os::malloc(size, memflags, stack);
 766   }
 767   if ((intptr_t)memblock == (intptr_t)MallocCatchPtr) {
 768     log_warning(malloc, free)(&quot;os::realloc caught &quot; PTR_FORMAT, p2i(memblock));
 769     breakpoint();
 770   }
 771   // NMT support
 772   void* membase = MemTracker::malloc_base(memblock);
 773   verify_memory(membase);
 774   // always move the block
 775   void* ptr = os::malloc(size, memflags, stack);
 776   // Copy to new memory if malloc didn&#39;t fail
 777   if (ptr != NULL ) {
 778     GuardedMemory guarded(MemTracker::malloc_base(memblock));
 779     // Guard&#39;s user data contains NMT header
 780     size_t memblock_size = guarded.get_user_size() - MemTracker::malloc_header_size(memblock);
 781     memcpy(ptr, memblock, MIN2(size, memblock_size));
 782     if (paranoid) {
 783       verify_memory(MemTracker::malloc_base(ptr));
 784     }
 785     os::free(memblock);
 786   }
 787   return ptr;
 788 #endif
 789 }
 790 
 791 // handles NULL pointers
 792 void  os::free(void *memblock) {
 793   NOT_PRODUCT(inc_stat_counter(&amp;num_frees, 1));
 794 #ifdef ASSERT
 795   if (memblock == NULL) return;
 796   if ((intptr_t)memblock == (intptr_t)MallocCatchPtr) {
 797     log_warning(malloc, free)(&quot;os::free caught &quot; PTR_FORMAT, p2i(memblock));
 798     breakpoint();
 799   }
 800   void* membase = MemTracker::record_free(memblock, MemTracker::tracking_level());
 801   verify_memory(membase);
 802 
 803   GuardedMemory guarded(membase);
 804   size_t size = guarded.get_user_size();
 805   inc_stat_counter(&amp;free_bytes, size);
 806   membase = guarded.release_for_freeing();
 807   ::free(membase);
 808 #else
 809   void* membase = MemTracker::record_free(memblock, MemTracker::tracking_level());
 810   ::free(membase);
 811 #endif
 812 }
 813 
 814 void os::init_random(unsigned int initval) {
 815   _rand_seed = initval;
 816 }
 817 
 818 
 819 static int random_helper(unsigned int rand_seed) {
 820   /* standard, well-known linear congruential random generator with
 821    * next_rand = (16807*seed) mod (2**31-1)
 822    * see
 823    * (1) &quot;Random Number Generators: Good Ones Are Hard to Find&quot;,
 824    *      S.K. Park and K.W. Miller, Communications of the ACM 31:10 (Oct 1988),
 825    * (2) &quot;Two Fast Implementations of the &#39;Minimal Standard&#39; Random
 826    *     Number Generator&quot;, David G. Carta, Comm. ACM 33, 1 (Jan 1990), pp. 87-88.
 827   */
 828   const unsigned int a = 16807;
 829   const unsigned int m = 2147483647;
 830   const int q = m / a;        assert(q == 127773, &quot;weird math&quot;);
 831   const int r = m % a;        assert(r == 2836, &quot;weird math&quot;);
 832 
 833   // compute az=2^31p+q
 834   unsigned int lo = a * (rand_seed &amp; 0xFFFF);
 835   unsigned int hi = a * (rand_seed &gt;&gt; 16);
 836   lo += (hi &amp; 0x7FFF) &lt;&lt; 16;
 837 
 838   // if q overflowed, ignore the overflow and increment q
 839   if (lo &gt; m) {
 840     lo &amp;= m;
 841     ++lo;
 842   }
 843   lo += hi &gt;&gt; 15;
 844 
 845   // if (p+q) overflowed, ignore the overflow and increment (p+q)
 846   if (lo &gt; m) {
 847     lo &amp;= m;
 848     ++lo;
 849   }
 850   return lo;
 851 }
 852 
 853 int os::random() {
 854   // Make updating the random seed thread safe.
 855   while (true) {
 856     unsigned int seed = _rand_seed;
 857     unsigned int rand = random_helper(seed);
 858     if (Atomic::cmpxchg(&amp;_rand_seed, seed, rand) == seed) {
 859       return static_cast&lt;int&gt;(rand);
 860     }
 861   }
 862 }
 863 
 864 // The INITIALIZED state is distinguished from the SUSPENDED state because the
 865 // conditions in which a thread is first started are different from those in which
 866 // a suspension is resumed.  These differences make it hard for us to apply the
 867 // tougher checks when starting threads that we want to do when resuming them.
 868 // However, when start_thread is called as a result of Thread.start, on a Java
 869 // thread, the operation is synchronized on the Java Thread object.  So there
 870 // cannot be a race to start the thread and hence for the thread to exit while
 871 // we are working on it.  Non-Java threads that start Java threads either have
 872 // to do so in a context in which races are impossible, or should do appropriate
 873 // locking.
 874 
 875 void os::start_thread(Thread* thread) {
 876   // guard suspend/resume
 877   MutexLocker ml(thread-&gt;SR_lock(), Mutex::_no_safepoint_check_flag);
 878   OSThread* osthread = thread-&gt;osthread();
 879   osthread-&gt;set_state(RUNNABLE);
 880   pd_start_thread(thread);
 881 }
 882 
 883 void os::abort(bool dump_core) {
 884   abort(dump_core &amp;&amp; CreateCoredumpOnCrash, NULL, NULL);
 885 }
 886 
 887 //---------------------------------------------------------------------------
 888 // Helper functions for fatal error handler
 889 
 890 void os::print_hex_dump(outputStream* st, address start, address end, int unitsize) {
 891   assert(unitsize == 1 || unitsize == 2 || unitsize == 4 || unitsize == 8, &quot;just checking&quot;);
 892 
 893   start = align_down(start, unitsize);
 894 
 895   int cols = 0;
 896   int cols_per_line = 0;
 897   switch (unitsize) {
 898     case 1: cols_per_line = 16; break;
 899     case 2: cols_per_line = 8;  break;
 900     case 4: cols_per_line = 4;  break;
 901     case 8: cols_per_line = 2;  break;
 902     default: return;
 903   }
 904 
 905   address p = start;
 906   st-&gt;print(PTR_FORMAT &quot;:   &quot;, p2i(start));
 907   while (p &lt; end) {
 908     if (is_readable_pointer(p)) {
 909       switch (unitsize) {
 910         case 1: st-&gt;print(&quot;%02x&quot;, *(u1*)p); break;
 911         case 2: st-&gt;print(&quot;%04x&quot;, *(u2*)p); break;
 912         case 4: st-&gt;print(&quot;%08x&quot;, *(u4*)p); break;
 913         case 8: st-&gt;print(&quot;%016&quot; FORMAT64_MODIFIER &quot;x&quot;, *(u8*)p); break;
 914       }
 915     } else {
 916       st-&gt;print(&quot;%*.*s&quot;, 2*unitsize, 2*unitsize, &quot;????????????????&quot;);
 917     }
 918     p += unitsize;
 919     cols++;
 920     if (cols &gt;= cols_per_line &amp;&amp; p &lt; end) {
 921        cols = 0;
 922        st-&gt;cr();
 923        st-&gt;print(PTR_FORMAT &quot;:   &quot;, p2i(p));
 924     } else {
 925        st-&gt;print(&quot; &quot;);
 926     }
 927   }
 928   st-&gt;cr();
 929 }
 930 
 931 void os::print_dhm(outputStream* st, const char* startStr, long sec) {
 932   long days    = sec/86400;
 933   long hours   = (sec/3600) - (days * 24);
 934   long minutes = (sec/60) - (days * 1440) - (hours * 60);
 935   if (startStr == NULL) startStr = &quot;&quot;;
 936   st-&gt;print_cr(&quot;%s %ld days %ld:%02ld hours&quot;, startStr, days, hours, minutes);
 937 }
 938 
 939 void os::print_instructions(outputStream* st, address pc, int unitsize) {
 940   st-&gt;print_cr(&quot;Instructions: (pc=&quot; PTR_FORMAT &quot;)&quot;, p2i(pc));
 941   print_hex_dump(st, pc - 256, pc + 256, unitsize);
 942 }
 943 
 944 void os::print_environment_variables(outputStream* st, const char** env_list) {
 945   if (env_list) {
 946     st-&gt;print_cr(&quot;Environment Variables:&quot;);
 947 
 948     for (int i = 0; env_list[i] != NULL; i++) {
 949       char *envvar = ::getenv(env_list[i]);
 950       if (envvar != NULL) {
 951         st-&gt;print(&quot;%s&quot;, env_list[i]);
 952         st-&gt;print(&quot;=&quot;);
 953         st-&gt;print_cr(&quot;%s&quot;, envvar);
 954       }
 955     }
 956   }
 957 }
 958 
 959 void os::print_cpu_info(outputStream* st, char* buf, size_t buflen) {
 960   // cpu
 961   st-&gt;print(&quot;CPU:&quot;);
 962   st-&gt;print(&quot;total %d&quot;, os::processor_count());
 963   // It&#39;s not safe to query number of active processors after crash
 964   // st-&gt;print(&quot;(active %d)&quot;, os::active_processor_count()); but we can
 965   // print the initial number of active processors.
 966   // We access the raw value here because the assert in the accessor will
 967   // fail if the crash occurs before initialization of this value.
 968   st-&gt;print(&quot; (initial active %d)&quot;, _initial_active_processor_count);
 969   st-&gt;print(&quot; %s&quot;, VM_Version::features_string());
 970   st-&gt;cr();
 971   pd_print_cpu_info(st, buf, buflen);
 972 }
 973 
 974 // Print a one line string summarizing the cpu, number of cores, memory, and operating system version
 975 void os::print_summary_info(outputStream* st, char* buf, size_t buflen) {
 976   st-&gt;print(&quot;Host: &quot;);
 977 #ifndef PRODUCT
 978   if (get_host_name(buf, buflen)) {
 979     st-&gt;print(&quot;%s, &quot;, buf);
 980   }
 981 #endif // PRODUCT
 982   get_summary_cpu_info(buf, buflen);
 983   st-&gt;print(&quot;%s, &quot;, buf);
 984   size_t mem = physical_memory()/G;
 985   if (mem == 0) {  // for low memory systems
 986     mem = physical_memory()/M;
 987     st-&gt;print(&quot;%d cores, &quot; SIZE_FORMAT &quot;M, &quot;, processor_count(), mem);
 988   } else {
 989     st-&gt;print(&quot;%d cores, &quot; SIZE_FORMAT &quot;G, &quot;, processor_count(), mem);
 990   }
 991   get_summary_os_info(buf, buflen);
 992   st-&gt;print_raw(buf);
 993   st-&gt;cr();
 994 }
 995 
 996 void os::print_date_and_time(outputStream *st, char* buf, size_t buflen) {
 997   const int secs_per_day  = 86400;
 998   const int secs_per_hour = 3600;
 999   const int secs_per_min  = 60;
1000 
1001   time_t tloc;
1002   (void)time(&amp;tloc);
1003   char* timestring = ctime(&amp;tloc);  // ctime adds newline.
1004   // edit out the newline
1005   char* nl = strchr(timestring, &#39;\n&#39;);
1006   if (nl != NULL) {
1007     *nl = &#39;\0&#39;;
1008   }
1009 
1010   struct tm tz;
1011   if (localtime_pd(&amp;tloc, &amp;tz) != NULL) {
1012     ::strftime(buf, buflen, &quot;%Z&quot;, &amp;tz);
1013     st-&gt;print(&quot;Time: %s %s&quot;, timestring, buf);
1014   } else {
1015     st-&gt;print(&quot;Time: %s&quot;, timestring);
1016   }
1017 
1018   double t = os::elapsedTime();
<a name="1" id="anc1"></a><span class="line-modified">1019   // NOTE: a crash using printf(&quot;%f&quot;,...) on Linux was historically noted here.</span>


1020   int eltime = (int)t;  // elapsed time in seconds
<a name="2" id="anc2"></a><span class="line-added">1021   int eltimeFraction = (int) ((t - eltime) * 1000000);</span>
1022 
1023   // print elapsed time in a human-readable format:
1024   int eldays = eltime / secs_per_day;
1025   int day_secs = eldays * secs_per_day;
1026   int elhours = (eltime - day_secs) / secs_per_hour;
1027   int hour_secs = elhours * secs_per_hour;
1028   int elmins = (eltime - day_secs - hour_secs) / secs_per_min;
1029   int minute_secs = elmins * secs_per_min;
1030   int elsecs = (eltime - day_secs - hour_secs - minute_secs);
<a name="3" id="anc3"></a><span class="line-modified">1031   st-&gt;print_cr(&quot; elapsed time: %d.%06d seconds (%dd %dh %dm %ds)&quot;, eltime, eltimeFraction, eldays, elhours, elmins, elsecs);</span>
1032 }
1033 
1034 
1035 // Check if pointer can be read from (4-byte read access).
1036 // Helps to prove validity of a not-NULL pointer.
1037 // Returns true in very early stages of VM life when stub is not yet generated.
1038 #define SAFEFETCH_DEFAULT true
1039 bool os::is_readable_pointer(const void* p) {
1040   if (!CanUseSafeFetch32()) {
1041     return SAFEFETCH_DEFAULT;
1042   }
1043   int* const aligned = (int*) align_down((intptr_t)p, 4);
1044   int cafebabe = 0xcafebabe;  // tester value 1
1045   int deadbeef = 0xdeadbeef;  // tester value 2
1046   return (SafeFetch32(aligned, cafebabe) != cafebabe) || (SafeFetch32(aligned, deadbeef) != deadbeef);
1047 }
1048 
1049 bool os::is_readable_range(const void* from, const void* to) {
1050   if ((uintptr_t)from &gt;= (uintptr_t)to) return false;
1051   for (uintptr_t p = align_down((uintptr_t)from, min_page_size()); p &lt; (uintptr_t)to; p += min_page_size()) {
1052     if (!is_readable_pointer((const void*)p)) {
1053       return false;
1054     }
1055   }
1056   return true;
1057 }
1058 
1059 
1060 // moved from debug.cpp (used to be find()) but still called from there
1061 // The verbose parameter is only set by the debug code in one case
1062 void os::print_location(outputStream* st, intptr_t x, bool verbose) {
1063   address addr = (address)x;
1064   // Handle NULL first, so later checks don&#39;t need to protect against it.
1065   if (addr == NULL) {
1066     st-&gt;print_cr(&quot;0x0 is NULL&quot;);
1067     return;
1068   }
1069 
1070   // Check if addr points into a code blob.
1071   CodeBlob* b = CodeCache::find_blob_unsafe(addr);
1072   if (b != NULL) {
1073     b-&gt;dump_for_addr(addr, st, verbose);
1074     return;
1075   }
1076 
1077   // Check if addr points into Java heap.
1078   if (Universe::heap()-&gt;print_location(st, addr)) {
1079     return;
1080   }
1081 
1082   bool accessible = is_readable_pointer(addr);
1083 
1084   // Check if addr is a JNI handle.
1085   if (align_down((intptr_t)addr, sizeof(intptr_t)) != 0 &amp;&amp; accessible) {
1086     if (JNIHandles::is_global_handle((jobject) addr)) {
1087       st-&gt;print_cr(INTPTR_FORMAT &quot; is a global jni handle&quot;, p2i(addr));
1088       return;
1089     }
1090     if (JNIHandles::is_weak_global_handle((jobject) addr)) {
1091       st-&gt;print_cr(INTPTR_FORMAT &quot; is a weak global jni handle&quot;, p2i(addr));
1092       return;
1093     }
1094 #ifndef PRODUCT
1095     // we don&#39;t keep the block list in product mode
1096     if (JNIHandles::is_local_handle((jobject) addr)) {
1097       st-&gt;print_cr(INTPTR_FORMAT &quot; is a local jni handle&quot;, p2i(addr));
1098       return;
1099     }
1100 #endif
1101   }
1102 
1103   // Check if addr belongs to a Java thread.
1104   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *thread = jtiwh.next(); ) {
1105     // If the addr is a java thread print information about that.
1106     if (addr == (address)thread) {
1107       if (verbose) {
1108         thread-&gt;print_on(st);
1109       } else {
1110         st-&gt;print_cr(INTPTR_FORMAT &quot; is a thread&quot;, p2i(addr));
1111       }
1112       return;
1113     }
1114     // If the addr is in the stack region for this thread then report that
1115     // and print thread info
<a name="4" id="anc4"></a><span class="line-modified">1116     if (thread-&gt;is_in_full_stack(addr)) {</span>
1117       st-&gt;print_cr(INTPTR_FORMAT &quot; is pointing into the stack for thread: &quot;
1118                    INTPTR_FORMAT, p2i(addr), p2i(thread));
1119       if (verbose) thread-&gt;print_on(st);
1120       return;
1121     }
1122   }
1123 
1124   // Check if in metaspace and print types that have vptrs
1125   if (Metaspace::contains(addr)) {
1126     if (Klass::is_valid((Klass*)addr)) {
1127       st-&gt;print_cr(INTPTR_FORMAT &quot; is a pointer to class: &quot;, p2i(addr));
1128       ((Klass*)addr)-&gt;print_on(st);
1129     } else if (Method::is_valid_method((const Method*)addr)) {
1130       ((Method*)addr)-&gt;print_value_on(st);
1131       st-&gt;cr();
1132     } else {
1133       // Use addr-&gt;print() from the debugger instead (not here)
1134       st-&gt;print_cr(INTPTR_FORMAT &quot; is pointing into metadata&quot;, p2i(addr));
1135     }
1136     return;
1137   }
1138 
1139   // Compressed klass needs to be decoded first.
1140 #ifdef _LP64
1141   if (UseCompressedClassPointers &amp;&amp; ((uintptr_t)addr &amp;~ (uintptr_t)max_juint) == 0) {
1142     narrowKlass narrow_klass = (narrowKlass)(uintptr_t)addr;
1143     Klass* k = CompressedKlassPointers::decode_raw(narrow_klass);
1144 
1145     if (Klass::is_valid(k)) {
1146       st-&gt;print_cr(UINT32_FORMAT &quot; is a compressed pointer to class: &quot; INTPTR_FORMAT, narrow_klass, p2i((HeapWord*)k));
1147       k-&gt;print_on(st);
1148       return;
1149     }
1150   }
1151 #endif
1152 
1153   // Try an OS specific find
1154   if (os::find(addr, st)) {
1155     return;
1156   }
1157 
1158   if (accessible) {
1159     st-&gt;print(INTPTR_FORMAT &quot; points into unknown readable memory:&quot;, p2i(addr));
1160     for (address p = addr; p &lt; align_up(addr + 1, sizeof(intptr_t)); ++p) {
1161       st-&gt;print(&quot; %02x&quot;, *(u1*)p);
1162     }
1163     st-&gt;cr();
1164     return;
1165   }
1166 
1167   st-&gt;print_cr(INTPTR_FORMAT &quot; is an unknown value&quot;, p2i(addr));
1168 }
1169 
1170 // Looks like all platforms can use the same function to check if C
1171 // stack is walkable beyond current frame. The check for fp() is not
1172 // necessary on Sparc, but it&#39;s harmless.
1173 bool os::is_first_C_frame(frame* fr) {
1174   // Load up sp, fp, sender sp and sender fp, check for reasonable values.
1175   // Check usp first, because if that&#39;s bad the other accessors may fault
1176   // on some architectures.  Ditto ufp second, etc.
1177   uintptr_t fp_align_mask = (uintptr_t)(sizeof(address)-1);
1178   // sp on amd can be 32 bit aligned.
1179   uintptr_t sp_align_mask = (uintptr_t)(sizeof(int)-1);
1180 
1181   uintptr_t usp    = (uintptr_t)fr-&gt;sp();
1182   if ((usp &amp; sp_align_mask) != 0) return true;
1183 
1184   uintptr_t ufp    = (uintptr_t)fr-&gt;fp();
1185   if ((ufp &amp; fp_align_mask) != 0) return true;
1186 
1187   uintptr_t old_sp = (uintptr_t)fr-&gt;sender_sp();
1188   if ((old_sp &amp; sp_align_mask) != 0) return true;
1189   if (old_sp == 0 || old_sp == (uintptr_t)-1) return true;
1190 
1191   uintptr_t old_fp = (uintptr_t)fr-&gt;link();
1192   if ((old_fp &amp; fp_align_mask) != 0) return true;
1193   if (old_fp == 0 || old_fp == (uintptr_t)-1 || old_fp == ufp) return true;
1194 
1195   // stack grows downwards; if old_fp is below current fp or if the stack
1196   // frame is too large, either the stack is corrupted or fp is not saved
1197   // on stack (i.e. on x86, ebp may be used as general register). The stack
1198   // is not walkable beyond current frame.
1199   if (old_fp &lt; ufp) return true;
1200   if (old_fp - ufp &gt; 64 * K) return true;
1201 
1202   return false;
1203 }
1204 
1205 
1206 // Set up the boot classpath.
1207 
1208 char* os::format_boot_path(const char* format_string,
1209                            const char* home,
1210                            int home_len,
1211                            char fileSep,
1212                            char pathSep) {
1213     assert((fileSep == &#39;/&#39; &amp;&amp; pathSep == &#39;:&#39;) ||
1214            (fileSep == &#39;\\&#39; &amp;&amp; pathSep == &#39;;&#39;), &quot;unexpected separator chars&quot;);
1215 
1216     // Scan the format string to determine the length of the actual
1217     // boot classpath, and handle platform dependencies as well.
1218     int formatted_path_len = 0;
1219     const char* p;
1220     for (p = format_string; *p != 0; ++p) {
1221         if (*p == &#39;%&#39;) formatted_path_len += home_len - 1;
1222         ++formatted_path_len;
1223     }
1224 
1225     char* formatted_path = NEW_C_HEAP_ARRAY(char, formatted_path_len + 1, mtInternal);
1226 
1227     // Create boot classpath from format, substituting separator chars and
1228     // java home directory.
1229     char* q = formatted_path;
1230     for (p = format_string; *p != 0; ++p) {
1231         switch (*p) {
1232         case &#39;%&#39;:
1233             strcpy(q, home);
1234             q += home_len;
1235             break;
1236         case &#39;/&#39;:
1237             *q++ = fileSep;
1238             break;
1239         case &#39;:&#39;:
1240             *q++ = pathSep;
1241             break;
1242         default:
1243             *q++ = *p;
1244         }
1245     }
1246     *q = &#39;\0&#39;;
1247 
1248     assert((q - formatted_path) == formatted_path_len, &quot;formatted_path size botched&quot;);
1249     return formatted_path;
1250 }
1251 
1252 // This function is a proxy to fopen, it tries to add a non standard flag (&#39;e&#39; or &#39;N&#39;)
1253 // that ensures automatic closing of the file on exec. If it can not find support in
1254 // the underlying c library, it will make an extra system call (fcntl) to ensure automatic
1255 // closing of the file on exec.
1256 FILE* os::fopen(const char* path, const char* mode) {
1257   char modified_mode[20];
1258   assert(strlen(mode) + 1 &lt; sizeof(modified_mode), &quot;mode chars plus one extra must fit in buffer&quot;);
1259   sprintf(modified_mode, &quot;%s&quot; LINUX_ONLY(&quot;e&quot;) BSD_ONLY(&quot;e&quot;) WINDOWS_ONLY(&quot;N&quot;), mode);
1260   FILE* file = ::fopen(path, modified_mode);
1261 
1262 #if !(defined LINUX || defined BSD || defined _WINDOWS)
1263   // assume fcntl FD_CLOEXEC support as a backup solution when &#39;e&#39; or &#39;N&#39;
1264   // is not supported as mode in fopen
1265   if (file != NULL) {
1266     int fd = fileno(file);
1267     if (fd != -1) {
1268       int fd_flags = fcntl(fd, F_GETFD);
1269       if (fd_flags != -1) {
1270         fcntl(fd, F_SETFD, fd_flags | FD_CLOEXEC);
1271       }
1272     }
1273   }
1274 #endif
1275 
1276   return file;
1277 }
1278 
1279 bool os::set_boot_path(char fileSep, char pathSep) {
1280   const char* home = Arguments::get_java_home();
1281   int home_len = (int)strlen(home);
1282 
1283   struct stat st;
1284 
1285   // modular image if &quot;modules&quot; jimage exists
1286   char* jimage = format_boot_path(&quot;%/lib/&quot; MODULES_IMAGE_NAME, home, home_len, fileSep, pathSep);
1287   if (jimage == NULL) return false;
1288   bool has_jimage = (os::stat(jimage, &amp;st) == 0);
1289   if (has_jimage) {
1290     Arguments::set_sysclasspath(jimage, true);
1291     FREE_C_HEAP_ARRAY(char, jimage);
1292     return true;
1293   }
1294   FREE_C_HEAP_ARRAY(char, jimage);
1295 
1296   // check if developer build with exploded modules
1297   char* base_classes = format_boot_path(&quot;%/modules/&quot; JAVA_BASE_NAME, home, home_len, fileSep, pathSep);
1298   if (base_classes == NULL) return false;
1299   if (os::stat(base_classes, &amp;st) == 0) {
1300     Arguments::set_sysclasspath(base_classes, false);
1301     FREE_C_HEAP_ARRAY(char, base_classes);
1302     return true;
1303   }
1304   FREE_C_HEAP_ARRAY(char, base_classes);
1305 
1306   return false;
1307 }
1308 
1309 // Splits a path, based on its separator, the number of
1310 // elements is returned back in &quot;elements&quot;.
1311 // file_name_length is used as a modifier for each path&#39;s
1312 // length when compared to JVM_MAXPATHLEN. So if you know
1313 // each returned path will have something appended when
1314 // in use, you can pass the length of that in
1315 // file_name_length, to ensure we detect if any path
1316 // exceeds the maximum path length once prepended onto
1317 // the sub-path/file name.
1318 // It is the callers responsibility to:
1319 //   a&gt; check the value of &quot;elements&quot;, which may be 0.
1320 //   b&gt; ignore any empty path elements
1321 //   c&gt; free up the data.
1322 char** os::split_path(const char* path, size_t* elements, size_t file_name_length) {
1323   *elements = (size_t)0;
1324   if (path == NULL || strlen(path) == 0 || file_name_length == (size_t)NULL) {
1325     return NULL;
1326   }
1327   const char psepchar = *os::path_separator();
1328   char* inpath = NEW_C_HEAP_ARRAY(char, strlen(path) + 1, mtInternal);
1329   strcpy(inpath, path);
1330   size_t count = 1;
1331   char* p = strchr(inpath, psepchar);
1332   // Get a count of elements to allocate memory
1333   while (p != NULL) {
1334     count++;
1335     p++;
1336     p = strchr(p, psepchar);
1337   }
1338 
1339   char** opath = NEW_C_HEAP_ARRAY(char*, count, mtInternal);
1340 
1341   // do the actual splitting
1342   p = inpath;
1343   for (size_t i = 0 ; i &lt; count ; i++) {
1344     size_t len = strcspn(p, os::path_separator());
1345     if (len + file_name_length &gt; JVM_MAXPATHLEN) {
1346       // release allocated storage before exiting the vm
1347       free_array_of_char_arrays(opath, i++);
1348       vm_exit_during_initialization(&quot;The VM tried to use a path that exceeds the maximum path length for &quot;
1349                                     &quot;this system. Review path-containing parameters and properties, such as &quot;
1350                                     &quot;sun.boot.library.path, to identify potential sources for this path.&quot;);
1351     }
1352     // allocate the string and add terminator storage
1353     char* s = NEW_C_HEAP_ARRAY(char, len + 1, mtInternal);
1354     strncpy(s, p, len);
1355     s[len] = &#39;\0&#39;;
1356     opath[i] = s;
1357     p += len + 1;
1358   }
1359   FREE_C_HEAP_ARRAY(char, inpath);
1360   *elements = count;
1361   return opath;
1362 }
1363 
1364 // Returns true if the current stack pointer is above the stack shadow
1365 // pages, false otherwise.
1366 bool os::stack_shadow_pages_available(Thread *thread, const methodHandle&amp; method, address sp) {
1367   if (!thread-&gt;is_Java_thread()) return false;
1368   // Check if we have StackShadowPages above the yellow zone.  This parameter
1369   // is dependent on the depth of the maximum VM call stack possible from
1370   // the handler for stack overflow.  &#39;instanceof&#39; in the stack overflow
1371   // handler or a println uses at least 8k stack of VM and native code
1372   // respectively.
1373   const int framesize_in_bytes =
1374     Interpreter::size_top_interpreter_activation(method()) * wordSize;
1375 
1376   address limit = ((JavaThread*)thread)-&gt;stack_end() +
1377                   (JavaThread::stack_guard_zone_size() + JavaThread::stack_shadow_zone_size());
1378 
1379   return sp &gt; (limit + framesize_in_bytes);
1380 }
1381 
1382 size_t os::page_size_for_region(size_t region_size, size_t min_pages, bool must_be_aligned) {
1383   assert(min_pages &gt; 0, &quot;sanity&quot;);
1384   if (UseLargePages) {
1385     const size_t max_page_size = region_size / min_pages;
1386 
1387     for (size_t i = 0; _page_sizes[i] != 0; ++i) {
1388       const size_t page_size = _page_sizes[i];
1389       if (page_size &lt;= max_page_size) {
1390         if (!must_be_aligned || is_aligned(region_size, page_size)) {
1391           return page_size;
1392         }
1393       }
1394     }
1395   }
1396 
1397   return vm_page_size();
1398 }
1399 
1400 size_t os::page_size_for_region_aligned(size_t region_size, size_t min_pages) {
1401   return page_size_for_region(region_size, min_pages, true);
1402 }
1403 
1404 size_t os::page_size_for_region_unaligned(size_t region_size, size_t min_pages) {
1405   return page_size_for_region(region_size, min_pages, false);
1406 }
1407 
1408 static const char* errno_to_string (int e, bool short_text) {
1409   #define ALL_SHARED_ENUMS(X) \
1410     X(E2BIG, &quot;Argument list too long&quot;) \
1411     X(EACCES, &quot;Permission denied&quot;) \
1412     X(EADDRINUSE, &quot;Address in use&quot;) \
1413     X(EADDRNOTAVAIL, &quot;Address not available&quot;) \
1414     X(EAFNOSUPPORT, &quot;Address family not supported&quot;) \
1415     X(EAGAIN, &quot;Resource unavailable, try again&quot;) \
1416     X(EALREADY, &quot;Connection already in progress&quot;) \
1417     X(EBADF, &quot;Bad file descriptor&quot;) \
1418     X(EBADMSG, &quot;Bad message&quot;) \
1419     X(EBUSY, &quot;Device or resource busy&quot;) \
1420     X(ECANCELED, &quot;Operation canceled&quot;) \
1421     X(ECHILD, &quot;No child processes&quot;) \
1422     X(ECONNABORTED, &quot;Connection aborted&quot;) \
1423     X(ECONNREFUSED, &quot;Connection refused&quot;) \
1424     X(ECONNRESET, &quot;Connection reset&quot;) \
1425     X(EDEADLK, &quot;Resource deadlock would occur&quot;) \
1426     X(EDESTADDRREQ, &quot;Destination address required&quot;) \
1427     X(EDOM, &quot;Mathematics argument out of domain of function&quot;) \
1428     X(EEXIST, &quot;File exists&quot;) \
1429     X(EFAULT, &quot;Bad address&quot;) \
1430     X(EFBIG, &quot;File too large&quot;) \
1431     X(EHOSTUNREACH, &quot;Host is unreachable&quot;) \
1432     X(EIDRM, &quot;Identifier removed&quot;) \
1433     X(EILSEQ, &quot;Illegal byte sequence&quot;) \
1434     X(EINPROGRESS, &quot;Operation in progress&quot;) \
1435     X(EINTR, &quot;Interrupted function&quot;) \
1436     X(EINVAL, &quot;Invalid argument&quot;) \
1437     X(EIO, &quot;I/O error&quot;) \
1438     X(EISCONN, &quot;Socket is connected&quot;) \
1439     X(EISDIR, &quot;Is a directory&quot;) \
1440     X(ELOOP, &quot;Too many levels of symbolic links&quot;) \
1441     X(EMFILE, &quot;Too many open files&quot;) \
1442     X(EMLINK, &quot;Too many links&quot;) \
1443     X(EMSGSIZE, &quot;Message too large&quot;) \
1444     X(ENAMETOOLONG, &quot;Filename too long&quot;) \
1445     X(ENETDOWN, &quot;Network is down&quot;) \
1446     X(ENETRESET, &quot;Connection aborted by network&quot;) \
1447     X(ENETUNREACH, &quot;Network unreachable&quot;) \
1448     X(ENFILE, &quot;Too many files open in system&quot;) \
1449     X(ENOBUFS, &quot;No buffer space available&quot;) \
1450     X(ENODATA, &quot;No message is available on the STREAM head read queue&quot;) \
1451     X(ENODEV, &quot;No such device&quot;) \
1452     X(ENOENT, &quot;No such file or directory&quot;) \
1453     X(ENOEXEC, &quot;Executable file format error&quot;) \
1454     X(ENOLCK, &quot;No locks available&quot;) \
1455     X(ENOLINK, &quot;Reserved&quot;) \
1456     X(ENOMEM, &quot;Not enough space&quot;) \
1457     X(ENOMSG, &quot;No message of the desired type&quot;) \
1458     X(ENOPROTOOPT, &quot;Protocol not available&quot;) \
1459     X(ENOSPC, &quot;No space left on device&quot;) \
1460     X(ENOSR, &quot;No STREAM resources&quot;) \
1461     X(ENOSTR, &quot;Not a STREAM&quot;) \
1462     X(ENOSYS, &quot;Function not supported&quot;) \
1463     X(ENOTCONN, &quot;The socket is not connected&quot;) \
1464     X(ENOTDIR, &quot;Not a directory&quot;) \
1465     X(ENOTEMPTY, &quot;Directory not empty&quot;) \
1466     X(ENOTSOCK, &quot;Not a socket&quot;) \
1467     X(ENOTSUP, &quot;Not supported&quot;) \
1468     X(ENOTTY, &quot;Inappropriate I/O control operation&quot;) \
1469     X(ENXIO, &quot;No such device or address&quot;) \
1470     X(EOPNOTSUPP, &quot;Operation not supported on socket&quot;) \
1471     X(EOVERFLOW, &quot;Value too large to be stored in data type&quot;) \
1472     X(EPERM, &quot;Operation not permitted&quot;) \
1473     X(EPIPE, &quot;Broken pipe&quot;) \
1474     X(EPROTO, &quot;Protocol error&quot;) \
1475     X(EPROTONOSUPPORT, &quot;Protocol not supported&quot;) \
1476     X(EPROTOTYPE, &quot;Protocol wrong type for socket&quot;) \
1477     X(ERANGE, &quot;Result too large&quot;) \
1478     X(EROFS, &quot;Read-only file system&quot;) \
1479     X(ESPIPE, &quot;Invalid seek&quot;) \
1480     X(ESRCH, &quot;No such process&quot;) \
1481     X(ETIME, &quot;Stream ioctl() timeout&quot;) \
1482     X(ETIMEDOUT, &quot;Connection timed out&quot;) \
1483     X(ETXTBSY, &quot;Text file busy&quot;) \
1484     X(EWOULDBLOCK, &quot;Operation would block&quot;) \
1485     X(EXDEV, &quot;Cross-device link&quot;)
1486 
1487   #define DEFINE_ENTRY(e, text) { e, #e, text },
1488 
1489   static const struct {
1490     int v;
1491     const char* short_text;
1492     const char* long_text;
1493   } table [] = {
1494 
1495     ALL_SHARED_ENUMS(DEFINE_ENTRY)
1496 
1497     // The following enums are not defined on all platforms.
1498     #ifdef ESTALE
1499     DEFINE_ENTRY(ESTALE, &quot;Reserved&quot;)
1500     #endif
1501     #ifdef EDQUOT
1502     DEFINE_ENTRY(EDQUOT, &quot;Reserved&quot;)
1503     #endif
1504     #ifdef EMULTIHOP
1505     DEFINE_ENTRY(EMULTIHOP, &quot;Reserved&quot;)
1506     #endif
1507 
1508     // End marker.
1509     { -1, &quot;Unknown errno&quot;, &quot;Unknown error&quot; }
1510 
1511   };
1512 
1513   #undef DEFINE_ENTRY
1514   #undef ALL_FLAGS
1515 
1516   int i = 0;
1517   while (table[i].v != -1 &amp;&amp; table[i].v != e) {
1518     i ++;
1519   }
1520 
1521   return short_text ? table[i].short_text : table[i].long_text;
1522 
1523 }
1524 
1525 const char* os::strerror(int e) {
1526   return errno_to_string(e, false);
1527 }
1528 
1529 const char* os::errno_name(int e) {
1530   return errno_to_string(e, true);
1531 }
1532 
1533 void os::trace_page_sizes(const char* str, const size_t* page_sizes, int count) {
1534   LogTarget(Info, pagesize) log;
1535   if (log.is_enabled()) {
1536     LogStream out(log);
1537 
1538     out.print(&quot;%s: &quot;, str);
1539     for (int i = 0; i &lt; count; ++i) {
1540       out.print(&quot; &quot; SIZE_FORMAT, page_sizes[i]);
1541     }
1542     out.cr();
1543   }
1544 }
1545 
1546 #define trace_page_size_params(size) byte_size_in_exact_unit(size), exact_unit_for_byte_size(size)
1547 
1548 void os::trace_page_sizes(const char* str,
1549                           const size_t region_min_size,
1550                           const size_t region_max_size,
1551                           const size_t page_size,
1552                           const char* base,
1553                           const size_t size) {
1554 
1555   log_info(pagesize)(&quot;%s: &quot;
1556                      &quot; min=&quot; SIZE_FORMAT &quot;%s&quot;
1557                      &quot; max=&quot; SIZE_FORMAT &quot;%s&quot;
1558                      &quot; base=&quot; PTR_FORMAT
1559                      &quot; page_size=&quot; SIZE_FORMAT &quot;%s&quot;
1560                      &quot; size=&quot; SIZE_FORMAT &quot;%s&quot;,
1561                      str,
1562                      trace_page_size_params(region_min_size),
1563                      trace_page_size_params(region_max_size),
1564                      p2i(base),
1565                      trace_page_size_params(page_size),
1566                      trace_page_size_params(size));
1567 }
1568 
1569 void os::trace_page_sizes_for_requested_size(const char* str,
1570                                              const size_t requested_size,
1571                                              const size_t page_size,
1572                                              const size_t alignment,
1573                                              const char* base,
1574                                              const size_t size) {
1575 
1576   log_info(pagesize)(&quot;%s:&quot;
1577                      &quot; req_size=&quot; SIZE_FORMAT &quot;%s&quot;
1578                      &quot; base=&quot; PTR_FORMAT
1579                      &quot; page_size=&quot; SIZE_FORMAT &quot;%s&quot;
1580                      &quot; alignment=&quot; SIZE_FORMAT &quot;%s&quot;
1581                      &quot; size=&quot; SIZE_FORMAT &quot;%s&quot;,
1582                      str,
1583                      trace_page_size_params(requested_size),
1584                      p2i(base),
1585                      trace_page_size_params(page_size),
1586                      trace_page_size_params(alignment),
1587                      trace_page_size_params(size));
1588 }
1589 
1590 
1591 // This is the working definition of a server class machine:
1592 // &gt;= 2 physical CPU&#39;s and &gt;=2GB of memory, with some fuzz
1593 // because the graphics memory (?) sometimes masks physical memory.
1594 // If you want to change the definition of a server class machine
1595 // on some OS or platform, e.g., &gt;=4GB on Windows platforms,
1596 // then you&#39;ll have to parameterize this method based on that state,
1597 // as was done for logical processors here, or replicate and
1598 // specialize this method for each platform.  (Or fix os to have
1599 // some inheritance structure and use subclassing.  Sigh.)
1600 // If you want some platform to always or never behave as a server
1601 // class machine, change the setting of AlwaysActAsServerClassMachine
1602 // and NeverActAsServerClassMachine in globals*.hpp.
1603 bool os::is_server_class_machine() {
1604   // First check for the early returns
1605   if (NeverActAsServerClassMachine) {
1606     return false;
1607   }
1608   if (AlwaysActAsServerClassMachine) {
1609     return true;
1610   }
1611   // Then actually look at the machine
1612   bool         result            = false;
1613   const unsigned int    server_processors = 2;
1614   const julong server_memory     = 2UL * G;
1615   // We seem not to get our full complement of memory.
1616   //     We allow some part (1/8?) of the memory to be &quot;missing&quot;,
1617   //     based on the sizes of DIMMs, and maybe graphics cards.
1618   const julong missing_memory   = 256UL * M;
1619 
1620   /* Is this a server class machine? */
1621   if ((os::active_processor_count() &gt;= (int)server_processors) &amp;&amp;
1622       (os::physical_memory() &gt;= (server_memory - missing_memory))) {
1623     const unsigned int logical_processors =
1624       VM_Version::logical_processors_per_package();
1625     if (logical_processors &gt; 1) {
1626       const unsigned int physical_packages =
1627         os::active_processor_count() / logical_processors;
1628       if (physical_packages &gt;= server_processors) {
1629         result = true;
1630       }
1631     } else {
1632       result = true;
1633     }
1634   }
1635   return result;
1636 }
1637 
1638 void os::initialize_initial_active_processor_count() {
1639   assert(_initial_active_processor_count == 0, &quot;Initial active processor count already set.&quot;);
1640   _initial_active_processor_count = active_processor_count();
1641   log_debug(os)(&quot;Initial active processor count set to %d&quot; , _initial_active_processor_count);
1642 }
1643 
1644 void os::SuspendedThreadTask::run() {
1645   internal_do_task();
1646   _done = true;
1647 }
1648 
1649 bool os::create_stack_guard_pages(char* addr, size_t bytes) {
1650   return os::pd_create_stack_guard_pages(addr, bytes);
1651 }
1652 
1653 char* os::reserve_memory(size_t bytes, char* addr, size_t alignment_hint, int file_desc) {
1654   char* result = NULL;
1655 
1656   if (file_desc != -1) {
1657     // Could have called pd_reserve_memory() followed by replace_existing_mapping_with_file_mapping(),
1658     // but AIX may use SHM in which case its more trouble to detach the segment and remap memory to the file.
1659     result = os::map_memory_to_file(addr, bytes, file_desc);
1660     if (result != NULL) {
1661       MemTracker::record_virtual_memory_reserve_and_commit((address)result, bytes, CALLER_PC);
1662     }
1663   } else {
1664     result = pd_reserve_memory(bytes, addr, alignment_hint);
1665     if (result != NULL) {
1666       MemTracker::record_virtual_memory_reserve((address)result, bytes, CALLER_PC);
1667     }
1668   }
1669 
1670   return result;
1671 }
1672 
1673 char* os::reserve_memory(size_t bytes, char* addr, size_t alignment_hint,
1674    MEMFLAGS flags) {
1675   char* result = pd_reserve_memory(bytes, addr, alignment_hint);
1676   if (result != NULL) {
1677     MemTracker::record_virtual_memory_reserve((address)result, bytes, CALLER_PC);
1678     MemTracker::record_virtual_memory_type((address)result, flags);
1679   }
1680 
1681   return result;
1682 }
1683 
1684 char* os::attempt_reserve_memory_at(size_t bytes, char* addr, int file_desc) {
1685   char* result = NULL;
1686   if (file_desc != -1) {
1687     result = pd_attempt_reserve_memory_at(bytes, addr, file_desc);
1688     if (result != NULL) {
1689       MemTracker::record_virtual_memory_reserve_and_commit((address)result, bytes, CALLER_PC);
1690     }
1691   } else {
1692     result = pd_attempt_reserve_memory_at(bytes, addr);
1693     if (result != NULL) {
1694       MemTracker::record_virtual_memory_reserve((address)result, bytes, CALLER_PC);
1695     }
1696   }
1697   return result;
1698 }
1699 
1700 void os::split_reserved_memory(char *base, size_t size,
1701                                  size_t split, bool realloc) {
1702   pd_split_reserved_memory(base, size, split, realloc);
1703 }
1704 
1705 bool os::commit_memory(char* addr, size_t bytes, bool executable) {
1706   bool res = pd_commit_memory(addr, bytes, executable);
1707   if (res) {
1708     MemTracker::record_virtual_memory_commit((address)addr, bytes, CALLER_PC);
1709   }
1710   return res;
1711 }
1712 
1713 bool os::commit_memory(char* addr, size_t size, size_t alignment_hint,
1714                               bool executable) {
1715   bool res = os::pd_commit_memory(addr, size, alignment_hint, executable);
1716   if (res) {
1717     MemTracker::record_virtual_memory_commit((address)addr, size, CALLER_PC);
1718   }
1719   return res;
1720 }
1721 
1722 void os::commit_memory_or_exit(char* addr, size_t bytes, bool executable,
1723                                const char* mesg) {
1724   pd_commit_memory_or_exit(addr, bytes, executable, mesg);
1725   MemTracker::record_virtual_memory_commit((address)addr, bytes, CALLER_PC);
1726 }
1727 
1728 void os::commit_memory_or_exit(char* addr, size_t size, size_t alignment_hint,
1729                                bool executable, const char* mesg) {
1730   os::pd_commit_memory_or_exit(addr, size, alignment_hint, executable, mesg);
1731   MemTracker::record_virtual_memory_commit((address)addr, size, CALLER_PC);
1732 }
1733 
1734 bool os::uncommit_memory(char* addr, size_t bytes) {
1735   bool res;
1736   if (MemTracker::tracking_level() &gt; NMT_minimal) {
1737     Tracker tkr(Tracker::uncommit);
1738     res = pd_uncommit_memory(addr, bytes);
1739     if (res) {
1740       tkr.record((address)addr, bytes);
1741     }
1742   } else {
1743     res = pd_uncommit_memory(addr, bytes);
1744   }
1745   return res;
1746 }
1747 
1748 bool os::release_memory(char* addr, size_t bytes) {
1749   bool res;
1750   if (MemTracker::tracking_level() &gt; NMT_minimal) {
1751     Tracker tkr(Tracker::release);
1752     res = pd_release_memory(addr, bytes);
1753     if (res) {
1754       tkr.record((address)addr, bytes);
1755     }
1756   } else {
1757     res = pd_release_memory(addr, bytes);
1758   }
1759   return res;
1760 }
1761 
1762 void os::pretouch_memory(void* start, void* end, size_t page_size) {
1763   for (volatile char *p = (char*)start; p &lt; (char*)end; p += page_size) {
1764     *p = 0;
1765   }
1766 }
1767 
1768 char* os::map_memory(int fd, const char* file_name, size_t file_offset,
1769                            char *addr, size_t bytes, bool read_only,
1770                            bool allow_exec) {
1771   char* result = pd_map_memory(fd, file_name, file_offset, addr, bytes, read_only, allow_exec);
1772   if (result != NULL) {
1773     MemTracker::record_virtual_memory_reserve_and_commit((address)result, bytes, CALLER_PC);
1774   }
1775   return result;
1776 }
1777 
1778 char* os::remap_memory(int fd, const char* file_name, size_t file_offset,
1779                              char *addr, size_t bytes, bool read_only,
1780                              bool allow_exec) {
1781   return pd_remap_memory(fd, file_name, file_offset, addr, bytes,
1782                     read_only, allow_exec);
1783 }
1784 
1785 bool os::unmap_memory(char *addr, size_t bytes) {
1786   bool result;
1787   if (MemTracker::tracking_level() &gt; NMT_minimal) {
1788     Tracker tkr(Tracker::release);
1789     result = pd_unmap_memory(addr, bytes);
1790     if (result) {
1791       tkr.record((address)addr, bytes);
1792     }
1793   } else {
1794     result = pd_unmap_memory(addr, bytes);
1795   }
1796   return result;
1797 }
1798 
1799 void os::free_memory(char *addr, size_t bytes, size_t alignment_hint) {
1800   pd_free_memory(addr, bytes, alignment_hint);
1801 }
1802 
1803 void os::realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
1804   pd_realign_memory(addr, bytes, alignment_hint);
1805 }
1806 
1807 #ifndef _WINDOWS
1808 /* try to switch state from state &quot;from&quot; to state &quot;to&quot;
1809  * returns the state set after the method is complete
1810  */
1811 os::SuspendResume::State os::SuspendResume::switch_state(os::SuspendResume::State from,
1812                                                          os::SuspendResume::State to)
1813 {
1814   os::SuspendResume::State result = Atomic::cmpxchg(&amp;_state, from, to);
1815   if (result == from) {
1816     // success
1817     return to;
1818   }
1819   return result;
1820 }
1821 #endif
1822 
1823 // Convenience wrapper around naked_short_sleep to allow for longer sleep
1824 // times. Only for use by non-JavaThreads.
1825 void os::naked_sleep(jlong millis) {
1826   assert(!Thread::current()-&gt;is_Java_thread(), &quot;not for use by JavaThreads&quot;);
1827   const jlong limit = 999;
1828   while (millis &gt; limit) {
1829     naked_short_sleep(limit);
1830     millis -= limit;
1831   }
1832   naked_short_sleep(millis);
1833 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>