<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/meta/HotSpotGraphBuilderPlugins.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DefaultHotSpotLoweringProvider.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotHostForeignCallsProvider.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/meta/HotSpotGraphBuilderPlugins.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 72 import org.graalvm.compiler.hotspot.replacements.StringUTF16Substitutions;
 73 import org.graalvm.compiler.hotspot.replacements.ThreadSubstitutions;
 74 import org.graalvm.compiler.hotspot.word.HotSpotWordTypes;
 75 import org.graalvm.compiler.nodes.ComputeObjectAddressNode;
 76 import org.graalvm.compiler.nodes.ConstantNode;
 77 import org.graalvm.compiler.nodes.NamedLocationIdentity;
 78 import org.graalvm.compiler.nodes.NodeView;
 79 import org.graalvm.compiler.nodes.ValueNode;
 80 import org.graalvm.compiler.nodes.calc.AddNode;
 81 import org.graalvm.compiler.nodes.calc.IntegerConvertNode;
 82 import org.graalvm.compiler.nodes.calc.LeftShiftNode;
 83 import org.graalvm.compiler.nodes.extended.ForeignCallNode;
 84 import org.graalvm.compiler.nodes.graphbuilderconf.ForeignCallPlugin;
 85 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
 86 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;
 87 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
 88 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin.Receiver;
 89 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 90 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
 91 import org.graalvm.compiler.nodes.graphbuilderconf.NodeIntrinsicPluginFactory;
<span class="line-modified"> 92 import org.graalvm.compiler.nodes.memory.HeapAccess.BarrierType;</span>
 93 import org.graalvm.compiler.nodes.memory.ReadNode;
 94 import org.graalvm.compiler.nodes.memory.address.AddressNode;
 95 import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;
 96 import org.graalvm.compiler.nodes.spi.Replacements;
 97 import org.graalvm.compiler.nodes.util.GraphUtil;
 98 import org.graalvm.compiler.options.OptionValues;
 99 import org.graalvm.compiler.phases.tiers.CompilerConfiguration;
100 import org.graalvm.compiler.replacements.InlineDuringParsingPlugin;
101 import org.graalvm.compiler.replacements.MethodHandlePlugin;
102 import org.graalvm.compiler.replacements.NodeIntrinsificationProvider;
103 import org.graalvm.compiler.replacements.ReplacementsImpl;
104 import org.graalvm.compiler.replacements.StandardGraphBuilderPlugins;
105 import org.graalvm.compiler.replacements.arraycopy.ArrayCopyNode;
106 import org.graalvm.compiler.serviceprovider.GraalServices;
107 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;
108 import org.graalvm.compiler.word.WordOperationPlugin;
109 import org.graalvm.compiler.word.WordTypes;
110 import jdk.internal.vm.compiler.word.LocationIdentity;
111 
112 import jdk.vm.ci.code.CodeUtil;
</pre>
<hr />
<pre>
126 public class HotSpotGraphBuilderPlugins {
127 
128     /**
129      * Creates a {@link Plugins} object that should be used when running on HotSpot.
130      *
131      * @param constantReflection
132      * @param snippetReflection
133      * @param foreignCalls
134      * @param options
135      * @param target
136      */
137     public static Plugins create(HotSpotGraalRuntimeProvider graalRuntime,
138                     CompilerConfiguration compilerConfiguration,
139                     GraalHotSpotVMConfig config,
140                     HotSpotWordTypes wordTypes,
141                     MetaAccessProvider metaAccess,
142                     ConstantReflectionProvider constantReflection,
143                     SnippetReflectionProvider snippetReflection,
144                     ForeignCallsProvider foreignCalls,
145                     ReplacementsImpl replacements,
<span class="line-modified">146                     OptionValues options, TargetDescription target) {</span>

147         InvocationPlugins invocationPlugins = new HotSpotInvocationPlugins(graalRuntime, config, compilerConfiguration);
148 
149         Plugins plugins = new Plugins(invocationPlugins);
150         NodeIntrinsificationProvider nodeIntrinsificationProvider = new NodeIntrinsificationProvider(metaAccess, snippetReflection, foreignCalls, wordTypes, target);
151         HotSpotWordOperationPlugin wordOperationPlugin = new HotSpotWordOperationPlugin(snippetReflection, wordTypes);
152         HotSpotNodePlugin nodePlugin = new HotSpotNodePlugin(wordOperationPlugin, config, wordTypes);
153 
154         plugins.appendTypePlugin(nodePlugin);
155         plugins.appendNodePlugin(nodePlugin);
156         if (!GeneratePIC.getValue(options)) {
157             plugins.appendNodePlugin(new MethodHandlePlugin(constantReflection.getMethodHandleAccess(), true));
158         }
159         plugins.appendInlineInvokePlugin(replacements);
160         if (InlineDuringParsing.getValue(options)) {
161             plugins.appendInlineInvokePlugin(new InlineDuringParsingPlugin());
162         }
163 
164         if (GeneratePIC.getValue(options)) {
165             plugins.setClassInitializationPlugin(new HotSpotAOTClassInitializationPlugin());
166             if (TieredAOT.getValue(options)) {
</pre>
<hr />
<pre>
648                                                 Receiver receiver,
649                                                 ValueNode data,
650                                                 ValueNode inOffset,
651                                                 ValueNode blocks,
652                                                 ValueNode state,
653                                                 ValueNode hashSubkey) {
654                                     int longArrayBaseOffset = metaAccess.getArrayBaseOffset(JavaKind.Long);
655                                     int byteArrayBaseOffset = metaAccess.getArrayBaseOffset(JavaKind.Byte);
656                                     ValueNode dataOffset = AddNode.create(ConstantNode.forInt(byteArrayBaseOffset), inOffset, NodeView.DEFAULT);
657                                     ComputeObjectAddressNode dataAddress = b.add(new ComputeObjectAddressNode(data, dataOffset));
658                                     ComputeObjectAddressNode stateAddress = b.add(new ComputeObjectAddressNode(state, ConstantNode.forInt(longArrayBaseOffset)));
659                                     ComputeObjectAddressNode hashSubkeyAddress = b.add(new ComputeObjectAddressNode(hashSubkey, ConstantNode.forInt(longArrayBaseOffset)));
660                                     b.add(new ForeignCallNode(foreignCalls, GHASH_PROCESS_BLOCKS, stateAddress, hashSubkeyAddress, dataAddress, blocks));
661                                     return true;
662                                 }
663                             });
664         }
665     }
666 
667     private static void registerCounterModePlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {
<span class="line-modified">668         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
669             assert !config.useAESCTRIntrinsics || config.counterModeAESCrypt != 0L;
670             Registration r = new Registration(plugins, &quot;com.sun.crypto.provider.CounterMode&quot;, replacements);
671             r.registerConditionalMethodSubstitution(config.useAESCTRIntrinsics, CounterModeSubstitutions.class, &quot;implCrypt&quot;, Receiver.class, byte[].class, int.class, int.class, byte[].class,
672                             int.class);
673         }
674     }
675 
676     private static void registerBase64Plugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, MetaAccessProvider metaAccess, ForeignCallsProvider foreignCalls) {
677         if (config.useBase64Intrinsics()) {
678             Registration r = new Registration(plugins, &quot;java.util.Base64$Encoder&quot;);
679             r.register7(&quot;encodeBlock&quot;,
680                             Receiver.class,
681                             byte[].class,
682                             int.class,
683                             int.class,
684                             byte[].class,
685                             int.class,
686                             boolean.class,
687                             new InvocationPlugin() {
688                                 @Override
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 72 import org.graalvm.compiler.hotspot.replacements.StringUTF16Substitutions;
 73 import org.graalvm.compiler.hotspot.replacements.ThreadSubstitutions;
 74 import org.graalvm.compiler.hotspot.word.HotSpotWordTypes;
 75 import org.graalvm.compiler.nodes.ComputeObjectAddressNode;
 76 import org.graalvm.compiler.nodes.ConstantNode;
 77 import org.graalvm.compiler.nodes.NamedLocationIdentity;
 78 import org.graalvm.compiler.nodes.NodeView;
 79 import org.graalvm.compiler.nodes.ValueNode;
 80 import org.graalvm.compiler.nodes.calc.AddNode;
 81 import org.graalvm.compiler.nodes.calc.IntegerConvertNode;
 82 import org.graalvm.compiler.nodes.calc.LeftShiftNode;
 83 import org.graalvm.compiler.nodes.extended.ForeignCallNode;
 84 import org.graalvm.compiler.nodes.graphbuilderconf.ForeignCallPlugin;
 85 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
 86 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;
 87 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
 88 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin.Receiver;
 89 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 90 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
 91 import org.graalvm.compiler.nodes.graphbuilderconf.NodeIntrinsicPluginFactory;
<span class="line-modified"> 92 import org.graalvm.compiler.nodes.memory.OnHeapMemoryAccess.BarrierType;</span>
 93 import org.graalvm.compiler.nodes.memory.ReadNode;
 94 import org.graalvm.compiler.nodes.memory.address.AddressNode;
 95 import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;
 96 import org.graalvm.compiler.nodes.spi.Replacements;
 97 import org.graalvm.compiler.nodes.util.GraphUtil;
 98 import org.graalvm.compiler.options.OptionValues;
 99 import org.graalvm.compiler.phases.tiers.CompilerConfiguration;
100 import org.graalvm.compiler.replacements.InlineDuringParsingPlugin;
101 import org.graalvm.compiler.replacements.MethodHandlePlugin;
102 import org.graalvm.compiler.replacements.NodeIntrinsificationProvider;
103 import org.graalvm.compiler.replacements.ReplacementsImpl;
104 import org.graalvm.compiler.replacements.StandardGraphBuilderPlugins;
105 import org.graalvm.compiler.replacements.arraycopy.ArrayCopyNode;
106 import org.graalvm.compiler.serviceprovider.GraalServices;
107 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;
108 import org.graalvm.compiler.word.WordOperationPlugin;
109 import org.graalvm.compiler.word.WordTypes;
110 import jdk.internal.vm.compiler.word.LocationIdentity;
111 
112 import jdk.vm.ci.code.CodeUtil;
</pre>
<hr />
<pre>
126 public class HotSpotGraphBuilderPlugins {
127 
128     /**
129      * Creates a {@link Plugins} object that should be used when running on HotSpot.
130      *
131      * @param constantReflection
132      * @param snippetReflection
133      * @param foreignCalls
134      * @param options
135      * @param target
136      */
137     public static Plugins create(HotSpotGraalRuntimeProvider graalRuntime,
138                     CompilerConfiguration compilerConfiguration,
139                     GraalHotSpotVMConfig config,
140                     HotSpotWordTypes wordTypes,
141                     MetaAccessProvider metaAccess,
142                     ConstantReflectionProvider constantReflection,
143                     SnippetReflectionProvider snippetReflection,
144                     ForeignCallsProvider foreignCalls,
145                     ReplacementsImpl replacements,
<span class="line-modified">146                     OptionValues options,</span>
<span class="line-added">147                     TargetDescription target) {</span>
148         InvocationPlugins invocationPlugins = new HotSpotInvocationPlugins(graalRuntime, config, compilerConfiguration);
149 
150         Plugins plugins = new Plugins(invocationPlugins);
151         NodeIntrinsificationProvider nodeIntrinsificationProvider = new NodeIntrinsificationProvider(metaAccess, snippetReflection, foreignCalls, wordTypes, target);
152         HotSpotWordOperationPlugin wordOperationPlugin = new HotSpotWordOperationPlugin(snippetReflection, wordTypes);
153         HotSpotNodePlugin nodePlugin = new HotSpotNodePlugin(wordOperationPlugin, config, wordTypes);
154 
155         plugins.appendTypePlugin(nodePlugin);
156         plugins.appendNodePlugin(nodePlugin);
157         if (!GeneratePIC.getValue(options)) {
158             plugins.appendNodePlugin(new MethodHandlePlugin(constantReflection.getMethodHandleAccess(), true));
159         }
160         plugins.appendInlineInvokePlugin(replacements);
161         if (InlineDuringParsing.getValue(options)) {
162             plugins.appendInlineInvokePlugin(new InlineDuringParsingPlugin());
163         }
164 
165         if (GeneratePIC.getValue(options)) {
166             plugins.setClassInitializationPlugin(new HotSpotAOTClassInitializationPlugin());
167             if (TieredAOT.getValue(options)) {
</pre>
<hr />
<pre>
649                                                 Receiver receiver,
650                                                 ValueNode data,
651                                                 ValueNode inOffset,
652                                                 ValueNode blocks,
653                                                 ValueNode state,
654                                                 ValueNode hashSubkey) {
655                                     int longArrayBaseOffset = metaAccess.getArrayBaseOffset(JavaKind.Long);
656                                     int byteArrayBaseOffset = metaAccess.getArrayBaseOffset(JavaKind.Byte);
657                                     ValueNode dataOffset = AddNode.create(ConstantNode.forInt(byteArrayBaseOffset), inOffset, NodeView.DEFAULT);
658                                     ComputeObjectAddressNode dataAddress = b.add(new ComputeObjectAddressNode(data, dataOffset));
659                                     ComputeObjectAddressNode stateAddress = b.add(new ComputeObjectAddressNode(state, ConstantNode.forInt(longArrayBaseOffset)));
660                                     ComputeObjectAddressNode hashSubkeyAddress = b.add(new ComputeObjectAddressNode(hashSubkey, ConstantNode.forInt(longArrayBaseOffset)));
661                                     b.add(new ForeignCallNode(foreignCalls, GHASH_PROCESS_BLOCKS, stateAddress, hashSubkeyAddress, dataAddress, blocks));
662                                     return true;
663                                 }
664                             });
665         }
666     }
667 
668     private static void registerCounterModePlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {
<span class="line-modified">669         if (isIntrinsicName(config, &quot;com/sun/crypto/provider/CounterMode&quot;, &quot;implCrypt&quot;)) {</span>
670             assert !config.useAESCTRIntrinsics || config.counterModeAESCrypt != 0L;
671             Registration r = new Registration(plugins, &quot;com.sun.crypto.provider.CounterMode&quot;, replacements);
672             r.registerConditionalMethodSubstitution(config.useAESCTRIntrinsics, CounterModeSubstitutions.class, &quot;implCrypt&quot;, Receiver.class, byte[].class, int.class, int.class, byte[].class,
673                             int.class);
674         }
675     }
676 
677     private static void registerBase64Plugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, MetaAccessProvider metaAccess, ForeignCallsProvider foreignCalls) {
678         if (config.useBase64Intrinsics()) {
679             Registration r = new Registration(plugins, &quot;java.util.Base64$Encoder&quot;);
680             r.register7(&quot;encodeBlock&quot;,
681                             Receiver.class,
682                             byte[].class,
683                             int.class,
684                             int.class,
685                             byte[].class,
686                             int.class,
687                             boolean.class,
688                             new InvocationPlugin() {
689                                 @Override
</pre>
</td>
</tr>
</table>
<center><a href="DefaultHotSpotLoweringProvider.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotHostForeignCallsProvider.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>