<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames make/autoconf/toolchain_windows.m4</title>
    <link rel="stylesheet" href="../../style.css" />
    <script type="text/javascript" src="../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 #
  2 # Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
  3 # DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4 #
  5 # This code is free software; you can redistribute it and/or modify it
  6 # under the terms of the GNU General Public License version 2 only, as
  7 # published by the Free Software Foundation.  Oracle designates this
  8 # particular file as subject to the &quot;Classpath&quot; exception as provided
  9 # by Oracle in the LICENSE file that accompanied this code.
 10 #
 11 # This code is distributed in the hope that it will be useful, but WITHOUT
 12 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14 # version 2 for more details (a copy is included in the LICENSE file that
 15 # accompanied this code).
 16 #
 17 # You should have received a copy of the GNU General Public License version
 18 # 2 along with this work; if not, write to the Free Software Foundation,
 19 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20 #
 21 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22 # or visit www.oracle.com if you need additional information or have any
 23 # questions.
 24 #
 25 
 26 ################################################################################
 27 # The order of these defines the priority by which we try to find them.
 28 VALID_VS_VERSIONS=&quot;2017 2019 2013 2015 2012 2010&quot;
 29 
 30 VS_DESCRIPTION_2010=&quot;Microsoft Visual Studio 2010&quot;
 31 VS_VERSION_INTERNAL_2010=100
 32 VS_MSVCR_2010=msvcr100.dll
 33 # We don&#39;t use msvcp on Visual Studio 2010
 34 #VS_MSVCP_2010=msvcp100.dll
 35 VS_ENVVAR_2010=&quot;VS100COMNTOOLS&quot;
 36 VS_VS_INSTALLDIR_2010=&quot;Microsoft Visual Studio 10.0&quot;
 37 VS_SDK_INSTALLDIR_2010=&quot;Microsoft SDKs/Windows/v7.1&quot;
 38 VS_VS_PLATFORM_NAME_2010=&quot;v100&quot;
 39 VS_SDK_PLATFORM_NAME_2010=&quot;Windows7.1SDK&quot;
 40 VS_SUPPORTED_2010=false
 41 
 42 VS_DESCRIPTION_2012=&quot;Microsoft Visual Studio 2012&quot;
 43 VS_VERSION_INTERNAL_2012=110
 44 VS_MSVCR_2012=msvcr110.dll
 45 VS_MSVCP_2012=msvcp110.dll
 46 VS_ENVVAR_2012=&quot;VS110COMNTOOLS&quot;
 47 VS_VS_INSTALLDIR_2012=&quot;Microsoft Visual Studio 11.0&quot;
 48 VS_SDK_INSTALLDIR_2012=
 49 VS_VS_PLATFORM_NAME_2012=&quot;v110&quot;
 50 VS_SDK_PLATFORM_NAME_2012=
 51 VS_SUPPORTED_2012=false
 52 
 53 VS_DESCRIPTION_2013=&quot;Microsoft Visual Studio 2013&quot;
 54 VS_VERSION_INTERNAL_2013=120
 55 VS_MSVCR_2013=msvcr120.dll
 56 VS_MSVCP_2013=msvcp120.dll
 57 VS_ENVVAR_2013=&quot;VS120COMNTOOLS&quot;
 58 VS_VS_INSTALLDIR_2013=&quot;Microsoft Visual Studio 12.0&quot;
 59 VS_SDK_INSTALLDIR_2013=
 60 VS_VS_PLATFORM_NAME_2013=&quot;v120&quot;
 61 VS_SDK_PLATFORM_NAME_2013=
 62 VS_SUPPORTED_2013=false
 63 
 64 VS_DESCRIPTION_2015=&quot;Microsoft Visual Studio 2015&quot;
 65 VS_VERSION_INTERNAL_2015=140
 66 VS_MSVCR_2015=vcruntime140.dll
 67 VS_MSVCP_2015=msvcp140.dll
 68 VS_ENVVAR_2015=&quot;VS140COMNTOOLS&quot;
 69 VS_VS_INSTALLDIR_2015=&quot;Microsoft Visual Studio 14.0&quot;
 70 VS_SDK_INSTALLDIR_2015=
 71 VS_VS_PLATFORM_NAME_2015=&quot;v140&quot;
 72 VS_SDK_PLATFORM_NAME_2015=
 73 # The vcvars of 2015 breaks if 2017 is also installed. Work around this by
 74 # explicitly specifying Windows Kit 8.1 to be used.
 75 VS_ENV_ARGS_2015=&quot;8.1&quot;
 76 VS_SUPPORTED_2015=false
 77 
 78 VS_DESCRIPTION_2017=&quot;Microsoft Visual Studio 2017&quot;
 79 VS_VERSION_INTERNAL_2017=141
 80 VS_MSVCR_2017=vcruntime140.dll
 81 VS_MSVCP_2017=msvcp140.dll
 82 VS_ENVVAR_2017=&quot;VS150COMNTOOLS&quot;
 83 VS_USE_UCRT_2017=&quot;true&quot;
 84 VS_VS_INSTALLDIR_2017=&quot;Microsoft Visual Studio/2017&quot;
 85 VS_EDITIONS_2017=&quot;BuildTools Community Professional Enterprise&quot;
 86 VS_SDK_INSTALLDIR_2017=
 87 VS_VS_PLATFORM_NAME_2017=&quot;v141&quot;
 88 VS_SDK_PLATFORM_NAME_2017=
 89 VS_SUPPORTED_2017=true
 90 VS_TOOLSET_SUPPORTED_2017=true
 91 
 92 VS_DESCRIPTION_2019=&quot;Microsoft Visual Studio 2019&quot;
 93 VS_VERSION_INTERNAL_2019=141
 94 VS_MSVCR_2019=vcruntime140.dll
 95 VS_MSVCP_2019=msvcp140.dll
 96 VS_ENVVAR_2019=&quot;VS160COMNTOOLS&quot;
 97 VS_USE_UCRT_2019=&quot;true&quot;
 98 VS_VS_INSTALLDIR_2019=&quot;Microsoft Visual Studio/2019&quot;
 99 VS_EDITIONS_2019=&quot;BuildTools Community Professional Enterprise&quot;
100 VS_SDK_INSTALLDIR_2019=
101 VS_VS_PLATFORM_NAME_2019=&quot;v142&quot;
102 VS_SDK_PLATFORM_NAME_2019=
103 VS_SUPPORTED_2019=false
104 VS_TOOLSET_SUPPORTED_2019=false
105 
106 ################################################################################
107 
108 AC_DEFUN([TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT],
109 [
110   if test &quot;x$VS_ENV_CMD&quot; = x; then
111     VS_VERSION=&quot;$1&quot;
112     VS_BASE=&quot;$2&quot;
113     METHOD=&quot;$3&quot;
114 
<a name="1" id="anc1"></a><span class="line-modified">115     UTIL_REWRITE_AS_UNIX_PATH(VS_BASE)</span>
116     # In VS 2017 and VS 2019, the default installation is in a subdir named after the edition.
117     # Find the first one present and use that.
118     if test &quot;x$VS_EDITIONS&quot; != x; then
119       for edition in $VS_EDITIONS; do
120         if test -d &quot;$VS_BASE/$edition&quot;; then
121           VS_BASE=&quot;$VS_BASE/$edition&quot;
122           break
123         fi
124       done
125     fi
126 
127     if test -d &quot;$VS_BASE&quot;; then
128       AC_MSG_NOTICE([Found Visual Studio installation at $VS_BASE using $METHOD])
129       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
130         VCVARSFILES=&quot;vc/bin/vcvars32.bat vc/auxiliary/build/vcvars32.bat&quot;
131       else
132         VCVARSFILES=&quot;vc/bin/amd64/vcvars64.bat vc/bin/x86_amd64/vcvarsx86_amd64.bat \
133             VC/Auxiliary/Build/vcvarsx86_amd64.bat VC/Auxiliary/Build/vcvars64.bat&quot;
134       fi
135 
136       for VCVARSFILE in $VCVARSFILES; do
137         if test -f &quot;$VS_BASE/$VCVARSFILE&quot;; then
138           VS_ENV_CMD=&quot;$VS_BASE/$VCVARSFILE&quot;
139           break
140         fi
141       done
142 
143       if test &quot;x$VS_ENV_CMD&quot; = x; then
144         AC_MSG_NOTICE([Warning: None of $VCVARSFILES were found, Visual Studio installation not recognized. Ignoring])
145       else
146         # PLATFORM_TOOLSET is used during the compilation of the freetype sources
147         # (see &#39;LIB_BUILD_FREETYPE&#39; in libraries.m4) and must be one of &#39;v100&#39;,
148         # &#39;v110&#39; or &#39;v120&#39; for VS 2010, 2012 or VS2013
149         eval PLATFORM_TOOLSET=&quot;\${VS_VS_PLATFORM_NAME_${VS_VERSION}}&quot;
150       fi
151     fi
152   fi
153 ])
154 
155 ################################################################################
156 
157 AC_DEFUN([TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT],
158 [
159   if test &quot;x$VS_ENV_CMD&quot; = x; then
160     VS_VERSION=&quot;$1&quot;
161     WIN_SDK_BASE=&quot;$2&quot;
162     METHOD=&quot;$3&quot;
<a name="2" id="anc2"></a><span class="line-modified">163     UTIL_REWRITE_AS_UNIX_PATH(WIN_SDK_BASE)</span>
164     if test -d &quot;$WIN_SDK_BASE&quot;; then
165       # There have been cases of partial or broken SDK installations. A missing
166       # lib dir is not going to work.
167       if test ! -d &quot;$WIN_SDK_BASE/lib&quot;; then
168         AC_MSG_NOTICE([Found Windows SDK installation at $WIN_SDK_BASE using $METHOD])
169         AC_MSG_NOTICE([Warning: Installation is broken, lib dir is missing. Ignoring])
170       elif test -f &quot;$WIN_SDK_BASE/Bin/SetEnv.Cmd&quot;; then
171         AC_MSG_NOTICE([Found Windows SDK installation at $WIN_SDK_BASE using $METHOD])
172         VS_ENV_CMD=&quot;$WIN_SDK_BASE/Bin/SetEnv.Cmd&quot;
173         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
174           VS_ENV_ARGS=&quot;/x86&quot;
175         else
176           VS_ENV_ARGS=&quot;/x64&quot;
177         fi
178         # PLATFORM_TOOLSET is used during the compilation of the freetype sources (see
179         # &#39;LIB_BUILD_FREETYPE&#39; in libraries.m4) and must be &#39;Windows7.1SDK&#39; for Windows7.1SDK
180         # TODO: improve detection for other versions of SDK
181         eval PLATFORM_TOOLSET=&quot;\${VS_SDK_PLATFORM_NAME_${VS_VERSION}}&quot;
182       else
183         AC_MSG_NOTICE([Found Windows SDK installation at $WIN_SDK_BASE using $METHOD])
184         AC_MSG_NOTICE([Warning: Installation is broken, SetEnv.Cmd is missing. Ignoring])
185       fi
186     fi
187   fi
188 ])
189 
190 ################################################################################
191 # Finds the bat or cmd file in Visual Studio or the SDK that sets up a proper
192 # build environment and assigns it to VS_ENV_CMD
193 AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO_BAT_FILE],
194 [
195   # VS2017 provides the option to install previous minor versions of the MSVC
196   # toolsets. It is not possible to directly download earlier minor versions of
197   # VS2017 and in order to build with a previous minor compiler toolset version,
198   # it is now possible to compile with earlier minor versions by passing
199   # -vcvars_ver=&lt;toolset_version&gt; argument to vcvarsall.bat.
200   AC_ARG_WITH(msvc-toolset-version, [AS_HELP_STRING([--with-msvc-toolset-version],
201       [specific MSVC toolset version to use, passed as -vcvars_ver argument to
202        pass to vcvarsall.bat (Windows only)])])
203 
204   VS_VERSION=&quot;$1&quot;
205   eval VS_COMNTOOLS_VAR=&quot;\${VS_ENVVAR_${VS_VERSION}}&quot;
206   eval VS_COMNTOOLS=&quot;\$${VS_COMNTOOLS_VAR}&quot;
207   eval VS_INSTALL_DIR=&quot;\${VS_VS_INSTALLDIR_${VS_VERSION}}&quot;
208   eval VS_EDITIONS=&quot;\${VS_EDITIONS_${VS_VERSION}}&quot;
209   eval SDK_INSTALL_DIR=&quot;\${VS_SDK_INSTALLDIR_${VS_VERSION}}&quot;
210   eval VS_ENV_ARGS=&quot;\${VS_ENV_ARGS_${VS_VERSION}}&quot;
211   eval VS_TOOLSET_SUPPORTED=&quot;\${VS_TOOLSET_SUPPORTED_${VS_VERSION}}&quot;
212 
213   VS_ENV_CMD=&quot;&quot;
214 
215   # When using --with-tools-dir, assume it points to the correct and default
216   # version of Visual Studio or that --with-toolchain-version was also set.
217   if test &quot;x$with_tools_dir&quot; != x; then
218     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
219         [$with_tools_dir/../..], [--with-tools-dir])
220     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
221         [$with_tools_dir/../../..], [--with-tools-dir])
222     if test &quot;x$VS_ENV_CMD&quot; = x; then
223       # Having specified an argument which is incorrect will produce an instant failure;
224       # we should not go on looking
225       AC_MSG_NOTICE([The path given by --with-tools-dir does not contain a valid])
226       AC_MSG_NOTICE([Visual Studio installation. Please point to the VC/bin or VC/bin/amd64])
227       AC_MSG_NOTICE([directory within the Visual Studio installation])
228       AC_MSG_ERROR([Cannot locate a valid Visual Studio installation])
229     fi
230   fi
231 
232   if test &quot;x$VS_COMNTOOLS&quot; != x; then
233     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
234         [$VS_COMNTOOLS/../..], [$VS_COMNTOOLS_VAR variable])
235   fi
236   if test &quot;x$PROGRAMFILES&quot; != x; then
237     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
238         [$PROGRAMFILES/$VS_INSTALL_DIR], [well-known name])
239   fi
240   # Work around the insanely named ProgramFiles(x86) env variable
241   PROGRAMFILES_X86=&quot;`env | $SED -n &#39;s/^ProgramFiles(x86)=//p&#39;`&quot;
242   if test &quot;x$PROGRAMFILES_X86&quot; != x; then
243     TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
244         [$PROGRAMFILES_X86/$VS_INSTALL_DIR], [well-known name])
245   fi
246   TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
247       [C:/Program Files/$VS_INSTALL_DIR], [well-known name])
248   TOOLCHAIN_CHECK_POSSIBLE_VISUAL_STUDIO_ROOT([${VS_VERSION}],
249       [C:/Program Files (x86)/$VS_INSTALL_DIR], [well-known name])
250   if test &quot;x$SDK_INSTALL_DIR&quot; != x; then
251     if test &quot;x$ProgramW6432&quot; != x; then
252       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
253           [$ProgramW6432/$SDK_INSTALL_DIR], [well-known name])
254     fi
255     if test &quot;x$PROGRAMW6432&quot; != x; then
256       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
257           [$PROGRAMW6432/$SDK_INSTALL_DIR], [well-known name])
258     fi
259     if test &quot;x$PROGRAMFILES&quot; != x; then
260       TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
261           [$PROGRAMFILES/$SDK_INSTALL_DIR], [well-known name])
262     fi
263     TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
264         [C:/Program Files/$SDK_INSTALL_DIR], [well-known name])
265     TOOLCHAIN_CHECK_POSSIBLE_WIN_SDK_ROOT([${VS_VERSION}],
266         [C:/Program Files (x86)/$SDK_INSTALL_DIR], [well-known name])
267   fi
268 
269   if test &quot;x$VS_TOOLSET_SUPPORTED&quot; != x; then
270     if test &quot;x$with_msvc_toolset_version&quot; != x; then
271       VS_ENV_ARGS=&quot;$VS_ENV_ARGS -vcvars_ver=$with_msvc_toolset_version&quot;
272     fi
273   fi
274 ])
275 
276 ################################################################################
277 
278 AC_DEFUN([TOOLCHAIN_FIND_VISUAL_STUDIO],
279 [
280   AC_ARG_WITH(toolchain-version, [AS_HELP_STRING([--with-toolchain-version],
281       [the version of the toolchain to look for, use &#39;--help&#39; to show possible values @&lt;:@platform dependent@:&gt;@])])
282 
283   if test &quot;x$with_toolchain_version&quot; = xlist; then
284     # List all toolchains
285     AC_MSG_NOTICE([The following toolchain versions are valid on this platform:])
286     for version in $VALID_VS_VERSIONS; do
287       eval VS_DESCRIPTION=\${VS_DESCRIPTION_$version}
288       $PRINTF &quot;  %-10s  %s\n&quot; $version &quot;$VS_DESCRIPTION&quot;
289     done
290 
291     exit 0
292   elif test &quot;x$DEVKIT_VS_VERSION&quot; != x; then
293     VS_VERSION=$DEVKIT_VS_VERSION
294     TOOLCHAIN_VERSION=$VS_VERSION
295     # If the devkit has a name, use that as description
296     VS_DESCRIPTION=&quot;$DEVKIT_NAME&quot;
297     if test &quot;x$VS_DESCRIPTION&quot; = x; then
298       eval VS_DESCRIPTION=&quot;\${VS_DESCRIPTION_${VS_VERSION}}&quot;
299     fi
300     eval VS_VERSION_INTERNAL=&quot;\${VS_VERSION_INTERNAL_${VS_VERSION}}&quot;
301     eval MSVCR_NAME=&quot;\${VS_MSVCR_${VS_VERSION}}&quot;
302     eval MSVCP_NAME=&quot;\${VS_MSVCP_${VS_VERSION}}&quot;
303     eval USE_UCRT=&quot;\${VS_USE_UCRT_${VS_VERSION}}&quot;
304     eval VS_SUPPORTED=&quot;\${VS_SUPPORTED_${VS_VERSION}}&quot;
305     eval PLATFORM_TOOLSET=&quot;\${VS_VS_PLATFORM_NAME_${VS_VERSION}}&quot;
306 
307     # The TOOLCHAIN_PATH from a devkit is in Unix format. In WSL we need a
308     # windows version of the complete VS_PATH as VS_PATH_WINDOWS
309     if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
310       # Convert the toolchain path
311       OLDIFS=&quot;$IFS&quot;
312       IFS=&quot;:&quot;
313       VS_PATH_WINDOWS=&quot;&quot;
314       for i in $TOOLCHAIN_PATH; do
315         path=$i
<a name="3" id="anc3"></a><span class="line-modified">316         UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([path])</span>
317         VS_PATH_WINDOWS=&quot;$VS_PATH_WINDOWS;$path&quot;
318       done
319       IFS=&quot;$OLDIFS&quot;
320       # Append the current path from Windows env
321       WINDOWS_PATH=&quot;`$CMD /c echo %PATH%`&quot;
322       VS_PATH_WINDOWS=&quot;$VS_PATH_WINDOWS;$WINDOWS_PATH&quot;
323     else
324       VS_PATH=&quot;$TOOLCHAIN_PATH:$PATH&quot;
325     fi
326 
327     # Convert DEVKIT_VS_INCLUDE into windows style VS_INCLUDE so that it
328     # can still be exported as INCLUDE for compiler invocations without
329     # SYSROOT_CFLAGS
330     OLDIFS=&quot;$IFS&quot;
331     IFS=&quot;;&quot;
332     for i in $DEVKIT_VS_INCLUDE; do
333       ipath=$i
<a name="4" id="anc4"></a><span class="line-modified">334       UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([ipath])</span>
335       VS_INCLUDE=&quot;$VS_INCLUDE;$ipath&quot;
336     done
337     # Convert DEVKIT_VS_LIB into VS_LIB so that it can still be exported
338     # as LIB for compiler invocations without SYSROOT_LDFLAGS
339     for i in $DEVKIT_VS_LIB; do
340       libpath=$i
<a name="5" id="anc5"></a><span class="line-modified">341       UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([libpath])</span>
342       VS_LIB=&quot;$VS_LIB;$libpath&quot;
343     done
344     IFS=&quot;$OLDIFS&quot;
345 
346     AC_MSG_NOTICE([Found devkit $VS_DESCRIPTION])
347 
348   elif test &quot;x$with_toolchain_version&quot; != x; then
349     # User override; check that it is valid
350     if test &quot;x${VALID_VS_VERSIONS/$with_toolchain_version/}&quot; = &quot;x${VALID_VS_VERSIONS}&quot;; then
351       AC_MSG_NOTICE([Visual Studio version $with_toolchain_version is not valid.])
352       AC_MSG_NOTICE([Valid Visual Studio versions: $VALID_VS_VERSIONS.])
353       AC_MSG_ERROR([Cannot continue.])
354     fi
355     VS_VERSIONS_PROBE_LIST=&quot;$with_toolchain_version&quot;
356   else
357     # No flag given, use default
358     VS_VERSIONS_PROBE_LIST=&quot;$VALID_VS_VERSIONS&quot;
359   fi
360 
361   for VS_VERSION in $VS_VERSIONS_PROBE_LIST; do
362     TOOLCHAIN_FIND_VISUAL_STUDIO_BAT_FILE([$VS_VERSION])
363     if test &quot;x$VS_ENV_CMD&quot; != x; then
364       TOOLCHAIN_VERSION=$VS_VERSION
365       eval VS_DESCRIPTION=&quot;\${VS_DESCRIPTION_${VS_VERSION}}&quot;
366       eval VS_VERSION_INTERNAL=&quot;\${VS_VERSION_INTERNAL_${VS_VERSION}}&quot;
367       eval MSVCR_NAME=&quot;\${VS_MSVCR_${VS_VERSION}}&quot;
368       eval MSVCP_NAME=&quot;\${VS_MSVCP_${VS_VERSION}}&quot;
369       eval USE_UCRT=&quot;\${VS_USE_UCRT_${VS_VERSION}}&quot;
370       eval VS_SUPPORTED=&quot;\${VS_SUPPORTED_${VS_VERSION}}&quot;
371       # The rest of the variables are already evaled while probing
372       AC_MSG_NOTICE([Found $VS_DESCRIPTION])
373       break
374     fi
375   done
376 
377   TOOLCHAIN_DESCRIPTION=&quot;$VS_DESCRIPTION&quot;
378   if test &quot;x$VS_SUPPORTED&quot; = &quot;xfalse&quot;; then
379     UNSUPPORTED_TOOLCHAIN_VERSION=yes
380   fi
381 ])
382 
383 ################################################################################
384 # Check if the VS env variables were setup prior to running configure.
385 # If not, then find vcvarsall.bat and run it automatically, and integrate
386 # the set env variables into the spec file.
387 AC_DEFUN([TOOLCHAIN_SETUP_VISUAL_STUDIO_ENV],
388 [
389   # Store path to cygwin link.exe to help excluding it when searching for
390   # VS linker. This must be done before changing the PATH when looking for VS.
391   AC_PATH_PROG(CYGWIN_LINK, link.exe)
392   if test &quot;x$CYGWIN_LINK&quot; != x; then
393     AC_MSG_CHECKING([if the first found link.exe is actually the Cygwin link tool])
394     &quot;$CYGWIN_LINK&quot; --version &gt; /dev/null
395     if test $? -eq 0 ; then
396       AC_MSG_RESULT([yes])
397     else
398       AC_MSG_RESULT([no])
399       # This might be the VS linker. Don&#39;t exclude it later on.
400       CYGWIN_LINK=&quot;&quot;
401     fi
402   fi
403 
404   # First-hand choice is to locate and run the vsvars bat file.
405   TOOLCHAIN_FIND_VISUAL_STUDIO
406 
407   # If we have a devkit, skip all of the below.
408   if test &quot;x$DEVKIT_VS_VERSION&quot; = x; then
409     if test &quot;x$VS_ENV_CMD&quot; != x; then
410       # We have found a Visual Studio environment on disk, let&#39;s extract variables from the vsvars bat file.
<a name="6" id="anc6"></a><span class="line-modified">411       UTIL_FIXUP_EXECUTABLE(VS_ENV_CMD)</span>
412 
413       # Lets extract the variables that are set by vcvarsall.bat/vsvars32.bat/vsvars64.bat
414       AC_MSG_NOTICE([Trying to extract Visual Studio environment variables])
415 
416       # We need to create a couple of temporary files.
417       VS_ENV_TMP_DIR=&quot;$CONFIGURESUPPORT_OUTPUTDIR/vs-env&quot;
418       $MKDIR -p $VS_ENV_TMP_DIR
419 
420       # Cannot use the VS10 setup script directly (since it only updates the DOS subshell environment).
421       # Instead create a shell script which will set the relevant variables when run.
422       WINPATH_VS_ENV_CMD=&quot;$VS_ENV_CMD&quot;
<a name="7" id="anc7"></a><span class="line-modified">423       UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([WINPATH_VS_ENV_CMD])</span>
424 
425       if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
426         WINPATH_BASH=&quot;bash&quot;
427       else
428         WINPATH_BASH=&quot;$BASH&quot;
<a name="8" id="anc8"></a><span class="line-modified">429         UTIL_REWRITE_AS_WINDOWS_MIXED_PATH([WINPATH_BASH])</span>
430       fi
431 
432       # Generate a DOS batch file which runs $VS_ENV_CMD, and then creates a shell
433       # script (executable by bash) that will setup the important variables.
434       EXTRACT_VC_ENV_BAT_FILE=&quot;$VS_ENV_TMP_DIR/extract-vs-env.bat&quot;
435       $ECHO &quot;@echo off&quot; &gt;  $EXTRACT_VC_ENV_BAT_FILE
436       # This will end up something like:
437       # call C:/progra~2/micros~2.0/vc/bin/amd64/vcvars64.bat
438       $ECHO &quot;call \&quot;$WINPATH_VS_ENV_CMD\&quot; $VS_ENV_ARGS&quot; &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
439       # In some cases, the VS_ENV_CMD will change directory, change back so
440       # the set-vs-env.sh ends up in the right place.
441       $ECHO &#39;cd %~dp0&#39; &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
442       if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
443         # These will end up something like:
444         # echo VS_PATH=\&quot;$PATH\&quot; &gt; set-vs-env.sh
445         # The trailing space for everyone except PATH is no typo, but is needed due
446         # to trailing \ in the Windows paths. These will be stripped later.
447         # Trying pure CMD extract. This results in windows paths that need to
448         # be converted post extraction, but a simpler script.
449         $ECHO &#39;echo VS_PATH=&quot;%PATH%&quot; &gt; set-vs-env.sh&#39; \
450             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
451         $ECHO &#39;echo VS_INCLUDE=&quot;%INCLUDE% &quot; &gt;&gt; set-vs-env.sh&#39; \
452             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
453         $ECHO &#39;echo VS_LIB=&quot;%LIB% &quot; &gt;&gt; set-vs-env.sh&#39; \
454             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
455         $ECHO &#39;echo VCINSTALLDIR=&quot;%VCINSTALLDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
456             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
457         $ECHO &#39;echo VCToolsRedistDir=&quot;%VCToolsRedistDir% &quot; &gt;&gt; set-vs-env.sh&#39; \
458             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
459         $ECHO &#39;echo WindowsSdkDir=&quot;%WindowsSdkDir% &quot; &gt;&gt; set-vs-env.sh&#39; \
460             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
461         $ECHO &#39;echo WINDOWSSDKDIR=&quot;%WINDOWSSDKDIR% &quot; &gt;&gt; set-vs-env.sh&#39; \
462             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
463       else
464         # These will end up something like:
465         # C:/CygWin/bin/bash -c &#39;echo VS_PATH=\&quot;$PATH\&quot; &gt; localdevenv.sh
466         # The trailing space for everyone except PATH is no typo, but is needed due
467         # to trailing \ in the Windows paths. These will be stripped later.
468         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_PATH=&quot;&#39;\&quot;$PATH\&quot; &gt; set-vs-env.sh&#39; \
469             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
470         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_INCLUDE=&quot;&#39;\&quot;$INCLUDE\;$include \&quot; &gt;&gt; set-vs-env.sh&#39; \
471             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
472         $ECHO &quot;$WINPATH_BASH -c &#39;echo VS_LIB=&quot;&#39;\&quot;$LIB\;$lib \&quot; &gt;&gt; set-vs-env.sh&#39; \
473             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
474         $ECHO &quot;$WINPATH_BASH -c &#39;echo VCINSTALLDIR=&quot;&#39;\&quot;$VCINSTALLDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
475             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
476         $ECHO &quot;$WINPATH_BASH -c &#39;echo VCToolsRedistDir=&quot;&#39;\&quot;$VCToolsRedistDir \&quot; &gt;&gt; set-vs-env.sh&#39; \
477             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
478         $ECHO &quot;$WINPATH_BASH -c &#39;echo WindowsSdkDir=&quot;&#39;\&quot;$WindowsSdkDir \&quot; &gt;&gt; set-vs-env.sh&#39; \
479             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
480         $ECHO &quot;$WINPATH_BASH -c &#39;echo WINDOWSSDKDIR=&quot;&#39;\&quot;$WINDOWSSDKDIR \&quot; &gt;&gt; set-vs-env.sh&#39; \
481             &gt;&gt; $EXTRACT_VC_ENV_BAT_FILE
482       fi
483 
484       # Now execute the newly created bat file.
485       # The | cat is to stop SetEnv.Cmd to mess with system colors on msys.
486       # Change directory so we don&#39;t need to mess with Windows paths in redirects.
487       cd $VS_ENV_TMP_DIR
488       $CMD /c extract-vs-env.bat | $CAT
489       cd $CONFIGURE_START_DIR
490 
491       if test ! -s $VS_ENV_TMP_DIR/set-vs-env.sh; then
492         AC_MSG_NOTICE([Could not succesfully extract the environment variables needed for the VS setup.])
493         AC_MSG_NOTICE([Try setting --with-tools-dir to the VC/bin directory within the VS installation])
494         AC_MSG_NOTICE([or run &quot;bash.exe -l&quot; from a VS command prompt and then run configure from there.])
495         AC_MSG_ERROR([Cannot continue])
496       fi
497 
498       # Remove windows line endings
499       $SED -i -e &#39;s|\r||g&#39; $VS_ENV_TMP_DIR/set-vs-env.sh
500 
501       # Now set all paths and other env variables. This will allow the rest of
502       # the configure script to find and run the compiler in the proper way.
503       AC_MSG_NOTICE([Setting extracted environment variables])
504       . $VS_ENV_TMP_DIR/set-vs-env.sh
505       # Now we have VS_PATH, VS_INCLUDE, VS_LIB. For further checking, we
506       # also define VCINSTALLDIR, WindowsSdkDir and WINDOWSSDKDIR.
507 
508       # In WSL, the extracted VS_PATH is Windows style. This needs to be
509       # rewritten as Unix style and the Windows style version is saved
510       # in VS_PATH_WINDOWS.
511       if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.wsl&quot;; then
512         OLDIFS=&quot;$IFS&quot;
513         IFS=&quot;;&quot;
514         # Convert VS_PATH to unix style
515         VS_PATH_WINDOWS=&quot;$VS_PATH&quot;
516         VS_PATH=&quot;&quot;
517         for i in $VS_PATH_WINDOWS; do
518           path=$i
519           # Only process non-empty elements
520           if test &quot;x$path&quot; != x; then
521             IFS=&quot;$OLDIFS&quot;
522             # Check that directory exists before calling fixup_path
523             testpath=$path
<a name="9" id="anc9"></a><span class="line-modified">524             UTIL_REWRITE_AS_UNIX_PATH([testpath])</span>
525             if test -d &quot;$testpath&quot;; then
<a name="10" id="anc10"></a><span class="line-modified">526               UTIL_FIXUP_PATH([path])</span>
<span class="line-modified">527               UTIL_APPEND_TO_PATH(VS_PATH, $path)</span>
528             fi
529             IFS=&quot;;&quot;
530           fi
531         done
532         IFS=&quot;$OLDIFS&quot;
533       fi
534 
535     else
536       # We did not find a vsvars bat file, let&#39;s hope we are run from a VS command prompt.
537       AC_MSG_NOTICE([Cannot locate a valid Visual Studio installation, checking current environment])
538     fi
539   fi
540 
541   # At this point, we should have correct variables in the environment, or we can&#39;t continue.
542   AC_MSG_CHECKING([for Visual Studio variables])
543 
544   if test &quot;x$VCINSTALLDIR&quot; != x || test &quot;x$WindowsSDKDir&quot; != x \
545       || test &quot;x$WINDOWSSDKDIR&quot; != x || test &quot;x$DEVKIT_NAME&quot; != x; then
546     if test &quot;x$VS_INCLUDE&quot; = x || test &quot;x$VS_LIB&quot; = x; then
547       AC_MSG_RESULT([present but broken])
548       AC_MSG_ERROR([Your VC command prompt seems broken, INCLUDE and/or LIB is missing.])
549     else
550       AC_MSG_RESULT([ok])
551       # Remove any trailing &quot;\&quot; &quot;;&quot; and &quot; &quot; from the variables.
552       VS_INCLUDE=`$ECHO &quot;$VS_INCLUDE&quot; | $SED -e &#39;s/\\\\*;* *$//&#39;`
553       VS_LIB=`$ECHO &quot;$VS_LIB&quot; | $SED &#39;s/\\\\*;* *$//&#39;`
554       VCINSTALLDIR=`$ECHO &quot;$VCINSTALLDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`
555       VCToolsRedistDir=`$ECHO &quot;$VCToolsRedistDir&quot; | $SED &#39;s/\\\\* *$//&#39;`
556       WindowsSdkDir=`$ECHO &quot;$WindowsSdkDir&quot; | $SED &#39;s/\\\\* *$//&#39;`
557       WINDOWSSDKDIR=`$ECHO &quot;$WINDOWSSDKDIR&quot; | $SED &#39;s/\\\\* *$//&#39;`
558       if test -z &quot;$WINDOWSSDKDIR&quot;; then
559         WINDOWSSDKDIR=&quot;$WindowsSdkDir&quot;
560       fi
561       # Remove any paths containing # (typically F#) as that messes up make. This
562       # is needed if visual studio was installed with F# support.
563       VS_PATH=`$ECHO &quot;$VS_PATH&quot; | $SED &#39;s/[[^:#]]*#[^:]*://g&#39;`
564 
565       AC_SUBST(VS_PATH)
566       AC_SUBST(VS_INCLUDE)
567       AC_SUBST(VS_LIB)
568 
569       # Convert VS_INCLUDE into SYSROOT_CFLAGS
570       OLDIFS=&quot;$IFS&quot;
571       IFS=&quot;;&quot;
572       for i in $VS_INCLUDE; do
573         ipath=$i
574         # Only process non-empty elements
575         if test &quot;x$ipath&quot; != x; then
576           IFS=&quot;$OLDIFS&quot;
577           # Check that directory exists before calling fixup_path
578           testpath=$ipath
<a name="11" id="anc11"></a><span class="line-modified">579           UTIL_REWRITE_AS_UNIX_PATH([testpath])</span>
580           if test -d &quot;$testpath&quot;; then
<a name="12" id="anc12"></a><span class="line-modified">581             UTIL_FIXUP_PATH([ipath])</span>
582             SYSROOT_CFLAGS=&quot;$SYSROOT_CFLAGS -I$ipath&quot;
583           fi
584           IFS=&quot;;&quot;
585         fi
586       done
587       # Convert VS_LIB into SYSROOT_LDFLAGS
588       for i in $VS_LIB; do
589         libpath=$i
590         # Only process non-empty elements
591         if test &quot;x$libpath&quot; != x; then
592           IFS=&quot;$OLDIFS&quot;
593           # Check that directory exists before calling fixup_path
594           testpath=$libpath
<a name="13" id="anc13"></a><span class="line-modified">595           UTIL_REWRITE_AS_UNIX_PATH([testpath])</span>
596           if test -d &quot;$testpath&quot;; then
<a name="14" id="anc14"></a><span class="line-modified">597             UTIL_FIXUP_PATH([libpath])</span>
598             SYSROOT_LDFLAGS=&quot;$SYSROOT_LDFLAGS -libpath:$libpath&quot;
599           fi
600           IFS=&quot;;&quot;
601         fi
602       done
603       IFS=&quot;$OLDIFS&quot;
604 
605       AC_SUBST(VS_PATH_WINDOWS)
606     fi
607   else
608     AC_MSG_RESULT([not found])
609 
610     if test &quot;x$VS_ENV_CMD&quot; = x; then
611       AC_MSG_NOTICE([Cannot locate a valid Visual Studio or Windows SDK installation on disk,])
612       AC_MSG_NOTICE([nor is this script run from a Visual Studio command prompt.])
613     else
614       AC_MSG_NOTICE([Running the extraction script failed.])
615     fi
616     AC_MSG_NOTICE([Try setting --with-tools-dir to the VC/bin directory within the VS installation])
617     AC_MSG_NOTICE([or run &quot;bash.exe -l&quot; from a VS command prompt and then run configure from there.])
618     AC_MSG_ERROR([Cannot continue])
619   fi
620 ])
621 
622 AC_DEFUN([TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL],
623 [
624   DLL_NAME=&quot;$1&quot;
625   POSSIBLE_MSVC_DLL=&quot;$2&quot;
626   METHOD=&quot;$3&quot;
627   if test -n &quot;$POSSIBLE_MSVC_DLL&quot; -a -e &quot;$POSSIBLE_MSVC_DLL&quot;; then
628     AC_MSG_NOTICE([Found $DLL_NAME at $POSSIBLE_MSVC_DLL using $METHOD])
629 
630     # Need to check if the found msvcr is correct architecture
631     AC_MSG_CHECKING([found $DLL_NAME architecture])
632     MSVC_DLL_FILETYPE=`$FILE -b &quot;$POSSIBLE_MSVC_DLL&quot;`
633     if test &quot;x$OPENJDK_BUILD_OS_ENV&quot; = &quot;xwindows.msys&quot;; then
634       # The MSYS &#39;file&#39; command returns &quot;PE32 executable for MS Windows (DLL) (GUI) Intel 80386 32-bit&quot;
635       # on x32 and &quot;PE32+ executable for MS Windows (DLL) (GUI) Mono/.Net assembly&quot; on x64 systems.
636       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
637         CORRECT_MSVCR_ARCH=&quot;PE32 executable&quot;
638       else
639         CORRECT_MSVCR_ARCH=&quot;PE32+ executable&quot;
640       fi
641     else
642       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x32; then
643         CORRECT_MSVCR_ARCH=386
644       else
645         CORRECT_MSVCR_ARCH=x86-64
646       fi
647     fi
648     if $ECHO &quot;$MSVC_DLL_FILETYPE&quot; | $GREP &quot;$CORRECT_MSVCR_ARCH&quot; 2&gt;&amp;1 &gt; /dev/null; then
649       AC_MSG_RESULT([ok])
650       MSVC_DLL=&quot;$POSSIBLE_MSVC_DLL&quot;
651       AC_MSG_CHECKING([for $DLL_NAME])
652       AC_MSG_RESULT([$MSVC_DLL])
653     else
654       AC_MSG_RESULT([incorrect, ignoring])
655       AC_MSG_NOTICE([The file type of the located $DLL_NAME is $MSVC_DLL_FILETYPE])
656     fi
657   fi
658 ])
659 
660 AC_DEFUN([TOOLCHAIN_SETUP_MSVC_DLL],
661 [
662   DLL_NAME=&quot;$1&quot;
663   MSVC_DLL=
664 
665   if test &quot;x$MSVC_DLL&quot; = x; then
666     if test &quot;x$VCINSTALLDIR&quot; != x; then
667       CYGWIN_VC_INSTALL_DIR=&quot;$VCINSTALLDIR&quot;
<a name="15" id="anc15"></a><span class="line-modified">668       UTIL_FIXUP_PATH(CYGWIN_VC_INSTALL_DIR)</span>
669       if test &quot;$VS_VERSION&quot; -lt 2017; then
670         # Probe: Using well-known location from Visual Studio 12.0 and older
671         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
672           POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
673         else
674           POSSIBLE_MSVC_DLL=&quot;$CYGWIN_VC_INSTALL_DIR/redist/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME&quot;
675         fi
676       else
677         CYGWIN_VC_TOOLS_REDIST_DIR=&quot;$VCToolsRedistDir&quot;
<a name="16" id="anc16"></a><span class="line-modified">678         UTIL_FIXUP_PATH(CYGWIN_VC_TOOLS_REDIST_DIR)</span>
679         # Probe: Using well-known location from VS 2017 and VS 2019
680         if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
681           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_TOOLS_REDIST_DIR/x64/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;
682         else
683           POSSIBLE_MSVC_DLL=&quot;`ls $CYGWIN_VC_TOOLS_REDIST_DIR/x86/Microsoft.VC${VS_VERSION_INTERNAL}.CRT/$DLL_NAME`&quot;
684         fi
685       fi
686       # In case any of the above finds more than one file, loop over them.
687       for possible_msvc_dll in $POSSIBLE_MSVC_DLL; do
688         $ECHO &quot;POSSIBLE_MSVC_DLL $possible_msvc_dll&quot;
689         TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$possible_msvc_dll],
690             [well-known location in VCINSTALLDIR])
691       done
692     fi
693   fi
694 
695   if test &quot;x$MSVC_DLL&quot; = x; then
696     # Probe: Check in the Boot JDK directory.
697     POSSIBLE_MSVC_DLL=&quot;$BOOT_JDK/bin/$DLL_NAME&quot;
698     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
699         [well-known location in Boot JDK])
700   fi
701 
702   if test &quot;x$MSVC_DLL&quot; = x; then
703     # Probe: Look in the Windows system32 directory
704     CYGWIN_SYSTEMROOT=&quot;$SYSTEMROOT&quot;
<a name="17" id="anc17"></a><span class="line-modified">705     UTIL_REWRITE_AS_UNIX_PATH(CYGWIN_SYSTEMROOT)</span>
706     POSSIBLE_MSVC_DLL=&quot;$CYGWIN_SYSTEMROOT/system32/$DLL_NAME&quot;
707     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
708         [well-known location in SYSTEMROOT])
709   fi
710 
711   if test &quot;x$MSVC_DLL&quot; = x; then
712     # Probe: If Visual Studio Express is installed, there is usually one with the debugger
713     if test &quot;x$VS100COMNTOOLS&quot; != x; then
714       CYGWIN_VS_TOOLS_DIR=&quot;$VS100COMNTOOLS/..&quot;
<a name="18" id="anc18"></a><span class="line-modified">715       UTIL_REWRITE_AS_UNIX_PATH(CYGWIN_VS_TOOLS_DIR)</span>
716       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
717         POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VS_TOOLS_DIR&quot; -name $DLL_NAME \
718         | $GREP -i /x64/ | $HEAD --lines 1`
719       else
720         POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VS_TOOLS_DIR&quot; -name $DLL_NAME \
721         | $GREP -i /x86/ | $HEAD --lines 1`
722       fi
723       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
724           [search of VS100COMNTOOLS])
725     fi
726   fi
727 
728   if test &quot;x$MSVC_DLL&quot; = x; then
729     # Probe: Search wildly in the VCINSTALLDIR. We&#39;ve probably lost by now.
730     # (This was the original behaviour; kept since it might turn something up)
731     if test &quot;x$CYGWIN_VC_INSTALL_DIR&quot; != x; then
732       if test &quot;x$OPENJDK_TARGET_CPU_BITS&quot; = x64; then
733         POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VC_INSTALL_DIR&quot; -name $DLL_NAME \
734         | $GREP x64 | $HEAD --lines 1`
735       else
736         POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VC_INSTALL_DIR&quot; -name $DLL_NAME \
737         | $GREP x86 | $GREP -v ia64 | $GREP -v x64 | $HEAD --lines 1`
738         if test &quot;x$POSSIBLE_MSVC_DLL&quot; = x; then
739           # We&#39;re grasping at straws now...
740           POSSIBLE_MSVC_DLL=`$FIND &quot;$CYGWIN_VC_INSTALL_DIR&quot; -name $DLL_NAME \
741           | $HEAD --lines 1`
742         fi
743       fi
744 
745       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL([$DLL_NAME], [$POSSIBLE_MSVC_DLL],
746           [search of VCINSTALLDIR])
747     fi
748   fi
749 
750   if test &quot;x$MSVC_DLL&quot; = x; then
751     AC_MSG_CHECKING([for $DLL_NAME])
752     AC_MSG_RESULT([no])
753     AC_MSG_ERROR([Could not find $DLL_NAME. Please specify using --with-msvcr-dll.])
754   fi
755 ])
756 
757 AC_DEFUN([TOOLCHAIN_SETUP_VS_RUNTIME_DLLS],
758 [
759   AC_ARG_WITH(msvcr-dll, [AS_HELP_STRING([--with-msvcr-dll],
760       [path to microsoft C runtime dll (msvcr*.dll) (Windows only) @&lt;:@probed@:&gt;@])])
761 
762   if test &quot;x$with_msvcr_dll&quot; != x; then
763     # If given explicitly by user, do not probe. If not present, fail directly.
764     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCR_NAME, [$with_msvcr_dll], [--with-msvcr-dll])
765     if test &quot;x$MSVC_DLL&quot; = x; then
766       AC_MSG_ERROR([Could not find a proper $MSVCR_NAME as specified by --with-msvcr-dll])
767     fi
768     MSVCR_DLL=&quot;$MSVC_DLL&quot;
769   elif test &quot;x$DEVKIT_MSVCR_DLL&quot; != x; then
770     TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCR_NAME, [$DEVKIT_MSVCR_DLL], [devkit])
771     if test &quot;x$MSVC_DLL&quot; = x; then
772       AC_MSG_ERROR([Could not find a proper $MSVCR_NAME as specified by devkit])
773     fi
774     MSVCR_DLL=&quot;$MSVC_DLL&quot;
775   else
776     TOOLCHAIN_SETUP_MSVC_DLL([${MSVCR_NAME}])
777     MSVCR_DLL=&quot;$MSVC_DLL&quot;
778   fi
779   AC_SUBST(MSVCR_DLL)
780 
781   AC_ARG_WITH(msvcp-dll, [AS_HELP_STRING([--with-msvcp-dll],
782       [path to microsoft C++ runtime dll (msvcp*.dll) (Windows only) @&lt;:@probed@:&gt;@])])
783 
784   if test &quot;x$MSVCP_NAME&quot; != &quot;x&quot;; then
785     if test &quot;x$with_msvcp_dll&quot; != x; then
786       # If given explicitly by user, do not probe. If not present, fail directly.
787       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCP_NAME, [$with_msvcp_dll], [--with-msvcp-dll])
788       if test &quot;x$MSVC_DLL&quot; = x; then
789         AC_MSG_ERROR([Could not find a proper $MSVCP_NAME as specified by --with-msvcp-dll])
790       fi
791       MSVCP_DLL=&quot;$MSVC_DLL&quot;
792     elif test &quot;x$DEVKIT_MSVCP_DLL&quot; != x; then
793       TOOLCHAIN_CHECK_POSSIBLE_MSVC_DLL($MSVCP_NAME, [$DEVKIT_MSVCP_DLL], [devkit])
794       if test &quot;x$MSVC_DLL&quot; = x; then
795         AC_MSG_ERROR([Could not find a proper $MSVCP_NAME as specified by devkit])
796       fi
797       MSVCP_DLL=&quot;$MSVC_DLL&quot;
798     else
799       TOOLCHAIN_SETUP_MSVC_DLL([${MSVCP_NAME}])
800       MSVCP_DLL=&quot;$MSVC_DLL&quot;
801     fi
802     AC_SUBST(MSVCP_DLL)
803   fi
804 
805   AC_ARG_WITH(ucrt-dll-dir, [AS_HELP_STRING([--with-ucrt-dll-dir],
806       [path to Microsoft Windows Kit UCRT DLL dir (Windows only) @&lt;:@probed@:&gt;@])])
807 
808   if test &quot;x$USE_UCRT&quot; = &quot;xtrue&quot;; then
809     AC_MSG_CHECKING([for UCRT DLL dir])
810     if test &quot;x$with_ucrt_dll_dir&quot; != x; then
811       if test -z &quot;$(ls -d &quot;$with_ucrt_dll_dir/&quot;*.dll 2&gt; /dev/null)&quot;; then
812         AC_MSG_RESULT([no])
813         AC_MSG_ERROR([Could not find any dlls in $with_ucrt_dll_dir])
814       else
815         AC_MSG_RESULT([$with_ucrt_dll_dir])
816         UCRT_DLL_DIR=&quot;$with_ucrt_dll_dir&quot;
<a name="19" id="anc19"></a><span class="line-modified">817         UTIL_FIXUP_PATH([UCRT_DLL_DIR])</span>
818       fi
819     elif test &quot;x$DEVKIT_UCRT_DLL_DIR&quot; != &quot;x&quot;; then
820       UCRT_DLL_DIR=&quot;$DEVKIT_UCRT_DLL_DIR&quot;
821       AC_MSG_RESULT($UCRT_DLL_DIR)
822     else
823       CYGWIN_WINDOWSSDKDIR=&quot;${WINDOWSSDKDIR}&quot;
<a name="20" id="anc20"></a><span class="line-modified">824       UTIL_FIXUP_PATH([CYGWIN_WINDOWSSDKDIR])</span>
825       dll_subdir=$OPENJDK_TARGET_CPU
826       if test &quot;x$dll_subdir&quot; = &quot;xx86_64&quot;; then
827         dll_subdir=&quot;x64&quot;
828       fi
829       UCRT_DLL_DIR=&quot;$CYGWIN_WINDOWSSDKDIR/Redist/ucrt/DLLs/$dll_subdir&quot;
830       if test -z &quot;$(ls -d &quot;$UCRT_DLL_DIR/&quot;*.dll 2&gt; /dev/null)&quot;; then
831         # Try with version subdir
832         UCRT_DLL_DIR=&quot;`ls -d $CYGWIN_WINDOWSSDKDIR/Redist/*/ucrt/DLLs/$dll_subdir \
833             2&gt; /dev/null | $SORT -d | $HEAD -n1`&quot;
834         if test -z &quot;$UCRT_DLL_DIR&quot; \
835             || test -z &quot;$(ls -d &quot;$UCRT_DLL_DIR/&quot;*.dll 2&gt; /dev/null)&quot;; then
836           AC_MSG_RESULT([no])
837           AC_MSG_ERROR([Could not find any dlls in $UCRT_DLL_DIR])
838         else
839           AC_MSG_RESULT($UCRT_DLL_DIR)
840         fi
841       else
842         AC_MSG_RESULT($UCRT_DLL_DIR)
843       fi
844     fi
845   else
846     UCRT_DLL_DIR=
847   fi
848   AC_SUBST(UCRT_DLL_DIR)
849 ])
<a name="21" id="anc21"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="21" type="hidden" />
</body>
</html>