<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff make/jdk/src/classes/build/tools/cldrconverter/CLDRConverter.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Bundle.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../generatelsrequivmaps/EquivMapsGenerator.java.udiff.html" target="_top">next &gt;</a></center>    <h2>make/jdk/src/classes/build/tools/cldrconverter/CLDRConverter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,11 +23,10 @@</span>
   * questions.
   */
  
  package build.tools.cldrconverter;
  
<span class="udiff-line-removed">- import static build.tools.cldrconverter.Bundle.jreTimeZoneNames;</span>
  import build.tools.cldrconverter.BundleGenerator.BundleType;
  import java.io.File;
  import java.io.IOException;
  import java.io.UncheckedIOException;
  import java.nio.file.*;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -87,11 +86,13 @@</span>
      static final String TIMEZONE_ID_PREFIX = &quot;timezone.id.&quot;;
      static final String EXEMPLAR_CITY_PREFIX = &quot;timezone.excity.&quot;;
      static final String ZONE_NAME_PREFIX = &quot;timezone.displayname.&quot;;
      static final String METAZONE_ID_PREFIX = &quot;metazone.id.&quot;;
      static final String PARENT_LOCALE_PREFIX = &quot;parentLocale.&quot;;
<span class="udiff-line-added">+     static final String META_EMPTY_ZONE_NAME = &quot;EMPTY_ZONE&quot;;</span>
      static final String[] EMPTY_ZONE = {&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;};
<span class="udiff-line-added">+     static final String META_ETCUTC_ZONE_NAME = &quot;ETC_UTC&quot;;</span>
  
      private static SupplementDataParseHandler handlerSuppl;
      private static LikelySubtagsParseHandler handlerLikelySubtags;
      private static WinZonesParseHandler handlerWinZones;
      static PluralsParseHandler handlerPlurals;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -682,74 +683,27 @@</span>
          }
          return currencyNames;
      }
  
      private static Map&lt;String, Object&gt; extractZoneNames(Map&lt;String, Object&gt; map, String id) {
<span class="udiff-line-modified-removed">-         Map&lt;String, Object&gt; names = new HashMap&lt;&gt;();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Copy over missing time zone ids from JRE for English locale</span>
<span class="udiff-line-removed">-         if (id.equals(&quot;en&quot;)) {</span>
<span class="udiff-line-removed">-             Map&lt;String[], String&gt; jreMetaMap = new HashMap&lt;&gt;();</span>
<span class="udiff-line-removed">-             jreTimeZoneNames.stream().forEach(e -&gt; {</span>
<span class="udiff-line-removed">-                 String tzid = (String)e[0];</span>
<span class="udiff-line-removed">-                 String[] data = (String[])e[1];</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 if (map.get(TIMEZONE_ID_PREFIX + tzid) == null &amp;&amp;</span>
<span class="udiff-line-removed">-                     handlerMetaZones.get(tzid) == null ||</span>
<span class="udiff-line-removed">-                     handlerMetaZones.get(tzid) != null &amp;&amp;</span>
<span class="udiff-line-removed">-                     map.get(METAZONE_ID_PREFIX + handlerMetaZones.get(tzid)) == null) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                     // First, check the alias</span>
<span class="udiff-line-removed">-                     String canonID = canonicalTZMap.get(tzid);</span>
<span class="udiff-line-removed">-                     if (canonID != null &amp;&amp; !tzid.equals(canonID)) {</span>
<span class="udiff-line-removed">-                         Object value = map.get(TIMEZONE_ID_PREFIX + canonID);</span>
<span class="udiff-line-removed">-                         if (value != null) {</span>
<span class="udiff-line-removed">-                             names.put(tzid, value);</span>
<span class="udiff-line-removed">-                             return;</span>
<span class="udiff-line-removed">-                         } else {</span>
<span class="udiff-line-removed">-                             String meta = handlerMetaZones.get(canonID);</span>
<span class="udiff-line-removed">-                             if (meta != null) {</span>
<span class="udiff-line-removed">-                                 value = map.get(METAZONE_ID_PREFIX + meta);</span>
<span class="udiff-line-removed">-                                 if (value != null) {</span>
<span class="udiff-line-removed">-                                     names.put(tzid, meta);</span>
<span class="udiff-line-removed">-                                     return;</span>
<span class="udiff-line-removed">-                                 }</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                     // Check the CLDR meta key</span>
<span class="udiff-line-removed">-                     Optional&lt;Map.Entry&lt;String, String&gt;&gt; cldrMeta =</span>
<span class="udiff-line-removed">-                         handlerMetaZones.getData().entrySet().stream()</span>
<span class="udiff-line-removed">-                             .filter(me -&gt;</span>
<span class="udiff-line-removed">-                                 Arrays.deepEquals(data,</span>
<span class="udiff-line-removed">-                                     (String[])map.get(METAZONE_ID_PREFIX + me.getValue())))</span>
<span class="udiff-line-removed">-                             .findAny();</span>
<span class="udiff-line-removed">-                     cldrMeta.ifPresentOrElse(meta -&gt; names.put(tzid, meta.getValue()), () -&gt; {</span>
<span class="udiff-line-removed">-                         // Check the JRE meta key, add if there is not.</span>
<span class="udiff-line-removed">-                         Optional&lt;Map.Entry&lt;String[], String&gt;&gt; jreMeta =</span>
<span class="udiff-line-removed">-                             jreMetaMap.entrySet().stream()</span>
<span class="udiff-line-removed">-                                 .filter(jm -&gt; Arrays.deepEquals(data, jm.getKey()))</span>
<span class="udiff-line-removed">-                                 .findAny();</span>
<span class="udiff-line-removed">-                         jreMeta.ifPresentOrElse(meta -&gt; names.put(tzid, meta.getValue()), () -&gt; {</span>
<span class="udiff-line-removed">-                                 String metaName = &quot;JRE_&quot; + tzid.replaceAll(&quot;[/-]&quot;, &quot;_&quot;);</span>
<span class="udiff-line-removed">-                                 names.put(METAZONE_ID_PREFIX + metaName, data);</span>
<span class="udiff-line-removed">-                                 names.put(tzid, metaName);</span>
<span class="udiff-line-removed">-                         });</span>
<span class="udiff-line-removed">-                     });</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             });</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         Map&lt;String, Object&gt; names = new TreeMap&lt;&gt;(KeyComparator.INSTANCE);</span>
  
          getAvailableZoneIds().stream().forEach(tzid -&gt; {
              // If the tzid is deprecated, get the data for the replacement id
              String tzKey = Optional.ofNullable((String)handlerSupplMeta.get(tzid))
                                     .orElse(tzid);
              Object data = map.get(TIMEZONE_ID_PREFIX + tzKey);
  
              if (data instanceof String[]) {
<span class="udiff-line-modified-removed">-                 names.put(tzid, data);</span>
<span class="udiff-line-modified-added">+                 // Hack for UTC. UTC is an alias to Etc/UTC in CLDR</span>
<span class="udiff-line-added">+                 if (tzid.equals(&quot;Etc/UTC&quot;) &amp;&amp; !map.containsKey(TIMEZONE_ID_PREFIX + &quot;UTC&quot;)) {</span>
<span class="udiff-line-added">+                     names.put(METAZONE_ID_PREFIX + META_ETCUTC_ZONE_NAME, data);</span>
<span class="udiff-line-added">+                     names.put(tzid, META_ETCUTC_ZONE_NAME);</span>
<span class="udiff-line-added">+                     names.put(&quot;UTC&quot;, META_ETCUTC_ZONE_NAME);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     names.put(tzid, data);</span>
<span class="udiff-line-added">+                 }</span>
              } else {
                  String meta = handlerMetaZones.get(tzKey);
                  if (meta != null) {
                      String metaKey = METAZONE_ID_PREFIX + meta;
                      data = map.get(metaKey);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -762,28 +716,27 @@</span>
              }
          });
  
          // exemplar cities.
          Map&lt;String, Object&gt; exCities = map.entrySet().stream()
<span class="udiff-line-modified-removed">-                 .filter(e -&gt; e.getKey().startsWith(CLDRConverter.EXEMPLAR_CITY_PREFIX))</span>
<span class="udiff-line-modified-removed">-                 .collect(Collectors</span>
<span class="udiff-line-removed">-                         .toMap(Map.Entry::getKey, Map.Entry::getValue));</span>
<span class="udiff-line-modified-added">+             .filter(e -&gt; e.getKey().startsWith(CLDRConverter.EXEMPLAR_CITY_PREFIX))</span>
<span class="udiff-line-modified-added">+             .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));</span>
          names.putAll(exCities);
  
<span class="udiff-line-modified-removed">-         if (!id.equals(&quot;en&quot;) &amp;&amp;</span>
<span class="udiff-line-modified-removed">-             !names.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-             // CLDR does not have UTC entry, so add it here.</span>
<span class="udiff-line-modified-removed">-             names.put(&quot;UTC&quot;, EMPTY_ZONE);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             // no metazone zones</span>
<span class="udiff-line-removed">-             Arrays.asList(handlerMetaZones.get(MetaZonesParseHandler.NO_METAZONE_KEY)</span>
<span class="udiff-line-removed">-                 .split(&quot;\\s&quot;)).stream()</span>
<span class="udiff-line-removed">-                 .forEach(tz -&gt; {</span>
<span class="udiff-line-removed">-                     names.put(tz, EMPTY_ZONE);</span>
<span class="udiff-line-removed">-                 });</span>
<span class="udiff-line-modified-added">+         // If there&#39;s no UTC entry at this point, add an empty one</span>
<span class="udiff-line-modified-added">+         if (!names.isEmpty() &amp;&amp; !names.containsKey(&quot;UTC&quot;)) {</span>
<span class="udiff-line-modified-added">+             names.putIfAbsent(METAZONE_ID_PREFIX + META_EMPTY_ZONE_NAME, EMPTY_ZONE);</span>
<span class="udiff-line-modified-added">+             names.put(&quot;UTC&quot;, META_EMPTY_ZONE_NAME);</span>
          }
  
<span class="udiff-line-added">+         // Finally some compatibility stuff</span>
<span class="udiff-line-added">+         ZoneId.SHORT_IDS.entrySet().stream()</span>
<span class="udiff-line-added">+             .filter(e -&gt; !names.containsKey(e.getKey()) &amp;&amp; names.containsKey(e.getValue()))</span>
<span class="udiff-line-added">+             .forEach(e -&gt; {</span>
<span class="udiff-line-added">+                 names.put(e.getKey(), names.get(e.getValue()));</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+ </span>
          return names;
      }
  
      /**
       * Extracts the language independent calendar data. Each of the two keys,
</pre>
<center><a href="Bundle.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../generatelsrequivmaps/EquivMapsGenerator.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>