<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os/bsd/os_bsd.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1999, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;oops/oop.inline.hpp&quot;
  40 #include &quot;os_bsd.inline.hpp&quot;
  41 #include &quot;os_posix.inline.hpp&quot;
  42 #include &quot;os_share_bsd.hpp&quot;
  43 #include &quot;prims/jniFastGetField.hpp&quot;
  44 #include &quot;prims/jvm_misc.hpp&quot;
  45 #include &quot;runtime/arguments.hpp&quot;
  46 #include &quot;runtime/atomic.hpp&quot;
  47 #include &quot;runtime/extendedPC.hpp&quot;
  48 #include &quot;runtime/globals.hpp&quot;
  49 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  50 #include &quot;runtime/java.hpp&quot;
  51 #include &quot;runtime/javaCalls.hpp&quot;
  52 #include &quot;runtime/mutexLocker.hpp&quot;
  53 #include &quot;runtime/objectMonitor.hpp&quot;
  54 #include &quot;runtime/osThread.hpp&quot;
  55 #include &quot;runtime/perfMemory.hpp&quot;
  56 #include &quot;runtime/semaphore.hpp&quot;
  57 #include &quot;runtime/sharedRuntime.hpp&quot;
  58 #include &quot;runtime/statSampler.hpp&quot;
  59 #include &quot;runtime/stubRoutines.hpp&quot;
  60 #include &quot;runtime/thread.inline.hpp&quot;
  61 #include &quot;runtime/threadCritical.hpp&quot;
  62 #include &quot;runtime/timer.hpp&quot;
  63 #include &quot;services/attachListener.hpp&quot;
  64 #include &quot;services/memTracker.hpp&quot;
  65 #include &quot;services/runtimeService.hpp&quot;
  66 #include &quot;utilities/align.hpp&quot;
  67 #include &quot;utilities/decoder.hpp&quot;
  68 #include &quot;utilities/defaultStream.hpp&quot;
  69 #include &quot;utilities/events.hpp&quot;
  70 #include &quot;utilities/growableArray.hpp&quot;
  71 #include &quot;utilities/vmError.hpp&quot;
  72 
  73 // put OS-includes here
  74 # include &lt;dlfcn.h&gt;
  75 # include &lt;errno.h&gt;
  76 # include &lt;fcntl.h&gt;
  77 # include &lt;inttypes.h&gt;
  78 # include &lt;poll.h&gt;
  79 # include &lt;pthread.h&gt;
  80 # include &lt;pwd.h&gt;
  81 # include &lt;signal.h&gt;
  82 # include &lt;stdint.h&gt;
  83 # include &lt;stdio.h&gt;
  84 # include &lt;string.h&gt;
  85 # include &lt;sys/ioctl.h&gt;
  86 # include &lt;sys/mman.h&gt;
  87 # include &lt;sys/param.h&gt;
  88 # include &lt;sys/resource.h&gt;
  89 # include &lt;sys/socket.h&gt;
  90 # include &lt;sys/stat.h&gt;
  91 # include &lt;sys/syscall.h&gt;
  92 # include &lt;sys/sysctl.h&gt;
  93 # include &lt;sys/time.h&gt;
  94 # include &lt;sys/times.h&gt;
  95 # include &lt;sys/types.h&gt;
  96 # include &lt;sys/wait.h&gt;
  97 # include &lt;time.h&gt;
  98 # include &lt;unistd.h&gt;
  99 
 100 #if defined(__FreeBSD__) || defined(__NetBSD__)
 101   #include &lt;elf.h&gt;
 102 #endif
 103 
 104 #ifdef __APPLE__
 105   #include &lt;mach-o/dyld.h&gt;
 106 #endif
 107 
 108 #ifndef MAP_ANONYMOUS
 109   #define MAP_ANONYMOUS MAP_ANON
 110 #endif
 111 
 112 #define MAX_PATH    (2 * K)
 113 
 114 // for timer info max values which include all bits
 115 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 116 
 117 ////////////////////////////////////////////////////////////////////////////////
 118 // global variables
 119 julong os::Bsd::_physical_memory = 0;
 120 
 121 #ifdef __APPLE__
 122 mach_timebase_info_data_t os::Bsd::_timebase_info = {0, 0};
 123 volatile uint64_t         os::Bsd::_max_abstime   = 0;
 124 #else
 125 int (*os::Bsd::_clock_gettime)(clockid_t, struct timespec *) = NULL;
 126 #endif
 127 pthread_t os::Bsd::_main_thread;
 128 int os::Bsd::_page_size = -1;
 129 
 130 static jlong initial_time_count=0;
 131 
 132 static int clock_tics_per_sec = 100;
 133 
 134 // For diagnostics to print a message once. see run_periodic_checks
 135 static sigset_t check_signal_done;
 136 static bool check_signals = true;
 137 
 138 // Signal number used to suspend/resume a thread
 139 
 140 // do not use any signal number less than SIGSEGV, see 4355769
 141 static int SR_signum = SIGUSR2;
 142 sigset_t SR_sigset;
 143 
 144 
 145 ////////////////////////////////////////////////////////////////////////////////
 146 // utility functions
 147 
 148 static int SR_initialize();
 149 
 150 julong os::available_memory() {
 151   return Bsd::available_memory();
 152 }
 153 
 154 // available here means free
 155 julong os::Bsd::available_memory() {
 156   uint64_t available = physical_memory() &gt;&gt; 2;
 157 #ifdef __APPLE__
 158   mach_msg_type_number_t count = HOST_VM_INFO64_COUNT;
 159   vm_statistics64_data_t vmstat;
 160   kern_return_t kerr = host_statistics64(mach_host_self(), HOST_VM_INFO64,
 161                                          (host_info64_t)&amp;vmstat, &amp;count);
 162   assert(kerr == KERN_SUCCESS,
 163          &quot;host_statistics64 failed - check mach_host_self() and count&quot;);
 164   if (kerr == KERN_SUCCESS) {
 165     available = vmstat.free_count * os::vm_page_size();
 166   }
 167 #endif
 168   return available;
 169 }
 170 
 171 // for more info see :
 172 // https://man.openbsd.org/sysctl.2
 173 void os::Bsd::print_uptime_info(outputStream* st) {
 174   struct timeval boottime;
 175   size_t len = sizeof(boottime);
 176   int mib[2];
 177   mib[0] = CTL_KERN;
 178   mib[1] = KERN_BOOTTIME;
 179 
 180   if (sysctl(mib, 2, &amp;boottime, &amp;len, NULL, 0) &gt;= 0) {
 181     time_t bootsec = boottime.tv_sec;
 182     time_t currsec = time(NULL);
 183     os::print_dhm(st, &quot;OS uptime:&quot;, (long) difftime(currsec, bootsec));
 184   }
 185 }
 186 
 187 julong os::physical_memory() {
 188   return Bsd::physical_memory();
 189 }
 190 
 191 // Return true if user is running as root.
 192 
 193 bool os::have_special_privileges() {
 194   static bool init = false;
 195   static bool privileges = false;
 196   if (!init) {
 197     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 198     init = true;
 199   }
 200   return privileges;
 201 }
 202 
 203 
 204 
 205 // Cpu architecture string
 206 #if   defined(ZERO)
 207 static char cpu_arch[] = ZERO_LIBARCH;
 208 #elif defined(IA64)
 209 static char cpu_arch[] = &quot;ia64&quot;;
 210 #elif defined(IA32)
 211 static char cpu_arch[] = &quot;i386&quot;;
 212 #elif defined(AMD64)
 213 static char cpu_arch[] = &quot;amd64&quot;;
 214 #elif defined(ARM)
 215 static char cpu_arch[] = &quot;arm&quot;;
 216 #elif defined(PPC32)
 217 static char cpu_arch[] = &quot;ppc&quot;;
 218 #elif defined(SPARC)
 219   #ifdef _LP64
 220 static char cpu_arch[] = &quot;sparcv9&quot;;
 221   #else
 222 static char cpu_arch[] = &quot;sparc&quot;;
 223   #endif
 224 #else
 225   #error Add appropriate cpu_arch setting
 226 #endif
 227 
 228 // Compiler variant
 229 #ifdef COMPILER2
 230   #define COMPILER_VARIANT &quot;server&quot;
 231 #else
 232   #define COMPILER_VARIANT &quot;client&quot;
 233 #endif
 234 
 235 
 236 void os::Bsd::initialize_system_info() {
 237   int mib[2];
 238   size_t len;
 239   int cpu_val;
 240   julong mem_val;
 241 
 242   // get processors count via hw.ncpus sysctl
 243   mib[0] = CTL_HW;
 244   mib[1] = HW_NCPU;
 245   len = sizeof(cpu_val);
 246   if (sysctl(mib, 2, &amp;cpu_val, &amp;len, NULL, 0) != -1 &amp;&amp; cpu_val &gt;= 1) {
 247     assert(len == sizeof(cpu_val), &quot;unexpected data size&quot;);
 248     set_processor_count(cpu_val);
 249   } else {
 250     set_processor_count(1);   // fallback
 251   }
 252 
 253   // get physical memory via hw.memsize sysctl (hw.memsize is used
 254   // since it returns a 64 bit value)
 255   mib[0] = CTL_HW;
 256 
 257 #if defined (HW_MEMSIZE) // Apple
 258   mib[1] = HW_MEMSIZE;
 259 #elif defined(HW_PHYSMEM) // Most of BSD
 260   mib[1] = HW_PHYSMEM;
 261 #elif defined(HW_REALMEM) // Old FreeBSD
 262   mib[1] = HW_REALMEM;
 263 #else
 264   #error No ways to get physmem
 265 #endif
 266 
 267   len = sizeof(mem_val);
 268   if (sysctl(mib, 2, &amp;mem_val, &amp;len, NULL, 0) != -1) {
 269     assert(len == sizeof(mem_val), &quot;unexpected data size&quot;);
 270     _physical_memory = mem_val;
 271   } else {
 272     _physical_memory = 256 * 1024 * 1024;       // fallback (XXXBSD?)
 273   }
 274 
 275 #ifdef __OpenBSD__
 276   {
 277     // limit _physical_memory memory view on OpenBSD since
 278     // datasize rlimit restricts us anyway.
 279     struct rlimit limits;
 280     getrlimit(RLIMIT_DATA, &amp;limits);
 281     _physical_memory = MIN2(_physical_memory, (julong)limits.rlim_cur);
 282   }
 283 #endif
 284 }
 285 
 286 #ifdef __APPLE__
 287 static const char *get_home() {
 288   const char *home_dir = ::getenv(&quot;HOME&quot;);
 289   if ((home_dir == NULL) || (*home_dir == &#39;\0&#39;)) {
 290     struct passwd *passwd_info = getpwuid(geteuid());
 291     if (passwd_info != NULL) {
 292       home_dir = passwd_info-&gt;pw_dir;
 293     }
 294   }
 295 
 296   return home_dir;
 297 }
 298 #endif
 299 
 300 void os::init_system_properties_values() {
 301   // The next steps are taken in the product version:
 302   //
 303   // Obtain the JAVA_HOME value from the location of libjvm.so.
 304   // This library should be located at:
 305   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/{client|server}/libjvm.so.
 306   //
 307   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 308   // assume libjvm.so is installed in a JDK and we use this path.
 309   //
 310   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 311   //
 312   // The following extra steps are taken in the debugging version:
 313   //
 314   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 315   // instead of exit check for $JAVA_HOME environment variable.
 316   //
 317   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 318   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 319   // it looks like libjvm.so is installed there
 320   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 321   //
 322   // Otherwise exit.
 323   //
 324   // Important note: if the location of libjvm.so changes this
 325   // code needs to be changed accordingly.
 326 
 327   // See ld(1):
 328   //      The linker uses the following search paths to locate required
 329   //      shared libraries:
 330   //        1: ...
 331   //        ...
 332   //        7: The default directories, normally /lib and /usr/lib.
 333 #ifndef DEFAULT_LIBPATH
 334   #ifndef OVERRIDE_LIBPATH
 335     #define DEFAULT_LIBPATH &quot;/lib:/usr/lib&quot;
 336   #else
 337     #define DEFAULT_LIBPATH OVERRIDE_LIBPATH
 338   #endif
 339 #endif
 340 
 341 // Base path of extensions installed on the system.
 342 #define SYS_EXT_DIR     &quot;/usr/java/packages&quot;
 343 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 344 
 345 #ifndef __APPLE__
 346 
 347   // Buffer that fits several sprintfs.
 348   // Note that the space for the colon and the trailing null are provided
 349   // by the nulls included by the sizeof operator.
 350   const size_t bufsize =
 351     MAX2((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 352          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 353   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 354 
 355   // sysclasspath, java_home, dll_dir
 356   {
 357     char *pslash;
 358     os::jvm_path(buf, bufsize);
 359 
 360     // Found the full path to libjvm.so.
 361     // Now cut the path to &lt;java_home&gt;/jre if we can.
 362     *(strrchr(buf, &#39;/&#39;)) = &#39;\0&#39;; // Get rid of /libjvm.so.
 363     pslash = strrchr(buf, &#39;/&#39;);
 364     if (pslash != NULL) {
 365       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 366     }
 367     Arguments::set_dll_dir(buf);
 368 
 369     if (pslash != NULL) {
 370       pslash = strrchr(buf, &#39;/&#39;);
 371       if (pslash != NULL) {
 372         *pslash = &#39;\0&#39;;          // Get rid of /&lt;arch&gt;.
 373         pslash = strrchr(buf, &#39;/&#39;);
 374         if (pslash != NULL) {
 375           *pslash = &#39;\0&#39;;        // Get rid of /lib.
 376         }
 377       }
 378     }
 379     Arguments::set_java_home(buf);
 380     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 381       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 382     }
 383   }
 384 
 385   // Where to look for native libraries.
 386   //
 387   // Note: Due to a legacy implementation, most of the library path
 388   // is set in the launcher. This was to accomodate linking restrictions
 389   // on legacy Bsd implementations (which are no longer supported).
 390   // Eventually, all the library path setting will be done here.
 391   //
 392   // However, to prevent the proliferation of improperly built native
 393   // libraries, the new path component /usr/java/packages is added here.
 394   // Eventually, all the library path setting will be done here.
 395   {
 396     // Get the user setting of LD_LIBRARY_PATH, and prepended it. It
 397     // should always exist (until the legacy problem cited above is
 398     // addressed).
 399     const char *v = ::getenv(&quot;LD_LIBRARY_PATH&quot;);
 400     const char *v_colon = &quot;:&quot;;
 401     if (v == NULL) { v = &quot;&quot;; v_colon = &quot;&quot;; }
 402     // That&#39;s +1 for the colon and +1 for the trailing &#39;\0&#39;.
 403     char *ld_library_path = NEW_C_HEAP_ARRAY(char,
 404                                              strlen(v) + 1 +
 405                                              sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;) + strlen(cpu_arch) + sizeof(DEFAULT_LIBPATH) + 1,
 406                                              mtInternal);
 407     sprintf(ld_library_path, &quot;%s%s&quot; SYS_EXT_DIR &quot;/lib/%s:&quot; DEFAULT_LIBPATH, v, v_colon, cpu_arch);
 408     Arguments::set_library_path(ld_library_path);
 409     FREE_C_HEAP_ARRAY(char, ld_library_path);
 410   }
 411 
 412   // Extensions directories.
 413   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 414   Arguments::set_ext_dirs(buf);
 415 
 416   FREE_C_HEAP_ARRAY(char, buf);
 417 
 418 #else // __APPLE__
 419 
 420   #define SYS_EXTENSIONS_DIR   &quot;/Library/Java/Extensions&quot;
 421   #define SYS_EXTENSIONS_DIRS  SYS_EXTENSIONS_DIR &quot;:/Network&quot; SYS_EXTENSIONS_DIR &quot;:/System&quot; SYS_EXTENSIONS_DIR &quot;:/usr/lib/java&quot;
 422 
 423   const char *user_home_dir = get_home();
 424   // The null in SYS_EXTENSIONS_DIRS counts for the size of the colon after user_home_dir.
 425   size_t system_ext_size = strlen(user_home_dir) + sizeof(SYS_EXTENSIONS_DIR) +
 426     sizeof(SYS_EXTENSIONS_DIRS);
 427 
 428   // Buffer that fits several sprintfs.
 429   // Note that the space for the colon and the trailing null are provided
 430   // by the nulls included by the sizeof operator.
 431   const size_t bufsize =
 432     MAX2((size_t)MAXPATHLEN,  // for dll_dir &amp; friends.
 433          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + system_ext_size); // extensions dir
 434   char *buf = NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 435 
 436   // sysclasspath, java_home, dll_dir
 437   {
 438     char *pslash;
 439     os::jvm_path(buf, bufsize);
 440 
 441     // Found the full path to libjvm.so.
 442     // Now cut the path to &lt;java_home&gt;/jre if we can.
 443     *(strrchr(buf, &#39;/&#39;)) = &#39;\0&#39;; // Get rid of /libjvm.so.
 444     pslash = strrchr(buf, &#39;/&#39;);
 445     if (pslash != NULL) {
 446       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 447     }
 448 #ifdef STATIC_BUILD
 449     strcat(buf, &quot;/lib&quot;);
 450 #endif
 451 
 452     Arguments::set_dll_dir(buf);
 453 
 454     if (pslash != NULL) {
 455       pslash = strrchr(buf, &#39;/&#39;);
 456       if (pslash != NULL) {
 457         *pslash = &#39;\0&#39;;          // Get rid of /lib.
 458       }
 459     }
 460     Arguments::set_java_home(buf);
 461     set_boot_path(&#39;/&#39;, &#39;:&#39;);
 462   }
 463 
 464   // Where to look for native libraries.
 465   //
 466   // Note: Due to a legacy implementation, most of the library path
 467   // is set in the launcher. This was to accomodate linking restrictions
 468   // on legacy Bsd implementations (which are no longer supported).
 469   // Eventually, all the library path setting will be done here.
 470   //
 471   // However, to prevent the proliferation of improperly built native
 472   // libraries, the new path component /usr/java/packages is added here.
 473   // Eventually, all the library path setting will be done here.
 474   {
 475     // Get the user setting of LD_LIBRARY_PATH, and prepended it. It
 476     // should always exist (until the legacy problem cited above is
 477     // addressed).
 478     // Prepend the default path with the JAVA_LIBRARY_PATH so that the app launcher code
 479     // can specify a directory inside an app wrapper
 480     const char *l = ::getenv(&quot;JAVA_LIBRARY_PATH&quot;);
 481     const char *l_colon = &quot;:&quot;;
 482     if (l == NULL) { l = &quot;&quot;; l_colon = &quot;&quot;; }
 483 
 484     const char *v = ::getenv(&quot;DYLD_LIBRARY_PATH&quot;);
 485     const char *v_colon = &quot;:&quot;;
 486     if (v == NULL) { v = &quot;&quot;; v_colon = &quot;&quot;; }
 487 
 488     // Apple&#39;s Java6 has &quot;.&quot; at the beginning of java.library.path.
 489     // OpenJDK on Windows has &quot;.&quot; at the end of java.library.path.
 490     // OpenJDK on Linux and Solaris don&#39;t have &quot;.&quot; in java.library.path
 491     // at all. To ease the transition from Apple&#39;s Java6 to OpenJDK7,
 492     // &quot;.&quot; is appended to the end of java.library.path. Yes, this
 493     // could cause a change in behavior, but Apple&#39;s Java6 behavior
 494     // can be achieved by putting &quot;.&quot; at the beginning of the
 495     // JAVA_LIBRARY_PATH environment variable.
 496     char *ld_library_path = NEW_C_HEAP_ARRAY(char,
 497                                              strlen(v) + 1 + strlen(l) + 1 +
 498                                              system_ext_size + 3,
 499                                              mtInternal);
 500     sprintf(ld_library_path, &quot;%s%s%s%s%s&quot; SYS_EXTENSIONS_DIR &quot;:&quot; SYS_EXTENSIONS_DIRS &quot;:.&quot;,
 501             v, v_colon, l, l_colon, user_home_dir);
 502     Arguments::set_library_path(ld_library_path);
 503     FREE_C_HEAP_ARRAY(char, ld_library_path);
 504   }
 505 
 506   // Extensions directories.
 507   //
 508   // Note that the space for the colon and the trailing null are provided
 509   // by the nulls included by the sizeof operator (so actually one byte more
 510   // than necessary is allocated).
 511   sprintf(buf, &quot;%s&quot; SYS_EXTENSIONS_DIR &quot;:%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXTENSIONS_DIRS,
 512           user_home_dir, Arguments::get_java_home());
 513   Arguments::set_ext_dirs(buf);
 514 
 515   FREE_C_HEAP_ARRAY(char, buf);
 516 
 517 #undef SYS_EXTENSIONS_DIR
 518 #undef SYS_EXTENSIONS_DIRS
 519 
 520 #endif // __APPLE__
 521 
 522 #undef SYS_EXT_DIR
 523 #undef EXTENSIONS_DIR
 524 }
 525 
 526 ////////////////////////////////////////////////////////////////////////////////
 527 // breakpoint support
 528 
 529 void os::breakpoint() {
 530   BREAKPOINT;
 531 }
 532 
 533 extern &quot;C&quot; void breakpoint() {
 534   // use debugger to set breakpoint here
 535 }
 536 
 537 ////////////////////////////////////////////////////////////////////////////////
 538 // signal support
 539 
 540 debug_only(static bool signal_sets_initialized = false);
 541 static sigset_t unblocked_sigs, vm_sigs;
 542 
 543 void os::Bsd::signal_sets_init() {
 544   // Should also have an assertion stating we are still single-threaded.
 545   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 546   // Fill in signals that are necessarily unblocked for all threads in
 547   // the VM. Currently, we unblock the following signals:
 548   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 549   //                         by -Xrs (=ReduceSignalUsage));
 550   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 551   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 552   // the dispositions or masks wrt these signals.
 553   // Programs embedding the VM that want to use the above signals for their
 554   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 555   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 556   // (See bug 4345157, and other related bugs).
 557   // In reality, though, unblocking these signals is really a nop, since
 558   // these signals are not blocked by default.
 559   sigemptyset(&amp;unblocked_sigs);
 560   sigaddset(&amp;unblocked_sigs, SIGILL);
 561   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 562   sigaddset(&amp;unblocked_sigs, SIGBUS);
 563   sigaddset(&amp;unblocked_sigs, SIGFPE);
 564   sigaddset(&amp;unblocked_sigs, SR_signum);
 565 
 566   if (!ReduceSignalUsage) {
 567     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 568       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 569 
 570     }
 571     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 572       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 573     }
 574     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 575       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 576     }
 577   }
 578   // Fill in signals that are blocked by all but the VM thread.
 579   sigemptyset(&amp;vm_sigs);
 580   if (!ReduceSignalUsage) {
 581     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 582   }
 583   debug_only(signal_sets_initialized = true);
 584 
 585 }
 586 
 587 // These are signals that are unblocked while a thread is running Java.
 588 // (For some reason, they get blocked by default.)
 589 sigset_t* os::Bsd::unblocked_signals() {
 590   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 591   return &amp;unblocked_sigs;
 592 }
 593 
 594 // These are the signals that are blocked while a (non-VM) thread is
 595 // running Java. Only the VM thread handles these signals.
 596 sigset_t* os::Bsd::vm_signals() {
 597   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 598   return &amp;vm_sigs;
 599 }
 600 
 601 void os::Bsd::hotspot_sigmask(Thread* thread) {
 602 
 603   //Save caller&#39;s signal mask before setting VM signal mask
 604   sigset_t caller_sigmask;
 605   pthread_sigmask(SIG_BLOCK, NULL, &amp;caller_sigmask);
 606 
 607   OSThread* osthread = thread-&gt;osthread();
 608   osthread-&gt;set_caller_sigmask(caller_sigmask);
 609 
 610   pthread_sigmask(SIG_UNBLOCK, os::Bsd::unblocked_signals(), NULL);
 611 
 612   if (!ReduceSignalUsage) {
 613     if (thread-&gt;is_VM_thread()) {
 614       // Only the VM thread handles BREAK_SIGNAL ...
 615       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 616     } else {
 617       // ... all other threads block BREAK_SIGNAL
 618       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 619     }
 620   }
 621 }
 622 
 623 
 624 //////////////////////////////////////////////////////////////////////////////
 625 // create new thread
 626 
 627 #ifdef __APPLE__
 628 // library handle for calling objc_registerThreadWithCollector()
 629 // without static linking to the libobjc library
 630   #define OBJC_LIB &quot;/usr/lib/libobjc.dylib&quot;
 631   #define OBJC_GCREGISTER &quot;objc_registerThreadWithCollector&quot;
 632 typedef void (*objc_registerThreadWithCollector_t)();
 633 extern &quot;C&quot; objc_registerThreadWithCollector_t objc_registerThreadWithCollectorFunction;
 634 objc_registerThreadWithCollector_t objc_registerThreadWithCollectorFunction = NULL;
 635 #endif
 636 
 637 // Thread start routine for all newly created threads
 638 static void *thread_native_entry(Thread *thread) {
 639 
 640   thread-&gt;record_stack_base_and_size();
 641 
 642   // Try to randomize the cache line index of hot stack frames.
 643   // This helps when threads of the same stack traces evict each other&#39;s
 644   // cache lines. The threads can be either from the same JVM instance, or
 645   // from different JVM instances. The benefit is especially true for
 646   // processors with hyperthreading technology.
 647   static int counter = 0;
 648   int pid = os::current_process_id();
 649   alloca(((pid ^ counter++) &amp; 7) * 128);
 650 
 651   thread-&gt;initialize_thread_current();
 652 
 653   OSThread* osthread = thread-&gt;osthread();
 654   Monitor* sync = osthread-&gt;startThread_lock();
 655 
 656   osthread-&gt;set_thread_id(os::Bsd::gettid());
 657 
 658   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 659     os::current_thread_id(), (uintx) pthread_self());
 660 
 661 #ifdef __APPLE__
 662   // Store unique OS X thread id used by SA
 663   osthread-&gt;set_unique_thread_id();
 664 #endif
 665 
 666   // initialize signal mask for this thread
 667   os::Bsd::hotspot_sigmask(thread);
 668 
 669   // initialize floating point control register
 670   os::Bsd::init_thread_fpu_state();
 671 
 672 #ifdef __APPLE__
 673   // register thread with objc gc
 674   if (objc_registerThreadWithCollectorFunction != NULL) {
 675     objc_registerThreadWithCollectorFunction();
 676   }
 677 #endif
 678 
 679   // handshaking with parent thread
 680   {
 681     MutexLocker ml(sync, Mutex::_no_safepoint_check_flag);
 682 
 683     // notify parent thread
 684     osthread-&gt;set_state(INITIALIZED);
 685     sync-&gt;notify_all();
 686 
 687     // wait until os::start_thread()
 688     while (osthread-&gt;get_state() == INITIALIZED) {
 689       sync-&gt;wait_without_safepoint_check();
 690     }
 691   }
 692 
 693   // call one more level start routine
 694   thread-&gt;call_run();
 695 
 696   // Note: at this point the thread object may already have deleted itself.
 697   // Prevent dereferencing it from here on out.
 698   thread = NULL;
 699 
 700   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 701     os::current_thread_id(), (uintx) pthread_self());
 702 
 703   return 0;
 704 }
 705 
 706 bool os::create_thread(Thread* thread, ThreadType thr_type,
 707                        size_t req_stack_size) {
 708   assert(thread-&gt;osthread() == NULL, &quot;caller responsible&quot;);
 709 
 710   // Allocate the OSThread object
 711   OSThread* osthread = new OSThread(NULL, NULL);
 712   if (osthread == NULL) {
 713     return false;
 714   }
 715 
 716   // set the correct thread state
 717   osthread-&gt;set_thread_type(thr_type);
 718 
 719   // Initial state is ALLOCATED but not INITIALIZED
 720   osthread-&gt;set_state(ALLOCATED);
 721 
 722   thread-&gt;set_osthread(osthread);
 723 
 724   // init thread attributes
 725   pthread_attr_t attr;
 726   pthread_attr_init(&amp;attr);
 727   pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
 728 
 729   // calculate stack size if it&#39;s not specified by caller
 730   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 731   int status = pthread_attr_setstacksize(&amp;attr, stack_size);
 732   assert_status(status == 0, status, &quot;pthread_attr_setstacksize&quot;);
 733 
 734   ThreadState state;
 735 
 736   {
 737     pthread_t tid;
 738     int ret = pthread_create(&amp;tid, &amp;attr, (void* (*)(void*)) thread_native_entry, thread);
 739 
 740     char buf[64];
 741     if (ret == 0) {
 742       log_info(os, thread)(&quot;Thread started (pthread id: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 743         (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 744     } else {
 745       log_warning(os, thread)(&quot;Failed to start thread - pthread_create failed (%s) for attributes: %s.&quot;,
 746         os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 747       // Log some OS information which might explain why creating the thread failed.
 748       log_info(os, thread)(&quot;Number of threads approx. running in the VM: %d&quot;, Threads::number_of_threads());
 749       LogStream st(Log(os, thread)::info());
 750       os::Posix::print_rlimit_info(&amp;st);
 751       os::print_memory_info(&amp;st);
 752     }
 753 
 754     pthread_attr_destroy(&amp;attr);
 755 
 756     if (ret != 0) {
 757       // Need to clean up stuff we&#39;ve allocated so far
 758       thread-&gt;set_osthread(NULL);
 759       delete osthread;
 760       return false;
 761     }
 762 
 763     // Store pthread info into the OSThread
 764     osthread-&gt;set_pthread_id(tid);
 765 
 766     // Wait until child thread is either initialized or aborted
 767     {
 768       Monitor* sync_with_child = osthread-&gt;startThread_lock();
 769       MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
 770       while ((state = osthread-&gt;get_state()) == ALLOCATED) {
 771         sync_with_child-&gt;wait_without_safepoint_check();
 772       }
 773     }
 774 
 775   }
 776 
 777   // Aborted due to thread limit being reached
 778   if (state == ZOMBIE) {
 779     thread-&gt;set_osthread(NULL);
 780     delete osthread;
 781     return false;
 782   }
 783 
 784   // The thread is returned suspended (in state INITIALIZED),
 785   // and is started higher up in the call chain
 786   assert(state == INITIALIZED, &quot;race condition&quot;);
 787   return true;
 788 }
 789 
 790 /////////////////////////////////////////////////////////////////////////////
 791 // attach existing thread
 792 
 793 // bootstrap the main thread
 794 bool os::create_main_thread(JavaThread* thread) {
 795   assert(os::Bsd::_main_thread == pthread_self(), &quot;should be called inside main thread&quot;);
 796   return create_attached_thread(thread);
 797 }
 798 
 799 bool os::create_attached_thread(JavaThread* thread) {
 800 #ifdef ASSERT
 801   thread-&gt;verify_not_published();
 802 #endif
 803 
 804   // Allocate the OSThread object
 805   OSThread* osthread = new OSThread(NULL, NULL);
 806 
 807   if (osthread == NULL) {
 808     return false;
 809   }
 810 
 811   osthread-&gt;set_thread_id(os::Bsd::gettid());
 812 
 813 #ifdef __APPLE__
 814   // Store unique OS X thread id used by SA
 815   osthread-&gt;set_unique_thread_id();
 816 #endif
 817 
 818   // Store pthread info into the OSThread
 819   osthread-&gt;set_pthread_id(::pthread_self());
 820 
 821   // initialize floating point control register
 822   os::Bsd::init_thread_fpu_state();
 823 
 824   // Initial thread state is RUNNABLE
 825   osthread-&gt;set_state(RUNNABLE);
 826 
 827   thread-&gt;set_osthread(osthread);
 828 
 829   // initialize signal mask for this thread
 830   // and save the caller&#39;s signal mask
 831   os::Bsd::hotspot_sigmask(thread);
 832 
 833   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 834     os::current_thread_id(), (uintx) pthread_self());
 835 
 836   return true;
 837 }
 838 
 839 void os::pd_start_thread(Thread* thread) {
 840   OSThread * osthread = thread-&gt;osthread();
 841   assert(osthread-&gt;get_state() != INITIALIZED, &quot;just checking&quot;);
 842   Monitor* sync_with_child = osthread-&gt;startThread_lock();
 843   MutexLocker ml(sync_with_child, Mutex::_no_safepoint_check_flag);
 844   sync_with_child-&gt;notify();
 845 }
 846 
 847 // Free Bsd resources related to the OSThread
 848 void os::free_thread(OSThread* osthread) {
 849   assert(osthread != NULL, &quot;osthread not set&quot;);
 850 
 851   // We are told to free resources of the argument thread,
 852   // but we can only really operate on the current thread.
 853   assert(Thread::current()-&gt;osthread() == osthread,
 854          &quot;os::free_thread but not current thread&quot;);
 855 
 856   // Restore caller&#39;s signal mask
 857   sigset_t sigmask = osthread-&gt;caller_sigmask();
 858   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
 859 
 860   delete osthread;
 861 }
 862 
 863 ////////////////////////////////////////////////////////////////////////////////
 864 // time support
 865 
 866 // Time since start-up in seconds to a fine granularity.
 867 // Used by VMSelfDestructTimer and the MemProfiler.
 868 double os::elapsedTime() {
 869 
 870   return ((double)os::elapsed_counter()) / os::elapsed_frequency();
 871 }
 872 
 873 jlong os::elapsed_counter() {
 874   return javaTimeNanos() - initial_time_count;
 875 }
 876 
 877 jlong os::elapsed_frequency() {
 878   return NANOSECS_PER_SEC; // nanosecond resolution
 879 }
 880 
 881 bool os::supports_vtime() { return true; }
 882 
 883 double os::elapsedVTime() {
 884   // better than nothing, but not much
 885   return elapsedTime();
 886 }
 887 
 888 jlong os::javaTimeMillis() {
 889   timeval time;
 890   int status = gettimeofday(&amp;time, NULL);
 891   assert(status != -1, &quot;bsd error&quot;);
 892   return jlong(time.tv_sec) * 1000  +  jlong(time.tv_usec / 1000);
 893 }
 894 
 895 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
 896   timeval time;
 897   int status = gettimeofday(&amp;time, NULL);
 898   assert(status != -1, &quot;bsd error&quot;);
 899   seconds = jlong(time.tv_sec);
 900   nanos = jlong(time.tv_usec) * 1000;
 901 }
 902 
 903 #ifndef __APPLE__
 904   #ifndef CLOCK_MONOTONIC
 905     #define CLOCK_MONOTONIC (1)
 906   #endif
 907 #endif
 908 
 909 #ifdef __APPLE__
 910 void os::Bsd::clock_init() {
 911   mach_timebase_info(&amp;_timebase_info);
 912 }
 913 #else
 914 void os::Bsd::clock_init() {
 915   struct timespec res;
 916   struct timespec tp;
 917   if (::clock_getres(CLOCK_MONOTONIC, &amp;res) == 0 &amp;&amp;
 918       ::clock_gettime(CLOCK_MONOTONIC, &amp;tp)  == 0) {
 919     // yes, monotonic clock is supported
 920     _clock_gettime = ::clock_gettime;
 921   }
 922 }
 923 #endif
 924 
 925 
 926 
 927 #ifdef __APPLE__
 928 
 929 jlong os::javaTimeNanos() {
 930   const uint64_t tm = mach_absolute_time();
 931   const uint64_t now = (tm * Bsd::_timebase_info.numer) / Bsd::_timebase_info.denom;
 932   const uint64_t prev = Bsd::_max_abstime;
 933   if (now &lt;= prev) {
 934     return prev;   // same or retrograde time;
 935   }
 936   const uint64_t obsv = Atomic::cmpxchg(&amp;Bsd::_max_abstime, prev, now);
 937   assert(obsv &gt;= prev, &quot;invariant&quot;);   // Monotonicity
 938   // If the CAS succeeded then we&#39;re done and return &quot;now&quot;.
 939   // If the CAS failed and the observed value &quot;obsv&quot; is &gt;= now then
 940   // we should return &quot;obsv&quot;.  If the CAS failed and now &gt; obsv &gt; prv then
 941   // some other thread raced this thread and installed a new value, in which case
 942   // we could either (a) retry the entire operation, (b) retry trying to install now
 943   // or (c) just return obsv.  We use (c).   No loop is required although in some cases
 944   // we might discard a higher &quot;now&quot; value in deference to a slightly lower but freshly
 945   // installed obsv value.   That&#39;s entirely benign -- it admits no new orderings compared
 946   // to (a) or (b) -- and greatly reduces coherence traffic.
 947   // We might also condition (c) on the magnitude of the delta between obsv and now.
 948   // Avoiding excessive CAS operations to hot RW locations is critical.
 949   // See https://blogs.oracle.com/dave/entry/cas_and_cache_trivia_invalidate
 950   return (prev == obsv) ? now : obsv;
 951 }
 952 
 953 #else // __APPLE__
 954 
 955 jlong os::javaTimeNanos() {
 956   if (os::supports_monotonic_clock()) {
 957     struct timespec tp;
 958     int status = Bsd::_clock_gettime(CLOCK_MONOTONIC, &amp;tp);
 959     assert(status == 0, &quot;gettime error&quot;);
 960     jlong result = jlong(tp.tv_sec) * (1000 * 1000 * 1000) + jlong(tp.tv_nsec);
 961     return result;
 962   } else {
 963     timeval time;
 964     int status = gettimeofday(&amp;time, NULL);
 965     assert(status != -1, &quot;bsd error&quot;);
 966     jlong usecs = jlong(time.tv_sec) * (1000 * 1000) + jlong(time.tv_usec);
 967     return 1000 * usecs;
 968   }
 969 }
 970 
 971 #endif // __APPLE__
 972 
 973 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
 974   if (os::supports_monotonic_clock()) {
 975     info_ptr-&gt;max_value = ALL_64_BITS;
 976 
 977     // CLOCK_MONOTONIC - amount of time since some arbitrary point in the past
 978     info_ptr-&gt;may_skip_backward = false;      // not subject to resetting or drifting
 979     info_ptr-&gt;may_skip_forward = false;       // not subject to resetting or drifting
 980   } else {
 981     // gettimeofday - based on time in seconds since the Epoch thus does not wrap
 982     info_ptr-&gt;max_value = ALL_64_BITS;
 983 
 984     // gettimeofday is a real time clock so it skips
 985     info_ptr-&gt;may_skip_backward = true;
 986     info_ptr-&gt;may_skip_forward = true;
 987   }
 988 
 989   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;                // elapsed not CPU time
 990 }
 991 
 992 // Return the real, user, and system times in seconds from an
 993 // arbitrary fixed point in the past.
 994 bool os::getTimesSecs(double* process_real_time,
 995                       double* process_user_time,
 996                       double* process_system_time) {
 997   struct tms ticks;
 998   clock_t real_ticks = times(&amp;ticks);
 999 
1000   if (real_ticks == (clock_t) (-1)) {
1001     return false;
1002   } else {
1003     double ticks_per_second = (double) clock_tics_per_sec;
1004     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1005     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1006     *process_real_time = ((double) real_ticks) / ticks_per_second;
1007 
1008     return true;
1009   }
1010 }
1011 
1012 
1013 char * os::local_time_string(char *buf, size_t buflen) {
1014   struct tm t;
1015   time_t long_time;
1016   time(&amp;long_time);
1017   localtime_r(&amp;long_time, &amp;t);
1018   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1019                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1020                t.tm_hour, t.tm_min, t.tm_sec);
1021   return buf;
1022 }
1023 
1024 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
1025   return localtime_r(clock, res);
1026 }
1027 
1028 ////////////////////////////////////////////////////////////////////////////////
1029 // runtime exit support
1030 
1031 // Note: os::shutdown() might be called very early during initialization, or
1032 // called from signal handler. Before adding something to os::shutdown(), make
1033 // sure it is async-safe and can handle partially initialized VM.
1034 void os::shutdown() {
1035 
1036   // allow PerfMemory to attempt cleanup of any persistent resources
1037   perfMemory_exit();
1038 
1039   // needs to remove object in file system
1040   AttachListener::abort();
1041 
1042   // flush buffered output, finish log files
1043   ostream_abort();
1044 
1045   // Check for abort hook
1046   abort_hook_t abort_hook = Arguments::abort_hook();
1047   if (abort_hook != NULL) {
1048     abort_hook();
1049   }
1050 
1051 }
1052 
1053 // Note: os::abort() might be called very early during initialization, or
1054 // called from signal handler. Before adding something to os::abort(), make
1055 // sure it is async-safe and can handle partially initialized VM.
1056 void os::abort(bool dump_core, void* siginfo, const void* context) {
1057   os::shutdown();
1058   if (dump_core) {
1059 #ifndef PRODUCT
1060     fdStream out(defaultStream::output_fd());
1061     out.print_raw(&quot;Current thread is &quot;);
1062     char buf[16];
1063     jio_snprintf(buf, sizeof(buf), UINTX_FORMAT, os::current_thread_id());
1064     out.print_raw_cr(buf);
1065     out.print_raw_cr(&quot;Dumping core ...&quot;);
1066 #endif
1067     ::abort(); // dump core
1068   }
1069 
1070   ::exit(1);
1071 }
1072 
1073 // Die immediately, no exit hook, no abort hook, no cleanup.
1074 // Dump a core file, if possible, for debugging.
1075 void os::die() {
1076   if (TestUnresponsiveErrorHandler &amp;&amp; !CreateCoredumpOnCrash) {
1077     // For TimeoutInErrorHandlingTest.java, we just kill the VM
1078     // and don&#39;t take the time to generate a core file.
1079     os::signal_raise(SIGKILL);
1080   } else {
1081     // _exit() on BsdThreads only kills current thread
1082     ::abort();
1083   }
1084 }
1085 
1086 // Information of current thread in variety of formats
1087 pid_t os::Bsd::gettid() {
1088   int retval = -1;
1089 
1090 #ifdef __APPLE__ // XNU kernel
1091   mach_port_t port = mach_thread_self();
1092   guarantee(MACH_PORT_VALID(port), &quot;just checking&quot;);
1093   mach_port_deallocate(mach_task_self(), port);
1094   return (pid_t)port;
1095 
1096 #else
1097   #ifdef __FreeBSD__
1098   retval = syscall(SYS_thr_self);
1099   #else
1100     #ifdef __OpenBSD__
1101   retval = syscall(SYS_getthrid);
1102     #else
1103       #ifdef __NetBSD__
1104   retval = (pid_t) syscall(SYS__lwp_self);
1105       #endif
1106     #endif
1107   #endif
1108 #endif
1109 
1110   if (retval == -1) {
1111     return getpid();
1112   }
1113 }
1114 
1115 intx os::current_thread_id() {
1116 #ifdef __APPLE__
1117   return (intx)os::Bsd::gettid();
1118 #else
1119   return (intx)::pthread_self();
1120 #endif
1121 }
1122 
1123 int os::current_process_id() {
1124   return (int)(getpid());
1125 }
1126 
1127 // DLL functions
1128 
1129 const char* os::dll_file_extension() { return JNI_LIB_SUFFIX; }
1130 
1131 // This must be hard coded because it&#39;s the system&#39;s temporary
1132 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1133 #ifdef __APPLE__
1134 // macosx has a secure per-user temporary directory
1135 char temp_path_storage[PATH_MAX];
1136 const char* os::get_temp_directory() {
1137   static char *temp_path = NULL;
1138   if (temp_path == NULL) {
1139     int pathSize = confstr(_CS_DARWIN_USER_TEMP_DIR, temp_path_storage, PATH_MAX);
1140     if (pathSize == 0 || pathSize &gt; PATH_MAX) {
1141       strlcpy(temp_path_storage, &quot;/tmp/&quot;, sizeof(temp_path_storage));
1142     }
1143     temp_path = temp_path_storage;
1144   }
1145   return temp_path;
1146 }
1147 #else // __APPLE__
1148 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1149 #endif // __APPLE__
1150 
1151 // check if addr is inside libjvm.so
1152 bool os::address_is_in_vm(address addr) {
1153   static address libjvm_base_addr;
1154   Dl_info dlinfo;
1155 
1156   if (libjvm_base_addr == NULL) {
1157     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1158       libjvm_base_addr = (address)dlinfo.dli_fbase;
1159     }
1160     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1161   }
1162 
1163   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1164     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1165   }
1166 
1167   return false;
1168 }
1169 
1170 
1171 #define MACH_MAXSYMLEN 256
1172 
1173 bool os::dll_address_to_function_name(address addr, char *buf,
1174                                       int buflen, int *offset,
1175                                       bool demangle) {
1176   // buf is not optional, but offset is optional
1177   assert(buf != NULL, &quot;sanity check&quot;);
1178 
1179   Dl_info dlinfo;
1180   char localbuf[MACH_MAXSYMLEN];
1181 
1182   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1183     // see if we have a matching symbol
1184     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1185       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1186         jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1187       }
1188       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1189       return true;
1190     }
1191     // no matching symbol so try for just file info
1192     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1193       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1194                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1195         return true;
1196       }
1197     }
1198 
1199     // Handle non-dynamic manually:
1200     if (dlinfo.dli_fbase != NULL &amp;&amp;
1201         Decoder::decode(addr, localbuf, MACH_MAXSYMLEN, offset,
1202                         dlinfo.dli_fbase)) {
1203       if (!(demangle &amp;&amp; Decoder::demangle(localbuf, buf, buflen))) {
1204         jio_snprintf(buf, buflen, &quot;%s&quot;, localbuf);
1205       }
1206       return true;
1207     }
1208   }
1209   buf[0] = &#39;\0&#39;;
1210   if (offset != NULL) *offset = -1;
1211   return false;
1212 }
1213 
1214 // ported from solaris version
1215 bool os::dll_address_to_library_name(address addr, char* buf,
1216                                      int buflen, int* offset) {
1217   // buf is not optional, but offset is optional
1218   assert(buf != NULL, &quot;sanity check&quot;);
1219 
1220   Dl_info dlinfo;
1221 
1222   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1223     if (dlinfo.dli_fname != NULL) {
1224       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1225     }
1226     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1227       *offset = addr - (address)dlinfo.dli_fbase;
1228     }
1229     return true;
1230   }
1231 
1232   buf[0] = &#39;\0&#39;;
1233   if (offset) *offset = -1;
1234   return false;
1235 }
1236 
1237 // Loads .dll/.so and
1238 // in case of error it checks if .dll/.so was built for the
1239 // same architecture as Hotspot is running on
1240 
1241 #ifdef __APPLE__
1242 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1243 #ifdef STATIC_BUILD
1244   return os::get_default_process_handle();
1245 #else
1246   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1247 
1248   void * result= ::dlopen(filename, RTLD_LAZY);
1249   if (result != NULL) {
1250     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
1251     // Successful loading
1252     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
1253     return result;
1254   }
1255 
1256   const char* error_report = ::dlerror();
1257   if (error_report == NULL) {
1258     error_report = &quot;dlerror returned no error description&quot;;
1259   }
1260   if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
1261     // Read system error message into ebuf
1262     ::strncpy(ebuf, error_report, ebuflen-1);
1263     ebuf[ebuflen-1]=&#39;\0&#39;;
1264   }
1265   Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
1266   log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
1267 
1268   return NULL;
1269 #endif // STATIC_BUILD
1270 }
1271 #else
1272 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1273 #ifdef STATIC_BUILD
1274   return os::get_default_process_handle();
1275 #else
1276   log_info(os)(&quot;attempting shared library load of %s&quot;, filename);
1277   void * result= ::dlopen(filename, RTLD_LAZY);
1278   if (result != NULL) {
1279     Events::log(NULL, &quot;Loaded shared library %s&quot;, filename);
1280     // Successful loading
1281     log_info(os)(&quot;shared library load of %s was successful&quot;, filename);
1282     return result;
1283   }
1284 
1285   Elf32_Ehdr elf_head;
1286 
1287   const char* const error_report = ::dlerror();
1288   if (error_report == NULL) {
1289     error_report = &quot;dlerror returned no error description&quot;;
1290   }
1291   if (ebuf != NULL &amp;&amp; ebuflen &gt; 0) {
1292     // Read system error message into ebuf
1293     ::strncpy(ebuf, error_report, ebuflen-1);
1294     ebuf[ebuflen-1]=&#39;\0&#39;;
1295   }
1296   Events::log(NULL, &quot;Loading shared library %s failed, %s&quot;, filename, error_report);
1297   log_info(os)(&quot;shared library load of %s failed, %s&quot;, filename, error_report);
1298 
1299   int diag_msg_max_length=ebuflen-strlen(ebuf);
1300   char* diag_msg_buf=ebuf+strlen(ebuf);
1301 
1302   if (diag_msg_max_length==0) {
1303     // No more space in ebuf for additional diagnostics message
1304     return NULL;
1305   }
1306 
1307 
1308   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1309 
1310   if (file_descriptor &lt; 0) {
1311     // Can&#39;t open library, report dlerror() message
1312     return NULL;
1313   }
1314 
1315   bool failed_to_read_elf_head=
1316     (sizeof(elf_head)!=
1317      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1318 
1319   ::close(file_descriptor);
1320   if (failed_to_read_elf_head) {
1321     // file i/o error - report dlerror() msg
1322     return NULL;
1323   }
1324 
1325   typedef struct {
1326     Elf32_Half  code;         // Actual value as defined in elf.h
1327     Elf32_Half  compat_class; // Compatibility of archs at VM&#39;s sense
1328     char        elf_class;    // 32 or 64 bit
1329     char        endianess;    // MSB or LSB
1330     char*       name;         // String representation
1331   } arch_t;
1332 
1333   #ifndef EM_486
1334     #define EM_486          6               /* Intel 80486 */
1335   #endif
1336 
1337   #ifndef EM_MIPS_RS3_LE
1338     #define EM_MIPS_RS3_LE  10              /* MIPS */
1339   #endif
1340 
1341   #ifndef EM_PPC64
1342     #define EM_PPC64        21              /* PowerPC64 */
1343   #endif
1344 
1345   #ifndef EM_S390
1346     #define EM_S390         22              /* IBM System/390 */
1347   #endif
1348 
1349   #ifndef EM_IA_64
1350     #define EM_IA_64        50              /* HP/Intel IA-64 */
1351   #endif
1352 
1353   #ifndef EM_X86_64
1354     #define EM_X86_64       62              /* AMD x86-64 */
1355   #endif
1356 
1357   static const arch_t arch_array[]={
1358     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1359     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1360     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1361     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1362     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1363     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1364     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1365     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1366     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1367     {EM_ARM,         EM_ARM,     ELFCLASS32,   ELFDATA2LSB, (char*)&quot;ARM&quot;},
1368     {EM_S390,        EM_S390,    ELFCLASSNONE, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},
1369     {EM_ALPHA,       EM_ALPHA,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Alpha&quot;},
1370     {EM_MIPS_RS3_LE, EM_MIPS_RS3_LE, ELFCLASS32, ELFDATA2LSB, (char*)&quot;MIPSel&quot;},
1371     {EM_MIPS,        EM_MIPS,    ELFCLASS32, ELFDATA2MSB, (char*)&quot;MIPS&quot;},
1372     {EM_PARISC,      EM_PARISC,  ELFCLASS32, ELFDATA2MSB, (char*)&quot;PARISC&quot;},
1373     {EM_68K,         EM_68K,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;M68k&quot;}
1374   };
1375 
1376   #if  (defined IA32)
1377   static  Elf32_Half running_arch_code=EM_386;
1378   #elif   (defined AMD64)
1379   static  Elf32_Half running_arch_code=EM_X86_64;
1380   #elif  (defined IA64)
1381   static  Elf32_Half running_arch_code=EM_IA_64;
1382   #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1383   static  Elf32_Half running_arch_code=EM_SPARCV9;
1384   #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1385   static  Elf32_Half running_arch_code=EM_SPARC;
1386   #elif  (defined __powerpc64__)
1387   static  Elf32_Half running_arch_code=EM_PPC64;
1388   #elif  (defined __powerpc__)
1389   static  Elf32_Half running_arch_code=EM_PPC;
1390   #elif  (defined ARM)
1391   static  Elf32_Half running_arch_code=EM_ARM;
1392   #elif  (defined S390)
1393   static  Elf32_Half running_arch_code=EM_S390;
1394   #elif  (defined ALPHA)
1395   static  Elf32_Half running_arch_code=EM_ALPHA;
1396   #elif  (defined MIPSEL)
1397   static  Elf32_Half running_arch_code=EM_MIPS_RS3_LE;
1398   #elif  (defined PARISC)
1399   static  Elf32_Half running_arch_code=EM_PARISC;
1400   #elif  (defined MIPS)
1401   static  Elf32_Half running_arch_code=EM_MIPS;
1402   #elif  (defined M68K)
1403   static  Elf32_Half running_arch_code=EM_68K;
1404   #else
1405     #error Method os::dll_load requires that one of following is defined:\
1406          IA32, AMD64, IA64, __sparc, __powerpc__, ARM, S390, ALPHA, MIPS, MIPSEL, PARISC, M68K
1407   #endif
1408 
1409   // Identify compatability class for VM&#39;s architecture and library&#39;s architecture
1410   // Obtain string descriptions for architectures
1411 
1412   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1413   int running_arch_index=-1;
1414 
1415   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1416     if (running_arch_code == arch_array[i].code) {
1417       running_arch_index    = i;
1418     }
1419     if (lib_arch.code == arch_array[i].code) {
1420       lib_arch.compat_class = arch_array[i].compat_class;
1421       lib_arch.name         = arch_array[i].name;
1422     }
1423   }
1424 
1425   assert(running_arch_index != -1,
1426          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1427   if (running_arch_index == -1) {
1428     // Even though running architecture detection failed
1429     // we may still continue with reporting dlerror() message
1430     return NULL;
1431   }
1432 
1433   if (lib_arch.endianess != arch_array[running_arch_index].endianess) {
1434     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: endianness mismatch)&quot;);
1435     return NULL;
1436   }
1437 
1438 #ifndef S390
1439   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
1440     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: architecture word width mismatch)&quot;);
1441     return NULL;
1442   }
1443 #endif // !S390
1444 
1445   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1446     if (lib_arch.name!=NULL) {
1447       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1448                  &quot; (Possible cause: can&#39;t load %s-bit .so on a %s-bit platform)&quot;,
1449                  lib_arch.name, arch_array[running_arch_index].name);
1450     } else {
1451       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1452                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s-bit platform)&quot;,
1453                  lib_arch.code,
1454                  arch_array[running_arch_index].name);
1455     }
1456   }
1457 
1458   return NULL;
1459 #endif // STATIC_BUILD
1460 }
1461 #endif // !__APPLE__
1462 
1463 void* os::get_default_process_handle() {
1464 #ifdef __APPLE__
1465   // MacOS X needs to use RTLD_FIRST instead of RTLD_LAZY
1466   // to avoid finding unexpected symbols on second (or later)
1467   // loads of a library.
1468   return (void*)::dlopen(NULL, RTLD_FIRST);
1469 #else
1470   return (void*)::dlopen(NULL, RTLD_LAZY);
1471 #endif
1472 }
1473 
1474 // XXX: Do we need a lock around this as per Linux?
1475 void* os::dll_lookup(void* handle, const char* name) {
1476   return dlsym(handle, name);
1477 }
1478 
1479 int _print_dll_info_cb(const char * name, address base_address, address top_address, void * param) {
1480   outputStream * out = (outputStream *) param;
1481   out-&gt;print_cr(INTPTR_FORMAT &quot; \t%s&quot;, (intptr_t)base_address, name);
1482   return 0;
1483 }
1484 
1485 void os::print_dll_info(outputStream *st) {
1486   st-&gt;print_cr(&quot;Dynamic libraries:&quot;);
1487   if (get_loaded_modules_info(_print_dll_info_cb, (void *)st)) {
1488     st-&gt;print_cr(&quot;Error: Cannot print dynamic libraries.&quot;);
1489   }
1490 }
1491 
1492 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
1493 #ifdef RTLD_DI_LINKMAP
1494   Dl_info dli;
1495   void *handle;
1496   Link_map *map;
1497   Link_map *p;
1498 
1499   if (dladdr(CAST_FROM_FN_PTR(void *, os::print_dll_info), &amp;dli) == 0 ||
1500       dli.dli_fname == NULL) {
1501     return 1;
1502   }
1503   handle = dlopen(dli.dli_fname, RTLD_LAZY);
1504   if (handle == NULL) {
1505     return 1;
1506   }
1507   dlinfo(handle, RTLD_DI_LINKMAP, &amp;map);
1508   if (map == NULL) {
1509     dlclose(handle);
1510     return 1;
1511   }
1512 
1513   while (map-&gt;l_prev != NULL)
1514     map = map-&gt;l_prev;
1515 
1516   while (map != NULL) {
1517     // Value for top_address is returned as 0 since we don&#39;t have any information about module size
1518     if (callback(map-&gt;l_name, (address)map-&gt;l_addr, (address)0, param)) {
1519       dlclose(handle);
1520       return 1;
1521     }
1522     map = map-&gt;l_next;
1523   }
1524 
1525   dlclose(handle);
1526 #elif defined(__APPLE__)
1527   for (uint32_t i = 1; i &lt; _dyld_image_count(); i++) {
1528     // Value for top_address is returned as 0 since we don&#39;t have any information about module size
1529     if (callback(_dyld_get_image_name(i), (address)_dyld_get_image_header(i), (address)0, param)) {
1530       return 1;
1531     }
1532   }
1533   return 0;
1534 #else
1535   return 1;
1536 #endif
1537 }
1538 
1539 void os::get_summary_os_info(char* buf, size_t buflen) {
1540   // These buffers are small because we want this to be brief
1541   // and not use a lot of stack while generating the hs_err file.
1542   char os[100];
1543   size_t size = sizeof(os);
1544   int mib_kern[] = { CTL_KERN, KERN_OSTYPE };
1545   if (sysctl(mib_kern, 2, os, &amp;size, NULL, 0) &lt; 0) {
1546 #ifdef __APPLE__
1547       strncpy(os, &quot;Darwin&quot;, sizeof(os));
1548 #elif __OpenBSD__
1549       strncpy(os, &quot;OpenBSD&quot;, sizeof(os));
1550 #else
1551       strncpy(os, &quot;BSD&quot;, sizeof(os));
1552 #endif
1553   }
1554 
1555   char release[100];
1556   size = sizeof(release);
1557   int mib_release[] = { CTL_KERN, KERN_OSRELEASE };
1558   if (sysctl(mib_release, 2, release, &amp;size, NULL, 0) &lt; 0) {
1559       // if error, leave blank
1560       strncpy(release, &quot;&quot;, sizeof(release));
1561   }
1562   snprintf(buf, buflen, &quot;%s %s&quot;, os, release);
1563 }
1564 
1565 void os::print_os_info_brief(outputStream* st) {
1566   os::Posix::print_uname_info(st);
1567 }
1568 
1569 void os::print_os_info(outputStream* st) {
1570   st-&gt;print(&quot;OS:&quot;);
1571 
1572   os::Posix::print_uname_info(st);
1573 
1574   os::Bsd::print_uptime_info(st);
1575 
1576   os::Posix::print_rlimit_info(st);
1577 
1578   os::Posix::print_load_average(st);
1579 }
1580 
1581 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
1582   // Nothing to do for now.
1583 }
1584 
1585 void os::get_summary_cpu_info(char* buf, size_t buflen) {
1586   unsigned int mhz;
1587   size_t size = sizeof(mhz);
1588   int mib[] = { CTL_HW, HW_CPU_FREQ };
1589   if (sysctl(mib, 2, &amp;mhz, &amp;size, NULL, 0) &lt; 0) {
1590     mhz = 1;  // looks like an error but can be divided by
1591   } else {
1592     mhz /= 1000000;  // reported in millions
1593   }
1594 
1595   char model[100];
1596   size = sizeof(model);
1597   int mib_model[] = { CTL_HW, HW_MODEL };
1598   if (sysctl(mib_model, 2, model, &amp;size, NULL, 0) &lt; 0) {
1599     strncpy(model, cpu_arch, sizeof(model));
1600   }
1601 
1602   char machine[100];
1603   size = sizeof(machine);
1604   int mib_machine[] = { CTL_HW, HW_MACHINE };
1605   if (sysctl(mib_machine, 2, machine, &amp;size, NULL, 0) &lt; 0) {
1606       strncpy(machine, &quot;&quot;, sizeof(machine));
1607   }
1608 
1609   snprintf(buf, buflen, &quot;%s %s %d MHz&quot;, model, machine, mhz);
1610 }
1611 
1612 void os::print_memory_info(outputStream* st) {
1613   xsw_usage swap_usage;
1614   size_t size = sizeof(swap_usage);
1615 
1616   st-&gt;print(&quot;Memory:&quot;);
1617   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
1618 
1619   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;,
1620             os::physical_memory() &gt;&gt; 10);
1621   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
1622             os::available_memory() &gt;&gt; 10);
1623 
1624   if((sysctlbyname(&quot;vm.swapusage&quot;, &amp;swap_usage, &amp;size, NULL, 0) == 0) || (errno == ENOMEM)) {
1625     if (size &gt;= offset_of(xsw_usage, xsu_used)) {
1626       st-&gt;print(&quot;, swap &quot; UINT64_FORMAT &quot;k&quot;,
1627                 ((julong) swap_usage.xsu_total) &gt;&gt; 10);
1628       st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
1629                 ((julong) swap_usage.xsu_avail) &gt;&gt; 10);
1630     }
1631   }
1632 
1633   st-&gt;cr();
1634 }
1635 
1636 static void print_signal_handler(outputStream* st, int sig,
1637                                  char* buf, size_t buflen);
1638 
1639 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
1640   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
1641   print_signal_handler(st, SIGSEGV, buf, buflen);
1642   print_signal_handler(st, SIGBUS , buf, buflen);
1643   print_signal_handler(st, SIGFPE , buf, buflen);
1644   print_signal_handler(st, SIGPIPE, buf, buflen);
1645   print_signal_handler(st, SIGXFSZ, buf, buflen);
1646   print_signal_handler(st, SIGILL , buf, buflen);
1647   print_signal_handler(st, SR_signum, buf, buflen);
1648   print_signal_handler(st, SHUTDOWN1_SIGNAL, buf, buflen);
1649   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
1650   print_signal_handler(st, SHUTDOWN3_SIGNAL , buf, buflen);
1651   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
1652 }
1653 
1654 static char saved_jvm_path[MAXPATHLEN] = {0};
1655 
1656 // Find the full path to the current module, libjvm
1657 void os::jvm_path(char *buf, jint buflen) {
1658   // Error checking.
1659   if (buflen &lt; MAXPATHLEN) {
1660     assert(false, &quot;must use a large-enough buffer&quot;);
1661     buf[0] = &#39;\0&#39;;
1662     return;
1663   }
1664   // Lazy resolve the path to current module.
1665   if (saved_jvm_path[0] != 0) {
1666     strcpy(buf, saved_jvm_path);
1667     return;
1668   }
1669 
1670   char dli_fname[MAXPATHLEN];
1671   bool ret = dll_address_to_library_name(
1672                                          CAST_FROM_FN_PTR(address, os::jvm_path),
1673                                          dli_fname, sizeof(dli_fname), NULL);
1674   assert(ret, &quot;cannot locate libjvm&quot;);
1675   char *rp = NULL;
1676   if (ret &amp;&amp; dli_fname[0] != &#39;\0&#39;) {
1677     rp = os::Posix::realpath(dli_fname, buf, buflen);
1678   }
1679   if (rp == NULL) {
1680     return;
1681   }
1682 
1683   if (Arguments::sun_java_launcher_is_altjvm()) {
1684     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
1685     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/&lt;vmtype&gt;/libjvm.so&quot;
1686     // or &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;vmtype&gt;/libjvm.dylib&quot;. If &quot;/jre/lib/&quot;
1687     // appears at the right place in the string, then assume we are
1688     // installed in a JDK and we&#39;re done. Otherwise, check for a
1689     // JAVA_HOME environment variable and construct a path to the JVM
1690     // being overridden.
1691 
1692     const char *p = buf + strlen(buf) - 1;
1693     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
1694       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
1695         /* empty */ ;
1696     }
1697 
1698     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
1699       // Look for JAVA_HOME in the environment.
1700       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
1701       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
1702         char* jrelib_p;
1703         int len;
1704 
1705         // Check the current module name &quot;libjvm&quot;
1706         p = strrchr(buf, &#39;/&#39;);
1707         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
1708 
1709         rp = os::Posix::realpath(java_home_var, buf, buflen);
1710         if (rp == NULL) {
1711           return;
1712         }
1713 
1714         // determine if this is a legacy image or modules image
1715         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
1716         len = strlen(buf);
1717         assert(len &lt; buflen, &quot;Ran out of buffer space&quot;);
1718         jrelib_p = buf + len;
1719 
1720         // Add the appropriate library subdir
1721         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
1722         if (0 != access(buf, F_OK)) {
1723           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
1724         }
1725 
1726         // Add the appropriate client or server subdir
1727         len = strlen(buf);
1728         jrelib_p = buf + len;
1729         snprintf(jrelib_p, buflen-len, &quot;/%s&quot;, COMPILER_VARIANT);
1730         if (0 != access(buf, F_OK)) {
1731           snprintf(jrelib_p, buflen-len, &quot;%s&quot;, &quot;&quot;);
1732         }
1733 
1734         // If the path exists within JAVA_HOME, add the JVM library name
1735         // to complete the path to JVM being overridden.  Otherwise fallback
1736         // to the path to the current library.
1737         if (0 == access(buf, F_OK)) {
1738           // Use current module name &quot;libjvm&quot;
1739           len = strlen(buf);
1740           snprintf(buf + len, buflen-len, &quot;/libjvm%s&quot;, JNI_LIB_SUFFIX);
1741         } else {
1742           // Fall back to path of current library
1743           rp = os::Posix::realpath(dli_fname, buf, buflen);
1744           if (rp == NULL) {
1745             return;
1746           }
1747         }
1748       }
1749     }
1750   }
1751 
1752   strncpy(saved_jvm_path, buf, MAXPATHLEN);
1753   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
1754 }
1755 
1756 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
1757   // no prefix required, not even &quot;_&quot;
1758 }
1759 
1760 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
1761   // no suffix required
1762 }
1763 
1764 ////////////////////////////////////////////////////////////////////////////////
1765 // sun.misc.Signal support
1766 
1767 static void UserHandler(int sig, void *siginfo, void *context) {
1768   // Ctrl-C is pressed during error reporting, likely because the error
1769   // handler fails to abort. Let VM die immediately.
1770   if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
1771     os::die();
1772   }
1773 
1774   os::signal_notify(sig);
1775 }
1776 
1777 void* os::user_handler() {
1778   return CAST_FROM_FN_PTR(void*, UserHandler);
1779 }
1780 
1781 extern &quot;C&quot; {
1782   typedef void (*sa_handler_t)(int);
1783   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
1784 }
1785 
1786 void* os::signal(int signal_number, void* handler) {
1787   struct sigaction sigAct, oldSigAct;
1788 
1789   sigfillset(&amp;(sigAct.sa_mask));
1790   sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;
1791   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
1792 
1793   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
1794     // -1 means registration failed
1795     return (void *)-1;
1796   }
1797 
1798   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
1799 }
1800 
1801 void os::signal_raise(int signal_number) {
1802   ::raise(signal_number);
1803 }
1804 
1805 // The following code is moved from os.cpp for making this
1806 // code platform specific, which it is by its very nature.
1807 
1808 // Will be modified when max signal is changed to be dynamic
1809 int os::sigexitnum_pd() {
1810   return NSIG;
1811 }
1812 
1813 // a counter for each possible signal value
1814 static volatile jint pending_signals[NSIG+1] = { 0 };
1815 static Semaphore* sig_sem = NULL;
1816 
1817 static void jdk_misc_signal_init() {
1818   // Initialize signal structures
1819   ::memset((void*)pending_signals, 0, sizeof(pending_signals));
1820 
1821   // Initialize signal semaphore
1822   sig_sem = new Semaphore();
1823 }
1824 
1825 void os::signal_notify(int sig) {
1826   if (sig_sem != NULL) {
1827     Atomic::inc(&amp;pending_signals[sig]);
1828     sig_sem-&gt;signal();
1829   } else {
1830     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
1831     // initialization isn&#39;t called.
1832     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
1833   }
1834 }
1835 
1836 static int check_pending_signals() {
1837   for (;;) {
1838     for (int i = 0; i &lt; NSIG + 1; i++) {
1839       jint n = pending_signals[i];
1840       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(&amp;pending_signals[i], n, n - 1)) {
1841         return i;
1842       }
1843     }
1844     JavaThread *thread = JavaThread::current();
1845     ThreadBlockInVM tbivm(thread);
1846 
1847     bool threadIsSuspended;
1848     do {
1849       thread-&gt;set_suspend_equivalent();
1850       // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
1851       sig_sem-&gt;wait();
1852 
1853       // were we externally suspended while we were waiting?
1854       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
1855       if (threadIsSuspended) {
1856         // The semaphore has been incremented, but while we were waiting
1857         // another thread suspended us. We don&#39;t want to continue running
1858         // while suspended because that would surprise the thread that
1859         // suspended us.
1860         sig_sem-&gt;signal();
1861 
1862         thread-&gt;java_suspend_self();
1863       }
1864     } while (threadIsSuspended);
1865   }
1866 }
1867 
1868 int os::signal_wait() {
1869   return check_pending_signals();
1870 }
1871 
1872 ////////////////////////////////////////////////////////////////////////////////
1873 // Virtual Memory
1874 
1875 int os::vm_page_size() {
1876   // Seems redundant as all get out
1877   assert(os::Bsd::page_size() != -1, &quot;must call os::init&quot;);
1878   return os::Bsd::page_size();
1879 }
1880 
1881 // Solaris allocates memory by pages.
1882 int os::vm_allocation_granularity() {
1883   assert(os::Bsd::page_size() != -1, &quot;must call os::init&quot;);
1884   return os::Bsd::page_size();
1885 }
1886 
1887 // Rationale behind this function:
1888 //  current (Mon Apr 25 20:12:18 MSD 2005) oprofile drops samples without executable
1889 //  mapping for address (see lookup_dcookie() in the kernel module), thus we cannot get
1890 //  samples for JITted code. Here we create private executable mapping over the code cache
1891 //  and then we can use standard (well, almost, as mapping can change) way to provide
1892 //  info for the reporting script by storing timestamp and location of symbol
1893 void bsd_wrap_code(char* base, size_t size) {
1894   static volatile jint cnt = 0;
1895 
1896   if (!UseOprofile) {
1897     return;
1898   }
1899 
1900   char buf[PATH_MAX + 1];
1901   int num = Atomic::add(&amp;cnt, 1);
1902 
1903   snprintf(buf, PATH_MAX + 1, &quot;%s/hs-vm-%d-%d&quot;,
1904            os::get_temp_directory(), os::current_process_id(), num);
1905   unlink(buf);
1906 
1907   int fd = ::open(buf, O_CREAT | O_RDWR, S_IRWXU);
1908 
1909   if (fd != -1) {
1910     off_t rv = ::lseek(fd, size-2, SEEK_SET);
1911     if (rv != (off_t)-1) {
1912       if (::write(fd, &quot;&quot;, 1) == 1) {
1913         mmap(base, size,
1914              PROT_READ|PROT_WRITE|PROT_EXEC,
1915              MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE, fd, 0);
1916       }
1917     }
1918     ::close(fd);
1919     unlink(buf);
1920   }
1921 }
1922 
1923 static void warn_fail_commit_memory(char* addr, size_t size, bool exec,
1924                                     int err) {
1925   warning(&quot;INFO: os::commit_memory(&quot; INTPTR_FORMAT &quot;, &quot; SIZE_FORMAT
1926           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, (intptr_t)addr, size, exec,
1927            os::errno_name(err), err);
1928 }
1929 
1930 // NOTE: Bsd kernel does not really reserve the pages for us.
1931 //       All it does is to check if there are enough free pages
1932 //       left at the time of mmap(). This could be a potential
1933 //       problem.
1934 bool os::pd_commit_memory(char* addr, size_t size, bool exec) {
1935   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
1936 #ifdef __OpenBSD__
1937   // XXX: Work-around mmap/MAP_FIXED bug temporarily on OpenBSD
1938   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(addr), p2i(addr+size), prot);
1939   if (::mprotect(addr, size, prot) == 0) {
1940     return true;
1941   }
1942 #else
1943   uintptr_t res = (uintptr_t) ::mmap(addr, size, prot,
1944                                      MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0);
1945   if (res != (uintptr_t) MAP_FAILED) {
1946     return true;
1947   }
1948 #endif
1949 
1950   // Warn about any commit errors we see in non-product builds just
1951   // in case mmap() doesn&#39;t work as described on the man page.
1952   NOT_PRODUCT(warn_fail_commit_memory(addr, size, exec, errno);)
1953 
1954   return false;
1955 }
1956 
1957 bool os::pd_commit_memory(char* addr, size_t size, size_t alignment_hint,
1958                           bool exec) {
1959   // alignment_hint is ignored on this OS
1960   return pd_commit_memory(addr, size, exec);
1961 }
1962 
1963 void os::pd_commit_memory_or_exit(char* addr, size_t size, bool exec,
1964                                   const char* mesg) {
1965   assert(mesg != NULL, &quot;mesg must be specified&quot;);
1966   if (!pd_commit_memory(addr, size, exec)) {
1967     // add extra info in product mode for vm_exit_out_of_memory():
1968     PRODUCT_ONLY(warn_fail_commit_memory(addr, size, exec, errno);)
1969     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
1970   }
1971 }
1972 
1973 void os::pd_commit_memory_or_exit(char* addr, size_t size,
1974                                   size_t alignment_hint, bool exec,
1975                                   const char* mesg) {
1976   // alignment_hint is ignored on this OS
1977   pd_commit_memory_or_exit(addr, size, exec, mesg);
1978 }
1979 
1980 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
1981 }
1982 
1983 void os::pd_free_memory(char *addr, size_t bytes, size_t alignment_hint) {
1984   ::madvise(addr, bytes, MADV_DONTNEED);
1985 }
1986 
1987 void os::numa_make_global(char *addr, size_t bytes) {
1988 }
1989 
1990 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
1991 }
1992 
1993 bool os::numa_topology_changed()   { return false; }
1994 
1995 size_t os::numa_get_groups_num() {
1996   return 1;
1997 }
1998 
1999 int os::numa_get_group_id() {
2000   return 0;
2001 }
2002 
2003 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
2004   if (size &gt; 0) {
2005     ids[0] = 0;
2006     return 1;
2007   }
2008   return 0;
2009 }
2010 
2011 int os::numa_get_group_id_for_address(const void* address) {
2012   return 0;
2013 }
2014 
2015 bool os::get_page_info(char *start, page_info* info) {
2016   return false;
2017 }
2018 
2019 char *os::scan_pages(char *start, char* end, page_info* page_expected, page_info* page_found) {
2020   return end;
2021 }
2022 
2023 
2024 bool os::pd_uncommit_memory(char* addr, size_t size) {
2025 #ifdef __OpenBSD__
2026   // XXX: Work-around mmap/MAP_FIXED bug temporarily on OpenBSD
2027   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with PROT_NONE&quot;, p2i(addr), p2i(addr+size));
2028   return ::mprotect(addr, size, PROT_NONE) == 0;
2029 #else
2030   uintptr_t res = (uintptr_t) ::mmap(addr, size, PROT_NONE,
2031                                      MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE|MAP_ANONYMOUS, -1, 0);
2032   return res  != (uintptr_t) MAP_FAILED;
2033 #endif
2034 }
2035 
2036 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
2037   return os::commit_memory(addr, size, !ExecMem);
2038 }
2039 
2040 // If this is a growable mapping, remove the guard pages entirely by
2041 // munmap()ping them.  If not, just call uncommit_memory().
2042 bool os::remove_stack_guard_pages(char* addr, size_t size) {
2043   return os::uncommit_memory(addr, size);
2044 }
2045 
2046 // If &#39;fixed&#39; is true, anon_mmap() will attempt to reserve anonymous memory
2047 // at &#39;requested_addr&#39;. If there are existing memory mappings at the same
2048 // location, however, they will be overwritten. If &#39;fixed&#39; is false,
2049 // &#39;requested_addr&#39; is only treated as a hint, the return value may or
2050 // may not start from the requested address. Unlike Bsd mmap(), this
2051 // function returns NULL to indicate failure.
2052 static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed) {
2053   char * addr;
2054   int flags;
2055 
2056   flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;
2057   if (fixed) {
2058     assert((uintptr_t)requested_addr % os::Bsd::page_size() == 0, &quot;unaligned address&quot;);
2059     flags |= MAP_FIXED;
2060   }
2061 
2062   // Map reserved/uncommitted pages PROT_NONE so we fail early if we
2063   // touch an uncommitted page. Otherwise, the read/write might
2064   // succeed if we have enough swap space to back the physical page.
2065   addr = (char*)::mmap(requested_addr, bytes, PROT_NONE,
2066                        flags, -1, 0);
2067 
2068   return addr == MAP_FAILED ? NULL : addr;
2069 }
2070 
2071 static int anon_munmap(char * addr, size_t size) {
2072   return ::munmap(addr, size) == 0;
2073 }
2074 
2075 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
2076                             size_t alignment_hint) {
2077   return anon_mmap(requested_addr, bytes, (requested_addr != NULL));
2078 }
2079 
2080 bool os::pd_release_memory(char* addr, size_t size) {
2081   return anon_munmap(addr, size);
2082 }
2083 
2084 static bool bsd_mprotect(char* addr, size_t size, int prot) {
2085   // Bsd wants the mprotect address argument to be page aligned.
2086   char* bottom = (char*)align_down((intptr_t)addr, os::Bsd::page_size());
2087 
2088   // According to SUSv3, mprotect() should only be used with mappings
2089   // established by mmap(), and mmap() always maps whole pages. Unaligned
2090   // &#39;addr&#39; likely indicates problem in the VM (e.g. trying to change
2091   // protection of malloc&#39;ed or statically allocated memory). Check the
2092   // caller if you hit this assert.
2093   assert(addr == bottom, &quot;sanity check&quot;);
2094 
2095   size = align_up(pointer_delta(addr, bottom, 1) + size, os::Bsd::page_size());
2096   Events::log(NULL, &quot;Protecting memory [&quot; INTPTR_FORMAT &quot;,&quot; INTPTR_FORMAT &quot;] with protection modes %x&quot;, p2i(bottom), p2i(bottom+size), prot);
2097   return ::mprotect(bottom, size, prot) == 0;
2098 }
2099 
2100 // Set protections specified
2101 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
2102                         bool is_committed) {
2103   unsigned int p = 0;
2104   switch (prot) {
2105   case MEM_PROT_NONE: p = PROT_NONE; break;
2106   case MEM_PROT_READ: p = PROT_READ; break;
2107   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
2108   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
2109   default:
2110     ShouldNotReachHere();
2111   }
2112   // is_committed is unused.
2113   return bsd_mprotect(addr, bytes, p);
2114 }
2115 
2116 bool os::guard_memory(char* addr, size_t size) {
2117   return bsd_mprotect(addr, size, PROT_NONE);
2118 }
2119 
2120 bool os::unguard_memory(char* addr, size_t size) {
2121   return bsd_mprotect(addr, size, PROT_READ|PROT_WRITE);
2122 }
2123 
2124 bool os::Bsd::hugetlbfs_sanity_check(bool warn, size_t page_size) {
2125   return false;
2126 }
2127 
2128 // Large page support
2129 
2130 static size_t _large_page_size = 0;
2131 
2132 void os::large_page_init() {
2133 }
2134 
2135 
2136 char* os::reserve_memory_special(size_t bytes, size_t alignment, char* req_addr, bool exec) {
2137   fatal(&quot;os::reserve_memory_special should not be called on BSD.&quot;);
2138   return NULL;
2139 }
2140 
2141 bool os::release_memory_special(char* base, size_t bytes) {
2142   fatal(&quot;os::release_memory_special should not be called on BSD.&quot;);
2143   return false;
2144 }
2145 
2146 size_t os::large_page_size() {
2147   return _large_page_size;
2148 }
2149 
2150 bool os::can_commit_large_page_memory() {
2151   // Does not matter, we do not support huge pages.
2152   return false;
2153 }
2154 
2155 bool os::can_execute_large_page_memory() {
2156   // Does not matter, we do not support huge pages.
2157   return false;
2158 }
2159 
2160 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
2161   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
2162   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
2163   if (result != NULL) {
2164     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
2165       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
2166     }
2167   }
2168   return result;
2169 }
2170 
2171 // Reserve memory at an arbitrary address, only if that area is
2172 // available (and not reserved for something else).
2173 
2174 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
2175   // Assert only that the size is a multiple of the page size, since
2176   // that&#39;s all that mmap requires, and since that&#39;s all we really know
2177   // about at this low abstraction level.  If we need higher alignment,
2178   // we can either pass an alignment to this method or verify alignment
2179   // in one of the methods further up the call chain.  See bug 5044738.
2180   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
2181 
2182   // Repeatedly allocate blocks until the block is allocated at the
2183   // right spot.
2184 
2185   // Bsd mmap allows caller to pass an address as hint; give it a try first,
2186   // if kernel honors the hint then we can return immediately.
2187   char * addr = anon_mmap(requested_addr, bytes, false);
2188   if (addr == requested_addr) {
2189     return requested_addr;
2190   }
2191 
2192   if (addr != NULL) {
2193     // mmap() is successful but it fails to reserve at the requested address
2194     anon_munmap(addr, bytes);
2195   }
2196 
2197   return NULL;
2198 }
2199 
2200 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
2201 void os::infinite_sleep() {
2202   while (true) {    // sleep forever ...
2203     ::sleep(100);   // ... 100 seconds at a time
2204   }
2205 }
2206 
2207 // Used to convert frequent JVM_Yield() to nops
2208 bool os::dont_yield() {
2209   return DontYieldALot;
2210 }
2211 
2212 void os::naked_yield() {
2213   sched_yield();
2214 }
2215 
2216 ////////////////////////////////////////////////////////////////////////////////
2217 // thread priority support
2218 
2219 // Note: Normal Bsd applications are run with SCHED_OTHER policy. SCHED_OTHER
2220 // only supports dynamic priority, static priority must be zero. For real-time
2221 // applications, Bsd supports SCHED_RR which allows static priority (1-99).
2222 // However, for large multi-threaded applications, SCHED_RR is not only slower
2223 // than SCHED_OTHER, but also very unstable (my volano tests hang hard 4 out
2224 // of 5 runs - Sep 2005).
2225 //
2226 // The following code actually changes the niceness of kernel-thread/LWP. It
2227 // has an assumption that setpriority() only modifies one kernel-thread/LWP,
2228 // not the entire user process, and user level threads are 1:1 mapped to kernel
2229 // threads. It has always been the case, but could change in the future. For
2230 // this reason, the code should not be used as default (ThreadPriorityPolicy=0).
2231 // It is only used when ThreadPriorityPolicy=1 and may require system level permission
2232 // (e.g., root privilege or CAP_SYS_NICE capability).
2233 
2234 #if !defined(__APPLE__)
2235 int os::java_to_os_priority[CriticalPriority + 1] = {
2236   19,              // 0 Entry should never be used
2237 
2238    0,              // 1 MinPriority
2239    3,              // 2
2240    6,              // 3
2241 
2242   10,              // 4
2243   15,              // 5 NormPriority
2244   18,              // 6
2245 
2246   21,              // 7
2247   25,              // 8
2248   28,              // 9 NearMaxPriority
2249 
2250   31,              // 10 MaxPriority
2251 
2252   31               // 11 CriticalPriority
2253 };
2254 #else
2255 // Using Mach high-level priority assignments
2256 int os::java_to_os_priority[CriticalPriority + 1] = {
2257    0,              // 0 Entry should never be used (MINPRI_USER)
2258 
2259   27,              // 1 MinPriority
2260   28,              // 2
2261   29,              // 3
2262 
2263   30,              // 4
2264   31,              // 5 NormPriority (BASEPRI_DEFAULT)
2265   32,              // 6
2266 
2267   33,              // 7
2268   34,              // 8
2269   35,              // 9 NearMaxPriority
2270 
2271   36,              // 10 MaxPriority
2272 
2273   36               // 11 CriticalPriority
2274 };
2275 #endif
2276 
2277 static int prio_init() {
2278   if (ThreadPriorityPolicy == 1) {
2279     if (geteuid() != 0) {
<a name="1" id="anc1"></a><span class="line-modified">2280       if (!FLAG_IS_DEFAULT(ThreadPriorityPolicy)) {</span>
2281         warning(&quot;-XX:ThreadPriorityPolicy=1 may require system level permission, &quot; \
2282                 &quot;e.g., being the root user. If the necessary permission is not &quot; \
2283                 &quot;possessed, changes to priority will be silently ignored.&quot;);
2284       }
2285     }
2286   }
2287   if (UseCriticalJavaThreadPriority) {
2288     os::java_to_os_priority[MaxPriority] = os::java_to_os_priority[CriticalPriority];
2289   }
2290   return 0;
2291 }
2292 
2293 OSReturn os::set_native_priority(Thread* thread, int newpri) {
2294   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) return OS_OK;
2295 
2296 #ifdef __OpenBSD__
2297   // OpenBSD pthread_setprio starves low priority threads
2298   return OS_OK;
2299 #elif defined(__FreeBSD__)
2300   int ret = pthread_setprio(thread-&gt;osthread()-&gt;pthread_id(), newpri);
2301   return (ret == 0) ? OS_OK : OS_ERR;
2302 #elif defined(__APPLE__) || defined(__NetBSD__)
2303   struct sched_param sp;
2304   int policy;
2305 
2306   if (pthread_getschedparam(thread-&gt;osthread()-&gt;pthread_id(), &amp;policy, &amp;sp) != 0) {
2307     return OS_ERR;
2308   }
2309 
2310   sp.sched_priority = newpri;
2311   if (pthread_setschedparam(thread-&gt;osthread()-&gt;pthread_id(), policy, &amp;sp) != 0) {
2312     return OS_ERR;
2313   }
2314 
2315   return OS_OK;
2316 #else
2317   int ret = setpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id(), newpri);
2318   return (ret == 0) ? OS_OK : OS_ERR;
2319 #endif
2320 }
2321 
2322 OSReturn os::get_native_priority(const Thread* const thread, int *priority_ptr) {
2323   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) {
2324     *priority_ptr = java_to_os_priority[NormPriority];
2325     return OS_OK;
2326   }
2327 
2328   errno = 0;
2329 #if defined(__OpenBSD__) || defined(__FreeBSD__)
2330   *priority_ptr = pthread_getprio(thread-&gt;osthread()-&gt;pthread_id());
2331 #elif defined(__APPLE__) || defined(__NetBSD__)
2332   int policy;
2333   struct sched_param sp;
2334 
2335   int res = pthread_getschedparam(thread-&gt;osthread()-&gt;pthread_id(), &amp;policy, &amp;sp);
2336   if (res != 0) {
2337     *priority_ptr = -1;
2338     return OS_ERR;
2339   } else {
2340     *priority_ptr = sp.sched_priority;
2341     return OS_OK;
2342   }
2343 #else
2344   *priority_ptr = getpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id());
2345 #endif
2346   return (*priority_ptr != -1 || errno == 0 ? OS_OK : OS_ERR);
2347 }
2348 
2349 ////////////////////////////////////////////////////////////////////////////////
2350 // suspend/resume support
2351 
2352 //  The low-level signal-based suspend/resume support is a remnant from the
2353 //  old VM-suspension that used to be for java-suspension, safepoints etc,
2354 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
2355 //
2356 //  The remaining code is greatly simplified from the more general suspension
2357 //  code that used to be used.
2358 //
2359 //  The protocol is quite simple:
2360 //  - suspend:
2361 //      - sends a signal to the target thread
2362 //      - polls the suspend state of the osthread using a yield loop
2363 //      - target thread signal handler (SR_handler) sets suspend state
2364 //        and blocks in sigsuspend until continued
2365 //  - resume:
2366 //      - sets target osthread state to continue
2367 //      - sends signal to end the sigsuspend loop in the SR_handler
2368 //
2369 //  Note that the SR_lock plays no role in this suspend/resume protocol,
2370 //  but is checked for NULL in SR_handler as a thread termination indicator.
2371 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
2372 //
2373 //  Note that resume_clear_context() and suspend_save_context() are needed
2374 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
2375 //  which in part is used by:
2376 //    - Forte Analyzer: AsyncGetCallTrace()
2377 //    - StackBanging: get_frame_at_stack_banging_point()
2378 
2379 static void resume_clear_context(OSThread *osthread) {
2380   osthread-&gt;set_ucontext(NULL);
2381   osthread-&gt;set_siginfo(NULL);
2382 }
2383 
2384 static void suspend_save_context(OSThread *osthread, siginfo_t* siginfo, ucontext_t* context) {
2385   osthread-&gt;set_ucontext(context);
2386   osthread-&gt;set_siginfo(siginfo);
2387 }
2388 
2389 // Handler function invoked when a thread&#39;s execution is suspended or
2390 // resumed. We have to be careful that only async-safe functions are
2391 // called here (Note: most pthread functions are not async safe and
2392 // should be avoided.)
2393 //
2394 // Note: sigwait() is a more natural fit than sigsuspend() from an
2395 // interface point of view, but sigwait() prevents the signal hander
2396 // from being run. libpthread would get very confused by not having
2397 // its signal handlers run and prevents sigwait()&#39;s use with the
2398 // mutex granting granting signal.
2399 //
2400 // Currently only ever called on the VMThread or JavaThread
2401 //
2402 #ifdef __APPLE__
2403 static OSXSemaphore sr_semaphore;
2404 #else
2405 static PosixSemaphore sr_semaphore;
2406 #endif
2407 
2408 static void SR_handler(int sig, siginfo_t* siginfo, ucontext_t* context) {
2409   // Save and restore errno to avoid confusing native code with EINTR
2410   // after sigsuspend.
2411   int old_errno = errno;
2412 
2413   Thread* thread = Thread::current_or_null_safe();
2414   assert(thread != NULL, &quot;Missing current thread in SR_handler&quot;);
2415 
2416   // On some systems we have seen signal delivery get &quot;stuck&quot; until the signal
2417   // mask is changed as part of thread termination. Check that the current thread
2418   // has not already terminated (via SR_lock()) - else the following assertion
2419   // will fail because the thread is no longer a JavaThread as the ~JavaThread
2420   // destructor has completed.
2421 
2422   if (thread-&gt;SR_lock() == NULL) {
2423     return;
2424   }
2425 
2426   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
2427 
2428   OSThread* osthread = thread-&gt;osthread();
2429 
2430   os::SuspendResume::State current = osthread-&gt;sr.state();
2431   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
2432     suspend_save_context(osthread, siginfo, context);
2433 
2434     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
2435     os::SuspendResume::State state = osthread-&gt;sr.suspended();
2436     if (state == os::SuspendResume::SR_SUSPENDED) {
2437       sigset_t suspend_set;  // signals for sigsuspend()
2438 
2439       // get current set of blocked signals and unblock resume signal
2440       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
2441       sigdelset(&amp;suspend_set, SR_signum);
2442 
2443       sr_semaphore.signal();
2444       // wait here until we are resumed
2445       while (1) {
2446         sigsuspend(&amp;suspend_set);
2447 
2448         os::SuspendResume::State result = osthread-&gt;sr.running();
2449         if (result == os::SuspendResume::SR_RUNNING) {
2450           sr_semaphore.signal();
2451           break;
2452         } else if (result != os::SuspendResume::SR_SUSPENDED) {
2453           ShouldNotReachHere();
2454         }
2455       }
2456 
2457     } else if (state == os::SuspendResume::SR_RUNNING) {
2458       // request was cancelled, continue
2459     } else {
2460       ShouldNotReachHere();
2461     }
2462 
2463     resume_clear_context(osthread);
2464   } else if (current == os::SuspendResume::SR_RUNNING) {
2465     // request was cancelled, continue
2466   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
2467     // ignore
2468   } else {
2469     // ignore
2470   }
2471 
2472   errno = old_errno;
2473 }
2474 
2475 
2476 static int SR_initialize() {
2477   struct sigaction act;
2478   char *s;
2479   // Get signal number to use for suspend/resume
2480   if ((s = ::getenv(&quot;_JAVA_SR_SIGNUM&quot;)) != 0) {
2481     int sig = ::strtol(s, 0, 10);
2482     if (sig &gt; MAX2(SIGSEGV, SIGBUS) &amp;&amp;  // See 4355769.
2483         sig &lt; NSIG) {                   // Must be legal signal and fit into sigflags[].
2484       SR_signum = sig;
2485     } else {
2486       warning(&quot;You set _JAVA_SR_SIGNUM=%d. It must be in range [%d, %d]. Using %d instead.&quot;,
2487               sig, MAX2(SIGSEGV, SIGBUS)+1, NSIG-1, SR_signum);
2488     }
2489   }
2490 
2491   assert(SR_signum &gt; SIGSEGV &amp;&amp; SR_signum &gt; SIGBUS,
2492          &quot;SR_signum must be greater than max(SIGSEGV, SIGBUS), see 4355769&quot;);
2493 
2494   sigemptyset(&amp;SR_sigset);
2495   sigaddset(&amp;SR_sigset, SR_signum);
2496 
2497   // Set up signal handler for suspend/resume
2498   act.sa_flags = SA_RESTART|SA_SIGINFO;
2499   act.sa_handler = (void (*)(int)) SR_handler;
2500 
2501   // SR_signum is blocked by default.
2502   // 4528190 - We also need to block pthread restart signal (32 on all
2503   // supported Bsd platforms). Note that BsdThreads need to block
2504   // this signal for all threads to work properly. So we don&#39;t have
2505   // to use hard-coded signal number when setting up the mask.
2506   pthread_sigmask(SIG_BLOCK, NULL, &amp;act.sa_mask);
2507 
2508   if (sigaction(SR_signum, &amp;act, 0) == -1) {
2509     return -1;
2510   }
2511 
2512   // Save signal flag
2513   os::Bsd::set_our_sigflags(SR_signum, act.sa_flags);
2514   return 0;
2515 }
2516 
2517 static int sr_notify(OSThread* osthread) {
2518   int status = pthread_kill(osthread-&gt;pthread_id(), SR_signum);
2519   assert_status(status == 0, status, &quot;pthread_kill&quot;);
2520   return status;
2521 }
2522 
2523 // &quot;Randomly&quot; selected value for how long we want to spin
2524 // before bailing out on suspending a thread, also how often
2525 // we send a signal to a thread we want to resume
2526 static const int RANDOMLY_LARGE_INTEGER = 1000000;
2527 static const int RANDOMLY_LARGE_INTEGER2 = 100;
2528 
2529 // returns true on success and false on error - really an error is fatal
2530 // but this seems the normal response to library errors
2531 static bool do_suspend(OSThread* osthread) {
2532   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
2533   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
2534 
2535   // mark as suspended and send signal
2536   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
2537     // failed to switch, state wasn&#39;t running?
2538     ShouldNotReachHere();
2539     return false;
2540   }
2541 
2542   if (sr_notify(osthread) != 0) {
2543     ShouldNotReachHere();
2544   }
2545 
2546   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
2547   while (true) {
2548     if (sr_semaphore.timedwait(2)) {
2549       break;
2550     } else {
2551       // timeout
2552       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
2553       if (cancelled == os::SuspendResume::SR_RUNNING) {
2554         return false;
2555       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
2556         // make sure that we consume the signal on the semaphore as well
2557         sr_semaphore.wait();
2558         break;
2559       } else {
2560         ShouldNotReachHere();
2561         return false;
2562       }
2563     }
2564   }
2565 
2566   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
2567   return true;
2568 }
2569 
2570 static void do_resume(OSThread* osthread) {
2571   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
2572   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
2573 
2574   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
2575     // failed to switch to WAKEUP_REQUEST
2576     ShouldNotReachHere();
2577     return;
2578   }
2579 
2580   while (true) {
2581     if (sr_notify(osthread) == 0) {
2582       if (sr_semaphore.timedwait(2)) {
2583         if (osthread-&gt;sr.is_running()) {
2584           return;
2585         }
2586       }
2587     } else {
2588       ShouldNotReachHere();
2589     }
2590   }
2591 
2592   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
2593 }
2594 
2595 ///////////////////////////////////////////////////////////////////////////////////
2596 // signal handling (except suspend/resume)
2597 
2598 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
2599 // The user-defined signal handler must pass unrecognized signals to this
2600 // routine, and if it returns true (non-zero), then the signal handler must
2601 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
2602 // routine will never retun false (zero), but instead will execute a VM panic
2603 // routine kill the process.
2604 //
2605 // If this routine returns false, it is OK to call it again.  This allows
2606 // the user-defined signal handler to perform checks either before or after
2607 // the VM performs its own checks.  Naturally, the user code would be making
2608 // a serious error if it tried to handle an exception (such as a null check
2609 // or breakpoint) that the VM was generating for its own correct operation.
2610 //
2611 // This routine may recognize any of the following kinds of signals:
2612 //    SIGBUS, SIGSEGV, SIGILL, SIGFPE, SIGQUIT, SIGPIPE, SIGXFSZ, SIGUSR1.
2613 // It should be consulted by handlers for any of those signals.
2614 //
2615 // The caller of this routine must pass in the three arguments supplied
2616 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
2617 // field of the structure passed to sigaction().  This routine assumes that
2618 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
2619 //
2620 // Note that the VM will print warnings if it detects conflicting signal
2621 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
2622 //
2623 extern &quot;C&quot; JNIEXPORT int JVM_handle_bsd_signal(int signo, siginfo_t* siginfo,
2624                                                void* ucontext,
2625                                                int abort_if_unrecognized);
2626 
2627 static void signalHandler(int sig, siginfo_t* info, void* uc) {
2628   assert(info != NULL &amp;&amp; uc != NULL, &quot;it must be old kernel&quot;);
2629   int orig_errno = errno;  // Preserve errno value over signal handler.
2630   JVM_handle_bsd_signal(sig, info, uc, true);
2631   errno = orig_errno;
2632 }
2633 
2634 
2635 // This boolean allows users to forward their own non-matching signals
2636 // to JVM_handle_bsd_signal, harmlessly.
2637 bool os::Bsd::signal_handlers_are_installed = false;
2638 
2639 // For signal-chaining
2640 bool os::Bsd::libjsig_is_loaded = false;
2641 typedef struct sigaction *(*get_signal_t)(int);
2642 get_signal_t os::Bsd::get_signal_action = NULL;
2643 
2644 struct sigaction* os::Bsd::get_chained_signal_action(int sig) {
2645   struct sigaction *actp = NULL;
2646 
2647   if (libjsig_is_loaded) {
2648     // Retrieve the old signal handler from libjsig
2649     actp = (*get_signal_action)(sig);
2650   }
2651   if (actp == NULL) {
2652     // Retrieve the preinstalled signal handler from jvm
2653     actp = os::Posix::get_preinstalled_handler(sig);
2654   }
2655 
2656   return actp;
2657 }
2658 
2659 static bool call_chained_handler(struct sigaction *actp, int sig,
2660                                  siginfo_t *siginfo, void *context) {
2661   // Call the old signal handler
2662   if (actp-&gt;sa_handler == SIG_DFL) {
2663     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
2664     // instead of taking the default action.
2665     return false;
2666   } else if (actp-&gt;sa_handler != SIG_IGN) {
2667     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
2668       // automaticlly block the signal
2669       sigaddset(&amp;(actp-&gt;sa_mask), sig);
2670     }
2671 
2672     sa_handler_t hand;
2673     sa_sigaction_t sa;
2674     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
2675     // retrieve the chained handler
2676     if (siginfo_flag_set) {
2677       sa = actp-&gt;sa_sigaction;
2678     } else {
2679       hand = actp-&gt;sa_handler;
2680     }
2681 
2682     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
2683       actp-&gt;sa_handler = SIG_DFL;
2684     }
2685 
2686     // try to honor the signal mask
2687     sigset_t oset;
2688     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
2689 
2690     // call into the chained handler
2691     if (siginfo_flag_set) {
2692       (*sa)(sig, siginfo, context);
2693     } else {
2694       (*hand)(sig);
2695     }
2696 
2697     // restore the signal mask
2698     pthread_sigmask(SIG_SETMASK, &amp;oset, 0);
2699   }
2700   // Tell jvm&#39;s signal handler the signal is taken care of.
2701   return true;
2702 }
2703 
2704 bool os::Bsd::chained_handler(int sig, siginfo_t* siginfo, void* context) {
2705   bool chained = false;
2706   // signal-chaining
2707   if (UseSignalChaining) {
2708     struct sigaction *actp = get_chained_signal_action(sig);
2709     if (actp != NULL) {
2710       chained = call_chained_handler(actp, sig, siginfo, context);
2711     }
2712   }
2713   return chained;
2714 }
2715 
2716 // for diagnostic
2717 int sigflags[NSIG];
2718 
2719 int os::Bsd::get_our_sigflags(int sig) {
2720   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
2721   return sigflags[sig];
2722 }
2723 
2724 void os::Bsd::set_our_sigflags(int sig, int flags) {
2725   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
2726   if (sig &gt; 0 &amp;&amp; sig &lt; NSIG) {
2727     sigflags[sig] = flags;
2728   }
2729 }
2730 
2731 void os::Bsd::set_signal_handler(int sig, bool set_installed) {
2732   // Check for overwrite.
2733   struct sigaction oldAct;
2734   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
2735 
2736   void* oldhand = oldAct.sa_sigaction
2737                 ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
2738                 : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
2739   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
2740       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
2741       oldhand != CAST_FROM_FN_PTR(void*, (sa_sigaction_t)signalHandler)) {
2742     if (AllowUserSignalHandlers || !set_installed) {
2743       // Do not overwrite; user takes responsibility to forward to us.
2744       return;
2745     } else if (UseSignalChaining) {
2746       // save the old handler in jvm
2747       os::Posix::save_preinstalled_handler(sig, oldAct);
2748       // libjsig also interposes the sigaction() call below and saves the
2749       // old sigaction on it own.
2750     } else {
2751       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
2752             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
2753     }
2754   }
2755 
2756   struct sigaction sigAct;
2757   sigfillset(&amp;(sigAct.sa_mask));
2758   sigAct.sa_handler = SIG_DFL;
2759   if (!set_installed) {
2760     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
2761   } else {
2762     sigAct.sa_sigaction = signalHandler;
2763     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
2764   }
2765 #ifdef __APPLE__
2766   // Needed for main thread as XNU (Mac OS X kernel) will only deliver SIGSEGV
2767   // (which starts as SIGBUS) on main thread with faulting address inside &quot;stack+guard pages&quot;
2768   // if the signal handler declares it will handle it on alternate stack.
2769   // Notice we only declare we will handle it on alt stack, but we are not
2770   // actually going to use real alt stack - this is just a workaround.
2771   // Please see ux_exception.c, method catch_mach_exception_raise for details
2772   // link http://www.opensource.apple.com/source/xnu/xnu-2050.18.24/bsd/uxkern/ux_exception.c
2773   if (sig == SIGSEGV) {
2774     sigAct.sa_flags |= SA_ONSTACK;
2775   }
2776 #endif
2777 
2778   // Save flags, which are set by ours
2779   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
2780   sigflags[sig] = sigAct.sa_flags;
2781 
2782   int ret = sigaction(sig, &amp;sigAct, &amp;oldAct);
2783   assert(ret == 0, &quot;check&quot;);
2784 
2785   void* oldhand2  = oldAct.sa_sigaction
2786                   ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
2787                   : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
2788   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
2789 }
2790 
2791 // install signal handlers for signals that HotSpot needs to
2792 // handle in order to support Java-level exception handling.
2793 
2794 void os::Bsd::install_signal_handlers() {
2795   if (!signal_handlers_are_installed) {
2796     signal_handlers_are_installed = true;
2797 
2798     // signal-chaining
2799     typedef void (*signal_setting_t)();
2800     signal_setting_t begin_signal_setting = NULL;
2801     signal_setting_t end_signal_setting = NULL;
2802     begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
2803                                           dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
2804     if (begin_signal_setting != NULL) {
2805       end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
2806                                           dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
2807       get_signal_action = CAST_TO_FN_PTR(get_signal_t,
2808                                          dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
2809       libjsig_is_loaded = true;
2810       assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
2811     }
2812     if (libjsig_is_loaded) {
2813       // Tell libjsig jvm is setting signal handlers
2814       (*begin_signal_setting)();
2815     }
2816 
2817     set_signal_handler(SIGSEGV, true);
2818     set_signal_handler(SIGPIPE, true);
2819     set_signal_handler(SIGBUS, true);
2820     set_signal_handler(SIGILL, true);
2821     set_signal_handler(SIGFPE, true);
2822     set_signal_handler(SIGXFSZ, true);
2823 
2824 #if defined(__APPLE__)
2825     // In Mac OS X 10.4, CrashReporter will write a crash log for all &#39;fatal&#39; signals, including
2826     // signals caught and handled by the JVM. To work around this, we reset the mach task
2827     // signal handler that&#39;s placed on our process by CrashReporter. This disables
2828     // CrashReporter-based reporting.
2829     //
2830     // This work-around is not necessary for 10.5+, as CrashReporter no longer intercedes
2831     // on caught fatal signals.
2832     //
2833     // Additionally, gdb installs both standard BSD signal handlers, and mach exception
2834     // handlers. By replacing the existing task exception handler, we disable gdb&#39;s mach
2835     // exception handling, while leaving the standard BSD signal handlers functional.
2836     kern_return_t kr;
2837     kr = task_set_exception_ports(mach_task_self(),
2838                                   EXC_MASK_BAD_ACCESS | EXC_MASK_ARITHMETIC,
2839                                   MACH_PORT_NULL,
2840                                   EXCEPTION_STATE_IDENTITY,
2841                                   MACHINE_THREAD_STATE);
2842 
2843     assert(kr == KERN_SUCCESS, &quot;could not set mach task signal handler&quot;);
2844 #endif
2845 
2846     if (libjsig_is_loaded) {
2847       // Tell libjsig jvm finishes setting signal handlers
2848       (*end_signal_setting)();
2849     }
2850 
2851     // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
2852     // and if UserSignalHandler is installed all bets are off
2853     if (CheckJNICalls) {
2854       if (libjsig_is_loaded) {
2855         log_debug(jni, resolve)(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
2856         check_signals = false;
2857       }
2858       if (AllowUserSignalHandlers) {
2859         log_debug(jni, resolve)(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
2860         check_signals = false;
2861       }
2862     }
2863   }
2864 }
2865 
2866 
2867 /////
2868 // glibc on Bsd platform uses non-documented flag
2869 // to indicate, that some special sort of signal
2870 // trampoline is used.
2871 // We will never set this flag, and we should
2872 // ignore this flag in our diagnostic
2873 #ifdef SIGNIFICANT_SIGNAL_MASK
2874   #undef SIGNIFICANT_SIGNAL_MASK
2875 #endif
2876 #define SIGNIFICANT_SIGNAL_MASK (~0x04000000)
2877 
2878 static const char* get_signal_handler_name(address handler,
2879                                            char* buf, int buflen) {
2880   int offset;
2881   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
2882   if (found) {
2883     // skip directory names
2884     const char *p1, *p2;
2885     p1 = buf;
2886     size_t len = strlen(os::file_separator());
2887     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
2888     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
2889   } else {
2890     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
2891   }
2892   return buf;
2893 }
2894 
2895 static void print_signal_handler(outputStream* st, int sig,
2896                                  char* buf, size_t buflen) {
2897   struct sigaction sa;
2898 
2899   sigaction(sig, NULL, &amp;sa);
2900 
2901   // See comment for SIGNIFICANT_SIGNAL_MASK define
2902   sa.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
2903 
2904   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
2905 
2906   address handler = (sa.sa_flags &amp; SA_SIGINFO)
2907     ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
2908     : CAST_FROM_FN_PTR(address, sa.sa_handler);
2909 
2910   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
2911     st-&gt;print(&quot;SIG_DFL&quot;);
2912   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
2913     st-&gt;print(&quot;SIG_IGN&quot;);
2914   } else {
2915     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
2916   }
2917 
2918   st-&gt;print(&quot;, sa_mask[0]=&quot;);
2919   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
2920 
2921   address rh = VMError::get_resetted_sighandler(sig);
2922   // May be, handler was resetted by VMError?
2923   if (rh != NULL) {
2924     handler = rh;
2925     sa.sa_flags = VMError::get_resetted_sigflags(sig) &amp; SIGNIFICANT_SIGNAL_MASK;
2926   }
2927 
2928   st-&gt;print(&quot;, sa_flags=&quot;);
2929   os::Posix::print_sa_flags(st, sa.sa_flags);
2930 
2931   // Check: is it our handler?
2932   if (handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler) ||
2933       handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler)) {
2934     // It is our signal handler
2935     // check for flags, reset system-used one!
2936     if ((int)sa.sa_flags != os::Bsd::get_our_sigflags(sig)) {
2937       st-&gt;print(
2938                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
2939                 os::Bsd::get_our_sigflags(sig));
2940     }
2941   }
2942   st-&gt;cr();
2943 }
2944 
2945 
2946 #define DO_SIGNAL_CHECK(sig)                      \
2947   do {                                            \
2948     if (!sigismember(&amp;check_signal_done, sig)) {  \
2949       os::Bsd::check_signal_handler(sig);         \
2950     }                                             \
2951   } while (0)
2952 
2953 // This method is a periodic task to check for misbehaving JNI applications
2954 // under CheckJNI, we can add any periodic checks here
2955 
2956 void os::run_periodic_checks() {
2957 
2958   if (check_signals == false) return;
2959 
2960   // SEGV and BUS if overridden could potentially prevent
2961   // generation of hs*.log in the event of a crash, debugging
2962   // such a case can be very challenging, so we absolutely
2963   // check the following for a good measure:
2964   DO_SIGNAL_CHECK(SIGSEGV);
2965   DO_SIGNAL_CHECK(SIGILL);
2966   DO_SIGNAL_CHECK(SIGFPE);
2967   DO_SIGNAL_CHECK(SIGBUS);
2968   DO_SIGNAL_CHECK(SIGPIPE);
2969   DO_SIGNAL_CHECK(SIGXFSZ);
2970 
2971 
2972   // ReduceSignalUsage allows the user to override these handlers
2973   // see comments at the very top and jvm_md.h
2974   if (!ReduceSignalUsage) {
2975     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
2976     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
2977     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
2978     DO_SIGNAL_CHECK(BREAK_SIGNAL);
2979   }
2980 
2981   DO_SIGNAL_CHECK(SR_signum);
2982 }
2983 
2984 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
2985 
2986 static os_sigaction_t os_sigaction = NULL;
2987 
2988 void os::Bsd::check_signal_handler(int sig) {
2989   char buf[O_BUFLEN];
2990   address jvmHandler = NULL;
2991 
2992 
2993   struct sigaction act;
2994   if (os_sigaction == NULL) {
2995     // only trust the default sigaction, in case it has been interposed
2996     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
2997     if (os_sigaction == NULL) return;
2998   }
2999 
3000   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
3001 
3002 
3003   act.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
3004 
3005   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
3006     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
3007     : CAST_FROM_FN_PTR(address, act.sa_handler);
3008 
3009 
3010   switch (sig) {
3011   case SIGSEGV:
3012   case SIGBUS:
3013   case SIGFPE:
3014   case SIGPIPE:
3015   case SIGILL:
3016   case SIGXFSZ:
3017     jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler);
3018     break;
3019 
3020   case SHUTDOWN1_SIGNAL:
3021   case SHUTDOWN2_SIGNAL:
3022   case SHUTDOWN3_SIGNAL:
3023   case BREAK_SIGNAL:
3024     jvmHandler = (address)user_handler();
3025     break;
3026 
3027   default:
3028     if (sig == SR_signum) {
3029       jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler);
3030     } else {
3031       return;
3032     }
3033     break;
3034   }
3035 
3036   if (thisHandler != jvmHandler) {
3037     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
3038     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
3039     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
3040     // No need to check this sig any longer
3041     sigaddset(&amp;check_signal_done, sig);
3042     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
3043     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
3044       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
3045                     exception_name(sig, buf, O_BUFLEN));
3046     }
3047   } else if(os::Bsd::get_our_sigflags(sig) != 0 &amp;&amp; (int)act.sa_flags != os::Bsd::get_our_sigflags(sig)) {
3048     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
3049     tty-&gt;print(&quot;expected:&quot;);
3050     os::Posix::print_sa_flags(tty, os::Bsd::get_our_sigflags(sig));
3051     tty-&gt;cr();
3052     tty-&gt;print(&quot;  found:&quot;);
3053     os::Posix::print_sa_flags(tty, act.sa_flags);
3054     tty-&gt;cr();
3055     // No need to check this sig any longer
3056     sigaddset(&amp;check_signal_done, sig);
3057   }
3058 
3059   // Dump all the signal
3060   if (sigismember(&amp;check_signal_done, sig)) {
3061     print_signal_handlers(tty, buf, O_BUFLEN);
3062   }
3063 }
3064 
3065 extern void report_error(char* file_name, int line_no, char* title,
3066                          char* format, ...);
3067 
3068 // this is called _before_ the most of global arguments have been parsed
3069 void os::init(void) {
3070   char dummy;   // used to get a guess on initial stack address
3071 
3072   clock_tics_per_sec = CLK_TCK;
3073 
3074   init_random(1234567);
3075 
3076   Bsd::set_page_size(getpagesize());
3077   if (Bsd::page_size() == -1) {
3078     fatal(&quot;os_bsd.cpp: os::init: sysconf failed (%s)&quot;, os::strerror(errno));
3079   }
3080   init_page_sizes((size_t) Bsd::page_size());
3081 
3082   Bsd::initialize_system_info();
3083 
3084   // _main_thread points to the thread that created/loaded the JVM.
3085   Bsd::_main_thread = pthread_self();
3086 
3087   Bsd::clock_init();
3088   initial_time_count = javaTimeNanos();
3089 
3090   os::Posix::init();
3091 }
3092 
3093 // To install functions for atexit system call
3094 extern &quot;C&quot; {
3095   static void perfMemory_exit_helper() {
3096     perfMemory_exit();
3097   }
3098 }
3099 
3100 // this is called _after_ the global arguments have been parsed
3101 jint os::init_2(void) {
3102 
3103   // This could be set after os::Posix::init() but all platforms
3104   // have to set it the same so we have to mirror Solaris.
3105   DEBUG_ONLY(os::set_mutex_init_done();)
3106 
3107   os::Posix::init_2();
3108 
3109   // initialize suspend/resume support - must do this before signal_sets_init()
3110   if (SR_initialize() != 0) {
3111     perror(&quot;SR_initialize failed&quot;);
3112     return JNI_ERR;
3113   }
3114 
3115   Bsd::signal_sets_init();
3116   Bsd::install_signal_handlers();
3117   // Initialize data for jdk.internal.misc.Signal
3118   if (!ReduceSignalUsage) {
3119     jdk_misc_signal_init();
3120   }
3121 
3122   // Check and sets minimum stack sizes against command line options
3123   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
3124     return JNI_ERR;
3125   }
3126 
3127   if (MaxFDLimit) {
3128     // set the number of file descriptors to max. print out error
3129     // if getrlimit/setrlimit fails but continue regardless.
3130     struct rlimit nbr_files;
3131     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3132     if (status != 0) {
3133       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
3134     } else {
3135       nbr_files.rlim_cur = nbr_files.rlim_max;
3136 
3137 #ifdef __APPLE__
3138       // Darwin returns RLIM_INFINITY for rlim_max, but fails with EINVAL if
3139       // you attempt to use RLIM_INFINITY. As per setrlimit(2), OPEN_MAX must
3140       // be used instead
3141       nbr_files.rlim_cur = MIN(OPEN_MAX, nbr_files.rlim_cur);
3142 #endif
3143 
3144       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3145       if (status != 0) {
3146         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
3147       }
3148     }
3149   }
3150 
3151   // at-exit methods are called in the reverse order of their registration.
3152   // atexit functions are called on return from main or as a result of a
3153   // call to exit(3C). There can be only 32 of these functions registered
3154   // and atexit() does not set errno.
3155 
3156   if (PerfAllowAtExitRegistration) {
3157     // only register atexit functions if PerfAllowAtExitRegistration is set.
3158     // atexit functions can be delayed until process exit time, which
3159     // can be problematic for embedded VM situations. Embedded VMs should
3160     // call DestroyJavaVM() to assure that VM resources are released.
3161 
3162     // note: perfMemory_exit_helper atexit function may be removed in
3163     // the future if the appropriate cleanup code can be added to the
3164     // VM_Exit VMOperation&#39;s doit method.
3165     if (atexit(perfMemory_exit_helper) != 0) {
3166       warning(&quot;os::init_2 atexit(perfMemory_exit_helper) failed&quot;);
3167     }
3168   }
3169 
3170   // initialize thread priority policy
3171   prio_init();
3172 
3173 #ifdef __APPLE__
3174   // dynamically link to objective c gc registration
3175   void *handleLibObjc = dlopen(OBJC_LIB, RTLD_LAZY);
3176   if (handleLibObjc != NULL) {
3177     objc_registerThreadWithCollectorFunction = (objc_registerThreadWithCollector_t) dlsym(handleLibObjc, OBJC_GCREGISTER);
3178   }
3179 #endif
3180 
3181   return JNI_OK;
3182 }
3183 
3184 // Mark the polling page as unreadable
3185 void os::make_polling_page_unreadable(void) {
3186   if (!guard_memory((char*)_polling_page, Bsd::page_size())) {
3187     fatal(&quot;Could not disable polling page&quot;);
3188   }
3189 }
3190 
3191 // Mark the polling page as readable
3192 void os::make_polling_page_readable(void) {
3193   if (!bsd_mprotect((char *)_polling_page, Bsd::page_size(), PROT_READ)) {
3194     fatal(&quot;Could not enable polling page&quot;);
3195   }
3196 }
3197 
3198 int os::active_processor_count() {
3199   // User has overridden the number of active processors
3200   if (ActiveProcessorCount &gt; 0) {
3201     log_trace(os)(&quot;active_processor_count: &quot;
3202                   &quot;active processor count set by user : %d&quot;,
3203                   ActiveProcessorCount);
3204     return ActiveProcessorCount;
3205   }
3206 
3207   return _processor_count;
3208 }
3209 
3210 #ifdef __APPLE__
3211 static volatile int* volatile apic_to_processor_mapping = NULL;
3212 static volatile int next_processor_id = 0;
3213 
3214 static inline volatile int* get_apic_to_processor_mapping() {
3215   volatile int* mapping = Atomic::load_acquire(&amp;apic_to_processor_mapping);
3216   if (mapping == NULL) {
3217     // Calculate possible number space for APIC ids. This space is not necessarily
3218     // in the range [0, number_of_processors).
3219     uint total_bits = 0;
3220     for (uint i = 0;; ++i) {
3221       uint eax = 0xb; // Query topology leaf
3222       uint ebx;
3223       uint ecx = i;
3224       uint edx;
3225 
3226       __asm__ (&quot;cpuid\n\t&quot; : &quot;+a&quot; (eax), &quot;+b&quot; (ebx), &quot;+c&quot; (ecx), &quot;+d&quot; (edx) : );
3227 
3228       uint level_type = (ecx &gt;&gt; 8) &amp; 0xFF;
3229       if (level_type == 0) {
3230         // Invalid level; end of topology
3231         break;
3232       }
3233       uint level_apic_id_shift = eax &amp; ((1u &lt;&lt; 5) - 1);
3234       total_bits += level_apic_id_shift;
3235     }
3236 
3237     uint max_apic_ids = 1u &lt;&lt; total_bits;
3238     mapping = NEW_C_HEAP_ARRAY(int, max_apic_ids, mtInternal);
3239 
3240     for (uint i = 0; i &lt; max_apic_ids; ++i) {
3241       mapping[i] = -1;
3242     }
3243 
3244     if (!Atomic::replace_if_null(&amp;apic_to_processor_mapping, mapping)) {
3245       FREE_C_HEAP_ARRAY(int, mapping);
3246       mapping = Atomic::load_acquire(&amp;apic_to_processor_mapping);
3247     }
3248   }
3249 
3250   return mapping;
3251 }
3252 
3253 uint os::processor_id() {
3254   volatile int* mapping = get_apic_to_processor_mapping();
3255 
3256   uint eax = 0xb;
3257   uint ebx;
3258   uint ecx = 0;
3259   uint edx;
3260 
3261   __asm__ (&quot;cpuid\n\t&quot; : &quot;+a&quot; (eax), &quot;+b&quot; (ebx), &quot;+c&quot; (ecx), &quot;+d&quot; (edx) : );
3262 
3263   // Map from APIC id to a unique logical processor ID in the expected
3264   // [0, num_processors) range.
3265 
3266   uint apic_id = edx;
3267   int processor_id = Atomic::load(&amp;mapping[apic_id]);
3268 
3269   while (processor_id &lt; 0) {
3270     if (Atomic::cmpxchg(&amp;mapping[apic_id], -1, -2) == -1) {
3271       Atomic::store(&amp;mapping[apic_id], Atomic::add(&amp;next_processor_id, 1) - 1);
3272     }
3273     processor_id = Atomic::load(&amp;mapping[apic_id]);
3274   }
3275 
3276   assert(processor_id &gt;= 0 &amp;&amp; processor_id &lt; os::processor_count(), &quot;invalid processor id&quot;);
3277 
3278   return (uint)processor_id;
3279 }
3280 #endif
3281 
3282 void os::set_native_thread_name(const char *name) {
3283 #if defined(__APPLE__) &amp;&amp; MAC_OS_X_VERSION_MIN_REQUIRED &gt; MAC_OS_X_VERSION_10_5
3284   // This is only supported in Snow Leopard and beyond
3285   if (name != NULL) {
3286     // Add a &quot;Java: &quot; prefix to the name
3287     char buf[MAXTHREADNAMESIZE];
3288     snprintf(buf, sizeof(buf), &quot;Java: %s&quot;, name);
3289     pthread_setname_np(buf);
3290   }
3291 #endif
3292 }
3293 
3294 bool os::bind_to_processor(uint processor_id) {
3295   // Not yet implemented.
3296   return false;
3297 }
3298 
3299 void os::SuspendedThreadTask::internal_do_task() {
3300   if (do_suspend(_thread-&gt;osthread())) {
3301     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
3302     do_task(context);
3303     do_resume(_thread-&gt;osthread());
3304   }
3305 }
3306 
3307 ////////////////////////////////////////////////////////////////////////////////
3308 // debug support
3309 
3310 bool os::find(address addr, outputStream* st) {
3311   Dl_info dlinfo;
3312   memset(&amp;dlinfo, 0, sizeof(dlinfo));
3313   if (dladdr(addr, &amp;dlinfo) != 0) {
3314     st-&gt;print(INTPTR_FORMAT &quot;: &quot;, (intptr_t)addr);
3315     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
3316       st-&gt;print(&quot;%s+%#x&quot;, dlinfo.dli_sname,
3317                 (uint)((uintptr_t)addr - (uintptr_t)dlinfo.dli_saddr));
3318     } else if (dlinfo.dli_fbase != NULL) {
3319       st-&gt;print(&quot;&lt;offset %#x&gt;&quot;, (uint)((uintptr_t)addr - (uintptr_t)dlinfo.dli_fbase));
3320     } else {
3321       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
3322     }
3323     if (dlinfo.dli_fname != NULL) {
3324       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
3325     }
3326     if (dlinfo.dli_fbase != NULL) {
3327       st-&gt;print(&quot; at &quot; INTPTR_FORMAT, (intptr_t)dlinfo.dli_fbase);
3328     }
3329     st-&gt;cr();
3330 
3331     if (Verbose) {
3332       // decode some bytes around the PC
3333       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
3334       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
3335       address       lowest = (address) dlinfo.dli_sname;
3336       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
3337       if (begin &lt; lowest)  begin = lowest;
3338       Dl_info dlinfo2;
3339       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
3340           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
3341         end = (address) dlinfo2.dli_saddr;
3342       }
3343       Disassembler::decode(begin, end, st);
3344     }
3345     return true;
3346   }
3347   return false;
3348 }
3349 
3350 ////////////////////////////////////////////////////////////////////////////////
3351 // misc
3352 
3353 // This does not do anything on Bsd. This is basically a hook for being
3354 // able to use structured exception handling (thread-local exception filters)
3355 // on, e.g., Win32.
3356 void os::os_exception_wrapper(java_call_t f, JavaValue* value,
3357                               const methodHandle&amp; method, JavaCallArguments* args,
3358                               Thread* thread) {
3359   f(value, method, args, thread);
3360 }
3361 
3362 void os::print_statistics() {
3363 }
3364 
3365 bool os::message_box(const char* title, const char* message) {
3366   int i;
3367   fdStream err(defaultStream::error_fd());
3368   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3369   err.cr();
3370   err.print_raw_cr(title);
3371   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
3372   err.cr();
3373   err.print_raw_cr(message);
3374   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3375   err.cr();
3376 
3377   char buf[16];
3378   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
3379   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
3380 
3381   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
3382 }
3383 
3384 static inline struct timespec get_mtime(const char* filename) {
3385   struct stat st;
3386   int ret = os::stat(filename, &amp;st);
3387   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
3388 #ifdef __APPLE__
3389   return st.st_mtimespec;
3390 #else
3391   return st.st_mtim;
3392 #endif
3393 }
3394 
3395 int os::compare_file_modified_times(const char* file1, const char* file2) {
3396   struct timespec filetime1 = get_mtime(file1);
3397   struct timespec filetime2 = get_mtime(file2);
3398   int diff = filetime1.tv_sec - filetime2.tv_sec;
3399   if (diff == 0) {
3400     return filetime1.tv_nsec - filetime2.tv_nsec;
3401   }
3402   return diff;
3403 }
3404 
3405 // Is a (classpath) directory empty?
3406 bool os::dir_is_empty(const char* path) {
3407   DIR *dir = NULL;
3408   struct dirent *ptr;
3409 
3410   dir = opendir(path);
3411   if (dir == NULL) return true;
3412 
3413   // Scan the directory
3414   bool result = true;
3415   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
3416     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
3417       result = false;
3418     }
3419   }
3420   closedir(dir);
3421   return result;
3422 }
3423 
3424 // This code originates from JDK&#39;s sysOpen and open64_w
3425 // from src/solaris/hpi/src/system_md.c
3426 
3427 int os::open(const char *path, int oflag, int mode) {
3428   if (strlen(path) &gt; MAX_PATH - 1) {
3429     errno = ENAMETOOLONG;
3430     return -1;
3431   }
3432   int fd;
3433 
3434   fd = ::open(path, oflag, mode);
3435   if (fd == -1) return -1;
3436 
3437   // If the open succeeded, the file might still be a directory
3438   {
3439     struct stat buf;
3440     int ret = ::fstat(fd, &amp;buf);
3441     int st_mode = buf.st_mode;
3442 
3443     if (ret != -1) {
3444       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
3445         errno = EISDIR;
3446         ::close(fd);
3447         return -1;
3448       }
3449     } else {
3450       ::close(fd);
3451       return -1;
3452     }
3453   }
3454 
3455   // All file descriptors that are opened in the JVM and not
3456   // specifically destined for a subprocess should have the
3457   // close-on-exec flag set.  If we don&#39;t set it, then careless 3rd
3458   // party native code might fork and exec without closing all
3459   // appropriate file descriptors (e.g. as we do in closeDescriptors in
3460   // UNIXProcess.c), and this in turn might:
3461   //
3462   // - cause end-of-file to fail to be detected on some file
3463   //   descriptors, resulting in mysterious hangs, or
3464   //
3465   // - might cause an fopen in the subprocess to fail on a system
3466   //   suffering from bug 1085341.
3467   //
3468   // (Yes, the default setting of the close-on-exec flag is a Unix
3469   // design flaw)
3470   //
3471   // See:
3472   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
3473   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
3474   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
3475   //
3476 #ifdef FD_CLOEXEC
3477   {
3478     int flags = ::fcntl(fd, F_GETFD);
3479     if (flags != -1) {
3480       ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
3481     }
3482   }
3483 #endif
3484 
3485   return fd;
3486 }
3487 
3488 
3489 // create binary file, rewriting existing file if required
3490 int os::create_binary_file(const char* path, bool rewrite_existing) {
3491   int oflags = O_WRONLY | O_CREAT;
3492   if (!rewrite_existing) {
3493     oflags |= O_EXCL;
3494   }
3495   return ::open(path, oflags, S_IREAD | S_IWRITE);
3496 }
3497 
3498 // return current position of file pointer
3499 jlong os::current_file_offset(int fd) {
3500   return (jlong)::lseek(fd, (off_t)0, SEEK_CUR);
3501 }
3502 
3503 // move file pointer to the specified offset
3504 jlong os::seek_to_file_offset(int fd, jlong offset) {
3505   return (jlong)::lseek(fd, (off_t)offset, SEEK_SET);
3506 }
3507 
3508 // This code originates from JDK&#39;s sysAvailable
3509 // from src/solaris/hpi/src/native_threads/src/sys_api_td.c
3510 
3511 int os::available(int fd, jlong *bytes) {
3512   jlong cur, end;
3513   int mode;
3514   struct stat buf;
3515 
3516   if (::fstat(fd, &amp;buf) &gt;= 0) {
3517     mode = buf.st_mode;
3518     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
3519       int n;
3520       if (::ioctl(fd, FIONREAD, &amp;n) &gt;= 0) {
3521         *bytes = n;
3522         return 1;
3523       }
3524     }
3525   }
3526   if ((cur = ::lseek(fd, 0L, SEEK_CUR)) == -1) {
3527     return 0;
3528   } else if ((end = ::lseek(fd, 0L, SEEK_END)) == -1) {
3529     return 0;
3530   } else if (::lseek(fd, cur, SEEK_SET) == -1) {
3531     return 0;
3532   }
3533   *bytes = end - cur;
3534   return 1;
3535 }
3536 
3537 // Map a block of memory.
3538 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
3539                         char *addr, size_t bytes, bool read_only,
3540                         bool allow_exec) {
3541   int prot;
3542   int flags;
3543 
3544   if (read_only) {
3545     prot = PROT_READ;
3546     flags = MAP_SHARED;
3547   } else {
3548     prot = PROT_READ | PROT_WRITE;
3549     flags = MAP_PRIVATE;
3550   }
3551 
3552   if (allow_exec) {
3553     prot |= PROT_EXEC;
3554   }
3555 
3556   if (addr != NULL) {
3557     flags |= MAP_FIXED;
3558   }
3559 
3560   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
3561                                      fd, file_offset);
3562   if (mapped_address == MAP_FAILED) {
3563     return NULL;
3564   }
3565   return mapped_address;
3566 }
3567 
3568 
3569 // Remap a block of memory.
3570 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
3571                           char *addr, size_t bytes, bool read_only,
3572                           bool allow_exec) {
3573   // same as map_memory() on this OS
3574   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
3575                         allow_exec);
3576 }
3577 
3578 
3579 // Unmap a block of memory.
3580 bool os::pd_unmap_memory(char* addr, size_t bytes) {
3581   return munmap(addr, bytes) == 0;
3582 }
3583 
3584 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
3585 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
3586 // of a thread.
3587 //
3588 // current_thread_cpu_time() and thread_cpu_time(Thread*) returns
3589 // the fast estimate available on the platform.
3590 
3591 jlong os::current_thread_cpu_time() {
3592 #ifdef __APPLE__
3593   return os::thread_cpu_time(Thread::current(), true /* user + sys */);
3594 #else
3595   Unimplemented();
3596   return 0;
3597 #endif
3598 }
3599 
3600 jlong os::thread_cpu_time(Thread* thread) {
3601 #ifdef __APPLE__
3602   return os::thread_cpu_time(thread, true /* user + sys */);
3603 #else
3604   Unimplemented();
3605   return 0;
3606 #endif
3607 }
3608 
3609 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
3610 #ifdef __APPLE__
3611   return os::thread_cpu_time(Thread::current(), user_sys_cpu_time);
3612 #else
3613   Unimplemented();
3614   return 0;
3615 #endif
3616 }
3617 
3618 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
3619 #ifdef __APPLE__
3620   struct thread_basic_info tinfo;
3621   mach_msg_type_number_t tcount = THREAD_INFO_MAX;
3622   kern_return_t kr;
3623   thread_t mach_thread;
3624 
3625   mach_thread = thread-&gt;osthread()-&gt;thread_id();
3626   kr = thread_info(mach_thread, THREAD_BASIC_INFO, (thread_info_t)&amp;tinfo, &amp;tcount);
3627   if (kr != KERN_SUCCESS) {
3628     return -1;
3629   }
3630 
3631   if (user_sys_cpu_time) {
3632     jlong nanos;
3633     nanos = ((jlong) tinfo.system_time.seconds + tinfo.user_time.seconds) * (jlong)1000000000;
3634     nanos += ((jlong) tinfo.system_time.microseconds + (jlong) tinfo.user_time.microseconds) * (jlong)1000;
3635     return nanos;
3636   } else {
3637     return ((jlong)tinfo.user_time.seconds * 1000000000) + ((jlong)tinfo.user_time.microseconds * (jlong)1000);
3638   }
3639 #else
3640   Unimplemented();
3641   return 0;
3642 #endif
3643 }
3644 
3645 
3646 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
3647   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
3648   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
3649   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
3650   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
3651 }
3652 
3653 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
3654   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
3655   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
3656   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
3657   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
3658 }
3659 
3660 bool os::is_thread_cpu_time_supported() {
3661 #ifdef __APPLE__
3662   return true;
3663 #else
3664   return false;
3665 #endif
3666 }
3667 
3668 // System loadavg support.  Returns -1 if load average cannot be obtained.
3669 // Bsd doesn&#39;t yet have a (official) notion of processor sets,
3670 // so just return the system wide load average.
3671 int os::loadavg(double loadavg[], int nelem) {
3672   return ::getloadavg(loadavg, nelem);
3673 }
3674 
3675 void os::pause() {
3676   char filename[MAX_PATH];
3677   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
3678     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
3679   } else {
3680     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
3681   }
3682 
3683   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
3684   if (fd != -1) {
3685     struct stat buf;
3686     ::close(fd);
3687     while (::stat(filename, &amp;buf) == 0) {
3688       (void)::poll(NULL, 0, 100);
3689     }
3690   } else {
3691     jio_fprintf(stderr,
3692                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
3693   }
3694 }
3695 
3696 // Darwin has no &quot;environ&quot; in a dynamic library.
3697 #ifdef __APPLE__
3698   #include &lt;crt_externs.h&gt;
3699   #define environ (*_NSGetEnviron())
3700 #else
3701 extern char** environ;
3702 #endif
3703 
3704 // Run the specified command in a separate process. Return its exit value,
3705 // or -1 on failure (e.g. can&#39;t fork a new process).
3706 // Unlike system(), this function can be called from signal handler. It
3707 // doesn&#39;t block SIGINT et al.
3708 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
3709   const char * argv[4] = {&quot;sh&quot;, &quot;-c&quot;, cmd, NULL};
3710 
3711   // fork() in BsdThreads/NPTL is not async-safe. It needs to run
3712   // pthread_atfork handlers and reset pthread library. All we need is a
3713   // separate process to execve. Make a direct syscall to fork process.
3714   // On IA64 there&#39;s no fork syscall, we have to use fork() and hope for
3715   // the best...
3716   pid_t pid = fork();
3717 
3718   if (pid &lt; 0) {
3719     // fork failed
3720     return -1;
3721 
3722   } else if (pid == 0) {
3723     // child process
3724 
3725     // execve() in BsdThreads will call pthread_kill_other_threads_np()
3726     // first to kill every thread on the thread list. Because this list is
3727     // not reset by fork() (see notes above), execve() will instead kill
3728     // every thread in the parent process. We know this is the only thread
3729     // in the new process, so make a system call directly.
3730     // IA64 should use normal execve() from glibc to match the glibc fork()
3731     // above.
3732     execve(&quot;/bin/sh&quot;, (char* const*)argv, environ);
3733 
3734     // execve failed
3735     _exit(-1);
3736 
3737   } else  {
3738     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
3739     // care about the actual exit code, for now.
3740 
3741     int status;
3742 
3743     // Wait for the child process to exit.  This returns immediately if
3744     // the child has already exited. */
3745     while (waitpid(pid, &amp;status, 0) &lt; 0) {
3746       switch (errno) {
3747       case ECHILD: return 0;
3748       case EINTR: break;
3749       default: return -1;
3750       }
3751     }
3752 
3753     if (WIFEXITED(status)) {
3754       // The child exited normally; get its exit code.
3755       return WEXITSTATUS(status);
3756     } else if (WIFSIGNALED(status)) {
3757       // The child exited because of a signal
3758       // The best value to return is 0x80 + signal number,
3759       // because that is what all Unix shells do, and because
3760       // it allows callers to distinguish between process exit and
3761       // process death by signal.
3762       return 0x80 + WTERMSIG(status);
3763     } else {
3764       // Unknown exit code; pass it through
3765       return status;
3766     }
3767   }
3768 }
3769 
3770 // Get the kern.corefile setting, or otherwise the default path to the core file
3771 // Returns the length of the string
3772 int os::get_core_path(char* buffer, size_t bufferSize) {
3773   int n = 0;
3774 #ifdef __APPLE__
3775   char coreinfo[MAX_PATH];
3776   size_t sz = sizeof(coreinfo);
3777   int ret = sysctlbyname(&quot;kern.corefile&quot;, coreinfo, &amp;sz, NULL, 0);
3778   if (ret == 0) {
3779     char *pid_pos = strstr(coreinfo, &quot;%P&quot;);
3780     // skip over the &quot;%P&quot; to preserve any optional custom user pattern
3781     const char* tail = (pid_pos != NULL) ? (pid_pos + 2) : &quot;&quot;;
3782 
3783     if (pid_pos != NULL) {
3784       *pid_pos = &#39;\0&#39;;
3785       n = jio_snprintf(buffer, bufferSize, &quot;%s%d%s&quot;, coreinfo, os::current_process_id(), tail);
3786     } else {
3787       n = jio_snprintf(buffer, bufferSize, &quot;%s&quot;, coreinfo);
3788     }
3789   } else
3790 #endif
3791   {
3792     n = jio_snprintf(buffer, bufferSize, &quot;/cores/core.%d&quot;, os::current_process_id());
3793   }
3794   // Truncate if theoretical string was longer than bufferSize
3795   n = MIN2(n, (int)bufferSize);
3796 
3797   return n;
3798 }
3799 
3800 bool os::supports_map_sync() {
3801   return false;
3802 }
3803 
3804 #ifndef PRODUCT
3805 void TestReserveMemorySpecial_test() {
3806   // No tests available for this platform
3807 }
3808 #endif
3809 
3810 bool os::start_debugging(char *buf, int buflen) {
3811   int len = (int)strlen(buf);
3812   char *p = &amp;buf[len];
3813 
3814   jio_snprintf(p, buflen-len,
3815              &quot;\n\n&quot;
3816              &quot;Do you want to debug the problem?\n\n&quot;
3817              &quot;To debug, run &#39;gdb /proc/%d/exe %d&#39;; then switch to thread &quot; INTX_FORMAT &quot; (&quot; INTPTR_FORMAT &quot;)\n&quot;
3818              &quot;Enter &#39;yes&#39; to launch gdb automatically (PATH must include gdb)\n&quot;
3819              &quot;Otherwise, press RETURN to abort...&quot;,
3820              os::current_process_id(), os::current_process_id(),
3821              os::current_thread_id(), os::current_thread_id());
3822 
3823   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
3824 
3825   if (yes) {
3826     // yes, user asked VM to launch debugger
3827     jio_snprintf(buf, sizeof(buf), &quot;gdb /proc/%d/exe %d&quot;,
3828                      os::current_process_id(), os::current_process_id());
3829 
3830     os::fork_and_exec(buf);
3831     yes = false;
3832   }
3833   return yes;
3834 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>