<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/compiler/tieredThresholdPolicy.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2010, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;compiler/compileBroker.hpp&quot;
  27 #include &quot;compiler/compilerOracle.hpp&quot;
  28 #include &quot;compiler/tieredThresholdPolicy.hpp&quot;
  29 #include &quot;memory/resourceArea.hpp&quot;
  30 #include &quot;runtime/arguments.hpp&quot;
  31 #include &quot;runtime/frame.inline.hpp&quot;
  32 #include &quot;runtime/handles.inline.hpp&quot;
  33 #include &quot;runtime/safepoint.hpp&quot;
  34 #include &quot;runtime/safepointVerifiers.hpp&quot;
  35 #include &quot;code/scopeDesc.hpp&quot;
  36 #include &quot;oops/method.inline.hpp&quot;
  37 #if INCLUDE_JVMCI
  38 #include &quot;jvmci/jvmci.hpp&quot;
  39 #endif
  40 
  41 #ifdef TIERED
  42 
  43 #include &quot;c1/c1_Compiler.hpp&quot;
  44 #include &quot;opto/c2compiler.hpp&quot;
  45 
  46 bool TieredThresholdPolicy::call_predicate_helper(const methodHandle&amp; method, CompLevel cur_level, int i, int b, double scale) {
  47   double threshold_scaling;
  48   if (CompilerOracle::has_option_value(method, &quot;CompileThresholdScaling&quot;, threshold_scaling)) {
  49     scale *= threshold_scaling;
  50   }
  51   switch(cur_level) {
  52   case CompLevel_aot:
  53     if (CompilationModeFlag::disable_intermediate()) {
  54       return (i &gt;= Tier0AOTInvocationThreshold * scale) ||
  55              (i &gt;= Tier0AOTMinInvocationThreshold * scale &amp;&amp; i + b &gt;= Tier0AOTCompileThreshold * scale);
  56     } else {
  57       return (i &gt;= Tier3AOTInvocationThreshold * scale) ||
  58              (i &gt;= Tier3AOTMinInvocationThreshold * scale &amp;&amp; i + b &gt;= Tier3AOTCompileThreshold * scale);
  59     }
  60   case CompLevel_none:
  61     if (CompilationModeFlag::disable_intermediate()) {
  62       return (i &gt;= Tier40InvocationThreshold * scale) ||
  63              (i &gt;= Tier40MinInvocationThreshold * scale &amp;&amp; i + b &gt;= Tier40CompileThreshold * scale);
  64     }
  65     // Fall through
  66   case CompLevel_limited_profile:
  67     return (i &gt;= Tier3InvocationThreshold * scale) ||
  68            (i &gt;= Tier3MinInvocationThreshold * scale &amp;&amp; i + b &gt;= Tier3CompileThreshold * scale);
  69   case CompLevel_full_profile:
  70    return (i &gt;= Tier4InvocationThreshold * scale) ||
  71           (i &gt;= Tier4MinInvocationThreshold * scale &amp;&amp; i + b &gt;= Tier4CompileThreshold * scale);
  72   default:
  73    return true;
  74   }
  75 }
  76 
  77 bool TieredThresholdPolicy::loop_predicate_helper(const methodHandle&amp; method, CompLevel cur_level, int i, int b, double scale) {
  78   double threshold_scaling;
  79   if (CompilerOracle::has_option_value(method, &quot;CompileThresholdScaling&quot;, threshold_scaling)) {
  80     scale *= threshold_scaling;
  81   }
  82   switch(cur_level) {
  83   case CompLevel_aot:
  84     if (CompilationModeFlag::disable_intermediate()) {
  85       return b &gt;= Tier0AOTBackEdgeThreshold * scale;
  86     } else {
  87       return b &gt;= Tier3AOTBackEdgeThreshold * scale;
  88     }
  89   case CompLevel_none:
  90     if (CompilationModeFlag::disable_intermediate()) {
  91       return b &gt;= Tier40BackEdgeThreshold * scale;
  92     }
  93     // Fall through
  94   case CompLevel_limited_profile:
  95     return b &gt;= Tier3BackEdgeThreshold * scale;
  96   case CompLevel_full_profile:
  97     return b &gt;= Tier4BackEdgeThreshold * scale;
  98   default:
  99     return true;
 100   }
 101 }
 102 
 103 // Simple methods are as good being compiled with C1 as C2.
 104 // Determine if a given method is such a case.
 105 bool TieredThresholdPolicy::is_trivial(Method* method) {
 106   if (method-&gt;is_accessor() ||
 107       method-&gt;is_constant_getter()) {
 108     return true;
 109   }
 110   return false;
 111 }
 112 
 113 bool TieredThresholdPolicy::force_comp_at_level_simple(const methodHandle&amp; method) {
 114   if (CompilationModeFlag::quick_internal()) {
 115 #if INCLUDE_JVMCI
 116     if (UseJVMCICompiler) {
 117       AbstractCompiler* comp = CompileBroker::compiler(CompLevel_full_optimization);
 118       if (comp != NULL &amp;&amp; comp-&gt;is_jvmci() &amp;&amp; ((JVMCICompiler*) comp)-&gt;force_comp_at_level_simple(method)) {
 119         return true;
 120       }
 121     }
 122 #endif
 123   }
 124   return false;
 125 }
 126 
 127 CompLevel TieredThresholdPolicy::comp_level(Method* method) {
 128   CompiledMethod *nm = method-&gt;code();
 129   if (nm != NULL &amp;&amp; nm-&gt;is_in_use()) {
 130     return (CompLevel)nm-&gt;comp_level();
 131   }
 132   return CompLevel_none;
 133 }
 134 
 135 void TieredThresholdPolicy::print_counters(const char* prefix, Method* m) {
 136   int invocation_count = m-&gt;invocation_count();
 137   int backedge_count = m-&gt;backedge_count();
 138   MethodData* mdh = m-&gt;method_data();
 139   int mdo_invocations = 0, mdo_backedges = 0;
 140   int mdo_invocations_start = 0, mdo_backedges_start = 0;
 141   if (mdh != NULL) {
 142     mdo_invocations = mdh-&gt;invocation_count();
 143     mdo_backedges = mdh-&gt;backedge_count();
 144     mdo_invocations_start = mdh-&gt;invocation_count_start();
 145     mdo_backedges_start = mdh-&gt;backedge_count_start();
 146   }
 147   tty-&gt;print(&quot; %stotal=%d,%d %smdo=%d(%d),%d(%d)&quot;, prefix,
 148       invocation_count, backedge_count, prefix,
 149       mdo_invocations, mdo_invocations_start,
 150       mdo_backedges, mdo_backedges_start);
 151   tty-&gt;print(&quot; %smax levels=%d,%d&quot;, prefix,
 152       m-&gt;highest_comp_level(), m-&gt;highest_osr_comp_level());
 153 }
 154 
 155 // Print an event.
 156 void TieredThresholdPolicy::print_event(EventType type, Method* m, Method* im,
 157                                         int bci, CompLevel level) {
 158   bool inlinee_event = m != im;
 159 
 160   ttyLocker tty_lock;
 161   tty-&gt;print(&quot;%lf: [&quot;, os::elapsedTime());
 162 
 163   switch(type) {
 164   case CALL:
 165     tty-&gt;print(&quot;call&quot;);
 166     break;
 167   case LOOP:
 168     tty-&gt;print(&quot;loop&quot;);
 169     break;
 170   case COMPILE:
 171     tty-&gt;print(&quot;compile&quot;);
 172     break;
 173   case REMOVE_FROM_QUEUE:
 174     tty-&gt;print(&quot;remove-from-queue&quot;);
 175     break;
 176   case UPDATE_IN_QUEUE:
 177     tty-&gt;print(&quot;update-in-queue&quot;);
 178     break;
 179   case REPROFILE:
 180     tty-&gt;print(&quot;reprofile&quot;);
 181     break;
 182   case MAKE_NOT_ENTRANT:
 183     tty-&gt;print(&quot;make-not-entrant&quot;);
 184     break;
 185   default:
 186     tty-&gt;print(&quot;unknown&quot;);
 187   }
 188 
 189   tty-&gt;print(&quot; level=%d &quot;, level);
 190 
 191   ResourceMark rm;
 192   char *method_name = m-&gt;name_and_sig_as_C_string();
 193   tty-&gt;print(&quot;[%s&quot;, method_name);
 194   if (inlinee_event) {
 195     char *inlinee_name = im-&gt;name_and_sig_as_C_string();
 196     tty-&gt;print(&quot; [%s]] &quot;, inlinee_name);
 197   }
 198   else tty-&gt;print(&quot;] &quot;);
 199   tty-&gt;print(&quot;@%d queues=%d,%d&quot;, bci, CompileBroker::queue_size(CompLevel_full_profile),
 200                                       CompileBroker::queue_size(CompLevel_full_optimization));
 201 
 202   tty-&gt;print(&quot; rate=&quot;);
 203   if (m-&gt;prev_time() == 0) tty-&gt;print(&quot;n/a&quot;);
 204   else tty-&gt;print(&quot;%f&quot;, m-&gt;rate());
 205 
 206   tty-&gt;print(&quot; k=%.2lf,%.2lf&quot;, threshold_scale(CompLevel_full_profile, Tier3LoadFeedback),
 207                                threshold_scale(CompLevel_full_optimization, Tier4LoadFeedback));
 208 
 209   if (type != COMPILE) {
 210     print_counters(&quot;&quot;, m);
 211     if (inlinee_event) {
 212       print_counters(&quot;inlinee &quot;, im);
 213     }
 214     tty-&gt;print(&quot; compilable=&quot;);
 215     bool need_comma = false;
 216     if (!m-&gt;is_not_compilable(CompLevel_full_profile)) {
 217       tty-&gt;print(&quot;c1&quot;);
 218       need_comma = true;
 219     }
 220     if (!m-&gt;is_not_osr_compilable(CompLevel_full_profile)) {
 221       if (need_comma) tty-&gt;print(&quot;,&quot;);
 222       tty-&gt;print(&quot;c1-osr&quot;);
 223       need_comma = true;
 224     }
 225     if (!m-&gt;is_not_compilable(CompLevel_full_optimization)) {
 226       if (need_comma) tty-&gt;print(&quot;,&quot;);
 227       tty-&gt;print(&quot;c2&quot;);
 228       need_comma = true;
 229     }
 230     if (!m-&gt;is_not_osr_compilable(CompLevel_full_optimization)) {
 231       if (need_comma) tty-&gt;print(&quot;,&quot;);
 232       tty-&gt;print(&quot;c2-osr&quot;);
 233     }
 234     tty-&gt;print(&quot; status=&quot;);
 235     if (m-&gt;queued_for_compilation()) {
 236       tty-&gt;print(&quot;in-queue&quot;);
 237     } else tty-&gt;print(&quot;idle&quot;);
 238   }
 239   tty-&gt;print_cr(&quot;]&quot;);
 240 }
 241 
 242 
 243 void TieredThresholdPolicy::initialize() {
 244   int count = CICompilerCount;
 245   bool c1_only = TieredStopAtLevel &lt; CompLevel_full_optimization || CompilationModeFlag::quick_only();
 246   bool c2_only = CompilationModeFlag::high_only();
 247 #ifdef _LP64
 248   // Turn on ergonomic compiler count selection
 249   if (FLAG_IS_DEFAULT(CICompilerCountPerCPU) &amp;&amp; FLAG_IS_DEFAULT(CICompilerCount)) {
 250     FLAG_SET_DEFAULT(CICompilerCountPerCPU, true);
 251   }
 252   if (CICompilerCountPerCPU) {
 253     // Simple log n seems to grow too slowly for tiered, try something faster: log n * log log n
 254     int log_cpu = log2_int(os::active_processor_count());
 255     int loglog_cpu = log2_int(MAX2(log_cpu, 1));
 256     count = MAX2(log_cpu * loglog_cpu * 3 / 2, 2);
 257     // Make sure there is enough space in the code cache to hold all the compiler buffers
 258     size_t c1_size = Compiler::code_buffer_size();
 259     size_t c2_size = C2Compiler::initial_code_buffer_size();
 260     size_t buffer_size = c1_only ? c1_size : (c1_size/3 + 2*c2_size/3);
 261     int max_count = (ReservedCodeCacheSize - (CodeCacheMinimumUseSpace DEBUG_ONLY(* 3))) / (int)buffer_size;
 262     if (count &gt; max_count) {
 263       // Lower the compiler count such that all buffers fit into the code cache
 264       count = MAX2(max_count, c1_only ? 1 : 2);
 265     }
 266     FLAG_SET_ERGO(CICompilerCount, count);
 267   }
 268 #else
 269   // On 32-bit systems, the number of compiler threads is limited to 3.
 270   // On these systems, the virtual address space available to the JVM
 271   // is usually limited to 2-4 GB (the exact value depends on the platform).
 272   // As the compilers (especially C2) can consume a large amount of
 273   // memory, scaling the number of compiler threads with the number of
 274   // available cores can result in the exhaustion of the address space
 275   /// available to the VM and thus cause the VM to crash.
 276   if (FLAG_IS_DEFAULT(CICompilerCount)) {
 277     count = 3;
 278     FLAG_SET_ERGO(CICompilerCount, count);
 279   }
 280 #endif
 281 
 282   if (c1_only) {
 283     // No C2 compiler thread required
 284     set_c1_count(count);
 285   } else if (c2_only) {
 286     set_c2_count(count);
 287   } else {
 288     set_c1_count(MAX2(count / 3, 1));
 289     set_c2_count(MAX2(count - c1_count(), 1));
 290   }
 291   assert(count == c1_count() + c2_count(), &quot;inconsistent compiler thread count&quot;);
 292 
 293   // Some inlining tuning
 294 #ifdef X86
 295   if (FLAG_IS_DEFAULT(InlineSmallCode)) {
 296     FLAG_SET_DEFAULT(InlineSmallCode, 2000);
 297   }
 298 #endif
 299 
 300 #if defined SPARC || defined AARCH64
 301   if (FLAG_IS_DEFAULT(InlineSmallCode)) {
 302     FLAG_SET_DEFAULT(InlineSmallCode, 2500);
 303   }
 304 #endif
 305 
 306   set_increase_threshold_at_ratio();
 307   set_start_time(nanos_to_millis(os::javaTimeNanos()));
 308 }
 309 
 310 
 311 #ifdef ASSERT
 312 bool TieredThresholdPolicy::verify_level(CompLevel level) {
 313   // AOT and interpreter levels are always valid.
 314   if (level == CompLevel_aot || level == CompLevel_none) {
 315     return true;
 316   }
 317   if (CompilationModeFlag::normal()) {
 318     return true;
 319   } else if (CompilationModeFlag::quick_only()) {
 320     return level == CompLevel_simple;
 321   } else if (CompilationModeFlag::high_only()) {
 322     return level == CompLevel_full_optimization;
 323   } else if (CompilationModeFlag::high_only_quick_internal()) {
 324     return level == CompLevel_full_optimization || level == CompLevel_simple;
 325   }
 326   return false;
 327 }
 328 #endif
 329 
 330 
 331 CompLevel TieredThresholdPolicy::limit_level(CompLevel level) {
 332   if (CompilationModeFlag::quick_only()) {
 333     level = MIN2(level, CompLevel_simple);
 334   }
 335   assert(verify_level(level), &quot;Invalid compilation level %d&quot;, level);
 336   if (level &lt;= TieredStopAtLevel) {
 337     return level;
 338   }
 339   // Some compilation levels are not valid depending on a compilation mode:
 340   // a) quick_only - levels 2,3,4 are invalid; levels -1,0,1 are valid;
 341   // b) high_only - levels 1,2,3 are invalid; levels -1,0,4 are valid;
 342   // c) high_only_quick_internal - levels 2,3 are invalid; levels -1,0,1,4 are valid.
 343   // The invalid levels are actually sequential so a single comparison is sufficient.
 344   // Down here we already have (level &gt; TieredStopAtLevel), which also implies that
 345   // (TieredStopAtLevel &lt; Highest Possible Level), so we need to return a level that is:
 346   // a) a max level that is strictly less than the highest for a given compilation mode
 347   // b) less or equal to TieredStopAtLevel
 348   if (CompilationModeFlag::normal() || CompilationModeFlag::quick_only()) {
 349     return (CompLevel)TieredStopAtLevel;
 350   }
 351 
 352   if (CompilationModeFlag::high_only() || CompilationModeFlag::high_only_quick_internal()) {
 353     return MIN2(CompLevel_none, (CompLevel)TieredStopAtLevel);
 354   }
 355 
 356   ShouldNotReachHere();
 357   return CompLevel_any;
 358 }
 359 
 360 CompLevel TieredThresholdPolicy::initial_compile_level_helper(const methodHandle&amp; method) {
 361   if (CompilationModeFlag::normal()) {
 362     return CompLevel_full_profile;
 363   } else if (CompilationModeFlag::quick_only()) {
 364     return CompLevel_simple;
 365   } else if (CompilationModeFlag::high_only()) {
 366     return CompLevel_full_optimization;
 367   } else if (CompilationModeFlag::high_only_quick_internal()) {
 368     if (force_comp_at_level_simple(method)) {
 369       return CompLevel_simple;
 370     } else {
 371       return CompLevel_full_optimization;
 372     }
 373   }
 374   ShouldNotReachHere();
 375   return CompLevel_any;
 376 }
 377 
 378 CompLevel TieredThresholdPolicy::initial_compile_level(const methodHandle&amp; method) {
 379   return limit_level(initial_compile_level_helper(method));
 380 }
 381 
<a name="1" id="anc1"></a><span class="line-removed"> 382 void TieredThresholdPolicy::set_carry_if_necessary(InvocationCounter *counter) {</span>
<span class="line-removed"> 383   if (!counter-&gt;carry() &amp;&amp; counter-&gt;count() &gt; InvocationCounter::count_limit / 2) {</span>
<span class="line-removed"> 384     counter-&gt;set_carry_flag();</span>
<span class="line-removed"> 385   }</span>
<span class="line-removed"> 386 }</span>
<span class="line-removed"> 387 </span>
 388 // Set carry flags on the counters if necessary
 389 void TieredThresholdPolicy::handle_counter_overflow(Method* method) {
 390   MethodCounters *mcs = method-&gt;method_counters();
 391   if (mcs != NULL) {
<a name="2" id="anc2"></a><span class="line-modified"> 392     set_carry_if_necessary(mcs-&gt;invocation_counter());</span>
<span class="line-modified"> 393     set_carry_if_necessary(mcs-&gt;backedge_counter());</span>
 394   }
 395   MethodData* mdo = method-&gt;method_data();
 396   if (mdo != NULL) {
<a name="3" id="anc3"></a><span class="line-modified"> 397     set_carry_if_necessary(mdo-&gt;invocation_counter());</span>
<span class="line-modified"> 398     set_carry_if_necessary(mdo-&gt;backedge_counter());</span>
 399   }
 400 }
 401 
 402 // Called with the queue locked and with at least one element
 403 CompileTask* TieredThresholdPolicy::select_task(CompileQueue* compile_queue) {
 404   CompileTask *max_blocking_task = NULL;
 405   CompileTask *max_task = NULL;
 406   Method* max_method = NULL;
 407   jlong t = nanos_to_millis(os::javaTimeNanos());
 408   // Iterate through the queue and find a method with a maximum rate.
 409   for (CompileTask* task = compile_queue-&gt;first(); task != NULL;) {
 410     CompileTask* next_task = task-&gt;next();
 411     Method* method = task-&gt;method();
 412     // If a method was unloaded or has been stale for some time, remove it from the queue.
 413     // Blocking tasks and tasks submitted from whitebox API don&#39;t become stale
 414     if (task-&gt;is_unloaded() || (task-&gt;can_become_stale() &amp;&amp; is_stale(t, TieredCompileTaskTimeout, method) &amp;&amp; !is_old(method))) {
 415       if (!task-&gt;is_unloaded()) {
 416         if (PrintTieredEvents) {
 417           print_event(REMOVE_FROM_QUEUE, method, method, task-&gt;osr_bci(), (CompLevel) task-&gt;comp_level());
 418         }
 419         method-&gt;clear_queued_for_compilation();
 420       }
 421       compile_queue-&gt;remove_and_mark_stale(task);
 422       task = next_task;
 423       continue;
 424     }
 425     update_rate(t, method);
 426     if (max_task == NULL || compare_methods(method, max_method)) {
 427       // Select a method with the highest rate
 428       max_task = task;
 429       max_method = method;
 430     }
 431 
 432     if (task-&gt;is_blocking()) {
 433       if (max_blocking_task == NULL || compare_methods(method, max_blocking_task-&gt;method())) {
 434         max_blocking_task = task;
 435       }
 436     }
 437 
 438     task = next_task;
 439   }
 440 
 441   if (max_blocking_task != NULL) {
 442     // In blocking compilation mode, the CompileBroker will make
 443     // compilations submitted by a JVMCI compiler thread non-blocking. These
 444     // compilations should be scheduled after all blocking compilations
 445     // to service non-compiler related compilations sooner and reduce the
 446     // chance of such compilations timing out.
 447     max_task = max_blocking_task;
 448     max_method = max_task-&gt;method();
 449   }
 450 
 451   methodHandle max_method_h(Thread::current(), max_method);
 452 
 453   if (max_task != NULL &amp;&amp; max_task-&gt;comp_level() == CompLevel_full_profile &amp;&amp;
 454       TieredStopAtLevel &gt; CompLevel_full_profile &amp;&amp;
 455       max_method != NULL &amp;&amp; is_method_profiled(max_method_h)) {
 456     max_task-&gt;set_comp_level(CompLevel_limited_profile);
 457 
 458     if (CompileBroker::compilation_is_complete(max_method_h, max_task-&gt;osr_bci(), CompLevel_limited_profile)) {
 459       if (PrintTieredEvents) {
 460         print_event(REMOVE_FROM_QUEUE, max_method, max_method, max_task-&gt;osr_bci(), (CompLevel)max_task-&gt;comp_level());
 461       }
 462       compile_queue-&gt;remove_and_mark_stale(max_task);
 463       max_method-&gt;clear_queued_for_compilation();
 464       return NULL;
 465     }
 466 
 467     if (PrintTieredEvents) {
 468       print_event(UPDATE_IN_QUEUE, max_method, max_method, max_task-&gt;osr_bci(), (CompLevel)max_task-&gt;comp_level());
 469     }
 470   }
 471 
 472   return max_task;
 473 }
 474 
 475 void TieredThresholdPolicy::reprofile(ScopeDesc* trap_scope, bool is_osr) {
 476   for (ScopeDesc* sd = trap_scope;; sd = sd-&gt;sender()) {
 477     if (PrintTieredEvents) {
 478       print_event(REPROFILE, sd-&gt;method(), sd-&gt;method(), InvocationEntryBci, CompLevel_none);
 479     }
 480     MethodData* mdo = sd-&gt;method()-&gt;method_data();
 481     if (mdo != NULL) {
 482       mdo-&gt;reset_start_counters();
 483     }
 484     if (sd-&gt;is_top()) break;
 485   }
 486 }
 487 
 488 nmethod* TieredThresholdPolicy::event(const methodHandle&amp; method, const methodHandle&amp; inlinee,
 489                                       int branch_bci, int bci, CompLevel comp_level, CompiledMethod* nm, JavaThread* thread) {
 490   if (comp_level == CompLevel_none &amp;&amp;
 491       JvmtiExport::can_post_interpreter_events() &amp;&amp;
 492       thread-&gt;is_interp_only_mode()) {
 493     return NULL;
 494   }
 495   if (ReplayCompiles) {
 496     // Don&#39;t trigger other compiles in testing mode
 497     return NULL;
 498   }
 499 
 500   handle_counter_overflow(method());
 501   if (method() != inlinee()) {
 502     handle_counter_overflow(inlinee());
 503   }
 504 
 505   if (PrintTieredEvents) {
 506     print_event(bci == InvocationEntryBci ? CALL : LOOP, method(), inlinee(), bci, comp_level);
 507   }
 508 
 509   if (bci == InvocationEntryBci) {
 510     method_invocation_event(method, inlinee, comp_level, nm, thread);
 511   } else {
 512     // method == inlinee if the event originated in the main method
 513     method_back_branch_event(method, inlinee, bci, comp_level, nm, thread);
 514     // Check if event led to a higher level OSR compilation
 515     CompLevel expected_comp_level = comp_level;
 516     if (!CompilationModeFlag::disable_intermediate() &amp;&amp; inlinee-&gt;is_not_osr_compilable(expected_comp_level)) {
 517       // It&#39;s not possble to reach the expected level so fall back to simple.
 518       expected_comp_level = CompLevel_simple;
 519     }
 520     nmethod* osr_nm = inlinee-&gt;lookup_osr_nmethod_for(bci, expected_comp_level, false);
 521     assert(osr_nm == NULL || osr_nm-&gt;comp_level() &gt;= expected_comp_level, &quot;lookup_osr_nmethod_for is broken&quot;);
 522     if (osr_nm != NULL) {
 523       // Perform OSR with new nmethod
 524       return osr_nm;
 525     }
 526   }
 527   return NULL;
 528 }
 529 
 530 // Check if the method can be compiled, change level if necessary
 531 void TieredThresholdPolicy::compile(const methodHandle&amp; mh, int bci, CompLevel level, JavaThread* thread) {
 532   assert(verify_level(level) &amp;&amp; level &lt;= TieredStopAtLevel, &quot;Invalid compilation level %d&quot;, level);
 533 
 534   if (level == CompLevel_none) {
 535     if (mh-&gt;has_compiled_code()) {
 536       // Happens when we switch from AOT to interpreter to profile.
 537       MutexLocker ml(Compile_lock);
 538       NoSafepointVerifier nsv;
 539       if (mh-&gt;has_compiled_code()) {
 540         mh-&gt;code()-&gt;make_not_used();
 541       }
 542       // Deoptimize immediately (we don&#39;t have to wait for a compile).
 543       RegisterMap map(thread, false);
 544       frame fr = thread-&gt;last_frame().sender(&amp;map);
 545       Deoptimization::deoptimize_frame(thread, fr.id());
 546     }
 547     return;
 548   }
 549   if (level == CompLevel_aot) {
 550     if (mh-&gt;has_aot_code()) {
 551       if (PrintTieredEvents) {
 552         print_event(COMPILE, mh(), mh(), bci, level);
 553       }
 554       MutexLocker ml(Compile_lock);
 555       NoSafepointVerifier nsv;
 556       if (mh-&gt;has_aot_code() &amp;&amp; mh-&gt;code() != mh-&gt;aot_code()) {
 557         mh-&gt;aot_code()-&gt;make_entrant();
 558         if (mh-&gt;has_compiled_code()) {
 559           mh-&gt;code()-&gt;make_not_entrant();
 560         }
 561         MutexLocker pl(CompiledMethod_lock, Mutex::_no_safepoint_check_flag);
 562         Method::set_code(mh, mh-&gt;aot_code());
 563       }
 564     }
 565     return;
 566   }
 567 
 568   if (!CompilationModeFlag::disable_intermediate()) {
 569     // Check if the method can be compiled. If it cannot be compiled with C1, continue profiling
 570     // in the interpreter and then compile with C2 (the transition function will request that,
 571     // see common() ). If the method cannot be compiled with C2 but still can with C1, compile it with
 572     // pure C1.
 573     if ((bci == InvocationEntryBci &amp;&amp; !can_be_compiled(mh, level))) {
 574       if (level == CompLevel_full_optimization &amp;&amp; can_be_compiled(mh, CompLevel_simple)) {
 575         compile(mh, bci, CompLevel_simple, thread);
 576       }
 577       return;
 578     }
 579     if ((bci != InvocationEntryBci &amp;&amp; !can_be_osr_compiled(mh, level))) {
 580       if (level == CompLevel_full_optimization &amp;&amp; can_be_osr_compiled(mh, CompLevel_simple)) {
 581         nmethod* osr_nm = mh-&gt;lookup_osr_nmethod_for(bci, CompLevel_simple, false);
 582         if (osr_nm != NULL &amp;&amp; osr_nm-&gt;comp_level() &gt; CompLevel_simple) {
 583           // Invalidate the existing OSR nmethod so that a compile at CompLevel_simple is permitted.
 584           osr_nm-&gt;make_not_entrant();
 585         }
 586         compile(mh, bci, CompLevel_simple, thread);
 587       }
 588       return;
 589     }
 590   }
 591   if (bci != InvocationEntryBci &amp;&amp; mh-&gt;is_not_osr_compilable(level)) {
 592     return;
 593   }
 594   if (!CompileBroker::compilation_is_in_queue(mh)) {
 595     if (PrintTieredEvents) {
 596       print_event(COMPILE, mh(), mh(), bci, level);
 597     }
 598     int hot_count = (bci == InvocationEntryBci) ? mh-&gt;invocation_count() : mh-&gt;backedge_count();
 599     update_rate(nanos_to_millis(os::javaTimeNanos()), mh());
 600     CompileBroker::compile_method(mh, bci, level, mh, hot_count, CompileTask::Reason_Tiered, thread);
 601   }
 602 }
 603 
 604 // update_rate() is called from select_task() while holding a compile queue lock.
 605 void TieredThresholdPolicy::update_rate(jlong t, Method* m) {
 606   // Skip update if counters are absent.
 607   // Can&#39;t allocate them since we are holding compile queue lock.
 608   if (m-&gt;method_counters() == NULL)  return;
 609 
 610   if (is_old(m)) {
 611     // We don&#39;t remove old methods from the queue,
 612     // so we can just zero the rate.
 613     m-&gt;set_rate(0);
 614     return;
 615   }
 616 
 617   // We don&#39;t update the rate if we&#39;ve just came out of a safepoint.
 618   // delta_s is the time since last safepoint in milliseconds.
 619   jlong delta_s = t - SafepointTracing::end_of_last_safepoint_ms();
 620   jlong delta_t = t - (m-&gt;prev_time() != 0 ? m-&gt;prev_time() : start_time()); // milliseconds since the last measurement
 621   // How many events were there since the last time?
 622   int event_count = m-&gt;invocation_count() + m-&gt;backedge_count();
 623   int delta_e = event_count - m-&gt;prev_event_count();
 624 
 625   // We should be running for at least 1ms.
 626   if (delta_s &gt;= TieredRateUpdateMinTime) {
 627     // And we must&#39;ve taken the previous point at least 1ms before.
 628     if (delta_t &gt;= TieredRateUpdateMinTime &amp;&amp; delta_e &gt; 0) {
 629       m-&gt;set_prev_time(t);
 630       m-&gt;set_prev_event_count(event_count);
 631       m-&gt;set_rate((float)delta_e / (float)delta_t); // Rate is events per millisecond
 632     } else {
 633       if (delta_t &gt; TieredRateUpdateMaxTime &amp;&amp; delta_e == 0) {
 634         // If nothing happened for 25ms, zero the rate. Don&#39;t modify prev values.
 635         m-&gt;set_rate(0);
 636       }
 637     }
 638   }
 639 }
 640 
 641 // Check if this method has been stale for a given number of milliseconds.
 642 // See select_task().
 643 bool TieredThresholdPolicy::is_stale(jlong t, jlong timeout, Method* m) {
 644   jlong delta_s = t - SafepointTracing::end_of_last_safepoint_ms();
 645   jlong delta_t = t - m-&gt;prev_time();
 646   if (delta_t &gt; timeout &amp;&amp; delta_s &gt; timeout) {
 647     int event_count = m-&gt;invocation_count() + m-&gt;backedge_count();
 648     int delta_e = event_count - m-&gt;prev_event_count();
 649     // Return true if there were no events.
 650     return delta_e == 0;
 651   }
 652   return false;
 653 }
 654 
 655 // We don&#39;t remove old methods from the compile queue even if they have
 656 // very low activity. See select_task().
 657 bool TieredThresholdPolicy::is_old(Method* method) {
 658   return method-&gt;invocation_count() &gt; 50000 || method-&gt;backedge_count() &gt; 500000;
 659 }
 660 
 661 double TieredThresholdPolicy::weight(Method* method) {
 662   return (double)(method-&gt;rate() + 1) *
 663     (method-&gt;invocation_count() + 1) * (method-&gt;backedge_count() + 1);
 664 }
 665 
 666 // Apply heuristics and return true if x should be compiled before y
 667 bool TieredThresholdPolicy::compare_methods(Method* x, Method* y) {
 668   if (x-&gt;highest_comp_level() &gt; y-&gt;highest_comp_level()) {
 669     // recompilation after deopt
 670     return true;
 671   } else
 672     if (x-&gt;highest_comp_level() == y-&gt;highest_comp_level()) {
 673       if (weight(x) &gt; weight(y)) {
 674         return true;
 675       }
 676     }
 677   return false;
 678 }
 679 
 680 // Is method profiled enough?
 681 bool TieredThresholdPolicy::is_method_profiled(const methodHandle&amp; method) {
 682   MethodData* mdo = method-&gt;method_data();
 683   if (mdo != NULL) {
 684     int i = mdo-&gt;invocation_count_delta();
 685     int b = mdo-&gt;backedge_count_delta();
 686     return call_predicate_helper(method, CompilationModeFlag::disable_intermediate() ? CompLevel_none : CompLevel_full_profile, i, b, 1);
 687   }
 688   return false;
 689 }
 690 
 691 double TieredThresholdPolicy::threshold_scale(CompLevel level, int feedback_k) {
 692   int comp_count = compiler_count(level);
 693   if (comp_count &gt; 0) {
 694     double queue_size = CompileBroker::queue_size(level);
 695     double k = queue_size / (feedback_k * comp_count) + 1;
 696 
 697     // Increase C1 compile threshold when the code cache is filled more
 698     // than specified by IncreaseFirstTierCompileThresholdAt percentage.
 699     // The main intention is to keep enough free space for C2 compiled code
 700     // to achieve peak performance if the code cache is under stress.
 701     if (!CompilationModeFlag::disable_intermediate() &amp;&amp; TieredStopAtLevel == CompLevel_full_optimization &amp;&amp; level != CompLevel_full_optimization)  {
 702       double current_reverse_free_ratio = CodeCache::reverse_free_ratio(CodeCache::get_code_blob_type(level));
 703       if (current_reverse_free_ratio &gt; _increase_threshold_at_ratio) {
 704         k *= exp(current_reverse_free_ratio - _increase_threshold_at_ratio);
 705       }
 706     }
 707     return k;
 708   }
 709   return 1;
 710 }
 711 
 712 // Call and loop predicates determine whether a transition to a higher
 713 // compilation level should be performed (pointers to predicate functions
 714 // are passed to common()).
 715 // Tier?LoadFeedback is basically a coefficient that determines of
 716 // how many methods per compiler thread can be in the queue before
 717 // the threshold values double.
 718 bool TieredThresholdPolicy::loop_predicate(int i, int b, CompLevel cur_level, const methodHandle&amp; method) {
 719   double k = 1;
 720   switch(cur_level) {
 721   case CompLevel_aot: {
 722     k = CompilationModeFlag::disable_intermediate() ? 1 : threshold_scale(CompLevel_full_profile, Tier3LoadFeedback);
 723     break;
 724   }
 725   case CompLevel_none: {
 726     if (CompilationModeFlag::disable_intermediate()) {
 727       k = threshold_scale(CompLevel_full_optimization, Tier4LoadFeedback);
 728       break;
 729     }
 730   }
 731   // Fall through
 732   case CompLevel_limited_profile: {
 733     k = threshold_scale(CompLevel_full_profile, Tier3LoadFeedback);
 734     break;
 735   }
 736   case CompLevel_full_profile: {
 737     k = threshold_scale(CompLevel_full_optimization, Tier4LoadFeedback);
 738     break;
 739   }
 740   default:
 741     return true;
 742   }
 743   return loop_predicate_helper(method, cur_level, i, b, k);
 744 }
 745 
 746 bool TieredThresholdPolicy::call_predicate(int i, int b, CompLevel cur_level, const methodHandle&amp; method) {
 747   double k = 1;
 748   switch(cur_level) {
 749   case CompLevel_aot: {
 750     k = CompilationModeFlag::disable_intermediate() ? 1 : threshold_scale(CompLevel_full_profile, Tier3LoadFeedback);
 751     break;
 752   }
 753   case CompLevel_none: {
 754     if (CompilationModeFlag::disable_intermediate()) {
 755       k = threshold_scale(CompLevel_full_optimization, Tier4LoadFeedback);
 756       break;
 757     }
 758   }
 759   // Fall through
 760   case CompLevel_limited_profile: {
 761     k = threshold_scale(CompLevel_full_profile, Tier3LoadFeedback);
 762     break;
 763   }
 764   case CompLevel_full_profile: {
 765     k = threshold_scale(CompLevel_full_optimization, Tier4LoadFeedback);
 766     break;
 767   }
 768   default:
 769     return true;
 770   }
 771   return call_predicate_helper(method, cur_level, i, b, k);
 772 }
 773 
 774 // Determine is a method is mature.
 775 bool TieredThresholdPolicy::is_mature(Method* method) {
 776   methodHandle mh(Thread::current(), method);
 777   if (is_trivial(method) || force_comp_at_level_simple(mh)) return true;
 778   MethodData* mdo = method-&gt;method_data();
 779   if (mdo != NULL) {
 780     int i = mdo-&gt;invocation_count();
 781     int b = mdo-&gt;backedge_count();
 782     double k = ProfileMaturityPercentage / 100.0;
 783     CompLevel main_profile_level = CompilationModeFlag::disable_intermediate() ? CompLevel_none : CompLevel_full_profile;
 784     return call_predicate_helper(mh, main_profile_level, i, b, k) || loop_predicate_helper(mh, main_profile_level, i, b, k);
 785   }
 786   return false;
 787 }
 788 
 789 // If a method is old enough and is still in the interpreter we would want to
 790 // start profiling without waiting for the compiled method to arrive.
 791 // We also take the load on compilers into the account.
 792 bool TieredThresholdPolicy::should_create_mdo(const methodHandle&amp; method, CompLevel cur_level) {
 793   if (cur_level != CompLevel_none || force_comp_at_level_simple(method)) {
 794     return false;
 795   }
 796   int i = method-&gt;invocation_count();
 797   int b = method-&gt;backedge_count();
 798   double k = Tier0ProfilingStartPercentage / 100.0;
 799 
 800   // If the top level compiler is not keeping up, delay profiling.
 801   if (CompileBroker::queue_size(CompLevel_full_optimization) &lt;=  (CompilationModeFlag::disable_intermediate() ? Tier0Delay : Tier3DelayOn) * compiler_count(CompLevel_full_optimization)) {
 802     return call_predicate_helper(method, CompLevel_none, i, b, k) || loop_predicate_helper(method, CompLevel_none, i, b, k);
 803   }
 804   return false;
 805 }
 806 
 807 // Inlining control: if we&#39;re compiling a profiled method with C1 and the callee
 808 // is known to have OSRed in a C2 version, don&#39;t inline it.
 809 bool TieredThresholdPolicy::should_not_inline(ciEnv* env, ciMethod* callee) {
 810   CompLevel comp_level = (CompLevel)env-&gt;comp_level();
 811   if (comp_level == CompLevel_full_profile ||
 812       comp_level == CompLevel_limited_profile) {
 813     return callee-&gt;highest_osr_comp_level() == CompLevel_full_optimization;
 814   }
 815   return false;
 816 }
 817 
 818 // Create MDO if necessary.
 819 void TieredThresholdPolicy::create_mdo(const methodHandle&amp; mh, JavaThread* THREAD) {
 820   if (mh-&gt;is_native() ||
 821       mh-&gt;is_abstract() ||
 822       mh-&gt;is_accessor() ||
 823       mh-&gt;is_constant_getter()) {
 824     return;
 825   }
 826   if (mh-&gt;method_data() == NULL) {
 827     Method::build_interpreter_method_data(mh, CHECK_AND_CLEAR);
 828   }
 829 }
 830 
 831 
 832 /*
 833  * Method states:
 834  *   0 - interpreter (CompLevel_none)
 835  *   1 - pure C1 (CompLevel_simple)
 836  *   2 - C1 with invocation and backedge counting (CompLevel_limited_profile)
 837  *   3 - C1 with full profiling (CompLevel_full_profile)
 838  *   4 - C2 or Graal (CompLevel_full_optimization)
 839  *
 840  * Common state transition patterns:
 841  * a. 0 -&gt; 3 -&gt; 4.
 842  *    The most common path. But note that even in this straightforward case
 843  *    profiling can start at level 0 and finish at level 3.
 844  *
 845  * b. 0 -&gt; 2 -&gt; 3 -&gt; 4.
 846  *    This case occurs when the load on C2 is deemed too high. So, instead of transitioning
 847  *    into state 3 directly and over-profiling while a method is in the C2 queue we transition to
 848  *    level 2 and wait until the load on C2 decreases. This path is disabled for OSRs.
 849  *
 850  * c. 0 -&gt; (3-&gt;2) -&gt; 4.
 851  *    In this case we enqueue a method for compilation at level 3, but the C1 queue is long enough
 852  *    to enable the profiling to fully occur at level 0. In this case we change the compilation level
 853  *    of the method to 2 while the request is still in-queue, because it&#39;ll allow it to run much faster
 854  *    without full profiling while c2 is compiling.
 855  *
 856  * d. 0 -&gt; 3 -&gt; 1 or 0 -&gt; 2 -&gt; 1.
 857  *    After a method was once compiled with C1 it can be identified as trivial and be compiled to
 858  *    level 1. These transition can also occur if a method can&#39;t be compiled with C2 but can with C1.
 859  *
 860  * e. 0 -&gt; 4.
 861  *    This can happen if a method fails C1 compilation (it will still be profiled in the interpreter)
 862  *    or because of a deopt that didn&#39;t require reprofiling (compilation won&#39;t happen in this case because
 863  *    the compiled version already exists).
 864  *
 865  * Note that since state 0 can be reached from any other state via deoptimization different loops
 866  * are possible.
 867  *
 868  */
 869 
 870 // Common transition function. Given a predicate determines if a method should transition to another level.
 871 CompLevel TieredThresholdPolicy::common(Predicate p, const methodHandle&amp; method, CompLevel cur_level, bool disable_feedback) {
 872   CompLevel next_level = cur_level;
 873   int i = method-&gt;invocation_count();
 874   int b = method-&gt;backedge_count();
 875 
 876   if (force_comp_at_level_simple(method)) {
 877     next_level = CompLevel_simple;
 878   } else {
 879     if (!CompilationModeFlag::disable_intermediate() &amp;&amp; is_trivial(method())) {
 880       next_level = CompLevel_simple;
 881     } else {
 882       switch(cur_level) {
 883       default: break;
 884       case CompLevel_aot:
 885         if (CompilationModeFlag::disable_intermediate()) {
 886           if (disable_feedback || (CompileBroker::queue_size(CompLevel_full_optimization) &lt;=
 887                                    Tier0Delay * compiler_count(CompLevel_full_optimization) &amp;&amp;
 888                                   (this-&gt;*p)(i, b, cur_level, method))) {
 889             next_level = CompLevel_none;
 890           }
 891         } else {
 892           // If we were at full profile level, would we switch to full opt?
 893           if (common(p, method, CompLevel_full_profile, disable_feedback) == CompLevel_full_optimization) {
 894             next_level = CompLevel_full_optimization;
 895           } else if (disable_feedback || (CompileBroker::queue_size(CompLevel_full_optimization) &lt;=
 896                                           Tier3DelayOff * compiler_count(CompLevel_full_optimization) &amp;&amp;
 897                                          (this-&gt;*p)(i, b, cur_level, method))) {
 898             next_level = CompLevel_full_profile;
 899           }
 900         }
 901         break;
 902       case CompLevel_none:
 903         if (CompilationModeFlag::disable_intermediate()) {
 904           MethodData* mdo = method-&gt;method_data();
 905           if (mdo != NULL) {
 906             // If mdo exists that means we are in a normal profiling mode.
 907             int mdo_i = mdo-&gt;invocation_count_delta();
 908             int mdo_b = mdo-&gt;backedge_count_delta();
 909             if ((this-&gt;*p)(mdo_i, mdo_b, cur_level, method)) {
 910               next_level = CompLevel_full_optimization;
 911             }
 912           }
 913         } else {
 914           // If we were at full profile level, would we switch to full opt?
 915           if (common(p, method, CompLevel_full_profile, disable_feedback) == CompLevel_full_optimization) {
 916             next_level = CompLevel_full_optimization;
 917           } else if ((this-&gt;*p)(i, b, cur_level, method)) {
 918   #if INCLUDE_JVMCI
 919             if (EnableJVMCI &amp;&amp; UseJVMCICompiler) {
 920               // Since JVMCI takes a while to warm up, its queue inevitably backs up during
 921               // early VM execution. As of 2014-06-13, JVMCI&#39;s inliner assumes that the root
 922               // compilation method and all potential inlinees have mature profiles (which
 923               // includes type profiling). If it sees immature profiles, JVMCI&#39;s inliner
 924               // can perform pathologically bad (e.g., causing OutOfMemoryErrors due to
 925               // exploring/inlining too many graphs). Since a rewrite of the inliner is
 926               // in progress, we simply disable the dialing back heuristic for now and will
 927               // revisit this decision once the new inliner is completed.
 928               next_level = CompLevel_full_profile;
 929             } else
 930   #endif
 931             {
 932               // C1-generated fully profiled code is about 30% slower than the limited profile
 933               // code that has only invocation and backedge counters. The observation is that
 934               // if C2 queue is large enough we can spend too much time in the fully profiled code
 935               // while waiting for C2 to pick the method from the queue. To alleviate this problem
 936               // we introduce a feedback on the C2 queue size. If the C2 queue is sufficiently long
 937               // we choose to compile a limited profiled version and then recompile with full profiling
 938               // when the load on C2 goes down.
 939               if (!disable_feedback &amp;&amp; CompileBroker::queue_size(CompLevel_full_optimization) &gt;
 940                   Tier3DelayOn * compiler_count(CompLevel_full_optimization)) {
 941                 next_level = CompLevel_limited_profile;
 942               } else {
 943                 next_level = CompLevel_full_profile;
 944               }
 945             }
 946           }
 947         }
 948         break;
 949       case CompLevel_limited_profile:
 950         if (is_method_profiled(method)) {
 951           // Special case: we got here because this method was fully profiled in the interpreter.
 952           next_level = CompLevel_full_optimization;
 953         } else {
 954           MethodData* mdo = method-&gt;method_data();
 955           if (mdo != NULL) {
 956             if (mdo-&gt;would_profile()) {
 957               if (disable_feedback || (CompileBroker::queue_size(CompLevel_full_optimization) &lt;=
 958                                        Tier3DelayOff * compiler_count(CompLevel_full_optimization) &amp;&amp;
 959                                        (this-&gt;*p)(i, b, cur_level, method))) {
 960                 next_level = CompLevel_full_profile;
 961               }
 962             } else {
 963               next_level = CompLevel_full_optimization;
 964             }
 965           } else {
 966             // If there is no MDO we need to profile
 967             if (disable_feedback || (CompileBroker::queue_size(CompLevel_full_optimization) &lt;=
 968                                      Tier3DelayOff * compiler_count(CompLevel_full_optimization) &amp;&amp;
 969                                      (this-&gt;*p)(i, b, cur_level, method))) {
 970               next_level = CompLevel_full_profile;
 971             }
 972           }
 973         }
 974         break;
 975       case CompLevel_full_profile:
 976         {
 977           MethodData* mdo = method-&gt;method_data();
 978           if (mdo != NULL) {
 979             if (mdo-&gt;would_profile()) {
 980               int mdo_i = mdo-&gt;invocation_count_delta();
 981               int mdo_b = mdo-&gt;backedge_count_delta();
 982               if ((this-&gt;*p)(mdo_i, mdo_b, cur_level, method)) {
 983                 next_level = CompLevel_full_optimization;
 984               }
 985             } else {
 986               next_level = CompLevel_full_optimization;
 987             }
 988           }
 989         }
 990         break;
 991       }
 992     }
 993   }
 994   return limit_level(next_level);
 995 }
 996 
 997 
 998 
 999 // Determine if a method should be compiled with a normal entry point at a different level.
1000 CompLevel TieredThresholdPolicy::call_event(const methodHandle&amp; method, CompLevel cur_level, JavaThread* thread) {
1001   CompLevel osr_level = MIN2((CompLevel) method-&gt;highest_osr_comp_level(),
1002                              common(&amp;TieredThresholdPolicy::loop_predicate, method, cur_level, true));
1003   CompLevel next_level = common(&amp;TieredThresholdPolicy::call_predicate, method, cur_level);
1004 
1005   // If OSR method level is greater than the regular method level, the levels should be
1006   // equalized by raising the regular method level in order to avoid OSRs during each
1007   // invocation of the method.
1008   if (osr_level == CompLevel_full_optimization &amp;&amp; cur_level == CompLevel_full_profile) {
1009     MethodData* mdo = method-&gt;method_data();
1010     guarantee(mdo != NULL, &quot;MDO should not be NULL&quot;);
1011     if (mdo-&gt;invocation_count() &gt;= 1) {
1012       next_level = CompLevel_full_optimization;
1013     }
1014   } else {
1015     next_level = MAX2(osr_level, next_level);
1016   }
1017   return next_level;
1018 }
1019 
1020 // Determine if we should do an OSR compilation of a given method.
1021 CompLevel TieredThresholdPolicy::loop_event(const methodHandle&amp; method, CompLevel cur_level, JavaThread* thread) {
1022   CompLevel next_level = common(&amp;TieredThresholdPolicy::loop_predicate, method, cur_level, true);
1023   if (cur_level == CompLevel_none) {
1024     // If there is a live OSR method that means that we deopted to the interpreter
1025     // for the transition.
1026     CompLevel osr_level = MIN2((CompLevel)method-&gt;highest_osr_comp_level(), next_level);
1027     if (osr_level &gt; CompLevel_none) {
1028       return osr_level;
1029     }
1030   }
1031   return next_level;
1032 }
1033 
1034 bool TieredThresholdPolicy::maybe_switch_to_aot(const methodHandle&amp; mh, CompLevel cur_level, CompLevel next_level, JavaThread* thread) {
1035   if (UseAOT) {
1036     if (cur_level == CompLevel_full_profile || cur_level == CompLevel_none) {
1037       // If the current level is full profile or interpreter and we&#39;re switching to any other level,
1038       // activate the AOT code back first so that we won&#39;t waste time overprofiling.
1039       compile(mh, InvocationEntryBci, CompLevel_aot, thread);
1040       // Fall through for JIT compilation.
1041     }
1042     if (next_level == CompLevel_limited_profile &amp;&amp; cur_level != CompLevel_aot &amp;&amp; mh-&gt;has_aot_code()) {
1043       // If the next level is limited profile, use the aot code (if there is any),
1044       // since it&#39;s essentially the same thing.
1045       compile(mh, InvocationEntryBci, CompLevel_aot, thread);
1046       // Not need to JIT, we&#39;re done.
1047       return true;
1048     }
1049   }
1050   return false;
1051 }
1052 
1053 
1054 // Handle the invocation event.
1055 void TieredThresholdPolicy::method_invocation_event(const methodHandle&amp; mh, const methodHandle&amp; imh,
1056                                                       CompLevel level, CompiledMethod* nm, JavaThread* thread) {
1057   if (should_create_mdo(mh, level)) {
1058     create_mdo(mh, thread);
1059   }
1060   CompLevel next_level = call_event(mh, level, thread);
1061   if (next_level != level) {
1062     if (maybe_switch_to_aot(mh, level, next_level, thread)) {
1063       // No JITting necessary
1064       return;
1065     }
1066     if (is_compilation_enabled() &amp;&amp; !CompileBroker::compilation_is_in_queue(mh)) {
1067       compile(mh, InvocationEntryBci, next_level, thread);
1068     }
1069   }
1070 }
1071 
1072 // Handle the back branch event. Notice that we can compile the method
1073 // with a regular entry from here.
1074 void TieredThresholdPolicy::method_back_branch_event(const methodHandle&amp; mh, const methodHandle&amp; imh,
1075                                                      int bci, CompLevel level, CompiledMethod* nm, JavaThread* thread) {
1076   if (should_create_mdo(mh, level)) {
1077     create_mdo(mh, thread);
1078   }
1079   // Check if MDO should be created for the inlined method
1080   if (should_create_mdo(imh, level)) {
1081     create_mdo(imh, thread);
1082   }
1083 
1084   if (is_compilation_enabled()) {
1085     CompLevel next_osr_level = loop_event(imh, level, thread);
1086     CompLevel max_osr_level = (CompLevel)imh-&gt;highest_osr_comp_level();
1087     // At the very least compile the OSR version
1088     if (!CompileBroker::compilation_is_in_queue(imh) &amp;&amp; (next_osr_level != level)) {
1089       compile(imh, bci, next_osr_level, thread);
1090     }
1091 
1092     // Use loop event as an opportunity to also check if there&#39;s been
1093     // enough calls.
1094     CompLevel cur_level, next_level;
1095     if (mh() != imh()) { // If there is an enclosing method
1096       if (level == CompLevel_aot) {
1097         // Recompile the enclosing method to prevent infinite OSRs. Stay at AOT level while it&#39;s compiling.
1098         if (max_osr_level != CompLevel_none &amp;&amp; !CompileBroker::compilation_is_in_queue(mh)) {
1099           CompLevel enclosing_level = limit_level(CompLevel_full_profile);
1100           compile(mh, InvocationEntryBci, enclosing_level, thread);
1101         }
1102       } else {
1103         // Current loop event level is not AOT
1104         guarantee(nm != NULL, &quot;Should have nmethod here&quot;);
1105         cur_level = comp_level(mh());
1106         next_level = call_event(mh, cur_level, thread);
1107 
1108         if (max_osr_level == CompLevel_full_optimization) {
1109           // The inlinee OSRed to full opt, we need to modify the enclosing method to avoid deopts
1110           bool make_not_entrant = false;
1111           if (nm-&gt;is_osr_method()) {
1112             // This is an osr method, just make it not entrant and recompile later if needed
1113             make_not_entrant = true;
1114           } else {
1115             if (next_level != CompLevel_full_optimization) {
1116               // next_level is not full opt, so we need to recompile the
1117               // enclosing method without the inlinee
1118               cur_level = CompLevel_none;
1119               make_not_entrant = true;
1120             }
1121           }
1122           if (make_not_entrant) {
1123             if (PrintTieredEvents) {
1124               int osr_bci = nm-&gt;is_osr_method() ? nm-&gt;osr_entry_bci() : InvocationEntryBci;
1125               print_event(MAKE_NOT_ENTRANT, mh(), mh(), osr_bci, level);
1126             }
1127             nm-&gt;make_not_entrant();
1128           }
1129         }
1130         // Fix up next_level if necessary to avoid deopts
1131         if (next_level == CompLevel_limited_profile &amp;&amp; max_osr_level == CompLevel_full_profile) {
1132           next_level = CompLevel_full_profile;
1133         }
1134         if (cur_level != next_level) {
1135           if (!maybe_switch_to_aot(mh, cur_level, next_level, thread) &amp;&amp; !CompileBroker::compilation_is_in_queue(mh)) {
1136             compile(mh, InvocationEntryBci, next_level, thread);
1137           }
1138         }
1139       }
1140     } else {
1141       cur_level = comp_level(mh());
1142       next_level = call_event(mh, cur_level, thread);
1143       if (next_level != cur_level) {
1144         if (!maybe_switch_to_aot(mh, cur_level, next_level, thread) &amp;&amp; !CompileBroker::compilation_is_in_queue(mh)) {
1145           compile(mh, InvocationEntryBci, next_level, thread);
1146         }
1147       }
1148     }
1149   }
1150 }
1151 
1152 #endif
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>