<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/share/compiler/oopMap.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="compileBroker.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="oopMap.hpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/share/compiler/oopMap.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 166,90 ***</span>
    }
  }
  
  // OopMapSet
  
<span class="line-modified">! OopMapSet::OopMapSet() {</span>
<span class="line-removed">-   set_om_size(MinOopMapAllocation);</span>
<span class="line-removed">-   set_om_count(0);</span>
<span class="line-removed">-   OopMap** temp = NEW_RESOURCE_ARRAY(OopMap*, om_size());</span>
<span class="line-removed">-   set_om_data(temp);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- void OopMapSet::grow_om_data() {</span>
<span class="line-removed">-   int new_size = om_size() * 2;</span>
<span class="line-removed">-   OopMap** new_data = NEW_RESOURCE_ARRAY(OopMap*, new_size);</span>
<span class="line-removed">-   memcpy(new_data,om_data(),om_size() * sizeof(OopMap*));</span>
<span class="line-removed">-   set_om_size(new_size);</span>
<span class="line-removed">-   set_om_data(new_data);</span>
<span class="line-removed">- }</span>
  
  void OopMapSet::add_gc_map(int pc_offset, OopMap *map ) {
<span class="line-removed">-   assert(om_size() != -1,&quot;Cannot grow a fixed OopMapSet&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   if(om_count() &gt;= om_size()) {</span>
<span class="line-removed">-     grow_om_data();</span>
<span class="line-removed">-   }</span>
    map-&gt;set_offset(pc_offset);
  
  #ifdef ASSERT
<span class="line-modified">!   if(om_count() &gt; 0) {</span>
<span class="line-modified">!     OopMap* last = at(om_count()-1);</span>
      if (last-&gt;offset() == map-&gt;offset() ) {
        fatal(&quot;OopMap inserted twice&quot;);
      }
<span class="line-modified">!     if(last-&gt;offset() &gt; map-&gt;offset()) {</span>
        tty-&gt;print_cr( &quot;WARNING, maps not sorted: pc[%d]=%d, pc[%d]=%d&quot;,
<span class="line-modified">!                       om_count(),last-&gt;offset(),om_count()+1,map-&gt;offset());</span>
      }
    }
  #endif // ASSERT
  
<span class="line-modified">!   set(om_count(),map);</span>
<span class="line-removed">-   increment_count();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- int OopMapSet::heap_size() const {</span>
<span class="line-removed">-   // The space we use</span>
<span class="line-removed">-   int size = sizeof(OopMap);</span>
<span class="line-removed">-   int align = sizeof(void *) - 1;</span>
<span class="line-removed">-   size = ((size+align) &amp; ~align);</span>
<span class="line-removed">-   size += om_count() * sizeof(OopMap*);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Now add in the space needed for the indivdiual OopMaps</span>
<span class="line-removed">-   for(int i=0; i &lt; om_count(); i++) {</span>
<span class="line-removed">-     size += at(i)-&gt;heap_size();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">-   // We don&#39;t need to align this, it will be naturally pointer aligned</span>
<span class="line-removed">-   return size;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- OopMap* OopMapSet::singular_oop_map() {</span>
<span class="line-removed">-   guarantee(om_count() == 1, &quot;Make sure we only have a single gc point&quot;);</span>
<span class="line-removed">-   return at(0);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- OopMap* OopMapSet::find_map_at_offset(int pc_offset) const {</span>
<span class="line-removed">-   int i, len = om_count();</span>
<span class="line-removed">-   assert( len &gt; 0, &quot;must have pointer maps&quot; );</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Scan through oopmaps. Stop when current offset is either equal or greater</span>
<span class="line-removed">-   // than the one we are looking for.</span>
<span class="line-removed">-   for( i = 0; i &lt; len; i++) {</span>
<span class="line-removed">-     if( at(i)-&gt;offset() &gt;= pc_offset )</span>
<span class="line-removed">-       break;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   assert( i &lt; len, &quot;oopmap not found&quot; );</span>
<span class="line-removed">- </span>
<span class="line-removed">-   OopMap* m = at(i);</span>
<span class="line-removed">-   assert( m-&gt;offset() == pc_offset, &quot;oopmap not found&quot; );</span>
<span class="line-removed">-   return m;</span>
  }
  
  static void add_derived_oop(oop* base, oop* derived) {
  #if !defined(TIERED) &amp;&amp; !INCLUDE_JVMCI
    COMPILER1_PRESENT(ShouldNotReachHere();)
<span class="line-new-header">--- 166,29 ---</span>
    }
  }
  
  // OopMapSet
  
<span class="line-modified">! OopMapSet::OopMapSet() : _list(MinOopMapAllocation) {}</span>
  
  void OopMapSet::add_gc_map(int pc_offset, OopMap *map ) {
    map-&gt;set_offset(pc_offset);
  
  #ifdef ASSERT
<span class="line-modified">!   if(_list.length() &gt; 0) {</span>
<span class="line-modified">!     OopMap* last = _list.last();</span>
      if (last-&gt;offset() == map-&gt;offset() ) {
        fatal(&quot;OopMap inserted twice&quot;);
      }
<span class="line-modified">!     if (last-&gt;offset() &gt; map-&gt;offset()) {</span>
        tty-&gt;print_cr( &quot;WARNING, maps not sorted: pc[%d]=%d, pc[%d]=%d&quot;,
<span class="line-modified">!                       _list.length(),last-&gt;offset(),_list.length()+1,map-&gt;offset());</span>
      }
    }
  #endif // ASSERT
  
<span class="line-modified">!   add(map);</span>
  }
  
  static void add_derived_oop(oop* base, oop* derived) {
  #if !defined(TIERED) &amp;&amp; !INCLUDE_JVMCI
    COMPILER1_PRESENT(ShouldNotReachHere();)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 300,11 ***</span>
    CodeBlob* cb = fr-&gt;cb();
    assert(cb != NULL, &quot;no codeblob&quot;);
  
    NOT_PRODUCT(if (TraceCodeBlobStacks) trace_codeblob_maps(fr, reg_map);)
  
<span class="line-removed">-   const ImmutableOopMapSet* maps = cb-&gt;oop_maps();</span>
    const ImmutableOopMap* map = cb-&gt;oop_map_for_return_address(fr-&gt;pc());
    assert(map != NULL, &quot;no ptr map found&quot;);
  
    // handle derived pointers first (otherwise base pointer may be
    // changed before derived pointer offset has been collected)
<span class="line-new-header">--- 239,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 514,11 ***</span>
  }
  
  void ImmutableOopMapSet::print() const { print_on(tty); }
  
  void OopMapSet::print_on(outputStream* st) const {
<span class="line-modified">!   const int len = om_count();</span>
  
    st-&gt;print_cr(&quot;OopMapSet contains %d OopMaps&quot;, len);
  
    for( int i = 0; i &lt; len; i++) {
      OopMap* m = at(i);
<span class="line-new-header">--- 452,11 ---</span>
  }
  
  void ImmutableOopMapSet::print() const { print_on(tty); }
  
  void OopMapSet::print_on(outputStream* st) const {
<span class="line-modified">!   const int len = _list.length();</span>
  
    st-&gt;print_cr(&quot;OopMapSet contains %d OopMaps&quot;, len);
  
    for( int i = 0; i &lt; len; i++) {
      OopMap* m = at(i);
</pre>
<center><a href="compileBroker.hpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="oopMap.hpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>