<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/opto/doCall.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;ci/ciCallSite.hpp&quot;
  27 #include &quot;ci/ciMethodHandle.hpp&quot;
  28 #include &quot;classfile/vmSymbols.hpp&quot;
  29 #include &quot;compiler/compileBroker.hpp&quot;
  30 #include &quot;compiler/compileLog.hpp&quot;
  31 #include &quot;interpreter/linkResolver.hpp&quot;
  32 #include &quot;opto/addnode.hpp&quot;
  33 #include &quot;opto/callGenerator.hpp&quot;
  34 #include &quot;opto/castnode.hpp&quot;
  35 #include &quot;opto/cfgnode.hpp&quot;
  36 #include &quot;opto/mulnode.hpp&quot;
  37 #include &quot;opto/parse.hpp&quot;
  38 #include &quot;opto/rootnode.hpp&quot;
  39 #include &quot;opto/runtime.hpp&quot;
  40 #include &quot;opto/subnode.hpp&quot;
  41 #include &quot;prims/nativeLookup.hpp&quot;
  42 #include &quot;runtime/sharedRuntime.hpp&quot;
  43 
  44 void trace_type_profile(Compile* C, ciMethod *method, int depth, int bci, ciMethod *prof_method, ciKlass *prof_klass, int site_count, int receiver_count) {
  45   if (TraceTypeProfile || C-&gt;print_inlining()) {
  46     outputStream* out = tty;
  47     if (!C-&gt;print_inlining()) {
  48       if (!PrintOpto &amp;&amp; !PrintCompilation) {
  49         method-&gt;print_short_name();
  50         tty-&gt;cr();
  51       }
  52       CompileTask::print_inlining_tty(prof_method, depth, bci);
  53     } else {
  54       out = C-&gt;print_inlining_stream();
  55     }
  56     CompileTask::print_inline_indent(depth, out);
  57     out-&gt;print(&quot; \\-&gt; TypeProfile (%d/%d counts) = &quot;, receiver_count, site_count);
  58     stringStream ss;
  59     prof_klass-&gt;name()-&gt;print_symbol_on(&amp;ss);
  60     out-&gt;print(&quot;%s&quot;, ss.as_string());
  61     out-&gt;cr();
  62   }
  63 }
  64 
  65 CallGenerator* Compile::call_generator(ciMethod* callee, int vtable_index, bool call_does_dispatch,
  66                                        JVMState* jvms, bool allow_inline,
  67                                        float prof_factor, ciKlass* speculative_receiver_type,
  68                                        bool allow_intrinsics, bool delayed_forbidden) {
  69   ciMethod*       caller   = jvms-&gt;method();
  70   int             bci      = jvms-&gt;bci();
  71   Bytecodes::Code bytecode = caller-&gt;java_code_at_bci(bci);
  72   guarantee(callee != NULL, &quot;failed method resolution&quot;);
  73 
  74   // Dtrace currently doesn&#39;t work unless all calls are vanilla
  75   if (env()-&gt;dtrace_method_probes()) {
  76     allow_inline = false;
  77   }
  78 
  79   // Note: When we get profiling during stage-1 compiles, we want to pull
  80   // from more specific profile data which pertains to this inlining.
  81   // Right now, ignore the information in jvms-&gt;caller(), and do method[bci].
  82   ciCallProfile profile = caller-&gt;call_profile_at_bci(bci);
  83 
  84   // See how many times this site has been invoked.
  85   int site_count = profile.count();
  86   int receiver_count = -1;
  87   if (call_does_dispatch &amp;&amp; UseTypeProfile &amp;&amp; profile.has_receiver(0)) {
  88     // Receivers in the profile structure are ordered by call counts
  89     // so that the most called (major) receiver is profile.receiver(0).
  90     receiver_count = profile.receiver_count(0);
  91   }
  92 
  93   CompileLog* log = this-&gt;log();
  94   if (log != NULL) {
  95     int rid = (receiver_count &gt;= 0)? log-&gt;identify(profile.receiver(0)): -1;
  96     int r2id = (rid != -1 &amp;&amp; profile.has_receiver(1))? log-&gt;identify(profile.receiver(1)):-1;
  97     log-&gt;begin_elem(&quot;call method=&#39;%d&#39; count=&#39;%d&#39; prof_factor=&#39;%f&#39;&quot;,
  98                     log-&gt;identify(callee), site_count, prof_factor);
  99     if (call_does_dispatch)  log-&gt;print(&quot; virtual=&#39;1&#39;&quot;);
 100     if (allow_inline)     log-&gt;print(&quot; inline=&#39;1&#39;&quot;);
 101     if (receiver_count &gt;= 0) {
 102       log-&gt;print(&quot; receiver=&#39;%d&#39; receiver_count=&#39;%d&#39;&quot;, rid, receiver_count);
 103       if (profile.has_receiver(1)) {
 104         log-&gt;print(&quot; receiver2=&#39;%d&#39; receiver2_count=&#39;%d&#39;&quot;, r2id, profile.receiver_count(1));
 105       }
 106     }
 107     if (callee-&gt;is_method_handle_intrinsic()) {
 108       log-&gt;print(&quot; method_handle_intrinsic=&#39;1&#39;&quot;);
 109     }
 110     log-&gt;end_elem();
 111   }
 112 
 113   // Special case the handling of certain common, profitable library
 114   // methods.  If these methods are replaced with specialized code,
 115   // then we return it as the inlined version of the call.
 116   // We do this before the strict f.p. check below because the
 117   // intrinsics handle strict f.p. correctly.
 118   CallGenerator* cg_intrinsic = NULL;
 119   if (allow_inline &amp;&amp; allow_intrinsics) {
 120     CallGenerator* cg = find_intrinsic(callee, call_does_dispatch);
 121     if (cg != NULL) {
 122       if (cg-&gt;is_predicated()) {
 123         // Code without intrinsic but, hopefully, inlined.
 124         CallGenerator* inline_cg = this-&gt;call_generator(callee,
 125               vtable_index, call_does_dispatch, jvms, allow_inline, prof_factor, speculative_receiver_type, false);
 126         if (inline_cg != NULL) {
 127           cg = CallGenerator::for_predicated_intrinsic(cg, inline_cg);
 128         }
 129       }
 130 
 131       // If intrinsic does the virtual dispatch, we try to use the type profile
 132       // first, and hopefully inline it as the regular virtual call below.
 133       // We will retry the intrinsic if nothing had claimed it afterwards.
 134       if (cg-&gt;does_virtual_dispatch()) {
 135         cg_intrinsic = cg;
 136         cg = NULL;
 137       } else {
 138         return cg;
 139       }
 140     }
 141   }
 142 
 143   // Do method handle calls.
 144   // NOTE: This must happen before normal inlining logic below since
 145   // MethodHandle.invoke* are native methods which obviously don&#39;t
 146   // have bytecodes and so normal inlining fails.
 147   if (callee-&gt;is_method_handle_intrinsic()) {
 148     CallGenerator* cg = CallGenerator::for_method_handle_call(jvms, caller, callee, delayed_forbidden);
 149     assert(cg == NULL || !delayed_forbidden || !cg-&gt;is_late_inline() || cg-&gt;is_mh_late_inline(), &quot;unexpected CallGenerator&quot;);
 150     return cg;
 151   }
 152 
<a name="1" id="anc1"></a><span class="line-modified"> 153   // If explicit rounding is required, do not inline strict into non-strict code (or the reverse).</span>
<span class="line-modified"> 154   if (Matcher::strict_fp_requires_explicit_rounding &amp;&amp;</span>
<span class="line-added"> 155       caller-&gt;is_strict() != callee-&gt;is_strict()) {</span>
 156     allow_inline = false;
 157   }
 158 
 159   // Attempt to inline...
 160   if (allow_inline) {
 161     // The profile data is only partly attributable to this caller,
 162     // scale back the call site information.
 163     float past_uses = jvms-&gt;method()-&gt;scale_count(site_count, prof_factor);
 164     // This is the number of times we expect the call code to be used.
 165     float expected_uses = past_uses;
 166 
 167     // Try inlining a bytecoded method:
 168     if (!call_does_dispatch) {
 169       InlineTree* ilt = InlineTree::find_subtree_from_root(this-&gt;ilt(), jvms-&gt;caller(), jvms-&gt;method());
 170       WarmCallInfo scratch_ci;
 171       bool should_delay = false;
 172       WarmCallInfo* ci = ilt-&gt;ok_to_inline(callee, jvms, profile, &amp;scratch_ci, should_delay);
 173       assert(ci != &amp;scratch_ci, &quot;do not let this pointer escape&quot;);
 174       bool allow_inline   = (ci != NULL &amp;&amp; !ci-&gt;is_cold());
 175       bool require_inline = (allow_inline &amp;&amp; ci-&gt;is_hot());
 176 
 177       if (allow_inline) {
 178         CallGenerator* cg = CallGenerator::for_inline(callee, expected_uses);
 179 
 180         if (require_inline &amp;&amp; cg != NULL) {
 181           // Delay the inlining of this method to give us the
 182           // opportunity to perform some high level optimizations
 183           // first.
 184           if (should_delay_string_inlining(callee, jvms)) {
 185             assert(!delayed_forbidden, &quot;strange&quot;);
 186             return CallGenerator::for_string_late_inline(callee, cg);
 187           } else if (should_delay_boxing_inlining(callee, jvms)) {
 188             assert(!delayed_forbidden, &quot;strange&quot;);
 189             return CallGenerator::for_boxing_late_inline(callee, cg);
 190           } else if ((should_delay || AlwaysIncrementalInline) &amp;&amp; !delayed_forbidden) {
 191             return CallGenerator::for_late_inline(callee, cg);
 192           }
 193         }
 194         if (cg == NULL || should_delay) {
 195           // Fall through.
 196         } else if (require_inline || !InlineWarmCalls) {
 197           return cg;
 198         } else {
 199           CallGenerator* cold_cg = call_generator(callee, vtable_index, call_does_dispatch, jvms, false, prof_factor);
 200           return CallGenerator::for_warm_call(ci, cold_cg, cg);
 201         }
 202       }
 203     }
 204 
 205     // Try using the type profile.
 206     if (call_does_dispatch &amp;&amp; site_count &gt; 0 &amp;&amp; UseTypeProfile) {
 207       // The major receiver&#39;s count &gt;= TypeProfileMajorReceiverPercent of site_count.
 208       bool have_major_receiver = profile.has_receiver(0) &amp;&amp; (100.*profile.receiver_prob(0) &gt;= (float)TypeProfileMajorReceiverPercent);
 209       ciMethod* receiver_method = NULL;
 210 
 211       int morphism = profile.morphism();
 212       if (speculative_receiver_type != NULL) {
 213         if (!too_many_traps_or_recompiles(caller, bci, Deoptimization::Reason_speculate_class_check)) {
 214           // We have a speculative type, we should be able to resolve
 215           // the call. We do that before looking at the profiling at
 216           // this invoke because it may lead to bimorphic inlining which
 217           // a speculative type should help us avoid.
 218           receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 219                                                    speculative_receiver_type);
 220           if (receiver_method == NULL) {
 221             speculative_receiver_type = NULL;
 222           } else {
 223             morphism = 1;
 224           }
 225         } else {
 226           // speculation failed before. Use profiling at the call
 227           // (could allow bimorphic inlining for instance).
 228           speculative_receiver_type = NULL;
 229         }
 230       }
 231       if (receiver_method == NULL &amp;&amp;
 232           (have_major_receiver || morphism == 1 ||
 233            (morphism == 2 &amp;&amp; UseBimorphicInlining))) {
 234         // receiver_method = profile.method();
 235         // Profiles do not suggest methods now.  Look it up in the major receiver.
 236         receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 237                                                       profile.receiver(0));
 238       }
 239       if (receiver_method != NULL) {
 240         // The single majority receiver sufficiently outweighs the minority.
 241         CallGenerator* hit_cg = this-&gt;call_generator(receiver_method,
 242               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 243         if (hit_cg != NULL) {
 244           // Look up second receiver.
 245           CallGenerator* next_hit_cg = NULL;
 246           ciMethod* next_receiver_method = NULL;
 247           if (morphism == 2 &amp;&amp; UseBimorphicInlining) {
 248             next_receiver_method = callee-&gt;resolve_invoke(jvms-&gt;method()-&gt;holder(),
 249                                                                profile.receiver(1));
 250             if (next_receiver_method != NULL) {
 251               next_hit_cg = this-&gt;call_generator(next_receiver_method,
 252                                   vtable_index, !call_does_dispatch, jvms,
 253                                   allow_inline, prof_factor);
 254               if (next_hit_cg != NULL &amp;&amp; !next_hit_cg-&gt;is_inline() &amp;&amp;
 255                   have_major_receiver &amp;&amp; UseOnlyInlinedBimorphic) {
 256                   // Skip if we can&#39;t inline second receiver&#39;s method
 257                   next_hit_cg = NULL;
 258               }
 259             }
 260           }
 261           CallGenerator* miss_cg;
 262           Deoptimization::DeoptReason reason = (morphism == 2
 263                                                ? Deoptimization::Reason_bimorphic
 264                                                : Deoptimization::reason_class_check(speculative_receiver_type != NULL));
 265           if ((morphism == 1 || (morphism == 2 &amp;&amp; next_hit_cg != NULL)) &amp;&amp;
 266               !too_many_traps_or_recompiles(caller, bci, reason)
 267              ) {
 268             // Generate uncommon trap for class check failure path
 269             // in case of monomorphic or bimorphic virtual call site.
 270             miss_cg = CallGenerator::for_uncommon_trap(callee, reason,
 271                         Deoptimization::Action_maybe_recompile);
 272           } else {
 273             // Generate virtual call for class check failure path
 274             // in case of polymorphic virtual call site.
 275             miss_cg = CallGenerator::for_virtual_call(callee, vtable_index);
 276           }
 277           if (miss_cg != NULL) {
 278             if (next_hit_cg != NULL) {
 279               assert(speculative_receiver_type == NULL, &quot;shouldn&#39;t end up here if we used speculation&quot;);
 280               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), next_receiver_method, profile.receiver(1), site_count, profile.receiver_count(1));
 281               // We don&#39;t need to record dependency on a receiver here and below.
 282               // Whenever we inline, the dependency is added by Parse::Parse().
 283               miss_cg = CallGenerator::for_predicted_call(profile.receiver(1), miss_cg, next_hit_cg, PROB_MAX);
 284             }
 285             if (miss_cg != NULL) {
 286               ciKlass* k = speculative_receiver_type != NULL ? speculative_receiver_type : profile.receiver(0);
 287               trace_type_profile(C, jvms-&gt;method(), jvms-&gt;depth() - 1, jvms-&gt;bci(), receiver_method, k, site_count, receiver_count);
 288               float hit_prob = speculative_receiver_type != NULL ? 1.0 : profile.receiver_prob(0);
 289               CallGenerator* cg = CallGenerator::for_predicted_call(k, miss_cg, hit_cg, hit_prob);
 290               if (cg != NULL)  return cg;
 291             }
 292           }
 293         }
 294       }
 295     }
 296 
 297     // If there is only one implementor of this interface then we
 298     // may be able to bind this invoke directly to the implementing
 299     // klass but we need both a dependence on the single interface
 300     // and on the method we bind to. Additionally since all we know
 301     // about the receiver type is that it&#39;s supposed to implement the
 302     // interface we have to insert a check that it&#39;s the class we
 303     // expect.  Interface types are not checked by the verifier so
 304     // they are roughly equivalent to Object.
 305     // The number of implementors for declared_interface is less or
 306     // equal to the number of implementors for target-&gt;holder() so
 307     // if number of implementors of target-&gt;holder() == 1 then
 308     // number of implementors for decl_interface is 0 or 1. If
 309     // it&#39;s 0 then no class implements decl_interface and there&#39;s
 310     // no point in inlining.
 311     if (call_does_dispatch &amp;&amp; bytecode == Bytecodes::_invokeinterface) {
 312       ciInstanceKlass* declared_interface =
 313           caller-&gt;get_declared_method_holder_at_bci(bci)-&gt;as_instance_klass();
 314       ciInstanceKlass* singleton = declared_interface-&gt;unique_implementor();
 315 
 316       if (singleton != NULL &amp;&amp;
 317           (!callee-&gt;is_default_method() || callee-&gt;is_overpass()) /* CHA doesn&#39;t support default methods yet */) {
 318         assert(singleton != declared_interface, &quot;not a unique implementor&quot;);
 319 
 320         ciMethod* cha_monomorphic_target =
 321             callee-&gt;find_monomorphic_target(caller-&gt;holder(), declared_interface, singleton);
 322 
 323         if (cha_monomorphic_target != NULL &amp;&amp;
 324             cha_monomorphic_target-&gt;holder() != env()-&gt;Object_klass()) { // subtype check against Object is useless
 325           ciKlass* holder = cha_monomorphic_target-&gt;holder();
 326 
 327           // Try to inline the method found by CHA. Inlined method is guarded by the type check.
 328           CallGenerator* hit_cg = call_generator(cha_monomorphic_target,
 329               vtable_index, !call_does_dispatch, jvms, allow_inline, prof_factor);
 330 
 331           // Deoptimize on type check fail. The interpreter will throw ICCE for us.
 332           CallGenerator* miss_cg = CallGenerator::for_uncommon_trap(callee,
 333               Deoptimization::Reason_class_check, Deoptimization::Action_none);
 334 
 335           CallGenerator* cg = CallGenerator::for_guarded_call(holder, miss_cg, hit_cg);
 336           if (hit_cg != NULL &amp;&amp; cg != NULL) {
 337             dependencies()-&gt;assert_unique_concrete_method(declared_interface, cha_monomorphic_target);
 338             return cg;
 339           }
 340         }
 341       }
 342     }
 343   }
 344 
 345   // Nothing claimed the intrinsic, we go with straight-forward inlining
 346   // for already discovered intrinsic.
 347   if (allow_inline &amp;&amp; allow_intrinsics &amp;&amp; cg_intrinsic != NULL) {
 348     assert(cg_intrinsic-&gt;does_virtual_dispatch(), &quot;sanity&quot;);
 349     return cg_intrinsic;
 350   }
 351 
 352   // There was no special inlining tactic, or it bailed out.
 353   // Use a more generic tactic, like a simple call.
 354   if (call_does_dispatch) {
 355     const char* msg = &quot;virtual call&quot;;
 356     if (PrintInlining) print_inlining(callee, jvms-&gt;depth() - 1, jvms-&gt;bci(), msg);
 357     C-&gt;log_inline_failure(msg);
 358     return CallGenerator::for_virtual_call(callee, vtable_index);
 359   } else {
 360     // Class Hierarchy Analysis or Type Profile reveals a unique target,
 361     // or it is a static or special call.
 362     return CallGenerator::for_direct_call(callee, should_delay_inlining(callee, jvms));
 363   }
 364 }
 365 
 366 // Return true for methods that shouldn&#39;t be inlined early so that
 367 // they are easier to analyze and optimize as intrinsics.
 368 bool Compile::should_delay_string_inlining(ciMethod* call_method, JVMState* jvms) {
 369   if (has_stringbuilder()) {
 370 
 371     if ((call_method-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 372          call_method-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass()) &amp;&amp;
 373         (jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuilder_klass() ||
 374          jvms-&gt;method()-&gt;holder() == C-&gt;env()-&gt;StringBuffer_klass())) {
 375       // Delay SB calls only when called from non-SB code
 376       return false;
 377     }
 378 
 379     switch (call_method-&gt;intrinsic_id()) {
 380       case vmIntrinsics::_StringBuilder_void:
 381       case vmIntrinsics::_StringBuilder_int:
 382       case vmIntrinsics::_StringBuilder_String:
 383       case vmIntrinsics::_StringBuilder_append_char:
 384       case vmIntrinsics::_StringBuilder_append_int:
 385       case vmIntrinsics::_StringBuilder_append_String:
 386       case vmIntrinsics::_StringBuilder_toString:
 387       case vmIntrinsics::_StringBuffer_void:
 388       case vmIntrinsics::_StringBuffer_int:
 389       case vmIntrinsics::_StringBuffer_String:
 390       case vmIntrinsics::_StringBuffer_append_char:
 391       case vmIntrinsics::_StringBuffer_append_int:
 392       case vmIntrinsics::_StringBuffer_append_String:
 393       case vmIntrinsics::_StringBuffer_toString:
 394       case vmIntrinsics::_Integer_toString:
 395         return true;
 396 
 397       case vmIntrinsics::_String_String:
 398         {
 399           Node* receiver = jvms-&gt;map()-&gt;in(jvms-&gt;argoff() + 1);
 400           if (receiver-&gt;is_Proj() &amp;&amp; receiver-&gt;in(0)-&gt;is_CallStaticJava()) {
 401             CallStaticJavaNode* csj = receiver-&gt;in(0)-&gt;as_CallStaticJava();
 402             ciMethod* m = csj-&gt;method();
 403             if (m != NULL &amp;&amp;
 404                 (m-&gt;intrinsic_id() == vmIntrinsics::_StringBuffer_toString ||
 405                  m-&gt;intrinsic_id() == vmIntrinsics::_StringBuilder_toString))
 406               // Delay String.&lt;init&gt;(new SB())
 407               return true;
 408           }
 409           return false;
 410         }
 411 
 412       default:
 413         return false;
 414     }
 415   }
 416   return false;
 417 }
 418 
 419 bool Compile::should_delay_boxing_inlining(ciMethod* call_method, JVMState* jvms) {
 420   if (eliminate_boxing() &amp;&amp; call_method-&gt;is_boxing_method()) {
 421     set_has_boxed_value(true);
 422     return aggressive_unboxing();
 423   }
 424   return false;
 425 }
 426 
 427 // uncommon-trap call-sites where callee is unloaded, uninitialized or will not link
 428 bool Parse::can_not_compile_call_site(ciMethod *dest_method, ciInstanceKlass* klass) {
 429   // Additional inputs to consider...
 430   // bc      = bc()
 431   // caller  = method()
 432   // iter().get_method_holder_index()
 433   assert( dest_method-&gt;is_loaded(), &quot;ciTypeFlow should not let us get here&quot; );
 434   // Interface classes can be loaded &amp; linked and never get around to
 435   // being initialized.  Uncommon-trap for not-initialized static or
 436   // v-calls.  Let interface calls happen.
 437   ciInstanceKlass* holder_klass = dest_method-&gt;holder();
 438   if (!holder_klass-&gt;is_being_initialized() &amp;&amp;
 439       !holder_klass-&gt;is_initialized() &amp;&amp;
 440       !holder_klass-&gt;is_interface()) {
 441     uncommon_trap(Deoptimization::Reason_uninitialized,
 442                   Deoptimization::Action_reinterpret,
 443                   holder_klass);
 444     return true;
 445   }
 446 
 447   assert(dest_method-&gt;is_loaded(), &quot;dest_method: typeflow responsibility&quot;);
 448   return false;
 449 }
 450 
 451 #ifdef ASSERT
 452 static bool check_call_consistency(JVMState* jvms, CallGenerator* cg) {
 453   ciMethod* symbolic_info = jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci());
 454   ciMethod* resolved_method = cg-&gt;method();
 455   if (!ciMethod::is_consistent_info(symbolic_info, resolved_method)) {
 456     tty-&gt;print_cr(&quot;JVMS:&quot;);
 457     jvms-&gt;dump();
 458     tty-&gt;print_cr(&quot;Bytecode info:&quot;);
 459     jvms-&gt;method()-&gt;get_method_at_bci(jvms-&gt;bci())-&gt;print(); tty-&gt;cr();
 460     tty-&gt;print_cr(&quot;Resolved method:&quot;);
 461     cg-&gt;method()-&gt;print(); tty-&gt;cr();
 462     return false;
 463   }
 464   return true;
 465 }
 466 #endif // ASSERT
 467 
 468 //------------------------------do_call----------------------------------------
 469 // Handle your basic call.  Inline if we can &amp; want to, else just setup call.
 470 void Parse::do_call() {
 471   // It&#39;s likely we are going to add debug info soon.
 472   // Also, if we inline a guy who eventually needs debug info for this JVMS,
 473   // our contribution to it is cleaned up right here.
 474   kill_dead_locals();
 475 
 476   C-&gt;print_inlining_assert_ready();
 477 
 478   // Set frequently used booleans
 479   const bool is_virtual = bc() == Bytecodes::_invokevirtual;
 480   const bool is_virtual_or_interface = is_virtual || bc() == Bytecodes::_invokeinterface;
 481   const bool has_receiver = Bytecodes::has_receiver(bc());
 482 
 483   // Find target being called
 484   bool             will_link;
 485   ciSignature*     declared_signature = NULL;
 486   ciMethod*        orig_callee  = iter().get_method(will_link, &amp;declared_signature);  // callee in the bytecode
 487   ciInstanceKlass* holder_klass = orig_callee-&gt;holder();
 488   ciKlass*         holder       = iter().get_declared_method_holder();
 489   ciInstanceKlass* klass = ciEnv::get_instance_klass_for_declared_method_holder(holder);
 490   assert(declared_signature != NULL, &quot;cannot be null&quot;);
 491 
 492   // Bump max node limit for JSR292 users
 493   if (bc() == Bytecodes::_invokedynamic || orig_callee-&gt;is_method_handle_intrinsic()) {
 494     C-&gt;set_max_node_limit(3*MaxNodeLimit);
 495   }
 496 
 497   // uncommon-trap when callee is unloaded, uninitialized or will not link
 498   // bailout when too many arguments for register representation
 499   if (!will_link || can_not_compile_call_site(orig_callee, klass)) {
 500     if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 501       method()-&gt;print_name(); tty-&gt;print_cr(&quot; can not compile call at bci %d to:&quot;, bci());
 502       orig_callee-&gt;print_name(); tty-&gt;cr();
 503     }
 504     return;
 505   }
 506   assert(holder_klass-&gt;is_loaded(), &quot;&quot;);
 507   //assert((bc_callee-&gt;is_static() || is_invokedynamic) == !has_receiver , &quot;must match bc&quot;);  // XXX invokehandle (cur_bc_raw)
 508   // Note: this takes into account invokeinterface of methods declared in java/lang/Object,
 509   // which should be invokevirtuals but according to the VM spec may be invokeinterfaces
 510   assert(holder_klass-&gt;is_interface() || holder_klass-&gt;super() == NULL || (bc() != Bytecodes::_invokeinterface), &quot;must match bc&quot;);
 511   // Note:  In the absence of miranda methods, an abstract class K can perform
 512   // an invokevirtual directly on an interface method I.m if K implements I.
 513 
 514   // orig_callee is the resolved callee which&#39;s signature includes the
 515   // appendix argument.
 516   const int nargs = orig_callee-&gt;arg_size();
 517   const bool is_signature_polymorphic = MethodHandles::is_signature_polymorphic(orig_callee-&gt;intrinsic_id());
 518 
 519   // Push appendix argument (MethodType, CallSite, etc.), if one.
 520   if (iter().has_appendix()) {
 521     ciObject* appendix_arg = iter().get_appendix();
 522     const TypeOopPtr* appendix_arg_type = TypeOopPtr::make_from_constant(appendix_arg, /* require_const= */ true);
 523     Node* appendix_arg_node = _gvn.makecon(appendix_arg_type);
 524     push(appendix_arg_node);
 525   }
 526 
 527   // ---------------------
 528   // Does Class Hierarchy Analysis reveal only a single target of a v-call?
 529   // Then we may inline or make a static call, but become dependent on there being only 1 target.
 530   // Does the call-site type profile reveal only one receiver?
 531   // Then we may introduce a run-time check and inline on the path where it succeeds.
 532   // The other path may uncommon_trap, check for another receiver, or do a v-call.
 533 
 534   // Try to get the most accurate receiver type
 535   ciMethod* callee             = orig_callee;
 536   int       vtable_index       = Method::invalid_vtable_index;
 537   bool      call_does_dispatch = false;
 538 
 539   // Speculative type of the receiver if any
 540   ciKlass* speculative_receiver_type = NULL;
 541   if (is_virtual_or_interface) {
 542     Node* receiver_node             = stack(sp() - nargs);
 543     const TypeOopPtr* receiver_type = _gvn.type(receiver_node)-&gt;isa_oopptr();
 544     // call_does_dispatch and vtable_index are out-parameters.  They might be changed.
 545     // For arrays, klass below is Object. When vtable calls are used,
 546     // resolving the call with Object would allow an illegal call to
 547     // finalize() on an array. We use holder instead: illegal calls to
 548     // finalize() won&#39;t be compiled as vtable calls (IC call
 549     // resolution will catch the illegal call) and the few legal calls
 550     // on array types won&#39;t be either.
 551     callee = C-&gt;optimize_virtual_call(method(), bci(), klass, holder, orig_callee,
 552                                       receiver_type, is_virtual,
 553                                       call_does_dispatch, vtable_index);  // out-parameters
 554     speculative_receiver_type = receiver_type != NULL ? receiver_type-&gt;speculative_type() : NULL;
 555   }
 556 
 557   // Additional receiver subtype checks for interface calls via invokespecial or invokeinterface.
 558   ciKlass* receiver_constraint = NULL;
 559   if (iter().cur_bc_raw() == Bytecodes::_invokespecial &amp;&amp; !orig_callee-&gt;is_object_initializer()) {
 560     ciInstanceKlass* calling_klass = method()-&gt;holder();
 561     ciInstanceKlass* sender_klass =
 562         calling_klass-&gt;is_unsafe_anonymous() ? calling_klass-&gt;unsafe_anonymous_host() :
 563                                                calling_klass;
 564     if (sender_klass-&gt;is_interface()) {
 565       receiver_constraint = sender_klass;
 566     }
 567   } else if (iter().cur_bc_raw() == Bytecodes::_invokeinterface &amp;&amp; orig_callee-&gt;is_private()) {
 568     assert(holder-&gt;is_interface(), &quot;How did we get a non-interface method here!&quot;);
 569     receiver_constraint = holder;
 570   }
 571 
 572   if (receiver_constraint != NULL) {
 573     Node* receiver_node = stack(sp() - nargs);
 574     Node* cls_node = makecon(TypeKlassPtr::make(receiver_constraint));
 575     Node* bad_type_ctrl = NULL;
 576     Node* casted_receiver = gen_checkcast(receiver_node, cls_node, &amp;bad_type_ctrl);
 577     if (bad_type_ctrl != NULL) {
 578       PreserveJVMState pjvms(this);
 579       set_control(bad_type_ctrl);
 580       uncommon_trap(Deoptimization::Reason_class_check,
 581                     Deoptimization::Action_none);
 582     }
 583     if (stopped()) {
 584       return; // MUST uncommon-trap?
 585     }
 586     set_stack(sp() - nargs, casted_receiver);
 587   }
 588 
 589   // Note:  It&#39;s OK to try to inline a virtual call.
 590   // The call generator will not attempt to inline a polymorphic call
 591   // unless it knows how to optimize the receiver dispatch.
 592   bool try_inline = (C-&gt;do_inlining() || InlineAccessors);
 593 
 594   // ---------------------
 595   dec_sp(nargs);              // Temporarily pop args for JVM state of call
 596   JVMState* jvms = sync_jvms();
 597 
 598   // ---------------------
 599   // Decide call tactic.
 600   // This call checks with CHA, the interpreter profile, intrinsics table, etc.
 601   // It decides whether inlining is desirable or not.
 602   CallGenerator* cg = C-&gt;call_generator(callee, vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type);
 603 
 604   // NOTE:  Don&#39;t use orig_callee and callee after this point!  Use cg-&gt;method() instead.
 605   orig_callee = callee = NULL;
 606 
 607   // ---------------------
 608   // Round double arguments before call
 609   round_double_arguments(cg-&gt;method());
 610 
 611   // Feed profiling data for arguments to the type system so it can
 612   // propagate it as speculative types
 613   record_profiled_arguments_for_speculation(cg-&gt;method(), bc());
 614 
 615 #ifndef PRODUCT
 616   // bump global counters for calls
 617   count_compiled_calls(/*at_method_entry*/ false, cg-&gt;is_inline());
 618 
 619   // Record first part of parsing work for this call
 620   parse_histogram()-&gt;record_change();
 621 #endif // not PRODUCT
 622 
 623   assert(jvms == this-&gt;jvms(), &quot;still operating on the right JVMS&quot;);
 624   assert(jvms_in_sync(),       &quot;jvms must carry full info into CG&quot;);
 625 
 626   // save across call, for a subsequent cast_not_null.
 627   Node* receiver = has_receiver ? argument(0) : NULL;
 628 
 629   // The extra CheckCastPPs for speculative types mess with PhaseStringOpts
 630   if (receiver != NULL &amp;&amp; !call_does_dispatch &amp;&amp; !cg-&gt;is_string_late_inline()) {
 631     // Feed profiling data for a single receiver to the type system so
 632     // it can propagate it as a speculative type
 633     receiver = record_profiled_receiver_for_speculation(receiver);
 634   }
 635 
 636   // Bump method data counters (We profile *before* the call is made
 637   // because exceptions don&#39;t return to the call site.)
 638   profile_call(receiver);
 639 
 640   JVMState* new_jvms = cg-&gt;generate(jvms);
 641   if (new_jvms == NULL) {
 642     // When inlining attempt fails (e.g., too many arguments),
 643     // it may contaminate the current compile state, making it
 644     // impossible to pull back and try again.  Once we call
 645     // cg-&gt;generate(), we are committed.  If it fails, the whole
 646     // compilation task is compromised.
 647     if (failing())  return;
 648 
 649     // This can happen if a library intrinsic is available, but refuses
 650     // the call site, perhaps because it did not match a pattern the
 651     // intrinsic was expecting to optimize. Should always be possible to
 652     // get a normal java call that may inline in that case
 653     cg = C-&gt;call_generator(cg-&gt;method(), vtable_index, call_does_dispatch, jvms, try_inline, prof_factor(), speculative_receiver_type, /* allow_intrinsics= */ false);
 654     new_jvms = cg-&gt;generate(jvms);
 655     if (new_jvms == NULL) {
 656       guarantee(failing(), &quot;call failed to generate:  calls should work&quot;);
 657       return;
 658     }
 659   }
 660 
 661   if (cg-&gt;is_inline()) {
 662     // Accumulate has_loops estimate
 663     C-&gt;set_has_loops(C-&gt;has_loops() || cg-&gt;method()-&gt;has_loops());
 664     C-&gt;env()-&gt;notice_inlined_method(cg-&gt;method());
 665   }
 666 
 667   // Reset parser state from [new_]jvms, which now carries results of the call.
 668   // Return value (if any) is already pushed on the stack by the cg.
 669   add_exception_states_from(new_jvms);
 670   if (new_jvms-&gt;map()-&gt;control() == top()) {
 671     stop_and_kill_map();
 672   } else {
 673     assert(new_jvms-&gt;same_calls_as(jvms), &quot;method/bci left unchanged&quot;);
 674     set_jvms(new_jvms);
 675   }
 676 
 677   assert(check_call_consistency(jvms, cg), &quot;inconsistent info&quot;);
 678 
 679   if (!stopped()) {
 680     // This was some sort of virtual call, which did a null check for us.
 681     // Now we can assert receiver-not-null, on the normal return path.
 682     if (receiver != NULL &amp;&amp; cg-&gt;is_virtual()) {
 683       Node* cast = cast_not_null(receiver);
 684       // %%% assert(receiver == cast, &quot;should already have cast the receiver&quot;);
 685     }
 686 
 687     // Round double result after a call from strict to non-strict code
 688     round_double_result(cg-&gt;method());
 689 
 690     ciType* rtype = cg-&gt;method()-&gt;return_type();
 691     ciType* ctype = declared_signature-&gt;return_type();
 692 
 693     if (Bytecodes::has_optional_appendix(iter().cur_bc_raw()) || is_signature_polymorphic) {
 694       // Be careful here with return types.
 695       if (ctype != rtype) {
 696         BasicType rt = rtype-&gt;basic_type();
 697         BasicType ct = ctype-&gt;basic_type();
 698         if (ct == T_VOID) {
 699           // It&#39;s OK for a method  to return a value that is discarded.
 700           // The discarding does not require any special action from the caller.
 701           // The Java code knows this, at VerifyType.isNullConversion.
 702           pop_node(rt);  // whatever it was, pop it
 703         } else if (rt == T_INT || is_subword_type(rt)) {
 704           // Nothing.  These cases are handled in lambda form bytecode.
 705           assert(ct == T_INT || is_subword_type(ct), &quot;must match: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 706         } else if (is_reference_type(rt)) {
 707           assert(is_reference_type(ct), &quot;rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 708           if (ctype-&gt;is_loaded()) {
 709             const TypeOopPtr* arg_type = TypeOopPtr::make_from_klass(rtype-&gt;as_klass());
 710             const Type*       sig_type = TypeOopPtr::make_from_klass(ctype-&gt;as_klass());
 711             if (arg_type != NULL &amp;&amp; !arg_type-&gt;higher_equal(sig_type)) {
 712               Node* retnode = pop();
 713               Node* cast_obj = _gvn.transform(new CheckCastPPNode(control(), retnode, sig_type));
 714               push(cast_obj);
 715             }
 716           }
 717         } else {
 718           assert(rt == ct, &quot;unexpected mismatch: rt=%s, ct=%s&quot;, type2name(rt), type2name(ct));
 719           // push a zero; it&#39;s better than getting an oop/int mismatch
 720           pop_node(rt);
 721           Node* retnode = zerocon(ct);
 722           push_node(ct, retnode);
 723         }
 724         // Now that the value is well-behaved, continue with the call-site type.
 725         rtype = ctype;
 726       }
 727     } else {
 728       // Symbolic resolution enforces the types to be the same.
 729       // NOTE: We must relax the assert for unloaded types because two
 730       // different ciType instances of the same unloaded class type
 731       // can appear to be &quot;loaded&quot; by different loaders (depending on
 732       // the accessing class).
 733       assert(!rtype-&gt;is_loaded() || !ctype-&gt;is_loaded() || rtype == ctype,
 734              &quot;mismatched return types: rtype=%s, ctype=%s&quot;, rtype-&gt;name(), ctype-&gt;name());
 735     }
 736 
 737     // If the return type of the method is not loaded, assert that the
 738     // value we got is a null.  Otherwise, we need to recompile.
 739     if (!rtype-&gt;is_loaded()) {
 740       if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 741         method()-&gt;print_name(); tty-&gt;print_cr(&quot; asserting nullness of result at bci: %d&quot;, bci());
 742         cg-&gt;method()-&gt;print_name(); tty-&gt;cr();
 743       }
 744       if (C-&gt;log() != NULL) {
 745         C-&gt;log()-&gt;elem(&quot;assert_null reason=&#39;return&#39; klass=&#39;%d&#39;&quot;,
 746                        C-&gt;log()-&gt;identify(rtype));
 747       }
 748       // If there is going to be a trap, put it at the next bytecode:
 749       set_bci(iter().next_bci());
 750       null_assert(peek());
 751       set_bci(iter().cur_bci()); // put it back
 752     }
 753     BasicType ct = ctype-&gt;basic_type();
 754     if (is_reference_type(ct)) {
 755       record_profiled_return_for_speculation();
 756     }
 757   }
 758 
 759   // Restart record of parsing work after possible inlining of call
 760 #ifndef PRODUCT
 761   parse_histogram()-&gt;set_initial_state(bc());
 762 #endif
 763 }
 764 
 765 //---------------------------catch_call_exceptions-----------------------------
 766 // Put a Catch and CatchProj nodes behind a just-created call.
 767 // Send their caught exceptions to the proper handler.
 768 // This may be used after a call to the rethrow VM stub,
 769 // when it is needed to process unloaded exception classes.
 770 void Parse::catch_call_exceptions(ciExceptionHandlerStream&amp; handlers) {
 771   // Exceptions are delivered through this channel:
 772   Node* i_o = this-&gt;i_o();
 773 
 774   // Add a CatchNode.
 775   GrowableArray&lt;int&gt;* bcis = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, -1);
 776   GrowableArray&lt;const Type*&gt;* extypes = new (C-&gt;node_arena()) GrowableArray&lt;const Type*&gt;(C-&gt;node_arena(), 8, 0, NULL);
 777   GrowableArray&lt;int&gt;* saw_unloaded = new (C-&gt;node_arena()) GrowableArray&lt;int&gt;(C-&gt;node_arena(), 8, 0, 0);
 778 
 779   bool default_handler = false;
 780   for (; !handlers.is_done(); handlers.next()) {
 781     ciExceptionHandler* h        = handlers.handler();
 782     int                 h_bci    = h-&gt;handler_bci();
 783     ciInstanceKlass*    h_klass  = h-&gt;is_catch_all() ? env()-&gt;Throwable_klass() : h-&gt;catch_klass();
 784     // Do not introduce unloaded exception types into the graph:
 785     if (!h_klass-&gt;is_loaded()) {
 786       if (saw_unloaded-&gt;contains(h_bci)) {
 787         /* We&#39;ve already seen an unloaded exception with h_bci,
 788            so don&#39;t duplicate. Duplication will cause the CatchNode to be
 789            unnecessarily large. See 4713716. */
 790         continue;
 791       } else {
 792         saw_unloaded-&gt;append(h_bci);
 793       }
 794     }
 795     const Type*         h_extype = TypeOopPtr::make_from_klass(h_klass);
 796     // (We use make_from_klass because it respects UseUniqueSubclasses.)
 797     h_extype = h_extype-&gt;join(TypeInstPtr::NOTNULL);
 798     assert(!h_extype-&gt;empty(), &quot;sanity&quot;);
 799     // Note:  It&#39;s OK if the BCIs repeat themselves.
 800     bcis-&gt;append(h_bci);
 801     extypes-&gt;append(h_extype);
 802     if (h_bci == -1) {
 803       default_handler = true;
 804     }
 805   }
 806 
 807   if (!default_handler) {
 808     bcis-&gt;append(-1);
 809     extypes-&gt;append(TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr());
 810   }
 811 
 812   int len = bcis-&gt;length();
 813   CatchNode *cn = new CatchNode(control(), i_o, len+1);
 814   Node *catch_ = _gvn.transform(cn);
 815 
 816   // now branch with the exception state to each of the (potential)
 817   // handlers
 818   for(int i=0; i &lt; len; i++) {
 819     // Setup JVM state to enter the handler.
 820     PreserveJVMState pjvms(this);
 821     // Locals are just copied from before the call.
 822     // Get control from the CatchNode.
 823     int handler_bci = bcis-&gt;at(i);
 824     Node* ctrl = _gvn.transform( new CatchProjNode(catch_, i+1,handler_bci));
 825     // This handler cannot happen?
 826     if (ctrl == top())  continue;
 827     set_control(ctrl);
 828 
 829     // Create exception oop
 830     const TypeInstPtr* extype = extypes-&gt;at(i)-&gt;is_instptr();
 831     Node *ex_oop = _gvn.transform(new CreateExNode(extypes-&gt;at(i), ctrl, i_o));
 832 
 833     // Handle unloaded exception classes.
 834     if (saw_unloaded-&gt;contains(handler_bci)) {
 835       // An unloaded exception type is coming here.  Do an uncommon trap.
 836 #ifndef PRODUCT
 837       // We do not expect the same handler bci to take both cold unloaded
 838       // and hot loaded exceptions.  But, watch for it.
 839       if ((Verbose || WizardMode) &amp;&amp; extype-&gt;is_loaded()) {
 840         tty-&gt;print(&quot;Warning: Handler @%d takes mixed loaded/unloaded exceptions in &quot;, bci());
 841         method()-&gt;print_name(); tty-&gt;cr();
 842       } else if (PrintOpto &amp;&amp; (Verbose || WizardMode)) {
 843         tty-&gt;print(&quot;Bailing out on unloaded exception type &quot;);
 844         extype-&gt;klass()-&gt;print_name();
 845         tty-&gt;print(&quot; at bci:%d in &quot;, bci());
 846         method()-&gt;print_name(); tty-&gt;cr();
 847       }
 848 #endif
 849       // Emit an uncommon trap instead of processing the block.
 850       set_bci(handler_bci);
 851       push_ex_oop(ex_oop);
 852       uncommon_trap(Deoptimization::Reason_unloaded,
 853                     Deoptimization::Action_reinterpret,
 854                     extype-&gt;klass(), &quot;!loaded exception&quot;);
 855       set_bci(iter().cur_bci()); // put it back
 856       continue;
 857     }
 858 
 859     // go to the exception handler
 860     if (handler_bci &lt; 0) {     // merge with corresponding rethrow node
 861       throw_to_exit(make_exception_state(ex_oop));
 862     } else {                      // Else jump to corresponding handle
 863       push_ex_oop(ex_oop);        // Clear stack and push just the oop.
 864       merge_exception(handler_bci);
 865     }
 866   }
 867 
 868   // The first CatchProj is for the normal return.
 869   // (Note:  If this is a call to rethrow_Java, this node goes dead.)
 870   set_control(_gvn.transform( new CatchProjNode(catch_, CatchProjNode::fall_through_index, CatchProjNode::no_handler_bci)));
 871 }
 872 
 873 
 874 //----------------------------catch_inline_exceptions--------------------------
 875 // Handle all exceptions thrown by an inlined method or individual bytecode.
 876 // Common case 1: we have no handler, so all exceptions merge right into
 877 // the rethrow case.
 878 // Case 2: we have some handlers, with loaded exception klasses that have
 879 // no subklasses.  We do a Deutsch-Shiffman style type-check on the incoming
 880 // exception oop and branch to the handler directly.
 881 // Case 3: We have some handlers with subklasses or are not loaded at
 882 // compile-time.  We have to call the runtime to resolve the exception.
 883 // So we insert a RethrowCall and all the logic that goes with it.
 884 void Parse::catch_inline_exceptions(SafePointNode* ex_map) {
 885   // Caller is responsible for saving away the map for normal control flow!
 886   assert(stopped(), &quot;call set_map(NULL) first&quot;);
 887   assert(method()-&gt;has_exception_handlers(), &quot;don&#39;t come here w/o work to do&quot;);
 888 
 889   Node* ex_node = saved_ex_oop(ex_map);
 890   if (ex_node == top()) {
 891     // No action needed.
 892     return;
 893   }
 894   const TypeInstPtr* ex_type = _gvn.type(ex_node)-&gt;isa_instptr();
 895   NOT_PRODUCT(if (ex_type==NULL) tty-&gt;print_cr(&quot;*** Exception not InstPtr&quot;));
 896   if (ex_type == NULL)
 897     ex_type = TypeOopPtr::make_from_klass(env()-&gt;Throwable_klass())-&gt;is_instptr();
 898 
 899   // determine potential exception handlers
 900   ciExceptionHandlerStream handlers(method(), bci(),
 901                                     ex_type-&gt;klass()-&gt;as_instance_klass(),
 902                                     ex_type-&gt;klass_is_exact());
 903 
 904   // Start executing from the given throw state.  (Keep its stack, for now.)
 905   // Get the exception oop as known at compile time.
 906   ex_node = use_exception_state(ex_map);
 907 
 908   // Get the exception oop klass from its header
 909   Node* ex_klass_node = NULL;
 910   if (has_ex_handler() &amp;&amp; !ex_type-&gt;klass_is_exact()) {
 911     Node* p = basic_plus_adr( ex_node, ex_node, oopDesc::klass_offset_in_bytes());
 912     ex_klass_node = _gvn.transform(LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 913 
 914     // Compute the exception klass a little more cleverly.
 915     // Obvious solution is to simple do a LoadKlass from the &#39;ex_node&#39;.
 916     // However, if the ex_node is a PhiNode, I&#39;m going to do a LoadKlass for
 917     // each arm of the Phi.  If I know something clever about the exceptions
 918     // I&#39;m loading the class from, I can replace the LoadKlass with the
 919     // klass constant for the exception oop.
 920     if (ex_node-&gt;is_Phi()) {
 921       ex_klass_node = new PhiNode(ex_node-&gt;in(0), TypeKlassPtr::OBJECT);
 922       for (uint i = 1; i &lt; ex_node-&gt;req(); i++) {
 923         Node* ex_in = ex_node-&gt;in(i);
 924         if (ex_in == top() || ex_in == NULL) {
 925           // This path was not taken.
 926           ex_klass_node-&gt;init_req(i, top());
 927           continue;
 928         }
 929         Node* p = basic_plus_adr(ex_in, ex_in, oopDesc::klass_offset_in_bytes());
 930         Node* k = _gvn.transform( LoadKlassNode::make(_gvn, NULL, immutable_memory(), p, TypeInstPtr::KLASS, TypeKlassPtr::OBJECT));
 931         ex_klass_node-&gt;init_req( i, k );
 932       }
 933       _gvn.set_type(ex_klass_node, TypeKlassPtr::OBJECT);
 934 
 935     }
 936   }
 937 
 938   // Scan the exception table for applicable handlers.
 939   // If none, we can call rethrow() and be done!
 940   // If precise (loaded with no subklasses), insert a D.S. style
 941   // pointer compare to the correct handler and loop back.
 942   // If imprecise, switch to the Rethrow VM-call style handling.
 943 
 944   int remaining = handlers.count_remaining();
 945 
 946   // iterate through all entries sequentially
 947   for (;!handlers.is_done(); handlers.next()) {
 948     ciExceptionHandler* handler = handlers.handler();
 949 
 950     if (handler-&gt;is_rethrow()) {
 951       // If we fell off the end of the table without finding an imprecise
 952       // exception klass (and without finding a generic handler) then we
 953       // know this exception is not handled in this method.  We just rethrow
 954       // the exception into the caller.
 955       throw_to_exit(make_exception_state(ex_node));
 956       return;
 957     }
 958 
 959     // exception handler bci range covers throw_bci =&gt; investigate further
 960     int handler_bci = handler-&gt;handler_bci();
 961 
 962     if (remaining == 1) {
 963       push_ex_oop(ex_node);        // Push exception oop for handler
 964       if (PrintOpto &amp;&amp; WizardMode) {
 965         tty-&gt;print_cr(&quot;  Catching every inline exception bci:%d -&gt; handler_bci:%d&quot;, bci(), handler_bci);
 966       }
 967       merge_exception(handler_bci); // jump to handler
 968       return;                   // No more handling to be done here!
 969     }
 970 
 971     // Get the handler&#39;s klass
 972     ciInstanceKlass* klass = handler-&gt;catch_klass();
 973 
 974     if (!klass-&gt;is_loaded()) {  // klass is not loaded?
 975       // fall through into catch_call_exceptions which will emit a
 976       // handler with an uncommon trap.
 977       break;
 978     }
 979 
 980     if (klass-&gt;is_interface())  // should not happen, but...
 981       break;                    // bail out
 982 
 983     // Check the type of the exception against the catch type
 984     const TypeKlassPtr *tk = TypeKlassPtr::make(klass);
 985     Node* con = _gvn.makecon(tk);
 986     Node* not_subtype_ctrl = gen_subtype_check(ex_klass_node, con);
 987     if (!stopped()) {
 988       PreserveJVMState pjvms(this);
 989       const TypeInstPtr* tinst = TypeOopPtr::make_from_klass_unique(klass)-&gt;cast_to_ptr_type(TypePtr::NotNull)-&gt;is_instptr();
 990       assert(klass-&gt;has_subklass() || tinst-&gt;klass_is_exact(), &quot;lost exactness&quot;);
 991       Node* ex_oop = _gvn.transform(new CheckCastPPNode(control(), ex_node, tinst));
 992       push_ex_oop(ex_oop);      // Push exception oop for handler
 993       if (PrintOpto &amp;&amp; WizardMode) {
 994         tty-&gt;print(&quot;  Catching inline exception bci:%d -&gt; handler_bci:%d -- &quot;, bci(), handler_bci);
 995         klass-&gt;print_name();
 996         tty-&gt;cr();
 997       }
 998       merge_exception(handler_bci);
 999     }
1000     set_control(not_subtype_ctrl);
1001 
1002     // Come here if exception does not match handler.
1003     // Carry on with more handler checks.
1004     --remaining;
1005   }
1006 
1007   assert(!stopped(), &quot;you should return if you finish the chain&quot;);
1008 
1009   // Oops, need to call into the VM to resolve the klasses at runtime.
1010   // Note:  This call must not deoptimize, since it is not a real at this bci!
1011   kill_dead_locals();
1012 
1013   make_runtime_call(RC_NO_LEAF | RC_MUST_THROW,
1014                     OptoRuntime::rethrow_Type(),
1015                     OptoRuntime::rethrow_stub(),
1016                     NULL, NULL,
1017                     ex_node);
1018 
1019   // Rethrow is a pure call, no side effects, only a result.
1020   // The result cannot be allocated, so we use I_O
1021 
1022   // Catch exceptions from the rethrow
1023   catch_call_exceptions(handlers);
1024 }
1025 
1026 
1027 // (Note:  Moved add_debug_info into GraphKit::add_safepoint_edges.)
1028 
1029 
1030 #ifndef PRODUCT
1031 void Parse::count_compiled_calls(bool at_method_entry, bool is_inline) {
1032   if( CountCompiledCalls ) {
1033     if( at_method_entry ) {
1034       // bump invocation counter if top method (for statistics)
1035       if (CountCompiledCalls &amp;&amp; depth() == 1) {
1036         const TypePtr* addr_type = TypeMetadataPtr::make(method());
1037         Node* adr1 = makecon(addr_type);
1038         Node* adr2 = basic_plus_adr(adr1, adr1, in_bytes(Method::compiled_invocation_counter_offset()));
1039         increment_counter(adr2);
1040       }
1041     } else if (is_inline) {
1042       switch (bc()) {
1043       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_inlined_calls_addr()); break;
1044       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_inlined_interface_calls_addr()); break;
1045       case Bytecodes::_invokestatic:
1046       case Bytecodes::_invokedynamic:
1047       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_inlined_static_calls_addr()); break;
1048       default: fatal(&quot;unexpected call bytecode&quot;);
1049       }
1050     } else {
1051       switch (bc()) {
1052       case Bytecodes::_invokevirtual:   increment_counter(SharedRuntime::nof_normal_calls_addr()); break;
1053       case Bytecodes::_invokeinterface: increment_counter(SharedRuntime::nof_interface_calls_addr()); break;
1054       case Bytecodes::_invokestatic:
1055       case Bytecodes::_invokedynamic:
1056       case Bytecodes::_invokespecial:   increment_counter(SharedRuntime::nof_static_calls_addr()); break;
1057       default: fatal(&quot;unexpected call bytecode&quot;);
1058       }
1059     }
1060   }
1061 }
1062 #endif //PRODUCT
1063 
1064 
1065 ciMethod* Compile::optimize_virtual_call(ciMethod* caller, int bci, ciInstanceKlass* klass,
1066                                          ciKlass* holder, ciMethod* callee,
1067                                          const TypeOopPtr* receiver_type, bool is_virtual,
1068                                          bool&amp; call_does_dispatch, int&amp; vtable_index,
1069                                          bool check_access) {
1070   // Set default values for out-parameters.
1071   call_does_dispatch = true;
1072   vtable_index       = Method::invalid_vtable_index;
1073 
1074   // Choose call strategy.
1075   ciMethod* optimized_virtual_method = optimize_inlining(caller, bci, klass, callee,
1076                                                          receiver_type, check_access);
1077 
1078   // Have the call been sufficiently improved such that it is no longer a virtual?
1079   if (optimized_virtual_method != NULL) {
1080     callee             = optimized_virtual_method;
1081     call_does_dispatch = false;
1082   } else if (!UseInlineCaches &amp;&amp; is_virtual &amp;&amp; callee-&gt;is_loaded()) {
1083     // We can make a vtable call at this site
1084     vtable_index = callee-&gt;resolve_vtable_index(caller-&gt;holder(), holder);
1085   }
1086   return callee;
1087 }
1088 
1089 // Identify possible target method and inlining style
1090 ciMethod* Compile::optimize_inlining(ciMethod* caller, int bci, ciInstanceKlass* klass,
1091                                      ciMethod* callee, const TypeOopPtr* receiver_type,
1092                                      bool check_access) {
1093   // only use for virtual or interface calls
1094 
1095   // If it is obviously final, do not bother to call find_monomorphic_target,
1096   // because the class hierarchy checks are not needed, and may fail due to
1097   // incompletely loaded classes.  Since we do our own class loading checks
1098   // in this module, we may confidently bind to any method.
1099   if (callee-&gt;can_be_statically_bound()) {
1100     return callee;
1101   }
1102 
1103   // Attempt to improve the receiver
1104   bool actual_receiver_is_exact = false;
1105   ciInstanceKlass* actual_receiver = klass;
1106   if (receiver_type != NULL) {
1107     // Array methods are all inherited from Object, and are monomorphic.
1108     // finalize() call on array is not allowed.
1109     if (receiver_type-&gt;isa_aryptr() &amp;&amp;
1110         callee-&gt;holder() == env()-&gt;Object_klass() &amp;&amp;
1111         callee-&gt;name() != ciSymbol::finalize_method_name()) {
1112       return callee;
1113     }
1114 
1115     // All other interesting cases are instance klasses.
1116     if (!receiver_type-&gt;isa_instptr()) {
1117       return NULL;
1118     }
1119 
1120     ciInstanceKlass *ikl = receiver_type-&gt;klass()-&gt;as_instance_klass();
1121     if (ikl-&gt;is_loaded() &amp;&amp; ikl-&gt;is_initialized() &amp;&amp; !ikl-&gt;is_interface() &amp;&amp;
1122         (ikl == actual_receiver || ikl-&gt;is_subtype_of(actual_receiver))) {
1123       // ikl is a same or better type than the original actual_receiver,
1124       // e.g. static receiver from bytecodes.
1125       actual_receiver = ikl;
1126       // Is the actual_receiver exact?
1127       actual_receiver_is_exact = receiver_type-&gt;klass_is_exact();
1128     }
1129   }
1130 
1131   ciInstanceKlass*   calling_klass = caller-&gt;holder();
1132   ciMethod* cha_monomorphic_target = callee-&gt;find_monomorphic_target(calling_klass, klass, actual_receiver, check_access);
1133   if (cha_monomorphic_target != NULL) {
1134     assert(!cha_monomorphic_target-&gt;is_abstract(), &quot;&quot;);
1135     // Look at the method-receiver type.  Does it add &quot;too much information&quot;?
1136     ciKlass*    mr_klass = cha_monomorphic_target-&gt;holder();
1137     const Type* mr_type  = TypeInstPtr::make(TypePtr::BotPTR, mr_klass);
1138     if (receiver_type == NULL || !receiver_type-&gt;higher_equal(mr_type)) {
1139       // Calling this method would include an implicit cast to its holder.
1140       // %%% Not yet implemented.  Would throw minor asserts at present.
1141       // %%% The most common wins are already gained by +UseUniqueSubclasses.
1142       // To fix, put the higher_equal check at the call of this routine,
1143       // and add a CheckCastPP to the receiver.
1144       if (TraceDependencies) {
1145         tty-&gt;print_cr(&quot;found unique CHA method, but could not cast up&quot;);
1146         tty-&gt;print(&quot;  method  = &quot;);
1147         cha_monomorphic_target-&gt;print();
1148         tty-&gt;cr();
1149       }
1150       if (log() != NULL) {
1151         log()-&gt;elem(&quot;missed_CHA_opportunity klass=&#39;%d&#39; method=&#39;%d&#39;&quot;,
1152                        log()-&gt;identify(klass),
1153                        log()-&gt;identify(cha_monomorphic_target));
1154       }
1155       cha_monomorphic_target = NULL;
1156     }
1157   }
1158 
1159   if (cha_monomorphic_target != NULL) {
1160     // Hardwiring a virtual.
1161     assert(!callee-&gt;can_be_statically_bound(), &quot;should have been handled earlier&quot;);
1162     assert(!cha_monomorphic_target-&gt;is_abstract(), &quot;&quot;);
1163     if (!cha_monomorphic_target-&gt;can_be_statically_bound(actual_receiver)) {
1164       // If we inlined because CHA revealed only a single target method,
1165       // then we are dependent on that target method not getting overridden
1166       // by dynamic class loading.  Be sure to test the &quot;static&quot; receiver
1167       // dest_method here, as opposed to the actual receiver, which may
1168       // falsely lead us to believe that the receiver is final or private.
1169       dependencies()-&gt;assert_unique_concrete_method(actual_receiver, cha_monomorphic_target);
1170     }
1171     return cha_monomorphic_target;
1172   }
1173 
1174   // If the type is exact, we can still bind the method w/o a vcall.
1175   // (This case comes after CHA so we can see how much extra work it does.)
1176   if (actual_receiver_is_exact) {
1177     // In case of evolution, there is a dependence on every inlined method, since each
1178     // such method can be changed when its class is redefined.
1179     ciMethod* exact_method = callee-&gt;resolve_invoke(calling_klass, actual_receiver);
1180     if (exact_method != NULL) {
1181       if (PrintOpto) {
1182         tty-&gt;print(&quot;  Calling method via exact type @%d --- &quot;, bci);
1183         exact_method-&gt;print_name();
1184         tty-&gt;cr();
1185       }
1186       return exact_method;
1187     }
1188   }
1189 
1190   return NULL;
1191 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>