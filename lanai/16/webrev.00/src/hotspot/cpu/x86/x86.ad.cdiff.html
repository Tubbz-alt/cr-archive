<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/cpu/x86/x86.ad</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="vtableStubs_x86_64.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="x86_32.ad.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/x86/x86.ad</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1260,11 ***</span>
        if (!UsePopCountInstruction) {
          return false;
        }
        break;
      case Op_PopCountVI:
<span class="line-modified">!       if (!UsePopCountInstruction || !VM_Version::supports_vpopcntdq()) {</span>
          return false;
        }
        break;
      case Op_MulVI:
        if ((UseSSE &lt; 4) &amp;&amp; (UseAVX &lt; 1)) { // only with SSE4_1 or AVX
<span class="line-new-header">--- 1260,11 ---</span>
        if (!UsePopCountInstruction) {
          return false;
        }
        break;
      case Op_PopCountVI:
<span class="line-modified">!       if (!UsePopCountInstruction || !VM_Version::supports_avx512_vpopcntdq()) {</span>
          return false;
        }
        break;
      case Op_MulVI:
        if ((UseSSE &lt; 4) &amp;&amp; (UseAVX &lt; 1)) { // only with SSE4_1 or AVX
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1293,18 ***</span>
      case Op_MulReductionVI:
        if (UseSSE &lt; 4) { // requires at least SSE4
          return false;
        }
        break;
<span class="line-removed">-     case Op_AddReductionVF:</span>
<span class="line-removed">-     case Op_AddReductionVD:</span>
<span class="line-removed">-     case Op_MulReductionVF:</span>
<span class="line-removed">-     case Op_MulReductionVD:</span>
<span class="line-removed">-       if (UseSSE &lt; 1) { // requires at least SSE</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-       break;</span>
      case Op_SqrtVD:
      case Op_SqrtVF:
        if (UseAVX &lt; 1) { // enabled for AVX only
          return false;
        }
<span class="line-new-header">--- 1293,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1336,18 ***</span>
      case Op_OnSpinWait:
        if (VM_Version::supports_on_spin_wait() == false) {
          return false;
        }
        break;
<span class="line-removed">-     case Op_MulAddVS2VI:</span>
<span class="line-removed">-     case Op_RShiftVL:</span>
<span class="line-removed">-     case Op_AbsVD:</span>
<span class="line-removed">-     case Op_NegVD:</span>
<span class="line-removed">-       if (UseSSE &lt; 2) {</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-       break;</span>
      case Op_MulVB:
      case Op_LShiftVB:
      case Op_RShiftVB:
      case Op_URShiftVB:
        if (UseSSE &lt; 4) {
<span class="line-new-header">--- 1328,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1379,10 ***</span>
<span class="line-new-header">--- 1363,28 ---</span>
      case Op_RoundDoubleModeV:
        if (VM_Version::supports_avx() == false) {
          return false; // 128bit vroundpd is not available
        }
        break;
<span class="line-added">+ #ifndef _LP64</span>
<span class="line-added">+     case Op_AddReductionVF:</span>
<span class="line-added">+     case Op_AddReductionVD:</span>
<span class="line-added">+     case Op_MulReductionVF:</span>
<span class="line-added">+     case Op_MulReductionVD:</span>
<span class="line-added">+       if (UseSSE &lt; 1) { // requires at least SSE</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+       }</span>
<span class="line-added">+       break;</span>
<span class="line-added">+     case Op_MulAddVS2VI:</span>
<span class="line-added">+     case Op_RShiftVL:</span>
<span class="line-added">+     case Op_AbsVD:</span>
<span class="line-added">+     case Op_NegVD:</span>
<span class="line-added">+       if (UseSSE &lt; 2) {</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+       }</span>
<span class="line-added">+       break;</span>
<span class="line-added">+ #endif // !LP64</span>
    }
    return true;  // Match rules are supported by default.
  }
  
  //------------------------------------------------------------------------
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3120,107 ***</span>
  
  // ====================REPLICATE=======================================
  
  // Replicate byte scalar to be vector
  instruct ReplB_reg(vec dst, rRegI src) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 32) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 64 &amp;&amp; VM_Version::supports_avx512bw())); // AVX512BW for 512bit byte instructions</span>
    match(Set dst (ReplicateB src));
    format %{ &quot;replicateB $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 64 || VM_Version::supports_avx512vlbw()) { // AVX512VL for &lt;512bit operands
<span class="line-modified">!       assert(VM_Version::supports_avx512bw(), &quot;required&quot;);</span>
        int vlen_enc = vector_length_encoding(this);
        __ evpbroadcastb($dst$$XMMRegister, $src$$Register, vlen_enc);
      } else {
        __ movdl($dst$$XMMRegister, $src$$Register);
        __ punpcklbw($dst$$XMMRegister, $dst$$XMMRegister);
        __ pshuflw($dst$$XMMRegister, $dst$$XMMRegister, 0x00);
        if (vlen &gt;= 16) {
          __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
          if (vlen &gt;= 32) {
<span class="line-modified">!           assert(vlen == 32, &quot;sanity&quot;); // vlen == 64 &amp;&amp; !AVX512BW is covered by ReplB_reg_leg</span>
            __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);
          }
        }
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplB_reg_leg(legVec dst, rRegI src) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 64 &amp;&amp; !VM_Version::supports_avx512bw()); // AVX512BW for 512bit byte instructions</span>
<span class="line-removed">-   match(Set dst (ReplicateB src));</span>
<span class="line-removed">-   format %{ &quot;replicateB $dst,$src&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     assert(UseAVX &gt; 2, &quot;required&quot;);</span>
<span class="line-removed">-     __ movdl($dst$$XMMRegister, $src$$Register);</span>
<span class="line-removed">-     __ punpcklbw($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ pshuflw($dst$$XMMRegister, $dst$$XMMRegister, 0x00);</span>
<span class="line-removed">-     __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplB_mem(vec dst, memory mem) %{
<span class="line-modified">!   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 32 &amp;&amp; VM_Version::supports_avx512vlbw()) || // AVX512VL for &lt;512bit operands</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 64 &amp;&amp; VM_Version::supports_avx512bw()));    // AVX512BW for 512bit byte instructions</span>
    match(Set dst (ReplicateB (LoadB mem)));
    format %{ &quot;replicateB $dst,$mem&quot; %}
    ins_encode %{
<span class="line-removed">-     assert(UseAVX &gt; 2, &quot;required&quot;);</span>
      int vector_len = vector_length_encoding(this);
      __ vpbroadcastb($dst$$XMMRegister, $mem$$Address, vector_len);
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplB_imm(vec dst, immI con) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 32) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 64 &amp;&amp; VM_Version::supports_avx512bw())); // AVX512BW for 512bit byte instructions</span>
    match(Set dst (ReplicateB con));
    format %{ &quot;replicateB $dst,$con&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      InternalAddress const_addr = $constantaddress(replicate8_imm($con$$constant, 1));
      if (vlen == 4) {
        __ movdl($dst$$XMMRegister, const_addr);
      } else {
        __ movq($dst$$XMMRegister, const_addr);
        if (vlen &gt;= 16) {
<span class="line-modified">!         if (vlen == 64 || VM_Version::supports_avx512vlbw()) { // AVX512VL for &lt;512bit operands</span>
            int vlen_enc = vector_length_encoding(this);
<span class="line-modified">!           __ vpbroadcastb($dst$$XMMRegister, $dst$$XMMRegister, vlen_enc);</span>
          } else {
            __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
<span class="line-removed">-           if (vlen &gt;= 32) {</span>
<span class="line-removed">-              assert(vlen == 32, &quot;sanity&quot;);// vlen == 64 &amp;&amp; !AVX512BW is covered by ReplB_imm_leg</span>
<span class="line-removed">-             __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-           }</span>
          }
        }
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplB_imm_leg(legVec dst, immI con) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 64 &amp;&amp; !VM_Version::supports_avx512bw());</span>
<span class="line-removed">-   match(Set dst (ReplicateB con));</span>
<span class="line-removed">-   format %{ &quot;replicateB $dst,$con&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ movq($dst$$XMMRegister, $constantaddress(replicate8_imm($con$$constant, 1)));</span>
<span class="line-removed">-     __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  // Replicate byte scalar zero to be vector
  instruct ReplB_zero(vec dst, immI0 zero) %{
    match(Set dst (ReplicateB zero));
    format %{ &quot;replicateB $dst,$zero&quot; %}
    ins_encode %{
<span class="line-new-header">--- 3122,69 ---</span>
  
  // ====================REPLICATE=======================================
  
  // Replicate byte scalar to be vector
  instruct ReplB_reg(vec dst, rRegI src) %{
    match(Set dst (ReplicateB src));
    format %{ &quot;replicateB $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 64 || VM_Version::supports_avx512vlbw()) { // AVX512VL for &lt;512bit operands
<span class="line-modified">!       assert(VM_Version::supports_avx512bw(), &quot;required&quot;); // 512-bit byte vectors assume AVX512BW</span>
        int vlen_enc = vector_length_encoding(this);
        __ evpbroadcastb($dst$$XMMRegister, $src$$Register, vlen_enc);
      } else {
        __ movdl($dst$$XMMRegister, $src$$Register);
        __ punpcklbw($dst$$XMMRegister, $dst$$XMMRegister);
        __ pshuflw($dst$$XMMRegister, $dst$$XMMRegister, 0x00);
        if (vlen &gt;= 16) {
          __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
          if (vlen &gt;= 32) {
<span class="line-modified">!           assert(vlen == 32, &quot;sanity&quot;);</span>
            __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);
          }
        }
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplB_mem(vec dst, memory mem) %{
<span class="line-modified">!   predicate(VM_Version::supports_avx2());</span>
    match(Set dst (ReplicateB (LoadB mem)));
    format %{ &quot;replicateB $dst,$mem&quot; %}
    ins_encode %{
      int vector_len = vector_length_encoding(this);
      __ vpbroadcastb($dst$$XMMRegister, $mem$$Address, vector_len);
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplB_imm(vec dst, immI con) %{
    match(Set dst (ReplicateB con));
    format %{ &quot;replicateB $dst,$con&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      InternalAddress const_addr = $constantaddress(replicate8_imm($con$$constant, 1));
      if (vlen == 4) {
        __ movdl($dst$$XMMRegister, const_addr);
      } else {
        __ movq($dst$$XMMRegister, const_addr);
        if (vlen &gt;= 16) {
<span class="line-modified">!         if (VM_Version::supports_avx2()) {</span>
            int vlen_enc = vector_length_encoding(this);
<span class="line-modified">!           __ vpbroadcastq($dst$$XMMRegister, $dst$$XMMRegister, vlen_enc);</span>
          } else {
<span class="line-added">+           assert(vlen == 16, &quot;sanity&quot;);</span>
            __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
          }
        }
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  // Replicate byte scalar zero to be vector
  instruct ReplB_zero(vec dst, immI0 zero) %{
    match(Set dst (ReplicateB zero));
    format %{ &quot;replicateB $dst,$zero&quot; %}
    ins_encode %{
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3237,130 ***</span>
  %}
  
  // ====================ReplicateS=======================================
  
  instruct ReplS_reg(vec dst, rRegI src) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 16) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 32 &amp;&amp; VM_Version::supports_avx512bw())); // AVX512BW for 512bit instructions on shorts</span>
    match(Set dst (ReplicateS src));
    format %{ &quot;replicateS $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 32 || VM_Version::supports_avx512vlbw()) { // AVX512VL for &lt;512bit operands
<span class="line-modified">!       assert(VM_Version::supports_avx512bw(), &quot;required&quot;);</span>
        int vlen_enc = vector_length_encoding(this);
        __ evpbroadcastw($dst$$XMMRegister, $src$$Register, vlen_enc);
      } else {
        __ movdl($dst$$XMMRegister, $src$$Register);
        __ pshuflw($dst$$XMMRegister, $dst$$XMMRegister, 0x00);
        if (vlen &gt;= 8) {
          __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
          if (vlen &gt;= 16) {
<span class="line-modified">!           assert(vlen == 16, &quot;sanity&quot;); // vlen == 32 &amp;&amp; !AVX512BW is covered by ReplS_reg_leg</span>
            __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);
          }
        }
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplS_reg_leg(legVec dst, rRegI src) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 32 &amp;&amp; !VM_Version::supports_avx512bw());</span>
<span class="line-removed">-   match(Set dst (ReplicateS src));</span>
<span class="line-removed">-   format %{ &quot;replicateS $dst,$src&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ movdl($dst$$XMMRegister, $src$$Register);</span>
<span class="line-removed">-     __ pshuflw($dst$$XMMRegister, $dst$$XMMRegister, 0x00);</span>
<span class="line-removed">-     __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplS_mem(vec dst, memory mem) %{
<span class="line-modified">!   predicate((n-&gt;as_Vector()-&gt;length() &gt;= 4  &amp;&amp;</span>
<span class="line-removed">-              n-&gt;as_Vector()-&gt;length() &lt;= 16 &amp;&amp; VM_Version::supports_avx()) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 32 &amp;&amp; VM_Version::supports_avx512bw())); // AVX512BW for 512bit instructions on shorts</span>
    match(Set dst (ReplicateS (LoadS mem)));
    format %{ &quot;replicateS $dst,$mem&quot; %}
    ins_encode %{
<span class="line-modified">!     uint vlen = vector_length(this);</span>
<span class="line-modified">!     if (vlen == 32 || VM_Version::supports_avx512vlbw()) { // AVX512VL for &lt;512bit operands</span>
<span class="line-removed">-       assert(VM_Version::supports_avx512bw(), &quot;required&quot;);</span>
<span class="line-removed">-       int vlen_enc = vector_length_encoding(this);</span>
<span class="line-removed">-       __ vpbroadcastw($dst$$XMMRegister, $mem$$Address, vlen_enc);</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-       __ pshuflw($dst$$XMMRegister, $mem$$Address, 0x00);</span>
<span class="line-removed">-       if (vlen &gt;= 8) {</span>
<span class="line-removed">-         __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-         if (vlen &gt;= 16) {</span>
<span class="line-removed">-           assert(vlen == 16, &quot;sanity&quot;); // vlen == 32 &amp;&amp; !AVX512BW is covered by ReplS_mem_leg</span>
<span class="line-removed">-           __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
<span class="line-removed">- instruct ReplS_mem_leg(legVec dst, memory mem) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 32 &amp;&amp; !VM_Version::supports_avx512bw());</span>
<span class="line-removed">-   match(Set dst (ReplicateS (LoadS mem)));</span>
<span class="line-removed">-   format %{ &quot;replicateS $dst,$mem&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ pshuflw($dst$$XMMRegister, $mem$$Address, 0x00);</span>
<span class="line-removed">-     __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplS_imm(vec dst, immI con) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 16) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 32 &amp;&amp; VM_Version::supports_avx512bw())); // AVX512BW for 512bit instructions on shorts</span>
    match(Set dst (ReplicateS con));
    format %{ &quot;replicateS $dst,$con&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
<span class="line-modified">!     InternalAddress constaddr = $constantaddress(replicate8_imm($con$$constant, 2));</span>
      if (vlen == 2) {
<span class="line-modified">!       __ movdl($dst$$XMMRegister, constaddr);</span>
      } else {
<span class="line-modified">!       __ movq($dst$$XMMRegister, constaddr);</span>
<span class="line-modified">!       if (vlen == 32 || VM_Version::supports_avx512vlbw() ) { // AVX512VL for &lt;512bit operands</span>
<span class="line-modified">!         assert(VM_Version::supports_avx512bw(), &quot;required&quot;);</span>
<span class="line-modified">!         int vlen_enc = vector_length_encoding(this);</span>
<span class="line-modified">!         __ vpbroadcastw($dst$$XMMRegister, $dst$$XMMRegister, vlen_enc);</span>
<span class="line-modified">!       } else {</span>
<span class="line-modified">!         __ movq($dst$$XMMRegister, constaddr);</span>
<span class="line-modified">!         __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-         if (vlen &gt;= 16) {</span>
<span class="line-removed">-           assert(vlen == 16, &quot;sanity&quot;); // vlen == 32 &amp;&amp; !AVX512BW is covered by ReplS_imm_leg</span>
<span class="line-removed">-           __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
          }
        }
      }
    %}
    ins_pipe( fpu_reg_reg );
  %}
  
<span class="line-removed">- instruct ReplS_imm_leg(legVec dst, immI con) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 32 &amp;&amp; !VM_Version::supports_avx512bw());</span>
<span class="line-removed">-   match(Set dst (ReplicateS con));</span>
<span class="line-removed">-   format %{ &quot;replicateS $dst,$con&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ movq($dst$$XMMRegister, $constantaddress(replicate8_imm($con$$constant, 2)));</span>
<span class="line-removed">-     __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplS_zero(vec dst, immI0 zero) %{
    match(Set dst (ReplicateS zero));
    format %{ &quot;replicateS $dst,$zero&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
<span class="line-new-header">--- 3201,68 ---</span>
  %}
  
  // ====================ReplicateS=======================================
  
  instruct ReplS_reg(vec dst, rRegI src) %{
    match(Set dst (ReplicateS src));
    format %{ &quot;replicateS $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 32 || VM_Version::supports_avx512vlbw()) { // AVX512VL for &lt;512bit operands
<span class="line-modified">!       assert(VM_Version::supports_avx512bw(), &quot;required&quot;); // 512-bit short vectors assume AVX512BW</span>
        int vlen_enc = vector_length_encoding(this);
        __ evpbroadcastw($dst$$XMMRegister, $src$$Register, vlen_enc);
      } else {
        __ movdl($dst$$XMMRegister, $src$$Register);
        __ pshuflw($dst$$XMMRegister, $dst$$XMMRegister, 0x00);
        if (vlen &gt;= 8) {
          __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
          if (vlen &gt;= 16) {
<span class="line-modified">!           assert(vlen == 16, &quot;sanity&quot;);</span>
            __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);
          }
        }
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplS_mem(vec dst, memory mem) %{
<span class="line-modified">!   predicate(VM_Version::supports_avx2());</span>
    match(Set dst (ReplicateS (LoadS mem)));
    format %{ &quot;replicateS $dst,$mem&quot; %}
    ins_encode %{
<span class="line-modified">!     int vlen_enc = vector_length_encoding(this);</span>
<span class="line-modified">!     __ vpbroadcastw($dst$$XMMRegister, $mem$$Address, vlen_enc);</span>
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplS_imm(vec dst, immI con) %{
    match(Set dst (ReplicateS con));
    format %{ &quot;replicateS $dst,$con&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
<span class="line-modified">!     InternalAddress const_addr = $constantaddress(replicate8_imm($con$$constant, 2));</span>
      if (vlen == 2) {
<span class="line-modified">!       __ movdl($dst$$XMMRegister, const_addr);</span>
      } else {
<span class="line-modified">!       __ movq($dst$$XMMRegister, const_addr);</span>
<span class="line-modified">!       if (vlen &gt;= 8) {</span>
<span class="line-modified">!         if (VM_Version::supports_avx2()) {</span>
<span class="line-modified">!           int vlen_enc = vector_length_encoding(this);</span>
<span class="line-modified">!           __ vpbroadcastw($dst$$XMMRegister, $dst$$XMMRegister, vlen_enc);</span>
<span class="line-modified">!         } else {</span>
<span class="line-modified">!           assert(vlen == 8, &quot;sanity&quot;);</span>
<span class="line-modified">!           __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
          }
        }
      }
    %}
    ins_pipe( fpu_reg_reg );
  %}
  
  instruct ReplS_zero(vec dst, immI0 zero) %{
    match(Set dst (ReplicateS zero));
    format %{ &quot;replicateS $dst,$zero&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3375,116 ***</span>
  %}
  
  // ====================ReplicateI=======================================
  
  instruct ReplI_reg(vec dst, rRegI src) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 8) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateI src));
    format %{ &quot;replicateI $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
<span class="line-modified">!     if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vlen_enc = vector_length_encoding(this);
        __ evpbroadcastd($dst$$XMMRegister, $src$$Register, vlen_enc);
      } else {
        __ movdl($dst$$XMMRegister, $src$$Register);
        __ pshufd($dst$$XMMRegister, $dst$$XMMRegister, 0x00);
        if (vlen &gt;= 8) {
<span class="line-modified">!         assert(vlen == 8, &quot;sanity&quot;); // vlen == 16 &amp;&amp; !AVX512VL is covered by ReplI_reg_leg</span>
          __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);
        }
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplI_reg_leg(legVec dst, rRegI src) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateI src));</span>
<span class="line-removed">-   format %{ &quot;replicateI  $dst,$src&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ movdl($dst$$XMMRegister, $src$$Register);</span>
<span class="line-removed">-     __ pshufd($dst$$XMMRegister, $dst$$XMMRegister, 0x00);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplI_mem(vec dst, memory mem) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 8  &amp;&amp; VM_Version::supports_avx()) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateI (LoadI mem)));
    format %{ &quot;replicateI $dst,$mem&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen &lt;= 4) {
<span class="line-modified">!       __ pshufd($dst$$XMMRegister, $mem$$Address, 0x00);</span>
<span class="line-modified">!     } else if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vector_len = vector_length_encoding(this);
        __ vpbroadcastd($dst$$XMMRegister, $mem$$Address, vector_len);
<span class="line-removed">-     } else {</span>
<span class="line-removed">-       assert(vlen == 8, &quot;sanity&quot;); // vlen == 16 &amp;&amp; !AVX512VL is covered by ReplI_mem_leg</span>
<span class="line-removed">-       __ pshufd($dst$$XMMRegister, $mem$$Address, 0x00);</span>
<span class="line-removed">-       __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplI_mem_leg(legVec dst, memory mem) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateI (LoadI mem)));</span>
<span class="line-removed">-   format %{ &quot;replicateI $dst,$mem&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ pshufd($dst$$XMMRegister, $mem$$Address, 0x00);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplI_imm(vec dst, immI con) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 8) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateI con));
    format %{ &quot;replicateI $dst,$con&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
<span class="line-modified">!     InternalAddress constaddr = $constantaddress(replicate8_imm($con$$constant, 4));</span>
<span class="line-modified">!     if (vlen == 2) {</span>
<span class="line-modified">!       __ movq($dst$$XMMRegister, constaddr);</span>
<span class="line-modified">!     } else if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vector_len = vector_length_encoding(this);
<span class="line-modified">!       __ movq($dst$$XMMRegister, constaddr);</span>
        __ vpbroadcastd($dst$$XMMRegister, $dst$$XMMRegister, vector_len);
<span class="line-removed">-     } else {</span>
<span class="line-removed">-       __ movq($dst$$XMMRegister, constaddr);</span>
<span class="line-removed">-       __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-       if (vlen &gt;= 8) {</span>
<span class="line-removed">-         assert(vlen == 8, &quot;sanity&quot;);</span>
<span class="line-removed">-         __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-       }</span>
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplI_imm_leg(legVec dst, immI con) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateI con));</span>
<span class="line-removed">-   format %{ &quot;replicateI $dst,$con&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ movq($dst$$XMMRegister, $constantaddress(replicate8_imm($con$$constant, 4)));</span>
<span class="line-removed">-     __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  // Replicate integer (4 byte) scalar zero to be vector
  instruct ReplI_zero(vec dst, immI0 zero) %{
    match(Set dst (ReplicateI zero));
    format %{ &quot;replicateI $dst,$zero&quot; %}
    ins_encode %{
<span class="line-new-header">--- 3277,67 ---</span>
  %}
  
  // ====================ReplicateI=======================================
  
  instruct ReplI_reg(vec dst, rRegI src) %{
    match(Set dst (ReplicateI src));
    format %{ &quot;replicateI $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
<span class="line-modified">!     if (vlen == 16 || VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vlen_enc = vector_length_encoding(this);
        __ evpbroadcastd($dst$$XMMRegister, $src$$Register, vlen_enc);
      } else {
        __ movdl($dst$$XMMRegister, $src$$Register);
        __ pshufd($dst$$XMMRegister, $dst$$XMMRegister, 0x00);
        if (vlen &gt;= 8) {
<span class="line-modified">!         assert(vlen == 8, &quot;sanity&quot;);</span>
          __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);
        }
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplI_mem(vec dst, memory mem) %{
    match(Set dst (ReplicateI (LoadI mem)));
    format %{ &quot;replicateI $dst,$mem&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen &lt;= 4) {
<span class="line-modified">!       __ movdl($dst$$XMMRegister, $mem$$Address);</span>
<span class="line-modified">!       __ pshufd($dst$$XMMRegister, $dst$$XMMRegister, 0x00);</span>
<span class="line-added">+     } else {</span>
<span class="line-added">+       assert(VM_Version::supports_avx2(), &quot;sanity&quot;);</span>
        int vector_len = vector_length_encoding(this);
        __ vpbroadcastd($dst$$XMMRegister, $mem$$Address, vector_len);
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplI_imm(vec dst, immI con) %{
    match(Set dst (ReplicateI con));
    format %{ &quot;replicateI $dst,$con&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
<span class="line-modified">!     InternalAddress const_addr = $constantaddress(replicate8_imm($con$$constant, 4));</span>
<span class="line-modified">!     if (vlen &lt;= 4) {</span>
<span class="line-modified">!       __ movq($dst$$XMMRegister, const_addr);</span>
<span class="line-modified">!       if (vlen == 4) {</span>
<span class="line-added">+         __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-added">+       }</span>
<span class="line-added">+     } else {</span>
<span class="line-added">+       assert(VM_Version::supports_avx2(), &quot;sanity&quot;);</span>
        int vector_len = vector_length_encoding(this);
<span class="line-modified">!       __ movq($dst$$XMMRegister, const_addr);</span>
        __ vpbroadcastd($dst$$XMMRegister, $dst$$XMMRegister, vector_len);
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  // Replicate integer (4 byte) scalar zero to be vector
  instruct ReplI_zero(vec dst, immI0 zero) %{
    match(Set dst (ReplicateI zero));
    format %{ &quot;replicateI $dst,$zero&quot; %}
    ins_encode %{
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3502,44 ***</span>
  // ====================ReplicateL=======================================
  
  #ifdef _LP64
  // Replicate long (8 byte) scalar to be vector
  instruct ReplL_reg(vec dst, rRegL src) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 4) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateL src));
    format %{ &quot;replicateL $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 2) {
        __ movdq($dst$$XMMRegister, $src$$Register);
        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
<span class="line-modified">!     } else if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vlen_enc = vector_length_encoding(this);
        __ evpbroadcastq($dst$$XMMRegister, $src$$Register, vlen_enc);
      } else {
<span class="line-modified">!       assert(vlen == 4, &quot;sanity&quot;); // vlen == 8 &amp;&amp; !AVX512VL is covered by ReplL_reg_leg</span>
        __ movdq($dst$$XMMRegister, $src$$Register);
        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
        __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);
      }
    %}
    ins_pipe( pipe_slow );
  %}
<span class="line-removed">- </span>
<span class="line-removed">- instruct ReplL_reg_leg(legVec dst, rRegL src) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateL src));</span>
<span class="line-removed">-   format %{ &quot;replicateL $dst,$src&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ movdq($dst$$XMMRegister, $src$$Register);</span>
<span class="line-removed">-     __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
  #else // _LP64
  // Replicate long (8 byte) scalar to be vector
  instruct ReplL_reg(vec dst, eRegL src, vec tmp) %{
    predicate(n-&gt;as_Vector()-&gt;length() &lt;= 4);
    match(Set dst (ReplicateL src));
<span class="line-new-header">--- 3355,29 ---</span>
  // ====================ReplicateL=======================================
  
  #ifdef _LP64
  // Replicate long (8 byte) scalar to be vector
  instruct ReplL_reg(vec dst, rRegL src) %{
    match(Set dst (ReplicateL src));
    format %{ &quot;replicateL $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 2) {
        __ movdq($dst$$XMMRegister, $src$$Register);
        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
<span class="line-modified">!     } else if (vlen == 8 || VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vlen_enc = vector_length_encoding(this);
        __ evpbroadcastq($dst$$XMMRegister, $src$$Register, vlen_enc);
      } else {
<span class="line-modified">!       assert(vlen == 4, &quot;sanity&quot;);</span>
        __ movdq($dst$$XMMRegister, $src$$Register);
        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
        __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);
      }
    %}
    ins_pipe( pipe_slow );
  %}
  #else // _LP64
  // Replicate long (8 byte) scalar to be vector
  instruct ReplL_reg(vec dst, eRegL src, vec tmp) %{
    predicate(n-&gt;as_Vector()-&gt;length() &lt;= 4);
    match(Set dst (ReplicateL src));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3593,84 ***</span>
    ins_pipe( pipe_slow );
  %}
  #endif // _LP64
  
  instruct ReplL_mem(vec dst, memory mem) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 4) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateL (LoadL mem)));
    format %{ &quot;replicateL $dst,$mem&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 2) {
        __ movq($dst$$XMMRegister, $mem$$Address);
        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
<span class="line-modified">!     } else if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vlen_enc = vector_length_encoding(this);
        __ vpbroadcastq($dst$$XMMRegister, $mem$$Address, vlen_enc);
<span class="line-removed">-     } else {</span>
<span class="line-removed">-       assert(vlen == 4, &quot;sanity&quot;); // vlen == 8 &amp;&amp; !AVX512VL is covered by ReplL_mem_leg</span>
<span class="line-removed">-       __ movq($dst$$XMMRegister, $mem$$Address);</span>
<span class="line-removed">-       __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-       __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplL_mem_leg(legVec dst, memory mem) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateL (LoadL mem)));</span>
<span class="line-removed">-   format %{ &quot;replicateL $dst,$mem&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ movq($dst$$XMMRegister, $mem$$Address);</span>
<span class="line-removed">-     __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  // Replicate long (8 byte) scalar immediate to be vector by loading from const table.
  instruct ReplL_imm(vec dst, immL con) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 4) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateL con));
    format %{ &quot;replicateL $dst,$con&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      InternalAddress const_addr = $constantaddress($con);
      if (vlen == 2) {
        __ movq($dst$$XMMRegister, const_addr);
        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
<span class="line-modified">!     } else if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vlen_enc = vector_length_encoding(this);
        __ movq($dst$$XMMRegister, const_addr);
        __ vpbroadcastq($dst$$XMMRegister, $dst$$XMMRegister, vlen_enc);
<span class="line-removed">-     } else {</span>
<span class="line-removed">-       assert(vlen == 4, &quot;sanity&quot;); // vlen == 8 &amp;&amp; !AVX512VL is covered by ReplL_imm_leg</span>
<span class="line-removed">-       __ movq($dst$$XMMRegister, const_addr);</span>
<span class="line-removed">-       __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-       __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplL_imm_leg(legVec dst, immL con) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateL con));</span>
<span class="line-removed">-   format %{ &quot;replicateL $dst,$con&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ movq($dst$$XMMRegister, $constantaddress($con));</span>
<span class="line-removed">-     __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplL_zero(vec dst, immL0 zero) %{
    match(Set dst (ReplicateL zero));
    format %{ &quot;replicateL $dst,$zero&quot; %}
    ins_encode %{
      int vlen = vector_length(this);
<span class="line-new-header">--- 3431,46 ---</span>
    ins_pipe( pipe_slow );
  %}
  #endif // _LP64
  
  instruct ReplL_mem(vec dst, memory mem) %{
    match(Set dst (ReplicateL (LoadL mem)));
    format %{ &quot;replicateL $dst,$mem&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 2) {
        __ movq($dst$$XMMRegister, $mem$$Address);
        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
<span class="line-modified">!     } else {</span>
<span class="line-added">+       assert(VM_Version::supports_avx2(), &quot;sanity&quot;);</span>
        int vlen_enc = vector_length_encoding(this);
        __ vpbroadcastq($dst$$XMMRegister, $mem$$Address, vlen_enc);
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  // Replicate long (8 byte) scalar immediate to be vector by loading from const table.
  instruct ReplL_imm(vec dst, immL con) %{
    match(Set dst (ReplicateL con));
    format %{ &quot;replicateL $dst,$con&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      InternalAddress const_addr = $constantaddress($con);
      if (vlen == 2) {
        __ movq($dst$$XMMRegister, const_addr);
        __ punpcklqdq($dst$$XMMRegister, $dst$$XMMRegister);
<span class="line-modified">!     } else {</span>
<span class="line-added">+       assert(VM_Version::supports_avx2(), &quot;sanity&quot;);</span>
        int vlen_enc = vector_length_encoding(this);
        __ movq($dst$$XMMRegister, const_addr);
        __ vpbroadcastq($dst$$XMMRegister, $dst$$XMMRegister, vlen_enc);
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplL_zero(vec dst, immL0 zero) %{
    match(Set dst (ReplicateL zero));
    format %{ &quot;replicateL $dst,$zero&quot; %}
    ins_encode %{
      int vlen = vector_length(this);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3685,75 ***</span>
  %}
  
  // ====================ReplicateF=======================================
  
  instruct ReplF_reg(vec dst, vlRegF src) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 8) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateF src));
    format %{ &quot;replicateF $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen &lt;= 4) {
        __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x00);
<span class="line-modified">!     } else if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vector_len = vector_length_encoding(this);
<span class="line-modified">!       __ vpbroadcastss($dst$$XMMRegister, $src$$XMMRegister, vector_len);</span>
      } else {
<span class="line-modified">!       assert(vlen == 8, &quot;sanity&quot;); // vlen == 16 &amp;&amp; !AVX512VL is covered by ReplF_reg_leg</span>
        __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x00);
        __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplF_reg_leg(legVec dst, vlRegF src) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateF src));</span>
<span class="line-removed">-   format %{ &quot;replicateF $dst,$src&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x00);</span>
<span class="line-removed">-     __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplF_mem(vec dst, memory mem) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 8  &amp;&amp; VM_Version::supports_avx()) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateF (LoadF mem)));
    format %{ &quot;replicateF $dst,$mem&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen &lt;= 4) {
<span class="line-modified">!       __ pshufd($dst$$XMMRegister, $mem$$Address, 0x00);</span>
<span class="line-modified">!     } else if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
<span class="line-removed">-       int vector_len = vector_length_encoding(this);</span>
<span class="line-removed">-       __ vpbroadcastss($dst$$XMMRegister, $mem$$Address, vector_len);</span>
      } else {
<span class="line-modified">!       assert(vlen == 8, &quot;sanity&quot;); // vlen == 16 &amp;&amp; !AVX512VL is covered by ReplF_mem_leg</span>
<span class="line-modified">!       __ pshufd($dst$$XMMRegister, $mem$$Address, 0x00);</span>
<span class="line-modified">!       __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplF_mem_leg(legVec dst, memory mem) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 16 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateF (LoadF mem)));</span>
<span class="line-removed">-   format %{ &quot;replicateF $dst,$mem&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ pshufd($dst$$XMMRegister, $mem$$Address, 0x00);</span>
<span class="line-removed">-     __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplF_zero(vec dst, immF0 zero) %{
    match(Set dst (ReplicateF zero));
    format %{ &quot;replicateF $dst,$zero&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
<span class="line-new-header">--- 3485,45 ---</span>
  %}
  
  // ====================ReplicateF=======================================
  
  instruct ReplF_reg(vec dst, vlRegF src) %{
    match(Set dst (ReplicateF src));
    format %{ &quot;replicateF $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen &lt;= 4) {
        __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x00);
<span class="line-modified">!    } else if (VM_Version::supports_avx2()) {</span>
        int vector_len = vector_length_encoding(this);
<span class="line-modified">!       __ vbroadcastss($dst$$XMMRegister, $src$$XMMRegister, vector_len); // reg-to-reg variant requires AVX2</span>
      } else {
<span class="line-modified">!       assert(vlen == 8, &quot;sanity&quot;);</span>
        __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x00);
        __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplF_mem(vec dst, memory mem) %{
    match(Set dst (ReplicateF (LoadF mem)));
    format %{ &quot;replicateF $dst,$mem&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen &lt;= 4) {
<span class="line-modified">!       __ movdl($dst$$XMMRegister, $mem$$Address);</span>
<span class="line-modified">!       __ pshufd($dst$$XMMRegister, $dst$$XMMRegister, 0x00);</span>
      } else {
<span class="line-modified">!       assert(VM_Version::supports_avx(), &quot;sanity&quot;);</span>
<span class="line-modified">!       int vector_len = vector_length_encoding(this);</span>
<span class="line-modified">!       __ vbroadcastss($dst$$XMMRegister, $mem$$Address, vector_len);</span>
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplF_zero(vec dst, immF0 zero) %{
    match(Set dst (ReplicateF zero));
    format %{ &quot;replicateF $dst,$zero&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3769,75 ***</span>
  
  // ====================ReplicateD=======================================
  
  // Replicate double (8 bytes) scalar to be vector
  instruct ReplD_reg(vec dst, vlRegD src) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 4) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateD src));
    format %{ &quot;replicateD $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 2) {
        __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x44);
<span class="line-modified">!     } else if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
        int vector_len = vector_length_encoding(this);
<span class="line-modified">!       __ vpbroadcastsd($dst$$XMMRegister, $src$$XMMRegister, vector_len);</span>
      } else {
<span class="line-modified">!       assert(vlen == 4, &quot;sanity&quot;); // vlen == 8 &amp;&amp; !AVX512VL is covered by ReplD_reg_leg</span>
        __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x44);
        __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplD_reg_leg(legVec dst, vlRegD src) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateD src));</span>
<span class="line-removed">-   format %{ &quot;replicateD $dst,$src&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x44);</span>
<span class="line-removed">-     __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplD_mem(vec dst, memory mem) %{
<span class="line-removed">-   predicate((n-&gt;as_Vector()-&gt;length() &lt;= 4 &amp;&amp; VM_Version::supports_avx()) ||</span>
<span class="line-removed">-             (n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; VM_Version::supports_avx512vl()));</span>
    match(Set dst (ReplicateD (LoadD mem)));
    format %{ &quot;replicateD $dst,$mem&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 2) {
<span class="line-modified">!       __ pshufd($dst$$XMMRegister, $mem$$Address, 0x44);</span>
<span class="line-modified">!     } else if (VM_Version::supports_avx512vl()) { // AVX512VL for &lt;512bit operands</span>
<span class="line-removed">-       int vector_len = vector_length_encoding(this);</span>
<span class="line-removed">-       __ vpbroadcastsd($dst$$XMMRegister, $mem$$Address, vector_len);</span>
      } else {
<span class="line-modified">!       assert(vlen == 4, &quot;sanity&quot;); // vlen == 8 &amp;&amp; !AVX512VL is covered by ReplD_mem_leg</span>
<span class="line-modified">!       __ pshufd($dst$$XMMRegister, $mem$$Address, 0x44);</span>
<span class="line-modified">!       __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct ReplD_mem_leg(legVec dst, memory mem) %{</span>
<span class="line-removed">-   predicate(n-&gt;as_Vector()-&gt;length() == 8 &amp;&amp; !VM_Version::supports_avx512vl());</span>
<span class="line-removed">-   match(Set dst (ReplicateD (LoadD mem)));</span>
<span class="line-removed">-   format %{ &quot;replicateD $dst,$mem&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ pshufd($dst$$XMMRegister, $mem$$Address, 0x44);</span>
<span class="line-removed">-     __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);</span>
<span class="line-removed">-     __ vinserti64x4($dst$$XMMRegister, $dst$$XMMRegister, $dst$$XMMRegister, 0x1);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  instruct ReplD_zero(vec dst, immD0 zero) %{
    match(Set dst (ReplicateD zero));
    format %{ &quot;replicateD $dst,$zero&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
<span class="line-new-header">--- 3539,45 ---</span>
  
  // ====================ReplicateD=======================================
  
  // Replicate double (8 bytes) scalar to be vector
  instruct ReplD_reg(vec dst, vlRegD src) %{
    match(Set dst (ReplicateD src));
    format %{ &quot;replicateD $dst,$src&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 2) {
        __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x44);
<span class="line-modified">!     } else if (VM_Version::supports_avx2()) {</span>
        int vector_len = vector_length_encoding(this);
<span class="line-modified">!       __ vbroadcastsd($dst$$XMMRegister, $src$$XMMRegister, vector_len); // reg-to-reg variant requires AVX2</span>
      } else {
<span class="line-modified">!       assert(vlen == 4, &quot;sanity&quot;);</span>
        __ pshufd($dst$$XMMRegister, $src$$XMMRegister, 0x44);
        __ vinsertf128_high($dst$$XMMRegister, $dst$$XMMRegister);
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplD_mem(vec dst, memory mem) %{
    match(Set dst (ReplicateD (LoadD mem)));
    format %{ &quot;replicateD $dst,$mem&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
      if (vlen == 2) {
<span class="line-modified">!       __ movq($dst$$XMMRegister, $mem$$Address);</span>
<span class="line-modified">!       __ pshufd($dst$$XMMRegister, $dst$$XMMRegister, 0x44);</span>
      } else {
<span class="line-modified">!       assert(VM_Version::supports_avx(), &quot;sanity&quot;);</span>
<span class="line-modified">!       int vector_len = vector_length_encoding(this);</span>
<span class="line-modified">!       __ vbroadcastsd($dst$$XMMRegister, $mem$$Address, vector_len);</span>
      }
    %}
    ins_pipe( pipe_slow );
  %}
  
  instruct ReplD_zero(vec dst, immD0 zero) %{
    match(Set dst (ReplicateD zero));
    format %{ &quot;replicateD $dst,$zero&quot; %}
    ins_encode %{
      uint vlen = vector_length(this);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 5394,22 ***</span>
      __ movdl($dst$$XMMRegister, $cnt$$Register);
    %}
    ins_pipe( pipe_slow );
  %}
  
<span class="line-removed">- instruct vshiftcntimm(vec dst, immI8 cnt, rRegI tmp) %{</span>
<span class="line-removed">-   match(Set dst cnt);</span>
<span class="line-removed">-   effect(TEMP tmp);</span>
<span class="line-removed">-   format %{ &quot;movl    $tmp,$cnt\t&quot;</span>
<span class="line-removed">-             &quot;movdl   $dst,$tmp\t! load shift count&quot; %}</span>
<span class="line-removed">-   ins_encode %{</span>
<span class="line-removed">-     __ movl($tmp$$Register, $cnt$$constant);</span>
<span class="line-removed">-     __ movdl($dst$$XMMRegister, $tmp$$Register);</span>
<span class="line-removed">-   %}</span>
<span class="line-removed">-   ins_pipe( pipe_slow );</span>
<span class="line-removed">- %}</span>
<span class="line-removed">- </span>
  // Byte vector shift
  instruct vshiftB(vec dst, vec src, vec shift, vec tmp, rRegI scratch) %{
    predicate(n-&gt;as_Vector()-&gt;length() &lt;= 8);
    match(Set dst (LShiftVB src shift));
    match(Set dst (RShiftVB src shift));
<span class="line-new-header">--- 5134,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 5936,11 ***</span>
  %}
  
  // --------------------------------- Vector Multiply Add Add ----------------------------------
  
  instruct vmuladdaddS2I_reg(vec dst, vec src1, vec src2) %{
<span class="line-modified">!   predicate(VM_Version::supports_vnni());</span>
    match(Set dst (AddVI (MulAddVS2VI src1 src2) dst));
    format %{ &quot;evpdpwssd $dst,$src1,$src2\t! muladdadd packedStoI&quot; %}
    ins_encode %{
      assert(UseAVX &gt; 2, &quot;required&quot;);
      int vector_len = vector_length_encoding(this);
<span class="line-new-header">--- 5664,11 ---</span>
  %}
  
  // --------------------------------- Vector Multiply Add Add ----------------------------------
  
  instruct vmuladdaddS2I_reg(vec dst, vec src1, vec src2) %{
<span class="line-modified">!   predicate(VM_Version::supports_avx512_vnni());</span>
    match(Set dst (AddVI (MulAddVS2VI src1 src2) dst));
    format %{ &quot;evpdpwssd $dst,$src1,$src2\t! muladdadd packedStoI&quot; %}
    ins_encode %{
      assert(UseAVX &gt; 2, &quot;required&quot;);
      int vector_len = vector_length_encoding(this);
</pre>
<center><a href="vtableStubs_x86_64.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="x86_32.ad.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>