<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/cpu/sparc/interp_masm_sparc.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;asm/macroAssembler.inline.hpp&quot;
  27 #include &quot;interp_masm_sparc.hpp&quot;
  28 #include &quot;interpreter/interpreter.hpp&quot;
  29 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  30 #include &quot;logging/log.hpp&quot;
  31 #include &quot;oops/arrayOop.hpp&quot;
  32 #include &quot;oops/markWord.hpp&quot;
  33 #include &quot;oops/methodData.hpp&quot;
  34 #include &quot;oops/method.hpp&quot;
  35 #include &quot;oops/methodCounters.hpp&quot;
  36 #include &quot;prims/jvmtiExport.hpp&quot;
  37 #include &quot;prims/jvmtiThreadState.hpp&quot;
  38 #include &quot;runtime/basicLock.hpp&quot;
  39 #include &quot;runtime/biasedLocking.hpp&quot;
  40 #include &quot;runtime/frame.inline.hpp&quot;
  41 #include &quot;runtime/safepointMechanism.hpp&quot;
  42 #include &quot;runtime/sharedRuntime.hpp&quot;
  43 #include &quot;runtime/thread.inline.hpp&quot;
  44 #include &quot;utilities/align.hpp&quot;
  45 
  46 // Implementation of InterpreterMacroAssembler
  47 
  48 // This file specializes the assember with interpreter-specific macros
  49 
  50 const Address InterpreterMacroAssembler::l_tmp(FP, (frame::interpreter_frame_l_scratch_fp_offset * wordSize) + STACK_BIAS);
  51 const Address InterpreterMacroAssembler::d_tmp(FP, (frame::interpreter_frame_d_scratch_fp_offset * wordSize) + STACK_BIAS);
  52 
  53 void InterpreterMacroAssembler::jump_to_entry(address entry) {
  54   assert(entry, &quot;Entry must have been generated by now&quot;);
  55   AddressLiteral al(entry);
  56   jump_to(al, G3_scratch);
  57   delayed()-&gt;nop();
  58 }
  59 
  60 void InterpreterMacroAssembler::compute_extra_locals_size_in_bytes(Register args_size, Register locals_size, Register delta) {
  61   // Note: this algorithm is also used by C1&#39;s OSR entry sequence.
  62   // Any changes should also be applied to CodeEmitter::emit_osr_entry().
  63   assert_different_registers(args_size, locals_size);
  64   // max_locals*2 for TAGS.  Assumes that args_size has already been adjusted.
  65   subcc(locals_size, args_size, delta);// extra space for non-arguments locals in words
  66   // Use br/mov combination because it works on both V8 and V9 and is
  67   // faster.
  68   Label skip_move;
  69   br(Assembler::negative, true, Assembler::pt, skip_move);
  70   delayed()-&gt;mov(G0, delta);
  71   bind(skip_move);
  72   align_up(delta, WordsPerLong);       // make multiple of 2 (SP must be 2-word aligned)
  73   sll(delta, LogBytesPerWord, delta);  // extra space for locals in bytes
  74 }
  75 
  76 // Dispatch code executed in the prolog of a bytecode which does not do it&#39;s
  77 // own dispatch. The dispatch address is computed and placed in IdispatchAddress
  78 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int bcp_incr) {
  79   assert_not_delayed();
  80   ldub( Lbcp, bcp_incr, Lbyte_code);                    // load next bytecode
  81   // dispatch table to use
  82   AddressLiteral tbl(Interpreter::dispatch_table(state));
  83   sll(Lbyte_code, LogBytesPerWord, Lbyte_code);         // multiply by wordSize
  84   set(tbl, G3_scratch);                                 // compute addr of table
  85   ld_ptr(G3_scratch, Lbyte_code, IdispatchAddress);     // get entry addr
  86 }
  87 
  88 
  89 // Dispatch code executed in the epilog of a bytecode which does not do it&#39;s
  90 // own dispatch. The dispatch address in IdispatchAddress is used for the
  91 // dispatch.
  92 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int bcp_incr) {
  93   assert_not_delayed();
  94   interp_verify_oop(Otos_i, state, __FILE__, __LINE__);
  95   jmp( IdispatchAddress, 0 );
  96   if (bcp_incr != 0)  delayed()-&gt;inc(Lbcp, bcp_incr);
  97   else                delayed()-&gt;nop();
  98 }
  99 
 100 void InterpreterMacroAssembler::dispatch_next(TosState state, int bcp_incr, bool generate_poll) {
 101   // %%%% consider branching to a single shared dispatch stub (for each bcp_incr)
 102   assert_not_delayed();
 103   ldub( Lbcp, bcp_incr, Lbyte_code);               // load next bytecode
 104   dispatch_Lbyte_code(state, Interpreter::dispatch_table(state), bcp_incr, true, generate_poll);
 105 }
 106 
 107 
 108 void InterpreterMacroAssembler::dispatch_next_noverify_oop(TosState state, int bcp_incr) {
 109   // %%%% consider branching to a single shared dispatch stub (for each bcp_incr)
 110   assert_not_delayed();
 111   ldub( Lbcp, bcp_incr, Lbyte_code);               // load next bytecode
 112   dispatch_Lbyte_code(state, Interpreter::dispatch_table(state), bcp_incr, false);
 113 }
 114 
 115 
 116 void InterpreterMacroAssembler::dispatch_via(TosState state, address* table) {
 117   // load current bytecode
 118   assert_not_delayed();
 119   ldub( Lbcp, 0, Lbyte_code);               // load next bytecode
 120   dispatch_base(state, table);
 121 }
 122 
 123 
 124 void InterpreterMacroAssembler::call_VM_leaf_base(
 125   Register java_thread,
 126   address  entry_point,
 127   int      number_of_arguments
 128 ) {
 129   if (!java_thread-&gt;is_valid())
 130     java_thread = L7_thread_cache;
 131   // super call
 132   MacroAssembler::call_VM_leaf_base(java_thread, entry_point, number_of_arguments);
 133 }
 134 
 135 
 136 void InterpreterMacroAssembler::call_VM_base(
 137   Register        oop_result,
 138   Register        java_thread,
 139   Register        last_java_sp,
 140   address         entry_point,
 141   int             number_of_arguments,
 142   bool            check_exception
 143 ) {
 144   if (!java_thread-&gt;is_valid())
 145     java_thread = L7_thread_cache;
 146   // See class ThreadInVMfromInterpreter, which assumes that the interpreter
 147   // takes responsibility for setting its own thread-state on call-out.
 148   // However, ThreadInVMfromInterpreter resets the state to &quot;in_Java&quot;.
 149 
 150   //save_bcp();                                  // save bcp
 151   MacroAssembler::call_VM_base(oop_result, java_thread, last_java_sp, entry_point, number_of_arguments, check_exception);
 152   //restore_bcp();                               // restore bcp
 153   //restore_locals();                            // restore locals pointer
 154 }
 155 
 156 
 157 void InterpreterMacroAssembler::check_and_handle_popframe(Register scratch_reg) {
 158   if (JvmtiExport::can_pop_frame()) {
 159     Label L;
 160 
 161     // Check the &quot;pending popframe condition&quot; flag in the current thread
 162     ld(G2_thread, JavaThread::popframe_condition_offset(), scratch_reg);
 163 
 164     // Initiate popframe handling only if it is not already being processed.  If the flag
 165     // has the popframe_processing bit set, it means that this code is called *during* popframe
 166     // handling - we don&#39;t want to reenter.
 167     btst(JavaThread::popframe_pending_bit, scratch_reg);
 168     br(zero, false, pt, L);
 169     delayed()-&gt;nop();
 170     btst(JavaThread::popframe_processing_bit, scratch_reg);
 171     br(notZero, false, pt, L);
 172     delayed()-&gt;nop();
 173 
 174     // Call Interpreter::remove_activation_preserving_args_entry() to get the
 175     // address of the same-named entrypoint in the generated interpreter code.
 176     call_VM_leaf(noreg, CAST_FROM_FN_PTR(address, Interpreter::remove_activation_preserving_args_entry));
 177 
 178     // Jump to Interpreter::_remove_activation_preserving_args_entry
 179     jmpl(O0, G0, G0);
 180     delayed()-&gt;nop();
 181     bind(L);
 182   }
 183 }
 184 
 185 
 186 void InterpreterMacroAssembler::load_earlyret_value(TosState state) {
 187   Register thr_state = G4_scratch;
 188   ld_ptr(G2_thread, JavaThread::jvmti_thread_state_offset(), thr_state);
 189   const Address tos_addr(thr_state, JvmtiThreadState::earlyret_tos_offset());
 190   const Address oop_addr(thr_state, JvmtiThreadState::earlyret_oop_offset());
 191   const Address val_addr(thr_state, JvmtiThreadState::earlyret_value_offset());
 192   switch (state) {
 193   case ltos: ld_long(val_addr, Otos_l);                   break;
 194   case atos: ld_ptr(oop_addr, Otos_l);
 195              st_ptr(G0, oop_addr);                        break;
 196   case btos:                                           // fall through
 197   case ztos:                                           // fall through
 198   case ctos:                                           // fall through
 199   case stos:                                           // fall through
 200   case itos: ld(val_addr, Otos_l1);                       break;
 201   case ftos: ldf(FloatRegisterImpl::S, val_addr, Ftos_f); break;
 202   case dtos: ldf(FloatRegisterImpl::D, val_addr, Ftos_d); break;
 203   case vtos: /* nothing to do */                          break;
 204   default  : ShouldNotReachHere();
 205   }
 206   // Clean up tos value in the jvmti thread state
 207   or3(G0, ilgl, G3_scratch);
 208   stw(G3_scratch, tos_addr);
 209   st_long(G0, val_addr);
 210   interp_verify_oop(Otos_i, state, __FILE__, __LINE__);
 211 }
 212 
 213 
 214 void InterpreterMacroAssembler::check_and_handle_earlyret(Register scratch_reg) {
 215   if (JvmtiExport::can_force_early_return()) {
 216     Label L;
 217     Register thr_state = G3_scratch;
 218     ld_ptr(G2_thread, JavaThread::jvmti_thread_state_offset(), thr_state);
 219     br_null_short(thr_state, pt, L); // if (thread-&gt;jvmti_thread_state() == NULL) exit;
 220 
 221     // Initiate earlyret handling only if it is not already being processed.
 222     // If the flag has the earlyret_processing bit set, it means that this code
 223     // is called *during* earlyret handling - we don&#39;t want to reenter.
 224     ld(thr_state, JvmtiThreadState::earlyret_state_offset(), G4_scratch);
 225     cmp_and_br_short(G4_scratch, JvmtiThreadState::earlyret_pending, Assembler::notEqual, pt, L);
 226 
 227     // Call Interpreter::remove_activation_early_entry() to get the address of the
 228     // same-named entrypoint in the generated interpreter code
 229     ld(thr_state, JvmtiThreadState::earlyret_tos_offset(), Otos_l1);
 230     call_VM_leaf(noreg, CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), Otos_l1);
 231 
 232     // Jump to Interpreter::_remove_activation_early_entry
 233     jmpl(O0, G0, G0);
 234     delayed()-&gt;nop();
 235     bind(L);
 236   }
 237 }
 238 
 239 
 240 void InterpreterMacroAssembler::super_call_VM_leaf(Register thread_cache, address entry_point, Register arg_1, Register arg_2) {
 241   mov(arg_1, O0);
 242   mov(arg_2, O1);
 243   MacroAssembler::call_VM_leaf_base(thread_cache, entry_point, 2);
 244 }
 245 
 246 void InterpreterMacroAssembler::dispatch_base(TosState state, address* table) {
 247   assert_not_delayed();
 248   dispatch_Lbyte_code(state, table);
 249 }
 250 
 251 
 252 void InterpreterMacroAssembler::dispatch_normal(TosState state) {
 253   dispatch_base(state, Interpreter::normal_table(state));
 254 }
 255 
 256 
 257 void InterpreterMacroAssembler::dispatch_only(TosState state) {
 258   dispatch_base(state, Interpreter::dispatch_table(state));
 259 }
 260 
 261 
 262 // common code to dispatch and dispatch_only
 263 // dispatch value in Lbyte_code and increment Lbcp
 264 
 265 void InterpreterMacroAssembler::dispatch_Lbyte_code(TosState state, address* table, int bcp_incr, bool verify, bool generate_poll) {
 266   // %%%%% maybe implement +VerifyActivationFrameSize here
 267   //verify_thread(); //too slow; we will just verify on method entry &amp; exit
 268   if (verify) interp_verify_oop(Otos_i, state, __FILE__, __LINE__);
 269   // dispatch table to use
 270   AddressLiteral tbl(table);
 271   Label dispatch;
 272 
 273   if (SafepointMechanism::uses_thread_local_poll() &amp;&amp; generate_poll) {
 274     AddressLiteral sfpt_tbl(Interpreter::safept_table(state));
 275     Label no_safepoint;
 276 
 277     if (tbl.value() != sfpt_tbl.value()) {
 278       ldx(Address(G2_thread, Thread::polling_page_offset()), G3_scratch, 0);
 279       // Armed page has poll_bit set, if poll bit is cleared just continue.
 280       and3(G3_scratch, SafepointMechanism::poll_bit(), G3_scratch);
 281 
 282       br_null_short(G3_scratch, Assembler::pt, no_safepoint);
 283       set(sfpt_tbl, G3_scratch);
 284       ba_short(dispatch);
 285     }
 286     bind(no_safepoint);
 287   }
 288 
 289   set(tbl, G3_scratch);                               // compute addr of table
 290   bind(dispatch);
 291   sll(Lbyte_code, LogBytesPerWord, Lbyte_code);       // multiply by wordSize
 292   ld_ptr(G3_scratch, Lbyte_code, G3_scratch);         // get entry addr
 293   jmp( G3_scratch, 0 );
 294   if (bcp_incr != 0)  delayed()-&gt;inc(Lbcp, bcp_incr);
 295   else                delayed()-&gt;nop();
 296 }
 297 
 298 
 299 // Helpers for expression stack
 300 
 301 // Longs and doubles are Category 2 computational types in the
 302 // JVM specification (section 3.11.1) and take 2 expression stack or
 303 // local slots.
 304 // Aligning them on 32 bit with tagged stacks is hard because the code generated
 305 // for the dup* bytecodes depends on what types are already on the stack.
 306 // If the types are split into the two stack/local slots, that is much easier
 307 // (and we can use 0 for non-reference tags).
 308 
 309 // Known good alignment in _LP64 but unknown otherwise
 310 void InterpreterMacroAssembler::load_unaligned_double(Register r1, int offset, FloatRegister d) {
 311   assert_not_delayed();
 312 
 313   ldf(FloatRegisterImpl::D, r1, offset, d);
 314 }
 315 
 316 // Known good alignment in _LP64 but unknown otherwise
 317 void InterpreterMacroAssembler::store_unaligned_double(FloatRegister d, Register r1, int offset) {
 318   assert_not_delayed();
 319 
 320   stf(FloatRegisterImpl::D, d, r1, offset);
 321   // store something more useful here
 322   debug_only(stx(G0, r1, offset+Interpreter::stackElementSize);)
 323 }
 324 
 325 
 326 // Known good alignment in _LP64 but unknown otherwise
 327 void InterpreterMacroAssembler::load_unaligned_long(Register r1, int offset, Register rd) {
 328   assert_not_delayed();
 329   ldx(r1, offset, rd);
 330 }
 331 
 332 // Known good alignment in _LP64 but unknown otherwise
 333 void InterpreterMacroAssembler::store_unaligned_long(Register l, Register r1, int offset) {
 334   assert_not_delayed();
 335 
 336   stx(l, r1, offset);
 337   // store something more useful here
 338   stx(G0, r1, offset+Interpreter::stackElementSize);
 339 }
 340 
 341 void InterpreterMacroAssembler::pop_i(Register r) {
 342   assert_not_delayed();
 343   ld(Lesp, Interpreter::expr_offset_in_bytes(0), r);
 344   inc(Lesp, Interpreter::stackElementSize);
 345   debug_only(verify_esp(Lesp));
 346 }
 347 
 348 void InterpreterMacroAssembler::pop_ptr(Register r, Register scratch) {
 349   assert_not_delayed();
 350   ld_ptr(Lesp, Interpreter::expr_offset_in_bytes(0), r);
 351   inc(Lesp, Interpreter::stackElementSize);
 352   debug_only(verify_esp(Lesp));
 353 }
 354 
 355 void InterpreterMacroAssembler::pop_l(Register r) {
 356   assert_not_delayed();
 357   load_unaligned_long(Lesp, Interpreter::expr_offset_in_bytes(0), r);
 358   inc(Lesp, 2*Interpreter::stackElementSize);
 359   debug_only(verify_esp(Lesp));
 360 }
 361 
 362 
 363 void InterpreterMacroAssembler::pop_f(FloatRegister f, Register scratch) {
 364   assert_not_delayed();
 365   ldf(FloatRegisterImpl::S, Lesp, Interpreter::expr_offset_in_bytes(0), f);
 366   inc(Lesp, Interpreter::stackElementSize);
 367   debug_only(verify_esp(Lesp));
 368 }
 369 
 370 
 371 void InterpreterMacroAssembler::pop_d(FloatRegister f, Register scratch) {
 372   assert_not_delayed();
 373   load_unaligned_double(Lesp, Interpreter::expr_offset_in_bytes(0), f);
 374   inc(Lesp, 2*Interpreter::stackElementSize);
 375   debug_only(verify_esp(Lesp));
 376 }
 377 
 378 
 379 void InterpreterMacroAssembler::push_i(Register r) {
 380   assert_not_delayed();
 381   debug_only(verify_esp(Lesp));
 382   st(r, Lesp, 0);
 383   dec(Lesp, Interpreter::stackElementSize);
 384 }
 385 
 386 void InterpreterMacroAssembler::push_ptr(Register r) {
 387   assert_not_delayed();
 388   st_ptr(r, Lesp, 0);
 389   dec(Lesp, Interpreter::stackElementSize);
 390 }
 391 
 392 // remember: our convention for longs in SPARC is:
 393 // O0 (Otos_l1) has high-order part in first word,
 394 // O1 (Otos_l2) has low-order part in second word
 395 
 396 void InterpreterMacroAssembler::push_l(Register r) {
 397   assert_not_delayed();
 398   debug_only(verify_esp(Lesp));
 399   // Longs are stored in memory-correct order, even if unaligned.
 400   int offset = -Interpreter::stackElementSize;
 401   store_unaligned_long(r, Lesp, offset);
 402   dec(Lesp, 2 * Interpreter::stackElementSize);
 403 }
 404 
 405 
 406 void InterpreterMacroAssembler::push_f(FloatRegister f) {
 407   assert_not_delayed();
 408   debug_only(verify_esp(Lesp));
 409   stf(FloatRegisterImpl::S, f, Lesp, 0);
 410   dec(Lesp, Interpreter::stackElementSize);
 411 }
 412 
 413 
 414 void InterpreterMacroAssembler::push_d(FloatRegister d)   {
 415   assert_not_delayed();
 416   debug_only(verify_esp(Lesp));
 417   // Longs are stored in memory-correct order, even if unaligned.
 418   int offset = -Interpreter::stackElementSize;
 419   store_unaligned_double(d, Lesp, offset);
 420   dec(Lesp, 2 * Interpreter::stackElementSize);
 421 }
 422 
 423 
 424 void InterpreterMacroAssembler::push(TosState state) {
 425   interp_verify_oop(Otos_i, state, __FILE__, __LINE__);
 426   switch (state) {
 427     case atos: push_ptr();            break;
 428     case btos:                        // fall through
 429     case ztos:                        // fall through
 430     case ctos:                        // fall through
 431     case stos:                        // fall through
 432     case itos: push_i();              break;
 433     case ltos: push_l();              break;
 434     case ftos: push_f();              break;
 435     case dtos: push_d();              break;
 436     case vtos: /* nothing to do */    break;
 437     default  : ShouldNotReachHere();
 438   }
 439 }
 440 
 441 
 442 void InterpreterMacroAssembler::pop(TosState state) {
 443   switch (state) {
 444     case atos: pop_ptr();            break;
 445     case btos:                       // fall through
 446     case ztos:                       // fall through
 447     case ctos:                       // fall through
 448     case stos:                       // fall through
 449     case itos: pop_i();              break;
 450     case ltos: pop_l();              break;
 451     case ftos: pop_f();              break;
 452     case dtos: pop_d();              break;
 453     case vtos: /* nothing to do */   break;
 454     default  : ShouldNotReachHere();
 455   }
 456   interp_verify_oop(Otos_i, state, __FILE__, __LINE__);
 457 }
 458 
 459 
 460 // Helpers for swap and dup
 461 void InterpreterMacroAssembler::load_ptr(int n, Register val) {
 462   ld_ptr(Lesp, Interpreter::expr_offset_in_bytes(n), val);
 463 }
 464 void InterpreterMacroAssembler::store_ptr(int n, Register val) {
 465   st_ptr(val, Lesp, Interpreter::expr_offset_in_bytes(n));
 466 }
 467 
 468 
 469 void InterpreterMacroAssembler::load_receiver(Register param_count,
 470                                               Register recv) {
 471   sll(param_count, Interpreter::logStackElementSize, param_count);
 472   ld_ptr(Lesp, param_count, recv);  // gets receiver oop
 473 }
 474 
 475 void InterpreterMacroAssembler::empty_expression_stack() {
 476   // Reset Lesp.
 477   sub( Lmonitors, wordSize, Lesp );
 478 
 479   // Reset SP by subtracting more space from Lesp.
 480   Label done;
 481   assert(G4_scratch != Gframe_size, &quot;Only you can prevent register aliasing!&quot;);
 482 
 483   // A native does not need to do this, since its callee does not change SP.
 484   ld(Lmethod, Method::access_flags_offset(), Gframe_size);  // Load access flags.
 485   btst(JVM_ACC_NATIVE, Gframe_size);
 486   br(Assembler::notZero, false, Assembler::pt, done);
 487   delayed()-&gt;nop();
 488 
 489   // Compute max expression stack+register save area
 490   ld_ptr(Lmethod, in_bytes(Method::const_offset()), Gframe_size);
 491   lduh(Gframe_size, in_bytes(ConstMethod::max_stack_offset()), Gframe_size);  // Load max stack.
 492   add(Gframe_size, frame::memory_parameter_word_sp_offset+Method::extra_stack_entries(), Gframe_size );
 493 
 494   //
 495   // now set up a stack frame with the size computed above
 496   //
 497   //round_to( Gframe_size, WordsPerLong ); // -- moved down to the &quot;and&quot; below
 498   sll( Gframe_size, LogBytesPerWord, Gframe_size );
 499   sub( Lesp, Gframe_size, Gframe_size );
 500   and3( Gframe_size, -(2 * wordSize), Gframe_size );          // align SP (downwards) to an 8/16-byte boundary
 501   debug_only(verify_sp(Gframe_size, G4_scratch));
 502   sub(Gframe_size, STACK_BIAS, Gframe_size );
 503   mov(Gframe_size, SP);
 504 
 505   bind(done);
 506 }
 507 
 508 
 509 #ifdef ASSERT
 510 void InterpreterMacroAssembler::verify_sp(Register Rsp, Register Rtemp) {
 511   Label Bad, OK;
 512 
 513   // Saved SP must be aligned.
 514   btst(2*BytesPerWord-1, Rsp);
 515   br(Assembler::notZero, false, Assembler::pn, Bad);
 516   delayed()-&gt;nop();
 517 
 518   // Saved SP, plus register window size, must not be above FP.
 519   add(Rsp, frame::register_save_words * wordSize, Rtemp);
 520   sub(Rtemp, STACK_BIAS, Rtemp);  // Bias Rtemp before cmp to FP
 521   cmp_and_brx_short(Rtemp, FP, Assembler::greaterUnsigned, Assembler::pn, Bad);
 522 
 523   // Saved SP must not be ridiculously below current SP.
 524   size_t maxstack = MAX2(JavaThread::stack_size_at_create(), (size_t) 4*K*K);
 525   set(maxstack, Rtemp);
 526   sub(SP, Rtemp, Rtemp);
 527   add(Rtemp, STACK_BIAS, Rtemp);  // Unbias Rtemp before cmp to Rsp
 528   cmp_and_brx_short(Rsp, Rtemp, Assembler::lessUnsigned, Assembler::pn, Bad);
 529 
 530   ba_short(OK);
 531 
 532   bind(Bad);
 533   stop(&quot;on return to interpreted call, restored SP is corrupted&quot;);
 534 
 535   bind(OK);
 536 }
 537 
 538 
 539 void InterpreterMacroAssembler::verify_esp(Register Resp) {
 540   // about to read or write Resp[0]
 541   // make sure it is not in the monitors or the register save area
 542   Label OK1, OK2;
 543 
 544   cmp(Resp, Lmonitors);
 545   brx(Assembler::lessUnsigned, true, Assembler::pt, OK1);
 546   delayed()-&gt;sub(Resp, frame::memory_parameter_word_sp_offset * wordSize, Resp);
 547   stop(&quot;too many pops:  Lesp points into monitor area&quot;);
 548   bind(OK1);
 549   sub(Resp, STACK_BIAS, Resp);
 550   cmp(Resp, SP);
 551   brx(Assembler::greaterEqualUnsigned, false, Assembler::pt, OK2);
 552   delayed()-&gt;add(Resp, STACK_BIAS + frame::memory_parameter_word_sp_offset * wordSize, Resp);
 553   stop(&quot;too many pushes:  Lesp points into register window&quot;);
 554   bind(OK2);
 555 }
 556 #endif // ASSERT
 557 
 558 // Load compiled (i2c) or interpreter entry when calling from interpreted and
 559 // do the call. Centralized so that all interpreter calls will do the same actions.
 560 // If jvmti single stepping is on for a thread we must not call compiled code.
 561 void InterpreterMacroAssembler::call_from_interpreter(Register target, Register scratch, Register Rret) {
 562 
 563   // Assume we want to go compiled if available
 564 
 565   ld_ptr(G5_method, in_bytes(Method::from_interpreted_offset()), target);
 566 
 567   if (JvmtiExport::can_post_interpreter_events()) {
 568     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
 569     // compiled code in threads for which the event is enabled.  Check here for
 570     // interp_only_mode if these events CAN be enabled.
 571     verify_thread();
 572     Label skip_compiled_code;
 573 
 574     const Address interp_only(G2_thread, JavaThread::interp_only_mode_offset());
 575     ld(interp_only, scratch);
 576     cmp_zero_and_br(Assembler::notZero, scratch, skip_compiled_code, true, Assembler::pn);
 577     delayed()-&gt;ld_ptr(G5_method, in_bytes(Method::interpreter_entry_offset()), target);
 578     bind(skip_compiled_code);
 579   }
 580 
 581   // the i2c_adapters need Method* in G5_method (right? %%%)
 582   // do the call
 583 #ifdef ASSERT
 584   {
 585     Label ok;
 586     br_notnull_short(target, Assembler::pt, ok);
 587     stop(&quot;null entry point&quot;);
 588     bind(ok);
 589   }
 590 #endif // ASSERT
 591 
 592   // Adjust Rret first so Llast_SP can be same as Rret
 593   add(Rret, -frame::pc_return_offset, O7);
 594   add(Lesp, BytesPerWord, Gargs); // setup parameter pointer
 595   // Record SP so we can remove any stack space allocated by adapter transition
 596   jmp(target, 0);
 597   delayed()-&gt;mov(SP, Llast_SP);
 598 }
 599 
 600 void InterpreterMacroAssembler::if_cmp(Condition cc, bool ptr_compare) {
 601   assert_not_delayed();
 602 
 603   Label not_taken;
 604   if (ptr_compare) brx(cc, false, Assembler::pn, not_taken);
 605   else             br (cc, false, Assembler::pn, not_taken);
 606   delayed()-&gt;nop();
 607 
 608   TemplateTable::branch(false,false);
 609 
 610   bind(not_taken);
 611 
 612   profile_not_taken_branch(G3_scratch);
 613 }
 614 
 615 
 616 void InterpreterMacroAssembler::get_2_byte_integer_at_bcp(
 617                                   int         bcp_offset,
 618                                   Register    Rtmp,
 619                                   Register    Rdst,
 620                                   signedOrNot is_signed,
 621                                   setCCOrNot  should_set_CC ) {
 622   assert(Rtmp != Rdst, &quot;need separate temp register&quot;);
 623   assert_not_delayed();
 624   switch (is_signed) {
 625    default: ShouldNotReachHere();
 626 
 627    case   Signed:  ldsb( Lbcp, bcp_offset, Rdst  );  break; // high byte
 628    case Unsigned:  ldub( Lbcp, bcp_offset, Rdst  );  break; // high byte
 629   }
 630   ldub( Lbcp, bcp_offset + 1, Rtmp ); // low byte
 631   sll( Rdst, BitsPerByte, Rdst);
 632   switch (should_set_CC ) {
 633    default: ShouldNotReachHere();
 634 
 635    case      set_CC:  orcc( Rdst, Rtmp, Rdst ); break;
 636    case dont_set_CC:  or3(  Rdst, Rtmp, Rdst ); break;
 637   }
 638 }
 639 
 640 
 641 void InterpreterMacroAssembler::get_4_byte_integer_at_bcp(
 642                                   int        bcp_offset,
 643                                   Register   Rtmp,
 644                                   Register   Rdst,
 645                                   setCCOrNot should_set_CC ) {
 646   assert(Rtmp != Rdst, &quot;need separate temp register&quot;);
 647   assert_not_delayed();
 648   add( Lbcp, bcp_offset, Rtmp);
 649   andcc( Rtmp, 3, G0);
 650   Label aligned;
 651   switch (should_set_CC ) {
 652    default: ShouldNotReachHere();
 653 
 654    case      set_CC: break;
 655    case dont_set_CC: break;
 656   }
 657 
 658   br(Assembler::zero, true, Assembler::pn, aligned);
 659   delayed()-&gt;ldsw(Rtmp, 0, Rdst);
 660 
 661   ldub(Lbcp, bcp_offset + 3, Rdst);
 662   ldub(Lbcp, bcp_offset + 2, Rtmp);  sll(Rtmp,  8, Rtmp);  or3(Rtmp, Rdst, Rdst);
 663   ldub(Lbcp, bcp_offset + 1, Rtmp);  sll(Rtmp, 16, Rtmp);  or3(Rtmp, Rdst, Rdst);
 664   ldsb(Lbcp, bcp_offset + 0, Rtmp);  sll(Rtmp, 24, Rtmp);
 665   or3(Rtmp, Rdst, Rdst );
 666 
 667   bind(aligned);
 668   if (should_set_CC == set_CC) tst(Rdst);
 669 }
 670 
 671 void InterpreterMacroAssembler::get_cache_index_at_bcp(Register temp, Register index,
 672                                                        int bcp_offset, size_t index_size) {
 673   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 674   if (index_size == sizeof(u2)) {
 675     get_2_byte_integer_at_bcp(bcp_offset, temp, index, Unsigned);
 676   } else if (index_size == sizeof(u4)) {
 677     get_4_byte_integer_at_bcp(bcp_offset, temp, index);
 678     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 679     xor3(index, -1, index);  // convert to plain index
 680   } else if (index_size == sizeof(u1)) {
 681     ldub(Lbcp, bcp_offset, index);
 682   } else {
 683     ShouldNotReachHere();
 684   }
 685 }
 686 
 687 
 688 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache, Register tmp,
 689                                                            int bcp_offset, size_t index_size) {
 690   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 691   assert_different_registers(cache, tmp);
 692   assert_not_delayed();
 693   get_cache_index_at_bcp(cache, tmp, bcp_offset, index_size);
 694   // convert from field index to ConstantPoolCacheEntry index and from
 695   // word index to byte offset
 696   sll(tmp, exact_log2(in_words(ConstantPoolCacheEntry::size()) * BytesPerWord), tmp);
 697   add(LcpoolCache, tmp, cache);
 698 }
 699 
 700 
 701 void InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache,
 702                                                                         Register temp,
 703                                                                         Register bytecode,
 704                                                                         int byte_no,
 705                                                                         int bcp_offset,
 706                                                                         size_t index_size) {
 707   get_cache_and_index_at_bcp(cache, temp, bcp_offset, index_size);
 708   ld_ptr(cache, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset(), bytecode);
 709   const int shift_count = (1 + byte_no) * BitsPerByte;
 710   assert((byte_no == TemplateTable::f1_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_1_shift) ||
 711          (byte_no == TemplateTable::f2_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_2_shift),
 712          &quot;correct shift count&quot;);
 713   srl(bytecode, shift_count, bytecode);
 714   assert(ConstantPoolCacheEntry::bytecode_1_mask == ConstantPoolCacheEntry::bytecode_2_mask, &quot;common mask&quot;);
 715   and3(bytecode, ConstantPoolCacheEntry::bytecode_1_mask, bytecode);
 716 }
 717 
 718 
 719 void InterpreterMacroAssembler::get_cache_entry_pointer_at_bcp(Register cache, Register tmp,
 720                                                                int bcp_offset, size_t index_size) {
 721   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 722   assert_different_registers(cache, tmp);
 723   assert_not_delayed();
 724   if (index_size == sizeof(u2)) {
 725     get_2_byte_integer_at_bcp(bcp_offset, cache, tmp, Unsigned);
 726   } else {
 727     ShouldNotReachHere();  // other sizes not supported here
 728   }
 729               // convert from field index to ConstantPoolCacheEntry index
 730               // and from word index to byte offset
 731   sll(tmp, exact_log2(in_words(ConstantPoolCacheEntry::size()) * BytesPerWord), tmp);
 732               // skip past the header
 733   add(tmp, in_bytes(ConstantPoolCache::base_offset()), tmp);
 734               // construct pointer to cache entry
 735   add(LcpoolCache, tmp, cache);
 736 }
 737 
 738 
 739 // Load object from cpool-&gt;resolved_references(index)
 740 void InterpreterMacroAssembler::load_resolved_reference_at_index(
 741                                            Register result, Register index, Register tmp) {
 742   assert_different_registers(result, index, tmp);
 743   assert_not_delayed();
 744   // convert from field index to resolved_references() index and from
 745   // word index to byte offset. Since this is a java object, it can be compressed
 746   sll(index, LogBytesPerHeapOop, index);
 747   get_constant_pool(result);
 748   // load pointer for resolved_references[] objArray
 749   ld_ptr(result, ConstantPool::cache_offset_in_bytes(), result);
 750   ld_ptr(result, ConstantPoolCache::resolved_references_offset_in_bytes(), result);
 751   resolve_oop_handle(result, tmp);
 752   // Add in the index
 753   add(result, index, result);
 754   load_heap_oop(result, arrayOopDesc::base_offset_in_bytes(T_OBJECT), result, tmp);
 755   // The resulting oop is null if the reference is not yet resolved.
 756   // It is Universe::the_null_sentinel() if the reference resolved to NULL via condy.
 757 }
 758 
 759 
 760 // load cpool-&gt;resolved_klass_at(index)
 761 void InterpreterMacroAssembler::load_resolved_klass_at_offset(Register Rcpool,
 762                                            Register Roffset, Register Rklass) {
 763   // int value = *this_cp-&gt;int_at_addr(which);
 764   // int resolved_klass_index = extract_low_short_from_int(value);
 765   //
 766   // Because SPARC is big-endian, the low_short is at (cpool-&gt;int_at_addr(which) + 2 bytes)
 767   add(Roffset, Rcpool, Roffset);
 768   lduh(Roffset, sizeof(ConstantPool) + 2, Roffset);  // Roffset = resolved_klass_index
 769 
 770   Register Rresolved_klasses = Rklass;
 771   ld_ptr(Rcpool, ConstantPool::resolved_klasses_offset_in_bytes(), Rresolved_klasses);
 772   sll(Roffset, LogBytesPerWord, Roffset);
 773   add(Roffset, Array&lt;Klass*&gt;::base_offset_in_bytes(), Roffset);
 774   ld_ptr(Rresolved_klasses, Roffset, Rklass);
 775 }
 776 
 777 
 778 // Generate a subtype check: branch to ok_is_subtype if sub_klass is
 779 // a subtype of super_klass.  Blows registers Rsuper_klass, Rsub_klass, tmp1, tmp2.
 780 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass,
 781                                                   Register Rsuper_klass,
 782                                                   Register Rtmp1,
 783                                                   Register Rtmp2,
 784                                                   Register Rtmp3,
 785                                                   Label &amp;ok_is_subtype ) {
 786   Label not_subtype;
 787 
 788   // Profile the not-null value&#39;s klass.
 789   profile_typecheck(Rsub_klass, Rtmp1);
 790 
 791   check_klass_subtype_fast_path(Rsub_klass, Rsuper_klass,
 792                                 Rtmp1, Rtmp2,
 793                                 &amp;ok_is_subtype, &amp;not_subtype, NULL);
 794 
 795   check_klass_subtype_slow_path(Rsub_klass, Rsuper_klass,
 796                                 Rtmp1, Rtmp2, Rtmp3, /*hack:*/ noreg,
 797                                 &amp;ok_is_subtype, NULL);
 798 
 799   bind(not_subtype);
 800   profile_typecheck_failed(Rtmp1);
 801 }
 802 
 803 // Separate these two to allow for delay slot in middle
 804 // These are used to do a test and full jump to exception-throwing code.
 805 
 806 // %%%%% Could possibly reoptimize this by testing to see if could use
 807 // a single conditional branch (i.e. if span is small enough.
 808 // If you go that route, than get rid of the split and give up
 809 // on the delay-slot hack.
 810 
 811 void InterpreterMacroAssembler::throw_if_not_1_icc( Condition ok_condition,
 812                                                     Label&amp;    ok ) {
 813   assert_not_delayed();
 814   br(ok_condition, true, pt, ok);
 815   // DELAY SLOT
 816 }
 817 
 818 void InterpreterMacroAssembler::throw_if_not_1_xcc( Condition ok_condition,
 819                                                     Label&amp;    ok ) {
 820   assert_not_delayed();
 821   bp( ok_condition, true, Assembler::xcc, pt, ok);
 822   // DELAY SLOT
 823 }
 824 
 825 void InterpreterMacroAssembler::throw_if_not_1_x( Condition ok_condition,
 826                                                   Label&amp;    ok ) {
 827   assert_not_delayed();
 828   brx(ok_condition, true, pt, ok);
 829   // DELAY SLOT
 830 }
 831 
 832 void InterpreterMacroAssembler::throw_if_not_2( address  throw_entry_point,
 833                                                 Register Rscratch,
 834                                                 Label&amp;   ok ) {
 835   assert(throw_entry_point != NULL, &quot;entry point must be generated by now&quot;);
 836   AddressLiteral dest(throw_entry_point);
 837   jump_to(dest, Rscratch);
 838   delayed()-&gt;nop();
 839   bind(ok);
 840 }
 841 
 842 
 843 // And if you cannot use the delay slot, here is a shorthand:
 844 
 845 void InterpreterMacroAssembler::throw_if_not_icc( Condition ok_condition,
 846                                                   address   throw_entry_point,
 847                                                   Register  Rscratch ) {
 848   Label ok;
 849   if (ok_condition != never) {
 850     throw_if_not_1_icc( ok_condition, ok);
 851     delayed()-&gt;nop();
 852   }
 853   throw_if_not_2( throw_entry_point, Rscratch, ok);
 854 }
 855 void InterpreterMacroAssembler::throw_if_not_xcc( Condition ok_condition,
 856                                                   address   throw_entry_point,
 857                                                   Register  Rscratch ) {
 858   Label ok;
 859   if (ok_condition != never) {
 860     throw_if_not_1_xcc( ok_condition, ok);
 861     delayed()-&gt;nop();
 862   }
 863   throw_if_not_2( throw_entry_point, Rscratch, ok);
 864 }
 865 void InterpreterMacroAssembler::throw_if_not_x( Condition ok_condition,
 866                                                 address   throw_entry_point,
 867                                                 Register  Rscratch ) {
 868   Label ok;
 869   if (ok_condition != never) {
 870     throw_if_not_1_x( ok_condition, ok);
 871     delayed()-&gt;nop();
 872   }
 873   throw_if_not_2( throw_entry_point, Rscratch, ok);
 874 }
 875 
 876 // Check that index is in range for array, then shift index by index_shift, and put arrayOop + shifted_index into res
 877 // Note: res is still shy of address by array offset into object.
 878 
 879 void InterpreterMacroAssembler::index_check_without_pop(Register array, Register index, int index_shift, Register tmp, Register res) {
 880   assert_not_delayed();
 881 
 882   verify_oop(array);
 883   // Sign extend since tos (index) can be a 32bit value.
 884   sra(index, G0, index);
 885 
 886   // Check array.
 887   Label ptr_ok;
 888   tst(array);
 889   throw_if_not_1_x(notZero, ptr_ok);
 890   delayed()-&gt;ld(array, arrayOopDesc::length_offset_in_bytes(), tmp); // Check index.
 891   throw_if_not_2(Interpreter::_throw_NullPointerException_entry, G3_scratch, ptr_ok);
 892 
 893   Label index_ok;
 894   cmp(index, tmp);
 895   throw_if_not_1_icc(lessUnsigned, index_ok);
 896   if (index_shift &gt; 0) {
 897     delayed()-&gt;sll(index, index_shift, index);
 898   } else {
 899     delayed()-&gt;add(array, index, res); // addr - const offset in index
 900   }
 901   // Pass the array to create more detailed exceptions.
 902   // Convention: move aberrant index into Otos_i for exception message.
 903   mov(index, Otos_i);
 904   mov(array, G3_scratch);
 905   throw_if_not_2(Interpreter::_throw_ArrayIndexOutOfBoundsException_entry, G4_scratch, index_ok);
 906 
 907   // add offset if didn&#39;t do it in delay slot
 908   if (index_shift &gt; 0) { add(array, index, res); } // addr - const offset in index
 909 }
 910 
 911 
 912 void InterpreterMacroAssembler::index_check(Register array, Register index, int index_shift, Register tmp, Register res) {
 913   assert_not_delayed();
 914 
 915   // pop array
 916   pop_ptr(array);
 917 
 918   // check array
 919   index_check_without_pop(array, index, index_shift, tmp, res);
 920 }
 921 
 922 
 923 void InterpreterMacroAssembler::get_const(Register Rdst) {
 924   ld_ptr(Lmethod, in_bytes(Method::const_offset()), Rdst);
 925 }
 926 
 927 
 928 void InterpreterMacroAssembler::get_constant_pool(Register Rdst) {
 929   get_const(Rdst);
 930   ld_ptr(Rdst, in_bytes(ConstMethod::constants_offset()), Rdst);
 931 }
 932 
 933 
 934 void InterpreterMacroAssembler::get_constant_pool_cache(Register Rdst) {
 935   get_constant_pool(Rdst);
 936   ld_ptr(Rdst, ConstantPool::cache_offset_in_bytes(), Rdst);
 937 }
 938 
 939 
 940 void InterpreterMacroAssembler::get_cpool_and_tags(Register Rcpool, Register Rtags) {
 941   get_constant_pool(Rcpool);
 942   ld_ptr(Rcpool, ConstantPool::tags_offset_in_bytes(), Rtags);
 943 }
 944 
 945 
 946 // unlock if synchronized method
 947 //
 948 // Unlock the receiver if this is a synchronized method.
 949 // Unlock any Java monitors from syncronized blocks.
 950 //
 951 // If there are locked Java monitors
 952 //    If throw_monitor_exception
 953 //       throws IllegalMonitorStateException
 954 //    Else if install_monitor_exception
 955 //       installs IllegalMonitorStateException
 956 //    Else
 957 //       no error processing
 958 void InterpreterMacroAssembler::unlock_if_synchronized_method(TosState state,
 959                                                               bool throw_monitor_exception,
 960                                                               bool install_monitor_exception) {
 961   Label unlocked, unlock, no_unlock;
 962 
 963   // get the value of _do_not_unlock_if_synchronized into G1_scratch
 964   const Address do_not_unlock_if_synchronized(G2_thread,
 965     JavaThread::do_not_unlock_if_synchronized_offset());
 966   ldbool(do_not_unlock_if_synchronized, G1_scratch);
 967   stbool(G0, do_not_unlock_if_synchronized); // reset the flag
 968 
 969   // check if synchronized method
 970   const Address access_flags(Lmethod, Method::access_flags_offset());
 971   interp_verify_oop(Otos_i, state, __FILE__, __LINE__);
 972   push(state); // save tos
 973   ld(access_flags, G3_scratch); // Load access flags.
 974   btst(JVM_ACC_SYNCHRONIZED, G3_scratch);
 975   br(zero, false, pt, unlocked);
 976   delayed()-&gt;nop();
 977 
 978   // Don&#39;t unlock anything if the _do_not_unlock_if_synchronized flag
 979   // is set.
 980   cmp_zero_and_br(Assembler::notZero, G1_scratch, no_unlock);
 981   delayed()-&gt;nop();
 982 
 983   // BasicObjectLock will be first in list, since this is a synchronized method. However, need
 984   // to check that the object has not been unlocked by an explicit monitorexit bytecode.
 985 
 986   //Intel: if (throw_monitor_exception) ... else ...
 987   // Entry already unlocked, need to throw exception
 988   //...
 989 
 990   // pass top-most monitor elem
 991   add( top_most_monitor(), O1 );
 992 
 993   ld_ptr(O1, BasicObjectLock::obj_offset_in_bytes(), G3_scratch);
 994   br_notnull_short(G3_scratch, pt, unlock);
 995 
 996   if (throw_monitor_exception) {
 997     // Entry already unlocked need to throw an exception
 998     MacroAssembler::call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_illegal_monitor_state_exception));
 999     should_not_reach_here();
1000   } else {
1001     // Monitor already unlocked during a stack unroll.
1002     // If requested, install an illegal_monitor_state_exception.
1003     // Continue with stack unrolling.
1004     if (install_monitor_exception) {
1005       MacroAssembler::call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::new_illegal_monitor_state_exception));
1006     }
1007     ba_short(unlocked);
1008   }
1009 
1010   bind(unlock);
1011 
1012   unlock_object(O1);
1013 
1014   bind(unlocked);
1015 
1016   // I0, I1: Might contain return value
1017 
1018   // Check that all monitors are unlocked
1019   { Label loop, exception, entry, restart;
1020 
1021     Register Rmptr   = O0;
1022     Register Rtemp   = O1;
1023     Register Rlimit  = Lmonitors;
1024     const jint delta = frame::interpreter_frame_monitor_size() * wordSize;
1025     assert( (delta &amp; LongAlignmentMask) == 0,
1026             &quot;sizeof BasicObjectLock must be even number of doublewords&quot;);
1027 
1028     #ifdef ASSERT
1029     add(top_most_monitor(), Rmptr, delta);
1030     { Label L;
1031       // ensure that Rmptr starts out above (or at) Rlimit
1032       cmp_and_brx_short(Rmptr, Rlimit, Assembler::greaterEqualUnsigned, pn, L);
1033       stop(&quot;monitor stack has negative size&quot;);
1034       bind(L);
1035     }
1036     #endif
1037     bind(restart);
1038     ba(entry);
1039     delayed()-&gt;
1040     add(top_most_monitor(), Rmptr, delta);      // points to current entry, starting with bottom-most entry
1041 
1042     // Entry is still locked, need to throw exception
1043     bind(exception);
1044     if (throw_monitor_exception) {
1045       MacroAssembler::call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_illegal_monitor_state_exception));
1046       should_not_reach_here();
1047     } else {
1048       // Stack unrolling. Unlock object and if requested, install illegal_monitor_exception.
1049       // Unlock does not block, so don&#39;t have to worry about the frame
1050       unlock_object(Rmptr);
1051       if (install_monitor_exception) {
1052         MacroAssembler::call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::new_illegal_monitor_state_exception));
1053       }
1054       ba_short(restart);
1055     }
1056 
1057     bind(loop);
1058     cmp(Rtemp, G0);                             // check if current entry is used
1059     brx(Assembler::notEqual, false, pn, exception);
1060     delayed()-&gt;
1061     dec(Rmptr, delta);                          // otherwise advance to next entry
1062     #ifdef ASSERT
1063     { Label L;
1064       // ensure that Rmptr has not somehow stepped below Rlimit
1065       cmp_and_brx_short(Rmptr, Rlimit, Assembler::greaterEqualUnsigned, pn, L);
1066       stop(&quot;ran off the end of the monitor stack&quot;);
1067       bind(L);
1068     }
1069     #endif
1070     bind(entry);
1071     cmp(Rmptr, Rlimit);                         // check if bottom reached
1072     brx(Assembler::notEqual, true, pn, loop);   // if not at bottom then check this entry
1073     delayed()-&gt;
1074     ld_ptr(Rmptr, BasicObjectLock::obj_offset_in_bytes() - delta, Rtemp);
1075   }
1076 
1077   bind(no_unlock);
1078   pop(state);
1079   interp_verify_oop(Otos_i, state, __FILE__, __LINE__);
1080 }
1081 
1082 void InterpreterMacroAssembler::narrow(Register result) {
1083 
1084   ld_ptr(Address(Lmethod, Method::const_offset()), G3_scratch);
1085   ldub(G3_scratch, in_bytes(ConstMethod::result_type_offset()), G3_scratch);
1086 
1087   Label notBool, notByte, notChar, done;
1088 
1089   // common case first
1090   cmp(G3_scratch, T_INT);
1091   br(Assembler::equal, true, pn, done);
1092   delayed()-&gt;nop();
1093 
1094   cmp(G3_scratch, T_BOOLEAN);
1095   br(Assembler::notEqual, true, pn, notBool);
1096   delayed()-&gt;cmp(G3_scratch, T_BYTE);
1097   and3(result, 1, result);
1098   ba(done);
1099   delayed()-&gt;nop();
1100 
1101   bind(notBool);
1102   // cmp(G3_scratch, T_BYTE);
1103   br(Assembler::notEqual, true, pn, notByte);
1104   delayed()-&gt;cmp(G3_scratch, T_CHAR);
1105   sll(result, 24, result);
1106   sra(result, 24, result);
1107   ba(done);
1108   delayed()-&gt;nop();
1109 
1110   bind(notByte);
1111   // cmp(G3_scratch, T_CHAR);
1112   sll(result, 16, result);
1113   br(Assembler::notEqual, true, pn, done);
1114   delayed()-&gt;sra(result, 16, result);
1115   // sll(result, 16, result);
1116   srl(result, 16, result);
1117 
1118   // bind(notChar);
1119   // must be short, instructions already executed in delay slot
1120   // sll(result, 16, result);
1121   // sra(result, 16, result);
1122 
1123   bind(done);
1124 }
1125 
1126 // remove activation
1127 //
1128 // Unlock the receiver if this is a synchronized method.
1129 // Unlock any Java monitors from syncronized blocks.
1130 // Remove the activation from the stack.
1131 //
1132 // If there are locked Java monitors
1133 //    If throw_monitor_exception
1134 //       throws IllegalMonitorStateException
1135 //    Else if install_monitor_exception
1136 //       installs IllegalMonitorStateException
1137 //    Else
1138 //       no error processing
1139 void InterpreterMacroAssembler::remove_activation(TosState state,
1140                                                   bool throw_monitor_exception,
1141                                                   bool install_monitor_exception) {
1142 
1143   unlock_if_synchronized_method(state, throw_monitor_exception, install_monitor_exception);
1144 
1145   // save result (push state before jvmti call and pop it afterwards) and notify jvmti
1146   notify_method_exit(false, state, NotifyJVMTI);
1147 
1148   if (StackReservedPages &gt; 0) {
1149     // testing if Stack Reserved Area needs to be re-enabled
1150     Label no_reserved_zone_enabling;
1151     ld_ptr(G2_thread, JavaThread::reserved_stack_activation_offset(), G3_scratch);
1152     cmp_and_brx_short(SP, G3_scratch, Assembler::lessUnsigned, Assembler::pt, no_reserved_zone_enabling);
1153 
1154     call_VM_leaf(noreg, CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone), G2_thread);
1155     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_delayed_StackOverflowError), G2_thread);
1156     should_not_reach_here();
1157 
1158     bind(no_reserved_zone_enabling);
1159   }
1160 
1161   interp_verify_oop(Otos_i, state, __FILE__, __LINE__);
1162   verify_thread();
1163 
1164   // return tos
1165   assert(Otos_l1 == Otos_i, &quot;adjust code below&quot;);
1166   switch (state) {
1167   case ltos: mov(Otos_l, Otos_l-&gt;after_save()); break; // O0 -&gt; I0
1168   case btos:                                      // fall through
1169   case ztos:                                      // fall through
1170   case ctos:
1171   case stos:                                      // fall through
1172   case atos:                                      // fall through
1173   case itos: mov(Otos_l1, Otos_l1-&gt;after_save());    break;        // O0 -&gt; I0
1174   case ftos:                                      // fall through
1175   case dtos:                                      // fall through
1176   case vtos: /* nothing to do */                     break;
1177   default  : ShouldNotReachHere();
1178   }
1179 }
1180 
1181 // Lock object
1182 //
1183 // Argument - lock_reg points to the BasicObjectLock to be used for locking,
1184 //            it must be initialized with the object to lock
1185 void InterpreterMacroAssembler::lock_object(Register lock_reg, Register Object) {
1186   if (UseHeavyMonitors) {
1187     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter), lock_reg);
1188   }
1189   else {
1190     Register obj_reg = Object;
1191     Register mark_reg = G4_scratch;
1192     Register temp_reg = G1_scratch;
1193     Address  lock_addr(lock_reg, BasicObjectLock::lock_offset_in_bytes());
1194     Address  mark_addr(obj_reg, oopDesc::mark_offset_in_bytes());
1195     Label    done;
1196 
1197     Label slow_case;
1198 
1199     assert_different_registers(lock_reg, obj_reg, mark_reg, temp_reg);
1200 
1201     // load markWord from object into mark_reg
1202     ld_ptr(mark_addr, mark_reg);
1203 
1204     if (UseBiasedLocking) {
1205       biased_locking_enter(obj_reg, mark_reg, temp_reg, done, &amp;slow_case);
1206     }
1207 
1208     // get the address of basicLock on stack that will be stored in the object
1209     // we need a temporary register here as we do not want to clobber lock_reg
1210     // (cas clobbers the destination register)
1211     mov(lock_reg, temp_reg);
1212     // set mark reg to be (markWord of object | UNLOCK_VALUE)
1213     or3(mark_reg, markWord::unlocked_value, mark_reg);
1214     // initialize the box  (Must happen before we update the object mark!)
1215     st_ptr(mark_reg, lock_addr, BasicLock::displaced_header_offset_in_bytes());
1216     // compare and exchange object_addr, markWord | 1, stack address of basicLock
1217     assert(mark_addr.disp() == 0, &quot;cas must take a zero displacement&quot;);
1218     cas_ptr(mark_addr.base(), mark_reg, temp_reg);
1219 
1220     // if the compare and exchange succeeded we are done (we saw an unlocked object)
1221     cmp_and_brx_short(mark_reg, temp_reg, Assembler::equal, Assembler::pt, done);
1222 
1223     // We did not see an unlocked object so try the fast recursive case
1224 
1225     // Check if owner is self by comparing the value in the markWord of object
1226     // with the stack pointer
1227     sub(temp_reg, SP, temp_reg);
1228     sub(temp_reg, STACK_BIAS, temp_reg);
1229     assert(os::vm_page_size() &gt; 0xfff, &quot;page size too small - change the constant&quot;);
1230 
1231     // Composite &quot;andcc&quot; test:
1232     // (a) %sp -vs- markword proximity check, and,
1233     // (b) verify mark word LSBs == 0 (Stack-locked).
1234     //
1235     // FFFFF003/FFFFFFFFFFFF003 is (markWord::lock_mask_in_place | -os::vm_page_size())
1236     // Note that the page size used for %sp proximity testing is arbitrary and is
1237     // unrelated to the actual MMU page size.  We use a &#39;logical&#39; page size of
1238     // 4096 bytes.   F..FFF003 is designed to fit conveniently in the SIMM13 immediate
1239     // field of the andcc instruction.
1240     andcc (temp_reg, 0xFFFFF003, G0) ;
1241 
1242     // if condition is true we are done and hence we can store 0 in the displaced
1243     // header indicating it is a recursive lock and be done
1244     brx(Assembler::zero, true, Assembler::pt, done);
1245     delayed()-&gt;st_ptr(G0, lock_addr, BasicLock::displaced_header_offset_in_bytes());
1246 
1247     // none of the above fast optimizations worked so we have to get into the
1248     // slow case of monitor enter
1249     bind(slow_case);
1250     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter), lock_reg);
1251 
1252     bind(done);
1253   }
1254 }
1255 
1256 // Unlocks an object. Used in monitorexit bytecode and remove_activation.
1257 //
1258 // Argument - lock_reg points to the BasicObjectLock for lock
1259 // Throw IllegalMonitorException if object is not locked by current thread
1260 void InterpreterMacroAssembler::unlock_object(Register lock_reg) {
1261   if (UseHeavyMonitors) {
1262     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit), lock_reg);
1263   } else {
1264     Register obj_reg = G3_scratch;
1265     Register mark_reg = G4_scratch;
1266     Register displaced_header_reg = G1_scratch;
1267     Address  lockobj_addr(lock_reg, BasicObjectLock::obj_offset_in_bytes());
1268     Address  mark_addr(obj_reg, oopDesc::mark_offset_in_bytes());
1269     Label    done;
1270 
1271     if (UseBiasedLocking) {
1272       // load the object out of the BasicObjectLock
1273       ld_ptr(lockobj_addr, obj_reg);
1274       biased_locking_exit(mark_addr, mark_reg, done, true);
1275       st_ptr(G0, lockobj_addr);  // free entry
1276     }
1277 
1278     // Test first if we are in the fast recursive case
1279     Address lock_addr(lock_reg, BasicObjectLock::lock_offset_in_bytes() + BasicLock::displaced_header_offset_in_bytes());
1280     ld_ptr(lock_addr, displaced_header_reg);
1281     br_null(displaced_header_reg, true, Assembler::pn, done);
1282     delayed()-&gt;st_ptr(G0, lockobj_addr);  // free entry
1283 
1284     // See if it is still a light weight lock, if so we just unlock
1285     // the object and we are done
1286 
1287     if (!UseBiasedLocking) {
1288       // load the object out of the BasicObjectLock
1289       ld_ptr(lockobj_addr, obj_reg);
1290     }
1291 
1292     // we have the displaced header in displaced_header_reg
1293     // we expect to see the stack address of the basicLock in case the
1294     // lock is still a light weight lock (lock_reg)
1295     assert(mark_addr.disp() == 0, &quot;cas must take a zero displacement&quot;);
1296     cas_ptr(mark_addr.base(), lock_reg, displaced_header_reg);
1297     cmp(lock_reg, displaced_header_reg);
1298     brx(Assembler::equal, true, Assembler::pn, done);
1299     delayed()-&gt;st_ptr(G0, lockobj_addr);  // free entry
1300 
1301     // The lock has been converted into a heavy lock and hence
1302     // we need to get into the slow case
1303 
1304     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit), lock_reg);
1305 
1306     bind(done);
1307   }
1308 }
1309 
1310 // Get the method data pointer from the Method* and set the
1311 // specified register to its value.
1312 
1313 void InterpreterMacroAssembler::set_method_data_pointer() {
1314   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1315   Label get_continue;
1316 
1317   ld_ptr(Lmethod, in_bytes(Method::method_data_offset()), ImethodDataPtr);
1318   test_method_data_pointer(get_continue);
1319   add(ImethodDataPtr, in_bytes(MethodData::data_offset()), ImethodDataPtr);
1320   bind(get_continue);
1321 }
1322 
1323 // Set the method data pointer for the current bcp.
1324 
1325 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
1326   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1327   Label zero_continue;
1328 
1329   // Test MDO to avoid the call if it is NULL.
1330   ld_ptr(Lmethod, in_bytes(Method::method_data_offset()), ImethodDataPtr);
1331   test_method_data_pointer(zero_continue);
1332   call_VM_leaf(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), Lmethod, Lbcp);
1333   add(ImethodDataPtr, in_bytes(MethodData::data_offset()), ImethodDataPtr);
1334   add(ImethodDataPtr, O0, ImethodDataPtr);
1335   bind(zero_continue);
1336 }
1337 
1338 // Test ImethodDataPtr.  If it is null, continue at the specified label
1339 
1340 void InterpreterMacroAssembler::test_method_data_pointer(Label&amp; zero_continue) {
1341   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1342   br_null_short(ImethodDataPtr, Assembler::pn, zero_continue);
1343 }
1344 
1345 void InterpreterMacroAssembler::verify_method_data_pointer() {
1346   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1347 #ifdef ASSERT
1348   Label verify_continue;
1349   test_method_data_pointer(verify_continue);
1350 
1351   // If the mdp is valid, it will point to a DataLayout header which is
1352   // consistent with the bcp.  The converse is highly probable also.
1353   lduh(ImethodDataPtr, in_bytes(DataLayout::bci_offset()), G3_scratch);
1354   ld_ptr(Lmethod, Method::const_offset(), O5);
1355   add(G3_scratch, in_bytes(ConstMethod::codes_offset()), G3_scratch);
1356   add(G3_scratch, O5, G3_scratch);
1357   cmp(Lbcp, G3_scratch);
1358   brx(Assembler::equal, false, Assembler::pt, verify_continue);
1359 
1360   Register temp_reg = O5;
1361   delayed()-&gt;mov(ImethodDataPtr, temp_reg);
1362   // %%% should use call_VM_leaf here?
1363   //call_VM_leaf(noreg, ..., Lmethod, Lbcp, ImethodDataPtr);
1364   save_frame_and_mov(sizeof(jdouble) / wordSize, Lmethod, O0, Lbcp, O1);
1365   Address d_save(FP, -sizeof(jdouble) + STACK_BIAS);
1366   stf(FloatRegisterImpl::D, Ftos_d, d_save);
1367   mov(temp_reg-&gt;after_save(), O2);
1368   save_thread(L7_thread_cache);
1369   call(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp), relocInfo::none);
1370   delayed()-&gt;nop();
1371   restore_thread(L7_thread_cache);
1372   ldf(FloatRegisterImpl::D, d_save, Ftos_d);
1373   restore();
1374   bind(verify_continue);
1375 #endif // ASSERT
1376 }
1377 
1378 void InterpreterMacroAssembler::test_invocation_counter_for_mdp(Register invocation_count,
1379                                                                 Register method_counters,
1380                                                                 Register Rtmp,
1381                                                                 Label &amp;profile_continue) {
1382   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1383   // Control will flow to &quot;profile_continue&quot; if the counter is less than the
1384   // limit or if we call profile_method()
1385 
1386   Label done;
1387 
1388   // if no method data exists, and the counter is high enough, make one
1389   br_notnull_short(ImethodDataPtr, Assembler::pn, done);
1390 
1391   // Test to see if we should create a method data oop
1392   Address profile_limit(method_counters, MethodCounters::interpreter_profile_limit_offset());
1393   ld(profile_limit, Rtmp);
1394   cmp(invocation_count, Rtmp);
1395   // Use long branches because call_VM() code and following code generated by
1396   // test_backedge_count_for_osr() is large in debug VM.
1397   br(Assembler::lessUnsigned, false, Assembler::pn, profile_continue);
1398   delayed()-&gt;nop();
1399 
1400   // Build it now.
1401   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1402   set_method_data_pointer_for_bcp();
1403   ba(profile_continue);
1404   delayed()-&gt;nop();
1405   bind(done);
1406 }
1407 
1408 // Store a value at some constant offset from the method data pointer.
1409 
1410 void InterpreterMacroAssembler::set_mdp_data_at(int constant, Register value) {
1411   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1412   st_ptr(value, ImethodDataPtr, constant);
1413 }
1414 
1415 void InterpreterMacroAssembler::increment_mdp_data_at(Address counter,
1416                                                       Register bumped_count,
1417                                                       bool decrement) {
1418   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1419 
1420   // Load the counter.
1421   ld_ptr(counter, bumped_count);
1422 
1423   if (decrement) {
1424     // Decrement the register.  Set condition codes.
1425     subcc(bumped_count, DataLayout::counter_increment, bumped_count);
1426 
1427     // If the decrement causes the counter to overflow, stay negative
1428     Label L;
1429     brx(Assembler::negative, true, Assembler::pn, L);
1430 
1431     // Store the decremented counter, if it is still negative.
1432     delayed()-&gt;st_ptr(bumped_count, counter);
1433     bind(L);
1434   } else {
1435     // Increment the register.  Set carry flag.
1436     addcc(bumped_count, DataLayout::counter_increment, bumped_count);
1437 
1438     // If the increment causes the counter to overflow, pull back by 1.
1439     assert(DataLayout::counter_increment == 1, &quot;subc works&quot;);
1440     subc(bumped_count, G0, bumped_count);
1441 
1442     // Store the incremented counter.
1443     st_ptr(bumped_count, counter);
1444   }
1445 }
1446 
1447 // Increment the value at some constant offset from the method data pointer.
1448 
1449 void InterpreterMacroAssembler::increment_mdp_data_at(int constant,
1450                                                       Register bumped_count,
1451                                                       bool decrement) {
1452   // Locate the counter at a fixed offset from the mdp:
1453   Address counter(ImethodDataPtr, constant);
1454   increment_mdp_data_at(counter, bumped_count, decrement);
1455 }
1456 
1457 // Increment the value at some non-fixed (reg + constant) offset from
1458 // the method data pointer.
1459 
1460 void InterpreterMacroAssembler::increment_mdp_data_at(Register reg,
1461                                                       int constant,
1462                                                       Register bumped_count,
1463                                                       Register scratch2,
1464                                                       bool decrement) {
1465   // Add the constant to reg to get the offset.
1466   add(ImethodDataPtr, reg, scratch2);
1467   Address counter(scratch2, constant);
1468   increment_mdp_data_at(counter, bumped_count, decrement);
1469 }
1470 
1471 // Set a flag value at the current method data pointer position.
1472 // Updates a single byte of the header, to avoid races with other header bits.
1473 
1474 void InterpreterMacroAssembler::set_mdp_flag_at(int flag_constant,
1475                                                 Register scratch) {
1476   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1477   // Load the data header
1478   ldub(ImethodDataPtr, in_bytes(DataLayout::flags_offset()), scratch);
1479 
1480   // Set the flag
1481   or3(scratch, flag_constant, scratch);
1482 
1483   // Store the modified header.
1484   stb(scratch, ImethodDataPtr, in_bytes(DataLayout::flags_offset()));
1485 }
1486 
1487 // Test the location at some offset from the method data pointer.
1488 // If it is not equal to value, branch to the not_equal_continue Label.
1489 // Set condition codes to match the nullness of the loaded value.
1490 
1491 void InterpreterMacroAssembler::test_mdp_data_at(int offset,
1492                                                  Register value,
1493                                                  Label&amp; not_equal_continue,
1494                                                  Register scratch) {
1495   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1496   ld_ptr(ImethodDataPtr, offset, scratch);
1497   cmp(value, scratch);
1498   brx(Assembler::notEqual, false, Assembler::pn, not_equal_continue);
1499   delayed()-&gt;tst(scratch);
1500 }
1501 
1502 // Update the method data pointer by the displacement located at some fixed
1503 // offset from the method data pointer.
1504 
1505 void InterpreterMacroAssembler::update_mdp_by_offset(int offset_of_disp,
1506                                                      Register scratch) {
1507   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1508   ld_ptr(ImethodDataPtr, offset_of_disp, scratch);
1509   add(ImethodDataPtr, scratch, ImethodDataPtr);
1510 }
1511 
1512 // Update the method data pointer by the displacement located at the
1513 // offset (reg + offset_of_disp).
1514 
1515 void InterpreterMacroAssembler::update_mdp_by_offset(Register reg,
1516                                                      int offset_of_disp,
1517                                                      Register scratch) {
1518   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1519   add(reg, offset_of_disp, scratch);
1520   ld_ptr(ImethodDataPtr, scratch, scratch);
1521   add(ImethodDataPtr, scratch, ImethodDataPtr);
1522 }
1523 
1524 // Update the method data pointer by a simple constant displacement.
1525 
1526 void InterpreterMacroAssembler::update_mdp_by_constant(int constant) {
1527   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1528   add(ImethodDataPtr, constant, ImethodDataPtr);
1529 }
1530 
1531 // Update the method data pointer for a _ret bytecode whose target
1532 // was not among our cached targets.
1533 
1534 void InterpreterMacroAssembler::update_mdp_for_ret(TosState state,
1535                                                    Register return_bci) {
1536   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1537   push(state);
1538   st_ptr(return_bci, l_tmp);  // protect return_bci, in case it is volatile
1539   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret), return_bci);
1540   ld_ptr(l_tmp, return_bci);
1541   pop(state);
1542 }
1543 
1544 // Count a taken branch in the bytecodes.
1545 
1546 void InterpreterMacroAssembler::profile_taken_branch(Register scratch, Register bumped_count) {
1547   if (ProfileInterpreter) {
1548     Label profile_continue;
1549 
1550     // If no method data exists, go to profile_continue.
1551     test_method_data_pointer(profile_continue);
1552 
1553     // We are taking a branch.  Increment the taken count.
1554     increment_mdp_data_at(in_bytes(JumpData::taken_offset()), bumped_count);
1555 
1556     // The method data pointer needs to be updated to reflect the new target.
1557     update_mdp_by_offset(in_bytes(JumpData::displacement_offset()), scratch);
1558     bind (profile_continue);
1559   }
1560 }
1561 
1562 
1563 // Count a not-taken branch in the bytecodes.
1564 
1565 void InterpreterMacroAssembler::profile_not_taken_branch(Register scratch) {
1566   if (ProfileInterpreter) {
1567     Label profile_continue;
1568 
1569     // If no method data exists, go to profile_continue.
1570     test_method_data_pointer(profile_continue);
1571 
1572     // We are taking a branch.  Increment the not taken count.
1573     increment_mdp_data_at(in_bytes(BranchData::not_taken_offset()), scratch);
1574 
1575     // The method data pointer needs to be updated to correspond to the
1576     // next bytecode.
1577     update_mdp_by_constant(in_bytes(BranchData::branch_data_size()));
1578     bind (profile_continue);
1579   }
1580 }
1581 
1582 
1583 // Count a non-virtual call in the bytecodes.
1584 
1585 void InterpreterMacroAssembler::profile_call(Register scratch) {
1586   if (ProfileInterpreter) {
1587     Label profile_continue;
1588 
1589     // If no method data exists, go to profile_continue.
1590     test_method_data_pointer(profile_continue);
1591 
1592     // We are making a call.  Increment the count.
1593     increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch);
1594 
1595     // The method data pointer needs to be updated to reflect the new target.
1596     update_mdp_by_constant(in_bytes(CounterData::counter_data_size()));
1597     bind (profile_continue);
1598   }
1599 }
1600 
1601 
1602 // Count a final call in the bytecodes.
1603 
1604 void InterpreterMacroAssembler::profile_final_call(Register scratch) {
1605   if (ProfileInterpreter) {
1606     Label profile_continue;
1607 
1608     // If no method data exists, go to profile_continue.
1609     test_method_data_pointer(profile_continue);
1610 
1611     // We are making a call.  Increment the count.
1612     increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch);
1613 
1614     // The method data pointer needs to be updated to reflect the new target.
1615     update_mdp_by_constant(in_bytes(VirtualCallData::virtual_call_data_size()));
1616     bind (profile_continue);
1617   }
1618 }
1619 
1620 
1621 // Count a virtual call in the bytecodes.
1622 
1623 void InterpreterMacroAssembler::profile_virtual_call(Register receiver,
1624                                                      Register scratch,
1625                                                      bool receiver_can_be_null) {
1626   if (ProfileInterpreter) {
1627     Label profile_continue;
1628 
1629     // If no method data exists, go to profile_continue.
1630     test_method_data_pointer(profile_continue);
1631 
1632 
1633     Label skip_receiver_profile;
1634     if (receiver_can_be_null) {
1635       Label not_null;
1636       br_notnull_short(receiver, Assembler::pt, not_null);
1637       // We are making a call.  Increment the count for null receiver.
1638       increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch);
1639       ba_short(skip_receiver_profile);
1640       bind(not_null);
1641     }
1642 
1643     // Record the receiver type.
1644     record_klass_in_profile(receiver, scratch, true);
1645     bind(skip_receiver_profile);
1646 
1647     // The method data pointer needs to be updated to reflect the new target.
1648 #if INCLUDE_JVMCI
1649     if (MethodProfileWidth == 0) {
1650       update_mdp_by_constant(in_bytes(VirtualCallData::virtual_call_data_size()));
1651     }
1652 #else
1653     update_mdp_by_constant(in_bytes(VirtualCallData::virtual_call_data_size()));
1654 #endif
1655     bind(profile_continue);
1656   }
1657 }
1658 
1659 #if INCLUDE_JVMCI
1660 void InterpreterMacroAssembler::profile_called_method(Register method, Register scratch) {
1661   assert_different_registers(method, scratch);
1662   if (ProfileInterpreter &amp;&amp; MethodProfileWidth &gt; 0) {
1663     Label profile_continue;
1664 
1665     // If no method data exists, go to profile_continue.
1666     test_method_data_pointer(profile_continue);
1667 
1668     Label done;
1669     record_item_in_profile_helper(method, scratch, 0, done, MethodProfileWidth,
1670       &amp;VirtualCallData::method_offset, &amp;VirtualCallData::method_count_offset, in_bytes(VirtualCallData::nonprofiled_receiver_count_offset()));
1671     bind(done);
1672 
1673     update_mdp_by_constant(in_bytes(VirtualCallData::virtual_call_data_size()));
1674     bind(profile_continue);
1675   }
1676 }
1677 #endif // INCLUDE_JVMCI
1678 
1679 void InterpreterMacroAssembler::record_klass_in_profile_helper(Register receiver, Register scratch,
1680                                                                Label&amp; done, bool is_virtual_call) {
1681   if (TypeProfileWidth == 0) {
1682     if (is_virtual_call) {
1683       increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch);
1684     }
1685 #if INCLUDE_JVMCI
1686     else if (EnableJVMCI) {
1687       increment_mdp_data_at(in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset()), scratch);
1688     }
1689 #endif
1690   } else {
1691     int non_profiled_offset = -1;
1692     if (is_virtual_call) {
1693       non_profiled_offset = in_bytes(CounterData::count_offset());
1694     }
1695 #if INCLUDE_JVMCI
1696     else if (EnableJVMCI) {
1697       non_profiled_offset = in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset());
1698     }
1699 #endif
1700 
1701     record_item_in_profile_helper(receiver, scratch, 0, done, TypeProfileWidth,
1702       &amp;VirtualCallData::receiver_offset, &amp;VirtualCallData::receiver_count_offset, non_profiled_offset);
1703   }
1704 }
1705 
1706 void InterpreterMacroAssembler::record_item_in_profile_helper(Register item,
1707                                           Register scratch, int start_row, Label&amp; done, int total_rows,
1708                                           OffsetFunction item_offset_fn, OffsetFunction item_count_offset_fn,
1709                                           int non_profiled_offset) {
1710   int last_row = total_rows - 1;
1711   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1712   // Test this row for both the item and for null.
1713   // Take any of three different outcomes:
1714   //   1. found item =&gt; increment count and goto done
1715   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1716   //   3. found something else =&gt; keep looking for cases 1 and 2
1717   // Case 3 is handled by a recursive call.
1718   for (int row = start_row; row &lt;= last_row; row++) {
1719     Label next_test;
1720     bool test_for_null_also = (row == start_row);
1721 
1722     // See if the item is item[n].
1723     int item_offset = in_bytes(item_offset_fn(row));
1724     test_mdp_data_at(item_offset, item, next_test, scratch);
1725     // delayed()-&gt;tst(scratch);
1726 
1727     // The receiver is item[n].  Increment count[n].
1728     int count_offset = in_bytes(item_count_offset_fn(row));
1729     increment_mdp_data_at(count_offset, scratch);
1730     ba_short(done);
1731     bind(next_test);
1732 
1733     if (test_for_null_also) {
1734       Label found_null;
1735       // Failed the equality check on item[n]...  Test for null.
1736       if (start_row == last_row) {
1737         // The only thing left to do is handle the null case.
1738         if (non_profiled_offset &gt;= 0) {
1739           brx(Assembler::zero, false, Assembler::pn, found_null);
1740           delayed()-&gt;nop();
1741           // Item did not match any saved item and there is no empty row for it.
1742           // Increment total counter to indicate polymorphic case.
1743           increment_mdp_data_at(non_profiled_offset, scratch);
1744           ba_short(done);
1745           bind(found_null);
1746         } else {
1747           brx(Assembler::notZero, false, Assembler::pt, done);
1748           delayed()-&gt;nop();
1749         }
1750         break;
1751       }
1752       // Since null is rare, make it be the branch-taken case.
1753       brx(Assembler::zero, false, Assembler::pn, found_null);
1754       delayed()-&gt;nop();
1755 
1756       // Put all the &quot;Case 3&quot; tests here.
1757       record_item_in_profile_helper(item, scratch, start_row + 1, done, total_rows,
1758         item_offset_fn, item_count_offset_fn, non_profiled_offset);
1759 
1760       // Found a null.  Keep searching for a matching item,
1761       // but remember that this is an empty (unused) slot.
1762       bind(found_null);
1763     }
1764   }
1765 
1766   // In the fall-through case, we found no matching item, but we
1767   // observed the item[start_row] is NULL.
1768 
1769   // Fill in the item field and increment the count.
1770   int item_offset = in_bytes(item_offset_fn(start_row));
1771   set_mdp_data_at(item_offset, item);
1772   int count_offset = in_bytes(item_count_offset_fn(start_row));
1773   mov(DataLayout::counter_increment, scratch);
1774   set_mdp_data_at(count_offset, scratch);
1775   if (start_row &gt; 0) {
1776     ba_short(done);
1777   }
1778 }
1779 
1780 void InterpreterMacroAssembler::record_klass_in_profile(Register receiver,
1781                                                         Register scratch, bool is_virtual_call) {
1782   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1783   Label done;
1784 
1785   record_klass_in_profile_helper(receiver, scratch, done, is_virtual_call);
1786 
1787   bind (done);
1788 }
1789 
1790 
1791 // Count a ret in the bytecodes.
1792 
1793 void InterpreterMacroAssembler::profile_ret(TosState state,
1794                                             Register return_bci,
1795                                             Register scratch) {
1796   if (ProfileInterpreter) {
1797     Label profile_continue;
1798     uint row;
1799 
1800     // If no method data exists, go to profile_continue.
1801     test_method_data_pointer(profile_continue);
1802 
1803     // Update the total ret count.
1804     increment_mdp_data_at(in_bytes(CounterData::count_offset()), scratch);
1805 
1806     for (row = 0; row &lt; RetData::row_limit(); row++) {
1807       Label next_test;
1808 
1809       // See if return_bci is equal to bci[n]:
1810       test_mdp_data_at(in_bytes(RetData::bci_offset(row)),
1811                        return_bci, next_test, scratch);
1812 
1813       // return_bci is equal to bci[n].  Increment the count.
1814       increment_mdp_data_at(in_bytes(RetData::bci_count_offset(row)), scratch);
1815 
1816       // The method data pointer needs to be updated to reflect the new target.
1817       update_mdp_by_offset(in_bytes(RetData::bci_displacement_offset(row)), scratch);
1818       ba_short(profile_continue);
1819       bind(next_test);
1820     }
1821 
1822     update_mdp_for_ret(state, return_bci);
1823 
1824     bind (profile_continue);
1825   }
1826 }
1827 
1828 // Profile an unexpected null in the bytecodes.
1829 void InterpreterMacroAssembler::profile_null_seen(Register scratch) {
1830   if (ProfileInterpreter) {
1831     Label profile_continue;
1832 
1833     // If no method data exists, go to profile_continue.
1834     test_method_data_pointer(profile_continue);
1835 
1836     set_mdp_flag_at(BitData::null_seen_byte_constant(), scratch);
1837 
1838     // The method data pointer needs to be updated.
1839     int mdp_delta = in_bytes(BitData::bit_data_size());
1840     if (TypeProfileCasts) {
1841       mdp_delta = in_bytes(ReceiverTypeData::receiver_type_data_size());
1842     }
1843     update_mdp_by_constant(mdp_delta);
1844 
1845     bind (profile_continue);
1846   }
1847 }
1848 
1849 void InterpreterMacroAssembler::profile_typecheck(Register klass,
1850                                                   Register scratch) {
1851   if (ProfileInterpreter) {
1852     Label profile_continue;
1853 
1854     // If no method data exists, go to profile_continue.
1855     test_method_data_pointer(profile_continue);
1856 
1857     int mdp_delta = in_bytes(BitData::bit_data_size());
1858     if (TypeProfileCasts) {
1859       mdp_delta = in_bytes(ReceiverTypeData::receiver_type_data_size());
1860 
1861       // Record the object type.
1862       record_klass_in_profile(klass, scratch, false);
1863     }
1864 
1865     // The method data pointer needs to be updated.
1866     update_mdp_by_constant(mdp_delta);
1867 
1868     bind (profile_continue);
1869   }
1870 }
1871 
1872 void InterpreterMacroAssembler::profile_typecheck_failed(Register scratch) {
1873   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1874     Label profile_continue;
1875 
1876     // If no method data exists, go to profile_continue.
1877     test_method_data_pointer(profile_continue);
1878 
1879     int count_offset = in_bytes(CounterData::count_offset());
1880     // Back up the address, since we have already bumped the mdp.
1881     count_offset -= in_bytes(ReceiverTypeData::receiver_type_data_size());
1882 
1883     // *Decrement* the counter.  We expect to see zero or small negatives.
1884     increment_mdp_data_at(count_offset, scratch, true);
1885 
1886     bind (profile_continue);
1887   }
1888 }
1889 
1890 // Count the default case of a switch construct.
1891 
1892 void InterpreterMacroAssembler::profile_switch_default(Register scratch) {
1893   if (ProfileInterpreter) {
1894     Label profile_continue;
1895 
1896     // If no method data exists, go to profile_continue.
1897     test_method_data_pointer(profile_continue);
1898 
1899     // Update the default case count
1900     increment_mdp_data_at(in_bytes(MultiBranchData::default_count_offset()),
1901                           scratch);
1902 
1903     // The method data pointer needs to be updated.
1904     update_mdp_by_offset(
1905                     in_bytes(MultiBranchData::default_displacement_offset()),
1906                     scratch);
1907 
1908     bind (profile_continue);
1909   }
1910 }
1911 
1912 // Count the index&#39;th case of a switch construct.
1913 
1914 void InterpreterMacroAssembler::profile_switch_case(Register index,
1915                                                     Register scratch,
1916                                                     Register scratch2,
1917                                                     Register scratch3) {
1918   if (ProfileInterpreter) {
1919     Label profile_continue;
1920 
1921     // If no method data exists, go to profile_continue.
1922     test_method_data_pointer(profile_continue);
1923 
1924     // Build the base (index * per_case_size_in_bytes()) + case_array_offset_in_bytes()
1925     set(in_bytes(MultiBranchData::per_case_size()), scratch);
1926     smul(index, scratch, scratch);
1927     add(scratch, in_bytes(MultiBranchData::case_array_offset()), scratch);
1928 
1929     // Update the case count
1930     increment_mdp_data_at(scratch,
1931                           in_bytes(MultiBranchData::relative_count_offset()),
1932                           scratch2,
1933                           scratch3);
1934 
1935     // The method data pointer needs to be updated.
1936     update_mdp_by_offset(scratch,
1937                      in_bytes(MultiBranchData::relative_displacement_offset()),
1938                      scratch2);
1939 
1940     bind (profile_continue);
1941   }
1942 }
1943 
1944 void InterpreterMacroAssembler::profile_obj_type(Register obj, const Address&amp; mdo_addr, Register tmp) {
1945   Label not_null, do_nothing, do_update;
1946 
1947   assert_different_registers(obj, mdo_addr.base(), tmp);
1948 
1949   verify_oop(obj);
1950 
1951   ld_ptr(mdo_addr, tmp);
1952 
1953   br_notnull_short(obj, pt, not_null);
1954   or3(tmp, TypeEntries::null_seen, tmp);
1955   ba_short(do_update);
1956 
1957   bind(not_null);
1958   load_klass(obj, obj);
1959 
1960   xor3(obj, tmp, obj);
1961   btst(TypeEntries::type_klass_mask, obj);
1962   // klass seen before, nothing to do. The unknown bit may have been
1963   // set already but no need to check.
1964   brx(zero, false, pt, do_nothing);
1965   delayed()-&gt;
1966 
1967   btst(TypeEntries::type_unknown, obj);
1968   // already unknown. Nothing to do anymore.
1969   brx(notZero, false, pt, do_nothing);
1970   delayed()-&gt;
1971 
1972   btst(TypeEntries::type_mask, tmp);
1973   brx(zero, true, pt, do_update);
1974   // first time here. Set profile type.
1975   delayed()-&gt;or3(tmp, obj, tmp);
1976 
1977   // different than before. Cannot keep accurate profile.
1978   or3(tmp, TypeEntries::type_unknown, tmp);
1979 
1980   bind(do_update);
1981   // update profile
1982   st_ptr(tmp, mdo_addr);
1983 
1984   bind(do_nothing);
1985 }
1986 
1987 void InterpreterMacroAssembler::profile_arguments_type(Register callee, Register tmp1, Register tmp2, bool is_virtual) {
1988   if (!ProfileInterpreter) {
1989     return;
1990   }
1991 
1992   assert_different_registers(callee, tmp1, tmp2, ImethodDataPtr);
1993 
1994   if (MethodData::profile_arguments() || MethodData::profile_return()) {
1995     Label profile_continue;
1996 
1997     test_method_data_pointer(profile_continue);
1998 
1999     int off_to_start = is_virtual ? in_bytes(VirtualCallData::virtual_call_data_size()) : in_bytes(CounterData::counter_data_size());
2000 
2001     ldub(ImethodDataPtr, in_bytes(DataLayout::tag_offset()) - off_to_start, tmp1);
2002     cmp_and_br_short(tmp1, is_virtual ? DataLayout::virtual_call_type_data_tag : DataLayout::call_type_data_tag, notEqual, pn, profile_continue);
2003 
2004     if (MethodData::profile_arguments()) {
2005       Label done;
2006       int off_to_args = in_bytes(TypeEntriesAtCall::args_data_offset());
2007       add(ImethodDataPtr, off_to_args, ImethodDataPtr);
2008 
2009       for (int i = 0; i &lt; TypeProfileArgsLimit; i++) {
2010         if (i &gt; 0 || MethodData::profile_return()) {
2011           // If return value type is profiled we may have no argument to profile
2012           ld_ptr(ImethodDataPtr, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args, tmp1);
2013           sub(tmp1, i*TypeStackSlotEntries::per_arg_count(), tmp1);
2014           cmp_and_br_short(tmp1, TypeStackSlotEntries::per_arg_count(), less, pn, done);
2015         }
2016         ld_ptr(Address(callee, Method::const_offset()), tmp1);
2017         lduh(Address(tmp1, ConstMethod::size_of_parameters_offset()), tmp1);
2018         // stack offset o (zero based) from the start of the argument
2019         // list, for n arguments translates into offset n - o - 1 from
2020         // the end of the argument list. But there&#39;s an extra slot at
2021         // the stop of the stack. So the offset is n - o from Lesp.
2022         ld_ptr(ImethodDataPtr, in_bytes(TypeEntriesAtCall::stack_slot_offset(i))-off_to_args, tmp2);
2023         sub(tmp1, tmp2, tmp1);
2024 
2025         // Can&#39;t use MacroAssembler::argument_address() which needs Gargs to be set up
2026         sll(tmp1, Interpreter::logStackElementSize, tmp1);
2027         ld_ptr(Lesp, tmp1, tmp1);
2028 
2029         Address mdo_arg_addr(ImethodDataPtr, in_bytes(TypeEntriesAtCall::argument_type_offset(i))-off_to_args);
2030         profile_obj_type(tmp1, mdo_arg_addr, tmp2);
2031 
2032         int to_add = in_bytes(TypeStackSlotEntries::per_arg_size());
2033         add(ImethodDataPtr, to_add, ImethodDataPtr);
2034         off_to_args += to_add;
2035       }
2036 
2037       if (MethodData::profile_return()) {
2038         ld_ptr(ImethodDataPtr, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args, tmp1);
2039         sub(tmp1, TypeProfileArgsLimit*TypeStackSlotEntries::per_arg_count(), tmp1);
2040       }
2041 
2042       bind(done);
2043 
2044       if (MethodData::profile_return()) {
2045         // We&#39;re right after the type profile for the last
2046         // argument. tmp1 is the number of cells left in the
2047         // CallTypeData/VirtualCallTypeData to reach its end. Non null
2048         // if there&#39;s a return to profile.
2049         assert(ReturnTypeEntry::static_cell_count() &lt; TypeStackSlotEntries::per_arg_count(), &quot;can&#39;t move past ret type&quot;);
2050         sll(tmp1, exact_log2(DataLayout::cell_size), tmp1);
2051         add(ImethodDataPtr, tmp1, ImethodDataPtr);
2052       }
2053     } else {
2054       assert(MethodData::profile_return(), &quot;either profile call args or call ret&quot;);
2055       update_mdp_by_constant(in_bytes(TypeEntriesAtCall::return_only_size()));
2056     }
2057 
2058     // mdp points right after the end of the
2059     // CallTypeData/VirtualCallTypeData, right after the cells for the
2060     // return value type if there&#39;s one.
2061 
2062     bind(profile_continue);
2063   }
2064 }
2065 
2066 void InterpreterMacroAssembler::profile_return_type(Register ret, Register tmp1, Register tmp2) {
2067   assert_different_registers(ret, tmp1, tmp2);
2068   if (ProfileInterpreter &amp;&amp; MethodData::profile_return()) {
2069     Label profile_continue, done;
2070 
2071     test_method_data_pointer(profile_continue);
2072 
2073     if (MethodData::profile_return_jsr292_only()) {
2074       assert(Method::intrinsic_id_size_in_bytes() == 2, &quot;assuming Method::_intrinsic_id is u2&quot;);
2075 
2076       // If we don&#39;t profile all invoke bytecodes we must make sure
2077       // it&#39;s a bytecode we indeed profile. We can&#39;t go back to the
2078       // begining of the ProfileData we intend to update to check its
2079       // type because we&#39;re right after it and we don&#39;t known its
2080       // length.
2081       Label do_profile;
2082       ldub(Lbcp, 0, tmp1);
2083       cmp_and_br_short(tmp1, Bytecodes::_invokedynamic, equal, pn, do_profile);
2084       cmp(tmp1, Bytecodes::_invokehandle);
2085       br(equal, false, pn, do_profile);
2086       delayed()-&gt;lduh(Lmethod, Method::intrinsic_id_offset_in_bytes(), tmp1);
2087       cmp_and_br_short(tmp1, vmIntrinsics::_compiledLambdaForm, notEqual, pt, profile_continue);
2088 
2089       bind(do_profile);
2090     }
2091 
2092     Address mdo_ret_addr(ImethodDataPtr, -in_bytes(ReturnTypeEntry::size()));
2093     mov(ret, tmp1);
2094     profile_obj_type(tmp1, mdo_ret_addr, tmp2);
2095 
2096     bind(profile_continue);
2097   }
2098 }
2099 
2100 void InterpreterMacroAssembler::profile_parameters_type(Register tmp1, Register tmp2, Register tmp3, Register tmp4) {
2101   if (ProfileInterpreter &amp;&amp; MethodData::profile_parameters()) {
2102     Label profile_continue, done;
2103 
2104     test_method_data_pointer(profile_continue);
2105 
2106     // Load the offset of the area within the MDO used for
2107     // parameters. If it&#39;s negative we&#39;re not profiling any parameters.
2108     lduw(ImethodDataPtr, in_bytes(MethodData::parameters_type_data_di_offset()) - in_bytes(MethodData::data_offset()), tmp1);
2109     cmp_and_br_short(tmp1, 0, less, pn, profile_continue);
2110 
2111     // Compute a pointer to the area for parameters from the offset
2112     // and move the pointer to the slot for the last
2113     // parameters. Collect profiling from last parameter down.
2114     // mdo start + parameters offset + array length - 1
2115 
2116     // Pointer to the parameter area in the MDO
2117     Register mdp = tmp1;
2118     add(ImethodDataPtr, tmp1, mdp);
2119 
2120     // offset of the current profile entry to update
2121     Register entry_offset = tmp2;
2122     // entry_offset = array len in number of cells
2123     ld_ptr(mdp, ArrayData::array_len_offset(), entry_offset);
2124 
2125     int off_base = in_bytes(ParametersTypeData::stack_slot_offset(0));
2126     assert(off_base % DataLayout::cell_size == 0, &quot;should be a number of cells&quot;);
2127 
2128     // entry_offset (number of cells)  = array len - size of 1 entry + offset of the stack slot field
2129     sub(entry_offset, TypeStackSlotEntries::per_arg_count() - (off_base / DataLayout::cell_size), entry_offset);
2130     // entry_offset in bytes
2131     sll(entry_offset, exact_log2(DataLayout::cell_size), entry_offset);
2132 
2133     Label loop;
2134     bind(loop);
2135 
2136     // load offset on the stack from the slot for this parameter
2137     ld_ptr(mdp, entry_offset, tmp3);
2138     sll(tmp3,Interpreter::logStackElementSize, tmp3);
2139     neg(tmp3);
2140     // read the parameter from the local area
2141     ld_ptr(Llocals, tmp3, tmp3);
2142 
2143     // make entry_offset now point to the type field for this parameter
2144     int type_base = in_bytes(ParametersTypeData::type_offset(0));
2145     assert(type_base &gt; off_base, &quot;unexpected&quot;);
2146     add(entry_offset, type_base - off_base, entry_offset);
2147 
2148     // profile the parameter
2149     Address arg_type(mdp, entry_offset);
2150     profile_obj_type(tmp3, arg_type, tmp4);
2151 
2152     // go to next parameter
2153     sub(entry_offset, TypeStackSlotEntries::per_arg_count() * DataLayout::cell_size + (type_base - off_base), entry_offset);
2154     cmp_and_br_short(entry_offset, off_base, greaterEqual, pt, loop);
2155 
2156     bind(profile_continue);
2157   }
2158 }
2159 
2160 // add a InterpMonitorElem to stack (see frame_sparc.hpp)
2161 
2162 void InterpreterMacroAssembler::add_monitor_to_stack( bool stack_is_empty,
2163                                                       Register Rtemp,
2164                                                       Register Rtemp2 ) {
2165 
2166   Register Rlimit = Lmonitors;
2167   const jint delta = frame::interpreter_frame_monitor_size() * wordSize;
2168   assert( (delta &amp; LongAlignmentMask) == 0,
2169           &quot;sizeof BasicObjectLock must be even number of doublewords&quot;);
2170 
2171   sub( SP,        delta, SP);
2172   sub( Lesp,      delta, Lesp);
2173   sub( Lmonitors, delta, Lmonitors);
2174 
2175   if (!stack_is_empty) {
2176 
2177     // must copy stack contents down
2178 
2179     Label start_copying, next;
2180 
2181     // untested(&quot;monitor stack expansion&quot;);
2182     compute_stack_base(Rtemp);
2183     ba(start_copying);
2184     delayed()-&gt;cmp(Rtemp, Rlimit); // done? duplicated below
2185 
2186     // note: must copy from low memory upwards
2187     // On entry to loop,
2188     // Rtemp points to new base of stack, Lesp points to new end of stack (1 past TOS)
2189     // Loop mutates Rtemp
2190 
2191     bind( next);
2192 
2193     st_ptr(Rtemp2, Rtemp, 0);
2194     inc(Rtemp, wordSize);
2195     cmp(Rtemp, Rlimit); // are we done? (duplicated above)
2196 
2197     bind( start_copying );
2198 
2199     brx( notEqual, true, pn, next );
2200     delayed()-&gt;ld_ptr( Rtemp, delta, Rtemp2 );
2201 
2202     // done copying stack
2203   }
2204 }
2205 
2206 // Locals
2207 void InterpreterMacroAssembler::access_local_ptr( Register index, Register dst ) {
2208   assert_not_delayed();
2209   sll(index, Interpreter::logStackElementSize, index);
2210   sub(Llocals, index, index);
2211   ld_ptr(index, 0, dst);
2212   // Note:  index must hold the effective address--the iinc template uses it
2213 }
2214 
2215 // Just like access_local_ptr but the tag is a returnAddress
2216 void InterpreterMacroAssembler::access_local_returnAddress(Register index,
2217                                                            Register dst ) {
2218   assert_not_delayed();
2219   sll(index, Interpreter::logStackElementSize, index);
2220   sub(Llocals, index, index);
2221   ld_ptr(index, 0, dst);
2222 }
2223 
2224 void InterpreterMacroAssembler::access_local_int( Register index, Register dst ) {
2225   assert_not_delayed();
2226   sll(index, Interpreter::logStackElementSize, index);
2227   sub(Llocals, index, index);
2228   ld(index, 0, dst);
2229   // Note:  index must hold the effective address--the iinc template uses it
2230 }
2231 
2232 
2233 void InterpreterMacroAssembler::access_local_long( Register index, Register dst ) {
2234   assert_not_delayed();
2235   sll(index, Interpreter::logStackElementSize, index);
2236   sub(Llocals, index, index);
2237   // First half stored at index n+1 (which grows down from Llocals[n])
2238   load_unaligned_long(index, Interpreter::local_offset_in_bytes(1), dst);
2239 }
2240 
2241 
2242 void InterpreterMacroAssembler::access_local_float( Register index, FloatRegister dst ) {
2243   assert_not_delayed();
2244   sll(index, Interpreter::logStackElementSize, index);
2245   sub(Llocals, index, index);
2246   ldf(FloatRegisterImpl::S, index, 0, dst);
2247 }
2248 
2249 
2250 void InterpreterMacroAssembler::access_local_double( Register index, FloatRegister dst ) {
2251   assert_not_delayed();
2252   sll(index, Interpreter::logStackElementSize, index);
2253   sub(Llocals, index, index);
2254   load_unaligned_double(index, Interpreter::local_offset_in_bytes(1), dst);
2255 }
2256 
2257 
2258 #ifdef ASSERT
2259 void InterpreterMacroAssembler::check_for_regarea_stomp(Register Rindex, int offset, Register Rlimit, Register Rscratch, Register Rscratch1) {
2260   Label L;
2261 
2262   assert(Rindex != Rscratch, &quot;Registers cannot be same&quot;);
2263   assert(Rindex != Rscratch1, &quot;Registers cannot be same&quot;);
2264   assert(Rlimit != Rscratch, &quot;Registers cannot be same&quot;);
2265   assert(Rlimit != Rscratch1, &quot;Registers cannot be same&quot;);
2266   assert(Rscratch1 != Rscratch, &quot;Registers cannot be same&quot;);
2267 
2268   // untested(&quot;reg area corruption&quot;);
2269   add(Rindex, offset, Rscratch);
2270   add(Rlimit, 64 + STACK_BIAS, Rscratch1);
2271   cmp_and_brx_short(Rscratch, Rscratch1, Assembler::greaterEqualUnsigned, pn, L);
2272   stop(&quot;regsave area is being clobbered&quot;);
2273   bind(L);
2274 }
2275 #endif // ASSERT
2276 
2277 
2278 void InterpreterMacroAssembler::store_local_int( Register index, Register src ) {
2279   assert_not_delayed();
2280   sll(index, Interpreter::logStackElementSize, index);
2281   sub(Llocals, index, index);
2282   debug_only(check_for_regarea_stomp(index, 0, FP, G1_scratch, G4_scratch);)
2283   st(src, index, 0);
2284 }
2285 
2286 void InterpreterMacroAssembler::store_local_ptr( Register index, Register src ) {
2287   assert_not_delayed();
2288   sll(index, Interpreter::logStackElementSize, index);
2289   sub(Llocals, index, index);
2290 #ifdef ASSERT
2291   check_for_regarea_stomp(index, 0, FP, G1_scratch, G4_scratch);
2292 #endif
2293   st_ptr(src, index, 0);
2294 }
2295 
2296 
2297 
2298 void InterpreterMacroAssembler::store_local_ptr( int n, Register src ) {
2299   st_ptr(src, Llocals, Interpreter::local_offset_in_bytes(n));
2300 }
2301 
2302 void InterpreterMacroAssembler::store_local_long( Register index, Register src ) {
2303   assert_not_delayed();
2304   sll(index, Interpreter::logStackElementSize, index);
2305   sub(Llocals, index, index);
2306 #ifdef ASSERT
2307   check_for_regarea_stomp(index, Interpreter::local_offset_in_bytes(1), FP, G1_scratch, G4_scratch);
2308 #endif
2309   store_unaligned_long(src, index, Interpreter::local_offset_in_bytes(1)); // which is n+1
2310 }
2311 
2312 
2313 void InterpreterMacroAssembler::store_local_float( Register index, FloatRegister src ) {
2314   assert_not_delayed();
2315   sll(index, Interpreter::logStackElementSize, index);
2316   sub(Llocals, index, index);
2317 #ifdef ASSERT
2318   check_for_regarea_stomp(index, 0, FP, G1_scratch, G4_scratch);
2319 #endif
2320   stf(FloatRegisterImpl::S, src, index, 0);
2321 }
2322 
2323 
2324 void InterpreterMacroAssembler::store_local_double( Register index, FloatRegister src ) {
2325   assert_not_delayed();
2326   sll(index, Interpreter::logStackElementSize, index);
2327   sub(Llocals, index, index);
2328 #ifdef ASSERT
2329   check_for_regarea_stomp(index, Interpreter::local_offset_in_bytes(1), FP, G1_scratch, G4_scratch);
2330 #endif
2331   store_unaligned_double(src, index, Interpreter::local_offset_in_bytes(1));
2332 }
2333 
2334 
2335 int InterpreterMacroAssembler::top_most_monitor_byte_offset() {
2336   const jint delta = frame::interpreter_frame_monitor_size() * wordSize;
2337   int rounded_vm_local_words = align_up((int)frame::interpreter_frame_vm_local_words, WordsPerLong);
2338   return ((-rounded_vm_local_words * wordSize) - delta ) + STACK_BIAS;
2339 }
2340 
2341 
2342 Address InterpreterMacroAssembler::top_most_monitor() {
2343   return Address(FP, top_most_monitor_byte_offset());
2344 }
2345 
2346 
2347 void InterpreterMacroAssembler::compute_stack_base( Register Rdest ) {
2348   add( Lesp,      wordSize,                                    Rdest );
2349 }
2350 
2351 void InterpreterMacroAssembler::get_method_counters(Register method,
2352                                                     Register Rcounters,
2353                                                     Label&amp; skip) {
2354   Label has_counters;
2355   Address method_counters(method, in_bytes(Method::method_counters_offset()));
2356   ld_ptr(method_counters, Rcounters);
2357   br_notnull_short(Rcounters, Assembler::pt, has_counters);
2358   call_VM(noreg, CAST_FROM_FN_PTR(address,
2359           InterpreterRuntime::build_method_counters), method);
2360   ld_ptr(method_counters, Rcounters);
2361   br_null(Rcounters, false, Assembler::pn, skip); // No MethodCounters, OutOfMemory
2362   delayed()-&gt;nop();
2363   bind(has_counters);
2364 }
2365 
2366 void InterpreterMacroAssembler::increment_invocation_counter( Register Rcounters, Register Rtmp, Register Rtmp2 ) {
2367   assert(UseCompiler || LogTouchedMethods, &quot;incrementing must be useful&quot;);
2368   assert_different_registers(Rcounters, Rtmp, Rtmp2);
2369 
2370   Address inv_counter(Rcounters, MethodCounters::invocation_counter_offset() +
2371                                  InvocationCounter::counter_offset());
2372   Address be_counter (Rcounters, MethodCounters::backedge_counter_offset() +
2373                                  InvocationCounter::counter_offset());
2374   int delta = InvocationCounter::count_increment;
2375 
2376   // Load each counter in a register
2377   ld( inv_counter, Rtmp );
2378   ld( be_counter, Rtmp2 );
2379 
2380   assert( is_simm13( delta ), &quot; delta too large.&quot;);
2381 
2382   // Add the delta to the invocation counter and store the result
2383   add( Rtmp, delta, Rtmp );
2384 
2385   // Mask the backedge counter
2386   and3( Rtmp2, InvocationCounter::count_mask_value, Rtmp2 );
2387 
2388   // Store value
2389   st( Rtmp, inv_counter);
2390 
2391   // Add invocation counter + backedge counter
2392   add( Rtmp, Rtmp2, Rtmp);
2393 
2394   // Note that this macro must leave the backedge_count + invocation_count in Rtmp!
2395 }
2396 
2397 void InterpreterMacroAssembler::increment_backedge_counter( Register Rcounters, Register Rtmp, Register Rtmp2 ) {
2398   assert(UseCompiler, &quot;incrementing must be useful&quot;);
2399   assert_different_registers(Rcounters, Rtmp, Rtmp2);
2400 
2401   Address be_counter (Rcounters, MethodCounters::backedge_counter_offset() +
2402                                  InvocationCounter::counter_offset());
2403   Address inv_counter(Rcounters, MethodCounters::invocation_counter_offset() +
2404                                  InvocationCounter::counter_offset());
2405 
2406   int delta = InvocationCounter::count_increment;
2407   // Load each counter in a register
2408   ld( be_counter, Rtmp );
2409   ld( inv_counter, Rtmp2 );
2410 
2411   // Add the delta to the backedge counter
2412   add( Rtmp, delta, Rtmp );
2413 
2414   // Mask the invocation counter, add to backedge counter
2415   and3( Rtmp2, InvocationCounter::count_mask_value, Rtmp2 );
2416 
2417   // and store the result to memory
2418   st( Rtmp, be_counter );
2419 
2420   // Add backedge + invocation counter
2421   add( Rtmp, Rtmp2, Rtmp );
2422 
2423   // Note that this macro must leave backedge_count + invocation_count in Rtmp!
2424 }
2425 
2426 void InterpreterMacroAssembler::test_backedge_count_for_osr( Register backedge_count,
2427                                                              Register method_counters,
2428                                                              Register branch_bcp,
2429                                                              Register Rtmp ) {
2430   Label did_not_overflow;
2431   Label overflow_with_error;
2432   assert_different_registers(backedge_count, Rtmp, branch_bcp);
2433   assert(UseOnStackReplacement,&quot;Must UseOnStackReplacement to test_backedge_count_for_osr&quot;);
2434 
2435   Address limit(method_counters, in_bytes(MethodCounters::interpreter_backward_branch_limit_offset()));
2436   ld(limit, Rtmp);
2437   cmp_and_br_short(backedge_count, Rtmp, Assembler::lessUnsigned, Assembler::pt, did_not_overflow);
2438 
2439   // When ProfileInterpreter is on, the backedge_count comes from the
2440   // MethodData*, which value does not get reset on the call to
2441   // frequency_counter_overflow().  To avoid excessive calls to the overflow
2442   // routine while the method is being compiled, add a second test to make sure
2443   // the overflow function is called only once every overflow_frequency.
2444   if (ProfileInterpreter) {
2445     const int overflow_frequency = 1024;
2446     andcc(backedge_count, overflow_frequency-1, Rtmp);
2447     brx(Assembler::notZero, false, Assembler::pt, did_not_overflow);
2448     delayed()-&gt;nop();
2449   }
2450 
2451   // overflow in loop, pass branch bytecode
2452   set(6,Rtmp);
2453   call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::frequency_counter_overflow), branch_bcp, Rtmp);
2454 
2455   // Was an OSR adapter generated?
2456   // O0 = osr nmethod
2457   br_null_short(O0, Assembler::pn, overflow_with_error);
2458 
2459   // Has the nmethod been invalidated already?
2460   ldub(O0, nmethod::state_offset(), O2);
2461   cmp_and_br_short(O2, nmethod::in_use, Assembler::notEqual, Assembler::pn, overflow_with_error);
2462 
2463   // migrate the interpreter frame off of the stack
2464 
2465   mov(G2_thread, L7);
2466   // save nmethod
2467   mov(O0, L6);
2468   set_last_Java_frame(SP, noreg);
2469   call_VM_leaf(noreg, CAST_FROM_FN_PTR(address, SharedRuntime::OSR_migration_begin), L7);
2470   reset_last_Java_frame();
2471   mov(L7, G2_thread);
2472 
2473   // move OSR nmethod to I1
2474   mov(L6, I1);
2475 
2476   // OSR buffer to I0
2477   mov(O0, I0);
2478 
2479   // remove the interpreter frame
2480   restore(I5_savedSP, 0, SP);
2481 
2482   // Jump to the osr code.
2483   ld_ptr(O1, nmethod::osr_entry_point_offset(), O2);
2484   jmp(O2, G0);
2485   delayed()-&gt;nop();
2486 
2487   bind(overflow_with_error);
2488 
2489   bind(did_not_overflow);
2490 }
2491 
2492 
2493 
2494 void InterpreterMacroAssembler::interp_verify_oop(Register reg, TosState state, const char * file, int line) {
2495   if (state == atos) { MacroAssembler::_verify_oop(reg, &quot;broken oop &quot;, file, line); }
2496 }
2497 
2498 
2499 // local helper function for the verify_oop_or_return_address macro
2500 static bool verify_return_address(Method* m, int bci) {
2501 #ifndef PRODUCT
2502   address pc = (address)(m-&gt;constMethod())
2503              + in_bytes(ConstMethod::codes_offset()) + bci;
2504   // assume it is a valid return address if it is inside m and is preceded by a jsr
2505   if (!m-&gt;contains(pc))                                          return false;
2506   address jsr_pc;
2507   jsr_pc = pc - Bytecodes::length_for(Bytecodes::_jsr);
2508   if (*jsr_pc == Bytecodes::_jsr   &amp;&amp; jsr_pc &gt;= m-&gt;code_base())    return true;
2509   jsr_pc = pc - Bytecodes::length_for(Bytecodes::_jsr_w);
2510   if (*jsr_pc == Bytecodes::_jsr_w &amp;&amp; jsr_pc &gt;= m-&gt;code_base())    return true;
2511 #endif // PRODUCT
2512   return false;
2513 }
2514 
2515 
2516 void InterpreterMacroAssembler::verify_oop_or_return_address(Register reg, Register Rtmp) {
2517   if (!VerifyOops)  return;
2518   // the VM documentation for the astore[_wide] bytecode allows
2519   // the TOS to be not only an oop but also a return address
2520   Label test;
2521   Label skip;
2522   // See if it is an address (in the current method):
2523 
2524   mov(reg, Rtmp);
2525   const int log2_bytecode_size_limit = 16;
2526   srl(Rtmp, log2_bytecode_size_limit, Rtmp);
2527   br_notnull_short( Rtmp, pt, test );
2528 
2529   // %%% should use call_VM_leaf here?
2530   save_frame_and_mov(0, Lmethod, O0, reg, O1);
2531   save_thread(L7_thread_cache);
2532   call(CAST_FROM_FN_PTR(address,verify_return_address), relocInfo::none);
2533   delayed()-&gt;nop();
2534   restore_thread(L7_thread_cache);
2535   br_notnull( O0, false, pt, skip );
2536   delayed()-&gt;restore();
2537 
2538   // Perform a more elaborate out-of-line call
2539   // Not an address; verify it:
2540   bind(test);
2541   verify_oop(reg);
2542   bind(skip);
2543 }
2544 
2545 
2546 // Jump if ((*counter_addr += increment) &amp; mask) satisfies the condition.
2547 void InterpreterMacroAssembler::increment_mask_and_jump(Address counter_addr,
2548                                                         int increment, Address mask_addr,
2549                                                         Register scratch1, Register scratch2,
2550                                                         Condition cond, Label *where) {
2551   ld(counter_addr, scratch1);
2552   add(scratch1, increment, scratch1);
2553   ld(mask_addr, scratch2);
2554   andcc(scratch1, scratch2,  G0);
2555   br(cond, false, Assembler::pn, *where);
2556   delayed()-&gt;st(scratch1, counter_addr);
2557 }
2558 
2559 // Inline assembly for:
2560 //
2561 // if (thread is in interp_only_mode) {
2562 //   InterpreterRuntime::post_method_entry();
2563 // }
2564 // if (DTraceMethodProbes) {
2565 //   SharedRuntime::dtrace_method_entry(method, receiver);
2566 // }
2567 // if (RC_TRACE_IN_RANGE(0x00001000, 0x00002000)) {
2568 //   SharedRuntime::rc_trace_method_entry(method, receiver);
2569 // }
2570 
2571 void InterpreterMacroAssembler::notify_method_entry() {
2572 
2573   // Whenever JVMTI puts a thread in interp_only_mode, method
2574   // entry/exit events are sent for that thread to track stack
2575   // depth.  If it is possible to enter interp_only_mode we add
2576   // the code to check if the event should be sent.
2577   if (JvmtiExport::can_post_interpreter_events()) {
2578     Label L;
2579     Register temp_reg = O5;
2580     const Address interp_only(G2_thread, JavaThread::interp_only_mode_offset());
2581     ld(interp_only, temp_reg);
2582     cmp_and_br_short(temp_reg, 0, equal, pt, L);
2583     call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_entry));
2584     bind(L);
2585   }
2586 
2587   {
2588     Register temp_reg = O5;
2589     SkipIfEqual skip_if(this, temp_reg, &amp;DTraceMethodProbes, zero);
2590     call_VM_leaf(noreg,
2591       CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_entry),
2592       G2_thread, Lmethod);
2593   }
2594 
2595   // RedefineClasses() tracing support for obsolete method entry
2596   if (log_is_enabled(Trace, redefine, class, obsolete)) {
2597     call_VM_leaf(noreg,
2598       CAST_FROM_FN_PTR(address, SharedRuntime::rc_trace_method_entry),
2599       G2_thread, Lmethod);
2600   }
2601 }
2602 
2603 
2604 // Inline assembly for:
2605 //
2606 // if (thread is in interp_only_mode) {
2607 //   // save result
2608 //   InterpreterRuntime::post_method_exit();
2609 //   // restore result
2610 // }
2611 // if (DTraceMethodProbes) {
2612 //   SharedRuntime::dtrace_method_exit(thread, method);
2613 // }
2614 //
2615 // Native methods have their result stored in d_tmp and l_tmp
2616 // Java methods have their result stored in the expression stack
2617 
2618 void InterpreterMacroAssembler::notify_method_exit(bool is_native_method,
2619                                                    TosState state,
2620                                                    NotifyMethodExitMode mode) {
2621 
2622   // Whenever JVMTI puts a thread in interp_only_mode, method
2623   // entry/exit events are sent for that thread to track stack
2624   // depth.  If it is possible to enter interp_only_mode we add
2625   // the code to check if the event should be sent.
2626   if (mode == NotifyJVMTI &amp;&amp; JvmtiExport::can_post_interpreter_events()) {
2627     Label L;
2628     Register temp_reg = O5;
2629     const Address interp_only(G2_thread, JavaThread::interp_only_mode_offset());
2630     ld(interp_only, temp_reg);
2631     cmp_and_br_short(temp_reg, 0, equal, pt, L);
2632 
2633     // Note: frame::interpreter_frame_result has a dependency on how the
2634     // method result is saved across the call to post_method_exit. For
2635     // native methods it assumes the result registers are saved to
2636     // l_scratch and d_scratch. If this changes then the interpreter_frame_result
2637     // implementation will need to be updated too.
2638 
2639     save_return_value(state, is_native_method);
2640     call_VM(noreg,
2641             CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
2642     restore_return_value(state, is_native_method);
2643     bind(L);
2644   }
2645 
2646   {
2647     Register temp_reg = O5;
2648     // Dtrace notification
2649     SkipIfEqual skip_if(this, temp_reg, &amp;DTraceMethodProbes, zero);
2650     save_return_value(state, is_native_method);
2651     call_VM_leaf(
2652       noreg,
2653       CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit),
2654       G2_thread, Lmethod);
2655     restore_return_value(state, is_native_method);
2656   }
2657 }
2658 
2659 void InterpreterMacroAssembler::save_return_value(TosState state, bool is_native_call) {
2660   if (is_native_call) {
2661     stf(FloatRegisterImpl::D, F0, d_tmp);
2662     stx(O0, l_tmp);
2663   } else {
2664     push(state);
2665   }
2666 }
2667 
2668 void InterpreterMacroAssembler::restore_return_value( TosState state, bool is_native_call) {
2669   if (is_native_call) {
2670     ldf(FloatRegisterImpl::D, d_tmp, F0);
2671     ldx(l_tmp, O0);
2672   } else {
2673     pop(state);
2674   }
2675 }
    </pre>
  </body>
</html>