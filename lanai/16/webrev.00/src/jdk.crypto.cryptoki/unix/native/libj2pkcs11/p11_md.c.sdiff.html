<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/unix/native/libj2pkcs11/p11_md.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../../share/legal/pkcs11cryptotoken.md.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.crypto.ec/share/classes/sun/security/ec/ECDSAOperations.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/unix/native/libj2pkcs11/p11_md.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2014, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
 76  */
 77 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_connect
 78     (JNIEnv *env, jobject obj, jstring jPkcs11ModulePath, jstring jGetFunctionList)
 79 {
 80     void *hModule;
 81     char *error;
 82     CK_C_GetFunctionList C_GetFunctionList=NULL;
 83     CK_RV rv;
 84     ModuleData *moduleData;
 85     jobject globalPKCS11ImplementationReference;
 86     char *systemErrorMessage;
 87     char *exceptionMessage;
 88     const char *getFunctionListStr;
 89 
 90     const char *libraryNameStr = (*env)-&gt;GetStringUTFChars(env, jPkcs11ModulePath, 0);
 91     if (libraryNameStr == NULL) {
 92         return;
 93     }
 94     TRACE1(&quot;DEBUG: connect to PKCS#11 module: %s ... &quot;, libraryNameStr);
 95 
<span class="line-removed"> 96 </span>
 97     /*
 98      * Load the PKCS #11 DLL
 99      */
100     dlerror(); /* clear any old error message not fetched */
101 #ifdef DEBUG
102     hModule = dlopen(libraryNameStr, RTLD_NOW);
103 #else
104     hModule = dlopen(libraryNameStr, RTLD_LAZY);
105 #endif /* DEBUG */
106 
107     if (hModule == NULL) {
108         systemErrorMessage = dlerror();
109         exceptionMessage = (char *) malloc(sizeof(char) * (strlen(systemErrorMessage) + strlen(libraryNameStr) + 1));
110         if (exceptionMessage == NULL) {
111             throwOutOfMemoryError(env, 0);
112             (*env)-&gt;ReleaseStringUTFChars(env, jPkcs11ModulePath, libraryNameStr);
113             return;
114         }
115         strcpy(exceptionMessage, systemErrorMessage);
116         strcat(exceptionMessage, libraryNameStr);
117         throwIOException(env, exceptionMessage);
118         (*env)-&gt;ReleaseStringUTFChars(env, jPkcs11ModulePath, libraryNameStr);
119         free(exceptionMessage);
120         return;
121     }

122 
123     /*
124      * Get function pointer to C_GetFunctionList
125      */
126     dlerror(); /* clear any old error message not fetched */
127     // with the old JAR file jGetFunctionList is null, temporarily check for that
128     if (jGetFunctionList != NULL) {
129         getFunctionListStr = (*env)-&gt;GetStringUTFChars(env, jGetFunctionList, 0);
130         if (getFunctionListStr == NULL) {
131             return;
132         }
133         C_GetFunctionList = (CK_C_GetFunctionList) dlsym(hModule, getFunctionListStr);
134         (*env)-&gt;ReleaseStringUTFChars(env, jGetFunctionList, getFunctionListStr);
135     }
136     if (C_GetFunctionList == NULL) {
137         throwIOException(env, &quot;ERROR: C_GetFunctionList == NULL&quot;);
138         return;
139     } else if ( (systemErrorMessage = dlerror()) != NULL ){
140         throwIOException(env, systemErrorMessage);
141         return;
142     }
143 
144     /*
145      * Get function pointers to all PKCS #11 functions
146      */
147     moduleData = (ModuleData *) malloc(sizeof(ModuleData));
148     if (moduleData == NULL) {
149         dlclose(hModule);
150         throwOutOfMemoryError(env, 0);
151         return;
152     }
153     moduleData-&gt;hModule = hModule;
154     moduleData-&gt;applicationMutexHandler = NULL;
155     rv = (C_GetFunctionList)(&amp;(moduleData-&gt;ckFunctionListPtr));
156     globalPKCS11ImplementationReference = (*env)-&gt;NewGlobalRef(env, obj);
157     putModuleEntry(env, globalPKCS11ImplementationReference, moduleData);
158 
<span class="line-removed">159     (*env)-&gt;ReleaseStringUTFChars(env, jPkcs11ModulePath, libraryNameStr);</span>
160     TRACE0(&quot;FINISHED\n&quot;);
161 
162     if(ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
163 }
164 
165 /*
166  * Class:     sun_security_pkcs11_wrapper_PKCS11
167  * Method:    disconnect
168  * Signature: ()V
169  */
170 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_disconnect
171     (JNIEnv *env, jobject obj)
172 {
173     ModuleData *moduleData;
174     TRACE0(&quot;DEBUG: disconnecting module...&quot;);
175     moduleData = removeModuleEntry(env, obj);
176 
177     if (moduleData != NULL) {
178         dlclose(moduleData-&gt;hModule);
179     }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
 76  */
 77 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_connect
 78     (JNIEnv *env, jobject obj, jstring jPkcs11ModulePath, jstring jGetFunctionList)
 79 {
 80     void *hModule;
 81     char *error;
 82     CK_C_GetFunctionList C_GetFunctionList=NULL;
 83     CK_RV rv;
 84     ModuleData *moduleData;
 85     jobject globalPKCS11ImplementationReference;
 86     char *systemErrorMessage;
 87     char *exceptionMessage;
 88     const char *getFunctionListStr;
 89 
 90     const char *libraryNameStr = (*env)-&gt;GetStringUTFChars(env, jPkcs11ModulePath, 0);
 91     if (libraryNameStr == NULL) {
 92         return;
 93     }
 94     TRACE1(&quot;DEBUG: connect to PKCS#11 module: %s ... &quot;, libraryNameStr);
 95 

 96     /*
 97      * Load the PKCS #11 DLL
 98      */
 99     dlerror(); /* clear any old error message not fetched */
100 #ifdef DEBUG
101     hModule = dlopen(libraryNameStr, RTLD_NOW);
102 #else
103     hModule = dlopen(libraryNameStr, RTLD_LAZY);
104 #endif /* DEBUG */
105 
106     if (hModule == NULL) {
107         systemErrorMessage = dlerror();
108         exceptionMessage = (char *) malloc(sizeof(char) * (strlen(systemErrorMessage) + strlen(libraryNameStr) + 1));
109         if (exceptionMessage == NULL) {
110             throwOutOfMemoryError(env, 0);
111             (*env)-&gt;ReleaseStringUTFChars(env, jPkcs11ModulePath, libraryNameStr);
112             return;
113         }
114         strcpy(exceptionMessage, systemErrorMessage);
115         strcat(exceptionMessage, libraryNameStr);
116         throwIOException(env, exceptionMessage);
117         (*env)-&gt;ReleaseStringUTFChars(env, jPkcs11ModulePath, libraryNameStr);
118         free(exceptionMessage);
119         return;
120     }
<span class="line-added">121     (*env)-&gt;ReleaseStringUTFChars(env, jPkcs11ModulePath, libraryNameStr);</span>
122 
123     /*
124      * Get function pointer to C_GetFunctionList
125      */
126     dlerror(); /* clear any old error message not fetched */
127     // with the old JAR file jGetFunctionList is null, temporarily check for that
128     if (jGetFunctionList != NULL) {
129         getFunctionListStr = (*env)-&gt;GetStringUTFChars(env, jGetFunctionList, 0);
130         if (getFunctionListStr == NULL) {
131             return;
132         }
133         C_GetFunctionList = (CK_C_GetFunctionList) dlsym(hModule, getFunctionListStr);
134         (*env)-&gt;ReleaseStringUTFChars(env, jGetFunctionList, getFunctionListStr);
135     }
136     if (C_GetFunctionList == NULL) {
137         throwIOException(env, &quot;ERROR: C_GetFunctionList == NULL&quot;);
138         return;
139     } else if ( (systemErrorMessage = dlerror()) != NULL ){
140         throwIOException(env, systemErrorMessage);
141         return;
142     }
143 
144     /*
145      * Get function pointers to all PKCS #11 functions
146      */
147     moduleData = (ModuleData *) malloc(sizeof(ModuleData));
148     if (moduleData == NULL) {
149         dlclose(hModule);
150         throwOutOfMemoryError(env, 0);
151         return;
152     }
153     moduleData-&gt;hModule = hModule;
154     moduleData-&gt;applicationMutexHandler = NULL;
155     rv = (C_GetFunctionList)(&amp;(moduleData-&gt;ckFunctionListPtr));
156     globalPKCS11ImplementationReference = (*env)-&gt;NewGlobalRef(env, obj);
157     putModuleEntry(env, globalPKCS11ImplementationReference, moduleData);
158 

159     TRACE0(&quot;FINISHED\n&quot;);
160 
161     if(ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
162 }
163 
164 /*
165  * Class:     sun_security_pkcs11_wrapper_PKCS11
166  * Method:    disconnect
167  * Signature: ()V
168  */
169 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_disconnect
170     (JNIEnv *env, jobject obj)
171 {
172     ModuleData *moduleData;
173     TRACE0(&quot;DEBUG: disconnecting module...&quot;);
174     moduleData = removeModuleEntry(env, obj);
175 
176     if (moduleData != NULL) {
177         dlclose(moduleData-&gt;hModule);
178     }
</pre>
</td>
</tr>
</table>
<center><a href="../../../share/legal/pkcs11cryptotoken.md.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.crypto.ec/share/classes/sun/security/ec/ECDSAOperations.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>