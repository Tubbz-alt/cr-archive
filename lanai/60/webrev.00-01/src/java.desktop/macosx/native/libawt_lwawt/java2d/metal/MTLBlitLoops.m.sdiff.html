<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLBlitLoops.m</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLBlitLoops.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 41 
 42 #import &lt;Accelerate/Accelerate.h&gt;
 43 
 44 #ifdef DEBUG
 45 #define TRACE_ISOBLIT
 46 #define TRACE_BLIT
 47 #endif //DEBUG
 48 //#define DEBUG_ISOBLIT
 49 //#define DEBUG_BLIT
 50 
 51 typedef struct {
 52     MTLPixelFormat   format;
 53     jboolean hasAlpha;
 54     jboolean isPremult;
 55     const uint8_t * permuteMap;
 56 } MTLRasterFormatInfo;
 57 
 58 // 0 denotes the alpha channel, 1 the red channel, 2 the green channel, and 3 the blue channel.
 59 const uint8_t permuteMap_rgbx[4] = { 1, 2, 3, 0 };
 60 const uint8_t permuteMap_bgrx[4] = { 3, 2, 1, 0 };
<span class="line-removed"> 61 const uint8_t permuteMap_argb[4] = { 0, 1, 2, 3 };</span>
 62 
 63 static uint8_t revertPerm(const uint8_t * perm, uint8_t pos) {
 64     for (int c = 0; c &lt; 4; ++c) {
 65         if (perm[c] == pos)
 66             return c;
 67     }
 68     return -1;
 69 }
 70 
 71 #define uint2swizzle(channel) (channel == 0 ? MTLTextureSwizzleAlpha : (channel == 1 ? MTLTextureSwizzleRed : (channel == 2 ? MTLTextureSwizzleGreen : (channel == 3 ? MTLTextureSwizzleBlue : MTLTextureSwizzleZero))))
 72 
 73 /**
 74  * This table contains the &quot;pixel formats&quot; for all system memory surfaces
 75  * that Metal is capable of handling, indexed by the &quot;PF_&quot; constants defined
 76  * in MTLLSurfaceData.java.  These pixel formats contain information that is
 77  * passed to Metal when copying from a system memory (&quot;Sw&quot;) surface to
 78  * an Metal surface
 79  */
 80 MTLRasterFormatInfo RasterFormatInfos[] = {
 81         { MTLPixelFormatBGRA8Unorm, 1, 0, NULL }, /* 0 - IntArgb      */ // Argb (in java notation)
</pre>
<hr />
<pre>
230             destBuf.height = dh;
231             destBuf.width = dw;
232             destBuf.rowBytes = dw*4;
233             destBuf.data = buffer;
234 
235             vImagePermuteChannels_ARGB8888(&amp;srcBuf, &amp;destBuf, rfi-&gt;permuteMap, kvImageNoFlags);
236             raster = buffer;
237 
238             J2dTraceLn5(J2D_TRACE_VERBOSE, &quot;replaceTextureRegion [use conversion]: %d, %d, %d, %d, hasA=%d&quot;,
239                         rfi-&gt;permuteMap[0], rfi-&gt;permuteMap[1], rfi-&gt;permuteMap[2], rfi-&gt;permuteMap[3], rfi-&gt;hasAlpha);
240         }
241     }
242 
243     MTLRegion region = MTLRegionMake2D(dx1, dy1, dw, dh);
244     if (result != nil)
245         dest = result;
246 
247     @autoreleasepool {
248         id &lt;MTLBlitCommandEncoder&gt; blitEncoder = [mtlc.encoderManager createBlitEncoder];
249 
<span class="line-modified">250         J2dTraceLn4(J2D_TRACE_VERBOSE, &quot;replaceTextureRegion scr (dw, dh) : [%d, %d] dest (dx1, dy1) =[%d, %d]&quot;,</span>
251                     dw, dh, dx1, dy1);
252 
253         id &lt;MTLBuffer&gt; buff = [[mtlc.device newBufferWithBytes:raster length:srcInfo-&gt;scanStride * dh options:MTLResourceStorageModeManaged] autorelease];
254         [blitEncoder copyFromBuffer:buff
255                 sourceOffset:0 sourceBytesPerRow:srcInfo-&gt;scanStride sourceBytesPerImage:srcInfo-&gt;scanStride * dh sourceSize:MTLSizeMake(dw, dh, 1)
256                 toTexture:dest destinationSlice:0 destinationLevel:0 destinationOrigin:MTLOriginMake(dx1, dy1, 0)];
257         [blitEncoder endEncoding];
258     }
259 
260     return result;
261 }
262 
263 /**
264  * Inner loop used for copying a source system memory (&quot;Sw&quot;) surface to a
265  * destination MTL &quot;Surface&quot;.  This method is invoked from
266  * MTLBlitLoops_Blit().
267  */
268 
269 static void
270 MTLBlitSwToTextureViaPooledTexture(
</pre>
</td>
<td>
<hr />
<pre>
 41 
 42 #import &lt;Accelerate/Accelerate.h&gt;
 43 
 44 #ifdef DEBUG
 45 #define TRACE_ISOBLIT
 46 #define TRACE_BLIT
 47 #endif //DEBUG
 48 //#define DEBUG_ISOBLIT
 49 //#define DEBUG_BLIT
 50 
 51 typedef struct {
 52     MTLPixelFormat   format;
 53     jboolean hasAlpha;
 54     jboolean isPremult;
 55     const uint8_t * permuteMap;
 56 } MTLRasterFormatInfo;
 57 
 58 // 0 denotes the alpha channel, 1 the red channel, 2 the green channel, and 3 the blue channel.
 59 const uint8_t permuteMap_rgbx[4] = { 1, 2, 3, 0 };
 60 const uint8_t permuteMap_bgrx[4] = { 3, 2, 1, 0 };

 61 
 62 static uint8_t revertPerm(const uint8_t * perm, uint8_t pos) {
 63     for (int c = 0; c &lt; 4; ++c) {
 64         if (perm[c] == pos)
 65             return c;
 66     }
 67     return -1;
 68 }
 69 
 70 #define uint2swizzle(channel) (channel == 0 ? MTLTextureSwizzleAlpha : (channel == 1 ? MTLTextureSwizzleRed : (channel == 2 ? MTLTextureSwizzleGreen : (channel == 3 ? MTLTextureSwizzleBlue : MTLTextureSwizzleZero))))
 71 
 72 /**
 73  * This table contains the &quot;pixel formats&quot; for all system memory surfaces
 74  * that Metal is capable of handling, indexed by the &quot;PF_&quot; constants defined
 75  * in MTLLSurfaceData.java.  These pixel formats contain information that is
 76  * passed to Metal when copying from a system memory (&quot;Sw&quot;) surface to
 77  * an Metal surface
 78  */
 79 MTLRasterFormatInfo RasterFormatInfos[] = {
 80         { MTLPixelFormatBGRA8Unorm, 1, 0, NULL }, /* 0 - IntArgb      */ // Argb (in java notation)
</pre>
<hr />
<pre>
229             destBuf.height = dh;
230             destBuf.width = dw;
231             destBuf.rowBytes = dw*4;
232             destBuf.data = buffer;
233 
234             vImagePermuteChannels_ARGB8888(&amp;srcBuf, &amp;destBuf, rfi-&gt;permuteMap, kvImageNoFlags);
235             raster = buffer;
236 
237             J2dTraceLn5(J2D_TRACE_VERBOSE, &quot;replaceTextureRegion [use conversion]: %d, %d, %d, %d, hasA=%d&quot;,
238                         rfi-&gt;permuteMap[0], rfi-&gt;permuteMap[1], rfi-&gt;permuteMap[2], rfi-&gt;permuteMap[3], rfi-&gt;hasAlpha);
239         }
240     }
241 
242     MTLRegion region = MTLRegionMake2D(dx1, dy1, dw, dh);
243     if (result != nil)
244         dest = result;
245 
246     @autoreleasepool {
247         id &lt;MTLBlitCommandEncoder&gt; blitEncoder = [mtlc.encoderManager createBlitEncoder];
248 
<span class="line-modified">249         J2dTraceLn4(J2D_TRACE_VERBOSE, &quot;replaceTextureRegion src (dw, dh) : [%d, %d] dest (dx1, dy1) =[%d, %d]&quot;,</span>
250                     dw, dh, dx1, dy1);
251 
252         id &lt;MTLBuffer&gt; buff = [[mtlc.device newBufferWithBytes:raster length:srcInfo-&gt;scanStride * dh options:MTLResourceStorageModeManaged] autorelease];
253         [blitEncoder copyFromBuffer:buff
254                 sourceOffset:0 sourceBytesPerRow:srcInfo-&gt;scanStride sourceBytesPerImage:srcInfo-&gt;scanStride * dh sourceSize:MTLSizeMake(dw, dh, 1)
255                 toTexture:dest destinationSlice:0 destinationLevel:0 destinationOrigin:MTLOriginMake(dx1, dy1, 0)];
256         [blitEncoder endEncoding];
257     }
258 
259     return result;
260 }
261 
262 /**
263  * Inner loop used for copying a source system memory (&quot;Sw&quot;) surface to a
264  * destination MTL &quot;Surface&quot;.  This method is invoked from
265  * MTLBlitLoops_Blit().
266  */
267 
268 static void
269 MTLBlitSwToTextureViaPooledTexture(
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>