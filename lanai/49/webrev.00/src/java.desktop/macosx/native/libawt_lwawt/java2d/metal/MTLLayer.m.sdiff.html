<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLLayer.m</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="MTLLayer.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/java.desktop/macosx/native/libawt_lwawt/java2d/metal/MTLLayer.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #import &quot;MTLGraphicsConfig.h&quot;
 27 #import &quot;MTLLayer.h&quot;
 28 #import &quot;ThreadUtilities.h&quot;
 29 #import &quot;LWCToolkit.h&quot;
 30 #import &quot;MTLSurfaceData.h&quot;
 31 
 32 @implementation MTLLayer
 33 
 34 
 35 @synthesize javaLayer;
 36 @synthesize ctx;
 37 @synthesize bufferWidth;
 38 @synthesize bufferHeight;
 39 @synthesize buffer;
<span class="line-removed"> 40 @synthesize mtlDrawable;</span>
<span class="line-removed"> 41 @synthesize blitCommandBuf;</span>
 42 @synthesize topInset;
 43 @synthesize leftInset;

 44 
 45 - (id) initWithJavaLayer:(JNFWeakJObjectWrapper *)layer
 46 {
 47     AWT_ASSERT_APPKIT_THREAD;
 48     // Initialize ourselves
 49     self = [super init];
 50     if (self == nil) return self;
 51 
 52     self.javaLayer = layer;
 53 
 54     self.contentsGravity = kCAGravityTopLeft;
 55 
 56     //Disable CALayer&#39;s default animation
 57     NSMutableDictionary * actions = [[NSMutableDictionary alloc] initWithObjectsAndKeys:
 58                                     [NSNull null], @&quot;anchorPoint&quot;,
 59                                     [NSNull null], @&quot;bounds&quot;,
 60                                     [NSNull null], @&quot;contents&quot;,
 61                                     [NSNull null], @&quot;contentsScale&quot;,
 62                                     [NSNull null], @&quot;onOrderIn&quot;,
 63                                     [NSNull null], @&quot;onOrderOut&quot;,
 64                                     [NSNull null], @&quot;position&quot;,
 65                                     [NSNull null], @&quot;sublayers&quot;,
 66                                     nil];
 67     self.actions = actions;
 68     [actions release];
 69     self.topInset = 0;
 70     self.leftInset = 0;
 71     self.framebufferOnly = NO;

 72     return self;
 73 }
 74 
 75 - (void) blitTexture {







 76     @autoreleasepool {
<span class="line-modified"> 77         id &lt;MTLBlitCommandEncoder&gt; blitEncoder = [self.blitCommandBuf blitCommandEncoder];</span>















 78 
 79         [blitEncoder
 80                 copyFromTexture:self.buffer sourceSlice:0 sourceLevel:0
 81                 sourceOrigin:MTLOriginMake((jint)(self.leftInset*self.contentsScale), (jint)(self.topInset*self.contentsScale), 0)
 82                 sourceSize:MTLSizeMake(self.buffer.width, self.buffer.height, 1)
<span class="line-modified"> 83                 toTexture:self.mtlDrawable.texture destinationSlice:0 destinationLevel:0 destinationOrigin:MTLOriginMake(0, 0, 0)];</span>
 84         [blitEncoder endEncoding];
 85 
<span class="line-modified"> 86         [self.blitCommandBuf presentDrawable:self.mtlDrawable];</span>



 87 
<span class="line-modified"> 88         [self.blitCommandBuf commit];</span>
 89     }
 90 }
 91 
 92 - (void) dealloc {
 93     self.javaLayer = nil;
 94     [super dealloc];
 95 }
 96 
 97 - (void) blitCallback {
 98 
 99     JNIEnv *env = [ThreadUtilities getJNIEnv];
100     static JNF_CLASS_CACHE(jc_JavaLayer, &quot;sun/java2d/metal/MTLLayer&quot;);
101     static JNF_MEMBER_CACHE(jm_drawInMTLContext, jc_JavaLayer, &quot;drawInMTLContext&quot;, &quot;()V&quot;);
102 
103     jobject javaLayerLocalRef = [self.javaLayer jObjectWithEnv:env];
104     if ((*env)-&gt;IsSameObject(env, javaLayerLocalRef, NULL)) {
105         return;
106     }
107 
108     JNFCallVoidMethod(env, javaLayerLocalRef, jm_drawInMTLContext);
109     (*env)-&gt;DeleteLocalRef(env, javaLayerLocalRef);
110 }
111 
<span class="line-removed">112 - (void) initBlit {</span>
<span class="line-removed">113     if (self.ctx == NULL || self.javaLayer == NULL || self.buffer == nil || self.ctx.device == nil) {</span>
<span class="line-removed">114         J2dTraceLn4(J2D_TRACE_VERBOSE, &quot;MTLLayer.initBlit: uninitialized (mtlc=%p, javaLayer=%p, buffer=%p, devide=%p)&quot;, self.ctx, self.javaLayer, self.buffer, ctx.device);</span>
<span class="line-removed">115         return;</span>
<span class="line-removed">116     }</span>
<span class="line-removed">117 </span>
<span class="line-removed">118     if ((self.buffer.width == 0) || (self.buffer.height == 0)) {</span>
<span class="line-removed">119         J2dTraceLn(J2D_TRACE_VERBOSE, &quot;MTLLayer.initBlit: cannot create drawable of size 0&quot;);</span>
<span class="line-removed">120         return;</span>
<span class="line-removed">121     }</span>
<span class="line-removed">122     self.blitCommandBuf = [self.ctx createBlitCommandBuffer];</span>
<span class="line-removed">123     if (self.blitCommandBuf == nil) {</span>
<span class="line-removed">124         J2dTraceLn(J2D_TRACE_VERBOSE, &quot;MTLLayer.initBlit: nothing to do (commandBuf is null)&quot;);</span>
<span class="line-removed">125         return;</span>
<span class="line-removed">126     }</span>
<span class="line-removed">127 </span>
<span class="line-removed">128     self.mtlDrawable = [self nextDrawable];</span>
<span class="line-removed">129     if (self.mtlDrawable == nil) {</span>
<span class="line-removed">130         J2dTraceLn(J2D_TRACE_VERBOSE, &quot;MTLLayer.initBlit: nextDrawable is null)&quot;);</span>
<span class="line-removed">131         return;</span>
<span class="line-removed">132     }</span>
<span class="line-removed">133     J2dTraceLn6(J2D_TRACE_VERBOSE, &quot;MTLLayer.initBlit: src tex=%p (w=%d, h=%d), dst tex=%p (w=%d, h=%d)&quot;, self.buffer, self.buffer.width, self.buffer.height, self.mtlDrawable.texture, self.mtlDrawable.texture.width, self.mtlDrawable.texture.height);</span>
<span class="line-removed">134 }</span>
<span class="line-removed">135 </span>
136 - (void) display {
137     AWT_ASSERT_APPKIT_THREAD;
138     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;MTLLayer_display() called&quot;);
<span class="line-removed">139     [self initBlit];</span>
140     [self blitCallback];
141     [super display];
142 }
143 @end
144 
145 /*
146  * Class:     sun_java2d_metal_MTLLayer
147  * Method:    nativeCreateLayer
148  * Signature: ()J
149  */
150 JNIEXPORT jlong JNICALL
151 Java_sun_java2d_metal_MTLLayer_nativeCreateLayer
152 (JNIEnv *env, jobject obj)
153 {
154     __block MTLLayer *layer = nil;
155 
156 JNF_COCOA_ENTER(env);
157 
158     JNFWeakJObjectWrapper *javaLayer = [JNFWeakJObjectWrapper wrapperWithJObject:obj withEnv:env];
159 
</pre>
</td>
<td>
<hr />
<pre>
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #import &quot;MTLGraphicsConfig.h&quot;
 27 #import &quot;MTLLayer.h&quot;
 28 #import &quot;ThreadUtilities.h&quot;
 29 #import &quot;LWCToolkit.h&quot;
 30 #import &quot;MTLSurfaceData.h&quot;
 31 
 32 @implementation MTLLayer
 33 
 34 
 35 @synthesize javaLayer;
 36 @synthesize ctx;
 37 @synthesize bufferWidth;
 38 @synthesize bufferHeight;
 39 @synthesize buffer;


 40 @synthesize topInset;
 41 @synthesize leftInset;
<span class="line-added"> 42 @synthesize nextDrawableCount;</span>
 43 
 44 - (id) initWithJavaLayer:(JNFWeakJObjectWrapper *)layer
 45 {
 46     AWT_ASSERT_APPKIT_THREAD;
 47     // Initialize ourselves
 48     self = [super init];
 49     if (self == nil) return self;
 50 
 51     self.javaLayer = layer;
 52 
 53     self.contentsGravity = kCAGravityTopLeft;
 54 
 55     //Disable CALayer&#39;s default animation
 56     NSMutableDictionary * actions = [[NSMutableDictionary alloc] initWithObjectsAndKeys:
 57                                     [NSNull null], @&quot;anchorPoint&quot;,
 58                                     [NSNull null], @&quot;bounds&quot;,
 59                                     [NSNull null], @&quot;contents&quot;,
 60                                     [NSNull null], @&quot;contentsScale&quot;,
 61                                     [NSNull null], @&quot;onOrderIn&quot;,
 62                                     [NSNull null], @&quot;onOrderOut&quot;,
 63                                     [NSNull null], @&quot;position&quot;,
 64                                     [NSNull null], @&quot;sublayers&quot;,
 65                                     nil];
 66     self.actions = actions;
 67     [actions release];
 68     self.topInset = 0;
 69     self.leftInset = 0;
 70     self.framebufferOnly = NO;
<span class="line-added"> 71     self.nextDrawableCount = 0;</span>
 72     return self;
 73 }
 74 
 75 - (void) blitTexture {
<span class="line-added"> 76     if (self.ctx == NULL || self.javaLayer == NULL || self.buffer == nil || self.ctx.device == nil) {</span>
<span class="line-added"> 77         J2dTraceLn4(J2D_TRACE_VERBOSE, &quot;MTLLayer.blitTexture: uninitialized (mtlc=%p, javaLayer=%p, buffer=%p, devide=%p)&quot;, self.ctx, self.javaLayer, self.buffer, ctx.device);</span>
<span class="line-added"> 78         return;</span>
<span class="line-added"> 79     }</span>
<span class="line-added"> 80 </span>
<span class="line-added"> 81     if (self.nextDrawableCount != 0)</span>
<span class="line-added"> 82         return;</span>
 83     @autoreleasepool {
<span class="line-modified"> 84         if ((self.buffer.width == 0) || (self.buffer.height == 0)) {</span>
<span class="line-added"> 85             J2dTraceLn(J2D_TRACE_VERBOSE, &quot;MTLLayer.blitTexture: cannot create drawable of size 0&quot;);</span>
<span class="line-added"> 86             return;</span>
<span class="line-added"> 87         }</span>
<span class="line-added"> 88         id&lt;MTLCommandBuffer&gt; commandBuf = [self.ctx createBlitCommandBuffer];</span>
<span class="line-added"> 89         if (commandBuf == nil) {</span>
<span class="line-added"> 90             J2dTraceLn(J2D_TRACE_VERBOSE, &quot;MTLLayer.blitTexture: commandBuf is null&quot;);</span>
<span class="line-added"> 91             return;</span>
<span class="line-added"> 92         }</span>
<span class="line-added"> 93         id&lt;CAMetalDrawable&gt; mtlDrawable = [self nextDrawable];</span>
<span class="line-added"> 94         if (mtlDrawable == nil) {</span>
<span class="line-added"> 95             J2dTraceLn(J2D_TRACE_VERBOSE, &quot;MTLLayer.blitTexture: nextDrawable is null)&quot;);</span>
<span class="line-added"> 96             return;</span>
<span class="line-added"> 97         }</span>
<span class="line-added"> 98         self.nextDrawableCount++;</span>
<span class="line-added"> 99         id &lt;MTLBlitCommandEncoder&gt; blitEncoder = [commandBuf blitCommandEncoder];</span>
100 
101         [blitEncoder
102                 copyFromTexture:self.buffer sourceSlice:0 sourceLevel:0
103                 sourceOrigin:MTLOriginMake((jint)(self.leftInset*self.contentsScale), (jint)(self.topInset*self.contentsScale), 0)
104                 sourceSize:MTLSizeMake(self.buffer.width, self.buffer.height, 1)
<span class="line-modified">105                 toTexture:mtlDrawable.texture destinationSlice:0 destinationLevel:0 destinationOrigin:MTLOriginMake(0, 0, 0)];</span>
106         [blitEncoder endEncoding];
107 
<span class="line-modified">108         [commandBuf presentDrawable:mtlDrawable];</span>
<span class="line-added">109         [commandBuf addCompletedHandler:^(id &lt;MTLCommandBuffer&gt; commandBuf) {</span>
<span class="line-added">110             self.nextDrawableCount--;</span>
<span class="line-added">111         }];</span>
112 
<span class="line-modified">113         [commandBuf commit];</span>
114     }
115 }
116 
117 - (void) dealloc {
118     self.javaLayer = nil;
119     [super dealloc];
120 }
121 
122 - (void) blitCallback {
123 
124     JNIEnv *env = [ThreadUtilities getJNIEnv];
125     static JNF_CLASS_CACHE(jc_JavaLayer, &quot;sun/java2d/metal/MTLLayer&quot;);
126     static JNF_MEMBER_CACHE(jm_drawInMTLContext, jc_JavaLayer, &quot;drawInMTLContext&quot;, &quot;()V&quot;);
127 
128     jobject javaLayerLocalRef = [self.javaLayer jObjectWithEnv:env];
129     if ((*env)-&gt;IsSameObject(env, javaLayerLocalRef, NULL)) {
130         return;
131     }
132 
133     JNFCallVoidMethod(env, javaLayerLocalRef, jm_drawInMTLContext);
134     (*env)-&gt;DeleteLocalRef(env, javaLayerLocalRef);
135 }
136 
























137 - (void) display {
138     AWT_ASSERT_APPKIT_THREAD;
139     J2dTraceLn(J2D_TRACE_VERBOSE, &quot;MTLLayer_display() called&quot;);

140     [self blitCallback];
141     [super display];
142 }
143 @end
144 
145 /*
146  * Class:     sun_java2d_metal_MTLLayer
147  * Method:    nativeCreateLayer
148  * Signature: ()J
149  */
150 JNIEXPORT jlong JNICALL
151 Java_sun_java2d_metal_MTLLayer_nativeCreateLayer
152 (JNIEnv *env, jobject obj)
153 {
154     __block MTLLayer *layer = nil;
155 
156 JNF_COCOA_ENTER(env);
157 
158     JNFWeakJObjectWrapper *javaLayer = [JNFWeakJObjectWrapper wrapperWithJObject:obj withEnv:env];
159 
</pre>
</td>
</tr>
</table>
<center><a href="MTLLayer.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>