<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/classes/com/sun/tdk/jcov/runtime/Collect.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../RepGen.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CollectDetect.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/classes/com/sun/tdk/jcov/runtime/Collect.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2014, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2014, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 22,12 ***</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package com.sun.tdk.jcov.runtime;
  
  /**
<span class="line-modified">!  * &lt;p&gt; Strores all runtime coverage information. Coverage information is stored</span>
   * in array of longs (counts[MAX_SLOTS]). &lt;/p&gt; &lt;p&gt; Here should be no imports!
   * Collect should be usable in the earliest VM lifecycle - eg in String class
   * loading. &lt;/p&gt; &lt;p&gt; slots count can be optimized at instrumentation time
   * by generation Collect class exactly for instrumented data. For agent it&#39;s
   * possible to use increasing array (see newSlot()). &lt;/p&gt;
<span class="line-new-header">--- 22,14 ---</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package com.sun.tdk.jcov.runtime;
  
<span class="line-added">+ import java.util.Objects;</span>
<span class="line-added">+ </span>
  /**
<span class="line-modified">!  * &lt;p&gt; Stores all runtime coverage information. Coverage information is stored</span>
   * in array of longs (counts[MAX_SLOTS]). &lt;/p&gt; &lt;p&gt; Here should be no imports!
   * Collect should be usable in the earliest VM lifecycle - eg in String class
   * loading. &lt;/p&gt; &lt;p&gt; slots count can be optimized at instrumentation time
   * by generation Collect class exactly for instrumented data. For agent it&#39;s
   * possible to use increasing array (see newSlot()). &lt;/p&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 40,26 ***</span>
      // coverage data
      public static final int MAX_SLOTS = 2000000;
      public static int SLOTS = MAX_SLOTS;
      private static final int MAX_SAVERS = 10;
      private static int nextSlot = 0;
<span class="line-modified">!     private static long counts[];</span>
<span class="line-modified">!     private static long counts_[];</span>
      // -- coverage data
      // savers
      private static JCovSaver[] savers = new JCovSaver[MAX_SAVERS];
      private static int nextSaver = 0;
<span class="line-modified">!     private static Class extension = null;</span>
      // This constant is replaced in ANT build script (see files se.replace.properties, me.replace.properties and so on)
      private final static String saverClassnameString = &quot;/*@BUILD_MODIFIED_SAVER_STRING@*/&quot;;
      // -- savers
      // saving state
      public static boolean enabled = false;
<span class="line-modified">!     public static boolean saveEnabled = true;</span>
<span class="line-modified">!     public static boolean saveAtShutdownEnabled = true;</span>
<span class="line-modified">!     public static boolean isInitialized = false;</span>
<span class="line-modified">!     public static boolean isInternal = false;</span>
      // -- saving state
  
      /**
       * &lt;p&gt; Reserves a new slot for coverage item. &lt;/p&gt;
       *
<span class="line-new-header">--- 42,26 ---</span>
      // coverage data
      public static final int MAX_SLOTS = 2000000;
      public static int SLOTS = MAX_SLOTS;
      private static final int MAX_SAVERS = 10;
      private static int nextSlot = 0;
<span class="line-modified">!     private static long[] counts;</span>
<span class="line-modified">!     private static long[] counts_;</span>
      // -- coverage data
      // savers
      private static JCovSaver[] savers = new JCovSaver[MAX_SAVERS];
      private static int nextSaver = 0;
<span class="line-modified">!     private static Class&lt;SaverDecorator&gt; extension = null;</span>
      // This constant is replaced in ANT build script (see files se.replace.properties, me.replace.properties and so on)
      private final static String saverClassnameString = &quot;/*@BUILD_MODIFIED_SAVER_STRING@*/&quot;;
      // -- savers
      // saving state
      public static boolean enabled = false;
<span class="line-modified">!     static boolean saveEnabled = true;</span>
<span class="line-modified">!     static boolean saveAtShutdownEnabled = true;</span>
<span class="line-modified">!     static boolean isInitialized = false;</span>
<span class="line-modified">!     static boolean isInternal = false;</span>
      // -- saving state
  
      /**
       * &lt;p&gt; Reserves a new slot for coverage item. &lt;/p&gt;
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 229,19 ***</span>
                      break;
                  }
              }
              for (int j = 0; j &lt; i; j++) {
                  try {
<span class="line-modified">!                     instantiateSaver(saver[j]).saveResults();</span>
                  } catch (Throwable t) {
                      t.printStackTrace();
                  }
              }
          } else {
              for (int i = 0; i &lt; nextSaver; i++) {
                  try {
<span class="line-modified">!                     savers[i].saveResults();</span>
                  } catch (Throwable t) {
                      t.printStackTrace();
                  }
              }
          }
<span class="line-new-header">--- 231,20 ---</span>
                      break;
                  }
              }
              for (int j = 0; j &lt; i; j++) {
                  try {
<span class="line-modified">!                     Objects.requireNonNull(instantiateSaver(saver[j])).saveResults();</span>
                  } catch (Throwable t) {
                      t.printStackTrace();
                  }
              }
          } else {
              for (int i = 0; i &lt; nextSaver; i++) {
                  try {
<span class="line-modified">!                     if (savers[i] != null)</span>
<span class="line-added">+                         savers[i].saveResults();</span>
                  } catch (Throwable t) {
                      t.printStackTrace();
                  }
              }
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 250,22 ***</span>
      }
  
      /**
       * &lt;p&gt; Loads satellite class if it&#39;s not loaded. &lt;/p&gt;
       */
<span class="line-modified">!     public static void loadSaverExtension() {</span>
          if (extension != null) {
              return;
          }
  
          String m = PropertyFinder.findValue(&quot;extension&quot;, null);
          if (m != null) {
              if (m.equals(&quot;javatest&quot;) || m.equals(&quot;jt&quot;) || m.equals(&quot;jtreg&quot;)) {
                  m = &quot;com.sun.tdk.jcov.runtime.NetworkSatelliteDecorator&quot;;
              }
              try {
<span class="line-modified">!                 extension = Class.forName(m);</span>
              } catch (Throwable t) {
                  t.printStackTrace();
              }
          }
      }
<span class="line-new-header">--- 253,22 ---</span>
      }
  
      /**
       * &lt;p&gt; Loads satellite class if it&#39;s not loaded. &lt;/p&gt;
       */
<span class="line-modified">!     private static void loadSaverExtension() {</span>
          if (extension != null) {
              return;
          }
  
          String m = PropertyFinder.findValue(&quot;extension&quot;, null);
          if (m != null) {
              if (m.equals(&quot;javatest&quot;) || m.equals(&quot;jt&quot;) || m.equals(&quot;jtreg&quot;)) {
                  m = &quot;com.sun.tdk.jcov.runtime.NetworkSatelliteDecorator&quot;;
              }
              try {
<span class="line-modified">!                 extension = (Class&lt;SaverDecorator&gt;) Class.forName(m);</span>
              } catch (Throwable t) {
                  t.printStackTrace();
              }
          }
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 275,23 ***</span>
       * instance if any. &lt;/p&gt;
       *
       * @param name Saver to create
       * @return Created Saver
       */
<span class="line-modified">!     public static JCovSaver instantiateSaver(String name) {</span>
          try {
<span class="line-modified">!             return decorateSaver((JCovSaver) Class.forName(name).newInstance());</span>
          } catch (Throwable t) {
              t.printStackTrace();
          }
          return null;
      }
  
      public static JCovSaver decorateSaver(JCovSaver saver) {
          if (extension != null) {
              try {
<span class="line-modified">!                 SaverDecorator s = (SaverDecorator) extension.newInstance();</span>
                  s.init(saver);
                  return s;
              } catch (Throwable t) {
                  t.printStackTrace();
              }
<span class="line-new-header">--- 278,23 ---</span>
       * instance if any. &lt;/p&gt;
       *
       * @param name Saver to create
       * @return Created Saver
       */
<span class="line-modified">!     private static JCovSaver instantiateSaver(String name) {</span>
          try {
<span class="line-modified">!             return decorateSaver((JCovSaver) Class.forName(name).getDeclaredConstructor().newInstance());</span>
          } catch (Throwable t) {
              t.printStackTrace();
          }
          return null;
      }
  
      public static JCovSaver decorateSaver(JCovSaver saver) {
          if (extension != null) {
              try {
<span class="line-modified">!                 SaverDecorator s = extension.getDeclaredConstructor().newInstance();</span>
                  s.init(saver);
                  return s;
              } catch (Throwable t) {
                  t.printStackTrace();
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 310,19 ***</span>
              if (PropertyFinder.isVMReady()) {
                  loadSaverExtension();
                  if (!saverClassnameString.startsWith(&quot;/*@&quot;)) {
                      addSaver(instantiateSaver(saverClassnameString));
                      PropertyFinder.addAutoShutdownSave();
<span class="line-removed">-                     isInitialized = true;</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     isInitialized = true;</span>
                  }
              }
              isInternal = false;
          }
      }
  
      static {
<span class="line-modified">!         enableCounts();</span>
<span class="line-modified">!         init();</span>
      }
  }
<span class="line-new-header">--- 313,17 ---</span>
              if (PropertyFinder.isVMReady()) {
                  loadSaverExtension();
                  if (!saverClassnameString.startsWith(&quot;/*@&quot;)) {
                      addSaver(instantiateSaver(saverClassnameString));
                      PropertyFinder.addAutoShutdownSave();
                  }
<span class="line-added">+                 isInitialized = true;</span>
              }
              isInternal = false;
          }
      }
  
      static {
<span class="line-modified">!         Collect.enableCounts();</span>
<span class="line-modified">!         Collect.init();</span>
      }
  }
</pre>
<center><a href="../RepGen.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CollectDetect.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>