<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/classes/com/sun/tdk/jcov/runtime/Collect.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../RepGen.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CollectDetect.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/classes/com/sun/tdk/jcov/runtime/Collect.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2014, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2014, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,12 +22,14 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package com.sun.tdk.jcov.runtime;
  
<span class="udiff-line-added">+ import java.util.Objects;</span>
<span class="udiff-line-added">+ </span>
  /**
<span class="udiff-line-modified-removed">-  * &lt;p&gt; Strores all runtime coverage information. Coverage information is stored</span>
<span class="udiff-line-modified-added">+  * &lt;p&gt; Stores all runtime coverage information. Coverage information is stored</span>
   * in array of longs (counts[MAX_SLOTS]). &lt;/p&gt; &lt;p&gt; Here should be no imports!
   * Collect should be usable in the earliest VM lifecycle - eg in String class
   * loading. &lt;/p&gt; &lt;p&gt; slots count can be optimized at instrumentation time
   * by generation Collect class exactly for instrumented data. For agent it&#39;s
   * possible to use increasing array (see newSlot()). &lt;/p&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -40,26 +42,26 @@</span>
      // coverage data
      public static final int MAX_SLOTS = 2000000;
      public static int SLOTS = MAX_SLOTS;
      private static final int MAX_SAVERS = 10;
      private static int nextSlot = 0;
<span class="udiff-line-modified-removed">-     private static long counts[];</span>
<span class="udiff-line-modified-removed">-     private static long counts_[];</span>
<span class="udiff-line-modified-added">+     private static long[] counts;</span>
<span class="udiff-line-modified-added">+     private static long[] counts_;</span>
      // -- coverage data
      // savers
      private static JCovSaver[] savers = new JCovSaver[MAX_SAVERS];
      private static int nextSaver = 0;
<span class="udiff-line-modified-removed">-     private static Class extension = null;</span>
<span class="udiff-line-modified-added">+     private static Class&lt;SaverDecorator&gt; extension = null;</span>
      // This constant is replaced in ANT build script (see files se.replace.properties, me.replace.properties and so on)
      private final static String saverClassnameString = &quot;/*@BUILD_MODIFIED_SAVER_STRING@*/&quot;;
      // -- savers
      // saving state
      public static boolean enabled = false;
<span class="udiff-line-modified-removed">-     public static boolean saveEnabled = true;</span>
<span class="udiff-line-modified-removed">-     public static boolean saveAtShutdownEnabled = true;</span>
<span class="udiff-line-modified-removed">-     public static boolean isInitialized = false;</span>
<span class="udiff-line-modified-removed">-     public static boolean isInternal = false;</span>
<span class="udiff-line-modified-added">+     static boolean saveEnabled = true;</span>
<span class="udiff-line-modified-added">+     static boolean saveAtShutdownEnabled = true;</span>
<span class="udiff-line-modified-added">+     static boolean isInitialized = false;</span>
<span class="udiff-line-modified-added">+     static boolean isInternal = false;</span>
      // -- saving state
  
      /**
       * &lt;p&gt; Reserves a new slot for coverage item. &lt;/p&gt;
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -229,19 +231,20 @@</span>
                      break;
                  }
              }
              for (int j = 0; j &lt; i; j++) {
                  try {
<span class="udiff-line-modified-removed">-                     instantiateSaver(saver[j]).saveResults();</span>
<span class="udiff-line-modified-added">+                     Objects.requireNonNull(instantiateSaver(saver[j])).saveResults();</span>
                  } catch (Throwable t) {
                      t.printStackTrace();
                  }
              }
          } else {
              for (int i = 0; i &lt; nextSaver; i++) {
                  try {
<span class="udiff-line-modified-removed">-                     savers[i].saveResults();</span>
<span class="udiff-line-modified-added">+                     if (savers[i] != null)</span>
<span class="udiff-line-added">+                         savers[i].saveResults();</span>
                  } catch (Throwable t) {
                      t.printStackTrace();
                  }
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -250,22 +253,22 @@</span>
      }
  
      /**
       * &lt;p&gt; Loads satellite class if it&#39;s not loaded. &lt;/p&gt;
       */
<span class="udiff-line-modified-removed">-     public static void loadSaverExtension() {</span>
<span class="udiff-line-modified-added">+     private static void loadSaverExtension() {</span>
          if (extension != null) {
              return;
          }
  
          String m = PropertyFinder.findValue(&quot;extension&quot;, null);
          if (m != null) {
              if (m.equals(&quot;javatest&quot;) || m.equals(&quot;jt&quot;) || m.equals(&quot;jtreg&quot;)) {
                  m = &quot;com.sun.tdk.jcov.runtime.NetworkSatelliteDecorator&quot;;
              }
              try {
<span class="udiff-line-modified-removed">-                 extension = Class.forName(m);</span>
<span class="udiff-line-modified-added">+                 extension = (Class&lt;SaverDecorator&gt;) Class.forName(m);</span>
              } catch (Throwable t) {
                  t.printStackTrace();
              }
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -275,23 +278,23 @@</span>
       * instance if any. &lt;/p&gt;
       *
       * @param name Saver to create
       * @return Created Saver
       */
<span class="udiff-line-modified-removed">-     public static JCovSaver instantiateSaver(String name) {</span>
<span class="udiff-line-modified-added">+     private static JCovSaver instantiateSaver(String name) {</span>
          try {
<span class="udiff-line-modified-removed">-             return decorateSaver((JCovSaver) Class.forName(name).newInstance());</span>
<span class="udiff-line-modified-added">+             return decorateSaver((JCovSaver) Class.forName(name).getDeclaredConstructor().newInstance());</span>
          } catch (Throwable t) {
              t.printStackTrace();
          }
          return null;
      }
  
      public static JCovSaver decorateSaver(JCovSaver saver) {
          if (extension != null) {
              try {
<span class="udiff-line-modified-removed">-                 SaverDecorator s = (SaverDecorator) extension.newInstance();</span>
<span class="udiff-line-modified-added">+                 SaverDecorator s = extension.getDeclaredConstructor().newInstance();</span>
                  s.init(saver);
                  return s;
              } catch (Throwable t) {
                  t.printStackTrace();
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -310,19 +313,17 @@</span>
              if (PropertyFinder.isVMReady()) {
                  loadSaverExtension();
                  if (!saverClassnameString.startsWith(&quot;/*@&quot;)) {
                      addSaver(instantiateSaver(saverClassnameString));
                      PropertyFinder.addAutoShutdownSave();
<span class="udiff-line-removed">-                     isInitialized = true;</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     isInitialized = true;</span>
                  }
<span class="udiff-line-added">+                 isInitialized = true;</span>
              }
              isInternal = false;
          }
      }
  
      static {
<span class="udiff-line-modified-removed">-         enableCounts();</span>
<span class="udiff-line-modified-removed">-         init();</span>
<span class="udiff-line-modified-added">+         Collect.enableCounts();</span>
<span class="udiff-line-modified-added">+         Collect.init();</span>
      }
  }
</pre>
<center><a href="../RepGen.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CollectDetect.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>