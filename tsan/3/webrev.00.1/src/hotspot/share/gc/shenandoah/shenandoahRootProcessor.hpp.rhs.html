<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/shenandoah/shenandoahRootProcessor.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, 2020, Red Hat, Inc. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #ifndef SHARE_GC_SHENANDOAH_SHENANDOAHROOTPROCESSOR_HPP
 26 #define SHARE_GC_SHENANDOAH_SHENANDOAHROOTPROCESSOR_HPP
 27 
 28 #include &quot;code/codeCache.hpp&quot;
 29 #include &quot;gc/shared/oopStorageParState.hpp&quot;
 30 #include &quot;gc/shenandoah/shenandoahCodeRoots.hpp&quot;
 31 #include &quot;gc/shenandoah/shenandoahHeap.hpp&quot;
 32 #include &quot;gc/shenandoah/shenandoahPhaseTimings.hpp&quot;
 33 #include &quot;gc/shenandoah/shenandoahSharedVariables.hpp&quot;
 34 #include &quot;memory/iterator.hpp&quot;
 35 
 36 class ShenandoahSerialRoot {
 37 public:
 38   typedef void (*OopsDo)(OopClosure*);
 39 private:
 40   ShenandoahSharedFlag                      _claimed;
 41   const OopsDo                              _oops_do;
 42   const ShenandoahPhaseTimings::GCParPhases _phase;
 43 
 44 public:
 45   ShenandoahSerialRoot(OopsDo oops_do, ShenandoahPhaseTimings::GCParPhases);
 46   void oops_do(OopClosure* cl, uint worker_id);
 47 };
 48 
 49 class ShenandoahSerialRoots {
 50 private:
 51   ShenandoahSerialRoot  _universe_root;
 52   ShenandoahSerialRoot  _object_synchronizer_root;
 53   ShenandoahSerialRoot  _management_root;
 54   ShenandoahSerialRoot  _system_dictionary_root;
 55   ShenandoahSerialRoot  _jvmti_root;
 56 public:
 57   ShenandoahSerialRoots();
 58   void oops_do(OopClosure* cl, uint worker_id);
 59 };
 60 
 61 class ShenandoahWeakSerialRoot {
 62   typedef void (*WeakOopsDo)(BoolObjectClosure*, OopClosure*);
 63 private:
 64   ShenandoahSharedFlag                      _claimed;
 65   const WeakOopsDo                          _weak_oops_do;
 66   const ShenandoahPhaseTimings::GCParPhases _phase;
 67 
 68 public:
 69   ShenandoahWeakSerialRoot(WeakOopsDo oops_do, ShenandoahPhaseTimings::GCParPhases);
 70   void weak_oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id);
 71 };
 72 
 73 #if INCLUDE_JVMTI
 74 class ShenandoahJVMTIWeakRoot : public ShenandoahWeakSerialRoot {
 75 public:
 76   ShenandoahJVMTIWeakRoot();
 77 };
 78 #endif // INCLUDE_JVMTI
 79 
 80 #if INCLUDE_JFR
 81 class ShenandoahJFRWeakRoot : public ShenandoahWeakSerialRoot {
 82 public:
 83   ShenandoahJFRWeakRoot();
 84 };
 85 #endif // INCLUDE_JFR
 86 
<a name="1" id="anc1"></a><span class="line-added"> 87 #if INCLUDE_TSAN</span>
<span class="line-added"> 88 class ShenandoahTSANWeakRoot : public ShenandoahWeakSerialRoot {</span>
<span class="line-added"> 89 public:</span>
<span class="line-added"> 90   ShenandoahTSANWeakRoot();</span>
<span class="line-added"> 91 };</span>
<span class="line-added"> 92 #endif // INCLUDE_TSAN</span>
<span class="line-added"> 93 </span>
 94 class ShenandoahSerialWeakRoots {
 95 private:
 96   JVMTI_ONLY(ShenandoahJVMTIWeakRoot _jvmti_weak_roots;)
 97   JFR_ONLY(ShenandoahJFRWeakRoot     _jfr_weak_roots;)
<a name="2" id="anc2"></a><span class="line-added"> 98   TSAN_ONLY(ShenandoahTSANWeakRoot   _tsan_weak_roots;)</span>
 99 public:
100   void weak_oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id);
101   void weak_oops_do(OopClosure* cl, uint worker_id);
102 };
103 
104 template &lt;bool CONCURRENT&gt;
105 class ShenandoahVMRoot {
106 private:
107   OopStorage::ParState&lt;CONCURRENT, false /* is_const */&gt; _itr;
108   const ShenandoahPhaseTimings::GCParPhases _phase;
109 public:
110   ShenandoahVMRoot(OopStorage* storage, ShenandoahPhaseTimings::GCParPhases phase);
111 
112   template &lt;typename Closure&gt;
113   void oops_do(Closure* cl, uint worker_id);
114 };
115 
116 template &lt;bool CONCURRENT&gt;
117 class ShenandoahWeakRoot : public ShenandoahVMRoot&lt;CONCURRENT&gt; {
118 public:
119   ShenandoahWeakRoot(OopStorage* storage, ShenandoahPhaseTimings::GCParPhases phase);
120 };
121 
122 template &lt;&gt;
123 class ShenandoahWeakRoot&lt;false /*concurrent*/&gt; {
124 private:
125   OopStorage::ParState&lt;false /*concurrent*/, false /*is_const*/&gt; _itr;
126   const ShenandoahPhaseTimings::GCParPhases _phase;
127 
128 public:
129   ShenandoahWeakRoot(OopStorage* storage, ShenandoahPhaseTimings::GCParPhases phase);
130 
131   template &lt;typename IsAliveClosure, typename KeepAliveClosure&gt;
132   void weak_oops_do(IsAliveClosure* is_alive, KeepAliveClosure* keep_alive, uint worker_id);
133 };
134 
135 template &lt;bool CONCURRENT&gt;
136 class ShenandoahWeakRoots {
137 private:
138   ShenandoahWeakRoot&lt;CONCURRENT&gt;  _jni_roots;
139   ShenandoahWeakRoot&lt;CONCURRENT&gt;  _string_table_roots;
140   ShenandoahWeakRoot&lt;CONCURRENT&gt;  _resolved_method_table_roots;
141   ShenandoahWeakRoot&lt;CONCURRENT&gt;  _vm_roots;
142 
143 public:
144   ShenandoahWeakRoots();
145 
146   template &lt;typename Closure&gt;
147   void oops_do(Closure* cl, uint worker_id = 0);
148 };
149 
150 template &lt;&gt;
151 class ShenandoahWeakRoots&lt;false /*concurrent */&gt; {
152 private:
153   ShenandoahWeakRoot&lt;false /*concurrent*/&gt;  _jni_roots;
154   ShenandoahWeakRoot&lt;false /*concurrent*/&gt;  _string_table_roots;
155   ShenandoahWeakRoot&lt;false /*concurrent*/&gt;  _resolved_method_table_roots;
156   ShenandoahWeakRoot&lt;false /*concurrent*/&gt;  _vm_roots;
157 public:
158   ShenandoahWeakRoots();
159 
160   template &lt;typename Closure&gt;
161   void oops_do(Closure* cl, uint worker_id = 0);
162 
163   template &lt;typename IsAliveClosure, typename KeepAliveClosure&gt;
164   void weak_oops_do(IsAliveClosure* is_alive, KeepAliveClosure* keep_alive, uint worker_id);
165 };
166 
167 template &lt;bool CONCURRENT&gt;
168 class ShenandoahVMRoots {
169 private:
170   ShenandoahVMRoot&lt;CONCURRENT&gt;    _jni_handle_roots;
171   ShenandoahVMRoot&lt;CONCURRENT&gt;    _vm_global_roots;
172 
173 public:
174   ShenandoahVMRoots();
175 
176   template &lt;typename T&gt;
177   void oops_do(T* cl, uint worker_id = 0);
178 };
179 
180 class ShenandoahThreadRoots {
181 private:
182   const bool _is_par;
183 public:
184   ShenandoahThreadRoots(bool is_par);
185   ~ShenandoahThreadRoots();
186 
187   void oops_do(OopClosure* oops_cl, CodeBlobClosure* code_cl, uint worker_id);
188   void threads_do(ThreadClosure* tc, uint worker_id);
189 };
190 
191 class ShenandoahStringDedupRoots {
192 public:
193   ShenandoahStringDedupRoots();
194   ~ShenandoahStringDedupRoots();
195 
196   void oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id);
197 };
198 
199 class ShenandoahConcurrentStringDedupRoots {
200 public:
201   ShenandoahConcurrentStringDedupRoots();
202   ~ShenandoahConcurrentStringDedupRoots();
203 
204   void oops_do(BoolObjectClosure* is_alive, OopClosure* keep_alive, uint worker_id);
205 };
206 
207 template &lt;typename ITR&gt;
208 class ShenandoahCodeCacheRoots {
209 private:
210   ITR _coderoots_iterator;
211 public:
212   ShenandoahCodeCacheRoots();
213   ~ShenandoahCodeCacheRoots();
214 
215   void code_blobs_do(CodeBlobClosure* blob_cl, uint worker_id);
216 };
217 
218 template &lt;bool CONCURRENT, bool SINGLE_THREADED&gt;
219 class ShenandoahClassLoaderDataRoots {
220 public:
221   ShenandoahClassLoaderDataRoots();
222   ~ShenandoahClassLoaderDataRoots();
223 
224   void always_strong_cld_do(CLDClosure* clds, uint worker_id = 0);
225   void cld_do(CLDClosure* clds, uint worker_id = 0);
226 };
227 
228 class ShenandoahRootProcessor : public StackObj {
229 private:
230   ShenandoahHeap* const               _heap;
231   const ShenandoahPhaseTimings::Phase _phase;
232 public:
233   ShenandoahRootProcessor(ShenandoahPhaseTimings::Phase phase);
234   ~ShenandoahRootProcessor();
235 
236   ShenandoahHeap* heap() const { return _heap; }
237 };
238 
239 template &lt;typename ITR&gt;
240 class ShenandoahRootScanner : public ShenandoahRootProcessor {
241 private:
242   ShenandoahSerialRoots                                     _serial_roots;
243   ShenandoahThreadRoots                                     _thread_roots;
244   ShenandoahCodeCacheRoots&lt;ITR&gt;                             _code_roots;
245   ShenandoahVMRoots&lt;false /*concurrent*/ &gt;                  _vm_roots;
246   ShenandoahStringDedupRoots                                _dedup_roots;
247   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, false /*single threaded*/&gt;
248                                                             _cld_roots;
249 public:
250   ShenandoahRootScanner(uint n_workers, ShenandoahPhaseTimings::Phase phase);
251 
252   // Apply oops, clds and blobs to all strongly reachable roots in the system,
253   // during class unloading cycle
254   void strong_roots_do(uint worker_id, OopClosure* cl);
255   void strong_roots_do(uint worker_id, OopClosure* oops, CLDClosure* clds, CodeBlobClosure* code, ThreadClosure* tc = NULL);
256 
257   // Apply oops, clds and blobs to all strongly reachable roots and weakly reachable
258   // roots when class unloading is disabled during this cycle
259   void roots_do(uint worker_id, OopClosure* cl);
260   void roots_do(uint worker_id, OopClosure* oops, CLDClosure* clds, CodeBlobClosure* code, ThreadClosure* tc = NULL);
261 };
262 
263 typedef ShenandoahRootScanner&lt;ShenandoahAllCodeRootsIterator&gt; ShenandoahAllRootScanner;
264 typedef ShenandoahRootScanner&lt;ShenandoahCsetCodeRootsIterator&gt; ShenandoahCSetRootScanner;
265 
266 // This scanner is only for SH::object_iteration() and only supports single-threaded
267 // root scanning
268 class ShenandoahHeapIterationRootScanner : public ShenandoahRootProcessor {
269 private:
270   ShenandoahSerialRoots                                    _serial_roots;
271   ShenandoahThreadRoots                                    _thread_roots;
272   ShenandoahVMRoots&lt;false /*concurrent*/&gt;                  _vm_roots;
273   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, true /*single threaded*/&gt;
274                                                            _cld_roots;
275   ShenandoahSerialWeakRoots                                _serial_weak_roots;
276   ShenandoahWeakRoots&lt;false /*concurrent*/&gt;                _weak_roots;
277   ShenandoahConcurrentStringDedupRoots                     _dedup_roots;
278   ShenandoahCodeCacheRoots&lt;ShenandoahAllCodeRootsIterator&gt; _code_roots;
279 
280 public:
281   ShenandoahHeapIterationRootScanner();
282 
283   void roots_do(OopClosure* cl);
284   void strong_roots_do(OopClosure* cl);
285 };
286 
287 // Evacuate all roots at a safepoint
288 class ShenandoahRootEvacuator : public ShenandoahRootProcessor {
289 private:
290   ShenandoahSerialRoots                                     _serial_roots;
291   ShenandoahVMRoots&lt;false /*concurrent*/&gt;                   _vm_roots;
292   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, false /*single threaded*/&gt;
293                                                             _cld_roots;
294   ShenandoahThreadRoots                                     _thread_roots;
295   ShenandoahSerialWeakRoots                                 _serial_weak_roots;
296   ShenandoahWeakRoots&lt;false /*concurrent*/&gt;                 _weak_roots;
297   ShenandoahStringDedupRoots                                _dedup_roots;
298   ShenandoahCodeCacheRoots&lt;ShenandoahAllCodeRootsIterator&gt;  _code_roots;
299   bool                                                      _include_concurrent_roots;
300   bool                                                      _include_concurrent_code_roots;
301 public:
302   ShenandoahRootEvacuator(uint n_workers, ShenandoahPhaseTimings::Phase phase,
303                           bool include_concurrent_roots, bool _include_concurrent_code_roots);
304 
305   void roots_do(uint worker_id, OopClosure* oops);
306 };
307 
308 // Update all roots at a safepoint
309 class ShenandoahRootUpdater : public ShenandoahRootProcessor {
310 private:
311   ShenandoahSerialRoots                                     _serial_roots;
312   ShenandoahVMRoots&lt;false /*concurrent*/&gt;                   _vm_roots;
313   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, false /*single threaded*/&gt;
314                                                             _cld_roots;
315   ShenandoahThreadRoots                                     _thread_roots;
316   ShenandoahSerialWeakRoots                                 _serial_weak_roots;
317   ShenandoahWeakRoots&lt;false /*concurrent*/&gt;                 _weak_roots;
318   ShenandoahStringDedupRoots                                _dedup_roots;
319   ShenandoahCodeCacheRoots&lt;ShenandoahAllCodeRootsIterator&gt;  _code_roots;
320 
321 public:
322   ShenandoahRootUpdater(uint n_workers, ShenandoahPhaseTimings::Phase phase);
323 
324   template&lt;typename IsAlive, typename KeepAlive&gt;
325   void roots_do(uint worker_id, IsAlive* is_alive, KeepAlive* keep_alive);
326 };
327 
328 // Adjuster all roots at a safepoint during full gc
329 class ShenandoahRootAdjuster : public ShenandoahRootProcessor {
330 private:
331   ShenandoahSerialRoots                                     _serial_roots;
332   ShenandoahVMRoots&lt;false /*concurrent*/&gt;                   _vm_roots;
333   ShenandoahClassLoaderDataRoots&lt;false /*concurrent*/, false /*single threaded*/&gt;
334                                                             _cld_roots;
335   ShenandoahThreadRoots                                     _thread_roots;
336   ShenandoahSerialWeakRoots                                 _serial_weak_roots;
337   ShenandoahWeakRoots&lt;false /*concurrent*/&gt;                 _weak_roots;
338   ShenandoahStringDedupRoots                                _dedup_roots;
339   ShenandoahCodeCacheRoots&lt;ShenandoahAllCodeRootsIterator&gt;  _code_roots;
340 
341 public:
342   ShenandoahRootAdjuster(uint n_workers, ShenandoahPhaseTimings::Phase phase);
343 
344   void roots_do(uint worker_id, OopClosure* oops);
345 };
346 
347 #endif // SHARE_GC_SHENANDOAH_SHENANDOAHROOTPROCESSOR_HPP
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>