<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/x86/interp_masm_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;interp_masm_x86.hpp&quot;
  27 #include &quot;interpreter/interpreter.hpp&quot;
  28 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  29 #include &quot;logging/log.hpp&quot;
  30 #include &quot;oops/arrayOop.hpp&quot;
  31 #include &quot;oops/markWord.hpp&quot;
  32 #include &quot;oops/methodData.hpp&quot;
  33 #include &quot;oops/method.hpp&quot;
  34 #include &quot;prims/jvmtiExport.hpp&quot;
  35 #include &quot;prims/jvmtiThreadState.hpp&quot;
  36 #include &quot;runtime/basicLock.hpp&quot;
  37 #include &quot;runtime/biasedLocking.hpp&quot;
  38 #include &quot;runtime/frame.inline.hpp&quot;
  39 #include &quot;runtime/safepointMechanism.hpp&quot;
  40 #include &quot;runtime/sharedRuntime.hpp&quot;
  41 #include &quot;runtime/thread.inline.hpp&quot;
  42 #include &quot;utilities/powerOfTwo.hpp&quot;
  43 
  44 // Implementation of InterpreterMacroAssembler
  45 
  46 void InterpreterMacroAssembler::jump_to_entry(address entry) {
  47   assert(entry, &quot;Entry must have been generated by now&quot;);
  48   jump(RuntimeAddress(entry));
  49 }
  50 
  51 void InterpreterMacroAssembler::profile_obj_type(Register obj, const Address&amp; mdo_addr) {
  52   Label update, next, none;
  53 
  54   verify_oop(obj);
  55 
  56   testptr(obj, obj);
  57   jccb(Assembler::notZero, update);
  58   orptr(mdo_addr, TypeEntries::null_seen);
  59   jmpb(next);
  60 
  61   bind(update);
  62   load_klass(obj, obj);
  63 
  64   xorptr(obj, mdo_addr);
  65   testptr(obj, TypeEntries::type_klass_mask);
  66   jccb(Assembler::zero, next); // klass seen before, nothing to
  67                                // do. The unknown bit may have been
  68                                // set already but no need to check.
  69 
  70   testptr(obj, TypeEntries::type_unknown);
  71   jccb(Assembler::notZero, next); // already unknown. Nothing to do anymore.
  72 
  73   cmpptr(mdo_addr, 0);
  74   jccb(Assembler::equal, none);
  75   cmpptr(mdo_addr, TypeEntries::null_seen);
  76   jccb(Assembler::equal, none);
  77   // There is a chance that the checks above (re-reading profiling
  78   // data from memory) fail if another thread has just set the
  79   // profiling to this obj&#39;s klass
  80   xorptr(obj, mdo_addr);
  81   testptr(obj, TypeEntries::type_klass_mask);
  82   jccb(Assembler::zero, next);
  83 
  84   // different than before. Cannot keep accurate profile.
  85   orptr(mdo_addr, TypeEntries::type_unknown);
  86   jmpb(next);
  87 
  88   bind(none);
  89   // first time here. Set profile type.
  90   movptr(mdo_addr, obj);
  91 
  92   bind(next);
  93 }
  94 
  95 void InterpreterMacroAssembler::profile_arguments_type(Register mdp, Register callee, Register tmp, bool is_virtual) {
  96   if (!ProfileInterpreter) {
  97     return;
  98   }
  99 
 100   if (MethodData::profile_arguments() || MethodData::profile_return()) {
 101     Label profile_continue;
 102 
 103     test_method_data_pointer(mdp, profile_continue);
 104 
 105     int off_to_start = is_virtual ? in_bytes(VirtualCallData::virtual_call_data_size()) : in_bytes(CounterData::counter_data_size());
 106 
 107     cmpb(Address(mdp, in_bytes(DataLayout::tag_offset()) - off_to_start), is_virtual ? DataLayout::virtual_call_type_data_tag : DataLayout::call_type_data_tag);
 108     jcc(Assembler::notEqual, profile_continue);
 109 
 110     if (MethodData::profile_arguments()) {
 111       Label done;
 112       int off_to_args = in_bytes(TypeEntriesAtCall::args_data_offset());
 113       addptr(mdp, off_to_args);
 114 
 115       for (int i = 0; i &lt; TypeProfileArgsLimit; i++) {
 116         if (i &gt; 0 || MethodData::profile_return()) {
 117           // If return value type is profiled we may have no argument to profile
 118           movptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args));
 119           subl(tmp, i*TypeStackSlotEntries::per_arg_count());
 120           cmpl(tmp, TypeStackSlotEntries::per_arg_count());
 121           jcc(Assembler::less, done);
 122         }
 123         movptr(tmp, Address(callee, Method::const_offset()));
 124         load_unsigned_short(tmp, Address(tmp, ConstMethod::size_of_parameters_offset()));
 125         // stack offset o (zero based) from the start of the argument
 126         // list, for n arguments translates into offset n - o - 1 from
 127         // the end of the argument list
 128         subptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::stack_slot_offset(i))-off_to_args));
 129         subl(tmp, 1);
 130         Address arg_addr = argument_address(tmp);
 131         movptr(tmp, arg_addr);
 132 
 133         Address mdo_arg_addr(mdp, in_bytes(TypeEntriesAtCall::argument_type_offset(i))-off_to_args);
 134         profile_obj_type(tmp, mdo_arg_addr);
 135 
 136         int to_add = in_bytes(TypeStackSlotEntries::per_arg_size());
 137         addptr(mdp, to_add);
 138         off_to_args += to_add;
 139       }
 140 
 141       if (MethodData::profile_return()) {
 142         movptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args));
 143         subl(tmp, TypeProfileArgsLimit*TypeStackSlotEntries::per_arg_count());
 144       }
 145 
 146       bind(done);
 147 
 148       if (MethodData::profile_return()) {
 149         // We&#39;re right after the type profile for the last
 150         // argument. tmp is the number of cells left in the
 151         // CallTypeData/VirtualCallTypeData to reach its end. Non null
 152         // if there&#39;s a return to profile.
 153         assert(ReturnTypeEntry::static_cell_count() &lt; TypeStackSlotEntries::per_arg_count(), &quot;can&#39;t move past ret type&quot;);
 154         shll(tmp, exact_log2(DataLayout::cell_size));
 155         addptr(mdp, tmp);
 156       }
 157       movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp);
 158     } else {
 159       assert(MethodData::profile_return(), &quot;either profile call args or call ret&quot;);
 160       update_mdp_by_constant(mdp, in_bytes(TypeEntriesAtCall::return_only_size()));
 161     }
 162 
 163     // mdp points right after the end of the
 164     // CallTypeData/VirtualCallTypeData, right after the cells for the
 165     // return value type if there&#39;s one
 166 
 167     bind(profile_continue);
 168   }
 169 }
 170 
 171 void InterpreterMacroAssembler::profile_return_type(Register mdp, Register ret, Register tmp) {
 172   assert_different_registers(mdp, ret, tmp, _bcp_register);
 173   if (ProfileInterpreter &amp;&amp; MethodData::profile_return()) {
 174     Label profile_continue;
 175 
 176     test_method_data_pointer(mdp, profile_continue);
 177 
 178     if (MethodData::profile_return_jsr292_only()) {
 179       assert(Method::intrinsic_id_size_in_bytes() == 2, &quot;assuming Method::_intrinsic_id is u2&quot;);
 180 
 181       // If we don&#39;t profile all invoke bytecodes we must make sure
 182       // it&#39;s a bytecode we indeed profile. We can&#39;t go back to the
 183       // begining of the ProfileData we intend to update to check its
 184       // type because we&#39;re right after it and we don&#39;t known its
 185       // length
 186       Label do_profile;
 187       cmpb(Address(_bcp_register, 0), Bytecodes::_invokedynamic);
 188       jcc(Assembler::equal, do_profile);
 189       cmpb(Address(_bcp_register, 0), Bytecodes::_invokehandle);
 190       jcc(Assembler::equal, do_profile);
 191       get_method(tmp);
 192       cmpw(Address(tmp, Method::intrinsic_id_offset_in_bytes()), vmIntrinsics::_compiledLambdaForm);
 193       jcc(Assembler::notEqual, profile_continue);
 194 
 195       bind(do_profile);
 196     }
 197 
 198     Address mdo_ret_addr(mdp, -in_bytes(ReturnTypeEntry::size()));
 199     mov(tmp, ret);
 200     profile_obj_type(tmp, mdo_ret_addr);
 201 
 202     bind(profile_continue);
 203   }
 204 }
 205 
 206 void InterpreterMacroAssembler::profile_parameters_type(Register mdp, Register tmp1, Register tmp2) {
 207   if (ProfileInterpreter &amp;&amp; MethodData::profile_parameters()) {
 208     Label profile_continue;
 209 
 210     test_method_data_pointer(mdp, profile_continue);
 211 
 212     // Load the offset of the area within the MDO used for
 213     // parameters. If it&#39;s negative we&#39;re not profiling any parameters
 214     movl(tmp1, Address(mdp, in_bytes(MethodData::parameters_type_data_di_offset()) - in_bytes(MethodData::data_offset())));
 215     testl(tmp1, tmp1);
 216     jcc(Assembler::negative, profile_continue);
 217 
 218     // Compute a pointer to the area for parameters from the offset
 219     // and move the pointer to the slot for the last
 220     // parameters. Collect profiling from last parameter down.
 221     // mdo start + parameters offset + array length - 1
 222     addptr(mdp, tmp1);
 223     movptr(tmp1, Address(mdp, ArrayData::array_len_offset()));
 224     decrement(tmp1, TypeStackSlotEntries::per_arg_count());
 225 
 226     Label loop;
 227     bind(loop);
 228 
 229     int off_base = in_bytes(ParametersTypeData::stack_slot_offset(0));
 230     int type_base = in_bytes(ParametersTypeData::type_offset(0));
 231     Address::ScaleFactor per_arg_scale = Address::times(DataLayout::cell_size);
 232     Address arg_off(mdp, tmp1, per_arg_scale, off_base);
 233     Address arg_type(mdp, tmp1, per_arg_scale, type_base);
 234 
 235     // load offset on the stack from the slot for this parameter
 236     movptr(tmp2, arg_off);
 237     negptr(tmp2);
 238     // read the parameter from the local area
 239     movptr(tmp2, Address(_locals_register, tmp2, Interpreter::stackElementScale()));
 240 
 241     // profile the parameter
 242     profile_obj_type(tmp2, arg_type);
 243 
 244     // go to next parameter
 245     decrement(tmp1, TypeStackSlotEntries::per_arg_count());
 246     jcc(Assembler::positive, loop);
 247 
 248     bind(profile_continue);
 249   }
 250 }
 251 
 252 void InterpreterMacroAssembler::call_VM_leaf_base(address entry_point,
 253                                                   int number_of_arguments) {
 254   // interpreter specific
 255   //
 256   // Note: No need to save/restore bcp &amp; locals registers
 257   //       since these are callee saved registers and no blocking/
 258   //       GC can happen in leaf calls.
 259   // Further Note: DO NOT save/restore bcp/locals. If a caller has
 260   // already saved them so that it can use rsi/rdi as temporaries
 261   // then a save/restore here will DESTROY the copy the caller
 262   // saved! There used to be a save_bcp() that only happened in
 263   // the ASSERT path (no restore_bcp). Which caused bizarre failures
 264   // when jvm built with ASSERTs.
 265 #ifdef ASSERT
 266   {
 267     Label L;
 268     cmpptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 269     jcc(Assembler::equal, L);
 270     stop(&quot;InterpreterMacroAssembler::call_VM_leaf_base:&quot;
 271          &quot; last_sp != NULL&quot;);
 272     bind(L);
 273   }
 274 #endif
 275   // super call
 276   MacroAssembler::call_VM_leaf_base(entry_point, number_of_arguments);
 277   // interpreter specific
 278   // LP64: Used to ASSERT that r13/r14 were equal to frame&#39;s bcp/locals
 279   // but since they may not have been saved (and we don&#39;t want to
 280   // save them here (see note above) the assert is invalid.
 281 }
 282 
 283 void InterpreterMacroAssembler::call_VM_base(Register oop_result,
 284                                              Register java_thread,
 285                                              Register last_java_sp,
 286                                              address  entry_point,
 287                                              int      number_of_arguments,
 288                                              bool     check_exceptions) {
 289   // interpreter specific
 290   //
 291   // Note: Could avoid restoring locals ptr (callee saved) - however doesn&#39;t
 292   //       really make a difference for these runtime calls, since they are
 293   //       slow anyway. Btw., bcp must be saved/restored since it may change
 294   //       due to GC.
 295   NOT_LP64(assert(java_thread == noreg , &quot;not expecting a precomputed java thread&quot;);)
 296   save_bcp();
 297 #ifdef ASSERT
 298   {
 299     Label L;
 300     cmpptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 301     jcc(Assembler::equal, L);
 302     stop(&quot;InterpreterMacroAssembler::call_VM_base:&quot;
 303          &quot; last_sp != NULL&quot;);
 304     bind(L);
 305   }
 306 #endif /* ASSERT */
 307   // super call
 308   MacroAssembler::call_VM_base(oop_result, noreg, last_java_sp,
 309                                entry_point, number_of_arguments,
 310                                check_exceptions);
 311   // interpreter specific
 312   restore_bcp();
 313   restore_locals();
 314 }
 315 
 316 void InterpreterMacroAssembler::check_and_handle_popframe(Register java_thread) {
 317   if (JvmtiExport::can_pop_frame()) {
 318     Label L;
 319     // Initiate popframe handling only if it is not already being
 320     // processed.  If the flag has the popframe_processing bit set, it
 321     // means that this code is called *during* popframe handling - we
 322     // don&#39;t want to reenter.
 323     // This method is only called just after the call into the vm in
 324     // call_VM_base, so the arg registers are available.
 325     Register pop_cond = NOT_LP64(java_thread) // Not clear if any other register is available on 32 bit
 326                         LP64_ONLY(c_rarg0);
 327     movl(pop_cond, Address(java_thread, JavaThread::popframe_condition_offset()));
 328     testl(pop_cond, JavaThread::popframe_pending_bit);
 329     jcc(Assembler::zero, L);
 330     testl(pop_cond, JavaThread::popframe_processing_bit);
 331     jcc(Assembler::notZero, L);
 332     // Call Interpreter::remove_activation_preserving_args_entry() to get the
 333     // address of the same-named entrypoint in the generated interpreter code.
 334     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_preserving_args_entry));
 335     jmp(rax);
 336     bind(L);
 337     NOT_LP64(get_thread(java_thread);)
 338   }
 339 }
 340 
 341 void InterpreterMacroAssembler::load_earlyret_value(TosState state) {
 342   Register thread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
 343   NOT_LP64(get_thread(thread);)
 344   movptr(rcx, Address(thread, JavaThread::jvmti_thread_state_offset()));
 345   const Address tos_addr(rcx, JvmtiThreadState::earlyret_tos_offset());
 346   const Address oop_addr(rcx, JvmtiThreadState::earlyret_oop_offset());
 347   const Address val_addr(rcx, JvmtiThreadState::earlyret_value_offset());
 348 #ifdef _LP64
 349   switch (state) {
 350     case atos: movptr(rax, oop_addr);
 351                movptr(oop_addr, (int32_t)NULL_WORD);
 352                verify_oop(rax, state);              break;
 353     case ltos: movptr(rax, val_addr);                 break;
 354     case btos:                                   // fall through
 355     case ztos:                                   // fall through
 356     case ctos:                                   // fall through
 357     case stos:                                   // fall through
 358     case itos: movl(rax, val_addr);                 break;
 359     case ftos: load_float(val_addr);                break;
 360     case dtos: load_double(val_addr);               break;
 361     case vtos: /* nothing to do */                  break;
 362     default  : ShouldNotReachHere();
 363   }
 364   // Clean up tos value in the thread object
 365   movl(tos_addr,  (int) ilgl);
 366   movl(val_addr,  (int32_t) NULL_WORD);
 367 #else
 368   const Address val_addr1(rcx, JvmtiThreadState::earlyret_value_offset()
 369                              + in_ByteSize(wordSize));
 370   switch (state) {
 371     case atos: movptr(rax, oop_addr);
 372                movptr(oop_addr, NULL_WORD);
 373                verify_oop(rax, state);                break;
 374     case ltos:
 375                movl(rdx, val_addr1);               // fall through
 376     case btos:                                     // fall through
 377     case ztos:                                     // fall through
 378     case ctos:                                     // fall through
 379     case stos:                                     // fall through
 380     case itos: movl(rax, val_addr);                   break;
 381     case ftos: load_float(val_addr);                  break;
 382     case dtos: load_double(val_addr);                 break;
 383     case vtos: /* nothing to do */                    break;
 384     default  : ShouldNotReachHere();
 385   }
 386 #endif // _LP64
 387   // Clean up tos value in the thread object
 388   movl(tos_addr,  (int32_t) ilgl);
 389   movptr(val_addr,  NULL_WORD);
 390   NOT_LP64(movptr(val_addr1, NULL_WORD);)
 391 }
 392 
 393 
 394 void InterpreterMacroAssembler::check_and_handle_earlyret(Register java_thread) {
 395   if (JvmtiExport::can_force_early_return()) {
 396     Label L;
 397     Register tmp = LP64_ONLY(c_rarg0) NOT_LP64(java_thread);
 398     Register rthread = LP64_ONLY(r15_thread) NOT_LP64(java_thread);
 399 
 400     movptr(tmp, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 401     testptr(tmp, tmp);
 402     jcc(Assembler::zero, L); // if (thread-&gt;jvmti_thread_state() == NULL) exit;
 403 
 404     // Initiate earlyret handling only if it is not already being processed.
 405     // If the flag has the earlyret_processing bit set, it means that this code
 406     // is called *during* earlyret handling - we don&#39;t want to reenter.
 407     movl(tmp, Address(tmp, JvmtiThreadState::earlyret_state_offset()));
 408     cmpl(tmp, JvmtiThreadState::earlyret_pending);
 409     jcc(Assembler::notEqual, L);
 410 
 411     // Call Interpreter::remove_activation_early_entry() to get the address of the
 412     // same-named entrypoint in the generated interpreter code.
 413     NOT_LP64(get_thread(java_thread);)
 414     movptr(tmp, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 415 #ifdef _LP64
 416     movl(tmp, Address(tmp, JvmtiThreadState::earlyret_tos_offset()));
 417     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), tmp);
 418 #else
 419     pushl(Address(tmp, JvmtiThreadState::earlyret_tos_offset()));
 420     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), 1);
 421 #endif // _LP64
 422     jmp(rax);
 423     bind(L);
 424     NOT_LP64(get_thread(java_thread);)
 425   }
 426 }
 427 
 428 void InterpreterMacroAssembler::get_unsigned_2_byte_index_at_bcp(Register reg, int bcp_offset) {
 429   assert(bcp_offset &gt;= 0, &quot;bcp is still pointing to start of bytecode&quot;);
 430   load_unsigned_short(reg, Address(_bcp_register, bcp_offset));
 431   bswapl(reg);
 432   shrl(reg, 16);
 433 }
 434 
 435 void InterpreterMacroAssembler::get_cache_index_at_bcp(Register index,
 436                                                        int bcp_offset,
 437                                                        size_t index_size) {
 438   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 439   if (index_size == sizeof(u2)) {
 440     load_unsigned_short(index, Address(_bcp_register, bcp_offset));
 441   } else if (index_size == sizeof(u4)) {
 442     movl(index, Address(_bcp_register, bcp_offset));
 443     // Check if the secondary index definition is still ~x, otherwise
 444     // we have to change the following assembler code to calculate the
 445     // plain index.
 446     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 447     notl(index);  // convert to plain index
 448   } else if (index_size == sizeof(u1)) {
 449     load_unsigned_byte(index, Address(_bcp_register, bcp_offset));
 450   } else {
 451     ShouldNotReachHere();
 452   }
 453 }
 454 
 455 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache,
 456                                                            Register index,
 457                                                            int bcp_offset,
 458                                                            size_t index_size) {
 459   assert_different_registers(cache, index);
 460   get_cache_index_at_bcp(index, bcp_offset, index_size);
 461   movptr(cache, Address(rbp, frame::interpreter_frame_cache_offset * wordSize));
 462   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 463   // convert from field index to ConstantPoolCacheEntry index
 464   assert(exact_log2(in_words(ConstantPoolCacheEntry::size())) == 2, &quot;else change next line&quot;);
 465   shll(index, 2);
 466 }
 467 
 468 void InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache,
 469                                                                         Register index,
 470                                                                         Register bytecode,
 471                                                                         int byte_no,
 472                                                                         int bcp_offset,
 473                                                                         size_t index_size) {
 474   get_cache_and_index_at_bcp(cache, index, bcp_offset, index_size);
 475   // We use a 32-bit load here since the layout of 64-bit words on
 476   // little-endian machines allow us that.
 477   movl(bytecode, Address(cache, index, Address::times_ptr, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset()));
 478   const int shift_count = (1 + byte_no) * BitsPerByte;
 479   assert((byte_no == TemplateTable::f1_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_1_shift) ||
 480          (byte_no == TemplateTable::f2_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_2_shift),
 481          &quot;correct shift count&quot;);
 482   shrl(bytecode, shift_count);
 483   assert(ConstantPoolCacheEntry::bytecode_1_mask == ConstantPoolCacheEntry::bytecode_2_mask, &quot;common mask&quot;);
 484   andl(bytecode, ConstantPoolCacheEntry::bytecode_1_mask);
 485 }
 486 
 487 void InterpreterMacroAssembler::get_cache_entry_pointer_at_bcp(Register cache,
 488                                                                Register tmp,
 489                                                                int bcp_offset,
 490                                                                size_t index_size) {
 491   assert_different_registers(cache, tmp);
 492 
 493   get_cache_index_at_bcp(tmp, bcp_offset, index_size);
 494   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 495   // convert from field index to ConstantPoolCacheEntry index
 496   // and from word offset to byte offset
 497   assert(exact_log2(in_bytes(ConstantPoolCacheEntry::size_in_bytes())) == 2 + LogBytesPerWord, &quot;else change next line&quot;);
 498   shll(tmp, 2 + LogBytesPerWord);
 499   movptr(cache, Address(rbp, frame::interpreter_frame_cache_offset * wordSize));
 500   // skip past the header
 501   addptr(cache, in_bytes(ConstantPoolCache::base_offset()));
 502   addptr(cache, tmp);  // construct pointer to cache entry
 503 }
 504 
 505 // Load object from cpool-&gt;resolved_references(index)
 506 void InterpreterMacroAssembler::load_resolved_reference_at_index(Register result,
 507                                                                  Register index,
 508                                                                  Register tmp) {
 509   assert_different_registers(result, index);
 510 
 511   get_constant_pool(result);
 512   // load pointer for resolved_references[] objArray
 513   movptr(result, Address(result, ConstantPool::cache_offset_in_bytes()));
 514   movptr(result, Address(result, ConstantPoolCache::resolved_references_offset_in_bytes()));
 515   resolve_oop_handle(result, tmp);
 516   load_heap_oop(result, Address(result, index,
 517                                 UseCompressedOops ? Address::times_4 : Address::times_ptr,
 518                                 arrayOopDesc::base_offset_in_bytes(T_OBJECT)), tmp);
 519 }
 520 
 521 // load cpool-&gt;resolved_klass_at(index)
 522 void InterpreterMacroAssembler::load_resolved_klass_at_index(Register klass,
 523                                                              Register cpool,
 524                                                              Register index) {
 525   assert_different_registers(cpool, index);
 526 
 527   movw(index, Address(cpool, index, Address::times_ptr, sizeof(ConstantPool)));
 528   Register resolved_klasses = cpool;
 529   movptr(resolved_klasses, Address(cpool, ConstantPool::resolved_klasses_offset_in_bytes()));
 530   movptr(klass, Address(resolved_klasses, index, Address::times_ptr, Array&lt;Klass*&gt;::base_offset_in_bytes()));
 531 }
 532 
 533 void InterpreterMacroAssembler::load_resolved_method_at_index(int byte_no,
 534                                                               Register method,
 535                                                               Register cache,
 536                                                               Register index) {
 537   assert_different_registers(cache, index);
 538 
 539   const int method_offset = in_bytes(
 540     ConstantPoolCache::base_offset() +
 541       ((byte_no == TemplateTable::f2_byte)
 542        ? ConstantPoolCacheEntry::f2_offset()
 543        : ConstantPoolCacheEntry::f1_offset()));
 544 
 545   movptr(method, Address(cache, index, Address::times_ptr, method_offset)); // get f1 Method*
 546 }
 547 
 548 // Generate a subtype check: branch to ok_is_subtype if sub_klass is a
 549 // subtype of super_klass.
 550 //
 551 // Args:
 552 //      rax: superklass
 553 //      Rsub_klass: subklass
 554 //
 555 // Kills:
 556 //      rcx, rdi
 557 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass,
 558                                                   Label&amp; ok_is_subtype) {
 559   assert(Rsub_klass != rax, &quot;rax holds superklass&quot;);
 560   LP64_ONLY(assert(Rsub_klass != r14, &quot;r14 holds locals&quot;);)
 561   LP64_ONLY(assert(Rsub_klass != r13, &quot;r13 holds bcp&quot;);)
 562   assert(Rsub_klass != rcx, &quot;rcx holds 2ndary super array length&quot;);
 563   assert(Rsub_klass != rdi, &quot;rdi holds 2ndary super array scan ptr&quot;);
 564 
 565   // Profile the not-null value&#39;s klass.
 566   profile_typecheck(rcx, Rsub_klass, rdi); // blows rcx, reloads rdi
 567 
 568   // Do the check.
 569   check_klass_subtype(Rsub_klass, rax, rcx, ok_is_subtype); // blows rcx
 570 
 571   // Profile the failure of the check.
 572   profile_typecheck_failed(rcx); // blows rcx
 573 }
 574 
 575 
 576 #ifndef _LP64
 577 void InterpreterMacroAssembler::f2ieee() {
 578   if (IEEEPrecision) {
 579     fstp_s(Address(rsp, 0));
 580     fld_s(Address(rsp, 0));
 581   }
 582 }
 583 
 584 
 585 void InterpreterMacroAssembler::d2ieee() {
 586   if (IEEEPrecision) {
 587     fstp_d(Address(rsp, 0));
 588     fld_d(Address(rsp, 0));
 589   }
 590 }
 591 #endif // _LP64
 592 
 593 // Java Expression Stack
 594 
 595 void InterpreterMacroAssembler::pop_ptr(Register r) {
 596   pop(r);
 597 }
 598 
 599 void InterpreterMacroAssembler::push_ptr(Register r) {
 600   push(r);
 601 }
 602 
 603 void InterpreterMacroAssembler::push_i(Register r) {
 604   push(r);
 605 }
 606 
 607 void InterpreterMacroAssembler::push_f(XMMRegister r) {
 608   subptr(rsp, wordSize);
 609   movflt(Address(rsp, 0), r);
 610 }
 611 
 612 void InterpreterMacroAssembler::pop_f(XMMRegister r) {
 613   movflt(r, Address(rsp, 0));
 614   addptr(rsp, wordSize);
 615 }
 616 
 617 void InterpreterMacroAssembler::push_d(XMMRegister r) {
 618   subptr(rsp, 2 * wordSize);
 619   movdbl(Address(rsp, 0), r);
 620 }
 621 
 622 void InterpreterMacroAssembler::pop_d(XMMRegister r) {
 623   movdbl(r, Address(rsp, 0));
 624   addptr(rsp, 2 * Interpreter::stackElementSize);
 625 }
 626 
 627 #ifdef _LP64
 628 void InterpreterMacroAssembler::pop_i(Register r) {
 629   // XXX can&#39;t use pop currently, upper half non clean
 630   movl(r, Address(rsp, 0));
 631   addptr(rsp, wordSize);
 632 }
 633 
 634 void InterpreterMacroAssembler::pop_l(Register r) {
 635   movq(r, Address(rsp, 0));
 636   addptr(rsp, 2 * Interpreter::stackElementSize);
 637 }
 638 
 639 void InterpreterMacroAssembler::push_l(Register r) {
 640   subptr(rsp, 2 * wordSize);
 641   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(0)), r         );
 642   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(1)), NULL_WORD );
 643 }
 644 
 645 void InterpreterMacroAssembler::pop(TosState state) {
 646   switch (state) {
 647   case atos: pop_ptr();                 break;
 648   case btos:
 649   case ztos:
 650   case ctos:
 651   case stos:
 652   case itos: pop_i();                   break;
 653   case ltos: pop_l();                   break;
 654   case ftos: pop_f(xmm0);               break;
 655   case dtos: pop_d(xmm0);               break;
 656   case vtos: /* nothing to do */        break;
 657   default:   ShouldNotReachHere();
 658   }
 659   verify_oop(rax, state);
 660 }
 661 
 662 void InterpreterMacroAssembler::push(TosState state) {
 663   verify_oop(rax, state);
 664   switch (state) {
 665   case atos: push_ptr();                break;
 666   case btos:
 667   case ztos:
 668   case ctos:
 669   case stos:
 670   case itos: push_i();                  break;
 671   case ltos: push_l();                  break;
 672   case ftos: push_f(xmm0);              break;
 673   case dtos: push_d(xmm0);              break;
 674   case vtos: /* nothing to do */        break;
 675   default  : ShouldNotReachHere();
 676   }
 677 }
 678 #else
 679 void InterpreterMacroAssembler::pop_i(Register r) {
 680   pop(r);
 681 }
 682 
 683 void InterpreterMacroAssembler::pop_l(Register lo, Register hi) {
 684   pop(lo);
 685   pop(hi);
 686 }
 687 
 688 void InterpreterMacroAssembler::pop_f() {
 689   fld_s(Address(rsp, 0));
 690   addptr(rsp, 1 * wordSize);
 691 }
 692 
 693 void InterpreterMacroAssembler::pop_d() {
 694   fld_d(Address(rsp, 0));
 695   addptr(rsp, 2 * wordSize);
 696 }
 697 
 698 
 699 void InterpreterMacroAssembler::pop(TosState state) {
 700   switch (state) {
 701     case atos: pop_ptr(rax);                                 break;
 702     case btos:                                               // fall through
 703     case ztos:                                               // fall through
 704     case ctos:                                               // fall through
 705     case stos:                                               // fall through
 706     case itos: pop_i(rax);                                   break;
 707     case ltos: pop_l(rax, rdx);                              break;
 708     case ftos:
 709       if (UseSSE &gt;= 1) {
 710         pop_f(xmm0);
 711       } else {
 712         pop_f();
 713       }
 714       break;
 715     case dtos:
 716       if (UseSSE &gt;= 2) {
 717         pop_d(xmm0);
 718       } else {
 719         pop_d();
 720       }
 721       break;
 722     case vtos: /* nothing to do */                           break;
 723     default  : ShouldNotReachHere();
 724   }
 725   verify_oop(rax, state);
 726 }
 727 
 728 
 729 void InterpreterMacroAssembler::push_l(Register lo, Register hi) {
 730   push(hi);
 731   push(lo);
 732 }
 733 
 734 void InterpreterMacroAssembler::push_f() {
 735   // Do not schedule for no AGI! Never write beyond rsp!
 736   subptr(rsp, 1 * wordSize);
 737   fstp_s(Address(rsp, 0));
 738 }
 739 
 740 void InterpreterMacroAssembler::push_d() {
 741   // Do not schedule for no AGI! Never write beyond rsp!
 742   subptr(rsp, 2 * wordSize);
 743   fstp_d(Address(rsp, 0));
 744 }
 745 
 746 
 747 void InterpreterMacroAssembler::push(TosState state) {
 748   verify_oop(rax, state);
 749   switch (state) {
 750     case atos: push_ptr(rax); break;
 751     case btos:                                               // fall through
 752     case ztos:                                               // fall through
 753     case ctos:                                               // fall through
 754     case stos:                                               // fall through
 755     case itos: push_i(rax);                                    break;
 756     case ltos: push_l(rax, rdx);                               break;
 757     case ftos:
 758       if (UseSSE &gt;= 1) {
 759         push_f(xmm0);
 760       } else {
 761         push_f();
 762       }
 763       break;
 764     case dtos:
 765       if (UseSSE &gt;= 2) {
 766         push_d(xmm0);
 767       } else {
 768         push_d();
 769       }
 770       break;
 771     case vtos: /* nothing to do */                             break;
 772     default  : ShouldNotReachHere();
 773   }
 774 }
 775 #endif // _LP64
 776 
 777 
 778 // Helpers for swap and dup
 779 void InterpreterMacroAssembler::load_ptr(int n, Register val) {
 780   movptr(val, Address(rsp, Interpreter::expr_offset_in_bytes(n)));
 781 }
 782 
 783 void InterpreterMacroAssembler::store_ptr(int n, Register val) {
 784   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(n)), val);
 785 }
 786 
 787 
 788 void InterpreterMacroAssembler::prepare_to_jump_from_interpreted() {
 789   // set sender sp
 790   lea(_bcp_register, Address(rsp, wordSize));
 791   // record last_sp
 792   movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), _bcp_register);
 793 }
 794 
 795 
 796 // Jump to from_interpreted entry of a call unless single stepping is possible
 797 // in this thread in which case we must call the i2i entry
 798 void InterpreterMacroAssembler::jump_from_interpreted(Register method, Register temp) {
 799   prepare_to_jump_from_interpreted();
 800 
 801   if (JvmtiExport::can_post_interpreter_events()) {
 802     Label run_compiled_code;
 803     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
 804     // compiled code in threads for which the event is enabled.  Check here for
 805     // interp_only_mode if these events CAN be enabled.
 806     // interp_only is an int, on little endian it is sufficient to test the byte only
 807     // Is a cmpl faster?
 808     LP64_ONLY(temp = r15_thread;)
 809     NOT_LP64(get_thread(temp);)
 810     cmpb(Address(temp, JavaThread::interp_only_mode_offset()), 0);
 811     jccb(Assembler::zero, run_compiled_code);
 812     jmp(Address(method, Method::interpreter_entry_offset()));
 813     bind(run_compiled_code);
 814   }
 815 
 816   jmp(Address(method, Method::from_interpreted_offset()));
 817 }
 818 
 819 // The following two routines provide a hook so that an implementation
 820 // can schedule the dispatch in two parts.  x86 does not do this.
 821 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int step) {
 822   // Nothing x86 specific to be done here
 823 }
 824 
 825 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int step) {
 826   dispatch_next(state, step);
 827 }
 828 
 829 void InterpreterMacroAssembler::dispatch_base(TosState state,
 830                                               address* table,
 831                                               bool verifyoop,
 832                                               bool generate_poll) {
 833   verify_FPU(1, state);
 834   if (VerifyActivationFrameSize) {
 835     Label L;
 836     mov(rcx, rbp);
 837     subptr(rcx, rsp);
 838     int32_t min_frame_size =
 839       (frame::link_offset - frame::interpreter_frame_initial_sp_offset) *
 840       wordSize;
 841     cmpptr(rcx, (int32_t)min_frame_size);
 842     jcc(Assembler::greaterEqual, L);
 843     stop(&quot;broken stack frame&quot;);
 844     bind(L);
 845   }
 846   if (verifyoop) {
 847     verify_oop(rax, state);
 848   }
 849 
 850   address* const safepoint_table = Interpreter::safept_table(state);
 851 #ifdef _LP64
 852   Label no_safepoint, dispatch;
 853   if (SafepointMechanism::uses_thread_local_poll() &amp;&amp; table != safepoint_table &amp;&amp; generate_poll) {
 854     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 855     testb(Address(r15_thread, Thread::polling_page_offset()), SafepointMechanism::poll_bit());
 856 
 857     jccb(Assembler::zero, no_safepoint);
 858     lea(rscratch1, ExternalAddress((address)safepoint_table));
 859     jmpb(dispatch);
 860   }
 861 
 862   bind(no_safepoint);
 863   lea(rscratch1, ExternalAddress((address)table));
 864   bind(dispatch);
 865   jmp(Address(rscratch1, rbx, Address::times_8));
 866 
 867 #else
 868   Address index(noreg, rbx, Address::times_ptr);
 869   if (SafepointMechanism::uses_thread_local_poll() &amp;&amp; table != safepoint_table &amp;&amp; generate_poll) {
 870     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 871     Label no_safepoint;
 872     const Register thread = rcx;
 873     get_thread(thread);
 874     testb(Address(thread, Thread::polling_page_offset()), SafepointMechanism::poll_bit());
 875 
 876     jccb(Assembler::zero, no_safepoint);
 877     ArrayAddress dispatch_addr(ExternalAddress((address)safepoint_table), index);
 878     jump(dispatch_addr);
 879     bind(no_safepoint);
 880   }
 881 
 882   {
 883     ArrayAddress dispatch_addr(ExternalAddress((address)table), index);
 884     jump(dispatch_addr);
 885   }
 886 #endif // _LP64
 887 }
 888 
 889 void InterpreterMacroAssembler::dispatch_only(TosState state, bool generate_poll) {
 890   dispatch_base(state, Interpreter::dispatch_table(state), true, generate_poll);
 891 }
 892 
 893 void InterpreterMacroAssembler::dispatch_only_normal(TosState state) {
 894   dispatch_base(state, Interpreter::normal_table(state));
 895 }
 896 
 897 void InterpreterMacroAssembler::dispatch_only_noverify(TosState state) {
 898   dispatch_base(state, Interpreter::normal_table(state), false);
 899 }
 900 
 901 
 902 void InterpreterMacroAssembler::dispatch_next(TosState state, int step, bool generate_poll) {
 903   // load next bytecode (load before advancing _bcp_register to prevent AGI)
 904   load_unsigned_byte(rbx, Address(_bcp_register, step));
 905   // advance _bcp_register
 906   increment(_bcp_register, step);
 907   dispatch_base(state, Interpreter::dispatch_table(state), true, generate_poll);
 908 }
 909 
 910 void InterpreterMacroAssembler::dispatch_via(TosState state, address* table) {
 911   // load current bytecode
 912   load_unsigned_byte(rbx, Address(_bcp_register, 0));
 913   dispatch_base(state, table);
 914 }
 915 
 916 void InterpreterMacroAssembler::narrow(Register result) {
 917 
 918   // Get method-&gt;_constMethod-&gt;_result_type
 919   movptr(rcx, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
 920   movptr(rcx, Address(rcx, Method::const_offset()));
 921   load_unsigned_byte(rcx, Address(rcx, ConstMethod::result_type_offset()));
 922 
 923   Label done, notBool, notByte, notChar;
 924 
 925   // common case first
 926   cmpl(rcx, T_INT);
 927   jcc(Assembler::equal, done);
 928 
 929   // mask integer result to narrower return type.
 930   cmpl(rcx, T_BOOLEAN);
 931   jcc(Assembler::notEqual, notBool);
 932   andl(result, 0x1);
 933   jmp(done);
 934 
 935   bind(notBool);
 936   cmpl(rcx, T_BYTE);
 937   jcc(Assembler::notEqual, notByte);
 938   LP64_ONLY(movsbl(result, result);)
 939   NOT_LP64(shll(result, 24);)      // truncate upper 24 bits
 940   NOT_LP64(sarl(result, 24);)      // and sign-extend byte
 941   jmp(done);
 942 
 943   bind(notByte);
 944   cmpl(rcx, T_CHAR);
 945   jcc(Assembler::notEqual, notChar);
 946   LP64_ONLY(movzwl(result, result);)
 947   NOT_LP64(andl(result, 0xFFFF);)  // truncate upper 16 bits
 948   jmp(done);
 949 
 950   bind(notChar);
 951   // cmpl(rcx, T_SHORT);  // all that&#39;s left
 952   // jcc(Assembler::notEqual, done);
 953   LP64_ONLY(movswl(result, result);)
 954   NOT_LP64(shll(result, 16);)      // truncate upper 16 bits
 955   NOT_LP64(sarl(result, 16);)      // and sign-extend short
 956 
 957   // Nothing to do for T_INT
 958   bind(done);
 959 }
 960 
 961 // remove activation
 962 //
 963 // Unlock the receiver if this is a synchronized method.
 964 // Unlock any Java monitors from syncronized blocks.
 965 // Remove the activation from the stack.
 966 //
 967 // If there are locked Java monitors
 968 //    If throw_monitor_exception
 969 //       throws IllegalMonitorStateException
 970 //    Else if install_monitor_exception
 971 //       installs IllegalMonitorStateException
 972 //    Else
 973 //       no error processing
 974 void InterpreterMacroAssembler::remove_activation(
 975         TosState state,
 976         Register ret_addr,
 977         bool throw_monitor_exception,
 978         bool install_monitor_exception,
 979         bool notify_jvmdi) {
 980   // Note: Registers rdx xmm0 may be in use for the
 981   // result check if synchronized method
 982   Label unlocked, unlock, no_unlock;
 983 
 984   const Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
 985   const Register robj    = LP64_ONLY(c_rarg1) NOT_LP64(rdx);
 986   const Register rmon    = LP64_ONLY(c_rarg1) NOT_LP64(rcx);
 987                               // monitor pointers need different register
 988                               // because rdx may have the result in it
 989   NOT_LP64(get_thread(rcx);)
 990 
 991   // get the value of _do_not_unlock_if_synchronized into rdx
 992   const Address do_not_unlock_if_synchronized(rthread,
 993     in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
 994   movbool(rbx, do_not_unlock_if_synchronized);
 995   movbool(do_not_unlock_if_synchronized, false); // reset the flag
 996 
 997  // get method access flags
 998   movptr(rcx, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
 999   movl(rcx, Address(rcx, Method::access_flags_offset()));
1000   testl(rcx, JVM_ACC_SYNCHRONIZED);
1001   jcc(Assembler::zero, unlocked);
1002 
1003   // Don&#39;t unlock anything if the _do_not_unlock_if_synchronized flag
1004   // is set.
1005   testbool(rbx);
1006   jcc(Assembler::notZero, no_unlock);
1007 
1008   // unlock monitor
1009   push(state); // save result
1010 
1011   // BasicObjectLock will be first in list, since this is a
1012   // synchronized method. However, need to check that the object has
1013   // not been unlocked by an explicit monitorexit bytecode.
1014   const Address monitor(rbp, frame::interpreter_frame_initial_sp_offset *
1015                         wordSize - (int) sizeof(BasicObjectLock));
1016   // We use c_rarg1/rdx so that if we go slow path it will be the correct
1017   // register for unlock_object to pass to VM directly
1018   lea(robj, monitor); // address of first monitor
1019 
1020   movptr(rax, Address(robj, BasicObjectLock::obj_offset_in_bytes()));
1021   testptr(rax, rax);
1022   jcc(Assembler::notZero, unlock);
1023 
1024   pop(state);
1025   if (throw_monitor_exception) {
1026     // Entry already unlocked, need to throw exception
1027     NOT_LP64(empty_FPU_stack();)  // remove possible return value from FPU-stack, otherwise stack could overflow
1028     call_VM(noreg, CAST_FROM_FN_PTR(address,
1029                    InterpreterRuntime::throw_illegal_monitor_state_exception));
1030     should_not_reach_here();
1031   } else {
1032     // Monitor already unlocked during a stack unroll. If requested,
1033     // install an illegal_monitor_state_exception.  Continue with
1034     // stack unrolling.
1035     if (install_monitor_exception) {
1036       NOT_LP64(empty_FPU_stack();)
1037       call_VM(noreg, CAST_FROM_FN_PTR(address,
1038                      InterpreterRuntime::new_illegal_monitor_state_exception));
1039     }
1040     jmp(unlocked);
1041   }
1042 
1043   bind(unlock);
1044   unlock_object(robj);
1045   pop(state);
1046 
1047   // Check that for block-structured locking (i.e., that all locked
1048   // objects has been unlocked)
1049   bind(unlocked);
1050 
1051   // rax, rdx: Might contain return value
1052 
1053   // Check that all monitors are unlocked
1054   {
1055     Label loop, exception, entry, restart;
1056     const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
1057     const Address monitor_block_top(
1058         rbp, frame::interpreter_frame_monitor_block_top_offset * wordSize);
1059     const Address monitor_block_bot(
1060         rbp, frame::interpreter_frame_initial_sp_offset * wordSize);
1061 
1062     bind(restart);
1063     // We use c_rarg1 so that if we go slow path it will be the correct
1064     // register for unlock_object to pass to VM directly
1065     movptr(rmon, monitor_block_top); // points to current entry, starting
1066                                   // with top-most entry
1067     lea(rbx, monitor_block_bot);  // points to word before bottom of
1068                                   // monitor block
1069     jmp(entry);
1070 
1071     // Entry already locked, need to throw exception
1072     bind(exception);
1073 
1074     if (throw_monitor_exception) {
1075       // Throw exception
1076       NOT_LP64(empty_FPU_stack();)
1077       MacroAssembler::call_VM(noreg,
1078                               CAST_FROM_FN_PTR(address, InterpreterRuntime::
1079                                    throw_illegal_monitor_state_exception));
1080       should_not_reach_here();
1081     } else {
1082       // Stack unrolling. Unlock object and install illegal_monitor_exception.
1083       // Unlock does not block, so don&#39;t have to worry about the frame.
1084       // We don&#39;t have to preserve c_rarg1 since we are going to throw an exception.
1085 
1086       push(state);
1087       mov(robj, rmon);   // nop if robj and rmon are the same
1088       unlock_object(robj);
1089       pop(state);
1090 
1091       if (install_monitor_exception) {
1092         NOT_LP64(empty_FPU_stack();)
1093         call_VM(noreg, CAST_FROM_FN_PTR(address,
1094                                         InterpreterRuntime::
1095                                         new_illegal_monitor_state_exception));
1096       }
1097 
1098       jmp(restart);
1099     }
1100 
1101     bind(loop);
1102     // check if current entry is used
1103     cmpptr(Address(rmon, BasicObjectLock::obj_offset_in_bytes()), (int32_t) NULL);
1104     jcc(Assembler::notEqual, exception);
1105 
1106     addptr(rmon, entry_size); // otherwise advance to next entry
1107     bind(entry);
1108     cmpptr(rmon, rbx); // check if bottom reached
1109     jcc(Assembler::notEqual, loop); // if not at bottom then check this entry
1110   }
1111 
1112   bind(no_unlock);
1113 
1114   // jvmti support
1115   if (notify_jvmdi) {
1116     notify_method_exit(state, NotifyJVMTI);    // preserve TOSCA
1117   } else {
1118     notify_method_exit(state, SkipNotifyJVMTI); // preserve TOSCA
1119   }
1120 
1121   // remove activation
1122   // get sender sp
1123   movptr(rbx,
1124          Address(rbp, frame::interpreter_frame_sender_sp_offset * wordSize));
1125   if (StackReservedPages &gt; 0) {
1126     // testing if reserved zone needs to be re-enabled
1127     Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
1128     Label no_reserved_zone_enabling;
1129 
1130     NOT_LP64(get_thread(rthread);)
1131 
1132     cmpl(Address(rthread, JavaThread::stack_guard_state_offset()), JavaThread::stack_guard_enabled);
1133     jcc(Assembler::equal, no_reserved_zone_enabling);
1134 
1135     cmpptr(rbx, Address(rthread, JavaThread::reserved_stack_activation_offset()));
1136     jcc(Assembler::lessEqual, no_reserved_zone_enabling);
1137 
1138     call_VM_leaf(
1139       CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone), rthread);
1140     call_VM(noreg, CAST_FROM_FN_PTR(address,
1141                    InterpreterRuntime::throw_delayed_StackOverflowError));
1142     should_not_reach_here();
1143 
1144     bind(no_reserved_zone_enabling);
1145   }
1146   leave();                           // remove frame anchor
1147   pop(ret_addr);                     // get return address
1148   mov(rsp, rbx);                     // set sp to sender sp
1149 }
1150 
1151 void InterpreterMacroAssembler::get_method_counters(Register method,
1152                                                     Register mcs, Label&amp; skip) {
1153   Label has_counters;
1154   movptr(mcs, Address(method, Method::method_counters_offset()));
1155   testptr(mcs, mcs);
1156   jcc(Assembler::notZero, has_counters);
1157   call_VM(noreg, CAST_FROM_FN_PTR(address,
1158           InterpreterRuntime::build_method_counters), method);
1159   movptr(mcs, Address(method,Method::method_counters_offset()));
1160   testptr(mcs, mcs);
1161   jcc(Assembler::zero, skip); // No MethodCounters allocated, OutOfMemory
1162   bind(has_counters);
1163 }
1164 
1165 
1166 // Lock object
1167 //
1168 // Args:
1169 //      rdx, c_rarg1: BasicObjectLock to be used for locking
1170 //
1171 // Kills:
1172 //      rax, rbx
1173 void InterpreterMacroAssembler::lock_object(Register lock_reg) {
1174   assert(lock_reg == LP64_ONLY(c_rarg1) NOT_LP64(rdx),
1175          &quot;The argument is only for looks. It must be c_rarg1&quot;);
1176 
<a name="1" id="anc1"></a><span class="line-added">1177   TSAN_RUNTIME_ONLY(push_ptr(lock_reg));</span>
1178   if (UseHeavyMonitors) {
1179     call_VM(noreg,
1180             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1181             lock_reg);
1182   } else {
1183     Label done;
1184 
1185     const Register swap_reg = rax; // Must use rax for cmpxchg instruction
1186     const Register tmp_reg = rbx; // Will be passed to biased_locking_enter to avoid a
1187                                   // problematic case where tmp_reg = no_reg.
1188     const Register obj_reg = LP64_ONLY(c_rarg3) NOT_LP64(rcx); // Will contain the oop
1189 
1190     const int obj_offset = BasicObjectLock::obj_offset_in_bytes();
1191     const int lock_offset = BasicObjectLock::lock_offset_in_bytes ();
1192     const int mark_offset = lock_offset +
1193                             BasicLock::displaced_header_offset_in_bytes();
1194 
1195     Label slow_case;
1196 
1197     // Load object pointer into obj_reg
1198     movptr(obj_reg, Address(lock_reg, obj_offset));
1199 
1200     if (UseBiasedLocking) {
1201       biased_locking_enter(lock_reg, obj_reg, swap_reg, tmp_reg, false, done, &amp;slow_case);
1202     }
1203 
1204     // Load immediate 1 into swap_reg %rax
1205     movl(swap_reg, (int32_t)1);
1206 
1207     // Load (object-&gt;mark() | 1) into swap_reg %rax
1208     orptr(swap_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1209 
1210     // Save (object-&gt;mark() | 1) into BasicLock&#39;s displaced header
1211     movptr(Address(lock_reg, mark_offset), swap_reg);
1212 
1213     assert(lock_offset == 0,
1214            &quot;displaced header must be first word in BasicObjectLock&quot;);
1215 
1216     lock();
1217     cmpxchgptr(lock_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1218     if (PrintBiasedLockingStatistics) {
1219       cond_inc32(Assembler::zero,
1220                  ExternalAddress((address) BiasedLocking::fast_path_entry_count_addr()));
1221     }
1222     jcc(Assembler::zero, done);
1223 
1224     const int zero_bits = LP64_ONLY(7) NOT_LP64(3);
1225 
1226     // Test if the oopMark is an obvious stack pointer, i.e.,
1227     //  1) (mark &amp; zero_bits) == 0, and
1228     //  2) rsp &lt;= mark &lt; mark + os::pagesize()
1229     //
1230     // These 3 tests can be done by evaluating the following
1231     // expression: ((mark - rsp) &amp; (zero_bits - os::vm_page_size())),
1232     // assuming both stack pointer and pagesize have their
1233     // least significant bits clear.
1234     // NOTE: the oopMark is in swap_reg %rax as the result of cmpxchg
1235     subptr(swap_reg, rsp);
1236     andptr(swap_reg, zero_bits - os::vm_page_size());
1237 
1238     // Save the test result, for recursive case, the result is zero
1239     movptr(Address(lock_reg, mark_offset), swap_reg);
1240 
1241     if (PrintBiasedLockingStatistics) {
1242       cond_inc32(Assembler::zero,
1243                  ExternalAddress((address) BiasedLocking::fast_path_entry_count_addr()));
1244     }
1245     jcc(Assembler::zero, done);
1246 
1247     bind(slow_case);
1248 
1249     // Call the runtime routine for slow case
1250     call_VM(noreg,
1251             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1252             lock_reg);
1253 
1254     bind(done);
1255   }
<a name="2" id="anc2"></a><span class="line-added">1256 </span>
<span class="line-added">1257   TSAN_RUNTIME_ONLY(</span>
<span class="line-added">1258     pop_ptr(lock_reg);</span>
<span class="line-added">1259     pusha();</span>
<span class="line-added">1260     call_VM(noreg,</span>
<span class="line-added">1261             CAST_FROM_FN_PTR(address, SharedRuntime::tsan_interp_lock),</span>
<span class="line-added">1262             lock_reg);</span>
<span class="line-added">1263     popa();</span>
<span class="line-added">1264   );</span>
1265 }
1266 
1267 
1268 // Unlocks an object. Used in monitorexit bytecode and
1269 // remove_activation.  Throws an IllegalMonitorException if object is
1270 // not locked by current thread.
1271 //
1272 // Args:
1273 //      rdx, c_rarg1: BasicObjectLock for lock
1274 //
1275 // Kills:
1276 //      rax
1277 //      c_rarg0, c_rarg1, c_rarg2, c_rarg3, ... (param regs)
1278 //      rscratch1 (scratch reg)
1279 // rax, rbx, rcx, rdx
1280 void InterpreterMacroAssembler::unlock_object(Register lock_reg) {
1281   assert(lock_reg == LP64_ONLY(c_rarg1) NOT_LP64(rdx),
1282          &quot;The argument is only for looks. It must be c_rarg1&quot;);
1283 
<a name="3" id="anc3"></a><span class="line-added">1284   TSAN_RUNTIME_ONLY(</span>
<span class="line-added">1285     pusha();</span>
<span class="line-added">1286     call_VM(noreg,</span>
<span class="line-added">1287             CAST_FROM_FN_PTR(address, SharedRuntime::tsan_interp_unlock),</span>
<span class="line-added">1288             lock_reg);</span>
<span class="line-added">1289     popa();</span>
<span class="line-added">1290   );</span>
<span class="line-added">1291 </span>
1292   if (UseHeavyMonitors) {
1293     call_VM(noreg,
1294             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
1295             lock_reg);
1296   } else {
1297     Label done;
1298 
1299     const Register swap_reg   = rax;  // Must use rax for cmpxchg instruction
1300     const Register header_reg = LP64_ONLY(c_rarg2) NOT_LP64(rbx);  // Will contain the old oopMark
1301     const Register obj_reg    = LP64_ONLY(c_rarg3) NOT_LP64(rcx);  // Will contain the oop
1302 
1303     save_bcp(); // Save in case of exception
1304 
1305     // Convert from BasicObjectLock structure to object and BasicLock
1306     // structure Store the BasicLock address into %rax
1307     lea(swap_reg, Address(lock_reg, BasicObjectLock::lock_offset_in_bytes()));
1308 
1309     // Load oop into obj_reg(%c_rarg3)
1310     movptr(obj_reg, Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()));
1311 
1312     // Free entry
1313     movptr(Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()), (int32_t)NULL_WORD);
1314 
1315     if (UseBiasedLocking) {
1316       biased_locking_exit(obj_reg, header_reg, done);
1317     }
1318 
1319     // Load the old header from BasicLock structure
1320     movptr(header_reg, Address(swap_reg,
1321                                BasicLock::displaced_header_offset_in_bytes()));
1322 
1323     // Test for recursion
1324     testptr(header_reg, header_reg);
1325 
1326     // zero for recursive case
1327     jcc(Assembler::zero, done);
1328 
1329     // Atomic swap back the old header
1330     lock();
1331     cmpxchgptr(header_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1332 
1333     // zero for simple unlock of a stack-lock case
1334     jcc(Assembler::zero, done);
1335 
1336     // Call the runtime routine for slow case.
1337     movptr(Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()),
1338          obj_reg); // restore obj
1339     call_VM(noreg,
1340             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
1341             lock_reg);
1342 
1343     bind(done);
1344 
1345     restore_bcp();
1346   }
1347 }
1348 
1349 void InterpreterMacroAssembler::test_method_data_pointer(Register mdp,
1350                                                          Label&amp; zero_continue) {
1351   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1352   movptr(mdp, Address(rbp, frame::interpreter_frame_mdp_offset * wordSize));
1353   testptr(mdp, mdp);
1354   jcc(Assembler::zero, zero_continue);
1355 }
1356 
1357 
1358 // Set the method data pointer for the current bcp.
1359 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
1360   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1361   Label set_mdp;
1362   push(rax);
1363   push(rbx);
1364 
1365   get_method(rbx);
1366   // Test MDO to avoid the call if it is NULL.
1367   movptr(rax, Address(rbx, in_bytes(Method::method_data_offset())));
1368   testptr(rax, rax);
1369   jcc(Assembler::zero, set_mdp);
1370   // rbx: method
1371   // _bcp_register: bcp
1372   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), rbx, _bcp_register);
1373   // rax: mdi
1374   // mdo is guaranteed to be non-zero here, we checked for it before the call.
1375   movptr(rbx, Address(rbx, in_bytes(Method::method_data_offset())));
1376   addptr(rbx, in_bytes(MethodData::data_offset()));
1377   addptr(rax, rbx);
1378   bind(set_mdp);
1379   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), rax);
1380   pop(rbx);
1381   pop(rax);
1382 }
1383 
1384 void InterpreterMacroAssembler::verify_method_data_pointer() {
1385   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1386 #ifdef ASSERT
1387   Label verify_continue;
1388   push(rax);
1389   push(rbx);
1390   Register arg3_reg = LP64_ONLY(c_rarg3) NOT_LP64(rcx);
1391   Register arg2_reg = LP64_ONLY(c_rarg2) NOT_LP64(rdx);
1392   push(arg3_reg);
1393   push(arg2_reg);
1394   test_method_data_pointer(arg3_reg, verify_continue); // If mdp is zero, continue
1395   get_method(rbx);
1396 
1397   // If the mdp is valid, it will point to a DataLayout header which is
1398   // consistent with the bcp.  The converse is highly probable also.
1399   load_unsigned_short(arg2_reg,
1400                       Address(arg3_reg, in_bytes(DataLayout::bci_offset())));
1401   addptr(arg2_reg, Address(rbx, Method::const_offset()));
1402   lea(arg2_reg, Address(arg2_reg, ConstMethod::codes_offset()));
1403   cmpptr(arg2_reg, _bcp_register);
1404   jcc(Assembler::equal, verify_continue);
1405   // rbx: method
1406   // _bcp_register: bcp
1407   // c_rarg3: mdp
1408   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp),
1409                rbx, _bcp_register, arg3_reg);
1410   bind(verify_continue);
1411   pop(arg2_reg);
1412   pop(arg3_reg);
1413   pop(rbx);
1414   pop(rax);
1415 #endif // ASSERT
1416 }
1417 
1418 
1419 void InterpreterMacroAssembler::set_mdp_data_at(Register mdp_in,
1420                                                 int constant,
1421                                                 Register value) {
1422   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1423   Address data(mdp_in, constant);
1424   movptr(data, value);
1425 }
1426 
1427 
1428 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1429                                                       int constant,
1430                                                       bool decrement) {
1431   // Counter address
1432   Address data(mdp_in, constant);
1433 
1434   increment_mdp_data_at(data, decrement);
1435 }
1436 
1437 void InterpreterMacroAssembler::increment_mdp_data_at(Address data,
1438                                                       bool decrement) {
1439   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1440   // %%% this does 64bit counters at best it is wasting space
1441   // at worst it is a rare bug when counters overflow
1442 
1443   if (decrement) {
1444     // Decrement the register.  Set condition codes.
1445     addptr(data, (int32_t) -DataLayout::counter_increment);
1446     // If the decrement causes the counter to overflow, stay negative
1447     Label L;
1448     jcc(Assembler::negative, L);
1449     addptr(data, (int32_t) DataLayout::counter_increment);
1450     bind(L);
1451   } else {
1452     assert(DataLayout::counter_increment == 1,
1453            &quot;flow-free idiom only works with 1&quot;);
1454     // Increment the register.  Set carry flag.
1455     addptr(data, DataLayout::counter_increment);
1456     // If the increment causes the counter to overflow, pull back by 1.
1457     sbbptr(data, (int32_t)0);
1458   }
1459 }
1460 
1461 
1462 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1463                                                       Register reg,
1464                                                       int constant,
1465                                                       bool decrement) {
1466   Address data(mdp_in, reg, Address::times_1, constant);
1467 
1468   increment_mdp_data_at(data, decrement);
1469 }
1470 
1471 void InterpreterMacroAssembler::set_mdp_flag_at(Register mdp_in,
1472                                                 int flag_byte_constant) {
1473   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1474   int header_offset = in_bytes(DataLayout::flags_offset());
1475   int header_bits = flag_byte_constant;
1476   // Set the flag
1477   orb(Address(mdp_in, header_offset), header_bits);
1478 }
1479 
1480 
1481 
1482 void InterpreterMacroAssembler::test_mdp_data_at(Register mdp_in,
1483                                                  int offset,
1484                                                  Register value,
1485                                                  Register test_value_out,
1486                                                  Label&amp; not_equal_continue) {
1487   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1488   if (test_value_out == noreg) {
1489     cmpptr(value, Address(mdp_in, offset));
1490   } else {
1491     // Put the test value into a register, so caller can use it:
1492     movptr(test_value_out, Address(mdp_in, offset));
1493     cmpptr(test_value_out, value);
1494   }
1495   jcc(Assembler::notEqual, not_equal_continue);
1496 }
1497 
1498 
1499 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1500                                                      int offset_of_disp) {
1501   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1502   Address disp_address(mdp_in, offset_of_disp);
1503   addptr(mdp_in, disp_address);
1504   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1505 }
1506 
1507 
1508 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1509                                                      Register reg,
1510                                                      int offset_of_disp) {
1511   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1512   Address disp_address(mdp_in, reg, Address::times_1, offset_of_disp);
1513   addptr(mdp_in, disp_address);
1514   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1515 }
1516 
1517 
1518 void InterpreterMacroAssembler::update_mdp_by_constant(Register mdp_in,
1519                                                        int constant) {
1520   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1521   addptr(mdp_in, constant);
1522   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1523 }
1524 
1525 
1526 void InterpreterMacroAssembler::update_mdp_for_ret(Register return_bci) {
1527   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1528   push(return_bci); // save/restore across call_VM
1529   call_VM(noreg,
1530           CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret),
1531           return_bci);
1532   pop(return_bci);
1533 }
1534 
1535 
1536 void InterpreterMacroAssembler::profile_taken_branch(Register mdp,
1537                                                      Register bumped_count) {
1538   if (ProfileInterpreter) {
1539     Label profile_continue;
1540 
1541     // If no method data exists, go to profile_continue.
1542     // Otherwise, assign to mdp
1543     test_method_data_pointer(mdp, profile_continue);
1544 
1545     // We are taking a branch.  Increment the taken count.
1546     // We inline increment_mdp_data_at to return bumped_count in a register
1547     //increment_mdp_data_at(mdp, in_bytes(JumpData::taken_offset()));
1548     Address data(mdp, in_bytes(JumpData::taken_offset()));
1549     movptr(bumped_count, data);
1550     assert(DataLayout::counter_increment == 1,
1551             &quot;flow-free idiom only works with 1&quot;);
1552     addptr(bumped_count, DataLayout::counter_increment);
1553     sbbptr(bumped_count, 0);
1554     movptr(data, bumped_count); // Store back out
1555 
1556     // The method data pointer needs to be updated to reflect the new target.
1557     update_mdp_by_offset(mdp, in_bytes(JumpData::displacement_offset()));
1558     bind(profile_continue);
1559   }
1560 }
1561 
1562 
1563 void InterpreterMacroAssembler::profile_not_taken_branch(Register mdp) {
1564   if (ProfileInterpreter) {
1565     Label profile_continue;
1566 
1567     // If no method data exists, go to profile_continue.
1568     test_method_data_pointer(mdp, profile_continue);
1569 
1570     // We are taking a branch.  Increment the not taken count.
1571     increment_mdp_data_at(mdp, in_bytes(BranchData::not_taken_offset()));
1572 
1573     // The method data pointer needs to be updated to correspond to
1574     // the next bytecode
1575     update_mdp_by_constant(mdp, in_bytes(BranchData::branch_data_size()));
1576     bind(profile_continue);
1577   }
1578 }
1579 
1580 void InterpreterMacroAssembler::profile_call(Register mdp) {
1581   if (ProfileInterpreter) {
1582     Label profile_continue;
1583 
1584     // If no method data exists, go to profile_continue.
1585     test_method_data_pointer(mdp, profile_continue);
1586 
1587     // We are making a call.  Increment the count.
1588     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1589 
1590     // The method data pointer needs to be updated to reflect the new target.
1591     update_mdp_by_constant(mdp, in_bytes(CounterData::counter_data_size()));
1592     bind(profile_continue);
1593   }
1594 }
1595 
1596 
1597 void InterpreterMacroAssembler::profile_final_call(Register mdp) {
1598   if (ProfileInterpreter) {
1599     Label profile_continue;
1600 
1601     // If no method data exists, go to profile_continue.
1602     test_method_data_pointer(mdp, profile_continue);
1603 
1604     // We are making a call.  Increment the count.
1605     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1606 
1607     // The method data pointer needs to be updated to reflect the new target.
1608     update_mdp_by_constant(mdp,
1609                            in_bytes(VirtualCallData::
1610                                     virtual_call_data_size()));
1611     bind(profile_continue);
1612   }
1613 }
1614 
1615 
1616 void InterpreterMacroAssembler::profile_virtual_call(Register receiver,
1617                                                      Register mdp,
1618                                                      Register reg2,
1619                                                      bool receiver_can_be_null) {
1620   if (ProfileInterpreter) {
1621     Label profile_continue;
1622 
1623     // If no method data exists, go to profile_continue.
1624     test_method_data_pointer(mdp, profile_continue);
1625 
1626     Label skip_receiver_profile;
1627     if (receiver_can_be_null) {
1628       Label not_null;
1629       testptr(receiver, receiver);
1630       jccb(Assembler::notZero, not_null);
1631       // We are making a call.  Increment the count for null receiver.
1632       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1633       jmp(skip_receiver_profile);
1634       bind(not_null);
1635     }
1636 
1637     // Record the receiver type.
1638     record_klass_in_profile(receiver, mdp, reg2, true);
1639     bind(skip_receiver_profile);
1640 
1641     // The method data pointer needs to be updated to reflect the new target.
1642 #if INCLUDE_JVMCI
1643     if (MethodProfileWidth == 0) {
1644       update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1645     }
1646 #else // INCLUDE_JVMCI
1647     update_mdp_by_constant(mdp,
1648                            in_bytes(VirtualCallData::
1649                                     virtual_call_data_size()));
1650 #endif // INCLUDE_JVMCI
1651     bind(profile_continue);
1652   }
1653 }
1654 
1655 #if INCLUDE_JVMCI
1656 void InterpreterMacroAssembler::profile_called_method(Register method, Register mdp, Register reg2) {
1657   assert_different_registers(method, mdp, reg2);
1658   if (ProfileInterpreter &amp;&amp; MethodProfileWidth &gt; 0) {
1659     Label profile_continue;
1660 
1661     // If no method data exists, go to profile_continue.
1662     test_method_data_pointer(mdp, profile_continue);
1663 
1664     Label done;
1665     record_item_in_profile_helper(method, mdp, reg2, 0, done, MethodProfileWidth,
1666       &amp;VirtualCallData::method_offset, &amp;VirtualCallData::method_count_offset, in_bytes(VirtualCallData::nonprofiled_receiver_count_offset()));
1667     bind(done);
1668 
1669     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1670     bind(profile_continue);
1671   }
1672 }
1673 #endif // INCLUDE_JVMCI
1674 
1675 // This routine creates a state machine for updating the multi-row
1676 // type profile at a virtual call site (or other type-sensitive bytecode).
1677 // The machine visits each row (of receiver/count) until the receiver type
1678 // is found, or until it runs out of rows.  At the same time, it remembers
1679 // the location of the first empty row.  (An empty row records null for its
1680 // receiver, and can be allocated for a newly-observed receiver type.)
1681 // Because there are two degrees of freedom in the state, a simple linear
1682 // search will not work; it must be a decision tree.  Hence this helper
1683 // function is recursive, to generate the required tree structured code.
1684 // It&#39;s the interpreter, so we are trading off code space for speed.
1685 // See below for example code.
1686 void InterpreterMacroAssembler::record_klass_in_profile_helper(
1687                                         Register receiver, Register mdp,
1688                                         Register reg2, int start_row,
1689                                         Label&amp; done, bool is_virtual_call) {
1690   if (TypeProfileWidth == 0) {
1691     if (is_virtual_call) {
1692       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1693     }
1694 #if INCLUDE_JVMCI
1695     else if (EnableJVMCI) {
1696       increment_mdp_data_at(mdp, in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset()));
1697     }
1698 #endif // INCLUDE_JVMCI
1699   } else {
1700     int non_profiled_offset = -1;
1701     if (is_virtual_call) {
1702       non_profiled_offset = in_bytes(CounterData::count_offset());
1703     }
1704 #if INCLUDE_JVMCI
1705     else if (EnableJVMCI) {
1706       non_profiled_offset = in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset());
1707     }
1708 #endif // INCLUDE_JVMCI
1709 
1710     record_item_in_profile_helper(receiver, mdp, reg2, 0, done, TypeProfileWidth,
1711         &amp;VirtualCallData::receiver_offset, &amp;VirtualCallData::receiver_count_offset, non_profiled_offset);
1712   }
1713 }
1714 
1715 void InterpreterMacroAssembler::record_item_in_profile_helper(Register item, Register mdp,
1716                                         Register reg2, int start_row, Label&amp; done, int total_rows,
1717                                         OffsetFunction item_offset_fn, OffsetFunction item_count_offset_fn,
1718                                         int non_profiled_offset) {
1719   int last_row = total_rows - 1;
1720   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1721   // Test this row for both the item and for null.
1722   // Take any of three different outcomes:
1723   //   1. found item =&gt; increment count and goto done
1724   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1725   //   3. found something else =&gt; keep looking for cases 1 and 2
1726   // Case 3 is handled by a recursive call.
1727   for (int row = start_row; row &lt;= last_row; row++) {
1728     Label next_test;
1729     bool test_for_null_also = (row == start_row);
1730 
1731     // See if the item is item[n].
1732     int item_offset = in_bytes(item_offset_fn(row));
1733     test_mdp_data_at(mdp, item_offset, item,
1734                      (test_for_null_also ? reg2 : noreg),
1735                      next_test);
1736     // (Reg2 now contains the item from the CallData.)
1737 
1738     // The item is item[n].  Increment count[n].
1739     int count_offset = in_bytes(item_count_offset_fn(row));
1740     increment_mdp_data_at(mdp, count_offset);
1741     jmp(done);
1742     bind(next_test);
1743 
1744     if (test_for_null_also) {
1745       // Failed the equality check on item[n]...  Test for null.
1746       testptr(reg2, reg2);
1747       if (start_row == last_row) {
1748         // The only thing left to do is handle the null case.
1749         if (non_profiled_offset &gt;= 0) {
1750           Label found_null;
1751           jccb(Assembler::zero, found_null);
1752           // Item did not match any saved item and there is no empty row for it.
1753           // Increment total counter to indicate polymorphic case.
1754           increment_mdp_data_at(mdp, non_profiled_offset);
1755           jmp(done);
1756           bind(found_null);
1757         } else {
1758           jcc(Assembler::notZero, done);
1759         }
1760         break;
1761       }
1762       Label found_null;
1763       // Since null is rare, make it be the branch-taken case.
1764       jcc(Assembler::zero, found_null);
1765 
1766       // Put all the &quot;Case 3&quot; tests here.
1767       record_item_in_profile_helper(item, mdp, reg2, start_row + 1, done, total_rows,
1768         item_offset_fn, item_count_offset_fn, non_profiled_offset);
1769 
1770       // Found a null.  Keep searching for a matching item,
1771       // but remember that this is an empty (unused) slot.
1772       bind(found_null);
1773     }
1774   }
1775 
1776   // In the fall-through case, we found no matching item, but we
1777   // observed the item[start_row] is NULL.
1778 
1779   // Fill in the item field and increment the count.
1780   int item_offset = in_bytes(item_offset_fn(start_row));
1781   set_mdp_data_at(mdp, item_offset, item);
1782   int count_offset = in_bytes(item_count_offset_fn(start_row));
1783   movl(reg2, DataLayout::counter_increment);
1784   set_mdp_data_at(mdp, count_offset, reg2);
1785   if (start_row &gt; 0) {
1786     jmp(done);
1787   }
1788 }
1789 
1790 // Example state machine code for three profile rows:
1791 //   // main copy of decision tree, rooted at row[1]
1792 //   if (row[0].rec == rec) { row[0].incr(); goto done; }
1793 //   if (row[0].rec != NULL) {
1794 //     // inner copy of decision tree, rooted at row[1]
1795 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1796 //     if (row[1].rec != NULL) {
1797 //       // degenerate decision tree, rooted at row[2]
1798 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1799 //       if (row[2].rec != NULL) { count.incr(); goto done; } // overflow
1800 //       row[2].init(rec); goto done;
1801 //     } else {
1802 //       // remember row[1] is empty
1803 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1804 //       row[1].init(rec); goto done;
1805 //     }
1806 //   } else {
1807 //     // remember row[0] is empty
1808 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1809 //     if (row[2].rec == rec) { row[2].incr(); goto done; }
1810 //     row[0].init(rec); goto done;
1811 //   }
1812 //   done:
1813 
1814 void InterpreterMacroAssembler::record_klass_in_profile(Register receiver,
1815                                                         Register mdp, Register reg2,
1816                                                         bool is_virtual_call) {
1817   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1818   Label done;
1819 
1820   record_klass_in_profile_helper(receiver, mdp, reg2, 0, done, is_virtual_call);
1821 
1822   bind (done);
1823 }
1824 
1825 void InterpreterMacroAssembler::profile_ret(Register return_bci,
1826                                             Register mdp) {
1827   if (ProfileInterpreter) {
1828     Label profile_continue;
1829     uint row;
1830 
1831     // If no method data exists, go to profile_continue.
1832     test_method_data_pointer(mdp, profile_continue);
1833 
1834     // Update the total ret count.
1835     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1836 
1837     for (row = 0; row &lt; RetData::row_limit(); row++) {
1838       Label next_test;
1839 
1840       // See if return_bci is equal to bci[n]:
1841       test_mdp_data_at(mdp,
1842                        in_bytes(RetData::bci_offset(row)),
1843                        return_bci, noreg,
1844                        next_test);
1845 
1846       // return_bci is equal to bci[n].  Increment the count.
1847       increment_mdp_data_at(mdp, in_bytes(RetData::bci_count_offset(row)));
1848 
1849       // The method data pointer needs to be updated to reflect the new target.
1850       update_mdp_by_offset(mdp,
1851                            in_bytes(RetData::bci_displacement_offset(row)));
1852       jmp(profile_continue);
1853       bind(next_test);
1854     }
1855 
1856     update_mdp_for_ret(return_bci);
1857 
1858     bind(profile_continue);
1859   }
1860 }
1861 
1862 
1863 void InterpreterMacroAssembler::profile_null_seen(Register mdp) {
1864   if (ProfileInterpreter) {
1865     Label profile_continue;
1866 
1867     // If no method data exists, go to profile_continue.
1868     test_method_data_pointer(mdp, profile_continue);
1869 
1870     set_mdp_flag_at(mdp, BitData::null_seen_byte_constant());
1871 
1872     // The method data pointer needs to be updated.
1873     int mdp_delta = in_bytes(BitData::bit_data_size());
1874     if (TypeProfileCasts) {
1875       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1876     }
1877     update_mdp_by_constant(mdp, mdp_delta);
1878 
1879     bind(profile_continue);
1880   }
1881 }
1882 
1883 
1884 void InterpreterMacroAssembler::profile_typecheck_failed(Register mdp) {
1885   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1886     Label profile_continue;
1887 
1888     // If no method data exists, go to profile_continue.
1889     test_method_data_pointer(mdp, profile_continue);
1890 
1891     int count_offset = in_bytes(CounterData::count_offset());
1892     // Back up the address, since we have already bumped the mdp.
1893     count_offset -= in_bytes(VirtualCallData::virtual_call_data_size());
1894 
1895     // *Decrement* the counter.  We expect to see zero or small negatives.
1896     increment_mdp_data_at(mdp, count_offset, true);
1897 
1898     bind (profile_continue);
1899   }
1900 }
1901 
1902 
1903 void InterpreterMacroAssembler::profile_typecheck(Register mdp, Register klass, Register reg2) {
1904   if (ProfileInterpreter) {
1905     Label profile_continue;
1906 
1907     // If no method data exists, go to profile_continue.
1908     test_method_data_pointer(mdp, profile_continue);
1909 
1910     // The method data pointer needs to be updated.
1911     int mdp_delta = in_bytes(BitData::bit_data_size());
1912     if (TypeProfileCasts) {
1913       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1914 
1915       // Record the object type.
1916       record_klass_in_profile(klass, mdp, reg2, false);
1917       NOT_LP64(assert(reg2 == rdi, &quot;we know how to fix this blown reg&quot;);)
1918       NOT_LP64(restore_locals();)         // Restore EDI
1919     }
1920     update_mdp_by_constant(mdp, mdp_delta);
1921 
1922     bind(profile_continue);
1923   }
1924 }
1925 
1926 
1927 void InterpreterMacroAssembler::profile_switch_default(Register mdp) {
1928   if (ProfileInterpreter) {
1929     Label profile_continue;
1930 
1931     // If no method data exists, go to profile_continue.
1932     test_method_data_pointer(mdp, profile_continue);
1933 
1934     // Update the default case count
1935     increment_mdp_data_at(mdp,
1936                           in_bytes(MultiBranchData::default_count_offset()));
1937 
1938     // The method data pointer needs to be updated.
1939     update_mdp_by_offset(mdp,
1940                          in_bytes(MultiBranchData::
1941                                   default_displacement_offset()));
1942 
1943     bind(profile_continue);
1944   }
1945 }
1946 
1947 
1948 void InterpreterMacroAssembler::profile_switch_case(Register index,
1949                                                     Register mdp,
1950                                                     Register reg2) {
1951   if (ProfileInterpreter) {
1952     Label profile_continue;
1953 
1954     // If no method data exists, go to profile_continue.
1955     test_method_data_pointer(mdp, profile_continue);
1956 
1957     // Build the base (index * per_case_size_in_bytes()) +
1958     // case_array_offset_in_bytes()
1959     movl(reg2, in_bytes(MultiBranchData::per_case_size()));
1960     imulptr(index, reg2); // XXX l ?
1961     addptr(index, in_bytes(MultiBranchData::case_array_offset())); // XXX l ?
1962 
1963     // Update the case count
1964     increment_mdp_data_at(mdp,
1965                           index,
1966                           in_bytes(MultiBranchData::relative_count_offset()));
1967 
1968     // The method data pointer needs to be updated.
1969     update_mdp_by_offset(mdp,
1970                          index,
1971                          in_bytes(MultiBranchData::
1972                                   relative_displacement_offset()));
1973 
1974     bind(profile_continue);
1975   }
1976 }
1977 
1978 
1979 
1980 void InterpreterMacroAssembler::verify_oop(Register reg, TosState state) {
1981   if (state == atos) {
1982     MacroAssembler::verify_oop(reg);
1983   }
1984 }
1985 
1986 void InterpreterMacroAssembler::verify_FPU(int stack_depth, TosState state) {
1987 #ifndef _LP64
1988   if ((state == ftos &amp;&amp; UseSSE &lt; 1) ||
1989       (state == dtos &amp;&amp; UseSSE &lt; 2)) {
1990     MacroAssembler::verify_FPU(stack_depth);
1991   }
1992 #endif
1993 }
1994 
1995 // Jump if ((*counter_addr += increment) &amp; mask) satisfies the condition.
1996 void InterpreterMacroAssembler::increment_mask_and_jump(Address counter_addr,
1997                                                         int increment, Address mask,
1998                                                         Register scratch, bool preloaded,
1999                                                         Condition cond, Label* where) {
2000   if (!preloaded) {
2001     movl(scratch, counter_addr);
2002   }
2003   incrementl(scratch, increment);
2004   movl(counter_addr, scratch);
2005   andl(scratch, mask);
2006   if (where != NULL) {
2007     jcc(cond, *where);
2008   }
2009 }
2010 
2011 void InterpreterMacroAssembler::notify_method_entry() {
2012   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
2013   // track stack depth.  If it is possible to enter interp_only_mode we add
2014   // the code to check if the event should be sent.
2015   Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
2016   Register rarg = LP64_ONLY(c_rarg1) NOT_LP64(rbx);
2017   if (JvmtiExport::can_post_interpreter_events()) {
2018     Label L;
2019     NOT_LP64(get_thread(rthread);)
2020     movl(rdx, Address(rthread, JavaThread::interp_only_mode_offset()));
2021     testl(rdx, rdx);
2022     jcc(Assembler::zero, L);
2023     call_VM(noreg, CAST_FROM_FN_PTR(address,
2024                                     InterpreterRuntime::post_method_entry));
2025     bind(L);
2026   }
2027 
2028   {
2029     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2030     NOT_LP64(get_thread(rthread);)
2031     get_method(rarg);
2032     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_entry),
2033                  rthread, rarg);
2034   }
2035 
<a name="4" id="anc4"></a><span class="line-added">2036   TSAN_RUNTIME_ONLY(call_VM(noreg,</span>
<span class="line-added">2037                             CAST_FROM_FN_PTR(address,</span>
<span class="line-added">2038                                              SharedRuntime::tsan_interp_method_entry)));</span>
<span class="line-added">2039 </span>
2040   // RedefineClasses() tracing support for obsolete method entry
2041   if (log_is_enabled(Trace, redefine, class, obsolete)) {
2042     NOT_LP64(get_thread(rthread);)
2043     get_method(rarg);
2044     call_VM_leaf(
2045       CAST_FROM_FN_PTR(address, SharedRuntime::rc_trace_method_entry),
2046       rthread, rarg);
2047   }
2048 }
2049 
2050 
2051 void InterpreterMacroAssembler::notify_method_exit(
2052     TosState state, NotifyMethodExitMode mode) {
2053   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
2054   // track stack depth.  If it is possible to enter interp_only_mode we add
2055   // the code to check if the event should be sent.
2056   Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
2057   Register rarg = LP64_ONLY(c_rarg1) NOT_LP64(rbx);
2058   if (mode == NotifyJVMTI &amp;&amp; JvmtiExport::can_post_interpreter_events()) {
2059     Label L;
2060     // Note: frame::interpreter_frame_result has a dependency on how the
2061     // method result is saved across the call to post_method_exit. If this
2062     // is changed then the interpreter_frame_result implementation will
2063     // need to be updated too.
2064 
2065     // template interpreter will leave the result on the top of the stack.
2066     push(state);
2067     NOT_LP64(get_thread(rthread);)
2068     movl(rdx, Address(rthread, JavaThread::interp_only_mode_offset()));
2069     testl(rdx, rdx);
2070     jcc(Assembler::zero, L);
2071     call_VM(noreg,
2072             CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
2073     bind(L);
2074     pop(state);
2075   }
2076 
<a name="5" id="anc5"></a><span class="line-added">2077   TSAN_RUNTIME_ONLY(</span>
<span class="line-added">2078     push(state);</span>
<span class="line-added">2079     call_VM_leaf(CAST_FROM_FN_PTR(address,</span>
<span class="line-added">2080                                   SharedRuntime::tsan_interp_method_exit));</span>
<span class="line-added">2081     pop(state);</span>
<span class="line-added">2082   );</span>
<span class="line-added">2083 </span>
2084   {
2085     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2086     push(state);
2087     NOT_LP64(get_thread(rthread);)
2088     get_method(rarg);
2089     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit),
2090                  rthread, rarg);
2091     pop(state);
2092   }
2093 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>