<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.security.sasl/share/classes/javax/security/sasl/Sasl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package javax.security.sasl;
 27 
 28 import javax.security.auth.callback.CallbackHandler;
<a name="2" id="anc2"></a><span class="line-modified"> 29 import java.security.AccessController;</span>
<span class="line-added"> 30 import java.security.PrivilegedAction;</span>
<span class="line-added"> 31 import java.util.ArrayList;</span>
 32 import java.util.Enumeration;
 33 import java.util.Iterator;
<a name="3" id="anc3"></a><span class="line-added"> 34 import java.util.List;</span>
 35 import java.util.Map;
 36 import java.util.Set;
 37 import java.util.HashSet;
 38 import java.util.Collections;
 39 import java.security.InvalidParameterException;
 40 import java.security.NoSuchAlgorithmException;
 41 import java.security.Provider;
 42 import java.security.Provider.Service;
 43 import java.security.Security;
<a name="4" id="anc4"></a><span class="line-added"> 44 import java.util.logging.Level;</span>
<span class="line-added"> 45 import java.util.logging.Logger;</span>
 46 
 47 /**
 48  * A static class for creating SASL clients and servers.
 49  *&lt;p&gt;
 50  * This class defines the policy of how to locate, load, and instantiate
 51  * SASL clients and servers.
 52  *&lt;p&gt;
 53  * For example, an application or library gets a SASL client by doing
 54  * something like:
 55  *&lt;blockquote&gt;&lt;pre&gt;
 56  * SaslClient sc = Sasl.createSaslClient(mechanisms,
 57  *     authorizationId, protocol, serverName, props, callbackHandler);
 58  *&lt;/pre&gt;&lt;/blockquote&gt;
 59  * It can then proceed to use the instance to create an authentication connection.
 60  *&lt;p&gt;
 61  * Similarly, a server gets a SASL server by using code that looks as follows:
 62  *&lt;blockquote&gt;&lt;pre&gt;
 63  * SaslServer ss = Sasl.createSaslServer(mechanism,
 64  *     protocol, serverName, props, callbackHandler);
 65  *&lt;/pre&gt;&lt;/blockquote&gt;
 66  *
 67  * @since 1.5
 68  *
 69  * @author Rosanna Lee
 70  * @author Rob Weltman
 71  */
 72 public class Sasl {
<a name="5" id="anc5"></a><span class="line-added"> 73 </span>
<span class="line-added"> 74     private static List&lt;String&gt; disabledMechanisms = new ArrayList&lt;&gt;();</span>
<span class="line-added"> 75 </span>
<span class="line-added"> 76     static {</span>
<span class="line-added"> 77         String prop = AccessController.doPrivileged(</span>
<span class="line-added"> 78                 (PrivilegedAction&lt;String&gt;)</span>
<span class="line-added"> 79                 () -&gt; Security.getProperty(&quot;jdk.sasl.disabledMechanisms&quot;));</span>
<span class="line-added"> 80 </span>
<span class="line-added"> 81         if (prop != null) {</span>
<span class="line-added"> 82             for (String s : prop.split(&quot;\\s*,\\s*&quot;)) {</span>
<span class="line-added"> 83                 if (!s.isEmpty()) {</span>
<span class="line-added"> 84                     disabledMechanisms.add(s);</span>
<span class="line-added"> 85                 }</span>
<span class="line-added"> 86             }</span>
<span class="line-added"> 87         }</span>
<span class="line-added"> 88     }</span>
<span class="line-added"> 89 </span>
<span class="line-added"> 90     private static final String SASL_LOGGER_NAME = &quot;javax.security.sasl&quot;;</span>
<span class="line-added"> 91 </span>
<span class="line-added"> 92     /**</span>
<span class="line-added"> 93      * Logger for debug messages</span>
<span class="line-added"> 94      */</span>
<span class="line-added"> 95     private static final Logger logger = Logger.getLogger(SASL_LOGGER_NAME);</span>
<span class="line-added"> 96 </span>
 97     // Cannot create one of these
 98     private Sasl() {
 99     }
100 
101     /**
102      * The name of a property that specifies the quality-of-protection to use.
103      * The property contains a comma-separated, ordered list
104      * of quality-of-protection values that the
105      * client or server is willing to support.  A qop value is one of
106      * &lt;ul&gt;
107      * &lt;li&gt;{@code &quot;auth&quot;} - authentication only&lt;/li&gt;
108      * &lt;li&gt;{@code &quot;auth-int&quot;} - authentication plus integrity protection&lt;/li&gt;
109      * &lt;li&gt;{@code &quot;auth-conf&quot;} - authentication plus integrity and confidentiality
110      * protection&lt;/li&gt;
111      * &lt;/ul&gt;
112      *
113      * The order of the list specifies the preference order of the client or
114      * server. If this property is absent, the default qop is {@code &quot;auth&quot;}.
115      * The value of this constant is {@code &quot;javax.security.sasl.qop&quot;}.
116      */
117     public static final String QOP = &quot;javax.security.sasl.qop&quot;;
118 
119     /**
120      * The name of a property that specifies the cipher strength to use.
121      * The property contains a comma-separated, ordered list
122      * of cipher strength values that
123      * the client or server is willing to support. A strength value is one of
124      * &lt;ul&gt;
125      * &lt;li&gt;{@code &quot;low&quot;}&lt;/li&gt;
126      * &lt;li&gt;{@code &quot;medium&quot;}&lt;/li&gt;
127      * &lt;li&gt;{@code &quot;high&quot;}&lt;/li&gt;
128      * &lt;/ul&gt;
129      * The order of the list specifies the preference order of the client or
130      * server.  An implementation should allow configuration of the meaning
131      * of these values.  An application may use the Java Cryptography
132      * Extension (JCE) with JCE-aware mechanisms to control the selection of
133      * cipher suites that match the strength values.
134      * &lt;BR&gt;
135      * If this property is absent, the default strength is
136      * {@code &quot;high,medium,low&quot;}.
137      * The value of this constant is {@code &quot;javax.security.sasl.strength&quot;}.
138      */
139     public static final String STRENGTH = &quot;javax.security.sasl.strength&quot;;
140 
141     /**
142      * The name of a property that specifies whether the
143      * server must authenticate to the client. The property contains
144      * {@code &quot;true&quot;} if the server must
145      * authenticate the to client; {@code &quot;false&quot;} otherwise.
146      * The default is {@code &quot;false&quot;}.
147      * &lt;br&gt;The value of this constant is
148      * {@code &quot;javax.security.sasl.server.authentication&quot;}.
149      */
150     public static final String SERVER_AUTH =
151     &quot;javax.security.sasl.server.authentication&quot;;
152 
153     /**
154      * The name of a property that specifies the bound server name for
155      * an unbound server. A server is created as an unbound server by setting
156      * the {@code serverName} argument in {@link #createSaslServer} as null.
157      * The property contains the bound host name after the authentication
158      * exchange has completed. It is only available on the server side.
159      * &lt;br&gt;The value of this constant is
160      * {@code &quot;javax.security.sasl.bound.server.name&quot;}.
161      */
162     public static final String BOUND_SERVER_NAME =
163     &quot;javax.security.sasl.bound.server.name&quot;;
164 
165     /**
166      * The name of a property that specifies the maximum size of the receive
167      * buffer in bytes of {@code SaslClient}/{@code SaslServer}.
168      * The property contains the string representation of an integer.
169      * &lt;br&gt;If this property is absent, the default size
170      * is defined by the mechanism.
171      * &lt;br&gt;The value of this constant is {@code &quot;javax.security.sasl.maxbuffer&quot;}.
172      */
173     public static final String MAX_BUFFER = &quot;javax.security.sasl.maxbuffer&quot;;
174 
175     /**
176      * The name of a property that specifies the maximum size of the raw send
177      * buffer in bytes of {@code SaslClient}/{@code SaslServer}.
178      * The property contains the string representation of an integer.
179      * The value of this property is negotiated between the client and server
180      * during the authentication exchange.
181      * &lt;br&gt;The value of this constant is {@code &quot;javax.security.sasl.rawsendsize&quot;}.
182      */
183     public static final String RAW_SEND_SIZE = &quot;javax.security.sasl.rawsendsize&quot;;
184 
185     /**
186      * The name of a property that specifies whether to reuse previously
187      * authenticated session information. The property contains &quot;true&quot; if the
188      * mechanism implementation may attempt to reuse previously authenticated
189      * session information; it contains &quot;false&quot; if the implementation must
190      * not reuse previously authenticated session information.  A setting of
191      * &quot;true&quot; serves only as a hint: it does not necessarily entail actual
192      * reuse because reuse might not be possible due to a number of reasons,
193      * including, but not limited to, lack of mechanism support for reuse,
194      * expiration of reusable information, and the peer&#39;s refusal to support
195      * reuse.
196      *
197      * The property&#39;s default value is &quot;false&quot;.  The value of this constant
198      * is &quot;javax.security.sasl.reuse&quot;.
199      *
200      * Note that all other parameters and properties required to create a
201      * SASL client/server instance must be provided regardless of whether
202      * this property has been supplied. That is, you cannot supply any less
203      * information in anticipation of reuse.
204      *
205      * Mechanism implementations that support reuse might allow customization
206      * of its implementation, for factors such as cache size, timeouts, and
207      * criteria for reusability. Such customizations are
208      * implementation-dependent.
209      */
210      public static final String REUSE = &quot;javax.security.sasl.reuse&quot;;
211 
212     /**
213      * The name of a property that specifies
214      * whether mechanisms susceptible to simple plain passive attacks (e.g.,
215      * &quot;PLAIN&quot;) are not permitted. The property
216      * contains {@code &quot;true&quot;} if such mechanisms are not permitted;
217      * {@code &quot;false&quot;} if such mechanisms are permitted.
218      * The default is {@code &quot;false&quot;}.
219      * &lt;br&gt;The value of this constant is
220      * {@code &quot;javax.security.sasl.policy.noplaintext&quot;}.
221      */
222     public static final String POLICY_NOPLAINTEXT =
223     &quot;javax.security.sasl.policy.noplaintext&quot;;
224 
225     /**
226      * The name of a property that specifies whether
227      * mechanisms susceptible to active (non-dictionary) attacks
228      * are not permitted.
229      * The property contains {@code &quot;true&quot;}
230      * if mechanisms susceptible to active attacks
231      * are not permitted; {@code &quot;false&quot;} if such mechanisms are permitted.
232      * The default is {@code &quot;false&quot;}.
233      * &lt;br&gt;The value of this constant is
234      * {@code &quot;javax.security.sasl.policy.noactive&quot;}.
235      */
236     public static final String POLICY_NOACTIVE =
237     &quot;javax.security.sasl.policy.noactive&quot;;
238 
239     /**
240      * The name of a property that specifies whether
241      * mechanisms susceptible to passive dictionary attacks are not permitted.
242      * The property contains {@code &quot;true&quot;}
243      * if mechanisms susceptible to dictionary attacks are not permitted;
244      * {@code &quot;false&quot;} if such mechanisms are permitted.
245      * The default is {@code &quot;false&quot;}.
246      *&lt;br&gt;
247      * The value of this constant is
248      * {@code &quot;javax.security.sasl.policy.nodictionary&quot;}.
249      */
250     public static final String POLICY_NODICTIONARY =
251     &quot;javax.security.sasl.policy.nodictionary&quot;;
252 
253     /**
254      * The name of a property that specifies whether mechanisms that accept
255      * anonymous login are not permitted. The property contains {@code &quot;true&quot;}
256      * if mechanisms that accept anonymous login are not permitted;
257      * {@code &quot;false&quot;}
258      * if such mechanisms are permitted. The default is {@code &quot;false&quot;}.
259      *&lt;br&gt;
260      * The value of this constant is
261      * {@code &quot;javax.security.sasl.policy.noanonymous&quot;}.
262      */
263     public static final String POLICY_NOANONYMOUS =
264     &quot;javax.security.sasl.policy.noanonymous&quot;;
265 
266      /**
267       * The name of a property that specifies whether mechanisms that implement
268       * forward secrecy between sessions are required. Forward secrecy
269       * means that breaking into one session will not automatically
270       * provide information for breaking into future sessions.
271       * The property
272       * contains {@code &quot;true&quot;} if mechanisms that implement forward secrecy
273       * between sessions are required; {@code &quot;false&quot;} if such mechanisms
274       * are not required. The default is {@code &quot;false&quot;}.
275       *&lt;br&gt;
276       * The value of this constant is
277       * {@code &quot;javax.security.sasl.policy.forward&quot;}.
278       */
279     public static final String POLICY_FORWARD_SECRECY =
280     &quot;javax.security.sasl.policy.forward&quot;;
281 
282     /**
283      * The name of a property that specifies whether
284      * mechanisms that pass client credentials are required. The property
285      * contains {@code &quot;true&quot;} if mechanisms that pass
286      * client credentials are required; {@code &quot;false&quot;}
287      * if such mechanisms are not required. The default is {@code &quot;false&quot;}.
288      *&lt;br&gt;
289      * The value of this constant is
290      * {@code &quot;javax.security.sasl.policy.credentials&quot;}.
291      */
292     public static final String POLICY_PASS_CREDENTIALS =
293     &quot;javax.security.sasl.policy.credentials&quot;;
294 
295     /**
296      * The name of a property that specifies the credentials to use.
297      * The property contains a mechanism-specific Java credential object.
298      * Mechanism implementations may examine the value of this property
299      * to determine whether it is a class that they support.
300      * The property may be used to supply credentials to a mechanism that
301      * supports delegated authentication.
302      *&lt;br&gt;
303      * The value of this constant is
304      * {@code &quot;javax.security.sasl.credentials&quot;}.
305      */
306     public static final String CREDENTIALS = &quot;javax.security.sasl.credentials&quot;;
307 
308     /**
309      * Creates a {@code SaslClient} using the parameters supplied.
310      *
311      * This method uses the
312      * {@extLink security_guide_jca JCA Security Provider Framework},
313      * described in the
314      * &quot;Java Cryptography Architecture (JCA) Reference Guide&quot;, for
315      * locating and selecting a {@code SaslClient} implementation.
316      *
317      * First, it
318      * obtains an ordered list of {@code SaslClientFactory} instances from
319      * the registered security providers for the &quot;SaslClientFactory&quot; service
320      * and the specified SASL mechanism(s). It then invokes
321      * {@code createSaslClient()} on each factory instance on the list
322      * until one produces a non-null {@code SaslClient} instance. It returns
323      * the non-null {@code SaslClient} instance, or null if the search fails
324      * to produce a non-null {@code SaslClient} instance.
325      *&lt;p&gt;
326      * A security provider for SaslClientFactory registers with the
327      * JCA Security Provider Framework keys of the form &lt;br&gt;
328      * {@code SaslClientFactory.}&lt;em&gt;{@code mechanism_name}&lt;/em&gt;
329      * &lt;br&gt;
330      * and values that are class names of implementations of
331      * {@code javax.security.sasl.SaslClientFactory}.
332      *
333      * For example, a provider that contains a factory class,
334      * {@code com.wiz.sasl.digest.ClientFactory}, that supports the
335      * &quot;DIGEST-MD5&quot; mechanism would register the following entry with the JCA:
336      * {@code SaslClientFactory.DIGEST-MD5 com.wiz.sasl.digest.ClientFactory}
337      *&lt;p&gt;
338      * See the
339      * &quot;Java Cryptography Architecture API Specification &amp;amp; Reference&quot;
340      * for information about how to install and configure security service
341      *  providers.
342      *
343      * @implNote
344      * The JDK Reference Implementation additionally uses the
345      * {@code jdk.security.provider.preferred}
346      * {@link Security#getProperty(String) Security} property to determine
347      * the preferred provider order for the specified algorithm. This
348      * may be different than the order of providers returned by
349      * {@link Security#getProviders() Security.getProviders()}.
<a name="6" id="anc6"></a><span class="line-added">350      * &lt;p&gt;</span>
<span class="line-added">351      * If a mechanism is listed in the {@code jdk.sasl.disabledMechanisms}</span>
<span class="line-added">352      * security property, it will be ignored and won&#39;t be negotiated.</span>
353      *
354      * @param mechanisms The non-null list of mechanism names to try. Each is the
355      * IANA-registered name of a SASL mechanism. (e.g. &quot;GSSAPI&quot;, &quot;CRAM-MD5&quot;).
356      * @param authorizationId The possibly null protocol-dependent
357      * identification to be used for authorization.
358      * If null or empty, the server derives an authorization
359      * ID from the client&#39;s authentication credentials.
360      * When the SASL authentication completes successfully,
361      * the specified entity is granted access.
362      *
363      * @param protocol The non-null string name of the protocol for which
364      * the authentication is being performed (e.g., &quot;ldap&quot;).
365      *
366      * @param serverName The non-null fully-qualified host name of the server
367      * to authenticate to.
368      *
369      * @param props The possibly null set of properties used to
370      * select the SASL mechanism and to configure the authentication
371      * exchange of the selected mechanism.
372      * For example, if {@code props} contains the
373      * {@code Sasl.POLICY_NOPLAINTEXT} property with the value
374      * {@code &quot;true&quot;}, then the selected
375      * SASL mechanism must not be susceptible to simple plain passive attacks.
376      * In addition to the standard properties declared in this class,
377      * other, possibly mechanism-specific, properties can be included.
378      * Properties not relevant to the selected mechanism are ignored,
379      * including any map entries with non-String keys.
380      *
381      * @param cbh The possibly null callback handler to used by the SASL
382      * mechanisms to get further information from the application/library
383      * to complete the authentication. For example, a SASL mechanism might
384      * require the authentication ID, password and realm from the caller.
385      * The authentication ID is requested by using a {@code NameCallback}.
386      * The password is requested by using a {@code PasswordCallback}.
387      * The realm is requested by using a {@code RealmChoiceCallback} if there is a list
388      * of realms to choose from, and by using a {@code RealmCallback} if
389      * the realm must be entered.
390      *
391      *@return A possibly null {@code SaslClient} created using the parameters
392      * supplied. If null, cannot find a {@code SaslClientFactory}
393      * that will produce one.
394      *@exception SaslException If cannot create a {@code SaslClient} because
395      * of an error.
396      */
397     public static SaslClient createSaslClient(
398         String[] mechanisms,
399         String authorizationId,
400         String protocol,
401         String serverName,
402         Map&lt;String,?&gt; props,
403         CallbackHandler cbh) throws SaslException {
404 
405         SaslClient mech = null;
406         SaslClientFactory fac;
407         Service service;
408         String mechName;
409 
410         for (int i = 0; i &lt; mechanisms.length; i++) {
411             if ((mechName=mechanisms[i]) == null) {
412                 throw new NullPointerException(
413                     &quot;Mechanism name cannot be null&quot;);
414             } else if (mechName.length() == 0) {
415                 continue;
<a name="7" id="anc7"></a><span class="line-added">416             } else if (isDisabled(mechName)) {</span>
<span class="line-added">417                 logger.log(Level.FINE,</span>
<span class="line-added">418                         &quot;Disabled &quot; + mechName + &quot; mechanism ignored&quot;);</span>
<span class="line-added">419                 continue;</span>
420             }
421             String type = &quot;SaslClientFactory&quot;;
422             Provider[] provs = Security.getProviders(type + &quot;.&quot; + mechName);
423             if (provs != null) {
424                 for (Provider p : provs) {
425                     service = p.getService(type, mechName);
426                     if (service == null) {
427                         // no such service exists
428                         continue;
429                     }
430 
431                     fac = (SaslClientFactory) loadFactory(service);
432                     if (fac != null) {
433                         mech = fac.createSaslClient(
434                             new String[]{mechanisms[i]}, authorizationId,
435                             protocol, serverName, props, cbh);
436                         if (mech != null) {
437                             return mech;
438                         }
439                     }
440                 }
441             }
442         }
443         return null;
444     }
445 
446     private static Object loadFactory(Service service)
447         throws SaslException {
448         try {
449             /*
450              * Load the implementation class with the same class loader
451              * that was used to load the provider.
452              * In order to get the class loader of a class, the
453              * caller&#39;s class loader must be the same as or an ancestor of
454              * the class loader being returned. Otherwise, the caller must
455              * have &quot;getClassLoader&quot; permission, or a SecurityException
456              * will be thrown.
457              */
458             return service.newInstance(null);
459         } catch (InvalidParameterException | NoSuchAlgorithmException e) {
460             throw new SaslException(&quot;Cannot instantiate service &quot; + service, e);
461         }
462     }
463 
464 
465     /**
466      * Creates a {@code SaslServer} for the specified mechanism.
467      *
468      * This method uses the
469      * {@extLink security_guide_jca JCA Security Provider Framework},
470      * described in the
471      * &quot;Java Cryptography Architecture (JCA) Reference Guide&quot;, for
472      * locating and selecting a {@code SaslClient} implementation.
473      *
474      * First, it
475      * obtains an ordered list of {@code SaslServerFactory} instances from
476      * the registered security providers for the &quot;SaslServerFactory&quot; service
477      * and the specified mechanism. It then invokes
478      * {@code createSaslServer()} on each factory instance on the list
479      * until one produces a non-null {@code SaslServer} instance. It returns
480      * the non-null {@code SaslServer} instance, or null if the search fails
481      * to produce a non-null {@code SaslServer} instance.
482      *&lt;p&gt;
483      * A security provider for SaslServerFactory registers with the
484      * JCA Security Provider Framework keys of the form &lt;br&gt;
485      * {@code SaslServerFactory.}&lt;em&gt;{@code mechanism_name}&lt;/em&gt;
486      * &lt;br&gt;
487      * and values that are class names of implementations of
488      * {@code javax.security.sasl.SaslServerFactory}.
489      *
490      * For example, a provider that contains a factory class,
491      * {@code com.wiz.sasl.digest.ServerFactory}, that supports the
492      * &quot;DIGEST-MD5&quot; mechanism would register the following entry with the JCA:
493      * {@code SaslServerFactory.DIGEST-MD5  com.wiz.sasl.digest.ServerFactory}
494      *&lt;p&gt;
495      * See the
496      * &quot;Java Cryptography Architecture API Specification &amp;amp; Reference&quot;
497      * for information about how to install and configure security
498      * service providers.
499      *
500      * @implNote
501      * The JDK Reference Implementation additionally uses the
502      * {@code jdk.security.provider.preferred}
503      * {@link Security#getProperty(String) Security} property to determine
504      * the preferred provider order for the specified algorithm. This
505      * may be different than the order of providers returned by
506      * {@link Security#getProviders() Security.getProviders()}.
<a name="8" id="anc8"></a><span class="line-added">507      * &lt;p&gt;</span>
<span class="line-added">508      * If {@code mechanism} is listed in the {@code jdk.sasl.disabledMechanisms}</span>
<span class="line-added">509      * security property, it will be ignored and this method returns {@code null}.</span>
510      *
511      * @param mechanism The non-null mechanism name. It must be an
512      * IANA-registered name of a SASL mechanism. (e.g. &quot;GSSAPI&quot;, &quot;CRAM-MD5&quot;).
513      * @param protocol The non-null string name of the protocol for which
514      * the authentication is being performed (e.g., &quot;ldap&quot;).
515      * @param serverName The fully qualified host name of the server, or null
516      * if the server is not bound to any specific host name. If the mechanism
517      * does not allow an unbound server, a {@code SaslException} will
518      * be thrown.
519      * @param props The possibly null set of properties used to
520      * select the SASL mechanism and to configure the authentication
521      * exchange of the selected mechanism.
522      * For example, if {@code props} contains the
523      * {@code Sasl.POLICY_NOPLAINTEXT} property with the value
524      * {@code &quot;true&quot;}, then the selected
525      * SASL mechanism must not be susceptible to simple plain passive attacks.
526      * In addition to the standard properties declared in this class,
527      * other, possibly mechanism-specific, properties can be included.
528      * Properties not relevant to the selected mechanism are ignored,
529      * including any map entries with non-String keys.
530      *
531      * @param cbh The possibly null callback handler to used by the SASL
532      * mechanisms to get further information from the application/library
533      * to complete the authentication. For example, a SASL mechanism might
534      * require the authentication ID, password and realm from the caller.
535      * The authentication ID is requested by using a {@code NameCallback}.
536      * The password is requested by using a {@code PasswordCallback}.
537      * The realm is requested by using a {@code RealmChoiceCallback} if there is a list
538      * of realms to choose from, and by using a {@code RealmCallback} if
539      * the realm must be entered.
540      *
541      *@return A possibly null {@code SaslServer} created using the parameters
542      * supplied. If null, cannot find a {@code SaslServerFactory}
543      * that will produce one.
544      *@exception SaslException If cannot create a {@code SaslServer} because
545      * of an error.
546      **/
547     public static SaslServer
548         createSaslServer(String mechanism,
549                     String protocol,
550                     String serverName,
551                     Map&lt;String,?&gt; props,
552                     javax.security.auth.callback.CallbackHandler cbh)
553         throws SaslException {
554 
555         SaslServer mech = null;
556         SaslServerFactory fac;
557         Service service;
558 
559         if (mechanism == null) {
560             throw new NullPointerException(&quot;Mechanism name cannot be null&quot;);
561         } else if (mechanism.length() == 0) {
562             return null;
<a name="9" id="anc9"></a><span class="line-added">563         } else if (isDisabled(mechanism)) {</span>
<span class="line-added">564             logger.log(Level.FINE,</span>
<span class="line-added">565                     &quot;Disabled &quot; + mechanism + &quot; mechanism ignored&quot;);</span>
<span class="line-added">566             return null;</span>
567         }
568 
569         String type = &quot;SaslServerFactory&quot;;
570         Provider[] provs = Security.getProviders(type + &quot;.&quot; + mechanism);
571         if (provs != null) {
572             for (Provider p : provs) {
573                 service = p.getService(type, mechanism);
574                 if (service == null) {
575                     throw new SaslException(&quot;Provider does not support &quot; +
576                         mechanism + &quot; &quot; + type);
577                 }
578                 fac = (SaslServerFactory) loadFactory(service);
579                 if (fac != null) {
580                     mech = fac.createSaslServer(
581                         mechanism, protocol, serverName, props, cbh);
582                     if (mech != null) {
583                         return mech;
584                     }
585                 }
586             }
587         }
588         return null;
589     }
590 
591     /**
592      * Gets an enumeration of known factories for producing {@code SaslClient}.
593      * This method uses the same algorithm for locating factories as
594      * {@code createSaslClient()}.
595      * @return A non-null enumeration of known factories for producing
596      * {@code SaslClient}.
597      * @see #createSaslClient
598      */
599     public static Enumeration&lt;SaslClientFactory&gt; getSaslClientFactories() {
600         Set&lt;Object&gt; facs = getFactories(&quot;SaslClientFactory&quot;);
601         final Iterator&lt;Object&gt; iter = facs.iterator();
602         return new Enumeration&lt;SaslClientFactory&gt;() {
603             public boolean hasMoreElements() {
604                 return iter.hasNext();
605             }
606             public SaslClientFactory nextElement() {
607                 return (SaslClientFactory)iter.next();
608             }
609         };
610     }
611 
612     /**
613      * Gets an enumeration of known factories for producing {@code SaslServer}.
614      * This method uses the same algorithm for locating factories as
615      * {@code createSaslServer()}.
616      * @return A non-null enumeration of known factories for producing
617      * {@code SaslServer}.
618      * @see #createSaslServer
619      */
620     public static Enumeration&lt;SaslServerFactory&gt; getSaslServerFactories() {
621         Set&lt;Object&gt; facs = getFactories(&quot;SaslServerFactory&quot;);
622         final Iterator&lt;Object&gt; iter = facs.iterator();
623         return new Enumeration&lt;SaslServerFactory&gt;() {
624             public boolean hasMoreElements() {
625                 return iter.hasNext();
626             }
627             public SaslServerFactory nextElement() {
628                 return (SaslServerFactory)iter.next();
629             }
630         };
631     }
632 
633     private static Set&lt;Object&gt; getFactories(String serviceName) {
634         HashSet&lt;Object&gt; result = new HashSet&lt;Object&gt;();
635 
636         if ((serviceName == null) || (serviceName.length() == 0) ||
637             (serviceName.endsWith(&quot;.&quot;))) {
638             return result;
639         }
640 
641         Provider[] provs = Security.getProviders();
642         Object fac;
643 
644         for (Provider p : provs) {
645 
646             Iterator&lt;Service&gt; iter = p.getServices().iterator();
647             while (iter.hasNext()) {
648                 Service s = iter.next();
649                 if (s.getType().equals(serviceName)) {
650                     try {
651                         fac = loadFactory(s);
652                         if (fac != null) {
653                             result.add(fac);
654                         }
655                     } catch (Exception ignore) {
656                     }
657                 }
658             }
659         }
660         return Collections.unmodifiableSet(result);
661     }
<a name="10" id="anc10"></a><span class="line-added">662 </span>
<span class="line-added">663     private static boolean isDisabled(String name) {</span>
<span class="line-added">664         return disabledMechanisms.contains(name);</span>
<span class="line-added">665     }</span>
666 }
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>