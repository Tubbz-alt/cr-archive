<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.security.sasl/share/classes/com/sun/security/sasl/digest/DigestMD5Server.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DigestMD5Client.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../javax/security/sasl/Sasl.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.sasl/share/classes/com/sun/security/sasl/digest/DigestMD5Server.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2012, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,14 ***</span>
   * questions.
   */
  
  package com.sun.security.sasl.digest;
  
<span class="line-removed">- import java.security.NoSuchAlgorithmException;</span>
  import java.io.ByteArrayOutputStream;
  import java.io.IOException;
<span class="line-modified">! import java.io.UnsupportedEncodingException;</span>
  import java.util.StringTokenizer;
  import java.util.ArrayList;
  import java.util.List;
  import java.util.Map;
  import java.util.Arrays;
<span class="line-new-header">--- 23,13 ---</span>
   * questions.
   */
  
  package com.sun.security.sasl.digest;
  
  import java.io.ByteArrayOutputStream;
  import java.io.IOException;
<span class="line-modified">! import java.security.NoSuchAlgorithmException;</span>
  import java.util.StringTokenizer;
  import java.util.ArrayList;
  import java.util.List;
  import java.util.Map;
  import java.util.Arrays;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 38,10 ***</span>
<span class="line-new-header">--- 37,12 ---</span>
  import java.util.logging.Level;
  
  import javax.security.sasl.*;
  import javax.security.auth.callback.*;
  
<span class="line-added">+ import static java.nio.charset.StandardCharsets.*;</span>
<span class="line-added">+ </span>
  /**
    * An implementation of the DIGEST-MD5 server SASL mechanism.
    * (&lt;a href=&quot;http://www.ietf.org/rfc/rfc2831.txt&quot;&gt;RFC 2831&lt;/a&gt;)
    * &lt;p&gt;
    * The DIGEST-MD5 SASL mechanism specifies two modes of authentication.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 169,11 ***</span>
                      serverRealms.add(token);
                  }
              }
          }
  
<span class="line-modified">!         encoding = (useUTF8 ? &quot;UTF8&quot; : &quot;8859_1&quot;);</span>
  
          // By default, use server name as realm
          if (serverRealms.isEmpty()) {
              if (serverName == null) {
                  throw new SaslException(
<span class="line-new-header">--- 170,11 ---</span>
                      serverRealms.add(token);
                  }
              }
          }
  
<span class="line-modified">!         encoding = (useUTF8 ? UTF_8 : ISO_8859_1);</span>
  
          // By default, use server name as realm
          if (serverRealms.isEmpty()) {
              if (serverName == null) {
                  throw new SaslException(
</pre>
<hr />
<pre>
<span class="line-old-header">*** 193,12 ***</span>
  
          byte[] challenge;
          switch (step) {
          case 1:
              if (response.length != 0) {
<span class="line-modified">!                 throw new SaslException(</span>
<span class="line-modified">!                     &quot;DIGEST-MD5 must not have an initial response&quot;);</span>
              }
  
              /* Generate first challenge */
              String supportedCiphers = null;
              if ((allQop&amp;PRIVACY_PROTECTION) != 0) {
<span class="line-new-header">--- 194,17 ---</span>
  
          byte[] challenge;
          switch (step) {
          case 1:
              if (response.length != 0) {
<span class="line-modified">!                 // We do not support &quot;subsequent authentication&quot; (client</span>
<span class="line-modified">!                 // initial response). According to</span>
<span class="line-added">+                 // https://tools.ietf.org/html/rfc2831#section-2.2</span>
<span class="line-added">+                 // If the server does not support subsequent authentication,</span>
<span class="line-added">+                 // then it sends a &quot;digest-challenge&quot;, and authentication</span>
<span class="line-added">+                 // proceeds as in initial authentication.</span>
<span class="line-added">+                 logger.log(Level.FINE, &quot;Ignoring initial response&quot;);</span>
              }
  
              /* Generate first challenge */
              String supportedCiphers = null;
              if ((allQop&amp;PRIVACY_PROTECTION) != 0) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 222,13 ***</span>
                  challenge = generateChallenge(serverRealms, specifiedQops,
                      supportedCiphers);
  
                  step = 3;
                  return challenge;
<span class="line-removed">-             } catch (UnsupportedEncodingException e) {</span>
<span class="line-removed">-                 throw new SaslException(</span>
<span class="line-removed">-                     &quot;DIGEST-MD5: Error encoding challenge&quot;, e);</span>
              } catch (IOException e) {
                  throw new SaslException(
                      &quot;DIGEST-MD5: Error generating challenge&quot;, e);
              }
  
<span class="line-new-header">--- 228,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 240,15 ***</span>
               */
              try {
                  byte[][] responseVal = parseDirectives(response, DIRECTIVE_KEY,
                      null, REALM);
                  challenge = validateClientResponse(responseVal);
<span class="line-removed">-             } catch (SaslException e) {</span>
<span class="line-removed">-                 throw e;</span>
<span class="line-removed">-             } catch (UnsupportedEncodingException e) {</span>
<span class="line-removed">-                 throw new SaslException(</span>
<span class="line-removed">-                     &quot;DIGEST-MD5: Error validating client response&quot;, e);</span>
              } finally {
                  step = 0;  // Set to invalid state
              }
  
              completed = true;
<span class="line-new-header">--- 243,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 291,11 ***</span>
       *        cipher-value      = &quot;3des&quot; | &quot;des&quot; | &quot;rc4-40&quot; | &quot;rc4&quot; |
       *                            &quot;rc4-56&quot; | token
       *        auth-param        = token &quot;=&quot; ( token | quoted-string )
       */
      private byte[] generateChallenge(List&lt;String&gt; realms, String qopStr,
<span class="line-modified">!         String cipherStr) throws UnsupportedEncodingException, IOException {</span>
          ByteArrayOutputStream out = new ByteArrayOutputStream();
  
          // Realms (&gt;= 0)
          for (int i = 0; realms != null &amp;&amp; i &lt; realms.size(); i++) {
              out.write(&quot;realm=\&quot;&quot;.getBytes(encoding));
<span class="line-new-header">--- 289,11 ---</span>
       *        cipher-value      = &quot;3des&quot; | &quot;des&quot; | &quot;rc4-40&quot; | &quot;rc4&quot; |
       *                            &quot;rc4-56&quot; | token
       *        auth-param        = token &quot;=&quot; ( token | quoted-string )
       */
      private byte[] generateChallenge(List&lt;String&gt; realms, String qopStr,
<span class="line-modified">!         String cipherStr) throws IOException {</span>
          ByteArrayOutputStream out = new ByteArrayOutputStream();
  
          // Realms (&gt;= 0)
          for (int i = 0; realms != null &amp;&amp; i &lt; realms.size(); i++) {
              out.write(&quot;realm=\&quot;&quot;.getBytes(encoding));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 382,11 ***</span>
       *   sendMaxBufSize
       *   authzid (gotten from callback)
       * @return response-value (&#39;rspauth&#39;) for client to validate
       */
      private byte[] validateClientResponse(byte[][] responseVal)
<span class="line-modified">!         throws SaslException, UnsupportedEncodingException {</span>
  
          /* CHARSET: optional atmost once */
          if (responseVal[CHARSET] != null) {
              // The client should send this directive only if the server has
              // indicated it supports UTF-8.
<span class="line-new-header">--- 380,11 ---</span>
       *   sendMaxBufSize
       *   authzid (gotten from callback)
       * @return response-value (&#39;rspauth&#39;) for client to validate
       */
      private byte[] validateClientResponse(byte[][] responseVal)
<span class="line-modified">!         throws SaslException {</span>
  
          /* CHARSET: optional atmost once */
          if (responseVal[CHARSET] != null) {
              // The client should send this directive only if the server has
              // indicated it supports UTF-8.
</pre>
<center><a href="DigestMD5Client.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../javax/security/sasl/Sasl.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>