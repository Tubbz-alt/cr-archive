<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.security.sasl/share/classes/com/sun/security/sasl/digest/DigestMD5Client.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DigestMD5Base.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DigestMD5Server.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.sasl/share/classes/com/sun/security/sasl/digest/DigestMD5Client.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.security.sasl.digest;
 27 
 28 import java.security.NoSuchAlgorithmException;
 29 import java.io.ByteArrayOutputStream;
 30 import java.io.IOException;
<span class="line-removed"> 31 import java.io.UnsupportedEncodingException;</span>
 32 import java.util.StringTokenizer;
 33 import java.util.ArrayList;
 34 import java.util.List;
 35 import java.util.Map;
 36 import java.util.Arrays;
<span class="line-removed"> 37 </span>
 38 import java.util.logging.Level;
 39 


 40 import javax.security.sasl.*;
 41 import javax.security.auth.callback.CallbackHandler;
 42 import javax.security.auth.callback.PasswordCallback;
 43 import javax.security.auth.callback.NameCallback;
 44 import javax.security.auth.callback.Callback;
 45 import javax.security.auth.callback.UnsupportedCallbackException;
 46 
 47 /**
 48   * An implementation of the DIGEST-MD5
 49   * (&lt;a href=&quot;http://www.ietf.org/rfc/rfc2831.txt&quot;&gt;RFC 2831&lt;/a&gt;) SASL
 50   * (&lt;a href=&quot;http://www.ietf.org/rfc/rfc2222.txt&quot;&gt;RFC 2222&lt;/a&gt;) mechanism.
 51   *
 52   * The DIGEST-MD5 SASL mechanism specifies two modes of authentication.
 53   * - Initial Authentication
 54   * - Subsequent Authentication - optional, (currently unsupported)
 55   *
 56   * Required callbacks:
 57   * - RealmChoiceCallback
 58   *    shows user list of realms server has offered; handler must choose one
 59   *    from list
</pre>
<hr />
<pre>
138     /**
139       * Constructor for DIGEST-MD5 mechanism.
140       *
141       * @param authzid A non-null String representing the principal
142       * for which authorization is being granted..
143       * @param digestURI A non-null String representing detailing the
144       * combined protocol and host being used for authentication.
145       * @param props The possibly null properties to be used by the SASL
146       * mechanism to configure the authentication exchange.
147       * @param cbh The non-null CallbackHanlder object for callbacks
148       * @throws SaslException if no authentication ID or password is supplied
149       */
150     DigestMD5Client(String authzid, String protocol, String serverName,
151         Map&lt;String, ?&gt; props, CallbackHandler cbh) throws SaslException {
152 
153         super(props, MY_CLASS_NAME, 2, protocol + &quot;/&quot; + serverName, cbh);
154 
155         // authzID can only be encoded in UTF8 - RFC 2222
156         if (authzid != null) {
157             this.authzid = authzid;
<span class="line-modified">158             try {</span>
<span class="line-removed">159                 authzidBytes = authzid.getBytes(&quot;UTF8&quot;);</span>
<span class="line-removed">160 </span>
<span class="line-removed">161             } catch (UnsupportedEncodingException e) {</span>
<span class="line-removed">162                 throw new SaslException(</span>
<span class="line-removed">163                     &quot;DIGEST-MD5: Error encoding authzid value into UTF-8&quot;, e);</span>
<span class="line-removed">164             }</span>
165         }
166 
167         if (props != null) {
168             specifiedCipher = (String)props.get(CIPHER_PROPERTY);
169 
170             logger.log(Level.FINE, &quot;DIGEST60:Explicitly specified cipher: {0}&quot;,
171                 specifiedCipher);
172         }
173    }
174 
175     /**
176      * DIGEST-MD5 has no initial response
177      *
178      * @return false
179      */
180     public boolean hasInitialResponse() {
181         return false;
182     }
183 
184     /**
</pre>
<hr />
<pre>
255                 completed = true;
256             }
257 
258         default:
259             // No other possible state
260             throw new SaslException(&quot;DIGEST-MD5: Client at illegal state&quot;);
261         }
262     }
263 
264 
265    /**
266     * Record information from the challengeVal array into variables/fields.
267     * Check directive values that are multi-valued and ensure that mandatory
268     * directives not missing from the digest-challenge.
269     *
270     * @throws SaslException if a sasl is a the mechanism cannot
271     * correcly handle a callbacks or if a violation in the
272     * digest challenge format is detected.
273     */
274     private void processChallenge(byte[][] challengeVal, List&lt;byte[]&gt; realmChoices)
<span class="line-modified">275         throws SaslException, UnsupportedEncodingException {</span>
276 
277         /* CHARSET: optional atmost once */
278         if (challengeVal[CHARSET] != null) {
279             if (!&quot;utf-8&quot;.equals(new String(challengeVal[CHARSET], encoding))) {
280                 throw new SaslException(&quot;DIGEST-MD5: digest-challenge format &quot; +
281                     &quot;violation. Unrecognised charset value: &quot; +
282                     new String(challengeVal[CHARSET]));
283             } else {
<span class="line-modified">284                 encoding = &quot;UTF8&quot;;</span>
285                 useUTF8 = true;
286             }
287         }
288 
289         /* ALGORITHM: required exactly once */
290         if (challengeVal[ALGORITHM] == null) {
291             throw new SaslException(&quot;DIGEST-MD5: Digest-challenge format &quot; +
292                 &quot;violation: algorithm directive missing&quot;);
293         } else if (!&quot;md5-sess&quot;.equals(new String(challengeVal[ALGORITHM], encoding))) {
294             throw new SaslException(&quot;DIGEST-MD5: Digest-challenge format &quot; +
295                 &quot;violation. Invalid value for &#39;algorithm&#39; directive: &quot; +
296                 challengeVal[ALGORITHM]);
297         }
298 
299         /* NONCE: required exactly once */
300         if (challengeVal[NONCE] == null) {
301             throw new SaslException(&quot;DIGEST-MD5: Digest-challenge format &quot; +
302                 &quot;violation: nonce directive missing&quot;);
303         } else {
304             nonce = challengeVal[NONCE];
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.security.sasl.digest;
 27 
 28 import java.security.NoSuchAlgorithmException;
 29 import java.io.ByteArrayOutputStream;
 30 import java.io.IOException;

 31 import java.util.StringTokenizer;
 32 import java.util.ArrayList;
 33 import java.util.List;
 34 import java.util.Map;
 35 import java.util.Arrays;

 36 import java.util.logging.Level;
 37 
<span class="line-added"> 38 import static java.nio.charset.StandardCharsets.UTF_8;</span>
<span class="line-added"> 39 </span>
 40 import javax.security.sasl.*;
 41 import javax.security.auth.callback.CallbackHandler;
 42 import javax.security.auth.callback.PasswordCallback;
 43 import javax.security.auth.callback.NameCallback;
 44 import javax.security.auth.callback.Callback;
 45 import javax.security.auth.callback.UnsupportedCallbackException;
 46 
 47 /**
 48   * An implementation of the DIGEST-MD5
 49   * (&lt;a href=&quot;http://www.ietf.org/rfc/rfc2831.txt&quot;&gt;RFC 2831&lt;/a&gt;) SASL
 50   * (&lt;a href=&quot;http://www.ietf.org/rfc/rfc2222.txt&quot;&gt;RFC 2222&lt;/a&gt;) mechanism.
 51   *
 52   * The DIGEST-MD5 SASL mechanism specifies two modes of authentication.
 53   * - Initial Authentication
 54   * - Subsequent Authentication - optional, (currently unsupported)
 55   *
 56   * Required callbacks:
 57   * - RealmChoiceCallback
 58   *    shows user list of realms server has offered; handler must choose one
 59   *    from list
</pre>
<hr />
<pre>
138     /**
139       * Constructor for DIGEST-MD5 mechanism.
140       *
141       * @param authzid A non-null String representing the principal
142       * for which authorization is being granted..
143       * @param digestURI A non-null String representing detailing the
144       * combined protocol and host being used for authentication.
145       * @param props The possibly null properties to be used by the SASL
146       * mechanism to configure the authentication exchange.
147       * @param cbh The non-null CallbackHanlder object for callbacks
148       * @throws SaslException if no authentication ID or password is supplied
149       */
150     DigestMD5Client(String authzid, String protocol, String serverName,
151         Map&lt;String, ?&gt; props, CallbackHandler cbh) throws SaslException {
152 
153         super(props, MY_CLASS_NAME, 2, protocol + &quot;/&quot; + serverName, cbh);
154 
155         // authzID can only be encoded in UTF8 - RFC 2222
156         if (authzid != null) {
157             this.authzid = authzid;
<span class="line-modified">158             authzidBytes = authzid.getBytes(UTF_8);</span>






159         }
160 
161         if (props != null) {
162             specifiedCipher = (String)props.get(CIPHER_PROPERTY);
163 
164             logger.log(Level.FINE, &quot;DIGEST60:Explicitly specified cipher: {0}&quot;,
165                 specifiedCipher);
166         }
167    }
168 
169     /**
170      * DIGEST-MD5 has no initial response
171      *
172      * @return false
173      */
174     public boolean hasInitialResponse() {
175         return false;
176     }
177 
178     /**
</pre>
<hr />
<pre>
249                 completed = true;
250             }
251 
252         default:
253             // No other possible state
254             throw new SaslException(&quot;DIGEST-MD5: Client at illegal state&quot;);
255         }
256     }
257 
258 
259    /**
260     * Record information from the challengeVal array into variables/fields.
261     * Check directive values that are multi-valued and ensure that mandatory
262     * directives not missing from the digest-challenge.
263     *
264     * @throws SaslException if a sasl is a the mechanism cannot
265     * correcly handle a callbacks or if a violation in the
266     * digest challenge format is detected.
267     */
268     private void processChallenge(byte[][] challengeVal, List&lt;byte[]&gt; realmChoices)
<span class="line-modified">269         throws SaslException {</span>
270 
271         /* CHARSET: optional atmost once */
272         if (challengeVal[CHARSET] != null) {
273             if (!&quot;utf-8&quot;.equals(new String(challengeVal[CHARSET], encoding))) {
274                 throw new SaslException(&quot;DIGEST-MD5: digest-challenge format &quot; +
275                     &quot;violation. Unrecognised charset value: &quot; +
276                     new String(challengeVal[CHARSET]));
277             } else {
<span class="line-modified">278                 encoding = UTF_8;</span>
279                 useUTF8 = true;
280             }
281         }
282 
283         /* ALGORITHM: required exactly once */
284         if (challengeVal[ALGORITHM] == null) {
285             throw new SaslException(&quot;DIGEST-MD5: Digest-challenge format &quot; +
286                 &quot;violation: algorithm directive missing&quot;);
287         } else if (!&quot;md5-sess&quot;.equals(new String(challengeVal[ALGORITHM], encoding))) {
288             throw new SaslException(&quot;DIGEST-MD5: Digest-challenge format &quot; +
289                 &quot;violation. Invalid value for &#39;algorithm&#39; directive: &quot; +
290                 challengeVal[ALGORITHM]);
291         }
292 
293         /* NONCE: required exactly once */
294         if (challengeVal[NONCE] == null) {
295             throw new SaslException(&quot;DIGEST-MD5: Digest-challenge format &quot; +
296                 &quot;violation: nonce directive missing&quot;);
297         } else {
298             nonce = challengeVal[NONCE];
</pre>
</td>
</tr>
</table>
<center><a href="DigestMD5Base.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DigestMD5Server.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>