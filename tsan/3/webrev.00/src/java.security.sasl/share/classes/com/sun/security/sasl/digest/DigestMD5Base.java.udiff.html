<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.security.sasl/share/classes/com/sun/security/sasl/digest/DigestMD5Base.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../PlainClient.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DigestMD5Client.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.security.sasl/share/classes/com/sun/security/sasl/digest/DigestMD5Base.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,28 +23,28 @@</span>
   * questions.
   */
  
  package com.sun.security.sasl.digest;
  
<span class="udiff-line-added">+ import java.io.ByteArrayOutputStream;</span>
<span class="udiff-line-added">+ import java.io.IOException;</span>
<span class="udiff-line-added">+ import java.math.BigInteger;</span>
<span class="udiff-line-added">+ import java.nio.charset.Charset;</span>
  import java.util.Map;
  import java.util.Arrays;
  import java.util.List;
  import java.util.logging.Level;
<span class="udiff-line-removed">- import java.math.BigInteger;</span>
  import java.util.Random;
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- import java.io.ByteArrayOutputStream;</span>
<span class="udiff-line-removed">- import java.io.UnsupportedEncodingException;</span>
<span class="udiff-line-removed">- import java.io.IOException;</span>
<span class="udiff-line-removed">- </span>
  import java.security.MessageDigest;
  import java.security.NoSuchAlgorithmException;
  import java.security.InvalidKeyException;
  import java.security.spec.KeySpec;
  import java.security.spec.InvalidKeySpecException;
  import java.security.InvalidAlgorithmParameterException;
  
<span class="udiff-line-added">+ import static java.nio.charset.StandardCharsets.*;</span>
<span class="udiff-line-added">+ </span>
  import javax.crypto.Cipher;
  import javax.crypto.SecretKey;
  import javax.crypto.Mac;
  import javax.crypto.SecretKeyFactory;
  import javax.crypto.NoSuchPaddingException;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -52,14 +52,14 @@</span>
  import javax.crypto.spec.IvParameterSpec;
  import javax.crypto.spec.SecretKeySpec;
  import javax.crypto.spec.DESKeySpec;
  import javax.crypto.spec.DESedeKeySpec;
  
<span class="udiff-line-added">+ import javax.security.auth.callback.CallbackHandler;</span>
  import javax.security.sasl.*;
<span class="udiff-line-removed">- import com.sun.security.sasl.util.AbstractSaslImpl;</span>
  
<span class="udiff-line-modified-removed">- import javax.security.auth.callback.CallbackHandler;</span>
<span class="udiff-line-modified-added">+ import com.sun.security.sasl.util.AbstractSaslImpl;</span>
  
  /**
   * Utility class for DIGEST-MD5 mechanism. Provides utility methods
   * and contains two inner classes which implement the SecurityCtx
   * interface. The inner classes provide the funtionality to allow
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -149,11 +149,11 @@</span>
      protected String negotiatedStrength;
      protected String negotiatedCipher;
      protected String negotiatedQop;
      protected String negotiatedRealm;
      protected boolean useUTF8 = false;
<span class="udiff-line-modified-removed">-     protected String encoding = &quot;8859_1&quot;;  // default unless server specifies utf-8</span>
<span class="udiff-line-modified-added">+     protected Charset encoding = ISO_8859_1;  // default unless server specifies utf-8</span>
  
      protected String digestUri;
      protected String authzid;       // authzid or canonicalized authzid
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -382,12 +382,11 @@</span>
       * Convert a byte array to hexadecimal string.
       *
       * @param a non-null byte array
       * @return a non-null String contain the HEX value
       */
<span class="udiff-line-modified-removed">-     protected byte[] binaryToHex(byte[] digest) throws</span>
<span class="udiff-line-removed">-     UnsupportedEncodingException {</span>
<span class="udiff-line-modified-added">+     protected byte[] binaryToHex(byte[] digest) {</span>
  
          StringBuilder digestString = new StringBuilder();
  
          for (int i = 0; i &lt; digest.length; i ++) {
              if ((digest[i] &amp; 0x000000ff) &lt; 0x10) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -403,30 +402,25 @@</span>
      /**
       * Used to convert username-value, passwd or realm to 8859_1 encoding
       * if all chars in string are within the 8859_1 (Latin 1) encoding range.
       *
       * @param a non-null String
<span class="udiff-line-modified-removed">-      * @return a non-nuill byte array containing the correct character encoding</span>
<span class="udiff-line-modified-added">+      * @return a non-null byte array containing the correct character encoding</span>
       * for username, paswd or realm.
       */
<span class="udiff-line-modified-removed">-     protected byte[] stringToByte_8859_1(String str) throws SaslException {</span>
<span class="udiff-line-modified-added">+     protected byte[] stringToByte_8859_1(String str) {</span>
  
          char[] buffer = str.toCharArray();
  
<span class="udiff-line-modified-removed">-         try {</span>
<span class="udiff-line-modified-removed">-             if (useUTF8) {</span>
<span class="udiff-line-modified-removed">-                 for( int i = 0; i&lt; buffer.length; i++ ) {</span>
<span class="udiff-line-modified-removed">-                     if( buffer[i] &gt; &#39;\u00FF&#39; ) {</span>
<span class="udiff-line-removed">-                         return str.getBytes(&quot;UTF8&quot;);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-modified-added">+         if (useUTF8) {</span>
<span class="udiff-line-modified-added">+             for (int i = 0; i &lt; buffer.length; i++) {</span>
<span class="udiff-line-modified-added">+                 if (buffer[i] &gt; &#39;\u00FF&#39;) {</span>
<span class="udiff-line-modified-added">+                     return str.getBytes(UTF_8);</span>
                  }
              }
<span class="udiff-line-removed">-             return str.getBytes(&quot;8859_1&quot;);</span>
<span class="udiff-line-removed">-         } catch (UnsupportedEncodingException e) {</span>
<span class="udiff-line-removed">-             throw new SaslException(</span>
<span class="udiff-line-removed">-                 &quot;cannot encode string in UTF8 or 8859-1 (Latin-1)&quot;, e);</span>
          }
<span class="udiff-line-added">+         return str.getBytes(ISO_8859_1);</span>
      }
  
      protected static byte[] getPlatformCiphers() {
          byte[] ciphers = new byte[CIPHER_TOKENS.length];
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -459,12 +453,10 @@</span>
       * @param authMethod &quot;AUTHENTICATE&quot; for client-generated response;
       *        &quot;&quot; for server-generated response
       * @return A non-null byte array containing the repsonse-value.
       * @throws NoSuchAlgorithmException if the platform does not have MD5
       * digest support.
<span class="udiff-line-removed">-      * @throws UnsupportedEncodingException if a an error occurs</span>
<span class="udiff-line-removed">-      * encoding a string into either Latin-1 or UTF-8.</span>
       * @throws IOException if an error occurs writing to the output
       * byte array buffer.
       */
      protected byte[] generateResponseValue(
          String authMethod,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -476,11 +468,10 @@</span>
          byte[] nonceValue,
          byte[] cNonceValue,
          int nonceCount,
          byte[] authzidValue
          ) throws NoSuchAlgorithmException,
<span class="udiff-line-removed">-             UnsupportedEncodingException,</span>
              IOException {
  
          MessageDigest md5 = MessageDigest.getInstance(&quot;MD5&quot;);
          byte[] hexA1, hexA2;
          ByteArrayOutputStream A2, beginA1, A1, KD;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -843,18 +834,13 @@</span>
              /* Initialize magic strings */
  
              try {
                  generateIntegrityKeyPair(clientMode);
  
<span class="udiff-line-removed">-             } catch (UnsupportedEncodingException e) {</span>
<span class="udiff-line-removed">-                 throw new SaslException(</span>
<span class="udiff-line-removed">-                     &quot;DIGEST-MD5: Error encoding strings into UTF-8&quot;, e);</span>
<span class="udiff-line-removed">- </span>
              } catch (IOException e) {
                  throw new SaslException(&quot;DIGEST-MD5: Error accessing buffers &quot; +
                      &quot;required to create integrity key pairs&quot;, e);
<span class="udiff-line-removed">- </span>
              } catch (NoSuchAlgorithmException e) {
                  throw new SaslException(&quot;DIGEST-MD5: Unsupported digest &quot; +
                      &quot;algorithm used to create integrity key pairs&quot;, e);
              }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -864,20 +850,17 @@</span>
  
          /**
           * Generate client-server, server-client key pairs for DIGEST-MD5
           * integrity checking.
           *
<span class="udiff-line-removed">-          * @throws UnsupportedEncodingException if the UTF-8 encoding is not</span>
<span class="udiff-line-removed">-          * supported on the platform.</span>
           * @throws IOException if an error occurs when writing to or from the
           * byte array output buffers.
           * @throws NoSuchAlgorithmException if the MD5 message digest algorithm
           * cannot loaded.
           */
          private void generateIntegrityKeyPair(boolean clientMode)
<span class="udiff-line-modified-removed">-             throws UnsupportedEncodingException, IOException,</span>
<span class="udiff-line-removed">-                 NoSuchAlgorithmException {</span>
<span class="udiff-line-modified-added">+             throws IOException, NoSuchAlgorithmException {</span>
  
              byte[] cimagic = CLIENT_INT_MAGIC.getBytes(encoding);
              byte[] simagic = SVR_INT_MAGIC.getBytes(encoding);
  
              MessageDigest md5 = MessageDigest.getInstance(&quot;MD5&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1128,15 +1111,10 @@</span>
              try {
                  generatePrivacyKeyPair(clientMode);
  
              } catch (SaslException e) {
                  throw e;
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             } catch (UnsupportedEncodingException e) {</span>
<span class="udiff-line-removed">-                 throw new SaslException(</span>
<span class="udiff-line-removed">-                     &quot;DIGEST-MD5: Error encoding string value into UTF-8&quot;, e);</span>
<span class="udiff-line-removed">- </span>
              } catch (IOException e) {
                  throw new SaslException(&quot;DIGEST-MD5: Error accessing &quot; +
                      &quot;buffers required to generate cipher keys&quot;, e);
              } catch (NoSuchAlgorithmException e) {
                  throw new SaslException(&quot;DIGEST-MD5: Error creating &quot; +
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1150,18 +1128,15 @@</span>
           *
           * @throws IOException if an error occurs when writing to or from the
           * byte array output buffers.
           * @throws NoSuchAlgorithmException if the MD5 message digest algorithm
           * cannot loaded.
<span class="udiff-line-modified-removed">-          * @throws UnsupportedEncodingException if an UTF-8 encoding is not</span>
<span class="udiff-line-removed">-          * supported on the platform.</span>
<span class="udiff-line-removed">-          * @throw SaslException if an error occurs initializing the keys and</span>
<span class="udiff-line-modified-added">+          * @throws SaslException if an error occurs initializing the keys and</span>
           * IVs for the chosen cipher.
           */
          private void generatePrivacyKeyPair(boolean clientMode)
<span class="udiff-line-modified-removed">-             throws IOException, UnsupportedEncodingException,</span>
<span class="udiff-line-removed">-             NoSuchAlgorithmException, SaslException {</span>
<span class="udiff-line-modified-added">+             throws IOException, NoSuchAlgorithmException, SaslException {</span>
  
              byte[] ccmagic = CLIENT_CONF_MAGIC.getBytes(encoding);
              byte[] scmagic = SVR_CONF_MAGIC.getBytes(encoding);
  
              /* Kcc = MD5{H(A1)[0..n], &quot;Digest ... client-to-server&quot;} */
</pre>
<center><a href="../PlainClient.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="DigestMD5Client.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>