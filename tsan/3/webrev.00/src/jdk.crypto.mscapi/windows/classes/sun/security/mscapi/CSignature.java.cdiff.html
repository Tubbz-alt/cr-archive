<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.crypto.mscapi/windows/classes/sun/security/mscapi/CSignature.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="CPublicKey.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../native/libsunmscapi/security.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.mscapi/windows/classes/sun/security/mscapi/CSignature.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 116,14 ***</span>
          }
  
          // initialize for signing. See JCA doc
          @Override
          protected void engineInitSign(PrivateKey key) throws InvalidKeyException {
<span class="line-modified">! </span>
              if ((key instanceof CPrivateKey) == false
                      || !key.getAlgorithm().equalsIgnoreCase(&quot;RSA&quot;)) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported&quot;);</span>
              }
              privateKey = (CPrivateKey) key;
  
              // Check against the local and global values to make sure
              // the sizes are ok.  Round up to nearest byte.
<span class="line-new-header">--- 116,17 ---</span>
          }
  
          // initialize for signing. See JCA doc
          @Override
          protected void engineInitSign(PrivateKey key) throws InvalidKeyException {
<span class="line-modified">!             if (key == null) {</span>
<span class="line-added">+                 throw new InvalidKeyException(&quot;Key cannot be null&quot;);</span>
<span class="line-added">+             }</span>
              if ((key instanceof CPrivateKey) == false
                      || !key.getAlgorithm().equalsIgnoreCase(&quot;RSA&quot;)) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported: &quot;</span>
<span class="line-added">+                         + key.getClass() + &quot; &quot; + key.getAlgorithm());</span>
              }
              privateKey = (CPrivateKey) key;
  
              // Check against the local and global values to make sure
              // the sizes are ok.  Round up to nearest byte.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 136,13 ***</span>
          }
  
          // initialize for signing. See JCA doc
          @Override
          protected void engineInitVerify(PublicKey key) throws InvalidKeyException {
              // This signature accepts only RSAPublicKey
              if ((key instanceof RSAPublicKey) == false) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported&quot;);</span>
              }
  
  
              if ((key instanceof CPublicKey) == false) {
  
<span class="line-new-header">--- 139,17 ---</span>
          }
  
          // initialize for signing. See JCA doc
          @Override
          protected void engineInitVerify(PublicKey key) throws InvalidKeyException {
<span class="line-added">+             if (key == null) {</span>
<span class="line-added">+                 throw new InvalidKeyException(&quot;Key cannot be null&quot;);</span>
<span class="line-added">+             }</span>
              // This signature accepts only RSAPublicKey
              if ((key instanceof RSAPublicKey) == false) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported: &quot;</span>
<span class="line-added">+                         + key.getClass());</span>
              }
  
  
              if ((key instanceof CPublicKey) == false) {
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 199,20 ***</span>
          @Override
          protected byte[] engineSign() throws SignatureException {
  
              byte[] hash = getDigestValue();
  
<span class="line-modified">!             // Omit the hash OID when generating a NONEwithRSA signature</span>
<span class="line-modified">!             boolean noHashOID = this instanceof NONEwithRSA;</span>
<span class="line-modified">! </span>
<span class="line-modified">!             // Sign hash using MS Crypto APIs</span>
<span class="line-modified">!             byte[] result = signHash(noHashOID, hash, hash.length,</span>
                          messageDigestAlgorithm, privateKey.getHCryptProvider(),
                          privateKey.getHCryptKey());
  
<span class="line-modified">!             // Convert signature array from little endian to big endian</span>
<span class="line-modified">!             return convertEndianArray(result);</span>
          }
  
          /**
           * Verifies the passed-in signature.
           *
<span class="line-new-header">--- 206,26 ---</span>
          @Override
          protected byte[] engineSign() throws SignatureException {
  
              byte[] hash = getDigestValue();
  
<span class="line-modified">!             if (privateKey.getHCryptKey() == 0) {</span>
<span class="line-modified">!                 return signCngHash(1, hash, hash.length,</span>
<span class="line-modified">!                         0,</span>
<span class="line-modified">!                         this instanceof NONEwithRSA ? null : messageDigestAlgorithm,</span>
<span class="line-modified">!                         privateKey.getHCryptProvider(), 0);</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 // Omit the hash OID when generating a NONEwithRSA signature</span>
<span class="line-added">+                 boolean noHashOID = this instanceof NONEwithRSA;</span>
<span class="line-added">+                 // Sign hash using MS Crypto APIs</span>
<span class="line-added">+                 byte[] result = signHash(noHashOID, hash, hash.length,</span>
                          messageDigestAlgorithm, privateKey.getHCryptProvider(),
                          privateKey.getHCryptKey());
  
<span class="line-modified">!                 // Convert signature array from little endian to big endian</span>
<span class="line-modified">!                 return convertEndianArray(result);</span>
<span class="line-added">+             }</span>
          }
  
          /**
           * Verifies the passed-in signature.
           *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 228,14 ***</span>
          @Override
          protected boolean engineVerify(byte[] sigBytes)
                  throws SignatureException {
              byte[] hash = getDigestValue();
  
<span class="line-modified">!             return verifySignedHash(hash, hash.length,</span>
<span class="line-modified">!                     messageDigestAlgorithm, convertEndianArray(sigBytes),</span>
<span class="line-modified">!                     sigBytes.length, publicKey.getHCryptProvider(),</span>
<span class="line-modified">!                     publicKey.getHCryptKey());</span>
          }
  
          /**
           * Generates a public-key BLOB from a key&#39;s components.
           */
<span class="line-new-header">--- 241,24 ---</span>
          @Override
          protected boolean engineVerify(byte[] sigBytes)
                  throws SignatureException {
              byte[] hash = getDigestValue();
  
<span class="line-modified">!             if (publicKey.getHCryptKey() == 0) {</span>
<span class="line-modified">!                 return verifyCngSignedHash(</span>
<span class="line-modified">!                         1, hash, hash.length,</span>
<span class="line-modified">!                         sigBytes, sigBytes.length,</span>
<span class="line-added">+                         0,</span>
<span class="line-added">+                         messageDigestAlgorithm,</span>
<span class="line-added">+                         publicKey.getHCryptProvider(),</span>
<span class="line-added">+                         0);</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 return verifySignedHash(hash, hash.length,</span>
<span class="line-added">+                         messageDigestAlgorithm, convertEndianArray(sigBytes),</span>
<span class="line-added">+                         sigBytes.length, publicKey.getHCryptProvider(),</span>
<span class="line-added">+                         publicKey.getHCryptKey());</span>
<span class="line-added">+             }</span>
          }
  
          /**
           * Generates a public-key BLOB from a key&#39;s components.
           */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 408,29 ***</span>
          }
  
          // initialize for signing. See JCA doc
          @Override
          protected void engineInitSign(PrivateKey key) throws InvalidKeyException {
              if ((key instanceof CPrivateKey) == false
                      || !key.getAlgorithm().equalsIgnoreCase(&quot;EC&quot;)) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported&quot;);</span>
              }
              privateKey = (CPrivateKey) key;
  
              this.publicKey = null;
              resetDigest();
          }
  
          // initialize for signing. See JCA doc
          @Override
          protected void engineInitVerify(PublicKey key) throws InvalidKeyException {
              // This signature accepts only ECPublicKey
              if ((key instanceof ECPublicKey) == false) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported&quot;);</span>
              }
  
<span class="line-removed">- </span>
              if ((key instanceof CPublicKey) == false) {
                  try {
                      publicKey = importECPublicKey(&quot;EC&quot;,
                              CKey.generateECBlob(key),
                              KeyUtil.getKeySize(key));
<span class="line-new-header">--- 431,36 ---</span>
          }
  
          // initialize for signing. See JCA doc
          @Override
          protected void engineInitSign(PrivateKey key) throws InvalidKeyException {
<span class="line-added">+             if (key == null) {</span>
<span class="line-added">+                 throw new InvalidKeyException(&quot;Key cannot be null&quot;);</span>
<span class="line-added">+             }</span>
              if ((key instanceof CPrivateKey) == false
                      || !key.getAlgorithm().equalsIgnoreCase(&quot;EC&quot;)) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported: &quot;</span>
<span class="line-added">+                         + key.getClass() + &quot; &quot; + key.getAlgorithm());</span>
              }
              privateKey = (CPrivateKey) key;
  
              this.publicKey = null;
              resetDigest();
          }
  
          // initialize for signing. See JCA doc
          @Override
          protected void engineInitVerify(PublicKey key) throws InvalidKeyException {
<span class="line-added">+             if (key == null) {</span>
<span class="line-added">+                 throw new InvalidKeyException(&quot;Key cannot be null&quot;);</span>
<span class="line-added">+             }</span>
              // This signature accepts only ECPublicKey
              if ((key instanceof ECPublicKey) == false) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported: &quot;</span>
<span class="line-added">+                         + key.getClass());</span>
              }
  
              if ((key instanceof CPublicKey) == false) {
                  try {
                      publicKey = importECPublicKey(&quot;EC&quot;,
                              CKey.generateECBlob(key),
                              KeyUtil.getKeySize(key));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 489,13 ***</span>
              fallbackSignature = null;
          }
  
          @Override
          protected void engineInitVerify(PublicKey key) throws InvalidKeyException {
              // This signature accepts only RSAPublicKey
              if ((key instanceof java.security.interfaces.RSAPublicKey) == false) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported&quot;);</span>
              }
  
              this.privateKey = null;
  
              if (key instanceof CPublicKey) {
<span class="line-new-header">--- 519,17 ---</span>
              fallbackSignature = null;
          }
  
          @Override
          protected void engineInitVerify(PublicKey key) throws InvalidKeyException {
<span class="line-added">+             if (key == null) {</span>
<span class="line-added">+                 throw new InvalidKeyException(&quot;Key cannot be null&quot;);</span>
<span class="line-added">+             }</span>
              // This signature accepts only RSAPublicKey
              if ((key instanceof java.security.interfaces.RSAPublicKey) == false) {
<span class="line-modified">!                 throw new InvalidKeyException(&quot;Key type not supported: &quot;</span>
<span class="line-added">+                         + key.getClass());</span>
              }
  
              this.privateKey = null;
  
              if (key instanceof CPublicKey) {
</pre>
<center><a href="CPublicKey.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../native/libsunmscapi/security.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>