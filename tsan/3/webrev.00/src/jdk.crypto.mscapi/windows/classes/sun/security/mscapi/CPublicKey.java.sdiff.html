<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.mscapi/windows/classes/sun/security/mscapi/CPublicKey.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="CPrivateKey.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CSignature.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.mscapi/windows/classes/sun/security/mscapi/CPublicKey.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 42 import sun.security.rsa.RSAUtil.KeyType;
 43 import sun.security.rsa.RSAPublicKeyImpl;
 44 import sun.security.util.ECKeySizeParameterSpec;
 45 
 46 /**
 47  * The handle for an RSA public key using the Microsoft Crypto API.
 48  *
 49  * @since 1.6
 50  */
 51 public abstract class CPublicKey extends CKey implements PublicKey {
 52 
 53     private static final long serialVersionUID = -2289561342425825391L;
 54 
 55     protected byte[] encoding = null;
 56 
 57     public static class CECPublicKey extends CPublicKey implements ECPublicKey {
 58 
 59         private ECPoint w = null;
 60         private static final long serialVersionUID = 12L;
 61 
<span class="line-modified"> 62         CECPublicKey(long hCryptProv, int keyLength) {</span>
<span class="line-modified"> 63             super(&quot;EC&quot;, hCryptProv, 0, keyLength);</span>
 64         }
 65 
 66         @Override
 67         public ECPoint getW() {
 68             if (w == null) {
 69                 // See CKey::generateECBlob.
 70                 try {
 71                     byte[] blob = getPublicKeyBlob(
 72                             handles.hCryptProv, handles.hCryptKey);
 73                     int len = blob[8] &amp; 0xff;
 74                     byte[] x = Arrays.copyOfRange(blob, 8, 8 + len);
 75                     byte[] y = Arrays.copyOfRange(blob, 8 + len, 8 + len + len);
 76                     w = new ECPoint(new BigInteger(1, x), new BigInteger(1, y));
 77                 } catch (KeyException e) {
 78                     throw new ProviderException(e);
 79                 }
 80             }
 81             return w;
 82         }
 83 
</pre>
<hr />
<pre>
104             } catch (Exception e) {
105                 throw new ProviderException(e);
106             }
107         }
108 
109         public String toString() {
110             StringBuffer sb = new StringBuffer();
111             sb.append(algorithm + &quot;PublicKey [size=&quot;).append(keyLength)
112                     .append(&quot;]\n  ECPoint: &quot;).append(getW())
113                     .append(&quot;\n  params: &quot;).append(getParams());
114             return sb.toString();
115         }
116     }
117 
118     public static class CRSAPublicKey extends CPublicKey implements RSAPublicKey {
119 
120         private BigInteger modulus = null;
121         private BigInteger exponent = null;
122         private static final long serialVersionUID = 12L;
123 
<span class="line-modified">124         CRSAPublicKey(long hCryptProv, long hCryptKey, int keyLength) {</span>
<span class="line-modified">125             super(&quot;RSA&quot;, hCryptProv, hCryptKey, keyLength);</span>
126         }
127 
128         public String toString() {
129             StringBuffer sb = new StringBuffer();
130             sb.append(algorithm + &quot;PublicKey [size=&quot;).append(keyLength)
<span class="line-modified">131                     .append(&quot; bits, type=&quot;).append(getKeyType(handles.hCryptKey))</span>
<span class="line-modified">132                     .append(&quot;, container=&quot;).append(getContainerName(handles.hCryptProv))</span>
<span class="line-modified">133                     .append(&quot;]\n  modulus: &quot;).append(getModulus())</span>





134                     .append(&quot;\n  public exponent: &quot;).append(getPublicExponent());
135             return sb.toString();
136         }
137 
138         @Override
139         public BigInteger getPublicExponent() {
140             if (exponent == null) {
141                 try {
142                     byte[] publicKeyBlob = getPublicKeyBlob(
143                             handles.hCryptProv, handles.hCryptKey);
144                     exponent = new BigInteger(1, getExponent(publicKeyBlob));
145                 } catch (KeyException e) {
146                     throw new ProviderException(e);
147                 }
148             }
149             return exponent;
150         }
151 
152         @Override
153         public BigInteger getModulus() {
</pre>
<hr />
<pre>
164         }
165 
166         @Override
167         public byte[] getEncoded() {
168             if (encoding == null) {
169                 try {
170                     encoding = RSAPublicKeyImpl.newKey(KeyType.RSA, null,
171                             getModulus(), getPublicExponent()).getEncoded();
172                 } catch (KeyException e) {
173                     // ignore
174                 }
175             }
176             return encoding;
177         }
178 
179         private native byte[] getExponent(byte[] keyBlob) throws KeyException;
180 
181         private native byte[] getModulus(byte[] keyBlob) throws KeyException;
182     }
183 
<span class="line-modified">184     public static CPublicKey of(</span>

185             String alg, long hCryptProv, long hCryptKey, int keyLength) {





186         switch (alg) {
187             case &quot;RSA&quot;:
<span class="line-modified">188                 return new CRSAPublicKey(hCryptProv, hCryptKey, keyLength);</span>
189             case &quot;EC&quot;:
<span class="line-modified">190                 return new CECPublicKey(hCryptProv, keyLength);</span>
191             default:
192                 throw new AssertionError(&quot;Unsupported algorithm: &quot; + alg);
193         }
194     }
195 
196     protected CPublicKey(
<span class="line-modified">197             String alg, long hCryptProv, long hCryptKey, int keyLength) {</span>
<span class="line-modified">198         super(alg, hCryptProv, hCryptKey, keyLength);</span>
199     }
200 
201     @Override
202     public String getFormat() {
203         return &quot;X.509&quot;;
204     }
205 
206     protected Object writeReplace() throws java.io.ObjectStreamException {
207         return new KeyRep(KeyRep.Type.PUBLIC,
208                         getAlgorithm(),
209                         getFormat(),
210                         getEncoded());
211     }
212 
213     // Returns the CAPI or CNG representation of the key.
214     native byte[] getPublicKeyBlob(long hCryptProv, long hCryptKey)
215             throws KeyException;
216 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 42 import sun.security.rsa.RSAUtil.KeyType;
 43 import sun.security.rsa.RSAPublicKeyImpl;
 44 import sun.security.util.ECKeySizeParameterSpec;
 45 
 46 /**
 47  * The handle for an RSA public key using the Microsoft Crypto API.
 48  *
 49  * @since 1.6
 50  */
 51 public abstract class CPublicKey extends CKey implements PublicKey {
 52 
 53     private static final long serialVersionUID = -2289561342425825391L;
 54 
 55     protected byte[] encoding = null;
 56 
 57     public static class CECPublicKey extends CPublicKey implements ECPublicKey {
 58 
 59         private ECPoint w = null;
 60         private static final long serialVersionUID = 12L;
 61 
<span class="line-modified"> 62         CECPublicKey(NativeHandles handles, int keyLength) {</span>
<span class="line-modified"> 63             super(&quot;EC&quot;, handles, keyLength);</span>
 64         }
 65 
 66         @Override
 67         public ECPoint getW() {
 68             if (w == null) {
 69                 // See CKey::generateECBlob.
 70                 try {
 71                     byte[] blob = getPublicKeyBlob(
 72                             handles.hCryptProv, handles.hCryptKey);
 73                     int len = blob[8] &amp; 0xff;
 74                     byte[] x = Arrays.copyOfRange(blob, 8, 8 + len);
 75                     byte[] y = Arrays.copyOfRange(blob, 8 + len, 8 + len + len);
 76                     w = new ECPoint(new BigInteger(1, x), new BigInteger(1, y));
 77                 } catch (KeyException e) {
 78                     throw new ProviderException(e);
 79                 }
 80             }
 81             return w;
 82         }
 83 
</pre>
<hr />
<pre>
104             } catch (Exception e) {
105                 throw new ProviderException(e);
106             }
107         }
108 
109         public String toString() {
110             StringBuffer sb = new StringBuffer();
111             sb.append(algorithm + &quot;PublicKey [size=&quot;).append(keyLength)
112                     .append(&quot;]\n  ECPoint: &quot;).append(getW())
113                     .append(&quot;\n  params: &quot;).append(getParams());
114             return sb.toString();
115         }
116     }
117 
118     public static class CRSAPublicKey extends CPublicKey implements RSAPublicKey {
119 
120         private BigInteger modulus = null;
121         private BigInteger exponent = null;
122         private static final long serialVersionUID = 12L;
123 
<span class="line-modified">124         CRSAPublicKey(NativeHandles handles, int keyLength) {</span>
<span class="line-modified">125             super(&quot;RSA&quot;, handles, keyLength);</span>
126         }
127 
128         public String toString() {
129             StringBuffer sb = new StringBuffer();
130             sb.append(algorithm + &quot;PublicKey [size=&quot;).append(keyLength)
<span class="line-modified">131                     .append(&quot; bits, type=&quot;);</span>
<span class="line-modified">132             if (handles.hCryptKey != 0) {</span>
<span class="line-modified">133                 sb.append(getKeyType(handles.hCryptKey))</span>
<span class="line-added">134                         .append(&quot;, container=&quot;).append(getContainerName(handles.hCryptProv));</span>
<span class="line-added">135             } else {</span>
<span class="line-added">136                 sb.append(&quot;CNG&quot;);</span>
<span class="line-added">137             }</span>
<span class="line-added">138             sb.append(&quot;]\n  modulus: &quot;).append(getModulus())</span>
139                     .append(&quot;\n  public exponent: &quot;).append(getPublicExponent());
140             return sb.toString();
141         }
142 
143         @Override
144         public BigInteger getPublicExponent() {
145             if (exponent == null) {
146                 try {
147                     byte[] publicKeyBlob = getPublicKeyBlob(
148                             handles.hCryptProv, handles.hCryptKey);
149                     exponent = new BigInteger(1, getExponent(publicKeyBlob));
150                 } catch (KeyException e) {
151                     throw new ProviderException(e);
152                 }
153             }
154             return exponent;
155         }
156 
157         @Override
158         public BigInteger getModulus() {
</pre>
<hr />
<pre>
169         }
170 
171         @Override
172         public byte[] getEncoded() {
173             if (encoding == null) {
174                 try {
175                     encoding = RSAPublicKeyImpl.newKey(KeyType.RSA, null,
176                             getModulus(), getPublicExponent()).getEncoded();
177                 } catch (KeyException e) {
178                     // ignore
179                 }
180             }
181             return encoding;
182         }
183 
184         private native byte[] getExponent(byte[] keyBlob) throws KeyException;
185 
186         private native byte[] getModulus(byte[] keyBlob) throws KeyException;
187     }
188 
<span class="line-modified">189     // Called by native code inside security.cpp</span>
<span class="line-added">190     static CPublicKey of(</span>
191             String alg, long hCryptProv, long hCryptKey, int keyLength) {
<span class="line-added">192         return of(alg, new NativeHandles(hCryptProv, hCryptKey), keyLength);</span>
<span class="line-added">193     }</span>
<span class="line-added">194 </span>
<span class="line-added">195     public static CPublicKey of(</span>
<span class="line-added">196             String alg, NativeHandles handles, int keyLength) {</span>
197         switch (alg) {
198             case &quot;RSA&quot;:
<span class="line-modified">199                 return new CRSAPublicKey(handles, keyLength);</span>
200             case &quot;EC&quot;:
<span class="line-modified">201                 return new CECPublicKey(handles, keyLength);</span>
202             default:
203                 throw new AssertionError(&quot;Unsupported algorithm: &quot; + alg);
204         }
205     }
206 
207     protected CPublicKey(
<span class="line-modified">208             String alg, NativeHandles handles, int keyLength) {</span>
<span class="line-modified">209         super(alg, handles, keyLength);</span>
210     }
211 
212     @Override
213     public String getFormat() {
214         return &quot;X.509&quot;;
215     }
216 
217     protected Object writeReplace() throws java.io.ObjectStreamException {
218         return new KeyRep(KeyRep.Type.PUBLIC,
219                         getAlgorithm(),
220                         getFormat(),
221                         getEncoded());
222     }
223 
224     // Returns the CAPI or CNG representation of the key.
225     native byte[] getPublicKeyBlob(long hCryptProv, long hCryptKey)
226             throws KeyException;
227 }
</pre>
</td>
</tr>
</table>
<center><a href="CPrivateKey.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CSignature.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>