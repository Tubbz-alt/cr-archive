<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.incubator.jpackage/share/native/libapplauncher/Package.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;Package.h&quot;
 27 #include &quot;Helpers.h&quot;
 28 #include &quot;Macros.h&quot;
 29 #include &quot;IniFile.h&quot;
 30 
 31 #include &lt;assert.h&gt;
 32 
 33 
 34 Package::Package(void) {
 35     FInitialized = false;
 36     Initialize();
 37 }
 38 
 39 TPlatformNumber StringToPercentageOfNumber(TString Value,
 40         TPlatformNumber Number) {
 41     TPlatformNumber result = 0;
 42     size_t percentage = atoi(PlatformString(Value.c_str()));
 43 
 44     if (percentage &gt; 0 &amp;&amp; Number &gt; 0) {
 45         result = Number * percentage / 100;
 46     }
 47 
 48     return result;
 49 }
 50 
 51 void Package::Initialize() {
 52     if (FInitialized == true) {
 53         return;
 54     }
 55 
 56     Platform&amp; platform = Platform::GetInstance();
 57 
 58     FBootFields = new PackageBootFields();
 59     FDebugging = dsNone;
 60 
 61     // Allow duplicates for Java options, so we can have multiple --add-exports
 62     // or similar args.
 63     FBootFields-&gt;FJavaOptions.SetAllowDuplicates(true);
 64     FBootFields-&gt;FPackageRootDirectory = platform.GetPackageRootDirectory();
 65     FBootFields-&gt;FPackageAppDirectory = platform.GetPackageAppDirectory();
 66     FBootFields-&gt;FPackageLauncherDirectory =
 67             platform.GetPackageLauncherDirectory();
 68     FBootFields-&gt;FAppDataDirectory = platform.GetAppDataDirectory();
 69 
 70     std::map&lt;TString, TString&gt; keys = platform.GetKeys();
 71 
 72     // Read from configure.cfg/Info.plist
 73     AutoFreePtr&lt;ISectionalPropertyContainer&gt; config =
 74             platform.GetConfigFile(platform.GetConfigFileName());
 75 
 76     config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
 77             keys[JPACKAGE_APP_DATA_DIR], FBootFields-&gt;FPackageAppDataDirectory);
 78     FBootFields-&gt;FPackageAppDataDirectory =
 79             FilePath::FixPathForPlatform(FBootFields-&gt;FPackageAppDataDirectory);
 80 
 81     // Main JAR.
 82     config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
 83             keys[CONFIG_MAINJAR_KEY], FBootFields-&gt;FMainJar);
 84     FBootFields-&gt;FMainJar = FilePath::FixPathForPlatform(FBootFields-&gt;FMainJar);
 85 
 86     // Main Module.
 87     config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
 88             keys[CONFIG_MAINMODULE_KEY], FBootFields-&gt;FMainModule);
 89 
 90     // Classpath.
 91     // 1. If the provided class path contains main jar then only use
 92     //    provided class path.
 93     // 2. If class path provided by config file is empty then add main jar.
 94     // 3. If main jar is not in provided class path then add it.
 95     config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
 96             keys[CONFIG_CLASSPATH_KEY], FBootFields-&gt;FClassPath);
 97     FBootFields-&gt;FClassPath =
 98             FilePath::FixPathSeparatorForPlatform(FBootFields-&gt;FClassPath);
 99 
100     if (FBootFields-&gt;FClassPath.empty() == true) {
101         FBootFields-&gt;FClassPath = GetMainJar();
102     } else if (FBootFields-&gt;FClassPath.find(GetMainJar()) == TString::npos) {
103         FBootFields-&gt;FClassPath = GetMainJar()
104                 + FilePath::PathSeparator() + FBootFields-&gt;FClassPath;
105     }
106 
107     // Modulepath.
108     config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
109             keys[CONFIG_MODULEPATH_KEY], FBootFields-&gt;FModulePath);
110     FBootFields-&gt;FModulePath =
111             FilePath::FixPathSeparatorForPlatform(FBootFields-&gt;FModulePath);
112 
113     // Main Class.
114     config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
115             keys[CONFIG_MAINCLASSNAME_KEY], FBootFields-&gt;FMainClassName);
116 
117     // Splash Screen.
118     if (config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
119             keys[CONFIG_SPLASH_KEY],
120             FBootFields-&gt;FSplashScreenFileName) == true) {
121         FBootFields-&gt;FSplashScreenFileName =
122             FilePath::IncludeTrailingSeparator(GetPackageAppDirectory())
123             + FilePath::FixPathForPlatform(FBootFields-&gt;FSplashScreenFileName);
124 
125         if (FilePath::FileExists(FBootFields-&gt;FSplashScreenFileName) == false) {
126             FBootFields-&gt;FSplashScreenFileName = _T(&quot;&quot;);
127         }
128     }
129 
130     // Runtime.
131     config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
132             keys[JAVA_RUNTIME_KEY], FBootFields-&gt;FJavaRuntimeDirectory);
133 
134     // Read jvmargs.
135     PromoteAppCDSState(config);
136     ReadJavaOptions(config);
137 
138     // Read args if none were passed in.
139     if (FBootFields-&gt;FArgs.size() == 0) {
140         OrderedMap&lt;TString, TString&gt; args;
141 
142         if (config-&gt;GetSection(keys[CONFIG_SECTION_ARGOPTIONS], args) == true) {
143             FBootFields-&gt;FArgs = Helpers::MapToNameValueList(args);
144         }
145     }
146 
147     // Auto Memory.
148     TString autoMemory;
149 
150     if (config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
151             keys[CONFIG_APP_MEMORY], autoMemory) == true) {
152         if (autoMemory == _T(&quot;auto&quot;) || autoMemory == _T(&quot;100%&quot;)) {
153             FBootFields-&gt;FMemoryState = PackageBootFields::msAuto;
154             FBootFields-&gt;FMemorySize = platform.GetMemorySize();
155         } else if (autoMemory.length() == 2 &amp;&amp; isdigit(autoMemory[0]) &amp;&amp;
156                 autoMemory[1] == &#39;%&#39;) {
157             FBootFields-&gt;FMemoryState = PackageBootFields::msAuto;
158             FBootFields-&gt;FMemorySize =
159                     StringToPercentageOfNumber(autoMemory.substr(0, 1),
160                     platform.GetMemorySize());
161         } else if (autoMemory.length() == 3 &amp;&amp; isdigit(autoMemory[0]) &amp;&amp;
162                 isdigit(autoMemory[1]) &amp;&amp; autoMemory[2] == &#39;%&#39;) {
163             FBootFields-&gt;FMemoryState = PackageBootFields::msAuto;
164             FBootFields-&gt;FMemorySize =
165                     StringToPercentageOfNumber(autoMemory.substr(0, 2),
166                     platform.GetMemorySize());
167         } else {
168             FBootFields-&gt;FMemoryState = PackageBootFields::msManual;
169             FBootFields-&gt;FMemorySize = 0;
170         }
171     }
172 
173     // Debug
174     TString debug;
175     if (config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
176             keys[CONFIG_APP_DEBUG], debug) == true) {
177         FBootFields-&gt;FArgs.push_back(debug);
178     }
179 }
180 
181 void Package::Clear() {
182     FreeBootFields();
183     FInitialized = false;
184 }
185 
186 // This is the only location that the AppCDS state should be modified except
187 // by command line arguments provided by the user.
188 //
189 // The state of AppCDS is as follows:
190 //
191 // -&gt; cdsUninitialized
192 //    -&gt; cdsGenCache If -Xappcds:generatecache
193 //    -&gt; cdsDisabled If -Xappcds:off
194 //    -&gt; cdsEnabled If &quot;AppCDSJavaOptions&quot; section is present
195 //    -&gt; cdsAuto If &quot;AppCDSJavaOptions&quot; section is present and
196 //               app.appcds.cache=auto
197 //    -&gt; cdsDisabled Default
198 //
199 void Package::PromoteAppCDSState(ISectionalPropertyContainer* Config) {
200     Platform&amp; platform = Platform::GetInstance();
201     std::map&lt;TString, TString&gt; keys = platform.GetKeys();
202 
203     // The AppCDS state can change at this point.
204     switch (platform.GetAppCDSState()) {
205         case cdsEnabled:
206         case cdsAuto:
207         case cdsDisabled:
208         case cdsGenCache: {
209             // Do nothing.
210             break;
211         }
212 
213         case cdsUninitialized: {
214             if (Config-&gt;ContainsSection(
215                     keys[CONFIG_SECTION_APPCDSJAVAOPTIONS]) == true) {
216                 // If the AppCDS section is present then enable AppCDS.
217                 TString appCDSCacheValue;
218 
219                 // If running with AppCDS enabled, and the configuration has
220                 // been setup so &quot;auto&quot; is enabled, then
221                 // the launcher will attempt to generate the cache file
222                 // automatically and run the application.
223                 if (Config-&gt;GetValue(keys[CONFIG_SECTION_APPLICATION],
224                         _T(&quot;app.appcds.cache&quot;), appCDSCacheValue) == true &amp;&amp;
225                     appCDSCacheValue == _T(&quot;auto&quot;)) {
226                     platform.SetAppCDSState(cdsAuto);
227                 }
228                 else {
229                     platform.SetAppCDSState(cdsEnabled);
230                 }
231             } else {
232 
233                 platform.SetAppCDSState(cdsDisabled);
234             }
235         }
236     }
237 }
238 
239 void Package::ReadJavaOptions(ISectionalPropertyContainer* Config) {
240     Platform&amp; platform = Platform::GetInstance();
241     std::map&lt;TString, TString&gt; keys = platform.GetKeys();
242 
243     // Evaluate based on the current AppCDS state.
244     switch (platform.GetAppCDSState()) {
245         case cdsUninitialized: {
246             throw Exception(_T(&quot;Internal Error&quot;));
247         }
248 
249         case cdsDisabled: {
250             Config-&gt;GetSection(keys[CONFIG_SECTION_JAVAOPTIONS],
251                     FBootFields-&gt;FJavaOptions);
252             break;
253         }
254 
255         case cdsGenCache: {
256             Config-&gt;GetSection(keys[
257                     CONFIG_SECTION_APPCDSGENERATECACHEJAVAOPTIONS],
258                     FBootFields-&gt;FJavaOptions);
259             break;
260         }
261 
262         case cdsAuto:
263         case cdsEnabled: {
264             if (Config-&gt;GetValue(keys[CONFIG_SECTION_APPCDSJAVAOPTIONS],
265                     _T( &quot;-XX:SharedArchiveFile&quot;),
266                     FBootFields-&gt;FAppCDSCacheFileName) == true) {
267                 // File names may contain the incorrect path separators.
268                 // The cache file name must be corrected at this point.
269                 if (FBootFields-&gt;FAppCDSCacheFileName.empty() == false) {
270                     IniFile* iniConfig = dynamic_cast&lt;IniFile*&gt;(Config);
271 
272                     if (iniConfig != NULL) {
273                         FBootFields-&gt;FAppCDSCacheFileName =
274                                 FilePath::FixPathForPlatform(
275                                 FBootFields-&gt;FAppCDSCacheFileName);
276                         iniConfig-&gt;SetValue(keys[
277                                 CONFIG_SECTION_APPCDSJAVAOPTIONS],
278                                 _T( &quot;-XX:SharedArchiveFile&quot;),
279                                 FBootFields-&gt;FAppCDSCacheFileName);
280                     }
281                 }
282 
283                 Config-&gt;GetSection(keys[CONFIG_SECTION_APPCDSJAVAOPTIONS],
284                         FBootFields-&gt;FJavaOptions);
285             }
286 
287             break;
288         }
289     }
290 }
291 
292 void Package::SetCommandLineArguments(int argc, TCHAR* argv[]) {
293     if (argc &gt; 0) {
294         std::list&lt;TString&gt; args;
295 
296         // Prepare app arguments. Skip value at index 0 -
297         // this is path to executable.
298         FBootFields-&gt;FCommandName = argv[0];
299 
300         // Path to executable is at 0 index so start at index 1.
301         for (int index = 1; index &lt; argc; index++) {
302             TString arg = argv[index];
303 
304 #ifdef DEBUG
305             if (arg == _T(&quot;-debug&quot;)) {
306                 FDebugging = dsNative;
307             }
308 
309             if (arg == _T(&quot;-javadebug&quot;)) {
310                 FDebugging = dsJava;
311             }
312 #endif //DEBUG
313 #ifdef MAC
314             if (arg.find(_T(&quot;-psn_&quot;), 0) != TString::npos) {
315                 Platform&amp; platform = Platform::GetInstance();
316 
317                 if (platform.IsMainThread() == true) {
318 #ifdef DEBUG
319                     printf(&quot;%s\n&quot;, arg.c_str());
320 #endif //DEBUG
321                     continue;
322                 }
323             }
324 
325             if (arg == _T(&quot;-NSDocumentRevisionsDebugMode&quot;)) {
326                 // Ignore -NSDocumentRevisionsDebugMode and
327                 // the following YES/NO
328                 index++;
329                 continue;
330             }
331 #endif //MAC
332 
333             args.push_back(arg);
334         }
335 
336         if (args.size() &gt; 0) {
337             FBootFields-&gt;FArgs = args;
338         }
339     }
340 }
341 
342 Package&amp; Package::GetInstance() {
343     static Package instance;
344     // Guaranteed to be destroyed. Instantiated on first use.
345     return instance;
346 }
347 
348 Package::~Package(void) {
349     FreeBootFields();
350 }
351 
352 void Package::FreeBootFields() {
353     if (FBootFields != NULL) {
354         delete FBootFields;
355         FBootFields = NULL;
356     }
357 }
358 
359 OrderedMap&lt;TString, TString&gt; Package::GetJavaOptions() {
360     return FBootFields-&gt;FJavaOptions;
361 }
362 
363 std::vector&lt;TString&gt; GetKeysThatAreNotDuplicates(OrderedMap&lt;TString,
364         TString&gt; &amp;Defaults, OrderedMap&lt;TString, TString&gt; &amp;Overrides) {
365     std::vector&lt;TString&gt; result;
366     std::vector&lt;TString&gt; overrideKeys = Overrides.GetKeys();
367 
368     for (size_t index = 0; index &lt; overrideKeys.size(); index++) {
369         TString overridesKey = overrideKeys[index];
370         TString overridesValue;
371         TString defaultValue;
372 
373         if ((Defaults.ContainsKey(overridesKey) == false) ||
374            (Defaults.GetValue(overridesKey, defaultValue) == true &amp;&amp;
375             Overrides.GetValue(overridesKey, overridesValue) == true &amp;&amp;
376             defaultValue != overridesValue)) {
377             result.push_back(overridesKey);
378         }
379     }
380 
381     return result;
382 }
383 
384 OrderedMap&lt;TString, TString&gt; CreateOrderedMapFromKeyList(OrderedMap&lt;TString,
385         TString&gt; &amp;Map, std::vector&lt;TString&gt; &amp;Keys) {
386     OrderedMap&lt;TString, TString&gt; result;
387 
388     for (size_t index = 0; index &lt; Keys.size(); index++) {
389         TString key = Keys[index];
390         TString value;
391 
392         if (Map.GetValue(key, value) == true) {
393             result.Append(key, value);
394         }
395     }
396 
397     return result;
398 }
399 
400 std::vector&lt;TString&gt; GetKeysThatAreNotOverridesOfDefaultValues(
401         OrderedMap&lt;TString, TString&gt; &amp;Defaults, OrderedMap&lt;TString,
402         TString&gt; &amp;Overrides) {
403     std::vector&lt;TString&gt; result;
404     std::vector&lt;TString&gt; keys = Overrides.GetKeys();
405 
406     for (unsigned int index = 0; index&lt; keys.size(); index++) {
407         TString key = keys[index];
408 
409         if (Defaults.ContainsKey(key) == true) {
410             try {
411                 TString value = Overrides[key];
412                 Defaults[key] = value;
413             }
414             catch (std::out_of_range &amp;) {
415             }
416         }
417         else {
418             result.push_back(key);
419         }
420     }
421 
422     return result;
423 }
424 
425 std::list&lt;TString&gt; Package::GetArgs() {
426     assert(FBootFields != NULL);
427     return FBootFields-&gt;FArgs;
428 }
429 
430 TString Package::GetPackageRootDirectory() {
431     assert(FBootFields != NULL);
432     return FBootFields-&gt;FPackageRootDirectory;
433 }
434 
435 TString Package::GetPackageAppDirectory() {
436     assert(FBootFields != NULL);
437     return FBootFields-&gt;FPackageAppDirectory;
438 }
439 
440 TString Package::GetPackageLauncherDirectory() {
441     assert(FBootFields != NULL);
442     return FBootFields-&gt;FPackageLauncherDirectory;
443 }
444 
445 TString Package::GetAppDataDirectory() {
446     assert(FBootFields != NULL);
447     return FBootFields-&gt;FAppDataDirectory;
448 }
449 
450 TString Package::GetAppCDSCacheDirectory() {
451     if (FAppCDSCacheDirectory.empty()) {
452         Platform&amp; platform = Platform::GetInstance();
453         FAppCDSCacheDirectory = FilePath::IncludeTrailingSeparator(
454                 platform.GetAppDataDirectory())
455                 + FilePath::IncludeTrailingSeparator(
456                 GetPackageAppDataDirectory()) + _T(&quot;cache&quot;);
457 
458         Macros&amp; macros = Macros::GetInstance();
459         FAppCDSCacheDirectory = macros.ExpandMacros(FAppCDSCacheDirectory);
460         FAppCDSCacheDirectory =
461                 FilePath::FixPathForPlatform(FAppCDSCacheDirectory);
462     }
463 
464     return FAppCDSCacheDirectory;
465 }
466 
467 TString Package::GetAppCDSCacheFileName() {
468     assert(FBootFields != NULL);
469 
470     if (FBootFields-&gt;FAppCDSCacheFileName.empty() == false) {
471         Macros&amp; macros = Macros::GetInstance();
472         FBootFields-&gt;FAppCDSCacheFileName =
473                 macros.ExpandMacros(FBootFields-&gt;FAppCDSCacheFileName);
474         FBootFields-&gt;FAppCDSCacheFileName =
475                 FilePath::FixPathForPlatform(FBootFields-&gt;FAppCDSCacheFileName);
476     }
477 
478     return FBootFields-&gt;FAppCDSCacheFileName;
479 }
480 
481 TString Package::GetPackageAppDataDirectory() {
482     assert(FBootFields != NULL);
483     return FBootFields-&gt;FPackageAppDataDirectory;
484 }
485 
486 TString Package::GetClassPath() {
487     assert(FBootFields != NULL);
488     return FBootFields-&gt;FClassPath;
489 }
490 
491 TString Package::GetModulePath() {
492     assert(FBootFields != NULL);
493     return FBootFields-&gt;FModulePath;
494 }
495 
496 TString Package::GetMainJar() {
497     assert(FBootFields != NULL);
498     return FBootFields-&gt;FMainJar;
499 }
500 
501 TString Package::GetMainModule() {
502     assert(FBootFields != NULL);
503     return FBootFields-&gt;FMainModule;
504 }
505 
506 TString Package::GetMainClassName() {
507     assert(FBootFields != NULL);
508     return FBootFields-&gt;FMainClassName;
509 }
510 
511 TString Package::GetJavaLibraryFileName() {
512     assert(FBootFields != NULL);
513 
514     if (FBootFields-&gt;FJavaLibraryFileName.empty() == true) {
515         Platform&amp; platform = Platform::GetInstance();
516         Macros&amp; macros = Macros::GetInstance();
517         TString jvmRuntimePath = macros.ExpandMacros(GetJavaRuntimeDirectory());
518         FBootFields-&gt;FJavaLibraryFileName =
519                 platform.GetBundledJavaLibraryFileName(jvmRuntimePath);
520     }
521 
522     return FBootFields-&gt;FJavaLibraryFileName;
523 }
524 
525 TString Package::GetJavaRuntimeDirectory() {
526     assert(FBootFields != NULL);
527     return FBootFields-&gt;FJavaRuntimeDirectory;
528 }
529 
530 TString Package::GetSplashScreenFileName() {
531     assert(FBootFields != NULL);
532     return FBootFields-&gt;FSplashScreenFileName;
533 }
534 
535 bool Package::HasSplashScreen() {
536     assert(FBootFields != NULL);
537     return FilePath::FileExists(FBootFields-&gt;FSplashScreenFileName);
538 }
539 
540 TString Package::GetCommandName() {
541     assert(FBootFields != NULL);
542     return FBootFields-&gt;FCommandName;
543 }
544 
545 TPlatformNumber Package::GetMemorySize() {
546     assert(FBootFields != NULL);
547     return FBootFields-&gt;FMemorySize;
548 }
549 
550 PackageBootFields::MemoryState Package::GetMemoryState() {
551     assert(FBootFields != NULL);
552     return FBootFields-&gt;FMemoryState;
553 }
554 
555 DebugState Package::Debugging() {
556     return FDebugging;
557 }
    </pre>
  </body>
</html>