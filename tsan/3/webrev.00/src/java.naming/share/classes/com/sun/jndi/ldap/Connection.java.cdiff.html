<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.naming/share/classes/com/sun/jndi/ldap/Connection.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="BerDecoder.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DefaultLdapDnsProvider.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.naming/share/classes/com/sun/jndi/ldap/Connection.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 406,69 ***</span>
      }
  
      /**
       * Reads a reply; waits until one is ready.
       */
<span class="line-modified">!     BerDecoder readReply(LdapRequest ldr)</span>
<span class="line-removed">-             throws IOException, NamingException {</span>
          BerDecoder rber;
  
<span class="line-modified">!         // Track down elapsed time to workaround spurious wakeups</span>
<span class="line-modified">!         long elapsedMilli = 0;</span>
<span class="line-modified">!         long elapsedNano = 0;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         while (((rber = ldr.getReplyBer()) == null) &amp;&amp;</span>
<span class="line-removed">-                 (readTimeout &lt;= 0 || elapsedMilli &lt; readTimeout))</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-             try {</span>
<span class="line-removed">-                 // If socket closed, don&#39;t even try</span>
<span class="line-removed">-                 synchronized (this) {</span>
<span class="line-removed">-                     if (sock == null) {</span>
<span class="line-removed">-                         throw new ServiceUnavailableException(host + &quot;:&quot; + port +</span>
<span class="line-removed">-                             &quot;; socket closed&quot;);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 synchronized (ldr) {</span>
<span class="line-removed">-                     // check if condition has changed since our last check</span>
<span class="line-removed">-                     rber = ldr.getReplyBer();</span>
<span class="line-removed">-                     if (rber == null) {</span>
<span class="line-removed">-                         if (readTimeout &gt; 0) {  // Socket read timeout is specified</span>
<span class="line-removed">-                             long beginNano = System.nanoTime();</span>
<span class="line-removed">- </span>
<span class="line-removed">-                             // will be woken up before readTimeout if reply is</span>
<span class="line-removed">-                             // available</span>
<span class="line-removed">-                             ldr.wait(readTimeout - elapsedMilli);</span>
<span class="line-removed">-                             elapsedNano += (System.nanoTime() - beginNano);</span>
<span class="line-removed">-                             elapsedMilli += elapsedNano / 1000_000;</span>
<span class="line-removed">-                             elapsedNano %= 1000_000;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                         } else {</span>
<span class="line-removed">-                             // no timeout is set so we wait infinitely until</span>
<span class="line-removed">-                             // a response is received</span>
<span class="line-removed">-                             // http://docs.oracle.com/javase/8/docs/technotes/guides/jndi/jndi-ldap.html#PROP</span>
<span class="line-removed">-                             ldr.wait();</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     } else {</span>
<span class="line-removed">-                         break;</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             } catch (InterruptedException ex) {</span>
<span class="line-removed">-                 throw new InterruptedNamingException(</span>
<span class="line-removed">-                     &quot;Interrupted during LDAP operation&quot;);</span>
              }
          }
  
<span class="line-modified">!         if ((rber == null) &amp;&amp; (elapsedMilli &gt;= readTimeout)) {</span>
              abandonRequest(ldr, null);
<span class="line-modified">!             throw new NamingException(&quot;LDAP response read timed out, timeout used:&quot;</span>
                              + readTimeout + &quot;ms.&quot; );
  
          }
          return rber;
      }
  
<span class="line-removed">- </span>
      ////////////////////////////////////////////////////////////////////////////
      //
      // Methods to add, find, delete, and abandon requests made to server
      //
      ////////////////////////////////////////////////////////////////////////////
<span class="line-new-header">--- 406,41 ---</span>
      }
  
      /**
       * Reads a reply; waits until one is ready.
       */
<span class="line-modified">!     BerDecoder readReply(LdapRequest ldr) throws IOException, NamingException {</span>
          BerDecoder rber;
  
<span class="line-modified">!         // If socket closed, don&#39;t even try</span>
<span class="line-modified">!         synchronized (this) {</span>
<span class="line-modified">!             if (sock == null) {</span>
<span class="line-modified">!                 throw new ServiceUnavailableException(host + &quot;:&quot; + port +</span>
<span class="line-modified">!                     &quot;; socket closed&quot;);</span>
              }
          }
  
<span class="line-modified">!         try {</span>
<span class="line-added">+             // if no timeout is set so we wait infinitely until</span>
<span class="line-added">+             // a response is received</span>
<span class="line-added">+             // http://docs.oracle.com/javase/8/docs/technotes/guides/jndi/jndi-ldap.html#PROP</span>
<span class="line-added">+             rber = ldr.getReplyBer(readTimeout);</span>
<span class="line-added">+         } catch (InterruptedException ex) {</span>
<span class="line-added">+             throw new InterruptedNamingException(</span>
<span class="line-added">+                 &quot;Interrupted during LDAP operation&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (rber == null) {</span>
              abandonRequest(ldr, null);
<span class="line-modified">!             throw new NamingException(</span>
<span class="line-added">+                     &quot;LDAP response read timed out, timeout used:&quot;</span>
                              + readTimeout + &quot;ms.&quot; );
  
          }
          return rber;
      }
  
      ////////////////////////////////////////////////////////////////////////////
      //
      // Methods to add, find, delete, and abandon requests made to server
      //
      ////////////////////////////////////////////////////////////////////////////
</pre>
<hr />
<pre>
<span class="line-old-header">*** 658,18 ***</span>
                  nparent = notifyParent;
              }
              if (nparent) {
                  LdapRequest ldr = pendingRequests;
                  while (ldr != null) {
<span class="line-modified">! </span>
<span class="line-removed">-                     synchronized (ldr) {</span>
<span class="line-removed">-                         ldr.notify();</span>
                          ldr = ldr.next;
                      }
                  }
              }
<span class="line-removed">-         }</span>
          if (nparent) {
              parent.processConnectionClosure();
          }
      }
  
<span class="line-new-header">--- 630,15 ---</span>
                  nparent = notifyParent;
              }
              if (nparent) {
                  LdapRequest ldr = pendingRequests;
                  while (ldr != null) {
<span class="line-modified">!                     ldr.close();</span>
                          ldr = ldr.next;
                      }
                  }
              }
          if (nparent) {
              parent.processConnectionClosure();
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 753,11 ***</span>
       * never be in midst of reading a buffer when a nonfatal close occurs.
       * If this occurs, then the connection is in an inconsistent state and
       * the safest thing to do is to shut it down.
       */
  
<span class="line-modified">!     private Object pauseLock = new Object();  // lock for reader to wait on while paused</span>
      private boolean paused = false;           // paused state of reader
  
      /*
       * Unpauses reader thread if it was paused
       */
<span class="line-new-header">--- 722,11 ---</span>
       * never be in midst of reading a buffer when a nonfatal close occurs.
       * If this occurs, then the connection is in an inconsistent state and
       * the safest thing to do is to shut it down.
       */
  
<span class="line-modified">!     private final Object pauseLock = new Object();  // lock for reader to wait on while paused</span>
      private boolean paused = false;           // paused state of reader
  
      /*
       * Unpauses reader thread if it was paused
       */
</pre>
<center><a href="BerDecoder.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DefaultLdapDnsProvider.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>