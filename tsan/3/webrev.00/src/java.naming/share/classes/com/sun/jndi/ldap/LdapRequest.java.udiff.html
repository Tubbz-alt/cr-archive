<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.naming/share/classes/com/sun/jndi/ldap/LdapRequest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LdapDnsProviderService.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../toolkit/ctx/Continuation.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.naming/share/classes/com/sun/jndi/ldap/LdapRequest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -27,94 +27,96 @@</span>
  
  import java.io.IOException;
  import java.util.concurrent.BlockingQueue;
  import java.util.concurrent.LinkedBlockingQueue;
  import javax.naming.CommunicationException;
<span class="udiff-line-added">+ import java.util.concurrent.TimeUnit;</span>
  
  final class LdapRequest {
  
<span class="udiff-line-modified-removed">-     LdapRequest next;   // Set/read in synchronized Connection methods</span>
<span class="udiff-line-removed">-     int msgId;          // read-only</span>
<span class="udiff-line-modified-added">+     private final static BerDecoder EOF = new BerDecoder(new byte[]{}, -1, 0);</span>
  
<span class="udiff-line-modified-removed">-     private int gotten = 0;</span>
<span class="udiff-line-modified-removed">-     private BlockingQueue&lt;BerDecoder&gt; replies;</span>
<span class="udiff-line-removed">-     private int highWatermark = -1;</span>
<span class="udiff-line-removed">-     private boolean cancelled = false;</span>
<span class="udiff-line-removed">-     private boolean pauseAfterReceipt = false;</span>
<span class="udiff-line-removed">-     private boolean completed = false;</span>
<span class="udiff-line-modified-added">+     LdapRequest next;   // Set/read in synchronized Connection methods</span>
<span class="udiff-line-modified-added">+     final int msgId;          // read-only</span>
  
<span class="udiff-line-modified-removed">-     LdapRequest(int msgId, boolean pause) {</span>
<span class="udiff-line-modified-removed">-         this(msgId, pause, -1);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     private final BlockingQueue&lt;BerDecoder&gt; replies;</span>
<span class="udiff-line-modified-added">+     private volatile boolean cancelled;</span>
<span class="udiff-line-modified-added">+     private volatile boolean closed;</span>
<span class="udiff-line-added">+     private volatile boolean completed;</span>
<span class="udiff-line-added">+     private final boolean pauseAfterReceipt;</span>
  
      LdapRequest(int msgId, boolean pause, int replyQueueCapacity) {
          this.msgId = msgId;
          this.pauseAfterReceipt = pause;
          if (replyQueueCapacity == -1) {
<span class="udiff-line-modified-removed">-             this.replies = new LinkedBlockingQueue&lt;BerDecoder&gt;();</span>
<span class="udiff-line-modified-added">+             this.replies = new LinkedBlockingQueue&lt;&gt;();</span>
          } else {
<span class="udiff-line-modified-removed">-             this.replies =</span>
<span class="udiff-line-removed">-                 new LinkedBlockingQueue&lt;BerDecoder&gt;(replyQueueCapacity);</span>
<span class="udiff-line-removed">-             highWatermark = (replyQueueCapacity * 80) / 100; // 80% capacity</span>
<span class="udiff-line-modified-added">+             this.replies = new LinkedBlockingQueue&lt;&gt;(8 * replyQueueCapacity / 10);</span>
          }
      }
  
<span class="udiff-line-modified-removed">-     synchronized void cancel() {</span>
<span class="udiff-line-modified-added">+     void cancel() {</span>
          cancelled = true;
<span class="udiff-line-added">+         replies.offer(EOF);</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         // Unblock reader of pending request</span>
<span class="udiff-line-modified-removed">-         // Should only ever have at most one waiter</span>
<span class="udiff-line-modified-removed">-         notify();</span>
<span class="udiff-line-modified-added">+     synchronized void close() {</span>
<span class="udiff-line-modified-added">+         closed = true;</span>
<span class="udiff-line-modified-added">+         replies.offer(EOF);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private boolean isClosed() {</span>
<span class="udiff-line-added">+         return closed &amp;&amp; (replies.size() == 0 || replies.peek() == EOF);</span>
      }
  
      synchronized boolean addReplyBer(BerDecoder ber) {
<span class="udiff-line-modified-removed">-         if (cancelled) {</span>
<span class="udiff-line-modified-added">+         // check the closed boolean value here as we don&#39;t want anything</span>
<span class="udiff-line-added">+         // to be added to the queue after close() has been called.</span>
<span class="udiff-line-added">+         if (cancelled || closed) {</span>
              return false;
          }
  
<span class="udiff-line-removed">-         // Add a new reply to the queue of unprocessed replies.</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             replies.put(ber);</span>
<span class="udiff-line-removed">-         } catch (InterruptedException e) {</span>
<span class="udiff-line-removed">-             // ignore</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          // peek at the BER buffer to check if it is a SearchResultDone PDU
          try {
              ber.parseSeq(null);
              ber.parseInt();
              completed = (ber.peekByte() == LdapClient.LDAP_REP_RESULT);
          } catch (IOException e) {
              // ignore
          }
          ber.reset();
  
<span class="udiff-line-modified-removed">-         notify(); // notify anyone waiting for reply</span>
<span class="udiff-line-modified-removed">-         /*</span>
<span class="udiff-line-modified-removed">-          * If a queue capacity has been set then trigger a pause when the</span>
<span class="udiff-line-modified-removed">-          * queue has filled to 80% capacity. Later, when the queue has drained</span>
<span class="udiff-line-modified-removed">-          * then the reader gets unpaused.</span>
<span class="udiff-line-removed">-          */</span>
<span class="udiff-line-removed">-         if (highWatermark != -1 &amp;&amp; replies.size() &gt;= highWatermark) {</span>
<span class="udiff-line-removed">-             return true; // trigger the pause</span>
<span class="udiff-line-modified-added">+         // Add a new reply to the queue of unprocessed replies.</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             replies.put(ber);</span>
<span class="udiff-line-modified-added">+         } catch (InterruptedException e) {</span>
<span class="udiff-line-modified-added">+             // ignore</span>
          }
<span class="udiff-line-added">+ </span>
          return pauseAfterReceipt;
      }
  
<span class="udiff-line-modified-removed">-     synchronized BerDecoder getReplyBer() throws CommunicationException {</span>
<span class="udiff-line-modified-added">+     BerDecoder getReplyBer(long millis) throws CommunicationException,</span>
<span class="udiff-line-added">+                                                InterruptedException {</span>
<span class="udiff-line-added">+         if (cancelled) {</span>
<span class="udiff-line-added">+             throw new CommunicationException(&quot;Request: &quot; + msgId +</span>
<span class="udiff-line-added">+                 &quot; cancelled&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (isClosed()) {</span>
<span class="udiff-line-added">+             return null;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         BerDecoder result = millis &gt; 0 ?</span>
<span class="udiff-line-added">+                 replies.poll(millis, TimeUnit.MILLISECONDS) : replies.take();</span>
<span class="udiff-line-added">+ </span>
          if (cancelled) {
              throw new CommunicationException(&quot;Request: &quot; + msgId +
                  &quot; cancelled&quot;);
          }
  
<span class="udiff-line-modified-removed">-         /*</span>
<span class="udiff-line-removed">-          * Remove a reply if the queue is not empty.</span>
<span class="udiff-line-removed">-          * poll returns null if queue is empty.</span>
<span class="udiff-line-removed">-          */</span>
<span class="udiff-line-removed">-         BerDecoder reply = replies.poll();</span>
<span class="udiff-line-removed">-         return reply;</span>
<span class="udiff-line-modified-added">+         return result == EOF ? null : result;</span>
      }
  
<span class="udiff-line-modified-removed">-     synchronized boolean hasSearchCompleted() {</span>
<span class="udiff-line-modified-added">+     boolean hasSearchCompleted() {</span>
          return completed;
      }
  }
</pre>
<center><a href="LdapDnsProviderService.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../toolkit/ctx/Continuation.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>