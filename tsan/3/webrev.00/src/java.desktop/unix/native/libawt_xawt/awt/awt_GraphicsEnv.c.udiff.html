<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/unix/native/libawt_xawt/awt/awt_GraphicsEnv.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="awt_Event.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_InputMethod.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/native/libawt_xawt/awt/awt_GraphicsEnv.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -52,15 +52,10 @@</span>
  #include &quot;awt_util.h&quot;
  #include &quot;gdefs.h&quot;
  #include &lt;dlfcn.h&gt;
  #include &quot;Trace.h&quot;
  
<span class="udiff-line-removed">- #ifdef NETSCAPE</span>
<span class="udiff-line-removed">- #include &lt;signal.h&gt;</span>
<span class="udiff-line-removed">- extern int awt_init_xt;</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
  #ifndef HEADLESS
  
  int awt_numScreens;     /* Xinerama-aware number of screens */
  
  AwtScreenDataPtr x11Screens;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -110,39 +105,24 @@</span>
   * display.
   * In many places where we talk to X11, a xinawareScreen variable is used to
   * pass the correct Display value, depending on the circumstances (a single
   * X display, multiple X displays, or a single X display with multiple
   * Xinerama screens).
<span class="udiff-line-removed">-  *</span>
<span class="udiff-line-removed">-  * Solaris and Linux differ in the functions used to access Xinerama-related</span>
<span class="udiff-line-removed">-  * data.  This is in part because at this time, the X consortium has not</span>
<span class="udiff-line-removed">-  * finalized the &quot;official&quot; Xinerama API.  Once this spec is available, and</span>
<span class="udiff-line-removed">-  * both OSes are conformant, one code base should be sufficient for Xinerama</span>
<span class="udiff-line-removed">-  * operation on both OSes.  Until then, some of the Xinerama-related code</span>
<span class="udiff-line-removed">-  * is ifdef&#39;d appropriately.  -bchristi, 7/12/01</span>
   */
  
  #define MAXFRAMEBUFFERS 16
<span class="udiff-line-removed">- #if defined(__linux__) || defined(MACOSX)</span>
  typedef struct {
     int   screen_number;
     short x_org;
     short y_org;
     short width;
     short height;
  } XineramaScreenInfo;
  
  typedef XineramaScreenInfo* XineramaQueryScreensFunc(Display*, int*);
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">- #else /* SOLARIS */</span>
<span class="udiff-line-removed">- typedef Status XineramaGetInfoFunc(Display* display, int screen_number,</span>
<span class="udiff-line-removed">-          XRectangle* framebuffer_rects, unsigned char* framebuffer_hints,</span>
<span class="udiff-line-removed">-          int* num_framebuffers);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+ static XineramaQueryScreensFunc* XineramaQueryScreens = NULL;</span>
  Bool usingXinerama = False;
<span class="udiff-line-removed">- XRectangle fbrects[MAXFRAMEBUFFERS];</span>
  
  JNIEXPORT void JNICALL
  Java_sun_awt_X11GraphicsConfig_initIDs (JNIEnv *env, jclass cls)
  {
      x11GraphicsConfigIDs.aData = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -150,17 +130,10 @@</span>
  
      x11GraphicsConfigIDs.aData = (*env)-&gt;GetFieldID (env, cls, &quot;aData&quot;, &quot;J&quot;);
      CHECK_NULL(x11GraphicsConfigIDs.aData);
      x11GraphicsConfigIDs.bitsPerPixel = (*env)-&gt;GetFieldID (env, cls, &quot;bitsPerPixel&quot;, &quot;I&quot;);
      CHECK_NULL(x11GraphicsConfigIDs.bitsPerPixel);
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (x11GraphicsConfigIDs.aData == NULL ||</span>
<span class="udiff-line-removed">-             x11GraphicsConfigIDs.bitsPerPixel == NULL) {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             JNU_ThrowNoSuchFieldError(env, &quot;Can&#39;t find a field&quot;);</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
  }
  
  #ifndef HEADLESS
  
  /*
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -191,10 +164,14 @@</span>
                                  mask, vinfo, &amp;visualsMatched);
      if (visualList) {
          int id = -1;
          VisualID defaultVisual = XVisualIDFromVisual(DefaultVisual(awt_display, vinfo-&gt;screen));
          defaultConfig = ZALLOC(_AwtGraphicsConfigData);
<span class="udiff-line-added">+         if (defaultConfig == NULL) {</span>
<span class="udiff-line-added">+             XFree(visualList);</span>
<span class="udiff-line-added">+             return NULL;</span>
<span class="udiff-line-added">+         }</span>
          for (i = 0; i &lt; visualsMatched; i++) {
              memcpy(&amp;defaultConfig-&gt;awt_visInfo, &amp;visualList[i], sizeof(XVisualInfo));
              defaultConfig-&gt;awt_depth = visualList[i].depth;
  
              /* we can&#39;t use awtJNI_CreateColorData here, because it&#39;ll pull,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -423,10 +400,11 @@</span>
  
      // Only use the RENDER extension if it is available on the X server
      if (XQueryExtension(awt_display, &quot;RENDER&quot;,
                          &amp;major_opcode, &amp;first_event, &amp;first_error))
      {
<span class="udiff-line-added">+         DTRACE_PRINTLN(&quot;RENDER extension available&quot;);</span>
          xrenderLibHandle = dlopen(&quot;libXrender.so.1&quot;, RTLD_LAZY | RTLD_GLOBAL);
  
  #ifdef MACOSX
  #define XRENDER_LIB &quot;/usr/X11/lib/libXrender.dylib&quot;
  #else
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -436,22 +414,34 @@</span>
          if (xrenderLibHandle == NULL) {
              xrenderLibHandle = dlopen(XRENDER_LIB,
                                        RTLD_LAZY | RTLD_GLOBAL);
          }
  
<span class="udiff-line-modified-removed">- #ifndef __linux__ /* SOLARIS */</span>
<span class="udiff-line-modified-added">+ #if defined(__solaris__)</span>
          if (xrenderLibHandle == NULL) {
              xrenderLibHandle = dlopen(&quot;/usr/lib/libXrender.so.1&quot;,
                                        RTLD_LAZY | RTLD_GLOBAL);
          }
<span class="udiff-line-added">+ #elif defined(_AIX)</span>
<span class="udiff-line-added">+         if (xrenderLibHandle == NULL) {</span>
<span class="udiff-line-added">+             xrenderLibHandle = dlopen(&quot;libXrender.a(libXrender.so.0)&quot;,</span>
<span class="udiff-line-added">+                                       RTLD_MEMBER | RTLD_LAZY | RTLD_GLOBAL);</span>
<span class="udiff-line-added">+         }</span>
  #endif
<span class="udiff-line-removed">- </span>
          if (xrenderLibHandle != NULL) {
<span class="udiff-line-added">+             DTRACE_PRINTLN(&quot;Loaded libXrender&quot;);</span>
              xrenderFindVisualFormat =
                  (XRenderFindVisualFormatFunc*)dlsym(xrenderLibHandle,
                                                      &quot;XRenderFindVisualFormat&quot;);
<span class="udiff-line-added">+             if (xrenderFindVisualFormat == NULL) {</span>
<span class="udiff-line-added">+                 DTRACE_PRINTLN1(&quot;Can&#39;t find &#39;XRenderFindVisualFormat&#39; in libXrender (%s)&quot;, dlerror());</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             DTRACE_PRINTLN1(&quot;Can&#39;t load libXrender (%s)&quot;, dlerror());</span>
          }
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+         DTRACE_PRINTLN(&quot;RENDER extension NOT available&quot;);</span>
      }
  
      for (i = 0; i &lt; nTrue; i++) {
          if (XVisualIDFromVisual(pVITrue[i].visual) ==
              XVisualIDFromVisual(defaultConfig-&gt;awt_visInfo.visual) ||
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -459,26 +449,35 @@</span>
              /* Skip the non-supported 12-bit TrueColor visual */
              continue;
          } else {
              ind = nConfig++;
          }
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind]-&gt;awt_depth = pVITrue [i].depth;</span>
<span class="udiff-line-modified-added">+         graphicsConfigs[ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-added">+         if (graphicsConfigs[ind] == NULL) {</span>
<span class="udiff-line-added">+             JNU_ThrowOutOfMemoryError(env, &quot;allocation in getAllConfigs failed&quot;);</span>
<span class="udiff-line-added">+             goto cleanup;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         graphicsConfigs[ind]-&gt;awt_depth = pVITrue [i].depth;</span>
          memcpy (&amp;graphicsConfigs [ind]-&gt;awt_visInfo, &amp;pVITrue [i],
                  sizeof (XVisualInfo));
<span class="udiff-line-modified-removed">-        if (xrenderFindVisualFormat != NULL) {</span>
<span class="udiff-line-modified-added">+         if (xrenderFindVisualFormat != NULL) {</span>
              XRenderPictFormat *format = xrenderFindVisualFormat (awt_display,
<span class="udiff-line-modified-removed">-                     pVITrue [i].visual);</span>
<span class="udiff-line-modified-added">+                                                                  pVITrue [i].visual);</span>
              if (format &amp;&amp;
                  format-&gt;type == PictTypeDirect &amp;&amp;
                  format-&gt;direct.alphaMask)
              {
<span class="udiff-line-added">+                 DTRACE_PRINTLN1(&quot;GraphicsConfig[%d] supports Translucency&quot;, ind);</span>
                  graphicsConfigs [ind]-&gt;isTranslucencySupported = 1;
                  memcpy(&amp;graphicsConfigs [ind]-&gt;renderPictFormat, format,
                          sizeof(*format));
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 DTRACE_PRINTLN1(format ?</span>
<span class="udiff-line-added">+                                 &quot;GraphicsConfig[%d] has no Translucency support&quot; :</span>
<span class="udiff-line-added">+                                 &quot;Error calling &#39;XRenderFindVisualFormat&#39;&quot;, ind);</span>
              }
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+        }</span>
      }
  
      if (xrenderLibHandle != NULL) {
          dlclose(xrenderLibHandle);
          xrenderLibHandle = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -489,12 +488,16 @@</span>
              XVisualIDFromVisual(defaultConfig-&gt;awt_visInfo.visual)) {
              continue;
          } else {
              ind = nConfig++;
          }
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind]-&gt;awt_depth = pVI8p [i].depth;</span>
<span class="udiff-line-modified-added">+         graphicsConfigs[ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-added">+         if (graphicsConfigs[ind] == NULL) {</span>
<span class="udiff-line-added">+             JNU_ThrowOutOfMemoryError(env, &quot;allocation in getAllConfigs failed&quot;);</span>
<span class="udiff-line-added">+             goto cleanup;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         graphicsConfigs[ind]-&gt;awt_depth = pVI8p [i].depth;</span>
          memcpy (&amp;graphicsConfigs [ind]-&gt;awt_visInfo, &amp;pVI8p [i],
                  sizeof (XVisualInfo));
      }
  
      for (i = 0; i &lt; n12p; i++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -502,12 +505,16 @@</span>
              XVisualIDFromVisual(defaultConfig-&gt;awt_visInfo.visual)) {
              continue;
          } else {
              ind = nConfig++;
          }
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind]-&gt;awt_depth = pVI12p [i].depth;</span>
<span class="udiff-line-modified-added">+         graphicsConfigs[ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-added">+         if (graphicsConfigs[ind] == NULL) {</span>
<span class="udiff-line-added">+             JNU_ThrowOutOfMemoryError(env, &quot;allocation in getAllConfigs failed&quot;);</span>
<span class="udiff-line-added">+             goto cleanup;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         graphicsConfigs[ind]-&gt;awt_depth = pVI12p [i].depth;</span>
          memcpy (&amp;graphicsConfigs [ind]-&gt;awt_visInfo, &amp;pVI12p [i],
                  sizeof (XVisualInfo));
      }
  
      for (i = 0; i &lt; n8s; i++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -515,12 +522,16 @@</span>
              XVisualIDFromVisual(defaultConfig-&gt;awt_visInfo.visual)) {
              continue;
          } else {
              ind = nConfig++;
          }
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind]-&gt;awt_depth = pVI8s [i].depth;</span>
<span class="udiff-line-modified-added">+         graphicsConfigs[ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-added">+         if (graphicsConfigs[ind] == NULL) {</span>
<span class="udiff-line-added">+             JNU_ThrowOutOfMemoryError(env, &quot;allocation in getAllConfigs failed&quot;);</span>
<span class="udiff-line-added">+             goto cleanup;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         graphicsConfigs[ind]-&gt;awt_depth = pVI8s [i].depth;</span>
          memcpy (&amp;graphicsConfigs [ind]-&gt;awt_visInfo, &amp;pVI8s [i],
                  sizeof (XVisualInfo));
      }
  
      for (i = 0; i &lt; n8gs; i++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -528,12 +539,16 @@</span>
              XVisualIDFromVisual(defaultConfig-&gt;awt_visInfo.visual)) {
              continue;
          } else {
              ind = nConfig++;
          }
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind]-&gt;awt_depth = pVI8gs [i].depth;</span>
<span class="udiff-line-modified-added">+         graphicsConfigs[ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-added">+         if (graphicsConfigs[ind] == NULL) {</span>
<span class="udiff-line-added">+             JNU_ThrowOutOfMemoryError(env, &quot;allocation in getAllConfigs failed&quot;);</span>
<span class="udiff-line-added">+             goto cleanup;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         graphicsConfigs[ind]-&gt;awt_depth = pVI8gs [i].depth;</span>
          memcpy (&amp;graphicsConfigs [ind]-&gt;awt_visInfo, &amp;pVI8gs [i],
                  sizeof (XVisualInfo));
      }
  
      for (i = 0; i &lt; n8sg; i++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -541,12 +556,16 @@</span>
              XVisualIDFromVisual(defaultConfig-&gt;awt_visInfo.visual)) {
              continue;
          } else {
              ind = nConfig++;
          }
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind]-&gt;awt_depth = pVI8sg [i].depth;</span>
<span class="udiff-line-modified-added">+         graphicsConfigs[ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-added">+         if (graphicsConfigs[ind] == NULL) {</span>
<span class="udiff-line-added">+             JNU_ThrowOutOfMemoryError(env, &quot;allocation in getAllConfigs failed&quot;);</span>
<span class="udiff-line-added">+             goto cleanup;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         graphicsConfigs[ind]-&gt;awt_depth = pVI8sg [i].depth;</span>
          memcpy (&amp;graphicsConfigs [ind]-&gt;awt_visInfo, &amp;pVI8sg [i],
                  sizeof (XVisualInfo));
      }
  
      for (i = 0; i &lt; n1sg; i++) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -554,16 +573,24 @@</span>
              XVisualIDFromVisual(defaultConfig-&gt;awt_visInfo.visual)) {
              continue;
          } else {
              ind = nConfig++;
          }
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-removed">-         graphicsConfigs [ind]-&gt;awt_depth = pVI1sg [i].depth;</span>
<span class="udiff-line-modified-added">+         graphicsConfigs[ind] = ZALLOC (_AwtGraphicsConfigData);</span>
<span class="udiff-line-modified-added">+         if (graphicsConfigs[ind] == NULL) {</span>
<span class="udiff-line-added">+             JNU_ThrowOutOfMemoryError(env, &quot;allocation in getAllConfigs failed&quot;);</span>
<span class="udiff-line-added">+             goto cleanup;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         graphicsConfigs[ind]-&gt;awt_depth = pVI1sg [i].depth;</span>
          memcpy (&amp;graphicsConfigs [ind]-&gt;awt_visInfo, &amp;pVI1sg [i],
                  sizeof (XVisualInfo));
      }
  
<span class="udiff-line-added">+     screenDataPtr-&gt;numConfigs = nConfig;</span>
<span class="udiff-line-added">+     screenDataPtr-&gt;configs = graphicsConfigs;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ cleanup:</span>
      if (n8p != 0)
         XFree (pVI8p);
      if (n12p != 0)
         XFree (pVI12p);
      if (n8s != 0)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -573,159 +600,90 @@</span>
      if (n8sg != 0)
         XFree (pVI8sg);
      if (n1sg != 0)
         XFree (pVI1sg);
  
<span class="udiff-line-removed">-     screenDataPtr-&gt;numConfigs = nConfig;</span>
<span class="udiff-line-removed">-     screenDataPtr-&gt;configs = graphicsConfigs;</span>
<span class="udiff-line-removed">- </span>
      AWT_UNLOCK ();
  }
  
  #ifndef HEADLESS
<span class="udiff-line-modified-removed">- #if defined(__linux__) || defined(MACOSX)</span>
<span class="udiff-line-modified-removed">- static void xinerama_init_linux()</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ /*</span>
<span class="udiff-line-modified-added">+  * Checks if Xinerama is running and perform Xinerama-related initialization.</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ static void xineramaInit(void) {</span>
<span class="udiff-line-added">+     char* XinExtName = &quot;XINERAMA&quot;;</span>
<span class="udiff-line-added">+     int32_t major_opcode, first_event, first_error;</span>
<span class="udiff-line-added">+     Bool gotXinExt = False;</span>
      void* libHandle = NULL;
      int32_t locNumScr = 0;
      XineramaScreenInfo *xinInfo;
      char* XineramaQueryScreensName = &quot;XineramaQueryScreens&quot;;
<span class="udiff-line-modified-removed">-     XineramaQueryScreensFunc* XineramaQueryScreens = NULL;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     gotXinExt = XQueryExtension(awt_display, XinExtName, &amp;major_opcode,</span>
<span class="udiff-line-added">+                                 &amp;first_event, &amp;first_error);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!gotXinExt) {</span>
<span class="udiff-line-added">+         DTRACE_PRINTLN(&quot;Xinerama extension is not available&quot;);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     DTRACE_PRINTLN(&quot;Xinerama extension is available&quot;);</span>
  
      /* load library */
      libHandle = dlopen(VERSIONED_JNI_LIB_NAME(&quot;Xinerama&quot;, &quot;1&quot;),
                         RTLD_LAZY | RTLD_GLOBAL);
      if (libHandle == NULL) {
<span class="udiff-line-added">+ #if defined(_AIX)</span>
<span class="udiff-line-added">+         libHandle = dlopen(&quot;libXext.a(shr_64.o)&quot;, RTLD_MEMBER | RTLD_LAZY | RTLD_GLOBAL);</span>
<span class="udiff-line-added">+ #else</span>
          libHandle = dlopen(JNI_LIB_NAME(&quot;Xinerama&quot;), RTLD_LAZY | RTLD_GLOBAL);
<span class="udiff-line-added">+ #endif</span>
      }
      if (libHandle != NULL) {
          XineramaQueryScreens = (XineramaQueryScreensFunc*)
              dlsym(libHandle, XineramaQueryScreensName);
  
<span class="udiff-line-modified-removed">-         if (XineramaQueryScreens != NULL) {</span>
<span class="udiff-line-modified-removed">-             DTRACE_PRINTLN(&quot;calling XineramaQueryScreens func on Linux&quot;);</span>
<span class="udiff-line-modified-added">+         if (XineramaQueryScreens == NULL) {</span>
<span class="udiff-line-modified-added">+             DTRACE_PRINTLN(&quot;couldn&#39;t load XineramaQueryScreens symbol&quot;);</span>
<span class="udiff-line-added">+             dlclose(libHandle);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             DTRACE_PRINTLN(&quot;calling XineramaQueryScreens func&quot;);</span>
              xinInfo = (*XineramaQueryScreens)(awt_display, &amp;locNumScr);
<span class="udiff-line-modified-removed">-             if (xinInfo != NULL &amp;&amp; locNumScr &gt; XScreenCount(awt_display)) {</span>
<span class="udiff-line-modified-removed">-                 int32_t idx;</span>
<span class="udiff-line-modified-removed">-                 DTRACE_PRINTLN(&quot;Enabling Xinerama support&quot;);</span>
<span class="udiff-line-modified-removed">-                 usingXinerama = True;</span>
<span class="udiff-line-modified-removed">-                 /* set global number of screens */</span>
<span class="udiff-line-modified-removed">-                 DTRACE_PRINTLN1(&quot; num screens = %i\n&quot;, locNumScr);</span>
<span class="udiff-line-modified-removed">-                 awt_numScreens = locNumScr;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                 /* stuff values into fbrects */</span>
<span class="udiff-line-removed">-                 for (idx = 0; idx &lt; awt_numScreens; idx++) {</span>
<span class="udiff-line-removed">-                     DASSERT(xinInfo[idx].screen_number == idx);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                     fbrects[idx].width = xinInfo[idx].width;</span>
<span class="udiff-line-removed">-                     fbrects[idx].height = xinInfo[idx].height;</span>
<span class="udiff-line-removed">-                     fbrects[idx].x = xinInfo[idx].x_org;</span>
<span class="udiff-line-removed">-                     fbrects[idx].y = xinInfo[idx].y_org;</span>
<span class="udiff-line-modified-added">+             if (xinInfo != NULL) {</span>
<span class="udiff-line-modified-added">+                 if (locNumScr &gt; XScreenCount(awt_display)) {</span>
<span class="udiff-line-modified-added">+                     DTRACE_PRINTLN(&quot;Enabling Xinerama support&quot;);</span>
<span class="udiff-line-modified-added">+                     usingXinerama = True;</span>
<span class="udiff-line-modified-added">+                     /* set global number of screens */</span>
<span class="udiff-line-modified-added">+                     DTRACE_PRINTLN1(&quot; num screens = %i\n&quot;, locNumScr);</span>
<span class="udiff-line-modified-added">+                     awt_numScreens = locNumScr;</span>
<span class="udiff-line-modified-added">+                 } else {</span>
<span class="udiff-line-modified-added">+                     DTRACE_PRINTLN(&quot;XineramaQueryScreens &lt;= XScreenCount&quot;);</span>
                  }
<span class="udiff-line-added">+                 XFree(xinInfo);</span>
              } else {
                  DTRACE_PRINTLN(&quot;calling XineramaQueryScreens didn&#39;t work&quot;);
              }
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             DTRACE_PRINTLN(&quot;couldn&#39;t load XineramaQueryScreens symbol&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         dlclose(libHandle);</span>
<span class="udiff-line-removed">-     } else {</span>
<span class="udiff-line-removed">-         DTRACE_PRINTLN1(&quot;\ncouldn&#39;t open shared library: %s\n&quot;, dlerror());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- #if !defined(__linux__) &amp;&amp; !defined(MACOSX) /* Solaris */</span>
<span class="udiff-line-removed">- static void xinerama_init_solaris()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     void* libHandle = NULL;</span>
<span class="udiff-line-removed">-     unsigned char fbhints[MAXFRAMEBUFFERS];</span>
<span class="udiff-line-removed">-     int32_t locNumScr = 0;</span>
<span class="udiff-line-removed">-     /* load and run XineramaGetInfo */</span>
<span class="udiff-line-removed">-     char* XineramaGetInfoName = &quot;XineramaGetInfo&quot;;</span>
<span class="udiff-line-removed">-     XineramaGetInfoFunc* XineramaSolarisFunc = NULL;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /* load library */</span>
<span class="udiff-line-removed">-     libHandle = dlopen(JNI_LIB_NAME(&quot;Xext&quot;), RTLD_LAZY | RTLD_GLOBAL);</span>
<span class="udiff-line-removed">-     if (libHandle != NULL) {</span>
<span class="udiff-line-removed">-         XineramaSolarisFunc = (XineramaGetInfoFunc*)dlsym(libHandle, XineramaGetInfoName);</span>
<span class="udiff-line-removed">-         if (XineramaSolarisFunc != NULL) {</span>
<span class="udiff-line-removed">-             DTRACE_PRINTLN(&quot;calling XineramaGetInfo func on Solaris&quot;);</span>
<span class="udiff-line-removed">-             if ((*XineramaSolarisFunc)(awt_display, 0, &amp;fbrects[0],</span>
<span class="udiff-line-removed">-                                        &amp;fbhints[0], &amp;locNumScr) != 0 &amp;&amp;</span>
<span class="udiff-line-removed">-                 locNumScr &gt; XScreenCount(awt_display))</span>
<span class="udiff-line-removed">-             {</span>
<span class="udiff-line-removed">-                 DTRACE_PRINTLN(&quot;Enabling Xinerama support&quot;);</span>
<span class="udiff-line-removed">-                 usingXinerama = True;</span>
<span class="udiff-line-removed">-                 /* set global number of screens */</span>
<span class="udiff-line-removed">-                 DTRACE_PRINTLN1(&quot; num screens = %i\n&quot;, locNumScr);</span>
<span class="udiff-line-removed">-                 awt_numScreens = locNumScr;</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 DTRACE_PRINTLN(&quot;calling XineramaGetInfo didn&#39;t work&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             DTRACE_PRINTLN(&quot;couldn&#39;t load XineramaGetInfo symbol&quot;);</span>
          }
<span class="udiff-line-removed">-         dlclose(libHandle);</span>
      } else {
          DTRACE_PRINTLN1(&quot;\ncouldn&#39;t open shared library: %s\n&quot;, dlerror());
      }
  }
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- /*</span>
<span class="udiff-line-removed">-  * Checks if Xinerama is running and perform Xinerama-related</span>
<span class="udiff-line-removed">-  * platform dependent initialization.</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- static void xineramaInit(void) {</span>
<span class="udiff-line-removed">-     char* XinExtName = &quot;XINERAMA&quot;;</span>
<span class="udiff-line-removed">-     int32_t major_opcode, first_event, first_error;</span>
<span class="udiff-line-removed">-     Bool gotXinExt = False;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     gotXinExt = XQueryExtension(awt_display, XinExtName, &amp;major_opcode,</span>
<span class="udiff-line-removed">-                                 &amp;first_event, &amp;first_error);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!gotXinExt) {</span>
<span class="udiff-line-removed">-         DTRACE_PRINTLN(&quot;Xinerama extension is not available&quot;);</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     DTRACE_PRINTLN(&quot;Xinerama extension is available&quot;);</span>
<span class="udiff-line-removed">- #if defined(__linux__) || defined(MACOSX)</span>
<span class="udiff-line-removed">-     xinerama_init_linux();</span>
<span class="udiff-line-removed">- #else /* Solaris */</span>
<span class="udiff-line-removed">-     xinerama_init_solaris();</span>
<span class="udiff-line-removed">- #endif /* __linux__ || MACOSX */</span>
<span class="udiff-line-removed">- }</span>
  #endif /* HEADLESS */
  
  Display *
  awt_init_Display(JNIEnv *env, jobject this)
  {
      jclass klass;
      Display *dpy;
      char errmsg[128];
      int i;
<span class="udiff-line-removed">- #ifdef NETSCAPE</span>
<span class="udiff-line-removed">-     sigset_t alarm_set, oldset;</span>
<span class="udiff-line-removed">- #endif</span>
  
      if (awt_display) {
          return awt_display;
      }
  
<span class="udiff-line-removed">- #ifdef NETSCAPE</span>
<span class="udiff-line-removed">-     /* Disable interrupts during XtOpenDisplay to avoid bugs in unix os select</span>
<span class="udiff-line-removed">-        code: some unix systems don&#39;t implement SA_RESTART properly and</span>
<span class="udiff-line-removed">-        because of this, select returns with EINTR. Most implementations of</span>
<span class="udiff-line-removed">-        gethostbyname don&#39;t cope with EINTR properly and as a result we get</span>
<span class="udiff-line-removed">-        stuck (forever) in the gethostbyname code</span>
<span class="udiff-line-removed">-     */</span>
<span class="udiff-line-removed">-     sigemptyset(&amp;alarm_set);</span>
<span class="udiff-line-removed">-     sigaddset(&amp;alarm_set, SIGALRM);</span>
<span class="udiff-line-removed">-     sigprocmask(SIG_BLOCK, &amp;alarm_set, &amp;oldset);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
      /* Load AWT lock-related methods in SunToolkit */
      klass = (*env)-&gt;FindClass(env, &quot;sun/awt/SunToolkit&quot;);
      if (klass == NULL) return NULL;
      GET_STATIC_METHOD(klass, awtLockMID, &quot;awtLock&quot;, &quot;()V&quot;);
      GET_STATIC_METHOD(klass, awtUnlockMID, &quot;awtUnlock&quot;, &quot;()V&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -741,13 +699,10 @@</span>
              printf(&quot;Ignoring XKB.\n&quot;);
          }
      }
  
      dpy = awt_display = XOpenDisplay(NULL);
<span class="udiff-line-removed">- #ifdef NETSCAPE</span>
<span class="udiff-line-removed">-     sigprocmask(SIG_SETMASK, &amp;oldset, NULL);</span>
<span class="udiff-line-removed">- #endif</span>
      if (!dpy) {
          jio_snprintf(errmsg,
                       sizeof(errmsg),
                       &quot;Can&#39;t connect to X11 window server using &#39;%s&#39; as the value of the DISPLAY variable.&quot;,
                       (getenv(&quot;DISPLAY&quot;) == NULL) ? &quot;:0.0&quot; : getenv(&quot;DISPLAY&quot;));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1368,31 +1323,46 @@</span>
  #else
      jclass clazz;
      jmethodID mid;
      jobject bounds = NULL;
      AwtGraphicsConfigDataPtr adata;
<span class="udiff-line-added">+     int32_t locNumScr = 0;</span>
<span class="udiff-line-added">+     XineramaScreenInfo *xinInfo;</span>
  
      adata = (AwtGraphicsConfigDataPtr)
          JNU_GetLongFieldAsPtr(env, this, x11GraphicsConfigIDs.aData);
  
      clazz = (*env)-&gt;FindClass(env, &quot;java/awt/Rectangle&quot;);
      CHECK_NULL_RETURN(clazz, NULL);
      mid = (*env)-&gt;GetMethodID(env, clazz, &quot;&lt;init&gt;&quot;, &quot;(IIII)V&quot;);
      if (mid != NULL) {
          if (usingXinerama) {
              if (0 &lt;= screen &amp;&amp; screen &lt; awt_numScreens) {
<span class="udiff-line-modified-removed">-                 bounds = (*env)-&gt;NewObject(env, clazz, mid, fbrects[screen].x,</span>
<span class="udiff-line-modified-removed">-                                                             fbrects[screen].y,</span>
<span class="udiff-line-modified-removed">-                                                             fbrects[screen].width,</span>
<span class="udiff-line-modified-removed">-                                                             fbrects[screen].height);</span>
<span class="udiff-line-modified-added">+                 AWT_LOCK();</span>
<span class="udiff-line-modified-added">+                 xinInfo = (*XineramaQueryScreens)(awt_display, &amp;locNumScr);</span>
<span class="udiff-line-modified-added">+                 AWT_UNLOCK();</span>
<span class="udiff-line-modified-added">+                 if (xinInfo != NULL &amp;&amp; locNumScr &gt; 0) {</span>
<span class="udiff-line-added">+                     if (screen &gt;= locNumScr) {</span>
<span class="udiff-line-added">+                         screen = 0; // fallback to the main screen</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     DASSERT(xinInfo[screen].screen_number == screen);</span>
<span class="udiff-line-added">+                     bounds = (*env)-&gt;NewObject(env, clazz, mid,</span>
<span class="udiff-line-added">+                                                xinInfo[screen].x_org,</span>
<span class="udiff-line-added">+                                                xinInfo[screen].y_org,</span>
<span class="udiff-line-added">+                                                xinInfo[screen].width,</span>
<span class="udiff-line-added">+                                                xinInfo[screen].height);</span>
<span class="udiff-line-added">+                     XFree(xinInfo);</span>
<span class="udiff-line-added">+                 }</span>
              } else {
                  jclass exceptionClass = (*env)-&gt;FindClass(env, &quot;java/lang/IllegalArgumentException&quot;);
                  if (exceptionClass != NULL) {
                      (*env)-&gt;ThrowNew(env, exceptionClass, &quot;Illegal screen index&quot;);
                  }
              }
<span class="udiff-line-modified-removed">-         } else {</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-added">+         if (!bounds) {</span>
<span class="udiff-line-added">+             // Xinerama cannot provide correct bounds, will try X11</span>
              XWindowAttributes xwa;
              memset(&amp;xwa, 0, sizeof(xwa));
  
              AWT_LOCK ();
              XGetWindowAttributes(awt_display,
</pre>
<center><a href="awt_Event.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_InputMethod.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>