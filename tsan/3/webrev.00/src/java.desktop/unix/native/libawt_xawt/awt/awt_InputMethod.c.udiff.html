<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/unix/native/libawt_xawt/awt/awt_InputMethod.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="awt_GraphicsEnv.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_Insets.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/native/libawt_xawt/awt/awt_InputMethod.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -44,11 +44,11 @@</span>
  
  struct X11InputMethodIDs {
    jfieldID pData;
  } x11InputMethodIDs;
  
<span class="udiff-line-modified-removed">- static void PreeditStartCallback(XIC, XPointer, XPointer);</span>
<span class="udiff-line-modified-added">+ static int PreeditStartCallback(XIC, XPointer, XPointer);</span>
  static void PreeditDoneCallback(XIC, XPointer, XPointer);
  static void PreeditDrawCallback(XIC, XPointer,
                                  XIMPreeditDrawCallbackStruct *);
  static void PreeditCaretCallback(XIC, XPointer,
                                   XIMPreeditCaretCallbackStruct *);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -78,11 +78,11 @@</span>
  /*
   * Callback function pointers: the order has to match the *Index
   * values above.
   */
  static XIMProc callback_funcs[NCALLBACKS] = {
<span class="udiff-line-modified-removed">-     (XIMProc)PreeditStartCallback,</span>
<span class="udiff-line-modified-added">+     (XIMProc)(void *)&amp;PreeditStartCallback,</span>
      (XIMProc)PreeditDoneCallback,
      (XIMProc)PreeditDrawCallback,
      (XIMProc)PreeditCaretCallback,
  #if defined(__linux__) || defined(MACOSX)
      (XIMProc)StatusStartCallback,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -173,10 +173,13 @@</span>
  
  static X11InputMethodData * getX11InputMethodData(JNIEnv *, jobject);
  static void setX11InputMethodData(JNIEnv *, jobject, X11InputMethodData *);
  static void destroyX11InputMethodData(JNIEnv *, X11InputMethodData *);
  static void freeX11InputMethodData(JNIEnv *, X11InputMethodData *);
<span class="udiff-line-added">+ #if defined(__linux__) || defined(MACOSX)</span>
<span class="udiff-line-added">+ static Window getParentWindow(Window);</span>
<span class="udiff-line-added">+ #endif</span>
  
  #ifdef __solaris__
  /* Prototype for this function is missing in Solaris X11R6 Xlib.h */
  extern char *XSetIMValues(
  #if NeedVarargsPrototypes
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1017,27 +1020,47 @@</span>
          if (pX11IMData-&gt;ic_active != pX11IMData-&gt;ic_passive) {
              XSetICValues (pX11IMData-&gt;ic_passive, XNCommitStringCallback, &amp;cb, NULL);
          }
      }
  
<span class="udiff-line-added">+     // The code set the IC mode that the preedit state is not initialied</span>
<span class="udiff-line-added">+     // at XmbResetIC.  This attribute can be set at XCreateIC.  I separately</span>
<span class="udiff-line-added">+     // set the attribute to avoid the failure of XCreateIC at some platform</span>
<span class="udiff-line-added">+     // which does not support the attribute.</span>
<span class="udiff-line-added">+     if (pX11IMData-&gt;ic_active != 0)</span>
<span class="udiff-line-added">+         XSetICValues(pX11IMData-&gt;ic_active,</span>
<span class="udiff-line-added">+                      XNResetState, XIMInitialState,</span>
<span class="udiff-line-added">+                      NULL);</span>
<span class="udiff-line-added">+     if (pX11IMData-&gt;ic_passive != 0</span>
<span class="udiff-line-added">+             &amp;&amp; pX11IMData-&gt;ic_active != pX11IMData-&gt;ic_passive)</span>
<span class="udiff-line-added">+         XSetICValues(pX11IMData-&gt;ic_passive,</span>
<span class="udiff-line-added">+                      XNResetState, XIMInitialState,</span>
<span class="udiff-line-added">+                      NULL);</span>
<span class="udiff-line-added">+ </span>
      /* Add the global reference object to X11InputMethod to the list. */
      addToX11InputMethodGRefList(pX11IMData-&gt;x11inputmethod);
  
<span class="udiff-line-added">+     /* Unset focus to avoid unexpected IM on */</span>
<span class="udiff-line-added">+     setXICFocus(pX11IMData-&gt;ic_active, False);</span>
<span class="udiff-line-added">+     if (pX11IMData-&gt;ic_active != pX11IMData-&gt;ic_passive)</span>
<span class="udiff-line-added">+         setXICFocus(pX11IMData-&gt;ic_passive, False);</span>
<span class="udiff-line-added">+ </span>
      return True;
  
   err:
      if (preedit)
          XFree((void *)preedit);
      THROW_OUT_OF_MEMORY_ERROR();
      return False;
  }
  
<span class="udiff-line-modified-removed">- static void</span>
<span class="udiff-line-modified-added">+ static int</span>
  PreeditStartCallback(XIC ic, XPointer client_data, XPointer call_data)
  {
      /*ARGSUSED*/
      /* printf(&quot;Native: PreeditStartCallback\n&quot;); */
<span class="udiff-line-added">+     return -1;</span>
  }
  
  static void
  PreeditDoneCallback(XIC ic, XPointer client_data, XPointer call_data)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1161,10 +1184,33 @@</span>
  static void
  StatusDoneCallback(XIC ic, XPointer client_data, XPointer call_data)
  {
      /*ARGSUSED*/
      /*printf(&quot;StatusDoneCallback:\n&quot;); */
<span class="udiff-line-added">+     JNIEnv *env = GetJNIEnv();</span>
<span class="udiff-line-added">+     X11InputMethodData *pX11IMData = NULL;</span>
<span class="udiff-line-added">+     StatusWindow *statusWindow;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     AWT_LOCK();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!isX11InputMethodGRefInList((jobject)client_data)) {</span>
<span class="udiff-line-added">+         if ((jobject)client_data == currentX11InputMethodInstance) {</span>
<span class="udiff-line-added">+             currentX11InputMethodInstance = NULL;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         goto finally;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (NULL == (pX11IMData = getX11InputMethodData(env, (jobject)client_data))</span>
<span class="udiff-line-added">+         || NULL == (statusWindow = pX11IMData-&gt;statusWindow)){</span>
<span class="udiff-line-added">+         goto finally;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     currentX11InputMethodInstance = (jobject)client_data;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     onoffStatusWindow(pX11IMData, 0, False);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  finally:</span>
<span class="udiff-line-added">+     AWT_UNLOCK();</span>
  }
  
  static void
  StatusDrawCallback(XIC ic, XPointer client_data,
                       XIMStatusDrawCallbackStruct *status_draw)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1281,11 +1327,19 @@</span>
  
      AWT_LOCK();
      /* free the old pX11IMData and set it to null. this also avoids crashing
       * the jvm if the XIM server reappears */
      while (x11InputMethodGRefListHead != NULL) {
<span class="udiff-line-modified-removed">-         getX11InputMethodData(env, x11InputMethodGRefListHead-&gt;inputMethodGRef);</span>
<span class="udiff-line-modified-added">+         if (getX11InputMethodData(env,</span>
<span class="udiff-line-added">+                 x11InputMethodGRefListHead-&gt;inputMethodGRef) == NULL) {</span>
<span class="udiff-line-added">+             /* Clear possible exceptions</span>
<span class="udiff-line-added">+              */</span>
<span class="udiff-line-added">+             if ((*env)-&gt;ExceptionOccurred(env)) {</span>
<span class="udiff-line-added">+                 (*env)-&gt;ExceptionDescribe(env);</span>
<span class="udiff-line-added">+                 (*env)-&gt;ExceptionClear(env);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
      }
      AWT_UNLOCK();
  }
  
  JNIEXPORT jboolean JNICALL
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1550,24 +1604,61 @@</span>
  JNIEXPORT jboolean JNICALL Java_sun_awt_X11InputMethodBase_setCompositionEnabledNative
    (JNIEnv *env, jobject this, jboolean enable)
  {
      X11InputMethodData *pX11IMData;
      char * ret = NULL;
<span class="udiff-line-added">+     XVaNestedList   pr_atrb;</span>
<span class="udiff-line-added">+ #if defined(__linux__) || defined(MACOSX)</span>
<span class="udiff-line-added">+     Boolean calledXSetICFocus = False;</span>
<span class="udiff-line-added">+ #endif</span>
  
      AWT_LOCK();
      pX11IMData = getX11InputMethodData(env, this);
  
      if ((pX11IMData == NULL) || (pX11IMData-&gt;current_ic == NULL)) {
          AWT_UNLOCK();
          return JNI_FALSE;
      }
  
<span class="udiff-line-modified-removed">-     ret = XSetICValues(pX11IMData-&gt;current_ic, XNPreeditState,</span>
<span class="udiff-line-modified-removed">-                        (enable ? XIMPreeditEnable : XIMPreeditDisable), NULL);</span>
<span class="udiff-line-modified-added">+ #if defined(__linux__) || defined(MACOSX)</span>
<span class="udiff-line-modified-added">+     if (NULL != pX11IMData-&gt;statusWindow) {</span>
<span class="udiff-line-added">+         Window focus = 0;</span>
<span class="udiff-line-added">+         int revert_to;</span>
<span class="udiff-line-added">+ #if defined(_LP64) &amp;&amp; !defined(_LITTLE_ENDIAN)</span>
<span class="udiff-line-added">+         // The Window value which is used for XGetICValues must be 32bit on BigEndian XOrg&#39;s xlib</span>
<span class="udiff-line-added">+         unsigned int w = 0;</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+         Window w = 0;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+         XGetInputFocus(awt_display, &amp;focus, &amp;revert_to);</span>
<span class="udiff-line-added">+         XGetICValues(pX11IMData-&gt;current_ic, XNFocusWindow, &amp;w, NULL);</span>
<span class="udiff-line-added">+         if (RevertToPointerRoot == revert_to</span>
<span class="udiff-line-added">+                 &amp;&amp; pX11IMData-&gt;ic_active != pX11IMData-&gt;ic_passive) {</span>
<span class="udiff-line-added">+             if (pX11IMData-&gt;current_ic == pX11IMData-&gt;ic_active) {</span>
<span class="udiff-line-added">+                 if (getParentWindow(focus) == getParentWindow(w)) {</span>
<span class="udiff-line-added">+                     XUnsetICFocus(pX11IMData-&gt;ic_active);</span>
<span class="udiff-line-added">+                     calledXSetICFocus = True;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+     pr_atrb = XVaCreateNestedList(0,</span>
<span class="udiff-line-added">+                   XNPreeditState, (enable ? XIMPreeditEnable : XIMPreeditDisable),</span>
<span class="udiff-line-added">+                   NULL);</span>
<span class="udiff-line-added">+     ret = XSetICValues(pX11IMData-&gt;current_ic, XNPreeditAttributes, pr_atrb, NULL);</span>
<span class="udiff-line-added">+     XFree((void *)pr_atrb);</span>
<span class="udiff-line-added">+ #if defined(__linux__) || defined(MACOSX)</span>
<span class="udiff-line-added">+     if (calledXSetICFocus) {</span>
<span class="udiff-line-added">+         XSetICFocus(pX11IMData-&gt;ic_active);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
      AWT_UNLOCK();
  
<span class="udiff-line-modified-removed">-     if ((ret != 0) &amp;&amp; (strcmp(ret, XNPreeditState) == 0)) {</span>
<span class="udiff-line-modified-added">+     if ((ret != 0)</span>
<span class="udiff-line-added">+             &amp;&amp; ((strcmp(ret, XNPreeditAttributes) == 0)</span>
<span class="udiff-line-added">+             || (strcmp(ret, XNPreeditState) == 0))) {</span>
          JNU_ThrowByName(env, &quot;java/lang/UnsupportedOperationException&quot;, &quot;&quot;);
      }
  
      return (jboolean)(ret == 0);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1586,24 +1677,35 @@</span>
  JNIEXPORT jboolean JNICALL Java_sun_awt_X11InputMethodBase_isCompositionEnabledNative
    (JNIEnv *env, jobject this)
  {
      X11InputMethodData *pX11IMData = NULL;
      char * ret = NULL;
<span class="udiff-line-modified-removed">-     XIMPreeditState state;</span>
<span class="udiff-line-modified-added">+ #if defined(__linux__) &amp;&amp; defined(_LP64) &amp;&amp; !defined(_LITTLE_ENDIAN)</span>
<span class="udiff-line-added">+     // XIMPreeditState value which is used for XGetICValues must be 32bit on BigEndian XOrg&#39;s xlib</span>
<span class="udiff-line-added">+     unsigned int state = XIMPreeditUnKnown;</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+     XIMPreeditState state = XIMPreeditUnKnown;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     XVaNestedList   pr_atrb;</span>
  
      AWT_LOCK();
      pX11IMData = getX11InputMethodData(env, this);
  
      if ((pX11IMData == NULL) || (pX11IMData-&gt;current_ic == NULL)) {
          AWT_UNLOCK();
          return JNI_FALSE;
      }
  
<span class="udiff-line-modified-removed">-     ret = XGetICValues(pX11IMData-&gt;current_ic, XNPreeditState, &amp;state, NULL);</span>
<span class="udiff-line-modified-added">+     pr_atrb = XVaCreateNestedList(0, XNPreeditState, &amp;state, NULL);</span>
<span class="udiff-line-added">+     ret = XGetICValues(pX11IMData-&gt;current_ic, XNPreeditAttributes, pr_atrb, NULL);</span>
<span class="udiff-line-added">+     XFree((void *)pr_atrb);</span>
      AWT_UNLOCK();
  
<span class="udiff-line-modified-removed">-     if ((ret != 0) &amp;&amp; (strcmp(ret, XNPreeditState) == 0)) {</span>
<span class="udiff-line-modified-added">+     if ((ret != 0)</span>
<span class="udiff-line-added">+             &amp;&amp; ((strcmp(ret, XNPreeditAttributes) == 0)</span>
<span class="udiff-line-added">+             || (strcmp(ret, XNPreeditState) == 0))) {</span>
          JNU_ThrowByName(env, &quot;java/lang/UnsupportedOperationException&quot;, &quot;&quot;);
          return JNI_FALSE;
      }
  
      return (jboolean)(state == XIMPreeditEnable);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1616,5 +1718,22 @@</span>
      AWT_LOCK();
      adjustStatusWindow(window);
      AWT_UNLOCK();
  #endif
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if defined(__linux__) || defined(MACOSX)</span>
<span class="udiff-line-added">+ static Window getParentWindow(Window w)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     Window root=None, parent=None, *ignore_children=NULL;</span>
<span class="udiff-line-added">+     unsigned int ignore_uint=0;</span>
<span class="udiff-line-added">+     Status status = 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (w == None)</span>
<span class="udiff-line-added">+         return None;</span>
<span class="udiff-line-added">+     status = XQueryTree(dpy, w, &amp;root, &amp;parent, &amp;ignore_children, &amp;ignore_uint);</span>
<span class="udiff-line-added">+     XFree(ignore_children);</span>
<span class="udiff-line-added">+     if (status == 0)</span>
<span class="udiff-line-added">+         return None;</span>
<span class="udiff-line-added">+     return parent;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
</pre>
<center><a href="awt_GraphicsEnv.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_Insets.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>