<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/unix/native/common/awt/awt_Font.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="X11Color.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_p.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/native/common/awt/awt_Font.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1995, 2014, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1995, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 21,56 ***</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-removed">- #ifndef HEADLESS</span>
<span class="line-removed">- </span>
<span class="line-removed">- #include &quot;awt_p.h&quot;</span>
<span class="line-removed">- #include &lt;string.h&gt;</span>
<span class="line-removed">- #include &quot;java_awt_Component.h&quot;</span>
  #include &quot;java_awt_Font.h&quot;
<span class="line-modified">! #include &quot;java_awt_FontMetrics.h&quot;</span>
<span class="line-modified">! #include &quot;sun_awt_X11GraphicsEnvironment.h&quot;</span>
<span class="line-removed">- </span>
<span class="line-removed">- #include &quot;awt_Font.h&quot;</span>
<span class="line-removed">- </span>
<span class="line-removed">- #include &quot;java_awt_Dimension.h&quot;</span>
<span class="line-removed">- #include &quot;multi_font.h&quot;</span>
<span class="line-removed">- #include &quot;Disposer.h&quot;</span>
<span class="line-removed">- #endif /* !HEADLESS */</span>
<span class="line-removed">- #include &lt;jni.h&gt;</span>
<span class="line-removed">- #ifndef HEADLESS</span>
<span class="line-removed">- #include &lt;jni_util.h&gt;</span>
<span class="line-removed">- </span>
<span class="line-removed">- #define defaultXLFD &quot;-*-helvetica-*-*-*-*-12-*-*-*-*-*-iso8859-1&quot;</span>
<span class="line-removed">- </span>
<span class="line-removed">- struct FontIDs fontIDs;</span>
<span class="line-removed">- struct PlatformFontIDs platformFontIDs;</span>
<span class="line-removed">- </span>
<span class="line-removed">- static void pDataDisposeMethod(JNIEnv *env, jlong pData);</span>
  
<span class="line-removed">- /* #define FONT_DEBUG 2 */</span>
<span class="line-removed">- /* 1- print failures, 2- print all, 3- terminate on failure */</span>
<span class="line-removed">- #if FONT_DEBUG</span>
<span class="line-removed">- static XFontStruct *XLoadQueryFontX(Display *display, char *name)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     XFontStruct *result = NULL;</span>
<span class="line-removed">-     result = XLoadQueryFont(display, name);</span>
<span class="line-removed">- #if FONT_DEBUG &lt; 2</span>
<span class="line-removed">-     if (result == NULL)</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-         fprintf(stderr, &quot;XLoadQueryFont(\&quot;%s\&quot;) -&gt; 0x%x.\n&quot;, name, result);</span>
<span class="line-removed">- #if FONT_DEBUG &gt;= 3</span>
<span class="line-removed">-     if (result == NULL)</span>
<span class="line-removed">-         exit(-1);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-     return result;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- #define XLoadQueryFont XLoadQueryFontX</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- #endif /* !HEADLESS */</span>
  
  /*
   * Class:     java_awt_Font
   * Method:    initIDs
   * Signature: ()V
<span class="line-new-header">--- 21,14 ---</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  #include &quot;java_awt_Font.h&quot;
<span class="line-modified">! #include &quot;sun_awt_FontDescriptor.h&quot;</span>
<span class="line-modified">! #include &quot;sun_awt_PlatformFont.h&quot;</span>
  
  
  /*
   * Class:     java_awt_Font
   * Method:    initIDs
   * Signature: ()V
</pre>
<hr />
<pre>
<span class="line-old-header">*** 78,32 ***</span>
  
  /* This function gets called from the static initializer for Font.java
     to initialize the fieldIDs for fields that may be accessed from C */
  
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_java_awt_Font_initIDs</span>
<span class="line-removed">-   (JNIEnv *env, jclass cls)</span>
<span class="line-removed">- {</span>
<span class="line-removed">- #ifndef HEADLESS</span>
<span class="line-removed">-     CHECK_NULL(fontIDs.pData = (*env)-&gt;GetFieldID(env, cls, &quot;pData&quot;, &quot;J&quot;));</span>
<span class="line-removed">-     CHECK_NULL(fontIDs.style = (*env)-&gt;GetFieldID(env, cls, &quot;style&quot;, &quot;I&quot;));</span>
<span class="line-removed">-     CHECK_NULL(fontIDs.size = (*env)-&gt;GetFieldID(env, cls, &quot;size&quot;, &quot;I&quot;));</span>
<span class="line-removed">-     CHECK_NULL(fontIDs.getPeer = (*env)-&gt;GetMethodID(env, cls, &quot;getFontPeer&quot;,</span>
<span class="line-removed">-                                                      &quot;()Ljava/awt/peer/FontPeer;&quot;));</span>
<span class="line-removed">-     CHECK_NULL(fontIDs.getFamily = (*env)-&gt;GetMethodID(env, cls, &quot;getFamily_NoClientCode&quot;,</span>
<span class="line-removed">-                                                        &quot;()Ljava/lang/String;&quot;));</span>
<span class="line-removed">- #endif /* !HEADLESS */</span>
  }
  
<span class="line-removed">- #ifndef HEADLESS</span>
<span class="line-removed">- /* fieldIDs for FontDescriptor fields that may be accessed from C */</span>
<span class="line-removed">- static struct FontDescriptorIDs {</span>
<span class="line-removed">-     jfieldID nativeName;</span>
<span class="line-removed">-     jfieldID charsetName;</span>
<span class="line-removed">- } fontDescriptorIDs;</span>
<span class="line-removed">- #endif /* !HEADLESS */</span>
<span class="line-removed">- </span>
  /*
   * Class:     sun_awt_FontDescriptor
   * Method:    initIDs
   * Signature: ()V
   */
<span class="line-new-header">--- 36,13 ---</span>
  
  /* This function gets called from the static initializer for Font.java
     to initialize the fieldIDs for fields that may be accessed from C */
  
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_java_awt_Font_initIDs(JNIEnv *env, jclass cls) {</span>
  }
  
  /*
   * Class:     sun_awt_FontDescriptor
   * Method:    initIDs
   * Signature: ()V
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 111,19 ***</span>
  /* This function gets called from the static initializer for
     FontDescriptor.java to initialize the fieldIDs for fields
     that may be accessed from C */
  
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_sun_awt_FontDescriptor_initIDs</span>
<span class="line-removed">-   (JNIEnv *env, jclass cls)</span>
<span class="line-removed">- {</span>
<span class="line-removed">- #ifndef HEADLESS</span>
<span class="line-removed">-     CHECK_NULL(fontDescriptorIDs.nativeName =</span>
<span class="line-removed">-                (*env)-&gt;GetFieldID(env, cls, &quot;nativeName&quot;, &quot;Ljava/lang/String;&quot;));</span>
<span class="line-removed">-     CHECK_NULL(fontDescriptorIDs.charsetName =</span>
<span class="line-removed">-                (*env)-&gt;GetFieldID(env, cls, &quot;charsetName&quot;, &quot;Ljava/lang/String;&quot;));</span>
<span class="line-removed">- #endif /* !HEADLESS */</span>
  }
  
  /*
   * Class:     sun_awt_PlatformFont
   * Method:    initIDs
<span class="line-new-header">--- 50,11 ---</span>
  /* This function gets called from the static initializer for
     FontDescriptor.java to initialize the fieldIDs for fields
     that may be accessed from C */
  
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_sun_awt_FontDescriptor_initIDs(JNIEnv *env, jclass cls) {</span>
  }
  
  /*
   * Class:     sun_awt_PlatformFont
   * Method:    initIDs
</pre>
<hr />
<pre>
<span class="line-old-header">*** 133,619 ***</span>
  /* This function gets called from the static initializer for
     PlatformFont.java to initialize the fieldIDs for fields
     that may be accessed from C */
  
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_sun_awt_PlatformFont_initIDs</span>
<span class="line-removed">-   (JNIEnv *env, jclass cls)</span>
<span class="line-removed">- {</span>
<span class="line-removed">- #ifndef HEADLESS</span>
<span class="line-removed">-     CHECK_NULL(platformFontIDs.componentFonts =</span>
<span class="line-removed">-                (*env)-&gt;GetFieldID(env, cls, &quot;componentFonts&quot;,</span>
<span class="line-removed">-                                   &quot;[Lsun/awt/FontDescriptor;&quot;));</span>
<span class="line-removed">-     CHECK_NULL(platformFontIDs.fontConfig =</span>
<span class="line-removed">-                (*env)-&gt;GetFieldID(env,cls, &quot;fontConfig&quot;,</span>
<span class="line-removed">-                                   &quot;Lsun/awt/FontConfiguration;&quot;));</span>
<span class="line-removed">-     CHECK_NULL(platformFontIDs.makeConvertedMultiFontString =</span>
<span class="line-removed">-                (*env)-&gt;GetMethodID(env, cls, &quot;makeConvertedMultiFontString&quot;,</span>
<span class="line-removed">-                                    &quot;(Ljava/lang/String;)[Ljava/lang/Object;&quot;));</span>
<span class="line-removed">-     CHECK_NULL(platformFontIDs.makeConvertedMultiFontChars =</span>
<span class="line-removed">-                (*env)-&gt;GetMethodID(env, cls, &quot;makeConvertedMultiFontChars&quot;,</span>
<span class="line-removed">-                                    &quot;([CII)[Ljava/lang/Object;&quot;));</span>
<span class="line-removed">- #endif /* !HEADLESS */</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #ifndef HEADLESS</span>
<span class="line-removed">- XFontStruct *</span>
<span class="line-removed">- loadFont(Display * display, char *name, int32_t pointSize)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     XFontStruct *f = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* try the exact xlfd name in font configuration file */</span>
<span class="line-removed">-     f = XLoadQueryFont(display, name);</span>
<span class="line-removed">-     if (f != NULL) {</span>
<span class="line-removed">-         return f;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * try nearly font</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      *  1. specify FAMILY_NAME, WEIGHT_NAME, SLANT, POINT_SIZE,</span>
<span class="line-removed">-      *     CHARSET_REGISTRY and CHARSET_ENCODING.</span>
<span class="line-removed">-      *  2. change POINT_SIZE to PIXEL_SIZE</span>
<span class="line-removed">-      *  3. change FAMILY_NAME to *</span>
<span class="line-removed">-      *  4. specify only PIXEL_SIZE and CHARSET_REGISTRY/ENCODING</span>
<span class="line-removed">-      *  5. change PIXEL_SIZE +1/-1/+2/-2...+4/-4</span>
<span class="line-removed">-      *  6. default font pattern</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * This code assumes the name contains exactly 14 &#39;-&#39; delimiter.</span>
<span class="line-removed">-          * If not use default pattern.</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         int32_t i, length, pixelSize;</span>
<span class="line-removed">-         Boolean useDefault = FALSE;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         char buffer[BUFSIZ], buffer2[BUFSIZ];</span>
<span class="line-removed">-         char *family = NULL, *style = NULL, *slant = NULL, *encoding = NULL;</span>
<span class="line-removed">-         char *start = NULL, *end = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (strlen(name) &gt; BUFSIZ - 1) {</span>
<span class="line-removed">-             useDefault = TRUE;</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             strcpy(buffer, name);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #define NEXT_HYPHEN\</span>
<span class="line-removed">-         start = end + 1;\</span>
<span class="line-removed">-         end = strchr(start, &#39;-&#39;);\</span>
<span class="line-removed">-         if (end == NULL) {\</span>
<span class="line-removed">-                               useDefault = TRUE;\</span>
<span class="line-removed">-         break;\</span>
<span class="line-removed">-         }\</span>
<span class="line-removed">-         *end = &#39;\0&#39;</span>
<span class="line-removed">- </span>
<span class="line-removed">-              do {</span>
<span class="line-removed">-                  end = buffer;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                  /* skip FOUNDRY */</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                  /* set FAMILY_NAME */</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  family = start;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                  /* set STYLE_NAME */</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  style = start;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                  /* set SLANT */</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  slant = start;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                  /* skip SETWIDTH_NAME, ADD_STYLE_NAME, PIXEL_SIZE</span>
<span class="line-removed">-                     POINT_SIZE, RESOLUTION_X, RESOLUTION_Y, SPACING</span>
<span class="line-removed">-                     and AVERAGE_WIDTH */</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">-                  NEXT_HYPHEN;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                  /* set CHARSET_REGISTRY and CHARSET_ENCODING */</span>
<span class="line-removed">-                  encoding = end + 1;</span>
<span class="line-removed">-              }</span>
<span class="line-removed">-              while (0);</span>
<span class="line-removed">- </span>
<span class="line-removed">- #define TRY_LOAD\</span>
<span class="line-removed">-         f = XLoadQueryFont(display, buffer2);\</span>
<span class="line-removed">-         if (f != NULL) {\</span>
<span class="line-removed">-                             strcpy(name, buffer2);\</span>
<span class="line-removed">-         return f;\</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (!useDefault) {</span>
<span class="line-removed">-             char *altstyle = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /* Regular is the style for TrueType fonts -- Type1, F3 use roman */</span>
<span class="line-removed">-             if (strcmp(style, &quot;regular&quot;) == 0) {</span>
<span class="line-removed">-                 altstyle = &quot;roman&quot;;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- #if defined(__linux__) || defined(MACOSX)</span>
<span class="line-removed">-             if (!strcmp(family, &quot;lucidasans&quot;)) {</span>
<span class="line-removed">-                 family = &quot;lucida&quot;;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-             /* try 1. */</span>
<span class="line-removed">-             jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                          &quot;-*-%s-%s-%s-*-*-*-%d-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                          family, style, slant, pointSize, encoding);</span>
<span class="line-removed">-             TRY_LOAD;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             if (altstyle != NULL) {</span>
<span class="line-removed">-                 jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                              &quot;-*-%s-%s-%s-*-*-*-%d-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                              family, altstyle, slant, pointSize, encoding);</span>
<span class="line-removed">-                 TRY_LOAD;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /* search bitmap font */</span>
<span class="line-removed">-             pixelSize = pointSize / 10;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /* try 2. */</span>
<span class="line-removed">-             jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                          &quot;-*-%s-%s-%s-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                          family, style, slant, pixelSize, encoding);</span>
<span class="line-removed">-             TRY_LOAD;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             if (altstyle != NULL) {</span>
<span class="line-removed">-                 jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                              &quot;-*-%s-%s-%s-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                              family, altstyle, slant, pixelSize, encoding);</span>
<span class="line-removed">-                 TRY_LOAD;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /* try 3 */</span>
<span class="line-removed">-             jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                          &quot;-*-*-%s-%s-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                          style, slant, pixelSize, encoding);</span>
<span class="line-removed">-             TRY_LOAD;</span>
<span class="line-removed">-             if (altstyle != NULL) {</span>
<span class="line-removed">-                 jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                              &quot;-*-*-%s-%s-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                              altstyle, slant, pixelSize, encoding);</span>
<span class="line-removed">-                 TRY_LOAD;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /* try 4 */</span>
<span class="line-removed">-             jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                          &quot;-*-*-*-%s-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                          slant, pixelSize, encoding);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             TRY_LOAD;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /* try 5. */</span>
<span class="line-removed">-             jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                          &quot;-*-*-*-*-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                          pixelSize, encoding);</span>
<span class="line-removed">-             TRY_LOAD;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /* try 6. */</span>
<span class="line-removed">-             for (i = 1; i &lt; 4; i++) {</span>
<span class="line-removed">-                 if (pixelSize &lt; i)</span>
<span class="line-removed">-                     break;</span>
<span class="line-removed">-                 jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                              &quot;-*-%s-%s-%s-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                              family, style, slant, pixelSize + i, encoding);</span>
<span class="line-removed">-                 TRY_LOAD;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                              &quot;-*-%s-%s-%s-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                              family, style, slant, pixelSize - i, encoding);</span>
<span class="line-removed">-                 TRY_LOAD;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                              &quot;-*-*-*-*-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                              pixelSize + i, encoding);</span>
<span class="line-removed">-                 TRY_LOAD;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 jio_snprintf(buffer2, sizeof(buffer2),</span>
<span class="line-removed">-                              &quot;-*-*-*-*-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                              pixelSize - i, encoding);</span>
<span class="line-removed">-                 TRY_LOAD;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     strcpy(name, defaultXLFD);</span>
<span class="line-removed">-     return XLoadQueryFont(display, defaultXLFD);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- /*</span>
<span class="line-removed">-  * Hardwired list of mappings for generic font names &quot;Helvetica&quot;,</span>
<span class="line-removed">-  * &quot;TimesRoman&quot;, &quot;Courier&quot;, &quot;Dialog&quot;, and &quot;DialogInput&quot;.</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- static char *defaultfontname = &quot;fixed&quot;;</span>
<span class="line-removed">- static char *defaultfoundry = &quot;misc&quot;;</span>
<span class="line-removed">- static char *anyfoundry = &quot;*&quot;;</span>
<span class="line-removed">- static char *anystyle = &quot;*-*&quot;;</span>
<span class="line-removed">- static char *isolatin1 = &quot;iso8859-1&quot;;</span>
<span class="line-removed">- </span>
<span class="line-removed">- static char *</span>
<span class="line-removed">- Style(int32_t s)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     switch (s) {</span>
<span class="line-removed">-         case java_awt_Font_ITALIC:</span>
<span class="line-removed">-             return &quot;medium-i&quot;;</span>
<span class="line-removed">-         case java_awt_Font_BOLD:</span>
<span class="line-removed">-             return &quot;bold-r&quot;;</span>
<span class="line-removed">-         case java_awt_Font_BOLD + java_awt_Font_ITALIC:</span>
<span class="line-removed">-             return &quot;bold-i&quot;;</span>
<span class="line-removed">-         case java_awt_Font_PLAIN:</span>
<span class="line-removed">-         default:</span>
<span class="line-removed">-             return &quot;medium-r&quot;;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static int32_t</span>
<span class="line-removed">- awtJNI_FontName(JNIEnv * env, jstring name, char **foundry, char **facename, char **encoding)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     char *cname = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (JNU_IsNull(env, name)) {</span>
<span class="line-removed">-         return 0;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     cname = (char *) JNU_GetStringPlatformChars(env, name, NULL);</span>
<span class="line-removed">-     if (cname == NULL) {</span>
<span class="line-removed">-         (*env)-&gt;ExceptionClear(env);</span>
<span class="line-removed">-         JNU_ThrowOutOfMemoryError(env, &quot;Could not create font name&quot;);</span>
<span class="line-removed">-         return 0;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* additional default font names */</span>
<span class="line-removed">-     if (strcmp(cname, &quot;serif&quot;) == 0) {</span>
<span class="line-removed">-         *foundry = &quot;adobe&quot;;</span>
<span class="line-removed">-         *facename = &quot;times&quot;;</span>
<span class="line-removed">-         *encoding = isolatin1;</span>
<span class="line-removed">-     } else if (strcmp(cname, &quot;sansserif&quot;) == 0) {</span>
<span class="line-removed">-         *foundry = &quot;adobe&quot;;</span>
<span class="line-removed">-         *facename = &quot;helvetica&quot;;</span>
<span class="line-removed">-         *encoding = isolatin1;</span>
<span class="line-removed">-     } else if (strcmp(cname, &quot;monospaced&quot;) == 0) {</span>
<span class="line-removed">-         *foundry = &quot;adobe&quot;;</span>
<span class="line-removed">-         *facename = &quot;courier&quot;;</span>
<span class="line-removed">-         *encoding = isolatin1;</span>
<span class="line-removed">-     } else if (strcmp(cname, &quot;helvetica&quot;) == 0) {</span>
<span class="line-removed">-         *foundry = &quot;adobe&quot;;</span>
<span class="line-removed">-         *facename = &quot;helvetica&quot;;</span>
<span class="line-removed">-         *encoding = isolatin1;</span>
<span class="line-removed">-     } else if (strcmp(cname, &quot;timesroman&quot;) == 0) {</span>
<span class="line-removed">-         *foundry = &quot;adobe&quot;;</span>
<span class="line-removed">-         *facename = &quot;times&quot;;</span>
<span class="line-removed">-         *encoding = isolatin1;</span>
<span class="line-removed">-     } else if (strcmp(cname, &quot;courier&quot;) == 0) {</span>
<span class="line-removed">-         *foundry = &quot;adobe&quot;;</span>
<span class="line-removed">-         *facename = &quot;courier&quot;;</span>
<span class="line-removed">-         *encoding = isolatin1;</span>
<span class="line-removed">-     } else if (strcmp(cname, &quot;dialog&quot;) == 0) {</span>
<span class="line-removed">-         *foundry = &quot;b&amp;h&quot;;</span>
<span class="line-removed">-         *facename = &quot;lucida&quot;;</span>
<span class="line-removed">-         *encoding = isolatin1;</span>
<span class="line-removed">-     } else if (strcmp(cname, &quot;dialoginput&quot;) == 0) {</span>
<span class="line-removed">-         *foundry = &quot;b&amp;h&quot;;</span>
<span class="line-removed">-         *facename = &quot;lucidatypewriter&quot;;</span>
<span class="line-removed">-         *encoding = isolatin1;</span>
<span class="line-removed">-     } else if (strcmp(cname, &quot;zapfdingbats&quot;) == 0) {</span>
<span class="line-removed">-         *foundry = &quot;itc&quot;;</span>
<span class="line-removed">-         *facename = &quot;zapfdingbats&quot;;</span>
<span class="line-removed">-         *encoding = &quot;*-*&quot;;</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">- #ifdef DEBUG</span>
<span class="line-removed">-         jio_fprintf(stderr, &quot;Unknown font: %s\n&quot;, cname);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-         *foundry = defaultfoundry;</span>
<span class="line-removed">-         *facename = defaultfontname;</span>
<span class="line-removed">-         *encoding = isolatin1;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (cname != NULL)</span>
<span class="line-removed">-         JNU_ReleaseStringPlatformChars(env, name, (const char *) cname);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return 1;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- struct FontData *</span>
<span class="line-removed">- awtJNI_GetFontData(JNIEnv * env, jobject font, char **errmsg)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     /* We are going to create at most 4 outstanding local refs in this</span>
<span class="line-removed">-      * function. */</span>
<span class="line-removed">-     if ((*env)-&gt;EnsureLocalCapacity(env, 4) &lt; 0) {</span>
<span class="line-removed">-         return NULL;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (!JNU_IsNull(env, font) &amp;&amp; awtJNI_IsMultiFont(env, font)) {</span>
<span class="line-removed">-         JNU_CHECK_EXCEPTION_RETURN(env, NULL);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         struct FontData *fdata = NULL;</span>
<span class="line-removed">-         int32_t i, size;</span>
<span class="line-removed">-         char *fontsetname = NULL;</span>
<span class="line-removed">-         char *nativename = NULL;</span>
<span class="line-removed">-         Boolean doFree = FALSE;</span>
<span class="line-removed">-         jobjectArray componentFonts = NULL;</span>
<span class="line-removed">-         jobject peer = NULL;</span>
<span class="line-removed">-         jobject fontDescriptor = NULL;</span>
<span class="line-removed">-         jstring fontDescriptorName = NULL;</span>
<span class="line-removed">-         jstring charsetName = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         fdata = (struct FontData *) JNU_GetLongFieldAsPtr(env,font,</span>
<span class="line-removed">-                                                          fontIDs.pData);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (fdata != NULL &amp;&amp; fdata-&gt;flist != NULL) {</span>
<span class="line-removed">-             return fdata;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         size = (*env)-&gt;GetIntField(env, font, fontIDs.size);</span>
<span class="line-removed">-         fdata = (struct FontData *) malloc(sizeof(struct FontData));</span>
<span class="line-removed">- </span>
<span class="line-removed">-         peer = (*env)-&gt;CallObjectMethod(env, font, fontIDs.getPeer);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         componentFonts =</span>
<span class="line-removed">-           (*env)-&gt;GetObjectField(env, peer, platformFontIDs.componentFonts);</span>
<span class="line-removed">-         /* We no longer need peer */</span>
<span class="line-removed">-         (*env)-&gt;DeleteLocalRef(env, peer);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         fdata-&gt;charset_num = (*env)-&gt;GetArrayLength(env, componentFonts);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         fdata-&gt;flist = (awtFontList *) malloc(sizeof(awtFontList)</span>
<span class="line-removed">-                                               * fdata-&gt;charset_num);</span>
<span class="line-removed">-         fdata-&gt;xfont = NULL;</span>
<span class="line-removed">-         for (i = 0; i &lt; fdata-&gt;charset_num; i++) {</span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * set xlfd name</span>
<span class="line-removed">-              */</span>
<span class="line-removed">- </span>
<span class="line-removed">-             fontDescriptor = (*env)-&gt;GetObjectArrayElement(env, componentFonts, i);</span>
<span class="line-removed">-             fontDescriptorName =</span>
<span class="line-removed">-               (*env)-&gt;GetObjectField(env, fontDescriptor,</span>
<span class="line-removed">-                                      fontDescriptorIDs.nativeName);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             if (!JNU_IsNull(env, fontDescriptorName)) {</span>
<span class="line-removed">-                 nativename = (char *) JNU_GetStringPlatformChars(env, fontDescriptorName, NULL);</span>
<span class="line-removed">-                 if (nativename == NULL) {</span>
<span class="line-removed">-                     nativename = &quot;&quot;;</span>
<span class="line-removed">-                     doFree = FALSE;</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     doFree = TRUE;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 nativename = &quot;&quot;;</span>
<span class="line-removed">-                 doFree = FALSE;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             fdata-&gt;flist[i].xlfd = malloc(strlen(nativename)</span>
<span class="line-removed">-                                           + strlen(defaultXLFD));</span>
<span class="line-removed">-             jio_snprintf(fdata-&gt;flist[i].xlfd, strlen(nativename) + 10,</span>
<span class="line-removed">-                          nativename, size * 10);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             if (nativename != NULL &amp;&amp; doFree)</span>
<span class="line-removed">-                 JNU_ReleaseStringPlatformChars(env, fontDescriptorName, (const char *) nativename);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * set charset_name</span>
<span class="line-removed">-              */</span>
<span class="line-removed">- </span>
<span class="line-removed">-             charsetName =</span>
<span class="line-removed">-               (*env)-&gt;GetObjectField(env, fontDescriptor,</span>
<span class="line-removed">-                                      fontDescriptorIDs.charsetName);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             fdata-&gt;flist[i].charset_name = (char *)</span>
<span class="line-removed">-                 JNU_GetStringPlatformChars(env, charsetName, NULL);</span>
<span class="line-removed">-             if (fdata-&gt;flist[i].charset_name == NULL) {</span>
<span class="line-removed">-                 (*env)-&gt;ExceptionClear(env);</span>
<span class="line-removed">-                 JNU_ThrowOutOfMemoryError(env, &quot;Could not create charset name&quot;);</span>
<span class="line-removed">-                 return NULL;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /* We are done with the objects. */</span>
<span class="line-removed">-             (*env)-&gt;DeleteLocalRef(env, fontDescriptor);</span>
<span class="line-removed">-             (*env)-&gt;DeleteLocalRef(env, fontDescriptorName);</span>
<span class="line-removed">-             (*env)-&gt;DeleteLocalRef(env, charsetName);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * set load &amp; XFontStruct</span>
<span class="line-removed">-              */</span>
<span class="line-removed">-             fdata-&gt;flist[i].load = 0;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * This appears to be a bogus check.  The actual intent appears</span>
<span class="line-removed">-              * to be to find out whether this is the &quot;base&quot; font in a set,</span>
<span class="line-removed">-              * rather than iso8859_1 explicitly.  Note that iso8859_15 will</span>
<span class="line-removed">-              * and must also pass this test.</span>
<span class="line-removed">-              */</span>
<span class="line-removed">- </span>
<span class="line-removed">-             if (fdata-&gt;xfont == NULL &amp;&amp;</span>
<span class="line-removed">-                 strstr(fdata-&gt;flist[i].charset_name, &quot;8859_1&quot;)) {</span>
<span class="line-removed">-                 fdata-&gt;flist[i].xfont =</span>
<span class="line-removed">-                     loadFont(awt_display, fdata-&gt;flist[i].xlfd, size * 10);</span>
<span class="line-removed">-                 if (fdata-&gt;flist[i].xfont != NULL) {</span>
<span class="line-removed">-                     fdata-&gt;flist[i].load = 1;</span>
<span class="line-removed">-                     fdata-&gt;xfont = fdata-&gt;flist[i].xfont;</span>
<span class="line-removed">-                     fdata-&gt;flist[i].index_length = 1;</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     /* Free any already allocated storage and fonts */</span>
<span class="line-removed">-                     int j = i;</span>
<span class="line-removed">-                     for (j = 0; j &lt;= i; j++) {</span>
<span class="line-removed">-                         free((void *)fdata-&gt;flist[j].xlfd);</span>
<span class="line-removed">-                         JNU_ReleaseStringPlatformChars(env, NULL,</span>
<span class="line-removed">-                             fdata-&gt;flist[j].charset_name);</span>
<span class="line-removed">-                         if (fdata-&gt;flist[j].load) {</span>
<span class="line-removed">-                             XFreeFont(awt_display, fdata-&gt;flist[j].xfont);</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     free((void *)fdata-&gt;flist);</span>
<span class="line-removed">-                     free((void *)fdata);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                     if (errmsg != NULL) {</span>
<span class="line-removed">-                         *errmsg = &quot;java/lang&quot; &quot;NullPointerException&quot;;</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     (*env)-&gt;DeleteLocalRef(env, componentFonts);</span>
<span class="line-removed">-                     return NULL;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         (*env)-&gt;DeleteLocalRef(env, componentFonts);</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * XFontSet will create if the peer of TextField/TextArea</span>
<span class="line-removed">-          * are used.</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         fdata-&gt;xfs = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         JNU_SetLongFieldFromPtr(env,font,fontIDs.pData,fdata);</span>
<span class="line-removed">-         Disposer_AddRecord(env, font, pDataDisposeMethod, ptr_to_jlong(fdata));</span>
<span class="line-removed">-         return fdata;</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         JNU_CHECK_EXCEPTION_RETURN(env, NULL);</span>
<span class="line-removed">-         Display *display = NULL;</span>
<span class="line-removed">-         struct FontData *fdata = NULL;</span>
<span class="line-removed">-         char fontSpec[1024];</span>
<span class="line-removed">-         int32_t height;</span>
<span class="line-removed">-         int32_t oheight;</span>
<span class="line-removed">-         int32_t above = 0;              /* tries above height */</span>
<span class="line-removed">-         int32_t below = 0;              /* tries below height */</span>
<span class="line-removed">-         char *foundry = NULL;</span>
<span class="line-removed">-         char *name = NULL;</span>
<span class="line-removed">-         char *encoding = NULL;</span>
<span class="line-removed">-         char *style = NULL;</span>
<span class="line-removed">-         XFontStruct *xfont = NULL;</span>
<span class="line-removed">-         jstring family = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (JNU_IsNull(env, font)) {</span>
<span class="line-removed">-             if (errmsg != NULL) {</span>
<span class="line-removed">-                 *errmsg = &quot;java/lang&quot; &quot;NullPointerException&quot;;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             return (struct FontData *) NULL;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         display = XDISPLAY;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         fdata = (struct FontData *) JNU_GetLongFieldAsPtr(env,font,fontIDs.pData);</span>
<span class="line-removed">-         if (fdata != NULL &amp;&amp; fdata-&gt;xfont != NULL) {</span>
<span class="line-removed">-             return fdata;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         family = (*env)-&gt;CallObjectMethod(env, font, fontIDs.getFamily);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (!awtJNI_FontName(env, family, &amp;foundry, &amp;name, &amp;encoding)) {</span>
<span class="line-removed">-             if (errmsg != NULL) {</span>
<span class="line-removed">-                 *errmsg = &quot;java/lang&quot; &quot;NullPointerException&quot;;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             (*env)-&gt;DeleteLocalRef(env, family);</span>
<span class="line-removed">-             return (struct FontData *) NULL;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         style = Style((*env)-&gt;GetIntField(env, font, fontIDs.style));</span>
<span class="line-removed">-         oheight = height = (*env)-&gt;GetIntField(env, font, fontIDs.size);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         while (1) {</span>
<span class="line-removed">-             jio_snprintf(fontSpec, sizeof(fontSpec), &quot;-%s-%s-%s-*-*-%d-*-*-*-*-*-%s&quot;,</span>
<span class="line-removed">-                          foundry,</span>
<span class="line-removed">-                          name,</span>
<span class="line-removed">-                          style,</span>
<span class="line-removed">-                          height,</span>
<span class="line-removed">-                          encoding);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /*fprintf(stderr,&quot;LoadFont: %s\n&quot;, fontSpec); */</span>
<span class="line-removed">-             xfont = XLoadQueryFont(display, fontSpec);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /* XXX: sometimes XLoadQueryFont returns a bogus font structure */</span>
<span class="line-removed">-             /* with negative ascent. */</span>
<span class="line-removed">-             if (xfont == NULL || xfont-&gt;ascent &lt; 0) {</span>
<span class="line-removed">-                 if (xfont != NULL) {</span>
<span class="line-removed">-                     XFreeFont(display, xfont);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 if (foundry != anyfoundry) {  /* Use ptr comparison here, not strcmp */</span>
<span class="line-removed">-                     /* Try any other foundry before messing with the sizes */</span>
<span class="line-removed">-                     foundry = anyfoundry;</span>
<span class="line-removed">-                     continue;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 /* We couldn&#39;t find the font. We&#39;ll try to find an */</span>
<span class="line-removed">-                 /* alternate by searching for heights above and below our */</span>
<span class="line-removed">-                 /* preferred height. We try for 4 heights above and below. */</span>
<span class="line-removed">-                 /* If we still can&#39;t find a font we repeat the algorithm */</span>
<span class="line-removed">-                 /* using misc-fixed as the font. If we then fail, then we */</span>
<span class="line-removed">-                 /* give up and signal an error. */</span>
<span class="line-removed">-                 if (above == below) {</span>
<span class="line-removed">-                     above++;</span>
<span class="line-removed">-                     height = oheight + above;</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     below++;</span>
<span class="line-removed">-                     if (below &gt; 4) {</span>
<span class="line-removed">-                         if (name != defaultfontname || style != anystyle) {</span>
<span class="line-removed">-                             name = defaultfontname;</span>
<span class="line-removed">-                             foundry = defaultfoundry;</span>
<span class="line-removed">-                             height = oheight;</span>
<span class="line-removed">-                             style = anystyle;</span>
<span class="line-removed">-                             encoding = isolatin1;</span>
<span class="line-removed">-                             above = below = 0;</span>
<span class="line-removed">-                             continue;</span>
<span class="line-removed">-                         } else {</span>
<span class="line-removed">-                             if (errmsg != NULL) {</span>
<span class="line-removed">-                                 *errmsg = &quot;java/io/&quot; &quot;FileNotFoundException&quot;;</span>
<span class="line-removed">-                             }</span>
<span class="line-removed">-                             (*env)-&gt;DeleteLocalRef(env, family);</span>
<span class="line-removed">-                             return (struct FontData *) NULL;</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     height = oheight - below;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 continue;</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 fdata = ZALLOC(FontData);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 if (fdata == NULL) {</span>
<span class="line-removed">-                     if (errmsg != NULL) {</span>
<span class="line-removed">-                         *errmsg = &quot;java/lang&quot; &quot;OutOfMemoryError&quot;;</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     fdata-&gt;xfont = xfont;</span>
<span class="line-removed">-                     JNU_SetLongFieldFromPtr(env,font,fontIDs.pData,fdata);</span>
<span class="line-removed">-                     Disposer_AddRecord(env, font, pDataDisposeMethod,</span>
<span class="line-removed">-                                        ptr_to_jlong(fdata));</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 (*env)-&gt;DeleteLocalRef(env, family);</span>
<span class="line-removed">-                 return fdata;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         /* not reached */</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- /*</span>
<span class="line-removed">-  * Registered with the 2D disposer to be called after the Font is GC&#39;d.</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- static void pDataDisposeMethod(JNIEnv *env, jlong pData)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     struct FontData *fdata = NULL;</span>
<span class="line-removed">-     int32_t i = 0;</span>
<span class="line-removed">-     Display *display = XDISPLAY;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     AWT_LOCK();</span>
<span class="line-removed">-     fdata = (struct FontData *)pData;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (fdata == NULL) {</span>
<span class="line-removed">-         AWT_UNLOCK();</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (fdata-&gt;xfs != NULL) {</span>
<span class="line-removed">-         XFreeFontSet(display, fdata-&gt;xfs);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* AWT fonts are always &quot;multifonts&quot; and probably have been in</span>
<span class="line-removed">-      * all post 1.0 releases, so this test for multi fonts is</span>
<span class="line-removed">-      * probably not needed, and the singleton xfont is probably never used.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     if (fdata-&gt;charset_num &gt; 0) {</span>
<span class="line-removed">-         for (i = 0; i &lt; fdata-&gt;charset_num; i++) {</span>
<span class="line-removed">-             free((void *)fdata-&gt;flist[i].xlfd);</span>
<span class="line-removed">-             JNU_ReleaseStringPlatformChars(env, NULL,</span>
<span class="line-removed">-                                            fdata-&gt;flist[i].charset_name);</span>
<span class="line-removed">-             if (fdata-&gt;flist[i].load) {</span>
<span class="line-removed">-                 XFreeFont(display, fdata-&gt;flist[i].xfont);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         free((void *)fdata-&gt;flist);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* Don&#39;t free fdata-&gt;xfont because it is equal to fdata-&gt;flist[i].xfont</span>
<span class="line-removed">-            for some &#39;i&#39; */</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         if (fdata-&gt;xfont != NULL) {</span>
<span class="line-removed">-             XFreeFont(display, fdata-&gt;xfont);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     free((void *)fdata);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     AWT_UNLOCK();</span>
  }
<span class="line-removed">- #endif /* !HEADLESS */</span>
<span class="line-new-header">--- 64,7 ---</span>
  /* This function gets called from the static initializer for
     PlatformFont.java to initialize the fieldIDs for fields
     that may be accessed from C */
  
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_sun_awt_PlatformFont_initIDs(JNIEnv *env, jclass cls) {</span>
  }
</pre>
<center><a href="X11Color.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_p.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>