<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/unix/native/common/java2d/x11/X11FontScaler_md.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../opengl/J2D_GL/glxext.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="X11SurfaceData.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/native/common/java2d/x11/X11FontScaler_md.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
256 #ifndef HEADLESS
257     free(xChar);
258 #endif /* !HEADLESS */
259 }
260 
261 JNIEXPORT jlong JNICALL AWTFontGenerateImage(AWTFont pFont, AWTChar2b* xChar) {
262 
263 #ifndef HEADLESS
264 
265     int width, height, direction, ascent, descent;
266     GlyphInfo *glyphInfo;
267     XFontStruct* xFont = (XFontStruct*)pFont;
268     XCharStruct xcs;
269     XImage *ximage;
270     int h, i, j, nbytes;
271     unsigned char *srcRow, *dstRow, *dstByte;
272     int wholeByteCount, remainingBitsCount;
273     unsigned int imageSize;
274     JNIEnv *env;
275 

276     FONT_AWT_LOCK();
277 /*     XTextExtents16(xFont, xChar, 1, &amp;direction, &amp;ascent, &amp;descent, &amp;xcs); */
278     XQueryTextExtents16(awt_display,xFont-&gt;fid, xChar, 1,
279                         &amp;direction, &amp;ascent, &amp;descent, &amp;xcs);
280     width = xcs.rbearing - xcs.lbearing;
281     height = xcs.ascent+xcs.descent;
282     imageSize = width*height;
<span class="line-removed">283 </span>
284     glyphInfo = (GlyphInfo*)malloc(sizeof(GlyphInfo)+imageSize);




285     glyphInfo-&gt;cellInfo = NULL;
286     glyphInfo-&gt;width = width;
287     glyphInfo-&gt;height = height;
288     glyphInfo-&gt;topLeftX = xcs.lbearing;
289     glyphInfo-&gt;topLeftY = -xcs.ascent;
290     glyphInfo-&gt;advanceX = xcs.width;
291     glyphInfo-&gt;advanceY = 0;
292 
293     if (imageSize == 0) {
294         glyphInfo-&gt;image = NULL;
295         AWT_UNLOCK();
296         return (jlong)(uintptr_t)glyphInfo;
297     } else {
298         glyphInfo-&gt;image = (unsigned char*)glyphInfo+sizeof(GlyphInfo);
299     }
300 
301     if ((pixmap == 0) || (width &gt; pixmapWidth) || (height &gt; pixmapHeight)) {
302         if (CreatePixmapAndGC(width, height) != Success) {
303             glyphInfo-&gt;image = NULL;
304             AWT_UNLOCK();
</pre>
</td>
<td>
<hr />
<pre>
256 #ifndef HEADLESS
257     free(xChar);
258 #endif /* !HEADLESS */
259 }
260 
261 JNIEXPORT jlong JNICALL AWTFontGenerateImage(AWTFont pFont, AWTChar2b* xChar) {
262 
263 #ifndef HEADLESS
264 
265     int width, height, direction, ascent, descent;
266     GlyphInfo *glyphInfo;
267     XFontStruct* xFont = (XFontStruct*)pFont;
268     XCharStruct xcs;
269     XImage *ximage;
270     int h, i, j, nbytes;
271     unsigned char *srcRow, *dstRow, *dstByte;
272     int wholeByteCount, remainingBitsCount;
273     unsigned int imageSize;
274     JNIEnv *env;
275 
<span class="line-added">276 </span>
277     FONT_AWT_LOCK();
278 /*     XTextExtents16(xFont, xChar, 1, &amp;direction, &amp;ascent, &amp;descent, &amp;xcs); */
279     XQueryTextExtents16(awt_display,xFont-&gt;fid, xChar, 1,
280                         &amp;direction, &amp;ascent, &amp;descent, &amp;xcs);
281     width = xcs.rbearing - xcs.lbearing;
282     height = xcs.ascent+xcs.descent;
283     imageSize = width*height;

284     glyphInfo = (GlyphInfo*)malloc(sizeof(GlyphInfo)+imageSize);
<span class="line-added">285     if (glyphInfo == NULL) {</span>
<span class="line-added">286         AWT_UNLOCK();</span>
<span class="line-added">287         return (jlong)(uintptr_t)NULL;</span>
<span class="line-added">288     }</span>
289     glyphInfo-&gt;cellInfo = NULL;
290     glyphInfo-&gt;width = width;
291     glyphInfo-&gt;height = height;
292     glyphInfo-&gt;topLeftX = xcs.lbearing;
293     glyphInfo-&gt;topLeftY = -xcs.ascent;
294     glyphInfo-&gt;advanceX = xcs.width;
295     glyphInfo-&gt;advanceY = 0;
296 
297     if (imageSize == 0) {
298         glyphInfo-&gt;image = NULL;
299         AWT_UNLOCK();
300         return (jlong)(uintptr_t)glyphInfo;
301     } else {
302         glyphInfo-&gt;image = (unsigned char*)glyphInfo+sizeof(GlyphInfo);
303     }
304 
305     if ((pixmap == 0) || (width &gt; pixmapWidth) || (height &gt; pixmapHeight)) {
306         if (CreatePixmapAndGC(width, height) != Success) {
307             glyphInfo-&gt;image = NULL;
308             AWT_UNLOCK();
</pre>
</td>
</tr>
</table>
<center><a href="../opengl/J2D_GL/glxext.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="X11SurfaceData.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>