<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/unix/native/common/awt/fontpath.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="awt_p.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/opengl/GLXSurfaceData.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/native/common/awt/fontpath.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1998, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 324 #ifndef HEADLESS
 325 static char **getX11FontPath ()
 326 {
 327     char **x11Path, **fontdirs;
 328     int i, pos, slen, nPaths, numDirs;
 329 
 330     x11Path = XGetFontPath (awt_display, &amp;nPaths);
 331 
 332     /* This isn&#39;t ever going to be perfect: the font path may contain
 333      * much we aren&#39;t interested in, but the cost should be moderate
 334      * Exclude all directories that contain the strings &quot;Speedo&quot;,&quot;/F3/&quot;,
 335      * &quot;75dpi&quot;, &quot;100dpi&quot;, &quot;misc&quot; or &quot;bitmap&quot;, or don&#39;t begin with a &quot;/&quot;,
 336      * the last of which should exclude font servers.
 337      * Also exclude the user specific &quot;.gnome*&quot; directories which
 338      * aren&#39;t going to contain the system fonts we need.
 339      * Hopefully we are left only with Type1 and TrueType directories.
 340      * It doesn&#39;t matter much if there are extraneous directories, it&#39;ll just
 341      * cost us a little wasted effort upstream.
 342      */
 343     fontdirs = (char**)calloc(nPaths+1, sizeof(char*));



 344     pos = 0;
 345     for (i=0; i &lt; nPaths; i++) {
 346         if (x11Path[i][0] != &#39;/&#39;) {
 347             continue;
 348         }
 349         if (strstr(x11Path[i], &quot;/75dpi&quot;) != NULL) {
 350             continue;
 351         }
 352         if (strstr(x11Path[i], &quot;/100dpi&quot;) != NULL) {
 353             continue;
 354         }
 355         if (strstr(x11Path[i], &quot;/misc&quot;) != NULL) {
 356             continue;
 357         }
 358         if (strstr(x11Path[i], &quot;/Speedo&quot;) != NULL) {
 359             continue;
 360         }
 361         if (strstr(x11Path[i], &quot;.gnome&quot;) != NULL) {
 362             continue;
 363         }
</pre>
<hr />
<pre>
 403     int len1=0, len2=0, len3=0, totalLen=0, numDirs=0,
 404         currLen, i, j, found, pathLen=0;
 405     char **ptr, **fontdirs;
 406     char *fontPath = NULL;
 407 
 408     if (p1 != NULL) {
 409         ptr = p1;
 410         while (*ptr++ != NULL) len1++;
 411     }
 412     if (p2 != NULL) {
 413         ptr = p2;
 414 
 415         while (*ptr++ != NULL) len2++;
 416     }
 417     if (p3 != NULL) {
 418         ptr = p3;
 419         while (*ptr++ != NULL) len3++;
 420     }
 421     totalLen = len1+len2+len3;
 422     fontdirs = (char**)calloc(totalLen, sizeof(char*));



 423 
 424     for (i=0; i &lt; len1; i++) {
 425         if (noType1 &amp;&amp; strstr(p1[i], &quot;Type1&quot;) != NULL) {
 426             continue;
 427         }
 428         fontdirs[numDirs++] = p1[i];
 429     }
 430 
 431     currLen = numDirs; /* only compare against previous path dirs */
 432     for (i=0; i &lt; len2; i++) {
 433         if (noType1 &amp;&amp; strstr(p2[i], &quot;Type1&quot;) != NULL) {
 434             continue;
 435         }
 436         found = 0;
 437         for (j=0; j &lt; currLen; j++) {
 438             if (strcmp(fontdirs[j], p2[i]) == 0) {
 439                 found = 1;
 440                 break;
 441             }
 442         }
</pre>
<hr />
<pre>
 799      * outline fonts, and to get the set of full file paths from the matches.
 800      * This set is returned from the call to FcFontList(..)
 801      * We allocate an array of char* pointers sufficient to hold all
 802      * the matches + 1 extra which ensures there will be a NULL after all
 803      * valid entries.
 804      * We call FcStrDirname strip the file name from the path, and
 805      * check if we have yet seen this directory. If not we add a pointer to
 806      * it into our array of char*. Note that FcStrDirname returns newly
 807      * allocated storage so we can use this in the return char** value.
 808      * Finally we clean up, freeing allocated resources, and return the
 809      * array of unique directories.
 810      */
 811     pattern = (*FcPatternBuild)(NULL, FC_OUTLINE, FcTypeBool, FcTrue, NULL);
 812     objset = (*FcObjectSetBuild)(FC_FILE, NULL);
 813     fontSet = (*FcFontList)(NULL, pattern, objset);
 814     if (fontSet == NULL) {
 815         /* FcFontList() may return NULL if fonts are not installed. */
 816         fontdirs = NULL;
 817     } else {
 818         fontdirs = (char**)calloc(fontSet-&gt;nfont+1, sizeof(char*));




 819         for (f=0; f &lt; fontSet-&gt;nfont; f++) {
 820             FcChar8 *file;
 821             FcChar8 *dir;
 822             if ((*FcPatternGetString)(fontSet-&gt;fonts[f], FC_FILE, 0, &amp;file) ==
 823                                       FcResultMatch) {
 824                 dir = (*FcStrDirname)(file);
 825                 found = 0;
 826                 for (i=0;i&lt;numdirs; i++) {
 827                     if (strcmp(fontdirs[i], (char*)dir) == 0) {
 828                         found = 1;
 829                         break;
 830                     }
 831                 }
 832                 if (!found) {
 833                     fontdirs[numdirs++] = (char*)dir;
 834                 } else {
 835                     free((char*)dir);
 836                 }
 837             }
 838         }
 839         /* Free fontset if one was returned */
 840         (*FcFontSetDestroy)(fontSet);
 841     }
 842 

 843     /* Free memory and close the &quot;.so&quot; */
 844     (*FcPatternDestroy)(pattern);
 845     closeFontConfig(libfontconfig, JNI_TRUE);
 846     return fontdirs;
 847 }
 848 
 849 /* These are copied from sun.awt.SunHints.
 850  * Consider initialising them as ints using JNI for more robustness.
 851  */
 852 #define TEXT_AA_OFF 1
 853 #define TEXT_AA_ON  2
 854 #define TEXT_AA_LCD_HRGB 4
 855 #define TEXT_AA_LCD_HBGR 5
 856 #define TEXT_AA_LCD_VRGB 6
 857 #define TEXT_AA_LCD_VBGR 7
 858 
 859 JNIEXPORT jint JNICALL
 860 Java_sun_font_FontConfigManager_getFontConfigAASettings
 861 (JNIEnv *env, jclass obj, jstring localeStr, jstring fcNameStr) {
 862 
</pre>
<hr />
<pre>
 870     FcPatternDestroyFuncType FcPatternDestroy;
 871 
 872     FcPattern *pattern, *matchPattern;
 873     FcResult result;
 874     FcBool antialias = FcFalse;
 875     int rgba = 0;
 876     const char *locale=NULL, *fcName=NULL;
 877     void* libfontconfig;
 878 
 879     if (fcNameStr == NULL || localeStr == NULL) {
 880         return -1;
 881     }
 882 
 883     fcName = (*env)-&gt;GetStringUTFChars(env, fcNameStr, 0);
 884     if (fcName == NULL) {
 885         return -1;
 886     }
 887     locale = (*env)-&gt;GetStringUTFChars(env, localeStr, 0);
 888 
 889     if ((libfontconfig = openFontConfig()) == NULL) {
<span class="line-modified"> 890         (*env)-&gt;ReleaseStringUTFChars (env, fcNameStr, (const char*)fcName);</span>
 891         if (locale) {
<span class="line-modified"> 892             (*env)-&gt;ReleaseStringUTFChars (env, localeStr,(const char*)locale);</span>
 893         }
 894         return -1;
 895     }
 896 
 897     FcNameParse = (FcNameParseFuncType)dlsym(libfontconfig, &quot;FcNameParse&quot;);
 898     FcPatternAddString =
 899         (FcPatternAddStringFuncType)dlsym(libfontconfig, &quot;FcPatternAddString&quot;);
 900     FcConfigSubstitute =
 901         (FcConfigSubstituteFuncType)dlsym(libfontconfig, &quot;FcConfigSubstitute&quot;);
 902     FcDefaultSubstitute = (FcDefaultSubstituteFuncType)
 903         dlsym(libfontconfig, &quot;FcDefaultSubstitute&quot;);
 904     FcFontMatch = (FcFontMatchFuncType)dlsym(libfontconfig, &quot;FcFontMatch&quot;);
 905     FcPatternGetBool = (FcPatternGetBoolFuncType)
 906         dlsym(libfontconfig, &quot;FcPatternGetBool&quot;);
 907     FcPatternGetInteger = (FcPatternGetIntegerFuncType)
 908         dlsym(libfontconfig, &quot;FcPatternGetInteger&quot;);
 909     FcPatternDestroy =
 910         (FcPatternDestroyFuncType)dlsym(libfontconfig, &quot;FcPatternDestroy&quot;);
 911 
 912     if (FcNameParse          == NULL ||
 913         FcPatternAddString   == NULL ||
 914         FcConfigSubstitute   == NULL ||
 915         FcDefaultSubstitute  == NULL ||
 916         FcFontMatch          == NULL ||
 917         FcPatternGetBool     == NULL ||
 918         FcPatternGetInteger  == NULL ||
 919         FcPatternDestroy     == NULL) { /* problem with the library: return. */
 920 
<span class="line-modified"> 921         (*env)-&gt;ReleaseStringUTFChars (env, fcNameStr, (const char*)fcName);</span>
 922         if (locale) {
<span class="line-modified"> 923             (*env)-&gt;ReleaseStringUTFChars (env, localeStr,(const char*)locale);</span>
 924         }
 925         closeFontConfig(libfontconfig, JNI_FALSE);
 926         return -1;
 927     }
 928 
 929 
 930     pattern = (*FcNameParse)((FcChar8 *)fcName);
 931     if (locale != NULL) {
 932         (*FcPatternAddString)(pattern, FC_LANG, (unsigned char*)locale);
 933     }
 934     (*FcConfigSubstitute)(NULL, pattern, FcMatchPattern);
 935     (*FcDefaultSubstitute)(pattern);
 936     matchPattern = (*FcFontMatch)(NULL, pattern, &amp;result);
 937     /* Perhaps should call FcFontRenderPrepare() here as some pattern
 938      * elements might change as a result of that call, but I&#39;m not seeing
 939      * any difference in testing.
 940      */
 941     if (matchPattern) {
 942         (*FcPatternGetBool)(matchPattern, FC_ANTIALIAS, 0, &amp;antialias);
 943         (*FcPatternGetInteger)(matchPattern, FC_RGBA, 0, &amp;rgba);
 944         (*FcPatternDestroy)(matchPattern);
 945     }
 946     (*FcPatternDestroy)(pattern);
 947 
<span class="line-modified"> 948     (*env)-&gt;ReleaseStringUTFChars (env, fcNameStr, (const char*)fcName);</span>
 949     if (locale) {
<span class="line-modified"> 950         (*env)-&gt;ReleaseStringUTFChars (env, localeStr, (const char*)locale);</span>
 951     }
 952     closeFontConfig(libfontconfig, JNI_TRUE);
 953 
 954     if (antialias == FcFalse) {
 955         return TEXT_AA_OFF;
 956     } else if (rgba &lt;= FC_RGBA_UNKNOWN || rgba &gt;= FC_RGBA_NONE) {
 957         return TEXT_AA_ON;
 958     } else {
 959         switch (rgba) {
 960         case FC_RGBA_RGB : return TEXT_AA_LCD_HRGB;
 961         case FC_RGBA_BGR : return TEXT_AA_LCD_HBGR;
 962         case FC_RGBA_VRGB : return TEXT_AA_LCD_VRGB;
 963         case FC_RGBA_VBGR : return TEXT_AA_LCD_VBGR;
 964         default : return TEXT_AA_LCD_HRGB; // should not get here.
 965         }
 966     }
 967 }
 968 
 969 JNIEXPORT jint JNICALL
 970 Java_sun_font_FontConfigManager_getFontConfigVersion
</pre>
<hr />
<pre>
1162         int fn, j, fontCount, nfonts;
1163         unsigned int minGlyphs;
1164         FcChar8 **family, **styleStr, **fullname, **file;
1165         jarray fcFontArr = NULL;
1166         FcCharSet *unionCharset = NULL;
1167 
1168         fcCompFontObj = (*env)-&gt;GetObjectArrayElement(env, fcCompFontArray, i);
1169         fcNameStr =
1170             (jstring)((*env)-&gt;GetObjectField(env, fcCompFontObj, fcNameID));
1171         fcName = (*env)-&gt;GetStringUTFChars(env, fcNameStr, 0);
1172         if (fcName == NULL) {
1173             (*env)-&gt;DeleteLocalRef(env, fcCompFontObj);
1174             (*env)-&gt;DeleteLocalRef(env, fcNameStr);
1175             continue;
1176         }
1177         pattern = (*FcNameParse)((FcChar8 *)fcName);
1178         (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);
1179         (*env)-&gt;DeleteLocalRef(env, fcNameStr);
1180         if (pattern == NULL) {
1181             closeFontConfig(libfontconfig, JNI_FALSE);



1182             return;
1183         }
1184 
1185         /* locale may not usually be necessary as fontconfig appears to apply
1186          * this anyway based on the user&#39;s environment. However we want
1187          * to use the value of the JDK startup locale so this should take
1188          * care of it.
1189          */
1190         if (locale != NULL) {
1191             (*FcPatternAddString)(pattern, FC_LANG, (unsigned char*)locale);
1192         }
1193         (*FcConfigSubstitute)(NULL, pattern, FcMatchPattern);
1194         (*FcDefaultSubstitute)(pattern);
1195         fontset = (*FcFontSort)(NULL, pattern, FcTrue, NULL, &amp;result);
1196         if (fontset == NULL) {
1197             (*FcPatternDestroy)(pattern);
1198             closeFontConfig(libfontconfig, JNI_FALSE);



1199             return;
1200         }
1201 
1202         /* fontconfig returned us &quot;nfonts&quot;. If we are just getting the
1203          * first font, we set nfont to zero. Otherwise we use &quot;nfonts&quot;.
1204          * Next create separate C arrrays of length nfonts for family file etc.
1205          * Inspect the returned fonts and the ones we like (adds enough glyphs)
1206          * are added to the arrays and we increment &#39;fontCount&#39;.
1207          */
1208         nfonts = fontset-&gt;nfont;
1209         family   = (FcChar8**)calloc(nfonts, sizeof(FcChar8*));
1210         styleStr = (FcChar8**)calloc(nfonts, sizeof(FcChar8*));
1211         fullname = (FcChar8**)calloc(nfonts, sizeof(FcChar8*));
1212         file     = (FcChar8**)calloc(nfonts, sizeof(FcChar8*));
1213         if (family == NULL || styleStr == NULL ||
1214             fullname == NULL || file == NULL) {
1215             if (family != NULL) {
1216                 free(family);
1217             }
1218             if (styleStr != NULL) {
1219                 free(styleStr);
1220             }
1221             if (fullname != NULL) {
1222                 free(fullname);
1223             }
1224             if (file != NULL) {
1225                 free(file);
1226             }
1227             (*FcPatternDestroy)(pattern);
1228             (*FcFontSetDestroy)(fontset);
1229             closeFontConfig(libfontconfig, JNI_FALSE);



1230             return;
1231         }
1232         fontCount = 0;
1233         minGlyphs = 20;
1234         if (debugMinGlyphsStr != NULL) {
1235             int val = minGlyphs;
1236             sscanf(debugMinGlyphsStr, &quot;%5d&quot;, &amp;val);
1237             if (val &gt;= 0 &amp;&amp; val &lt;= 65536) {
1238                 minGlyphs = val;
1239             }
1240         }
1241 
1242         for (j=0; j&lt;nfonts; j++) {
1243             FcPattern *fontPattern = fontset-&gt;fonts[j];
1244             FcChar8 *fontformat;
1245             FcCharSet *charset = NULL;
1246 
1247             fontformat = NULL;
1248             (*FcPatternGetString)(fontPattern, FC_FONTFORMAT, 0, &amp;fontformat);
1249             /* We only want TrueType fonts but some Linuxes still depend
</pre>
<hr />
<pre>
1252              */
1253             if (fontformat != NULL
1254                 &amp;&amp; (strcmp((char*)fontformat, &quot;TrueType&quot;) != 0)
1255 #if defined(__linux__) || defined(_AIX)
1256                 &amp;&amp; (strcmp((char*)fontformat, &quot;Type 1&quot;) != 0)
1257                 &amp;&amp; (strcmp((char*)fontformat, &quot;CFF&quot;) != 0)
1258 #endif
1259              ) {
1260                 continue;
1261             }
1262             result = (*FcPatternGetCharSet)(fontPattern,
1263                                             FC_CHARSET, 0, &amp;charset);
1264             if (result != FcResultMatch) {
1265                 free(family);
1266                 free(fullname);
1267                 free(styleStr);
1268                 free(file);
1269                 (*FcPatternDestroy)(pattern);
1270                 (*FcFontSetDestroy)(fontset);
1271                 closeFontConfig(libfontconfig, JNI_FALSE);



1272                 return;
1273             }
1274 
1275             /* We don&#39;t want 20 or 30 fonts, so once we hit 10 fonts,
1276              * then require that they really be adding value. Too many
1277              * adversely affects load time for minimal value-add.
1278              * This is still likely far more than we&#39;ve had in the past.
1279              */
1280             if (j==10) {
1281                 minGlyphs = 50;
1282             }
1283             if (unionCharset == NULL) {
1284                 unionCharset = charset;
1285             } else {
1286                 if ((*FcCharSetSubtractCount)(charset, unionCharset)
1287                     &gt; minGlyphs) {
1288                     unionCharset = (* FcCharSetUnion)(unionCharset, charset);
1289                 } else {
1290                     continue;
1291                 }
</pre>
<hr />
<pre>
1306 
1307         /* Once we get here &#39;fontCount&#39; is the number of returned fonts
1308          * we actually want to use, so we create &#39;fcFontArr&#39; of that length.
1309          * The non-null entries of &quot;family[]&quot; etc are those fonts.
1310          * Then loop again over all nfonts adding just those non-null ones
1311          * to &#39;fcFontArr&#39;. If its null (we didn&#39;t want the font)
1312          * then we don&#39;t enter the main body.
1313          * So we should never get more than &#39;fontCount&#39; entries.
1314          */
1315         if (includeFallbacks) {
1316             fcFontArr =
1317                 (*env)-&gt;NewObjectArray(env, fontCount, fcFontClass, NULL);
1318             if (IS_NULL(fcFontArr)) {
1319                 free(family);
1320                 free(fullname);
1321                 free(styleStr);
1322                 free(file);
1323                 (*FcPatternDestroy)(pattern);
1324                 (*FcFontSetDestroy)(fontset);
1325                 closeFontConfig(libfontconfig, JNI_FALSE);



1326                 return;
1327             }
1328             (*env)-&gt;SetObjectField(env,fcCompFontObj, fcAllFontsID, fcFontArr);
1329         }
1330         fn=0;
1331 
1332         for (j=0;j&lt;nfonts;j++) {
1333             if (family[j] != NULL) {
1334                 jobject fcFont =
1335                     (*env)-&gt;NewObject(env, fcFontClass, fcFontCons);
1336                 if (IS_NULL(fcFont)) break;
1337                 jstr = (*env)-&gt;NewStringUTF(env, (const char*)family[j]);
1338                 if (IS_NULL(jstr)) break;
1339                 (*env)-&gt;SetObjectField(env, fcFont, familyNameID, jstr);
1340                 (*env)-&gt;DeleteLocalRef(env, jstr);
1341                 if (file[j] != NULL) {
1342                     jstr = (*env)-&gt;NewStringUTF(env, (const char*)file[j]);
1343                     if (IS_NULL(jstr)) break;
1344                     (*env)-&gt;SetObjectField(env, fcFont, fontFileID, jstr);
1345                     (*env)-&gt;DeleteLocalRef(env, jstr);
</pre>
<hr />
<pre>
1367                     break;
1368                 }
1369                 (*env)-&gt;DeleteLocalRef(env, fcFont);
1370             }
1371         }
1372         if (includeFallbacks) {
1373             (*env)-&gt;DeleteLocalRef(env, fcFontArr);
1374         }
1375         (*env)-&gt;DeleteLocalRef(env, fcCompFontObj);
1376         (*FcFontSetDestroy)(fontset);
1377         (*FcPatternDestroy)(pattern);
1378         free(family);
1379         free(styleStr);
1380         free(fullname);
1381         free(file);
1382     }
1383 
1384     /* release resources and close the &quot;.so&quot; */
1385 
1386     if (locale) {
<span class="line-modified">1387         (*env)-&gt;ReleaseStringUTFChars (env, localeStr, (const char*)locale);</span>
1388     }
1389     closeFontConfig(libfontconfig, JNI_TRUE);
1390 }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 324 #ifndef HEADLESS
 325 static char **getX11FontPath ()
 326 {
 327     char **x11Path, **fontdirs;
 328     int i, pos, slen, nPaths, numDirs;
 329 
 330     x11Path = XGetFontPath (awt_display, &amp;nPaths);
 331 
 332     /* This isn&#39;t ever going to be perfect: the font path may contain
 333      * much we aren&#39;t interested in, but the cost should be moderate
 334      * Exclude all directories that contain the strings &quot;Speedo&quot;,&quot;/F3/&quot;,
 335      * &quot;75dpi&quot;, &quot;100dpi&quot;, &quot;misc&quot; or &quot;bitmap&quot;, or don&#39;t begin with a &quot;/&quot;,
 336      * the last of which should exclude font servers.
 337      * Also exclude the user specific &quot;.gnome*&quot; directories which
 338      * aren&#39;t going to contain the system fonts we need.
 339      * Hopefully we are left only with Type1 and TrueType directories.
 340      * It doesn&#39;t matter much if there are extraneous directories, it&#39;ll just
 341      * cost us a little wasted effort upstream.
 342      */
 343     fontdirs = (char**)calloc(nPaths+1, sizeof(char*));
<span class="line-added"> 344     if (fontdirs == NULL) {</span>
<span class="line-added"> 345         return NULL;</span>
<span class="line-added"> 346     }</span>
 347     pos = 0;
 348     for (i=0; i &lt; nPaths; i++) {
 349         if (x11Path[i][0] != &#39;/&#39;) {
 350             continue;
 351         }
 352         if (strstr(x11Path[i], &quot;/75dpi&quot;) != NULL) {
 353             continue;
 354         }
 355         if (strstr(x11Path[i], &quot;/100dpi&quot;) != NULL) {
 356             continue;
 357         }
 358         if (strstr(x11Path[i], &quot;/misc&quot;) != NULL) {
 359             continue;
 360         }
 361         if (strstr(x11Path[i], &quot;/Speedo&quot;) != NULL) {
 362             continue;
 363         }
 364         if (strstr(x11Path[i], &quot;.gnome&quot;) != NULL) {
 365             continue;
 366         }
</pre>
<hr />
<pre>
 406     int len1=0, len2=0, len3=0, totalLen=0, numDirs=0,
 407         currLen, i, j, found, pathLen=0;
 408     char **ptr, **fontdirs;
 409     char *fontPath = NULL;
 410 
 411     if (p1 != NULL) {
 412         ptr = p1;
 413         while (*ptr++ != NULL) len1++;
 414     }
 415     if (p2 != NULL) {
 416         ptr = p2;
 417 
 418         while (*ptr++ != NULL) len2++;
 419     }
 420     if (p3 != NULL) {
 421         ptr = p3;
 422         while (*ptr++ != NULL) len3++;
 423     }
 424     totalLen = len1+len2+len3;
 425     fontdirs = (char**)calloc(totalLen, sizeof(char*));
<span class="line-added"> 426     if (fontdirs == NULL) {</span>
<span class="line-added"> 427         return NULL;</span>
<span class="line-added"> 428     }</span>
 429 
 430     for (i=0; i &lt; len1; i++) {
 431         if (noType1 &amp;&amp; strstr(p1[i], &quot;Type1&quot;) != NULL) {
 432             continue;
 433         }
 434         fontdirs[numDirs++] = p1[i];
 435     }
 436 
 437     currLen = numDirs; /* only compare against previous path dirs */
 438     for (i=0; i &lt; len2; i++) {
 439         if (noType1 &amp;&amp; strstr(p2[i], &quot;Type1&quot;) != NULL) {
 440             continue;
 441         }
 442         found = 0;
 443         for (j=0; j &lt; currLen; j++) {
 444             if (strcmp(fontdirs[j], p2[i]) == 0) {
 445                 found = 1;
 446                 break;
 447             }
 448         }
</pre>
<hr />
<pre>
 805      * outline fonts, and to get the set of full file paths from the matches.
 806      * This set is returned from the call to FcFontList(..)
 807      * We allocate an array of char* pointers sufficient to hold all
 808      * the matches + 1 extra which ensures there will be a NULL after all
 809      * valid entries.
 810      * We call FcStrDirname strip the file name from the path, and
 811      * check if we have yet seen this directory. If not we add a pointer to
 812      * it into our array of char*. Note that FcStrDirname returns newly
 813      * allocated storage so we can use this in the return char** value.
 814      * Finally we clean up, freeing allocated resources, and return the
 815      * array of unique directories.
 816      */
 817     pattern = (*FcPatternBuild)(NULL, FC_OUTLINE, FcTypeBool, FcTrue, NULL);
 818     objset = (*FcObjectSetBuild)(FC_FILE, NULL);
 819     fontSet = (*FcFontList)(NULL, pattern, objset);
 820     if (fontSet == NULL) {
 821         /* FcFontList() may return NULL if fonts are not installed. */
 822         fontdirs = NULL;
 823     } else {
 824         fontdirs = (char**)calloc(fontSet-&gt;nfont+1, sizeof(char*));
<span class="line-added"> 825         if (fontdirs == NULL) {</span>
<span class="line-added"> 826             (*FcFontSetDestroy)(fontSet);</span>
<span class="line-added"> 827             goto cleanup;</span>
<span class="line-added"> 828         }</span>
 829         for (f=0; f &lt; fontSet-&gt;nfont; f++) {
 830             FcChar8 *file;
 831             FcChar8 *dir;
 832             if ((*FcPatternGetString)(fontSet-&gt;fonts[f], FC_FILE, 0, &amp;file) ==
 833                                       FcResultMatch) {
 834                 dir = (*FcStrDirname)(file);
 835                 found = 0;
 836                 for (i=0;i&lt;numdirs; i++) {
 837                     if (strcmp(fontdirs[i], (char*)dir) == 0) {
 838                         found = 1;
 839                         break;
 840                     }
 841                 }
 842                 if (!found) {
 843                     fontdirs[numdirs++] = (char*)dir;
 844                 } else {
 845                     free((char*)dir);
 846                 }
 847             }
 848         }
 849         /* Free fontset if one was returned */
 850         (*FcFontSetDestroy)(fontSet);
 851     }
 852 
<span class="line-added"> 853 cleanup:</span>
 854     /* Free memory and close the &quot;.so&quot; */
 855     (*FcPatternDestroy)(pattern);
 856     closeFontConfig(libfontconfig, JNI_TRUE);
 857     return fontdirs;
 858 }
 859 
 860 /* These are copied from sun.awt.SunHints.
 861  * Consider initialising them as ints using JNI for more robustness.
 862  */
 863 #define TEXT_AA_OFF 1
 864 #define TEXT_AA_ON  2
 865 #define TEXT_AA_LCD_HRGB 4
 866 #define TEXT_AA_LCD_HBGR 5
 867 #define TEXT_AA_LCD_VRGB 6
 868 #define TEXT_AA_LCD_VBGR 7
 869 
 870 JNIEXPORT jint JNICALL
 871 Java_sun_font_FontConfigManager_getFontConfigAASettings
 872 (JNIEnv *env, jclass obj, jstring localeStr, jstring fcNameStr) {
 873 
</pre>
<hr />
<pre>
 881     FcPatternDestroyFuncType FcPatternDestroy;
 882 
 883     FcPattern *pattern, *matchPattern;
 884     FcResult result;
 885     FcBool antialias = FcFalse;
 886     int rgba = 0;
 887     const char *locale=NULL, *fcName=NULL;
 888     void* libfontconfig;
 889 
 890     if (fcNameStr == NULL || localeStr == NULL) {
 891         return -1;
 892     }
 893 
 894     fcName = (*env)-&gt;GetStringUTFChars(env, fcNameStr, 0);
 895     if (fcName == NULL) {
 896         return -1;
 897     }
 898     locale = (*env)-&gt;GetStringUTFChars(env, localeStr, 0);
 899 
 900     if ((libfontconfig = openFontConfig()) == NULL) {
<span class="line-modified"> 901         (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);</span>
 902         if (locale) {
<span class="line-modified"> 903             (*env)-&gt;ReleaseStringUTFChars(env, localeStr,(const char*)locale);</span>
 904         }
 905         return -1;
 906     }
 907 
 908     FcNameParse = (FcNameParseFuncType)dlsym(libfontconfig, &quot;FcNameParse&quot;);
 909     FcPatternAddString =
 910         (FcPatternAddStringFuncType)dlsym(libfontconfig, &quot;FcPatternAddString&quot;);
 911     FcConfigSubstitute =
 912         (FcConfigSubstituteFuncType)dlsym(libfontconfig, &quot;FcConfigSubstitute&quot;);
 913     FcDefaultSubstitute = (FcDefaultSubstituteFuncType)
 914         dlsym(libfontconfig, &quot;FcDefaultSubstitute&quot;);
 915     FcFontMatch = (FcFontMatchFuncType)dlsym(libfontconfig, &quot;FcFontMatch&quot;);
 916     FcPatternGetBool = (FcPatternGetBoolFuncType)
 917         dlsym(libfontconfig, &quot;FcPatternGetBool&quot;);
 918     FcPatternGetInteger = (FcPatternGetIntegerFuncType)
 919         dlsym(libfontconfig, &quot;FcPatternGetInteger&quot;);
 920     FcPatternDestroy =
 921         (FcPatternDestroyFuncType)dlsym(libfontconfig, &quot;FcPatternDestroy&quot;);
 922 
 923     if (FcNameParse          == NULL ||
 924         FcPatternAddString   == NULL ||
 925         FcConfigSubstitute   == NULL ||
 926         FcDefaultSubstitute  == NULL ||
 927         FcFontMatch          == NULL ||
 928         FcPatternGetBool     == NULL ||
 929         FcPatternGetInteger  == NULL ||
 930         FcPatternDestroy     == NULL) { /* problem with the library: return. */
 931 
<span class="line-modified"> 932         (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);</span>
 933         if (locale) {
<span class="line-modified"> 934             (*env)-&gt;ReleaseStringUTFChars(env, localeStr,(const char*)locale);</span>
 935         }
 936         closeFontConfig(libfontconfig, JNI_FALSE);
 937         return -1;
 938     }
 939 
 940 
 941     pattern = (*FcNameParse)((FcChar8 *)fcName);
 942     if (locale != NULL) {
 943         (*FcPatternAddString)(pattern, FC_LANG, (unsigned char*)locale);
 944     }
 945     (*FcConfigSubstitute)(NULL, pattern, FcMatchPattern);
 946     (*FcDefaultSubstitute)(pattern);
 947     matchPattern = (*FcFontMatch)(NULL, pattern, &amp;result);
 948     /* Perhaps should call FcFontRenderPrepare() here as some pattern
 949      * elements might change as a result of that call, but I&#39;m not seeing
 950      * any difference in testing.
 951      */
 952     if (matchPattern) {
 953         (*FcPatternGetBool)(matchPattern, FC_ANTIALIAS, 0, &amp;antialias);
 954         (*FcPatternGetInteger)(matchPattern, FC_RGBA, 0, &amp;rgba);
 955         (*FcPatternDestroy)(matchPattern);
 956     }
 957     (*FcPatternDestroy)(pattern);
 958 
<span class="line-modified"> 959     (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);</span>
 960     if (locale) {
<span class="line-modified"> 961         (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
 962     }
 963     closeFontConfig(libfontconfig, JNI_TRUE);
 964 
 965     if (antialias == FcFalse) {
 966         return TEXT_AA_OFF;
 967     } else if (rgba &lt;= FC_RGBA_UNKNOWN || rgba &gt;= FC_RGBA_NONE) {
 968         return TEXT_AA_ON;
 969     } else {
 970         switch (rgba) {
 971         case FC_RGBA_RGB : return TEXT_AA_LCD_HRGB;
 972         case FC_RGBA_BGR : return TEXT_AA_LCD_HBGR;
 973         case FC_RGBA_VRGB : return TEXT_AA_LCD_VRGB;
 974         case FC_RGBA_VBGR : return TEXT_AA_LCD_VBGR;
 975         default : return TEXT_AA_LCD_HRGB; // should not get here.
 976         }
 977     }
 978 }
 979 
 980 JNIEXPORT jint JNICALL
 981 Java_sun_font_FontConfigManager_getFontConfigVersion
</pre>
<hr />
<pre>
1173         int fn, j, fontCount, nfonts;
1174         unsigned int minGlyphs;
1175         FcChar8 **family, **styleStr, **fullname, **file;
1176         jarray fcFontArr = NULL;
1177         FcCharSet *unionCharset = NULL;
1178 
1179         fcCompFontObj = (*env)-&gt;GetObjectArrayElement(env, fcCompFontArray, i);
1180         fcNameStr =
1181             (jstring)((*env)-&gt;GetObjectField(env, fcCompFontObj, fcNameID));
1182         fcName = (*env)-&gt;GetStringUTFChars(env, fcNameStr, 0);
1183         if (fcName == NULL) {
1184             (*env)-&gt;DeleteLocalRef(env, fcCompFontObj);
1185             (*env)-&gt;DeleteLocalRef(env, fcNameStr);
1186             continue;
1187         }
1188         pattern = (*FcNameParse)((FcChar8 *)fcName);
1189         (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);
1190         (*env)-&gt;DeleteLocalRef(env, fcNameStr);
1191         if (pattern == NULL) {
1192             closeFontConfig(libfontconfig, JNI_FALSE);
<span class="line-added">1193             if (locale) {</span>
<span class="line-added">1194                 (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="line-added">1195             }</span>
1196             return;
1197         }
1198 
1199         /* locale may not usually be necessary as fontconfig appears to apply
1200          * this anyway based on the user&#39;s environment. However we want
1201          * to use the value of the JDK startup locale so this should take
1202          * care of it.
1203          */
1204         if (locale != NULL) {
1205             (*FcPatternAddString)(pattern, FC_LANG, (unsigned char*)locale);
1206         }
1207         (*FcConfigSubstitute)(NULL, pattern, FcMatchPattern);
1208         (*FcDefaultSubstitute)(pattern);
1209         fontset = (*FcFontSort)(NULL, pattern, FcTrue, NULL, &amp;result);
1210         if (fontset == NULL) {
1211             (*FcPatternDestroy)(pattern);
1212             closeFontConfig(libfontconfig, JNI_FALSE);
<span class="line-added">1213             if (locale) {</span>
<span class="line-added">1214                 (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="line-added">1215             }</span>
1216             return;
1217         }
1218 
1219         /* fontconfig returned us &quot;nfonts&quot;. If we are just getting the
1220          * first font, we set nfont to zero. Otherwise we use &quot;nfonts&quot;.
1221          * Next create separate C arrrays of length nfonts for family file etc.
1222          * Inspect the returned fonts and the ones we like (adds enough glyphs)
1223          * are added to the arrays and we increment &#39;fontCount&#39;.
1224          */
1225         nfonts = fontset-&gt;nfont;
1226         family   = (FcChar8**)calloc(nfonts, sizeof(FcChar8*));
1227         styleStr = (FcChar8**)calloc(nfonts, sizeof(FcChar8*));
1228         fullname = (FcChar8**)calloc(nfonts, sizeof(FcChar8*));
1229         file     = (FcChar8**)calloc(nfonts, sizeof(FcChar8*));
1230         if (family == NULL || styleStr == NULL ||
1231             fullname == NULL || file == NULL) {
1232             if (family != NULL) {
1233                 free(family);
1234             }
1235             if (styleStr != NULL) {
1236                 free(styleStr);
1237             }
1238             if (fullname != NULL) {
1239                 free(fullname);
1240             }
1241             if (file != NULL) {
1242                 free(file);
1243             }
1244             (*FcPatternDestroy)(pattern);
1245             (*FcFontSetDestroy)(fontset);
1246             closeFontConfig(libfontconfig, JNI_FALSE);
<span class="line-added">1247             if (locale) {</span>
<span class="line-added">1248                 (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="line-added">1249             }</span>
1250             return;
1251         }
1252         fontCount = 0;
1253         minGlyphs = 20;
1254         if (debugMinGlyphsStr != NULL) {
1255             int val = minGlyphs;
1256             sscanf(debugMinGlyphsStr, &quot;%5d&quot;, &amp;val);
1257             if (val &gt;= 0 &amp;&amp; val &lt;= 65536) {
1258                 minGlyphs = val;
1259             }
1260         }
1261 
1262         for (j=0; j&lt;nfonts; j++) {
1263             FcPattern *fontPattern = fontset-&gt;fonts[j];
1264             FcChar8 *fontformat;
1265             FcCharSet *charset = NULL;
1266 
1267             fontformat = NULL;
1268             (*FcPatternGetString)(fontPattern, FC_FONTFORMAT, 0, &amp;fontformat);
1269             /* We only want TrueType fonts but some Linuxes still depend
</pre>
<hr />
<pre>
1272              */
1273             if (fontformat != NULL
1274                 &amp;&amp; (strcmp((char*)fontformat, &quot;TrueType&quot;) != 0)
1275 #if defined(__linux__) || defined(_AIX)
1276                 &amp;&amp; (strcmp((char*)fontformat, &quot;Type 1&quot;) != 0)
1277                 &amp;&amp; (strcmp((char*)fontformat, &quot;CFF&quot;) != 0)
1278 #endif
1279              ) {
1280                 continue;
1281             }
1282             result = (*FcPatternGetCharSet)(fontPattern,
1283                                             FC_CHARSET, 0, &amp;charset);
1284             if (result != FcResultMatch) {
1285                 free(family);
1286                 free(fullname);
1287                 free(styleStr);
1288                 free(file);
1289                 (*FcPatternDestroy)(pattern);
1290                 (*FcFontSetDestroy)(fontset);
1291                 closeFontConfig(libfontconfig, JNI_FALSE);
<span class="line-added">1292                 if (locale) {</span>
<span class="line-added">1293                     (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="line-added">1294                 }</span>
1295                 return;
1296             }
1297 
1298             /* We don&#39;t want 20 or 30 fonts, so once we hit 10 fonts,
1299              * then require that they really be adding value. Too many
1300              * adversely affects load time for minimal value-add.
1301              * This is still likely far more than we&#39;ve had in the past.
1302              */
1303             if (j==10) {
1304                 minGlyphs = 50;
1305             }
1306             if (unionCharset == NULL) {
1307                 unionCharset = charset;
1308             } else {
1309                 if ((*FcCharSetSubtractCount)(charset, unionCharset)
1310                     &gt; minGlyphs) {
1311                     unionCharset = (* FcCharSetUnion)(unionCharset, charset);
1312                 } else {
1313                     continue;
1314                 }
</pre>
<hr />
<pre>
1329 
1330         /* Once we get here &#39;fontCount&#39; is the number of returned fonts
1331          * we actually want to use, so we create &#39;fcFontArr&#39; of that length.
1332          * The non-null entries of &quot;family[]&quot; etc are those fonts.
1333          * Then loop again over all nfonts adding just those non-null ones
1334          * to &#39;fcFontArr&#39;. If its null (we didn&#39;t want the font)
1335          * then we don&#39;t enter the main body.
1336          * So we should never get more than &#39;fontCount&#39; entries.
1337          */
1338         if (includeFallbacks) {
1339             fcFontArr =
1340                 (*env)-&gt;NewObjectArray(env, fontCount, fcFontClass, NULL);
1341             if (IS_NULL(fcFontArr)) {
1342                 free(family);
1343                 free(fullname);
1344                 free(styleStr);
1345                 free(file);
1346                 (*FcPatternDestroy)(pattern);
1347                 (*FcFontSetDestroy)(fontset);
1348                 closeFontConfig(libfontconfig, JNI_FALSE);
<span class="line-added">1349                 if (locale) {</span>
<span class="line-added">1350                     (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="line-added">1351                 }</span>
1352                 return;
1353             }
1354             (*env)-&gt;SetObjectField(env,fcCompFontObj, fcAllFontsID, fcFontArr);
1355         }
1356         fn=0;
1357 
1358         for (j=0;j&lt;nfonts;j++) {
1359             if (family[j] != NULL) {
1360                 jobject fcFont =
1361                     (*env)-&gt;NewObject(env, fcFontClass, fcFontCons);
1362                 if (IS_NULL(fcFont)) break;
1363                 jstr = (*env)-&gt;NewStringUTF(env, (const char*)family[j]);
1364                 if (IS_NULL(jstr)) break;
1365                 (*env)-&gt;SetObjectField(env, fcFont, familyNameID, jstr);
1366                 (*env)-&gt;DeleteLocalRef(env, jstr);
1367                 if (file[j] != NULL) {
1368                     jstr = (*env)-&gt;NewStringUTF(env, (const char*)file[j]);
1369                     if (IS_NULL(jstr)) break;
1370                     (*env)-&gt;SetObjectField(env, fcFont, fontFileID, jstr);
1371                     (*env)-&gt;DeleteLocalRef(env, jstr);
</pre>
<hr />
<pre>
1393                     break;
1394                 }
1395                 (*env)-&gt;DeleteLocalRef(env, fcFont);
1396             }
1397         }
1398         if (includeFallbacks) {
1399             (*env)-&gt;DeleteLocalRef(env, fcFontArr);
1400         }
1401         (*env)-&gt;DeleteLocalRef(env, fcCompFontObj);
1402         (*FcFontSetDestroy)(fontset);
1403         (*FcPatternDestroy)(pattern);
1404         free(family);
1405         free(styleStr);
1406         free(fullname);
1407         free(file);
1408     }
1409 
1410     /* release resources and close the &quot;.so&quot; */
1411 
1412     if (locale) {
<span class="line-modified">1413         (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
1414     }
1415     closeFontConfig(libfontconfig, JNI_TRUE);
1416 }
</pre>
</td>
</tr>
</table>
<center><a href="awt_p.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/opengl/GLXSurfaceData.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>