<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/unix/native/common/awt/fontpath.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="awt_p.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/opengl/GLXSurfaceData.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/native/common/awt/fontpath.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1998, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -339,10 +339,13 @@</span>
       * Hopefully we are left only with Type1 and TrueType directories.
       * It doesn&#39;t matter much if there are extraneous directories, it&#39;ll just
       * cost us a little wasted effort upstream.
       */
      fontdirs = (char**)calloc(nPaths+1, sizeof(char*));
<span class="udiff-line-added">+     if (fontdirs == NULL) {</span>
<span class="udiff-line-added">+         return NULL;</span>
<span class="udiff-line-added">+     }</span>
      pos = 0;
      for (i=0; i &lt; nPaths; i++) {
          if (x11Path[i][0] != &#39;/&#39;) {
              continue;
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -418,10 +421,13 @@</span>
          ptr = p3;
          while (*ptr++ != NULL) len3++;
      }
      totalLen = len1+len2+len3;
      fontdirs = (char**)calloc(totalLen, sizeof(char*));
<span class="udiff-line-added">+     if (fontdirs == NULL) {</span>
<span class="udiff-line-added">+         return NULL;</span>
<span class="udiff-line-added">+     }</span>
  
      for (i=0; i &lt; len1; i++) {
          if (noType1 &amp;&amp; strstr(p1[i], &quot;Type1&quot;) != NULL) {
              continue;
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -814,10 +820,14 @@</span>
      if (fontSet == NULL) {
          /* FcFontList() may return NULL if fonts are not installed. */
          fontdirs = NULL;
      } else {
          fontdirs = (char**)calloc(fontSet-&gt;nfont+1, sizeof(char*));
<span class="udiff-line-added">+         if (fontdirs == NULL) {</span>
<span class="udiff-line-added">+             (*FcFontSetDestroy)(fontSet);</span>
<span class="udiff-line-added">+             goto cleanup;</span>
<span class="udiff-line-added">+         }</span>
          for (f=0; f &lt; fontSet-&gt;nfont; f++) {
              FcChar8 *file;
              FcChar8 *dir;
              if ((*FcPatternGetString)(fontSet-&gt;fonts[f], FC_FILE, 0, &amp;file) ==
                                        FcResultMatch) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -838,10 +848,11 @@</span>
          }
          /* Free fontset if one was returned */
          (*FcFontSetDestroy)(fontSet);
      }
  
<span class="udiff-line-added">+ cleanup:</span>
      /* Free memory and close the &quot;.so&quot; */
      (*FcPatternDestroy)(pattern);
      closeFontConfig(libfontconfig, JNI_TRUE);
      return fontdirs;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -885,13 +896,13 @@</span>
          return -1;
      }
      locale = (*env)-&gt;GetStringUTFChars(env, localeStr, 0);
  
      if ((libfontconfig = openFontConfig()) == NULL) {
<span class="udiff-line-modified-removed">-         (*env)-&gt;ReleaseStringUTFChars (env, fcNameStr, (const char*)fcName);</span>
<span class="udiff-line-modified-added">+         (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);</span>
          if (locale) {
<span class="udiff-line-modified-removed">-             (*env)-&gt;ReleaseStringUTFChars (env, localeStr,(const char*)locale);</span>
<span class="udiff-line-modified-added">+             (*env)-&gt;ReleaseStringUTFChars(env, localeStr,(const char*)locale);</span>
          }
          return -1;
      }
  
      FcNameParse = (FcNameParseFuncType)dlsym(libfontconfig, &quot;FcNameParse&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -916,13 +927,13 @@</span>
          FcFontMatch          == NULL ||
          FcPatternGetBool     == NULL ||
          FcPatternGetInteger  == NULL ||
          FcPatternDestroy     == NULL) { /* problem with the library: return. */
  
<span class="udiff-line-modified-removed">-         (*env)-&gt;ReleaseStringUTFChars (env, fcNameStr, (const char*)fcName);</span>
<span class="udiff-line-modified-added">+         (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);</span>
          if (locale) {
<span class="udiff-line-modified-removed">-             (*env)-&gt;ReleaseStringUTFChars (env, localeStr,(const char*)locale);</span>
<span class="udiff-line-modified-added">+             (*env)-&gt;ReleaseStringUTFChars(env, localeStr,(const char*)locale);</span>
          }
          closeFontConfig(libfontconfig, JNI_FALSE);
          return -1;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -943,13 +954,13 @@</span>
          (*FcPatternGetInteger)(matchPattern, FC_RGBA, 0, &amp;rgba);
          (*FcPatternDestroy)(matchPattern);
      }
      (*FcPatternDestroy)(pattern);
  
<span class="udiff-line-modified-removed">-     (*env)-&gt;ReleaseStringUTFChars (env, fcNameStr, (const char*)fcName);</span>
<span class="udiff-line-modified-added">+     (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);</span>
      if (locale) {
<span class="udiff-line-modified-removed">-         (*env)-&gt;ReleaseStringUTFChars (env, localeStr, (const char*)locale);</span>
<span class="udiff-line-modified-added">+         (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
      }
      closeFontConfig(libfontconfig, JNI_TRUE);
  
      if (antialias == FcFalse) {
          return TEXT_AA_OFF;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1177,10 +1188,13 @@</span>
          pattern = (*FcNameParse)((FcChar8 *)fcName);
          (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);
          (*env)-&gt;DeleteLocalRef(env, fcNameStr);
          if (pattern == NULL) {
              closeFontConfig(libfontconfig, JNI_FALSE);
<span class="udiff-line-added">+             if (locale) {</span>
<span class="udiff-line-added">+                 (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="udiff-line-added">+             }</span>
              return;
          }
  
          /* locale may not usually be necessary as fontconfig appears to apply
           * this anyway based on the user&#39;s environment. However we want
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1194,10 +1208,13 @@</span>
          (*FcDefaultSubstitute)(pattern);
          fontset = (*FcFontSort)(NULL, pattern, FcTrue, NULL, &amp;result);
          if (fontset == NULL) {
              (*FcPatternDestroy)(pattern);
              closeFontConfig(libfontconfig, JNI_FALSE);
<span class="udiff-line-added">+             if (locale) {</span>
<span class="udiff-line-added">+                 (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="udiff-line-added">+             }</span>
              return;
          }
  
          /* fontconfig returned us &quot;nfonts&quot;. If we are just getting the
           * first font, we set nfont to zero. Otherwise we use &quot;nfonts&quot;.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1225,10 +1242,13 @@</span>
                  free(file);
              }
              (*FcPatternDestroy)(pattern);
              (*FcFontSetDestroy)(fontset);
              closeFontConfig(libfontconfig, JNI_FALSE);
<span class="udiff-line-added">+             if (locale) {</span>
<span class="udiff-line-added">+                 (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="udiff-line-added">+             }</span>
              return;
          }
          fontCount = 0;
          minGlyphs = 20;
          if (debugMinGlyphsStr != NULL) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1267,10 +1287,13 @@</span>
                  free(styleStr);
                  free(file);
                  (*FcPatternDestroy)(pattern);
                  (*FcFontSetDestroy)(fontset);
                  closeFontConfig(libfontconfig, JNI_FALSE);
<span class="udiff-line-added">+                 if (locale) {</span>
<span class="udiff-line-added">+                     (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="udiff-line-added">+                 }</span>
                  return;
              }
  
              /* We don&#39;t want 20 or 30 fonts, so once we hit 10 fonts,
               * then require that they really be adding value. Too many
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1321,10 +1344,13 @@</span>
                  free(styleStr);
                  free(file);
                  (*FcPatternDestroy)(pattern);
                  (*FcFontSetDestroy)(fontset);
                  closeFontConfig(libfontconfig, JNI_FALSE);
<span class="udiff-line-added">+                 if (locale) {</span>
<span class="udiff-line-added">+                     (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
<span class="udiff-line-added">+                 }</span>
                  return;
              }
              (*env)-&gt;SetObjectField(env,fcCompFontObj, fcAllFontsID, fcFontArr);
          }
          fn=0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1382,9 +1408,9 @@</span>
      }
  
      /* release resources and close the &quot;.so&quot; */
  
      if (locale) {
<span class="udiff-line-modified-removed">-         (*env)-&gt;ReleaseStringUTFChars (env, localeStr, (const char*)locale);</span>
<span class="udiff-line-modified-added">+         (*env)-&gt;ReleaseStringUTFChars(env, localeStr, (const char*)locale);</span>
      }
      closeFontConfig(libfontconfig, JNI_TRUE);
  }
</pre>
<center><a href="awt_p.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/opengl/GLXSurfaceData.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>