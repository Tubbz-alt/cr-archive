<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/unix/classes/sun/font/FcFontConfiguration.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../awt/X11InputMethodBase.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="FontConfigManager.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/classes/sun/font/FcFontConfiguration.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2008, 2014, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2008, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,11 +23,10 @@</span>
   * questions.
   */
  
  package sun.font;
  
<span class="udiff-line-removed">- import java.awt.Font;</span>
  import java.io.File;
  import java.io.FileInputStream;
  import java.io.FileOutputStream;
  import java.io.IOException;
  import java.net.InetAddress;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -35,22 +34,21 @@</span>
  import java.nio.charset.Charset;
  import java.nio.charset.StandardCharsets;
  import java.nio.file.Files;
  import java.util.HashMap;
  import java.util.HashSet;
<span class="udiff-line-added">+ import java.util.Locale;</span>
  import java.util.Properties;
  import java.util.Scanner;
  import sun.awt.FcFontManager;
  import sun.awt.FontConfiguration;
  import sun.awt.FontDescriptor;
  import sun.awt.SunToolkit;
  import sun.font.CompositeFontDescriptor;
<span class="udiff-line-removed">- import sun.font.FontManager;</span>
  import sun.font.FontConfigManager.FontConfigInfo;
  import sun.font.FontConfigManager.FcCompFont;
  import sun.font.FontConfigManager.FontConfigFont;
<span class="udiff-line-removed">- import sun.java2d.SunGraphicsEnvironment;</span>
  import sun.util.logging.PlatformLogger;
  
  public class FcFontConfiguration extends FontConfiguration {
  
      /** Version of the cache file format understood by this code.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -262,11 +260,11 @@</span>
                  String[] faceNames = new String[numFonts];
  
                  int index;
                  for (index = 0; index &lt; fcFonts.length; index++) {
                      fileNames[index] = fcFonts[index].fontFile;
<span class="udiff-line-modified-removed">-                     faceNames[index] = fcFonts[index].familyName;</span>
<span class="udiff-line-modified-added">+                     faceNames[index] = fcFonts[index].fullName;</span>
                  }
  
                  if (installedFallbackFontFiles != null) {
                      System.arraycopy(installedFallbackFontFiles, 0,
                                       fileNames, fcFonts.length,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -286,16 +284,14 @@</span>
      }
  
      /**
       * Gets the OS version string from a Linux release-specific file.
       */
<span class="udiff-line-modified-removed">-     private String getVersionString(File f){</span>
<span class="udiff-line-modified-removed">-         try {</span>
<span class="udiff-line-removed">-             Scanner sc  = new Scanner(f);</span>
<span class="udiff-line-modified-added">+     private String getVersionString(File f) {</span>
<span class="udiff-line-modified-added">+         try (Scanner sc  = new Scanner(f)) {</span>
              return sc.findInLine(&quot;(\\d)+((\\.)(\\d)+)*&quot;);
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-removed">-         catch (Exception e){</span>
<span class="udiff-line-modified-added">+         } catch (Exception e) {</span>
          }
          return null;
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -355,13 +351,15 @@</span>
              }
              String userDir = System.getProperty(&quot;user.home&quot;);
              String version = System.getProperty(&quot;java.version&quot;);
              String fs = File.separator;
              String dir = userDir+fs+&quot;.java&quot;+fs+&quot;fonts&quot;+fs+version;
<span class="udiff-line-modified-removed">-             String lang = SunToolkit.getStartupLocale().getLanguage();</span>
<span class="udiff-line-modified-added">+             Locale locale = SunToolkit.getStartupLocale();</span>
<span class="udiff-line-added">+             String lang = locale.getLanguage();</span>
<span class="udiff-line-added">+             String country = locale.getCountry();</span>
              String name = &quot;fcinfo-&quot;+fileVersion+&quot;-&quot;+hostname+&quot;-&quot;+
<span class="udiff-line-modified-removed">-                 osName+&quot;-&quot;+osVersion+&quot;-&quot;+lang+&quot;.properties&quot;;</span>
<span class="udiff-line-modified-added">+                 osName+&quot;-&quot;+osVersion+&quot;-&quot;+lang+&quot;-&quot;+country+&quot;.properties&quot;;</span>
              fcInfoFileName = dir+fs+name;
          }
          return new File(fcInfoFileName);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -383,14 +381,16 @@</span>
              FcCompFont fci = fcCompFonts[i];
              String styleKey = fci.jdkName+&quot;.&quot;+fci.style;
              props.setProperty(styleKey+&quot;.length&quot;,
                                Integer.toString(fci.allFonts.length));
              for (int j=0; j&lt;fci.allFonts.length; j++) {
<span class="udiff-line-removed">-                 props.setProperty(styleKey+&quot;.&quot;+j+&quot;.family&quot;,</span>
<span class="udiff-line-removed">-                                   fci.allFonts[j].familyName);</span>
                  props.setProperty(styleKey+&quot;.&quot;+j+&quot;.file&quot;,
                                    fci.allFonts[j].fontFile);
<span class="udiff-line-added">+                 if (fci.allFonts[j].fullName != null) {</span>
<span class="udiff-line-added">+                     props.setProperty(styleKey+&quot;.&quot;+j+&quot;.fullName&quot;,</span>
<span class="udiff-line-added">+                                       fci.allFonts[j].fullName);</span>
<span class="udiff-line-added">+                 }</span>
              }
          }
          try {
              /* This writes into a temp file then renames when done.
               * Since the rename is an atomic action within the same
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -422,27 +422,30 @@</span>
       * the system cache.
       */
      private void readFcInfo() {
          File fcFile = getFcInfoFile();
          if (!fcFile.exists()) {
<span class="udiff-line-added">+             if (FontUtilities.debugFonts()) {</span>
<span class="udiff-line-added">+                 warning(&quot;fontconfig info file &quot; + fcFile.toString() + &quot; does not exist&quot;);</span>
<span class="udiff-line-added">+             }</span>
              return;
          }
          Properties props = new Properties();
<span class="udiff-line-modified-removed">-         FcFontManager fm = (FcFontManager) fontManager;</span>
<span class="udiff-line-removed">-         FontConfigManager fcm = fm.getFontConfigManager();</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             FileInputStream fis = new FileInputStream(fcFile);</span>
<span class="udiff-line-modified-added">+         try (FileInputStream fis = new FileInputStream(fcFile)) {</span>
              props.load(fis);
<span class="udiff-line-removed">-             fis.close();</span>
          } catch (IOException e) {
              if (FontUtilities.debugFonts()) {
<span class="udiff-line-modified-removed">-                 warning(&quot;IOException reading from &quot;+fcFile.toString());</span>
<span class="udiff-line-modified-added">+                 warning(&quot;IOException (&quot; + e.getCause() + &quot;) reading from &quot; + fcFile.toString());</span>
              }
              return;
          }
          String version = (String)props.get(&quot;version&quot;);
          if (version == null || !version.equals(fileVersion)) {
<span class="udiff-line-added">+             if (FontUtilities.debugFonts()) {</span>
<span class="udiff-line-added">+                 warning(&quot;fontconfig info file version mismatch (found: &quot; + version +</span>
<span class="udiff-line-added">+                     &quot;, expected: &quot; + fileVersion + &quot;)&quot;);</span>
<span class="udiff-line-added">+             }</span>
              return;
          }
  
          // If there&#39;s a new, different fontconfig installed on the
          // system, we invalidate our fontconfig file.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -451,10 +454,13 @@</span>
              int fcVersion;
              try {
                  fcVersion = Integer.parseInt(fcVersionStr);
                  if (fcVersion != 0 &amp;&amp;
                      fcVersion != FontConfigManager.getFontConfigVersion()) {
<span class="udiff-line-added">+                     if (FontUtilities.debugFonts()) {</span>
<span class="udiff-line-added">+                         warning(&quot;new, different fontconfig detected&quot;);</span>
<span class="udiff-line-added">+                     }</span>
                      return;
                  }
              } catch (Exception e) {
                  if (FontUtilities.debugFonts()) {
                      warning(&quot;Exception parsing version &quot; + fcVersionStr);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -473,10 +479,13 @@</span>
              if (dir == null) {
                  break;
              }
              File dirFile = new File(dir);
              if (dirFile.exists() &amp;&amp; dirFile.lastModified() &gt; lastModified) {
<span class="udiff-line-added">+                 if (FontUtilities.debugFonts()) {</span>
<span class="udiff-line-added">+                     warning(&quot;out of date cache directories detected&quot;);</span>
<span class="udiff-line-added">+                 }</span>
                  return;
              }
              cacheDirIndex++;
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -496,21 +505,27 @@</span>
                      fci[index].fcFamily = fcnames[i];
                      fci[index].style = s;
                      String lenStr = (String)props.get(key+&quot;.length&quot;);
                      int nfonts = Integer.parseInt(lenStr);
                      if (nfonts &lt;= 0) {
<span class="udiff-line-added">+                         if (FontUtilities.debugFonts()) {</span>
<span class="udiff-line-added">+                             warning(&quot;bad non-positive .length entry in fontconfig file &quot; + fcFile.toString());</span>
<span class="udiff-line-added">+                         }</span>
                          return; // bad file
                      }
                      fci[index].allFonts = new FontConfigFont[nfonts];
                      for (int f=0; f&lt;nfonts; f++) {
                          fci[index].allFonts[f] = new FontConfigFont();
<span class="udiff-line-modified-removed">-                         String fkey = key+&quot;.&quot;+f+&quot;.family&quot;;</span>
<span class="udiff-line-modified-removed">-                         String family = (String)props.get(fkey);</span>
<span class="udiff-line-modified-removed">-                         fci[index].allFonts[f].familyName = family;</span>
<span class="udiff-line-modified-added">+                         String fkey = key+&quot;.&quot;+f+&quot;.fullName&quot;;</span>
<span class="udiff-line-modified-added">+                         String fullName = (String)props.get(fkey);</span>
<span class="udiff-line-modified-added">+                         fci[index].allFonts[f].fullName = fullName;</span>
                          fkey = key+&quot;.&quot;+f+&quot;.file&quot;;
                          String file = (String)props.get(fkey);
                          if (file == null) {
<span class="udiff-line-added">+                             if (FontUtilities.debugFonts()) {</span>
<span class="udiff-line-added">+                                 warning(&quot;missing file value for key &quot; + fkey + &quot; in fontconfig file &quot; + fcFile.toString());</span>
<span class="udiff-line-added">+                             }</span>
                              return; // bad file
                          }
                          fci[index].allFonts[f].fontFile = file;
                      }
                      fci[index].firstFont =  fci[index].allFonts[0];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -521,10 +536,15 @@</span>
          } catch (Throwable t) {
              if (FontUtilities.debugFonts()) {
                  warning(t.toString());
              }
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (FontUtilities.debugFonts()) {</span>
<span class="udiff-line-added">+             PlatformLogger logger = FontUtilities.getLogger();</span>
<span class="udiff-line-added">+             logger.info(&quot;successfully parsed the fontconfig file at &quot; + fcFile.toString());</span>
<span class="udiff-line-added">+         }</span>
      }
  
      private static void warning(String msg) {
          PlatformLogger logger = PlatformLogger.getLogger(&quot;sun.awt.FontConfiguration&quot;);
          logger.warning(msg);
</pre>
<center><a href="../awt/X11InputMethodBase.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="FontConfigManager.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>