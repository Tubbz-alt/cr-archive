<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/unix/classes/sun/awt/X11/XToolkit.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="XTextFieldPeer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="XWindow.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/classes/sun/awt/X11/XToolkit.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 329             return res;
 330         } finally {
 331             awtUnlock();
 332         }
 333     }
 334 
 335     void init() {
 336         awtLock();
 337         try {
 338             XlibWrapper.XSupportsLocale();
 339             if (XlibWrapper.XSetLocaleModifiers(&quot;&quot;) == null) {
 340                 log.finer(&quot;X locale modifiers are not supported, using default&quot;);
 341             }
 342             tryXKB();
 343 
 344             AwtScreenData defaultScreen = new AwtScreenData(XToolkit.getDefaultScreenData());
 345             awt_defaultFg = defaultScreen.get_blackpixel();
 346 
 347             arrowCursor = XlibWrapper.XCreateFontCursor(XToolkit.getDisplay(),
 348                 XCursorFontConstants.XC_arrow);
<span class="line-modified"> 349             areExtraMouseButtonsEnabled = Boolean.parseBoolean(System.getProperty(&quot;sun.awt.enableExtraMouseButtons&quot;, &quot;true&quot;));</span>
<span class="line-modified"> 350             //set system property if not yet assigned</span>
<span class="line-modified"> 351             System.setProperty(&quot;sun.awt.enableExtraMouseButtons&quot;, &quot;&quot;+areExtraMouseButtonsEnabled);</span>
<span class="line-modified"> 352 </span>




 353             // Detect display mode changes
 354             XlibWrapper.XSelectInput(XToolkit.getDisplay(), XToolkit.getDefaultRootWindow(), XConstants.StructureNotifyMask);
 355             XToolkit.addEventDispatcher(XToolkit.getDefaultRootWindow(), new XEventDispatcher() {
 356                 @Override
 357                 public void dispatchEvent(XEvent ev) {
 358                     if (ev.get_type() == XConstants.ConfigureNotify) {
 359                         awtUnlock();
 360                         try {
 361                             ((X11GraphicsEnvironment)GraphicsEnvironment.
 362                              getLocalGraphicsEnvironment()).
 363                                 displayChanged();
 364                         } finally {
 365                             awtLock();
 366                         }
 367                     }
 368                 }
 369             });
 370         } finally {
 371             awtUnlock();
 372         }
</pre>
<hr />
<pre>
 406 
 407 
 408     static String getAWTAppClassName() {
 409         return awtAppClassName;
 410     }
 411 
 412     public XToolkit() {
 413         super();
 414         if (PerformanceLogger.loggingEnabled()) {
 415             PerformanceLogger.setTime(&quot;XToolkit construction&quot;);
 416         }
 417 
 418         if (!GraphicsEnvironment.isHeadless()) {
 419             String mainClassName = null;
 420 
 421             StackTraceElement[] trace = (new Throwable()).getStackTrace();
 422             int bottom = trace.length - 1;
 423             if (bottom &gt;= 0) {
 424                 mainClassName = trace[bottom].getClassName();
 425             }
<span class="line-modified"> 426             if (mainClassName == null || mainClassName.equals(&quot;&quot;)) {</span>
 427                 mainClassName = &quot;AWT&quot;;
 428             }
 429             awtAppClassName = getCorrectXIDString(mainClassName);
 430 
 431             init();
 432             XWM.init();
 433 
 434             toolkitThread = AccessController.doPrivileged((PrivilegedAction&lt;Thread&gt;) () -&gt; {
 435                 String name = &quot;AWT-XAWT&quot;;
 436                 Thread thread = new Thread(
 437                         ThreadGroupUtils.getRootThreadGroup(), this, name,
 438                         0, false);
 439                 thread.setContextClassLoader(null);
 440                 thread.setPriority(Thread.NORM_PRIORITY + 1);
 441                 thread.setDaemon(true);
 442                 return thread;
 443             });
 444             toolkitThread.start();
 445         }
 446     }
</pre>
<hr />
<pre>
2537     private void processXkbChanges(XEvent ev) {
2538         // mapping change --&gt; refresh kbd map
2539         // state change --&gt; get a new effective group; do I really need it
2540         //  or that should be left for XkbTranslateKeyCode?
2541         XkbEvent xke = new XkbEvent( ev.getPData() );
2542         int xkb_type = xke.get_any().get_xkb_type();
2543         switch( xkb_type ) {
2544             case XConstants.XkbNewKeyboardNotify :
2545                  if( awt_XKBDescPtr != 0 ) {
2546                      freeXKB();
2547                  }
2548                  awt_XKBDescPtr = XlibWrapper.XkbGetMap(getDisplay(),
2549                                               XConstants.XkbKeyTypesMask    |
2550                                               XConstants.XkbKeySymsMask     |
2551                                               XConstants.XkbModifierMapMask |
2552                                               XConstants.XkbVirtualModsMask,
2553                                               XConstants.XkbUseCoreKbd);
2554                  //System.out.println(&quot;XkbNewKeyboard:&quot;+(xke.get_new_kbd()));
2555                  break;
2556             case XConstants.XkbMapNotify :
<span class="line-modified">2557                  //TODO: provide a simple unit test.</span>
<span class="line-modified">2558                  XlibWrapper.XkbGetUpdatedMap(getDisplay(),</span>
<span class="line-modified">2559                                               XConstants.XkbKeyTypesMask    |</span>
<span class="line-modified">2560                                               XConstants.XkbKeySymsMask     |</span>
<span class="line-modified">2561                                               XConstants.XkbModifierMapMask |</span>
<span class="line-modified">2562                                               XConstants.XkbVirtualModsMask,</span>
<span class="line-modified">2563                                               awt_XKBDescPtr);</span>
<span class="line-modified">2564                  //System.out.println(&quot;XkbMap:&quot;+(xke.get_map()));</span>


2565                  break;
2566             case XConstants.XkbStateNotify :
2567                  // May use it later e.g. to obtain an effective group etc.
2568                  //System.out.println(&quot;XkbState:&quot;+(xke.get_state()));
2569                  break;
2570             default:
2571                  //System.out.println(&quot;XkbEvent of xkb_type &quot;+xkb_type);
2572                  break;
2573         }
2574     }
2575 
2576     private static long eventNumber;
2577     public static long getEventNumber() {
2578         awtLock();
2579         try {
2580             return eventNumber;
2581         } finally {
2582             awtUnlock();
2583         }
2584     }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 329             return res;
 330         } finally {
 331             awtUnlock();
 332         }
 333     }
 334 
 335     void init() {
 336         awtLock();
 337         try {
 338             XlibWrapper.XSupportsLocale();
 339             if (XlibWrapper.XSetLocaleModifiers(&quot;&quot;) == null) {
 340                 log.finer(&quot;X locale modifiers are not supported, using default&quot;);
 341             }
 342             tryXKB();
 343 
 344             AwtScreenData defaultScreen = new AwtScreenData(XToolkit.getDefaultScreenData());
 345             awt_defaultFg = defaultScreen.get_blackpixel();
 346 
 347             arrowCursor = XlibWrapper.XCreateFontCursor(XToolkit.getDisplay(),
 348                 XCursorFontConstants.XC_arrow);
<span class="line-modified"> 349             final String extraButtons = &quot;sun.awt.enableExtraMouseButtons&quot;;</span>
<span class="line-modified"> 350             AccessController.doPrivileged((PrivilegedAction&lt;Void&gt;) () -&gt; {</span>
<span class="line-modified"> 351                 areExtraMouseButtonsEnabled =</span>
<span class="line-modified"> 352                     Boolean.parseBoolean(System.getProperty(extraButtons, &quot;true&quot;));</span>
<span class="line-added"> 353                 //set system property if not yet assigned</span>
<span class="line-added"> 354                 System.setProperty(extraButtons, &quot;&quot;+areExtraMouseButtonsEnabled);</span>
<span class="line-added"> 355                 return null;</span>
<span class="line-added"> 356             });</span>
 357             // Detect display mode changes
 358             XlibWrapper.XSelectInput(XToolkit.getDisplay(), XToolkit.getDefaultRootWindow(), XConstants.StructureNotifyMask);
 359             XToolkit.addEventDispatcher(XToolkit.getDefaultRootWindow(), new XEventDispatcher() {
 360                 @Override
 361                 public void dispatchEvent(XEvent ev) {
 362                     if (ev.get_type() == XConstants.ConfigureNotify) {
 363                         awtUnlock();
 364                         try {
 365                             ((X11GraphicsEnvironment)GraphicsEnvironment.
 366                              getLocalGraphicsEnvironment()).
 367                                 displayChanged();
 368                         } finally {
 369                             awtLock();
 370                         }
 371                     }
 372                 }
 373             });
 374         } finally {
 375             awtUnlock();
 376         }
</pre>
<hr />
<pre>
 410 
 411 
 412     static String getAWTAppClassName() {
 413         return awtAppClassName;
 414     }
 415 
 416     public XToolkit() {
 417         super();
 418         if (PerformanceLogger.loggingEnabled()) {
 419             PerformanceLogger.setTime(&quot;XToolkit construction&quot;);
 420         }
 421 
 422         if (!GraphicsEnvironment.isHeadless()) {
 423             String mainClassName = null;
 424 
 425             StackTraceElement[] trace = (new Throwable()).getStackTrace();
 426             int bottom = trace.length - 1;
 427             if (bottom &gt;= 0) {
 428                 mainClassName = trace[bottom].getClassName();
 429             }
<span class="line-modified"> 430             if (mainClassName == null || mainClassName.isEmpty()) {</span>
 431                 mainClassName = &quot;AWT&quot;;
 432             }
 433             awtAppClassName = getCorrectXIDString(mainClassName);
 434 
 435             init();
 436             XWM.init();
 437 
 438             toolkitThread = AccessController.doPrivileged((PrivilegedAction&lt;Thread&gt;) () -&gt; {
 439                 String name = &quot;AWT-XAWT&quot;;
 440                 Thread thread = new Thread(
 441                         ThreadGroupUtils.getRootThreadGroup(), this, name,
 442                         0, false);
 443                 thread.setContextClassLoader(null);
 444                 thread.setPriority(Thread.NORM_PRIORITY + 1);
 445                 thread.setDaemon(true);
 446                 return thread;
 447             });
 448             toolkitThread.start();
 449         }
 450     }
</pre>
<hr />
<pre>
2541     private void processXkbChanges(XEvent ev) {
2542         // mapping change --&gt; refresh kbd map
2543         // state change --&gt; get a new effective group; do I really need it
2544         //  or that should be left for XkbTranslateKeyCode?
2545         XkbEvent xke = new XkbEvent( ev.getPData() );
2546         int xkb_type = xke.get_any().get_xkb_type();
2547         switch( xkb_type ) {
2548             case XConstants.XkbNewKeyboardNotify :
2549                  if( awt_XKBDescPtr != 0 ) {
2550                      freeXKB();
2551                  }
2552                  awt_XKBDescPtr = XlibWrapper.XkbGetMap(getDisplay(),
2553                                               XConstants.XkbKeyTypesMask    |
2554                                               XConstants.XkbKeySymsMask     |
2555                                               XConstants.XkbModifierMapMask |
2556                                               XConstants.XkbVirtualModsMask,
2557                                               XConstants.XkbUseCoreKbd);
2558                  //System.out.println(&quot;XkbNewKeyboard:&quot;+(xke.get_new_kbd()));
2559                  break;
2560             case XConstants.XkbMapNotify :
<span class="line-modified">2561                  if (awt_XKBDescPtr != 0) {</span>
<span class="line-modified">2562                     //TODO: provide a simple unit test.</span>
<span class="line-modified">2563                     XlibWrapper.XkbGetUpdatedMap(getDisplay(),</span>
<span class="line-modified">2564                                                  XConstants.XkbKeyTypesMask    |</span>
<span class="line-modified">2565                                                  XConstants.XkbKeySymsMask     |</span>
<span class="line-modified">2566                                                  XConstants.XkbModifierMapMask |</span>
<span class="line-modified">2567                                                  XConstants.XkbVirtualModsMask,</span>
<span class="line-modified">2568                                                  awt_XKBDescPtr);</span>
<span class="line-added">2569                  }</span>
<span class="line-added">2570                 //System.out.println(&quot;XkbMap:&quot;+(xke.get_map()));</span>
2571                  break;
2572             case XConstants.XkbStateNotify :
2573                  // May use it later e.g. to obtain an effective group etc.
2574                  //System.out.println(&quot;XkbState:&quot;+(xke.get_state()));
2575                  break;
2576             default:
2577                  //System.out.println(&quot;XkbEvent of xkb_type &quot;+xkb_type);
2578                  break;
2579         }
2580     }
2581 
2582     private static long eventNumber;
2583     public static long getEventNumber() {
2584         awtLock();
2585         try {
2586             return eventNumber;
2587         } finally {
2588             awtUnlock();
2589         }
2590     }
</pre>
</td>
</tr>
</table>
<center><a href="XTextFieldPeer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="XWindow.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>