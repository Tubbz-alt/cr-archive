<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/unix/classes/sun/awt/X11/XPopupMenuPeer.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="XMenuPeer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="XTextAreaPeer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/unix/classes/sun/awt/X11/XPopupMenuPeer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 62     private static final int CAPTION_SEPARATOR_HEIGHT = 6;
 63 
 64     /************************************************
 65      *
 66      * Construction
 67      *
 68      ************************************************/
 69     XPopupMenuPeer(PopupMenu target) {
 70         super(null);
 71         this.popupMenuTarget = target;
 72     }
 73 
 74     /************************************************
 75      *
 76      * Implementation of interface methods
 77      *
 78      ************************************************/
 79     /*
 80      * From MenuComponentPeer
 81      */

 82     public void setFont(Font f) {
 83         resetMapping();
 84         setItemsFont(f);
 85         postPaintEvent();
 86     }
 87 
 88     /*
 89      * From MenuItemPeer
 90      */

 91     public void setLabel(String label) {
 92         resetMapping();
 93         postPaintEvent();
 94     }
 95 
 96 

 97     public void setEnabled(boolean enabled) {
 98         postPaintEvent();
 99     }
100 
<span class="line-removed">101     /*</span>
<span class="line-removed">102      * From MenuPeer</span>
<span class="line-removed">103      */</span>
<span class="line-removed">104     /**</span>
<span class="line-removed">105      * addSeparator routines are not used</span>
<span class="line-removed">106      * in peers. Shared code invokes addItem(&quot;-&quot;)</span>
<span class="line-removed">107      * for adding separators</span>
<span class="line-removed">108      */</span>
<span class="line-removed">109     public void addSeparator() {</span>
<span class="line-removed">110         if (log.isLoggable(PlatformLogger.Level.FINER)) {</span>
<span class="line-removed">111             log.finer(&quot;addSeparator is not implemented&quot;);</span>
<span class="line-removed">112         }</span>
<span class="line-removed">113     }</span>
<span class="line-removed">114 </span>
115     /*
116      * From PopupMenuPeer
117      */

118     @SuppressWarnings(&quot;deprecation&quot;)
119     public void show(Event e) {
120         target = (Component)e.target;
121         // Get menus from the target.
122         Vector&lt;MenuItem&gt; targetItemVector = getMenuTargetItems();
123         if (targetItemVector != null) {
124             reloadItems(targetItemVector);
125             //Fix for 6287092: JCK15a: api/java_awt/interactive/event/EventTests.html#EventTest0015 fails, mustang
126             Point tl = target.getLocationOnScreen();
127             Point pt = new Point(tl.x + e.x, tl.y + e.y);
128             //Fixed 6266513: Incorrect key handling in XAWT popup menu
129             //No item should be selected when showing popup menu
130             if (!ensureCreated()) {
131                 return;
132             }
133             Dimension dim = getDesiredSize();
134             //Fix for 6267162: PIT: Popup Menu gets hidden below the screen when opened
135             //near the periphery of the screen, XToolkit
136             Rectangle bounds = getWindowBounds(pt, dim);
137             reshape(bounds);
</pre>
<hr />
<pre>
156         return AWTAccessor.getMenuComponentAccessor()
157                    .getFont_NoClientCode(popupMenuTarget);
158     }
159 
160     //Fix for 6267144: PIT: Popup menu label is not shown, XToolkit
161     String getTargetLabel() {
162         if (target == null) {
163             return &quot;&quot;;
164         }
165         return AWTAccessor.getMenuItemAccessor().getLabel(popupMenuTarget);
166     }
167 
168     //Fix for 6184485: Popup menu is not disabled on XToolkit even when calling setEnabled (false)
169     boolean isTargetEnabled() {
170         if (popupMenuTarget == null) {
171             return false;
172         }
173         return AWTAccessor.getMenuItemAccessor().isEnabled(popupMenuTarget);
174     }
175 

176     Vector&lt;MenuItem&gt; getMenuTargetItems() {
177         if (popupMenuTarget == null) {
178             return null;
179         }
180         return AWTAccessor.getMenuAccessor().getItems(popupMenuTarget);
181     }
182 
183     /************************************************
184      *
185      * Utility functions
186      *
187      ************************************************/
188 
189     //Fix for 6267162: PIT: Popup Menu gets hidden below the screen when opened
190     //near the periphery of the screen, XToolkit
191 
192     /**
193      * Calculates placement of popup menu window
194      * given origin in global coordinates and
195      * size of menu window. Returns suggested
</pre>
<hr />
<pre>
214         if (res != null) {
215             return res;
216         }
217         res = fitWindowAbove(globalBounds, windowSize, screenBounds);
218         if (res != null) {
219             return res;
220         }
221         return fitWindowToScreen(windowSize, screenBounds);
222    }
223 
224     /************************************************
225      *
226      * Overriden XMenuWindow caption-painting functions
227      * Necessary to fix 6267144: PIT: Popup menu label is not shown, XToolkit
228      *
229      ************************************************/
230     /**
231      * Returns height of menu window&#39;s caption.
232      * Can be overriden for popup menus and tear-off menus
233      */

234     protected Dimension getCaptionSize() {
235         String s = getTargetLabel();
<span class="line-modified">236         if (s.equals(&quot;&quot;)) {</span>
237             return null;
238         }
239         Graphics g = getGraphics();
240         if (g == null) {
241             return null;
242         }
243         try {
244             g.setFont(getTargetFont());
245             FontMetrics fm = g.getFontMetrics();
246             String str = getTargetLabel();
247             int width = fm.stringWidth(str);
248             int height = CAPTION_MARGIN_TOP + fm.getHeight() + CAPTION_SEPARATOR_HEIGHT;
249             Dimension textDimension = new Dimension(width, height);
250             return textDimension;
251         } finally {
252             g.dispose();
253         }
254     }
255 
256     /**
257      * Paints menu window&#39;s caption.
258      * Can be overriden for popup menus and tear-off menus.
259      * Default implementation does nothing
260      */

261     protected void paintCaption(Graphics g, Rectangle rect) {
262         String s = getTargetLabel();
<span class="line-modified">263         if (s.equals(&quot;&quot;)) {</span>
264             return;
265         }
266         g.setFont(getTargetFont());
267         FontMetrics fm = g.getFontMetrics();
268         String str = getTargetLabel();
269         int width = fm.stringWidth(str);
270         int textx = rect.x + (rect.width - width) / 2;
271         int texty = rect.y + CAPTION_MARGIN_TOP + fm.getAscent();
272         int sepy = rect.y + rect.height - CAPTION_SEPARATOR_HEIGHT / 2;
273         g.setColor(isTargetEnabled() ? getForegroundColor() : getDisabledColor());
274         g.drawString(s, textx, texty);
275         draw3DRect(g, rect.x, sepy,  rect.width, 2, false);
276     }
277 
278     /************************************************
279      *
280      * Overriden XBaseMenuWindow functions
281      *
282      ************************************************/

283     protected void doDispose() {
284         super.doDispose();
285         XToolkit.targetDisposedPeer(popupMenuTarget, this);
286     }
287 

288     protected void handleEvent(AWTEvent event) {
289         switch(event.getID()) {
290         case MouseEvent.MOUSE_PRESSED:
291         case MouseEvent.MOUSE_RELEASED:
292         case MouseEvent.MOUSE_CLICKED:
293         case MouseEvent.MOUSE_MOVED:
294         case MouseEvent.MOUSE_ENTERED:
295         case MouseEvent.MOUSE_EXITED:
296         case MouseEvent.MOUSE_DRAGGED:
297             doHandleJavaMouseEvent((MouseEvent)event);
298             break;
299         case KeyEvent.KEY_PRESSED:
300         case KeyEvent.KEY_RELEASED:
301             doHandleJavaKeyEvent((KeyEvent)event);
302             break;
303         default:
304             super.handleEvent(event);
305             break;
306         }
307     }
308 
309     /************************************************
310      *
311      * Overriden XWindow general-purpose functions
312      *
313      ************************************************/

314     void ungrabInputImpl() {
315         hide();
316     }
317 
318     /************************************************
319      *
320      * Overriden XWindow keyboard processing
321      *
322      ************************************************/
323 
324     /*
325      * In previous version keys were handled in handleKeyPress.
326      * Now we override this function do disable F10 explicit
327      * processing. All processing is done using KeyEvent.
328      */

329     public void handleKeyPress(XEvent xev) {
330         XKeyEvent xkey = xev.get_xkey();
331         if (log.isLoggable(PlatformLogger.Level.FINE)) {
332             log.fine(xkey.toString());
333         }
334         if (isEventDisabled(xev)) {
335             return;
336         }
337         final Component currentSource = getEventSource();
338         handleKeyPress(xkey);
339     }
340 
341 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 62     private static final int CAPTION_SEPARATOR_HEIGHT = 6;
 63 
 64     /************************************************
 65      *
 66      * Construction
 67      *
 68      ************************************************/
 69     XPopupMenuPeer(PopupMenu target) {
 70         super(null);
 71         this.popupMenuTarget = target;
 72     }
 73 
 74     /************************************************
 75      *
 76      * Implementation of interface methods
 77      *
 78      ************************************************/
 79     /*
 80      * From MenuComponentPeer
 81      */
<span class="line-added"> 82     @Override</span>
 83     public void setFont(Font f) {
 84         resetMapping();
 85         setItemsFont(f);
 86         postPaintEvent();
 87     }
 88 
 89     /*
 90      * From MenuItemPeer
 91      */
<span class="line-added"> 92     @Override</span>
 93     public void setLabel(String label) {
 94         resetMapping();
 95         postPaintEvent();
 96     }
 97 
 98 
<span class="line-added"> 99     @Override</span>
100     public void setEnabled(boolean enabled) {
101         postPaintEvent();
102     }
103 














104     /*
105      * From PopupMenuPeer
106      */
<span class="line-added">107     @Override</span>
108     @SuppressWarnings(&quot;deprecation&quot;)
109     public void show(Event e) {
110         target = (Component)e.target;
111         // Get menus from the target.
112         Vector&lt;MenuItem&gt; targetItemVector = getMenuTargetItems();
113         if (targetItemVector != null) {
114             reloadItems(targetItemVector);
115             //Fix for 6287092: JCK15a: api/java_awt/interactive/event/EventTests.html#EventTest0015 fails, mustang
116             Point tl = target.getLocationOnScreen();
117             Point pt = new Point(tl.x + e.x, tl.y + e.y);
118             //Fixed 6266513: Incorrect key handling in XAWT popup menu
119             //No item should be selected when showing popup menu
120             if (!ensureCreated()) {
121                 return;
122             }
123             Dimension dim = getDesiredSize();
124             //Fix for 6267162: PIT: Popup Menu gets hidden below the screen when opened
125             //near the periphery of the screen, XToolkit
126             Rectangle bounds = getWindowBounds(pt, dim);
127             reshape(bounds);
</pre>
<hr />
<pre>
146         return AWTAccessor.getMenuComponentAccessor()
147                    .getFont_NoClientCode(popupMenuTarget);
148     }
149 
150     //Fix for 6267144: PIT: Popup menu label is not shown, XToolkit
151     String getTargetLabel() {
152         if (target == null) {
153             return &quot;&quot;;
154         }
155         return AWTAccessor.getMenuItemAccessor().getLabel(popupMenuTarget);
156     }
157 
158     //Fix for 6184485: Popup menu is not disabled on XToolkit even when calling setEnabled (false)
159     boolean isTargetEnabled() {
160         if (popupMenuTarget == null) {
161             return false;
162         }
163         return AWTAccessor.getMenuItemAccessor().isEnabled(popupMenuTarget);
164     }
165 
<span class="line-added">166     @Override</span>
167     Vector&lt;MenuItem&gt; getMenuTargetItems() {
168         if (popupMenuTarget == null) {
169             return null;
170         }
171         return AWTAccessor.getMenuAccessor().getItems(popupMenuTarget);
172     }
173 
174     /************************************************
175      *
176      * Utility functions
177      *
178      ************************************************/
179 
180     //Fix for 6267162: PIT: Popup Menu gets hidden below the screen when opened
181     //near the periphery of the screen, XToolkit
182 
183     /**
184      * Calculates placement of popup menu window
185      * given origin in global coordinates and
186      * size of menu window. Returns suggested
</pre>
<hr />
<pre>
205         if (res != null) {
206             return res;
207         }
208         res = fitWindowAbove(globalBounds, windowSize, screenBounds);
209         if (res != null) {
210             return res;
211         }
212         return fitWindowToScreen(windowSize, screenBounds);
213    }
214 
215     /************************************************
216      *
217      * Overriden XMenuWindow caption-painting functions
218      * Necessary to fix 6267144: PIT: Popup menu label is not shown, XToolkit
219      *
220      ************************************************/
221     /**
222      * Returns height of menu window&#39;s caption.
223      * Can be overriden for popup menus and tear-off menus
224      */
<span class="line-added">225     @Override</span>
226     protected Dimension getCaptionSize() {
227         String s = getTargetLabel();
<span class="line-modified">228         if (s.isEmpty()) {</span>
229             return null;
230         }
231         Graphics g = getGraphics();
232         if (g == null) {
233             return null;
234         }
235         try {
236             g.setFont(getTargetFont());
237             FontMetrics fm = g.getFontMetrics();
238             String str = getTargetLabel();
239             int width = fm.stringWidth(str);
240             int height = CAPTION_MARGIN_TOP + fm.getHeight() + CAPTION_SEPARATOR_HEIGHT;
241             Dimension textDimension = new Dimension(width, height);
242             return textDimension;
243         } finally {
244             g.dispose();
245         }
246     }
247 
248     /**
249      * Paints menu window&#39;s caption.
250      * Can be overriden for popup menus and tear-off menus.
251      * Default implementation does nothing
252      */
<span class="line-added">253     @Override</span>
254     protected void paintCaption(Graphics g, Rectangle rect) {
255         String s = getTargetLabel();
<span class="line-modified">256         if (s.isEmpty()) {</span>
257             return;
258         }
259         g.setFont(getTargetFont());
260         FontMetrics fm = g.getFontMetrics();
261         String str = getTargetLabel();
262         int width = fm.stringWidth(str);
263         int textx = rect.x + (rect.width - width) / 2;
264         int texty = rect.y + CAPTION_MARGIN_TOP + fm.getAscent();
265         int sepy = rect.y + rect.height - CAPTION_SEPARATOR_HEIGHT / 2;
266         g.setColor(isTargetEnabled() ? getForegroundColor() : getDisabledColor());
267         g.drawString(s, textx, texty);
268         draw3DRect(g, rect.x, sepy,  rect.width, 2, false);
269     }
270 
271     /************************************************
272      *
273      * Overriden XBaseMenuWindow functions
274      *
275      ************************************************/
<span class="line-added">276     @Override</span>
277     protected void doDispose() {
278         super.doDispose();
279         XToolkit.targetDisposedPeer(popupMenuTarget, this);
280     }
281 
<span class="line-added">282     @Override</span>
283     protected void handleEvent(AWTEvent event) {
284         switch(event.getID()) {
285         case MouseEvent.MOUSE_PRESSED:
286         case MouseEvent.MOUSE_RELEASED:
287         case MouseEvent.MOUSE_CLICKED:
288         case MouseEvent.MOUSE_MOVED:
289         case MouseEvent.MOUSE_ENTERED:
290         case MouseEvent.MOUSE_EXITED:
291         case MouseEvent.MOUSE_DRAGGED:
292             doHandleJavaMouseEvent((MouseEvent)event);
293             break;
294         case KeyEvent.KEY_PRESSED:
295         case KeyEvent.KEY_RELEASED:
296             doHandleJavaKeyEvent((KeyEvent)event);
297             break;
298         default:
299             super.handleEvent(event);
300             break;
301         }
302     }
303 
304     /************************************************
305      *
306      * Overriden XWindow general-purpose functions
307      *
308      ************************************************/
<span class="line-added">309     @Override</span>
310     void ungrabInputImpl() {
311         hide();
312     }
313 
314     /************************************************
315      *
316      * Overriden XWindow keyboard processing
317      *
318      ************************************************/
319 
320     /*
321      * In previous version keys were handled in handleKeyPress.
322      * Now we override this function do disable F10 explicit
323      * processing. All processing is done using KeyEvent.
324      */
<span class="line-added">325     @Override</span>
326     public void handleKeyPress(XEvent xev) {
327         XKeyEvent xkey = xev.get_xkey();
328         if (log.isLoggable(PlatformLogger.Level.FINE)) {
329             log.fine(xkey.toString());
330         }
331         if (isEventDisabled(xev)) {
332             return;
333         }
334         final Component currentSource = getEventSource();
335         handleKeyPress(xkey);
336     }
337 
338 }
</pre>
</td>
</tr>
</table>
<center><a href="XMenuPeer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="XTextAreaPeer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>