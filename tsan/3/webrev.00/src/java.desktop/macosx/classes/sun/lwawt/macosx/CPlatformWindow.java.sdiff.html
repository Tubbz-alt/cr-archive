<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/classes/sun/lwawt/macosx/CPlatformWindow.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="CPlatformView.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CTaskbarPeer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/classes/sun/lwawt/macosx/CPlatformWindow.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  45 import java.beans.PropertyChangeEvent;
  46 import java.beans.PropertyChangeListener;
  47 import java.lang.reflect.InvocationTargetException;
  48 import java.util.ArrayList;
  49 import java.util.Arrays;
  50 import java.util.Comparator;
  51 import java.util.concurrent.atomic.AtomicBoolean;
  52 import java.util.concurrent.atomic.AtomicLong;
  53 import java.util.concurrent.atomic.AtomicReference;
  54 
  55 import javax.swing.JRootPane;
  56 import javax.swing.RootPaneContainer;
  57 import javax.swing.SwingUtilities;
  58 
  59 import com.apple.laf.ClientPropertyApplicator;
  60 import com.apple.laf.ClientPropertyApplicator.Property;
  61 import sun.awt.AWTAccessor;
  62 import sun.awt.AWTAccessor.ComponentAccessor;
  63 import sun.awt.AWTAccessor.WindowAccessor;
  64 import sun.java2d.SurfaceData;
<span class="line-removed">  65 import sun.java2d.opengl.CGLSurfaceData;</span>
  66 import sun.lwawt.LWLightweightFramePeer;
  67 import sun.lwawt.LWToolkit;
  68 import sun.lwawt.LWWindowPeer;
  69 import sun.lwawt.LWWindowPeer.PeerType;
  70 import sun.lwawt.PlatformWindow;
  71 import sun.util.logging.PlatformLogger;
  72 
  73 public class CPlatformWindow extends CFRetainedResource implements PlatformWindow {
  74     private native long nativeCreateNSWindow(long nsViewPtr,long ownerPtr, long styleBits, double x, double y, double w, double h);
  75     private static native void nativeSetNSWindowStyleBits(long nsWindowPtr, int mask, int data);
  76     private static native void nativeSetNSWindowMenuBar(long nsWindowPtr, long menuBarPtr);
  77     private static native Insets nativeGetNSWindowInsets(long nsWindowPtr);
  78     private static native void nativeSetNSWindowBounds(long nsWindowPtr, double x, double y, double w, double h);
  79     private static native void nativeSetNSWindowLocationByPlatform(long nsWindowPtr);
  80     private static native void nativeSetNSWindowStandardFrame(long nsWindowPtr,
  81             double x, double y, double w, double h);
  82     private static native void nativeSetNSWindowMinMax(long nsWindowPtr, double minW, double minH, double maxW, double maxH);
  83     private static native void nativePushNSWindowToBack(long nsWindowPtr);
  84     private static native void nativePushNSWindowToFront(long nsWindowPtr);
  85     private static native void nativeSetNSWindowTitle(long nsWindowPtr, String title);
</pre>
<hr />
<pre>
 292     private Window target;
 293     private LWWindowPeer peer;
 294     protected CPlatformView contentView;
 295     protected CPlatformWindow owner;
 296     protected boolean visible = false; // visibility status from native perspective
 297     private boolean undecorated; // initialized in getInitialStyleBits()
 298     private Rectangle normalBounds = null; // not-null only for undecorated maximized windows
 299     private CPlatformResponder responder;
 300     private long lastBecomeMainTime; // this is necessary to preserve right siblings order
 301 
 302     public CPlatformWindow() {
 303         super(0, true);
 304     }
 305 
 306     /*
 307      * Delegate initialization (create native window and all the
 308      * related resources).
 309      */
 310     @Override // PlatformWindow
 311     public void initialize(Window _target, LWWindowPeer _peer, PlatformWindow _owner) {
<span class="line-modified"> 312         initializeBase(_target, _peer, _owner, new CPlatformView());</span>
 313 
 314         final int styleBits = getInitialStyleBits();
 315 
 316         responder = createPlatformResponder();
<span class="line-removed"> 317         contentView = createContentView();</span>
 318         contentView.initialize(peer, responder);
 319 
 320         Rectangle bounds;
 321         if (!IS(DECORATED, styleBits)) {
 322             // For undecorated frames the move/resize event does not come if the frame is centered on the screen
 323             // so we need to set a stub location to force an initial move/resize. Real bounds would be set later.
 324             bounds = new Rectangle(0, 0, 1, 1);
 325         } else {
 326             bounds = _peer.constrainBounds(_target.getBounds());
 327         }
 328         AtomicLong ref = new AtomicLong();
 329         contentView.execute(viewPtr -&gt; {
 330             boolean hasOwnerPtr = false;
 331 
 332             if (owner != null) {
 333                 hasOwnerPtr = 0L != owner.executeGet(ownerPtr -&gt; {
 334                     ref.set(nativeCreateNSWindow(viewPtr, ownerPtr, styleBits,
 335                                                     bounds.x, bounds.y,
 336                                                     bounds.width, bounds.height));
 337                     return 1;
 338                 });
 339             }
 340 
 341             if (!hasOwnerPtr) {
 342                 ref.set(nativeCreateNSWindow(viewPtr, 0,
 343                                              styleBits, bounds.x, bounds.y,
 344                                              bounds.width, bounds.height));
 345             }
 346         });
 347         setPtr(ref.get());
 348 
 349         if (target instanceof javax.swing.RootPaneContainer) {
 350             final javax.swing.JRootPane rootpane = ((javax.swing.RootPaneContainer)target).getRootPane();
 351             if (rootpane != null) rootpane.addPropertyChangeListener(&quot;ancestor&quot;, new PropertyChangeListener() {
 352                 public void propertyChange(final PropertyChangeEvent evt) {
 353                     CLIENT_PROPERTY_APPLICATOR.attachAndApplyClientProperties(rootpane);
 354                     rootpane.removePropertyChangeListener(&quot;ancestor&quot;, this);
 355                 }
 356             });
 357         }
<span class="line-removed"> 358 </span>
<span class="line-removed"> 359         validateSurface();</span>
 360     }
 361 
<span class="line-modified"> 362     protected void initializeBase(Window target, LWWindowPeer peer, PlatformWindow owner, CPlatformView view) {</span>
 363         this.peer = peer;
 364         this.target = target;
 365         if (owner instanceof CPlatformWindow) {
 366             this.owner = (CPlatformWindow)owner;
 367         }
<span class="line-modified"> 368         this.contentView = view;</span>
 369     }
 370 
 371     protected CPlatformResponder createPlatformResponder() {
 372         return new CPlatformResponder(peer, false);
 373     }
 374 
<span class="line-modified"> 375     protected CPlatformView createContentView() {</span>
 376         return new CPlatformView();
 377     }
 378 
 379     protected int getInitialStyleBits() {
 380         // defaults style bits
 381         int styleBits = DECORATED | HAS_SHADOW | CLOSEABLE | MINIMIZABLE | ZOOMABLE | RESIZABLE;
 382 
 383         if (isNativelyFocusableWindow()) {
 384             styleBits = SET(styleBits, SHOULD_BECOME_KEY, true);
 385             styleBits = SET(styleBits, SHOULD_BECOME_MAIN, true);
 386         }
 387 
 388         final boolean isFrame = (target instanceof Frame);
 389         final boolean isDialog = (target instanceof Dialog);
 390         final boolean isPopup = (target.getType() == Window.Type.POPUP);
 391         if (isDialog) {
 392             styleBits = SET(styleBits, MINIMIZABLE, false);
 393         }
 394 
 395         // Either java.awt.Frame or java.awt.Dialog can be undecorated, however java.awt.Window always is undecorated.
</pre>
<hr />
<pre>
1035      */
1036     @Override
1037     public LWWindowPeer getPeer() {
1038         return peer;
1039     }
1040 
1041     @Override
1042     public boolean isUnderMouse() {
1043         return contentView.isUnderMouse();
1044     }
1045 
1046     public CPlatformView getContentView() {
1047         return contentView;
1048     }
1049 
1050     @Override
1051     public long getLayerPtr() {
1052         return contentView.getWindowLayerPtr();
1053     }
1054 
<span class="line-removed">1055     private void validateSurface() {</span>
<span class="line-removed">1056         SurfaceData surfaceData = getSurfaceData();</span>
<span class="line-removed">1057         if (surfaceData instanceof CGLSurfaceData) {</span>
<span class="line-removed">1058             ((CGLSurfaceData)surfaceData).validate();</span>
<span class="line-removed">1059         }</span>
<span class="line-removed">1060     }</span>
<span class="line-removed">1061 </span>
1062     void flushBuffers() {
1063         if (isVisible() &amp;&amp; !nativeBounds.isEmpty() &amp;&amp; !isFullScreenMode) {
1064             try {
1065                 LWCToolkit.invokeAndWait(new Runnable() {
1066                     @Override
1067                     public void run() {
1068                         //Posting an empty to flush the EventQueue without blocking the main thread
1069                     }
1070                 }, target);
1071             } catch (InvocationTargetException e) {
1072                 e.printStackTrace();
1073             }
1074         }
1075     }
1076 
1077     /**
1078      * Helper method to get a pointer to the native view from the PlatformWindow.
1079      */
1080     static long getNativeViewPtr(PlatformWindow platformWindow) {
1081         long nativePeer = 0L;
</pre>
</td>
<td>
<hr />
<pre>
  45 import java.beans.PropertyChangeEvent;
  46 import java.beans.PropertyChangeListener;
  47 import java.lang.reflect.InvocationTargetException;
  48 import java.util.ArrayList;
  49 import java.util.Arrays;
  50 import java.util.Comparator;
  51 import java.util.concurrent.atomic.AtomicBoolean;
  52 import java.util.concurrent.atomic.AtomicLong;
  53 import java.util.concurrent.atomic.AtomicReference;
  54 
  55 import javax.swing.JRootPane;
  56 import javax.swing.RootPaneContainer;
  57 import javax.swing.SwingUtilities;
  58 
  59 import com.apple.laf.ClientPropertyApplicator;
  60 import com.apple.laf.ClientPropertyApplicator.Property;
  61 import sun.awt.AWTAccessor;
  62 import sun.awt.AWTAccessor.ComponentAccessor;
  63 import sun.awt.AWTAccessor.WindowAccessor;
  64 import sun.java2d.SurfaceData;

  65 import sun.lwawt.LWLightweightFramePeer;
  66 import sun.lwawt.LWToolkit;
  67 import sun.lwawt.LWWindowPeer;
  68 import sun.lwawt.LWWindowPeer.PeerType;
  69 import sun.lwawt.PlatformWindow;
  70 import sun.util.logging.PlatformLogger;
  71 
  72 public class CPlatformWindow extends CFRetainedResource implements PlatformWindow {
  73     private native long nativeCreateNSWindow(long nsViewPtr,long ownerPtr, long styleBits, double x, double y, double w, double h);
  74     private static native void nativeSetNSWindowStyleBits(long nsWindowPtr, int mask, int data);
  75     private static native void nativeSetNSWindowMenuBar(long nsWindowPtr, long menuBarPtr);
  76     private static native Insets nativeGetNSWindowInsets(long nsWindowPtr);
  77     private static native void nativeSetNSWindowBounds(long nsWindowPtr, double x, double y, double w, double h);
  78     private static native void nativeSetNSWindowLocationByPlatform(long nsWindowPtr);
  79     private static native void nativeSetNSWindowStandardFrame(long nsWindowPtr,
  80             double x, double y, double w, double h);
  81     private static native void nativeSetNSWindowMinMax(long nsWindowPtr, double minW, double minH, double maxW, double maxH);
  82     private static native void nativePushNSWindowToBack(long nsWindowPtr);
  83     private static native void nativePushNSWindowToFront(long nsWindowPtr);
  84     private static native void nativeSetNSWindowTitle(long nsWindowPtr, String title);
</pre>
<hr />
<pre>
 291     private Window target;
 292     private LWWindowPeer peer;
 293     protected CPlatformView contentView;
 294     protected CPlatformWindow owner;
 295     protected boolean visible = false; // visibility status from native perspective
 296     private boolean undecorated; // initialized in getInitialStyleBits()
 297     private Rectangle normalBounds = null; // not-null only for undecorated maximized windows
 298     private CPlatformResponder responder;
 299     private long lastBecomeMainTime; // this is necessary to preserve right siblings order
 300 
 301     public CPlatformWindow() {
 302         super(0, true);
 303     }
 304 
 305     /*
 306      * Delegate initialization (create native window and all the
 307      * related resources).
 308      */
 309     @Override // PlatformWindow
 310     public void initialize(Window _target, LWWindowPeer _peer, PlatformWindow _owner) {
<span class="line-modified"> 311         initializeBase(_target, _peer, _owner);</span>
 312 
 313         final int styleBits = getInitialStyleBits();
 314 
 315         responder = createPlatformResponder();

 316         contentView.initialize(peer, responder);
 317 
 318         Rectangle bounds;
 319         if (!IS(DECORATED, styleBits)) {
 320             // For undecorated frames the move/resize event does not come if the frame is centered on the screen
 321             // so we need to set a stub location to force an initial move/resize. Real bounds would be set later.
 322             bounds = new Rectangle(0, 0, 1, 1);
 323         } else {
 324             bounds = _peer.constrainBounds(_target.getBounds());
 325         }
 326         AtomicLong ref = new AtomicLong();
 327         contentView.execute(viewPtr -&gt; {
 328             boolean hasOwnerPtr = false;
 329 
 330             if (owner != null) {
 331                 hasOwnerPtr = 0L != owner.executeGet(ownerPtr -&gt; {
 332                     ref.set(nativeCreateNSWindow(viewPtr, ownerPtr, styleBits,
 333                                                     bounds.x, bounds.y,
 334                                                     bounds.width, bounds.height));
 335                     return 1;
 336                 });
 337             }
 338 
 339             if (!hasOwnerPtr) {
 340                 ref.set(nativeCreateNSWindow(viewPtr, 0,
 341                                              styleBits, bounds.x, bounds.y,
 342                                              bounds.width, bounds.height));
 343             }
 344         });
 345         setPtr(ref.get());
 346 
 347         if (target instanceof javax.swing.RootPaneContainer) {
 348             final javax.swing.JRootPane rootpane = ((javax.swing.RootPaneContainer)target).getRootPane();
 349             if (rootpane != null) rootpane.addPropertyChangeListener(&quot;ancestor&quot;, new PropertyChangeListener() {
 350                 public void propertyChange(final PropertyChangeEvent evt) {
 351                     CLIENT_PROPERTY_APPLICATOR.attachAndApplyClientProperties(rootpane);
 352                     rootpane.removePropertyChangeListener(&quot;ancestor&quot;, this);
 353                 }
 354             });
 355         }


 356     }
 357 
<span class="line-modified"> 358     void initializeBase(Window target, LWWindowPeer peer, PlatformWindow owner) {</span>
 359         this.peer = peer;
 360         this.target = target;
 361         if (owner instanceof CPlatformWindow) {
 362             this.owner = (CPlatformWindow)owner;
 363         }
<span class="line-modified"> 364         contentView = createContentView();</span>
 365     }
 366 
 367     protected CPlatformResponder createPlatformResponder() {
 368         return new CPlatformResponder(peer, false);
 369     }
 370 
<span class="line-modified"> 371     CPlatformView createContentView() {</span>
 372         return new CPlatformView();
 373     }
 374 
 375     protected int getInitialStyleBits() {
 376         // defaults style bits
 377         int styleBits = DECORATED | HAS_SHADOW | CLOSEABLE | MINIMIZABLE | ZOOMABLE | RESIZABLE;
 378 
 379         if (isNativelyFocusableWindow()) {
 380             styleBits = SET(styleBits, SHOULD_BECOME_KEY, true);
 381             styleBits = SET(styleBits, SHOULD_BECOME_MAIN, true);
 382         }
 383 
 384         final boolean isFrame = (target instanceof Frame);
 385         final boolean isDialog = (target instanceof Dialog);
 386         final boolean isPopup = (target.getType() == Window.Type.POPUP);
 387         if (isDialog) {
 388             styleBits = SET(styleBits, MINIMIZABLE, false);
 389         }
 390 
 391         // Either java.awt.Frame or java.awt.Dialog can be undecorated, however java.awt.Window always is undecorated.
</pre>
<hr />
<pre>
1031      */
1032     @Override
1033     public LWWindowPeer getPeer() {
1034         return peer;
1035     }
1036 
1037     @Override
1038     public boolean isUnderMouse() {
1039         return contentView.isUnderMouse();
1040     }
1041 
1042     public CPlatformView getContentView() {
1043         return contentView;
1044     }
1045 
1046     @Override
1047     public long getLayerPtr() {
1048         return contentView.getWindowLayerPtr();
1049     }
1050 







1051     void flushBuffers() {
1052         if (isVisible() &amp;&amp; !nativeBounds.isEmpty() &amp;&amp; !isFullScreenMode) {
1053             try {
1054                 LWCToolkit.invokeAndWait(new Runnable() {
1055                     @Override
1056                     public void run() {
1057                         //Posting an empty to flush the EventQueue without blocking the main thread
1058                     }
1059                 }, target);
1060             } catch (InvocationTargetException e) {
1061                 e.printStackTrace();
1062             }
1063         }
1064     }
1065 
1066     /**
1067      * Helper method to get a pointer to the native view from the PlatformWindow.
1068      */
1069     static long getNativeViewPtr(PlatformWindow platformWindow) {
1070         long nativePeer = 0L;
</pre>
</td>
</tr>
</table>
<center><a href="CPlatformView.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CTaskbarPeer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>