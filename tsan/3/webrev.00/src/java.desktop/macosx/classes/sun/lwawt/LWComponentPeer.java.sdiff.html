<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/classes/sun/lwawt/LWComponentPeer.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../java2d/opengl/CGLVolatileSurfaceManager.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="LWLightweightFramePeer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/classes/sun/lwawt/LWComponentPeer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
<span class="line-removed">  26 </span>
  27 package sun.lwawt;
  28 
<span class="line-modified">  29 import java.awt.*;</span>
<span class="line-modified">  30 </span>















  31 import java.awt.dnd.DropTarget;
  32 import java.awt.dnd.peer.DropTargetPeer;
<span class="line-modified">  33 import java.awt.event.*;</span>
<span class="line-modified">  34 </span>






  35 import java.awt.image.ColorModel;
<span class="line-removed">  36 import java.awt.image.ImageObserver;</span>
<span class="line-removed">  37 import java.awt.image.ImageProducer;</span>
  38 import java.awt.image.VolatileImage;
<span class="line-removed">  39 </span>
  40 import java.awt.peer.ComponentPeer;
  41 import java.awt.peer.ContainerPeer;
<span class="line-removed">  42 </span>
  43 import java.awt.peer.KeyboardFocusManagerPeer;
<span class="line-removed">  44 import java.util.concurrent.atomic.AtomicBoolean;</span>
  45 import java.lang.reflect.Field;
  46 import java.security.AccessController;
  47 import java.security.PrivilegedAction;

  48 
<span class="line-modified">  49 import sun.awt.*;</span>


  50 





  51 import sun.awt.event.IgnorePaintEvent;
<span class="line-removed">  52 </span>
  53 import sun.awt.image.SunVolatileImage;
<span class="line-removed">  54 import sun.awt.image.ToolkitImage;</span>
<span class="line-removed">  55 </span>
  56 import sun.java2d.SunGraphics2D;
  57 import sun.java2d.opengl.OGLRenderQueue;
  58 import sun.java2d.pipe.Region;
<span class="line-removed">  59 </span>
  60 import sun.util.logging.PlatformLogger;
  61 
<span class="line-removed">  62 import javax.swing.JComponent;</span>
<span class="line-removed">  63 import javax.swing.SwingUtilities;</span>
<span class="line-removed">  64 import javax.swing.RepaintManager;</span>
<span class="line-removed">  65 </span>
<span class="line-removed">  66 import com.sun.java.swing.SwingUtilities3;</span>
<span class="line-removed">  67 </span>
  68 public abstract class LWComponentPeer&lt;T extends Component, D extends JComponent&gt;
  69     implements ComponentPeer, DropTargetPeer
  70 {
  71     private static final PlatformLogger focusLog = PlatformLogger.getLogger(&quot;sun.lwawt.focus.LWComponentPeer&quot;);
  72 
  73     /**
  74      * State lock is to be used for modifications to this peer&#39;s fields (e.g.
  75      * bounds, background, font, etc.) It should be the last lock in the lock
  76      * chain
  77      */
  78     private final Object stateLock = new Object();
  79 
  80     /**
  81      * The lock to operate with the peers hierarchy. AWT tree lock is not used
  82      * as there are many peers related ops to be done on the toolkit thread, and
  83      * we don&#39;t want to depend on a public lock on this thread
  84      */
  85     private static final Object peerTreeLock = new Object();
  86 
  87     /**
</pre>
<hr />
<pre>
 960                                       parentWindow.isFocused());
 961                     }
 962                     LWKeyboardFocusManagerPeer.removeLastFocusRequest(getTarget());
 963                     return false;
 964                 }
 965 
 966                 KeyboardFocusManagerPeer kfmPeer = LWKeyboardFocusManagerPeer.getInstance();
 967                 Component focusOwner = kfmPeer.getCurrentFocusOwner();
 968                 return LWKeyboardFocusManagerPeer.deliverFocus(lightweightChild,
 969                         getTarget(), temporary,
 970                         focusedWindowChangeAllowed,
 971                         time, cause, focusOwner);
 972 
 973             case LWKeyboardFocusManagerPeer.SNFH_SUCCESS_HANDLED:
 974                 return true;
 975         }
 976 
 977         return false;
 978     }
 979 
<span class="line-removed"> 980     @Override</span>
<span class="line-removed"> 981     public final Image createImage(final ImageProducer producer) {</span>
<span class="line-removed"> 982         return new ToolkitImage(producer);</span>
<span class="line-removed"> 983     }</span>
<span class="line-removed"> 984 </span>
 985     @Override
 986     public final Image createImage(final int width, final int height) {
 987         return getLWGC().createAcceleratedImage(getTarget(), width, height);
 988     }
 989 
 990     @Override
 991     public final VolatileImage createVolatileImage(final int w, final int h) {
 992         return new SunVolatileImage(getTarget(), w, h);
 993     }
 994 
<span class="line-removed"> 995     @Override</span>
<span class="line-removed"> 996     public boolean prepareImage(Image img, int w, int h, ImageObserver o) {</span>
<span class="line-removed"> 997         // TODO: is it a right/complete implementation?</span>
<span class="line-removed"> 998         return Toolkit.getDefaultToolkit().prepareImage(img, w, h, o);</span>
<span class="line-removed"> 999     }</span>
<span class="line-removed">1000 </span>
<span class="line-removed">1001     @Override</span>
<span class="line-removed">1002     public int checkImage(Image img, int w, int h, ImageObserver o) {</span>
<span class="line-removed">1003         // TODO: is it a right/complete implementation?</span>
<span class="line-removed">1004         return Toolkit.getDefaultToolkit().checkImage(img, w, h, o);</span>
<span class="line-removed">1005     }</span>
<span class="line-removed">1006 </span>
1007     @Override
1008     public boolean handlesWheelScrolling() {
1009         // TODO: not implemented
1010         return false;
1011     }
1012 
1013     @Override
1014     public final void applyShape(final Region shape) {
1015         synchronized (getStateLock()) {
1016             if (region == shape || (region != null &amp;&amp; region.equals(shape))) {
1017                 return;
1018             }
1019         }
1020         applyShapeImpl(shape);
1021     }
1022 
1023     void applyShapeImpl(final Region shape) {
1024         synchronized (getStateLock()) {
1025             if (shape != null) {
1026                 region = Region.WHOLE_REGION.getIntersection(shape);
</pre>
<hr />
<pre>
1088                     } else
1089                         System.err.println(&quot;CComponent.removeDropTarget(): current drop target is null.&quot;);
1090                 }
1091             }
1092         }
1093     }
1094 
1095     // ---- PEER NOTIFICATIONS ---- //
1096 
1097     /**
1098      * Called when this peer&#39;s location has been changed either as a result
1099      * of target.setLocation() or as a result of user actions (window is
1100      * dragged with mouse).
1101      *
1102      * This method could be called on the toolkit thread.
1103      */
1104     protected final void handleMove(final int x, final int y,
1105                                     final boolean updateTarget) {
1106         if (updateTarget) {
1107             AWTAccessor.getComponentAccessor().setLocation(getTarget(), x, y);


1108         }
<span class="line-removed">1109         postEvent(new ComponentEvent(getTarget(),</span>
<span class="line-removed">1110                                      ComponentEvent.COMPONENT_MOVED));</span>
1111     }
1112 
1113     /**
1114      * Called when this peer&#39;s size has been changed either as a result of
1115      * target.setSize() or as a result of user actions (window is resized).
1116      *
1117      * This method could be called on the toolkit thread.
1118      */
1119     protected final void handleResize(final int w, final int h,
1120                                       final boolean updateTarget) {
1121         Image oldBB = null;
1122         synchronized (getStateLock()) {
1123             if (backBuffer != null) {
1124                 oldBB = backBuffer;
1125                 backBuffer = getLWGC().createBackBuffer(this);
1126             }
1127         }
1128         getLWGC().destroyBackBuffer(oldBB);
1129 
1130         if (updateTarget) {
1131             AWTAccessor.getComponentAccessor().setSize(getTarget(), w, h);


1132         }
<span class="line-removed">1133         postEvent(new ComponentEvent(getTarget(),</span>
<span class="line-removed">1134                                      ComponentEvent.COMPONENT_RESIZED));</span>
1135     }
1136 
1137     protected final void repaintOldNewBounds(final Rectangle oldB) {
1138         repaintParent(oldB);
1139         repaintPeer(getSize());
1140     }
1141 
1142     protected final void repaintParent(final Rectangle oldB) {
1143         final LWContainerPeer&lt;?, ?&gt; cp = getContainerPeer();
1144         if (cp != null) {
1145             // Repaint unobscured part of the parent
1146             cp.repaintPeer(cp.getContentSize().intersection(oldB));
1147         }
1148     }
1149 
1150     // ---- EVENTS ---- //
1151 
1152     /**
1153      * Post an event to the proper Java EDT.
1154      */
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 

  26 package sun.lwawt;
  27 
<span class="line-modified">  28 import java.awt.AWTEvent;</span>
<span class="line-modified">  29 import java.awt.AWTException;</span>
<span class="line-added">  30 import java.awt.BufferCapabilities;</span>
<span class="line-added">  31 import java.awt.Color;</span>
<span class="line-added">  32 import java.awt.Component;</span>
<span class="line-added">  33 import java.awt.Container;</span>
<span class="line-added">  34 import java.awt.Cursor;</span>
<span class="line-added">  35 import java.awt.Dimension;</span>
<span class="line-added">  36 import java.awt.Font;</span>
<span class="line-added">  37 import java.awt.FontMetrics;</span>
<span class="line-added">  38 import java.awt.Graphics;</span>
<span class="line-added">  39 import java.awt.GraphicsConfiguration;</span>
<span class="line-added">  40 import java.awt.Image;</span>
<span class="line-added">  41 import java.awt.Point;</span>
<span class="line-added">  42 import java.awt.Rectangle;</span>
<span class="line-added">  43 import java.awt.Toolkit;</span>
<span class="line-added">  44 import java.awt.Window;</span>
  45 import java.awt.dnd.DropTarget;
  46 import java.awt.dnd.peer.DropTargetPeer;
<span class="line-modified">  47 import java.awt.event.AWTEventListener;</span>
<span class="line-modified">  48 import java.awt.event.ComponentEvent;</span>
<span class="line-added">  49 import java.awt.event.FocusEvent;</span>
<span class="line-added">  50 import java.awt.event.InputEvent;</span>
<span class="line-added">  51 import java.awt.event.KeyEvent;</span>
<span class="line-added">  52 import java.awt.event.MouseEvent;</span>
<span class="line-added">  53 import java.awt.event.MouseWheelEvent;</span>
<span class="line-added">  54 import java.awt.event.PaintEvent;</span>
  55 import java.awt.image.ColorModel;


  56 import java.awt.image.VolatileImage;

  57 import java.awt.peer.ComponentPeer;
  58 import java.awt.peer.ContainerPeer;

  59 import java.awt.peer.KeyboardFocusManagerPeer;

  60 import java.lang.reflect.Field;
  61 import java.security.AccessController;
  62 import java.security.PrivilegedAction;
<span class="line-added">  63 import java.util.concurrent.atomic.AtomicBoolean;</span>
  64 
<span class="line-modified">  65 import javax.swing.JComponent;</span>
<span class="line-added">  66 import javax.swing.RepaintManager;</span>
<span class="line-added">  67 import javax.swing.SwingUtilities;</span>
  68 
<span class="line-added">  69 import com.sun.java.swing.SwingUtilities3;</span>
<span class="line-added">  70 import sun.awt.AWTAccessor;</span>
<span class="line-added">  71 import sun.awt.PaintEventDispatcher;</span>
<span class="line-added">  72 import sun.awt.RepaintArea;</span>
<span class="line-added">  73 import sun.awt.SunToolkit;</span>
  74 import sun.awt.event.IgnorePaintEvent;

  75 import sun.awt.image.SunVolatileImage;


  76 import sun.java2d.SunGraphics2D;
  77 import sun.java2d.opengl.OGLRenderQueue;
  78 import sun.java2d.pipe.Region;

  79 import sun.util.logging.PlatformLogger;
  80 






  81 public abstract class LWComponentPeer&lt;T extends Component, D extends JComponent&gt;
  82     implements ComponentPeer, DropTargetPeer
  83 {
  84     private static final PlatformLogger focusLog = PlatformLogger.getLogger(&quot;sun.lwawt.focus.LWComponentPeer&quot;);
  85 
  86     /**
  87      * State lock is to be used for modifications to this peer&#39;s fields (e.g.
  88      * bounds, background, font, etc.) It should be the last lock in the lock
  89      * chain
  90      */
  91     private final Object stateLock = new Object();
  92 
  93     /**
  94      * The lock to operate with the peers hierarchy. AWT tree lock is not used
  95      * as there are many peers related ops to be done on the toolkit thread, and
  96      * we don&#39;t want to depend on a public lock on this thread
  97      */
  98     private static final Object peerTreeLock = new Object();
  99 
 100     /**
</pre>
<hr />
<pre>
 973                                       parentWindow.isFocused());
 974                     }
 975                     LWKeyboardFocusManagerPeer.removeLastFocusRequest(getTarget());
 976                     return false;
 977                 }
 978 
 979                 KeyboardFocusManagerPeer kfmPeer = LWKeyboardFocusManagerPeer.getInstance();
 980                 Component focusOwner = kfmPeer.getCurrentFocusOwner();
 981                 return LWKeyboardFocusManagerPeer.deliverFocus(lightweightChild,
 982                         getTarget(), temporary,
 983                         focusedWindowChangeAllowed,
 984                         time, cause, focusOwner);
 985 
 986             case LWKeyboardFocusManagerPeer.SNFH_SUCCESS_HANDLED:
 987                 return true;
 988         }
 989 
 990         return false;
 991     }
 992 





 993     @Override
 994     public final Image createImage(final int width, final int height) {
 995         return getLWGC().createAcceleratedImage(getTarget(), width, height);
 996     }
 997 
 998     @Override
 999     public final VolatileImage createVolatileImage(final int w, final int h) {
1000         return new SunVolatileImage(getTarget(), w, h);
1001     }
1002 












1003     @Override
1004     public boolean handlesWheelScrolling() {
1005         // TODO: not implemented
1006         return false;
1007     }
1008 
1009     @Override
1010     public final void applyShape(final Region shape) {
1011         synchronized (getStateLock()) {
1012             if (region == shape || (region != null &amp;&amp; region.equals(shape))) {
1013                 return;
1014             }
1015         }
1016         applyShapeImpl(shape);
1017     }
1018 
1019     void applyShapeImpl(final Region shape) {
1020         synchronized (getStateLock()) {
1021             if (shape != null) {
1022                 region = Region.WHOLE_REGION.getIntersection(shape);
</pre>
<hr />
<pre>
1084                     } else
1085                         System.err.println(&quot;CComponent.removeDropTarget(): current drop target is null.&quot;);
1086                 }
1087             }
1088         }
1089     }
1090 
1091     // ---- PEER NOTIFICATIONS ---- //
1092 
1093     /**
1094      * Called when this peer&#39;s location has been changed either as a result
1095      * of target.setLocation() or as a result of user actions (window is
1096      * dragged with mouse).
1097      *
1098      * This method could be called on the toolkit thread.
1099      */
1100     protected final void handleMove(final int x, final int y,
1101                                     final boolean updateTarget) {
1102         if (updateTarget) {
1103             AWTAccessor.getComponentAccessor().setLocation(getTarget(), x, y);
<span class="line-added">1104             postEvent(new ComponentEvent(getTarget(),</span>
<span class="line-added">1105                                          ComponentEvent.COMPONENT_MOVED));</span>
1106         }


1107     }
1108 
1109     /**
1110      * Called when this peer&#39;s size has been changed either as a result of
1111      * target.setSize() or as a result of user actions (window is resized).
1112      *
1113      * This method could be called on the toolkit thread.
1114      */
1115     protected final void handleResize(final int w, final int h,
1116                                       final boolean updateTarget) {
1117         Image oldBB = null;
1118         synchronized (getStateLock()) {
1119             if (backBuffer != null) {
1120                 oldBB = backBuffer;
1121                 backBuffer = getLWGC().createBackBuffer(this);
1122             }
1123         }
1124         getLWGC().destroyBackBuffer(oldBB);
1125 
1126         if (updateTarget) {
1127             AWTAccessor.getComponentAccessor().setSize(getTarget(), w, h);
<span class="line-added">1128             postEvent(new ComponentEvent(getTarget(),</span>
<span class="line-added">1129                                          ComponentEvent.COMPONENT_RESIZED));</span>
1130         }


1131     }
1132 
1133     protected final void repaintOldNewBounds(final Rectangle oldB) {
1134         repaintParent(oldB);
1135         repaintPeer(getSize());
1136     }
1137 
1138     protected final void repaintParent(final Rectangle oldB) {
1139         final LWContainerPeer&lt;?, ?&gt; cp = getContainerPeer();
1140         if (cp != null) {
1141             // Repaint unobscured part of the parent
1142             cp.repaintPeer(cp.getContentSize().intersection(oldB));
1143         }
1144     }
1145 
1146     // ---- EVENTS ---- //
1147 
1148     /**
1149      * Post an event to the proper Java EDT.
1150      */
</pre>
</td>
</tr>
</table>
<center><a href="../java2d/opengl/CGLVolatileSurfaceManager.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="LWLightweightFramePeer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>