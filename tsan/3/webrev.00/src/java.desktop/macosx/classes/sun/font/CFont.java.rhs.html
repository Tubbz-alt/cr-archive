<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/macosx/classes/sun/font/CFont.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2011, 2017, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.font;
 27 
 28 import java.awt.Font;
 29 import java.awt.font.FontRenderContext;
 30 import java.awt.geom.AffineTransform;
 31 import java.awt.geom.GeneralPath;
 32 import java.awt.geom.Point2D;
 33 import java.awt.geom.Rectangle2D;
 34 import java.util.ArrayList;
 35 
 36 // Right now this class is final to avoid a problem with native code.
 37 // For some reason the JNI IsInstanceOf was not working correctly
 38 // so we are checking the class specifically. If we subclass this
 39 // we need to modify the native code in CFontWrapper.m
 40 public final class CFont extends PhysicalFont implements FontSubstitution {
 41 
 42     /* CFontStrike doesn&#39;t call these methods so they are unimplemented.
 43      * They are here to meet the requirements of PhysicalFont, needed
 44      * because a CFont can sometimes be returned where a PhysicalFont
 45      * is expected.
 46      */
 47     StrikeMetrics getFontMetrics(long pScalerContext) {
 48        throw new InternalError(&quot;Not implemented&quot;);
 49     }
 50 
 51     float getGlyphAdvance(long pScalerContext, int glyphCode) {
 52        throw new InternalError(&quot;Not implemented&quot;);
 53     }
 54 
 55     void getGlyphMetrics(long pScalerContext, int glyphCode,
 56                                   Point2D.Float metrics) {
 57        throw new InternalError(&quot;Not implemented&quot;);
 58     }
 59 
 60     long getGlyphImage(long pScalerContext, int glyphCode) {
 61        throw new InternalError(&quot;Not implemented&quot;);
 62     }
 63 
 64     Rectangle2D.Float getGlyphOutlineBounds(long pScalerContext,
 65                                                      int glyphCode) {
 66        throw new InternalError(&quot;Not implemented&quot;);
 67     }
 68 
 69     GeneralPath getGlyphOutline(long pScalerContext, int glyphCode,
 70                                          float x, float y) {
 71        throw new InternalError(&quot;Not implemented&quot;);
 72     }
 73 
 74     GeneralPath getGlyphVectorOutline(long pScalerContext,
 75                                                int[] glyphs, int numGlyphs,
 76                                                float x, float y) {
 77        throw new InternalError(&quot;Not implemented&quot;);
 78     }
 79 
<a name="1" id="anc1"></a>




 80     @Override
 81     protected byte[] getTableBytes(int tag) {
 82         return getTableBytesNative(getNativeFontPtr(), tag);
 83     }
 84 
<a name="2" id="anc2"></a>

 85     private native byte[] getTableBytesNative(long nativeFontPtr, int tag);
 86 
 87     private static native long createNativeFont(final String nativeFontName,
 88                                                 final int style);
 89     private static native void disposeNativeFont(final long nativeFontPtr);
 90 
 91     private boolean isFakeItalic;
 92     private String nativeFontName;
 93     private long nativeFontPtr;
 94 
 95     private native float getWidthNative(final long nativeFontPtr);
 96     private native float getWeightNative(final long nativeFontPtr);
 97 
 98     private int fontWidth = -1;
 99     private int fontWeight = -1;
100 
101     @Override
102     public int getWidth() {
103         if (fontWidth == -1) {
104             // Apple use a range of -1 -&gt; +1, where 0.0 is normal
105             // OpenType uses a % range from 50% -&gt; 200% where 100% is normal
106             // and maps these onto the integer values 1-&gt;9.
107             // Since that is what Font2D.getWidth() expects, remap to that.
108             float fw = getWidthNative(getNativeFontPtr());
109             if (fw == 0.0) { // short cut the common case
110                 fontWidth = Font2D.FWIDTH_NORMAL;
111                 return fontWidth;
112             }
113             fw += 1.0; fw *= 100.0;
114             if (fw &lt;= 50.0) {
115                 fontWidth = 1;
116             } else if (fw &lt;= 62.5) {
117                 fontWidth = 2;
118             } else if (fw &lt;= 75.0) {
119                 fontWidth = 3;
120             } else if (fw &lt;= 87.5) {
121                 fontWidth = 4;
122             } else if (fw &lt;= 100.0) {
123                 fontWidth = 5;
124             } else if (fw &lt;= 112.5) {
125                 fontWidth = 6;
126             } else if (fw &lt;= 125.0) {
127                 fontWidth = 7;
128             } else if (fw &lt;= 150.0) {
129                 fontWidth = 8;
130             } else {
131                 fontWidth = 9;
132             }
133         }
134         return fontWidth;
135    }
136 
137     @Override
138     public int getWeight() {
139         if (fontWeight == -1) {
140             // Apple use a range of -1 -&gt; +1, where 0 is medium/regular
141             // Map this on to the OpenType range of 100-&gt;900 where
142             // 500 is medium/regular.
143             // We&#39;ll actually map to 0-&gt;1000 but that&#39;s close enough.
144             float fw = getWeightNative(getNativeFontPtr());
145             if (fw == 0) {
146                return Font2D.FWEIGHT_NORMAL;
147             }
148             fw += 1.0; fw *= 500;
149             fontWeight = (int)fw;
150           }
151           return fontWeight;
152     }
153 
154     // this constructor is called from CFontWrapper.m
155     public CFont(String name) {
156         this(name, name);
157     }
158 
159     public CFont(String name, String inFamilyName) {
160         handle = new Font2DHandle(this);
161         fullName = name;
162         familyName = inFamilyName;
163         nativeFontName = fullName;
164         setStyle();
165     }
166 
167     /* Called from CFontManager too */
168     public CFont(CFont other, String logicalFamilyName) {
169         handle = new Font2DHandle(this);
170         fullName = logicalFamilyName;
171         familyName = logicalFamilyName;
172         nativeFontName = other.nativeFontName;
173         style = other.style;
174         isFakeItalic = other.isFakeItalic;
175     }
176 
177     public CFont createItalicVariant() {
178         CFont font = new CFont(this, familyName);
179         font.nativeFontName = fullName;
180         font.fullName =
181             fullName + (style == Font.BOLD ? &quot;&quot; : &quot;-&quot;) + &quot;Italic-Derived&quot;;
182         font.style |= Font.ITALIC;
183         font.isFakeItalic = true;
184         return font;
185     }
186 
187     protected synchronized long getNativeFontPtr() {
188         if (nativeFontPtr == 0L) {
189             nativeFontPtr = createNativeFont(nativeFontName, style);
190         }
191         return nativeFontPtr;
192     }
193 
194     private native long getCGFontPtrNative(long ptr);
195 
196     // This digs the CGFont out of the AWTFont.
197     protected synchronized long getPlatformNativeFontPtr() {
198         return getCGFontPtrNative(getNativeFontPtr());
199     }
200 
201     static native void getCascadeList(long nativeFontPtr, ArrayList&lt;String&gt; listOfString);
202 
203     private CompositeFont createCompositeFont() {
204         ArrayList&lt;String&gt; listOfString = new ArrayList&lt;String&gt;();
205         getCascadeList(nativeFontPtr, listOfString);
206 
207         // In some italic cases the standard Mac cascade list is missing Arabic.
208         listOfString.add(&quot;GeezaPro&quot;);
209         FontManager fm = FontManagerFactory.getInstance();
210         int numFonts = 1 + listOfString.size();
211         PhysicalFont[] fonts = new PhysicalFont[numFonts];
212         fonts[0] = this;
213         int idx = 1;
214         for (String s : listOfString) {
215             if (s.equals(&quot;.AppleSymbolsFB&quot;))  {
216                 // Don&#39;t know why we get the weird name above .. replace.
217                 s = &quot;AppleSymbols&quot;;
218             }
219             Font2D f2d = fm.findFont2D(s, Font.PLAIN, FontManager.NO_FALLBACK);
220             if (f2d == null || f2d == this) {
221                 continue;
222             }
223             fonts[idx++] = (PhysicalFont)f2d;
224         }
225         if (idx &lt; fonts.length) {
226             PhysicalFont[] orig = fonts;
227             fonts = new PhysicalFont[idx];
228             System.arraycopy(orig, 0, fonts, 0, idx);
229         }
230         CompositeFont compFont = new CompositeFont(fonts);
231         compFont.mapper = new CCompositeGlyphMapper(compFont);
232         return compFont;
233     }
234 
235     private CompositeFont compFont;
236 
237     public CompositeFont getCompositeFont2D() {
238         if (compFont == null) {
239            compFont = createCompositeFont();
240         }
241         return compFont;
242     }
243 
244     @SuppressWarnings(&quot;deprecation&quot;)
245     protected synchronized void finalize() {
246         if (nativeFontPtr != 0) {
247             disposeNativeFont(nativeFontPtr);
248         }
249         nativeFontPtr = 0;
250     }
251 
252     protected CharToGlyphMapper getMapper() {
253         if (mapper == null) {
254             mapper = new CCharToGlyphMapper(this);
255         }
256         return mapper;
257     }
258 
259     protected FontStrike createStrike(FontStrikeDesc desc) {
260         if (isFakeItalic) {
261             desc = new FontStrikeDesc(desc);
262             desc.glyphTx.concatenate(AffineTransform.getShearInstance(-0.2, 0));
263         }
264         return new CStrike(this, desc);
265     }
266 
267     // &lt;rdar://problem/5321707&gt; sun.font.Font2D caches the last used strike,
268     // but does not check if the properties of the strike match the properties
269     // of the incoming java.awt.Font object (size, style, etc).
270     // Simple answer: don&#39;t cache.
271     private static FontRenderContext DEFAULT_FRC =
272         new FontRenderContext(null, false, false);
273     public FontStrike getStrike(final Font font) {
274         return getStrike(font, DEFAULT_FRC);
275     }
276 
277     public boolean equals(Object o) {
278          if (!super.equals(o)) {
279              return false;
280          }
281 
282          return ((Font2D)o).getStyle() == this.getStyle();
283     }
284 
285     public int hashCode() {
286         return super.hashCode() ^ this.getStyle();
287     }
288 
289     public String toString() {
290         return &quot;CFont { fullName: &quot; + fullName +
291             &quot;,  familyName: &quot; + familyName + &quot;, style: &quot; + style +
292             &quot; } aka: &quot; + super.toString();
293     }
294 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>