<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libjsound/PLATFORM_API_MacOSX_Ports.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../libawt_lwawt/java2d/opengl/CGLSurfaceData.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../libosxapp/NSApplicationAWT.m.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libjsound/PLATFORM_API_MacOSX_Ports.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
397     return TRUE;
398 }
399 
400 
401 // counts number of valid (non-NULL) elements in the array of AudioControls
402 static int ValidControlCount(AudioControl **arr, int offset, int len) {
403     int result = 0;
404     int end = offset + len;
405     for (int i=offset; i&lt;end; i++) {
406         if (arr[i] != NULL)
407             result++;
408     }
409     return result;
410 }
411 
412 // returns java control
413 static void* CreatePortControl(PortMixer *mixer, PortControlCreator *creator, PortControl::ControlType type,
414                                AudioControl **audioControls, int offset, int len) {
415     void *jControl = NULL;
416     PortControl *control = (PortControl *)calloc(1, sizeof(PortControl));



417     float precision = 0.01;
418 
419     control-&gt;type = type;
420     control-&gt;controlCount = len;
421     control-&gt;audioControls = (AudioControl **)malloc(len * sizeof(AudioControl *));




422     memcpy(control-&gt;audioControls, audioControls + offset, len * sizeof(AudioControl *));
423 
424     switch (control-&gt;type) {
425     case PortControl::Volume:
426         jControl = creator-&gt;newFloatControl(creator, control, CONTROL_TYPE_VOLUME, 0, 1, precision, &quot;&quot;);
427         break;
428     case PortControl::Mute:
429         jControl = creator-&gt;newBooleanControl(creator, control, CONTROL_TYPE_MUTE);
430         break;
431     case PortControl::Balance:
432         jControl = creator-&gt;newFloatControl(creator, control, CONTROL_TYPE_BALANCE, -1, 1, precision, &quot;&quot;);
433         break;
434     };
435 
436     if (jControl == NULL) {
437         ERROR0(&quot;CreatePortControl: javaControl was not created\n&quot;);
438         free(control-&gt;audioControls);
439         free(control);
440         return NULL;
441     }
</pre>
<hr />
<pre>
465         // deviceControlCount is overestimated
466         // because we don&#39;t actually filter by if the owned objects are controls
467         err = GetAudioObjectPropertySize(mixer-&gt;deviceID, kAudioObjectPropertyScopeGlobal,
468             kAudioObjectPropertyOwnedObjects, &amp;size);
469 
470         if (err) {
471             OS_ERROR1(err, &quot;PORT_GetControls (portIndex = %d) get OwnedObject size&quot;, portIndex);
472         } else {
473             mixer-&gt;deviceControlCount = size / sizeof(AudioObjectID);
474             TRACE1(&quot;  PORT_GetControls: detected %d owned objects\n&quot;, mixer-&gt;deviceControlCount);
475 
476             AudioObjectID controlIDs[mixer-&gt;deviceControlCount];
477 
478             err = GetAudioObjectProperty(mixer-&gt;deviceID, kAudioObjectPropertyScopeGlobal,
479                 kAudioObjectPropertyOwnedObjects, sizeof(controlIDs), controlIDs, 1);
480 
481             if (err) {
482                 OS_ERROR1(err, &quot;PORT_GetControls (portIndex = %d) get OwnedObject values&quot;, portIndex);
483             } else {
484                 mixer-&gt;deviceControls = (AudioControl *)calloc(mixer-&gt;deviceControlCount, sizeof(AudioControl));



485 
486                 for (int i = 0; i &lt; mixer-&gt;deviceControlCount; i++) {
487                     AudioControl *control = &amp;mixer-&gt;deviceControls[i];
488 
489                     control-&gt;controlID = controlIDs[i];
490 
491                     OSStatus err1 = GetAudioObjectProperty(control-&gt;controlID, kAudioObjectPropertyScopeGlobal,
492                         kAudioObjectPropertyClass, sizeof(control-&gt;classID), &amp;control-&gt;classID, 1);
493                     OSStatus err2 = GetAudioObjectProperty(control-&gt;controlID, kAudioObjectPropertyScopeGlobal,
494                         kAudioControlPropertyScope, sizeof(control-&gt;scope), &amp;control-&gt;scope, 1);
495                     OSStatus err3 = GetAudioObjectProperty(control-&gt;controlID, kAudioObjectPropertyScopeGlobal,
496                         kAudioControlPropertyElement, sizeof(control-&gt;channel), &amp;control-&gt;channel, 1);
497                     if (err1 || err2 || err3) { // not a control or other error
498                         control-&gt;classID = 0;
499                         continue;
500                     }
501 
502                     TRACE4(&quot;- control 0x%x, class=&#39;%s&#39;, scope=&#39;%s&#39;, channel=%d\n&quot;,
503                         control-&gt;controlID, FourCC2Str(control-&gt;classID), FourCC2Str(control-&gt;scope), control-&gt;channel);
504                 }
</pre>
<hr />
<pre>
598     if (masterMute != NULL) {
599         creator-&gt;addControl(creator, masterMute);
600     }
601 
602     // don&#39;t add per-channel controls for mono &amp; stereo - they are handled by &quot;master&quot; controls
603     // TODO: this should be reviewed to handle controls other than mute &amp; volume
604     if (totalChannels &gt; 2) {
605         // add separate compound control for each channel (containing volume and mute)
606         // (ensure that we have controls)
607         if (ValidControlCount(volumeControls, 1, totalChannels) &gt; 0 || ValidControlCount(muteControls, 1, totalChannels) &gt; 0) {
608             for (int ch=1; ch&lt;=totalChannels; ch++) {
609                 // get the channel name
610                 char *channelName;
611                 CFStringRef cfname = NULL;
612                 const AudioObjectPropertyAddress address = {kAudioObjectPropertyElementName, port-&gt;scope, (unsigned)ch};
613                 UInt32 size = sizeof(cfname);
614                 OSStatus err = AudioObjectGetPropertyData(mixer-&gt;deviceID, &amp;address, 0, NULL, &amp;size, &amp;cfname);
615                 if (err == noErr) {
616                     CFIndex length = CFStringGetLength(cfname) + 1;
617                     channelName = (char *)malloc(length);



618                     CFStringGetCString(cfname, channelName, length, kCFStringEncodingUTF8);
619                     CFRelease(cfname);
620                 } else {
621                     channelName = (char *)malloc(16);



622                     sprintf(channelName, &quot;Ch %d&quot;, ch);
623                 }
624 
625                 void* jControls[2];
626                 int controlCount = 0;
627                 if (volumeControls[ch] != NULL) {
628                     jControls[controlCount++] = CreatePortControl(mixer, creator, PortControl::Volume, volumeControls, ch, 1);
629                 }
630                 if (muteControls[ch] != NULL) {
631                     jControls[controlCount++] = CreatePortControl(mixer, creator, PortControl::Mute, muteControls, ch, 1);
632                 }
633                 // TODO: add any extra controls for &quot;other&quot; controls for the channel
634 
635                 void *compoundControl = creator-&gt;newCompoundControl(creator, channelName, jControls, controlCount);
636                 creator-&gt;addControl(creator, compoundControl);
637 
638                 free(channelName);
639             }
640         }
641     }
</pre>
</td>
<td>
<hr />
<pre>
397     return TRUE;
398 }
399 
400 
401 // counts number of valid (non-NULL) elements in the array of AudioControls
402 static int ValidControlCount(AudioControl **arr, int offset, int len) {
403     int result = 0;
404     int end = offset + len;
405     for (int i=offset; i&lt;end; i++) {
406         if (arr[i] != NULL)
407             result++;
408     }
409     return result;
410 }
411 
412 // returns java control
413 static void* CreatePortControl(PortMixer *mixer, PortControlCreator *creator, PortControl::ControlType type,
414                                AudioControl **audioControls, int offset, int len) {
415     void *jControl = NULL;
416     PortControl *control = (PortControl *)calloc(1, sizeof(PortControl));
<span class="line-added">417     if (control == NULL) {</span>
<span class="line-added">418         return NULL;</span>
<span class="line-added">419     }</span>
420     float precision = 0.01;
421 
422     control-&gt;type = type;
423     control-&gt;controlCount = len;
424     control-&gt;audioControls = (AudioControl **)malloc(len * sizeof(AudioControl *));
<span class="line-added">425     if (control-&gt;audioControls == NULL) {</span>
<span class="line-added">426         free(control);</span>
<span class="line-added">427         return NULL;</span>
<span class="line-added">428     }</span>
429     memcpy(control-&gt;audioControls, audioControls + offset, len * sizeof(AudioControl *));
430 
431     switch (control-&gt;type) {
432     case PortControl::Volume:
433         jControl = creator-&gt;newFloatControl(creator, control, CONTROL_TYPE_VOLUME, 0, 1, precision, &quot;&quot;);
434         break;
435     case PortControl::Mute:
436         jControl = creator-&gt;newBooleanControl(creator, control, CONTROL_TYPE_MUTE);
437         break;
438     case PortControl::Balance:
439         jControl = creator-&gt;newFloatControl(creator, control, CONTROL_TYPE_BALANCE, -1, 1, precision, &quot;&quot;);
440         break;
441     };
442 
443     if (jControl == NULL) {
444         ERROR0(&quot;CreatePortControl: javaControl was not created\n&quot;);
445         free(control-&gt;audioControls);
446         free(control);
447         return NULL;
448     }
</pre>
<hr />
<pre>
472         // deviceControlCount is overestimated
473         // because we don&#39;t actually filter by if the owned objects are controls
474         err = GetAudioObjectPropertySize(mixer-&gt;deviceID, kAudioObjectPropertyScopeGlobal,
475             kAudioObjectPropertyOwnedObjects, &amp;size);
476 
477         if (err) {
478             OS_ERROR1(err, &quot;PORT_GetControls (portIndex = %d) get OwnedObject size&quot;, portIndex);
479         } else {
480             mixer-&gt;deviceControlCount = size / sizeof(AudioObjectID);
481             TRACE1(&quot;  PORT_GetControls: detected %d owned objects\n&quot;, mixer-&gt;deviceControlCount);
482 
483             AudioObjectID controlIDs[mixer-&gt;deviceControlCount];
484 
485             err = GetAudioObjectProperty(mixer-&gt;deviceID, kAudioObjectPropertyScopeGlobal,
486                 kAudioObjectPropertyOwnedObjects, sizeof(controlIDs), controlIDs, 1);
487 
488             if (err) {
489                 OS_ERROR1(err, &quot;PORT_GetControls (portIndex = %d) get OwnedObject values&quot;, portIndex);
490             } else {
491                 mixer-&gt;deviceControls = (AudioControl *)calloc(mixer-&gt;deviceControlCount, sizeof(AudioControl));
<span class="line-added">492                 if (mixer-&gt;deviceControls == NULL) {</span>
<span class="line-added">493                     return;</span>
<span class="line-added">494                 }</span>
495 
496                 for (int i = 0; i &lt; mixer-&gt;deviceControlCount; i++) {
497                     AudioControl *control = &amp;mixer-&gt;deviceControls[i];
498 
499                     control-&gt;controlID = controlIDs[i];
500 
501                     OSStatus err1 = GetAudioObjectProperty(control-&gt;controlID, kAudioObjectPropertyScopeGlobal,
502                         kAudioObjectPropertyClass, sizeof(control-&gt;classID), &amp;control-&gt;classID, 1);
503                     OSStatus err2 = GetAudioObjectProperty(control-&gt;controlID, kAudioObjectPropertyScopeGlobal,
504                         kAudioControlPropertyScope, sizeof(control-&gt;scope), &amp;control-&gt;scope, 1);
505                     OSStatus err3 = GetAudioObjectProperty(control-&gt;controlID, kAudioObjectPropertyScopeGlobal,
506                         kAudioControlPropertyElement, sizeof(control-&gt;channel), &amp;control-&gt;channel, 1);
507                     if (err1 || err2 || err3) { // not a control or other error
508                         control-&gt;classID = 0;
509                         continue;
510                     }
511 
512                     TRACE4(&quot;- control 0x%x, class=&#39;%s&#39;, scope=&#39;%s&#39;, channel=%d\n&quot;,
513                         control-&gt;controlID, FourCC2Str(control-&gt;classID), FourCC2Str(control-&gt;scope), control-&gt;channel);
514                 }
</pre>
<hr />
<pre>
608     if (masterMute != NULL) {
609         creator-&gt;addControl(creator, masterMute);
610     }
611 
612     // don&#39;t add per-channel controls for mono &amp; stereo - they are handled by &quot;master&quot; controls
613     // TODO: this should be reviewed to handle controls other than mute &amp; volume
614     if (totalChannels &gt; 2) {
615         // add separate compound control for each channel (containing volume and mute)
616         // (ensure that we have controls)
617         if (ValidControlCount(volumeControls, 1, totalChannels) &gt; 0 || ValidControlCount(muteControls, 1, totalChannels) &gt; 0) {
618             for (int ch=1; ch&lt;=totalChannels; ch++) {
619                 // get the channel name
620                 char *channelName;
621                 CFStringRef cfname = NULL;
622                 const AudioObjectPropertyAddress address = {kAudioObjectPropertyElementName, port-&gt;scope, (unsigned)ch};
623                 UInt32 size = sizeof(cfname);
624                 OSStatus err = AudioObjectGetPropertyData(mixer-&gt;deviceID, &amp;address, 0, NULL, &amp;size, &amp;cfname);
625                 if (err == noErr) {
626                     CFIndex length = CFStringGetLength(cfname) + 1;
627                     channelName = (char *)malloc(length);
<span class="line-added">628                     if (channelName == NULL) {</span>
<span class="line-added">629                         return;</span>
<span class="line-added">630                     }</span>
631                     CFStringGetCString(cfname, channelName, length, kCFStringEncodingUTF8);
632                     CFRelease(cfname);
633                 } else {
634                     channelName = (char *)malloc(16);
<span class="line-added">635                     if (channelName == NULL) {</span>
<span class="line-added">636                         return;</span>
<span class="line-added">637                     }</span>
638                     sprintf(channelName, &quot;Ch %d&quot;, ch);
639                 }
640 
641                 void* jControls[2];
642                 int controlCount = 0;
643                 if (volumeControls[ch] != NULL) {
644                     jControls[controlCount++] = CreatePortControl(mixer, creator, PortControl::Volume, volumeControls, ch, 1);
645                 }
646                 if (muteControls[ch] != NULL) {
647                     jControls[controlCount++] = CreatePortControl(mixer, creator, PortControl::Mute, muteControls, ch, 1);
648                 }
649                 // TODO: add any extra controls for &quot;other&quot; controls for the channel
650 
651                 void *compoundControl = creator-&gt;newCompoundControl(creator, channelName, jControls, controlCount);
652                 creator-&gt;addControl(creator, compoundControl);
653 
654                 free(channelName);
655             }
656         }
657     }
</pre>
</td>
</tr>
</table>
<center><a href="../libawt_lwawt/java2d/opengl/CGLSurfaceData.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../libosxapp/NSApplicationAWT.m.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>