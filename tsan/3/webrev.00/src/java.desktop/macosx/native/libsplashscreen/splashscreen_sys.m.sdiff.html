<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libsplashscreen/splashscreen_sys.m</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../libosxapp/NSApplicationAWT.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../share/classes/com/sun/accessibility/internal/resources/accessibility.properties.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libsplashscreen/splashscreen_sys.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;splashscreen_impl.h&quot;
 27 
 28 #import &lt;Cocoa/Cocoa.h&gt;
 29 #import &lt;objc/objc-auto.h&gt;
 30 

 31 #import &lt;JavaNativeFoundation/JavaNativeFoundation.h&gt;
 32 #import &quot;NSApplicationAWT.h&quot;
 33 
 34 #include &lt;sys/time.h&gt;
 35 #include &lt;pthread.h&gt;
 36 #include &lt;iconv.h&gt;
 37 #include &lt;langinfo.h&gt;
 38 #include &lt;locale.h&gt;
 39 #include &lt;fcntl.h&gt;
 40 #include &lt;poll.h&gt;
 41 #include &lt;errno.h&gt;
 42 #include &lt;sys/types.h&gt;
 43 #include &lt;signal.h&gt;
 44 #include &lt;unistd.h&gt;
 45 #include &lt;dlfcn.h&gt;
 46 
 47 #include &lt;sizecalc.h&gt;
 48 #import &quot;ThreadUtilities.h&quot;
 49 
 50 NSString* findScaledImageName(NSString *fileName,
</pre>
<hr />
<pre>
167         if(![[NSFileManager defaultManager]
168                 fileExistsAtPath: fileName2x]) {
169             fileName2x = findScaledImageName(fileName, dotIndex, @&quot;@200pct&quot;);
170         }
171         if (jar || [[NSFileManager defaultManager]
172                 fileExistsAtPath: fileName2x]){
173             if (strlen([fileName2x UTF8String]) &gt; scaledImageLength) {
174                 [pool drain];
175                 return JNI_FALSE;
176             }
177             *scaleFactor = 2;
178             strcpy(scaledFile, [fileName2x UTF8String]);
179             [pool drain];
180             return JNI_TRUE;
181         }
182     }
183     [pool drain];
184     return JNI_FALSE;
185 }
186 
<span class="line-modified">187 void</span>




















188 SplashInitPlatform(Splash * splash) {



189     pthread_mutex_init(&amp;splash-&gt;lock, NULL);
190 
191     splash-&gt;maskRequired = 0;
192 
<span class="line-modified">193     </span>
194     //TODO: the following is too much of a hack but should work in 90% cases.
195     //      besides we don&#39;t use device-dependent drawing, so probably
196     //      that&#39;s very fine indeed
197     splash-&gt;byteAlignment = 1;
198     initFormat(&amp;splash-&gt;screenFormat, 0xff &lt;&lt; 8,
199             0xff &lt;&lt; 16, 0xff &lt;&lt; 24, 0xff &lt;&lt; 0);
200     splash-&gt;screenFormat.byteOrder = 1 ?  BYTE_ORDER_LSBFIRST : BYTE_ORDER_MSBFIRST;
201     splash-&gt;screenFormat.depthBytes = 4;
202 
203     // If we are running SWT we should not start a runLoop
204     if (!isSWTRunning()) {
205         [JNFRunLoop performOnMainThreadWaiting:NO withBlock:^() {
206             [NSApplicationAWT runAWTLoopWithApp:[NSApplicationAWT sharedApplication]];
207         }];
208     }

209 }
210 
211 void
212 SplashCleanupPlatform(Splash * splash) {
213     splash-&gt;maskRequired = 0;
214 }
215 
216 void
217 SplashDonePlatform(Splash * splash) {
218     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
219 
220     pthread_mutex_destroy(&amp;splash-&gt;lock);
221     [JNFRunLoop performOnMainThreadWaiting:YES withBlock:^(){
222         if (splash-&gt;window) {
223             [splash-&gt;window orderOut:nil];
224             [splash-&gt;window release];
225         }
226     }];
227     [pool drain];
228 }
</pre>
<hr />
<pre>
240 void
241 SplashInitFrameShape(Splash * splash, int imageIndex) {
242     // No shapes, we rely on alpha compositing
243 }
244 
245 void * SplashScreenThread(void *param);
246 void
247 SplashCreateThread(Splash * splash) {
248     pthread_t thr;
249     pthread_attr_t attr;
250     int rc;
251 
252     pthread_attr_init(&amp;attr);
253     rc = pthread_create(&amp;thr, &amp;attr, SplashScreenThread, (void *) splash);
254 }
255 
256 void
257 SplashRedrawWindow(Splash * splash) {
258     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
259 
<span class="line-removed">260     SplashUpdateScreenData(splash);</span>
<span class="line-removed">261 </span>
262     [JNFRunLoop performOnMainThreadWaiting:YES withBlock:^(){




263         // NSDeviceRGBColorSpace vs. NSCalibratedRGBColorSpace ?
264         NSBitmapImageRep * rep = [[NSBitmapImageRep alloc]
265             initWithBitmapDataPlanes: (unsigned char**)&amp;splash-&gt;screenData
266                           pixelsWide: splash-&gt;width
267                           pixelsHigh: splash-&gt;height
268                        bitsPerSample: 8
269                      samplesPerPixel: 4
270                             hasAlpha: YES
271                             isPlanar: NO
272                       colorSpaceName: NSDeviceRGBColorSpace
273                         bitmapFormat: NSAlphaFirstBitmapFormat | NSAlphaNonpremultipliedBitmapFormat
274                          bytesPerRow: splash-&gt;width * 4
275                         bitsPerPixel: 32];
276 
277         NSImage * image = [[NSImage alloc]
278             initWithSize: NSMakeSize(splash-&gt;width, splash-&gt;height)];
279         [image setBackgroundColor: [NSColor clearColor]];
280 
281         [image addRepresentation: rep];
282         float scaleFactor = splash-&gt;scaleFactor;
283         if (scaleFactor &gt; 0 &amp;&amp; scaleFactor != 1) {
284             NSSize size = [image size];
285             size.width /= scaleFactor;
286             size.height /= scaleFactor;
287             [image setSize: size];
288         }
<span class="line-modified">289         </span>
290         NSImageView * view = [[NSImageView alloc] init];
291 
292         [view setImage: image];
293         [view setEditable: NO];
294         //NOTE: we don&#39;t set a &#39;wait cursor&#39; for the view because:
295         //      1. The Cocoa GUI guidelines suggest to avoid it, and use a progress
296         //         bar instead.
297         //      2. There simply isn&#39;t an instance of NSCursor that represent
298         //         the &#39;wait cursor&#39;. So that is undoable.
299 
300         //TODO: only the first image in an animated gif preserves transparency.
301         //      Loos like the splash-&gt;screenData contains inappropriate data
302         //      for all but the first frame.
303 
304         [image release];
305         [rep release];
306 
307         [splash-&gt;window setContentView: view];
308         [splash-&gt;window orderFrontRegardless];
309     }];
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &quot;splashscreen_impl.h&quot;
 27 
 28 #import &lt;Cocoa/Cocoa.h&gt;
 29 #import &lt;objc/objc-auto.h&gt;
 30 
<span class="line-added"> 31 #include &lt;Security/AuthSession.h&gt;</span>
 32 #import &lt;JavaNativeFoundation/JavaNativeFoundation.h&gt;
 33 #import &quot;NSApplicationAWT.h&quot;
 34 
 35 #include &lt;sys/time.h&gt;
 36 #include &lt;pthread.h&gt;
 37 #include &lt;iconv.h&gt;
 38 #include &lt;langinfo.h&gt;
 39 #include &lt;locale.h&gt;
 40 #include &lt;fcntl.h&gt;
 41 #include &lt;poll.h&gt;
 42 #include &lt;errno.h&gt;
 43 #include &lt;sys/types.h&gt;
 44 #include &lt;signal.h&gt;
 45 #include &lt;unistd.h&gt;
 46 #include &lt;dlfcn.h&gt;
 47 
 48 #include &lt;sizecalc.h&gt;
 49 #import &quot;ThreadUtilities.h&quot;
 50 
 51 NSString* findScaledImageName(NSString *fileName,
</pre>
<hr />
<pre>
168         if(![[NSFileManager defaultManager]
169                 fileExistsAtPath: fileName2x]) {
170             fileName2x = findScaledImageName(fileName, dotIndex, @&quot;@200pct&quot;);
171         }
172         if (jar || [[NSFileManager defaultManager]
173                 fileExistsAtPath: fileName2x]){
174             if (strlen([fileName2x UTF8String]) &gt; scaledImageLength) {
175                 [pool drain];
176                 return JNI_FALSE;
177             }
178             *scaleFactor = 2;
179             strcpy(scaledFile, [fileName2x UTF8String]);
180             [pool drain];
181             return JNI_TRUE;
182         }
183     }
184     [pool drain];
185     return JNI_FALSE;
186 }
187 
<span class="line-modified">188 static int isInAquaSession() {</span>
<span class="line-added">189     // environment variable to bypass the aqua session check</span>
<span class="line-added">190     char *ev = getenv(&quot;AWT_FORCE_HEADFUL&quot;);</span>
<span class="line-added">191     if (ev &amp;&amp; (strncasecmp(ev, &quot;true&quot;, 4) == 0)) {</span>
<span class="line-added">192         // if &quot;true&quot; then tell the caller we&#39;re in</span>
<span class="line-added">193         // an Aqua session without actually checking</span>
<span class="line-added">194         return 1;</span>
<span class="line-added">195     }</span>
<span class="line-added">196     // Is the WindowServer available?</span>
<span class="line-added">197     SecuritySessionId session_id;</span>
<span class="line-added">198     SessionAttributeBits session_info;</span>
<span class="line-added">199     OSStatus status = SessionGetInfo(callerSecuritySession, &amp;session_id, &amp;session_info);</span>
<span class="line-added">200     if (status == noErr) {</span>
<span class="line-added">201         if (session_info &amp; sessionHasGraphicAccess) {</span>
<span class="line-added">202             return 1;</span>
<span class="line-added">203         }</span>
<span class="line-added">204     }</span>
<span class="line-added">205     return 0;</span>
<span class="line-added">206 }</span>
<span class="line-added">207 </span>
<span class="line-added">208 int</span>
209 SplashInitPlatform(Splash * splash) {
<span class="line-added">210     if (!isInAquaSession()) {</span>
<span class="line-added">211         return 0;</span>
<span class="line-added">212     }</span>
213     pthread_mutex_init(&amp;splash-&gt;lock, NULL);
214 
215     splash-&gt;maskRequired = 0;
216 
<span class="line-modified">217 </span>
218     //TODO: the following is too much of a hack but should work in 90% cases.
219     //      besides we don&#39;t use device-dependent drawing, so probably
220     //      that&#39;s very fine indeed
221     splash-&gt;byteAlignment = 1;
222     initFormat(&amp;splash-&gt;screenFormat, 0xff &lt;&lt; 8,
223             0xff &lt;&lt; 16, 0xff &lt;&lt; 24, 0xff &lt;&lt; 0);
224     splash-&gt;screenFormat.byteOrder = 1 ?  BYTE_ORDER_LSBFIRST : BYTE_ORDER_MSBFIRST;
225     splash-&gt;screenFormat.depthBytes = 4;
226 
227     // If we are running SWT we should not start a runLoop
228     if (!isSWTRunning()) {
229         [JNFRunLoop performOnMainThreadWaiting:NO withBlock:^() {
230             [NSApplicationAWT runAWTLoopWithApp:[NSApplicationAWT sharedApplication]];
231         }];
232     }
<span class="line-added">233     return 1;</span>
234 }
235 
236 void
237 SplashCleanupPlatform(Splash * splash) {
238     splash-&gt;maskRequired = 0;
239 }
240 
241 void
242 SplashDonePlatform(Splash * splash) {
243     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
244 
245     pthread_mutex_destroy(&amp;splash-&gt;lock);
246     [JNFRunLoop performOnMainThreadWaiting:YES withBlock:^(){
247         if (splash-&gt;window) {
248             [splash-&gt;window orderOut:nil];
249             [splash-&gt;window release];
250         }
251     }];
252     [pool drain];
253 }
</pre>
<hr />
<pre>
265 void
266 SplashInitFrameShape(Splash * splash, int imageIndex) {
267     // No shapes, we rely on alpha compositing
268 }
269 
270 void * SplashScreenThread(void *param);
271 void
272 SplashCreateThread(Splash * splash) {
273     pthread_t thr;
274     pthread_attr_t attr;
275     int rc;
276 
277     pthread_attr_init(&amp;attr);
278     rc = pthread_create(&amp;thr, &amp;attr, SplashScreenThread, (void *) splash);
279 }
280 
281 void
282 SplashRedrawWindow(Splash * splash) {
283     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
284 


285     [JNFRunLoop performOnMainThreadWaiting:YES withBlock:^(){
<span class="line-added">286         // drop the reference to the old view and image</span>
<span class="line-added">287         [splash-&gt;window setContentView: nil];</span>
<span class="line-added">288         SplashUpdateScreenData(splash);</span>
<span class="line-added">289 </span>
290         // NSDeviceRGBColorSpace vs. NSCalibratedRGBColorSpace ?
291         NSBitmapImageRep * rep = [[NSBitmapImageRep alloc]
292             initWithBitmapDataPlanes: (unsigned char**)&amp;splash-&gt;screenData
293                           pixelsWide: splash-&gt;width
294                           pixelsHigh: splash-&gt;height
295                        bitsPerSample: 8
296                      samplesPerPixel: 4
297                             hasAlpha: YES
298                             isPlanar: NO
299                       colorSpaceName: NSDeviceRGBColorSpace
300                         bitmapFormat: NSAlphaFirstBitmapFormat | NSAlphaNonpremultipliedBitmapFormat
301                          bytesPerRow: splash-&gt;width * 4
302                         bitsPerPixel: 32];
303 
304         NSImage * image = [[NSImage alloc]
305             initWithSize: NSMakeSize(splash-&gt;width, splash-&gt;height)];
306         [image setBackgroundColor: [NSColor clearColor]];
307 
308         [image addRepresentation: rep];
309         float scaleFactor = splash-&gt;scaleFactor;
310         if (scaleFactor &gt; 0 &amp;&amp; scaleFactor != 1) {
311             NSSize size = [image size];
312             size.width /= scaleFactor;
313             size.height /= scaleFactor;
314             [image setSize: size];
315         }
<span class="line-modified">316 </span>
317         NSImageView * view = [[NSImageView alloc] init];
318 
319         [view setImage: image];
320         [view setEditable: NO];
321         //NOTE: we don&#39;t set a &#39;wait cursor&#39; for the view because:
322         //      1. The Cocoa GUI guidelines suggest to avoid it, and use a progress
323         //         bar instead.
324         //      2. There simply isn&#39;t an instance of NSCursor that represent
325         //         the &#39;wait cursor&#39;. So that is undoable.
326 
327         //TODO: only the first image in an animated gif preserves transparency.
328         //      Loos like the splash-&gt;screenData contains inappropriate data
329         //      for all but the first frame.
330 
331         [image release];
332         [rep release];
333 
334         [splash-&gt;window setContentView: view];
335         [splash-&gt;window orderFrontRegardless];
336     }];
</pre>
</td>
</tr>
</table>
<center><a href="../libosxapp/NSApplicationAWT.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../share/classes/com/sun/accessibility/internal/resources/accessibility.properties.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>