<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/macosx/native/libsplashscreen/splashscreen_sys.m</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../libosxapp/NSApplicationAWT.m.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../share/classes/com/sun/accessibility/internal/resources/accessibility.properties.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libsplashscreen/splashscreen_sys.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -26,10 +26,11 @@</span>
  #include &quot;splashscreen_impl.h&quot;
  
  #import &lt;Cocoa/Cocoa.h&gt;
  #import &lt;objc/objc-auto.h&gt;
  
<span class="udiff-line-added">+ #include &lt;Security/AuthSession.h&gt;</span>
  #import &lt;JavaNativeFoundation/JavaNativeFoundation.h&gt;
  #import &quot;NSApplicationAWT.h&quot;
  
  #include &lt;sys/time.h&gt;
  #include &lt;pthread.h&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -182,17 +183,40 @@</span>
      }
      [pool drain];
      return JNI_FALSE;
  }
  
<span class="udiff-line-modified-removed">- void</span>
<span class="udiff-line-modified-added">+ static int isInAquaSession() {</span>
<span class="udiff-line-added">+     // environment variable to bypass the aqua session check</span>
<span class="udiff-line-added">+     char *ev = getenv(&quot;AWT_FORCE_HEADFUL&quot;);</span>
<span class="udiff-line-added">+     if (ev &amp;&amp; (strncasecmp(ev, &quot;true&quot;, 4) == 0)) {</span>
<span class="udiff-line-added">+         // if &quot;true&quot; then tell the caller we&#39;re in</span>
<span class="udiff-line-added">+         // an Aqua session without actually checking</span>
<span class="udiff-line-added">+         return 1;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     // Is the WindowServer available?</span>
<span class="udiff-line-added">+     SecuritySessionId session_id;</span>
<span class="udiff-line-added">+     SessionAttributeBits session_info;</span>
<span class="udiff-line-added">+     OSStatus status = SessionGetInfo(callerSecuritySession, &amp;session_id, &amp;session_info);</span>
<span class="udiff-line-added">+     if (status == noErr) {</span>
<span class="udiff-line-added">+         if (session_info &amp; sessionHasGraphicAccess) {</span>
<span class="udiff-line-added">+             return 1;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return 0;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ int</span>
  SplashInitPlatform(Splash * splash) {
<span class="udiff-line-added">+     if (!isInAquaSession()) {</span>
<span class="udiff-line-added">+         return 0;</span>
<span class="udiff-line-added">+     }</span>
      pthread_mutex_init(&amp;splash-&gt;lock, NULL);
  
      splash-&gt;maskRequired = 0;
  
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
      //TODO: the following is too much of a hack but should work in 90% cases.
      //      besides we don&#39;t use device-dependent drawing, so probably
      //      that&#39;s very fine indeed
      splash-&gt;byteAlignment = 1;
      initFormat(&amp;splash-&gt;screenFormat, 0xff &lt;&lt; 8,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -204,10 +228,11 @@</span>
      if (!isSWTRunning()) {
          [JNFRunLoop performOnMainThreadWaiting:NO withBlock:^() {
              [NSApplicationAWT runAWTLoopWithApp:[NSApplicationAWT sharedApplication]];
          }];
      }
<span class="udiff-line-added">+     return 1;</span>
  }
  
  void
  SplashCleanupPlatform(Splash * splash) {
      splash-&gt;maskRequired = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -255,13 +280,15 @@</span>
  
  void
  SplashRedrawWindow(Splash * splash) {
      NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
  
<span class="udiff-line-removed">-     SplashUpdateScreenData(splash);</span>
<span class="udiff-line-removed">- </span>
      [JNFRunLoop performOnMainThreadWaiting:YES withBlock:^(){
<span class="udiff-line-added">+         // drop the reference to the old view and image</span>
<span class="udiff-line-added">+         [splash-&gt;window setContentView: nil];</span>
<span class="udiff-line-added">+         SplashUpdateScreenData(splash);</span>
<span class="udiff-line-added">+ </span>
          // NSDeviceRGBColorSpace vs. NSCalibratedRGBColorSpace ?
          NSBitmapImageRep * rep = [[NSBitmapImageRep alloc]
              initWithBitmapDataPlanes: (unsigned char**)&amp;splash-&gt;screenData
                            pixelsWide: splash-&gt;width
                            pixelsHigh: splash-&gt;height
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -284,11 +311,11 @@</span>
              NSSize size = [image size];
              size.width /= scaleFactor;
              size.height /= scaleFactor;
              [image setSize: size];
          }
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-added">+ </span>
          NSImageView * view = [[NSImageView alloc] init];
  
          [view setImage: image];
          [view setEditable: NO];
          //NOTE: we don&#39;t set a &#39;wait cursor&#39; for the view because:
</pre>
<center><a href="../libosxapp/NSApplicationAWT.m.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../share/classes/com/sun/accessibility/internal/resources/accessibility.properties.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>