<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libawt_lwawt/java2d/opengl/CGLLayer.m</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="CGLLayer.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CGLSurfaceData.m.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libawt_lwawt/java2d/opengl/CGLLayer.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #import &quot;CGLGraphicsConfig.h&quot;
 27 #import &quot;CGLLayer.h&quot;
 28 #import &quot;ThreadUtilities.h&quot;
 29 #import &quot;LWCToolkit.h&quot;
 30 #import &quot;CGLSurfaceData.h&quot;
 31 
 32 
 33 extern NSOpenGLPixelFormat *sharedPixelFormat;
 34 extern NSOpenGLContext *sharedContext;
 35 
 36 @implementation CGLLayer
 37 
 38 @synthesize javaLayer;
 39 @synthesize textureID;
 40 @synthesize target;
 41 @synthesize textureWidth;
 42 @synthesize textureHeight;
<span class="line-removed"> 43 #ifdef REMOTELAYER</span>
<span class="line-removed"> 44 @synthesize parentLayer;</span>
<span class="line-removed"> 45 @synthesize remoteLayer;</span>
<span class="line-removed"> 46 @synthesize jrsRemoteLayer;</span>
<span class="line-removed"> 47 #endif</span>
 48 
 49 - (id) initWithJavaLayer:(JNFWeakJObjectWrapper *)layer;
 50 {
 51 AWT_ASSERT_APPKIT_THREAD;
 52     // Initialize ourselves
 53     self = [super init];
 54     if (self == nil) return self;
 55 
 56     self.javaLayer = layer;
 57 
 58     // NOTE: async=YES means that the layer is re-cached periodically
 59     self.asynchronous = FALSE;
 60     self.contentsGravity = kCAGravityTopLeft;
 61     //Layer backed view
 62     //self.needsDisplayOnBoundsChange = YES;
 63     //self.autoresizingMask = kCALayerWidthSizable | kCALayerHeightSizable;
 64 
 65     //Disable CALayer&#39;s default animation
 66     NSMutableDictionary * actions = [[NSMutableDictionary alloc] initWithObjectsAndKeys:
 67                                     [NSNull null], @&quot;anchorPoint&quot;,
</pre>
<hr />
<pre>
162 
163 @end
164 
165 /*
166  * Class:     sun_java2d_opengl_CGLLayer
167  * Method:    nativeCreateLayer
168  * Signature: ()J
169  */
170 JNIEXPORT jlong JNICALL
171 Java_sun_java2d_opengl_CGLLayer_nativeCreateLayer
172 (JNIEnv *env, jobject obj)
173 {
174     __block CGLLayer *layer = nil;
175 
176 JNF_COCOA_ENTER(env);
177 
178     JNFWeakJObjectWrapper *javaLayer = [JNFWeakJObjectWrapper wrapperWithJObject:obj withEnv:env];
179 
180     [ThreadUtilities performOnMainThreadWaiting:YES block:^(){
181             AWT_ASSERT_APPKIT_THREAD;
<span class="line-modified">182         </span>
183             layer = [[CGLLayer alloc] initWithJavaLayer: javaLayer];
184     }];
<span class="line-modified">185     </span>
186 JNF_COCOA_EXIT(env);
187 
188     return ptr_to_jlong(layer);
189 }
190 
191 // Must be called under the RQ lock.
192 JNIEXPORT void JNICALL
193 Java_sun_java2d_opengl_CGLLayer_validate
194 (JNIEnv *env, jclass cls, jlong layerPtr, jobject surfaceData)
195 {
196     CGLLayer *layer = OBJC(layerPtr);
197 
198     if (surfaceData != NULL) {
199         OGLSDOps *oglsdo = (OGLSDOps*) SurfaceData_GetOps(env, surfaceData);
200         layer.textureID = oglsdo-&gt;textureID;
201         layer.target = GL_TEXTURE_2D;
202         layer.textureWidth = oglsdo-&gt;width;
203         layer.textureHeight = oglsdo-&gt;height;
204     } else {
205         layer.textureID = 0;
206     }
207 }
208 
209 // Must be called on the AppKit thread and under the RQ lock.
210 JNIEXPORT void JNICALL
211 Java_sun_java2d_opengl_CGLLayer_blitTexture
212 (JNIEnv *env, jclass cls, jlong layerPtr)
213 {
214     CGLLayer *layer = jlong_to_ptr(layerPtr);
215 
216     [layer blitTexture];
217 }
218 
219 JNIEXPORT void JNICALL
220 Java_sun_java2d_opengl_CGLLayer_nativeSetScale
221 (JNIEnv *env, jclass cls, jlong layerPtr, jdouble scale)
222 {
223     JNF_COCOA_ENTER(env);
224     CGLLayer *layer = jlong_to_ptr(layerPtr);
<span class="line-modified">225     // We always call all setXX methods asynchronously, exception is only in </span>
226     // this method where we need to change native texture size and layer&#39;s scale
<span class="line-modified">227     // in one call on appkit, otherwise we&#39;ll get window&#39;s contents blinking, </span>
228     // during screen-2-screen moving.
229     [ThreadUtilities performOnMainThreadWaiting:[NSThread isMainThread] block:^(){
230         layer.contentsScale = scale;
231     }];
232     JNF_COCOA_EXIT(env);
233 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #import &quot;CGLGraphicsConfig.h&quot;
 27 #import &quot;CGLLayer.h&quot;
 28 #import &quot;ThreadUtilities.h&quot;
 29 #import &quot;LWCToolkit.h&quot;
 30 #import &quot;CGLSurfaceData.h&quot;
 31 
 32 
 33 extern NSOpenGLPixelFormat *sharedPixelFormat;
 34 extern NSOpenGLContext *sharedContext;
 35 
 36 @implementation CGLLayer
 37 
 38 @synthesize javaLayer;
 39 @synthesize textureID;
 40 @synthesize target;
 41 @synthesize textureWidth;
 42 @synthesize textureHeight;





 43 
 44 - (id) initWithJavaLayer:(JNFWeakJObjectWrapper *)layer;
 45 {
 46 AWT_ASSERT_APPKIT_THREAD;
 47     // Initialize ourselves
 48     self = [super init];
 49     if (self == nil) return self;
 50 
 51     self.javaLayer = layer;
 52 
 53     // NOTE: async=YES means that the layer is re-cached periodically
 54     self.asynchronous = FALSE;
 55     self.contentsGravity = kCAGravityTopLeft;
 56     //Layer backed view
 57     //self.needsDisplayOnBoundsChange = YES;
 58     //self.autoresizingMask = kCALayerWidthSizable | kCALayerHeightSizable;
 59 
 60     //Disable CALayer&#39;s default animation
 61     NSMutableDictionary * actions = [[NSMutableDictionary alloc] initWithObjectsAndKeys:
 62                                     [NSNull null], @&quot;anchorPoint&quot;,
</pre>
<hr />
<pre>
157 
158 @end
159 
160 /*
161  * Class:     sun_java2d_opengl_CGLLayer
162  * Method:    nativeCreateLayer
163  * Signature: ()J
164  */
165 JNIEXPORT jlong JNICALL
166 Java_sun_java2d_opengl_CGLLayer_nativeCreateLayer
167 (JNIEnv *env, jobject obj)
168 {
169     __block CGLLayer *layer = nil;
170 
171 JNF_COCOA_ENTER(env);
172 
173     JNFWeakJObjectWrapper *javaLayer = [JNFWeakJObjectWrapper wrapperWithJObject:obj withEnv:env];
174 
175     [ThreadUtilities performOnMainThreadWaiting:YES block:^(){
176             AWT_ASSERT_APPKIT_THREAD;
<span class="line-modified">177 </span>
178             layer = [[CGLLayer alloc] initWithJavaLayer: javaLayer];
179     }];
<span class="line-modified">180 </span>
181 JNF_COCOA_EXIT(env);
182 
183     return ptr_to_jlong(layer);
184 }
185 
186 // Must be called under the RQ lock.
187 JNIEXPORT void JNICALL
188 Java_sun_java2d_opengl_CGLLayer_validate
189 (JNIEnv *env, jclass cls, jlong layerPtr, jobject surfaceData)
190 {
191     CGLLayer *layer = OBJC(layerPtr);
192 
193     if (surfaceData != NULL) {
194         OGLSDOps *oglsdo = (OGLSDOps*) SurfaceData_GetOps(env, surfaceData);
195         layer.textureID = oglsdo-&gt;textureID;
196         layer.target = GL_TEXTURE_2D;
197         layer.textureWidth = oglsdo-&gt;width;
198         layer.textureHeight = oglsdo-&gt;height;
199     } else {
200         layer.textureID = 0;
201     }
202 }
203 
204 // Must be called on the AppKit thread and under the RQ lock.
205 JNIEXPORT void JNICALL
206 Java_sun_java2d_opengl_CGLLayer_blitTexture
207 (JNIEnv *env, jclass cls, jlong layerPtr)
208 {
209     CGLLayer *layer = jlong_to_ptr(layerPtr);
210 
211     [layer blitTexture];
212 }
213 
214 JNIEXPORT void JNICALL
215 Java_sun_java2d_opengl_CGLLayer_nativeSetScale
216 (JNIEnv *env, jclass cls, jlong layerPtr, jdouble scale)
217 {
218     JNF_COCOA_ENTER(env);
219     CGLLayer *layer = jlong_to_ptr(layerPtr);
<span class="line-modified">220     // We always call all setXX methods asynchronously, exception is only in</span>
221     // this method where we need to change native texture size and layer&#39;s scale
<span class="line-modified">222     // in one call on appkit, otherwise we&#39;ll get window&#39;s contents blinking,</span>
223     // during screen-2-screen moving.
224     [ThreadUtilities performOnMainThreadWaiting:[NSThread isMainThread] block:^(){
225         layer.contentsScale = scale;
226     }];
227     JNF_COCOA_EXIT(env);
228 }
</pre>
</td>
</tr>
</table>
<center><a href="CGLLayer.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CGLSurfaceData.m.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>