<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libawt_lwawt/awt/ImageSurfaceData.m</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="CRobot.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="LWCToolkit.m.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libawt_lwawt/awt/ImageSurfaceData.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
1751         if (bipriv-&gt;base != NULL) {
1752             jint mode = (((bipriv-&gt;lockFlags &amp; (SD_LOCK_WRITE)) != 0)
1753                          ? 0 : JNI_ABORT);
1754             (*env)-&gt;ReleasePrimitiveArrayCritical(env, bisdo-&gt;array,
1755                                                   bipriv-&gt;base, mode);
1756         }
1757         if (bipriv-&gt;lutbase != NULL) {
1758             (*env)-&gt;ReleasePrimitiveArrayCritical(env, bisdo-&gt;lutarray,
1759                                                   bipriv-&gt;lutbase, JNI_ABORT);
1760         }
1761     }
1762 }
1763 
1764 JNIEXPORT void JNICALL Java_sun_java2d_OSXOffScreenSurfaceData_initRaster(JNIEnv *env, jobject bisd, jobject array, jint offset, jint width, jint height,
1765                                                                                 jint pixelStride, jint scanStride, jobject icm, jint type,
1766                                                                                     jobject jGraphicsState, jobjectArray jGraphicsStateObject, jobject jImageInfo)
1767 {
1768 PRINT(&quot;Java_sun_java2d_OSXOffScreenSurfaceData_initRaster&quot;)
1769 
1770     ImageSDOps* isdo = (ImageSDOps*)SurfaceData_InitOps(env, bisd, sizeof(ImageSDOps));




1771 
1772     pthread_mutexattr_t attr;
1773     pthread_mutexattr_init(&amp;attr);
1774     pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_RECURSIVE);
1775     pthread_mutex_init(&amp;isdo-&gt;lock, &amp;attr);
1776     pthread_mutex_lock(&amp;isdo-&gt;lock);
1777     pthread_mutexattr_destroy(&amp;attr);
1778 
1779     // copied (and modified) from Java_sun_awt_image_BufImgSurfaceData_initRaster in BufImgSurfaceData.c
1780     {
1781         BufImgSDOps *bisdo =
1782         //(BufImgSDOps*)SurfaceData_InitOps(env, bisd, sizeof(BufImgSDOps));
1783         (BufImgSDOps*)isdo;
1784         //bisdo-&gt;sdOps.Lock = BufImg_Lock;
1785         //bisdo-&gt;sdOps.GetRasInfo = BufImg_GetRasInfo;
1786         //bisdo-&gt;sdOps.Release = BufImg_Release;
1787         //bisdo-&gt;sdOps.Unlock = NULL;
1788         //bisdo-&gt;sdOps.Dispose = BufImg_Dispose;
1789 
1790         bisdo-&gt;array = (*env)-&gt;NewWeakGlobalRef(env, array);
</pre>
</td>
<td>
<hr />
<pre>
1751         if (bipriv-&gt;base != NULL) {
1752             jint mode = (((bipriv-&gt;lockFlags &amp; (SD_LOCK_WRITE)) != 0)
1753                          ? 0 : JNI_ABORT);
1754             (*env)-&gt;ReleasePrimitiveArrayCritical(env, bisdo-&gt;array,
1755                                                   bipriv-&gt;base, mode);
1756         }
1757         if (bipriv-&gt;lutbase != NULL) {
1758             (*env)-&gt;ReleasePrimitiveArrayCritical(env, bisdo-&gt;lutarray,
1759                                                   bipriv-&gt;lutbase, JNI_ABORT);
1760         }
1761     }
1762 }
1763 
1764 JNIEXPORT void JNICALL Java_sun_java2d_OSXOffScreenSurfaceData_initRaster(JNIEnv *env, jobject bisd, jobject array, jint offset, jint width, jint height,
1765                                                                                 jint pixelStride, jint scanStride, jobject icm, jint type,
1766                                                                                     jobject jGraphicsState, jobjectArray jGraphicsStateObject, jobject jImageInfo)
1767 {
1768 PRINT(&quot;Java_sun_java2d_OSXOffScreenSurfaceData_initRaster&quot;)
1769 
1770     ImageSDOps* isdo = (ImageSDOps*)SurfaceData_InitOps(env, bisd, sizeof(ImageSDOps));
<span class="line-added">1771     if (isdo == NULL) {</span>
<span class="line-added">1772         JNU_ThrowOutOfMemoryError(env, &quot;Initialization of SurfaceData failed.&quot;);</span>
<span class="line-added">1773         return;</span>
<span class="line-added">1774     }</span>
1775 
1776     pthread_mutexattr_t attr;
1777     pthread_mutexattr_init(&amp;attr);
1778     pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_RECURSIVE);
1779     pthread_mutex_init(&amp;isdo-&gt;lock, &amp;attr);
1780     pthread_mutex_lock(&amp;isdo-&gt;lock);
1781     pthread_mutexattr_destroy(&amp;attr);
1782 
1783     // copied (and modified) from Java_sun_awt_image_BufImgSurfaceData_initRaster in BufImgSurfaceData.c
1784     {
1785         BufImgSDOps *bisdo =
1786         //(BufImgSDOps*)SurfaceData_InitOps(env, bisd, sizeof(BufImgSDOps));
1787         (BufImgSDOps*)isdo;
1788         //bisdo-&gt;sdOps.Lock = BufImg_Lock;
1789         //bisdo-&gt;sdOps.GetRasInfo = BufImg_GetRasInfo;
1790         //bisdo-&gt;sdOps.Release = BufImg_Release;
1791         //bisdo-&gt;sdOps.Unlock = NULL;
1792         //bisdo-&gt;sdOps.Dispose = BufImg_Dispose;
1793 
1794         bisdo-&gt;array = (*env)-&gt;NewWeakGlobalRef(env, array);
</pre>
</td>
</tr>
</table>
<center><a href="CRobot.m.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="LWCToolkit.m.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>