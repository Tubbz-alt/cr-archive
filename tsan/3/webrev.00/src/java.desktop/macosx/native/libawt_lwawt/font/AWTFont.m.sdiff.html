<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libawt_lwawt/font/AWTFont.m</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="AWTFont.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/opengl/CGLGraphicsConfig.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libawt_lwawt/font/AWTFont.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 25 
 26 #import &lt;JavaNativeFoundation/JavaNativeFoundation.h&gt;
 27 
 28 #import &quot;java_awt_Font.h&quot;
 29 #import &quot;sun_awt_PlatformFont.h&quot;
 30 #import &quot;sun_awt_FontDescriptor.h&quot;
 31 #import &quot;sun_font_CFont.h&quot;
 32 #import &quot;sun_font_CFontManager.h&quot;
 33 
 34 #import &quot;AWTFont.h&quot;
 35 #import &quot;AWTStrike.h&quot;
 36 #import &quot;CoreTextSupport.h&quot;
 37 
 38 @implementation AWTFont
 39 
 40 - (id) initWithFont:(NSFont *)font {
 41     self = [super init];
 42     if (self) {
 43         fFont = [font retain];
 44         fNativeCGFont = CTFontCopyGraphicsFont((CTFontRef)font, NULL);
<span class="line-removed"> 45         layoutTableCache = NULL;</span>
 46     }
 47     return self;
 48 }
 49 
<span class="line-removed"> 50 static TTLayoutTableCache* newCFontLayoutTableCache() {</span>
<span class="line-removed"> 51   TTLayoutTableCache* ltc = calloc(1, sizeof(TTLayoutTableCache));</span>
<span class="line-removed"> 52   if (ltc) {</span>
<span class="line-removed"> 53     int i;</span>
<span class="line-removed"> 54     for(i=0;i&lt;LAYOUTCACHE_ENTRIES;i++) {</span>
<span class="line-removed"> 55       ltc-&gt;entries[i].len = -1;</span>
<span class="line-removed"> 56     }</span>
<span class="line-removed"> 57   }</span>
<span class="line-removed"> 58   return ltc;</span>
<span class="line-removed"> 59 }</span>
<span class="line-removed"> 60 </span>
<span class="line-removed"> 61 static void freeCFontLayoutTableCache(TTLayoutTableCache* ltc) {</span>
<span class="line-removed"> 62   if (ltc) {</span>
<span class="line-removed"> 63     int i;</span>
<span class="line-removed"> 64     for(i=0;i&lt;LAYOUTCACHE_ENTRIES;i++) {</span>
<span class="line-removed"> 65       if(ltc-&gt;entries[i].ptr) free (ltc-&gt;entries[i].ptr);</span>
<span class="line-removed"> 66     }</span>
<span class="line-removed"> 67     if (ltc-&gt;kernPairs) free(ltc-&gt;kernPairs);</span>
<span class="line-removed"> 68     free(ltc);</span>
<span class="line-removed"> 69   }</span>
<span class="line-removed"> 70 }</span>
<span class="line-removed"> 71 </span>
 72 - (void) dealloc {
 73     [fFont release];
 74     fFont = nil;
 75 
 76     if (fNativeCGFont) {
 77         CGFontRelease(fNativeCGFont);
 78     fNativeCGFont = NULL;
<span class="line-removed"> 79     if (layoutTableCache != NULL) {</span>
<span class="line-removed"> 80         freeCFontLayoutTableCache(layoutTableCache);</span>
<span class="line-removed"> 81         layoutTableCache = NULL;</span>
<span class="line-removed"> 82     }</span>
 83     }
 84 
 85     [super dealloc];
 86 }
 87 
 88 - (void) finalize {
 89     if (fNativeCGFont) {
 90         CGFontRelease(fNativeCGFont);
 91     fNativeCGFont = NULL;
 92     }
<span class="line-removed"> 93     if (layoutTableCache != NULL) {</span>
<span class="line-removed"> 94         freeCFontLayoutTableCache(layoutTableCache);</span>
<span class="line-removed"> 95         layoutTableCache = NULL;</span>
<span class="line-removed"> 96     }</span>
 97     [super finalize];
 98 }
 99 
100 + (AWTFont *) awtFontForName:(NSString *)name
101                        style:(int)style
102 {
103     // create font with family &amp; size
104     NSFont *nsFont = [NSFont fontWithName:name size:1.0];
105 
106     if (nsFont == nil) {
107         // if can&#39;t get font of that name, substitute system default font
108         nsFont = [NSFont fontWithName:@&quot;Lucida Grande&quot; size:1.0];
109 #ifdef DEBUG
110         NSLog(@&quot;needed to substitute Lucida Grande for: %@&quot;, name);
111 #endif
112     }
113 
114     // create an italic style (if one is installed)
115     if (style &amp; java_awt_Font_ITALIC) {
116         nsFont = [[NSFontManager sharedFontManager] convertFont:nsFont toHaveTrait:NSItalicFontMask];
</pre>
<hr />
<pre>
414 #endif
415 JNF_COCOA_EXIT(env);
416 }
417 
418 #pragma mark --- sun.font.CFont JNI ---
419 
420 /*
421  * Class:     sun_font_CFont
422  * Method:    getPlatformFontPtrNative
423  * Signature: (JI)[B
424  */
425 JNIEXPORT jlong JNICALL
426 Java_sun_font_CFont_getCGFontPtrNative
427     (JNIEnv *env, jclass clazz,
428      jlong awtFontPtr)
429 {
430     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
431     return (jlong)(awtFont-&gt;fNativeCGFont);
432 }
433 
<span class="line-removed">434 /*</span>
<span class="line-removed">435  * Class:     sun_font_CFont</span>
<span class="line-removed">436  * Method:    getLayoutTableCacheNative</span>
<span class="line-removed">437  * Signature: (J)J</span>
<span class="line-removed">438  */</span>
<span class="line-removed">439 JNIEXPORT jlong JNICALL</span>
<span class="line-removed">440 Java_sun_font_CFont_getLayoutTableCacheNative</span>
<span class="line-removed">441     (JNIEnv *env, jclass clazz,</span>
<span class="line-removed">442      jlong awtFontPtr)</span>
<span class="line-removed">443 {</span>
<span class="line-removed">444     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);</span>
<span class="line-removed">445     if (awtFont-&gt;layoutTableCache == NULL) {</span>
<span class="line-removed">446         awtFont-&gt;layoutTableCache = newCFontLayoutTableCache();</span>
<span class="line-removed">447     }</span>
<span class="line-removed">448     return (jlong)(awtFont-&gt;layoutTableCache);</span>
<span class="line-removed">449 }</span>
<span class="line-removed">450 </span>
451 /*
452  * Class:     sun_font_CFont
453  * Method:    getTableBytesNative
454  * Signature: (JI)[B
455  */
456 JNIEXPORT jbyteArray JNICALL
457 Java_sun_font_CFont_getTableBytesNative
458     (JNIEnv *env, jclass clazz,
459      jlong awtFontPtr, jint jtag)
460 {
461     jbyteArray jbytes = NULL;
462 JNF_COCOA_ENTER(env);
463 
464     CTFontTableTag tag = (CTFontTableTag)jtag;
465     int i, found = 0;
466     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
467     NSFont* nsFont = awtFont-&gt;fFont;
468     CTFontRef ctfont = (CTFontRef)nsFont;
469     CFArrayRef tagsArray =
470         CTFontCopyAvailableTables(ctfont, kCTFontTableOptionNoOptions);
</pre>
</td>
<td>
<hr />
<pre>
 25 
 26 #import &lt;JavaNativeFoundation/JavaNativeFoundation.h&gt;
 27 
 28 #import &quot;java_awt_Font.h&quot;
 29 #import &quot;sun_awt_PlatformFont.h&quot;
 30 #import &quot;sun_awt_FontDescriptor.h&quot;
 31 #import &quot;sun_font_CFont.h&quot;
 32 #import &quot;sun_font_CFontManager.h&quot;
 33 
 34 #import &quot;AWTFont.h&quot;
 35 #import &quot;AWTStrike.h&quot;
 36 #import &quot;CoreTextSupport.h&quot;
 37 
 38 @implementation AWTFont
 39 
 40 - (id) initWithFont:(NSFont *)font {
 41     self = [super init];
 42     if (self) {
 43         fFont = [font retain];
 44         fNativeCGFont = CTFontCopyGraphicsFont((CTFontRef)font, NULL);

 45     }
 46     return self;
 47 }
 48 






















 49 - (void) dealloc {
 50     [fFont release];
 51     fFont = nil;
 52 
 53     if (fNativeCGFont) {
 54         CGFontRelease(fNativeCGFont);
 55     fNativeCGFont = NULL;




 56     }
 57 
 58     [super dealloc];
 59 }
 60 
 61 - (void) finalize {
 62     if (fNativeCGFont) {
 63         CGFontRelease(fNativeCGFont);
 64     fNativeCGFont = NULL;
 65     }




 66     [super finalize];
 67 }
 68 
 69 + (AWTFont *) awtFontForName:(NSString *)name
 70                        style:(int)style
 71 {
 72     // create font with family &amp; size
 73     NSFont *nsFont = [NSFont fontWithName:name size:1.0];
 74 
 75     if (nsFont == nil) {
 76         // if can&#39;t get font of that name, substitute system default font
 77         nsFont = [NSFont fontWithName:@&quot;Lucida Grande&quot; size:1.0];
 78 #ifdef DEBUG
 79         NSLog(@&quot;needed to substitute Lucida Grande for: %@&quot;, name);
 80 #endif
 81     }
 82 
 83     // create an italic style (if one is installed)
 84     if (style &amp; java_awt_Font_ITALIC) {
 85         nsFont = [[NSFontManager sharedFontManager] convertFont:nsFont toHaveTrait:NSItalicFontMask];
</pre>
<hr />
<pre>
383 #endif
384 JNF_COCOA_EXIT(env);
385 }
386 
387 #pragma mark --- sun.font.CFont JNI ---
388 
389 /*
390  * Class:     sun_font_CFont
391  * Method:    getPlatformFontPtrNative
392  * Signature: (JI)[B
393  */
394 JNIEXPORT jlong JNICALL
395 Java_sun_font_CFont_getCGFontPtrNative
396     (JNIEnv *env, jclass clazz,
397      jlong awtFontPtr)
398 {
399     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
400     return (jlong)(awtFont-&gt;fNativeCGFont);
401 }
402 

















403 /*
404  * Class:     sun_font_CFont
405  * Method:    getTableBytesNative
406  * Signature: (JI)[B
407  */
408 JNIEXPORT jbyteArray JNICALL
409 Java_sun_font_CFont_getTableBytesNative
410     (JNIEnv *env, jclass clazz,
411      jlong awtFontPtr, jint jtag)
412 {
413     jbyteArray jbytes = NULL;
414 JNF_COCOA_ENTER(env);
415 
416     CTFontTableTag tag = (CTFontTableTag)jtag;
417     int i, found = 0;
418     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
419     NSFont* nsFont = awtFont-&gt;fFont;
420     CTFontRef ctfont = (CTFontRef)nsFont;
421     CFArrayRef tagsArray =
422         CTFontCopyAvailableTables(ctfont, kCTFontTableOptionNoOptions);
</pre>
</td>
</tr>
</table>
<center><a href="AWTFont.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/opengl/CGLGraphicsConfig.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>