<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/macosx/native/libawt_lwawt/font/AWTFont.m</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2011, 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #import &lt;JavaNativeFoundation/JavaNativeFoundation.h&gt;
 27 
 28 #import &quot;java_awt_Font.h&quot;
 29 #import &quot;sun_awt_PlatformFont.h&quot;
 30 #import &quot;sun_awt_FontDescriptor.h&quot;
 31 #import &quot;sun_font_CFont.h&quot;
 32 #import &quot;sun_font_CFontManager.h&quot;
 33 
 34 #import &quot;AWTFont.h&quot;
 35 #import &quot;AWTStrike.h&quot;
 36 #import &quot;CoreTextSupport.h&quot;
 37 
 38 @implementation AWTFont
 39 
 40 - (id) initWithFont:(NSFont *)font {
 41     self = [super init];
 42     if (self) {
 43         fFont = [font retain];
 44         fNativeCGFont = CTFontCopyGraphicsFont((CTFontRef)font, NULL);
<a name="1" id="anc1"></a><span class="line-removed"> 45         layoutTableCache = NULL;</span>
 46     }
 47     return self;
 48 }
 49 
<a name="2" id="anc2"></a><span class="line-removed"> 50 static TTLayoutTableCache* newCFontLayoutTableCache() {</span>
<span class="line-removed"> 51   TTLayoutTableCache* ltc = calloc(1, sizeof(TTLayoutTableCache));</span>
<span class="line-removed"> 52   if (ltc) {</span>
<span class="line-removed"> 53     int i;</span>
<span class="line-removed"> 54     for(i=0;i&lt;LAYOUTCACHE_ENTRIES;i++) {</span>
<span class="line-removed"> 55       ltc-&gt;entries[i].len = -1;</span>
<span class="line-removed"> 56     }</span>
<span class="line-removed"> 57   }</span>
<span class="line-removed"> 58   return ltc;</span>
<span class="line-removed"> 59 }</span>
<span class="line-removed"> 60 </span>
<span class="line-removed"> 61 static void freeCFontLayoutTableCache(TTLayoutTableCache* ltc) {</span>
<span class="line-removed"> 62   if (ltc) {</span>
<span class="line-removed"> 63     int i;</span>
<span class="line-removed"> 64     for(i=0;i&lt;LAYOUTCACHE_ENTRIES;i++) {</span>
<span class="line-removed"> 65       if(ltc-&gt;entries[i].ptr) free (ltc-&gt;entries[i].ptr);</span>
<span class="line-removed"> 66     }</span>
<span class="line-removed"> 67     if (ltc-&gt;kernPairs) free(ltc-&gt;kernPairs);</span>
<span class="line-removed"> 68     free(ltc);</span>
<span class="line-removed"> 69   }</span>
<span class="line-removed"> 70 }</span>
<span class="line-removed"> 71 </span>
 72 - (void) dealloc {
 73     [fFont release];
 74     fFont = nil;
 75 
 76     if (fNativeCGFont) {
 77         CGFontRelease(fNativeCGFont);
 78     fNativeCGFont = NULL;
<a name="3" id="anc3"></a><span class="line-removed"> 79     if (layoutTableCache != NULL) {</span>
<span class="line-removed"> 80         freeCFontLayoutTableCache(layoutTableCache);</span>
<span class="line-removed"> 81         layoutTableCache = NULL;</span>
<span class="line-removed"> 82     }</span>
 83     }
 84 
 85     [super dealloc];
 86 }
 87 
 88 - (void) finalize {
 89     if (fNativeCGFont) {
 90         CGFontRelease(fNativeCGFont);
 91     fNativeCGFont = NULL;
 92     }
<a name="4" id="anc4"></a><span class="line-removed"> 93     if (layoutTableCache != NULL) {</span>
<span class="line-removed"> 94         freeCFontLayoutTableCache(layoutTableCache);</span>
<span class="line-removed"> 95         layoutTableCache = NULL;</span>
<span class="line-removed"> 96     }</span>
 97     [super finalize];
 98 }
 99 
100 + (AWTFont *) awtFontForName:(NSString *)name
101                        style:(int)style
102 {
103     // create font with family &amp; size
104     NSFont *nsFont = [NSFont fontWithName:name size:1.0];
105 
106     if (nsFont == nil) {
107         // if can&#39;t get font of that name, substitute system default font
108         nsFont = [NSFont fontWithName:@&quot;Lucida Grande&quot; size:1.0];
109 #ifdef DEBUG
110         NSLog(@&quot;needed to substitute Lucida Grande for: %@&quot;, name);
111 #endif
112     }
113 
114     // create an italic style (if one is installed)
115     if (style &amp; java_awt_Font_ITALIC) {
116         nsFont = [[NSFontManager sharedFontManager] convertFont:nsFont toHaveTrait:NSItalicFontMask];
117     }
118 
119     // create a bold style (if one is installed)
120     if (style &amp; java_awt_Font_BOLD) {
121         nsFont = [[NSFontManager sharedFontManager] convertFont:nsFont toHaveTrait:NSBoldFontMask];
122     }
123 
124     return [[[AWTFont alloc] initWithFont:nsFont] autorelease];
125 }
126 
127 + (NSFont *) nsFontForJavaFont:(jobject)javaFont env:(JNIEnv *)env {
128     if (javaFont == NULL) {
129 #ifdef DEBUG
130         NSLog(@&quot;nil font&quot;);
131 #endif
132         return nil;
133     }
134 
135     static JNF_CLASS_CACHE(jc_Font, &quot;java/awt/Font&quot;);
136 
137     // obtain the Font2D
138     static JNF_MEMBER_CACHE(jm_Font_getFont2D, jc_Font, &quot;getFont2D&quot;, &quot;()Lsun/font/Font2D;&quot;);
139     jobject font2d = JNFCallObjectMethod(env, javaFont, jm_Font_getFont2D);
140     if (font2d == NULL) {
141 #ifdef DEBUG
142         NSLog(@&quot;nil font2d&quot;);
143 #endif
144         return nil;
145     }
146 
147     // if it&#39;s not a CFont, it&#39;s likely one of TTF or OTF fonts
148     // from the Sun rendering loops
149     static JNF_CLASS_CACHE(jc_CFont, &quot;sun/font/CFont&quot;);
150     if (!JNFIsInstanceOf(env, font2d, &amp;jc_CFont)) {
151 #ifdef DEBUG
152         NSLog(@&quot;font2d !instanceof CFont&quot;);
153 #endif
154         return nil;
155     }
156 
157     static JNF_MEMBER_CACHE(jm_CFont_getFontStrike, jc_CFont, &quot;getStrike&quot;, &quot;(Ljava/awt/Font;)Lsun/font/FontStrike;&quot;);
158     jobject fontStrike = JNFCallObjectMethod(env, font2d, jm_CFont_getFontStrike, javaFont);
159 
160     static JNF_CLASS_CACHE(jc_CStrike, &quot;sun/font/CStrike&quot;);
161     if (!JNFIsInstanceOf(env, fontStrike, &amp;jc_CStrike)) {
162 #ifdef DEBUG
163         NSLog(@&quot;fontStrike !instanceof CStrike&quot;);
164 #endif
165         return nil;
166     }
167 
168     static JNF_MEMBER_CACHE(jm_CStrike_nativeStrikePtr, jc_CStrike, &quot;getNativeStrikePtr&quot;, &quot;()J&quot;);
169     jlong awtStrikePtr = JNFCallLongMethod(env, fontStrike, jm_CStrike_nativeStrikePtr);
170     if (awtStrikePtr == 0L) {
171 #ifdef DEBUG
172         NSLog(@&quot;nil nativeFontPtr from CFont&quot;);
173 #endif
174         return nil;
175     }
176 
177     AWTStrike *strike = (AWTStrike *)jlong_to_ptr(awtStrikePtr);
178 
179     return [NSFont fontWithName:[strike-&gt;fAWTFont-&gt;fFont fontName] matrix:(CGFloat *)(&amp;(strike-&gt;fAltTx))];
180 }
181 
182 @end
183 
184 
185 #pragma mark --- Font Discovery and Loading ---
186 
187 static NSArray* sFilteredFonts = nil;
188 static NSDictionary* sFontFamilyTable = nil;
189 
190 static NSString*
191 GetFamilyNameForFontName(NSString* fontname)
192 {
193     return [sFontFamilyTable objectForKey:fontname];
194 }
195 
196 static void addFont(CTFontUIFontType uiType, 
197                     NSMutableArray *allFonts,
198                     NSMutableDictionary* fontFamilyTable) {
199 
200         CTFontRef font = CTFontCreateUIFontForLanguage(uiType, 0.0, NULL);
201         if (font == NULL) {
202             return;
203         }
204         CTFontDescriptorRef desc = CTFontCopyFontDescriptor(font);
205         if (desc == NULL) {
206             CFRelease(font);
207             return;
208         }
209         CFStringRef family = CTFontDescriptorCopyAttribute(desc, kCTFontFamilyNameAttribute);
210         if (family == NULL) {
211             CFRelease(desc);
212             CFRelease(font);
213             return;
214         }
215         CFStringRef name = CTFontDescriptorCopyAttribute(desc, kCTFontNameAttribute);
216         if (name == NULL) {
217             CFRelease(family);
218             CFRelease(desc);
219             CFRelease(font);
220             return;
221         }
222         [allFonts addObject:name];
223         [fontFamilyTable setObject:family forKey:name];
224 #ifdef DEBUG
225         NSLog(@&quot;name is : %@&quot;, (NSString*)name);
226         NSLog(@&quot;family is : %@&quot;, (NSString*)family);
227 #endif
228         CFRelease(family);
229         CFRelease(name);
230         CFRelease(desc);
231         CFRelease(font);
232 }
233  
234 static NSArray*
235 GetFilteredFonts()
236 {
237     if (sFilteredFonts == nil) {
238         NSFontManager *fontManager = [NSFontManager sharedFontManager];
239         NSUInteger fontCount = [[fontManager availableFonts] count];
240 
241         NSMutableArray *allFonts = [[NSMutableArray alloc] initWithCapacity:fontCount];
242         NSMutableDictionary* fontFamilyTable = [[NSMutableDictionary alloc] initWithCapacity:fontCount];
243         NSArray *allFamilies = [fontManager availableFontFamilies];
244 
245         NSUInteger familyCount = [allFamilies count];
246 
247         NSUInteger familyIndex;
248         for (familyIndex = 0; familyIndex &lt; familyCount; familyIndex++) {
249             NSString *family = [allFamilies objectAtIndex:familyIndex];
250 
251             if ((family == nil) || [family characterAtIndex:0] == &#39;.&#39;) {
252                 continue;
253             }
254 
255             NSArray *fontFaces = [fontManager availableMembersOfFontFamily:family];
256             NSUInteger faceCount = [fontFaces count];
257 
258             NSUInteger faceIndex;
259             for (faceIndex = 0; faceIndex &lt; faceCount; faceIndex++) {
260                 NSString* face = [[fontFaces objectAtIndex:faceIndex] objectAtIndex:0];
261                 if (face != nil) {
262                     [allFonts addObject:face];
263                     [fontFamilyTable setObject:family forKey:face];
264                 }
265             }
266         }
267 
268         /*
269          * JavaFX registers these fonts and so JDK needs to do so as well.
270          * If this isn&#39;t done we will have mis-matched rendering, since
271          * although these may include fonts that are enumerated normally
272          * they also demonstrably includes fonts that are not.
273          */
274         addFont(kCTFontUIFontSystem, allFonts, fontFamilyTable);
275         addFont(kCTFontUIFontEmphasizedSystem, allFonts, fontFamilyTable);
276         addFont(kCTFontUIFontUserFixedPitch, allFonts, fontFamilyTable);
277 
278         sFilteredFonts = allFonts;
279         sFontFamilyTable = fontFamilyTable;
280     }
281 
282     return sFilteredFonts;
283 }
284 
285 #pragma mark --- sun.font.CFontManager JNI ---
286 
287 static OSStatus CreateFSRef(FSRef *myFSRefPtr, NSString *inPath)
288 {
289     return FSPathMakeRef((UInt8 *)[inPath fileSystemRepresentation],
290                          myFSRefPtr, NULL);
291 }
292 
293 // /*
294 //  * Class:     sun_font_CFontManager
295 //  * Method:    loadFileFont
296 //  * Signature: (Ljava/lang/String;)Lsun/font/Font2D;
297 //  */
298 // JNIEXPORT /* sun.font.CFont */ jobject JNICALL
299 // Java_sun_font_CFontManager_loadFileFont
300 //     (JNIEnv *env, jclass obj, jstring fontpath)
301 // {
302 //     jobject result = NULL;
303 //
304 // JNF_COCOA_ENTER(env);
305 //
306 //     NSString *nsFilePath = JNFJavaToNSString(env, fontpath);
307 //     jstring javaFontName = NULL;
308 //
309 //     //
310 //     // Note: This API uses ATS and can therefore return Carbon error codes.
311 //     // These codes can be found at:
312 //     // http://developer.apple.com/techpubs/macosx/Carbon/Files/FileManager/File_Manager/ResultCodes/ResultCodes.html
313 //     //
314 //
315 //     FSRef iFile;
316 //     OSStatus status = CreateFSRef(&amp;iFile, nsFilePath);
317 //
318 //     if (status == noErr) {
319 //         ATSFontContainerRef oContainer;
320 //         status = ATSFontActivateFromFileReference(&amp;iFile, kATSFontContextLocal,
321 //                                                   kATSFontFormatUnspecified,
322 //                                                   NULL,
323 //                                                   kATSOptionFlagsUseDataFork,
324 //                                                   &amp;oContainer);
325 //         if (status == noErr) {
326 //             ATSFontRef ioArray[1];
327 //             ItemCount oCount;
328 //             status = ATSFontFindFromContainer(oContainer,
329 //                                               kATSOptionFlagsUseDataFork,
330 //                                               1, ioArray, &amp;oCount);
331 //
332 //             if (status == noErr) {
333 //                 CFStringRef oName;
334 //                 status = ATSFontGetPostScriptName(ioArray[0],
335 //                                                   kATSOptionFlagsUseDataFork,
336 //                                                   &amp;oName);
337 //                 if (status == noErr) {
338 //                     javaFontName = JNFNSToJavaString(env, (NSString *)oName);
339 //                     CFRelease(oName);
340 //                 }
341 //             }
342 //         }
343 //     }
344 //
345 //     if (javaFontName != NULL) {
346 //         // create the CFont!
347 //         static JNF_CLASS_CACHE(sjc_CFont, &quot;sun/font/CFont&quot;);
348 //         static JNF_CTOR_CACHE(sjf_CFont_ctor,
349 //                               sjc_CFont, &quot;(Ljava/lang/String;)V&quot;);
350 //         result = JNFNewObject(env, sjf_CFont_ctor, javaFontName);
351 //     }
352 //
353 // JNF_COCOA_EXIT(env);
354 //
355 //     return result;
356 // }
357 
358 /*
359  * Class:     sun_font_CFontManager
360  * Method:    loadNativeFonts
361  * Signature: ()V
362  */
363 JNIEXPORT void JNICALL
364 Java_sun_font_CFontManager_loadNativeFonts
365     (JNIEnv *env, jobject jthis)
366 {
367     static JNF_CLASS_CACHE(jc_CFontManager,
368                            &quot;sun/font/CFontManager&quot;);
369     static JNF_MEMBER_CACHE(jm_registerFont, jc_CFontManager,
370                             &quot;registerFont&quot;,
371                             &quot;(Ljava/lang/String;Ljava/lang/String;)V&quot;);
372 
373     jint num = 0;
374 
375 JNF_COCOA_ENTER(env);
376 
377     NSArray *filteredFonts = GetFilteredFonts();
378     num = (jint)[filteredFonts count];
379 
380     jint i;
381     for (i = 0; i &lt; num; i++) {
382         NSString *fontname = [filteredFonts objectAtIndex:i];
383         jobject jFontName = JNFNSToJavaString(env, fontname);
384         jobject jFontFamilyName =
385             JNFNSToJavaString(env, GetFamilyNameForFontName(fontname));
386 
387         JNFCallVoidMethod(env, jthis,
388                           jm_registerFont, jFontName, jFontFamilyName);
389         (*env)-&gt;DeleteLocalRef(env, jFontName);
390         (*env)-&gt;DeleteLocalRef(env, jFontFamilyName);
391     }
392 
393 JNF_COCOA_EXIT(env);
394 }
395 
396 /*
397  * Class:     Java_sun_font_CFontManager_loadNativeDirFonts
398  * Method:    loadNativeDirFonts
399  * Signature: (Ljava/lang/String;)V;
400  */
401 JNIEXPORT void JNICALL
402 Java_sun_font_CFontManager_loadNativeDirFonts
403 (JNIEnv *env, jclass clz, jstring filename)
404 {
405 JNF_COCOA_ENTER(env);
406 
407     NSString *path = JNFJavaToNSString(env, filename);
408     NSURL *url = [NSURL fileURLWithPath:(NSString *)path];
409     bool res = CTFontManagerRegisterFontsForURL((CFURLRef)url, kCTFontManagerScopeProcess, nil);
410 #ifdef DEBUG
411     NSLog(@&quot;path is : %@&quot;, (NSString*)path);
412     NSLog(@&quot;url is : %@&quot;, (NSString*)url);
413     printf(&quot;res is %d\n&quot;, res);
414 #endif
415 JNF_COCOA_EXIT(env);
416 }
417 
418 #pragma mark --- sun.font.CFont JNI ---
419 
420 /*
421  * Class:     sun_font_CFont
422  * Method:    getPlatformFontPtrNative
423  * Signature: (JI)[B
424  */
425 JNIEXPORT jlong JNICALL
426 Java_sun_font_CFont_getCGFontPtrNative
427     (JNIEnv *env, jclass clazz,
428      jlong awtFontPtr)
429 {
430     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
431     return (jlong)(awtFont-&gt;fNativeCGFont);
432 }
433 
<a name="5" id="anc5"></a><span class="line-removed">434 /*</span>
<span class="line-removed">435  * Class:     sun_font_CFont</span>
<span class="line-removed">436  * Method:    getLayoutTableCacheNative</span>
<span class="line-removed">437  * Signature: (J)J</span>
<span class="line-removed">438  */</span>
<span class="line-removed">439 JNIEXPORT jlong JNICALL</span>
<span class="line-removed">440 Java_sun_font_CFont_getLayoutTableCacheNative</span>
<span class="line-removed">441     (JNIEnv *env, jclass clazz,</span>
<span class="line-removed">442      jlong awtFontPtr)</span>
<span class="line-removed">443 {</span>
<span class="line-removed">444     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);</span>
<span class="line-removed">445     if (awtFont-&gt;layoutTableCache == NULL) {</span>
<span class="line-removed">446         awtFont-&gt;layoutTableCache = newCFontLayoutTableCache();</span>
<span class="line-removed">447     }</span>
<span class="line-removed">448     return (jlong)(awtFont-&gt;layoutTableCache);</span>
<span class="line-removed">449 }</span>
<span class="line-removed">450 </span>
451 /*
452  * Class:     sun_font_CFont
453  * Method:    getTableBytesNative
454  * Signature: (JI)[B
455  */
456 JNIEXPORT jbyteArray JNICALL
457 Java_sun_font_CFont_getTableBytesNative
458     (JNIEnv *env, jclass clazz,
459      jlong awtFontPtr, jint jtag)
460 {
461     jbyteArray jbytes = NULL;
462 JNF_COCOA_ENTER(env);
463 
464     CTFontTableTag tag = (CTFontTableTag)jtag;
465     int i, found = 0;
466     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
467     NSFont* nsFont = awtFont-&gt;fFont;
468     CTFontRef ctfont = (CTFontRef)nsFont;
469     CFArrayRef tagsArray =
470         CTFontCopyAvailableTables(ctfont, kCTFontTableOptionNoOptions);
471     CFIndex numTags = CFArrayGetCount(tagsArray);
472     for (i=0; i&lt;numTags; i++) {
473         if (tag ==
474             (CTFontTableTag)(uintptr_t)CFArrayGetValueAtIndex(tagsArray, i)) {
475             found = 1;
476             break;
477         }
478     }
479     CFRelease(tagsArray);
480     if (!found) {
481         return NULL;
482     }
483     CFDataRef table = CTFontCopyTable(ctfont, tag, kCTFontTableOptionNoOptions);
484     if (table == NULL) {
485         return NULL;
486     }
487 
488     char *tableBytes = (char*)(CFDataGetBytePtr(table));
489     size_t tableLength = CFDataGetLength(table);
490     if (tableBytes == NULL || tableLength == 0) {
491         CFRelease(table);
492         return NULL;
493     }
494 
495     jbytes = (*env)-&gt;NewByteArray(env, (jsize)tableLength);
496     if (jbytes == NULL) {
497         return NULL;
498     }
499     (*env)-&gt;SetByteArrayRegion(env, jbytes, 0,
500                                (jsize)tableLength,
501                                (jbyte*)tableBytes);
502     CFRelease(table);
503 
504 JNF_COCOA_EXIT(env);
505 
506     return jbytes;
507 }
508 
509 /*
510  * Class:     sun_font_CFont
511  * Method:    initNativeFont
512  * Signature: (Ljava/lang/String;I)J
513  */
514 JNIEXPORT jlong JNICALL
515 Java_sun_font_CFont_createNativeFont
516     (JNIEnv *env, jclass clazz,
517      jstring nativeFontName, jint style)
518 {
519     AWTFont *awtFont = nil;
520 
521 JNF_COCOA_ENTER(env);
522 
523     awtFont =
524         [AWTFont awtFontForName:JNFJavaToNSString(env, nativeFontName)
525          style:style]; // autoreleased
526 
527     if (awtFont) {
528         CFRetain(awtFont); // GC
529     }
530 
531 JNF_COCOA_EXIT(env);
532 
533     return ptr_to_jlong(awtFont);
534 }
535 
536 /*
537  * Class:     sun_font_CFont
538  * Method:    getWidthNative
539  * Signature: (J)F
540  */
541 JNIEXPORT jfloat JNICALL
542 Java_sun_font_CFont_getWidthNative
543     (JNIEnv *env, jobject cfont, jlong awtFontPtr)
544 {
545     float widthVal;
546 JNF_COCOA_ENTER(env);
547 
548     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
549     NSFont* nsFont = awtFont-&gt;fFont;
550     NSFontDescriptor *fontDescriptor = nsFont.fontDescriptor;
551     NSDictionary *fontTraits = [fontDescriptor objectForKey : NSFontTraitsAttribute];
552     NSNumber *width = [fontTraits objectForKey : NSFontWidthTrait];
553     widthVal = (float)[width floatValue];
554 
555 JNF_COCOA_EXIT(env);
556    return (jfloat)widthVal;
557 }
558 
559 /*
560  * Class:     sun_font_CFont
561  * Method:    getWeightNative
562  * Signature: (J)F
563  */
564 JNIEXPORT jfloat JNICALL
565 Java_sun_font_CFont_getWeightNative
566     (JNIEnv *env, jobject cfont, jlong awtFontPtr)
567 {
568     float weightVal;
569 JNF_COCOA_ENTER(env);
570 
571     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
572     NSFont* nsFont = awtFont-&gt;fFont;
573     NSFontDescriptor *fontDescriptor = nsFont.fontDescriptor;
574     NSDictionary *fontTraits = [fontDescriptor objectForKey : NSFontTraitsAttribute];
575     NSNumber *weight = [fontTraits objectForKey : NSFontWeightTrait];
576     weightVal = (float)[weight floatValue];
577 
578 JNF_COCOA_EXIT(env);
579    return (jfloat)weightVal;
580 }
581 
582 /*
583  * Class:     sun_font_CFont
584  * Method:    disposeNativeFont
585  * Signature: (J)V
586  */
587 JNIEXPORT void JNICALL
588 Java_sun_font_CFont_disposeNativeFont
589     (JNIEnv *env, jclass clazz, jlong awtFontPtr)
590 {
591 JNF_COCOA_ENTER(env);
592 
593     if (awtFontPtr) {
594         CFRelease((AWTFont *)jlong_to_ptr(awtFontPtr)); // GC
595     }
596 
597 JNF_COCOA_EXIT(env);
598 }
599 
600 
601 #pragma mark --- Miscellaneous JNI ---
602 
603 #ifndef HEADLESS
604 /*
605  * Class:     sun_awt_PlatformFont
606  * Method:    initIDs
607  * Signature: ()V
608  */
609 JNIEXPORT void JNICALL
610 Java_sun_awt_PlatformFont_initIDs
611     (JNIEnv *env, jclass cls)
612 {
613 }
614 
615 /*
616  * Class:     sun_awt_FontDescriptor
617  * Method:    initIDs
618  * Signature: ()V
619  */
620 JNIEXPORT void JNICALL
621 Java_sun_awt_FontDescriptor_initIDs
622     (JNIEnv *env, jclass cls)
623 {
624 }
625 #endif
626 
627 /*
628  * Class:     sun_awt_FontDescriptor
629  * Method:    initIDs
630  * Signature: ()V
631  */
632 JNIEXPORT void JNICALL
633 Java_sun_font_CFont_getCascadeList
634     (JNIEnv *env, jclass cls, jlong awtFontPtr, jobject arrayListOfString)
635 {
636     jclass alc = (*env)-&gt;FindClass(env, &quot;java/util/ArrayList&quot;);
637     if (alc == NULL) return;
638     jmethodID addMID = (*env)-&gt;GetMethodID(env, alc, &quot;add&quot;, &quot;(Ljava/lang/Object;)Z&quot;);
639     if (addMID == NULL) return;
640 
641     CFIndex i;
642     AWTFont *awtFont = (AWTFont *)jlong_to_ptr(awtFontPtr);
643     NSFont* nsFont = awtFont-&gt;fFont;
644     CTFontRef font = (CTFontRef)nsFont;
645     CFStringRef base = CTFontCopyFullName(font);
646     CFArrayRef codes = CFLocaleCopyISOLanguageCodes();
647 
648 #ifdef DEBUG
649     NSLog(@&quot;BaseFont is : %@&quot;, (NSString*)base);
650 #endif
651     CFArrayRef fds = CTFontCopyDefaultCascadeListForLanguages(font, codes);
652     CFIndex cnt = CFArrayGetCount(fds);
653     for (i=0; i&lt;cnt; i++) {
654         CTFontDescriptorRef ref = CFArrayGetValueAtIndex(fds, i);
655         CFStringRef fontname =
656             CTFontDescriptorCopyAttribute(ref, kCTFontNameAttribute);
657 #ifdef DEBUG
658         NSLog(@&quot;Font is : %@&quot;, (NSString*)fontname);
659 #endif
660         jstring jFontName = (jstring)JNFNSToJavaString(env, fontname);
661         (*env)-&gt;CallBooleanMethod(env, arrayListOfString, addMID, jFontName); 
662         (*env)-&gt;DeleteLocalRef(env, jFontName);
663     }
664 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>