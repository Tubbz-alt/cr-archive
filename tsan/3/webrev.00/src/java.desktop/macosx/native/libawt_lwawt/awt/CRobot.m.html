<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.desktop/macosx/native/libawt_lwawt/awt/CRobot.m</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 
 27 #import &quot;jni_util.h&quot;
 28 
 29 #import &lt;JavaNativeFoundation/JavaNativeFoundation.h&gt;
 30 #import &lt;ApplicationServices/ApplicationServices.h&gt;
 31 
 32 #import &quot;CRobotKeyCode.h&quot;
 33 #import &quot;LWCToolkit.h&quot;
 34 #import &quot;sun_lwawt_macosx_CRobot.h&quot;
 35 #import &quot;java_awt_event_InputEvent.h&quot;
 36 #import &quot;java_awt_event_KeyEvent.h&quot;
 37 #import &quot;sizecalc.h&quot;
 38 
 39 // Starting number for event numbers generated by Robot.
 40 // Apple docs don&#39;t mention at all what are the requirements
 41 // for these numbers. It seems that they must be higher
 42 // than event numbers from real events, which start at some
 43 // value close to zero. There is no API for obtaining current
 44 // event number, so we have to start from some random number.
 45 // 32000 as starting value works for me, let&#39;s hope that it will
 46 // work for others as well.
 47 #define ROBOT_EVENT_NUMBER_START 32000
 48 
 49 #define k_JAVA_ROBOT_WHEEL_COUNT 1
 50 
 51 #if !defined(kCGBitmapByteOrder32Host)
 52 #define kCGBitmapByteOrder32Host 0
 53 #endif
 54 
 55 // In OS X, left and right mouse button share the same click count.
 56 // That is, if one starts clicking the left button rapidly and then
 57 // switches to the right button, then the click count will continue
 58 // increasing, without dropping to 1 in between. The middle button,
 59 // however, has its own click count.
 60 // For robot, we aren&#39;t going to emulate all that complexity. All our
 61 // synhtetic clicks share the same click count.
 62 static int gsClickCount;
 63 static NSTimeInterval gsLastClickTime;
 64 
 65 // Apparently, for mouse up/down events we have to set an event number
 66 // that is incremented on each button press. Otherwise, strange things
 67 // happen with z-order.
 68 static int gsEventNumber;
 69 static int* gsButtonEventNumber;
 70 
 71 static inline CGKeyCode GetCGKeyCode(jint javaKeyCode);
 72 
 73 static void PostMouseEvent(const CGPoint point, CGMouseButton button,
 74                            CGEventType type, int clickCount, int eventNumber);
 75 
 76 static int GetClickCount(BOOL isDown);
 77 
 78 static void
 79 CreateJavaException(JNIEnv* env, CGError err)
 80 {
 81     // Throw a java exception indicating what is wrong.
 82     NSString* s = [NSString stringWithFormat:@&quot;Robot: CGError: %d&quot;, err];
 83     (*env)-&gt;ThrowNew(env, (*env)-&gt;FindClass(env, &quot;java/awt/AWTException&quot;),
 84                      [s UTF8String]);
 85 }
 86 
 87 /*
 88  * Class:     sun_lwawt_macosx_CRobot
 89  * Method:    initRobot
 90  * Signature: (V)V
 91  */
 92 JNIEXPORT void JNICALL
 93 Java_sun_lwawt_macosx_CRobot_initRobot
 94 (JNIEnv *env, jobject peer)
 95 {
 96     // Set things up to let our app act like a synthetic keyboard and mouse.
 97     // Always set all states, in case Apple ever changes default behaviors.
 98     static int setupDone = 0;
 99     if (!setupDone) {
100         int i;
101         jint* tmp;
102         jboolean copy = JNI_FALSE;
103 
104         setupDone = 1;
105         // Don&#39;t block local events after posting ours
106         CGSetLocalEventsSuppressionInterval(0.0);
107 
108         // Let our event&#39;s modifier key state blend with local hardware events
109         CGEnableEventStateCombining(TRUE);
110 
111         // Don&#39;t let our events block local hardware events
112         CGSetLocalEventsFilterDuringSupressionState(
113                                     kCGEventFilterMaskPermitAllEvents,
114                                     kCGEventSupressionStateSupressionInterval);
115         CGSetLocalEventsFilterDuringSupressionState(
116                                     kCGEventFilterMaskPermitAllEvents,
117                                     kCGEventSupressionStateRemoteMouseDrag);
118 
119         gsClickCount = 0;
120         gsLastClickTime = 0;
121         gsEventNumber = ROBOT_EVENT_NUMBER_START;
122 
123         gsButtonEventNumber = (int*)SAFE_SIZE_ARRAY_ALLOC(malloc, sizeof(int), gNumberOfButtons);
124         if (gsButtonEventNumber == NULL) {
125             JNU_ThrowOutOfMemoryError(env, NULL);
126             return;
127         }
128 
129         for (i = 0; i &lt; gNumberOfButtons; ++i) {
130             gsButtonEventNumber[i] = ROBOT_EVENT_NUMBER_START;
131         }
132     }
133 }
134 
135 /*
136  * Class:     sun_lwawt_macosx_CRobot
137  * Method:    mouseEvent
138  * Signature: (IIIIZZ)V
139  */
140 JNIEXPORT void JNICALL
141 Java_sun_lwawt_macosx_CRobot_mouseEvent
142 (JNIEnv *env, jobject peer, jint mouseLastX, jint mouseLastY, jint buttonsState,
143  jboolean isButtonsDownState, jboolean isMouseMove)
144 {
145     JNF_COCOA_ENTER(env);
146 
147     // This is the native method called when Robot mouse events occur.
148     // The CRobot tracks the mouse position, and which button was
149     // pressed. The peer also tracks the mouse button desired state,
150     // the appropriate key modifier state, and whether the mouse action
151     // is simply a mouse move with no mouse button state changes.
152 
153     // volatile, otherwise it warns that it might be clobbered by &#39;longjmp&#39;
154     volatile CGPoint point;
155 
156     point.x = mouseLastX;
157     point.y = mouseLastY;
158 
159     __block CGMouseButton button = kCGMouseButtonLeft;
160     __block CGEventType type = kCGEventMouseMoved;
161 
162     void (^HandleRobotButton)(CGMouseButton, CGEventType, CGEventType, CGEventType) =
163         ^(CGMouseButton cgButton, CGEventType cgButtonUp, CGEventType cgButtonDown,
164           CGEventType cgButtonDragged) {
165 
166             button = cgButton;
167             type = cgButtonUp;
168 
169             if (isButtonsDownState) {
170                 if (isMouseMove) {
171                     type = cgButtonDragged;
172                 } else {
173                     type = cgButtonDown;
174                 }
175             }
176         };
177 
178     // Left
179     if (buttonsState &amp; java_awt_event_InputEvent_BUTTON1_MASK ||
180         buttonsState &amp; java_awt_event_InputEvent_BUTTON1_DOWN_MASK ) {
181 
182         HandleRobotButton(kCGMouseButtonLeft, kCGEventLeftMouseUp,
183                           kCGEventLeftMouseDown, kCGEventLeftMouseDragged);
184     }
185 
186     // Other
187     if (buttonsState &amp; java_awt_event_InputEvent_BUTTON2_MASK ||
188         buttonsState &amp; java_awt_event_InputEvent_BUTTON2_DOWN_MASK ) {
189 
190         HandleRobotButton(kCGMouseButtonCenter, kCGEventOtherMouseUp,
191                           kCGEventOtherMouseDown, kCGEventOtherMouseDragged);
192     }
193 
194     // Right
195     if (buttonsState &amp; java_awt_event_InputEvent_BUTTON3_MASK ||
196         buttonsState &amp; java_awt_event_InputEvent_BUTTON3_DOWN_MASK ) {
197 
198         HandleRobotButton(kCGMouseButtonRight, kCGEventRightMouseUp,
199                           kCGEventRightMouseDown, kCGEventRightMouseDragged);
200     }
201 
202     // Extra
203     if (gNumberOfButtons &gt; 3) {
204         int extraButton;
205         for (extraButton = 3; extraButton &lt; gNumberOfButtons; ++extraButton) {
206             if ((buttonsState &amp; gButtonDownMasks[extraButton])) {
207                 HandleRobotButton(extraButton, kCGEventOtherMouseUp,
208                             kCGEventOtherMouseDown, kCGEventOtherMouseDragged);
209             }
210         }
211     }
212 
213     int clickCount = 0;
214     int eventNumber = gsEventNumber;
215 
216     if (isMouseMove) {
217         // any mouse movement resets click count
218         gsLastClickTime = 0;
219     } else {
220         clickCount = GetClickCount(isButtonsDownState);
221 
222         if (isButtonsDownState) {
223             gsButtonEventNumber[button] = gsEventNumber++;
224         }
225         eventNumber = gsButtonEventNumber[button];
226     }
227 
228     PostMouseEvent(point, button, type, clickCount, eventNumber);
229 
230     JNF_COCOA_EXIT(env);
231 }
232 
233 /*
234  * Class:     sun_lwawt_macosx_CRobot
235  * Method:    mouseWheel
236  * Signature: (I)V
237  */
238 JNIEXPORT void JNICALL
239 Java_sun_lwawt_macosx_CRobot_mouseWheel
240 (JNIEnv *env, jobject peer, jint wheelAmt)
241 {
242     CGEventRef event = CGEventCreateScrollWheelEvent(NULL,
243                                             kCGScrollEventUnitLine,
244                                             k_JAVA_ROBOT_WHEEL_COUNT, wheelAmt);
245 
246     if (event != NULL) {
247         CGEventPost(kCGSessionEventTap, event);
248         CFRelease(event);
249     }
250 }
251 
252 /*
253  * Class:     sun_lwawt_macosx_CRobot
254  * Method:    keyEvent
255  * Signature: (IZ)V
256  */
257 JNIEXPORT void JNICALL
258 Java_sun_lwawt_macosx_CRobot_keyEvent
259 (JNIEnv *env, jobject peer, jint javaKeyCode, jboolean keyPressed)
260 {
261     CGKeyCode keyCode = GetCGKeyCode(javaKeyCode);
262 
263     CGEventRef event = CGEventCreateKeyboardEvent(NULL, keyCode, keyPressed);
264     if (event != NULL) {
265         CGEventPost(kCGSessionEventTap, event);
266         CFRelease(event);
267     }
268 }
269 
270 /*
271  * Class:     sun_lwawt_macosx_CRobot
272  * Method:    nativeGetScreenPixels
273  * Signature: (IIIII[I)V
274  */
275 JNIEXPORT void JNICALL
276 Java_sun_lwawt_macosx_CRobot_nativeGetScreenPixels
277 (JNIEnv *env, jobject peer,
278  jint x, jint y, jint width, jint height, jdouble scale, jintArray pixels)
279 {
280     JNF_COCOA_ENTER(env);
281 
282     jint picX = x;
283     jint picY = y;
284     jint picWidth = width;
285     jint picHeight = height;
286 
287     CGRect screenRect = CGRectMake(picX / scale, picY / scale,
288     				picWidth / scale, picHeight / scale);
289     CGImageRef screenPixelsImage = CGWindowListCreateImage(screenRect,
290                                         kCGWindowListOptionOnScreenOnly,
291                                         kCGNullWindowID, kCGWindowImageBestResolution);
292 
293     if (screenPixelsImage == NULL) {
294         return;
295     }
296 
297     // get a pointer to the Java int array
298     void *jPixelData = (*env)-&gt;GetPrimitiveArrayCritical(env, pixels, 0);
299     CHECK_NULL(jPixelData);
300 
301     // create a graphics context around the Java int array
302     CGColorSpaceRef picColorSpace = CGColorSpaceCreateWithName(
303                                             kCGColorSpaceSRGB);
304     CGContextRef jPicContextRef = CGBitmapContextCreate(
305                                             jPixelData,
306                                             picWidth, picHeight,
307                                             8, picWidth * sizeof(jint),
308                                             picColorSpace,
309                                             kCGBitmapByteOrder32Host |
310                                             kCGImageAlphaPremultipliedFirst);
311 
312     CGColorSpaceRelease(picColorSpace);
313 
314     // flip, scale, and color correct the screen image into the Java pixels
315     CGRect bounds = { { 0, 0 }, { picWidth, picHeight } };
316     CGContextDrawImage(jPicContextRef, bounds, screenPixelsImage);
317     CGContextFlush(jPicContextRef);
318 
319     // cleanup
320     CGContextRelease(jPicContextRef);
321     CGImageRelease(screenPixelsImage);
322 
323     // release the Java int array back up to the JVM
324     (*env)-&gt;ReleasePrimitiveArrayCritical(env, pixels, jPixelData, 0);
325 
326     JNF_COCOA_EXIT(env);
327 }
328 
329 /****************************************************
330  * Helper methods
331  ****************************************************/
332 
333 static void PostMouseEvent(const CGPoint point, CGMouseButton button,
334                            CGEventType type, int clickCount, int eventNumber)
335 {
336     CGEventRef mouseEvent = CGEventCreateMouseEvent(NULL, type, point, button);
337     if (mouseEvent != NULL) {
338         CGEventSetIntegerValueField(mouseEvent, kCGMouseEventClickState, clickCount);
339         CGEventSetIntegerValueField(mouseEvent, kCGMouseEventNumber, eventNumber);
340         CGEventPost(kCGSessionEventTap, mouseEvent);
341         CFRelease(mouseEvent);
342     }
343 }
344 
345 static inline CGKeyCode GetCGKeyCode(jint javaKeyCode)
346 {
347     CRobotKeyCodeMapping *keyCodeMapping = [CRobotKeyCodeMapping sharedInstance];
348     return [keyCodeMapping getOSXKeyCodeForJavaKey:javaKeyCode];
349 }
350 
351 static int GetClickCount(BOOL isDown) {
352     NSTimeInterval now = [[NSDate date] timeIntervalSinceReferenceDate];
353     NSTimeInterval clickInterval = now - gsLastClickTime;
354     BOOL isWithinTreshold = clickInterval &lt; [NSEvent doubleClickInterval];
355 
356     if (isDown) {
357         if (isWithinTreshold) {
358             gsClickCount++;
359         } else {
360             gsClickCount = 1;
361         }
362 
363         gsLastClickTime = now;
364     } else {
365         // In OS X, a mouse up has the click count of the last mouse down
366         // if an interval between up and down is within the double click
367         // threshold, and 0 otherwise.
368         if (!isWithinTreshold) {
369             gsClickCount = 0;
370         }
371     }
372 
373     return gsClickCount;
374 }
    </pre>
  </body>
</html>