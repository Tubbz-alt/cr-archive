<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/macosx/native/libosxapp/NSApplicationAWT.m</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #import &quot;NSApplicationAWT.h&quot;
 27 
 28 #import &lt;objc/runtime.h&gt;
 29 #import &lt;JavaRuntimeSupport/JavaRuntimeSupport.h&gt;
 30 
 31 #import &quot;PropertiesUtilities.h&quot;
 32 #import &quot;ThreadUtilities.h&quot;
 33 #import &quot;QueuingApplicationDelegate.h&quot;
 34 #import &quot;AWTIconData.h&quot;
 35 
 36 /*
 37  * Declare library specific JNI_Onload entry if static build
 38  */
 39 DEF_STATIC_JNI_OnLoad
 40 
 41 static BOOL sUsingDefaultNIB = YES;
 42 static NSString *SHARED_FRAMEWORK_BUNDLE = @&quot;/System/Library/Frameworks/JavaVM.framework&quot;;
 43 static id &lt;NSApplicationDelegate&gt; applicationDelegate = nil;
 44 static QueuingApplicationDelegate * qad = nil;
 45 
 46 // Flag used to indicate to the Plugin2 event synthesis code to do a postEvent instead of sendEvent
 47 BOOL postEventDuringEventSynthesis = NO;
 48 
 49 /**
 50  * Subtypes of NSApplicationDefined, which are used for custom events.
 51  */
 52 enum {
<a name="2" id="anc2"></a><span class="line-modified"> 53     ExecuteBlockEvent = 777, NativeSyncQueueEvent</span>
 54 };
 55 
 56 @implementation NSApplicationAWT
 57 
 58 - (id) init
 59 {
 60     // Headless: NO
 61     // Embedded: NO
 62     // Multiple Calls: NO
 63     //  Caller: +[NSApplication sharedApplication]
 64 
 65 AWT_ASSERT_APPKIT_THREAD;
 66     fApplicationName = nil;
 67     dummyEventTimestamp = 0.0;
 68     seenDummyEventLock = nil;
 69 
 70 
 71     // NSApplication will call _RegisterApplication with the application&#39;s bundle, but there may not be one.
 72     // So, we need to call it ourselves to ensure the app is set up properly.
 73     [self registerWithProcessManager];
 74 
 75     return [super init];
 76 }
 77 
 78 - (void)dealloc
 79 {
 80     [[NSUserNotificationCenter defaultUserNotificationCenter] setDelegate:nil];
 81 
 82     [fApplicationName release];
 83     fApplicationName = nil;
 84 
 85     [super dealloc];
 86 }
 87 
 88 - (void)finishLaunching
 89 {
 90 AWT_ASSERT_APPKIT_THREAD;
 91 
 92     JNIEnv *env = [ThreadUtilities getJNIEnv];
 93 
<a name="3" id="anc3"></a><span class="line-added"> 94     SEL appearanceSel = @selector(setAppearance:); // macOS 10.14+</span>
<span class="line-added"> 95     if ([self respondsToSelector:appearanceSel]) {</span>
<span class="line-added"> 96         NSString *appearanceProp = [PropertiesUtilities</span>
<span class="line-added"> 97                 javaSystemPropertyForKey:@&quot;apple.awt.application.appearance&quot;</span>
<span class="line-added"> 98                                  withEnv:env];</span>
<span class="line-added"> 99         if (![@&quot;system&quot; isEqual:appearanceProp]) {</span>
<span class="line-added">100             // by default use light mode, because dark mode is not supported yet</span>
<span class="line-added">101             NSAppearance *appearance = [NSAppearance appearanceNamed:NSAppearanceNameAqua];</span>
<span class="line-added">102             if (appearanceProp != nil) {</span>
<span class="line-added">103                 NSAppearance *requested = [NSAppearance appearanceNamed:appearanceProp];</span>
<span class="line-added">104                 if (requested != nil) {</span>
<span class="line-added">105                     appearance = requested;</span>
<span class="line-added">106                 }</span>
<span class="line-added">107             }</span>
<span class="line-added">108             // [self setAppearance:appearance];</span>
<span class="line-added">109             [self performSelector:appearanceSel withObject:appearance];</span>
<span class="line-added">110         }</span>
<span class="line-added">111     }</span>
<span class="line-added">112 </span>
113     // Get default nib file location
114     // NOTE: This should learn about the current java.version. Probably best thru
115     //  the Makefile system&#39;s -DFRAMEWORK_VERSION define. Need to be able to pass this
116     //  thru to PB from the Makefile system and for local builds.
117     NSString *defaultNibFile = [PropertiesUtilities javaSystemPropertyForKey:@&quot;apple.awt.application.nib&quot; withEnv:env];
118     if (!defaultNibFile) {
119         NSBundle *javaBundle = [NSBundle bundleWithPath:SHARED_FRAMEWORK_BUNDLE];
120         defaultNibFile = [javaBundle pathForResource:@&quot;DefaultApp&quot; ofType:@&quot;nib&quot;];
121     } else {
122         sUsingDefaultNIB = NO;
123     }
124 
125     [NSBundle loadNibFile:defaultNibFile externalNameTable: [NSDictionary dictionaryWithObject:self forKey:@&quot;NSOwner&quot;] withZone:nil];
126 
127     // Set user defaults to not try to parse application arguments.
128     NSUserDefaults * defs = [NSUserDefaults standardUserDefaults];
129     NSDictionary * noOpenDict = [NSDictionary dictionaryWithObject:@&quot;NO&quot; forKey:@&quot;NSTreatUnknownArgumentsAsOpen&quot;];
130     [defs registerDefaults:noOpenDict];
131 
132     // Fix up the dock icon now that we are registered with CAS and the Dock.
133     [self setDockIconWithEnv:env];
134 
135     // If we are using our nib (the default application NIB) we need to put the app name into
136     // the application menu, which has placeholders for the name.
137     if (sUsingDefaultNIB) {
138         NSUInteger i, itemCount;
139         NSMenu *theMainMenu = [NSApp mainMenu];
140 
141         // First submenu off the main menu is the application menu.
142         NSMenuItem *appMenuItem = [theMainMenu itemAtIndex:0];
143         NSMenu *appMenu = [appMenuItem submenu];
144         itemCount = [appMenu numberOfItems];
145 
146         for (i = 0; i &lt; itemCount; i++) {
147             NSMenuItem *anItem = [appMenu itemAtIndex:i];
148             NSString *oldTitle = [anItem title];
149             [anItem setTitle:[NSString stringWithFormat:oldTitle, fApplicationName]];
150         }
151     }
152 
153     if (applicationDelegate) {
154         [self setDelegate:applicationDelegate];
155     } else {
156         qad = [QueuingApplicationDelegate sharedDelegate];
157         [self setDelegate:qad];
158     }
159 
160     [super finishLaunching];
161 
162     [[NSUserNotificationCenter defaultUserNotificationCenter] setDelegate:self];
163 
164     // inform any interested parties that the AWT has arrived and is pumping
165     [[NSNotificationCenter defaultCenter] postNotificationName:JNFRunLoopDidStartNotification object:self];
166 }
167 
168 - (BOOL)userNotificationCenter:(NSUserNotificationCenter *)center
169      shouldPresentNotification:(NSUserNotification *)notification
170 {
171     return YES; // We always show notifications to the user
172 }
173 
174 - (void) registerWithProcessManager
175 {
176     // Headless: NO
177     // Embedded: NO
178     // Multiple Calls: NO
179     //  Caller: -[NSApplicationAWT init]
180 
181 AWT_ASSERT_APPKIT_THREAD;
182     JNIEnv *env = [ThreadUtilities getJNIEnv];
183 
184     char envVar[80];
185 
186     // The following environment variable is set from the -Xdock:name param. It should be UTF8.
187     snprintf(envVar, sizeof(envVar), &quot;APP_NAME_%d&quot;, getpid());
188     char *appName = getenv(envVar);
189     if (appName != NULL) {
190         fApplicationName = [NSString stringWithUTF8String:appName];
191         unsetenv(envVar);
192     }
193 
194     // If it wasn&#39;t specified as an argument, see if it was specified as a system property.
195     if (fApplicationName == nil) {
196         fApplicationName = [PropertiesUtilities javaSystemPropertyForKey:@&quot;apple.awt.application.name&quot; withEnv:env];
197     }
198 
199     // If we STILL don&#39;t have it, the app name is retrieved from an environment variable (set in java.c) It should be UTF8.
200     if (fApplicationName == nil) {
201         char mainClassEnvVar[80];
202         snprintf(mainClassEnvVar, sizeof(mainClassEnvVar), &quot;JAVA_MAIN_CLASS_%d&quot;, getpid());
203         char *mainClass = getenv(mainClassEnvVar);
204         if (mainClass != NULL) {
205             fApplicationName = [NSString stringWithUTF8String:mainClass];
206             unsetenv(mainClassEnvVar);
207 
208             NSRange lastPeriod = [fApplicationName rangeOfString:@&quot;.&quot; options:NSBackwardsSearch];
209             if (lastPeriod.location != NSNotFound) {
210                 fApplicationName = [fApplicationName substringFromIndex:lastPeriod.location + 1];
211             }
212         }
213     }
214 
215     // The dock name is nil for double-clickable Java apps (bundled and Web Start apps)
216     // When that happens get the display name, and if that&#39;s not available fall back to
217     // CFBundleName.
218     NSBundle *mainBundle = [NSBundle mainBundle];
219     if (fApplicationName == nil) {
220         fApplicationName = (NSString *)[mainBundle objectForInfoDictionaryKey:@&quot;CFBundleDisplayName&quot;];
221 
222         if (fApplicationName == nil) {
223             fApplicationName = (NSString *)[mainBundle objectForInfoDictionaryKey:(NSString *)kCFBundleNameKey];
224 
225             if (fApplicationName == nil) {
226                 fApplicationName = (NSString *)[mainBundle objectForInfoDictionaryKey: (NSString *)kCFBundleExecutableKey];
227 
228                 if (fApplicationName == nil) {
229                     // Name of last resort is the last part of the applicatoin name without the .app (consistent with CopyProcessName)
230                     fApplicationName = [[mainBundle bundlePath] lastPathComponent];
231 
232                     if ([fApplicationName hasSuffix:@&quot;.app&quot;]) {
233                         fApplicationName = [fApplicationName stringByDeletingPathExtension];
234                     }
235                 }
236             }
237         }
238     }
239 
240     // We&#39;re all done trying to determine the app name.  Hold on to it.
241     [fApplicationName retain];
242 
243     NSDictionary *registrationOptions = [NSMutableDictionary dictionaryWithObject:fApplicationName forKey:@&quot;JRSAppNameKey&quot;];
244 
245     NSString *launcherType = [PropertiesUtilities javaSystemPropertyForKey:@&quot;sun.java.launcher&quot; withEnv:env];
246     if ([@&quot;SUN_STANDARD&quot; isEqualToString:launcherType]) {
247         [registrationOptions setValue:[NSNumber numberWithBool:YES] forKey:@&quot;JRSAppIsCommandLineKey&quot;];
248     }
249 
250     NSString *uiElementProp = [PropertiesUtilities javaSystemPropertyForKey:@&quot;apple.awt.UIElement&quot; withEnv:env];
251     if ([@&quot;true&quot; isCaseInsensitiveLike:uiElementProp]) {
252         [registrationOptions setValue:[NSNumber numberWithBool:YES] forKey:@&quot;JRSAppIsUIElementKey&quot;];
253     }
254 
255     NSString *backgroundOnlyProp = [PropertiesUtilities javaSystemPropertyForKey:@&quot;apple.awt.BackgroundOnly&quot; withEnv:env];
256     if ([@&quot;true&quot; isCaseInsensitiveLike:backgroundOnlyProp]) {
257         [registrationOptions setValue:[NSNumber numberWithBool:YES] forKey:@&quot;JRSAppIsBackgroundOnlyKey&quot;];
258     }
259 
260     // TODO replace with direct call
261     // [JRSAppKitAWT registerAWTAppWithOptions:registrationOptions];
262     // and remove below transform/activate/run hack
263 
264     id jrsAppKitAWTClass = objc_getClass(&quot;JRSAppKitAWT&quot;);
265     SEL registerSel = @selector(registerAWTAppWithOptions:);
266     if ([jrsAppKitAWTClass respondsToSelector:registerSel]) {
267         [jrsAppKitAWTClass performSelector:registerSel withObject:registrationOptions];
268         return;
269     }
270 
271 // HACK BEGIN
272     // The following is necessary to make the java process behave like a
273     // proper foreground application...
274     [JNFRunLoop performOnMainThreadWaiting:NO withBlock:^(){
275         ProcessSerialNumber psn;
276         GetCurrentProcess(&amp;psn);
277         TransformProcessType(&amp;psn, kProcessTransformToForegroundApplication);
278 
279         [NSApp activateIgnoringOtherApps:YES];
280         [NSApp run];
281     }];
282 // HACK END
283 }
284 
285 - (void) setDockIconWithEnv:(JNIEnv *)env {
286     NSString *theIconPath = nil;
287 
288     // The following environment variable is set in java.c. It is probably UTF8.
289     char envVar[80];
290     snprintf(envVar, sizeof(envVar), &quot;APP_ICON_%d&quot;, getpid());
291     char *appIcon = getenv(envVar);
292     if (appIcon != NULL) {
293         theIconPath = [NSString stringWithUTF8String:appIcon];
294         unsetenv(envVar);
295     }
296 
297     if (theIconPath == nil) {
298         theIconPath = [PropertiesUtilities javaSystemPropertyForKey:@&quot;apple.awt.application.icon&quot; withEnv:env];
299     }
300 
301     // Use the path specified to get the icon image
302     NSImage* iconImage = nil;
303     if (theIconPath != nil) {
304         iconImage = [[NSImage alloc] initWithContentsOfFile:theIconPath];
305     }
306 
307     // If no icon file was specified or we failed to get the icon image
308     // and there is no bundle&#39;s icon, then use the default icon
309     if (iconImage == nil) {
310         NSString* bundleIcon = [[NSBundle mainBundle] objectForInfoDictionaryKey:@&quot;CFBundleIconFile&quot;];
311         if (bundleIcon == nil) {
312             NSData* iconData;
313             iconData = [[NSData alloc] initWithBytesNoCopy: sAWTIconData length: sizeof(sAWTIconData) freeWhenDone: NO];
314             iconImage = [[NSImage alloc] initWithData: iconData];
315             [iconData release];
316         }
317     }
318 
319     // Set up the dock icon if we have an icon image.
320     if (iconImage != nil) {
321         [NSApp setApplicationIconImage:iconImage];
322         [iconImage release];
323     }
324 }
325 
326 + (void) runAWTLoopWithApp:(NSApplication*)app {
327     NSAutoreleasePool *pool = [NSAutoreleasePool new];
328 
329     // Make sure that when we run in AWTRunLoopMode we don&#39;t exit randomly
330     [[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:[JNFRunLoop javaRunLoopMode]];
331 
332     do {
333         @try {
334             [app run];
335         } @catch (NSException* e) {
336             NSLog(@&quot;Apple AWT Startup Exception: %@&quot;, [e description]);
337             NSLog(@&quot;Apple AWT Restarting Native Event Thread&quot;);
338 
339             [app stop:app];
340         }
341     } while (YES);
342 
343     [pool drain];
344 }
345 
346 - (BOOL)usingDefaultNib {
347     return sUsingDefaultNIB;
348 }
349 
350 - (void)orderFrontStandardAboutPanelWithOptions:(NSDictionary *)optionsDictionary {
351     if (!optionsDictionary) {
352         optionsDictionary = [NSMutableDictionary dictionaryWithCapacity:2];
353         [optionsDictionary setValue:[[[[[NSApp mainMenu] itemAtIndex:0] submenu] itemAtIndex:0] title] forKey:@&quot;ApplicationName&quot;];
354         if (![NSImage imageNamed:@&quot;NSApplicationIcon&quot;]) {
355             [optionsDictionary setValue:[NSApp applicationIconImage] forKey:@&quot;ApplicationIcon&quot;];
356         }
357     }
358 
359     [super orderFrontStandardAboutPanelWithOptions:optionsDictionary];
360 }
361 
362 #define DRAGMASK (NSMouseMovedMask | NSLeftMouseDraggedMask | NSRightMouseDownMask | NSRightMouseDraggedMask | NSLeftMouseUpMask | NSRightMouseUpMask | NSFlagsChangedMask | NSKeyDownMask)
363 
364 #if defined(MAC_OS_X_VERSION_10_12) &amp;&amp; __LP64__
365    // 10.12 changed `mask` to NSEventMask (unsigned long long) for x86_64 builds.
366 - (NSEvent *)nextEventMatchingMask:(NSEventMask)mask
367 #else
368 - (NSEvent *)nextEventMatchingMask:(NSUInteger)mask
369 #endif
370 untilDate:(NSDate *)expiration inMode:(NSString *)mode dequeue:(BOOL)deqFlag {
371     if (mask == DRAGMASK &amp;&amp; [((NSString *)kCFRunLoopDefaultMode) isEqual:mode]) {
372         postEventDuringEventSynthesis = YES;
373     }
374 
375     NSEvent *event = [super nextEventMatchingMask:mask untilDate:expiration inMode:mode dequeue: deqFlag];
376     postEventDuringEventSynthesis = NO;
377 
378     return event;
379 }
380 
381 // NSTimeInterval has microseconds precision
382 #define TS_EQUAL(ts1, ts2) (fabs((ts1) - (ts2)) &lt; 1e-6)
383 
384 - (void)sendEvent:(NSEvent *)event
385 {
386     if ([event type] == NSApplicationDefined
387             &amp;&amp; TS_EQUAL([event timestamp], dummyEventTimestamp)
<a name="4" id="anc4"></a><span class="line-modified">388             &amp;&amp; (short)[event subtype] == NativeSyncQueueEvent</span>
<span class="line-added">389             &amp;&amp; [event data1] == NativeSyncQueueEvent</span>
<span class="line-added">390             &amp;&amp; [event data2] == NativeSyncQueueEvent) {</span>
391         [seenDummyEventLock lockWhenCondition:NO];
392         [seenDummyEventLock unlockWithCondition:YES];
<a name="5" id="anc5"></a><span class="line-modified">393     } else if ([event type] == NSApplicationDefined</span>
<span class="line-modified">394                &amp;&amp; (short)[event subtype] == ExecuteBlockEvent</span>
<span class="line-added">395                &amp;&amp; [event data1] != 0 &amp;&amp; [event data2] == ExecuteBlockEvent) {</span>
396         void (^block)() = (void (^)()) [event data1];
397         block();
398         [block release];
399     } else if ([event type] == NSKeyUp &amp;&amp; ([event modifierFlags] &amp; NSCommandKeyMask)) {
400         // Cocoa won&#39;t send us key up event when releasing a key while Cmd is down,
401         // so we have to do it ourselves.
402         [[self keyWindow] sendEvent:event];
403     } else {
404         [super sendEvent:event];
405     }
406 }
407 
408 /*
409  * Posts the block to the AppKit event queue which will be executed
410  * on the main AppKit loop.
411  * While running nested loops this event will be ignored.
412  */
413 - (void)postRunnableEvent:(void (^)())block
414 {
415     void (^copy)() = [block copy];
416     NSInteger encode = (NSInteger) copy;
417     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
418     NSEvent* event = [NSEvent otherEventWithType: NSApplicationDefined
419                                         location: NSMakePoint(0,0)
420                                    modifierFlags: 0
421                                        timestamp: 0
422                                     windowNumber: 0
423                                          context: nil
424                                          subtype: ExecuteBlockEvent
425                                            data1: encode
<a name="6" id="anc6"></a><span class="line-modified">426                                            data2: ExecuteBlockEvent];</span>
427 
428     [NSApp postEvent: event atStart: NO];
429     [pool drain];
430 }
431 
432 - (void)postDummyEvent:(bool)useCocoa {
433     seenDummyEventLock = [[NSConditionLock alloc] initWithCondition:NO];
434     dummyEventTimestamp = [NSProcessInfo processInfo].systemUptime;
435 
436     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
437     NSEvent* event = [NSEvent otherEventWithType: NSApplicationDefined
438                                         location: NSMakePoint(0,0)
439                                    modifierFlags: 0
440                                        timestamp: dummyEventTimestamp
441                                     windowNumber: 0
442                                          context: nil
443                                          subtype: NativeSyncQueueEvent
<a name="7" id="anc7"></a><span class="line-modified">444                                            data1: NativeSyncQueueEvent</span>
<span class="line-modified">445                                            data2: NativeSyncQueueEvent];</span>
446     if (useCocoa) {
447         [NSApp postEvent:event atStart:NO];
448     } else {
449         ProcessSerialNumber psn;
450         GetCurrentProcess(&amp;psn);
451         CGEventPostToPSN(&amp;psn, [event CGEvent]);
452     }
453     [pool drain];
454 }
455 
456 - (void)waitForDummyEvent:(double)timeout {
457     bool unlock = true;
458     if (timeout &gt;= 0) {
459         double sec = timeout / 1000;
460         unlock = [seenDummyEventLock lockWhenCondition:YES
461                                beforeDate:[NSDate dateWithTimeIntervalSinceNow:sec]];
462     } else {
463         [seenDummyEventLock lockWhenCondition:YES];
464     }
465     if (unlock) {
466         [seenDummyEventLock unlock];
467     }
468     [seenDummyEventLock release];
469 
470     seenDummyEventLock = nil;
471 }
472 
473 @end
474 
475 
476 void OSXAPP_SetApplicationDelegate(id &lt;NSApplicationDelegate&gt; newdelegate)
477 {
478 AWT_ASSERT_APPKIT_THREAD;
479     applicationDelegate = newdelegate;
480 
481     if (NSApp != nil) {
482         [NSApp setDelegate: applicationDelegate];
483 
484         if (applicationDelegate &amp;&amp; qad) {
485             [qad processQueuedEventsWithTargetDelegate: applicationDelegate];
486             qad = nil;
487         }
488     }
489 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>