<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/macosx/native/libosxapp/NSApplicationAWT.m</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../libjsound/PLATFORM_API_MacOSX_Ports.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../libsplashscreen/splashscreen_sys.m.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/macosx/native/libosxapp/NSApplicationAWT.m</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 33 #import &quot;QueuingApplicationDelegate.h&quot;
 34 #import &quot;AWTIconData.h&quot;
 35 
 36 /*
 37  * Declare library specific JNI_Onload entry if static build
 38  */
 39 DEF_STATIC_JNI_OnLoad
 40 
 41 static BOOL sUsingDefaultNIB = YES;
 42 static NSString *SHARED_FRAMEWORK_BUNDLE = @&quot;/System/Library/Frameworks/JavaVM.framework&quot;;
 43 static id &lt;NSApplicationDelegate&gt; applicationDelegate = nil;
 44 static QueuingApplicationDelegate * qad = nil;
 45 
 46 // Flag used to indicate to the Plugin2 event synthesis code to do a postEvent instead of sendEvent
 47 BOOL postEventDuringEventSynthesis = NO;
 48 
 49 /**
 50  * Subtypes of NSApplicationDefined, which are used for custom events.
 51  */
 52 enum {
<span class="line-modified"> 53     ExecuteBlockEvent, NativeSyncQueueEvent</span>
 54 };
 55 
 56 @implementation NSApplicationAWT
 57 
 58 - (id) init
 59 {
 60     // Headless: NO
 61     // Embedded: NO
 62     // Multiple Calls: NO
 63     //  Caller: +[NSApplication sharedApplication]
 64 
 65 AWT_ASSERT_APPKIT_THREAD;
 66     fApplicationName = nil;
 67     dummyEventTimestamp = 0.0;
 68     seenDummyEventLock = nil;
 69 
 70 
 71     // NSApplication will call _RegisterApplication with the application&#39;s bundle, but there may not be one.
 72     // So, we need to call it ourselves to ensure the app is set up properly.
 73     [self registerWithProcessManager];
 74 
 75     return [super init];
 76 }
 77 
 78 - (void)dealloc
 79 {
 80     [[NSUserNotificationCenter defaultUserNotificationCenter] setDelegate:nil];
 81 
 82     [fApplicationName release];
 83     fApplicationName = nil;
 84 
 85     [super dealloc];
 86 }
 87 
 88 - (void)finishLaunching
 89 {
 90 AWT_ASSERT_APPKIT_THREAD;
 91 
 92     JNIEnv *env = [ThreadUtilities getJNIEnv];
 93 



















 94     // Get default nib file location
 95     // NOTE: This should learn about the current java.version. Probably best thru
 96     //  the Makefile system&#39;s -DFRAMEWORK_VERSION define. Need to be able to pass this
 97     //  thru to PB from the Makefile system and for local builds.
 98     NSString *defaultNibFile = [PropertiesUtilities javaSystemPropertyForKey:@&quot;apple.awt.application.nib&quot; withEnv:env];
 99     if (!defaultNibFile) {
100         NSBundle *javaBundle = [NSBundle bundleWithPath:SHARED_FRAMEWORK_BUNDLE];
101         defaultNibFile = [javaBundle pathForResource:@&quot;DefaultApp&quot; ofType:@&quot;nib&quot;];
102     } else {
103         sUsingDefaultNIB = NO;
104     }
105 
106     [NSBundle loadNibFile:defaultNibFile externalNameTable: [NSDictionary dictionaryWithObject:self forKey:@&quot;NSOwner&quot;] withZone:nil];
107 
108     // Set user defaults to not try to parse application arguments.
109     NSUserDefaults * defs = [NSUserDefaults standardUserDefaults];
110     NSDictionary * noOpenDict = [NSDictionary dictionaryWithObject:@&quot;NO&quot; forKey:@&quot;NSTreatUnknownArgumentsAsOpen&quot;];
111     [defs registerDefaults:noOpenDict];
112 
113     // Fix up the dock icon now that we are registered with CAS and the Dock.
</pre>
<hr />
<pre>
349 - (NSEvent *)nextEventMatchingMask:(NSUInteger)mask
350 #endif
351 untilDate:(NSDate *)expiration inMode:(NSString *)mode dequeue:(BOOL)deqFlag {
352     if (mask == DRAGMASK &amp;&amp; [((NSString *)kCFRunLoopDefaultMode) isEqual:mode]) {
353         postEventDuringEventSynthesis = YES;
354     }
355 
356     NSEvent *event = [super nextEventMatchingMask:mask untilDate:expiration inMode:mode dequeue: deqFlag];
357     postEventDuringEventSynthesis = NO;
358 
359     return event;
360 }
361 
362 // NSTimeInterval has microseconds precision
363 #define TS_EQUAL(ts1, ts2) (fabs((ts1) - (ts2)) &lt; 1e-6)
364 
365 - (void)sendEvent:(NSEvent *)event
366 {
367     if ([event type] == NSApplicationDefined
368             &amp;&amp; TS_EQUAL([event timestamp], dummyEventTimestamp)
<span class="line-modified">369             &amp;&amp; [event subtype] == NativeSyncQueueEvent) {</span>


370         [seenDummyEventLock lockWhenCondition:NO];
371         [seenDummyEventLock unlockWithCondition:YES];
<span class="line-modified">372 </span>
<span class="line-modified">373     } else if ([event type] == NSApplicationDefined &amp;&amp; [event subtype] == ExecuteBlockEvent) {</span>

374         void (^block)() = (void (^)()) [event data1];
375         block();
376         [block release];
377     } else if ([event type] == NSKeyUp &amp;&amp; ([event modifierFlags] &amp; NSCommandKeyMask)) {
378         // Cocoa won&#39;t send us key up event when releasing a key while Cmd is down,
379         // so we have to do it ourselves.
380         [[self keyWindow] sendEvent:event];
381     } else {
382         [super sendEvent:event];
383     }
384 }
385 
386 /*
387  * Posts the block to the AppKit event queue which will be executed
388  * on the main AppKit loop.
389  * While running nested loops this event will be ignored.
390  */
391 - (void)postRunnableEvent:(void (^)())block
392 {
393     void (^copy)() = [block copy];
394     NSInteger encode = (NSInteger) copy;
395     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
396     NSEvent* event = [NSEvent otherEventWithType: NSApplicationDefined
397                                         location: NSMakePoint(0,0)
398                                    modifierFlags: 0
399                                        timestamp: 0
400                                     windowNumber: 0
401                                          context: nil
402                                          subtype: ExecuteBlockEvent
403                                            data1: encode
<span class="line-modified">404                                            data2: 0];</span>
405 
406     [NSApp postEvent: event atStart: NO];
407     [pool drain];
408 }
409 
410 - (void)postDummyEvent:(bool)useCocoa {
411     seenDummyEventLock = [[NSConditionLock alloc] initWithCondition:NO];
412     dummyEventTimestamp = [NSProcessInfo processInfo].systemUptime;
413 
414     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
415     NSEvent* event = [NSEvent otherEventWithType: NSApplicationDefined
416                                         location: NSMakePoint(0,0)
417                                    modifierFlags: 0
418                                        timestamp: dummyEventTimestamp
419                                     windowNumber: 0
420                                          context: nil
421                                          subtype: NativeSyncQueueEvent
<span class="line-modified">422                                            data1: 0</span>
<span class="line-modified">423                                            data2: 0];</span>
424     if (useCocoa) {
425         [NSApp postEvent:event atStart:NO];
426     } else {
427         ProcessSerialNumber psn;
428         GetCurrentProcess(&amp;psn);
429         CGEventPostToPSN(&amp;psn, [event CGEvent]);
430     }
431     [pool drain];
432 }
433 
434 - (void)waitForDummyEvent:(double)timeout {
435     bool unlock = true;
436     if (timeout &gt;= 0) {
437         double sec = timeout / 1000;
438         unlock = [seenDummyEventLock lockWhenCondition:YES
439                                beforeDate:[NSDate dateWithTimeIntervalSinceNow:sec]];
440     } else {
441         [seenDummyEventLock lockWhenCondition:YES];
442     }
443     if (unlock) {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 33 #import &quot;QueuingApplicationDelegate.h&quot;
 34 #import &quot;AWTIconData.h&quot;
 35 
 36 /*
 37  * Declare library specific JNI_Onload entry if static build
 38  */
 39 DEF_STATIC_JNI_OnLoad
 40 
 41 static BOOL sUsingDefaultNIB = YES;
 42 static NSString *SHARED_FRAMEWORK_BUNDLE = @&quot;/System/Library/Frameworks/JavaVM.framework&quot;;
 43 static id &lt;NSApplicationDelegate&gt; applicationDelegate = nil;
 44 static QueuingApplicationDelegate * qad = nil;
 45 
 46 // Flag used to indicate to the Plugin2 event synthesis code to do a postEvent instead of sendEvent
 47 BOOL postEventDuringEventSynthesis = NO;
 48 
 49 /**
 50  * Subtypes of NSApplicationDefined, which are used for custom events.
 51  */
 52 enum {
<span class="line-modified"> 53     ExecuteBlockEvent = 777, NativeSyncQueueEvent</span>
 54 };
 55 
 56 @implementation NSApplicationAWT
 57 
 58 - (id) init
 59 {
 60     // Headless: NO
 61     // Embedded: NO
 62     // Multiple Calls: NO
 63     //  Caller: +[NSApplication sharedApplication]
 64 
 65 AWT_ASSERT_APPKIT_THREAD;
 66     fApplicationName = nil;
 67     dummyEventTimestamp = 0.0;
 68     seenDummyEventLock = nil;
 69 
 70 
 71     // NSApplication will call _RegisterApplication with the application&#39;s bundle, but there may not be one.
 72     // So, we need to call it ourselves to ensure the app is set up properly.
 73     [self registerWithProcessManager];
 74 
 75     return [super init];
 76 }
 77 
 78 - (void)dealloc
 79 {
 80     [[NSUserNotificationCenter defaultUserNotificationCenter] setDelegate:nil];
 81 
 82     [fApplicationName release];
 83     fApplicationName = nil;
 84 
 85     [super dealloc];
 86 }
 87 
 88 - (void)finishLaunching
 89 {
 90 AWT_ASSERT_APPKIT_THREAD;
 91 
 92     JNIEnv *env = [ThreadUtilities getJNIEnv];
 93 
<span class="line-added"> 94     SEL appearanceSel = @selector(setAppearance:); // macOS 10.14+</span>
<span class="line-added"> 95     if ([self respondsToSelector:appearanceSel]) {</span>
<span class="line-added"> 96         NSString *appearanceProp = [PropertiesUtilities</span>
<span class="line-added"> 97                 javaSystemPropertyForKey:@&quot;apple.awt.application.appearance&quot;</span>
<span class="line-added"> 98                                  withEnv:env];</span>
<span class="line-added"> 99         if (![@&quot;system&quot; isEqual:appearanceProp]) {</span>
<span class="line-added">100             // by default use light mode, because dark mode is not supported yet</span>
<span class="line-added">101             NSAppearance *appearance = [NSAppearance appearanceNamed:NSAppearanceNameAqua];</span>
<span class="line-added">102             if (appearanceProp != nil) {</span>
<span class="line-added">103                 NSAppearance *requested = [NSAppearance appearanceNamed:appearanceProp];</span>
<span class="line-added">104                 if (requested != nil) {</span>
<span class="line-added">105                     appearance = requested;</span>
<span class="line-added">106                 }</span>
<span class="line-added">107             }</span>
<span class="line-added">108             // [self setAppearance:appearance];</span>
<span class="line-added">109             [self performSelector:appearanceSel withObject:appearance];</span>
<span class="line-added">110         }</span>
<span class="line-added">111     }</span>
<span class="line-added">112 </span>
113     // Get default nib file location
114     // NOTE: This should learn about the current java.version. Probably best thru
115     //  the Makefile system&#39;s -DFRAMEWORK_VERSION define. Need to be able to pass this
116     //  thru to PB from the Makefile system and for local builds.
117     NSString *defaultNibFile = [PropertiesUtilities javaSystemPropertyForKey:@&quot;apple.awt.application.nib&quot; withEnv:env];
118     if (!defaultNibFile) {
119         NSBundle *javaBundle = [NSBundle bundleWithPath:SHARED_FRAMEWORK_BUNDLE];
120         defaultNibFile = [javaBundle pathForResource:@&quot;DefaultApp&quot; ofType:@&quot;nib&quot;];
121     } else {
122         sUsingDefaultNIB = NO;
123     }
124 
125     [NSBundle loadNibFile:defaultNibFile externalNameTable: [NSDictionary dictionaryWithObject:self forKey:@&quot;NSOwner&quot;] withZone:nil];
126 
127     // Set user defaults to not try to parse application arguments.
128     NSUserDefaults * defs = [NSUserDefaults standardUserDefaults];
129     NSDictionary * noOpenDict = [NSDictionary dictionaryWithObject:@&quot;NO&quot; forKey:@&quot;NSTreatUnknownArgumentsAsOpen&quot;];
130     [defs registerDefaults:noOpenDict];
131 
132     // Fix up the dock icon now that we are registered with CAS and the Dock.
</pre>
<hr />
<pre>
368 - (NSEvent *)nextEventMatchingMask:(NSUInteger)mask
369 #endif
370 untilDate:(NSDate *)expiration inMode:(NSString *)mode dequeue:(BOOL)deqFlag {
371     if (mask == DRAGMASK &amp;&amp; [((NSString *)kCFRunLoopDefaultMode) isEqual:mode]) {
372         postEventDuringEventSynthesis = YES;
373     }
374 
375     NSEvent *event = [super nextEventMatchingMask:mask untilDate:expiration inMode:mode dequeue: deqFlag];
376     postEventDuringEventSynthesis = NO;
377 
378     return event;
379 }
380 
381 // NSTimeInterval has microseconds precision
382 #define TS_EQUAL(ts1, ts2) (fabs((ts1) - (ts2)) &lt; 1e-6)
383 
384 - (void)sendEvent:(NSEvent *)event
385 {
386     if ([event type] == NSApplicationDefined
387             &amp;&amp; TS_EQUAL([event timestamp], dummyEventTimestamp)
<span class="line-modified">388             &amp;&amp; (short)[event subtype] == NativeSyncQueueEvent</span>
<span class="line-added">389             &amp;&amp; [event data1] == NativeSyncQueueEvent</span>
<span class="line-added">390             &amp;&amp; [event data2] == NativeSyncQueueEvent) {</span>
391         [seenDummyEventLock lockWhenCondition:NO];
392         [seenDummyEventLock unlockWithCondition:YES];
<span class="line-modified">393     } else if ([event type] == NSApplicationDefined</span>
<span class="line-modified">394                &amp;&amp; (short)[event subtype] == ExecuteBlockEvent</span>
<span class="line-added">395                &amp;&amp; [event data1] != 0 &amp;&amp; [event data2] == ExecuteBlockEvent) {</span>
396         void (^block)() = (void (^)()) [event data1];
397         block();
398         [block release];
399     } else if ([event type] == NSKeyUp &amp;&amp; ([event modifierFlags] &amp; NSCommandKeyMask)) {
400         // Cocoa won&#39;t send us key up event when releasing a key while Cmd is down,
401         // so we have to do it ourselves.
402         [[self keyWindow] sendEvent:event];
403     } else {
404         [super sendEvent:event];
405     }
406 }
407 
408 /*
409  * Posts the block to the AppKit event queue which will be executed
410  * on the main AppKit loop.
411  * While running nested loops this event will be ignored.
412  */
413 - (void)postRunnableEvent:(void (^)())block
414 {
415     void (^copy)() = [block copy];
416     NSInteger encode = (NSInteger) copy;
417     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
418     NSEvent* event = [NSEvent otherEventWithType: NSApplicationDefined
419                                         location: NSMakePoint(0,0)
420                                    modifierFlags: 0
421                                        timestamp: 0
422                                     windowNumber: 0
423                                          context: nil
424                                          subtype: ExecuteBlockEvent
425                                            data1: encode
<span class="line-modified">426                                            data2: ExecuteBlockEvent];</span>
427 
428     [NSApp postEvent: event atStart: NO];
429     [pool drain];
430 }
431 
432 - (void)postDummyEvent:(bool)useCocoa {
433     seenDummyEventLock = [[NSConditionLock alloc] initWithCondition:NO];
434     dummyEventTimestamp = [NSProcessInfo processInfo].systemUptime;
435 
436     NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
437     NSEvent* event = [NSEvent otherEventWithType: NSApplicationDefined
438                                         location: NSMakePoint(0,0)
439                                    modifierFlags: 0
440                                        timestamp: dummyEventTimestamp
441                                     windowNumber: 0
442                                          context: nil
443                                          subtype: NativeSyncQueueEvent
<span class="line-modified">444                                            data1: NativeSyncQueueEvent</span>
<span class="line-modified">445                                            data2: NativeSyncQueueEvent];</span>
446     if (useCocoa) {
447         [NSApp postEvent:event atStart:NO];
448     } else {
449         ProcessSerialNumber psn;
450         GetCurrentProcess(&amp;psn);
451         CGEventPostToPSN(&amp;psn, [event CGEvent]);
452     }
453     [pool drain];
454 }
455 
456 - (void)waitForDummyEvent:(double)timeout {
457     bool unlock = true;
458     if (timeout &gt;= 0) {
459         double sec = timeout / 1000;
460         unlock = [seenDummyEventLock lockWhenCondition:YES
461                                beforeDate:[NSDate dateWithTimeIntervalSinceNow:sec]];
462     } else {
463         [seenDummyEventLock lockWhenCondition:YES];
464     }
465     if (unlock) {
</pre>
</td>
</tr>
</table>
<center><a href="../libjsound/PLATFORM_API_MacOSX_Ports.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../libsplashscreen/splashscreen_sys.m.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>