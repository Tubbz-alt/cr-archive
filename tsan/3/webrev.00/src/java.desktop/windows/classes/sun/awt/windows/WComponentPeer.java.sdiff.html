<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/classes/sun/awt/windows/WComponentPeer.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="WChoicePeer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="WFramePeer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/classes/sun/awt/windows/WComponentPeer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1996, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 package sun.awt.windows;
  26 
<span class="line-modified">  27 import java.awt.*;</span>
<span class="line-modified">  28 import java.awt.peer.*;</span>
<span class="line-modified">  29 import java.awt.image.VolatileImage;</span>
<span class="line-modified">  30 import sun.awt.RepaintArea;</span>
<span class="line-modified">  31 import sun.awt.image.SunVolatileImage;</span>
<span class="line-modified">  32 import sun.awt.image.ToolkitImage;</span>
<span class="line-modified">  33 import java.awt.image.BufferedImage;</span>
<span class="line-modified">  34 import java.awt.image.ImageProducer;</span>
<span class="line-modified">  35 import java.awt.image.ImageObserver;</span>
<span class="line-modified">  36 import java.awt.image.ColorModel;</span>
<span class="line-modified">  37 import java.awt.event.PaintEvent;</span>










  38 import java.awt.event.InvocationEvent;
  39 import java.awt.event.KeyEvent;
<span class="line-removed">  40 import java.awt.event.FocusEvent;</span>
  41 import java.awt.event.MouseEvent;
  42 import java.awt.event.MouseWheelEvent;
<span class="line-modified">  43 import java.awt.event.InputEvent;</span>











  44 import sun.awt.Win32GraphicsConfig;
  45 import sun.awt.Win32GraphicsEnvironment;


  46 import sun.java2d.InvalidPipeException;
<span class="line-removed">  47 import sun.java2d.SurfaceData;</span>
  48 import sun.java2d.ScreenUpdateManager;

  49 import sun.java2d.d3d.D3DSurfaceData;
  50 import sun.java2d.opengl.OGLSurfaceData;
  51 import sun.java2d.pipe.Region;
<span class="line-removed">  52 import sun.awt.PaintEventDispatcher;</span>
<span class="line-removed">  53 import sun.awt.SunToolkit;</span>
<span class="line-removed">  54 import sun.awt.event.IgnorePaintEvent;</span>
<span class="line-removed">  55 </span>
<span class="line-removed">  56 import java.awt.dnd.DropTarget;</span>
<span class="line-removed">  57 import java.awt.dnd.peer.DropTargetPeer;</span>
<span class="line-removed">  58 import java.awt.geom.AffineTransform;</span>
<span class="line-removed">  59 import sun.awt.AWTAccessor;</span>
<span class="line-removed">  60 </span>
  61 import sun.util.logging.PlatformLogger;
  62 
  63 public abstract class WComponentPeer extends WObjectPeer
  64     implements ComponentPeer, DropTargetPeer
  65 {
  66     /**
  67      * Handle to native window
  68      */
  69     protected volatile long hwnd;
  70 
  71     private static final PlatformLogger log = PlatformLogger.getLogger(&quot;sun.awt.windows.WComponentPeer&quot;);
  72     private static final PlatformLogger shapeLog = PlatformLogger.getLogger(&quot;sun.awt.windows.shape.WComponentPeer&quot;);
  73     private static final PlatformLogger focusLog = PlatformLogger.getLogger(&quot;sun.awt.windows.focus.WComponentPeer&quot;);
  74 
  75     // ComponentPeer implementation
  76     SurfaceData surfaceData;
  77 
  78     private RepaintArea paintArea;
  79 
  80     protected Win32GraphicsConfig winGraphicsConfig;
</pre>
<hr />
<pre>
 562         }
 563         else {
 564             return null;
 565         }
 566     }
 567 
 568     // fallback default font object
 569     static final Font defaultFont = new Font(Font.DIALOG, Font.PLAIN, 12);
 570 
 571     @Override
 572     public Graphics getGraphics() {
 573         if (isDisposed()) {
 574             return null;
 575         }
 576 
 577         Component target = (Component)getTarget();
 578         Window window = SunToolkit.getContainingWindow(target);
 579         if (window != null) {
 580             final WWindowPeer wpeer = AWTAccessor.getComponentAccessor()
 581                                                  .getPeer(window);
<span class="line-modified"> 582             Graphics g = wpeer.getTranslucentGraphics();</span>
<span class="line-modified"> 583             // getTranslucentGraphics() returns non-null value for non-opaque windows only</span>
<span class="line-modified"> 584             if (g != null) {</span>
<span class="line-modified"> 585                 // Non-opaque windows do not support heavyweight children.</span>
<span class="line-modified"> 586                 // Redirect all painting to the Window&#39;s Graphics instead.</span>
<span class="line-modified"> 587                 // The caller is responsible for calling the</span>
<span class="line-modified"> 588                 // WindowPeer.updateWindow() after painting has finished.</span>
<span class="line-modified"> 589                 int x = 0, y = 0;</span>
<span class="line-modified"> 590                 for (Component c = target; c != window; c = c.getParent()) {</span>
<span class="line-modified"> 591                     x += c.getX();</span>
<span class="line-modified"> 592                     y += c.getY();</span>
<span class="line-modified"> 593                 }</span>

 594 
<span class="line-modified"> 595                 g.translate(x, y);</span>
<span class="line-modified"> 596                 g.clipRect(0, 0, target.getWidth(), target.getHeight());</span>
 597 
<span class="line-modified"> 598                 return g;</span>

 599             }
 600         }
 601 
 602         SurfaceData surfaceData = this.surfaceData;
 603         if (surfaceData != null) {
 604             /* Fix for bug 4746122. Color and Font shouldn&#39;t be null */
 605             Color bgColor = background;
 606             if (bgColor == null) {
 607                 bgColor = SystemColor.window;
 608             }
 609             Color fgColor = foreground;
 610             if (fgColor == null) {
 611                 fgColor = SystemColor.windowText;
 612             }
 613             Font font = this.font;
 614             if (font == null) {
 615                 font = defaultFont;
 616             }
 617             ScreenUpdateManager mgr =
 618                 ScreenUpdateManager.getInstance();
</pre>
<hr />
<pre>
 731                                                             (Component)target,
 732                                                             temporary,
 733                                                             focusedWindowChangeAllowed,
 734                                                             time, cause);
 735 
 736           case WKeyboardFocusManagerPeer.SNFH_SUCCESS_HANDLED:
 737               // Either lightweight or excessive request - all events are generated.
 738               return true;
 739         }
 740         return false;
 741     }
 742 
 743     private boolean rejectFocusRequestHelper(String logMsg) {
 744         if (focusLog.isLoggable(PlatformLogger.Level.FINER)) {
 745             focusLog.finer(logMsg);
 746         }
 747         WKeyboardFocusManagerPeer.removeLastFocusRequest((Component)target);
 748         return false;
 749     }
 750 
<span class="line-removed"> 751     @Override</span>
<span class="line-removed"> 752     public Image createImage(ImageProducer producer) {</span>
<span class="line-removed"> 753         return new ToolkitImage(producer);</span>
<span class="line-removed"> 754     }</span>
<span class="line-removed"> 755 </span>
 756     @Override
 757     public Image createImage(int width, int height) {
 758         Win32GraphicsConfig gc =
 759             (Win32GraphicsConfig)getGraphicsConfiguration();
 760         return gc.createAcceleratedImage((Component)target, width, height);
 761     }
 762 
 763     @Override
 764     public VolatileImage createVolatileImage(int width, int height) {
 765         return new SunVolatileImage((Component)target, width, height);
 766     }
 767 
<span class="line-removed"> 768     @Override</span>
<span class="line-removed"> 769     public boolean prepareImage(Image img, int w, int h, ImageObserver o) {</span>
<span class="line-removed"> 770         return Toolkit.getDefaultToolkit().prepareImage(img, w, h, o);</span>
<span class="line-removed"> 771     }</span>
<span class="line-removed"> 772 </span>
<span class="line-removed"> 773     @Override</span>
<span class="line-removed"> 774     public int checkImage(Image img, int w, int h, ImageObserver o) {</span>
<span class="line-removed"> 775         return Toolkit.getDefaultToolkit().checkImage(img, w, h, o);</span>
<span class="line-removed"> 776     }</span>
<span class="line-removed"> 777 </span>
 778     // Object overrides
 779 
 780     public String toString() {
 781         return getClass().getName() + &quot;[&quot; + target + &quot;]&quot;;
 782     }
 783 
 784     // Toolkit &amp; peer internals
 785 
 786     private int updateX1, updateY1, updateX2, updateY2;
 787 
 788     WComponentPeer(Component target) {
 789         this.target = target;
 790         this.paintArea = new RepaintArea();
 791         create(getNativeParent());
 792         // fix for 5088782: check if window object is created successfully
 793         checkCreation();
 794 
 795         createScreenSurface(false);
 796         initialize();
 797         start();  // Initialize enable/disable state, turn on callbacks
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1996, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 package sun.awt.windows;
  26 
<span class="line-modified">  27 import java.awt.AWTEvent;</span>
<span class="line-modified">  28 import java.awt.AWTException;</span>
<span class="line-modified">  29 import java.awt.BufferCapabilities;</span>
<span class="line-modified">  30 import java.awt.Color;</span>
<span class="line-modified">  31 import java.awt.Component;</span>
<span class="line-modified">  32 import java.awt.Container;</span>
<span class="line-modified">  33 import java.awt.Dimension;</span>
<span class="line-modified">  34 import java.awt.Font;</span>
<span class="line-modified">  35 import java.awt.FontMetrics;</span>
<span class="line-modified">  36 import java.awt.Graphics;</span>
<span class="line-modified">  37 import java.awt.GraphicsConfiguration;</span>
<span class="line-added">  38 import java.awt.GraphicsDevice;</span>
<span class="line-added">  39 import java.awt.Image;</span>
<span class="line-added">  40 import java.awt.Point;</span>
<span class="line-added">  41 import java.awt.Rectangle;</span>
<span class="line-added">  42 import java.awt.SystemColor;</span>
<span class="line-added">  43 import java.awt.Window;</span>
<span class="line-added">  44 import java.awt.dnd.DropTarget;</span>
<span class="line-added">  45 import java.awt.dnd.peer.DropTargetPeer;</span>
<span class="line-added">  46 import java.awt.event.FocusEvent;</span>
<span class="line-added">  47 import java.awt.event.InputEvent;</span>
  48 import java.awt.event.InvocationEvent;
  49 import java.awt.event.KeyEvent;

  50 import java.awt.event.MouseEvent;
  51 import java.awt.event.MouseWheelEvent;
<span class="line-modified">  52 import java.awt.event.PaintEvent;</span>
<span class="line-added">  53 import java.awt.geom.AffineTransform;</span>
<span class="line-added">  54 import java.awt.image.BufferedImage;</span>
<span class="line-added">  55 import java.awt.image.ColorModel;</span>
<span class="line-added">  56 import java.awt.image.VolatileImage;</span>
<span class="line-added">  57 import java.awt.peer.ComponentPeer;</span>
<span class="line-added">  58 import java.awt.peer.ContainerPeer;</span>
<span class="line-added">  59 </span>
<span class="line-added">  60 import sun.awt.AWTAccessor;</span>
<span class="line-added">  61 import sun.awt.PaintEventDispatcher;</span>
<span class="line-added">  62 import sun.awt.RepaintArea;</span>
<span class="line-added">  63 import sun.awt.SunToolkit;</span>
  64 import sun.awt.Win32GraphicsConfig;
  65 import sun.awt.Win32GraphicsEnvironment;
<span class="line-added">  66 import sun.awt.event.IgnorePaintEvent;</span>
<span class="line-added">  67 import sun.awt.image.SunVolatileImage;</span>
  68 import sun.java2d.InvalidPipeException;

  69 import sun.java2d.ScreenUpdateManager;
<span class="line-added">  70 import sun.java2d.SurfaceData;</span>
  71 import sun.java2d.d3d.D3DSurfaceData;
  72 import sun.java2d.opengl.OGLSurfaceData;
  73 import sun.java2d.pipe.Region;









  74 import sun.util.logging.PlatformLogger;
  75 
  76 public abstract class WComponentPeer extends WObjectPeer
  77     implements ComponentPeer, DropTargetPeer
  78 {
  79     /**
  80      * Handle to native window
  81      */
  82     protected volatile long hwnd;
  83 
  84     private static final PlatformLogger log = PlatformLogger.getLogger(&quot;sun.awt.windows.WComponentPeer&quot;);
  85     private static final PlatformLogger shapeLog = PlatformLogger.getLogger(&quot;sun.awt.windows.shape.WComponentPeer&quot;);
  86     private static final PlatformLogger focusLog = PlatformLogger.getLogger(&quot;sun.awt.windows.focus.WComponentPeer&quot;);
  87 
  88     // ComponentPeer implementation
  89     SurfaceData surfaceData;
  90 
  91     private RepaintArea paintArea;
  92 
  93     protected Win32GraphicsConfig winGraphicsConfig;
</pre>
<hr />
<pre>
 575         }
 576         else {
 577             return null;
 578         }
 579     }
 580 
 581     // fallback default font object
 582     static final Font defaultFont = new Font(Font.DIALOG, Font.PLAIN, 12);
 583 
 584     @Override
 585     public Graphics getGraphics() {
 586         if (isDisposed()) {
 587             return null;
 588         }
 589 
 590         Component target = (Component)getTarget();
 591         Window window = SunToolkit.getContainingWindow(target);
 592         if (window != null) {
 593             final WWindowPeer wpeer = AWTAccessor.getComponentAccessor()
 594                                                  .getPeer(window);
<span class="line-modified"> 595             if (wpeer != null) {</span>
<span class="line-modified"> 596                 Graphics g = wpeer.getTranslucentGraphics();</span>
<span class="line-modified"> 597                 // getTranslucentGraphics() returns non-null value for non-opaque windows only</span>
<span class="line-modified"> 598                 if (g != null) {</span>
<span class="line-modified"> 599                     // Non-opaque windows do not support heavyweight children.</span>
<span class="line-modified"> 600                     // Redirect all painting to the Window&#39;s Graphics instead.</span>
<span class="line-modified"> 601                     // The caller is responsible for calling the</span>
<span class="line-modified"> 602                     // WindowPeer.updateWindow() after painting has finished.</span>
<span class="line-modified"> 603                     int x = 0, y = 0;</span>
<span class="line-modified"> 604                     for (Component c = target; c != window; c = c.getParent()) {</span>
<span class="line-modified"> 605                         x += c.getX();</span>
<span class="line-modified"> 606                         y += c.getY();</span>
<span class="line-added"> 607                     }</span>
 608 
<span class="line-modified"> 609                     g.translate(x, y);</span>
<span class="line-modified"> 610                     g.clipRect(0, 0, target.getWidth(), target.getHeight());</span>
 611 
<span class="line-modified"> 612                     return g;</span>
<span class="line-added"> 613                 }</span>
 614             }
 615         }
 616 
 617         SurfaceData surfaceData = this.surfaceData;
 618         if (surfaceData != null) {
 619             /* Fix for bug 4746122. Color and Font shouldn&#39;t be null */
 620             Color bgColor = background;
 621             if (bgColor == null) {
 622                 bgColor = SystemColor.window;
 623             }
 624             Color fgColor = foreground;
 625             if (fgColor == null) {
 626                 fgColor = SystemColor.windowText;
 627             }
 628             Font font = this.font;
 629             if (font == null) {
 630                 font = defaultFont;
 631             }
 632             ScreenUpdateManager mgr =
 633                 ScreenUpdateManager.getInstance();
</pre>
<hr />
<pre>
 746                                                             (Component)target,
 747                                                             temporary,
 748                                                             focusedWindowChangeAllowed,
 749                                                             time, cause);
 750 
 751           case WKeyboardFocusManagerPeer.SNFH_SUCCESS_HANDLED:
 752               // Either lightweight or excessive request - all events are generated.
 753               return true;
 754         }
 755         return false;
 756     }
 757 
 758     private boolean rejectFocusRequestHelper(String logMsg) {
 759         if (focusLog.isLoggable(PlatformLogger.Level.FINER)) {
 760             focusLog.finer(logMsg);
 761         }
 762         WKeyboardFocusManagerPeer.removeLastFocusRequest((Component)target);
 763         return false;
 764     }
 765 





 766     @Override
 767     public Image createImage(int width, int height) {
 768         Win32GraphicsConfig gc =
 769             (Win32GraphicsConfig)getGraphicsConfiguration();
 770         return gc.createAcceleratedImage((Component)target, width, height);
 771     }
 772 
 773     @Override
 774     public VolatileImage createVolatileImage(int width, int height) {
 775         return new SunVolatileImage((Component)target, width, height);
 776     }
 777 










 778     // Object overrides
 779 
 780     public String toString() {
 781         return getClass().getName() + &quot;[&quot; + target + &quot;]&quot;;
 782     }
 783 
 784     // Toolkit &amp; peer internals
 785 
 786     private int updateX1, updateY1, updateX2, updateY2;
 787 
 788     WComponentPeer(Component target) {
 789         this.target = target;
 790         this.paintArea = new RepaintArea();
 791         create(getNativeParent());
 792         // fix for 5088782: check if window object is created successfully
 793         checkCreation();
 794 
 795         createScreenSurface(false);
 796         initialize();
 797         start();  // Initialize enable/disable state, turn on callbacks
</pre>
</td>
</tr>
</table>
<center><a href="WChoicePeer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="WFramePeer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>