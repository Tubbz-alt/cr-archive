<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/classes/sun/awt/windows/WFramePeer.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="WComponentPeer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="WMenuPeer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/classes/sun/awt/windows/WFramePeer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1996, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */

 25 package sun.awt.windows;
 26 
<span class="line-modified"> 27 import java.awt.*;</span>
<span class="line-modified"> 28 import java.awt.peer.*;</span>







 29 import sun.awt.AWTAccessor;
 30 import sun.awt.im.InputMethodManager;
<span class="line-removed"> 31 import java.security.AccessController;</span>
 32 import sun.security.action.GetPropertyAction;
 33 


 34 class WFramePeer extends WWindowPeer implements FramePeer {
 35 
 36     static {
 37         initIDs();
 38     }
 39 
 40     // initialize JNI field and method IDs
 41     private static native void initIDs();
 42 
 43     // FramePeer implementation
 44     @Override
 45     public native void setState(int state);
 46     @Override
 47     public native int getState();
 48 
 49     // sync target and peer
 50     public void setExtendedState(int state) {
 51         AWTAccessor.getFrameAccessor().setExtendedState((Frame)target, state);
 52     }
 53     public int getExtendedState() {
 54         return AWTAccessor.getFrameAccessor().getExtendedState((Frame)target);
 55     }
 56 
 57     // Convenience methods to save us from trouble of extracting
 58     // Rectangle fields in native code.
 59     private native void setMaximizedBounds(int x, int y, int w, int h);
 60     private native void clearMaximizedBounds();
 61 
 62     private static final boolean keepOnMinimize = &quot;true&quot;.equals(
 63         AccessController.doPrivileged(
 64             new GetPropertyAction(
 65             &quot;sun.awt.keepWorkingSetOnMinimize&quot;)));
 66 
 67     @Override
<span class="line-modified"> 68     public void setMaximizedBounds(Rectangle b) {</span>
 69         if (b == null) {
 70             clearMaximizedBounds();
 71         } else {
<span class="line-modified"> 72             Rectangle adjBounds = (Rectangle)b.clone();</span>
<span class="line-modified"> 73             adjustMaximizedBounds(adjBounds);</span>
<span class="line-removed"> 74             setMaximizedBounds(adjBounds.x, adjBounds.y, adjBounds.width, adjBounds.height);</span>
 75         }
 76     }
 77 
 78     /**
 79      * The incoming bounds describe the maximized size and position of the
<span class="line-modified"> 80      * window on the monitor that displays the window. But the window manager</span>
<span class="line-modified"> 81      * expects that the bounds are based on the size and position of the</span>
<span class="line-modified"> 82      * primary monitor, even if the window ultimately maximizes onto a</span>
<span class="line-modified"> 83      * secondary monitor. And the window manager adjusts these values to</span>
<span class="line-modified"> 84      * compensate for differences between the primary monitor and the monitor</span>
<span class="line-modified"> 85      * that displays the window.</span>

 86      * The method translates the incoming bounds to the values acceptable
 87      * by the window manager. For more details, please refer to 6699851.
 88      */
<span class="line-modified"> 89     private void adjustMaximizedBounds(Rectangle b) {</span>
<span class="line-modified"> 90         GraphicsConfiguration currentDevGC = getGraphicsConfiguration();</span>
<span class="line-modified"> 91 </span>
<span class="line-modified"> 92         GraphicsDevice primaryDev = GraphicsEnvironment</span>
<span class="line-modified"> 93             .getLocalGraphicsEnvironment().getDefaultScreenDevice();</span>
<span class="line-modified"> 94         GraphicsConfiguration primaryDevGC = primaryDev.getDefaultConfiguration();</span>
<span class="line-modified"> 95 </span>
<span class="line-modified"> 96         if (currentDevGC != null &amp;&amp; currentDevGC != primaryDevGC) {</span>
<span class="line-modified"> 97             Rectangle currentDevBounds = currentDevGC.getBounds();</span>
<span class="line-modified"> 98             Rectangle primaryDevBounds = primaryDevGC.getBounds();</span>
<span class="line-modified"> 99 </span>
<span class="line-modified">100             boolean isCurrentDevLarger =</span>
<span class="line-modified">101                 ((currentDevBounds.width - primaryDevBounds.width &gt; 0) ||</span>
<span class="line-modified">102                  (currentDevBounds.height - primaryDevBounds.height &gt; 0));</span>
<span class="line-modified">103 </span>
<span class="line-modified">104             // the window manager doesn&#39;t seem to compensate for differences when</span>
<span class="line-modified">105             // the primary monitor is larger than the monitor that display the window</span>
<span class="line-modified">106             if (isCurrentDevLarger) {</span>
<span class="line-modified">107                 b.width -= (currentDevBounds.width - primaryDevBounds.width);</span>
<span class="line-modified">108                 b.height -= (currentDevBounds.height - primaryDevBounds.height);</span>
<span class="line-modified">109             }</span>
<span class="line-modified">110         }</span>


111     }
112 
113     @Override
114     public boolean updateGraphicsData(GraphicsConfiguration gc) {
115         boolean result = super.updateGraphicsData(gc);
116         Rectangle bounds = AWTAccessor.getFrameAccessor().
117                                getMaximizedBounds((Frame)target);
118         if (bounds != null) {
119             setMaximizedBounds(bounds);
120         }
121         return result;
122     }
123 
124     @Override
125     boolean isTargetUndecorated() {
126         return ((Frame)target).isUndecorated();
127     }
128 
129     @Override
130     public void reshape(int x, int y, int width, int height) {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1996, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
<span class="line-added"> 25 </span>
 26 package sun.awt.windows;
 27 
<span class="line-modified"> 28 import java.awt.Component;</span>
<span class="line-modified"> 29 import java.awt.Dimension;</span>
<span class="line-added"> 30 import java.awt.Frame;</span>
<span class="line-added"> 31 import java.awt.GraphicsConfiguration;</span>
<span class="line-added"> 32 import java.awt.MenuBar;</span>
<span class="line-added"> 33 import java.awt.Rectangle;</span>
<span class="line-added"> 34 import java.awt.peer.FramePeer;</span>
<span class="line-added"> 35 import java.security.AccessController;</span>
<span class="line-added"> 36 </span>
 37 import sun.awt.AWTAccessor;
 38 import sun.awt.im.InputMethodManager;

 39 import sun.security.action.GetPropertyAction;
 40 
<span class="line-added"> 41 import static sun.java2d.SunGraphicsEnvironment.convertToDeviceSpace;</span>
<span class="line-added"> 42 </span>
 43 class WFramePeer extends WWindowPeer implements FramePeer {
 44 
 45     static {
 46         initIDs();
 47     }
 48 
 49     // initialize JNI field and method IDs
 50     private static native void initIDs();
 51 
 52     // FramePeer implementation
 53     @Override
 54     public native void setState(int state);
 55     @Override
 56     public native int getState();
 57 
 58     // sync target and peer
 59     public void setExtendedState(int state) {
 60         AWTAccessor.getFrameAccessor().setExtendedState((Frame)target, state);
 61     }
 62     public int getExtendedState() {
 63         return AWTAccessor.getFrameAccessor().getExtendedState((Frame)target);
 64     }
 65 
 66     // Convenience methods to save us from trouble of extracting
 67     // Rectangle fields in native code.
 68     private native void setMaximizedBounds(int x, int y, int w, int h);
 69     private native void clearMaximizedBounds();
 70 
 71     private static final boolean keepOnMinimize = &quot;true&quot;.equals(
 72         AccessController.doPrivileged(
 73             new GetPropertyAction(
 74             &quot;sun.awt.keepWorkingSetOnMinimize&quot;)));
 75 
 76     @Override
<span class="line-modified"> 77     public final void setMaximizedBounds(Rectangle b) {</span>
 78         if (b == null) {
 79             clearMaximizedBounds();
 80         } else {
<span class="line-modified"> 81             b = adjustMaximizedBounds(b);</span>
<span class="line-modified"> 82             setMaximizedBounds(b.x, b.y, b.width, b.height);</span>

 83         }
 84     }
 85 
 86     /**
 87      * The incoming bounds describe the maximized size and position of the
<span class="line-modified"> 88      * window in the virtual coordinate system. But the window manager expects</span>
<span class="line-modified"> 89      * that the bounds are based on the size of the primary monitor and</span>
<span class="line-modified"> 90      * position is based on the actual window monitor, even if the window</span>
<span class="line-modified"> 91      * ultimately maximizes onto a secondary monitor. And the window manager</span>
<span class="line-modified"> 92      * adjusts these values to compensate for differences between the primary</span>
<span class="line-modified"> 93      * monitor and the monitor that displays the window.</span>
<span class="line-added"> 94      * &lt;p&gt;</span>
 95      * The method translates the incoming bounds to the values acceptable
 96      * by the window manager. For more details, please refer to 6699851.
 97      */
<span class="line-modified"> 98     private Rectangle adjustMaximizedBounds(Rectangle bounds) {</span>
<span class="line-modified"> 99         // All calculations should be done in the device space</span>
<span class="line-modified">100         bounds = convertToDeviceSpace(bounds);</span>
<span class="line-modified">101 </span>
<span class="line-modified">102         GraphicsConfiguration gc = getGraphicsConfiguration();</span>
<span class="line-modified">103         Rectangle currentDevBounds = convertToDeviceSpace(gc, gc.getBounds());</span>
<span class="line-modified">104         // Prepare data for WM_GETMINMAXINFO message.</span>
<span class="line-modified">105         // ptMaxPosition should be in coordinate system of the current monitor,</span>
<span class="line-modified">106         // not the main monitor, or monitor on which we maximize the window.</span>
<span class="line-modified">107         bounds.x -= currentDevBounds.x;</span>
<span class="line-modified">108         bounds.y -= currentDevBounds.y;</span>
<span class="line-modified">109         // ptMaxSize will be used as-is if the size is smaller than the main</span>
<span class="line-modified">110         // monitor. If the size is larger than the main monitor then the</span>
<span class="line-modified">111         // window manager adjusts the size, like this:</span>
<span class="line-modified">112         // result = bounds.w + (current.w - main.w); =&gt;&gt; wrong size</span>
<span class="line-modified">113         // We can try to compensate for this adjustment like this:</span>
<span class="line-modified">114         // result = bounds.w - (current.w - main.w);</span>
<span class="line-modified">115         // but this can result to the size smaller than the main screen, so no</span>
<span class="line-modified">116         // adjustment will be done by the window manager =&gt;&gt; wrong size.</span>
<span class="line-modified">117         // So we skip compensation here and cut the adjustment on</span>
<span class="line-modified">118         // WM_WINDOWPOSCHANGING event.</span>
<span class="line-modified">119         // Note that the result does not depend on the monitor on which we</span>
<span class="line-added">120         // maximize the window.</span>
<span class="line-added">121         return bounds;</span>
122     }
123 
124     @Override
125     public boolean updateGraphicsData(GraphicsConfiguration gc) {
126         boolean result = super.updateGraphicsData(gc);
127         Rectangle bounds = AWTAccessor.getFrameAccessor().
128                                getMaximizedBounds((Frame)target);
129         if (bounds != null) {
130             setMaximizedBounds(bounds);
131         }
132         return result;
133     }
134 
135     @Override
136     boolean isTargetUndecorated() {
137         return ((Frame)target).isUndecorated();
138     }
139 
140     @Override
141     public void reshape(int x, int y, int width, int height) {
</pre>
</td>
</tr>
</table>
<center><a href="WComponentPeer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="WMenuPeer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>