<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/native/libawt/java2d/opengl/WGLSurfaceData.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="J2D_GL/wglext.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../windows/ShellFolder2.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libawt/java2d/opengl/WGLSurfaceData.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 41  */
 42 
 43 extern LockFunc                     OGLSD_Lock;
 44 extern GetRasInfoFunc               OGLSD_GetRasInfo;
 45 extern UnlockFunc                   OGLSD_Unlock;
 46 extern DisposeFunc                  OGLSD_Dispose;
 47 
 48 extern OGLPixelFormat PixelFormats[];
 49 extern void AwtWindow_UpdateWindow(JNIEnv *env, jobject peer,
 50                                    jint w, jint h, HBITMAP hBitmap);
 51 extern HBITMAP BitmapUtil_CreateBitmapFromARGBPre(int width, int height,
 52                                                   int srcStride,
 53                                                   int* imageData);
 54 extern void AwtComponent_GetInsets(JNIEnv *env, jobject peer, RECT *insets);
 55 
 56 extern void
 57     OGLSD_SetNativeDimensions(JNIEnv *env, OGLSDOps *oglsdo, jint w, jint h);
 58 
 59 JNIEXPORT void JNICALL
 60 Java_sun_java2d_opengl_WGLSurfaceData_initOps(JNIEnv *env, jobject wglsd,
<span class="line-modified"> 61                                               jlong pConfigInfo,</span>
 62                                               jobject peer, jlong hwnd)
 63 {






 64     OGLSDOps *oglsdo = (OGLSDOps *)SurfaceData_InitOps(env, wglsd,
 65                                                        sizeof(OGLSDOps));








 66     WGLSDOps *wglsdo = (WGLSDOps *)malloc(sizeof(WGLSDOps));
 67 
 68     J2dTraceLn(J2D_TRACE_INFO, &quot;WGLSurfaceData_initOps&quot;);
 69 
 70     if (wglsdo == NULL) {
 71         JNU_ThrowOutOfMemoryError(env, &quot;creating native wgl ops&quot;);
 72         return;
 73     }
 74     if (oglsdo == NULL) {
 75         free(wglsdo);
 76         JNU_ThrowOutOfMemoryError(env, &quot;Initialization of SurfaceData failed.&quot;);
 77         return;
 78     }
 79 
 80     oglsdo-&gt;privOps = wglsdo;
 81 
 82     oglsdo-&gt;sdOps.Lock               = OGLSD_Lock;
 83     oglsdo-&gt;sdOps.GetRasInfo         = OGLSD_GetRasInfo;
 84     oglsdo-&gt;sdOps.Unlock             = OGLSD_Unlock;
 85     oglsdo-&gt;sdOps.Dispose            = OGLSD_Dispose;
</pre>
<hr />
<pre>
127     WGLCtxInfo *ctxInfo;
128 
129     J2dTraceLn(J2D_TRACE_INFO, &quot;WGLSD_MakeCurrentToScratch&quot;);
130 
131     if (oglc == NULL) {
132         J2dRlsTraceLn(J2D_TRACE_ERROR,
133                       &quot;WGLSD_MakeCurrentToScratch: context is null&quot;);
134         return JNI_FALSE;
135     }
136 
137     ctxInfo = (WGLCtxInfo *)oglc-&gt;ctxInfo;
138     if (!j2d_wglMakeCurrent(ctxInfo-&gt;scratchSurfaceDC, ctxInfo-&gt;context)) {
139         J2dRlsTraceLn(J2D_TRACE_ERROR,
140                       &quot;WGLSD_MakeCurrentToScratch: could not make current&quot;);
141         return JNI_FALSE;
142     }
143 
144     return JNI_TRUE;
145 }
146 
<span class="line-removed">147 /**</span>
<span class="line-removed">148  * Returns a pointer (as a jlong) to the native WGLGraphicsConfigInfo</span>
<span class="line-removed">149  * associated with the given OGLSDOps.  This method can be called from</span>
<span class="line-removed">150  * shared code to retrieve the native GraphicsConfig data in a platform-</span>
<span class="line-removed">151  * independent manner.</span>
<span class="line-removed">152  */</span>
<span class="line-removed">153 jlong</span>
<span class="line-removed">154 OGLSD_GetNativeConfigInfo(OGLSDOps *oglsdo)</span>
<span class="line-removed">155 {</span>
<span class="line-removed">156     WGLSDOps *wglsdo;</span>
<span class="line-removed">157 </span>
<span class="line-removed">158     if (oglsdo == NULL) {</span>
<span class="line-removed">159         J2dRlsTraceLn(J2D_TRACE_ERROR,</span>
<span class="line-removed">160                       &quot;OGLSD_GetNativeConfigInfo: ops are null&quot;);</span>
<span class="line-removed">161         return 0L;</span>
<span class="line-removed">162     }</span>
<span class="line-removed">163 </span>
<span class="line-removed">164     wglsdo = (WGLSDOps *)oglsdo-&gt;privOps;</span>
<span class="line-removed">165     if (wglsdo == NULL) {</span>
<span class="line-removed">166         J2dRlsTraceLn(J2D_TRACE_ERROR,</span>
<span class="line-removed">167                       &quot;OGLSD_GetNativeConfigInfo: wgl ops are null&quot;);</span>
<span class="line-removed">168         return 0L;</span>
<span class="line-removed">169     }</span>
<span class="line-removed">170 </span>
<span class="line-removed">171     return ptr_to_jlong(wglsdo-&gt;configInfo);</span>
<span class="line-removed">172 }</span>
<span class="line-removed">173 </span>
174 /**
175  * Makes the given GraphicsConfig&#39;s context current to its associated
176  * &quot;scratch&quot; surface.  If there is a problem making the context current,
177  * this method will return NULL; otherwise, returns a pointer to the
178  * OGLContext that is associated with the given GraphicsConfig.
179  */
180 OGLContext *
181 OGLSD_SetScratchSurface(JNIEnv *env, jlong pConfigInfo)
182 {
183     WGLGraphicsConfigInfo *wglInfo =
184         (WGLGraphicsConfigInfo *)jlong_to_ptr(pConfigInfo);
185     OGLContext *oglc;
186 
187     J2dTraceLn(J2D_TRACE_INFO, &quot;OGLSD_SetScratchContext&quot;);
188 
189     if (wglInfo == NULL) {
190         J2dRlsTraceLn(J2D_TRACE_ERROR,
191                       &quot;OGLSD_SetScratchContext: wgl config info is null&quot;);
192         return NULL;
193     }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2004, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 41  */
 42 
 43 extern LockFunc                     OGLSD_Lock;
 44 extern GetRasInfoFunc               OGLSD_GetRasInfo;
 45 extern UnlockFunc                   OGLSD_Unlock;
 46 extern DisposeFunc                  OGLSD_Dispose;
 47 
 48 extern OGLPixelFormat PixelFormats[];
 49 extern void AwtWindow_UpdateWindow(JNIEnv *env, jobject peer,
 50                                    jint w, jint h, HBITMAP hBitmap);
 51 extern HBITMAP BitmapUtil_CreateBitmapFromARGBPre(int width, int height,
 52                                                   int srcStride,
 53                                                   int* imageData);
 54 extern void AwtComponent_GetInsets(JNIEnv *env, jobject peer, RECT *insets);
 55 
 56 extern void
 57     OGLSD_SetNativeDimensions(JNIEnv *env, OGLSDOps *oglsdo, jint w, jint h);
 58 
 59 JNIEXPORT void JNICALL
 60 Java_sun_java2d_opengl_WGLSurfaceData_initOps(JNIEnv *env, jobject wglsd,
<span class="line-modified"> 61                                               jobject gc, jlong pConfigInfo,</span>
 62                                               jobject peer, jlong hwnd)
 63 {
<span class="line-added"> 64     gc = (*env)-&gt;NewGlobalRef(env, gc);</span>
<span class="line-added"> 65     if (gc == NULL) {</span>
<span class="line-added"> 66         JNU_ThrowOutOfMemoryError(env, &quot;Initialization of SurfaceData failed.&quot;);</span>
<span class="line-added"> 67         return;</span>
<span class="line-added"> 68     }</span>
<span class="line-added"> 69 </span>
 70     OGLSDOps *oglsdo = (OGLSDOps *)SurfaceData_InitOps(env, wglsd,
 71                                                        sizeof(OGLSDOps));
<span class="line-added"> 72     if (oglsdo == NULL) {</span>
<span class="line-added"> 73         (*env)-&gt;DeleteGlobalRef(env, gc);</span>
<span class="line-added"> 74         JNU_ThrowOutOfMemoryError(env, &quot;Initialization of SurfaceData failed.&quot;);</span>
<span class="line-added"> 75         return;</span>
<span class="line-added"> 76     }</span>
<span class="line-added"> 77     // later the graphicsConfig will be used for deallocation of oglsdo</span>
<span class="line-added"> 78     oglsdo-&gt;graphicsConfig = gc;</span>
<span class="line-added"> 79 </span>
 80     WGLSDOps *wglsdo = (WGLSDOps *)malloc(sizeof(WGLSDOps));
 81 
 82     J2dTraceLn(J2D_TRACE_INFO, &quot;WGLSurfaceData_initOps&quot;);
 83 
 84     if (wglsdo == NULL) {
 85         JNU_ThrowOutOfMemoryError(env, &quot;creating native wgl ops&quot;);
 86         return;
 87     }
 88     if (oglsdo == NULL) {
 89         free(wglsdo);
 90         JNU_ThrowOutOfMemoryError(env, &quot;Initialization of SurfaceData failed.&quot;);
 91         return;
 92     }
 93 
 94     oglsdo-&gt;privOps = wglsdo;
 95 
 96     oglsdo-&gt;sdOps.Lock               = OGLSD_Lock;
 97     oglsdo-&gt;sdOps.GetRasInfo         = OGLSD_GetRasInfo;
 98     oglsdo-&gt;sdOps.Unlock             = OGLSD_Unlock;
 99     oglsdo-&gt;sdOps.Dispose            = OGLSD_Dispose;
</pre>
<hr />
<pre>
141     WGLCtxInfo *ctxInfo;
142 
143     J2dTraceLn(J2D_TRACE_INFO, &quot;WGLSD_MakeCurrentToScratch&quot;);
144 
145     if (oglc == NULL) {
146         J2dRlsTraceLn(J2D_TRACE_ERROR,
147                       &quot;WGLSD_MakeCurrentToScratch: context is null&quot;);
148         return JNI_FALSE;
149     }
150 
151     ctxInfo = (WGLCtxInfo *)oglc-&gt;ctxInfo;
152     if (!j2d_wglMakeCurrent(ctxInfo-&gt;scratchSurfaceDC, ctxInfo-&gt;context)) {
153         J2dRlsTraceLn(J2D_TRACE_ERROR,
154                       &quot;WGLSD_MakeCurrentToScratch: could not make current&quot;);
155         return JNI_FALSE;
156     }
157 
158     return JNI_TRUE;
159 }
160 



























161 /**
162  * Makes the given GraphicsConfig&#39;s context current to its associated
163  * &quot;scratch&quot; surface.  If there is a problem making the context current,
164  * this method will return NULL; otherwise, returns a pointer to the
165  * OGLContext that is associated with the given GraphicsConfig.
166  */
167 OGLContext *
168 OGLSD_SetScratchSurface(JNIEnv *env, jlong pConfigInfo)
169 {
170     WGLGraphicsConfigInfo *wglInfo =
171         (WGLGraphicsConfigInfo *)jlong_to_ptr(pConfigInfo);
172     OGLContext *oglc;
173 
174     J2dTraceLn(J2D_TRACE_INFO, &quot;OGLSD_SetScratchContext&quot;);
175 
176     if (wglInfo == NULL) {
177         J2dRlsTraceLn(J2D_TRACE_ERROR,
178                       &quot;OGLSD_SetScratchContext: wgl config info is null&quot;);
179         return NULL;
180     }
</pre>
</td>
</tr>
</table>
<center><a href="J2D_GL/wglext.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../windows/ShellFolder2.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>