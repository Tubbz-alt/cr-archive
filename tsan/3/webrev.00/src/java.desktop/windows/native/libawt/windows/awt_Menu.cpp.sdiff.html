<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/native/libawt/windows/awt_Menu.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="awt_Frame.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_Menu.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libawt/windows/awt_Menu.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1996, 2014, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
111         menu-&gt;SetHMenu(hMenu);
112 
113         menu-&gt;LinkObjects(env, self);
114         menu-&gt;SetMenuContainer(parentMenu);
115         if (parentMenu != NULL) {
116             parentMenu-&gt;AddItem(menu);
117         }
118     } catch (...) {
119         env-&gt;DeleteLocalRef(target);
120         throw;
121     }
122 
123 done:
124     if (target != NULL) {
125         env-&gt;DeleteLocalRef(target);
126     }
127 
128     return menu;
129 }
130 
<span class="line-removed">131 void AwtMenu::_AddSeparator(void *param)</span>
<span class="line-removed">132 {</span>
<span class="line-removed">133     if (AwtToolkit::IsMainThread()) {</span>
<span class="line-removed">134         JNIEnv *env = (JNIEnv *)JNU_GetEnv(jvm, JNI_VERSION_1_2);</span>
<span class="line-removed">135 </span>
<span class="line-removed">136         jobject self = (jobject)param;</span>
<span class="line-removed">137         AwtMenu *m = NULL;</span>
<span class="line-removed">138         PDATA pData;</span>
<span class="line-removed">139         JNI_CHECK_PEER_GOTO(self, ret);</span>
<span class="line-removed">140         m = (AwtMenu *)pData;</span>
<span class="line-removed">141         m-&gt;AddSeparator();</span>
<span class="line-removed">142 ret:</span>
<span class="line-removed">143         env-&gt;DeleteGlobalRef(self);</span>
<span class="line-removed">144     } else {</span>
<span class="line-removed">145         AwtToolkit::GetInstance().InvokeFunction(AwtMenu::_AddSeparator, param);</span>
<span class="line-removed">146     }</span>
<span class="line-removed">147 }</span>
<span class="line-removed">148 </span>
149 void AwtMenu::_DelItem(void *param)
150 {
151     if (AwtToolkit::IsMainThread()) {
152         JNIEnv *env = (JNIEnv *)JNU_GetEnv(jvm, JNI_VERSION_1_2);
153 
154         DelItemStruct *dis = (DelItemStruct*) param;
155         jobject self = dis-&gt;menuitem;
156         jint index = dis-&gt;index;
157 
158         AwtMenu *m = NULL;
159         PDATA pData;
160         JNI_CHECK_PEER_GOTO(self, ret);
161         m = (AwtMenu *)pData;
162         m-&gt;DeleteItem(static_cast&lt;UINT&gt;(index));
163 ret:
164         env-&gt;DeleteGlobalRef(self);
165         delete dis;
166     } else {
167         AwtToolkit::GetInstance().InvokeFunction(AwtMenu::_DelItem, param);
168     }
</pre>
<hr />
<pre>
194 }
195 
196 void AwtMenu::UpdateContainerLayout()
197 {
198     AwtMenu* menu = GetMenuContainer();
199     if (menu != NULL) {
200         menu-&gt;UpdateLayout();
201     } else {
202         UpdateLayout();
203     }
204 }
205 
206 AwtMenuBar* AwtMenu::GetMenuBar() {
207     return (GetMenuContainer() == NULL) ? NULL : GetMenuContainer()-&gt;GetMenuBar();
208 }
209 
210 HWND AwtMenu::GetOwnerHWnd() {
211     return (GetMenuContainer() == NULL) ? NULL : GetMenuContainer()-&gt;GetOwnerHWnd();
212 }
213 
<span class="line-removed">214 void AwtMenu::AddSeparator() {</span>
<span class="line-removed">215     VERIFY(::AppendMenu(GetHMenu(), MF_SEPARATOR, 0, 0));</span>
<span class="line-removed">216 }</span>
<span class="line-removed">217 </span>
218 void AwtMenu::AddItem(AwtMenuItem* item)
219 {
220     JNIEnv *env = (JNIEnv *)JNU_GetEnv(jvm, JNI_VERSION_1_2);
221     if (env-&gt;EnsureLocalCapacity(2) &lt; 0) {
222         return;
223     }
224 
225     if (item-&gt;IsSeparator()) {
<span class="line-modified">226         AddSeparator();</span>
227     } else {
228         /* jitem is a java.awt.MenuItem */
229         jobject jitem = item-&gt;GetTarget(env);
230 
231         jboolean enabled =
232             (jboolean)env-&gt;GetBooleanField(jitem, AwtMenuItem::enabledID);
233 
234         UINT flags = MF_STRING | (enabled ? MF_ENABLED : MF_GRAYED);
235         flags |= MF_OWNERDRAW;
236         LPCTSTR itemInfo = (LPCTSTR) this;
237 
238         if (_tcscmp(item-&gt;GetClassName(), TEXT(&quot;SunAwtMenu&quot;)) == 0) {
239             flags |= MF_POPUP;
240             itemInfo = (LPCTSTR) item;
241         }
242 
243         VERIFY(::AppendMenu(GetHMenu(), flags, item-&gt;GetID(), itemInfo));
244         if (GetRTL()) {
245             MENUITEMINFO  mif;
246             memset(&amp;mif, 0, sizeof(MENUITEMINFO));
</pre>
<hr />
<pre>
386     AwtMenu::countItemsMID = env-&gt;GetMethodID(cls, &quot;countItemsImpl&quot;, &quot;()I&quot;);
387     DASSERT(AwtMenu::countItemsMID != NULL);
388     CHECK_NULL(AwtMenu::countItemsMID);
389 
390     AwtMenu::getItemMID = env-&gt;GetMethodID(cls, &quot;getItemImpl&quot;,
391                                            &quot;(I)Ljava/awt/MenuItem;&quot;);
392     DASSERT(AwtMenu::getItemMID != NULL);
393 
394     CATCH_BAD_ALLOC;
395 }
396 
397 } /* extern &quot;C&quot; */
398 
399 
400 /************************************************************************
401  * WMenuPeer native methods
402  */
403 
404 extern &quot;C&quot; {
405 
<span class="line-removed">406 /*</span>
<span class="line-removed">407  * Class:     sun_awt_windows_WMenuPeer</span>
<span class="line-removed">408  * Method:    addSeparator</span>
<span class="line-removed">409  * Signature: ()V</span>
<span class="line-removed">410  */</span>
<span class="line-removed">411 JNIEXPORT void JNICALL</span>
<span class="line-removed">412 Java_sun_awt_windows_WMenuPeer_addSeparator(JNIEnv *env, jobject self)</span>
<span class="line-removed">413 {</span>
<span class="line-removed">414     TRY;</span>
<span class="line-removed">415 </span>
<span class="line-removed">416     jobject selfGlobalRef = env-&gt;NewGlobalRef(self);</span>
<span class="line-removed">417 </span>
<span class="line-removed">418     AwtToolkit::GetInstance().SyncCall(AwtMenu::_AddSeparator, selfGlobalRef);</span>
<span class="line-removed">419     // selfGlobalRef is deleted in _AddSeparator</span>
<span class="line-removed">420 </span>
<span class="line-removed">421     CATCH_BAD_ALLOC;</span>
<span class="line-removed">422 }</span>
<span class="line-removed">423 </span>
424 /*
425  * Class:     sun_awt_windows_WMenuPeer
426  * Method:    delItem
427  * Signature: (I)V
428  */
429 JNIEXPORT void JNICALL
430 Java_sun_awt_windows_WMenuPeer_delItem(JNIEnv *env, jobject self,
431                                        jint index)
432 {
433     TRY;
434 
435     DelItemStruct *dis = new DelItemStruct;
436     dis-&gt;menuitem = env-&gt;NewGlobalRef(self);
437     dis-&gt;index = index;
438 
439     AwtToolkit::GetInstance().SyncCall(AwtMenu::_DelItem, dis);
440     // global refs and dis are deleted in _DelItem
441 
442     CATCH_BAD_ALLOC;
443 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1996, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
111         menu-&gt;SetHMenu(hMenu);
112 
113         menu-&gt;LinkObjects(env, self);
114         menu-&gt;SetMenuContainer(parentMenu);
115         if (parentMenu != NULL) {
116             parentMenu-&gt;AddItem(menu);
117         }
118     } catch (...) {
119         env-&gt;DeleteLocalRef(target);
120         throw;
121     }
122 
123 done:
124     if (target != NULL) {
125         env-&gt;DeleteLocalRef(target);
126     }
127 
128     return menu;
129 }
130 


















131 void AwtMenu::_DelItem(void *param)
132 {
133     if (AwtToolkit::IsMainThread()) {
134         JNIEnv *env = (JNIEnv *)JNU_GetEnv(jvm, JNI_VERSION_1_2);
135 
136         DelItemStruct *dis = (DelItemStruct*) param;
137         jobject self = dis-&gt;menuitem;
138         jint index = dis-&gt;index;
139 
140         AwtMenu *m = NULL;
141         PDATA pData;
142         JNI_CHECK_PEER_GOTO(self, ret);
143         m = (AwtMenu *)pData;
144         m-&gt;DeleteItem(static_cast&lt;UINT&gt;(index));
145 ret:
146         env-&gt;DeleteGlobalRef(self);
147         delete dis;
148     } else {
149         AwtToolkit::GetInstance().InvokeFunction(AwtMenu::_DelItem, param);
150     }
</pre>
<hr />
<pre>
176 }
177 
178 void AwtMenu::UpdateContainerLayout()
179 {
180     AwtMenu* menu = GetMenuContainer();
181     if (menu != NULL) {
182         menu-&gt;UpdateLayout();
183     } else {
184         UpdateLayout();
185     }
186 }
187 
188 AwtMenuBar* AwtMenu::GetMenuBar() {
189     return (GetMenuContainer() == NULL) ? NULL : GetMenuContainer()-&gt;GetMenuBar();
190 }
191 
192 HWND AwtMenu::GetOwnerHWnd() {
193     return (GetMenuContainer() == NULL) ? NULL : GetMenuContainer()-&gt;GetOwnerHWnd();
194 }
195 




196 void AwtMenu::AddItem(AwtMenuItem* item)
197 {
198     JNIEnv *env = (JNIEnv *)JNU_GetEnv(jvm, JNI_VERSION_1_2);
199     if (env-&gt;EnsureLocalCapacity(2) &lt; 0) {
200         return;
201     }
202 
203     if (item-&gt;IsSeparator()) {
<span class="line-modified">204         VERIFY(::AppendMenu(GetHMenu(), MF_SEPARATOR, 0, 0));</span>
205     } else {
206         /* jitem is a java.awt.MenuItem */
207         jobject jitem = item-&gt;GetTarget(env);
208 
209         jboolean enabled =
210             (jboolean)env-&gt;GetBooleanField(jitem, AwtMenuItem::enabledID);
211 
212         UINT flags = MF_STRING | (enabled ? MF_ENABLED : MF_GRAYED);
213         flags |= MF_OWNERDRAW;
214         LPCTSTR itemInfo = (LPCTSTR) this;
215 
216         if (_tcscmp(item-&gt;GetClassName(), TEXT(&quot;SunAwtMenu&quot;)) == 0) {
217             flags |= MF_POPUP;
218             itemInfo = (LPCTSTR) item;
219         }
220 
221         VERIFY(::AppendMenu(GetHMenu(), flags, item-&gt;GetID(), itemInfo));
222         if (GetRTL()) {
223             MENUITEMINFO  mif;
224             memset(&amp;mif, 0, sizeof(MENUITEMINFO));
</pre>
<hr />
<pre>
364     AwtMenu::countItemsMID = env-&gt;GetMethodID(cls, &quot;countItemsImpl&quot;, &quot;()I&quot;);
365     DASSERT(AwtMenu::countItemsMID != NULL);
366     CHECK_NULL(AwtMenu::countItemsMID);
367 
368     AwtMenu::getItemMID = env-&gt;GetMethodID(cls, &quot;getItemImpl&quot;,
369                                            &quot;(I)Ljava/awt/MenuItem;&quot;);
370     DASSERT(AwtMenu::getItemMID != NULL);
371 
372     CATCH_BAD_ALLOC;
373 }
374 
375 } /* extern &quot;C&quot; */
376 
377 
378 /************************************************************************
379  * WMenuPeer native methods
380  */
381 
382 extern &quot;C&quot; {
383 


















384 /*
385  * Class:     sun_awt_windows_WMenuPeer
386  * Method:    delItem
387  * Signature: (I)V
388  */
389 JNIEXPORT void JNICALL
390 Java_sun_awt_windows_WMenuPeer_delItem(JNIEnv *env, jobject self,
391                                        jint index)
392 {
393     TRY;
394 
395     DelItemStruct *dis = new DelItemStruct;
396     dis-&gt;menuitem = env-&gt;NewGlobalRef(self);
397     dis-&gt;index = index;
398 
399     AwtToolkit::GetInstance().SyncCall(AwtMenu::_DelItem, dis);
400     // global refs and dis are deleted in _DelItem
401 
402     CATCH_BAD_ALLOC;
403 }
</pre>
</td>
</tr>
</table>
<center><a href="awt_Frame.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_Menu.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>