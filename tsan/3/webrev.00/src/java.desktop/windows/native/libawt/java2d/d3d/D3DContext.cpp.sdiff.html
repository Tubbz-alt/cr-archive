<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/native/libawt/java2d/d3d/D3DContext.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../common/awt/systemscale/systemScale.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="D3DContext.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libawt/java2d/d3d/D3DContext.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2007, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 668     HRESULT res = S_OK;
 669 
 670     J2dTraceLn(J2D_TRACE_INFO, &quot;D3DContext::Sync&quot;);
 671 
 672     if (pSyncQuery != NULL) {
 673         J2dTrace(J2D_TRACE_VERBOSE, &quot;  flushing the device queue..&quot;);
 674         while (S_FALSE ==
 675                (res = pSyncQuery-&gt;GetData(NULL, 0, D3DGETDATA_FLUSH))) ;
 676         J2dTrace(J2D_TRACE_VERBOSE, &quot;.. done\n&quot;);
 677     }
 678     if (pSyncRTRes != NULL) {
 679         D3DLOCKED_RECT lr;
 680         IDirect3DSurface9 *pSurface = pSyncRTRes-&gt;GetSurface();
 681         if (SUCCEEDED(pSurface-&gt;LockRect(&amp;lr, NULL, D3DLOCK_NOSYSLOCK))) {
 682             pSurface-&gt;UnlockRect();
 683         }
 684     }
 685     return res;
 686 }
 687 
<span class="line-removed"> 688 HRESULT</span>
<span class="line-removed"> 689 D3DContext::SaveState()</span>
<span class="line-removed"> 690 {</span>
<span class="line-removed"> 691     HRESULT res;</span>
<span class="line-removed"> 692 </span>
<span class="line-removed"> 693     RETURN_STATUS_IF_NULL(pd3dDevice, S_OK);</span>
<span class="line-removed"> 694 </span>
<span class="line-removed"> 695     J2dTraceLn(J2D_TRACE_INFO, &quot;D3DContext::SaveState&quot;);</span>
<span class="line-removed"> 696 </span>
<span class="line-removed"> 697     FlushVertexQueue();</span>
<span class="line-removed"> 698     UpdateState(STATE_CHANGE);</span>
<span class="line-removed"> 699 </span>
<span class="line-removed"> 700     if (pStateBlock != NULL) {</span>
<span class="line-removed"> 701         J2dTraceLn(J2D_TRACE_WARNING,</span>
<span class="line-removed"> 702                    &quot;D3DContext::SaveState: existing state block!&quot;);</span>
<span class="line-removed"> 703         SAFE_RELEASE(pStateBlock);</span>
<span class="line-removed"> 704     }</span>
<span class="line-removed"> 705 </span>
<span class="line-removed"> 706     if (SUCCEEDED(res =</span>
<span class="line-removed"> 707             pd3dDevice-&gt;CreateStateBlock(D3DSBT_ALL, &amp;pStateBlock)))</span>
<span class="line-removed"> 708     {</span>
<span class="line-removed"> 709         J2dTraceLn(J2D_TRACE_VERBOSE, &quot;  created state block&quot;);</span>
<span class="line-removed"> 710     } else {</span>
<span class="line-removed"> 711         J2dTraceLn(J2D_TRACE_WARNING,</span>
<span class="line-removed"> 712                    &quot;D3DContext::SaveState: failed to create state block&quot;);</span>
<span class="line-removed"> 713     }</span>
<span class="line-removed"> 714     ZeroMemory(lastTexture, sizeof(lastTexture));</span>
<span class="line-removed"> 715 </span>
<span class="line-removed"> 716     return res;</span>
<span class="line-removed"> 717 }</span>
<span class="line-removed"> 718 </span>
<span class="line-removed"> 719 HRESULT</span>
<span class="line-removed"> 720 D3DContext::RestoreState()</span>
<span class="line-removed"> 721 {</span>
<span class="line-removed"> 722     HRESULT res = S_OK;</span>
<span class="line-removed"> 723 </span>
<span class="line-removed"> 724     J2dTraceLn(J2D_TRACE_INFO, &quot;D3DContext::RestoreState&quot;);</span>
<span class="line-removed"> 725 </span>
<span class="line-removed"> 726     FlushVertexQueue();</span>
<span class="line-removed"> 727     UpdateState(STATE_CHANGE);</span>
<span class="line-removed"> 728 </span>
<span class="line-removed"> 729     if (pStateBlock != NULL) {</span>
<span class="line-removed"> 730         if (SUCCEEDED(res = pStateBlock-&gt;Apply())) {</span>
<span class="line-removed"> 731             J2dTraceLn(J2D_TRACE_VERBOSE, &quot;  restored device state&quot;);</span>
<span class="line-removed"> 732         } else {</span>
<span class="line-removed"> 733             J2dTraceLn(J2D_TRACE_WARNING,</span>
<span class="line-removed"> 734                        &quot;D3DContext::RestoreState: failed to restore state&quot;);</span>
<span class="line-removed"> 735         }</span>
<span class="line-removed"> 736         SAFE_RELEASE(pStateBlock);</span>
<span class="line-removed"> 737     } else {</span>
<span class="line-removed"> 738         J2dTraceLn(J2D_TRACE_WARNING,</span>
<span class="line-removed"> 739                    &quot;D3DContext::RestoreState: empty state block!&quot;);</span>
<span class="line-removed"> 740     }</span>
<span class="line-removed"> 741     ZeroMemory(lastTexture, sizeof(lastTexture));</span>
<span class="line-removed"> 742 </span>
<span class="line-removed"> 743     return res;</span>
<span class="line-removed"> 744 }</span>
<span class="line-removed"> 745 </span>
 746 #define POINT_FILTER_CAP (D3DPTFILTERCAPS_MAGFPOINT|D3DPTFILTERCAPS_MINFPOINT)
 747 #define LINEAR_FILTER_CAP (D3DPTFILTERCAPS_MAGFLINEAR|D3DPTFILTERCAPS_MINFLINEAR)
 748 
 749 BOOL
 750 D3DContext::IsStretchRectFilteringSupported(D3DTEXTUREFILTERTYPE fType)
 751 {
 752     if (fType == D3DTEXF_POINT) {
 753         return ((devCaps.StretchRectFilterCaps &amp; POINT_FILTER_CAP) != 0);
 754     }
 755     if (fType == D3DTEXF_LINEAR) {
 756         return ((devCaps.StretchRectFilterCaps &amp; LINEAR_FILTER_CAP) != 0);
 757     }
 758     return FALSE;
 759 }
 760 
 761 BOOL
 762 D3DContext::IsTextureFilteringSupported(D3DTEXTUREFILTERTYPE fType)
 763 {
 764     if (fType == D3DTEXF_POINT) {
 765         return ((devCaps.TextureFilterCaps &amp; POINT_FILTER_CAP) != 0);
</pre>
<hr />
<pre>
1133     // We disable further updates to the depth buffer: it should only
1134     // be updated in SetClip method.
1135     pd3dDevice-&gt;SetRenderState(D3DRS_ZWRITEENABLE, FALSE);
1136     pd3dDevice-&gt;SetRenderState(D3DRS_ZFUNC, D3DCMP_LESS);
1137 
1138     return res;
1139 }
1140 
1141 HRESULT
1142 D3DContext::UploadTileToTexture(D3DResource *pTextureRes, void *pixels,
1143                                 jint dstx, jint dsty,
1144                                 jint srcx, jint srcy,
1145                                 jint srcWidth, jint srcHeight,
1146                                 jint srcStride,
1147                                 TileFormat srcFormat,
1148                                 jint *pPixelsTouchedL,
1149                                 jint* pPixelsTouchedR)
1150 {
1151 #ifndef PtrAddBytes
1152 #define PtrAddBytes(p, b)               ((void *) (((intptr_t) (p)) + (b)))
<span class="line-modified">1153 #define PtrCoord(p, x, xinc, y, yinc)   PtrAddBytes(p, (y)*(yinc) + (x)*(xinc))</span>


1154 #endif // PtrAddBytes
1155 
1156     HRESULT res = S_OK;
1157     IDirect3DTexture9 *pTexture = pTextureRes-&gt;GetTexture();
1158     D3DSURFACE_DESC *pDesc = pTextureRes-&gt;GetDesc();
1159     RECT r = { dstx, dsty, dstx+srcWidth, dsty+srcHeight };
1160     RECT *pR = &amp;r;
1161     D3DLOCKED_RECT lockedRect;
1162     DWORD dwLockFlags = D3DLOCK_NOSYSLOCK;
1163     // these are only counted for LCD glyph uploads
1164     jint pixelsTouchedL = 0, pixelsTouchedR = 0;
1165 
1166     J2dTraceLn(J2D_TRACE_INFO, &quot;D3DContext::UploadTileToTexture&quot;);
1167     J2dTraceLn4(J2D_TRACE_VERBOSE,
1168         &quot; rect={%-4d, %-4d, %-4d, %-4d}&quot;,
1169         r.left, r.top, r.right, r.bottom);
1170 
1171     if (pDesc-&gt;Usage == D3DUSAGE_DYNAMIC) {
1172         // it is safe to lock with discard because we don&#39;t care about the
1173         // contents of dynamic textures and dstx,dsty for this case is
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 668     HRESULT res = S_OK;
 669 
 670     J2dTraceLn(J2D_TRACE_INFO, &quot;D3DContext::Sync&quot;);
 671 
 672     if (pSyncQuery != NULL) {
 673         J2dTrace(J2D_TRACE_VERBOSE, &quot;  flushing the device queue..&quot;);
 674         while (S_FALSE ==
 675                (res = pSyncQuery-&gt;GetData(NULL, 0, D3DGETDATA_FLUSH))) ;
 676         J2dTrace(J2D_TRACE_VERBOSE, &quot;.. done\n&quot;);
 677     }
 678     if (pSyncRTRes != NULL) {
 679         D3DLOCKED_RECT lr;
 680         IDirect3DSurface9 *pSurface = pSyncRTRes-&gt;GetSurface();
 681         if (SUCCEEDED(pSurface-&gt;LockRect(&amp;lr, NULL, D3DLOCK_NOSYSLOCK))) {
 682             pSurface-&gt;UnlockRect();
 683         }
 684     }
 685     return res;
 686 }
 687 


























































 688 #define POINT_FILTER_CAP (D3DPTFILTERCAPS_MAGFPOINT|D3DPTFILTERCAPS_MINFPOINT)
 689 #define LINEAR_FILTER_CAP (D3DPTFILTERCAPS_MAGFLINEAR|D3DPTFILTERCAPS_MINFLINEAR)
 690 
 691 BOOL
 692 D3DContext::IsStretchRectFilteringSupported(D3DTEXTUREFILTERTYPE fType)
 693 {
 694     if (fType == D3DTEXF_POINT) {
 695         return ((devCaps.StretchRectFilterCaps &amp; POINT_FILTER_CAP) != 0);
 696     }
 697     if (fType == D3DTEXF_LINEAR) {
 698         return ((devCaps.StretchRectFilterCaps &amp; LINEAR_FILTER_CAP) != 0);
 699     }
 700     return FALSE;
 701 }
 702 
 703 BOOL
 704 D3DContext::IsTextureFilteringSupported(D3DTEXTUREFILTERTYPE fType)
 705 {
 706     if (fType == D3DTEXF_POINT) {
 707         return ((devCaps.TextureFilterCaps &amp; POINT_FILTER_CAP) != 0);
</pre>
<hr />
<pre>
1075     // We disable further updates to the depth buffer: it should only
1076     // be updated in SetClip method.
1077     pd3dDevice-&gt;SetRenderState(D3DRS_ZWRITEENABLE, FALSE);
1078     pd3dDevice-&gt;SetRenderState(D3DRS_ZFUNC, D3DCMP_LESS);
1079 
1080     return res;
1081 }
1082 
1083 HRESULT
1084 D3DContext::UploadTileToTexture(D3DResource *pTextureRes, void *pixels,
1085                                 jint dstx, jint dsty,
1086                                 jint srcx, jint srcy,
1087                                 jint srcWidth, jint srcHeight,
1088                                 jint srcStride,
1089                                 TileFormat srcFormat,
1090                                 jint *pPixelsTouchedL,
1091                                 jint* pPixelsTouchedR)
1092 {
1093 #ifndef PtrAddBytes
1094 #define PtrAddBytes(p, b)               ((void *) (((intptr_t) (p)) + (b)))
<span class="line-modified">1095 #define PtrCoord(p, x, xinc, y, yinc)   PtrAddBytes(p, \</span>
<span class="line-added">1096                                                     ((ptrdiff_t)(y))*(yinc) + \</span>
<span class="line-added">1097                                                     ((ptrdiff_t)(x))*(xinc))</span>
1098 #endif // PtrAddBytes
1099 
1100     HRESULT res = S_OK;
1101     IDirect3DTexture9 *pTexture = pTextureRes-&gt;GetTexture();
1102     D3DSURFACE_DESC *pDesc = pTextureRes-&gt;GetDesc();
1103     RECT r = { dstx, dsty, dstx+srcWidth, dsty+srcHeight };
1104     RECT *pR = &amp;r;
1105     D3DLOCKED_RECT lockedRect;
1106     DWORD dwLockFlags = D3DLOCK_NOSYSLOCK;
1107     // these are only counted for LCD glyph uploads
1108     jint pixelsTouchedL = 0, pixelsTouchedR = 0;
1109 
1110     J2dTraceLn(J2D_TRACE_INFO, &quot;D3DContext::UploadTileToTexture&quot;);
1111     J2dTraceLn4(J2D_TRACE_VERBOSE,
1112         &quot; rect={%-4d, %-4d, %-4d, %-4d}&quot;,
1113         r.left, r.top, r.right, r.bottom);
1114 
1115     if (pDesc-&gt;Usage == D3DUSAGE_DYNAMIC) {
1116         // it is safe to lock with discard because we don&#39;t care about the
1117         // contents of dynamic textures and dstx,dsty for this case is
</pre>
</td>
</tr>
</table>
<center><a href="../../../common/awt/systemscale/systemScale.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="D3DContext.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>