<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/native/libawt/windows/awt_Choice.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="awt.rc.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_Color.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libawt/windows/awt_Choice.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1996, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
160             if (dimension != NULL &amp;&amp; width == 0) {
161                 width = env-&gt;GetIntField(dimension, AwtDimension::widthID);
162             }
163             c-&gt;CreateHWnd(env, L&quot;&quot;, style, exStyle,
164                           x, y, width, height,
165                           awtParent-&gt;GetHWnd(),
166                           reinterpret_cast&lt;HMENU&gt;(static_cast&lt;INT_PTR&gt;(myId)),
167                           ::GetSysColor(COLOR_WINDOWTEXT),
168                           ::GetSysColor(COLOR_WINDOW),
169                           peer);
170 
171             /* suppress inheriting parent&#39;s color. */
172             c-&gt;m_backgroundColorSet = TRUE;
173             c-&gt;UpdateBackground(env, target);
174 
175             /* Bug 4255631 Solaris: Size returned by Choice.getSize() does not match
176              * actual size
177              * Fix: Set the Choice to its actual size in the component.
178              */
179             ::GetClientRect(c-&gt;GetHWnd(), &amp;rc);
<span class="line-modified">180             env-&gt;SetIntField(target, AwtComponent::widthID,  (jint) rc.right);</span>
<span class="line-modified">181             env-&gt;SetIntField(target, AwtComponent::heightID, (jint) rc.bottom);</span>
182 
183             if (IS_WINXP) {
184                 ::SendMessage(c-&gt;GetHWnd(), CB_SETMINVISIBLE, (WPARAM) MINIMUM_NUMBER_OF_VISIBLE_ITEMS, 0);
185             }
186 
187             env-&gt;DeleteLocalRef(dimension);
188         }
189     } catch (...) {
190         env-&gt;DeleteLocalRef(target);
191         throw;
192     }
193 
194 done:
195     env-&gt;DeleteLocalRef(target);
196 
197     return c;
198 }
199 
200 // calculate height of drop-down list part of the combobox
201 // to show all the items up to a maximum of eight
</pre>
<hr />
<pre>
211 }
212 
213 // get the height of the field portion of the combobox
214 int AwtChoice::GetFieldHeight()
215 {
216     int fieldHeight;
217     int borderHeight;
218     fieldHeight =(int)::SendMessage(GetHWnd(), CB_GETITEMHEIGHT, (UINT)-1, 0);
219     // add top and bottom border lines; border size is different for
220     // Win 4.x (3d edge) vs 3.x (1 pixel line)
221     borderHeight = ::GetSystemMetrics(SM_CYEDGE);
222     fieldHeight += borderHeight*2;
223     return ScaleDownY(fieldHeight);
224 }
225 
226 // gets the total height of the combobox, including drop down
227 int AwtChoice::GetTotalHeight()
228 {
229     int dropHeight = GetDropDownHeight();
230     int fieldHeight = GetFieldHeight();
<span class="line-removed">231     int totalHeight;</span>
232 
233     // border on drop-down portion is always non-3d (so don&#39;t use SM_CYEDGE)
<span class="line-modified">234     int borderHeight = ::GetSystemMetrics(SM_CYBORDER);</span>
235     // total height = drop down height + field height + top+bottom drop down border lines
<span class="line-modified">236     totalHeight = dropHeight + fieldHeight +borderHeight*2;</span>
<span class="line-removed">237     return totalHeight;</span>
238 }
239 
240 // Recalculate and set the drop-down height for the Choice.
241 void AwtChoice::ResetDropDownHeight()
242 {
243     RECT    rcWindow;
244 
245     ::GetWindowRect(GetHWnd(), &amp;rcWindow);
246     // resize the drop down to accommodate added/removed items
<span class="line-modified">247     int     totalHeight = GetTotalHeight();</span>
248     ::SetWindowPos(GetHWnd(), NULL,
249                     0, 0, rcWindow.right - rcWindow.left, totalHeight,
250                     SWP_NOACTIVATE|SWP_NOMOVE|SWP_NOZORDER);
251 }
252 
253 /* Fix for the bug 4327666: set the capture for middle
254    and right mouse buttons, but leave left button alone */
255 void AwtChoice::SetDragCapture(UINT flags)
256 {
257     if ((flags &amp; MK_LBUTTON) != 0) {
258         if ((::GetCapture() == GetHWnd()) &amp;&amp; mouseCapture) {
259             /* On MK_LBUTTON ComboBox captures mouse itself
260                so we should release capture and clear flag to
261                prevent releasing capture by ReleaseDragCapture
262              */
263             ::ReleaseCapture();
264             mouseCapture = FALSE;
265         }
266         return;
267     }
</pre>
<hr />
<pre>
288     // so vertically center the choice in it&#39;s bounding box
289     JNIEnv *env = (JNIEnv *)JNU_GetEnv(jvm, JNI_VERSION_1_2);
290     jobject target = GetTarget(env);
291     jobject parent = env-&gt;GetObjectField(target, AwtComponent::parentID);
292     RECT rc;
293 
294     int fieldHeight = GetFieldHeight();
295     if ((parent != NULL &amp;&amp; env-&gt;GetObjectField(parent, AwtContainer::layoutMgrID) != NULL) &amp;&amp;
296         fieldHeight &gt; 0 &amp;&amp; fieldHeight &lt; h) {
297         y += (h - fieldHeight) / 2;
298     }
299 
300     /* Fix for 4783342
301      * Choice should ignore reshape on height changes,
302      * as height is dependent on Font size only.
303      */
304     AwtComponent* awtParent = GetParent();
305     BOOL bReshape = true;
306     if (awtParent != NULL) {
307         ::GetWindowRect(GetHWnd(), &amp;rc);
<span class="line-modified">308         int oldW = rc.right - rc.left;</span>
309         RECT parentRc;
310         ::GetWindowRect(awtParent-&gt;GetHWnd(), &amp;parentRc);
<span class="line-modified">311         int oldX = rc.left - parentRc.left;</span>
<span class="line-modified">312         int oldY = rc.top - parentRc.top;</span>
313         bReshape = (x != oldX || y != oldY || w != oldW);
314     }
315 
316     if (bReshape)
317     {
318         int totalHeight = GetTotalHeight();
319         AwtComponent::Reshape(x, y, w, totalHeight);
320     }
321 
322     /* Bug 4255631 Solaris: Size returned by Choice.getSize() does not match
323      * actual size
324      * Fix: Set the Choice to its actual size in the component.
325      */
326     ::GetClientRect(GetHWnd(), &amp;rc);
327     env-&gt;SetIntField(target, AwtComponent::widthID, ScaleDownX(rc.right));
328     env-&gt;SetIntField(target, AwtComponent::heightID, ScaleDownY(rc.bottom));
329 
330     env-&gt;DeleteLocalRef(target);
331     env-&gt;DeleteLocalRef(parent);
332 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1996, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
160             if (dimension != NULL &amp;&amp; width == 0) {
161                 width = env-&gt;GetIntField(dimension, AwtDimension::widthID);
162             }
163             c-&gt;CreateHWnd(env, L&quot;&quot;, style, exStyle,
164                           x, y, width, height,
165                           awtParent-&gt;GetHWnd(),
166                           reinterpret_cast&lt;HMENU&gt;(static_cast&lt;INT_PTR&gt;(myId)),
167                           ::GetSysColor(COLOR_WINDOWTEXT),
168                           ::GetSysColor(COLOR_WINDOW),
169                           peer);
170 
171             /* suppress inheriting parent&#39;s color. */
172             c-&gt;m_backgroundColorSet = TRUE;
173             c-&gt;UpdateBackground(env, target);
174 
175             /* Bug 4255631 Solaris: Size returned by Choice.getSize() does not match
176              * actual size
177              * Fix: Set the Choice to its actual size in the component.
178              */
179             ::GetClientRect(c-&gt;GetHWnd(), &amp;rc);
<span class="line-modified">180             env-&gt;SetIntField(target, AwtComponent::widthID, c-&gt;ScaleDownX(rc.right));</span>
<span class="line-modified">181             env-&gt;SetIntField(target, AwtComponent::heightID, c-&gt;ScaleDownY(rc.bottom));</span>
182 
183             if (IS_WINXP) {
184                 ::SendMessage(c-&gt;GetHWnd(), CB_SETMINVISIBLE, (WPARAM) MINIMUM_NUMBER_OF_VISIBLE_ITEMS, 0);
185             }
186 
187             env-&gt;DeleteLocalRef(dimension);
188         }
189     } catch (...) {
190         env-&gt;DeleteLocalRef(target);
191         throw;
192     }
193 
194 done:
195     env-&gt;DeleteLocalRef(target);
196 
197     return c;
198 }
199 
200 // calculate height of drop-down list part of the combobox
201 // to show all the items up to a maximum of eight
</pre>
<hr />
<pre>
211 }
212 
213 // get the height of the field portion of the combobox
214 int AwtChoice::GetFieldHeight()
215 {
216     int fieldHeight;
217     int borderHeight;
218     fieldHeight =(int)::SendMessage(GetHWnd(), CB_GETITEMHEIGHT, (UINT)-1, 0);
219     // add top and bottom border lines; border size is different for
220     // Win 4.x (3d edge) vs 3.x (1 pixel line)
221     borderHeight = ::GetSystemMetrics(SM_CYEDGE);
222     fieldHeight += borderHeight*2;
223     return ScaleDownY(fieldHeight);
224 }
225 
226 // gets the total height of the combobox, including drop down
227 int AwtChoice::GetTotalHeight()
228 {
229     int dropHeight = GetDropDownHeight();
230     int fieldHeight = GetFieldHeight();

231 
232     // border on drop-down portion is always non-3d (so don&#39;t use SM_CYEDGE)
<span class="line-modified">233     int borderHeight = ScaleDownY(::GetSystemMetrics(SM_CYBORDER));</span>
234     // total height = drop down height + field height + top+bottom drop down border lines
<span class="line-modified">235     return dropHeight + fieldHeight + borderHeight * 2;</span>

236 }
237 
238 // Recalculate and set the drop-down height for the Choice.
239 void AwtChoice::ResetDropDownHeight()
240 {
241     RECT    rcWindow;
242 
243     ::GetWindowRect(GetHWnd(), &amp;rcWindow);
244     // resize the drop down to accommodate added/removed items
<span class="line-modified">245     int totalHeight = ScaleUpY(GetTotalHeight());</span>
246     ::SetWindowPos(GetHWnd(), NULL,
247                     0, 0, rcWindow.right - rcWindow.left, totalHeight,
248                     SWP_NOACTIVATE|SWP_NOMOVE|SWP_NOZORDER);
249 }
250 
251 /* Fix for the bug 4327666: set the capture for middle
252    and right mouse buttons, but leave left button alone */
253 void AwtChoice::SetDragCapture(UINT flags)
254 {
255     if ((flags &amp; MK_LBUTTON) != 0) {
256         if ((::GetCapture() == GetHWnd()) &amp;&amp; mouseCapture) {
257             /* On MK_LBUTTON ComboBox captures mouse itself
258                so we should release capture and clear flag to
259                prevent releasing capture by ReleaseDragCapture
260              */
261             ::ReleaseCapture();
262             mouseCapture = FALSE;
263         }
264         return;
265     }
</pre>
<hr />
<pre>
286     // so vertically center the choice in it&#39;s bounding box
287     JNIEnv *env = (JNIEnv *)JNU_GetEnv(jvm, JNI_VERSION_1_2);
288     jobject target = GetTarget(env);
289     jobject parent = env-&gt;GetObjectField(target, AwtComponent::parentID);
290     RECT rc;
291 
292     int fieldHeight = GetFieldHeight();
293     if ((parent != NULL &amp;&amp; env-&gt;GetObjectField(parent, AwtContainer::layoutMgrID) != NULL) &amp;&amp;
294         fieldHeight &gt; 0 &amp;&amp; fieldHeight &lt; h) {
295         y += (h - fieldHeight) / 2;
296     }
297 
298     /* Fix for 4783342
299      * Choice should ignore reshape on height changes,
300      * as height is dependent on Font size only.
301      */
302     AwtComponent* awtParent = GetParent();
303     BOOL bReshape = true;
304     if (awtParent != NULL) {
305         ::GetWindowRect(GetHWnd(), &amp;rc);
<span class="line-modified">306         int oldW = ScaleDownX(rc.right - rc.left);</span>
307         RECT parentRc;
308         ::GetWindowRect(awtParent-&gt;GetHWnd(), &amp;parentRc);
<span class="line-modified">309         int oldX = ScaleDownX(rc.left - parentRc.left);</span>
<span class="line-modified">310         int oldY = ScaleDownY(rc.top - parentRc.top);</span>
311         bReshape = (x != oldX || y != oldY || w != oldW);
312     }
313 
314     if (bReshape)
315     {
316         int totalHeight = GetTotalHeight();
317         AwtComponent::Reshape(x, y, w, totalHeight);
318     }
319 
320     /* Bug 4255631 Solaris: Size returned by Choice.getSize() does not match
321      * actual size
322      * Fix: Set the Choice to its actual size in the component.
323      */
324     ::GetClientRect(GetHWnd(), &amp;rc);
325     env-&gt;SetIntField(target, AwtComponent::widthID, ScaleDownX(rc.right));
326     env-&gt;SetIntField(target, AwtComponent::heightID, ScaleDownY(rc.bottom));
327 
328     env-&gt;DeleteLocalRef(target);
329     env-&gt;DeleteLocalRef(parent);
330 }
</pre>
</td>
</tr>
</table>
<center><a href="awt.rc.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="awt_Color.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>