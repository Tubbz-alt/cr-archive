<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/native/libfontmanager/lcdglyph.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="fontpath.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../libjsound/PLATFORM_API_WinOS_DirectSound.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libfontmanager/lcdglyph.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
155         DeleteObject(hMemoryDC); \
156     } \
157     if (hBitmap != 0) { \
158         DeleteObject(hBitmap); \
159     } \
160     if (tmpBitmap != 0) { \
161         DeleteObject(tmpBitmap); \
162     } \
163     if (dibImage != NULL) { \
164         free(dibImage); \
165     } \
166     if (glyphInfo != NULL) { \
167         free(glyphInfo); \
168     } \
169     return (jlong)0;
170 /* end define */
171 
172 JNIEXPORT jlong JNICALL
173 Java_sun_font_FileFontStrike__1getGlyphImageFromWindows
174 (JNIEnv *env, jobject unused,
<span class="line-modified">175  jstring fontFamily, jint style, jint size, jint glyphCode, jboolean fm) {</span>

176 
177     GLYPHMETRICS glyphMetrics;
178     LOGFONTW lf;
179     BITMAPINFO bmi;
180     TEXTMETRIC textMetric;
181     RECT rect;
182     int bytesWidth, dibBytesWidth, extra, imageSize, dibImageSize;
183     unsigned char* dibImage = NULL, *rowPtr, *pixelPtr, *dibPixPtr, *dibRowPtr;
184     unsigned char r,g,b;
185     unsigned char* igTable;
186     GlyphInfo* glyphInfo = NULL;
187     int nameLen;
188     LPWSTR name;
189     HFONT oldFont, hFont;
190     MAT2 mat2;

191 
192     unsigned short width;
193     unsigned short height;
194     short advanceX;
195     short advanceY;
196     int topLeftX;
197     int topLeftY;
198     int err;
199     int bmWidth, bmHeight;
200     int x, y;
201     HBITMAP hBitmap = NULL, hOrigBM;
202     HBITMAP tmpBitmap = NULL;
203     int gamma, orient;
204 
205     HWND hWnd = NULL;
206     HDC hDesktopDC = NULL;
207     HDC hMemoryDC = NULL;
208 
209     hWnd = GetDesktopWindow();
210     hDesktopDC = GetWindowDC(hWnd);
</pre>
<hr />
<pre>
237     nameLen = (*env)-&gt;GetStringLength(env, fontFamily);
238     name = (LPWSTR)alloca((nameLen+1)*2);
239     if (name == NULL) {
240        FREE_AND_RETURN;
241     }
242     (*env)-&gt;GetStringRegion(env, fontFamily, 0, nameLen, name);
243     name[nameLen] = &#39;\0&#39;;
244 
245     if (nameLen &lt; (sizeof(lf.lfFaceName) / sizeof(lf.lfFaceName[0]))) {
246         wcscpy(lf.lfFaceName, name);
247     } else {
248         FREE_AND_RETURN;
249     }
250 
251     hFont = CreateFontIndirectW(&amp;lf);
252     if (hFont == NULL) {
253         FREE_AND_RETURN;
254     }
255     oldFont = SelectObject(hMemoryDC, hFont);
256 











257     tmpBitmap = CreateCompatibleBitmap(hDesktopDC, 1, 1);
258     if (tmpBitmap == NULL) {
259         FREE_AND_RETURN;
260     }
261     hOrigBM = (HBITMAP)SelectObject(hMemoryDC, tmpBitmap);
262 
263     memset(&amp;textMetric, 0, sizeof(TEXTMETRIC));
264     err = GetTextMetrics(hMemoryDC, &amp;textMetric);
265     if (err == 0) {
266         FREE_AND_RETURN;
267     }
268     memset(&amp;glyphMetrics, 0, sizeof(GLYPHMETRICS));
269     memset(&amp;mat2, 0, sizeof(MAT2));
270     mat2.eM11.value = 1; mat2.eM22.value = 1;
271     err = GetGlyphOutline(hMemoryDC, glyphCode,
272                           GGO_METRICS|GGO_GLYPH_INDEX,
273                           &amp;glyphMetrics,
274                           0, NULL, &amp;mat2);
275     if (err == GDI_ERROR) {
276         /* Probably no such glyph - ie the font wasn&#39;t the one we expected. */
</pre>
</td>
<td>
<hr />
<pre>
155         DeleteObject(hMemoryDC); \
156     } \
157     if (hBitmap != 0) { \
158         DeleteObject(hBitmap); \
159     } \
160     if (tmpBitmap != 0) { \
161         DeleteObject(tmpBitmap); \
162     } \
163     if (dibImage != NULL) { \
164         free(dibImage); \
165     } \
166     if (glyphInfo != NULL) { \
167         free(glyphInfo); \
168     } \
169     return (jlong)0;
170 /* end define */
171 
172 JNIEXPORT jlong JNICALL
173 Java_sun_font_FileFontStrike__1getGlyphImageFromWindows
174 (JNIEnv *env, jobject unused,
<span class="line-modified">175  jstring fontFamily, jint style, jint size, jint glyphCode, jboolean fm,</span>
<span class="line-added">176  jint fontDataSize) {</span>
177 
178     GLYPHMETRICS glyphMetrics;
179     LOGFONTW lf;
180     BITMAPINFO bmi;
181     TEXTMETRIC textMetric;
182     RECT rect;
183     int bytesWidth, dibBytesWidth, extra, imageSize, dibImageSize;
184     unsigned char* dibImage = NULL, *rowPtr, *pixelPtr, *dibPixPtr, *dibRowPtr;
185     unsigned char r,g,b;
186     unsigned char* igTable;
187     GlyphInfo* glyphInfo = NULL;
188     int nameLen;
189     LPWSTR name;
190     HFONT oldFont, hFont;
191     MAT2 mat2;
<span class="line-added">192     DWORD actualFontDataSize;</span>
193 
194     unsigned short width;
195     unsigned short height;
196     short advanceX;
197     short advanceY;
198     int topLeftX;
199     int topLeftY;
200     int err;
201     int bmWidth, bmHeight;
202     int x, y;
203     HBITMAP hBitmap = NULL, hOrigBM;
204     HBITMAP tmpBitmap = NULL;
205     int gamma, orient;
206 
207     HWND hWnd = NULL;
208     HDC hDesktopDC = NULL;
209     HDC hMemoryDC = NULL;
210 
211     hWnd = GetDesktopWindow();
212     hDesktopDC = GetWindowDC(hWnd);
</pre>
<hr />
<pre>
239     nameLen = (*env)-&gt;GetStringLength(env, fontFamily);
240     name = (LPWSTR)alloca((nameLen+1)*2);
241     if (name == NULL) {
242        FREE_AND_RETURN;
243     }
244     (*env)-&gt;GetStringRegion(env, fontFamily, 0, nameLen, name);
245     name[nameLen] = &#39;\0&#39;;
246 
247     if (nameLen &lt; (sizeof(lf.lfFaceName) / sizeof(lf.lfFaceName[0]))) {
248         wcscpy(lf.lfFaceName, name);
249     } else {
250         FREE_AND_RETURN;
251     }
252 
253     hFont = CreateFontIndirectW(&amp;lf);
254     if (hFont == NULL) {
255         FREE_AND_RETURN;
256     }
257     oldFont = SelectObject(hMemoryDC, hFont);
258 
<span class="line-added">259     if (fontDataSize &gt; 0) {</span>
<span class="line-added">260         // GDI doesn&#39;t allow to select a specific font file for drawing, we can</span>
<span class="line-added">261         // only check that it picks the file we need by validating font size.</span>
<span class="line-added">262         // If it doesn&#39;t match, we cannot proceed, as the same glyph code can</span>
<span class="line-added">263         // correspond to a completely different glyph in the selected font.</span>
<span class="line-added">264         actualFontDataSize = GetFontData(hMemoryDC, 0, 0, NULL, 0);</span>
<span class="line-added">265         if (actualFontDataSize != fontDataSize) {</span>
<span class="line-added">266             FREE_AND_RETURN;</span>
<span class="line-added">267         }</span>
<span class="line-added">268     }</span>
<span class="line-added">269 </span>
270     tmpBitmap = CreateCompatibleBitmap(hDesktopDC, 1, 1);
271     if (tmpBitmap == NULL) {
272         FREE_AND_RETURN;
273     }
274     hOrigBM = (HBITMAP)SelectObject(hMemoryDC, tmpBitmap);
275 
276     memset(&amp;textMetric, 0, sizeof(TEXTMETRIC));
277     err = GetTextMetrics(hMemoryDC, &amp;textMetric);
278     if (err == 0) {
279         FREE_AND_RETURN;
280     }
281     memset(&amp;glyphMetrics, 0, sizeof(GLYPHMETRICS));
282     memset(&amp;mat2, 0, sizeof(MAT2));
283     mat2.eM11.value = 1; mat2.eM22.value = 1;
284     err = GetGlyphOutline(hMemoryDC, glyphCode,
285                           GGO_METRICS|GGO_GLYPH_INDEX,
286                           &amp;glyphMetrics,
287                           0, NULL, &amp;mat2);
288     if (err == GDI_ERROR) {
289         /* Probably no such glyph - ie the font wasn&#39;t the one we expected. */
</pre>
</td>
</tr>
</table>
<center><a href="fontpath.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../libjsound/PLATFORM_API_WinOS_DirectSound.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>