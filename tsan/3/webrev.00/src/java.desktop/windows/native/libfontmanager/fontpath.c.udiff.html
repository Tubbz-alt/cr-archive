<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/windows/native/libfontmanager/fontpath.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../libawt/windows/awt_Win32GraphicsDevice.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="lcdglyph.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libfontmanager/fontpath.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -509,18 +509,13 @@</span>
  
      /* Delete the created reference after its usage */
      DeleteLocalReference(env, fileStr);
  }
  
<span class="udiff-line-modified-removed">- /* Obtain all the fontname -&gt; filename mappings.</span>
<span class="udiff-line-modified-removed">-  * This is called once and the results returned to Java code which can</span>
<span class="udiff-line-modified-removed">-  * use it for lookups to reduce or avoid the need to search font files.</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- JNIEXPORT void JNICALL</span>
<span class="udiff-line-removed">- Java_sun_awt_Win32FontManager_populateFontFileNameMap0</span>
<span class="udiff-line-removed">- (JNIEnv *env, jclass obj, jobject fontToFileMap,</span>
<span class="udiff-line-removed">-  jobject fontToFamilyMap, jobject familyToFontListMap, jobject locale)</span>
<span class="udiff-line-modified-added">+ static void populateFontFileNameFromRegistryKey(HKEY regKey,</span>
<span class="udiff-line-modified-added">+                                                 GdiFontMapInfo *fmi,</span>
<span class="udiff-line-modified-added">+                                                 jobject fontToFileMap)</span>
  {
  #define MAX_BUFFER (FILENAME_MAX+1)
      const wchar_t wname[MAX_BUFFER];
      const char data[MAX_BUFFER];
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -529,11 +524,67 @@</span>
      HKEY hkeyFonts;
      DWORD dwNameSize;
      DWORD dwDataValueSize;
      DWORD nval;
      DWORD dwNumValues, dwMaxValueNameLen, dwMaxValueDataLen;
<span class="udiff-line-modified-removed">-     DWORD numValues = 0;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     /* Use the windows registry to map font names to files */</span>
<span class="udiff-line-added">+     ret = RegOpenKeyEx(regKey,</span>
<span class="udiff-line-added">+                        FONTKEY_NT, 0L, KEY_READ, &amp;hkeyFonts);</span>
<span class="udiff-line-added">+     if (ret != ERROR_SUCCESS) {</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ret = RegQueryInfoKeyW(hkeyFonts, NULL, NULL, NULL, NULL, NULL, NULL,</span>
<span class="udiff-line-added">+                            &amp;dwNumValues, &amp;dwMaxValueNameLen,</span>
<span class="udiff-line-added">+                            &amp;dwMaxValueDataLen, NULL, NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (ret != ERROR_SUCCESS ||</span>
<span class="udiff-line-added">+         dwMaxValueNameLen &gt;= MAX_BUFFER ||</span>
<span class="udiff-line-added">+         dwMaxValueDataLen &gt;= MAX_BUFFER) {</span>
<span class="udiff-line-added">+         RegCloseKey(hkeyFonts);</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     for (nval = 0; nval &lt; dwNumValues; nval++ ) {</span>
<span class="udiff-line-added">+         dwNameSize = MAX_BUFFER;</span>
<span class="udiff-line-added">+         dwDataValueSize = MAX_BUFFER;</span>
<span class="udiff-line-added">+         ret = RegEnumValueW(hkeyFonts, nval, (LPWSTR)wname, &amp;dwNameSize,</span>
<span class="udiff-line-added">+                             NULL, &amp;type, (LPBYTE)data, &amp;dwDataValueSize);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (ret != ERROR_SUCCESS) {</span>
<span class="udiff-line-added">+             break;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (type != REG_SZ) { /* REG_SZ means a null-terminated string */</span>
<span class="udiff-line-added">+             continue;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (!RegistryToBaseTTNameW((LPWSTR)wname) ) {</span>
<span class="udiff-line-added">+             /* If the filename ends with &quot;.ttf&quot; or &quot;.otf&quot; also accept it.</span>
<span class="udiff-line-added">+              * Not expecting to need to do this for .ttc files.</span>
<span class="udiff-line-added">+              * Also note this code is not mirrored in the &quot;A&quot; (win9x) path.</span>
<span class="udiff-line-added">+              */</span>
<span class="udiff-line-added">+             LPWSTR dot = wcsrchr((LPWSTR)data, L&#39;.&#39;);</span>
<span class="udiff-line-added">+             if (dot == NULL || ((wcsicmp(dot, L&quot;.ttf&quot;) != 0)</span>
<span class="udiff-line-added">+                                   &amp;&amp; (wcsicmp(dot, L&quot;.otf&quot;) != 0))) {</span>
<span class="udiff-line-added">+                 continue;  /* not a TT font... */</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         registerFontW(fmi, fontToFileMap, (LPWSTR)wname, (LPWSTR)data);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     RegCloseKey(hkeyFonts);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /* Obtain all the fontname -&gt; filename mappings.</span>
<span class="udiff-line-added">+  * This is called once and the results returned to Java code which can</span>
<span class="udiff-line-added">+  * use it for lookups to reduce or avoid the need to search font files.</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ JNIEXPORT void JNICALL</span>
<span class="udiff-line-added">+ Java_sun_awt_Win32FontManager_populateFontFileNameMap0</span>
<span class="udiff-line-added">+ (JNIEnv *env, jclass obj, jobject fontToFileMap,</span>
<span class="udiff-line-added">+  jobject fontToFamilyMap, jobject familyToFontListMap, jobject locale)</span>
<span class="udiff-line-added">+ {</span>
      jclass classIDHashMap;
      jclass classIDString;
      jmethodID putMID;
      GdiFontMapInfo fmi;
      LOGFONTW lfw;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -604,58 +655,15 @@</span>
      lfw.lfCharSet = DEFAULT_CHARSET;  /* all charsets */
      wcscpy(lfw.lfFaceName, L&quot;&quot;);      /* one face per family (CHECK) */
      EnumFontFamiliesExW(screenDC, &amp;lfw,
                          (FONTENUMPROCW)EnumFamilyNamesW,
                          (LPARAM)(&amp;fmi), 0L);
<span class="udiff-line-added">+     /* Starting from Windows 10 Preview Build 17704</span>
<span class="udiff-line-added">+      * fonts are installed into user&#39;s home folder by default,</span>
<span class="udiff-line-added">+      * and are listed in user&#39;s registry section</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     populateFontFileNameFromRegistryKey(HKEY_CURRENT_USER, &amp;fmi, fontToFileMap);</span>
<span class="udiff-line-added">+     populateFontFileNameFromRegistryKey(HKEY_LOCAL_MACHINE, &amp;fmi, fontToFileMap);</span>
  
<span class="udiff-line-removed">-     /* Use the windows registry to map font names to files */</span>
<span class="udiff-line-removed">-     ret = RegOpenKeyEx(HKEY_LOCAL_MACHINE,</span>
<span class="udiff-line-removed">-                        FONTKEY_NT, 0L, KEY_READ, &amp;hkeyFonts);</span>
<span class="udiff-line-removed">-     if (ret != ERROR_SUCCESS) {</span>
<span class="udiff-line-removed">-         ReleaseDC(NULL, screenDC);</span>
<span class="udiff-line-removed">-         screenDC = NULL;</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     ret = RegQueryInfoKeyW(hkeyFonts, NULL, NULL, NULL, NULL, NULL, NULL,</span>
<span class="udiff-line-removed">-                            &amp;dwNumValues, &amp;dwMaxValueNameLen,</span>
<span class="udiff-line-removed">-                            &amp;dwMaxValueDataLen, NULL, NULL);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (ret != ERROR_SUCCESS ||</span>
<span class="udiff-line-removed">-         dwMaxValueNameLen &gt;= MAX_BUFFER ||</span>
<span class="udiff-line-removed">-         dwMaxValueDataLen &gt;= MAX_BUFFER) {</span>
<span class="udiff-line-removed">-         RegCloseKey(hkeyFonts);</span>
<span class="udiff-line-removed">-         ReleaseDC(NULL, screenDC);</span>
<span class="udiff-line-removed">-         screenDC = NULL;</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     for (nval = 0; nval &lt; dwNumValues; nval++ ) {</span>
<span class="udiff-line-removed">-         dwNameSize = MAX_BUFFER;</span>
<span class="udiff-line-removed">-         dwDataValueSize = MAX_BUFFER;</span>
<span class="udiff-line-removed">-         ret = RegEnumValueW(hkeyFonts, nval, (LPWSTR)wname, &amp;dwNameSize,</span>
<span class="udiff-line-removed">-                             NULL, &amp;type, (LPBYTE)data, &amp;dwDataValueSize);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (ret != ERROR_SUCCESS) {</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (type != REG_SZ) { /* REG_SZ means a null-terminated string */</span>
<span class="udiff-line-removed">-             continue;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (!RegistryToBaseTTNameW((LPWSTR)wname) ) {</span>
<span class="udiff-line-removed">-             /* If the filename ends with &quot;.ttf&quot; or &quot;.otf&quot; also accept it.</span>
<span class="udiff-line-removed">-              * Not expecting to need to do this for .ttc files.</span>
<span class="udiff-line-removed">-              * Also note this code is not mirrored in the &quot;A&quot; (win9x) path.</span>
<span class="udiff-line-removed">-              */</span>
<span class="udiff-line-removed">-             LPWSTR dot = wcsrchr((LPWSTR)data, L&#39;.&#39;);</span>
<span class="udiff-line-removed">-             if (dot == NULL || ((wcsicmp(dot, L&quot;.ttf&quot;) != 0)</span>
<span class="udiff-line-removed">-                                   &amp;&amp; (wcsicmp(dot, L&quot;.otf&quot;) != 0))) {</span>
<span class="udiff-line-removed">-                 continue;  /* not a TT font... */</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         registerFontW(&amp;fmi, fontToFileMap, (LPWSTR)wname, (LPWSTR)data);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     RegCloseKey(hkeyFonts);</span>
      ReleaseDC(NULL, screenDC);
      screenDC = NULL;
  }
</pre>
<center><a href="../libawt/windows/awt_Win32GraphicsDevice.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="lcdglyph.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>