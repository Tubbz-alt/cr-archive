<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/native/libfontmanager/fontpath.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../libawt/windows/awt_Win32GraphicsDevice.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="lcdglyph.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libfontmanager/fontpath.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
494             /* Delete the created reference before return */
495             DeleteLocalReference(env, fileStr);
496             return;
497         }
498 
499         (*env)-&gt;CallObjectMethod(env, fontToFileMap, fmi-&gt;putMID,
500                                  fontStrLC, fileStr);
501         /* Delete the created reference after its usage */
502         DeleteLocalReference(env, fontStrLC);
503         if ((*env)-&gt;ExceptionCheck(env)) {
504             /* Delete the created reference before return */
505             DeleteLocalReference(env, fileStr);
506             return;
507         }
508     }
509 
510     /* Delete the created reference after its usage */
511     DeleteLocalReference(env, fileStr);
512 }
513 
<span class="line-modified">514 /* Obtain all the fontname -&gt; filename mappings.</span>
<span class="line-modified">515  * This is called once and the results returned to Java code which can</span>
<span class="line-modified">516  * use it for lookups to reduce or avoid the need to search font files.</span>
<span class="line-removed">517  */</span>
<span class="line-removed">518 JNIEXPORT void JNICALL</span>
<span class="line-removed">519 Java_sun_awt_Win32FontManager_populateFontFileNameMap0</span>
<span class="line-removed">520 (JNIEnv *env, jclass obj, jobject fontToFileMap,</span>
<span class="line-removed">521  jobject fontToFamilyMap, jobject familyToFontListMap, jobject locale)</span>
522 {
523 #define MAX_BUFFER (FILENAME_MAX+1)
524     const wchar_t wname[MAX_BUFFER];
525     const char data[MAX_BUFFER];
526 
527     DWORD type;
528     LONG ret;
529     HKEY hkeyFonts;
530     DWORD dwNameSize;
531     DWORD dwDataValueSize;
532     DWORD nval;
533     DWORD dwNumValues, dwMaxValueNameLen, dwMaxValueDataLen;
<span class="line-modified">534     DWORD numValues = 0;</span>
























































535     jclass classIDHashMap;
536     jclass classIDString;
537     jmethodID putMID;
538     GdiFontMapInfo fmi;
539     LOGFONTW lfw;
540 
541     /* Check we were passed all the maps we need, and do lookup of
542      * methods for JNI up-calls
543      */
544     if (fontToFileMap == NULL ||
545         fontToFamilyMap == NULL ||
546         familyToFontListMap == NULL) {
547         return;
548     }
549     classIDHashMap = (*env)-&gt;FindClass(env, &quot;java/util/HashMap&quot;);
550     if (classIDHashMap == NULL) {
551         return;
552     }
553     putMID = (*env)-&gt;GetMethodID(env, classIDHashMap, &quot;put&quot;,
554                  &quot;(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;&quot;);
</pre>
<hr />
<pre>
589     }
590     fmi.toLowerCaseMID =
591         (*env)-&gt;GetMethodID(env, classIDString, &quot;toLowerCase&quot;,
592                             &quot;(Ljava/util/Locale;)Ljava/lang/String;&quot;);
593     if (fmi.toLowerCaseMID == NULL) {
594         return;
595     }
596 
597     screenDC = GetDC(NULL);
598     if (screenDC == NULL) {
599         return;
600     }
601 
602     /* Enumerate fonts via GDI to build maps of fonts and families */
603     memset(&amp;lfw, 0, sizeof(lfw));
604     lfw.lfCharSet = DEFAULT_CHARSET;  /* all charsets */
605     wcscpy(lfw.lfFaceName, L&quot;&quot;);      /* one face per family (CHECK) */
606     EnumFontFamiliesExW(screenDC, &amp;lfw,
607                         (FONTENUMPROCW)EnumFamilyNamesW,
608                         (LPARAM)(&amp;fmi), 0L);






609 
<span class="line-removed">610     /* Use the windows registry to map font names to files */</span>
<span class="line-removed">611     ret = RegOpenKeyEx(HKEY_LOCAL_MACHINE,</span>
<span class="line-removed">612                        FONTKEY_NT, 0L, KEY_READ, &amp;hkeyFonts);</span>
<span class="line-removed">613     if (ret != ERROR_SUCCESS) {</span>
<span class="line-removed">614         ReleaseDC(NULL, screenDC);</span>
<span class="line-removed">615         screenDC = NULL;</span>
<span class="line-removed">616         return;</span>
<span class="line-removed">617     }</span>
<span class="line-removed">618 </span>
<span class="line-removed">619     ret = RegQueryInfoKeyW(hkeyFonts, NULL, NULL, NULL, NULL, NULL, NULL,</span>
<span class="line-removed">620                            &amp;dwNumValues, &amp;dwMaxValueNameLen,</span>
<span class="line-removed">621                            &amp;dwMaxValueDataLen, NULL, NULL);</span>
<span class="line-removed">622 </span>
<span class="line-removed">623     if (ret != ERROR_SUCCESS ||</span>
<span class="line-removed">624         dwMaxValueNameLen &gt;= MAX_BUFFER ||</span>
<span class="line-removed">625         dwMaxValueDataLen &gt;= MAX_BUFFER) {</span>
<span class="line-removed">626         RegCloseKey(hkeyFonts);</span>
<span class="line-removed">627         ReleaseDC(NULL, screenDC);</span>
<span class="line-removed">628         screenDC = NULL;</span>
<span class="line-removed">629         return;</span>
<span class="line-removed">630     }</span>
<span class="line-removed">631     for (nval = 0; nval &lt; dwNumValues; nval++ ) {</span>
<span class="line-removed">632         dwNameSize = MAX_BUFFER;</span>
<span class="line-removed">633         dwDataValueSize = MAX_BUFFER;</span>
<span class="line-removed">634         ret = RegEnumValueW(hkeyFonts, nval, (LPWSTR)wname, &amp;dwNameSize,</span>
<span class="line-removed">635                             NULL, &amp;type, (LPBYTE)data, &amp;dwDataValueSize);</span>
<span class="line-removed">636 </span>
<span class="line-removed">637         if (ret != ERROR_SUCCESS) {</span>
<span class="line-removed">638             break;</span>
<span class="line-removed">639         }</span>
<span class="line-removed">640         if (type != REG_SZ) { /* REG_SZ means a null-terminated string */</span>
<span class="line-removed">641             continue;</span>
<span class="line-removed">642         }</span>
<span class="line-removed">643 </span>
<span class="line-removed">644         if (!RegistryToBaseTTNameW((LPWSTR)wname) ) {</span>
<span class="line-removed">645             /* If the filename ends with &quot;.ttf&quot; or &quot;.otf&quot; also accept it.</span>
<span class="line-removed">646              * Not expecting to need to do this for .ttc files.</span>
<span class="line-removed">647              * Also note this code is not mirrored in the &quot;A&quot; (win9x) path.</span>
<span class="line-removed">648              */</span>
<span class="line-removed">649             LPWSTR dot = wcsrchr((LPWSTR)data, L&#39;.&#39;);</span>
<span class="line-removed">650             if (dot == NULL || ((wcsicmp(dot, L&quot;.ttf&quot;) != 0)</span>
<span class="line-removed">651                                   &amp;&amp; (wcsicmp(dot, L&quot;.otf&quot;) != 0))) {</span>
<span class="line-removed">652                 continue;  /* not a TT font... */</span>
<span class="line-removed">653             }</span>
<span class="line-removed">654         }</span>
<span class="line-removed">655         registerFontW(&amp;fmi, fontToFileMap, (LPWSTR)wname, (LPWSTR)data);</span>
<span class="line-removed">656     }</span>
<span class="line-removed">657 </span>
<span class="line-removed">658     RegCloseKey(hkeyFonts);</span>
659     ReleaseDC(NULL, screenDC);
660     screenDC = NULL;
661 }
</pre>
</td>
<td>
<hr />
<pre>
494             /* Delete the created reference before return */
495             DeleteLocalReference(env, fileStr);
496             return;
497         }
498 
499         (*env)-&gt;CallObjectMethod(env, fontToFileMap, fmi-&gt;putMID,
500                                  fontStrLC, fileStr);
501         /* Delete the created reference after its usage */
502         DeleteLocalReference(env, fontStrLC);
503         if ((*env)-&gt;ExceptionCheck(env)) {
504             /* Delete the created reference before return */
505             DeleteLocalReference(env, fileStr);
506             return;
507         }
508     }
509 
510     /* Delete the created reference after its usage */
511     DeleteLocalReference(env, fileStr);
512 }
513 
<span class="line-modified">514 static void populateFontFileNameFromRegistryKey(HKEY regKey,</span>
<span class="line-modified">515                                                 GdiFontMapInfo *fmi,</span>
<span class="line-modified">516                                                 jobject fontToFileMap)</span>





517 {
518 #define MAX_BUFFER (FILENAME_MAX+1)
519     const wchar_t wname[MAX_BUFFER];
520     const char data[MAX_BUFFER];
521 
522     DWORD type;
523     LONG ret;
524     HKEY hkeyFonts;
525     DWORD dwNameSize;
526     DWORD dwDataValueSize;
527     DWORD nval;
528     DWORD dwNumValues, dwMaxValueNameLen, dwMaxValueDataLen;
<span class="line-modified">529 </span>
<span class="line-added">530     /* Use the windows registry to map font names to files */</span>
<span class="line-added">531     ret = RegOpenKeyEx(regKey,</span>
<span class="line-added">532                        FONTKEY_NT, 0L, KEY_READ, &amp;hkeyFonts);</span>
<span class="line-added">533     if (ret != ERROR_SUCCESS) {</span>
<span class="line-added">534         return;</span>
<span class="line-added">535     }</span>
<span class="line-added">536 </span>
<span class="line-added">537     ret = RegQueryInfoKeyW(hkeyFonts, NULL, NULL, NULL, NULL, NULL, NULL,</span>
<span class="line-added">538                            &amp;dwNumValues, &amp;dwMaxValueNameLen,</span>
<span class="line-added">539                            &amp;dwMaxValueDataLen, NULL, NULL);</span>
<span class="line-added">540 </span>
<span class="line-added">541     if (ret != ERROR_SUCCESS ||</span>
<span class="line-added">542         dwMaxValueNameLen &gt;= MAX_BUFFER ||</span>
<span class="line-added">543         dwMaxValueDataLen &gt;= MAX_BUFFER) {</span>
<span class="line-added">544         RegCloseKey(hkeyFonts);</span>
<span class="line-added">545         return;</span>
<span class="line-added">546     }</span>
<span class="line-added">547     for (nval = 0; nval &lt; dwNumValues; nval++ ) {</span>
<span class="line-added">548         dwNameSize = MAX_BUFFER;</span>
<span class="line-added">549         dwDataValueSize = MAX_BUFFER;</span>
<span class="line-added">550         ret = RegEnumValueW(hkeyFonts, nval, (LPWSTR)wname, &amp;dwNameSize,</span>
<span class="line-added">551                             NULL, &amp;type, (LPBYTE)data, &amp;dwDataValueSize);</span>
<span class="line-added">552 </span>
<span class="line-added">553         if (ret != ERROR_SUCCESS) {</span>
<span class="line-added">554             break;</span>
<span class="line-added">555         }</span>
<span class="line-added">556         if (type != REG_SZ) { /* REG_SZ means a null-terminated string */</span>
<span class="line-added">557             continue;</span>
<span class="line-added">558         }</span>
<span class="line-added">559 </span>
<span class="line-added">560         if (!RegistryToBaseTTNameW((LPWSTR)wname) ) {</span>
<span class="line-added">561             /* If the filename ends with &quot;.ttf&quot; or &quot;.otf&quot; also accept it.</span>
<span class="line-added">562              * Not expecting to need to do this for .ttc files.</span>
<span class="line-added">563              * Also note this code is not mirrored in the &quot;A&quot; (win9x) path.</span>
<span class="line-added">564              */</span>
<span class="line-added">565             LPWSTR dot = wcsrchr((LPWSTR)data, L&#39;.&#39;);</span>
<span class="line-added">566             if (dot == NULL || ((wcsicmp(dot, L&quot;.ttf&quot;) != 0)</span>
<span class="line-added">567                                   &amp;&amp; (wcsicmp(dot, L&quot;.otf&quot;) != 0))) {</span>
<span class="line-added">568                 continue;  /* not a TT font... */</span>
<span class="line-added">569             }</span>
<span class="line-added">570         }</span>
<span class="line-added">571         registerFontW(fmi, fontToFileMap, (LPWSTR)wname, (LPWSTR)data);</span>
<span class="line-added">572     }</span>
<span class="line-added">573 </span>
<span class="line-added">574     RegCloseKey(hkeyFonts);</span>
<span class="line-added">575 }</span>
<span class="line-added">576 </span>
<span class="line-added">577 /* Obtain all the fontname -&gt; filename mappings.</span>
<span class="line-added">578  * This is called once and the results returned to Java code which can</span>
<span class="line-added">579  * use it for lookups to reduce or avoid the need to search font files.</span>
<span class="line-added">580  */</span>
<span class="line-added">581 JNIEXPORT void JNICALL</span>
<span class="line-added">582 Java_sun_awt_Win32FontManager_populateFontFileNameMap0</span>
<span class="line-added">583 (JNIEnv *env, jclass obj, jobject fontToFileMap,</span>
<span class="line-added">584  jobject fontToFamilyMap, jobject familyToFontListMap, jobject locale)</span>
<span class="line-added">585 {</span>
586     jclass classIDHashMap;
587     jclass classIDString;
588     jmethodID putMID;
589     GdiFontMapInfo fmi;
590     LOGFONTW lfw;
591 
592     /* Check we were passed all the maps we need, and do lookup of
593      * methods for JNI up-calls
594      */
595     if (fontToFileMap == NULL ||
596         fontToFamilyMap == NULL ||
597         familyToFontListMap == NULL) {
598         return;
599     }
600     classIDHashMap = (*env)-&gt;FindClass(env, &quot;java/util/HashMap&quot;);
601     if (classIDHashMap == NULL) {
602         return;
603     }
604     putMID = (*env)-&gt;GetMethodID(env, classIDHashMap, &quot;put&quot;,
605                  &quot;(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;&quot;);
</pre>
<hr />
<pre>
640     }
641     fmi.toLowerCaseMID =
642         (*env)-&gt;GetMethodID(env, classIDString, &quot;toLowerCase&quot;,
643                             &quot;(Ljava/util/Locale;)Ljava/lang/String;&quot;);
644     if (fmi.toLowerCaseMID == NULL) {
645         return;
646     }
647 
648     screenDC = GetDC(NULL);
649     if (screenDC == NULL) {
650         return;
651     }
652 
653     /* Enumerate fonts via GDI to build maps of fonts and families */
654     memset(&amp;lfw, 0, sizeof(lfw));
655     lfw.lfCharSet = DEFAULT_CHARSET;  /* all charsets */
656     wcscpy(lfw.lfFaceName, L&quot;&quot;);      /* one face per family (CHECK) */
657     EnumFontFamiliesExW(screenDC, &amp;lfw,
658                         (FONTENUMPROCW)EnumFamilyNamesW,
659                         (LPARAM)(&amp;fmi), 0L);
<span class="line-added">660     /* Starting from Windows 10 Preview Build 17704</span>
<span class="line-added">661      * fonts are installed into user&#39;s home folder by default,</span>
<span class="line-added">662      * and are listed in user&#39;s registry section</span>
<span class="line-added">663      */</span>
<span class="line-added">664     populateFontFileNameFromRegistryKey(HKEY_CURRENT_USER, &amp;fmi, fontToFileMap);</span>
<span class="line-added">665     populateFontFileNameFromRegistryKey(HKEY_LOCAL_MACHINE, &amp;fmi, fontToFileMap);</span>
666 

















































667     ReleaseDC(NULL, screenDC);
668     screenDC = NULL;
669 }
</pre>
</td>
</tr>
</table>
<center><a href="../libawt/windows/awt_Win32GraphicsDevice.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="lcdglyph.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>