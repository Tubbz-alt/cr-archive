<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/windows/native/libsplashscreen/splashscreen_sys.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../libjsound/PLATFORM_API_WinOS_DirectSound.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../java.instrument/share/classes/java/lang/instrument/Instrumentation.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/windows/native/libsplashscreen/splashscreen_sys.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2014, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
420     style = WS_POPUP;
421     hWnd = CreateWindowEx(exStyle, (LPCSTR) wndClass, &quot;&quot;, style,
422             splash-&gt;x, splash-&gt;y, splash-&gt;width, splash-&gt;height, NULL, NULL,
423             wcex.hInstance, NULL);
424     SetWindowLongPtr(hWnd, GWLP_USERDATA, (LONG_PTR) splash);
425     return hWnd;
426 }
427 
428 void
429 SplashLock(Splash * splash)
430 {
431     EnterCriticalSection(&amp;splash-&gt;lock);
432 }
433 
434 void
435 SplashUnlock(Splash * splash)
436 {
437     LeaveCriticalSection(&amp;splash-&gt;lock);
438 }
439 
<span class="line-modified">440 void</span>
441 SplashInitPlatform(Splash * splash)
442 {
443     HDC hdc;
444     int paletteMode;
445 
446     InitializeCriticalSection(&amp;splash-&gt;lock);
447     splash-&gt;isLayered = FALSE;
448     hdc = GetDC(NULL);
449     paletteMode = (GetDeviceCaps(hdc, RASTERCAPS) &amp; RC_PALETTE) != 0;
450     if (UpdateLayeredWindow &amp;&amp; !paletteMode) {
451         splash-&gt;isLayered = TRUE;
452     }
453     splash-&gt;byteAlignment = 4;
454     if (splash-&gt;isLayered) {
455         initFormat(&amp;splash-&gt;screenFormat,
456                 0x00ff0000, 0x0000ff00, 0x000000ff, 0xff000000);
457         splash-&gt;screenFormat.premultiplied = 1;
458         splash-&gt;maskRequired = 0;
459     }
460     else {
</pre>
<hr />
<pre>
469             /*      FIXME: maybe remapping to non-reserved colors would improve performance */
470             for (i = 0; i &lt; numColors; i++) {
471                 splash-&gt;colorIndex[i] = i;
472             }
473             numColors = quantizeColors(numColors, numComponents);
474             initColorCube(numComponents, splash-&gt;colorMap, splash-&gt;dithers,
475                     splash-&gt;colorIndex);
476             splash-&gt;screenFormat.colorIndex = splash-&gt;colorIndex;
477             splash-&gt;screenFormat.depthBytes = 1;
478             splash-&gt;screenFormat.colorMap = splash-&gt;colorMap;
479             splash-&gt;screenFormat.dithers = splash-&gt;dithers;
480             splash-&gt;screenFormat.numColors = numColors;
481             splash-&gt;hPalette = NULL;
482         }
483         else {
484             initFormat(&amp;splash-&gt;screenFormat,
485                     0x00ff0000, 0x0000ff00, 0x000000ff, 0xff000000);
486         }
487     }
488     ReleaseDC(NULL, hdc);

489 }
490 
491 void
492 SplashCleanupPlatform(Splash * splash)
493 {
494     int i;
495 
496     if (splash-&gt;frames) {
497         for (i = 0; i &lt; splash-&gt;frameCount; i++) {
498             if (splash-&gt;frames[i].hRgn) {
499                 DeleteObject(splash-&gt;frames[i].hRgn);
500                 splash-&gt;frames[i].hRgn = NULL;
501             }
502         }
503     }
504     if (splash-&gt;hPalette)
505         DeleteObject(splash-&gt;hPalette);
506     splash-&gt;maskRequired = !splash-&gt;isLayered;
507 }
508 
</pre>
<hr />
<pre>
557 }
558 
559 void
560 SplashClosePlatform(Splash * splash)
561 {
562     PostMessage(splash-&gt;hWnd, WM_QUIT, 0, 0);
563 }
564 
565 void
566 SplashUpdate(Splash * splash)
567 {
568     PostMessage(splash-&gt;hWnd, WM_SPLASHUPDATE, 0, 0);
569 }
570 
571 void
572 SplashReconfigure(Splash * splash)
573 {
574     PostMessage(splash-&gt;hWnd, WM_SPLASHRECONFIGURE, 0, 0);
575 }
576 
<span class="line-modified">577 JNIEXPORT jboolean JNICALL</span>
578 SplashGetScaledImageName(const char* jarName, const char* fileName,
579                            float *scaleFactor, char *scaleImageName,
580                            const size_t scaledImageLength)
581 {
582     float dpiScaleX = -1.0f;
583     float dpiScaleY = -1.0f;
584     FILE *fp = NULL;
585     *scaleFactor = 1.0;
586     GetScreenDpi(getPrimaryMonitor(), &amp;dpiScaleX, &amp;dpiScaleY);
587     *scaleFactor = dpiScaleX &gt; 0 ? dpiScaleX / 96 : *scaleFactor;
588     return GetScaledImageName(fileName, scaleImageName,
589         scaleFactor, scaledImageLength);
590 }
591 
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
420     style = WS_POPUP;
421     hWnd = CreateWindowEx(exStyle, (LPCSTR) wndClass, &quot;&quot;, style,
422             splash-&gt;x, splash-&gt;y, splash-&gt;width, splash-&gt;height, NULL, NULL,
423             wcex.hInstance, NULL);
424     SetWindowLongPtr(hWnd, GWLP_USERDATA, (LONG_PTR) splash);
425     return hWnd;
426 }
427 
428 void
429 SplashLock(Splash * splash)
430 {
431     EnterCriticalSection(&amp;splash-&gt;lock);
432 }
433 
434 void
435 SplashUnlock(Splash * splash)
436 {
437     LeaveCriticalSection(&amp;splash-&gt;lock);
438 }
439 
<span class="line-modified">440 int</span>
441 SplashInitPlatform(Splash * splash)
442 {
443     HDC hdc;
444     int paletteMode;
445 
446     InitializeCriticalSection(&amp;splash-&gt;lock);
447     splash-&gt;isLayered = FALSE;
448     hdc = GetDC(NULL);
449     paletteMode = (GetDeviceCaps(hdc, RASTERCAPS) &amp; RC_PALETTE) != 0;
450     if (UpdateLayeredWindow &amp;&amp; !paletteMode) {
451         splash-&gt;isLayered = TRUE;
452     }
453     splash-&gt;byteAlignment = 4;
454     if (splash-&gt;isLayered) {
455         initFormat(&amp;splash-&gt;screenFormat,
456                 0x00ff0000, 0x0000ff00, 0x000000ff, 0xff000000);
457         splash-&gt;screenFormat.premultiplied = 1;
458         splash-&gt;maskRequired = 0;
459     }
460     else {
</pre>
<hr />
<pre>
469             /*      FIXME: maybe remapping to non-reserved colors would improve performance */
470             for (i = 0; i &lt; numColors; i++) {
471                 splash-&gt;colorIndex[i] = i;
472             }
473             numColors = quantizeColors(numColors, numComponents);
474             initColorCube(numComponents, splash-&gt;colorMap, splash-&gt;dithers,
475                     splash-&gt;colorIndex);
476             splash-&gt;screenFormat.colorIndex = splash-&gt;colorIndex;
477             splash-&gt;screenFormat.depthBytes = 1;
478             splash-&gt;screenFormat.colorMap = splash-&gt;colorMap;
479             splash-&gt;screenFormat.dithers = splash-&gt;dithers;
480             splash-&gt;screenFormat.numColors = numColors;
481             splash-&gt;hPalette = NULL;
482         }
483         else {
484             initFormat(&amp;splash-&gt;screenFormat,
485                     0x00ff0000, 0x0000ff00, 0x000000ff, 0xff000000);
486         }
487     }
488     ReleaseDC(NULL, hdc);
<span class="line-added">489     return 1;</span>
490 }
491 
492 void
493 SplashCleanupPlatform(Splash * splash)
494 {
495     int i;
496 
497     if (splash-&gt;frames) {
498         for (i = 0; i &lt; splash-&gt;frameCount; i++) {
499             if (splash-&gt;frames[i].hRgn) {
500                 DeleteObject(splash-&gt;frames[i].hRgn);
501                 splash-&gt;frames[i].hRgn = NULL;
502             }
503         }
504     }
505     if (splash-&gt;hPalette)
506         DeleteObject(splash-&gt;hPalette);
507     splash-&gt;maskRequired = !splash-&gt;isLayered;
508 }
509 
</pre>
<hr />
<pre>
558 }
559 
560 void
561 SplashClosePlatform(Splash * splash)
562 {
563     PostMessage(splash-&gt;hWnd, WM_QUIT, 0, 0);
564 }
565 
566 void
567 SplashUpdate(Splash * splash)
568 {
569     PostMessage(splash-&gt;hWnd, WM_SPLASHUPDATE, 0, 0);
570 }
571 
572 void
573 SplashReconfigure(Splash * splash)
574 {
575     PostMessage(splash-&gt;hWnd, WM_SPLASHRECONFIGURE, 0, 0);
576 }
577 
<span class="line-modified">578 JNIEXPORT jboolean</span>
579 SplashGetScaledImageName(const char* jarName, const char* fileName,
580                            float *scaleFactor, char *scaleImageName,
581                            const size_t scaledImageLength)
582 {
583     float dpiScaleX = -1.0f;
584     float dpiScaleY = -1.0f;
585     FILE *fp = NULL;
586     *scaleFactor = 1.0;
587     GetScreenDpi(getPrimaryMonitor(), &amp;dpiScaleX, &amp;dpiScaleY);
588     *scaleFactor = dpiScaleX &gt; 0 ? dpiScaleX / 96 : *scaleFactor;
589     return GetScaledImageName(fileName, scaleImageName,
590         scaleFactor, scaledImageLength);
591 }
592 
</pre>
</td>
</tr>
</table>
<center><a href="../libjsound/PLATFORM_API_WinOS_DirectSound.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../java.instrument/share/classes/java/lang/instrument/Instrumentation.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>