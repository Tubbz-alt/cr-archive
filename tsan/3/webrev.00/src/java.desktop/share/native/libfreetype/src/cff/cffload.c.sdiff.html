<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/cff/cffload.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="cffgload.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cffload.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/cff/cffload.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 /***************************************************************************/</span>
<span class="line-modified">   2 /*                                                                         */</span>
<span class="line-modified">   3 /*  cffload.c                                                              */</span>
<span class="line-modified">   4 /*                                                                         */</span>
<span class="line-modified">   5 /*    OpenType and CFF data/program tables loader (body).                  */</span>
<span class="line-modified">   6 /*                                                                         */</span>
<span class="line-modified">   7 /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">   8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">   9 /*                                                                         */</span>
<span class="line-modified">  10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">  11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">  12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">  13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">  14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified">  15 /*                                                                         */</span>
<span class="line-modified">  16 /***************************************************************************/</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_INTERNAL_DEBUG_H
  21 #include FT_INTERNAL_OBJECTS_H
  22 #include FT_INTERNAL_STREAM_H
  23 #include FT_TRUETYPE_TAGS_H
  24 #include FT_TYPE1_TABLES_H
  25 #include FT_INTERNAL_POSTSCRIPT_AUX_H
  26 
  27 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  28 #include FT_MULTIPLE_MASTERS_H
  29 #include FT_SERVICE_MULTIPLE_MASTERS_H
  30 #endif
  31 
  32 #include &quot;cffload.h&quot;
  33 #include &quot;cffparse.h&quot;
  34 
  35 #include &quot;cfferrs.h&quot;
  36 
</pre>
<hr />
<pre>
 179     326, 150, 164, 169, 327, 328, 329, 330,
 180     331, 332, 333, 334, 335, 336, 337, 338,
 181     339, 340, 341, 342, 343, 344, 345, 346,
 182     347, 348, 349, 350, 351, 352, 353, 354,
 183     355, 356, 357, 358, 359, 360, 361, 362,
 184     363, 364, 365, 366, 367, 368, 369, 370,
 185     371, 372, 373, 374, 375, 376, 377, 378
 186   };
 187 
 188 #endif /* 1 */
 189 
 190 
 191   FT_LOCAL_DEF( FT_UShort )
 192   cff_get_standard_encoding( FT_UInt  charcode )
 193   {
 194     return (FT_UShort)( charcode &lt; 256 ? cff_standard_encoding[charcode]
 195                                        : 0 );
 196   }
 197 
 198 
<span class="line-modified"> 199   /*************************************************************************/</span>
<span class="line-modified"> 200   /*                                                                       */</span>
<span class="line-modified"> 201   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified"> 202   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified"> 203   /* messages during execution.                                            */</span>
<span class="line-modified"> 204   /*                                                                       */</span>
 205 #undef  FT_COMPONENT
<span class="line-modified"> 206 #define FT_COMPONENT  trace_cffload</span>
 207 
 208 
 209   /* read an offset from the index&#39;s stream current position */
 210   static FT_ULong
 211   cff_index_read_offset( CFF_Index  idx,
 212                          FT_Error  *errorp )
 213   {
 214     FT_Error   error;
 215     FT_Stream  stream = idx-&gt;stream;
 216     FT_Byte    tmp[4];
 217     FT_ULong   result = 0;
 218 
 219 
 220     if ( !FT_STREAM_READ( tmp, idx-&gt;off_size ) )
 221     {
 222       FT_Int  nn;
 223 
 224 
 225       for ( nn = 0; nn &lt; idx-&gt;off_size; nn++ )
 226         result = ( result &lt;&lt; 8 ) | tmp[nn];
</pre>
<hr />
<pre>
1381 
1382   /* Compute a blend vector from variation store index and normalized  */
1383   /* vector based on pseudo-code in OpenType Font Variations Overview. */
1384   /*                                                                   */
1385   /* Note: lenNDV == 0 produces a default blend vector, (1,0,0,...).   */
1386   FT_LOCAL_DEF( FT_Error )
1387   cff_blend_build_vector( CFF_Blend  blend,
1388                           FT_UInt    vsindex,
1389                           FT_UInt    lenNDV,
1390                           FT_Fixed*  NDV )
1391   {
1392     FT_Error   error  = FT_Err_Ok;            /* for FT_REALLOC */
1393     FT_Memory  memory = blend-&gt;font-&gt;memory;  /* for FT_REALLOC */
1394 
1395     FT_UInt       len;
1396     CFF_VStore    vs;
1397     CFF_VarData*  varData;
1398     FT_UInt       master;
1399 
1400 
<span class="line-modified">1401     FT_ASSERT( lenNDV == 0 || NDV );</span>







1402 
1403     blend-&gt;builtBV = FALSE;
1404 
1405     vs = &amp;blend-&gt;font-&gt;vstore;
1406 
1407     /* VStore and fvar must be consistent */
1408     if ( lenNDV != 0 &amp;&amp; lenNDV != vs-&gt;axisCount )
1409     {
1410       FT_TRACE4(( &quot; cff_blend_build_vector: Axis count mismatch\n&quot; ));
1411       error = FT_THROW( Invalid_File_Format );
1412       goto Exit;
1413     }
1414 
1415     if ( vsindex &gt;= vs-&gt;dataCount )
1416     {
1417       FT_TRACE4(( &quot; cff_blend_build_vector: vsindex out of range\n&quot; ));
1418       error = FT_THROW( Invalid_File_Format );
1419       goto Exit;
1420     }
1421 
</pre>
<hr />
<pre>
2063       goto Exit;
2064 
2065     /* if it is a CID font, we stop there */
2066     if ( top-&gt;cid_registry != 0xFFFFU )
2067       goto Exit;
2068 
2069     /* Parse the private dictionary, if any.                   */
2070     /*                                                         */
2071     /* CFF2 does not have a private dictionary in the Top DICT */
2072     /* but may have one in a Font DICT.  We need to parse      */
2073     /* the latter here in order to load any local subrs.       */
2074     error = cff_load_private_dict( font, subfont, 0, 0 );
2075     if ( error )
2076       goto Exit;
2077 
2078     if ( !cff2 )
2079     {
2080       /*
2081        * Initialize the random number generator.
2082        *
<span class="line-modified">2083        * . If we have a face-specific seed, use it.</span>
2084        *   If non-zero, update it to a positive value.
2085        *
<span class="line-modified">2086        * . Otherwise, use the seed from the CFF driver.</span>
2087        *   If non-zero, update it to a positive value.
2088        *
<span class="line-modified">2089        * . If the random value is zero, use the seed given by the subfont&#39;s</span>
2090        *   `initialRandomSeed&#39; value.
2091        *
2092        */
2093       if ( face-&gt;root.internal-&gt;random_seed == -1 )
2094       {
2095         PS_Driver  driver = (PS_Driver)FT_FACE_DRIVER( face );
2096 
2097 
2098         subfont-&gt;random = (FT_UInt32)driver-&gt;random_seed;
2099         if ( driver-&gt;random_seed )
2100         {
2101           do
2102           {
2103             driver-&gt;random_seed =
2104               (FT_Int32)psaux-&gt;cff_random( (FT_UInt32)driver-&gt;random_seed );
2105 
2106           } while ( driver-&gt;random_seed &lt; 0 );
2107         }
2108       }
2109       else
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 /****************************************************************************</span>
<span class="line-modified">   2  *</span>
<span class="line-modified">   3  * cffload.c</span>
<span class="line-modified">   4  *</span>
<span class="line-modified">   5  *   OpenType and CFF data/program tables loader (body).</span>
<span class="line-modified">   6  *</span>
<span class="line-modified">   7  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">   8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">   9  *</span>
<span class="line-modified">  10  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">  11  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">  12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">  13  * this file you indicate that you have read the license and</span>
<span class="line-modified">  14  * understand and accept it fully.</span>
<span class="line-modified">  15  *</span>
<span class="line-modified">  16  */</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_INTERNAL_DEBUG_H
  21 #include FT_INTERNAL_OBJECTS_H
  22 #include FT_INTERNAL_STREAM_H
  23 #include FT_TRUETYPE_TAGS_H
  24 #include FT_TYPE1_TABLES_H
  25 #include FT_INTERNAL_POSTSCRIPT_AUX_H
  26 
  27 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  28 #include FT_MULTIPLE_MASTERS_H
  29 #include FT_SERVICE_MULTIPLE_MASTERS_H
  30 #endif
  31 
  32 #include &quot;cffload.h&quot;
  33 #include &quot;cffparse.h&quot;
  34 
  35 #include &quot;cfferrs.h&quot;
  36 
</pre>
<hr />
<pre>
 179     326, 150, 164, 169, 327, 328, 329, 330,
 180     331, 332, 333, 334, 335, 336, 337, 338,
 181     339, 340, 341, 342, 343, 344, 345, 346,
 182     347, 348, 349, 350, 351, 352, 353, 354,
 183     355, 356, 357, 358, 359, 360, 361, 362,
 184     363, 364, 365, 366, 367, 368, 369, 370,
 185     371, 372, 373, 374, 375, 376, 377, 378
 186   };
 187 
 188 #endif /* 1 */
 189 
 190 
 191   FT_LOCAL_DEF( FT_UShort )
 192   cff_get_standard_encoding( FT_UInt  charcode )
 193   {
 194     return (FT_UShort)( charcode &lt; 256 ? cff_standard_encoding[charcode]
 195                                        : 0 );
 196   }
 197 
 198 
<span class="line-modified"> 199   /**************************************************************************</span>
<span class="line-modified"> 200    *</span>
<span class="line-modified"> 201    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified"> 202    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified"> 203    * messages during execution.</span>
<span class="line-modified"> 204    */</span>
 205 #undef  FT_COMPONENT
<span class="line-modified"> 206 #define FT_COMPONENT  cffload</span>
 207 
 208 
 209   /* read an offset from the index&#39;s stream current position */
 210   static FT_ULong
 211   cff_index_read_offset( CFF_Index  idx,
 212                          FT_Error  *errorp )
 213   {
 214     FT_Error   error;
 215     FT_Stream  stream = idx-&gt;stream;
 216     FT_Byte    tmp[4];
 217     FT_ULong   result = 0;
 218 
 219 
 220     if ( !FT_STREAM_READ( tmp, idx-&gt;off_size ) )
 221     {
 222       FT_Int  nn;
 223 
 224 
 225       for ( nn = 0; nn &lt; idx-&gt;off_size; nn++ )
 226         result = ( result &lt;&lt; 8 ) | tmp[nn];
</pre>
<hr />
<pre>
1381 
1382   /* Compute a blend vector from variation store index and normalized  */
1383   /* vector based on pseudo-code in OpenType Font Variations Overview. */
1384   /*                                                                   */
1385   /* Note: lenNDV == 0 produces a default blend vector, (1,0,0,...).   */
1386   FT_LOCAL_DEF( FT_Error )
1387   cff_blend_build_vector( CFF_Blend  blend,
1388                           FT_UInt    vsindex,
1389                           FT_UInt    lenNDV,
1390                           FT_Fixed*  NDV )
1391   {
1392     FT_Error   error  = FT_Err_Ok;            /* for FT_REALLOC */
1393     FT_Memory  memory = blend-&gt;font-&gt;memory;  /* for FT_REALLOC */
1394 
1395     FT_UInt       len;
1396     CFF_VStore    vs;
1397     CFF_VarData*  varData;
1398     FT_UInt       master;
1399 
1400 
<span class="line-modified">1401     /* protect against malformed fonts */</span>
<span class="line-added">1402     if ( !( lenNDV == 0 || NDV ) )</span>
<span class="line-added">1403     {</span>
<span class="line-added">1404       FT_TRACE4(( &quot; cff_blend_build_vector:&quot;</span>
<span class="line-added">1405                   &quot; Malformed Normalize Design Vector data\n&quot; ));</span>
<span class="line-added">1406       error = FT_THROW( Invalid_File_Format );</span>
<span class="line-added">1407       goto Exit;</span>
<span class="line-added">1408     }</span>
1409 
1410     blend-&gt;builtBV = FALSE;
1411 
1412     vs = &amp;blend-&gt;font-&gt;vstore;
1413 
1414     /* VStore and fvar must be consistent */
1415     if ( lenNDV != 0 &amp;&amp; lenNDV != vs-&gt;axisCount )
1416     {
1417       FT_TRACE4(( &quot; cff_blend_build_vector: Axis count mismatch\n&quot; ));
1418       error = FT_THROW( Invalid_File_Format );
1419       goto Exit;
1420     }
1421 
1422     if ( vsindex &gt;= vs-&gt;dataCount )
1423     {
1424       FT_TRACE4(( &quot; cff_blend_build_vector: vsindex out of range\n&quot; ));
1425       error = FT_THROW( Invalid_File_Format );
1426       goto Exit;
1427     }
1428 
</pre>
<hr />
<pre>
2070       goto Exit;
2071 
2072     /* if it is a CID font, we stop there */
2073     if ( top-&gt;cid_registry != 0xFFFFU )
2074       goto Exit;
2075 
2076     /* Parse the private dictionary, if any.                   */
2077     /*                                                         */
2078     /* CFF2 does not have a private dictionary in the Top DICT */
2079     /* but may have one in a Font DICT.  We need to parse      */
2080     /* the latter here in order to load any local subrs.       */
2081     error = cff_load_private_dict( font, subfont, 0, 0 );
2082     if ( error )
2083       goto Exit;
2084 
2085     if ( !cff2 )
2086     {
2087       /*
2088        * Initialize the random number generator.
2089        *
<span class="line-modified">2090        * - If we have a face-specific seed, use it.</span>
2091        *   If non-zero, update it to a positive value.
2092        *
<span class="line-modified">2093        * - Otherwise, use the seed from the CFF driver.</span>
2094        *   If non-zero, update it to a positive value.
2095        *
<span class="line-modified">2096        * - If the random value is zero, use the seed given by the subfont&#39;s</span>
2097        *   `initialRandomSeed&#39; value.
2098        *
2099        */
2100       if ( face-&gt;root.internal-&gt;random_seed == -1 )
2101       {
2102         PS_Driver  driver = (PS_Driver)FT_FACE_DRIVER( face );
2103 
2104 
2105         subfont-&gt;random = (FT_UInt32)driver-&gt;random_seed;
2106         if ( driver-&gt;random_seed )
2107         {
2108           do
2109           {
2110             driver-&gt;random_seed =
2111               (FT_Int32)psaux-&gt;cff_random( (FT_UInt32)driver-&gt;random_seed );
2112 
2113           } while ( driver-&gt;random_seed &lt; 0 );
2114         }
2115       }
2116       else
</pre>
</td>
</tr>
</table>
<center><a href="cffgload.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cffload.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>