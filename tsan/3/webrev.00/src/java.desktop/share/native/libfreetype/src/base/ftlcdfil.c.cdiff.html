<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfreetype/src/base/ftlcdfil.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ftinit.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftmac.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/base/ftlcdfil.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,21 ***</span>
<span class="line-modified">! /***************************************************************************/</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*  ftlcdfil.c                                                             */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*    FreeType API for color filtering of subpixel bitmap glyphs (body).   */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*  Copyright 2006-2018 by                                                 */</span>
<span class="line-modified">! /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">! /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">! /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">! /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">! /*  understand and accept it fully.                                        */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /***************************************************************************/</span>
  
  
  #include &lt;ft2build.h&gt;
  #include FT_INTERNAL_DEBUG_H
  
<span class="line-new-header">--- 1,21 ---</span>
<span class="line-modified">! /****************************************************************************</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * ftlcdfil.c</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  *   FreeType API for color filtering of subpixel bitmap glyphs (body).</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * Copyright (C) 2006-2019 by</span>
<span class="line-modified">!  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">!  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">!  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">!  * this file you indicate that you have read the license and</span>
<span class="line-modified">!  * understand and accept it fully.</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  */</span>
  
  
  #include &lt;ft2build.h&gt;
  #include FT_INTERNAL_DEBUG_H
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 32,13 ***</span>
  #define FT_SHIFTCLAMP( x )  ( x &gt;&gt;= 8, (FT_Byte)( x &gt; 255 ? 255 : x ) )
  
  
    /* add padding according to filter weights */
    FT_BASE_DEF (void)
<span class="line-modified">!   ft_lcd_padding( FT_Pos*       Min,</span>
<span class="line-modified">!                   FT_Pos*       Max,</span>
<span class="line-modified">!                   FT_GlyphSlot  slot )</span>
    {
      FT_Byte*                 lcd_weights;
      FT_Bitmap_LcdFilterFunc  lcd_filter_func;
  
  
<span class="line-new-header">--- 32,13 ---</span>
  #define FT_SHIFTCLAMP( x )  ( x &gt;&gt;= 8, (FT_Byte)( x &gt; 255 ? 255 : x ) )
  
  
    /* add padding according to filter weights */
    FT_BASE_DEF (void)
<span class="line-modified">!   ft_lcd_padding( FT_BBox*        cbox,</span>
<span class="line-modified">!                   FT_GlyphSlot    slot,</span>
<span class="line-modified">!                   FT_Render_Mode  mode )</span>
    {
      FT_Byte*                 lcd_weights;
      FT_Bitmap_LcdFilterFunc  lcd_filter_func;
  
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 54,36 ***</span>
        lcd_filter_func = slot-&gt;library-&gt;lcd_filter_func;
      }
  
      if ( lcd_filter_func == ft_lcd_filter_fir )
      {
<span class="line-modified">!       *Min -= lcd_weights[0] ? 43 :</span>
<span class="line-modified">!               lcd_weights[1] ? 22 : 0;</span>
<span class="line-modified">!       *Max += lcd_weights[4] ? 43 :</span>
<span class="line-modified">!               lcd_weights[3] ? 22 : 0;</span>
      }
    }
  
  
    /* FIR filter used by the default and light filters */
    FT_BASE_DEF( void )
    ft_lcd_filter_fir( FT_Bitmap*           bitmap,
<span class="line-removed">-                      FT_Render_Mode       mode,</span>
                       FT_LcdFiveTapFilter  weights )
    {
      FT_UInt   width  = (FT_UInt)bitmap-&gt;width;
      FT_UInt   height = (FT_UInt)bitmap-&gt;rows;
      FT_Int    pitch  = bitmap-&gt;pitch;
      FT_Byte*  origin = bitmap-&gt;buffer;
  
  
      /* take care of bitmap flow */
      if ( pitch &gt; 0 &amp;&amp; height &gt; 0 )
        origin += pitch * (FT_Int)( height - 1 );
  
      /* horizontal in-place FIR filter */
<span class="line-modified">!     if ( mode == FT_RENDER_MODE_LCD &amp;&amp; width &gt;= 2 )</span>
      {
        FT_Byte*  line = origin;
  
  
        /* `fir&#39; must be at least 32 bit wide, since the sum of */
<span class="line-new-header">--- 54,46 ---</span>
        lcd_filter_func = slot-&gt;library-&gt;lcd_filter_func;
      }
  
      if ( lcd_filter_func == ft_lcd_filter_fir )
      {
<span class="line-modified">!       if ( mode == FT_RENDER_MODE_LCD )</span>
<span class="line-modified">!       {</span>
<span class="line-modified">!         cbox-&gt;xMin -= lcd_weights[0] ? 43 :</span>
<span class="line-modified">!                       lcd_weights[1] ? 22 : 0;</span>
<span class="line-added">+         cbox-&gt;xMax += lcd_weights[4] ? 43 :</span>
<span class="line-added">+                       lcd_weights[3] ? 22 : 0;</span>
<span class="line-added">+       }</span>
<span class="line-added">+       else if ( mode == FT_RENDER_MODE_LCD_V )</span>
<span class="line-added">+       {</span>
<span class="line-added">+         cbox-&gt;yMin -= lcd_weights[0] ? 43 :</span>
<span class="line-added">+                       lcd_weights[1] ? 22 : 0;</span>
<span class="line-added">+         cbox-&gt;yMax += lcd_weights[4] ? 43 :</span>
<span class="line-added">+                       lcd_weights[3] ? 22 : 0;</span>
<span class="line-added">+       }</span>
      }
    }
  
  
    /* FIR filter used by the default and light filters */
    FT_BASE_DEF( void )
    ft_lcd_filter_fir( FT_Bitmap*           bitmap,
                       FT_LcdFiveTapFilter  weights )
    {
      FT_UInt   width  = (FT_UInt)bitmap-&gt;width;
      FT_UInt   height = (FT_UInt)bitmap-&gt;rows;
      FT_Int    pitch  = bitmap-&gt;pitch;
      FT_Byte*  origin = bitmap-&gt;buffer;
<span class="line-added">+     FT_Byte   mode   = bitmap-&gt;pixel_mode;</span>
  
  
      /* take care of bitmap flow */
      if ( pitch &gt; 0 &amp;&amp; height &gt; 0 )
        origin += pitch * (FT_Int)( height - 1 );
  
      /* horizontal in-place FIR filter */
<span class="line-modified">!     if ( mode == FT_PIXEL_MODE_LCD &amp;&amp; width &gt;= 2 )</span>
      {
        FT_Byte*  line = origin;
  
  
        /* `fir&#39; must be at least 32 bit wide, since the sum of */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 122,11 ***</span>
          line[xx - 1] = FT_SHIFTCLAMP( fir[2] );
        }
      }
  
      /* vertical in-place FIR filter */
<span class="line-modified">!     else if ( mode == FT_RENDER_MODE_LCD_V &amp;&amp; height &gt;= 2 )</span>
      {
        FT_Byte*  column = origin;
  
  
        for ( ; width &gt; 0; width--, column++ )
<span class="line-new-header">--- 132,11 ---</span>
          line[xx - 1] = FT_SHIFTCLAMP( fir[2] );
        }
      }
  
      /* vertical in-place FIR filter */
<span class="line-modified">!     else if ( mode == FT_PIXEL_MODE_LCD_V &amp;&amp; height &gt;= 2 )</span>
      {
        FT_Byte*  column = origin;
  
  
        for ( ; width &gt; 0; width--, column++ )
</pre>
<hr />
<pre>
<span class="line-old-header">*** 171,17 ***</span>
  #ifdef USE_LEGACY
  
    /* intra-pixel filter used by the legacy filter */
    static void
    _ft_lcd_filter_legacy( FT_Bitmap*      bitmap,
<span class="line-removed">-                          FT_Render_Mode  mode,</span>
                           FT_Byte*        weights )
    {
      FT_UInt   width  = (FT_UInt)bitmap-&gt;width;
      FT_UInt   height = (FT_UInt)bitmap-&gt;rows;
      FT_Int    pitch  = bitmap-&gt;pitch;
      FT_Byte*  origin = bitmap-&gt;buffer;
  
      static const unsigned int  filters[3][3] =
      {
        { 65538 * 9/13, 65538 * 1/6, 65538 * 1/13 },
        { 65538 * 3/13, 65538 * 4/6, 65538 * 3/13 },
<span class="line-new-header">--- 181,17 ---</span>
  #ifdef USE_LEGACY
  
    /* intra-pixel filter used by the legacy filter */
    static void
    _ft_lcd_filter_legacy( FT_Bitmap*      bitmap,
                           FT_Byte*        weights )
    {
      FT_UInt   width  = (FT_UInt)bitmap-&gt;width;
      FT_UInt   height = (FT_UInt)bitmap-&gt;rows;
      FT_Int    pitch  = bitmap-&gt;pitch;
      FT_Byte*  origin = bitmap-&gt;buffer;
<span class="line-added">+     FT_Byte   mode   = bitmap-&gt;pixel_mode;</span>
  
      static const unsigned int  filters[3][3] =
      {
        { 65538 * 9/13, 65538 * 1/6, 65538 * 1/13 },
        { 65538 * 3/13, 65538 * 4/6, 65538 * 3/13 },
</pre>
<hr />
<pre>
<span class="line-old-header">*** 194,11 ***</span>
      /* take care of bitmap flow */
      if ( pitch &gt; 0 &amp;&amp; height &gt; 0 )
        origin += pitch * (FT_Int)( height - 1 );
  
      /* horizontal in-place intra-pixel filter */
<span class="line-modified">!     if ( mode == FT_RENDER_MODE_LCD &amp;&amp; width &gt;= 3 )</span>
      {
        FT_Byte*  line = origin;
  
  
        for ( ; height &gt; 0; height--, line -= pitch )
<span class="line-new-header">--- 204,11 ---</span>
      /* take care of bitmap flow */
      if ( pitch &gt; 0 &amp;&amp; height &gt; 0 )
        origin += pitch * (FT_Int)( height - 1 );
  
      /* horizontal in-place intra-pixel filter */
<span class="line-modified">!     if ( mode == FT_PIXEL_MODE_LCD &amp;&amp; width &gt;= 3 )</span>
      {
        FT_Byte*  line = origin;
  
  
        for ( ; height &gt; 0; height--, line -= pitch )
</pre>
<hr />
<pre>
<span class="line-old-header">*** 231,11 ***</span>
            line[xx + 1] = (FT_Byte)( g / 65536 );
            line[xx + 2] = (FT_Byte)( b / 65536 );
          }
        }
      }
<span class="line-modified">!     else if ( mode == FT_RENDER_MODE_LCD_V &amp;&amp; height &gt;= 3 )</span>
      {
        FT_Byte*  column = origin;
  
  
        for ( ; width &gt; 0; width--, column++ )
<span class="line-new-header">--- 241,11 ---</span>
            line[xx + 1] = (FT_Byte)( g / 65536 );
            line[xx + 2] = (FT_Byte)( b / 65536 );
          }
        }
      }
<span class="line-modified">!     else if ( mode == FT_PIXEL_MODE_LCD_V &amp;&amp; height &gt;= 3 )</span>
      {
        FT_Byte*  column = origin;
  
  
        for ( ; width &gt; 0; width--, column++ )
</pre>
<hr />
<pre>
<span class="line-old-header">*** 273,10 ***</span>
<span class="line-new-header">--- 283,12 ---</span>
    }
  
  #endif /* USE_LEGACY */
  
  
<span class="line-added">+   /* documentation in ftlcdfil.h */</span>
<span class="line-added">+ </span>
    FT_EXPORT_DEF( FT_Error )
    FT_Library_SetLcdFilterWeights( FT_Library      library,
                                    unsigned char  *weights )
    {
      if ( !library )
</pre>
<hr />
<pre>
<span class="line-old-header">*** 290,10 ***</span>
<span class="line-new-header">--- 302,12 ---</span>
  
      return FT_Err_Ok;
    }
  
  
<span class="line-added">+   /* documentation in ftlcdfil.h */</span>
<span class="line-added">+ </span>
    FT_EXPORT_DEF( FT_Error )
    FT_Library_SetLcdFilter( FT_Library    library,
                             FT_LcdFilter  filter )
    {
      static const FT_LcdFiveTapFilter  default_weights =
</pre>
<hr />
<pre>
<span class="line-old-header">*** 339,22 ***</span>
      }
  
      return FT_Err_Ok;
    }
  
  #else /* !FT_CONFIG_OPTION_SUBPIXEL_RENDERING */
  
<span class="line-modified">!   /* add padding according to accommodate outline shifts */</span>
    FT_BASE_DEF (void)
<span class="line-modified">!   ft_lcd_padding( FT_Pos*       Min,</span>
<span class="line-modified">!                   FT_Pos*       Max,</span>
<span class="line-modified">!                   FT_GlyphSlot  slot )</span>
    {
<span class="line-modified">!     FT_UNUSED( slot );</span>
  
<span class="line-modified">!     *Min -= 21;</span>
<span class="line-modified">!     *Max += 21;</span>
    }
  
  
    FT_EXPORT_DEF( FT_Error )
    FT_Library_SetLcdFilterWeights( FT_Library      library,
<span class="line-new-header">--- 353,45 ---</span>
      }
  
      return FT_Err_Ok;
    }
  
<span class="line-added">+ </span>
<span class="line-added">+   FT_EXPORT_DEF( FT_Error )</span>
<span class="line-added">+   FT_Library_SetLcdGeometry( FT_Library  library,</span>
<span class="line-added">+                              FT_Vector*  sub )</span>
<span class="line-added">+   {</span>
<span class="line-added">+     FT_UNUSED( library );</span>
<span class="line-added">+     FT_UNUSED( sub );</span>
<span class="line-added">+ </span>
<span class="line-added">+     return FT_THROW( Unimplemented_Feature );</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
  #else /* !FT_CONFIG_OPTION_SUBPIXEL_RENDERING */
  
<span class="line-modified">!   /* add padding to accommodate outline shifts */</span>
    FT_BASE_DEF (void)
<span class="line-modified">!   ft_lcd_padding( FT_BBox*        cbox,</span>
<span class="line-modified">!                   FT_GlyphSlot    slot,</span>
<span class="line-modified">!                   FT_Render_Mode  mode )</span>
    {
<span class="line-modified">!     FT_Vector*  sub = slot-&gt;library-&gt;lcd_geometry;</span>
  
<span class="line-modified">!     if ( mode == FT_RENDER_MODE_LCD )</span>
<span class="line-modified">!     {</span>
<span class="line-added">+       cbox-&gt;xMin -= FT_MAX( FT_MAX( sub[0].x, sub[1].x ), sub[2].x );</span>
<span class="line-added">+       cbox-&gt;xMax -= FT_MIN( FT_MIN( sub[0].x, sub[1].x ), sub[2].x );</span>
<span class="line-added">+       cbox-&gt;yMin -= FT_MAX( FT_MAX( sub[0].y, sub[1].y ), sub[2].y );</span>
<span class="line-added">+       cbox-&gt;yMax -= FT_MIN( FT_MIN( sub[0].y, sub[1].y ), sub[2].y );</span>
<span class="line-added">+     }</span>
<span class="line-added">+     else if ( mode == FT_RENDER_MODE_LCD_V )</span>
<span class="line-added">+     {</span>
<span class="line-added">+       cbox-&gt;xMin -= FT_MAX( FT_MAX( sub[0].y, sub[1].y ), sub[2].y );</span>
<span class="line-added">+       cbox-&gt;xMax -= FT_MIN( FT_MIN( sub[0].y, sub[1].y ), sub[2].y );</span>
<span class="line-added">+       cbox-&gt;yMin += FT_MIN( FT_MIN( sub[0].x, sub[1].x ), sub[2].x );</span>
<span class="line-added">+       cbox-&gt;yMax += FT_MAX( FT_MAX( sub[0].x, sub[1].x ), sub[2].x );</span>
<span class="line-added">+     }</span>
    }
  
  
    FT_EXPORT_DEF( FT_Error )
    FT_Library_SetLcdFilterWeights( FT_Library      library,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 375,9 ***</span>
<span class="line-new-header">--- 412,27 ---</span>
      FT_UNUSED( filter );
  
      return FT_THROW( Unimplemented_Feature );
    }
  
<span class="line-added">+ </span>
<span class="line-added">+   /* documentation in ftlcdfil.h */</span>
<span class="line-added">+ </span>
<span class="line-added">+   FT_EXPORT_DEF( FT_Error )</span>
<span class="line-added">+   FT_Library_SetLcdGeometry( FT_Library  library,</span>
<span class="line-added">+                              FT_Vector   sub[3] )</span>
<span class="line-added">+   {</span>
<span class="line-added">+     if ( !library )</span>
<span class="line-added">+       return FT_THROW( Invalid_Library_Handle );</span>
<span class="line-added">+ </span>
<span class="line-added">+     if ( !sub )</span>
<span class="line-added">+       return FT_THROW( Invalid_Argument );</span>
<span class="line-added">+ </span>
<span class="line-added">+     ft_memcpy( library-&gt;lcd_geometry, sub, 3 * sizeof( FT_Vector ) );</span>
<span class="line-added">+ </span>
<span class="line-added">+     return FT_THROW( Unimplemented_Feature );</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
  #endif /* !FT_CONFIG_OPTION_SUBPIXEL_RENDERING */
  
  
  /* END */
</pre>
<center><a href="ftinit.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftmac.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>