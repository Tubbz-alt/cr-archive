<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/pshinter/pshalgo.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../psaux/t1decode.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="pshalgo.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/pshinter/pshalgo.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 /***************************************************************************/</span>
<span class="line-modified">   2 /*                                                                         */</span>
<span class="line-modified">   3 /*  pshalgo.c                                                              */</span>
<span class="line-modified">   4 /*                                                                         */</span>
<span class="line-modified">   5 /*    PostScript hinting algorithm (body).                                 */</span>
<span class="line-modified">   6 /*                                                                         */</span>
<span class="line-modified">   7 /*  Copyright 2001-2018 by                                                 */</span>
<span class="line-modified">   8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">   9 /*                                                                         */</span>
<span class="line-modified">  10 /*  This file is part of the FreeType project, and may only be used        */</span>
<span class="line-modified">  11 /*  modified and distributed under the terms of the FreeType project       */</span>
<span class="line-modified">  12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">  13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">  14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified">  15 /*                                                                         */</span>
<span class="line-modified">  16 /***************************************************************************/</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_INTERNAL_OBJECTS_H
  21 #include FT_INTERNAL_DEBUG_H
  22 #include FT_INTERNAL_CALC_H
  23 #include &quot;pshalgo.h&quot;
  24 
  25 #include &quot;pshnterr.h&quot;
  26 
  27 
  28 #undef  FT_COMPONENT
<span class="line-modified">  29 #define FT_COMPONENT  trace_pshalgo</span>
  30 
  31 
  32 #ifdef DEBUG_HINTER
  33   PSH_Hint_Table  ps_debug_hint_table = NULL;
  34   PSH_HintFunc    ps_debug_hint_func  = NULL;
  35   PSH_Glyph       ps_debug_glyph      = NULL;
  36 #endif
  37 
  38 
  39 #define  COMPUTE_INFLEXS  /* compute inflection points to optimize `S&#39; */
  40                           /* and similar glyphs                        */
  41 
  42 
  43   /*************************************************************************/
  44   /*************************************************************************/
  45   /*****                                                               *****/
  46   /*****                  BASIC HINTS RECORDINGS                       *****/
  47   /*****                                                               *****/
  48   /*************************************************************************/
  49   /*************************************************************************/
  50 
  51   /* return true if two stem hints overlap */
  52   static FT_Int
  53   psh_hint_overlap( PSH_Hint  hint1,
  54                     PSH_Hint  hint2 )
  55   {
<span class="line-modified">  56     return hint1-&gt;org_pos + hint1-&gt;org_len &gt;= hint2-&gt;org_pos &amp;&amp;</span>
<span class="line-modified">  57            hint2-&gt;org_pos + hint2-&gt;org_len &gt;= hint1-&gt;org_pos;</span>
  58   }
  59 
  60 
  61   /* destroy hints table */
  62   static void
  63   psh_hint_table_done( PSH_Hint_Table  table,
  64                        FT_Memory       memory )
  65   {
  66     FT_FREE( table-&gt;zones );
  67     table-&gt;num_zones = 0;
  68     table-&gt;zone      = NULL;
  69 
  70     FT_FREE( table-&gt;sort );
  71     FT_FREE( table-&gt;hints );
  72     table-&gt;num_hints   = 0;
  73     table-&gt;max_hints   = 0;
  74     table-&gt;sort_global = NULL;
  75   }
  76 
  77 
</pre>
<hr />
<pre>
 462         hint-&gt;cur_len = len;
 463 
 464         psh_hint_set_fitted( hint );
 465         return;
 466       }
 467 
 468       /* perform stem snapping when requested - this is necessary
 469        * for monochrome and LCD hinting modes only
 470        */
 471       do_snapping = ( dimension == 0 &amp;&amp; glyph-&gt;do_horz_snapping ) ||
 472                     ( dimension == 1 &amp;&amp; glyph-&gt;do_vert_snapping );
 473 
 474       hint-&gt;cur_len = fit_len = len;
 475 
 476       /* check blue zones for horizontal stems */
 477       align.align     = PSH_BLUE_ALIGN_NONE;
 478       align.align_bot = align.align_top = 0;
 479 
 480       if ( dimension == 1 )
 481         psh_blues_snap_stem( &amp;globals-&gt;blues,
<span class="line-modified"> 482                              hint-&gt;org_pos + hint-&gt;org_len,</span>
 483                              hint-&gt;org_pos,
 484                              &amp;align );
 485 
 486       switch ( align.align )
 487       {
 488       case PSH_BLUE_ALIGN_TOP:
 489         /* the top of the stem is aligned against a blue zone */
 490         hint-&gt;cur_pos = align.align_top - fit_len;
 491         break;
 492 
 493       case PSH_BLUE_ALIGN_BOT:
 494         /* the bottom of the stem is aligned against a blue zone */
 495         hint-&gt;cur_pos = align.align_bot;
 496         break;
 497 
 498       case PSH_BLUE_ALIGN_TOP | PSH_BLUE_ALIGN_BOT:
 499         /* both edges of the stem are aligned against blue zones */
 500         hint-&gt;cur_pos = align.align_bot;
 501         hint-&gt;cur_len = align.align_top - align.align_bot;
 502         break;
</pre>
<hr />
<pre>
 641               pos = FT_PIX_ROUND( pos + ( len &gt;&gt; 1 ) );
 642 
 643             hint-&gt;cur_pos = pos - ( len &gt;&gt; 1 );
 644             hint-&gt;cur_len = len;
 645         }
 646       }
 647 
 648       psh_hint_set_fitted( hint );
 649 
 650 #ifdef DEBUG_HINTER
 651       if ( ps_debug_hint_func )
 652         ps_debug_hint_func( hint, dimension );
 653 #endif
 654     }
 655   }
 656 
 657 
 658 #if 0  /* not used for now, experimental */
 659 
 660  /*
<span class="line-modified"> 661   *  A variant to perform &quot;light&quot; hinting (i.e. FT_RENDER_MODE_LIGHT)</span>
<span class="line-modified"> 662   *  of stems</span>
 663   */
 664   static void
 665   psh_hint_align_light( PSH_Hint     hint,
 666                         PSH_Globals  globals,
 667                         FT_Int       dimension,
 668                         PSH_Glyph    glyph )
 669   {
 670     PSH_Dimension  dim   = &amp;globals-&gt;dimension[dimension];
 671     FT_Fixed       scale = dim-&gt;scale_mult;
 672     FT_Fixed       delta = dim-&gt;scale_delta;
 673 
 674 
 675     if ( !psh_hint_is_fitted( hint ) )
 676     {
 677       FT_Pos  pos = FT_MulFix( hint-&gt;org_pos, scale ) + delta;
 678       FT_Pos  len = FT_MulFix( hint-&gt;org_len, scale );
 679 
 680       FT_Pos  fit_len;
 681 
 682       PSH_AlignmentRec  align;
</pre>
<hr />
<pre>
 686       if ( ( dimension == 0 &amp;&amp; !glyph-&gt;do_horz_hints ) ||
 687            ( dimension == 1 &amp;&amp; !glyph-&gt;do_vert_hints ) )
 688       {
 689         hint-&gt;cur_pos = pos;
 690         hint-&gt;cur_len = len;
 691 
 692         psh_hint_set_fitted( hint );
 693         return;
 694       }
 695 
 696       fit_len = len;
 697 
 698       hint-&gt;cur_len = fit_len;
 699 
 700       /* check blue zones for horizontal stems */
 701       align.align = PSH_BLUE_ALIGN_NONE;
 702       align.align_bot = align.align_top = 0;
 703 
 704       if ( dimension == 1 )
 705         psh_blues_snap_stem( &amp;globals-&gt;blues,
<span class="line-modified"> 706                              hint-&gt;org_pos + hint-&gt;org_len,</span>
 707                              hint-&gt;org_pos,
 708                              &amp;align );
 709 
 710       switch ( align.align )
 711       {
 712       case PSH_BLUE_ALIGN_TOP:
 713         /* the top of the stem is aligned against a blue zone */
 714         hint-&gt;cur_pos = align.align_top - fit_len;
 715         break;
 716 
 717       case PSH_BLUE_ALIGN_BOT:
 718         /* the bottom of the stem is aligned against a blue zone */
 719         hint-&gt;cur_pos = align.align_bot;
 720         break;
 721 
 722       case PSH_BLUE_ALIGN_TOP | PSH_BLUE_ALIGN_BOT:
 723         /* both edges of the stem are aligned against blue zones */
 724         hint-&gt;cur_pos = align.align_bot;
 725         hint-&gt;cur_len = align.align_top - align.align_bot;
 726         break;
</pre>
<hr />
<pre>
1521             FT_Pos    d    = org_u - hint-&gt;org_pos - hint-&gt;org_len;
1522 
1523 
1524             if ( d &lt; threshold &amp;&amp; -d &lt; threshold )
1525             {
1526               point-&gt;flags2 |= PSH_POINT_EDGE_MAX;
1527               point-&gt;hint    = hint;
1528               psh_point_set_strong( point );
1529               break;
1530             }
1531           }
1532         }
1533 
1534         if ( !point-&gt;hint )
1535         {
1536           for ( nn = 0; nn &lt; num_hints; nn++ )
1537           {
1538             PSH_Hint  hint = sort[nn];
1539 
1540 
<span class="line-modified">1541             if ( org_u &gt;= hint-&gt;org_pos                 &amp;&amp;</span>
<span class="line-modified">1542                 org_u &lt;= hint-&gt;org_pos + hint-&gt;org_len )</span>
1543             {
1544               point-&gt;hint = hint;
1545               break;
1546             }
1547           }
1548         }
1549       }
1550 
1551 #endif /* 1 */
1552     }
1553   }
1554 
1555 
1556   /* the accepted shift for strong points in fractional pixels */
1557 #define PSH_STRONG_THRESHOLD  32
1558 
1559   /* the maximum shift value in font units */
1560 #define PSH_STRONG_THRESHOLD_MAXIMUM  30
1561 
1562 
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 /****************************************************************************</span>
<span class="line-modified">   2  *</span>
<span class="line-modified">   3  * pshalgo.c</span>
<span class="line-modified">   4  *</span>
<span class="line-modified">   5  *   PostScript hinting algorithm (body).</span>
<span class="line-modified">   6  *</span>
<span class="line-modified">   7  * Copyright (C) 2001-2019 by</span>
<span class="line-modified">   8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">   9  *</span>
<span class="line-modified">  10  * This file is part of the FreeType project, and may only be used</span>
<span class="line-modified">  11  * modified and distributed under the terms of the FreeType project</span>
<span class="line-modified">  12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">  13  * this file you indicate that you have read the license and</span>
<span class="line-modified">  14  * understand and accept it fully.</span>
<span class="line-modified">  15  *</span>
<span class="line-modified">  16  */</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_INTERNAL_OBJECTS_H
  21 #include FT_INTERNAL_DEBUG_H
  22 #include FT_INTERNAL_CALC_H
  23 #include &quot;pshalgo.h&quot;
  24 
  25 #include &quot;pshnterr.h&quot;
  26 
  27 
  28 #undef  FT_COMPONENT
<span class="line-modified">  29 #define FT_COMPONENT  pshalgo</span>
  30 
  31 
  32 #ifdef DEBUG_HINTER
  33   PSH_Hint_Table  ps_debug_hint_table = NULL;
  34   PSH_HintFunc    ps_debug_hint_func  = NULL;
  35   PSH_Glyph       ps_debug_glyph      = NULL;
  36 #endif
  37 
  38 
  39 #define  COMPUTE_INFLEXS  /* compute inflection points to optimize `S&#39; */
  40                           /* and similar glyphs                        */
  41 
  42 
  43   /*************************************************************************/
  44   /*************************************************************************/
  45   /*****                                                               *****/
  46   /*****                  BASIC HINTS RECORDINGS                       *****/
  47   /*****                                                               *****/
  48   /*************************************************************************/
  49   /*************************************************************************/
  50 
  51   /* return true if two stem hints overlap */
  52   static FT_Int
  53   psh_hint_overlap( PSH_Hint  hint1,
  54                     PSH_Hint  hint2 )
  55   {
<span class="line-modified">  56     return ADD_INT( hint1-&gt;org_pos, hint1-&gt;org_len ) &gt;= hint2-&gt;org_pos &amp;&amp;</span>
<span class="line-modified">  57            ADD_INT( hint2-&gt;org_pos, hint2-&gt;org_len ) &gt;= hint1-&gt;org_pos;</span>
  58   }
  59 
  60 
  61   /* destroy hints table */
  62   static void
  63   psh_hint_table_done( PSH_Hint_Table  table,
  64                        FT_Memory       memory )
  65   {
  66     FT_FREE( table-&gt;zones );
  67     table-&gt;num_zones = 0;
  68     table-&gt;zone      = NULL;
  69 
  70     FT_FREE( table-&gt;sort );
  71     FT_FREE( table-&gt;hints );
  72     table-&gt;num_hints   = 0;
  73     table-&gt;max_hints   = 0;
  74     table-&gt;sort_global = NULL;
  75   }
  76 
  77 
</pre>
<hr />
<pre>
 462         hint-&gt;cur_len = len;
 463 
 464         psh_hint_set_fitted( hint );
 465         return;
 466       }
 467 
 468       /* perform stem snapping when requested - this is necessary
 469        * for monochrome and LCD hinting modes only
 470        */
 471       do_snapping = ( dimension == 0 &amp;&amp; glyph-&gt;do_horz_snapping ) ||
 472                     ( dimension == 1 &amp;&amp; glyph-&gt;do_vert_snapping );
 473 
 474       hint-&gt;cur_len = fit_len = len;
 475 
 476       /* check blue zones for horizontal stems */
 477       align.align     = PSH_BLUE_ALIGN_NONE;
 478       align.align_bot = align.align_top = 0;
 479 
 480       if ( dimension == 1 )
 481         psh_blues_snap_stem( &amp;globals-&gt;blues,
<span class="line-modified"> 482                              ADD_INT( hint-&gt;org_pos, hint-&gt;org_len ),</span>
 483                              hint-&gt;org_pos,
 484                              &amp;align );
 485 
 486       switch ( align.align )
 487       {
 488       case PSH_BLUE_ALIGN_TOP:
 489         /* the top of the stem is aligned against a blue zone */
 490         hint-&gt;cur_pos = align.align_top - fit_len;
 491         break;
 492 
 493       case PSH_BLUE_ALIGN_BOT:
 494         /* the bottom of the stem is aligned against a blue zone */
 495         hint-&gt;cur_pos = align.align_bot;
 496         break;
 497 
 498       case PSH_BLUE_ALIGN_TOP | PSH_BLUE_ALIGN_BOT:
 499         /* both edges of the stem are aligned against blue zones */
 500         hint-&gt;cur_pos = align.align_bot;
 501         hint-&gt;cur_len = align.align_top - align.align_bot;
 502         break;
</pre>
<hr />
<pre>
 641               pos = FT_PIX_ROUND( pos + ( len &gt;&gt; 1 ) );
 642 
 643             hint-&gt;cur_pos = pos - ( len &gt;&gt; 1 );
 644             hint-&gt;cur_len = len;
 645         }
 646       }
 647 
 648       psh_hint_set_fitted( hint );
 649 
 650 #ifdef DEBUG_HINTER
 651       if ( ps_debug_hint_func )
 652         ps_debug_hint_func( hint, dimension );
 653 #endif
 654     }
 655   }
 656 
 657 
 658 #if 0  /* not used for now, experimental */
 659 
 660  /*
<span class="line-modified"> 661   * A variant to perform &quot;light&quot; hinting (i.e. FT_RENDER_MODE_LIGHT)</span>
<span class="line-modified"> 662   * of stems</span>
 663   */
 664   static void
 665   psh_hint_align_light( PSH_Hint     hint,
 666                         PSH_Globals  globals,
 667                         FT_Int       dimension,
 668                         PSH_Glyph    glyph )
 669   {
 670     PSH_Dimension  dim   = &amp;globals-&gt;dimension[dimension];
 671     FT_Fixed       scale = dim-&gt;scale_mult;
 672     FT_Fixed       delta = dim-&gt;scale_delta;
 673 
 674 
 675     if ( !psh_hint_is_fitted( hint ) )
 676     {
 677       FT_Pos  pos = FT_MulFix( hint-&gt;org_pos, scale ) + delta;
 678       FT_Pos  len = FT_MulFix( hint-&gt;org_len, scale );
 679 
 680       FT_Pos  fit_len;
 681 
 682       PSH_AlignmentRec  align;
</pre>
<hr />
<pre>
 686       if ( ( dimension == 0 &amp;&amp; !glyph-&gt;do_horz_hints ) ||
 687            ( dimension == 1 &amp;&amp; !glyph-&gt;do_vert_hints ) )
 688       {
 689         hint-&gt;cur_pos = pos;
 690         hint-&gt;cur_len = len;
 691 
 692         psh_hint_set_fitted( hint );
 693         return;
 694       }
 695 
 696       fit_len = len;
 697 
 698       hint-&gt;cur_len = fit_len;
 699 
 700       /* check blue zones for horizontal stems */
 701       align.align = PSH_BLUE_ALIGN_NONE;
 702       align.align_bot = align.align_top = 0;
 703 
 704       if ( dimension == 1 )
 705         psh_blues_snap_stem( &amp;globals-&gt;blues,
<span class="line-modified"> 706                              ADD_INT( hint-&gt;org_pos, hint-&gt;org_len ),</span>
 707                              hint-&gt;org_pos,
 708                              &amp;align );
 709 
 710       switch ( align.align )
 711       {
 712       case PSH_BLUE_ALIGN_TOP:
 713         /* the top of the stem is aligned against a blue zone */
 714         hint-&gt;cur_pos = align.align_top - fit_len;
 715         break;
 716 
 717       case PSH_BLUE_ALIGN_BOT:
 718         /* the bottom of the stem is aligned against a blue zone */
 719         hint-&gt;cur_pos = align.align_bot;
 720         break;
 721 
 722       case PSH_BLUE_ALIGN_TOP | PSH_BLUE_ALIGN_BOT:
 723         /* both edges of the stem are aligned against blue zones */
 724         hint-&gt;cur_pos = align.align_bot;
 725         hint-&gt;cur_len = align.align_top - align.align_bot;
 726         break;
</pre>
<hr />
<pre>
1521             FT_Pos    d    = org_u - hint-&gt;org_pos - hint-&gt;org_len;
1522 
1523 
1524             if ( d &lt; threshold &amp;&amp; -d &lt; threshold )
1525             {
1526               point-&gt;flags2 |= PSH_POINT_EDGE_MAX;
1527               point-&gt;hint    = hint;
1528               psh_point_set_strong( point );
1529               break;
1530             }
1531           }
1532         }
1533 
1534         if ( !point-&gt;hint )
1535         {
1536           for ( nn = 0; nn &lt; num_hints; nn++ )
1537           {
1538             PSH_Hint  hint = sort[nn];
1539 
1540 
<span class="line-modified">1541             if ( org_u &gt;=          hint-&gt;org_pos                  &amp;&amp;</span>
<span class="line-modified">1542                  org_u &lt;= ADD_INT( hint-&gt;org_pos, hint-&gt;org_len ) )</span>
1543             {
1544               point-&gt;hint = hint;
1545               break;
1546             }
1547           }
1548         }
1549       }
1550 
1551 #endif /* 1 */
1552     }
1553   }
1554 
1555 
1556   /* the accepted shift for strong points in fractional pixels */
1557 #define PSH_STRONG_THRESHOLD  32
1558 
1559   /* the maximum shift value in font units */
1560 #define PSH_STRONG_THRESHOLD_MAXIMUM  30
1561 
1562 
</pre>
</td>
</tr>
</table>
<center><a href="../psaux/t1decode.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="pshalgo.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>