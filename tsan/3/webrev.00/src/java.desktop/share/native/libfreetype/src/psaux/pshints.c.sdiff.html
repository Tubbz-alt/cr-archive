<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/psaux/pshints.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="psglue.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="pshints.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/psaux/pshints.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 /***************************************************************************/</span>
<span class="line-modified">   2 /*                                                                         */</span>
<span class="line-modified">   3 /*  pshints.c                                                              */</span>
<span class="line-modified">   4 /*                                                                         */</span>
<span class="line-modified">   5 /*    Adobe&#39;s code for handling CFF hints (body).                          */</span>
<span class="line-modified">   6 /*                                                                         */</span>
<span class="line-modified">   7 /*  Copyright 2007-2014 Adobe Systems Incorporated.                        */</span>
<span class="line-modified">   8 /*                                                                         */</span>
<span class="line-modified">   9 /*  This software, and all works of authorship, whether in source or       */</span>
<span class="line-modified">  10 /*  object code form as indicated by the copyright notice(s) included      */</span>
<span class="line-modified">  11 /*  herein (collectively, the &quot;Work&quot;) is made available, and may only be   */</span>
<span class="line-modified">  12 /*  used, modified, and distributed under the FreeType Project License,    */</span>
<span class="line-modified">  13 /*  LICENSE.TXT.  Additionally, subject to the terms and conditions of the */</span>
<span class="line-modified">  14 /*  FreeType Project License, each contributor to the Work hereby grants   */</span>
<span class="line-modified">  15 /*  to any individual or legal entity exercising permissions granted by    */</span>
<span class="line-modified">  16 /*  the FreeType Project License and this section (hereafter, &quot;You&quot; or     */</span>
<span class="line-modified">  17 /*  &quot;Your&quot;) a perpetual, worldwide, non-exclusive, no-charge,              */</span>
<span class="line-modified">  18 /*  royalty-free, irrevocable (except as stated in this section) patent    */</span>
<span class="line-modified">  19 /*  license to make, have made, use, offer to sell, sell, import, and      */</span>
<span class="line-modified">  20 /*  otherwise transfer the Work, where such license applies only to those  */</span>
<span class="line-modified">  21 /*  patent claims licensable by such contributor that are necessarily      */</span>
<span class="line-modified">  22 /*  infringed by their contribution(s) alone or by combination of their    */</span>
<span class="line-modified">  23 /*  contribution(s) with the Work to which such contribution(s) was        */</span>
<span class="line-modified">  24 /*  submitted.  If You institute patent litigation against any entity      */</span>
<span class="line-modified">  25 /*  (including a cross-claim or counterclaim in a lawsuit) alleging that   */</span>
<span class="line-modified">  26 /*  the Work or a contribution incorporated within the Work constitutes    */</span>
<span class="line-modified">  27 /*  direct or contributory patent infringement, then any patent licenses   */</span>
<span class="line-modified">  28 /*  granted to You under this License for that Work shall terminate as of  */</span>
<span class="line-modified">  29 /*  the date such litigation is filed.                                     */</span>
<span class="line-modified">  30 /*                                                                         */</span>
<span class="line-modified">  31 /*  By using, modifying, or distributing the Work you indicate that you    */</span>
<span class="line-modified">  32 /*  have read and understood the terms and conditions of the               */</span>
<span class="line-modified">  33 /*  FreeType Project License as well as those provided in this section,    */</span>
<span class="line-modified">  34 /*  and you accept them fully.                                             */</span>
<span class="line-modified">  35 /*                                                                         */</span>
<span class="line-modified">  36 /***************************************************************************/</span>
  37 
  38 
  39 #include &quot;psft.h&quot;
  40 #include FT_INTERNAL_DEBUG_H
  41 
  42 #include &quot;psglue.h&quot;
  43 #include &quot;psfont.h&quot;
  44 #include &quot;pshints.h&quot;
  45 #include &quot;psintrp.h&quot;
  46 
  47 
<span class="line-modified">  48   /*************************************************************************/</span>
<span class="line-modified">  49   /*                                                                       */</span>
<span class="line-modified">  50   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified">  51   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified">  52   /* messages during execution.                                            */</span>
<span class="line-modified">  53   /*                                                                       */</span>
  54 #undef  FT_COMPONENT
<span class="line-modified">  55 #define FT_COMPONENT  trace_cf2hints</span>
  56 
  57 
  58   typedef struct  CF2_HintMoveRec_
  59   {
  60     size_t     j;          /* index of upper hint map edge   */
  61     CF2_Fixed  moveUp;     /* adjustment to optimum position */
  62 
  63   } CF2_HintMoveRec, *CF2_HintMove;
  64 
  65 
  66   /* Compute angular momentum for winding order detection.  It is called */
  67   /* for all lines and curves, but not necessarily in element order.     */
  68   static CF2_Int
  69   cf2_getWindingMomentum( CF2_Fixed  x1,
  70                           CF2_Fixed  y1,
  71                           CF2_Fixed  x2,
  72                           CF2_Fixed  y2 )
  73   {
  74     /* cross product of pt1 position from origin with pt2 position from  */
  75     /* pt1; we reduce the precision so that the result fits into 32 bits */
</pre>
<hr />
<pre>
 200         hint-&gt;dsCoord = stemHint-&gt;minDS;
 201 
 202       cf2_hint_lock( hint );
 203     }
 204     else
 205       hint-&gt;dsCoord = FT_MulFix( hint-&gt;csCoord, scale );
 206   }
 207 
 208 
 209   /* initialize an invalid hint map element */
 210   static void
 211   cf2_hint_initZero( CF2_Hint  hint )
 212   {
 213     FT_ZERO( hint );
 214   }
 215 
 216 
 217   FT_LOCAL_DEF( FT_Bool )
 218   cf2_hint_isValid( const CF2_Hint  hint )
 219   {
<span class="line-modified"> 220     return (FT_Bool)( hint-&gt;flags != 0 );</span>
 221   }
 222 
 223 
 224   static FT_Bool
 225   cf2_hint_isPair( const CF2_Hint  hint )
 226   {
<span class="line-modified"> 227     return (FT_Bool)( ( hint-&gt;flags                      &amp;</span>
<span class="line-removed"> 228                         ( CF2_PairBottom | CF2_PairTop ) ) != 0 );</span>
 229   }
 230 
 231 
 232   static FT_Bool
 233   cf2_hint_isPairTop( const CF2_Hint  hint )
 234   {
<span class="line-modified"> 235     return (FT_Bool)( ( hint-&gt;flags &amp; CF2_PairTop ) != 0 );</span>
 236   }
 237 
 238 
 239   FT_LOCAL_DEF( FT_Bool )
 240   cf2_hint_isTop( const CF2_Hint  hint )
 241   {
<span class="line-modified"> 242     return (FT_Bool)( ( hint-&gt;flags                    &amp;</span>
<span class="line-removed"> 243                         ( CF2_PairTop | CF2_GhostTop ) ) != 0 );</span>
 244   }
 245 
 246 
 247   FT_LOCAL_DEF( FT_Bool )
 248   cf2_hint_isBottom( const CF2_Hint  hint )
 249   {
<span class="line-modified"> 250     return (FT_Bool)( ( hint-&gt;flags                          &amp;</span>
<span class="line-removed"> 251                         ( CF2_PairBottom | CF2_GhostBottom ) ) != 0 );</span>
 252   }
 253 
 254 
 255   static FT_Bool
 256   cf2_hint_isLocked( const CF2_Hint  hint )
 257   {
<span class="line-modified"> 258     return (FT_Bool)( ( hint-&gt;flags &amp; CF2_Locked ) != 0 );</span>
 259   }
 260 
 261 
 262   static FT_Bool
 263   cf2_hint_isSynthetic( const CF2_Hint  hint )
 264   {
<span class="line-modified"> 265     return (FT_Bool)( ( hint-&gt;flags &amp; CF2_Synthetic ) != 0 );</span>
 266   }
 267 
 268 
 269   FT_LOCAL_DEF( void )
 270   cf2_hint_lock( CF2_Hint  hint )
 271   {
 272     hint-&gt;flags |= CF2_Locked;
 273   }
 274 
 275 
 276   FT_LOCAL_DEF( void )
 277   cf2_hintmap_init( CF2_HintMap   hintmap,
 278                     CF2_Font      font,
 279                     CF2_HintMap   initialMap,
 280                     CF2_ArrStack  hintMoves,
 281                     CF2_Fixed     scale )
 282   {
 283     FT_ZERO( hintmap );
 284 
 285     /* copy parameters from font instance */
</pre>
<hr />
<pre>
 317                   hint-&gt;index,
 318                   hint-&gt;csCoord / 65536.0,
 319                   hint-&gt;dsCoord / ( hint-&gt;scale * 1.0 ),
 320                   hint-&gt;scale,
 321                   ( cf2_hint_isPair( hint ) ? &quot;p&quot; : &quot;g&quot; ),
 322                   ( cf2_hint_isTop( hint ) ? &quot;t&quot; : &quot;b&quot; ),
 323                   ( cf2_hint_isLocked( hint ) ? &quot;L&quot; : &quot;&quot;),
 324                   ( cf2_hint_isSynthetic( hint ) ? &quot;S&quot; : &quot;&quot; ) ));
 325     }
 326 #else
 327     FT_UNUSED( hintmap );
 328 #endif
 329   }
 330 
 331 
 332   /* transform character space coordinate to device space using hint map */
 333   static CF2_Fixed
 334   cf2_hintmap_map( CF2_HintMap  hintmap,
 335                    CF2_Fixed    csCoord )
 336   {
<span class="line-modified"> 337     if ( hintmap-&gt;count == 0 || ! hintmap-&gt;hinted )</span>
 338     {
 339       /* there are no hints; use uniform scale and zero offset */
 340       return FT_MulFix( csCoord, hintmap-&gt;scale );
 341     }
 342     else
 343     {
 344       /* start linear search from last hit */
 345       CF2_UInt  i = hintmap-&gt;lastIndex;
 346 
 347 
 348       FT_ASSERT( hintmap-&gt;lastIndex &lt; CF2_MAX_HINT_EDGES );
 349 
 350       /* search up */
 351       while ( i &lt; hintmap-&gt;count - 1                  &amp;&amp;
 352               csCoord &gt;= hintmap-&gt;edge[i + 1].csCoord )
 353         i += 1;
 354 
 355       /* search down */
 356       while ( i &gt; 0 &amp;&amp; csCoord &lt; hintmap-&gt;edge[i].csCoord )
 357         i -= 1;
</pre>
<hr />
<pre>
 480                hintmap-&gt;edge[i - 1].dsCoord &lt;=
 481                  ADD_INT32( hintmap-&gt;edge[i].dsCoord,
 482                             moveDown - downMinCounter ) )
 483           {
 484             /* move smaller absolute amount */
 485             move = ( -moveDown &lt; moveUp ) ? moveDown : moveUp;  /* optimum */
 486           }
 487           else
 488             move = moveUp;
 489         }
 490         else
 491         {
 492           /* is there room to move down? */
 493           if ( i == 0                                   ||
 494                hintmap-&gt;edge[i - 1].dsCoord &lt;=
 495                  ADD_INT32( hintmap-&gt;edge[i].dsCoord,
 496                             moveDown - downMinCounter ) )
 497           {
 498             move     = moveDown;
 499             /* true if non-optimum move */
<span class="line-modified"> 500             saveEdge = (FT_Bool)( moveUp &lt; -moveDown );</span>
 501           }
 502           else
 503           {
 504             /* no room to move either way without overlapping or reducing */
 505             /* the counter too much                                       */
 506             move     = 0;
 507             saveEdge = TRUE;
 508           }
 509         }
 510 
 511         /* Identify non-moves and moves down that aren&#39;t optimal, and save */
 512         /* them for second pass.                                           */
 513         /* Do this only if there is an unlocked edge above (which could    */
 514         /* possibly move).                                                 */
 515         if ( saveEdge                                    &amp;&amp;
 516              j &lt; hintmap-&gt;count - 1                      &amp;&amp;
 517              !cf2_hint_isLocked( &amp;hintmap-&gt;edge[j + 1] ) )
 518         {
 519           CF2_HintMoveRec  savedMove;
 520 
</pre>
<hr />
<pre>
1008                          i,
1009                          font,
1010                          hintOrigin,
1011                          hintmap-&gt;scale,
1012                          FALSE /* top */ );
1013 
1014           cf2_hintmap_insertHint( hintmap, &amp;bottomHintEdge, &amp;topHintEdge );
1015         }
1016 
1017         if ( ( i &amp; 7 ) == 7 )
1018         {
1019           /* move to next mask byte */
1020           maskPtr++;
1021           maskByte = 0x80;
1022         }
1023         else
1024           maskByte &gt;&gt;= 1;
1025       }
1026     }
1027 
<span class="line-modified">1028     FT_TRACE6(( initialMap ? &quot;flags: [p]air [g]host [t]op &quot;</span>
<span class="line-modified">1029                              &quot;[b]ottom [L]ocked [S]ynthetic\n&quot;</span>
<span class="line-modified">1030                              &quot;Initial hintmap\n&quot;</span>
<span class="line-modified">1031                            : &quot;Hints:\n&quot; ));</span>
1032     cf2_hintmap_dump( hintmap );
1033 
1034     /*
1035      * Note: The following line is a convenient place to break when
1036      *       debugging hinting.  Examine `hintmap-&gt;edge&#39; for the list of
1037      *       enabled hints, then step over the call to see the effect of
1038      *       adjustment.  We stop here first on the recursive call that
1039      *       creates the initial map, and then on each counter group and
1040      *       hint zone.
1041      */
1042 
1043     /* adjust positions of hint edges that are not locked to blue zones */
1044     cf2_hintmap_adjustHints( hintmap );
1045 
1046     FT_TRACE6(( &quot;(adjusted)\n&quot; ));
1047     cf2_hintmap_dump( hintmap );
1048 
1049     /* save the position of all hints that were used in this hint map; */
1050     /* if we use them again, we&#39;ll locate them in the same position    */
1051     if ( !initialMap )
</pre>
<hr />
<pre>
1198    *
1199    */
1200   static FT_Bool
1201   cf2_glyphpath_computeIntersection( CF2_GlyphPath     glyphpath,
1202                                      const FT_Vector*  u1,
1203                                      const FT_Vector*  u2,
1204                                      const FT_Vector*  v1,
1205                                      const FT_Vector*  v2,
1206                                      FT_Vector*        intersection )
1207   {
1208     /*
1209      * Let `u&#39; be a zero-based vector from the first segment, `v&#39; from the
1210      * second segment.
1211      * Let `w &#39;be the zero-based vector from `u1&#39; to `v1&#39;.
1212      * `perp&#39; is the `perpendicular dot product&#39;; see
1213      * https://mathworld.wolfram.com/PerpDotProduct.html.
1214      * `s&#39; is the parameter for the parametric line for the first segment
1215      * (`u&#39;).
1216      *
1217      * See notation in
<span class="line-modified">1218      * http://softsurfer.com/Archive/algorithm_0104/algorithm_0104B.htm.</span>
1219      * Calculations are done in 16.16, but must handle the squaring of
1220      * line lengths in character space.  We scale all vectors by 1/32 to
1221      * avoid overflow.  This allows values up to 4095 to be squared.  The
1222      * scale factor cancels in the divide.
1223      *
1224      * TODO: the scale factor could be computed from UnitsPerEm.
1225      *
1226      */
1227 
1228 #define cf2_perp( a, b )                                    \
1229           ( FT_MulFix( a.x, b.y ) - FT_MulFix( a.y, b.x ) )
1230 
1231   /* round and divide by 32 */
1232 #define CF2_CS_SCALE( x )         \
1233           ( ( (x) + 0x10 ) &gt;&gt; 5 )
1234 
1235     FT_Vector  u, v, w;      /* scaled vectors */
1236     CF2_Fixed  denominator, s;
1237 
1238 
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 /****************************************************************************</span>
<span class="line-modified">   2  *</span>
<span class="line-modified">   3  * pshints.c</span>
<span class="line-modified">   4  *</span>
<span class="line-modified">   5  *   Adobe&#39;s code for handling CFF hints (body).</span>
<span class="line-modified">   6  *</span>
<span class="line-modified">   7  * Copyright 2007-2014 Adobe Systems Incorporated.</span>
<span class="line-modified">   8  *</span>
<span class="line-modified">   9  * This software, and all works of authorship, whether in source or</span>
<span class="line-modified">  10  * object code form as indicated by the copyright notice(s) included</span>
<span class="line-modified">  11  * herein (collectively, the &quot;Work&quot;) is made available, and may only be</span>
<span class="line-modified">  12  * used, modified, and distributed under the FreeType Project License,</span>
<span class="line-modified">  13  * LICENSE.TXT.  Additionally, subject to the terms and conditions of the</span>
<span class="line-modified">  14  * FreeType Project License, each contributor to the Work hereby grants</span>
<span class="line-modified">  15  * to any individual or legal entity exercising permissions granted by</span>
<span class="line-modified">  16  * the FreeType Project License and this section (hereafter, &quot;You&quot; or</span>
<span class="line-modified">  17  * &quot;Your&quot;) a perpetual, worldwide, non-exclusive, no-charge,</span>
<span class="line-modified">  18  * royalty-free, irrevocable (except as stated in this section) patent</span>
<span class="line-modified">  19  * license to make, have made, use, offer to sell, sell, import, and</span>
<span class="line-modified">  20  * otherwise transfer the Work, where such license applies only to those</span>
<span class="line-modified">  21  * patent claims licensable by such contributor that are necessarily</span>
<span class="line-modified">  22  * infringed by their contribution(s) alone or by combination of their</span>
<span class="line-modified">  23  * contribution(s) with the Work to which such contribution(s) was</span>
<span class="line-modified">  24  * submitted.  If You institute patent litigation against any entity</span>
<span class="line-modified">  25  * (including a cross-claim or counterclaim in a lawsuit) alleging that</span>
<span class="line-modified">  26  * the Work or a contribution incorporated within the Work constitutes</span>
<span class="line-modified">  27  * direct or contributory patent infringement, then any patent licenses</span>
<span class="line-modified">  28  * granted to You under this License for that Work shall terminate as of</span>
<span class="line-modified">  29  * the date such litigation is filed.</span>
<span class="line-modified">  30  *</span>
<span class="line-modified">  31  * By using, modifying, or distributing the Work you indicate that you</span>
<span class="line-modified">  32  * have read and understood the terms and conditions of the</span>
<span class="line-modified">  33  * FreeType Project License as well as those provided in this section,</span>
<span class="line-modified">  34  * and you accept them fully.</span>
<span class="line-modified">  35  *</span>
<span class="line-modified">  36  */</span>
  37 
  38 
  39 #include &quot;psft.h&quot;
  40 #include FT_INTERNAL_DEBUG_H
  41 
  42 #include &quot;psglue.h&quot;
  43 #include &quot;psfont.h&quot;
  44 #include &quot;pshints.h&quot;
  45 #include &quot;psintrp.h&quot;
  46 
  47 
<span class="line-modified">  48   /**************************************************************************</span>
<span class="line-modified">  49    *</span>
<span class="line-modified">  50    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified">  51    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified">  52    * messages during execution.</span>
<span class="line-modified">  53    */</span>
  54 #undef  FT_COMPONENT
<span class="line-modified">  55 #define FT_COMPONENT  cf2hints</span>
  56 
  57 
  58   typedef struct  CF2_HintMoveRec_
  59   {
  60     size_t     j;          /* index of upper hint map edge   */
  61     CF2_Fixed  moveUp;     /* adjustment to optimum position */
  62 
  63   } CF2_HintMoveRec, *CF2_HintMove;
  64 
  65 
  66   /* Compute angular momentum for winding order detection.  It is called */
  67   /* for all lines and curves, but not necessarily in element order.     */
  68   static CF2_Int
  69   cf2_getWindingMomentum( CF2_Fixed  x1,
  70                           CF2_Fixed  y1,
  71                           CF2_Fixed  x2,
  72                           CF2_Fixed  y2 )
  73   {
  74     /* cross product of pt1 position from origin with pt2 position from  */
  75     /* pt1; we reduce the precision so that the result fits into 32 bits */
</pre>
<hr />
<pre>
 200         hint-&gt;dsCoord = stemHint-&gt;minDS;
 201 
 202       cf2_hint_lock( hint );
 203     }
 204     else
 205       hint-&gt;dsCoord = FT_MulFix( hint-&gt;csCoord, scale );
 206   }
 207 
 208 
 209   /* initialize an invalid hint map element */
 210   static void
 211   cf2_hint_initZero( CF2_Hint  hint )
 212   {
 213     FT_ZERO( hint );
 214   }
 215 
 216 
 217   FT_LOCAL_DEF( FT_Bool )
 218   cf2_hint_isValid( const CF2_Hint  hint )
 219   {
<span class="line-modified"> 220     return FT_BOOL( hint-&gt;flags );</span>
 221   }
 222 
 223 
 224   static FT_Bool
 225   cf2_hint_isPair( const CF2_Hint  hint )
 226   {
<span class="line-modified"> 227     return FT_BOOL( hint-&gt;flags &amp; ( CF2_PairBottom | CF2_PairTop ) );</span>

 228   }
 229 
 230 
 231   static FT_Bool
 232   cf2_hint_isPairTop( const CF2_Hint  hint )
 233   {
<span class="line-modified"> 234     return FT_BOOL( hint-&gt;flags &amp; CF2_PairTop );</span>
 235   }
 236 
 237 
 238   FT_LOCAL_DEF( FT_Bool )
 239   cf2_hint_isTop( const CF2_Hint  hint )
 240   {
<span class="line-modified"> 241     return FT_BOOL( hint-&gt;flags &amp; ( CF2_PairTop | CF2_GhostTop ) );</span>

 242   }
 243 
 244 
 245   FT_LOCAL_DEF( FT_Bool )
 246   cf2_hint_isBottom( const CF2_Hint  hint )
 247   {
<span class="line-modified"> 248     return FT_BOOL( hint-&gt;flags &amp; ( CF2_PairBottom | CF2_GhostBottom ) );</span>

 249   }
 250 
 251 
 252   static FT_Bool
 253   cf2_hint_isLocked( const CF2_Hint  hint )
 254   {
<span class="line-modified"> 255     return FT_BOOL( hint-&gt;flags &amp; CF2_Locked );</span>
 256   }
 257 
 258 
 259   static FT_Bool
 260   cf2_hint_isSynthetic( const CF2_Hint  hint )
 261   {
<span class="line-modified"> 262     return FT_BOOL( hint-&gt;flags &amp; CF2_Synthetic );</span>
 263   }
 264 
 265 
 266   FT_LOCAL_DEF( void )
 267   cf2_hint_lock( CF2_Hint  hint )
 268   {
 269     hint-&gt;flags |= CF2_Locked;
 270   }
 271 
 272 
 273   FT_LOCAL_DEF( void )
 274   cf2_hintmap_init( CF2_HintMap   hintmap,
 275                     CF2_Font      font,
 276                     CF2_HintMap   initialMap,
 277                     CF2_ArrStack  hintMoves,
 278                     CF2_Fixed     scale )
 279   {
 280     FT_ZERO( hintmap );
 281 
 282     /* copy parameters from font instance */
</pre>
<hr />
<pre>
 314                   hint-&gt;index,
 315                   hint-&gt;csCoord / 65536.0,
 316                   hint-&gt;dsCoord / ( hint-&gt;scale * 1.0 ),
 317                   hint-&gt;scale,
 318                   ( cf2_hint_isPair( hint ) ? &quot;p&quot; : &quot;g&quot; ),
 319                   ( cf2_hint_isTop( hint ) ? &quot;t&quot; : &quot;b&quot; ),
 320                   ( cf2_hint_isLocked( hint ) ? &quot;L&quot; : &quot;&quot;),
 321                   ( cf2_hint_isSynthetic( hint ) ? &quot;S&quot; : &quot;&quot; ) ));
 322     }
 323 #else
 324     FT_UNUSED( hintmap );
 325 #endif
 326   }
 327 
 328 
 329   /* transform character space coordinate to device space using hint map */
 330   static CF2_Fixed
 331   cf2_hintmap_map( CF2_HintMap  hintmap,
 332                    CF2_Fixed    csCoord )
 333   {
<span class="line-modified"> 334     if ( hintmap-&gt;count == 0 || !hintmap-&gt;hinted )</span>
 335     {
 336       /* there are no hints; use uniform scale and zero offset */
 337       return FT_MulFix( csCoord, hintmap-&gt;scale );
 338     }
 339     else
 340     {
 341       /* start linear search from last hit */
 342       CF2_UInt  i = hintmap-&gt;lastIndex;
 343 
 344 
 345       FT_ASSERT( hintmap-&gt;lastIndex &lt; CF2_MAX_HINT_EDGES );
 346 
 347       /* search up */
 348       while ( i &lt; hintmap-&gt;count - 1                  &amp;&amp;
 349               csCoord &gt;= hintmap-&gt;edge[i + 1].csCoord )
 350         i += 1;
 351 
 352       /* search down */
 353       while ( i &gt; 0 &amp;&amp; csCoord &lt; hintmap-&gt;edge[i].csCoord )
 354         i -= 1;
</pre>
<hr />
<pre>
 477                hintmap-&gt;edge[i - 1].dsCoord &lt;=
 478                  ADD_INT32( hintmap-&gt;edge[i].dsCoord,
 479                             moveDown - downMinCounter ) )
 480           {
 481             /* move smaller absolute amount */
 482             move = ( -moveDown &lt; moveUp ) ? moveDown : moveUp;  /* optimum */
 483           }
 484           else
 485             move = moveUp;
 486         }
 487         else
 488         {
 489           /* is there room to move down? */
 490           if ( i == 0                                   ||
 491                hintmap-&gt;edge[i - 1].dsCoord &lt;=
 492                  ADD_INT32( hintmap-&gt;edge[i].dsCoord,
 493                             moveDown - downMinCounter ) )
 494           {
 495             move     = moveDown;
 496             /* true if non-optimum move */
<span class="line-modified"> 497             saveEdge = FT_BOOL( moveUp &lt; -moveDown );</span>
 498           }
 499           else
 500           {
 501             /* no room to move either way without overlapping or reducing */
 502             /* the counter too much                                       */
 503             move     = 0;
 504             saveEdge = TRUE;
 505           }
 506         }
 507 
 508         /* Identify non-moves and moves down that aren&#39;t optimal, and save */
 509         /* them for second pass.                                           */
 510         /* Do this only if there is an unlocked edge above (which could    */
 511         /* possibly move).                                                 */
 512         if ( saveEdge                                    &amp;&amp;
 513              j &lt; hintmap-&gt;count - 1                      &amp;&amp;
 514              !cf2_hint_isLocked( &amp;hintmap-&gt;edge[j + 1] ) )
 515         {
 516           CF2_HintMoveRec  savedMove;
 517 
</pre>
<hr />
<pre>
1005                          i,
1006                          font,
1007                          hintOrigin,
1008                          hintmap-&gt;scale,
1009                          FALSE /* top */ );
1010 
1011           cf2_hintmap_insertHint( hintmap, &amp;bottomHintEdge, &amp;topHintEdge );
1012         }
1013 
1014         if ( ( i &amp; 7 ) == 7 )
1015         {
1016           /* move to next mask byte */
1017           maskPtr++;
1018           maskByte = 0x80;
1019         }
1020         else
1021           maskByte &gt;&gt;= 1;
1022       }
1023     }
1024 
<span class="line-modified">1025     FT_TRACE6(( &quot;%s\n&quot;, initialMap ? &quot;flags: [p]air [g]host [t]op&quot;</span>
<span class="line-modified">1026                                      &quot; [b]ottom [L]ocked [S]ynthetic\n&quot;</span>
<span class="line-modified">1027                                      &quot;Initial hintmap&quot;</span>
<span class="line-modified">1028                                    : &quot;Hints:&quot; ));</span>
1029     cf2_hintmap_dump( hintmap );
1030 
1031     /*
1032      * Note: The following line is a convenient place to break when
1033      *       debugging hinting.  Examine `hintmap-&gt;edge&#39; for the list of
1034      *       enabled hints, then step over the call to see the effect of
1035      *       adjustment.  We stop here first on the recursive call that
1036      *       creates the initial map, and then on each counter group and
1037      *       hint zone.
1038      */
1039 
1040     /* adjust positions of hint edges that are not locked to blue zones */
1041     cf2_hintmap_adjustHints( hintmap );
1042 
1043     FT_TRACE6(( &quot;(adjusted)\n&quot; ));
1044     cf2_hintmap_dump( hintmap );
1045 
1046     /* save the position of all hints that were used in this hint map; */
1047     /* if we use them again, we&#39;ll locate them in the same position    */
1048     if ( !initialMap )
</pre>
<hr />
<pre>
1195    *
1196    */
1197   static FT_Bool
1198   cf2_glyphpath_computeIntersection( CF2_GlyphPath     glyphpath,
1199                                      const FT_Vector*  u1,
1200                                      const FT_Vector*  u2,
1201                                      const FT_Vector*  v1,
1202                                      const FT_Vector*  v2,
1203                                      FT_Vector*        intersection )
1204   {
1205     /*
1206      * Let `u&#39; be a zero-based vector from the first segment, `v&#39; from the
1207      * second segment.
1208      * Let `w &#39;be the zero-based vector from `u1&#39; to `v1&#39;.
1209      * `perp&#39; is the `perpendicular dot product&#39;; see
1210      * https://mathworld.wolfram.com/PerpDotProduct.html.
1211      * `s&#39; is the parameter for the parametric line for the first segment
1212      * (`u&#39;).
1213      *
1214      * See notation in
<span class="line-modified">1215      * http://geomalgorithms.com/a05-_intersect-1.html.</span>
1216      * Calculations are done in 16.16, but must handle the squaring of
1217      * line lengths in character space.  We scale all vectors by 1/32 to
1218      * avoid overflow.  This allows values up to 4095 to be squared.  The
1219      * scale factor cancels in the divide.
1220      *
1221      * TODO: the scale factor could be computed from UnitsPerEm.
1222      *
1223      */
1224 
1225 #define cf2_perp( a, b )                                    \
1226           ( FT_MulFix( a.x, b.y ) - FT_MulFix( a.y, b.x ) )
1227 
1228   /* round and divide by 32 */
1229 #define CF2_CS_SCALE( x )         \
1230           ( ( (x) + 0x10 ) &gt;&gt; 5 )
1231 
1232     FT_Vector  u, v, w;      /* scaled vectors */
1233     CF2_Fixed  denominator, s;
1234 
1235 
</pre>
</td>
</tr>
</table>
<center><a href="psglue.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="pshints.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>