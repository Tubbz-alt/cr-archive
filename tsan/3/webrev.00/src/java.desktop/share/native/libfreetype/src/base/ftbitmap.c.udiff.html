<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfreetype/src/base/ftbitmap.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ftbbox.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftcalc.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/base/ftbitmap.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,33 +1,43 @@</span>
<span class="udiff-line-modified-removed">- /***************************************************************************/</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  ftbitmap.c                                                             */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*    FreeType utility functions for bitmaps (body).                       */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  Copyright 2004-2018 by                                                 */</span>
<span class="udiff-line-modified-removed">- /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="udiff-line-modified-removed">- /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="udiff-line-modified-removed">- /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="udiff-line-modified-removed">- /*  this file you indicate that you have read the license and              */</span>
<span class="udiff-line-modified-removed">- /*  understand and accept it fully.                                        */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /***************************************************************************/</span>
<span class="udiff-line-modified-added">+ /****************************************************************************</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * ftbitmap.c</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  *   FreeType utility functions for bitmaps (body).</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 2004-2019 by</span>
<span class="udiff-line-modified-added">+  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * This file is part of the FreeType project, and may only be used,</span>
<span class="udiff-line-modified-added">+  * modified, and distributed under the terms of the FreeType project</span>
<span class="udiff-line-modified-added">+  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="udiff-line-modified-added">+  * this file you indicate that you have read the license and</span>
<span class="udiff-line-modified-added">+  * understand and accept it fully.</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  */</span>
  
  
  #include &lt;ft2build.h&gt;
  #include FT_INTERNAL_DEBUG_H
  
  #include FT_BITMAP_H
  #include FT_IMAGE_H
  #include FT_INTERNAL_OBJECTS_H
  
  
<span class="udiff-line-added">+   /**************************************************************************</span>
<span class="udiff-line-added">+    *</span>
<span class="udiff-line-added">+    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="udiff-line-added">+    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="udiff-line-added">+    * messages during execution.</span>
<span class="udiff-line-added">+    */</span>
<span class="udiff-line-added">+ #undef  FT_COMPONENT</span>
<span class="udiff-line-added">+ #define FT_COMPONENT  bitmap</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
    static
<span class="udiff-line-modified-removed">-   const FT_Bitmap  null_bitmap = { 0, 0, 0, 0, 0, 0, 0, 0 };</span>
<span class="udiff-line-modified-added">+   const FT_Bitmap  null_bitmap = { 0, 0, 0, NULL, 0, 0, 0, NULL };</span>
  
  
    /* documentation is in ftbitmap.h */
  
    FT_EXPORT_DEF( void )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -781,10 +791,342 @@</span>
  
      return error;
    }
  
  
<span class="udiff-line-added">+   /* documentation is in ftbitmap.h */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   FT_EXPORT_DEF( FT_Error )</span>
<span class="udiff-line-added">+   FT_Bitmap_Blend( FT_Library        library,</span>
<span class="udiff-line-added">+                    const FT_Bitmap*  source_,</span>
<span class="udiff-line-added">+                    const FT_Vector   source_offset_,</span>
<span class="udiff-line-added">+                    FT_Bitmap*        target,</span>
<span class="udiff-line-added">+                    FT_Vector        *atarget_offset,</span>
<span class="udiff-line-added">+                    FT_Color          color )</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     FT_Error   error = FT_Err_Ok;</span>
<span class="udiff-line-added">+     FT_Memory  memory;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     FT_Bitmap         source_bitmap;</span>
<span class="udiff-line-added">+     const FT_Bitmap*  source;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     FT_Vector  source_offset;</span>
<span class="udiff-line-added">+     FT_Vector  target_offset;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     FT_Bool  free_source_bitmap          = 0;</span>
<span class="udiff-line-added">+     FT_Bool  free_target_bitmap_on_error = 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     FT_Pos  source_llx, source_lly, source_urx, source_ury;</span>
<span class="udiff-line-added">+     FT_Pos  target_llx, target_lly, target_urx, target_ury;</span>
<span class="udiff-line-added">+     FT_Pos  final_llx, final_lly, final_urx, final_ury;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     unsigned int  final_rows, final_width;</span>
<span class="udiff-line-added">+     long          x, y;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( !library || !target || !source_ || !atarget_offset )</span>
<span class="udiff-line-added">+       return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     memory = library-&gt;memory;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( !( target-&gt;pixel_mode == FT_PIXEL_MODE_NONE     ||</span>
<span class="udiff-line-added">+             ( target-&gt;pixel_mode == FT_PIXEL_MODE_BGRA &amp;&amp;</span>
<span class="udiff-line-added">+               target-&gt;buffer                           ) ) )</span>
<span class="udiff-line-added">+       return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( source_-&gt;pixel_mode == FT_PIXEL_MODE_NONE )</span>
<span class="udiff-line-added">+       return FT_Err_Ok;               /* nothing to do */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* pitches must have the same sign */</span>
<span class="udiff-line-added">+     if ( target-&gt;pixel_mode == FT_PIXEL_MODE_BGRA &amp;&amp;</span>
<span class="udiff-line-added">+          ( source_-&gt;pitch ^ target-&gt;pitch ) &lt; 0   )</span>
<span class="udiff-line-added">+       return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( !( source_-&gt;width &amp;&amp; source_-&gt;rows ) )</span>
<span class="udiff-line-added">+       return FT_Err_Ok;               /* nothing to do */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* assure integer pixel offsets */</span>
<span class="udiff-line-added">+     source_offset.x = FT_PIX_FLOOR( source_offset_.x );</span>
<span class="udiff-line-added">+     source_offset.y = FT_PIX_FLOOR( source_offset_.y );</span>
<span class="udiff-line-added">+     target_offset.x = FT_PIX_FLOOR( atarget_offset-&gt;x );</span>
<span class="udiff-line-added">+     target_offset.y = FT_PIX_FLOOR( atarget_offset-&gt;y );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* get source bitmap dimensions */</span>
<span class="udiff-line-added">+     source_llx = source_offset.x;</span>
<span class="udiff-line-added">+     if ( FT_LONG_MIN + (FT_Pos)( source_-&gt;rows &lt;&lt; 6 ) + 64 &gt; source_offset.y )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       FT_TRACE5((</span>
<span class="udiff-line-added">+         &quot;FT_Bitmap_Blend: y coordinate overflow in source bitmap\n&quot; ));</span>
<span class="udiff-line-added">+       return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     source_lly = source_offset.y - ( source_-&gt;rows &lt;&lt; 6 );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( FT_LONG_MAX - (FT_Pos)( source_-&gt;width &lt;&lt; 6 ) - 64 &lt; source_llx )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       FT_TRACE5((</span>
<span class="udiff-line-added">+         &quot;FT_Bitmap_Blend: x coordinate overflow in source bitmap\n&quot; ));</span>
<span class="udiff-line-added">+       return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     source_urx = source_llx + ( source_-&gt;width &lt;&lt; 6 );</span>
<span class="udiff-line-added">+     source_ury = source_offset.y;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* get target bitmap dimensions */</span>
<span class="udiff-line-added">+     if ( target-&gt;width &amp;&amp; target-&gt;rows )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       target_llx = target_offset.x;</span>
<span class="udiff-line-added">+       if ( FT_LONG_MIN + (FT_Pos)( target-&gt;rows &lt;&lt; 6 ) &gt; target_offset.y )</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         FT_TRACE5((</span>
<span class="udiff-line-added">+           &quot;FT_Bitmap_Blend: y coordinate overflow in target bitmap\n&quot; ));</span>
<span class="udiff-line-added">+         return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+       target_lly = target_offset.y - ( target-&gt;rows &lt;&lt; 6 );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if ( FT_LONG_MAX - (FT_Pos)( target-&gt;width &lt;&lt; 6 ) &lt; target_llx )</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         FT_TRACE5((</span>
<span class="udiff-line-added">+           &quot;FT_Bitmap_Blend: x coordinate overflow in target bitmap\n&quot; ));</span>
<span class="udiff-line-added">+         return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+       target_urx = target_llx + ( target-&gt;width &lt;&lt; 6 );</span>
<span class="udiff-line-added">+       target_ury = target_offset.y;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       target_llx = FT_LONG_MAX;</span>
<span class="udiff-line-added">+       target_lly = FT_LONG_MAX;</span>
<span class="udiff-line-added">+       target_urx = FT_LONG_MIN;</span>
<span class="udiff-line-added">+       target_ury = FT_LONG_MIN;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* compute final bitmap dimensions */</span>
<span class="udiff-line-added">+     final_llx = FT_MIN( source_llx, target_llx );</span>
<span class="udiff-line-added">+     final_lly = FT_MIN( source_lly, target_lly );</span>
<span class="udiff-line-added">+     final_urx = FT_MAX( source_urx, target_urx );</span>
<span class="udiff-line-added">+     final_ury = FT_MAX( source_ury, target_ury );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     final_width = ( final_urx - final_llx ) &gt;&gt; 6;</span>
<span class="udiff-line-added">+     final_rows  = ( final_ury - final_lly ) &gt;&gt; 6;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #ifdef FT_DEBUG_LEVEL_TRACE</span>
<span class="udiff-line-added">+     FT_TRACE5(( &quot;FT_Bitmap_Blend:\n&quot;</span>
<span class="udiff-line-added">+                 &quot;  source bitmap: (%d, %d) -- (%d, %d); %d x %d\n&quot;,</span>
<span class="udiff-line-added">+       source_llx / 64, source_lly / 64,</span>
<span class="udiff-line-added">+       source_urx / 64, source_ury / 64,</span>
<span class="udiff-line-added">+       source_-&gt;width, source_-&gt;rows ));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( target-&gt;width &amp;&amp; target-&gt;rows )</span>
<span class="udiff-line-added">+       FT_TRACE5(( &quot;  target bitmap: (%d, %d) -- (%d, %d); %d x %d\n&quot;,</span>
<span class="udiff-line-added">+         target_llx / 64, target_lly / 64,</span>
<span class="udiff-line-added">+         target_urx / 64, target_ury / 64,</span>
<span class="udiff-line-added">+         target-&gt;width, target-&gt;rows ));</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+       FT_TRACE5(( &quot;  target bitmap: empty\n&quot; ));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( final_width &amp;&amp; final_rows )</span>
<span class="udiff-line-added">+       FT_TRACE5(( &quot;  final bitmap: (%d, %d) -- (%d, %d); %d x %d\n&quot;,</span>
<span class="udiff-line-added">+         final_llx / 64, final_lly / 64,</span>
<span class="udiff-line-added">+         final_urx / 64, final_ury / 64,</span>
<span class="udiff-line-added">+         final_width, final_rows ));</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+       FT_TRACE5(( &quot;  final bitmap: empty\n&quot; ));</span>
<span class="udiff-line-added">+ #endif /* FT_DEBUG_LEVEL_TRACE */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( !( final_width &amp;&amp; final_rows ) )</span>
<span class="udiff-line-added">+       return FT_Err_Ok;               /* nothing to do */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* for blending, set offset vector of final bitmap */</span>
<span class="udiff-line-added">+     /* temporarily to (0,0)                            */</span>
<span class="udiff-line-added">+     source_llx -= final_llx;</span>
<span class="udiff-line-added">+     source_lly -= final_lly;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( target-&gt;width &amp;&amp; target-&gt;rows )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       target_llx -= final_llx;</span>
<span class="udiff-line-added">+       target_lly -= final_lly;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* set up target bitmap */</span>
<span class="udiff-line-added">+     if ( target-&gt;pixel_mode == FT_PIXEL_MODE_NONE )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       /* create new empty bitmap */</span>
<span class="udiff-line-added">+       target-&gt;width      = final_width;</span>
<span class="udiff-line-added">+       target-&gt;rows       = final_rows;</span>
<span class="udiff-line-added">+       target-&gt;pixel_mode = FT_PIXEL_MODE_BGRA;</span>
<span class="udiff-line-added">+       target-&gt;pitch      = (int)final_width * 4;</span>
<span class="udiff-line-added">+       target-&gt;num_grays  = 256;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if ( FT_LONG_MAX / target-&gt;pitch &lt; (int)target-&gt;rows )</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         FT_TRACE5(( &quot;FT_Blend_Bitmap: target bitmap too large (%d x %d)\n&quot;,</span>
<span class="udiff-line-added">+                      final_width, final_rows ));</span>
<span class="udiff-line-added">+         return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if ( FT_ALLOC( target-&gt;buffer, target-&gt;pitch * (int)target-&gt;rows ) )</span>
<span class="udiff-line-added">+         return error;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       free_target_bitmap_on_error = 1;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     else if ( target-&gt;width != final_width ||</span>
<span class="udiff-line-added">+               target-&gt;rows  != final_rows  )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       /* adjust old bitmap to enlarged size */</span>
<span class="udiff-line-added">+       int  pitch, new_pitch;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       unsigned char*  buffer = NULL;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       pitch = target-&gt;pitch;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if ( pitch &lt; 0 )</span>
<span class="udiff-line-added">+         pitch = -pitch;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       new_pitch = (int)final_width * 4;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if ( FT_LONG_MAX / new_pitch &lt; (int)final_rows )</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         FT_TRACE5(( &quot;FT_Blend_Bitmap: target bitmap too large (%d x %d)\n&quot;,</span>
<span class="udiff-line-added">+                      final_width, final_rows ));</span>
<span class="udiff-line-added">+         return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       /* TODO: provide an in-buffer solution for large bitmaps */</span>
<span class="udiff-line-added">+       /*       to avoid allocation of a new buffer             */</span>
<span class="udiff-line-added">+       if ( FT_ALLOC( buffer, new_pitch * (int)final_rows ) )</span>
<span class="udiff-line-added">+         goto Error;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       /* copy data to new buffer */</span>
<span class="udiff-line-added">+       x = target_llx &gt;&gt; 6;</span>
<span class="udiff-line-added">+       y = target_lly &gt;&gt; 6;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       /* the bitmap flow is from top to bottom, */</span>
<span class="udiff-line-added">+       /* but y is measured from bottom to top   */</span>
<span class="udiff-line-added">+       if ( target-&gt;pitch &lt; 0 )</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         /* XXX */</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+       else</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         unsigned char*  p =</span>
<span class="udiff-line-added">+           target-&gt;buffer;</span>
<span class="udiff-line-added">+         unsigned char*  q =</span>
<span class="udiff-line-added">+           buffer +</span>
<span class="udiff-line-added">+           ( final_rows - y - target-&gt;rows ) * new_pitch +</span>
<span class="udiff-line-added">+           x * 4;</span>
<span class="udiff-line-added">+         unsigned char*  limit_p =</span>
<span class="udiff-line-added">+           p + pitch * (int)target-&gt;rows;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         while ( p &lt; limit_p )</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+           FT_MEM_COPY( q, p, pitch );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           p += pitch;</span>
<span class="udiff-line-added">+           q += new_pitch;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       FT_FREE( target-&gt;buffer );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       target-&gt;width = final_width;</span>
<span class="udiff-line-added">+       target-&gt;rows  = final_rows;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if ( target-&gt;pitch &lt; 0 )</span>
<span class="udiff-line-added">+         target-&gt;pitch = -new_pitch;</span>
<span class="udiff-line-added">+       else</span>
<span class="udiff-line-added">+         target-&gt;pitch = new_pitch;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       target-&gt;buffer = buffer;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* adjust source bitmap if necessary */</span>
<span class="udiff-line-added">+     if ( source_-&gt;pixel_mode != FT_PIXEL_MODE_GRAY )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       FT_Bitmap_Init( &amp;source_bitmap );</span>
<span class="udiff-line-added">+       error = FT_Bitmap_Convert( library, source_, &amp;source_bitmap, 1 );</span>
<span class="udiff-line-added">+       if ( error )</span>
<span class="udiff-line-added">+         goto Error;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       source             = &amp;source_bitmap;</span>
<span class="udiff-line-added">+       free_source_bitmap = 1;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+       source = source_;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* do blending; the code below returns pre-multiplied channels, */</span>
<span class="udiff-line-added">+     /* similar to what FreeType gets from `CBDT&#39; tables             */</span>
<span class="udiff-line-added">+     x = source_llx &gt;&gt; 6;</span>
<span class="udiff-line-added">+     y = source_lly &gt;&gt; 6;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* the bitmap flow is from top to bottom, */</span>
<span class="udiff-line-added">+     /* but y is measured from bottom to top   */</span>
<span class="udiff-line-added">+     if ( target-&gt;pitch &lt; 0 )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       /* XXX */</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       unsigned char*  p =</span>
<span class="udiff-line-added">+         source-&gt;buffer;</span>
<span class="udiff-line-added">+       unsigned char*  q =</span>
<span class="udiff-line-added">+         target-&gt;buffer +</span>
<span class="udiff-line-added">+         ( target-&gt;rows - y - source-&gt;rows ) * target-&gt;pitch +</span>
<span class="udiff-line-added">+         x * 4;</span>
<span class="udiff-line-added">+       unsigned char*  limit_p =</span>
<span class="udiff-line-added">+         p + source-&gt;pitch * (int)source-&gt;rows;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       while ( p &lt; limit_p )</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         unsigned char*  r       = p;</span>
<span class="udiff-line-added">+         unsigned char*  s       = q;</span>
<span class="udiff-line-added">+         unsigned char*  limit_r = r + source-&gt;width;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         while ( r &lt; limit_r )</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+           int  aa = *r++;</span>
<span class="udiff-line-added">+           int  fa = color.alpha * aa / 255;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           int  fb = color.blue * fa / 255;</span>
<span class="udiff-line-added">+           int  fg = color.green * fa / 255;</span>
<span class="udiff-line-added">+           int  fr = color.red * fa / 255;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           int  ba2 = 255 - fa;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           int  bb = s[0];</span>
<span class="udiff-line-added">+           int  bg = s[1];</span>
<span class="udiff-line-added">+           int  br = s[2];</span>
<span class="udiff-line-added">+           int  ba = s[3];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           *s++ = (unsigned char)( bb * ba2 / 255 + fb );</span>
<span class="udiff-line-added">+           *s++ = (unsigned char)( bg * ba2 / 255 + fg );</span>
<span class="udiff-line-added">+           *s++ = (unsigned char)( br * ba2 / 255 + fr );</span>
<span class="udiff-line-added">+           *s++ = (unsigned char)( ba * ba2 / 255 + fa );</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         p += source-&gt;pitch;</span>
<span class="udiff-line-added">+         q += target-&gt;pitch;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     atarget_offset-&gt;x = final_llx;</span>
<span class="udiff-line-added">+     atarget_offset-&gt;y = final_lly + ( final_rows &lt;&lt; 6 );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   Error:</span>
<span class="udiff-line-added">+     if ( error &amp;&amp; free_target_bitmap_on_error )</span>
<span class="udiff-line-added">+       FT_Bitmap_Done( library, target );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( free_source_bitmap )</span>
<span class="udiff-line-added">+       FT_Bitmap_Done( library, &amp;source_bitmap );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return error;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
    /* documentation is in ftbitmap.h */
  
    FT_EXPORT_DEF( FT_Error )
    FT_GlyphSlot_Own_Bitmap( FT_GlyphSlot  slot )
    {
</pre>
<center><a href="ftbbox.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftcalc.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>