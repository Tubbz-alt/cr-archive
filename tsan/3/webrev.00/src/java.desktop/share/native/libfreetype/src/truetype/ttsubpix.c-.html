<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.desktop/share/native/libfreetype/src/truetype/ttsubpix.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /***************************************************************************/
   2 /*                                                                         */
   3 /*  ttsubpix.c                                                             */
   4 /*                                                                         */
   5 /*    TrueType Subpixel Hinting.                                           */
   6 /*                                                                         */
   7 /*  Copyright 2010-2018 by                                                 */
   8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */
   9 /*                                                                         */
  10 /*  This file is part of the FreeType project, and may only be used,       */
  11 /*  modified, and distributed under the terms of the FreeType project      */
  12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */
  13 /*  this file you indicate that you have read the license and              */
  14 /*  understand and accept it fully.                                        */
  15 /*                                                                         */
  16 /***************************************************************************/
  17 
  18 #include &lt;ft2build.h&gt;
  19 #include FT_INTERNAL_DEBUG_H
  20 #include FT_INTERNAL_CALC_H
  21 #include FT_INTERNAL_STREAM_H
  22 #include FT_INTERNAL_SFNT_H
  23 #include FT_TRUETYPE_TAGS_H
  24 #include FT_OUTLINE_H
  25 #include FT_DRIVER_H
  26 
  27 #include &quot;ttsubpix.h&quot;
  28 
  29 
  30 #if defined( TT_USE_BYTECODE_INTERPRETER )            &amp;&amp; \
  31     defined( TT_SUPPORT_SUBPIXEL_HINTING_INFINALITY )
  32 
  33   /*************************************************************************/
  34   /*                                                                       */
  35   /* These rules affect how the TT Interpreter does hinting, with the      */
  36   /* goal of doing subpixel hinting by (in general) ignoring x moves.      */
  37   /* Some of these rules are fixes that go above and beyond the            */
  38   /* stated techniques in the MS whitepaper on Cleartype, due to           */
  39   /* artifacts in many glyphs.  So, these rules make some glyphs render    */
  40   /* better than they do in the MS rasterizer.                             */
  41   /*                                                                       */
  42   /* &quot;&quot; string or 0 int/char indicates to apply to all glyphs.             */
  43   /* &quot;-&quot; used as dummy placeholders, but any non-matching string works.    */
  44   /*                                                                       */
  45   /* Some of this could arguably be implemented in fontconfig, however:    */
  46   /*                                                                       */
  47   /*  - Fontconfig can&#39;t set things on a glyph-by-glyph basis.             */
  48   /*  - The tweaks that happen here are very low-level, from an average    */
  49   /*    user&#39;s point of view and are best implemented in the hinter.       */
  50   /*                                                                       */
  51   /* The goal is to make the subpixel hinting techniques as generalized    */
  52   /* as possible across all fonts to prevent the need for extra rules such */
  53   /* as these.                                                             */
  54   /*                                                                       */
  55   /* The rule structure is designed so that entirely new rules can easily  */
  56   /* be added when a new compatibility feature is discovered.              */
  57   /*                                                                       */
  58   /* The rule structures could also use some enhancement to handle ranges. */
  59   /*                                                                       */
  60   /*     ****************** WORK IN PROGRESS *******************           */
  61   /*                                                                       */
  62 
  63   /* These are `classes&#39; of fonts that can be grouped together and used in */
  64   /* rules below.  A blank entry &quot;&quot; is required at the end of these!       */
  65 #define FAMILY_CLASS_RULES_SIZE  7
  66 
  67   static const SPH_Font_Class  FAMILY_CLASS_Rules
  68                                [FAMILY_CLASS_RULES_SIZE] =
  69   {
  70     { &quot;MS Legacy Fonts&quot;,
  71       { &quot;Aharoni&quot;,
  72         &quot;Andale Mono&quot;,
  73         &quot;Andalus&quot;,
  74         &quot;Angsana New&quot;,
  75         &quot;AngsanaUPC&quot;,
  76         &quot;Arabic Transparent&quot;,
  77         &quot;Arial Black&quot;,
  78         &quot;Arial Narrow&quot;,
  79         &quot;Arial Unicode MS&quot;,
  80         &quot;Arial&quot;,
  81         &quot;Batang&quot;,
  82         &quot;Browallia New&quot;,
  83         &quot;BrowalliaUPC&quot;,
  84         &quot;Comic Sans MS&quot;,
  85         &quot;Cordia New&quot;,
  86         &quot;CordiaUPC&quot;,
  87         &quot;Courier New&quot;,
  88         &quot;DFKai-SB&quot;,
  89         &quot;David Transparent&quot;,
  90         &quot;David&quot;,
  91         &quot;DilleniaUPC&quot;,
  92         &quot;Estrangelo Edessa&quot;,
  93         &quot;EucrosiaUPC&quot;,
  94         &quot;FangSong_GB2312&quot;,
  95         &quot;Fixed Miriam Transparent&quot;,
  96         &quot;FrankRuehl&quot;,
  97         &quot;Franklin Gothic Medium&quot;,
  98         &quot;FreesiaUPC&quot;,
  99         &quot;Garamond&quot;,
 100         &quot;Gautami&quot;,
 101         &quot;Georgia&quot;,
 102         &quot;Gulim&quot;,
 103         &quot;Impact&quot;,
 104         &quot;IrisUPC&quot;,
 105         &quot;JasmineUPC&quot;,
 106         &quot;KaiTi_GB2312&quot;,
 107         &quot;KodchiangUPC&quot;,
 108         &quot;Latha&quot;,
 109         &quot;Levenim MT&quot;,
 110         &quot;LilyUPC&quot;,
 111         &quot;Lucida Console&quot;,
 112         &quot;Lucida Sans Unicode&quot;,
 113         &quot;MS Gothic&quot;,
 114         &quot;MS Mincho&quot;,
 115         &quot;MV Boli&quot;,
 116         &quot;Mangal&quot;,
 117         &quot;Marlett&quot;,
 118         &quot;Microsoft Sans Serif&quot;,
 119         &quot;Mingliu&quot;,
 120         &quot;Miriam Fixed&quot;,
 121         &quot;Miriam Transparent&quot;,
 122         &quot;Miriam&quot;,
 123         &quot;Narkisim&quot;,
 124         &quot;Palatino Linotype&quot;,
 125         &quot;Raavi&quot;,
 126         &quot;Rod Transparent&quot;,
 127         &quot;Rod&quot;,
 128         &quot;Shruti&quot;,
 129         &quot;SimHei&quot;,
 130         &quot;Simplified Arabic Fixed&quot;,
 131         &quot;Simplified Arabic&quot;,
 132         &quot;Simsun&quot;,
 133         &quot;Sylfaen&quot;,
 134         &quot;Symbol&quot;,
 135         &quot;Tahoma&quot;,
 136         &quot;Times New Roman&quot;,
 137         &quot;Traditional Arabic&quot;,
 138         &quot;Trebuchet MS&quot;,
 139         &quot;Tunga&quot;,
 140         &quot;Verdana&quot;,
 141         &quot;Webdings&quot;,
 142         &quot;Wingdings&quot;,
 143         &quot;&quot;,
 144       },
 145     },
 146     { &quot;Core MS Legacy Fonts&quot;,
 147       { &quot;Arial Black&quot;,
 148         &quot;Arial Narrow&quot;,
 149         &quot;Arial Unicode MS&quot;,
 150         &quot;Arial&quot;,
 151         &quot;Comic Sans MS&quot;,
 152         &quot;Courier New&quot;,
 153         &quot;Garamond&quot;,
 154         &quot;Georgia&quot;,
 155         &quot;Impact&quot;,
 156         &quot;Lucida Console&quot;,
 157         &quot;Lucida Sans Unicode&quot;,
 158         &quot;Microsoft Sans Serif&quot;,
 159         &quot;Palatino Linotype&quot;,
 160         &quot;Tahoma&quot;,
 161         &quot;Times New Roman&quot;,
 162         &quot;Trebuchet MS&quot;,
 163         &quot;Verdana&quot;,
 164         &quot;&quot;,
 165       },
 166     },
 167     { &quot;Apple Legacy Fonts&quot;,
 168       { &quot;Geneva&quot;,
 169         &quot;Times&quot;,
 170         &quot;Monaco&quot;,
 171         &quot;Century&quot;,
 172         &quot;Chalkboard&quot;,
 173         &quot;Lobster&quot;,
 174         &quot;Century Gothic&quot;,
 175         &quot;Optima&quot;,
 176         &quot;Lucida Grande&quot;,
 177         &quot;Gill Sans&quot;,
 178         &quot;Baskerville&quot;,
 179         &quot;Helvetica&quot;,
 180         &quot;Helvetica Neue&quot;,
 181         &quot;&quot;,
 182       },
 183     },
 184     { &quot;Legacy Sans Fonts&quot;,
 185       { &quot;Andale Mono&quot;,
 186         &quot;Arial Unicode MS&quot;,
 187         &quot;Arial&quot;,
 188         &quot;Century Gothic&quot;,
 189         &quot;Comic Sans MS&quot;,
 190         &quot;Franklin Gothic Medium&quot;,
 191         &quot;Geneva&quot;,
 192         &quot;Lucida Console&quot;,
 193         &quot;Lucida Grande&quot;,
 194         &quot;Lucida Sans Unicode&quot;,
 195         &quot;Lucida Sans Typewriter&quot;,
 196         &quot;Microsoft Sans Serif&quot;,
 197         &quot;Monaco&quot;,
 198         &quot;Tahoma&quot;,
 199         &quot;Trebuchet MS&quot;,
 200         &quot;Verdana&quot;,
 201         &quot;&quot;,
 202       },
 203     },
 204 
 205     { &quot;Misc Legacy Fonts&quot;,
 206       { &quot;Dark Courier&quot;, &quot;&quot;, }, },
 207     { &quot;Verdana Clones&quot;,
 208       { &quot;DejaVu Sans&quot;,
 209         &quot;Bitstream Vera Sans&quot;, &quot;&quot;, }, },
 210     { &quot;Verdana and Clones&quot;,
 211       { &quot;DejaVu Sans&quot;,
 212         &quot;Bitstream Vera Sans&quot;,
 213         &quot;Verdana&quot;, &quot;&quot;, }, },
 214   };
 215 
 216 
 217   /* Define this to force natural (i.e. not bitmap-compatible) widths.     */
 218   /* The default leans strongly towards natural widths except for a few    */
 219   /* legacy fonts where a selective combination produces nicer results.    */
 220 /* #define FORCE_NATURAL_WIDTHS   */
 221 
 222 
 223   /* Define `classes&#39; of styles that can be grouped together and used in   */
 224   /* rules below.  A blank entry &quot;&quot; is required at the end of these!       */
 225 #define STYLE_CLASS_RULES_SIZE  5
 226 
 227   static const SPH_Font_Class  STYLE_CLASS_Rules
 228                                [STYLE_CLASS_RULES_SIZE] =
 229   {
 230     { &quot;Regular Class&quot;,
 231       { &quot;Regular&quot;,
 232         &quot;Book&quot;,
 233         &quot;Medium&quot;,
 234         &quot;Roman&quot;,
 235         &quot;Normal&quot;,
 236         &quot;&quot;,
 237       },
 238     },
 239     { &quot;Regular/Italic Class&quot;,
 240       { &quot;Regular&quot;,
 241         &quot;Book&quot;,
 242         &quot;Medium&quot;,
 243         &quot;Italic&quot;,
 244         &quot;Oblique&quot;,
 245         &quot;Roman&quot;,
 246         &quot;Normal&quot;,
 247         &quot;&quot;,
 248       },
 249     },
 250     { &quot;Bold/BoldItalic Class&quot;,
 251       { &quot;Bold&quot;,
 252         &quot;Bold Italic&quot;,
 253         &quot;Black&quot;,
 254         &quot;&quot;,
 255       },
 256     },
 257     { &quot;Bold/Italic/BoldItalic Class&quot;,
 258       { &quot;Bold&quot;,
 259         &quot;Bold Italic&quot;,
 260         &quot;Black&quot;,
 261         &quot;Italic&quot;,
 262         &quot;Oblique&quot;,
 263         &quot;&quot;,
 264       },
 265     },
 266     { &quot;Regular/Bold Class&quot;,
 267       { &quot;Regular&quot;,
 268         &quot;Book&quot;,
 269         &quot;Medium&quot;,
 270         &quot;Normal&quot;,
 271         &quot;Roman&quot;,
 272         &quot;Bold&quot;,
 273         &quot;Black&quot;,
 274         &quot;&quot;,
 275       },
 276     },
 277   };
 278 
 279 
 280   /* Force special legacy fixes for fonts.                                 */
 281 #define COMPATIBILITY_MODE_RULES_SIZE  1
 282 
 283   static const SPH_TweakRule  COMPATIBILITY_MODE_Rules
 284                               [COMPATIBILITY_MODE_RULES_SIZE] =
 285   {
 286     { &quot;Verdana Clones&quot;, 0, &quot;&quot;, 0 },
 287   };
 288 
 289 
 290   /* Don&#39;t do subpixel (ignore_x_mode) hinting; do normal hinting.         */
 291 #define PIXEL_HINTING_RULES_SIZE  2
 292 
 293   static const SPH_TweakRule  PIXEL_HINTING_Rules
 294                               [PIXEL_HINTING_RULES_SIZE] =
 295   {
 296     /* these characters are almost always safe */
 297     { &quot;Courier New&quot;, 12, &quot;Italic&quot;, &#39;z&#39; },
 298     { &quot;Courier New&quot;, 11, &quot;Italic&quot;, &#39;z&#39; },
 299   };
 300 
 301 
 302   /* Subpixel hinting ignores SHPIX rules on X.  Force SHPIX for these.    */
 303 #define DO_SHPIX_RULES_SIZE  1
 304 
 305   static const SPH_TweakRule  DO_SHPIX_Rules
 306                               [DO_SHPIX_RULES_SIZE] =
 307   {
 308     { &quot;-&quot;, 0, &quot;&quot;, 0 },
 309   };
 310 
 311 
 312   /* Skip Y moves that start with a point that is not on a Y pixel         */
 313   /* boundary and don&#39;t move that point to a Y pixel boundary.             */
 314 #define SKIP_NONPIXEL_Y_MOVES_RULES_SIZE  4
 315 
 316   static const SPH_TweakRule  SKIP_NONPIXEL_Y_MOVES_Rules
 317                               [SKIP_NONPIXEL_Y_MOVES_RULES_SIZE] =
 318   {
 319     /* fix vwxyz thinness*/
 320     { &quot;Consolas&quot;, 0, &quot;&quot;, 0 },
 321     /* Fix thin middle stems */
 322     { &quot;Core MS Legacy Fonts&quot;, 0, &quot;Regular&quot;, 0 },
 323     /* Cyrillic small letter I */
 324     { &quot;Legacy Sans Fonts&quot;, 0, &quot;&quot;, 0 },
 325     /* Fix artifacts with some Regular &amp; Bold */
 326     { &quot;Verdana Clones&quot;, 0, &quot;&quot;, 0 },
 327   };
 328 
 329 
 330 #define SKIP_NONPIXEL_Y_MOVES_RULES_EXCEPTIONS_SIZE  1
 331 
 332   static const SPH_TweakRule  SKIP_NONPIXEL_Y_MOVES_Rules_Exceptions
 333                               [SKIP_NONPIXEL_Y_MOVES_RULES_EXCEPTIONS_SIZE] =
 334   {
 335     /* Fixes &lt; and &gt; */
 336     { &quot;Courier New&quot;, 0, &quot;Regular&quot;, 0 },
 337   };
 338 
 339 
 340   /* Skip Y moves that start with a point that is not on a Y pixel         */
 341   /* boundary and don&#39;t move that point to a Y pixel boundary.             */
 342 #define SKIP_NONPIXEL_Y_MOVES_DELTAP_RULES_SIZE  2
 343 
 344   static const SPH_TweakRule  SKIP_NONPIXEL_Y_MOVES_DELTAP_Rules
 345                               [SKIP_NONPIXEL_Y_MOVES_DELTAP_RULES_SIZE] =
 346   {
 347     /* Maintain thickness of diagonal in &#39;N&#39; */
 348     { &quot;Times New Roman&quot;, 0, &quot;Regular/Bold Class&quot;, &#39;N&#39; },
 349     { &quot;Georgia&quot;, 0, &quot;Regular/Bold Class&quot;, &#39;N&#39; },
 350   };
 351 
 352 
 353   /* Skip Y moves that move a point off a Y pixel boundary.                */
 354 #define SKIP_OFFPIXEL_Y_MOVES_RULES_SIZE  1
 355 
 356   static const SPH_TweakRule  SKIP_OFFPIXEL_Y_MOVES_Rules
 357                               [SKIP_OFFPIXEL_Y_MOVES_RULES_SIZE] =
 358   {
 359     { &quot;-&quot;, 0, &quot;&quot;, 0 },
 360   };
 361 
 362 
 363 #define SKIP_OFFPIXEL_Y_MOVES_RULES_EXCEPTIONS_SIZE  1
 364 
 365   static const SPH_TweakRule  SKIP_OFFPIXEL_Y_MOVES_Rules_Exceptions
 366                               [SKIP_OFFPIXEL_Y_MOVES_RULES_EXCEPTIONS_SIZE] =
 367   {
 368     { &quot;-&quot;, 0, &quot;&quot;, 0 },
 369   };
 370 
 371 
 372   /* Round moves that don&#39;t move a point to a Y pixel boundary.            */
 373 #define ROUND_NONPIXEL_Y_MOVES_RULES_SIZE  2
 374 
 375   static const SPH_TweakRule  ROUND_NONPIXEL_Y_MOVES_Rules
 376                               [ROUND_NONPIXEL_Y_MOVES_RULES_SIZE] =
 377   {
 378     /* Droid font instructions don&#39;t snap Y to pixels */
 379     { &quot;Droid Sans&quot;, 0, &quot;Regular/Italic Class&quot;, 0 },
 380     { &quot;Droid Sans Mono&quot;, 0, &quot;&quot;, 0 },
 381   };
 382 
 383 
 384 #define ROUND_NONPIXEL_Y_MOVES_RULES_EXCEPTIONS_SIZE  1
 385 
 386   static const SPH_TweakRule  ROUND_NONPIXEL_Y_MOVES_Rules_Exceptions
 387                               [ROUND_NONPIXEL_Y_MOVES_RULES_EXCEPTIONS_SIZE] =
 388   {
 389     { &quot;-&quot;, 0, &quot;&quot;, 0 },
 390   };
 391 
 392 
 393   /* Allow a Direct_Move along X freedom vector if matched.                */
 394 #define ALLOW_X_DMOVE_RULES_SIZE  1
 395 
 396   static const SPH_TweakRule  ALLOW_X_DMOVE_Rules
 397                               [ALLOW_X_DMOVE_RULES_SIZE] =
 398   {
 399     /* Fixes vanishing diagonal in 4 */
 400     { &quot;Verdana&quot;, 0, &quot;Regular&quot;, &#39;4&#39; },
 401   };
 402 
 403 
 404   /* Return MS rasterizer version 35 if matched.                           */
 405 #define RASTERIZER_35_RULES_SIZE  8
 406 
 407   static const SPH_TweakRule  RASTERIZER_35_Rules
 408                               [RASTERIZER_35_RULES_SIZE] =
 409   {
 410     /* This seems to be the only way to make these look good */
 411     { &quot;Times New Roman&quot;, 0, &quot;Regular&quot;, &#39;i&#39; },
 412     { &quot;Times New Roman&quot;, 0, &quot;Regular&quot;, &#39;j&#39; },
 413     { &quot;Times New Roman&quot;, 0, &quot;Regular&quot;, &#39;m&#39; },
 414     { &quot;Times New Roman&quot;, 0, &quot;Regular&quot;, &#39;r&#39; },
 415     { &quot;Times New Roman&quot;, 0, &quot;Regular&quot;, &#39;a&#39; },
 416     { &quot;Times New Roman&quot;, 0, &quot;Regular&quot;, &#39;n&#39; },
 417     { &quot;Times New Roman&quot;, 0, &quot;Regular&quot;, &#39;p&#39; },
 418     { &quot;Times&quot;, 0, &quot;&quot;, 0 },
 419   };
 420 
 421 
 422   /* Don&#39;t round to the subpixel grid.  Round to pixel grid.               */
 423 #define NORMAL_ROUND_RULES_SIZE  1
 424 
 425   static const SPH_TweakRule  NORMAL_ROUND_Rules
 426                               [NORMAL_ROUND_RULES_SIZE] =
 427   {
 428     /* Fix serif thickness for certain ppems */
 429     /* Can probably be generalized somehow   */
 430     { &quot;Courier New&quot;, 0, &quot;&quot;, 0 },
 431   };
 432 
 433 
 434   /* Skip IUP instructions if matched.                                     */
 435 #define SKIP_IUP_RULES_SIZE  1
 436 
 437   static const SPH_TweakRule  SKIP_IUP_Rules
 438                               [SKIP_IUP_RULES_SIZE] =
 439   {
 440     { &quot;Arial&quot;, 13, &quot;Regular&quot;, &#39;a&#39; },
 441   };
 442 
 443 
 444   /* Skip MIAP Twilight hack if matched.                                   */
 445 #define MIAP_HACK_RULES_SIZE  1
 446 
 447   static const SPH_TweakRule  MIAP_HACK_Rules
 448                               [MIAP_HACK_RULES_SIZE] =
 449   {
 450     { &quot;Geneva&quot;, 12, &quot;&quot;, 0 },
 451   };
 452 
 453 
 454   /* Skip DELTAP instructions if matched.                                  */
 455 #define ALWAYS_SKIP_DELTAP_RULES_SIZE  23
 456 
 457   static const SPH_TweakRule  ALWAYS_SKIP_DELTAP_Rules
 458                               [ALWAYS_SKIP_DELTAP_RULES_SIZE] =
 459   {
 460     { &quot;Georgia&quot;, 0, &quot;Regular&quot;, &#39;k&#39; },
 461     /* fix various problems with e in different versions */
 462     { &quot;Trebuchet MS&quot;, 14, &quot;Regular&quot;, &#39;e&#39; },
 463     { &quot;Trebuchet MS&quot;, 13, &quot;Regular&quot;, &#39;e&#39; },
 464     { &quot;Trebuchet MS&quot;, 15, &quot;Regular&quot;, &#39;e&#39; },
 465     { &quot;Trebuchet MS&quot;, 0, &quot;Italic&quot;, &#39;v&#39; },
 466     { &quot;Trebuchet MS&quot;, 0, &quot;Italic&quot;, &#39;w&#39; },
 467     { &quot;Trebuchet MS&quot;, 0, &quot;Regular&quot;, &#39;Y&#39; },
 468     { &quot;Arial&quot;, 11, &quot;Regular&quot;, &#39;s&#39; },
 469     /* prevent problems with &#39;3&#39; and others */
 470     { &quot;Verdana&quot;, 10, &quot;Regular&quot;, 0 },
 471     { &quot;Verdana&quot;, 9, &quot;Regular&quot;, 0 },
 472     /* Cyrillic small letter short I */
 473     { &quot;Legacy Sans Fonts&quot;, 0, &quot;&quot;, 0x438 },
 474     { &quot;Legacy Sans Fonts&quot;, 0, &quot;&quot;, 0x439 },
 475     { &quot;Arial&quot;, 10, &quot;Regular&quot;, &#39;6&#39; },
 476     { &quot;Arial&quot;, 0, &quot;Bold/BoldItalic Class&quot;, &#39;a&#39; },
 477     /* Make horizontal stems consistent with the rest */
 478     { &quot;Arial&quot;, 24, &quot;Bold&quot;, &#39;a&#39; },
 479     { &quot;Arial&quot;, 25, &quot;Bold&quot;, &#39;a&#39; },
 480     { &quot;Arial&quot;, 24, &quot;Bold&quot;, &#39;s&#39; },
 481     { &quot;Arial&quot;, 25, &quot;Bold&quot;, &#39;s&#39; },
 482     { &quot;Arial&quot;, 34, &quot;Bold&quot;, &#39;s&#39; },
 483     { &quot;Arial&quot;, 35, &quot;Bold&quot;, &#39;s&#39; },
 484     { &quot;Arial&quot;, 36, &quot;Bold&quot;, &#39;s&#39; },
 485     { &quot;Arial&quot;, 25, &quot;Regular&quot;, &#39;s&#39; },
 486     { &quot;Arial&quot;, 26, &quot;Regular&quot;, &#39;s&#39; },
 487   };
 488 
 489 
 490   /* Always do DELTAP instructions if matched.                             */
 491 #define ALWAYS_DO_DELTAP_RULES_SIZE  1
 492 
 493   static const SPH_TweakRule  ALWAYS_DO_DELTAP_Rules
 494                               [ALWAYS_DO_DELTAP_RULES_SIZE] =
 495   {
 496     { &quot;-&quot;, 0, &quot;&quot;, 0 },
 497   };
 498 
 499 
 500   /* Don&#39;t allow ALIGNRP after IUP.                                        */
 501 #define NO_ALIGNRP_AFTER_IUP_RULES_SIZE  1
 502 
 503   static const SPH_TweakRule  NO_ALIGNRP_AFTER_IUP_Rules
 504                               [NO_ALIGNRP_AFTER_IUP_RULES_SIZE] =
 505   {
 506     /* Prevent creation of dents in outline */
 507     { &quot;-&quot;, 0, &quot;&quot;, 0 },
 508   };
 509 
 510 
 511   /* Don&#39;t allow DELTAP after IUP.                                         */
 512 #define NO_DELTAP_AFTER_IUP_RULES_SIZE  1
 513 
 514   static const SPH_TweakRule  NO_DELTAP_AFTER_IUP_Rules
 515                               [NO_DELTAP_AFTER_IUP_RULES_SIZE] =
 516   {
 517     { &quot;-&quot;, 0, &quot;&quot;, 0 },
 518   };
 519 
 520 
 521   /* Don&#39;t allow CALL after IUP.                                           */
 522 #define NO_CALL_AFTER_IUP_RULES_SIZE  1
 523 
 524   static const SPH_TweakRule  NO_CALL_AFTER_IUP_Rules
 525                               [NO_CALL_AFTER_IUP_RULES_SIZE] =
 526   {
 527     /* Prevent creation of dents in outline */
 528     { &quot;-&quot;, 0, &quot;&quot;, 0 },
 529   };
 530 
 531 
 532   /* De-embolden these glyphs slightly.                                    */
 533 #define DEEMBOLDEN_RULES_SIZE  9
 534 
 535   static const SPH_TweakRule  DEEMBOLDEN_Rules
 536                               [DEEMBOLDEN_RULES_SIZE] =
 537   {
 538     { &quot;Courier New&quot;, 0, &quot;Bold&quot;, &#39;A&#39; },
 539     { &quot;Courier New&quot;, 0, &quot;Bold&quot;, &#39;W&#39; },
 540     { &quot;Courier New&quot;, 0, &quot;Bold&quot;, &#39;w&#39; },
 541     { &quot;Courier New&quot;, 0, &quot;Bold&quot;, &#39;M&#39; },
 542     { &quot;Courier New&quot;, 0, &quot;Bold&quot;, &#39;X&#39; },
 543     { &quot;Courier New&quot;, 0, &quot;Bold&quot;, &#39;K&#39; },
 544     { &quot;Courier New&quot;, 0, &quot;Bold&quot;, &#39;x&#39; },
 545     { &quot;Courier New&quot;, 0, &quot;Bold&quot;, &#39;z&#39; },
 546     { &quot;Courier New&quot;, 0, &quot;Bold&quot;, &#39;v&#39; },
 547   };
 548 
 549 
 550   /* Embolden these glyphs slightly.                                       */
 551 #define EMBOLDEN_RULES_SIZE  2
 552 
 553   static const SPH_TweakRule  EMBOLDEN_Rules
 554                               [EMBOLDEN_RULES_SIZE] =
 555   {
 556     { &quot;Courier New&quot;, 0, &quot;Regular&quot;, 0 },
 557     { &quot;Courier New&quot;, 0, &quot;Italic&quot;, 0 },
 558   };
 559 
 560 
 561   /* This is a CVT hack that makes thick horizontal stems on 2, 5, 7       */
 562   /* similar to Windows XP.                                                */
 563 #define TIMES_NEW_ROMAN_HACK_RULES_SIZE  12
 564 
 565   static const SPH_TweakRule  TIMES_NEW_ROMAN_HACK_Rules
 566                               [TIMES_NEW_ROMAN_HACK_RULES_SIZE] =
 567   {
 568     { &quot;Times New Roman&quot;, 16, &quot;Italic&quot;, &#39;2&#39; },
 569     { &quot;Times New Roman&quot;, 16, &quot;Italic&quot;, &#39;5&#39; },
 570     { &quot;Times New Roman&quot;, 16, &quot;Italic&quot;, &#39;7&#39; },
 571     { &quot;Times New Roman&quot;, 16, &quot;Regular&quot;, &#39;2&#39; },
 572     { &quot;Times New Roman&quot;, 16, &quot;Regular&quot;, &#39;5&#39; },
 573     { &quot;Times New Roman&quot;, 16, &quot;Regular&quot;, &#39;7&#39; },
 574     { &quot;Times New Roman&quot;, 17, &quot;Italic&quot;, &#39;2&#39; },
 575     { &quot;Times New Roman&quot;, 17, &quot;Italic&quot;, &#39;5&#39; },
 576     { &quot;Times New Roman&quot;, 17, &quot;Italic&quot;, &#39;7&#39; },
 577     { &quot;Times New Roman&quot;, 17, &quot;Regular&quot;, &#39;2&#39; },
 578     { &quot;Times New Roman&quot;, 17, &quot;Regular&quot;, &#39;5&#39; },
 579     { &quot;Times New Roman&quot;, 17, &quot;Regular&quot;, &#39;7&#39; },
 580   };
 581 
 582 
 583   /* This fudges distance on 2 to get rid of the vanishing stem issue.     */
 584   /* A real solution to this is certainly welcome.                         */
 585 #define COURIER_NEW_2_HACK_RULES_SIZE  15
 586 
 587   static const SPH_TweakRule  COURIER_NEW_2_HACK_Rules
 588                               [COURIER_NEW_2_HACK_RULES_SIZE] =
 589   {
 590     { &quot;Courier New&quot;, 10, &quot;Regular&quot;, &#39;2&#39; },
 591     { &quot;Courier New&quot;, 11, &quot;Regular&quot;, &#39;2&#39; },
 592     { &quot;Courier New&quot;, 12, &quot;Regular&quot;, &#39;2&#39; },
 593     { &quot;Courier New&quot;, 13, &quot;Regular&quot;, &#39;2&#39; },
 594     { &quot;Courier New&quot;, 14, &quot;Regular&quot;, &#39;2&#39; },
 595     { &quot;Courier New&quot;, 15, &quot;Regular&quot;, &#39;2&#39; },
 596     { &quot;Courier New&quot;, 16, &quot;Regular&quot;, &#39;2&#39; },
 597     { &quot;Courier New&quot;, 17, &quot;Regular&quot;, &#39;2&#39; },
 598     { &quot;Courier New&quot;, 18, &quot;Regular&quot;, &#39;2&#39; },
 599     { &quot;Courier New&quot;, 19, &quot;Regular&quot;, &#39;2&#39; },
 600     { &quot;Courier New&quot;, 20, &quot;Regular&quot;, &#39;2&#39; },
 601     { &quot;Courier New&quot;, 21, &quot;Regular&quot;, &#39;2&#39; },
 602     { &quot;Courier New&quot;, 22, &quot;Regular&quot;, &#39;2&#39; },
 603     { &quot;Courier New&quot;, 23, &quot;Regular&quot;, &#39;2&#39; },
 604     { &quot;Courier New&quot;, 24, &quot;Regular&quot;, &#39;2&#39; },
 605   };
 606 
 607 
 608 #ifndef FORCE_NATURAL_WIDTHS
 609 
 610   /* Use compatible widths with these glyphs.  Compatible widths is always */
 611   /* on when doing B/W TrueType instructing, but is used selectively here, */
 612   /* typically on glyphs with 3 or more vertical stems.                    */
 613 #define COMPATIBLE_WIDTHS_RULES_SIZE  38
 614 
 615   static const SPH_TweakRule  COMPATIBLE_WIDTHS_Rules
 616                               [COMPATIBLE_WIDTHS_RULES_SIZE] =
 617   {
 618     { &quot;Arial Unicode MS&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39; },
 619     { &quot;Arial Unicode MS&quot;, 14, &quot;Regular Class&quot;, &#39;m&#39; },
 620     /* Cyrillic small letter sha */
 621     { &quot;Arial&quot;, 10, &quot;Regular Class&quot;, 0x448 },
 622     { &quot;Arial&quot;, 11, &quot;Regular Class&quot;, &#39;m&#39; },
 623     { &quot;Arial&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39; },
 624     /* Cyrillic small letter sha */
 625     { &quot;Arial&quot;, 12, &quot;Regular Class&quot;, 0x448 },
 626     { &quot;Arial&quot;, 13, &quot;Regular Class&quot;, 0x448 },
 627     { &quot;Arial&quot;, 14, &quot;Regular Class&quot;, &#39;m&#39; },
 628     /* Cyrillic small letter sha */
 629     { &quot;Arial&quot;, 14, &quot;Regular Class&quot;, 0x448 },
 630     { &quot;Arial&quot;, 15, &quot;Regular Class&quot;, 0x448 },
 631     { &quot;Arial&quot;, 17, &quot;Regular Class&quot;, &#39;m&#39; },
 632     { &quot;DejaVu Sans&quot;, 15, &quot;Regular Class&quot;, 0 },
 633     { &quot;Microsoft Sans Serif&quot;, 11, &quot;Regular Class&quot;, 0 },
 634     { &quot;Microsoft Sans Serif&quot;, 12, &quot;Regular Class&quot;, 0 },
 635     { &quot;Segoe UI&quot;, 11, &quot;Regular Class&quot;, 0 },
 636     { &quot;Monaco&quot;, 0, &quot;Regular Class&quot;, 0 },
 637     { &quot;Segoe UI&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39; },
 638     { &quot;Segoe UI&quot;, 14, &quot;Regular Class&quot;, &#39;m&#39; },
 639     { &quot;Tahoma&quot;, 11, &quot;Regular Class&quot;, 0 },
 640     { &quot;Times New Roman&quot;, 16, &quot;Regular Class&quot;, &#39;c&#39; },
 641     { &quot;Times New Roman&quot;, 16, &quot;Regular Class&quot;, &#39;m&#39; },
 642     { &quot;Times New Roman&quot;, 16, &quot;Regular Class&quot;, &#39;o&#39; },
 643     { &quot;Times New Roman&quot;, 16, &quot;Regular Class&quot;, &#39;w&#39; },
 644     { &quot;Trebuchet MS&quot;, 11, &quot;Regular Class&quot;, 0 },
 645     { &quot;Trebuchet MS&quot;, 12, &quot;Regular Class&quot;, 0 },
 646     { &quot;Trebuchet MS&quot;, 14, &quot;Regular Class&quot;, 0 },
 647     { &quot;Trebuchet MS&quot;, 15, &quot;Regular Class&quot;, 0 },
 648     { &quot;Ubuntu&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39; },
 649     /* Cyrillic small letter sha */
 650     { &quot;Verdana&quot;, 10, &quot;Regular Class&quot;, 0x448 },
 651     { &quot;Verdana&quot;, 11, &quot;Regular Class&quot;, 0x448 },
 652     { &quot;Verdana and Clones&quot;, 12, &quot;Regular Class&quot;, &#39;i&#39; },
 653     { &quot;Verdana and Clones&quot;, 12, &quot;Regular Class&quot;, &#39;j&#39; },
 654     { &quot;Verdana and Clones&quot;, 12, &quot;Regular Class&quot;, &#39;l&#39; },
 655     { &quot;Verdana and Clones&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39; },
 656     { &quot;Verdana and Clones&quot;, 13, &quot;Regular Class&quot;, &#39;i&#39; },
 657     { &quot;Verdana and Clones&quot;, 13, &quot;Regular Class&quot;, &#39;j&#39; },
 658     { &quot;Verdana and Clones&quot;, 13, &quot;Regular Class&quot;, &#39;l&#39; },
 659     { &quot;Verdana and Clones&quot;, 14, &quot;Regular Class&quot;, &#39;m&#39; },
 660   };
 661 
 662 
 663   /* Scaling slightly in the x-direction prior to hinting results in       */
 664   /* more visually pleasing glyphs in certain cases.                       */
 665   /* This sometimes needs to be coordinated with compatible width rules.   */
 666   /* A value of 1000 corresponds to a scaled value of 1.0.                 */
 667 
 668 #define X_SCALING_RULES_SIZE  50
 669 
 670   static const SPH_ScaleRule  X_SCALING_Rules[X_SCALING_RULES_SIZE] =
 671   {
 672     { &quot;DejaVu Sans&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39;, 950 },
 673     { &quot;Verdana and Clones&quot;, 12, &quot;Regular Class&quot;, &#39;a&#39;, 1100 },
 674     { &quot;Verdana and Clones&quot;, 13, &quot;Regular Class&quot;, &#39;a&#39;, 1050 },
 675     { &quot;Arial&quot;, 11, &quot;Regular Class&quot;, &#39;m&#39;, 975 },
 676     { &quot;Arial&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39;, 1050 },
 677     /* Cyrillic small letter el */
 678     { &quot;Arial&quot;, 13, &quot;Regular Class&quot;, 0x43B, 950 },
 679     { &quot;Arial&quot;, 13, &quot;Regular Class&quot;, &#39;o&#39;, 950 },
 680     { &quot;Arial&quot;, 13, &quot;Regular Class&quot;, &#39;e&#39;, 950 },
 681     { &quot;Arial&quot;, 14, &quot;Regular Class&quot;, &#39;m&#39;, 950 },
 682     /* Cyrillic small letter el */
 683     { &quot;Arial&quot;, 15, &quot;Regular Class&quot;, 0x43B, 925 },
 684     { &quot;Bitstream Vera Sans&quot;, 10, &quot;Regular/Italic Class&quot;, 0, 1100 },
 685     { &quot;Bitstream Vera Sans&quot;, 12, &quot;Regular/Italic Class&quot;, 0, 1050 },
 686     { &quot;Bitstream Vera Sans&quot;, 16, &quot;Regular Class&quot;, 0, 1050 },
 687     { &quot;Bitstream Vera Sans&quot;, 9, &quot;Regular/Italic Class&quot;, 0, 1050 },
 688     { &quot;DejaVu Sans&quot;, 12, &quot;Regular Class&quot;, &#39;l&#39;, 975 },
 689     { &quot;DejaVu Sans&quot;, 12, &quot;Regular Class&quot;, &#39;i&#39;, 975 },
 690     { &quot;DejaVu Sans&quot;, 12, &quot;Regular Class&quot;, &#39;j&#39;, 975 },
 691     { &quot;DejaVu Sans&quot;, 13, &quot;Regular Class&quot;, &#39;l&#39;, 950 },
 692     { &quot;DejaVu Sans&quot;, 13, &quot;Regular Class&quot;, &#39;i&#39;, 950 },
 693     { &quot;DejaVu Sans&quot;, 13, &quot;Regular Class&quot;, &#39;j&#39;, 950 },
 694     { &quot;DejaVu Sans&quot;, 10, &quot;Regular/Italic Class&quot;, 0, 1100 },
 695     { &quot;DejaVu Sans&quot;, 12, &quot;Regular/Italic Class&quot;, 0, 1050 },
 696     { &quot;Georgia&quot;, 10, &quot;&quot;, 0, 1050 },
 697     { &quot;Georgia&quot;, 11, &quot;&quot;, 0, 1100 },
 698     { &quot;Georgia&quot;, 12, &quot;&quot;, 0, 1025 },
 699     { &quot;Georgia&quot;, 13, &quot;&quot;, 0, 1050 },
 700     { &quot;Georgia&quot;, 16, &quot;&quot;, 0, 1050 },
 701     { &quot;Georgia&quot;, 17, &quot;&quot;, 0, 1030 },
 702     { &quot;Liberation Sans&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39;, 1100 },
 703     { &quot;Lucida Grande&quot;, 11, &quot;Regular Class&quot;, &#39;m&#39;, 1100 },
 704     { &quot;Microsoft Sans Serif&quot;, 11, &quot;Regular Class&quot;, &#39;m&#39;, 950 },
 705     { &quot;Microsoft Sans Serif&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39;, 1050 },
 706     { &quot;Segoe UI&quot;, 12, &quot;Regular Class&quot;, &#39;H&#39;, 1050 },
 707     { &quot;Segoe UI&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39;, 1050 },
 708     { &quot;Segoe UI&quot;, 14, &quot;Regular Class&quot;, &#39;m&#39;, 1050 },
 709     { &quot;Tahoma&quot;, 11, &quot;Regular Class&quot;, &#39;i&#39;, 975 },
 710     { &quot;Tahoma&quot;, 11, &quot;Regular Class&quot;, &#39;l&#39;, 975 },
 711     { &quot;Tahoma&quot;, 11, &quot;Regular Class&quot;, &#39;j&#39;, 900 },
 712     { &quot;Tahoma&quot;, 11, &quot;Regular Class&quot;, &#39;m&#39;, 918 },
 713     { &quot;Verdana&quot;, 10, &quot;Regular/Italic Class&quot;, 0, 1100 },
 714     { &quot;Verdana&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39;, 975 },
 715     { &quot;Verdana&quot;, 12, &quot;Regular/Italic Class&quot;, 0, 1050 },
 716     { &quot;Verdana&quot;, 13, &quot;Regular/Italic Class&quot;, &#39;i&#39;, 950 },
 717     { &quot;Verdana&quot;, 13, &quot;Regular/Italic Class&quot;, &#39;j&#39;, 950 },
 718     { &quot;Verdana&quot;, 13, &quot;Regular/Italic Class&quot;, &#39;l&#39;, 950 },
 719     { &quot;Verdana&quot;, 16, &quot;Regular Class&quot;, 0, 1050 },
 720     { &quot;Verdana&quot;, 9, &quot;Regular/Italic Class&quot;, 0, 1050 },
 721     { &quot;Times New Roman&quot;, 16, &quot;Regular Class&quot;, &#39;m&#39;, 918 },
 722     { &quot;Trebuchet MS&quot;, 11, &quot;Regular Class&quot;, &#39;m&#39;, 800 },
 723     { &quot;Trebuchet MS&quot;, 12, &quot;Regular Class&quot;, &#39;m&#39;, 800 },
 724   };
 725 
 726 #else
 727 
 728 #define COMPATIBLE_WIDTHS_RULES_SIZE  1
 729 
 730   static const SPH_TweakRule  COMPATIBLE_WIDTHS_Rules
 731                               [COMPATIBLE_WIDTHS_RULES_SIZE] =
 732   {
 733     { &quot;-&quot;, 0, &quot;&quot;, 0 },
 734   };
 735 
 736 
 737 #define X_SCALING_RULES_SIZE  1
 738 
 739   static const SPH_ScaleRule  X_SCALING_Rules
 740                               [X_SCALING_RULES_SIZE] =
 741   {
 742     { &quot;-&quot;, 0, &quot;&quot;, 0, 1000 },
 743   };
 744 
 745 #endif /* FORCE_NATURAL_WIDTHS */
 746 
 747 
 748   static FT_Bool
 749   is_member_of_family_class( const FT_String*  detected_font_name,
 750                              const FT_String*  rule_font_name )
 751   {
 752     FT_UInt  i, j;
 753 
 754 
 755     /* Does font name match rule family? */
 756     if ( ft_strcmp( detected_font_name, rule_font_name ) == 0 )
 757       return TRUE;
 758 
 759     /* Is font name a wildcard &quot;&quot;? */
 760     if ( ft_strcmp( rule_font_name, &quot;&quot; ) == 0 )
 761       return TRUE;
 762 
 763     /* Is font name contained in a class list? */
 764     for ( i = 0; i &lt; FAMILY_CLASS_RULES_SIZE; i++ )
 765     {
 766       if ( ft_strcmp( FAMILY_CLASS_Rules[i].name, rule_font_name ) == 0 )
 767       {
 768         for ( j = 0; j &lt; SPH_MAX_CLASS_MEMBERS; j++ )
 769         {
 770           if ( ft_strcmp( FAMILY_CLASS_Rules[i].member[j], &quot;&quot; ) == 0 )
 771             continue;
 772           if ( ft_strcmp( FAMILY_CLASS_Rules[i].member[j],
 773                           detected_font_name ) == 0 )
 774             return TRUE;
 775         }
 776       }
 777     }
 778 
 779     return FALSE;
 780   }
 781 
 782 
 783   static FT_Bool
 784   is_member_of_style_class( const FT_String*  detected_font_style,
 785                             const FT_String*  rule_font_style )
 786   {
 787     FT_UInt  i, j;
 788 
 789 
 790     /* Does font style match rule style? */
 791     if ( ft_strcmp( detected_font_style, rule_font_style ) == 0 )
 792       return TRUE;
 793 
 794     /* Is font style a wildcard &quot;&quot;? */
 795     if ( ft_strcmp( rule_font_style, &quot;&quot; ) == 0 )
 796       return TRUE;
 797 
 798     /* Is font style contained in a class list? */
 799     for ( i = 0; i &lt; STYLE_CLASS_RULES_SIZE; i++ )
 800     {
 801       if ( ft_strcmp( STYLE_CLASS_Rules[i].name, rule_font_style ) == 0 )
 802       {
 803         for ( j = 0; j &lt; SPH_MAX_CLASS_MEMBERS; j++ )
 804         {
 805           if ( ft_strcmp( STYLE_CLASS_Rules[i].member[j], &quot;&quot; ) == 0 )
 806             continue;
 807           if ( ft_strcmp( STYLE_CLASS_Rules[i].member[j],
 808                           detected_font_style ) == 0 )
 809             return TRUE;
 810         }
 811       }
 812     }
 813 
 814     return FALSE;
 815   }
 816 
 817 
 818   FT_LOCAL_DEF( FT_Bool )
 819   sph_test_tweak( TT_Face               face,
 820                   const FT_String*      family,
 821                   FT_UInt               ppem,
 822                   const FT_String*      style,
 823                   FT_UInt               glyph_index,
 824                   const SPH_TweakRule*  rule,
 825                   FT_UInt               num_rules )
 826   {
 827     FT_UInt  i;
 828 
 829 
 830     /* rule checks may be able to be optimized further */
 831     for ( i = 0; i &lt; num_rules; i++ )
 832     {
 833       if ( family                                                   &amp;&amp;
 834            ( is_member_of_family_class ( family, rule[i].family ) ) )
 835         if ( rule[i].ppem == 0    ||
 836              rule[i].ppem == ppem )
 837           if ( style                                             &amp;&amp;
 838                is_member_of_style_class ( style, rule[i].style ) )
 839             if ( rule[i].glyph == 0                                ||
 840                  FT_Get_Char_Index( (FT_Face)face,
 841                                     rule[i].glyph ) == glyph_index )
 842         return TRUE;
 843     }
 844 
 845     return FALSE;
 846   }
 847 
 848 
 849   static FT_UInt
 850   scale_test_tweak( TT_Face               face,
 851                     const FT_String*      family,
 852                     FT_UInt               ppem,
 853                     const FT_String*      style,
 854                     FT_UInt               glyph_index,
 855                     const SPH_ScaleRule*  rule,
 856                     FT_UInt               num_rules )
 857   {
 858     FT_UInt  i;
 859 
 860 
 861     /* rule checks may be able to be optimized further */
 862     for ( i = 0; i &lt; num_rules; i++ )
 863     {
 864       if ( family                                                   &amp;&amp;
 865            ( is_member_of_family_class ( family, rule[i].family ) ) )
 866         if ( rule[i].ppem == 0    ||
 867              rule[i].ppem == ppem )
 868           if ( style                                            &amp;&amp;
 869                is_member_of_style_class( style, rule[i].style ) )
 870             if ( rule[i].glyph == 0                                ||
 871                  FT_Get_Char_Index( (FT_Face)face,
 872                                     rule[i].glyph ) == glyph_index )
 873         return rule[i].scale;
 874     }
 875 
 876     return 1000;
 877   }
 878 
 879 
 880   FT_LOCAL_DEF( FT_UInt )
 881   sph_test_tweak_x_scaling( TT_Face           face,
 882                             const FT_String*  family,
 883                             FT_UInt           ppem,
 884                             const FT_String*  style,
 885                             FT_UInt           glyph_index )
 886   {
 887     return scale_test_tweak( face, family, ppem, style, glyph_index,
 888                              X_SCALING_Rules, X_SCALING_RULES_SIZE );
 889   }
 890 
 891 
 892 #define TWEAK_RULES( x )                                       \
 893   if ( sph_test_tweak( face, family, ppem, style, glyph_index, \
 894                        x##_Rules, x##_RULES_SIZE ) )           \
 895     loader-&gt;exec-&gt;sph_tweak_flags |= SPH_TWEAK_##x;
 896 
 897 #define TWEAK_RULES_EXCEPTIONS( x )                                        \
 898   if ( sph_test_tweak( face, family, ppem, style, glyph_index,             \
 899                        x##_Rules_Exceptions, x##_RULES_EXCEPTIONS_SIZE ) ) \
 900     loader-&gt;exec-&gt;sph_tweak_flags &amp;= ~SPH_TWEAK_##x;
 901 
 902 
 903   FT_LOCAL_DEF( void )
 904   sph_set_tweaks( TT_Loader  loader,
 905                   FT_UInt    glyph_index )
 906   {
 907     TT_Face     face   = loader-&gt;face;
 908     FT_String*  family = face-&gt;root.family_name;
 909     FT_UInt     ppem   = loader-&gt;size-&gt;metrics-&gt;x_ppem;
 910     FT_String*  style  = face-&gt;root.style_name;
 911 
 912 
 913     /* don&#39;t apply rules if style isn&#39;t set */
 914     if ( !face-&gt;root.style_name )
 915       return;
 916 
 917 #ifdef SPH_DEBUG_MORE_VERBOSE
 918     printf( &quot;%s,%d,%s,%c=%d &quot;,
 919             family, ppem, style, glyph_index, glyph_index );
 920 #endif
 921 
 922     TWEAK_RULES( PIXEL_HINTING );
 923 
 924     if ( loader-&gt;exec-&gt;sph_tweak_flags &amp; SPH_TWEAK_PIXEL_HINTING )
 925     {
 926       loader-&gt;exec-&gt;ignore_x_mode = FALSE;
 927       return;
 928     }
 929 
 930     TWEAK_RULES( ALLOW_X_DMOVE );
 931     TWEAK_RULES( ALWAYS_DO_DELTAP );
 932     TWEAK_RULES( ALWAYS_SKIP_DELTAP );
 933     TWEAK_RULES( DEEMBOLDEN );
 934     TWEAK_RULES( DO_SHPIX );
 935     TWEAK_RULES( EMBOLDEN );
 936     TWEAK_RULES( MIAP_HACK );
 937     TWEAK_RULES( NORMAL_ROUND );
 938     TWEAK_RULES( NO_ALIGNRP_AFTER_IUP );
 939     TWEAK_RULES( NO_CALL_AFTER_IUP );
 940     TWEAK_RULES( NO_DELTAP_AFTER_IUP );
 941     TWEAK_RULES( RASTERIZER_35 );
 942     TWEAK_RULES( SKIP_IUP );
 943 
 944     TWEAK_RULES( SKIP_OFFPIXEL_Y_MOVES );
 945     TWEAK_RULES_EXCEPTIONS( SKIP_OFFPIXEL_Y_MOVES );
 946 
 947     TWEAK_RULES( SKIP_NONPIXEL_Y_MOVES_DELTAP );
 948 
 949     TWEAK_RULES( SKIP_NONPIXEL_Y_MOVES );
 950     TWEAK_RULES_EXCEPTIONS( SKIP_NONPIXEL_Y_MOVES );
 951 
 952     TWEAK_RULES( ROUND_NONPIXEL_Y_MOVES );
 953     TWEAK_RULES_EXCEPTIONS( ROUND_NONPIXEL_Y_MOVES );
 954 
 955     if ( loader-&gt;exec-&gt;sph_tweak_flags &amp; SPH_TWEAK_RASTERIZER_35 )
 956     {
 957       if ( loader-&gt;exec-&gt;rasterizer_version != TT_INTERPRETER_VERSION_35 )
 958       {
 959         loader-&gt;exec-&gt;rasterizer_version = TT_INTERPRETER_VERSION_35;
 960         loader-&gt;exec-&gt;size-&gt;cvt_ready    = -1;
 961 
 962         tt_size_ready_bytecode(
 963           loader-&gt;exec-&gt;size,
 964           FT_BOOL( loader-&gt;load_flags &amp; FT_LOAD_PEDANTIC ) );
 965       }
 966       else
 967         loader-&gt;exec-&gt;rasterizer_version = TT_INTERPRETER_VERSION_35;
 968     }
 969     else
 970     {
 971       if ( loader-&gt;exec-&gt;rasterizer_version  !=
 972            SPH_OPTION_SET_RASTERIZER_VERSION )
 973       {
 974         loader-&gt;exec-&gt;rasterizer_version = SPH_OPTION_SET_RASTERIZER_VERSION;
 975         loader-&gt;exec-&gt;size-&gt;cvt_ready    = -1;
 976 
 977         tt_size_ready_bytecode(
 978           loader-&gt;exec-&gt;size,
 979           FT_BOOL( loader-&gt;load_flags &amp; FT_LOAD_PEDANTIC ) );
 980       }
 981       else
 982         loader-&gt;exec-&gt;rasterizer_version = SPH_OPTION_SET_RASTERIZER_VERSION;
 983     }
 984 
 985     if ( IS_HINTED( loader-&gt;load_flags ) )
 986     {
 987       TWEAK_RULES( TIMES_NEW_ROMAN_HACK );
 988       TWEAK_RULES( COURIER_NEW_2_HACK );
 989     }
 990 
 991     if ( sph_test_tweak( face, family, ppem, style, glyph_index,
 992            COMPATIBILITY_MODE_Rules, COMPATIBILITY_MODE_RULES_SIZE ) )
 993       loader-&gt;exec-&gt;face-&gt;sph_compatibility_mode = TRUE;
 994 
 995 
 996     if ( IS_HINTED( loader-&gt;load_flags ) )
 997     {
 998       if ( sph_test_tweak( face, family, ppem, style, glyph_index,
 999              COMPATIBLE_WIDTHS_Rules, COMPATIBLE_WIDTHS_RULES_SIZE ) )
1000         loader-&gt;exec-&gt;compatible_widths |= TRUE;
1001     }
1002   }
1003 
1004 #else /* !(TT_USE_BYTECODE_INTERPRETER &amp;&amp;          */
1005       /*   TT_SUPPORT_SUBPIXEL_HINTING_INFINALITY) */
1006 
1007   /* ANSI C doesn&#39;t like empty source files */
1008   typedef int  _tt_subpix_dummy;
1009 
1010 #endif /* !(TT_USE_BYTECODE_INTERPRETER &amp;&amp;          */
1011        /*   TT_SUPPORT_SUBPIXEL_HINTING_INFINALITY) */
1012 
1013 
1014 /* END */
    </pre>
  </body>
</html>