<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/base/ftdbgmem.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ftcid.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftdebug.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/base/ftdbgmem.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">  1 /***************************************************************************/</span>
<span class="line-modified">  2 /*                                                                         */</span>
<span class="line-modified">  3 /*  ftdbgmem.c                                                             */</span>
<span class="line-modified">  4 /*                                                                         */</span>
<span class="line-modified">  5 /*    Memory debugger (body).                                              */</span>
<span class="line-modified">  6 /*                                                                         */</span>
<span class="line-modified">  7 /*  Copyright 2001-2018 by                                                 */</span>
<span class="line-modified">  8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">  9 /*                                                                         */</span>
<span class="line-modified"> 10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified"> 11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified"> 12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified"> 13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified"> 14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified"> 15 /*                                                                         */</span>
<span class="line-modified"> 16 /***************************************************************************/</span>
 17 
 18 
 19 #include &lt;ft2build.h&gt;
 20 #include FT_CONFIG_CONFIG_H
 21 #include FT_INTERNAL_DEBUG_H
 22 #include FT_INTERNAL_MEMORY_H
 23 #include FT_SYSTEM_H
 24 #include FT_ERRORS_H
 25 #include FT_TYPES_H
 26 
 27 
 28 #ifdef FT_DEBUG_MEMORY
 29 
 30 #define  KEEPALIVE /* `Keep alive&#39; means that freed blocks aren&#39;t released
 31                     * to the heap.  This is useful to detect double-frees
 32                     * or weird heap corruption, but it uses large amounts of
 33                     * memory, however.
 34                     */
 35 
 36 #include FT_CONFIG_STANDARD_LIBRARY_H
 37 
 38   FT_BASE_DEF( const char* )  _ft_debug_file   = NULL;
 39   FT_BASE_DEF( long )         _ft_debug_lineno = 0;
 40 
 41   extern void
 42   FT_DumpMemory( FT_Memory  memory );
 43 
 44 
 45   typedef struct FT_MemSourceRec_*  FT_MemSource;
 46   typedef struct FT_MemNodeRec_*    FT_MemNode;
 47   typedef struct FT_MemTableRec_*   FT_MemTable;
 48 
 49 
 50 #define FT_MEM_VAL( addr )  ( (FT_PtrDist)(FT_Pointer)( addr ) )
 51 
 52   /*
<span class="line-modified"> 53    *  This structure holds statistics for a single allocation/release</span>
<span class="line-modified"> 54    *  site.  This is useful to know where memory operations happen the</span>
<span class="line-modified"> 55    *  most.</span>
 56    */
 57   typedef struct  FT_MemSourceRec_
 58   {
 59     const char*   file_name;
 60     long          line_no;
 61 
 62     FT_Long       cur_blocks;   /* current number of allocated blocks */
 63     FT_Long       max_blocks;   /* max. number of allocated blocks    */
 64     FT_Long       all_blocks;   /* total number of blocks allocated   */
 65 
 66     FT_Long       cur_size;     /* current cumulative allocated size */
 67     FT_Long       max_size;     /* maximum cumulative allocated size */
 68     FT_Long       all_size;     /* total cumulative allocated size   */
 69 
 70     FT_Long       cur_max;      /* current maximum allocated size */
 71 
 72     FT_UInt32     hash;
 73     FT_MemSource  link;
 74 
 75   } FT_MemSourceRec;
 76 
 77 
 78   /*
<span class="line-modified"> 79    *  We don&#39;t need a resizable array for the memory sources because</span>
<span class="line-modified"> 80    *  their number is pretty limited within FreeType.</span>
 81    */
 82 #define FT_MEM_SOURCE_BUCKETS  128
 83 
 84   /*
<span class="line-modified"> 85    *  This structure holds information related to a single allocated</span>
<span class="line-modified"> 86    *  memory block.  If KEEPALIVE is defined, blocks that are freed by</span>
<span class="line-modified"> 87    *  FreeType are never released to the system.  Instead, their `size&#39;</span>
<span class="line-modified"> 88    *  field is set to `-size&#39;.  This is mainly useful to detect double</span>
<span class="line-modified"> 89    *  frees, at the price of a large memory footprint during execution.</span>
 90    */
 91   typedef struct  FT_MemNodeRec_
 92   {
 93     FT_Byte*      address;
 94     FT_Long       size;     /* &lt; 0 if the block was freed */
 95 
 96     FT_MemSource  source;
 97 
 98 #ifdef KEEPALIVE
 99     const char*   free_file_name;
100     FT_Long       free_line_no;
101 #endif
102 
103     FT_MemNode    link;
104 
105   } FT_MemNodeRec;
106 
107 
108   /*
<span class="line-modified">109    *  The global structure, containing compound statistics and all hash</span>
<span class="line-modified">110    *  tables.</span>
111    */
112   typedef struct  FT_MemTableRec_
113   {
114     FT_Long          size;
115     FT_Long          nodes;
116     FT_MemNode*      buckets;
117 
118     FT_Long          alloc_total;
119     FT_Long          alloc_current;
120     FT_Long          alloc_max;
121     FT_Long          alloc_count;
122 
123     FT_Bool          bound_total;
124     FT_Long          alloc_total_max;
125 
126     FT_Bool          bound_count;
127     FT_Long          alloc_count_max;
128 
129     FT_MemSource     sources[FT_MEM_SOURCE_BUCKETS];
130 
131     FT_Bool          keep_alive;
132 
133     FT_Memory        memory;
134     FT_Pointer       memory_user;
135     FT_Alloc_Func    alloc;
136     FT_Free_Func     free;
137     FT_Realloc_Func  realloc;
138 
139   } FT_MemTableRec;
140 
141 
142 #define FT_MEM_SIZE_MIN  7
143 #define FT_MEM_SIZE_MAX  13845163
144 
145 #define FT_FILENAME( x )  ( (x) ? (x) : &quot;unknown file&quot; )
146 
147 
148   /*
<span class="line-modified">149    *  Prime numbers are ugly to handle.  It would be better to implement</span>
<span class="line-modified">150    *  L-Hashing, which is 10% faster and doesn&#39;t require divisions.</span>
151    */
152   static const FT_Int  ft_mem_primes[] =
153   {
154     7,
155     11,
156     19,
157     37,
158     73,
159     109,
160     163,
161     251,
162     367,
163     557,
164     823,
165     1237,
166     1861,
167     2777,
168     4177,
169     6247,
170     9371,
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">  1 /****************************************************************************</span>
<span class="line-modified">  2  *</span>
<span class="line-modified">  3  * ftdbgmem.c</span>
<span class="line-modified">  4  *</span>
<span class="line-modified">  5  *   Memory debugger (body).</span>
<span class="line-modified">  6  *</span>
<span class="line-modified">  7  * Copyright (C) 2001-2019 by</span>
<span class="line-modified">  8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">  9  *</span>
<span class="line-modified"> 10  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified"> 11  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified"> 12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified"> 13  * this file you indicate that you have read the license and</span>
<span class="line-modified"> 14  * understand and accept it fully.</span>
<span class="line-modified"> 15  *</span>
<span class="line-modified"> 16  */</span>
 17 
 18 
 19 #include &lt;ft2build.h&gt;
 20 #include FT_CONFIG_CONFIG_H
 21 #include FT_INTERNAL_DEBUG_H
 22 #include FT_INTERNAL_MEMORY_H
 23 #include FT_SYSTEM_H
 24 #include FT_ERRORS_H
 25 #include FT_TYPES_H
 26 
 27 
 28 #ifdef FT_DEBUG_MEMORY
 29 
 30 #define  KEEPALIVE /* `Keep alive&#39; means that freed blocks aren&#39;t released
 31                     * to the heap.  This is useful to detect double-frees
 32                     * or weird heap corruption, but it uses large amounts of
 33                     * memory, however.
 34                     */
 35 
 36 #include FT_CONFIG_STANDARD_LIBRARY_H
 37 
 38   FT_BASE_DEF( const char* )  _ft_debug_file   = NULL;
 39   FT_BASE_DEF( long )         _ft_debug_lineno = 0;
 40 
 41   extern void
 42   FT_DumpMemory( FT_Memory  memory );
 43 
 44 
 45   typedef struct FT_MemSourceRec_*  FT_MemSource;
 46   typedef struct FT_MemNodeRec_*    FT_MemNode;
 47   typedef struct FT_MemTableRec_*   FT_MemTable;
 48 
 49 
 50 #define FT_MEM_VAL( addr )  ( (FT_PtrDist)(FT_Pointer)( addr ) )
 51 
 52   /*
<span class="line-modified"> 53    * This structure holds statistics for a single allocation/release</span>
<span class="line-modified"> 54    * site.  This is useful to know where memory operations happen the</span>
<span class="line-modified"> 55    * most.</span>
 56    */
 57   typedef struct  FT_MemSourceRec_
 58   {
 59     const char*   file_name;
 60     long          line_no;
 61 
 62     FT_Long       cur_blocks;   /* current number of allocated blocks */
 63     FT_Long       max_blocks;   /* max. number of allocated blocks    */
 64     FT_Long       all_blocks;   /* total number of blocks allocated   */
 65 
 66     FT_Long       cur_size;     /* current cumulative allocated size */
 67     FT_Long       max_size;     /* maximum cumulative allocated size */
 68     FT_Long       all_size;     /* total cumulative allocated size   */
 69 
 70     FT_Long       cur_max;      /* current maximum allocated size */
 71 
 72     FT_UInt32     hash;
 73     FT_MemSource  link;
 74 
 75   } FT_MemSourceRec;
 76 
 77 
 78   /*
<span class="line-modified"> 79    * We don&#39;t need a resizable array for the memory sources because</span>
<span class="line-modified"> 80    * their number is pretty limited within FreeType.</span>
 81    */
 82 #define FT_MEM_SOURCE_BUCKETS  128
 83 
 84   /*
<span class="line-modified"> 85    * This structure holds information related to a single allocated</span>
<span class="line-modified"> 86    * memory block.  If KEEPALIVE is defined, blocks that are freed by</span>
<span class="line-modified"> 87    * FreeType are never released to the system.  Instead, their `size&#39;</span>
<span class="line-modified"> 88    * field is set to `-size&#39;.  This is mainly useful to detect double</span>
<span class="line-modified"> 89    * frees, at the price of a large memory footprint during execution.</span>
 90    */
 91   typedef struct  FT_MemNodeRec_
 92   {
 93     FT_Byte*      address;
 94     FT_Long       size;     /* &lt; 0 if the block was freed */
 95 
 96     FT_MemSource  source;
 97 
 98 #ifdef KEEPALIVE
 99     const char*   free_file_name;
100     FT_Long       free_line_no;
101 #endif
102 
103     FT_MemNode    link;
104 
105   } FT_MemNodeRec;
106 
107 
108   /*
<span class="line-modified">109    * The global structure, containing compound statistics and all hash</span>
<span class="line-modified">110    * tables.</span>
111    */
112   typedef struct  FT_MemTableRec_
113   {
114     FT_Long          size;
115     FT_Long          nodes;
116     FT_MemNode*      buckets;
117 
118     FT_Long          alloc_total;
119     FT_Long          alloc_current;
120     FT_Long          alloc_max;
121     FT_Long          alloc_count;
122 
123     FT_Bool          bound_total;
124     FT_Long          alloc_total_max;
125 
126     FT_Bool          bound_count;
127     FT_Long          alloc_count_max;
128 
129     FT_MemSource     sources[FT_MEM_SOURCE_BUCKETS];
130 
131     FT_Bool          keep_alive;
132 
133     FT_Memory        memory;
134     FT_Pointer       memory_user;
135     FT_Alloc_Func    alloc;
136     FT_Free_Func     free;
137     FT_Realloc_Func  realloc;
138 
139   } FT_MemTableRec;
140 
141 
142 #define FT_MEM_SIZE_MIN  7
143 #define FT_MEM_SIZE_MAX  13845163
144 
145 #define FT_FILENAME( x )  ( (x) ? (x) : &quot;unknown file&quot; )
146 
147 
148   /*
<span class="line-modified">149    * Prime numbers are ugly to handle.  It would be better to implement</span>
<span class="line-modified">150    * L-Hashing, which is 10% faster and doesn&#39;t require divisions.</span>
151    */
152   static const FT_Int  ft_mem_primes[] =
153   {
154     7,
155     11,
156     19,
157     37,
158     73,
159     109,
160     163,
161     251,
162     367,
163     557,
164     823,
165     1237,
166     1861,
167     2777,
168     4177,
169     6247,
170     9371,
</pre>
</td>
</tr>
</table>
<center><a href="ftcid.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftdebug.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>