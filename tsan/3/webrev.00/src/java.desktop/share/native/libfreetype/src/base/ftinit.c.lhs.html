<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/share/native/libfreetype/src/base/ftinit.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre><a name="1" id="anc1"></a><span class="line-modified">  1 /***************************************************************************/</span>
<span class="line-modified">  2 /*                                                                         */</span>
<span class="line-modified">  3 /*  ftinit.c                                                               */</span>
<span class="line-modified">  4 /*                                                                         */</span>
<span class="line-modified">  5 /*    FreeType initialization layer (body).                                */</span>
<span class="line-modified">  6 /*                                                                         */</span>
<span class="line-modified">  7 /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">  8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">  9 /*                                                                         */</span>
<span class="line-modified"> 10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified"> 11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified"> 12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified"> 13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified"> 14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified"> 15 /*                                                                         */</span>
<span class="line-modified"> 16 /***************************************************************************/</span>
<span class="line-modified"> 17 </span>
<span class="line-modified"> 18   /*************************************************************************/</span>
<span class="line-modified"> 19   /*                                                                       */</span>
<span class="line-modified"> 20   /*  The purpose of this file is to implement the following two           */</span>
<span class="line-modified"> 21   /*  functions:                                                           */</span>
<span class="line-modified"> 22   /*                                                                       */</span>
<span class="line-modified"> 23   /*  FT_Add_Default_Modules():                                            */</span>
<span class="line-modified"> 24   /*     This function is used to add the set of default modules to a      */</span>
<span class="line-modified"> 25   /*     fresh new library object.  The set is taken from the header file  */</span>
<span class="line-modified"> 26   /*     `freetype/config/ftmodule.h&#39;.  See the document `FreeType 2.0     */</span>
<span class="line-modified"> 27   /*     Build System&#39; for more information.                               */</span>
<span class="line-modified"> 28   /*                                                                       */</span>
<span class="line-modified"> 29   /*  FT_Init_FreeType():                                                  */</span>
<span class="line-modified"> 30   /*     This function creates a system object for the current platform,   */</span>
<span class="line-modified"> 31   /*     builds a library out of it, then calls FT_Default_Drivers().      */</span>
<span class="line-modified"> 32   /*                                                                       */</span>
<span class="line-modified"> 33   /*  Note that even if FT_Init_FreeType() uses the implementation of the  */</span>
<span class="line-modified"> 34   /*  system object defined at build time, client applications are still   */</span>
<span class="line-modified"> 35   /*  able to provide their own `ftsystem.c&#39;.                              */</span>
<span class="line-modified"> 36   /*                                                                       */</span>
<span class="line-modified"> 37   /*************************************************************************/</span>
 38 
 39 
 40 #include &lt;ft2build.h&gt;
 41 #include FT_CONFIG_CONFIG_H
 42 #include FT_INTERNAL_OBJECTS_H
 43 #include FT_INTERNAL_DEBUG_H
 44 #include FT_MODULE_H
<a name="2" id="anc2"></a><span class="line-removed"> 45 #include &quot;basepic.h&quot;</span>
 46 
 47 
<a name="3" id="anc3"></a><span class="line-modified"> 48   /*************************************************************************/</span>
<span class="line-modified"> 49   /*                                                                       */</span>
<span class="line-modified"> 50   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified"> 51   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified"> 52   /* messages during execution.                                            */</span>
<span class="line-modified"> 53   /*                                                                       */</span>
 54 #undef  FT_COMPONENT
<a name="4" id="anc4"></a><span class="line-modified"> 55 #define FT_COMPONENT  trace_init</span>
<span class="line-removed"> 56 </span>
<span class="line-removed"> 57 </span>
<span class="line-removed"> 58 #ifndef FT_CONFIG_OPTION_PIC</span>
 59 
 60 
 61 #undef  FT_USE_MODULE
 62 #ifdef __cplusplus
 63 #define FT_USE_MODULE( type, x )  extern &quot;C&quot; const type  x;
 64 #else
 65 #define FT_USE_MODULE( type, x )  extern const type  x;
 66 #endif
 67 
 68 #include FT_CONFIG_MODULES_H
 69 
 70 #undef  FT_USE_MODULE
 71 #define FT_USE_MODULE( type, x )  (const FT_Module_Class*)&amp;(x),
 72 
 73   static
 74   const FT_Module_Class*  const ft_default_modules[] =
 75   {
 76 #include FT_CONFIG_MODULES_H
 77     0
 78   };
 79 
 80 
<a name="5" id="anc5"></a><span class="line-removed"> 81 #else /* FT_CONFIG_OPTION_PIC */</span>
<span class="line-removed"> 82 </span>
<span class="line-removed"> 83 </span>
<span class="line-removed"> 84 #ifdef __cplusplus</span>
<span class="line-removed"> 85 #define FT_EXTERNC  extern &quot;C&quot;</span>
<span class="line-removed"> 86 #else</span>
<span class="line-removed"> 87 #define FT_EXTERNC  extern</span>
<span class="line-removed"> 88 #endif</span>
<span class="line-removed"> 89 </span>
<span class="line-removed"> 90   /* declare the module&#39;s class creation/destruction functions */</span>
<span class="line-removed"> 91 #undef  FT_USE_MODULE</span>
<span class="line-removed"> 92 #define FT_USE_MODULE( type, x )                            \</span>
<span class="line-removed"> 93   FT_EXTERNC FT_Error                                       \</span>
<span class="line-removed"> 94   FT_Create_Class_ ## x( FT_Library         library,        \</span>
<span class="line-removed"> 95                          FT_Module_Class*  *output_class ); \</span>
<span class="line-removed"> 96   FT_EXTERNC void                                           \</span>
<span class="line-removed"> 97   FT_Destroy_Class_ ## x( FT_Library        library,        \</span>
<span class="line-removed"> 98                           FT_Module_Class*  clazz );</span>
<span class="line-removed"> 99 </span>
<span class="line-removed">100 #include FT_CONFIG_MODULES_H</span>
<span class="line-removed">101 </span>
<span class="line-removed">102   /* count all module classes */</span>
<span class="line-removed">103 #undef  FT_USE_MODULE</span>
<span class="line-removed">104 #define FT_USE_MODULE( type, x )  MODULE_CLASS_ ## x,</span>
<span class="line-removed">105 </span>
<span class="line-removed">106   enum</span>
<span class="line-removed">107   {</span>
<span class="line-removed">108 #include FT_CONFIG_MODULES_H</span>
<span class="line-removed">109     FT_NUM_MODULE_CLASSES</span>
<span class="line-removed">110   };</span>
<span class="line-removed">111 </span>
<span class="line-removed">112   /* destroy all module classes */</span>
<span class="line-removed">113 #undef  FT_USE_MODULE</span>
<span class="line-removed">114 #define FT_USE_MODULE( type, x )                   \</span>
<span class="line-removed">115   if ( classes[i] )                                \</span>
<span class="line-removed">116   {                                                \</span>
<span class="line-removed">117     FT_Destroy_Class_ ## x( library, classes[i] ); \</span>
<span class="line-removed">118   }                                                \</span>
<span class="line-removed">119   i++;</span>
<span class="line-removed">120 </span>
<span class="line-removed">121 </span>
<span class="line-removed">122   FT_BASE_DEF( void )</span>
<span class="line-removed">123   ft_destroy_default_module_classes( FT_Library  library )</span>
<span class="line-removed">124   {</span>
<span class="line-removed">125     FT_Module_Class*  *classes;</span>
<span class="line-removed">126     FT_Memory          memory;</span>
<span class="line-removed">127     FT_UInt            i;</span>
<span class="line-removed">128     BasePIC*           pic_container = (BasePIC*)library-&gt;pic_container.base;</span>
<span class="line-removed">129 </span>
<span class="line-removed">130 </span>
<span class="line-removed">131     if ( !pic_container-&gt;default_module_classes )</span>
<span class="line-removed">132       return;</span>
<span class="line-removed">133 </span>
<span class="line-removed">134     memory  = library-&gt;memory;</span>
<span class="line-removed">135     classes = pic_container-&gt;default_module_classes;</span>
<span class="line-removed">136     i       = 0;</span>
<span class="line-removed">137 </span>
<span class="line-removed">138 #include FT_CONFIG_MODULES_H</span>
<span class="line-removed">139 </span>
<span class="line-removed">140     FT_FREE( classes );</span>
<span class="line-removed">141     pic_container-&gt;default_module_classes = NULL;</span>
<span class="line-removed">142   }</span>
<span class="line-removed">143 </span>
<span class="line-removed">144 </span>
<span class="line-removed">145   /* initialize all module classes and the pointer table */</span>
<span class="line-removed">146 #undef  FT_USE_MODULE</span>
<span class="line-removed">147 #define FT_USE_MODULE( type, x )                     \</span>
<span class="line-removed">148   error = FT_Create_Class_ ## x( library, &amp;clazz );  \</span>
<span class="line-removed">149   if ( error )                                       \</span>
<span class="line-removed">150     goto Exit;                                       \</span>
<span class="line-removed">151   classes[i++] = clazz;</span>
<span class="line-removed">152 </span>
<span class="line-removed">153 </span>
<span class="line-removed">154   FT_BASE_DEF( FT_Error )</span>
<span class="line-removed">155   ft_create_default_module_classes( FT_Library  library )</span>
<span class="line-removed">156   {</span>
<span class="line-removed">157     FT_Error           error;</span>
<span class="line-removed">158     FT_Memory          memory;</span>
<span class="line-removed">159     FT_Module_Class*  *classes = NULL;</span>
<span class="line-removed">160     FT_Module_Class*   clazz;</span>
<span class="line-removed">161     FT_UInt            i;</span>
<span class="line-removed">162     BasePIC*           pic_container = (BasePIC*)library-&gt;pic_container.base;</span>
<span class="line-removed">163 </span>
<span class="line-removed">164 </span>
<span class="line-removed">165     memory = library-&gt;memory;</span>
<span class="line-removed">166 </span>
<span class="line-removed">167     pic_container-&gt;default_module_classes = NULL;</span>
<span class="line-removed">168 </span>
<span class="line-removed">169     if ( FT_ALLOC( classes, sizeof ( FT_Module_Class* ) *</span>
<span class="line-removed">170                               ( FT_NUM_MODULE_CLASSES + 1 ) ) )</span>
<span class="line-removed">171       return error;</span>
<span class="line-removed">172 </span>
<span class="line-removed">173     /* initialize all pointers to 0, especially the last one */</span>
<span class="line-removed">174     for ( i = 0; i &lt; FT_NUM_MODULE_CLASSES; i++ )</span>
<span class="line-removed">175       classes[i] = NULL;</span>
<span class="line-removed">176     classes[FT_NUM_MODULE_CLASSES] = NULL;</span>
<span class="line-removed">177 </span>
<span class="line-removed">178     i = 0;</span>
<span class="line-removed">179 </span>
<span class="line-removed">180 #include FT_CONFIG_MODULES_H</span>
<span class="line-removed">181 </span>
<span class="line-removed">182   Exit:</span>
<span class="line-removed">183     if ( error )</span>
<span class="line-removed">184       ft_destroy_default_module_classes( library );</span>
<span class="line-removed">185     else</span>
<span class="line-removed">186       pic_container-&gt;default_module_classes = classes;</span>
<span class="line-removed">187 </span>
<span class="line-removed">188     return error;</span>
<span class="line-removed">189   }</span>
<span class="line-removed">190 </span>
<span class="line-removed">191 </span>
<span class="line-removed">192 #endif /* FT_CONFIG_OPTION_PIC */</span>
<span class="line-removed">193 </span>
<span class="line-removed">194 </span>
195   /* documentation is in ftmodapi.h */
196 
197   FT_EXPORT_DEF( void )
198   FT_Add_Default_Modules( FT_Library  library )
199   {
200     FT_Error                       error;
201     const FT_Module_Class* const*  cur;
202 
203 
<a name="6" id="anc6"></a><span class="line-removed">204     /* FT_DEFAULT_MODULES_GET dereferences `library&#39; in PIC mode */</span>
<span class="line-removed">205 #ifdef FT_CONFIG_OPTION_PIC</span>
<span class="line-removed">206     if ( !library )</span>
<span class="line-removed">207       return;</span>
<span class="line-removed">208 #endif</span>
<span class="line-removed">209 </span>
210     /* GCC 4.6 warns the type difference:
211      *   FT_Module_Class** != const FT_Module_Class* const*
212      */
<a name="7" id="anc7"></a><span class="line-modified">213     cur = (const FT_Module_Class* const*)FT_DEFAULT_MODULES_GET;</span>
214 
215     /* test for valid `library&#39; delayed to FT_Add_Module() */
216     while ( *cur )
217     {
218       error = FT_Add_Module( library, *cur );
219       /* notify errors, but don&#39;t stop */
220       if ( error )
221         FT_TRACE0(( &quot;FT_Add_Default_Module:&quot;
222                     &quot; Cannot install `%s&#39;, error = 0x%x\n&quot;,
223                     (*cur)-&gt;module_name, error ));
224       cur++;
225     }
226   }
227 
228 
229 #ifdef FT_CONFIG_OPTION_ENVIRONMENT_PROPERTIES
230 
231 #define MAX_LENGTH  128
232 
233   /* documentation is in ftmodapi.h */
234 
235   FT_EXPORT_DEF( void )
236   FT_Set_Default_Properties( FT_Library  library )
237   {
238     const char*  env;
239     const char*  p;
240     const char*  q;
241 
242     char  module_name[MAX_LENGTH + 1];
243     char  property_name[MAX_LENGTH + 1];
244     char  property_value[MAX_LENGTH + 1];
245 
246     int  i;
247 
248 
249     env = ft_getenv( &quot;FREETYPE_PROPERTIES&quot; );
250     if ( !env )
251       return;
252 
253     for ( p = env; *p; p++ )
254     {
255       /* skip leading whitespace and separators */
256       if ( *p == &#39; &#39; || *p == &#39;\t&#39; )
257         continue;
258 
259       /* read module name, followed by `:&#39; */
260       q = p;
261       for ( i = 0; i &lt; MAX_LENGTH; i++ )
262       {
263         if ( !*p || *p == &#39;:&#39; )
264           break;
265         module_name[i] = *p++;
266       }
267       module_name[i] = &#39;\0&#39;;
268 
269       if ( !*p || *p != &#39;:&#39; || p == q )
270         break;
271 
272       /* read property name, followed by `=&#39; */
273       q = ++p;
274       for ( i = 0; i &lt; MAX_LENGTH; i++ )
275       {
276         if ( !*p || *p == &#39;=&#39; )
277           break;
278         property_name[i] = *p++;
279       }
280       property_name[i] = &#39;\0&#39;;
281 
282       if ( !*p || *p != &#39;=&#39; || p == q )
283         break;
284 
285       /* read property value, followed by whitespace (if any) */
286       q = ++p;
287       for ( i = 0; i &lt; MAX_LENGTH; i++ )
288       {
289         if ( !*p || *p == &#39; &#39; || *p == &#39;\t&#39; )
290           break;
291         property_value[i] = *p++;
292       }
293       property_value[i] = &#39;\0&#39;;
294 
295       if ( !( *p == &#39;\0&#39; || *p == &#39; &#39; || *p == &#39;\t&#39; ) || p == q )
296         break;
297 
298       /* we completely ignore errors */
299       ft_property_string_set( library,
300                               module_name,
301                               property_name,
302                               property_value );
<a name="8" id="anc8"></a>


303     }
304   }
305 
306 #else
307 
308   FT_EXPORT_DEF( void )
309   FT_Set_Default_Properties( FT_Library  library )
310   {
311     FT_UNUSED( library );
312   }
313 
314 #endif
315 
316 
317   /* documentation is in freetype.h */
318 
319   FT_EXPORT_DEF( FT_Error )
320   FT_Init_FreeType( FT_Library  *alibrary )
321   {
322     FT_Error   error;
323     FT_Memory  memory;
324 
325 
326     /* check of `alibrary&#39; delayed to `FT_New_Library&#39; */
327 
328     /* First of all, allocate a new system object -- this function is part */
329     /* of the system-specific component, i.e. `ftsystem.c&#39;.                */
330 
331     memory = FT_New_Memory();
332     if ( !memory )
333     {
334       FT_ERROR(( &quot;FT_Init_FreeType: cannot find memory manager\n&quot; ));
335       return FT_THROW( Unimplemented_Feature );
336     }
337 
338     /* build a library out of it, then fill it with the set of */
339     /* default drivers.                                        */
340 
341     error = FT_New_Library( memory, alibrary );
342     if ( error )
343       FT_Done_Memory( memory );
344     else
345       FT_Add_Default_Modules( *alibrary );
346 
347     FT_Set_Default_Properties( *alibrary );
348 
349     return error;
350   }
351 
352 
353   /* documentation is in freetype.h */
354 
355   FT_EXPORT_DEF( FT_Error )
356   FT_Done_FreeType( FT_Library  library )
357   {
358     FT_Memory  memory;
359 
360 
361     if ( !library )
362       return FT_THROW( Invalid_Library_Handle );
363 
364     memory = library-&gt;memory;
365 
366     /* Discard the library object */
367     FT_Done_Library( library );
368 
369     /* discard memory manager */
370     FT_Done_Memory( memory );
371 
372     return FT_Err_Ok;
373   }
374 
375 
376 /* END */
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>