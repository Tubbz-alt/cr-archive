<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/truetype/ttobjs.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ttinterp.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttobjs.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/truetype/ttobjs.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 /***************************************************************************/</span>
<span class="line-modified">   2 /*                                                                         */</span>
<span class="line-modified">   3 /*  ttobjs.c                                                               */</span>
<span class="line-modified">   4 /*                                                                         */</span>
<span class="line-modified">   5 /*    Objects manager (body).                                              */</span>
<span class="line-modified">   6 /*                                                                         */</span>
<span class="line-modified">   7 /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">   8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">   9 /*                                                                         */</span>
<span class="line-modified">  10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">  11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">  12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">  13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">  14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified">  15 /*                                                                         */</span>
<span class="line-modified">  16 /***************************************************************************/</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_INTERNAL_DEBUG_H
  21 #include FT_INTERNAL_STREAM_H
  22 #include FT_TRUETYPE_TAGS_H
  23 #include FT_INTERNAL_SFNT_H
  24 #include FT_DRIVER_H
  25 
  26 #include &quot;ttgload.h&quot;
  27 #include &quot;ttpload.h&quot;
  28 
  29 #include &quot;tterrors.h&quot;
  30 
  31 #ifdef TT_USE_BYTECODE_INTERPRETER
  32 #include &quot;ttinterp.h&quot;
  33 #endif
  34 
  35 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  36 #include &quot;ttgxvar.h&quot;
  37 #endif
  38 
<span class="line-modified">  39   /*************************************************************************/</span>
<span class="line-modified">  40   /*                                                                       */</span>
<span class="line-modified">  41   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified">  42   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified">  43   /* messages during execution.                                            */</span>
<span class="line-modified">  44   /*                                                                       */</span>
  45 #undef  FT_COMPONENT
<span class="line-modified">  46 #define FT_COMPONENT  trace_ttobjs</span>
  47 
  48 
  49 #ifdef TT_USE_BYTECODE_INTERPRETER
  50 
<span class="line-modified">  51   /*************************************************************************/</span>
<span class="line-modified">  52   /*                                                                       */</span>
<span class="line-modified">  53   /*                       GLYPH ZONE FUNCTIONS                            */</span>
<span class="line-modified">  54   /*                                                                       */</span>
<span class="line-modified">  55   /*************************************************************************/</span>
<span class="line-modified">  56 </span>
<span class="line-modified">  57 </span>
<span class="line-modified">  58   /*************************************************************************/</span>
<span class="line-modified">  59   /*                                                                       */</span>
<span class="line-modified">  60   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">  61   /*    tt_glyphzone_done                                                  */</span>
<span class="line-modified">  62   /*                                                                       */</span>
<span class="line-modified">  63   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">  64   /*    Deallocate a glyph zone.                                           */</span>
<span class="line-modified">  65   /*                                                                       */</span>
<span class="line-modified">  66   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">  67   /*    zone :: A pointer to the target glyph zone.                        */</span>
<span class="line-modified">  68   /*                                                                       */</span>

  69   FT_LOCAL_DEF( void )
  70   tt_glyphzone_done( TT_GlyphZone  zone )
  71   {
  72     FT_Memory  memory = zone-&gt;memory;
  73 
  74 
  75     if ( memory )
  76     {
  77       FT_FREE( zone-&gt;contours );
  78       FT_FREE( zone-&gt;tags );
  79       FT_FREE( zone-&gt;cur );
  80       FT_FREE( zone-&gt;org );
  81       FT_FREE( zone-&gt;orus );
  82 
  83       zone-&gt;max_points   = zone-&gt;n_points   = 0;
  84       zone-&gt;max_contours = zone-&gt;n_contours = 0;
  85       zone-&gt;memory       = NULL;
  86     }
  87   }
  88 
  89 
<span class="line-modified">  90   /*************************************************************************/</span>
<span class="line-modified">  91   /*                                                                       */</span>
<span class="line-modified">  92   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">  93   /*    tt_glyphzone_new                                                   */</span>
<span class="line-modified">  94   /*                                                                       */</span>
<span class="line-modified">  95   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">  96   /*    Allocate a new glyph zone.                                         */</span>
<span class="line-modified">  97   /*                                                                       */</span>
<span class="line-modified">  98   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">  99   /*    memory      :: A handle to the current memory object.              */</span>
<span class="line-modified"> 100   /*                                                                       */</span>
<span class="line-modified"> 101   /*    maxPoints   :: The capacity of glyph zone in points.               */</span>
<span class="line-modified"> 102   /*                                                                       */</span>
<span class="line-modified"> 103   /*    maxContours :: The capacity of glyph zone in contours.             */</span>
<span class="line-modified"> 104   /*                                                                       */</span>
<span class="line-modified"> 105   /* &lt;Output&gt;                                                              */</span>
<span class="line-modified"> 106   /*    zone        :: A pointer to the target glyph zone record.          */</span>
<span class="line-modified"> 107   /*                                                                       */</span>
<span class="line-modified"> 108   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 109   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 110   /*                                                                       */</span>




 111   FT_LOCAL_DEF( FT_Error )
 112   tt_glyphzone_new( FT_Memory     memory,
 113                     FT_UShort     maxPoints,
 114                     FT_Short      maxContours,
 115                     TT_GlyphZone  zone )
 116   {
 117     FT_Error  error;
 118 
 119 
 120     FT_ZERO( zone );
 121     zone-&gt;memory = memory;
 122 
 123     if ( FT_NEW_ARRAY( zone-&gt;org,      maxPoints   ) ||
 124          FT_NEW_ARRAY( zone-&gt;cur,      maxPoints   ) ||
 125          FT_NEW_ARRAY( zone-&gt;orus,     maxPoints   ) ||
 126          FT_NEW_ARRAY( zone-&gt;tags,     maxPoints   ) ||
 127          FT_NEW_ARRAY( zone-&gt;contours, maxContours ) )
 128     {
 129       tt_glyphzone_done( zone );
 130     }
 131     else
 132     {
 133       zone-&gt;max_points   = maxPoints;
 134       zone-&gt;max_contours = maxContours;
 135     }
 136 
 137     return error;
 138   }
 139 #endif /* TT_USE_BYTECODE_INTERPRETER */
 140 
 141 
 142   /* Compare the face with a list of well-known `tricky&#39; fonts. */
 143   /* This list shall be expanded as we find more of them.       */
 144 
 145   static FT_Bool
<span class="line-modified"> 146   tt_check_trickyness_family( FT_String*  name )</span>
 147   {
 148 
 149 #define TRICK_NAMES_MAX_CHARACTERS  19
 150 #define TRICK_NAMES_COUNT           26
 151 
 152     static const char trick_names[TRICK_NAMES_COUNT]
 153                                  [TRICK_NAMES_MAX_CHARACTERS + 1] =
 154     {
 155       /*
 156          PostScript names are given in brackets if they differ from the
 157          family name.  The version numbers, together with the copyright or
 158          release year data, are taken from fonts available to the
 159          developers.
 160 
 161          Note that later versions of the fonts might be no longer tricky;
 162          for example, `MingLiU&#39; version 7.00 (file `mingliu.ttc&#39; from
 163          Windows 7) is an ordinary TTC with non-tricky subfonts.
 164        */
 165 
 166       &quot;cpop&quot;,               /* dftt-p7.ttf; version 1.00, 1992 [DLJGyShoMedium] */
</pre>
<hr />
<pre>
 549       if ( glyph_index == 0 )
 550         result = TRUE;
 551       else
 552       {
 553         /* FIXME: Need to test glyphname == .notdef ? */
 554         FT_Error error;
 555         char buf[8];
 556 
 557 
 558         error = FT_Get_Glyph_Name( ttface, glyph_index, buf, 8 );
 559         if ( !error                                            &amp;&amp;
 560              buf[0] == &#39;.&#39; &amp;&amp; !ft_strncmp( buf, &quot;.notdef&quot;, 8 ) )
 561           result = TRUE;
 562       }
 563     }
 564 
 565     return result;
 566   }
 567 
 568 
<span class="line-modified"> 569   /*************************************************************************/</span>
<span class="line-modified"> 570   /*                                                                       */</span>
<span class="line-modified"> 571   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 572   /*    tt_face_init                                                       */</span>
<span class="line-modified"> 573   /*                                                                       */</span>
<span class="line-modified"> 574   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 575   /*    Initialize a given TrueType face object.                           */</span>
<span class="line-modified"> 576   /*                                                                       */</span>
<span class="line-modified"> 577   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 578   /*    stream     :: The source font stream.                              */</span>
<span class="line-modified"> 579   /*                                                                       */</span>
<span class="line-modified"> 580   /*    face_index :: The index of the TrueType font, if we are opening a  */</span>
<span class="line-modified"> 581   /*                  collection, in bits 0-15.  The numbered instance     */</span>
<span class="line-modified"> 582   /*                  index~+~1 of a GX (sub)font, if applicable, in bits  */</span>
<span class="line-modified"> 583   /*                  16-30.                                               */</span>
<span class="line-modified"> 584   /*                                                                       */</span>
<span class="line-modified"> 585   /*    num_params :: Number of additional generic parameters.  Ignored.   */</span>
<span class="line-modified"> 586   /*                                                                       */</span>
<span class="line-modified"> 587   /*    params     :: Additional generic parameters.  Ignored.             */</span>
<span class="line-modified"> 588   /*                                                                       */</span>
<span class="line-modified"> 589   /* &lt;InOut&gt;                                                               */</span>
<span class="line-modified"> 590   /*    face       :: The newly built face object.                         */</span>
<span class="line-modified"> 591   /*                                                                       */</span>
<span class="line-modified"> 592   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 593   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 594   /*                                                                       */</span>





 595   FT_LOCAL_DEF( FT_Error )
 596   tt_face_init( FT_Stream      stream,
 597                 FT_Face        ttface,      /* TT_Face */
 598                 FT_Int         face_index,
 599                 FT_Int         num_params,
 600                 FT_Parameter*  params )
 601   {
 602     FT_Error      error;
 603     FT_Library    library;
 604     SFNT_Service  sfnt;
 605     TT_Face       face = (TT_Face)ttface;
 606 
 607 
 608     FT_TRACE2(( &quot;TTF driver\n&quot; ));
 609 
 610     library = ttface-&gt;driver-&gt;root.library;
 611 
 612     sfnt = (SFNT_Service)FT_Get_Module_Interface( library, &quot;sfnt&quot; );
 613     if ( !sfnt )
 614     {
</pre>
<hr />
<pre>
 726           goto Exit;
 727 
 728         tt_apply_mvar( face );
 729       }
 730     }
 731 
 732 #endif /* TT_CONFIG_OPTION_GX_VAR_SUPPORT */
 733 
 734     /* initialize standard glyph loading routines */
 735     TT_Init_Glyph_Loading( face );
 736 
 737   Exit:
 738     return error;
 739 
 740   Bad_Format:
 741     error = FT_THROW( Unknown_File_Format );
 742     goto Exit;
 743   }
 744 
 745 
<span class="line-modified"> 746   /*************************************************************************/</span>
<span class="line-modified"> 747   /*                                                                       */</span>
<span class="line-modified"> 748   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 749   /*    tt_face_done                                                       */</span>
<span class="line-modified"> 750   /*                                                                       */</span>
<span class="line-modified"> 751   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 752   /*    Finalize a given face object.                                      */</span>
<span class="line-modified"> 753   /*                                                                       */</span>
<span class="line-modified"> 754   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 755   /*    face :: A pointer to the face object to destroy.                   */</span>
<span class="line-modified"> 756   /*                                                                       */</span>

 757   FT_LOCAL_DEF( void )
 758   tt_face_done( FT_Face  ttface )           /* TT_Face */
 759   {
 760     TT_Face       face = (TT_Face)ttface;
 761     FT_Memory     memory;
 762     FT_Stream     stream;
 763     SFNT_Service  sfnt;
 764 
 765 
 766     if ( !face )
 767       return;
 768 
 769     memory = ttface-&gt;memory;
 770     stream = ttface-&gt;stream;
 771     sfnt   = (SFNT_Service)face-&gt;sfnt;
 772 
 773     /* for `extended TrueType formats&#39; (i.e. compressed versions) */
 774     if ( face-&gt;extra.finalizer )
 775       face-&gt;extra.finalizer( face-&gt;extra.data );
 776 
</pre>
<hr />
<pre>
 782 
 783     tt_face_free_hdmx( face );
 784 
 785     /* freeing the CVT */
 786     FT_FREE( face-&gt;cvt );
 787     face-&gt;cvt_size = 0;
 788 
 789     /* freeing the programs */
 790     FT_FRAME_RELEASE( face-&gt;font_program );
 791     FT_FRAME_RELEASE( face-&gt;cvt_program );
 792     face-&gt;font_program_size = 0;
 793     face-&gt;cvt_program_size  = 0;
 794 
 795 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
 796     tt_done_blend( face );
 797     face-&gt;blend = NULL;
 798 #endif
 799   }
 800 
 801 
<span class="line-modified"> 802   /*************************************************************************/</span>
<span class="line-modified"> 803   /*                                                                       */</span>
<span class="line-modified"> 804   /*                           SIZE  FUNCTIONS                             */</span>
<span class="line-modified"> 805   /*                                                                       */</span>
<span class="line-modified"> 806   /*************************************************************************/</span>
 807 
 808 #ifdef TT_USE_BYTECODE_INTERPRETER
 809 
<span class="line-modified"> 810   /*************************************************************************/</span>
<span class="line-modified"> 811   /*                                                                       */</span>
<span class="line-modified"> 812   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 813   /*    tt_size_run_fpgm                                                   */</span>
<span class="line-modified"> 814   /*                                                                       */</span>
<span class="line-modified"> 815   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 816   /*    Run the font program.                                              */</span>
<span class="line-modified"> 817   /*                                                                       */</span>
<span class="line-modified"> 818   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 819   /*    size     :: A handle to the size object.                           */</span>
<span class="line-modified"> 820   /*                                                                       */</span>
<span class="line-modified"> 821   /*    pedantic :: Set if bytecode execution should be pedantic.          */</span>
<span class="line-modified"> 822   /*                                                                       */</span>
<span class="line-modified"> 823   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 824   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 825   /*                                                                       */</span>


 826   FT_LOCAL_DEF( FT_Error )
 827   tt_size_run_fpgm( TT_Size  size,
 828                     FT_Bool  pedantic )
 829   {
 830     TT_Face         face = (TT_Face)size-&gt;root.face;
 831     TT_ExecContext  exec;
 832     FT_Error        error;
 833 
 834 
 835     exec = size-&gt;context;
 836 
 837     error = TT_Load_Context( exec, face, size );
 838     if ( error )
 839       return error;
 840 
 841     exec-&gt;callTop = 0;
 842     exec-&gt;top     = 0;
 843 
 844     exec-&gt;period    = 64;
 845     exec-&gt;phase     = 0;
</pre>
<hr />
<pre>
 882       FT_TRACE4(( &quot;Executing `fpgm&#39; table.\n&quot; ));
 883       error = face-&gt;interpreter( exec );
 884 #ifdef FT_DEBUG_LEVEL_TRACE
 885       if ( error )
 886         FT_TRACE4(( &quot;  interpretation failed with error code 0x%x\n&quot;,
 887                     error ));
 888 #endif
 889     }
 890     else
 891       error = FT_Err_Ok;
 892 
 893     size-&gt;bytecode_ready = error;
 894 
 895     if ( !error )
 896       TT_Save_Context( exec, size );
 897 
 898     return error;
 899   }
 900 
 901 
<span class="line-modified"> 902   /*************************************************************************/</span>
<span class="line-modified"> 903   /*                                                                       */</span>
<span class="line-modified"> 904   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 905   /*    tt_size_run_prep                                                   */</span>
<span class="line-modified"> 906   /*                                                                       */</span>
<span class="line-modified"> 907   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 908   /*    Run the control value program.                                     */</span>
<span class="line-modified"> 909   /*                                                                       */</span>
<span class="line-modified"> 910   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 911   /*    size     :: A handle to the size object.                           */</span>
<span class="line-modified"> 912   /*                                                                       */</span>
<span class="line-modified"> 913   /*    pedantic :: Set if bytecode execution should be pedantic.          */</span>
<span class="line-modified"> 914   /*                                                                       */</span>
<span class="line-modified"> 915   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 916   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 917   /*                                                                       */</span>


 918   FT_LOCAL_DEF( FT_Error )
 919   tt_size_run_prep( TT_Size  size,
 920                     FT_Bool  pedantic )
 921   {
 922     TT_Face         face = (TT_Face)size-&gt;root.face;
 923     TT_ExecContext  exec;
 924     FT_Error        error;

 925 














 926 
 927     exec = size-&gt;context;
 928 
 929     error = TT_Load_Context( exec, face, size );
 930     if ( error )
 931       return error;
 932 
 933     exec-&gt;callTop = 0;
 934     exec-&gt;top     = 0;
 935 
 936     exec-&gt;instruction_trap = FALSE;
 937 
 938     exec-&gt;pedantic_hinting = pedantic;
 939 
 940     TT_Set_CodeRange( exec,
 941                       tt_coderange_cvt,
 942                       face-&gt;cvt_program,
 943                       (FT_Long)face-&gt;cvt_program_size );
 944 
 945     TT_Clear_CodeRange( exec, tt_coderange_glyph );
</pre>
<hr />
<pre>
1062     size-&gt;max_function_defs    = maxp-&gt;maxFunctionDefs;
1063     size-&gt;max_instruction_defs = maxp-&gt;maxInstructionDefs;
1064 
1065     size-&gt;num_function_defs    = 0;
1066     size-&gt;num_instruction_defs = 0;
1067 
1068     size-&gt;max_func = 0;
1069     size-&gt;max_ins  = 0;
1070 
1071     size-&gt;cvt_size     = face-&gt;cvt_size;
1072     size-&gt;storage_size = maxp-&gt;maxStorage;
1073 
1074     /* Set default metrics */
1075     {
1076       TT_Size_Metrics*  tt_metrics = &amp;size-&gt;ttmetrics;
1077 
1078 
1079       tt_metrics-&gt;rotated   = FALSE;
1080       tt_metrics-&gt;stretched = FALSE;
1081 
<span class="line-modified">1082       /* set default engine compensation */</span>
<span class="line-modified">1083       tt_metrics-&gt;compensations[0] = 0;   /* gray     */</span>
<span class="line-modified">1084       tt_metrics-&gt;compensations[1] = 0;   /* black    */</span>
<span class="line-modified">1085       tt_metrics-&gt;compensations[2] = 0;   /* white    */</span>
<span class="line-modified">1086       tt_metrics-&gt;compensations[3] = 0;   /* reserved */</span>






1087     }
1088 
1089     /* allocate function defs, instruction defs, cvt, and storage area */
1090     if ( FT_NEW_ARRAY( size-&gt;function_defs,    size-&gt;max_function_defs    ) ||
1091          FT_NEW_ARRAY( size-&gt;instruction_defs, size-&gt;max_instruction_defs ) ||
1092          FT_NEW_ARRAY( size-&gt;cvt,              size-&gt;cvt_size             ) ||
1093          FT_NEW_ARRAY( size-&gt;storage,          size-&gt;storage_size         ) )
1094       goto Exit;
1095 
1096     /* reserve twilight zone */
1097     n_twilight = maxp-&gt;maxTwilightPoints;
1098 
1099     /* there are 4 phantom points (do we need this?) */
1100     n_twilight += 4;
1101 
1102     error = tt_glyphzone_new( memory, n_twilight, 0, &amp;size-&gt;twilight );
1103     if ( error )
1104       goto Exit;
1105 
1106     size-&gt;twilight.n_points = n_twilight;
</pre>
<hr />
<pre>
1139 
1140   FT_LOCAL_DEF( FT_Error )
1141   tt_size_ready_bytecode( TT_Size  size,
1142                           FT_Bool  pedantic )
1143   {
1144     FT_Error  error = FT_Err_Ok;
1145 
1146 
1147     if ( size-&gt;bytecode_ready &lt; 0 )
1148       error = tt_size_init_bytecode( (FT_Size)size, pedantic );
1149     else
1150       error = size-&gt;bytecode_ready;
1151 
1152     if ( error )
1153       goto Exit;
1154 
1155     /* rescale CVT when needed */
1156     if ( size-&gt;cvt_ready &lt; 0 )
1157     {
1158       FT_UInt  i;
<span class="line-removed">1159       TT_Face  face = (TT_Face)size-&gt;root.face;</span>
<span class="line-removed">1160 </span>
1161 
<span class="line-removed">1162       /* Scale the cvt values to the new ppem.          */</span>
<span class="line-removed">1163       /* We use by default the y ppem to scale the CVT. */</span>
<span class="line-removed">1164       for ( i = 0; i &lt; size-&gt;cvt_size; i++ )</span>
<span class="line-removed">1165         size-&gt;cvt[i] = FT_MulFix( face-&gt;cvt[i], size-&gt;ttmetrics.scale );</span>
1166 
1167       /* all twilight points are originally zero */
1168       for ( i = 0; i &lt; (FT_UInt)size-&gt;twilight.n_points; i++ )
1169       {
1170         size-&gt;twilight.org[i].x = 0;
1171         size-&gt;twilight.org[i].y = 0;
1172         size-&gt;twilight.cur[i].x = 0;
1173         size-&gt;twilight.cur[i].y = 0;
1174       }
1175 
1176       /* clear storage area */
1177       for ( i = 0; i &lt; (FT_UInt)size-&gt;storage_size; i++ )
1178         size-&gt;storage[i] = 0;
1179 
1180       size-&gt;GS = tt_default_graphics_state;
1181 
1182       error = tt_size_run_prep( size, pedantic );
1183     }
1184     else
1185       error = size-&gt;cvt_ready;
1186 
1187   Exit:
1188     return error;
1189   }
1190 
1191 #endif /* TT_USE_BYTECODE_INTERPRETER */
1192 
1193 
<span class="line-modified">1194   /*************************************************************************/</span>
<span class="line-modified">1195   /*                                                                       */</span>
<span class="line-modified">1196   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1197   /*    tt_size_init                                                       */</span>
<span class="line-modified">1198   /*                                                                       */</span>
<span class="line-modified">1199   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1200   /*    Initialize a new TrueType size object.                             */</span>
<span class="line-modified">1201   /*                                                                       */</span>
<span class="line-modified">1202   /* &lt;InOut&gt;                                                               */</span>
<span class="line-modified">1203   /*    size :: A handle to the size object.                               */</span>
<span class="line-modified">1204   /*                                                                       */</span>
<span class="line-modified">1205   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">1206   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">1207   /*                                                                       */</span>

1208   FT_LOCAL_DEF( FT_Error )
1209   tt_size_init( FT_Size  ttsize )           /* TT_Size */
1210   {
1211     TT_Size   size  = (TT_Size)ttsize;
1212     FT_Error  error = FT_Err_Ok;
1213 
1214 
1215 #ifdef TT_USE_BYTECODE_INTERPRETER
1216     size-&gt;bytecode_ready = -1;
1217     size-&gt;cvt_ready      = -1;
1218 #endif
1219 
1220     size-&gt;ttmetrics.valid = FALSE;
1221     size-&gt;strike_index    = 0xFFFFFFFFUL;
1222 
1223     return error;
1224   }
1225 
1226 
<span class="line-modified">1227   /*************************************************************************/</span>
<span class="line-modified">1228   /*                                                                       */</span>
<span class="line-modified">1229   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1230   /*    tt_size_done                                                       */</span>
<span class="line-modified">1231   /*                                                                       */</span>
<span class="line-modified">1232   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1233   /*    The TrueType size object finalizer.                                */</span>
<span class="line-modified">1234   /*                                                                       */</span>
<span class="line-modified">1235   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">1236   /*    size :: A handle to the target size object.                        */</span>
<span class="line-modified">1237   /*                                                                       */</span>

1238   FT_LOCAL_DEF( void )
1239   tt_size_done( FT_Size  ttsize )           /* TT_Size */
1240   {
1241     TT_Size  size = (TT_Size)ttsize;
1242 
1243 
1244 #ifdef TT_USE_BYTECODE_INTERPRETER
1245     tt_size_done_bytecode( ttsize );
1246 #endif
1247 
1248     size-&gt;ttmetrics.valid = FALSE;
1249   }
1250 
1251 
<span class="line-modified">1252   /*************************************************************************/</span>
<span class="line-modified">1253   /*                                                                       */</span>
<span class="line-modified">1254   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1255   /*    tt_size_reset                                                      */</span>
<span class="line-modified">1256   /*                                                                       */</span>
<span class="line-modified">1257   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1258   /*    Reset a TrueType size when resolutions and character dimensions    */</span>
<span class="line-modified">1259   /*    have been changed.                                                 */</span>
<span class="line-modified">1260   /*                                                                       */</span>
<span class="line-modified">1261   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">1262   /*    size        :: A handle to the target size object.                 */</span>
<span class="line-modified">1263   /*                                                                       */</span>
<span class="line-modified">1264   /*    only_height :: Only recompute ascender, descender, and height;     */</span>
<span class="line-modified">1265   /*                   this flag is used for variation fonts where         */</span>
<span class="line-modified">1266   /*                   `tt_size_reset&#39; is used as an iterator function.    */</span>
<span class="line-modified">1267   /*                                                                       */</span>


1268   FT_LOCAL_DEF( FT_Error )
1269   tt_size_reset( TT_Size  size,
1270                  FT_Bool  only_height )
1271   {
1272     TT_Face           face;
1273     FT_Size_Metrics*  size_metrics;
1274 
1275 
1276     face = (TT_Face)size-&gt;root.face;
1277 
1278     /* nothing to do for CFF2 */
1279     if ( face-&gt;is_cff2 )
1280       return FT_Err_Ok;
1281 
1282     size-&gt;ttmetrics.valid = FALSE;
1283 
1284     size_metrics = &amp;size-&gt;hinted_metrics;
1285 
1286     /* copy the result from base layer */
1287     *size_metrics = size-&gt;root.metrics;
</pre>
<hr />
<pre>
1341     }
1342     else
1343     {
1344       size-&gt;ttmetrics.scale   = size_metrics-&gt;y_scale;
1345       size-&gt;ttmetrics.ppem    = size_metrics-&gt;y_ppem;
1346       size-&gt;ttmetrics.x_ratio = FT_DivFix( size_metrics-&gt;x_ppem,
1347                                            size_metrics-&gt;y_ppem );
1348       size-&gt;ttmetrics.y_ratio = 0x10000L;
1349     }
1350 
1351     size-&gt;metrics = size_metrics;
1352 
1353 #ifdef TT_USE_BYTECODE_INTERPRETER
1354     size-&gt;cvt_ready = -1;
1355 #endif /* TT_USE_BYTECODE_INTERPRETER */
1356 
1357     return FT_Err_Ok;
1358   }
1359 
1360 
<span class="line-modified">1361   /*************************************************************************/</span>
<span class="line-modified">1362   /*                                                                       */</span>
<span class="line-modified">1363   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1364   /*    tt_driver_init                                                     */</span>
<span class="line-modified">1365   /*                                                                       */</span>
<span class="line-modified">1366   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1367   /*    Initialize a given TrueType driver object.                         */</span>
<span class="line-modified">1368   /*                                                                       */</span>
<span class="line-modified">1369   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">1370   /*    driver :: A handle to the target driver object.                    */</span>
<span class="line-modified">1371   /*                                                                       */</span>
<span class="line-modified">1372   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">1373   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">1374   /*                                                                       */</span>

1375   FT_LOCAL_DEF( FT_Error )
1376   tt_driver_init( FT_Module  ttdriver )     /* TT_Driver */
1377   {
1378 
1379 #ifdef TT_USE_BYTECODE_INTERPRETER
1380 
1381     TT_Driver  driver = (TT_Driver)ttdriver;
1382 
1383     driver-&gt;interpreter_version = TT_INTERPRETER_VERSION_35;
1384 #ifdef TT_SUPPORT_SUBPIXEL_HINTING_INFINALITY
1385     driver-&gt;interpreter_version = TT_INTERPRETER_VERSION_38;
1386 #endif
1387 #ifdef TT_SUPPORT_SUBPIXEL_HINTING_MINIMAL
1388     driver-&gt;interpreter_version = TT_INTERPRETER_VERSION_40;
1389 #endif
1390 
1391 #else /* !TT_USE_BYTECODE_INTERPRETER */
1392 
1393     FT_UNUSED( ttdriver );
1394 
1395 #endif /* !TT_USE_BYTECODE_INTERPRETER */
1396 
1397     return FT_Err_Ok;
1398   }
1399 
1400 
<span class="line-modified">1401   /*************************************************************************/</span>
<span class="line-modified">1402   /*                                                                       */</span>
<span class="line-modified">1403   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1404   /*    tt_driver_done                                                     */</span>
<span class="line-modified">1405   /*                                                                       */</span>
<span class="line-modified">1406   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1407   /*    Finalize a given TrueType driver.                                  */</span>
<span class="line-modified">1408   /*                                                                       */</span>
<span class="line-modified">1409   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">1410   /*    driver :: A handle to the target TrueType driver.                  */</span>
<span class="line-modified">1411   /*                                                                       */</span>

1412   FT_LOCAL_DEF( void )
1413   tt_driver_done( FT_Module  ttdriver )     /* TT_Driver */
1414   {
1415     FT_UNUSED( ttdriver );
1416   }
1417 
1418 
<span class="line-modified">1419   /*************************************************************************/</span>
<span class="line-modified">1420   /*                                                                       */</span>
<span class="line-modified">1421   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1422   /*    tt_slot_init                                                       */</span>
<span class="line-modified">1423   /*                                                                       */</span>
<span class="line-modified">1424   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1425   /*    Initialize a new slot object.                                      */</span>
<span class="line-modified">1426   /*                                                                       */</span>
<span class="line-modified">1427   /* &lt;InOut&gt;                                                               */</span>
<span class="line-modified">1428   /*    slot :: A handle to the slot object.                               */</span>
<span class="line-modified">1429   /*                                                                       */</span>
<span class="line-modified">1430   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">1431   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">1432   /*                                                                       */</span>

1433   FT_LOCAL_DEF( FT_Error )
1434   tt_slot_init( FT_GlyphSlot  slot )
1435   {
1436     return FT_GlyphLoader_CreateExtra( slot-&gt;internal-&gt;loader );
1437   }
1438 
1439 
1440 /* END */
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 /****************************************************************************</span>
<span class="line-modified">   2  *</span>
<span class="line-modified">   3  * ttobjs.c</span>
<span class="line-modified">   4  *</span>
<span class="line-modified">   5  *   Objects manager (body).</span>
<span class="line-modified">   6  *</span>
<span class="line-modified">   7  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">   8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">   9  *</span>
<span class="line-modified">  10  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">  11  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">  12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">  13  * this file you indicate that you have read the license and</span>
<span class="line-modified">  14  * understand and accept it fully.</span>
<span class="line-modified">  15  *</span>
<span class="line-modified">  16  */</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_INTERNAL_DEBUG_H
  21 #include FT_INTERNAL_STREAM_H
  22 #include FT_TRUETYPE_TAGS_H
  23 #include FT_INTERNAL_SFNT_H
  24 #include FT_DRIVER_H
  25 
  26 #include &quot;ttgload.h&quot;
  27 #include &quot;ttpload.h&quot;
  28 
  29 #include &quot;tterrors.h&quot;
  30 
  31 #ifdef TT_USE_BYTECODE_INTERPRETER
  32 #include &quot;ttinterp.h&quot;
  33 #endif
  34 
  35 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  36 #include &quot;ttgxvar.h&quot;
  37 #endif
  38 
<span class="line-modified">  39   /**************************************************************************</span>
<span class="line-modified">  40    *</span>
<span class="line-modified">  41    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified">  42    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified">  43    * messages during execution.</span>
<span class="line-modified">  44    */</span>
  45 #undef  FT_COMPONENT
<span class="line-modified">  46 #define FT_COMPONENT  ttobjs</span>
  47 
  48 
  49 #ifdef TT_USE_BYTECODE_INTERPRETER
  50 
<span class="line-modified">  51   /**************************************************************************</span>
<span class="line-modified">  52    *</span>
<span class="line-modified">  53    *                      GLYPH ZONE FUNCTIONS</span>
<span class="line-modified">  54    *</span>
<span class="line-modified">  55    */</span>
<span class="line-modified">  56 </span>
<span class="line-modified">  57 </span>
<span class="line-modified">  58   /**************************************************************************</span>
<span class="line-modified">  59    *</span>
<span class="line-modified">  60    * @Function:</span>
<span class="line-modified">  61    *   tt_glyphzone_done</span>
<span class="line-modified">  62    *</span>
<span class="line-modified">  63    * @Description:</span>
<span class="line-modified">  64    *   Deallocate a glyph zone.</span>
<span class="line-modified">  65    *</span>
<span class="line-modified">  66    * @Input:</span>
<span class="line-modified">  67    *   zone ::</span>
<span class="line-modified">  68    *     A pointer to the target glyph zone.</span>
<span class="line-added">  69    */</span>
  70   FT_LOCAL_DEF( void )
  71   tt_glyphzone_done( TT_GlyphZone  zone )
  72   {
  73     FT_Memory  memory = zone-&gt;memory;
  74 
  75 
  76     if ( memory )
  77     {
  78       FT_FREE( zone-&gt;contours );
  79       FT_FREE( zone-&gt;tags );
  80       FT_FREE( zone-&gt;cur );
  81       FT_FREE( zone-&gt;org );
  82       FT_FREE( zone-&gt;orus );
  83 
  84       zone-&gt;max_points   = zone-&gt;n_points   = 0;
  85       zone-&gt;max_contours = zone-&gt;n_contours = 0;
  86       zone-&gt;memory       = NULL;
  87     }
  88   }
  89 
  90 
<span class="line-modified">  91   /**************************************************************************</span>
<span class="line-modified">  92    *</span>
<span class="line-modified">  93    * @Function:</span>
<span class="line-modified">  94    *   tt_glyphzone_new</span>
<span class="line-modified">  95    *</span>
<span class="line-modified">  96    * @Description:</span>
<span class="line-modified">  97    *   Allocate a new glyph zone.</span>
<span class="line-modified">  98    *</span>
<span class="line-modified">  99    * @Input:</span>
<span class="line-modified"> 100    *   memory ::</span>
<span class="line-modified"> 101    *     A handle to the current memory object.</span>
<span class="line-modified"> 102    *</span>
<span class="line-modified"> 103    *   maxPoints ::</span>
<span class="line-modified"> 104    *     The capacity of glyph zone in points.</span>
<span class="line-modified"> 105    *</span>
<span class="line-modified"> 106    *   maxContours ::</span>
<span class="line-modified"> 107    *     The capacity of glyph zone in contours.</span>
<span class="line-modified"> 108    *</span>
<span class="line-modified"> 109    * @Output:</span>
<span class="line-modified"> 110    *   zone ::</span>
<span class="line-modified"> 111    *     A pointer to the target glyph zone record.</span>
<span class="line-added"> 112    *</span>
<span class="line-added"> 113    * @Return:</span>
<span class="line-added"> 114    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 115    */</span>
 116   FT_LOCAL_DEF( FT_Error )
 117   tt_glyphzone_new( FT_Memory     memory,
 118                     FT_UShort     maxPoints,
 119                     FT_Short      maxContours,
 120                     TT_GlyphZone  zone )
 121   {
 122     FT_Error  error;
 123 
 124 
 125     FT_ZERO( zone );
 126     zone-&gt;memory = memory;
 127 
 128     if ( FT_NEW_ARRAY( zone-&gt;org,      maxPoints   ) ||
 129          FT_NEW_ARRAY( zone-&gt;cur,      maxPoints   ) ||
 130          FT_NEW_ARRAY( zone-&gt;orus,     maxPoints   ) ||
 131          FT_NEW_ARRAY( zone-&gt;tags,     maxPoints   ) ||
 132          FT_NEW_ARRAY( zone-&gt;contours, maxContours ) )
 133     {
 134       tt_glyphzone_done( zone );
 135     }
 136     else
 137     {
 138       zone-&gt;max_points   = maxPoints;
 139       zone-&gt;max_contours = maxContours;
 140     }
 141 
 142     return error;
 143   }
 144 #endif /* TT_USE_BYTECODE_INTERPRETER */
 145 
 146 
 147   /* Compare the face with a list of well-known `tricky&#39; fonts. */
 148   /* This list shall be expanded as we find more of them.       */
 149 
 150   static FT_Bool
<span class="line-modified"> 151   tt_check_trickyness_family( const FT_String*  name )</span>
 152   {
 153 
 154 #define TRICK_NAMES_MAX_CHARACTERS  19
 155 #define TRICK_NAMES_COUNT           26
 156 
 157     static const char trick_names[TRICK_NAMES_COUNT]
 158                                  [TRICK_NAMES_MAX_CHARACTERS + 1] =
 159     {
 160       /*
 161          PostScript names are given in brackets if they differ from the
 162          family name.  The version numbers, together with the copyright or
 163          release year data, are taken from fonts available to the
 164          developers.
 165 
 166          Note that later versions of the fonts might be no longer tricky;
 167          for example, `MingLiU&#39; version 7.00 (file `mingliu.ttc&#39; from
 168          Windows 7) is an ordinary TTC with non-tricky subfonts.
 169        */
 170 
 171       &quot;cpop&quot;,               /* dftt-p7.ttf; version 1.00, 1992 [DLJGyShoMedium] */
</pre>
<hr />
<pre>
 554       if ( glyph_index == 0 )
 555         result = TRUE;
 556       else
 557       {
 558         /* FIXME: Need to test glyphname == .notdef ? */
 559         FT_Error error;
 560         char buf[8];
 561 
 562 
 563         error = FT_Get_Glyph_Name( ttface, glyph_index, buf, 8 );
 564         if ( !error                                            &amp;&amp;
 565              buf[0] == &#39;.&#39; &amp;&amp; !ft_strncmp( buf, &quot;.notdef&quot;, 8 ) )
 566           result = TRUE;
 567       }
 568     }
 569 
 570     return result;
 571   }
 572 
 573 
<span class="line-modified"> 574   /**************************************************************************</span>
<span class="line-modified"> 575    *</span>
<span class="line-modified"> 576    * @Function:</span>
<span class="line-modified"> 577    *   tt_face_init</span>
<span class="line-modified"> 578    *</span>
<span class="line-modified"> 579    * @Description:</span>
<span class="line-modified"> 580    *   Initialize a given TrueType face object.</span>
<span class="line-modified"> 581    *</span>
<span class="line-modified"> 582    * @Input:</span>
<span class="line-modified"> 583    *   stream ::</span>
<span class="line-modified"> 584    *     The source font stream.</span>
<span class="line-modified"> 585    *</span>
<span class="line-modified"> 586    *   face_index ::</span>
<span class="line-modified"> 587    *     The index of the TrueType font, if we are opening a</span>
<span class="line-modified"> 588    *     collection, in bits 0-15.  The numbered instance</span>
<span class="line-modified"> 589    *     index~+~1 of a GX (sub)font, if applicable, in bits</span>
<span class="line-modified"> 590    *     16-30.</span>
<span class="line-modified"> 591    *</span>
<span class="line-modified"> 592    *   num_params ::</span>
<span class="line-modified"> 593    *     Number of additional generic parameters.  Ignored.</span>
<span class="line-modified"> 594    *</span>
<span class="line-modified"> 595    *   params ::</span>
<span class="line-modified"> 596    *     Additional generic parameters.  Ignored.</span>
<span class="line-modified"> 597    *</span>
<span class="line-modified"> 598    * @InOut:</span>
<span class="line-modified"> 599    *   face ::</span>
<span class="line-added"> 600    *     The newly built face object.</span>
<span class="line-added"> 601    *</span>
<span class="line-added"> 602    * @Return:</span>
<span class="line-added"> 603    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 604    */</span>
 605   FT_LOCAL_DEF( FT_Error )
 606   tt_face_init( FT_Stream      stream,
 607                 FT_Face        ttface,      /* TT_Face */
 608                 FT_Int         face_index,
 609                 FT_Int         num_params,
 610                 FT_Parameter*  params )
 611   {
 612     FT_Error      error;
 613     FT_Library    library;
 614     SFNT_Service  sfnt;
 615     TT_Face       face = (TT_Face)ttface;
 616 
 617 
 618     FT_TRACE2(( &quot;TTF driver\n&quot; ));
 619 
 620     library = ttface-&gt;driver-&gt;root.library;
 621 
 622     sfnt = (SFNT_Service)FT_Get_Module_Interface( library, &quot;sfnt&quot; );
 623     if ( !sfnt )
 624     {
</pre>
<hr />
<pre>
 736           goto Exit;
 737 
 738         tt_apply_mvar( face );
 739       }
 740     }
 741 
 742 #endif /* TT_CONFIG_OPTION_GX_VAR_SUPPORT */
 743 
 744     /* initialize standard glyph loading routines */
 745     TT_Init_Glyph_Loading( face );
 746 
 747   Exit:
 748     return error;
 749 
 750   Bad_Format:
 751     error = FT_THROW( Unknown_File_Format );
 752     goto Exit;
 753   }
 754 
 755 
<span class="line-modified"> 756   /**************************************************************************</span>
<span class="line-modified"> 757    *</span>
<span class="line-modified"> 758    * @Function:</span>
<span class="line-modified"> 759    *   tt_face_done</span>
<span class="line-modified"> 760    *</span>
<span class="line-modified"> 761    * @Description:</span>
<span class="line-modified"> 762    *   Finalize a given face object.</span>
<span class="line-modified"> 763    *</span>
<span class="line-modified"> 764    * @Input:</span>
<span class="line-modified"> 765    *   face ::</span>
<span class="line-modified"> 766    *     A pointer to the face object to destroy.</span>
<span class="line-added"> 767    */</span>
 768   FT_LOCAL_DEF( void )
 769   tt_face_done( FT_Face  ttface )           /* TT_Face */
 770   {
 771     TT_Face       face = (TT_Face)ttface;
 772     FT_Memory     memory;
 773     FT_Stream     stream;
 774     SFNT_Service  sfnt;
 775 
 776 
 777     if ( !face )
 778       return;
 779 
 780     memory = ttface-&gt;memory;
 781     stream = ttface-&gt;stream;
 782     sfnt   = (SFNT_Service)face-&gt;sfnt;
 783 
 784     /* for `extended TrueType formats&#39; (i.e. compressed versions) */
 785     if ( face-&gt;extra.finalizer )
 786       face-&gt;extra.finalizer( face-&gt;extra.data );
 787 
</pre>
<hr />
<pre>
 793 
 794     tt_face_free_hdmx( face );
 795 
 796     /* freeing the CVT */
 797     FT_FREE( face-&gt;cvt );
 798     face-&gt;cvt_size = 0;
 799 
 800     /* freeing the programs */
 801     FT_FRAME_RELEASE( face-&gt;font_program );
 802     FT_FRAME_RELEASE( face-&gt;cvt_program );
 803     face-&gt;font_program_size = 0;
 804     face-&gt;cvt_program_size  = 0;
 805 
 806 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
 807     tt_done_blend( face );
 808     face-&gt;blend = NULL;
 809 #endif
 810   }
 811 
 812 
<span class="line-modified"> 813   /**************************************************************************</span>
<span class="line-modified"> 814    *</span>
<span class="line-modified"> 815    *                          SIZE  FUNCTIONS</span>
<span class="line-modified"> 816    *</span>
<span class="line-modified"> 817    */</span>
 818 
 819 #ifdef TT_USE_BYTECODE_INTERPRETER
 820 
<span class="line-modified"> 821   /**************************************************************************</span>
<span class="line-modified"> 822    *</span>
<span class="line-modified"> 823    * @Function:</span>
<span class="line-modified"> 824    *   tt_size_run_fpgm</span>
<span class="line-modified"> 825    *</span>
<span class="line-modified"> 826    * @Description:</span>
<span class="line-modified"> 827    *   Run the font program.</span>
<span class="line-modified"> 828    *</span>
<span class="line-modified"> 829    * @Input:</span>
<span class="line-modified"> 830    *   size ::</span>
<span class="line-modified"> 831    *     A handle to the size object.</span>
<span class="line-modified"> 832    *</span>
<span class="line-modified"> 833    *   pedantic ::</span>
<span class="line-modified"> 834    *     Set if bytecode execution should be pedantic.</span>
<span class="line-modified"> 835    *</span>
<span class="line-modified"> 836    * @Return:</span>
<span class="line-added"> 837    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 838    */</span>
 839   FT_LOCAL_DEF( FT_Error )
 840   tt_size_run_fpgm( TT_Size  size,
 841                     FT_Bool  pedantic )
 842   {
 843     TT_Face         face = (TT_Face)size-&gt;root.face;
 844     TT_ExecContext  exec;
 845     FT_Error        error;
 846 
 847 
 848     exec = size-&gt;context;
 849 
 850     error = TT_Load_Context( exec, face, size );
 851     if ( error )
 852       return error;
 853 
 854     exec-&gt;callTop = 0;
 855     exec-&gt;top     = 0;
 856 
 857     exec-&gt;period    = 64;
 858     exec-&gt;phase     = 0;
</pre>
<hr />
<pre>
 895       FT_TRACE4(( &quot;Executing `fpgm&#39; table.\n&quot; ));
 896       error = face-&gt;interpreter( exec );
 897 #ifdef FT_DEBUG_LEVEL_TRACE
 898       if ( error )
 899         FT_TRACE4(( &quot;  interpretation failed with error code 0x%x\n&quot;,
 900                     error ));
 901 #endif
 902     }
 903     else
 904       error = FT_Err_Ok;
 905 
 906     size-&gt;bytecode_ready = error;
 907 
 908     if ( !error )
 909       TT_Save_Context( exec, size );
 910 
 911     return error;
 912   }
 913 
 914 
<span class="line-modified"> 915   /**************************************************************************</span>
<span class="line-modified"> 916    *</span>
<span class="line-modified"> 917    * @Function:</span>
<span class="line-modified"> 918    *   tt_size_run_prep</span>
<span class="line-modified"> 919    *</span>
<span class="line-modified"> 920    * @Description:</span>
<span class="line-modified"> 921    *   Run the control value program.</span>
<span class="line-modified"> 922    *</span>
<span class="line-modified"> 923    * @Input:</span>
<span class="line-modified"> 924    *   size ::</span>
<span class="line-modified"> 925    *     A handle to the size object.</span>
<span class="line-modified"> 926    *</span>
<span class="line-modified"> 927    *   pedantic ::</span>
<span class="line-modified"> 928    *     Set if bytecode execution should be pedantic.</span>
<span class="line-modified"> 929    *</span>
<span class="line-modified"> 930    * @Return:</span>
<span class="line-added"> 931    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 932    */</span>
 933   FT_LOCAL_DEF( FT_Error )
 934   tt_size_run_prep( TT_Size  size,
 935                     FT_Bool  pedantic )
 936   {
 937     TT_Face         face = (TT_Face)size-&gt;root.face;
 938     TT_ExecContext  exec;
 939     FT_Error        error;
<span class="line-added"> 940     FT_UInt         i;</span>
 941 
<span class="line-added"> 942     /* unscaled CVT values are already stored in 26.6 format */</span>
<span class="line-added"> 943     FT_Fixed  scale = size-&gt;ttmetrics.scale &gt;&gt; 6;</span>
<span class="line-added"> 944 </span>
<span class="line-added"> 945 </span>
<span class="line-added"> 946     /* Scale the cvt values to the new ppem.            */</span>
<span class="line-added"> 947     /* By default, we use the y ppem value for scaling. */</span>
<span class="line-added"> 948     FT_TRACE6(( &quot;CVT values:\n&quot; ));</span>
<span class="line-added"> 949     for ( i = 0; i &lt; size-&gt;cvt_size; i++ )</span>
<span class="line-added"> 950     {</span>
<span class="line-added"> 951       size-&gt;cvt[i] = FT_MulFix( face-&gt;cvt[i], scale );</span>
<span class="line-added"> 952       FT_TRACE6(( &quot;  %3d: %f (%f)\n&quot;,</span>
<span class="line-added"> 953                   i, face-&gt;cvt[i] / 64.0, size-&gt;cvt[i] / 64.0 ));</span>
<span class="line-added"> 954     }</span>
<span class="line-added"> 955     FT_TRACE6(( &quot;\n&quot; ));</span>
 956 
 957     exec = size-&gt;context;
 958 
 959     error = TT_Load_Context( exec, face, size );
 960     if ( error )
 961       return error;
 962 
 963     exec-&gt;callTop = 0;
 964     exec-&gt;top     = 0;
 965 
 966     exec-&gt;instruction_trap = FALSE;
 967 
 968     exec-&gt;pedantic_hinting = pedantic;
 969 
 970     TT_Set_CodeRange( exec,
 971                       tt_coderange_cvt,
 972                       face-&gt;cvt_program,
 973                       (FT_Long)face-&gt;cvt_program_size );
 974 
 975     TT_Clear_CodeRange( exec, tt_coderange_glyph );
</pre>
<hr />
<pre>
1092     size-&gt;max_function_defs    = maxp-&gt;maxFunctionDefs;
1093     size-&gt;max_instruction_defs = maxp-&gt;maxInstructionDefs;
1094 
1095     size-&gt;num_function_defs    = 0;
1096     size-&gt;num_instruction_defs = 0;
1097 
1098     size-&gt;max_func = 0;
1099     size-&gt;max_ins  = 0;
1100 
1101     size-&gt;cvt_size     = face-&gt;cvt_size;
1102     size-&gt;storage_size = maxp-&gt;maxStorage;
1103 
1104     /* Set default metrics */
1105     {
1106       TT_Size_Metrics*  tt_metrics = &amp;size-&gt;ttmetrics;
1107 
1108 
1109       tt_metrics-&gt;rotated   = FALSE;
1110       tt_metrics-&gt;stretched = FALSE;
1111 
<span class="line-modified">1112       /* Set default engine compensation.  Value 3 is not described */</span>
<span class="line-modified">1113       /* in the OpenType specification (as of Mai 2019), but Greg   */</span>
<span class="line-modified">1114       /* says that MS handles it the same as `gray&#39;.                */</span>
<span class="line-modified">1115       /*                                                            */</span>
<span class="line-modified">1116       /* The Apple specification says that the compensation for     */</span>
<span class="line-added">1117       /* `gray&#39; is always zero.  FreeType doesn&#39;t do any            */</span>
<span class="line-added">1118       /* compensation at all.                                       */</span>
<span class="line-added">1119       tt_metrics-&gt;compensations[0] = 0;   /* gray             */</span>
<span class="line-added">1120       tt_metrics-&gt;compensations[1] = 0;   /* black            */</span>
<span class="line-added">1121       tt_metrics-&gt;compensations[2] = 0;   /* white            */</span>
<span class="line-added">1122       tt_metrics-&gt;compensations[3] = 0;   /* the same as gray */</span>
1123     }
1124 
1125     /* allocate function defs, instruction defs, cvt, and storage area */
1126     if ( FT_NEW_ARRAY( size-&gt;function_defs,    size-&gt;max_function_defs    ) ||
1127          FT_NEW_ARRAY( size-&gt;instruction_defs, size-&gt;max_instruction_defs ) ||
1128          FT_NEW_ARRAY( size-&gt;cvt,              size-&gt;cvt_size             ) ||
1129          FT_NEW_ARRAY( size-&gt;storage,          size-&gt;storage_size         ) )
1130       goto Exit;
1131 
1132     /* reserve twilight zone */
1133     n_twilight = maxp-&gt;maxTwilightPoints;
1134 
1135     /* there are 4 phantom points (do we need this?) */
1136     n_twilight += 4;
1137 
1138     error = tt_glyphzone_new( memory, n_twilight, 0, &amp;size-&gt;twilight );
1139     if ( error )
1140       goto Exit;
1141 
1142     size-&gt;twilight.n_points = n_twilight;
</pre>
<hr />
<pre>
1175 
1176   FT_LOCAL_DEF( FT_Error )
1177   tt_size_ready_bytecode( TT_Size  size,
1178                           FT_Bool  pedantic )
1179   {
1180     FT_Error  error = FT_Err_Ok;
1181 
1182 
1183     if ( size-&gt;bytecode_ready &lt; 0 )
1184       error = tt_size_init_bytecode( (FT_Size)size, pedantic );
1185     else
1186       error = size-&gt;bytecode_ready;
1187 
1188     if ( error )
1189       goto Exit;
1190 
1191     /* rescale CVT when needed */
1192     if ( size-&gt;cvt_ready &lt; 0 )
1193     {
1194       FT_UInt  i;


1195 




1196 
1197       /* all twilight points are originally zero */
1198       for ( i = 0; i &lt; (FT_UInt)size-&gt;twilight.n_points; i++ )
1199       {
1200         size-&gt;twilight.org[i].x = 0;
1201         size-&gt;twilight.org[i].y = 0;
1202         size-&gt;twilight.cur[i].x = 0;
1203         size-&gt;twilight.cur[i].y = 0;
1204       }
1205 
1206       /* clear storage area */
1207       for ( i = 0; i &lt; (FT_UInt)size-&gt;storage_size; i++ )
1208         size-&gt;storage[i] = 0;
1209 
1210       size-&gt;GS = tt_default_graphics_state;
1211 
1212       error = tt_size_run_prep( size, pedantic );
1213     }
1214     else
1215       error = size-&gt;cvt_ready;
1216 
1217   Exit:
1218     return error;
1219   }
1220 
1221 #endif /* TT_USE_BYTECODE_INTERPRETER */
1222 
1223 
<span class="line-modified">1224   /**************************************************************************</span>
<span class="line-modified">1225    *</span>
<span class="line-modified">1226    * @Function:</span>
<span class="line-modified">1227    *   tt_size_init</span>
<span class="line-modified">1228    *</span>
<span class="line-modified">1229    * @Description:</span>
<span class="line-modified">1230    *   Initialize a new TrueType size object.</span>
<span class="line-modified">1231    *</span>
<span class="line-modified">1232    * @InOut:</span>
<span class="line-modified">1233    *   size ::</span>
<span class="line-modified">1234    *     A handle to the size object.</span>
<span class="line-modified">1235    *</span>
<span class="line-modified">1236    * @Return:</span>
<span class="line-modified">1237    *   FreeType error code.  0 means success.</span>
<span class="line-added">1238    */</span>
1239   FT_LOCAL_DEF( FT_Error )
1240   tt_size_init( FT_Size  ttsize )           /* TT_Size */
1241   {
1242     TT_Size   size  = (TT_Size)ttsize;
1243     FT_Error  error = FT_Err_Ok;
1244 
1245 
1246 #ifdef TT_USE_BYTECODE_INTERPRETER
1247     size-&gt;bytecode_ready = -1;
1248     size-&gt;cvt_ready      = -1;
1249 #endif
1250 
1251     size-&gt;ttmetrics.valid = FALSE;
1252     size-&gt;strike_index    = 0xFFFFFFFFUL;
1253 
1254     return error;
1255   }
1256 
1257 
<span class="line-modified">1258   /**************************************************************************</span>
<span class="line-modified">1259    *</span>
<span class="line-modified">1260    * @Function:</span>
<span class="line-modified">1261    *   tt_size_done</span>
<span class="line-modified">1262    *</span>
<span class="line-modified">1263    * @Description:</span>
<span class="line-modified">1264    *   The TrueType size object finalizer.</span>
<span class="line-modified">1265    *</span>
<span class="line-modified">1266    * @Input:</span>
<span class="line-modified">1267    *   size ::</span>
<span class="line-modified">1268    *     A handle to the target size object.</span>
<span class="line-added">1269    */</span>
1270   FT_LOCAL_DEF( void )
1271   tt_size_done( FT_Size  ttsize )           /* TT_Size */
1272   {
1273     TT_Size  size = (TT_Size)ttsize;
1274 
1275 
1276 #ifdef TT_USE_BYTECODE_INTERPRETER
1277     tt_size_done_bytecode( ttsize );
1278 #endif
1279 
1280     size-&gt;ttmetrics.valid = FALSE;
1281   }
1282 
1283 
<span class="line-modified">1284   /**************************************************************************</span>
<span class="line-modified">1285    *</span>
<span class="line-modified">1286    * @Function:</span>
<span class="line-modified">1287    *   tt_size_reset</span>
<span class="line-modified">1288    *</span>
<span class="line-modified">1289    * @Description:</span>
<span class="line-modified">1290    *   Reset a TrueType size when resolutions and character dimensions</span>
<span class="line-modified">1291    *   have been changed.</span>
<span class="line-modified">1292    *</span>
<span class="line-modified">1293    * @Input:</span>
<span class="line-modified">1294    *   size ::</span>
<span class="line-modified">1295    *     A handle to the target size object.</span>
<span class="line-modified">1296    *</span>
<span class="line-modified">1297    *   only_height ::</span>
<span class="line-modified">1298    *     Only recompute ascender, descender, and height;</span>
<span class="line-modified">1299    *     this flag is used for variation fonts where</span>
<span class="line-added">1300    *     `tt_size_reset&#39; is used as an iterator function.</span>
<span class="line-added">1301    */</span>
1302   FT_LOCAL_DEF( FT_Error )
1303   tt_size_reset( TT_Size  size,
1304                  FT_Bool  only_height )
1305   {
1306     TT_Face           face;
1307     FT_Size_Metrics*  size_metrics;
1308 
1309 
1310     face = (TT_Face)size-&gt;root.face;
1311 
1312     /* nothing to do for CFF2 */
1313     if ( face-&gt;is_cff2 )
1314       return FT_Err_Ok;
1315 
1316     size-&gt;ttmetrics.valid = FALSE;
1317 
1318     size_metrics = &amp;size-&gt;hinted_metrics;
1319 
1320     /* copy the result from base layer */
1321     *size_metrics = size-&gt;root.metrics;
</pre>
<hr />
<pre>
1375     }
1376     else
1377     {
1378       size-&gt;ttmetrics.scale   = size_metrics-&gt;y_scale;
1379       size-&gt;ttmetrics.ppem    = size_metrics-&gt;y_ppem;
1380       size-&gt;ttmetrics.x_ratio = FT_DivFix( size_metrics-&gt;x_ppem,
1381                                            size_metrics-&gt;y_ppem );
1382       size-&gt;ttmetrics.y_ratio = 0x10000L;
1383     }
1384 
1385     size-&gt;metrics = size_metrics;
1386 
1387 #ifdef TT_USE_BYTECODE_INTERPRETER
1388     size-&gt;cvt_ready = -1;
1389 #endif /* TT_USE_BYTECODE_INTERPRETER */
1390 
1391     return FT_Err_Ok;
1392   }
1393 
1394 
<span class="line-modified">1395   /**************************************************************************</span>
<span class="line-modified">1396    *</span>
<span class="line-modified">1397    * @Function:</span>
<span class="line-modified">1398    *   tt_driver_init</span>
<span class="line-modified">1399    *</span>
<span class="line-modified">1400    * @Description:</span>
<span class="line-modified">1401    *   Initialize a given TrueType driver object.</span>
<span class="line-modified">1402    *</span>
<span class="line-modified">1403    * @Input:</span>
<span class="line-modified">1404    *   driver ::</span>
<span class="line-modified">1405    *     A handle to the target driver object.</span>
<span class="line-modified">1406    *</span>
<span class="line-modified">1407    * @Return:</span>
<span class="line-modified">1408    *   FreeType error code.  0 means success.</span>
<span class="line-added">1409    */</span>
1410   FT_LOCAL_DEF( FT_Error )
1411   tt_driver_init( FT_Module  ttdriver )     /* TT_Driver */
1412   {
1413 
1414 #ifdef TT_USE_BYTECODE_INTERPRETER
1415 
1416     TT_Driver  driver = (TT_Driver)ttdriver;
1417 
1418     driver-&gt;interpreter_version = TT_INTERPRETER_VERSION_35;
1419 #ifdef TT_SUPPORT_SUBPIXEL_HINTING_INFINALITY
1420     driver-&gt;interpreter_version = TT_INTERPRETER_VERSION_38;
1421 #endif
1422 #ifdef TT_SUPPORT_SUBPIXEL_HINTING_MINIMAL
1423     driver-&gt;interpreter_version = TT_INTERPRETER_VERSION_40;
1424 #endif
1425 
1426 #else /* !TT_USE_BYTECODE_INTERPRETER */
1427 
1428     FT_UNUSED( ttdriver );
1429 
1430 #endif /* !TT_USE_BYTECODE_INTERPRETER */
1431 
1432     return FT_Err_Ok;
1433   }
1434 
1435 
<span class="line-modified">1436   /**************************************************************************</span>
<span class="line-modified">1437    *</span>
<span class="line-modified">1438    * @Function:</span>
<span class="line-modified">1439    *   tt_driver_done</span>
<span class="line-modified">1440    *</span>
<span class="line-modified">1441    * @Description:</span>
<span class="line-modified">1442    *   Finalize a given TrueType driver.</span>
<span class="line-modified">1443    *</span>
<span class="line-modified">1444    * @Input:</span>
<span class="line-modified">1445    *   driver ::</span>
<span class="line-modified">1446    *     A handle to the target TrueType driver.</span>
<span class="line-added">1447    */</span>
1448   FT_LOCAL_DEF( void )
1449   tt_driver_done( FT_Module  ttdriver )     /* TT_Driver */
1450   {
1451     FT_UNUSED( ttdriver );
1452   }
1453 
1454 
<span class="line-modified">1455   /**************************************************************************</span>
<span class="line-modified">1456    *</span>
<span class="line-modified">1457    * @Function:</span>
<span class="line-modified">1458    *   tt_slot_init</span>
<span class="line-modified">1459    *</span>
<span class="line-modified">1460    * @Description:</span>
<span class="line-modified">1461    *   Initialize a new slot object.</span>
<span class="line-modified">1462    *</span>
<span class="line-modified">1463    * @InOut:</span>
<span class="line-modified">1464    *   slot ::</span>
<span class="line-modified">1465    *     A handle to the slot object.</span>
<span class="line-modified">1466    *</span>
<span class="line-modified">1467    * @Return:</span>
<span class="line-modified">1468    *   FreeType error code.  0 means success.</span>
<span class="line-added">1469    */</span>
1470   FT_LOCAL_DEF( FT_Error )
1471   tt_slot_init( FT_GlyphSlot  slot )
1472   {
1473     return FT_GlyphLoader_CreateExtra( slot-&gt;internal-&gt;loader );
1474   }
1475 
1476 
1477 /* END */
</pre>
</td>
</tr>
</table>
<center><a href="ttinterp.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttobjs.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>