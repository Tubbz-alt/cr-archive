<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/share/native/libfreetype/src/autofit/afglobal.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre><a name="1" id="anc1"></a><span class="line-modified">  1 /***************************************************************************/</span>
<span class="line-modified">  2 /*                                                                         */</span>
<span class="line-modified">  3 /*  afglobal.c                                                             */</span>
<span class="line-modified">  4 /*                                                                         */</span>
<span class="line-modified">  5 /*    Auto-fitter routines to compute global hinting values (body).        */</span>
<span class="line-modified">  6 /*                                                                         */</span>
<span class="line-modified">  7 /*  Copyright 2003-2018 by                                                 */</span>
<span class="line-modified">  8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">  9 /*                                                                         */</span>
<span class="line-modified"> 10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified"> 11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified"> 12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified"> 13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified"> 14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified"> 15 /*                                                                         */</span>
<span class="line-modified"> 16 /***************************************************************************/</span>
 17 
 18 
 19 #include &quot;afglobal.h&quot;
 20 #include &quot;afranges.h&quot;
 21 #include &quot;afshaper.h&quot;
 22 #include FT_INTERNAL_DEBUG_H
 23 
 24 
<a name="2" id="anc2"></a><span class="line-modified"> 25   /*************************************************************************/</span>
<span class="line-modified"> 26   /*                                                                       */</span>
<span class="line-modified"> 27   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified"> 28   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified"> 29   /* messages during execution.                                            */</span>
<span class="line-modified"> 30   /*                                                                       */</span>
 31 #undef  FT_COMPONENT
<a name="3" id="anc3"></a><span class="line-modified"> 32 #define FT_COMPONENT  trace_afglobal</span>
 33 
 34 
 35   /* get writing system specific header files */
 36 #undef  WRITING_SYSTEM
 37 #define WRITING_SYSTEM( ws, WS )  /* empty */
 38 #include &quot;afwrtsys.h&quot;
 39 
 40 #include &quot;aferrors.h&quot;
<a name="4" id="anc4"></a><span class="line-removed"> 41 #include &quot;afpic.h&quot;</span>
 42 
 43 
 44 #undef  SCRIPT
 45 #define SCRIPT( s, S, d, h, H, ss )         \
 46           AF_DEFINE_SCRIPT_CLASS(           \
 47             af_ ## s ## _script_class,      \
 48             AF_SCRIPT_ ## S,                \
 49             af_ ## s ## _uniranges,         \
 50             af_ ## s ## _nonbase_uniranges, \
 51             AF_ ## H,                       \
 52             ss )
 53 
 54 #include &quot;afscript.h&quot;
 55 
 56 
 57 #undef  STYLE
 58 #define STYLE( s, S, d, ws, sc, ss, c )  \
 59           AF_DEFINE_STYLE_CLASS(         \
 60             af_ ## s ## _style_class,    \
 61             AF_STYLE_ ## S,              \
 62             ws,                          \
 63             sc,                          \
 64             ss,                          \
 65             c )
 66 
 67 #include &quot;afstyles.h&quot;
 68 
 69 
<a name="5" id="anc5"></a><span class="line-removed"> 70 #ifndef FT_CONFIG_OPTION_PIC</span>
<span class="line-removed"> 71 </span>
 72 #undef  WRITING_SYSTEM
 73 #define WRITING_SYSTEM( ws, WS )               \
 74           &amp;af_ ## ws ## _writing_system_class,
 75 
 76   FT_LOCAL_ARRAY_DEF( AF_WritingSystemClass )
 77   af_writing_system_classes[] =
 78   {
 79 
 80 #include &quot;afwrtsys.h&quot;
 81 
 82     NULL  /* do not remove */
 83   };
 84 
 85 
 86 #undef  SCRIPT
 87 #define SCRIPT( s, S, d, h, H, ss )   \
 88           &amp;af_ ## s ## _script_class,
 89 
 90   FT_LOCAL_ARRAY_DEF( AF_ScriptClass )
 91   af_script_classes[] =
 92   {
 93 
 94 #include &quot;afscript.h&quot;
 95 
 96     NULL  /* do not remove */
 97   };
 98 
 99 
100 #undef  STYLE
101 #define STYLE( s, S, d, ws, sc, ss, c ) \
102           &amp;af_ ## s ## _style_class,
103 
104   FT_LOCAL_ARRAY_DEF( AF_StyleClass )
105   af_style_classes[] =
106   {
107 
108 #include &quot;afstyles.h&quot;
109 
110     NULL  /* do not remove */
111   };
112 
<a name="6" id="anc6"></a><span class="line-removed">113 #endif /* !FT_CONFIG_OPTION_PIC */</span>
<span class="line-removed">114 </span>
115 
116 #ifdef FT_DEBUG_LEVEL_TRACE
117 
118 #undef  STYLE
119 #define STYLE( s, S, d, ws, sc, ss, c )  #s,
120 
121   FT_LOCAL_ARRAY_DEF( char* )
122   af_style_names[] =
123   {
124 
125 #include &quot;afstyles.h&quot;
126 
127   };
128 
129 #endif /* FT_DEBUG_LEVEL_TRACE */
130 
131 
132   /* Compute the style index of each glyph within a given face. */
133 
134   static FT_Error
135   af_face_globals_compute_style_coverage( AF_FaceGlobals  globals )
136   {
137     FT_Error    error;
138     FT_Face     face        = globals-&gt;face;
139     FT_CharMap  old_charmap = face-&gt;charmap;
140     FT_UShort*  gstyles     = globals-&gt;glyph_styles;
141     FT_UInt     ss;
142     FT_UInt     i;
143     FT_UInt     dflt        = ~0U; /* a non-valid value */
144 
145 
146     /* the value AF_STYLE_UNASSIGNED means `uncovered glyph&#39; */
147     for ( i = 0; i &lt; (FT_UInt)globals-&gt;glyph_count; i++ )
148       gstyles[i] = AF_STYLE_UNASSIGNED;
149 
150     error = FT_Select_Charmap( face, FT_ENCODING_UNICODE );
151     if ( error )
152     {
153       /*
154        * Ignore this error; we simply use the fallback style.
155        * XXX: Shouldn&#39;t we rather disable hinting?
156        */
157       error = FT_Err_Ok;
158       goto Exit;
159     }
160 
161     /* scan each style in a Unicode charmap */
<a name="7" id="anc7"></a><span class="line-modified">162     for ( ss = 0; AF_STYLE_CLASSES_GET[ss]; ss++ )</span>
163     {
164       AF_StyleClass       style_class =
<a name="8" id="anc8"></a><span class="line-modified">165                             AF_STYLE_CLASSES_GET[ss];</span>
166       AF_ScriptClass      script_class =
<a name="9" id="anc9"></a><span class="line-modified">167                             AF_SCRIPT_CLASSES_GET[style_class-&gt;script];</span>
168       AF_Script_UniRange  range;
169 
170 
171       if ( !script_class-&gt;script_uni_ranges )
172         continue;
173 
174       /*
<a name="10" id="anc10"></a><span class="line-modified">175        *  Scan all Unicode points in the range and set the corresponding</span>
<span class="line-modified">176        *  glyph style index.</span>
177        */
178       if ( style_class-&gt;coverage == AF_COVERAGE_DEFAULT )
179       {
180         if ( (FT_UInt)style_class-&gt;script ==
181              globals-&gt;module-&gt;default_script )
182           dflt = ss;
183 
184         for ( range = script_class-&gt;script_uni_ranges;
185               range-&gt;first != 0;
186               range++ )
187         {
188           FT_ULong  charcode = range-&gt;first;
189           FT_UInt   gindex;
190 
191 
192           gindex = FT_Get_Char_Index( face, charcode );
193 
194           if ( gindex != 0                                                &amp;&amp;
195                gindex &lt; (FT_ULong)globals-&gt;glyph_count                    &amp;&amp;
196                ( gstyles[gindex] &amp; AF_STYLE_MASK ) == AF_STYLE_UNASSIGNED )
197             gstyles[gindex] = (FT_UShort)ss;
198 
199           for (;;)
200           {
201             charcode = FT_Get_Next_Char( face, charcode, &amp;gindex );
202 
203             if ( gindex == 0 || charcode &gt; range-&gt;last )
204               break;
205 
206             if ( gindex &lt; (FT_ULong)globals-&gt;glyph_count                    &amp;&amp;
207                  ( gstyles[gindex] &amp; AF_STYLE_MASK ) == AF_STYLE_UNASSIGNED )
208               gstyles[gindex] = (FT_UShort)ss;
209           }
210         }
211 
212         /* do the same for the script&#39;s non-base characters */
213         for ( range = script_class-&gt;script_uni_nonbase_ranges;
214               range-&gt;first != 0;
215               range++ )
216         {
217           FT_ULong  charcode = range-&gt;first;
218           FT_UInt   gindex;
219 
220 
221           gindex = FT_Get_Char_Index( face, charcode );
222 
223           if ( gindex != 0                                          &amp;&amp;
224                gindex &lt; (FT_ULong)globals-&gt;glyph_count              &amp;&amp;
225                ( gstyles[gindex] &amp; AF_STYLE_MASK ) == (FT_UShort)ss )
226             gstyles[gindex] |= AF_NONBASE;
227 
228           for (;;)
229           {
230             charcode = FT_Get_Next_Char( face, charcode, &amp;gindex );
231 
232             if ( gindex == 0 || charcode &gt; range-&gt;last )
233               break;
234 
235             if ( gindex &lt; (FT_ULong)globals-&gt;glyph_count              &amp;&amp;
236                  ( gstyles[gindex] &amp; AF_STYLE_MASK ) == (FT_UShort)ss )
237               gstyles[gindex] |= AF_NONBASE;
238           }
239         }
240       }
241       else
242       {
243         /* get glyphs not directly addressable by cmap */
244         af_shaper_get_coverage( globals, style_class, gstyles, 0 );
245       }
246     }
247 
248     /* handle the remaining default OpenType features ... */
<a name="11" id="anc11"></a><span class="line-modified">249     for ( ss = 0; AF_STYLE_CLASSES_GET[ss]; ss++ )</span>
250     {
<a name="12" id="anc12"></a><span class="line-modified">251       AF_StyleClass  style_class = AF_STYLE_CLASSES_GET[ss];</span>
252 
253 
254       if ( style_class-&gt;coverage == AF_COVERAGE_DEFAULT )
255         af_shaper_get_coverage( globals, style_class, gstyles, 0 );
256     }
257 
258     /* ... and finally the default OpenType features of the default script */
<a name="13" id="anc13"></a><span class="line-modified">259     af_shaper_get_coverage( globals, AF_STYLE_CLASSES_GET[dflt], gstyles, 1 );</span>
260 
261     /* mark ASCII digits */
262     for ( i = 0x30; i &lt;= 0x39; i++ )
263     {
264       FT_UInt  gindex = FT_Get_Char_Index( face, i );
265 
266 
267       if ( gindex != 0 &amp;&amp; gindex &lt; (FT_ULong)globals-&gt;glyph_count )
268         gstyles[gindex] |= AF_DIGIT;
269     }
270 
271   Exit:
272     /*
<a name="14" id="anc14"></a><span class="line-modified">273      *  By default, all uncovered glyphs are set to the fallback style.</span>
<span class="line-modified">274      *  XXX: Shouldn&#39;t we disable hinting or do something similar?</span>
275      */
276     if ( globals-&gt;module-&gt;fallback_style != AF_STYLE_UNASSIGNED )
277     {
278       FT_Long  nn;
279 
280 
281       for ( nn = 0; nn &lt; globals-&gt;glyph_count; nn++ )
282       {
283         if ( ( gstyles[nn] &amp; AF_STYLE_MASK ) == AF_STYLE_UNASSIGNED )
284         {
285           gstyles[nn] &amp;= ~AF_STYLE_MASK;
286           gstyles[nn] |= globals-&gt;module-&gt;fallback_style;
287         }
288       }
289     }
290 
291 #ifdef FT_DEBUG_LEVEL_TRACE
292 
293     FT_TRACE4(( &quot;\n&quot;
294                 &quot;style coverage\n&quot;
295                 &quot;==============\n&quot;
296                 &quot;\n&quot; ));
297 
<a name="15" id="anc15"></a><span class="line-modified">298     for ( ss = 0; AF_STYLE_CLASSES_GET[ss]; ss++ )</span>
299     {
<a name="16" id="anc16"></a><span class="line-modified">300       AF_StyleClass  style_class = AF_STYLE_CLASSES_GET[ss];</span>
301       FT_UInt        count       = 0;
302       FT_Long        idx;
303 
304 
305       FT_TRACE4(( &quot;%s:\n&quot;, af_style_names[style_class-&gt;style] ));
306 
307       for ( idx = 0; idx &lt; globals-&gt;glyph_count; idx++ )
308       {
309         if ( ( gstyles[idx] &amp; AF_STYLE_MASK ) == style_class-&gt;style )
310         {
311           if ( !( count % 10 ) )
312             FT_TRACE4(( &quot; &quot; ));
313 
314           FT_TRACE4(( &quot; %d&quot;, idx ));
315           count++;
316 
317           if ( !( count % 10 ) )
318             FT_TRACE4(( &quot;\n&quot; ));
319         }
320       }
321 
322       if ( !count )
323         FT_TRACE4(( &quot;  (none)\n&quot; ));
324       if ( count % 10 )
325         FT_TRACE4(( &quot;\n&quot; ));
326     }
327 
328 #endif /* FT_DEBUG_LEVEL_TRACE */
329 
330     FT_Set_Charmap( face, old_charmap );
331     return error;
332   }
333 
334 
335   FT_LOCAL_DEF( FT_Error )
336   af_face_globals_new( FT_Face          face,
337                        AF_FaceGlobals  *aglobals,
338                        AF_Module        module )
339   {
340     FT_Error        error;
341     FT_Memory       memory;
342     AF_FaceGlobals  globals = NULL;
343 
344 
345     memory = face-&gt;memory;
346 
347     /* we allocate an AF_FaceGlobals structure together */
348     /* with the glyph_styles array                      */
349     if ( FT_ALLOC( globals,
350                    sizeof ( *globals ) +
351                      (FT_ULong)face-&gt;num_glyphs * sizeof ( FT_UShort ) ) )
352       goto Exit;
353 
354     globals-&gt;face                      = face;
355     globals-&gt;glyph_count               = face-&gt;num_glyphs;
356     /* right after the globals structure come the glyph styles */
357     globals-&gt;glyph_styles              = (FT_UShort*)( globals + 1 );
358     globals-&gt;module                    = module;
359     globals-&gt;stem_darkening_for_ppem   = 0;
360     globals-&gt;darken_x                  = 0;
361     globals-&gt;darken_y                  = 0;
362     globals-&gt;standard_vertical_width   = 0;
363     globals-&gt;standard_horizontal_width = 0;
364     globals-&gt;scale_down_factor         = 0;
365 
366 #ifdef FT_CONFIG_OPTION_USE_HARFBUZZ
367     globals-&gt;hb_font = hb_ft_font_create( face, NULL );
368     globals-&gt;hb_buf  = hb_buffer_create();
369 #endif
370 
371     error = af_face_globals_compute_style_coverage( globals );
372     if ( error )
373     {
374       af_face_globals_free( globals );
375       globals = NULL;
376     }
377     else
378       globals-&gt;increase_x_height = AF_PROP_INCREASE_X_HEIGHT_MAX;
379 
380   Exit:
381     *aglobals = globals;
382     return error;
383   }
384 
385 
386   FT_LOCAL_DEF( void )
387   af_face_globals_free( AF_FaceGlobals  globals )
388   {
389     if ( globals )
390     {
391       FT_Memory  memory = globals-&gt;face-&gt;memory;
392       FT_UInt    nn;
393 
394 
395       for ( nn = 0; nn &lt; AF_STYLE_MAX; nn++ )
396       {
397         if ( globals-&gt;metrics[nn] )
398         {
399           AF_StyleClass          style_class =
<a name="17" id="anc17"></a><span class="line-modified">400             AF_STYLE_CLASSES_GET[nn];</span>
401           AF_WritingSystemClass  writing_system_class =
<a name="18" id="anc18"></a><span class="line-modified">402             AF_WRITING_SYSTEM_CLASSES_GET[style_class-&gt;writing_system];</span>
403 
404 
405           if ( writing_system_class-&gt;style_metrics_done )
406             writing_system_class-&gt;style_metrics_done( globals-&gt;metrics[nn] );
407 
408           FT_FREE( globals-&gt;metrics[nn] );
409         }
410       }
411 
412 #ifdef FT_CONFIG_OPTION_USE_HARFBUZZ
413       hb_font_destroy( globals-&gt;hb_font );
414       hb_buffer_destroy( globals-&gt;hb_buf );
415 #endif
416 
417       /* no need to free `globals-&gt;glyph_styles&#39;; */
418       /* it is part of the `globals&#39; array        */
419       FT_FREE( globals );
420     }
421   }
422 
423 
424   FT_LOCAL_DEF( FT_Error )
425   af_face_globals_get_metrics( AF_FaceGlobals    globals,
426                                FT_UInt           gindex,
427                                FT_UInt           options,
428                                AF_StyleMetrics  *ametrics )
429   {
430     AF_StyleMetrics  metrics = NULL;
431 
432     AF_Style               style = (AF_Style)options;
433     AF_WritingSystemClass  writing_system_class;
434     AF_StyleClass          style_class;
435 
436     FT_Error  error = FT_Err_Ok;
437 
438 
439     if ( gindex &gt;= (FT_ULong)globals-&gt;glyph_count )
440     {
441       error = FT_THROW( Invalid_Argument );
442       goto Exit;
443     }
444 
445     /* if we have a forced style (via `options&#39;), use it, */
446     /* otherwise look into `glyph_styles&#39; array           */
447     if ( style == AF_STYLE_NONE_DFLT || style + 1 &gt;= AF_STYLE_MAX )
448       style = (AF_Style)( globals-&gt;glyph_styles[gindex] &amp;
449                           AF_STYLE_UNASSIGNED           );
450 
<a name="19" id="anc19"></a><span class="line-modified">451     style_class          = AF_STYLE_CLASSES_GET[style];</span>
<span class="line-modified">452     writing_system_class = AF_WRITING_SYSTEM_CLASSES_GET</span>

453                              [style_class-&gt;writing_system];
454 
455     metrics = globals-&gt;metrics[style];
456     if ( !metrics )
457     {
458       /* create the global metrics object if necessary */
459       FT_Memory  memory = globals-&gt;face-&gt;memory;
460 
461 
462       if ( FT_ALLOC( metrics, writing_system_class-&gt;style_metrics_size ) )
463         goto Exit;
464 
465       metrics-&gt;style_class = style_class;
466       metrics-&gt;globals     = globals;
467 
468       if ( writing_system_class-&gt;style_metrics_init )
469       {
470         error = writing_system_class-&gt;style_metrics_init( metrics,
471                                                           globals-&gt;face );
472         if ( error )
473         {
474           if ( writing_system_class-&gt;style_metrics_done )
475             writing_system_class-&gt;style_metrics_done( metrics );
476 
477           FT_FREE( metrics );
<a name="20" id="anc20"></a>









478           goto Exit;
479         }
480       }
481 
482       globals-&gt;metrics[style] = metrics;
483     }
484 
485   Exit:
486     *ametrics = metrics;
487 
488     return error;
489   }
490 
491 
492   FT_LOCAL_DEF( FT_Bool )
493   af_face_globals_is_digit( AF_FaceGlobals  globals,
494                             FT_UInt         gindex )
495   {
496     if ( gindex &lt; (FT_ULong)globals-&gt;glyph_count )
<a name="21" id="anc21"></a><span class="line-modified">497       return (FT_Bool)( globals-&gt;glyph_styles[gindex] &amp; AF_DIGIT );</span>
498 
<a name="22" id="anc22"></a><span class="line-modified">499     return (FT_Bool)0;</span>
500   }
501 
502 
503 /* END */
<a name="23" id="anc23"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="23" type="hidden" />
</body>
</html>