<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/base/ftbitmap.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ftbbox.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftcalc.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/base/ftbitmap.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 /***************************************************************************/</span>
<span class="line-modified">   2 /*                                                                         */</span>
<span class="line-modified">   3 /*  ftbitmap.c                                                             */</span>
<span class="line-modified">   4 /*                                                                         */</span>
<span class="line-modified">   5 /*    FreeType utility functions for bitmaps (body).                       */</span>
<span class="line-modified">   6 /*                                                                         */</span>
<span class="line-modified">   7 /*  Copyright 2004-2018 by                                                 */</span>
<span class="line-modified">   8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">   9 /*                                                                         */</span>
<span class="line-modified">  10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">  11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">  12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">  13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">  14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified">  15 /*                                                                         */</span>
<span class="line-modified">  16 /***************************************************************************/</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_INTERNAL_DEBUG_H
  21 
  22 #include FT_BITMAP_H
  23 #include FT_IMAGE_H
  24 #include FT_INTERNAL_OBJECTS_H
  25 
  26 










  27   static
<span class="line-modified">  28   const FT_Bitmap  null_bitmap = { 0, 0, 0, 0, 0, 0, 0, 0 };</span>
  29 
  30 
  31   /* documentation is in ftbitmap.h */
  32 
  33   FT_EXPORT_DEF( void )
  34   FT_Bitmap_Init( FT_Bitmap  *abitmap )
  35   {
  36     if ( abitmap )
  37       *abitmap = null_bitmap;
  38   }
  39 
  40 
  41   /* deprecated function name; retained for ABI compatibility */
  42 
  43   FT_EXPORT_DEF( void )
  44   FT_Bitmap_New( FT_Bitmap  *abitmap )
  45   {
  46     if ( abitmap )
  47       *abitmap = null_bitmap;
  48   }
</pre>
<hr />
<pre>
 766             tt[0] = ft_gray_for_premultiplied_srgb_bgra( ss );
 767 
 768             ss += 4;
 769             tt += 1;
 770           }
 771 
 772           s += source-&gt;pitch;
 773           t += target-&gt;pitch;
 774         }
 775       }
 776       break;
 777 
 778     default:
 779       ;
 780     }
 781 
 782     return error;
 783   }
 784 
 785 












































































































































































































































































































































 786   /* documentation is in ftbitmap.h */
 787 
 788   FT_EXPORT_DEF( FT_Error )
 789   FT_GlyphSlot_Own_Bitmap( FT_GlyphSlot  slot )
 790   {
 791     if ( slot &amp;&amp; slot-&gt;format == FT_GLYPH_FORMAT_BITMAP   &amp;&amp;
 792          !( slot-&gt;internal-&gt;flags &amp; FT_GLYPH_OWN_BITMAP ) )
 793     {
 794       FT_Bitmap  bitmap;
 795       FT_Error   error;
 796 
 797 
 798       FT_Bitmap_Init( &amp;bitmap );
 799       error = FT_Bitmap_Copy( slot-&gt;library, &amp;slot-&gt;bitmap, &amp;bitmap );
 800       if ( error )
 801         return error;
 802 
 803       slot-&gt;bitmap = bitmap;
 804       slot-&gt;internal-&gt;flags |= FT_GLYPH_OWN_BITMAP;
 805     }
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 /****************************************************************************</span>
<span class="line-modified">   2  *</span>
<span class="line-modified">   3  * ftbitmap.c</span>
<span class="line-modified">   4  *</span>
<span class="line-modified">   5  *   FreeType utility functions for bitmaps (body).</span>
<span class="line-modified">   6  *</span>
<span class="line-modified">   7  * Copyright (C) 2004-2019 by</span>
<span class="line-modified">   8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">   9  *</span>
<span class="line-modified">  10  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">  11  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">  12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">  13  * this file you indicate that you have read the license and</span>
<span class="line-modified">  14  * understand and accept it fully.</span>
<span class="line-modified">  15  *</span>
<span class="line-modified">  16  */</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_INTERNAL_DEBUG_H
  21 
  22 #include FT_BITMAP_H
  23 #include FT_IMAGE_H
  24 #include FT_INTERNAL_OBJECTS_H
  25 
  26 
<span class="line-added">  27   /**************************************************************************</span>
<span class="line-added">  28    *</span>
<span class="line-added">  29    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-added">  30    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-added">  31    * messages during execution.</span>
<span class="line-added">  32    */</span>
<span class="line-added">  33 #undef  FT_COMPONENT</span>
<span class="line-added">  34 #define FT_COMPONENT  bitmap</span>
<span class="line-added">  35 </span>
<span class="line-added">  36 </span>
  37   static
<span class="line-modified">  38   const FT_Bitmap  null_bitmap = { 0, 0, 0, NULL, 0, 0, 0, NULL };</span>
  39 
  40 
  41   /* documentation is in ftbitmap.h */
  42 
  43   FT_EXPORT_DEF( void )
  44   FT_Bitmap_Init( FT_Bitmap  *abitmap )
  45   {
  46     if ( abitmap )
  47       *abitmap = null_bitmap;
  48   }
  49 
  50 
  51   /* deprecated function name; retained for ABI compatibility */
  52 
  53   FT_EXPORT_DEF( void )
  54   FT_Bitmap_New( FT_Bitmap  *abitmap )
  55   {
  56     if ( abitmap )
  57       *abitmap = null_bitmap;
  58   }
</pre>
<hr />
<pre>
 776             tt[0] = ft_gray_for_premultiplied_srgb_bgra( ss );
 777 
 778             ss += 4;
 779             tt += 1;
 780           }
 781 
 782           s += source-&gt;pitch;
 783           t += target-&gt;pitch;
 784         }
 785       }
 786       break;
 787 
 788     default:
 789       ;
 790     }
 791 
 792     return error;
 793   }
 794 
 795 
<span class="line-added"> 796   /* documentation is in ftbitmap.h */</span>
<span class="line-added"> 797 </span>
<span class="line-added"> 798   FT_EXPORT_DEF( FT_Error )</span>
<span class="line-added"> 799   FT_Bitmap_Blend( FT_Library        library,</span>
<span class="line-added"> 800                    const FT_Bitmap*  source_,</span>
<span class="line-added"> 801                    const FT_Vector   source_offset_,</span>
<span class="line-added"> 802                    FT_Bitmap*        target,</span>
<span class="line-added"> 803                    FT_Vector        *atarget_offset,</span>
<span class="line-added"> 804                    FT_Color          color )</span>
<span class="line-added"> 805   {</span>
<span class="line-added"> 806     FT_Error   error = FT_Err_Ok;</span>
<span class="line-added"> 807     FT_Memory  memory;</span>
<span class="line-added"> 808 </span>
<span class="line-added"> 809     FT_Bitmap         source_bitmap;</span>
<span class="line-added"> 810     const FT_Bitmap*  source;</span>
<span class="line-added"> 811 </span>
<span class="line-added"> 812     FT_Vector  source_offset;</span>
<span class="line-added"> 813     FT_Vector  target_offset;</span>
<span class="line-added"> 814 </span>
<span class="line-added"> 815     FT_Bool  free_source_bitmap          = 0;</span>
<span class="line-added"> 816     FT_Bool  free_target_bitmap_on_error = 0;</span>
<span class="line-added"> 817 </span>
<span class="line-added"> 818     FT_Pos  source_llx, source_lly, source_urx, source_ury;</span>
<span class="line-added"> 819     FT_Pos  target_llx, target_lly, target_urx, target_ury;</span>
<span class="line-added"> 820     FT_Pos  final_llx, final_lly, final_urx, final_ury;</span>
<span class="line-added"> 821 </span>
<span class="line-added"> 822     unsigned int  final_rows, final_width;</span>
<span class="line-added"> 823     long          x, y;</span>
<span class="line-added"> 824 </span>
<span class="line-added"> 825 </span>
<span class="line-added"> 826     if ( !library || !target || !source_ || !atarget_offset )</span>
<span class="line-added"> 827       return FT_THROW( Invalid_Argument );</span>
<span class="line-added"> 828 </span>
<span class="line-added"> 829     memory = library-&gt;memory;</span>
<span class="line-added"> 830 </span>
<span class="line-added"> 831     if ( !( target-&gt;pixel_mode == FT_PIXEL_MODE_NONE     ||</span>
<span class="line-added"> 832             ( target-&gt;pixel_mode == FT_PIXEL_MODE_BGRA &amp;&amp;</span>
<span class="line-added"> 833               target-&gt;buffer                           ) ) )</span>
<span class="line-added"> 834       return FT_THROW( Invalid_Argument );</span>
<span class="line-added"> 835 </span>
<span class="line-added"> 836     if ( source_-&gt;pixel_mode == FT_PIXEL_MODE_NONE )</span>
<span class="line-added"> 837       return FT_Err_Ok;               /* nothing to do */</span>
<span class="line-added"> 838 </span>
<span class="line-added"> 839     /* pitches must have the same sign */</span>
<span class="line-added"> 840     if ( target-&gt;pixel_mode == FT_PIXEL_MODE_BGRA &amp;&amp;</span>
<span class="line-added"> 841          ( source_-&gt;pitch ^ target-&gt;pitch ) &lt; 0   )</span>
<span class="line-added"> 842       return FT_THROW( Invalid_Argument );</span>
<span class="line-added"> 843 </span>
<span class="line-added"> 844     if ( !( source_-&gt;width &amp;&amp; source_-&gt;rows ) )</span>
<span class="line-added"> 845       return FT_Err_Ok;               /* nothing to do */</span>
<span class="line-added"> 846 </span>
<span class="line-added"> 847     /* assure integer pixel offsets */</span>
<span class="line-added"> 848     source_offset.x = FT_PIX_FLOOR( source_offset_.x );</span>
<span class="line-added"> 849     source_offset.y = FT_PIX_FLOOR( source_offset_.y );</span>
<span class="line-added"> 850     target_offset.x = FT_PIX_FLOOR( atarget_offset-&gt;x );</span>
<span class="line-added"> 851     target_offset.y = FT_PIX_FLOOR( atarget_offset-&gt;y );</span>
<span class="line-added"> 852 </span>
<span class="line-added"> 853     /* get source bitmap dimensions */</span>
<span class="line-added"> 854     source_llx = source_offset.x;</span>
<span class="line-added"> 855     if ( FT_LONG_MIN + (FT_Pos)( source_-&gt;rows &lt;&lt; 6 ) + 64 &gt; source_offset.y )</span>
<span class="line-added"> 856     {</span>
<span class="line-added"> 857       FT_TRACE5((</span>
<span class="line-added"> 858         &quot;FT_Bitmap_Blend: y coordinate overflow in source bitmap\n&quot; ));</span>
<span class="line-added"> 859       return FT_THROW( Invalid_Argument );</span>
<span class="line-added"> 860     }</span>
<span class="line-added"> 861     source_lly = source_offset.y - ( source_-&gt;rows &lt;&lt; 6 );</span>
<span class="line-added"> 862 </span>
<span class="line-added"> 863     if ( FT_LONG_MAX - (FT_Pos)( source_-&gt;width &lt;&lt; 6 ) - 64 &lt; source_llx )</span>
<span class="line-added"> 864     {</span>
<span class="line-added"> 865       FT_TRACE5((</span>
<span class="line-added"> 866         &quot;FT_Bitmap_Blend: x coordinate overflow in source bitmap\n&quot; ));</span>
<span class="line-added"> 867       return FT_THROW( Invalid_Argument );</span>
<span class="line-added"> 868     }</span>
<span class="line-added"> 869     source_urx = source_llx + ( source_-&gt;width &lt;&lt; 6 );</span>
<span class="line-added"> 870     source_ury = source_offset.y;</span>
<span class="line-added"> 871 </span>
<span class="line-added"> 872     /* get target bitmap dimensions */</span>
<span class="line-added"> 873     if ( target-&gt;width &amp;&amp; target-&gt;rows )</span>
<span class="line-added"> 874     {</span>
<span class="line-added"> 875       target_llx = target_offset.x;</span>
<span class="line-added"> 876       if ( FT_LONG_MIN + (FT_Pos)( target-&gt;rows &lt;&lt; 6 ) &gt; target_offset.y )</span>
<span class="line-added"> 877       {</span>
<span class="line-added"> 878         FT_TRACE5((</span>
<span class="line-added"> 879           &quot;FT_Bitmap_Blend: y coordinate overflow in target bitmap\n&quot; ));</span>
<span class="line-added"> 880         return FT_THROW( Invalid_Argument );</span>
<span class="line-added"> 881       }</span>
<span class="line-added"> 882       target_lly = target_offset.y - ( target-&gt;rows &lt;&lt; 6 );</span>
<span class="line-added"> 883 </span>
<span class="line-added"> 884       if ( FT_LONG_MAX - (FT_Pos)( target-&gt;width &lt;&lt; 6 ) &lt; target_llx )</span>
<span class="line-added"> 885       {</span>
<span class="line-added"> 886         FT_TRACE5((</span>
<span class="line-added"> 887           &quot;FT_Bitmap_Blend: x coordinate overflow in target bitmap\n&quot; ));</span>
<span class="line-added"> 888         return FT_THROW( Invalid_Argument );</span>
<span class="line-added"> 889       }</span>
<span class="line-added"> 890       target_urx = target_llx + ( target-&gt;width &lt;&lt; 6 );</span>
<span class="line-added"> 891       target_ury = target_offset.y;</span>
<span class="line-added"> 892     }</span>
<span class="line-added"> 893     else</span>
<span class="line-added"> 894     {</span>
<span class="line-added"> 895       target_llx = FT_LONG_MAX;</span>
<span class="line-added"> 896       target_lly = FT_LONG_MAX;</span>
<span class="line-added"> 897       target_urx = FT_LONG_MIN;</span>
<span class="line-added"> 898       target_ury = FT_LONG_MIN;</span>
<span class="line-added"> 899     }</span>
<span class="line-added"> 900 </span>
<span class="line-added"> 901     /* compute final bitmap dimensions */</span>
<span class="line-added"> 902     final_llx = FT_MIN( source_llx, target_llx );</span>
<span class="line-added"> 903     final_lly = FT_MIN( source_lly, target_lly );</span>
<span class="line-added"> 904     final_urx = FT_MAX( source_urx, target_urx );</span>
<span class="line-added"> 905     final_ury = FT_MAX( source_ury, target_ury );</span>
<span class="line-added"> 906 </span>
<span class="line-added"> 907     final_width = ( final_urx - final_llx ) &gt;&gt; 6;</span>
<span class="line-added"> 908     final_rows  = ( final_ury - final_lly ) &gt;&gt; 6;</span>
<span class="line-added"> 909 </span>
<span class="line-added"> 910 #ifdef FT_DEBUG_LEVEL_TRACE</span>
<span class="line-added"> 911     FT_TRACE5(( &quot;FT_Bitmap_Blend:\n&quot;</span>
<span class="line-added"> 912                 &quot;  source bitmap: (%d, %d) -- (%d, %d); %d x %d\n&quot;,</span>
<span class="line-added"> 913       source_llx / 64, source_lly / 64,</span>
<span class="line-added"> 914       source_urx / 64, source_ury / 64,</span>
<span class="line-added"> 915       source_-&gt;width, source_-&gt;rows ));</span>
<span class="line-added"> 916 </span>
<span class="line-added"> 917     if ( target-&gt;width &amp;&amp; target-&gt;rows )</span>
<span class="line-added"> 918       FT_TRACE5(( &quot;  target bitmap: (%d, %d) -- (%d, %d); %d x %d\n&quot;,</span>
<span class="line-added"> 919         target_llx / 64, target_lly / 64,</span>
<span class="line-added"> 920         target_urx / 64, target_ury / 64,</span>
<span class="line-added"> 921         target-&gt;width, target-&gt;rows ));</span>
<span class="line-added"> 922     else</span>
<span class="line-added"> 923       FT_TRACE5(( &quot;  target bitmap: empty\n&quot; ));</span>
<span class="line-added"> 924 </span>
<span class="line-added"> 925     if ( final_width &amp;&amp; final_rows )</span>
<span class="line-added"> 926       FT_TRACE5(( &quot;  final bitmap: (%d, %d) -- (%d, %d); %d x %d\n&quot;,</span>
<span class="line-added"> 927         final_llx / 64, final_lly / 64,</span>
<span class="line-added"> 928         final_urx / 64, final_ury / 64,</span>
<span class="line-added"> 929         final_width, final_rows ));</span>
<span class="line-added"> 930     else</span>
<span class="line-added"> 931       FT_TRACE5(( &quot;  final bitmap: empty\n&quot; ));</span>
<span class="line-added"> 932 #endif /* FT_DEBUG_LEVEL_TRACE */</span>
<span class="line-added"> 933 </span>
<span class="line-added"> 934     if ( !( final_width &amp;&amp; final_rows ) )</span>
<span class="line-added"> 935       return FT_Err_Ok;               /* nothing to do */</span>
<span class="line-added"> 936 </span>
<span class="line-added"> 937     /* for blending, set offset vector of final bitmap */</span>
<span class="line-added"> 938     /* temporarily to (0,0)                            */</span>
<span class="line-added"> 939     source_llx -= final_llx;</span>
<span class="line-added"> 940     source_lly -= final_lly;</span>
<span class="line-added"> 941 </span>
<span class="line-added"> 942     if ( target-&gt;width &amp;&amp; target-&gt;rows )</span>
<span class="line-added"> 943     {</span>
<span class="line-added"> 944       target_llx -= final_llx;</span>
<span class="line-added"> 945       target_lly -= final_lly;</span>
<span class="line-added"> 946     }</span>
<span class="line-added"> 947 </span>
<span class="line-added"> 948     /* set up target bitmap */</span>
<span class="line-added"> 949     if ( target-&gt;pixel_mode == FT_PIXEL_MODE_NONE )</span>
<span class="line-added"> 950     {</span>
<span class="line-added"> 951       /* create new empty bitmap */</span>
<span class="line-added"> 952       target-&gt;width      = final_width;</span>
<span class="line-added"> 953       target-&gt;rows       = final_rows;</span>
<span class="line-added"> 954       target-&gt;pixel_mode = FT_PIXEL_MODE_BGRA;</span>
<span class="line-added"> 955       target-&gt;pitch      = (int)final_width * 4;</span>
<span class="line-added"> 956       target-&gt;num_grays  = 256;</span>
<span class="line-added"> 957 </span>
<span class="line-added"> 958       if ( FT_LONG_MAX / target-&gt;pitch &lt; (int)target-&gt;rows )</span>
<span class="line-added"> 959       {</span>
<span class="line-added"> 960         FT_TRACE5(( &quot;FT_Blend_Bitmap: target bitmap too large (%d x %d)\n&quot;,</span>
<span class="line-added"> 961                      final_width, final_rows ));</span>
<span class="line-added"> 962         return FT_THROW( Invalid_Argument );</span>
<span class="line-added"> 963       }</span>
<span class="line-added"> 964 </span>
<span class="line-added"> 965       if ( FT_ALLOC( target-&gt;buffer, target-&gt;pitch * (int)target-&gt;rows ) )</span>
<span class="line-added"> 966         return error;</span>
<span class="line-added"> 967 </span>
<span class="line-added"> 968       free_target_bitmap_on_error = 1;</span>
<span class="line-added"> 969     }</span>
<span class="line-added"> 970     else if ( target-&gt;width != final_width ||</span>
<span class="line-added"> 971               target-&gt;rows  != final_rows  )</span>
<span class="line-added"> 972     {</span>
<span class="line-added"> 973       /* adjust old bitmap to enlarged size */</span>
<span class="line-added"> 974       int  pitch, new_pitch;</span>
<span class="line-added"> 975 </span>
<span class="line-added"> 976       unsigned char*  buffer = NULL;</span>
<span class="line-added"> 977 </span>
<span class="line-added"> 978 </span>
<span class="line-added"> 979       pitch = target-&gt;pitch;</span>
<span class="line-added"> 980 </span>
<span class="line-added"> 981       if ( pitch &lt; 0 )</span>
<span class="line-added"> 982         pitch = -pitch;</span>
<span class="line-added"> 983 </span>
<span class="line-added"> 984       new_pitch = (int)final_width * 4;</span>
<span class="line-added"> 985 </span>
<span class="line-added"> 986       if ( FT_LONG_MAX / new_pitch &lt; (int)final_rows )</span>
<span class="line-added"> 987       {</span>
<span class="line-added"> 988         FT_TRACE5(( &quot;FT_Blend_Bitmap: target bitmap too large (%d x %d)\n&quot;,</span>
<span class="line-added"> 989                      final_width, final_rows ));</span>
<span class="line-added"> 990         return FT_THROW( Invalid_Argument );</span>
<span class="line-added"> 991       }</span>
<span class="line-added"> 992 </span>
<span class="line-added"> 993       /* TODO: provide an in-buffer solution for large bitmaps */</span>
<span class="line-added"> 994       /*       to avoid allocation of a new buffer             */</span>
<span class="line-added"> 995       if ( FT_ALLOC( buffer, new_pitch * (int)final_rows ) )</span>
<span class="line-added"> 996         goto Error;</span>
<span class="line-added"> 997 </span>
<span class="line-added"> 998       /* copy data to new buffer */</span>
<span class="line-added"> 999       x = target_llx &gt;&gt; 6;</span>
<span class="line-added">1000       y = target_lly &gt;&gt; 6;</span>
<span class="line-added">1001 </span>
<span class="line-added">1002       /* the bitmap flow is from top to bottom, */</span>
<span class="line-added">1003       /* but y is measured from bottom to top   */</span>
<span class="line-added">1004       if ( target-&gt;pitch &lt; 0 )</span>
<span class="line-added">1005       {</span>
<span class="line-added">1006         /* XXX */</span>
<span class="line-added">1007       }</span>
<span class="line-added">1008       else</span>
<span class="line-added">1009       {</span>
<span class="line-added">1010         unsigned char*  p =</span>
<span class="line-added">1011           target-&gt;buffer;</span>
<span class="line-added">1012         unsigned char*  q =</span>
<span class="line-added">1013           buffer +</span>
<span class="line-added">1014           ( final_rows - y - target-&gt;rows ) * new_pitch +</span>
<span class="line-added">1015           x * 4;</span>
<span class="line-added">1016         unsigned char*  limit_p =</span>
<span class="line-added">1017           p + pitch * (int)target-&gt;rows;</span>
<span class="line-added">1018 </span>
<span class="line-added">1019 </span>
<span class="line-added">1020         while ( p &lt; limit_p )</span>
<span class="line-added">1021         {</span>
<span class="line-added">1022           FT_MEM_COPY( q, p, pitch );</span>
<span class="line-added">1023 </span>
<span class="line-added">1024           p += pitch;</span>
<span class="line-added">1025           q += new_pitch;</span>
<span class="line-added">1026         }</span>
<span class="line-added">1027       }</span>
<span class="line-added">1028 </span>
<span class="line-added">1029       FT_FREE( target-&gt;buffer );</span>
<span class="line-added">1030 </span>
<span class="line-added">1031       target-&gt;width = final_width;</span>
<span class="line-added">1032       target-&gt;rows  = final_rows;</span>
<span class="line-added">1033 </span>
<span class="line-added">1034       if ( target-&gt;pitch &lt; 0 )</span>
<span class="line-added">1035         target-&gt;pitch = -new_pitch;</span>
<span class="line-added">1036       else</span>
<span class="line-added">1037         target-&gt;pitch = new_pitch;</span>
<span class="line-added">1038 </span>
<span class="line-added">1039       target-&gt;buffer = buffer;</span>
<span class="line-added">1040     }</span>
<span class="line-added">1041 </span>
<span class="line-added">1042     /* adjust source bitmap if necessary */</span>
<span class="line-added">1043     if ( source_-&gt;pixel_mode != FT_PIXEL_MODE_GRAY )</span>
<span class="line-added">1044     {</span>
<span class="line-added">1045       FT_Bitmap_Init( &amp;source_bitmap );</span>
<span class="line-added">1046       error = FT_Bitmap_Convert( library, source_, &amp;source_bitmap, 1 );</span>
<span class="line-added">1047       if ( error )</span>
<span class="line-added">1048         goto Error;</span>
<span class="line-added">1049 </span>
<span class="line-added">1050       source             = &amp;source_bitmap;</span>
<span class="line-added">1051       free_source_bitmap = 1;</span>
<span class="line-added">1052     }</span>
<span class="line-added">1053     else</span>
<span class="line-added">1054       source = source_;</span>
<span class="line-added">1055 </span>
<span class="line-added">1056     /* do blending; the code below returns pre-multiplied channels, */</span>
<span class="line-added">1057     /* similar to what FreeType gets from `CBDT&#39; tables             */</span>
<span class="line-added">1058     x = source_llx &gt;&gt; 6;</span>
<span class="line-added">1059     y = source_lly &gt;&gt; 6;</span>
<span class="line-added">1060 </span>
<span class="line-added">1061     /* the bitmap flow is from top to bottom, */</span>
<span class="line-added">1062     /* but y is measured from bottom to top   */</span>
<span class="line-added">1063     if ( target-&gt;pitch &lt; 0 )</span>
<span class="line-added">1064     {</span>
<span class="line-added">1065       /* XXX */</span>
<span class="line-added">1066     }</span>
<span class="line-added">1067     else</span>
<span class="line-added">1068     {</span>
<span class="line-added">1069       unsigned char*  p =</span>
<span class="line-added">1070         source-&gt;buffer;</span>
<span class="line-added">1071       unsigned char*  q =</span>
<span class="line-added">1072         target-&gt;buffer +</span>
<span class="line-added">1073         ( target-&gt;rows - y - source-&gt;rows ) * target-&gt;pitch +</span>
<span class="line-added">1074         x * 4;</span>
<span class="line-added">1075       unsigned char*  limit_p =</span>
<span class="line-added">1076         p + source-&gt;pitch * (int)source-&gt;rows;</span>
<span class="line-added">1077 </span>
<span class="line-added">1078 </span>
<span class="line-added">1079       while ( p &lt; limit_p )</span>
<span class="line-added">1080       {</span>
<span class="line-added">1081         unsigned char*  r       = p;</span>
<span class="line-added">1082         unsigned char*  s       = q;</span>
<span class="line-added">1083         unsigned char*  limit_r = r + source-&gt;width;</span>
<span class="line-added">1084 </span>
<span class="line-added">1085 </span>
<span class="line-added">1086         while ( r &lt; limit_r )</span>
<span class="line-added">1087         {</span>
<span class="line-added">1088           int  aa = *r++;</span>
<span class="line-added">1089           int  fa = color.alpha * aa / 255;</span>
<span class="line-added">1090 </span>
<span class="line-added">1091           int  fb = color.blue * fa / 255;</span>
<span class="line-added">1092           int  fg = color.green * fa / 255;</span>
<span class="line-added">1093           int  fr = color.red * fa / 255;</span>
<span class="line-added">1094 </span>
<span class="line-added">1095           int  ba2 = 255 - fa;</span>
<span class="line-added">1096 </span>
<span class="line-added">1097           int  bb = s[0];</span>
<span class="line-added">1098           int  bg = s[1];</span>
<span class="line-added">1099           int  br = s[2];</span>
<span class="line-added">1100           int  ba = s[3];</span>
<span class="line-added">1101 </span>
<span class="line-added">1102 </span>
<span class="line-added">1103           *s++ = (unsigned char)( bb * ba2 / 255 + fb );</span>
<span class="line-added">1104           *s++ = (unsigned char)( bg * ba2 / 255 + fg );</span>
<span class="line-added">1105           *s++ = (unsigned char)( br * ba2 / 255 + fr );</span>
<span class="line-added">1106           *s++ = (unsigned char)( ba * ba2 / 255 + fa );</span>
<span class="line-added">1107         }</span>
<span class="line-added">1108 </span>
<span class="line-added">1109         p += source-&gt;pitch;</span>
<span class="line-added">1110         q += target-&gt;pitch;</span>
<span class="line-added">1111       }</span>
<span class="line-added">1112     }</span>
<span class="line-added">1113 </span>
<span class="line-added">1114     atarget_offset-&gt;x = final_llx;</span>
<span class="line-added">1115     atarget_offset-&gt;y = final_lly + ( final_rows &lt;&lt; 6 );</span>
<span class="line-added">1116 </span>
<span class="line-added">1117   Error:</span>
<span class="line-added">1118     if ( error &amp;&amp; free_target_bitmap_on_error )</span>
<span class="line-added">1119       FT_Bitmap_Done( library, target );</span>
<span class="line-added">1120 </span>
<span class="line-added">1121     if ( free_source_bitmap )</span>
<span class="line-added">1122       FT_Bitmap_Done( library, &amp;source_bitmap );</span>
<span class="line-added">1123 </span>
<span class="line-added">1124     return error;</span>
<span class="line-added">1125   }</span>
<span class="line-added">1126 </span>
<span class="line-added">1127 </span>
1128   /* documentation is in ftbitmap.h */
1129 
1130   FT_EXPORT_DEF( FT_Error )
1131   FT_GlyphSlot_Own_Bitmap( FT_GlyphSlot  slot )
1132   {
1133     if ( slot &amp;&amp; slot-&gt;format == FT_GLYPH_FORMAT_BITMAP   &amp;&amp;
1134          !( slot-&gt;internal-&gt;flags &amp; FT_GLYPH_OWN_BITMAP ) )
1135     {
1136       FT_Bitmap  bitmap;
1137       FT_Error   error;
1138 
1139 
1140       FT_Bitmap_Init( &amp;bitmap );
1141       error = FT_Bitmap_Copy( slot-&gt;library, &amp;slot-&gt;bitmap, &amp;bitmap );
1142       if ( error )
1143         return error;
1144 
1145       slot-&gt;bitmap = bitmap;
1146       slot-&gt;internal-&gt;flags |= FT_GLYPH_OWN_BITMAP;
1147     }
</pre>
</td>
</tr>
</table>
<center><a href="ftbbox.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftcalc.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>