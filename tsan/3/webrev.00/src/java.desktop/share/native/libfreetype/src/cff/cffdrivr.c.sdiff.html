<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/cff/cffdrivr.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="cffcmap.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cffdrivr.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/cff/cffdrivr.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 /***************************************************************************/</span>
<span class="line-modified">   2 /*                                                                         */</span>
<span class="line-modified">   3 /*  cffdrivr.c                                                             */</span>
<span class="line-modified">   4 /*                                                                         */</span>
<span class="line-modified">   5 /*    OpenType font driver implementation (body).                          */</span>
<span class="line-modified">   6 /*                                                                         */</span>
<span class="line-modified">   7 /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">   8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">   9 /*                                                                         */</span>
<span class="line-modified">  10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">  11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">  12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">  13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">  14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified">  15 /*                                                                         */</span>
<span class="line-modified">  16 /***************************************************************************/</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_FREETYPE_H
  21 #include FT_INTERNAL_DEBUG_H
  22 #include FT_INTERNAL_STREAM_H
  23 #include FT_INTERNAL_SFNT_H
  24 #include FT_INTERNAL_POSTSCRIPT_AUX_H
  25 #include FT_INTERNAL_POSTSCRIPT_PROPS_H
  26 #include FT_SERVICE_CID_H
  27 #include FT_SERVICE_POSTSCRIPT_INFO_H
  28 #include FT_SERVICE_POSTSCRIPT_NAME_H
  29 #include FT_SERVICE_TT_CMAP_H
  30 #include FT_SERVICE_CFF_TABLE_LOAD_H
  31 
  32 #include &quot;cffdrivr.h&quot;
  33 #include &quot;cffgload.h&quot;
  34 #include &quot;cffload.h&quot;
  35 #include &quot;cffcmap.h&quot;
  36 #include &quot;cffparse.h&quot;
  37 #include &quot;cffobjs.h&quot;
  38 
  39 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  40 #include FT_SERVICE_MULTIPLE_MASTERS_H
  41 #include FT_SERVICE_METRICS_VARIATIONS_H
  42 #endif
  43 
  44 #include &quot;cfferrs.h&quot;
<span class="line-removed">  45 #include &quot;cffpic.h&quot;</span>
  46 
  47 #include FT_SERVICE_FONT_FORMAT_H
  48 #include FT_SERVICE_GLYPH_DICT_H
  49 #include FT_SERVICE_PROPERTIES_H
  50 #include FT_DRIVER_H
  51 
  52 
<span class="line-modified">  53   /*************************************************************************/</span>
<span class="line-modified">  54   /*                                                                       */</span>
<span class="line-modified">  55   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified">  56   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified">  57   /* messages during execution.                                            */</span>
<span class="line-modified">  58   /*                                                                       */</span>
  59 #undef  FT_COMPONENT
<span class="line-modified">  60 #define FT_COMPONENT  trace_cffdriver</span>
  61 
  62 
  63   /*************************************************************************/
  64   /*************************************************************************/
  65   /*************************************************************************/
  66   /****                                                                 ****/
  67   /****                                                                 ****/
  68   /****                          F A C E S                              ****/
  69   /****                                                                 ****/
  70   /****                                                                 ****/
  71   /*************************************************************************/
  72   /*************************************************************************/
  73   /*************************************************************************/
  74 
  75 
<span class="line-modified">  76   /*************************************************************************/</span>
<span class="line-modified">  77   /*                                                                       */</span>
<span class="line-modified">  78   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">  79   /*    cff_get_kerning                                                    */</span>
<span class="line-modified">  80   /*                                                                       */</span>
<span class="line-modified">  81   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">  82   /*    A driver method used to return the kerning vector between two      */</span>
<span class="line-modified">  83   /*    glyphs of the same face.                                           */</span>
<span class="line-modified">  84   /*                                                                       */</span>
<span class="line-modified">  85   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">  86   /*    face        :: A handle to the source face object.                 */</span>
<span class="line-modified">  87   /*                                                                       */</span>
<span class="line-modified">  88   /*    left_glyph  :: The index of the left glyph in the kern pair.       */</span>
<span class="line-modified">  89   /*                                                                       */</span>
<span class="line-modified">  90   /*    right_glyph :: The index of the right glyph in the kern pair.      */</span>
<span class="line-modified">  91   /*                                                                       */</span>
<span class="line-modified">  92   /* &lt;Output&gt;                                                              */</span>
<span class="line-modified">  93   /*    kerning     :: The kerning vector.  This is in font units for      */</span>
<span class="line-modified">  94   /*                   scalable formats, and in pixels for fixed-sizes     */</span>
<span class="line-modified">  95   /*                   formats.                                            */</span>
<span class="line-modified">  96   /*                                                                       */</span>
<span class="line-modified">  97   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">  98   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">  99   /*                                                                       */</span>
<span class="line-modified"> 100   /* &lt;Note&gt;                                                                */</span>
<span class="line-modified"> 101   /*    Only horizontal layouts (left-to-right &amp; right-to-left) are        */</span>
<span class="line-modified"> 102   /*    supported by this function.  Other layouts, or more sophisticated  */</span>
<span class="line-modified"> 103   /*    kernings, are out of scope of this method (the basic driver        */</span>
<span class="line-modified"> 104   /*    interface is meant to be simple).                                  */</span>
<span class="line-modified"> 105   /*                                                                       */</span>
<span class="line-modified"> 106   /*    They can be implemented by format-specific interfaces.             */</span>
<span class="line-modified"> 107   /*                                                                       */</span>




 108   FT_CALLBACK_DEF( FT_Error )
 109   cff_get_kerning( FT_Face     ttface,          /* TT_Face */
 110                    FT_UInt     left_glyph,
 111                    FT_UInt     right_glyph,
 112                    FT_Vector*  kerning )
 113   {
 114     TT_Face       face = (TT_Face)ttface;
 115     SFNT_Service  sfnt = (SFNT_Service)face-&gt;sfnt;
 116 
 117 
 118     kerning-&gt;x = 0;
 119     kerning-&gt;y = 0;
 120 
 121     if ( sfnt )
 122       kerning-&gt;x = sfnt-&gt;get_kerning( face, left_glyph, right_glyph );
 123 
 124     return FT_Err_Ok;
 125   }
 126 
 127 
<span class="line-modified"> 128   /*************************************************************************/</span>
<span class="line-modified"> 129   /*                                                                       */</span>
<span class="line-modified"> 130   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 131   /*    cff_glyph_load                                                     */</span>
<span class="line-modified"> 132   /*                                                                       */</span>
<span class="line-modified"> 133   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 134   /*    A driver method used to load a glyph within a given glyph slot.    */</span>
<span class="line-modified"> 135   /*                                                                       */</span>
<span class="line-modified"> 136   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 137   /*    slot        :: A handle to the target slot object where the glyph  */</span>
<span class="line-modified"> 138   /*                   will be loaded.                                     */</span>
<span class="line-modified"> 139   /*                                                                       */</span>
<span class="line-modified"> 140   /*    size        :: A handle to the source face size at which the glyph */</span>
<span class="line-modified"> 141   /*                   must be scaled, loaded, etc.                        */</span>
<span class="line-modified"> 142   /*                                                                       */</span>
<span class="line-modified"> 143   /*    glyph_index :: The index of the glyph in the font file.            */</span>
<span class="line-modified"> 144   /*                                                                       */</span>
<span class="line-modified"> 145   /*    load_flags  :: A flag indicating what to load for this glyph.  The */</span>
<span class="line-modified"> 146   /*                   FT_LOAD_??? constants can be used to control the    */</span>
<span class="line-modified"> 147   /*                   glyph loading process (e.g., whether the outline    */</span>
<span class="line-modified"> 148   /*                   should be scaled, whether to load bitmaps or not,   */</span>
<span class="line-modified"> 149   /*                   whether to hint the outline, etc).                  */</span>
<span class="line-modified"> 150   /*                                                                       */</span>
<span class="line-modified"> 151   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 152   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 153   /*                                                                       */</span>




 154   FT_CALLBACK_DEF( FT_Error )
 155   cff_glyph_load( FT_GlyphSlot  cffslot,      /* CFF_GlyphSlot */
 156                   FT_Size       cffsize,      /* CFF_Size      */
 157                   FT_UInt       glyph_index,
 158                   FT_Int32      load_flags )
 159   {
 160     FT_Error       error;
 161     CFF_GlyphSlot  slot = (CFF_GlyphSlot)cffslot;
 162     CFF_Size       size = (CFF_Size)cffsize;
 163 
 164 
 165     if ( !slot )
 166       return FT_THROW( Invalid_Slot_Handle );
 167 
 168     FT_TRACE1(( &quot;cff_glyph_load: glyph index %d\n&quot;, glyph_index ));
 169 
 170     /* check whether we want a scaled outline or bitmap */
 171     if ( !size )
 172       load_flags |= FT_LOAD_NO_SCALE | FT_LOAD_NO_HINTING;
 173 
</pre>
<hr />
<pre>
 285 
 286   Missing_Table:
 287     flags |= (FT_UInt32)FT_LOAD_ADVANCE_ONLY;
 288 
 289     for ( nn = 0; nn &lt; count; nn++ )
 290     {
 291       error = cff_glyph_load( slot, face-&gt;size, start + nn, flags );
 292       if ( error )
 293         break;
 294 
 295       advances[nn] = ( flags &amp; FT_LOAD_VERTICAL_LAYOUT )
 296                      ? slot-&gt;linearVertAdvance
 297                      : slot-&gt;linearHoriAdvance;
 298     }
 299 
 300     return error;
 301   }
 302 
 303 
 304   /*
<span class="line-modified"> 305    *  GLYPH DICT SERVICE</span>
 306    *
 307    */
 308 
 309   static FT_Error
 310   cff_get_glyph_name( CFF_Face    face,
 311                       FT_UInt     glyph_index,
 312                       FT_Pointer  buffer,
 313                       FT_UInt     buffer_max )
 314   {
 315     CFF_Font    font   = (CFF_Font)face-&gt;extra.data;
 316     FT_String*  gname;
 317     FT_UShort   sid;
 318     FT_Error    error;
 319 
 320 
 321     /* CFF2 table does not have glyph names; */
 322     /* we need to use `post&#39; table method    */
 323     if ( font-&gt;version_major == 2 )
 324     {
 325       FT_Library            library     = FT_FACE_LIBRARY( face );
 326       FT_Module             sfnt_module = FT_Get_Module( library, &quot;sfnt&quot; );
 327       FT_Service_GlyphDict  service     =
 328         (FT_Service_GlyphDict)ft_module_get_service(
 329                                  sfnt_module,
 330                                  FT_SERVICE_ID_GLYPH_DICT,
 331                                  0 );
 332 
 333 
 334       if ( service &amp;&amp; service-&gt;get_name )
 335         return service-&gt;get_name( FT_FACE( face ),
 336                                   glyph_index,
 337                                   buffer,
 338                                   buffer_max );
 339       else
 340       {
 341         FT_ERROR(( &quot;cff_get_glyph_name:&quot;
 342                    &quot; cannot get glyph name from a CFF2 font\n&quot;
 343                    &quot;                   &quot;
<span class="line-modified"> 344                    &quot; without the `PSNames&#39; module\n&quot; ));</span>
 345         error = FT_THROW( Missing_Module );
 346         goto Exit;
 347       }
 348     }
 349 
 350     if ( !font-&gt;psnames )
 351     {
 352       FT_ERROR(( &quot;cff_get_glyph_name:&quot;
 353                  &quot; cannot get glyph name from CFF &amp; CEF fonts\n&quot;
 354                  &quot;                   &quot;
<span class="line-modified"> 355                  &quot; without the `PSNames&#39; module\n&quot; ));</span>
 356       error = FT_THROW( Missing_Module );
 357       goto Exit;
 358     }
 359 
 360     /* first, locate the sid in the charset table */
 361     sid = font-&gt;charset.sids[glyph_index];
 362 
 363     /* now, lookup the name itself */
 364     gname = cff_index_get_sid_string( font, sid );
 365 
 366     if ( gname )
 367       FT_STRCPYN( buffer, gname, buffer_max );
 368 
 369     error = FT_Err_Ok;
 370 
 371   Exit:
 372     return error;
 373   }
 374 
 375 
 376   static FT_UInt
<span class="line-modified"> 377   cff_get_name_index( CFF_Face    face,</span>
<span class="line-modified"> 378                       FT_String*  glyph_name )</span>
 379   {
 380     CFF_Font            cff;
 381     CFF_Charset         charset;
 382     FT_Service_PsCMaps  psnames;
 383     FT_String*          name;
 384     FT_UShort           sid;
 385     FT_UInt             i;
 386 
 387 
 388     cff     = (CFF_FontRec *)face-&gt;extra.data;
 389     charset = &amp;cff-&gt;charset;
 390 
 391     /* CFF2 table does not have glyph names; */
 392     /* we need to use `post&#39; table method    */
 393     if ( cff-&gt;version_major == 2 )
 394     {
 395       FT_Library            library     = FT_FACE_LIBRARY( face );
 396       FT_Module             sfnt_module = FT_Get_Module( library, &quot;sfnt&quot; );
 397       FT_Service_GlyphDict  service     =
 398         (FT_Service_GlyphDict)ft_module_get_service(
 399                                  sfnt_module,
 400                                  FT_SERVICE_ID_GLYPH_DICT,
 401                                  0 );
 402 
 403 
 404       if ( service &amp;&amp; service-&gt;name_index )
 405         return service-&gt;name_index( FT_FACE( face ), glyph_name );
 406       else
 407       {
 408         FT_ERROR(( &quot;cff_get_name_index:&quot;
 409                    &quot; cannot get glyph index from a CFF2 font\n&quot;
 410                    &quot;                   &quot;
<span class="line-modified"> 411                    &quot; without the `PSNames&#39; module\n&quot; ));</span>
 412         return 0;
 413       }
 414     }
 415 
 416     FT_FACE_FIND_GLOBAL_SERVICE( face, psnames, POSTSCRIPT_CMAPS );
 417     if ( !psnames )
 418       return 0;
 419 
 420     for ( i = 0; i &lt; cff-&gt;num_glyphs; i++ )
 421     {
 422       sid = charset-&gt;sids[i];
 423 
 424       if ( sid &gt; 390 )
 425         name = cff_index_get_string( cff, sid - 391 );
 426       else
 427         name = (FT_String *)psnames-&gt;adobe_std_strings( sid );
 428 
 429       if ( !name )
 430         continue;
 431 
 432       if ( !ft_strcmp( glyph_name, name ) )
 433         return i;
 434     }
 435 
 436     return 0;
 437   }
 438 
 439 
 440   FT_DEFINE_SERVICE_GLYPHDICTREC(
 441     cff_service_glyph_dict,
 442 
 443     (FT_GlyphDict_GetNameFunc)  cff_get_glyph_name,      /* get_name   */
 444     (FT_GlyphDict_NameIndexFunc)cff_get_name_index       /* name_index */
 445   )
 446 
 447 
 448   /*
<span class="line-modified"> 449    *  POSTSCRIPT INFO SERVICE</span>
 450    *
 451    */
 452 
 453   static FT_Int
 454   cff_ps_has_glyph_names( FT_Face  face )
 455   {
 456     return ( face-&gt;face_flags &amp; FT_FACE_FLAG_GLYPH_NAMES ) &gt; 0;
 457   }
 458 
 459 
 460   static FT_Error
 461   cff_ps_get_font_info( CFF_Face         face,
 462                         PS_FontInfoRec*  afont_info )
 463   {
 464     CFF_Font  cff   = (CFF_Font)face-&gt;extra.data;
 465     FT_Error  error = FT_Err_Ok;
 466 
 467 
 468     if ( cff &amp;&amp; !cff-&gt;font_info )
 469     {
</pre>
<hr />
<pre>
 576 
 577   Fail:
 578     return error;
 579   }
 580 
 581 
 582   FT_DEFINE_SERVICE_PSINFOREC(
 583     cff_service_ps_info,
 584 
 585     (PS_GetFontInfoFunc)   cff_ps_get_font_info,    /* ps_get_font_info    */
 586     (PS_GetFontExtraFunc)  cff_ps_get_font_extra,   /* ps_get_font_extra   */
 587     (PS_HasGlyphNamesFunc) cff_ps_has_glyph_names,  /* ps_has_glyph_names  */
 588     /* unsupported with CFF fonts */
 589     (PS_GetFontPrivateFunc)NULL,                    /* ps_get_font_private */
 590     /* not implemented            */
 591     (PS_GetFontValueFunc)  NULL                     /* ps_get_font_value   */
 592   )
 593 
 594 
 595   /*
<span class="line-modified"> 596    *  POSTSCRIPT NAME SERVICE</span>
 597    *
 598    */
 599 
 600   static const char*
 601   cff_get_ps_name( CFF_Face  face )
 602   {
 603     CFF_Font      cff  = (CFF_Font)face-&gt;extra.data;
 604     SFNT_Service  sfnt = (SFNT_Service)face-&gt;sfnt;
 605 
 606 
 607     /* following the OpenType specification 1.7, we return the name stored */
 608     /* in the `name&#39; table for a CFF wrapped into an SFNT container        */
 609 
 610     if ( FT_IS_SFNT( FT_FACE( face ) ) &amp;&amp; sfnt )
 611     {
 612       FT_Library             library     = FT_FACE_LIBRARY( face );
 613       FT_Module              sfnt_module = FT_Get_Module( library, &quot;sfnt&quot; );
 614       FT_Service_PsFontName  service     =
 615         (FT_Service_PsFontName)ft_module_get_service(
 616                                  sfnt_module,
</pre>
<hr />
<pre>
 637    * TT CMAP INFO
 638    *
 639    * If the charmap is a synthetic Unicode encoding cmap or
 640    * a Type 1 standard (or expert) encoding cmap, hide TT CMAP INFO
 641    * service defined in SFNT module.
 642    *
 643    * Otherwise call the service function in the sfnt module.
 644    *
 645    */
 646   static FT_Error
 647   cff_get_cmap_info( FT_CharMap    charmap,
 648                      TT_CMapInfo  *cmap_info )
 649   {
 650     FT_CMap   cmap  = FT_CMAP( charmap );
 651     FT_Error  error = FT_Err_Ok;
 652 
 653     FT_Face     face    = FT_CMAP_FACE( cmap );
 654     FT_Library  library = FT_FACE_LIBRARY( face );
 655 
 656 
<span class="line-modified"> 657     if ( cmap-&gt;clazz != &amp;CFF_CMAP_ENCODING_CLASS_REC_GET &amp;&amp;</span>
<span class="line-modified"> 658          cmap-&gt;clazz != &amp;CFF_CMAP_UNICODE_CLASS_REC_GET  )</span>
 659     {
 660       FT_Module           sfnt    = FT_Get_Module( library, &quot;sfnt&quot; );
 661       FT_Service_TTCMaps  service =
 662         (FT_Service_TTCMaps)ft_module_get_service( sfnt,
 663                                                    FT_SERVICE_ID_TT_CMAP,
 664                                                    0 );
 665 
 666 
 667       if ( service &amp;&amp; service-&gt;get_cmap_info )
 668         error = service-&gt;get_cmap_info( charmap, cmap_info );
 669     }
 670     else
 671       error = FT_THROW( Invalid_CharMap_Format );
 672 
 673     return error;
 674   }
 675 
 676 
 677   FT_DEFINE_SERVICE_TTCMAPSREC(
 678     cff_service_get_cmap_info,
 679 
 680     (TT_CMap_Info_GetFunc)cff_get_cmap_info    /* get_cmap_info */
 681   )
 682 
 683 
 684   /*
<span class="line-modified"> 685    *  CID INFO SERVICE</span>
 686    *
 687    */
 688   static FT_Error
 689   cff_get_ros( CFF_Face      face,
 690                const char*  *registry,
 691                const char*  *ordering,
 692                FT_Int       *supplement )
 693   {
 694     FT_Error  error = FT_Err_Ok;
 695     CFF_Font  cff   = (CFF_Font)face-&gt;extra.data;
 696 
 697 
 698     if ( cff )
 699     {
 700       CFF_FontRecDict  dict = &amp;cff-&gt;top_font.font_dict;
 701 
 702 
 703       if ( dict-&gt;cid_registry == 0xFFFFU )
 704       {
 705         error = FT_THROW( Invalid_Argument );
</pre>
<hr />
<pre>
 771                                 FT_UInt  *cid )
 772   {
 773     FT_Error  error = FT_Err_Ok;
 774     CFF_Font  cff;
 775 
 776 
 777     cff = (CFF_Font)face-&gt;extra.data;
 778 
 779     if ( cff )
 780     {
 781       FT_UInt          c;
 782       CFF_FontRecDict  dict = &amp;cff-&gt;top_font.font_dict;
 783 
 784 
 785       if ( dict-&gt;cid_registry == 0xFFFFU )
 786       {
 787         error = FT_THROW( Invalid_Argument );
 788         goto Fail;
 789       }
 790 
<span class="line-modified"> 791       if ( glyph_index &gt; cff-&gt;num_glyphs )</span>
 792       {
 793         error = FT_THROW( Invalid_Argument );
 794         goto Fail;
 795       }
 796 
 797       c = cff-&gt;charset.sids[glyph_index];
 798 
 799       if ( cid )
 800         *cid = c;
 801     }
 802 
 803   Fail:
 804     return error;
 805   }
 806 
 807 
 808   FT_DEFINE_SERVICE_CIDREC(
 809     cff_service_cid_info,
 810 
 811     (FT_CID_GetRegistryOrderingSupplementFunc)
 812       cff_get_ros,                             /* get_ros                  */
 813     (FT_CID_GetIsInternallyCIDKeyedFunc)
 814       cff_get_is_cid,                          /* get_is_cid               */
 815     (FT_CID_GetCIDFromGlyphIndexFunc)
 816       cff_get_cid_from_glyph_index             /* get_cid_from_glyph_index */
 817   )
 818 
 819 
 820   /*
<span class="line-modified"> 821    *  PROPERTY SERVICE</span>
 822    *
 823    */
 824 
 825   FT_DEFINE_SERVICE_PROPERTIESREC(
 826     cff_service_properties,
 827 
 828     (FT_Properties_SetFunc)ps_property_set,      /* set_property */
 829     (FT_Properties_GetFunc)ps_property_get )     /* get_property */
 830 
 831 
 832 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
 833 
 834   /*
<span class="line-modified"> 835    *  MULTIPLE MASTER SERVICE</span>
 836    *
 837    */
 838 
 839   static FT_Error
 840   cff_set_mm_blend( CFF_Face   face,
 841                     FT_UInt    num_coords,
 842                     FT_Fixed*  coords )
 843   {
 844     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 845 
 846 
 847     return mm-&gt;set_mm_blend( FT_FACE( face ), num_coords, coords );
 848   }
 849 
 850 
 851   static FT_Error
 852   cff_get_mm_blend( CFF_Face   face,
 853                     FT_UInt    num_coords,
 854                     FT_Fixed*  coords )
 855   {
 856     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 857 
 858 
 859     return mm-&gt;get_mm_blend( FT_FACE( face ), num_coords, coords );
 860   }
 861 
 862 
























 863   static FT_Error
 864   cff_get_mm_var( CFF_Face     face,
 865                   FT_MM_Var*  *master )
 866   {
 867     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 868 
 869 
 870     return mm-&gt;get_mm_var( FT_FACE( face ), master );
 871   }
 872 
 873 
 874   static FT_Error
 875   cff_set_var_design( CFF_Face   face,
 876                       FT_UInt    num_coords,
 877                       FT_Fixed*  coords )
 878   {
 879     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 880 
 881 
 882     return mm-&gt;set_var_design( FT_FACE( face ), num_coords, coords );
</pre>
<hr />
<pre>
 892 
 893 
 894     return mm-&gt;get_var_design( FT_FACE( face ), num_coords, coords );
 895   }
 896 
 897 
 898   static FT_Error
 899   cff_set_instance( CFF_Face  face,
 900                     FT_UInt   instance_index )
 901   {
 902     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 903 
 904 
 905     return mm-&gt;set_instance( FT_FACE( face ), instance_index );
 906   }
 907 
 908 
 909   FT_DEFINE_SERVICE_MULTIMASTERSREC(
 910     cff_service_multi_masters,
 911 
<span class="line-modified"> 912     (FT_Get_MM_Func)        NULL,                   /* get_mm         */</span>
<span class="line-modified"> 913     (FT_Set_MM_Design_Func) NULL,                   /* set_mm_design  */</span>
<span class="line-modified"> 914     (FT_Set_MM_Blend_Func)  cff_set_mm_blend,       /* set_mm_blend   */</span>
<span class="line-modified"> 915     (FT_Get_MM_Blend_Func)  cff_get_mm_blend,       /* get_mm_blend   */</span>
<span class="line-modified"> 916     (FT_Get_MM_Var_Func)    cff_get_mm_var,         /* get_mm_var     */</span>
<span class="line-modified"> 917     (FT_Set_Var_Design_Func)cff_set_var_design,     /* set_var_design */</span>
<span class="line-modified"> 918     (FT_Get_Var_Design_Func)cff_get_var_design,     /* get_var_design */</span>
<span class="line-modified"> 919     (FT_Set_Instance_Func)  cff_set_instance,       /* set_instance   */</span>
<span class="line-modified"> 920 </span>
<span class="line-modified"> 921     (FT_Get_Var_Blend_Func) cff_get_var_blend,      /* get_var_blend  */</span>
<span class="line-modified"> 922     (FT_Done_Blend_Func)    cff_done_blend          /* done_blend     */</span>


 923   )
 924 
 925 
 926   /*
<span class="line-modified"> 927    *  METRICS VARIATIONS SERVICE</span>
 928    *
 929    */
 930 
 931   static FT_Error
 932   cff_hadvance_adjust( CFF_Face  face,
 933                        FT_UInt   gindex,
 934                        FT_Int   *avalue )
 935   {
 936     FT_Service_MetricsVariations  var = (FT_Service_MetricsVariations)face-&gt;var;
 937 
 938 
 939     return var-&gt;hadvance_adjust( FT_FACE( face ), gindex, avalue );
 940   }
 941 
 942 
 943   static void
 944   cff_metrics_adjust( CFF_Face  face )
 945   {
 946     FT_Service_MetricsVariations  var = (FT_Service_MetricsVariations)face-&gt;var;
 947 
</pre>
<hr />
<pre>
 951 
 952 
 953   FT_DEFINE_SERVICE_METRICSVARIATIONSREC(
 954     cff_service_metrics_variations,
 955 
 956     (FT_HAdvance_Adjust_Func)cff_hadvance_adjust,    /* hadvance_adjust */
 957     (FT_LSB_Adjust_Func)     NULL,                   /* lsb_adjust      */
 958     (FT_RSB_Adjust_Func)     NULL,                   /* rsb_adjust      */
 959 
 960     (FT_VAdvance_Adjust_Func)NULL,                   /* vadvance_adjust */
 961     (FT_TSB_Adjust_Func)     NULL,                   /* tsb_adjust      */
 962     (FT_BSB_Adjust_Func)     NULL,                   /* bsb_adjust      */
 963     (FT_VOrg_Adjust_Func)    NULL,                   /* vorg_adjust     */
 964 
 965     (FT_Metrics_Adjust_Func) cff_metrics_adjust      /* metrics_adjust  */
 966   )
 967 #endif
 968 
 969 
 970   /*
<span class="line-modified"> 971    *  CFFLOAD SERVICE</span>
 972    *
 973    */
 974 
 975   FT_DEFINE_SERVICE_CFFLOADREC(
 976     cff_service_cff_load,
 977 
 978     (FT_Get_Standard_Encoding_Func)cff_get_standard_encoding,
 979     (FT_Load_Private_Dict_Func)    cff_load_private_dict,
 980     (FT_FD_Select_Get_Func)        cff_fd_select_get,
 981     (FT_Blend_Check_Vector_Func)   cff_blend_check_vector,
 982     (FT_Blend_Build_Vector_Func)   cff_blend_build_vector
 983   )
 984 
 985 
 986   /*************************************************************************/
 987   /*************************************************************************/
 988   /*************************************************************************/
 989   /****                                                                 ****/
 990   /****                                                                 ****/
 991   /****                D R I V E R  I N T E R F A C E                   ****/
 992   /****                                                                 ****/
 993   /****                                                                 ****/
 994   /*************************************************************************/
 995   /*************************************************************************/
 996   /*************************************************************************/
 997 
 998 #if !defined FT_CONFIG_OPTION_NO_GLYPH_NAMES &amp;&amp; \
 999      defined TT_CONFIG_OPTION_GX_VAR_SUPPORT
1000   FT_DEFINE_SERVICEDESCREC10(
1001     cff_services,
1002 
1003     FT_SERVICE_ID_FONT_FORMAT,          FT_FONT_FORMAT_CFF,
<span class="line-modified">1004     FT_SERVICE_ID_MULTI_MASTERS,        &amp;CFF_SERVICE_MULTI_MASTERS_GET,</span>
<span class="line-modified">1005     FT_SERVICE_ID_METRICS_VARIATIONS,   &amp;CFF_SERVICE_METRICS_VAR_GET,</span>
<span class="line-modified">1006     FT_SERVICE_ID_POSTSCRIPT_INFO,      &amp;CFF_SERVICE_PS_INFO_GET,</span>
<span class="line-modified">1007     FT_SERVICE_ID_POSTSCRIPT_FONT_NAME, &amp;CFF_SERVICE_PS_NAME_GET,</span>
<span class="line-modified">1008     FT_SERVICE_ID_GLYPH_DICT,           &amp;CFF_SERVICE_GLYPH_DICT_GET,</span>
<span class="line-modified">1009     FT_SERVICE_ID_TT_CMAP,              &amp;CFF_SERVICE_GET_CMAP_INFO_GET,</span>
<span class="line-modified">1010     FT_SERVICE_ID_CID,                  &amp;CFF_SERVICE_CID_INFO_GET,</span>
<span class="line-modified">1011     FT_SERVICE_ID_PROPERTIES,           &amp;CFF_SERVICE_PROPERTIES_GET,</span>
<span class="line-modified">1012     FT_SERVICE_ID_CFF_LOAD,             &amp;CFF_SERVICE_CFF_LOAD_GET</span>
1013   )
1014 #elif !defined FT_CONFIG_OPTION_NO_GLYPH_NAMES
1015   FT_DEFINE_SERVICEDESCREC8(
1016     cff_services,
1017 
1018     FT_SERVICE_ID_FONT_FORMAT,          FT_FONT_FORMAT_CFF,
<span class="line-modified">1019     FT_SERVICE_ID_POSTSCRIPT_INFO,      &amp;CFF_SERVICE_PS_INFO_GET,</span>
<span class="line-modified">1020     FT_SERVICE_ID_POSTSCRIPT_FONT_NAME, &amp;CFF_SERVICE_PS_NAME_GET,</span>
<span class="line-modified">1021     FT_SERVICE_ID_GLYPH_DICT,           &amp;CFF_SERVICE_GLYPH_DICT_GET,</span>
<span class="line-modified">1022     FT_SERVICE_ID_TT_CMAP,              &amp;CFF_SERVICE_GET_CMAP_INFO_GET,</span>
<span class="line-modified">1023     FT_SERVICE_ID_CID,                  &amp;CFF_SERVICE_CID_INFO_GET,</span>
<span class="line-modified">1024     FT_SERVICE_ID_PROPERTIES,           &amp;CFF_SERVICE_PROPERTIES_GET,</span>
<span class="line-modified">1025     FT_SERVICE_ID_CFF_LOAD,             &amp;CFF_SERVICE_CFF_LOAD_GET</span>
1026   )
1027 #elif defined TT_CONFIG_OPTION_GX_VAR_SUPPORT
1028   FT_DEFINE_SERVICEDESCREC9(
1029     cff_services,
1030 
1031     FT_SERVICE_ID_FONT_FORMAT,          FT_FONT_FORMAT_CFF,
<span class="line-modified">1032     FT_SERVICE_ID_MULTI_MASTERS,        &amp;CFF_SERVICE_MULTI_MASTERS_GET,</span>
<span class="line-modified">1033     FT_SERVICE_ID_METRICS_VARIATIONS,   &amp;CFF_SERVICE_METRICS_VAR_GET,</span>
<span class="line-modified">1034     FT_SERVICE_ID_POSTSCRIPT_INFO,      &amp;CFF_SERVICE_PS_INFO_GET,</span>
<span class="line-modified">1035     FT_SERVICE_ID_POSTSCRIPT_FONT_NAME, &amp;CFF_SERVICE_PS_NAME_GET,</span>
<span class="line-modified">1036     FT_SERVICE_ID_TT_CMAP,              &amp;CFF_SERVICE_GET_CMAP_INFO_GET,</span>
<span class="line-modified">1037     FT_SERVICE_ID_CID,                  &amp;CFF_SERVICE_CID_INFO_GET,</span>
<span class="line-modified">1038     FT_SERVICE_ID_PROPERTIES,           &amp;CFF_SERVICE_PROPERTIES_GET,</span>
<span class="line-modified">1039     FT_SERVICE_ID_CFF_LOAD,             &amp;CFF_SERVICE_CFF_LOAD_GET</span>
1040   )
1041 #else
1042   FT_DEFINE_SERVICEDESCREC7(
1043     cff_services,
1044 
1045     FT_SERVICE_ID_FONT_FORMAT,          FT_FONT_FORMAT_CFF,
<span class="line-modified">1046     FT_SERVICE_ID_POSTSCRIPT_INFO,      &amp;CFF_SERVICE_PS_INFO_GET,</span>
<span class="line-modified">1047     FT_SERVICE_ID_POSTSCRIPT_FONT_NAME, &amp;CFF_SERVICE_PS_NAME_GET,</span>
<span class="line-modified">1048     FT_SERVICE_ID_TT_CMAP,              &amp;CFF_SERVICE_GET_CMAP_INFO_GET,</span>
<span class="line-modified">1049     FT_SERVICE_ID_CID,                  &amp;CFF_SERVICE_CID_INFO_GET,</span>
<span class="line-modified">1050     FT_SERVICE_ID_PROPERTIES,           &amp;CFF_SERVICE_PROPERTIES_GET,</span>
<span class="line-modified">1051     FT_SERVICE_ID_CFF_LOAD,             &amp;CFF_SERVICE_CFF_LOAD_GET</span>
1052   )
1053 #endif
1054 
1055 
1056   FT_CALLBACK_DEF( FT_Module_Interface )
1057   cff_get_interface( FT_Module    driver,       /* CFF_Driver */
1058                      const char*  module_interface )
1059   {
1060     FT_Library           library;
1061     FT_Module            sfnt;
1062     FT_Module_Interface  result;
1063 
1064 
<span class="line-modified">1065     /* CFF_SERVICES_GET dereferences `library&#39; in PIC mode */</span>
<span class="line-removed">1066 #ifdef FT_CONFIG_OPTION_PIC</span>
<span class="line-removed">1067     if ( !driver )</span>
<span class="line-removed">1068       return NULL;</span>
<span class="line-removed">1069     library = driver-&gt;library;</span>
<span class="line-removed">1070     if ( !library )</span>
<span class="line-removed">1071       return NULL;</span>
<span class="line-removed">1072 #endif</span>
<span class="line-removed">1073 </span>
<span class="line-removed">1074     result = ft_service_list_lookup( CFF_SERVICES_GET, module_interface );</span>
1075     if ( result )
1076       return result;
1077 
<span class="line-modified">1078     /* `driver&#39; is not yet evaluated in non-PIC mode */</span>
<span class="line-removed">1079 #ifndef FT_CONFIG_OPTION_PIC</span>
1080     if ( !driver )
1081       return NULL;
1082     library = driver-&gt;library;
1083     if ( !library )
1084       return NULL;
<span class="line-removed">1085 #endif</span>
1086 
1087     /* we pass our request to the `sfnt&#39; module */
1088     sfnt = FT_Get_Module( library, &quot;sfnt&quot; );
1089 
1090     return sfnt ? sfnt-&gt;clazz-&gt;get_interface( sfnt, module_interface ) : 0;
1091   }
1092 
1093 
1094   /* The FT_DriverInterface structure is defined in ftdriver.h. */
1095 
1096 #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
1097 #define CFF_SIZE_SELECT cff_size_select
1098 #else
1099 #define CFF_SIZE_SELECT 0
1100 #endif
1101 
1102   FT_DEFINE_DRIVER(
1103     cff_driver_class,
1104 
1105       FT_MODULE_FONT_DRIVER          |
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 /****************************************************************************</span>
<span class="line-modified">   2  *</span>
<span class="line-modified">   3  * cffdrivr.c</span>
<span class="line-modified">   4  *</span>
<span class="line-modified">   5  *   OpenType font driver implementation (body).</span>
<span class="line-modified">   6  *</span>
<span class="line-modified">   7  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">   8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">   9  *</span>
<span class="line-modified">  10  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">  11  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">  12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">  13  * this file you indicate that you have read the license and</span>
<span class="line-modified">  14  * understand and accept it fully.</span>
<span class="line-modified">  15  *</span>
<span class="line-modified">  16  */</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 #include FT_FREETYPE_H
  21 #include FT_INTERNAL_DEBUG_H
  22 #include FT_INTERNAL_STREAM_H
  23 #include FT_INTERNAL_SFNT_H
  24 #include FT_INTERNAL_POSTSCRIPT_AUX_H
  25 #include FT_INTERNAL_POSTSCRIPT_PROPS_H
  26 #include FT_SERVICE_CID_H
  27 #include FT_SERVICE_POSTSCRIPT_INFO_H
  28 #include FT_SERVICE_POSTSCRIPT_NAME_H
  29 #include FT_SERVICE_TT_CMAP_H
  30 #include FT_SERVICE_CFF_TABLE_LOAD_H
  31 
  32 #include &quot;cffdrivr.h&quot;
  33 #include &quot;cffgload.h&quot;
  34 #include &quot;cffload.h&quot;
  35 #include &quot;cffcmap.h&quot;
  36 #include &quot;cffparse.h&quot;
  37 #include &quot;cffobjs.h&quot;
  38 
  39 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  40 #include FT_SERVICE_MULTIPLE_MASTERS_H
  41 #include FT_SERVICE_METRICS_VARIATIONS_H
  42 #endif
  43 
  44 #include &quot;cfferrs.h&quot;

  45 
  46 #include FT_SERVICE_FONT_FORMAT_H
  47 #include FT_SERVICE_GLYPH_DICT_H
  48 #include FT_SERVICE_PROPERTIES_H
  49 #include FT_DRIVER_H
  50 
  51 
<span class="line-modified">  52   /**************************************************************************</span>
<span class="line-modified">  53    *</span>
<span class="line-modified">  54    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified">  55    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified">  56    * messages during execution.</span>
<span class="line-modified">  57    */</span>
  58 #undef  FT_COMPONENT
<span class="line-modified">  59 #define FT_COMPONENT  cffdriver</span>
  60 
  61 
  62   /*************************************************************************/
  63   /*************************************************************************/
  64   /*************************************************************************/
  65   /****                                                                 ****/
  66   /****                                                                 ****/
  67   /****                          F A C E S                              ****/
  68   /****                                                                 ****/
  69   /****                                                                 ****/
  70   /*************************************************************************/
  71   /*************************************************************************/
  72   /*************************************************************************/
  73 
  74 
<span class="line-modified">  75   /**************************************************************************</span>
<span class="line-modified">  76    *</span>
<span class="line-modified">  77    * @Function:</span>
<span class="line-modified">  78    *   cff_get_kerning</span>
<span class="line-modified">  79    *</span>
<span class="line-modified">  80    * @Description:</span>
<span class="line-modified">  81    *   A driver method used to return the kerning vector between two</span>
<span class="line-modified">  82    *   glyphs of the same face.</span>
<span class="line-modified">  83    *</span>
<span class="line-modified">  84    * @Input:</span>
<span class="line-modified">  85    *   face ::</span>
<span class="line-modified">  86    *     A handle to the source face object.</span>
<span class="line-modified">  87    *</span>
<span class="line-modified">  88    *   left_glyph ::</span>
<span class="line-modified">  89    *     The index of the left glyph in the kern pair.</span>
<span class="line-modified">  90    *</span>
<span class="line-modified">  91    *   right_glyph ::</span>
<span class="line-modified">  92    *     The index of the right glyph in the kern pair.</span>
<span class="line-modified">  93    *</span>
<span class="line-modified">  94    * @Output:</span>
<span class="line-modified">  95    *   kerning ::</span>
<span class="line-modified">  96    *     The kerning vector.  This is in font units for</span>
<span class="line-modified">  97    *     scalable formats, and in pixels for fixed-sizes</span>
<span class="line-modified">  98    *     formats.</span>
<span class="line-modified">  99    *</span>
<span class="line-modified"> 100    * @Return:</span>
<span class="line-modified"> 101    *   FreeType error code.  0 means success.</span>
<span class="line-modified"> 102    *</span>
<span class="line-modified"> 103    * @Note:</span>
<span class="line-modified"> 104    *   Only horizontal layouts (left-to-right &amp; right-to-left) are</span>
<span class="line-modified"> 105    *   supported by this function.  Other layouts, or more sophisticated</span>
<span class="line-modified"> 106    *   kernings, are out of scope of this method (the basic driver</span>
<span class="line-added"> 107    *   interface is meant to be simple).</span>
<span class="line-added"> 108    *</span>
<span class="line-added"> 109    *   They can be implemented by format-specific interfaces.</span>
<span class="line-added"> 110    */</span>
 111   FT_CALLBACK_DEF( FT_Error )
 112   cff_get_kerning( FT_Face     ttface,          /* TT_Face */
 113                    FT_UInt     left_glyph,
 114                    FT_UInt     right_glyph,
 115                    FT_Vector*  kerning )
 116   {
 117     TT_Face       face = (TT_Face)ttface;
 118     SFNT_Service  sfnt = (SFNT_Service)face-&gt;sfnt;
 119 
 120 
 121     kerning-&gt;x = 0;
 122     kerning-&gt;y = 0;
 123 
 124     if ( sfnt )
 125       kerning-&gt;x = sfnt-&gt;get_kerning( face, left_glyph, right_glyph );
 126 
 127     return FT_Err_Ok;
 128   }
 129 
 130 
<span class="line-modified"> 131   /**************************************************************************</span>
<span class="line-modified"> 132    *</span>
<span class="line-modified"> 133    * @Function:</span>
<span class="line-modified"> 134    *   cff_glyph_load</span>
<span class="line-modified"> 135    *</span>
<span class="line-modified"> 136    * @Description:</span>
<span class="line-modified"> 137    *   A driver method used to load a glyph within a given glyph slot.</span>
<span class="line-modified"> 138    *</span>
<span class="line-modified"> 139    * @Input:</span>
<span class="line-modified"> 140    *   slot ::</span>
<span class="line-modified"> 141    *     A handle to the target slot object where the glyph</span>
<span class="line-modified"> 142    *     will be loaded.</span>
<span class="line-modified"> 143    *</span>
<span class="line-modified"> 144    *   size ::</span>
<span class="line-modified"> 145    *     A handle to the source face size at which the glyph</span>
<span class="line-modified"> 146    *     must be scaled, loaded, etc.</span>
<span class="line-modified"> 147    *</span>
<span class="line-modified"> 148    *   glyph_index ::</span>
<span class="line-modified"> 149    *     The index of the glyph in the font file.</span>
<span class="line-modified"> 150    *</span>
<span class="line-modified"> 151    *   load_flags ::</span>
<span class="line-modified"> 152    *     A flag indicating what to load for this glyph.  The</span>
<span class="line-modified"> 153    *     FT_LOAD_??? constants can be used to control the</span>
<span class="line-modified"> 154    *     glyph loading process (e.g., whether the outline</span>
<span class="line-modified"> 155    *     should be scaled, whether to load bitmaps or not,</span>
<span class="line-modified"> 156    *     whether to hint the outline, etc).</span>
<span class="line-added"> 157    *</span>
<span class="line-added"> 158    * @Return:</span>
<span class="line-added"> 159    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 160    */</span>
 161   FT_CALLBACK_DEF( FT_Error )
 162   cff_glyph_load( FT_GlyphSlot  cffslot,      /* CFF_GlyphSlot */
 163                   FT_Size       cffsize,      /* CFF_Size      */
 164                   FT_UInt       glyph_index,
 165                   FT_Int32      load_flags )
 166   {
 167     FT_Error       error;
 168     CFF_GlyphSlot  slot = (CFF_GlyphSlot)cffslot;
 169     CFF_Size       size = (CFF_Size)cffsize;
 170 
 171 
 172     if ( !slot )
 173       return FT_THROW( Invalid_Slot_Handle );
 174 
 175     FT_TRACE1(( &quot;cff_glyph_load: glyph index %d\n&quot;, glyph_index ));
 176 
 177     /* check whether we want a scaled outline or bitmap */
 178     if ( !size )
 179       load_flags |= FT_LOAD_NO_SCALE | FT_LOAD_NO_HINTING;
 180 
</pre>
<hr />
<pre>
 292 
 293   Missing_Table:
 294     flags |= (FT_UInt32)FT_LOAD_ADVANCE_ONLY;
 295 
 296     for ( nn = 0; nn &lt; count; nn++ )
 297     {
 298       error = cff_glyph_load( slot, face-&gt;size, start + nn, flags );
 299       if ( error )
 300         break;
 301 
 302       advances[nn] = ( flags &amp; FT_LOAD_VERTICAL_LAYOUT )
 303                      ? slot-&gt;linearVertAdvance
 304                      : slot-&gt;linearHoriAdvance;
 305     }
 306 
 307     return error;
 308   }
 309 
 310 
 311   /*
<span class="line-modified"> 312    * GLYPH DICT SERVICE</span>
 313    *
 314    */
 315 
 316   static FT_Error
 317   cff_get_glyph_name( CFF_Face    face,
 318                       FT_UInt     glyph_index,
 319                       FT_Pointer  buffer,
 320                       FT_UInt     buffer_max )
 321   {
 322     CFF_Font    font   = (CFF_Font)face-&gt;extra.data;
 323     FT_String*  gname;
 324     FT_UShort   sid;
 325     FT_Error    error;
 326 
 327 
 328     /* CFF2 table does not have glyph names; */
 329     /* we need to use `post&#39; table method    */
 330     if ( font-&gt;version_major == 2 )
 331     {
 332       FT_Library            library     = FT_FACE_LIBRARY( face );
 333       FT_Module             sfnt_module = FT_Get_Module( library, &quot;sfnt&quot; );
 334       FT_Service_GlyphDict  service     =
 335         (FT_Service_GlyphDict)ft_module_get_service(
 336                                  sfnt_module,
 337                                  FT_SERVICE_ID_GLYPH_DICT,
 338                                  0 );
 339 
 340 
 341       if ( service &amp;&amp; service-&gt;get_name )
 342         return service-&gt;get_name( FT_FACE( face ),
 343                                   glyph_index,
 344                                   buffer,
 345                                   buffer_max );
 346       else
 347       {
 348         FT_ERROR(( &quot;cff_get_glyph_name:&quot;
 349                    &quot; cannot get glyph name from a CFF2 font\n&quot;
 350                    &quot;                   &quot;
<span class="line-modified"> 351                    &quot; without the `psnames&#39; module\n&quot; ));</span>
 352         error = FT_THROW( Missing_Module );
 353         goto Exit;
 354       }
 355     }
 356 
 357     if ( !font-&gt;psnames )
 358     {
 359       FT_ERROR(( &quot;cff_get_glyph_name:&quot;
 360                  &quot; cannot get glyph name from CFF &amp; CEF fonts\n&quot;
 361                  &quot;                   &quot;
<span class="line-modified"> 362                  &quot; without the `psnames&#39; module\n&quot; ));</span>
 363       error = FT_THROW( Missing_Module );
 364       goto Exit;
 365     }
 366 
 367     /* first, locate the sid in the charset table */
 368     sid = font-&gt;charset.sids[glyph_index];
 369 
 370     /* now, lookup the name itself */
 371     gname = cff_index_get_sid_string( font, sid );
 372 
 373     if ( gname )
 374       FT_STRCPYN( buffer, gname, buffer_max );
 375 
 376     error = FT_Err_Ok;
 377 
 378   Exit:
 379     return error;
 380   }
 381 
 382 
 383   static FT_UInt
<span class="line-modified"> 384   cff_get_name_index( CFF_Face          face,</span>
<span class="line-modified"> 385                       const FT_String*  glyph_name )</span>
 386   {
 387     CFF_Font            cff;
 388     CFF_Charset         charset;
 389     FT_Service_PsCMaps  psnames;
 390     FT_String*          name;
 391     FT_UShort           sid;
 392     FT_UInt             i;
 393 
 394 
 395     cff     = (CFF_FontRec *)face-&gt;extra.data;
 396     charset = &amp;cff-&gt;charset;
 397 
 398     /* CFF2 table does not have glyph names; */
 399     /* we need to use `post&#39; table method    */
 400     if ( cff-&gt;version_major == 2 )
 401     {
 402       FT_Library            library     = FT_FACE_LIBRARY( face );
 403       FT_Module             sfnt_module = FT_Get_Module( library, &quot;sfnt&quot; );
 404       FT_Service_GlyphDict  service     =
 405         (FT_Service_GlyphDict)ft_module_get_service(
 406                                  sfnt_module,
 407                                  FT_SERVICE_ID_GLYPH_DICT,
 408                                  0 );
 409 
 410 
 411       if ( service &amp;&amp; service-&gt;name_index )
 412         return service-&gt;name_index( FT_FACE( face ), glyph_name );
 413       else
 414       {
 415         FT_ERROR(( &quot;cff_get_name_index:&quot;
 416                    &quot; cannot get glyph index from a CFF2 font\n&quot;
 417                    &quot;                   &quot;
<span class="line-modified"> 418                    &quot; without the `psnames&#39; module\n&quot; ));</span>
 419         return 0;
 420       }
 421     }
 422 
 423     FT_FACE_FIND_GLOBAL_SERVICE( face, psnames, POSTSCRIPT_CMAPS );
 424     if ( !psnames )
 425       return 0;
 426 
 427     for ( i = 0; i &lt; cff-&gt;num_glyphs; i++ )
 428     {
 429       sid = charset-&gt;sids[i];
 430 
 431       if ( sid &gt; 390 )
 432         name = cff_index_get_string( cff, sid - 391 );
 433       else
 434         name = (FT_String *)psnames-&gt;adobe_std_strings( sid );
 435 
 436       if ( !name )
 437         continue;
 438 
 439       if ( !ft_strcmp( glyph_name, name ) )
 440         return i;
 441     }
 442 
 443     return 0;
 444   }
 445 
 446 
 447   FT_DEFINE_SERVICE_GLYPHDICTREC(
 448     cff_service_glyph_dict,
 449 
 450     (FT_GlyphDict_GetNameFunc)  cff_get_glyph_name,      /* get_name   */
 451     (FT_GlyphDict_NameIndexFunc)cff_get_name_index       /* name_index */
 452   )
 453 
 454 
 455   /*
<span class="line-modified"> 456    * POSTSCRIPT INFO SERVICE</span>
 457    *
 458    */
 459 
 460   static FT_Int
 461   cff_ps_has_glyph_names( FT_Face  face )
 462   {
 463     return ( face-&gt;face_flags &amp; FT_FACE_FLAG_GLYPH_NAMES ) &gt; 0;
 464   }
 465 
 466 
 467   static FT_Error
 468   cff_ps_get_font_info( CFF_Face         face,
 469                         PS_FontInfoRec*  afont_info )
 470   {
 471     CFF_Font  cff   = (CFF_Font)face-&gt;extra.data;
 472     FT_Error  error = FT_Err_Ok;
 473 
 474 
 475     if ( cff &amp;&amp; !cff-&gt;font_info )
 476     {
</pre>
<hr />
<pre>
 583 
 584   Fail:
 585     return error;
 586   }
 587 
 588 
 589   FT_DEFINE_SERVICE_PSINFOREC(
 590     cff_service_ps_info,
 591 
 592     (PS_GetFontInfoFunc)   cff_ps_get_font_info,    /* ps_get_font_info    */
 593     (PS_GetFontExtraFunc)  cff_ps_get_font_extra,   /* ps_get_font_extra   */
 594     (PS_HasGlyphNamesFunc) cff_ps_has_glyph_names,  /* ps_has_glyph_names  */
 595     /* unsupported with CFF fonts */
 596     (PS_GetFontPrivateFunc)NULL,                    /* ps_get_font_private */
 597     /* not implemented            */
 598     (PS_GetFontValueFunc)  NULL                     /* ps_get_font_value   */
 599   )
 600 
 601 
 602   /*
<span class="line-modified"> 603    * POSTSCRIPT NAME SERVICE</span>
 604    *
 605    */
 606 
 607   static const char*
 608   cff_get_ps_name( CFF_Face  face )
 609   {
 610     CFF_Font      cff  = (CFF_Font)face-&gt;extra.data;
 611     SFNT_Service  sfnt = (SFNT_Service)face-&gt;sfnt;
 612 
 613 
 614     /* following the OpenType specification 1.7, we return the name stored */
 615     /* in the `name&#39; table for a CFF wrapped into an SFNT container        */
 616 
 617     if ( FT_IS_SFNT( FT_FACE( face ) ) &amp;&amp; sfnt )
 618     {
 619       FT_Library             library     = FT_FACE_LIBRARY( face );
 620       FT_Module              sfnt_module = FT_Get_Module( library, &quot;sfnt&quot; );
 621       FT_Service_PsFontName  service     =
 622         (FT_Service_PsFontName)ft_module_get_service(
 623                                  sfnt_module,
</pre>
<hr />
<pre>
 644    * TT CMAP INFO
 645    *
 646    * If the charmap is a synthetic Unicode encoding cmap or
 647    * a Type 1 standard (or expert) encoding cmap, hide TT CMAP INFO
 648    * service defined in SFNT module.
 649    *
 650    * Otherwise call the service function in the sfnt module.
 651    *
 652    */
 653   static FT_Error
 654   cff_get_cmap_info( FT_CharMap    charmap,
 655                      TT_CMapInfo  *cmap_info )
 656   {
 657     FT_CMap   cmap  = FT_CMAP( charmap );
 658     FT_Error  error = FT_Err_Ok;
 659 
 660     FT_Face     face    = FT_CMAP_FACE( cmap );
 661     FT_Library  library = FT_FACE_LIBRARY( face );
 662 
 663 
<span class="line-modified"> 664     if ( cmap-&gt;clazz != &amp;cff_cmap_encoding_class_rec &amp;&amp;</span>
<span class="line-modified"> 665          cmap-&gt;clazz != &amp;cff_cmap_unicode_class_rec  )</span>
 666     {
 667       FT_Module           sfnt    = FT_Get_Module( library, &quot;sfnt&quot; );
 668       FT_Service_TTCMaps  service =
 669         (FT_Service_TTCMaps)ft_module_get_service( sfnt,
 670                                                    FT_SERVICE_ID_TT_CMAP,
 671                                                    0 );
 672 
 673 
 674       if ( service &amp;&amp; service-&gt;get_cmap_info )
 675         error = service-&gt;get_cmap_info( charmap, cmap_info );
 676     }
 677     else
 678       error = FT_THROW( Invalid_CharMap_Format );
 679 
 680     return error;
 681   }
 682 
 683 
 684   FT_DEFINE_SERVICE_TTCMAPSREC(
 685     cff_service_get_cmap_info,
 686 
 687     (TT_CMap_Info_GetFunc)cff_get_cmap_info    /* get_cmap_info */
 688   )
 689 
 690 
 691   /*
<span class="line-modified"> 692    * CID INFO SERVICE</span>
 693    *
 694    */
 695   static FT_Error
 696   cff_get_ros( CFF_Face      face,
 697                const char*  *registry,
 698                const char*  *ordering,
 699                FT_Int       *supplement )
 700   {
 701     FT_Error  error = FT_Err_Ok;
 702     CFF_Font  cff   = (CFF_Font)face-&gt;extra.data;
 703 
 704 
 705     if ( cff )
 706     {
 707       CFF_FontRecDict  dict = &amp;cff-&gt;top_font.font_dict;
 708 
 709 
 710       if ( dict-&gt;cid_registry == 0xFFFFU )
 711       {
 712         error = FT_THROW( Invalid_Argument );
</pre>
<hr />
<pre>
 778                                 FT_UInt  *cid )
 779   {
 780     FT_Error  error = FT_Err_Ok;
 781     CFF_Font  cff;
 782 
 783 
 784     cff = (CFF_Font)face-&gt;extra.data;
 785 
 786     if ( cff )
 787     {
 788       FT_UInt          c;
 789       CFF_FontRecDict  dict = &amp;cff-&gt;top_font.font_dict;
 790 
 791 
 792       if ( dict-&gt;cid_registry == 0xFFFFU )
 793       {
 794         error = FT_THROW( Invalid_Argument );
 795         goto Fail;
 796       }
 797 
<span class="line-modified"> 798       if ( glyph_index &gt;= cff-&gt;num_glyphs )</span>
 799       {
 800         error = FT_THROW( Invalid_Argument );
 801         goto Fail;
 802       }
 803 
 804       c = cff-&gt;charset.sids[glyph_index];
 805 
 806       if ( cid )
 807         *cid = c;
 808     }
 809 
 810   Fail:
 811     return error;
 812   }
 813 
 814 
 815   FT_DEFINE_SERVICE_CIDREC(
 816     cff_service_cid_info,
 817 
 818     (FT_CID_GetRegistryOrderingSupplementFunc)
 819       cff_get_ros,                             /* get_ros                  */
 820     (FT_CID_GetIsInternallyCIDKeyedFunc)
 821       cff_get_is_cid,                          /* get_is_cid               */
 822     (FT_CID_GetCIDFromGlyphIndexFunc)
 823       cff_get_cid_from_glyph_index             /* get_cid_from_glyph_index */
 824   )
 825 
 826 
 827   /*
<span class="line-modified"> 828    * PROPERTY SERVICE</span>
 829    *
 830    */
 831 
 832   FT_DEFINE_SERVICE_PROPERTIESREC(
 833     cff_service_properties,
 834 
 835     (FT_Properties_SetFunc)ps_property_set,      /* set_property */
 836     (FT_Properties_GetFunc)ps_property_get )     /* get_property */
 837 
 838 
 839 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
 840 
 841   /*
<span class="line-modified"> 842    * MULTIPLE MASTER SERVICE</span>
 843    *
 844    */
 845 
 846   static FT_Error
 847   cff_set_mm_blend( CFF_Face   face,
 848                     FT_UInt    num_coords,
 849                     FT_Fixed*  coords )
 850   {
 851     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 852 
 853 
 854     return mm-&gt;set_mm_blend( FT_FACE( face ), num_coords, coords );
 855   }
 856 
 857 
 858   static FT_Error
 859   cff_get_mm_blend( CFF_Face   face,
 860                     FT_UInt    num_coords,
 861                     FT_Fixed*  coords )
 862   {
 863     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 864 
 865 
 866     return mm-&gt;get_mm_blend( FT_FACE( face ), num_coords, coords );
 867   }
 868 
 869 
<span class="line-added"> 870   static FT_Error</span>
<span class="line-added"> 871   cff_set_mm_weightvector( CFF_Face   face,</span>
<span class="line-added"> 872                            FT_UInt    len,</span>
<span class="line-added"> 873                            FT_Fixed*  weightvector )</span>
<span class="line-added"> 874   {</span>
<span class="line-added"> 875     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;</span>
<span class="line-added"> 876 </span>
<span class="line-added"> 877 </span>
<span class="line-added"> 878     return mm-&gt;set_mm_weightvector( FT_FACE( face ), len, weightvector );</span>
<span class="line-added"> 879   }</span>
<span class="line-added"> 880 </span>
<span class="line-added"> 881 </span>
<span class="line-added"> 882   static FT_Error</span>
<span class="line-added"> 883   cff_get_mm_weightvector( CFF_Face   face,</span>
<span class="line-added"> 884                            FT_UInt*   len,</span>
<span class="line-added"> 885                            FT_Fixed*  weightvector )</span>
<span class="line-added"> 886   {</span>
<span class="line-added"> 887     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;</span>
<span class="line-added"> 888 </span>
<span class="line-added"> 889 </span>
<span class="line-added"> 890     return mm-&gt;get_mm_weightvector( FT_FACE( face ), len, weightvector );</span>
<span class="line-added"> 891   }</span>
<span class="line-added"> 892 </span>
<span class="line-added"> 893 </span>
 894   static FT_Error
 895   cff_get_mm_var( CFF_Face     face,
 896                   FT_MM_Var*  *master )
 897   {
 898     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 899 
 900 
 901     return mm-&gt;get_mm_var( FT_FACE( face ), master );
 902   }
 903 
 904 
 905   static FT_Error
 906   cff_set_var_design( CFF_Face   face,
 907                       FT_UInt    num_coords,
 908                       FT_Fixed*  coords )
 909   {
 910     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 911 
 912 
 913     return mm-&gt;set_var_design( FT_FACE( face ), num_coords, coords );
</pre>
<hr />
<pre>
 923 
 924 
 925     return mm-&gt;get_var_design( FT_FACE( face ), num_coords, coords );
 926   }
 927 
 928 
 929   static FT_Error
 930   cff_set_instance( CFF_Face  face,
 931                     FT_UInt   instance_index )
 932   {
 933     FT_Service_MultiMasters  mm = (FT_Service_MultiMasters)face-&gt;mm;
 934 
 935 
 936     return mm-&gt;set_instance( FT_FACE( face ), instance_index );
 937   }
 938 
 939 
 940   FT_DEFINE_SERVICE_MULTIMASTERSREC(
 941     cff_service_multi_masters,
 942 
<span class="line-modified"> 943     (FT_Get_MM_Func)             NULL,                    /* get_mm              */</span>
<span class="line-modified"> 944     (FT_Set_MM_Design_Func)      NULL,                    /* set_mm_design       */</span>
<span class="line-modified"> 945     (FT_Set_MM_Blend_Func)       cff_set_mm_blend,        /* set_mm_blend        */</span>
<span class="line-modified"> 946     (FT_Get_MM_Blend_Func)       cff_get_mm_blend,        /* get_mm_blend        */</span>
<span class="line-modified"> 947     (FT_Get_MM_Var_Func)         cff_get_mm_var,          /* get_mm_var          */</span>
<span class="line-modified"> 948     (FT_Set_Var_Design_Func)     cff_set_var_design,      /* set_var_design      */</span>
<span class="line-modified"> 949     (FT_Get_Var_Design_Func)     cff_get_var_design,      /* get_var_design      */</span>
<span class="line-modified"> 950     (FT_Set_Instance_Func)       cff_set_instance,        /* set_instance        */</span>
<span class="line-modified"> 951     (FT_Set_MM_WeightVector_Func)cff_set_mm_weightvector, /* set_mm_weightvector */</span>
<span class="line-modified"> 952     (FT_Get_MM_WeightVector_Func)cff_get_mm_weightvector, /* get_mm_weightvector */</span>
<span class="line-modified"> 953 </span>
<span class="line-added"> 954     (FT_Get_Var_Blend_Func)      cff_get_var_blend,       /* get_var_blend       */</span>
<span class="line-added"> 955     (FT_Done_Blend_Func)         cff_done_blend           /* done_blend          */</span>
 956   )
 957 
 958 
 959   /*
<span class="line-modified"> 960    * METRICS VARIATIONS SERVICE</span>
 961    *
 962    */
 963 
 964   static FT_Error
 965   cff_hadvance_adjust( CFF_Face  face,
 966                        FT_UInt   gindex,
 967                        FT_Int   *avalue )
 968   {
 969     FT_Service_MetricsVariations  var = (FT_Service_MetricsVariations)face-&gt;var;
 970 
 971 
 972     return var-&gt;hadvance_adjust( FT_FACE( face ), gindex, avalue );
 973   }
 974 
 975 
 976   static void
 977   cff_metrics_adjust( CFF_Face  face )
 978   {
 979     FT_Service_MetricsVariations  var = (FT_Service_MetricsVariations)face-&gt;var;
 980 
</pre>
<hr />
<pre>
 984 
 985 
 986   FT_DEFINE_SERVICE_METRICSVARIATIONSREC(
 987     cff_service_metrics_variations,
 988 
 989     (FT_HAdvance_Adjust_Func)cff_hadvance_adjust,    /* hadvance_adjust */
 990     (FT_LSB_Adjust_Func)     NULL,                   /* lsb_adjust      */
 991     (FT_RSB_Adjust_Func)     NULL,                   /* rsb_adjust      */
 992 
 993     (FT_VAdvance_Adjust_Func)NULL,                   /* vadvance_adjust */
 994     (FT_TSB_Adjust_Func)     NULL,                   /* tsb_adjust      */
 995     (FT_BSB_Adjust_Func)     NULL,                   /* bsb_adjust      */
 996     (FT_VOrg_Adjust_Func)    NULL,                   /* vorg_adjust     */
 997 
 998     (FT_Metrics_Adjust_Func) cff_metrics_adjust      /* metrics_adjust  */
 999   )
1000 #endif
1001 
1002 
1003   /*
<span class="line-modified">1004    * CFFLOAD SERVICE</span>
1005    *
1006    */
1007 
1008   FT_DEFINE_SERVICE_CFFLOADREC(
1009     cff_service_cff_load,
1010 
1011     (FT_Get_Standard_Encoding_Func)cff_get_standard_encoding,
1012     (FT_Load_Private_Dict_Func)    cff_load_private_dict,
1013     (FT_FD_Select_Get_Func)        cff_fd_select_get,
1014     (FT_Blend_Check_Vector_Func)   cff_blend_check_vector,
1015     (FT_Blend_Build_Vector_Func)   cff_blend_build_vector
1016   )
1017 
1018 
1019   /*************************************************************************/
1020   /*************************************************************************/
1021   /*************************************************************************/
1022   /****                                                                 ****/
1023   /****                                                                 ****/
1024   /****                D R I V E R  I N T E R F A C E                   ****/
1025   /****                                                                 ****/
1026   /****                                                                 ****/
1027   /*************************************************************************/
1028   /*************************************************************************/
1029   /*************************************************************************/
1030 
1031 #if !defined FT_CONFIG_OPTION_NO_GLYPH_NAMES &amp;&amp; \
1032      defined TT_CONFIG_OPTION_GX_VAR_SUPPORT
1033   FT_DEFINE_SERVICEDESCREC10(
1034     cff_services,
1035 
1036     FT_SERVICE_ID_FONT_FORMAT,          FT_FONT_FORMAT_CFF,
<span class="line-modified">1037     FT_SERVICE_ID_MULTI_MASTERS,        &amp;cff_service_multi_masters,</span>
<span class="line-modified">1038     FT_SERVICE_ID_METRICS_VARIATIONS,   &amp;cff_service_metrics_variations,</span>
<span class="line-modified">1039     FT_SERVICE_ID_POSTSCRIPT_INFO,      &amp;cff_service_ps_info,</span>
<span class="line-modified">1040     FT_SERVICE_ID_POSTSCRIPT_FONT_NAME, &amp;cff_service_ps_name,</span>
<span class="line-modified">1041     FT_SERVICE_ID_GLYPH_DICT,           &amp;cff_service_glyph_dict,</span>
<span class="line-modified">1042     FT_SERVICE_ID_TT_CMAP,              &amp;cff_service_get_cmap_info,</span>
<span class="line-modified">1043     FT_SERVICE_ID_CID,                  &amp;cff_service_cid_info,</span>
<span class="line-modified">1044     FT_SERVICE_ID_PROPERTIES,           &amp;cff_service_properties,</span>
<span class="line-modified">1045     FT_SERVICE_ID_CFF_LOAD,             &amp;cff_service_cff_load</span>
1046   )
1047 #elif !defined FT_CONFIG_OPTION_NO_GLYPH_NAMES
1048   FT_DEFINE_SERVICEDESCREC8(
1049     cff_services,
1050 
1051     FT_SERVICE_ID_FONT_FORMAT,          FT_FONT_FORMAT_CFF,
<span class="line-modified">1052     FT_SERVICE_ID_POSTSCRIPT_INFO,      &amp;cff_service_ps_info,</span>
<span class="line-modified">1053     FT_SERVICE_ID_POSTSCRIPT_FONT_NAME, &amp;cff_service_ps_name,</span>
<span class="line-modified">1054     FT_SERVICE_ID_GLYPH_DICT,           &amp;cff_service_glyph_dict,</span>
<span class="line-modified">1055     FT_SERVICE_ID_TT_CMAP,              &amp;cff_service_get_cmap_info,</span>
<span class="line-modified">1056     FT_SERVICE_ID_CID,                  &amp;cff_service_cid_info,</span>
<span class="line-modified">1057     FT_SERVICE_ID_PROPERTIES,           &amp;cff_service_properties,</span>
<span class="line-modified">1058     FT_SERVICE_ID_CFF_LOAD,             &amp;cff_service_cff_load</span>
1059   )
1060 #elif defined TT_CONFIG_OPTION_GX_VAR_SUPPORT
1061   FT_DEFINE_SERVICEDESCREC9(
1062     cff_services,
1063 
1064     FT_SERVICE_ID_FONT_FORMAT,          FT_FONT_FORMAT_CFF,
<span class="line-modified">1065     FT_SERVICE_ID_MULTI_MASTERS,        &amp;cff_service_multi_masters,</span>
<span class="line-modified">1066     FT_SERVICE_ID_METRICS_VARIATIONS,   &amp;cff_service_metrics_var,</span>
<span class="line-modified">1067     FT_SERVICE_ID_POSTSCRIPT_INFO,      &amp;cff_service_ps_info,</span>
<span class="line-modified">1068     FT_SERVICE_ID_POSTSCRIPT_FONT_NAME, &amp;cff_service_ps_name,</span>
<span class="line-modified">1069     FT_SERVICE_ID_TT_CMAP,              &amp;cff_service_get_cmap_info,</span>
<span class="line-modified">1070     FT_SERVICE_ID_CID,                  &amp;cff_service_cid_info,</span>
<span class="line-modified">1071     FT_SERVICE_ID_PROPERTIES,           &amp;cff_service_properties,</span>
<span class="line-modified">1072     FT_SERVICE_ID_CFF_LOAD,             &amp;cff_service_cff_load</span>
1073   )
1074 #else
1075   FT_DEFINE_SERVICEDESCREC7(
1076     cff_services,
1077 
1078     FT_SERVICE_ID_FONT_FORMAT,          FT_FONT_FORMAT_CFF,
<span class="line-modified">1079     FT_SERVICE_ID_POSTSCRIPT_INFO,      &amp;cff_service_ps_info,</span>
<span class="line-modified">1080     FT_SERVICE_ID_POSTSCRIPT_FONT_NAME, &amp;cff_service_ps_name,</span>
<span class="line-modified">1081     FT_SERVICE_ID_TT_CMAP,              &amp;cff_service_get_cmap_info,</span>
<span class="line-modified">1082     FT_SERVICE_ID_CID,                  &amp;cff_service_cid_info,</span>
<span class="line-modified">1083     FT_SERVICE_ID_PROPERTIES,           &amp;cff_service_properties,</span>
<span class="line-modified">1084     FT_SERVICE_ID_CFF_LOAD,             &amp;cff_service_cff_load</span>
1085   )
1086 #endif
1087 
1088 
1089   FT_CALLBACK_DEF( FT_Module_Interface )
1090   cff_get_interface( FT_Module    driver,       /* CFF_Driver */
1091                      const char*  module_interface )
1092   {
1093     FT_Library           library;
1094     FT_Module            sfnt;
1095     FT_Module_Interface  result;
1096 
1097 
<span class="line-modified">1098     result = ft_service_list_lookup( cff_services, module_interface );</span>









1099     if ( result )
1100       return result;
1101 
<span class="line-modified">1102     /* `driver&#39; is not yet evaluated */</span>

1103     if ( !driver )
1104       return NULL;
1105     library = driver-&gt;library;
1106     if ( !library )
1107       return NULL;

1108 
1109     /* we pass our request to the `sfnt&#39; module */
1110     sfnt = FT_Get_Module( library, &quot;sfnt&quot; );
1111 
1112     return sfnt ? sfnt-&gt;clazz-&gt;get_interface( sfnt, module_interface ) : 0;
1113   }
1114 
1115 
1116   /* The FT_DriverInterface structure is defined in ftdriver.h. */
1117 
1118 #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
1119 #define CFF_SIZE_SELECT cff_size_select
1120 #else
1121 #define CFF_SIZE_SELECT 0
1122 #endif
1123 
1124   FT_DEFINE_DRIVER(
1125     cff_driver_class,
1126 
1127       FT_MODULE_FONT_DRIVER          |
</pre>
</td>
</tr>
</table>
<center><a href="cffcmap.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cffdrivr.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>