<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfreetype/src/base/ftcalc.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ftbitmap.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftcid.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/base/ftcalc.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,37 +1,37 @@</span>
<span class="udiff-line-modified-removed">- /***************************************************************************/</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  ftcalc.c                                                               */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*    Arithmetic computations (body).                                      */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  Copyright 1996-2018 by                                                 */</span>
<span class="udiff-line-modified-removed">- /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="udiff-line-modified-removed">- /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="udiff-line-modified-removed">- /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="udiff-line-modified-removed">- /*  this file you indicate that you have read the license and              */</span>
<span class="udiff-line-modified-removed">- /*  understand and accept it fully.                                        */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /***************************************************************************/</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* Support for 1-complement arithmetic has been totally dropped in this  */</span>
<span class="udiff-line-modified-removed">-   /* release.  You can still write your own code if you need it.           */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* Implementing basic computation routines.                              */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* FT_MulDiv(), FT_MulFix(), FT_DivFix(), FT_RoundFix(), FT_CeilFix(),   */</span>
<span class="udiff-line-modified-removed">-   /* and FT_FloorFix() are declared in freetype.h.                         */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-added">+ /****************************************************************************</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * ftcalc.c</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  *   Arithmetic computations (body).</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 1996-2019 by</span>
<span class="udiff-line-modified-added">+  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * This file is part of the FreeType project, and may only be used,</span>
<span class="udiff-line-modified-added">+  * modified, and distributed under the terms of the FreeType project</span>
<span class="udiff-line-modified-added">+  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="udiff-line-modified-added">+  * this file you indicate that you have read the license and</span>
<span class="udiff-line-modified-added">+  * understand and accept it fully.</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  */</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * Support for 1-complement arithmetic has been totally dropped in this</span>
<span class="udiff-line-modified-added">+    * release.  You can still write your own code if you need it.</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    */</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * Implementing basic computation routines.</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * FT_MulDiv(), FT_MulFix(), FT_DivFix(), FT_RoundFix(), FT_CeilFix(),</span>
<span class="udiff-line-modified-added">+    * and FT_FloorFix() are declared in freetype.h.</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    */</span>
  
  
  #include &lt;ft2build.h&gt;
  #include FT_GLYPH_H
  #include FT_TRIGONOMETRY_H
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -56,18 +56,18 @@</span>
    } FT_Int64;
  
  #endif /* !FT_LONG64 */
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="udiff-line-modified-removed">-   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="udiff-line-modified-removed">-   /* messages during execution.                                            */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="udiff-line-modified-added">+    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="udiff-line-modified-added">+    * messages during execution.</span>
<span class="udiff-line-modified-added">+    */</span>
  #undef  FT_COMPONENT
<span class="udiff-line-modified-removed">- #define FT_COMPONENT  trace_calc</span>
<span class="udiff-line-modified-added">+ #define FT_COMPONENT  calc</span>
  
  
    /* transfer sign, leaving a positive number;                        */
    /* we need an unsigned value to safely negate INT_MIN (or LONG_MIN) */
  #define FT_MOVE_SIGN( x, x_unsigned, s ) \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -514,37 +514,37 @@</span>
      return FT_MULFIX_ASSEMBLER( a_, b_ );
  
  #elif 0
  
      /*
<span class="udiff-line-modified-removed">-      *  This code is nonportable.  See comment below.</span>
<span class="udiff-line-modified-added">+      * This code is nonportable.  See comment below.</span>
       *
<span class="udiff-line-modified-removed">-      *  However, on a platform where right-shift of a signed quantity fills</span>
<span class="udiff-line-modified-removed">-      *  the leftmost bits by copying the sign bit, it might be faster.</span>
<span class="udiff-line-modified-added">+      * However, on a platform where right-shift of a signed quantity fills</span>
<span class="udiff-line-modified-added">+      * the leftmost bits by copying the sign bit, it might be faster.</span>
       */
  
      FT_Long    sa, sb;
      FT_UInt32  a, b;
  
  
      /*
<span class="udiff-line-modified-removed">-      *  This is a clever way of converting a signed number `a&#39; into its</span>
<span class="udiff-line-modified-removed">-      *  absolute value (stored back into `a&#39;) and its sign.  The sign is</span>
<span class="udiff-line-modified-removed">-      *  stored in `sa&#39;; 0 means `a&#39; was positive or zero, and -1 means `a&#39;</span>
<span class="udiff-line-modified-removed">-      *  was negative.  (Similarly for `b&#39; and `sb&#39;).</span>
<span class="udiff-line-modified-added">+      * This is a clever way of converting a signed number `a&#39; into its</span>
<span class="udiff-line-modified-added">+      * absolute value (stored back into `a&#39;) and its sign.  The sign is</span>
<span class="udiff-line-modified-added">+      * stored in `sa&#39;; 0 means `a&#39; was positive or zero, and -1 means `a&#39;</span>
<span class="udiff-line-modified-added">+      * was negative.  (Similarly for `b&#39; and `sb&#39;).</span>
       *
<span class="udiff-line-modified-removed">-      *  Unfortunately, it doesn&#39;t work (at least not portably).</span>
<span class="udiff-line-modified-added">+      * Unfortunately, it doesn&#39;t work (at least not portably).</span>
       *
<span class="udiff-line-modified-removed">-      *  It makes the assumption that right-shift on a negative signed value</span>
<span class="udiff-line-modified-removed">-      *  fills the leftmost bits by copying the sign bit.  This is wrong.</span>
<span class="udiff-line-modified-removed">-      *  According to K&amp;R 2nd ed, section `A7.8 Shift Operators&#39; on page 206,</span>
<span class="udiff-line-modified-removed">-      *  the result of right-shift of a negative signed value is</span>
<span class="udiff-line-modified-removed">-      *  implementation-defined.  At least one implementation fills the</span>
<span class="udiff-line-modified-removed">-      *  leftmost bits with 0s (i.e., it is exactly the same as an unsigned</span>
<span class="udiff-line-modified-removed">-      *  right shift).  This means that when `a&#39; is negative, `sa&#39; ends up</span>
<span class="udiff-line-modified-removed">-      *  with the value 1 rather than -1.  After that, everything else goes</span>
<span class="udiff-line-modified-removed">-      *  wrong.</span>
<span class="udiff-line-modified-added">+      * It makes the assumption that right-shift on a negative signed value</span>
<span class="udiff-line-modified-added">+      * fills the leftmost bits by copying the sign bit.  This is wrong.</span>
<span class="udiff-line-modified-added">+      * According to K&amp;R 2nd ed, section `A7.8 Shift Operators&#39; on page 206,</span>
<span class="udiff-line-modified-added">+      * the result of right-shift of a negative signed value is</span>
<span class="udiff-line-modified-added">+      * implementation-defined.  At least one implementation fills the</span>
<span class="udiff-line-modified-added">+      * leftmost bits with 0s (i.e., it is exactly the same as an unsigned</span>
<span class="udiff-line-modified-added">+      * right shift).  This means that when `a&#39; is negative, `sa&#39; ends up</span>
<span class="udiff-line-modified-added">+      * with the value 1 rather than -1.  After that, everything else goes</span>
<span class="udiff-line-modified-added">+      * wrong.</span>
       */
      sa = ( a_ &gt;&gt; ( sizeof ( a_ ) * 8 - 1 ) );
      a  = ( a_ ^ sa ) - sa;
      sb = ( b_ &gt;&gt; ( sizeof ( b_ ) * 8 - 1 ) );
      b  = ( b_ ^ sb ) - sb;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -699,12 +699,12 @@</span>
              FT_MulFix( matrix-&gt;xy, matrix-&gt;yx );
  
      if ( !delta )
        return FT_THROW( Invalid_Argument );  /* matrix can&#39;t be inverted */
  
<span class="udiff-line-modified-removed">-     matrix-&gt;xy = - FT_DivFix( matrix-&gt;xy, delta );</span>
<span class="udiff-line-modified-removed">-     matrix-&gt;yx = - FT_DivFix( matrix-&gt;yx, delta );</span>
<span class="udiff-line-modified-added">+     matrix-&gt;xy = -FT_DivFix( matrix-&gt;xy, delta );</span>
<span class="udiff-line-modified-added">+     matrix-&gt;yx = -FT_DivFix( matrix-&gt;yx, delta );</span>
  
      xx = matrix-&gt;xx;
      yy = matrix-&gt;yy;
  
      matrix-&gt;xx = FT_DivFix( yy, delta );
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -743,10 +743,80 @@</span>
      b-&gt;yx = yx;
      b-&gt;yy = yy;
    }
  
  
<span class="udiff-line-added">+   /* documentation is in ftcalc.h */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   FT_BASE_DEF( FT_Bool )</span>
<span class="udiff-line-added">+   FT_Matrix_Check( const FT_Matrix*  matrix )</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     FT_Matrix  m;</span>
<span class="udiff-line-added">+     FT_Fixed   val[4];</span>
<span class="udiff-line-added">+     FT_Fixed   nonzero_minval, maxval;</span>
<span class="udiff-line-added">+     FT_Fixed   temp1, temp2;</span>
<span class="udiff-line-added">+     FT_UInt    i;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( !matrix )</span>
<span class="udiff-line-added">+       return 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     val[0] = FT_ABS( matrix-&gt;xx );</span>
<span class="udiff-line-added">+     val[1] = FT_ABS( matrix-&gt;xy );</span>
<span class="udiff-line-added">+     val[2] = FT_ABS( matrix-&gt;yx );</span>
<span class="udiff-line-added">+     val[3] = FT_ABS( matrix-&gt;yy );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * To avoid overflow, we ensure that each value is not larger than</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      *   int(sqrt(2^31 / 4)) = 23170  ;</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * we also check that no value becomes zero if we have to scale.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     maxval         = 0;</span>
<span class="udiff-line-added">+     nonzero_minval = FT_LONG_MAX;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for ( i = 0; i &lt; 4; i++ )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       if ( val[i] &gt; maxval )</span>
<span class="udiff-line-added">+         maxval = val[i];</span>
<span class="udiff-line-added">+       if ( val[i] &amp;&amp; val[i] &lt; nonzero_minval )</span>
<span class="udiff-line-added">+         nonzero_minval = val[i];</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* we only handle 32bit values */</span>
<span class="udiff-line-added">+     if ( maxval &gt; 0x7FFFFFFFL )</span>
<span class="udiff-line-added">+       return 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( maxval &gt; 23170 )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       FT_Fixed  scale = FT_DivFix( maxval, 23170 );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if ( !FT_DivFix( nonzero_minval, scale ) )</span>
<span class="udiff-line-added">+         return 0;    /* value range too large */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       m.xx = FT_DivFix( matrix-&gt;xx, scale );</span>
<span class="udiff-line-added">+       m.xy = FT_DivFix( matrix-&gt;xy, scale );</span>
<span class="udiff-line-added">+       m.yx = FT_DivFix( matrix-&gt;yx, scale );</span>
<span class="udiff-line-added">+       m.yy = FT_DivFix( matrix-&gt;yy, scale );</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+       m = *matrix;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     temp1 = FT_ABS( m.xx * m.yy - m.xy * m.yx );</span>
<span class="udiff-line-added">+     temp2 = m.xx * m.xx + m.xy * m.xy + m.yx * m.yx + m.yy * m.yy;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( temp1 == 0         ||</span>
<span class="udiff-line-added">+          temp2 / temp1 &gt; 50 )</span>
<span class="udiff-line-added">+       return 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return 1;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
    /* documentation is in ftcalc.h */
  
    FT_BASE_DEF( void )
    FT_Vector_Transform_Scaled( FT_Vector*        vector,
                                const FT_Matrix*  matrix,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -911,24 +981,26 @@</span>
    ft_corner_orientation( FT_Pos  in_x,
                           FT_Pos  in_y,
                           FT_Pos  out_x,
                           FT_Pos  out_y )
    {
<span class="udiff-line-added">+     /* we silently ignore overflow errors since such large values */</span>
<span class="udiff-line-added">+     /* lead to even more (harmless) rendering errors later on     */</span>
<span class="udiff-line-added">+ </span>
  #ifdef FT_LONG64
  
<span class="udiff-line-modified-removed">-     FT_Int64  delta = (FT_Int64)in_x * out_y - (FT_Int64)in_y * out_x;</span>
<span class="udiff-line-modified-added">+     FT_Int64  delta = SUB_INT64( MUL_INT64( in_x, out_y ),</span>
<span class="udiff-line-added">+                                  MUL_INT64( in_y, out_x ) );</span>
  
  
      return ( delta &gt; 0 ) - ( delta &lt; 0 );
  
  #else
  
      FT_Int  result;
  
  
<span class="udiff-line-removed">-     /* we silently ignore overflow errors, since such large values */</span>
<span class="udiff-line-removed">-     /* lead to even more (harmless) rendering errors later on      */</span>
      if ( ADD_LONG( FT_ABS( in_x ), FT_ABS( out_y ) ) &lt;= 131071L &amp;&amp;
           ADD_LONG( FT_ABS( in_y ), FT_ABS( out_x ) ) &lt;= 131071L )
      {
        FT_Long  z1 = MUL_LONG( in_x, out_y );
        FT_Long  z2 = MUL_LONG( in_y, out_x );
</pre>
<center><a href="ftbitmap.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ftcid.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>