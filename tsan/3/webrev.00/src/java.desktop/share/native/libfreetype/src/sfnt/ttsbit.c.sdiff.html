<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/sfnt/ttsbit.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ttpost.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttsbit.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/sfnt/ttsbit.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 /***************************************************************************/</span>
<span class="line-modified">   2 /*                                                                         */</span>
<span class="line-modified">   3 /*  ttsbit.c                                                               */</span>
<span class="line-modified">   4 /*                                                                         */</span>
<span class="line-modified">   5 /*    TrueType and OpenType embedded bitmap support (body).                */</span>
<span class="line-modified">   6 /*                                                                         */</span>
<span class="line-modified">   7 /*  Copyright 2005-2018 by                                                 */</span>
<span class="line-modified">   8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">   9 /*                                                                         */</span>
<span class="line-modified">  10 /*  Copyright 2013 by Google, Inc.                                         */</span>
<span class="line-modified">  11 /*  Google Author(s): Behdad Esfahbod.                                     */</span>
<span class="line-modified">  12 /*                                                                         */</span>
<span class="line-modified">  13 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">  14 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">  15 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">  16 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">  17 /*  understand and accept it fully.                                        */</span>
<span class="line-modified">  18 /*                                                                         */</span>
<span class="line-modified">  19 /***************************************************************************/</span>
  20 
  21 
  22 #include &lt;ft2build.h&gt;
  23 #include FT_INTERNAL_DEBUG_H
  24 #include FT_INTERNAL_STREAM_H
  25 #include FT_TRUETYPE_TAGS_H
  26 #include FT_BITMAP_H
  27 
  28 
  29 #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
  30 
  31 #include &quot;ttsbit.h&quot;
  32 
  33 #include &quot;sferrors.h&quot;
  34 
  35 #include &quot;ttmtx.h&quot;
  36 #include &quot;pngshim.h&quot;
  37 
  38 
<span class="line-modified">  39   /*************************************************************************/</span>
<span class="line-modified">  40   /*                                                                       */</span>
<span class="line-modified">  41   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified">  42   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified">  43   /* messages during execution.                                            */</span>
<span class="line-modified">  44   /*                                                                       */</span>
  45 #undef  FT_COMPONENT
<span class="line-modified">  46 #define FT_COMPONENT  trace_ttsbit</span>
  47 
  48 
  49   FT_LOCAL_DEF( FT_Error )
  50   tt_face_load_sbit( TT_Face    face,
  51                      FT_Stream  stream )
  52   {
  53     FT_Error  error;
  54     FT_ULong  table_size;
  55     FT_ULong  table_start;
  56 
  57 
  58     face-&gt;sbit_table       = NULL;
  59     face-&gt;sbit_table_size  = 0;
  60     face-&gt;sbit_table_type  = TT_SBIT_TABLE_TYPE_NONE;
  61     face-&gt;sbit_num_strikes = 0;
  62 
  63     error = face-&gt;goto_table( face, TTAG_CBLC, stream, &amp;table_size );
  64     if ( !error )
  65       face-&gt;sbit_table_type = TT_SBIT_TABLE_TYPE_CBLC;
  66     else
</pre>
<hr />
<pre>
 112         num_strikes = FT_NEXT_ULONG( p );
 113 
 114         /* there&#39;s at least one font (FZShuSong-Z01, version 3)   */
 115         /* that uses the wrong byte order for the `version&#39; field */
 116         if ( ( (FT_ULong)version &amp; 0xFFFF0000UL ) != 0x00020000UL &amp;&amp;
 117              ( (FT_ULong)version &amp; 0x0000FFFFUL ) != 0x00000200UL &amp;&amp;
 118              ( (FT_ULong)version &amp; 0xFFFF0000UL ) != 0x00030000UL &amp;&amp;
 119              ( (FT_ULong)version &amp; 0x0000FFFFUL ) != 0x00000300UL )
 120         {
 121           error = FT_THROW( Unknown_File_Format );
 122           goto Exit;
 123         }
 124 
 125         if ( num_strikes &gt;= 0x10000UL )
 126         {
 127           error = FT_THROW( Invalid_File_Format );
 128           goto Exit;
 129         }
 130 
 131         /*
<span class="line-modified"> 132          *  Count the number of strikes available in the table.  We are a bit</span>
<span class="line-modified"> 133          *  paranoid there and don&#39;t trust the data.</span>
 134          */
 135         count = (FT_UInt)num_strikes;
 136         if ( 8 + 48UL * count &gt; table_size )
 137           count = (FT_UInt)( ( table_size - 8 ) / 48 );
 138 
 139         face-&gt;sbit_num_strikes = count;
 140       }
 141       break;
 142 
 143     case TT_SBIT_TABLE_TYPE_SBIX:
 144       {
 145         FT_UShort  version;
 146         FT_UShort  flags;
 147         FT_ULong   num_strikes;
 148         FT_UInt    count;
 149 
 150 
 151         if ( FT_FRAME_ENTER( 8 ) )
 152           goto Exit;
 153 
</pre>
<hr />
<pre>
 165 
 166         /* Bit 0 must always be `1&#39;.                            */
 167         /* Bit 1 controls the overlay of bitmaps with outlines. */
 168         /* All other bits should be zero.                       */
 169         if ( !( flags == 1 || flags == 3 ) ||
 170              num_strikes &gt;= 0x10000UL      )
 171         {
 172           error = FT_THROW( Invalid_File_Format );
 173           goto Exit;
 174         }
 175 
 176         /* we currently don&#39;t support bit 1; however, it is better to */
 177         /* draw at least something...                                 */
 178         if ( flags == 3 )
 179           FT_TRACE1(( &quot;tt_face_load_sbit_strikes:&quot;
 180                       &quot; sbix overlay not supported yet\n&quot;
 181                       &quot;                          &quot;
 182                       &quot; expect bad rendering results\n&quot; ));
 183 
 184         /*
<span class="line-modified"> 185          *  Count the number of strikes available in the table.  We are a bit</span>
<span class="line-modified"> 186          *  paranoid there and don&#39;t trust the data.</span>
 187          */
 188         count = (FT_UInt)num_strikes;
 189         if ( 8 + 4UL * count &gt; table_size )
 190           count = (FT_UInt)( ( table_size - 8 ) / 4 );
 191 
 192         if ( FT_STREAM_SEEK( FT_STREAM_POS() - 8 ) )
 193           goto Exit;
 194 
 195         face-&gt;sbit_table_size = 8 + count * 4;
 196         if ( FT_FRAME_EXTRACT( face-&gt;sbit_table_size, face-&gt;sbit_table ) )
 197           goto Exit;
 198 
 199         face-&gt;sbit_num_strikes = count;
 200       }
 201       break;
 202 
 203     default:
 204       /* we ignore unknown table formats */
 205       error = FT_THROW( Unknown_File_Format );
 206       break;
</pre>
<hr />
<pre>
 997     FT_Byte  vertAdvance  = (FT_Byte)decoder-&gt;metrics-&gt;vertAdvance;
 998 
 999 
1000     if ( p + 2 &gt; limit )
1001       goto Fail;
1002 
1003     num_components = FT_NEXT_USHORT( p );
1004     if ( p + 4 * num_components &gt; limit )
1005     {
1006       FT_TRACE1(( &quot;tt_sbit_decoder_load_compound: broken table\n&quot; ));
1007       goto Fail;
1008     }
1009 
1010     FT_TRACE3(( &quot;tt_sbit_decoder_load_compound: loading %d component%s\n&quot;,
1011                 num_components,
1012                 num_components == 1 ? &quot;&quot; : &quot;s&quot; ));
1013 
1014     for ( nn = 0; nn &lt; num_components; nn++ )
1015     {
1016       FT_UInt  gindex = FT_NEXT_USHORT( p );
<span class="line-modified">1017       FT_Byte  dx     = FT_NEXT_BYTE( p );</span>
<span class="line-modified">1018       FT_Byte  dy     = FT_NEXT_BYTE( p );</span>
1019 
1020 
1021       /* NB: a recursive call */
1022       error = tt_sbit_decoder_load_image( decoder,
1023                                           gindex,
1024                                           x_pos + dx,
1025                                           y_pos + dy,
1026                                           recurse_count + 1,
1027                                           /* request full bitmap image */
1028                                           FALSE );
1029       if ( error )
1030         break;
1031     }
1032 
1033     FT_TRACE3(( &quot;tt_sbit_decoder_load_compound: done\n&quot; ));
1034 
1035     decoder-&gt;metrics-&gt;horiBearingX = horiBearingX;
1036     decoder-&gt;metrics-&gt;horiBearingY = horiBearingY;
1037     decoder-&gt;metrics-&gt;horiAdvance  = horiAdvance;
1038     decoder-&gt;metrics-&gt;vertBearingX = vertBearingX;
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 /****************************************************************************</span>
<span class="line-modified">   2  *</span>
<span class="line-modified">   3  * ttsbit.c</span>
<span class="line-modified">   4  *</span>
<span class="line-modified">   5  *   TrueType and OpenType embedded bitmap support (body).</span>
<span class="line-modified">   6  *</span>
<span class="line-modified">   7  * Copyright (C) 2005-2019 by</span>
<span class="line-modified">   8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">   9  *</span>
<span class="line-modified">  10  * Copyright 2013 by Google, Inc.</span>
<span class="line-modified">  11  * Google Author(s): Behdad Esfahbod.</span>
<span class="line-modified">  12  *</span>
<span class="line-modified">  13  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">  14  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">  15  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">  16  * this file you indicate that you have read the license and</span>
<span class="line-modified">  17  * understand and accept it fully.</span>
<span class="line-modified">  18  *</span>
<span class="line-modified">  19  */</span>
  20 
  21 
  22 #include &lt;ft2build.h&gt;
  23 #include FT_INTERNAL_DEBUG_H
  24 #include FT_INTERNAL_STREAM_H
  25 #include FT_TRUETYPE_TAGS_H
  26 #include FT_BITMAP_H
  27 
  28 
  29 #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
  30 
  31 #include &quot;ttsbit.h&quot;
  32 
  33 #include &quot;sferrors.h&quot;
  34 
  35 #include &quot;ttmtx.h&quot;
  36 #include &quot;pngshim.h&quot;
  37 
  38 
<span class="line-modified">  39   /**************************************************************************</span>
<span class="line-modified">  40    *</span>
<span class="line-modified">  41    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified">  42    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified">  43    * messages during execution.</span>
<span class="line-modified">  44    */</span>
  45 #undef  FT_COMPONENT
<span class="line-modified">  46 #define FT_COMPONENT  ttsbit</span>
  47 
  48 
  49   FT_LOCAL_DEF( FT_Error )
  50   tt_face_load_sbit( TT_Face    face,
  51                      FT_Stream  stream )
  52   {
  53     FT_Error  error;
  54     FT_ULong  table_size;
  55     FT_ULong  table_start;
  56 
  57 
  58     face-&gt;sbit_table       = NULL;
  59     face-&gt;sbit_table_size  = 0;
  60     face-&gt;sbit_table_type  = TT_SBIT_TABLE_TYPE_NONE;
  61     face-&gt;sbit_num_strikes = 0;
  62 
  63     error = face-&gt;goto_table( face, TTAG_CBLC, stream, &amp;table_size );
  64     if ( !error )
  65       face-&gt;sbit_table_type = TT_SBIT_TABLE_TYPE_CBLC;
  66     else
</pre>
<hr />
<pre>
 112         num_strikes = FT_NEXT_ULONG( p );
 113 
 114         /* there&#39;s at least one font (FZShuSong-Z01, version 3)   */
 115         /* that uses the wrong byte order for the `version&#39; field */
 116         if ( ( (FT_ULong)version &amp; 0xFFFF0000UL ) != 0x00020000UL &amp;&amp;
 117              ( (FT_ULong)version &amp; 0x0000FFFFUL ) != 0x00000200UL &amp;&amp;
 118              ( (FT_ULong)version &amp; 0xFFFF0000UL ) != 0x00030000UL &amp;&amp;
 119              ( (FT_ULong)version &amp; 0x0000FFFFUL ) != 0x00000300UL )
 120         {
 121           error = FT_THROW( Unknown_File_Format );
 122           goto Exit;
 123         }
 124 
 125         if ( num_strikes &gt;= 0x10000UL )
 126         {
 127           error = FT_THROW( Invalid_File_Format );
 128           goto Exit;
 129         }
 130 
 131         /*
<span class="line-modified"> 132          * Count the number of strikes available in the table.  We are a bit</span>
<span class="line-modified"> 133          * paranoid there and don&#39;t trust the data.</span>
 134          */
 135         count = (FT_UInt)num_strikes;
 136         if ( 8 + 48UL * count &gt; table_size )
 137           count = (FT_UInt)( ( table_size - 8 ) / 48 );
 138 
 139         face-&gt;sbit_num_strikes = count;
 140       }
 141       break;
 142 
 143     case TT_SBIT_TABLE_TYPE_SBIX:
 144       {
 145         FT_UShort  version;
 146         FT_UShort  flags;
 147         FT_ULong   num_strikes;
 148         FT_UInt    count;
 149 
 150 
 151         if ( FT_FRAME_ENTER( 8 ) )
 152           goto Exit;
 153 
</pre>
<hr />
<pre>
 165 
 166         /* Bit 0 must always be `1&#39;.                            */
 167         /* Bit 1 controls the overlay of bitmaps with outlines. */
 168         /* All other bits should be zero.                       */
 169         if ( !( flags == 1 || flags == 3 ) ||
 170              num_strikes &gt;= 0x10000UL      )
 171         {
 172           error = FT_THROW( Invalid_File_Format );
 173           goto Exit;
 174         }
 175 
 176         /* we currently don&#39;t support bit 1; however, it is better to */
 177         /* draw at least something...                                 */
 178         if ( flags == 3 )
 179           FT_TRACE1(( &quot;tt_face_load_sbit_strikes:&quot;
 180                       &quot; sbix overlay not supported yet\n&quot;
 181                       &quot;                          &quot;
 182                       &quot; expect bad rendering results\n&quot; ));
 183 
 184         /*
<span class="line-modified"> 185          * Count the number of strikes available in the table.  We are a bit</span>
<span class="line-modified"> 186          * paranoid there and don&#39;t trust the data.</span>
 187          */
 188         count = (FT_UInt)num_strikes;
 189         if ( 8 + 4UL * count &gt; table_size )
 190           count = (FT_UInt)( ( table_size - 8 ) / 4 );
 191 
 192         if ( FT_STREAM_SEEK( FT_STREAM_POS() - 8 ) )
 193           goto Exit;
 194 
 195         face-&gt;sbit_table_size = 8 + count * 4;
 196         if ( FT_FRAME_EXTRACT( face-&gt;sbit_table_size, face-&gt;sbit_table ) )
 197           goto Exit;
 198 
 199         face-&gt;sbit_num_strikes = count;
 200       }
 201       break;
 202 
 203     default:
 204       /* we ignore unknown table formats */
 205       error = FT_THROW( Unknown_File_Format );
 206       break;
</pre>
<hr />
<pre>
 997     FT_Byte  vertAdvance  = (FT_Byte)decoder-&gt;metrics-&gt;vertAdvance;
 998 
 999 
1000     if ( p + 2 &gt; limit )
1001       goto Fail;
1002 
1003     num_components = FT_NEXT_USHORT( p );
1004     if ( p + 4 * num_components &gt; limit )
1005     {
1006       FT_TRACE1(( &quot;tt_sbit_decoder_load_compound: broken table\n&quot; ));
1007       goto Fail;
1008     }
1009 
1010     FT_TRACE3(( &quot;tt_sbit_decoder_load_compound: loading %d component%s\n&quot;,
1011                 num_components,
1012                 num_components == 1 ? &quot;&quot; : &quot;s&quot; ));
1013 
1014     for ( nn = 0; nn &lt; num_components; nn++ )
1015     {
1016       FT_UInt  gindex = FT_NEXT_USHORT( p );
<span class="line-modified">1017       FT_Char  dx     = FT_NEXT_CHAR( p );</span>
<span class="line-modified">1018       FT_Char  dy     = FT_NEXT_CHAR( p );</span>
1019 
1020 
1021       /* NB: a recursive call */
1022       error = tt_sbit_decoder_load_image( decoder,
1023                                           gindex,
1024                                           x_pos + dx,
1025                                           y_pos + dy,
1026                                           recurse_count + 1,
1027                                           /* request full bitmap image */
1028                                           FALSE );
1029       if ( error )
1030         break;
1031     }
1032 
1033     FT_TRACE3(( &quot;tt_sbit_decoder_load_compound: done\n&quot; ));
1034 
1035     decoder-&gt;metrics-&gt;horiBearingX = horiBearingX;
1036     decoder-&gt;metrics-&gt;horiBearingY = horiBearingY;
1037     decoder-&gt;metrics-&gt;horiAdvance  = horiAdvance;
1038     decoder-&gt;metrics-&gt;vertBearingX = vertBearingX;
</pre>
</td>
</tr>
</table>
<center><a href="ttpost.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttsbit.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>