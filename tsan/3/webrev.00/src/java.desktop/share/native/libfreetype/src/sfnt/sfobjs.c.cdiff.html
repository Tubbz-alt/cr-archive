<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfreetype/src/sfnt/sfobjs.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="sferrors.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="sfobjs.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/sfnt/sfobjs.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,35 ***</span>
<span class="line-modified">! /***************************************************************************/</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*  sfobjs.c                                                               */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*    SFNT object management (base).                                       */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">! /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">! /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">! /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">! /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">! /*  understand and accept it fully.                                        */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /***************************************************************************/</span>
  
  
  #include &lt;ft2build.h&gt;
  #include &quot;sfobjs.h&quot;
  #include &quot;ttload.h&quot;
  #include &quot;ttcmap.h&quot;
  #include &quot;ttkern.h&quot;
  #include FT_INTERNAL_SFNT_H
  #include FT_INTERNAL_DEBUG_H
  #include FT_TRUETYPE_IDS_H
  #include FT_TRUETYPE_TAGS_H
  #include FT_SERVICE_POSTSCRIPT_CMAPS_H
  #include FT_SFNT_NAMES_H
<span class="line-removed">- #include FT_GZIP_H</span>
  
  #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  #include FT_SERVICE_MULTIPLE_MASTERS_H
  #include FT_SERVICE_METRICS_VARIATIONS_H
  #endif
<span class="line-new-header">--- 1,35 ---</span>
<span class="line-modified">! /****************************************************************************</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * sfobjs.c</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  *   SFNT object management (base).</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">!  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">!  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">!  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">!  * this file you indicate that you have read the license and</span>
<span class="line-modified">!  * understand and accept it fully.</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  */</span>
  
  
  #include &lt;ft2build.h&gt;
  #include &quot;sfobjs.h&quot;
  #include &quot;ttload.h&quot;
  #include &quot;ttcmap.h&quot;
  #include &quot;ttkern.h&quot;
<span class="line-added">+ #include &quot;sfwoff.h&quot;</span>
  #include FT_INTERNAL_SFNT_H
  #include FT_INTERNAL_DEBUG_H
  #include FT_TRUETYPE_IDS_H
  #include FT_TRUETYPE_TAGS_H
  #include FT_SERVICE_POSTSCRIPT_CMAPS_H
  #include FT_SFNT_NAMES_H
  
  #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  #include FT_SERVICE_MULTIPLE_MASTERS_H
  #include FT_SERVICE_METRICS_VARIATIONS_H
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 39,18 ***</span>
  #ifdef TT_CONFIG_OPTION_BDF
  #include &quot;ttbdf.h&quot;
  #endif
  
  
<span class="line-modified">!   /*************************************************************************/</span>
<span class="line-modified">!   /*                                                                       */</span>
<span class="line-modified">!   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified">!   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified">!   /* messages during execution.                                            */</span>
<span class="line-modified">!   /*                                                                       */</span>
  #undef  FT_COMPONENT
<span class="line-modified">! #define FT_COMPONENT  trace_sfobjs</span>
  
  
  
    /* convert a UTF-16 name entry to ASCII */
    static FT_String*
<span class="line-new-header">--- 39,18 ---</span>
  #ifdef TT_CONFIG_OPTION_BDF
  #include &quot;ttbdf.h&quot;
  #endif
  
  
<span class="line-modified">!   /**************************************************************************</span>
<span class="line-modified">!    *</span>
<span class="line-modified">!    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified">!    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified">!    * messages during execution.</span>
<span class="line-modified">!    */</span>
  #undef  FT_COMPONENT
<span class="line-modified">! #define FT_COMPONENT  sfobjs</span>
  
  
  
    /* convert a UTF-16 name entry to ASCII */
    static FT_String*
</pre>
<hr />
<pre>
<span class="line-old-header">*** 335,407 ***</span>
  
      return FT_ENCODING_NONE;
    }
  
  
<span class="line-removed">- #define WRITE_USHORT( p, v )                \</span>
<span class="line-removed">-           do                                \</span>
<span class="line-removed">-           {                                 \</span>
<span class="line-removed">-             *(p)++ = (FT_Byte)( (v) &gt;&gt; 8 ); \</span>
<span class="line-removed">-             *(p)++ = (FT_Byte)( (v) &gt;&gt; 0 ); \</span>
<span class="line-removed">-                                             \</span>
<span class="line-removed">-           } while ( 0 )</span>
<span class="line-removed">- </span>
<span class="line-removed">- #define WRITE_ULONG( p, v )                  \</span>
<span class="line-removed">-           do                                 \</span>
<span class="line-removed">-           {                                  \</span>
<span class="line-removed">-             *(p)++ = (FT_Byte)( (v) &gt;&gt; 24 ); \</span>
<span class="line-removed">-             *(p)++ = (FT_Byte)( (v) &gt;&gt; 16 ); \</span>
<span class="line-removed">-             *(p)++ = (FT_Byte)( (v) &gt;&gt;  8 ); \</span>
<span class="line-removed">-             *(p)++ = (FT_Byte)( (v) &gt;&gt;  0 ); \</span>
<span class="line-removed">-                                              \</span>
<span class="line-removed">-           } while ( 0 )</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-   static void</span>
<span class="line-removed">-   sfnt_stream_close( FT_Stream  stream )</span>
<span class="line-removed">-   {</span>
<span class="line-removed">-     FT_Memory  memory = stream-&gt;memory;</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_FREE( stream-&gt;base );</span>
<span class="line-removed">- </span>
<span class="line-removed">-     stream-&gt;size  = 0;</span>
<span class="line-removed">-     stream-&gt;base  = NULL;</span>
<span class="line-removed">-     stream-&gt;close = NULL;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-   FT_CALLBACK_DEF( int )</span>
<span class="line-removed">-   compare_offsets( const void*  a,</span>
<span class="line-removed">-                    const void*  b )</span>
<span class="line-removed">-   {</span>
<span class="line-removed">-     WOFF_Table  table1 = *(WOFF_Table*)a;</span>
<span class="line-removed">-     WOFF_Table  table2 = *(WOFF_Table*)b;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_ULong  offset1 = table1-&gt;Offset;</span>
<span class="line-removed">-     FT_ULong  offset2 = table2-&gt;Offset;</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ( offset1 &gt; offset2 )</span>
<span class="line-removed">-       return 1;</span>
<span class="line-removed">-     else if ( offset1 &lt; offset2 )</span>
<span class="line-removed">-       return -1;</span>
<span class="line-removed">-     else</span>
<span class="line-removed">-       return 0;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-   /* Replace `face-&gt;root.stream&#39; with a stream containing the extracted */</span>
<span class="line-removed">-   /* SFNT of a WOFF font.                                               */</span>
<span class="line-removed">- </span>
<span class="line-removed">-   static FT_Error</span>
<span class="line-removed">-   woff_open_font( FT_Stream  stream,</span>
<span class="line-removed">-                   TT_Face    face )</span>
<span class="line-removed">-   {</span>
<span class="line-removed">-     FT_Memory       memory = stream-&gt;memory;</span>
<span class="line-removed">-     FT_Error        error  = FT_Err_Ok;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     WOFF_HeaderRec  woff;</span>
<span class="line-removed">-     WOFF_Table      tables  = NULL;</span>
<span class="line-removed">-     WOFF_Table*     indices = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_ULong        woff_offset;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_Byte*        sfnt        = NULL;</span>
<span class="line-removed">-     FT_Stream       sfnt_stream = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_Byte*        sfnt_header;</span>
<span class="line-removed">-     FT_ULong        sfnt_offset;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_Int          nn;</span>
<span class="line-removed">-     FT_ULong        old_tag = 0;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     static const FT_Frame_Field  woff_header_fields[] =</span>
<span class="line-removed">-     {</span>
<span class="line-removed">- #undef  FT_STRUCTURE</span>
<span class="line-removed">- #define FT_STRUCTURE  WOFF_HeaderRec</span>
<span class="line-removed">- </span>
<span class="line-removed">-       FT_FRAME_START( 44 ),</span>
<span class="line-removed">-         FT_FRAME_ULONG ( signature ),</span>
<span class="line-removed">-         FT_FRAME_ULONG ( flavor ),</span>
<span class="line-removed">-         FT_FRAME_ULONG ( length ),</span>
<span class="line-removed">-         FT_FRAME_USHORT( num_tables ),</span>
<span class="line-removed">-         FT_FRAME_USHORT( reserved ),</span>
<span class="line-removed">-         FT_FRAME_ULONG ( totalSfntSize ),</span>
<span class="line-removed">-         FT_FRAME_USHORT( majorVersion ),</span>
<span class="line-removed">-         FT_FRAME_USHORT( minorVersion ),</span>
<span class="line-removed">-         FT_FRAME_ULONG ( metaOffset ),</span>
<span class="line-removed">-         FT_FRAME_ULONG ( metaLength ),</span>
<span class="line-removed">-         FT_FRAME_ULONG ( metaOrigLength ),</span>
<span class="line-removed">-         FT_FRAME_ULONG ( privOffset ),</span>
<span class="line-removed">-         FT_FRAME_ULONG ( privLength ),</span>
<span class="line-removed">-       FT_FRAME_END</span>
<span class="line-removed">-     };</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_ASSERT( stream == face-&gt;root.stream );</span>
<span class="line-removed">-     FT_ASSERT( FT_STREAM_POS() == 0 );</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ( FT_STREAM_READ_FIELDS( woff_header_fields, &amp;woff ) )</span>
<span class="line-removed">-       return error;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* Make sure we don&#39;t recurse back here or hit TTC code. */</span>
<span class="line-removed">-     if ( woff.flavor == TTAG_wOFF || woff.flavor == TTAG_ttcf )</span>
<span class="line-removed">-       return FT_THROW( Invalid_Table );</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* Miscellaneous checks. */</span>
<span class="line-removed">-     if ( woff.length != stream-&gt;size                              ||</span>
<span class="line-removed">-          woff.num_tables == 0                                     ||</span>
<span class="line-removed">-          44 + woff.num_tables * 20UL &gt;= woff.length               ||</span>
<span class="line-removed">-          12 + woff.num_tables * 16UL &gt;= woff.totalSfntSize        ||</span>
<span class="line-removed">-          ( woff.totalSfntSize &amp; 3 ) != 0                          ||</span>
<span class="line-removed">-          ( woff.metaOffset == 0 &amp;&amp; ( woff.metaLength != 0     ||</span>
<span class="line-removed">-                                      woff.metaOrigLength != 0 ) ) ||</span>
<span class="line-removed">-          ( woff.metaLength != 0 &amp;&amp; woff.metaOrigLength == 0 )     ||</span>
<span class="line-removed">-          ( woff.privOffset == 0 &amp;&amp; woff.privLength != 0 )         )</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       FT_ERROR(( &quot;woff_font_open: invalid WOFF header\n&quot; ));</span>
<span class="line-removed">-       return FT_THROW( Invalid_Table );</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* Don&#39;t trust `totalSfntSize&#39; before thorough checks. */</span>
<span class="line-removed">-     if ( FT_ALLOC( sfnt, 12 + woff.num_tables * 16UL ) ||</span>
<span class="line-removed">-          FT_NEW( sfnt_stream )                         )</span>
<span class="line-removed">-       goto Exit;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     sfnt_header = sfnt;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* Write sfnt header. */</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       FT_UInt  searchRange, entrySelector, rangeShift, x;</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-       x             = woff.num_tables;</span>
<span class="line-removed">-       entrySelector = 0;</span>
<span class="line-removed">-       while ( x )</span>
<span class="line-removed">-       {</span>
<span class="line-removed">-         x            &gt;&gt;= 1;</span>
<span class="line-removed">-         entrySelector += 1;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-       entrySelector--;</span>
<span class="line-removed">- </span>
<span class="line-removed">-       searchRange = ( 1 &lt;&lt; entrySelector ) * 16;</span>
<span class="line-removed">-       rangeShift  = woff.num_tables * 16 - searchRange;</span>
<span class="line-removed">- </span>
<span class="line-removed">-       WRITE_ULONG ( sfnt_header, woff.flavor );</span>
<span class="line-removed">-       WRITE_USHORT( sfnt_header, woff.num_tables );</span>
<span class="line-removed">-       WRITE_USHORT( sfnt_header, searchRange );</span>
<span class="line-removed">-       WRITE_USHORT( sfnt_header, entrySelector );</span>
<span class="line-removed">-       WRITE_USHORT( sfnt_header, rangeShift );</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* While the entries in the sfnt header must be sorted by the */</span>
<span class="line-removed">-     /* tag value, the tables themselves are not.  We thus have to */</span>
<span class="line-removed">-     /* sort them by offset and check that they don&#39;t overlap.     */</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ( FT_NEW_ARRAY( tables, woff.num_tables )  ||</span>
<span class="line-removed">-          FT_NEW_ARRAY( indices, woff.num_tables ) )</span>
<span class="line-removed">-       goto Exit;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_TRACE2(( &quot;\n&quot;</span>
<span class="line-removed">-                 &quot;  tag    offset    compLen  origLen  checksum\n&quot;</span>
<span class="line-removed">-                 &quot;  -------------------------------------------\n&quot; ));</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ( FT_FRAME_ENTER( 20L * woff.num_tables ) )</span>
<span class="line-removed">-       goto Exit;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     for ( nn = 0; nn &lt; woff.num_tables; nn++ )</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       WOFF_Table  table = tables + nn;</span>
<span class="line-removed">- </span>
<span class="line-removed">-       table-&gt;Tag        = FT_GET_TAG4();</span>
<span class="line-removed">-       table-&gt;Offset     = FT_GET_ULONG();</span>
<span class="line-removed">-       table-&gt;CompLength = FT_GET_ULONG();</span>
<span class="line-removed">-       table-&gt;OrigLength = FT_GET_ULONG();</span>
<span class="line-removed">-       table-&gt;CheckSum   = FT_GET_ULONG();</span>
<span class="line-removed">- </span>
<span class="line-removed">-       FT_TRACE2(( &quot;  %c%c%c%c  %08lx  %08lx  %08lx  %08lx\n&quot;,</span>
<span class="line-removed">-                   (FT_Char)( table-&gt;Tag &gt;&gt; 24 ),</span>
<span class="line-removed">-                   (FT_Char)( table-&gt;Tag &gt;&gt; 16 ),</span>
<span class="line-removed">-                   (FT_Char)( table-&gt;Tag &gt;&gt; 8  ),</span>
<span class="line-removed">-                   (FT_Char)( table-&gt;Tag       ),</span>
<span class="line-removed">-                   table-&gt;Offset,</span>
<span class="line-removed">-                   table-&gt;CompLength,</span>
<span class="line-removed">-                   table-&gt;OrigLength,</span>
<span class="line-removed">-                   table-&gt;CheckSum ));</span>
<span class="line-removed">- </span>
<span class="line-removed">-       if ( table-&gt;Tag &lt;= old_tag )</span>
<span class="line-removed">-       {</span>
<span class="line-removed">-         FT_FRAME_EXIT();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         FT_ERROR(( &quot;woff_font_open: table tags are not sorted\n&quot; ));</span>
<span class="line-removed">-         error = FT_THROW( Invalid_Table );</span>
<span class="line-removed">-         goto Exit;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       old_tag     = table-&gt;Tag;</span>
<span class="line-removed">-       indices[nn] = table;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_FRAME_EXIT();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* Sort by offset. */</span>
<span class="line-removed">- </span>
<span class="line-removed">-     ft_qsort( indices,</span>
<span class="line-removed">-               woff.num_tables,</span>
<span class="line-removed">-               sizeof ( WOFF_Table ),</span>
<span class="line-removed">-               compare_offsets );</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* Check offsets and lengths. */</span>
<span class="line-removed">- </span>
<span class="line-removed">-     woff_offset = 44 + woff.num_tables * 20L;</span>
<span class="line-removed">-     sfnt_offset = 12 + woff.num_tables * 16L;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     for ( nn = 0; nn &lt; woff.num_tables; nn++ )</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       WOFF_Table  table = indices[nn];</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-       if ( table-&gt;Offset != woff_offset                         ||</span>
<span class="line-removed">-            table-&gt;CompLength &gt; woff.length                      ||</span>
<span class="line-removed">-            table-&gt;Offset &gt; woff.length - table-&gt;CompLength      ||</span>
<span class="line-removed">-            table-&gt;OrigLength &gt; woff.totalSfntSize               ||</span>
<span class="line-removed">-            sfnt_offset &gt; woff.totalSfntSize - table-&gt;OrigLength ||</span>
<span class="line-removed">-            table-&gt;CompLength &gt; table-&gt;OrigLength                )</span>
<span class="line-removed">-       {</span>
<span class="line-removed">-         FT_ERROR(( &quot;woff_font_open: invalid table offsets\n&quot; ));</span>
<span class="line-removed">-         error = FT_THROW( Invalid_Table );</span>
<span class="line-removed">-         goto Exit;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       table-&gt;OrigOffset = sfnt_offset;</span>
<span class="line-removed">- </span>
<span class="line-removed">-       /* The offsets must be multiples of 4. */</span>
<span class="line-removed">-       woff_offset += ( table-&gt;CompLength + 3 ) &amp; ~3U;</span>
<span class="line-removed">-       sfnt_offset += ( table-&gt;OrigLength + 3 ) &amp; ~3U;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * Final checks!</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * We don&#39;t decode and check the metadata block.</span>
<span class="line-removed">-      * We don&#39;t check table checksums either.</span>
<span class="line-removed">-      * But other than those, I think we implement all</span>
<span class="line-removed">-      * `MUST&#39; checks from the spec.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ( woff.metaOffset )</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       if ( woff.metaOffset != woff_offset                  ||</span>
<span class="line-removed">-            woff.metaOffset + woff.metaLength &gt; woff.length )</span>
<span class="line-removed">-       {</span>
<span class="line-removed">-         FT_ERROR(( &quot;woff_font_open:&quot;</span>
<span class="line-removed">-                    &quot; invalid `metadata&#39; offset or length\n&quot; ));</span>
<span class="line-removed">-         error = FT_THROW( Invalid_Table );</span>
<span class="line-removed">-         goto Exit;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       /* We have padding only ... */</span>
<span class="line-removed">-       woff_offset += woff.metaLength;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ( woff.privOffset )</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       /* ... if it isn&#39;t the last block. */</span>
<span class="line-removed">-       woff_offset = ( woff_offset + 3 ) &amp; ~3U;</span>
<span class="line-removed">- </span>
<span class="line-removed">-       if ( woff.privOffset != woff_offset                  ||</span>
<span class="line-removed">-            woff.privOffset + woff.privLength &gt; woff.length )</span>
<span class="line-removed">-       {</span>
<span class="line-removed">-         FT_ERROR(( &quot;woff_font_open: invalid `private&#39; offset or length\n&quot; ));</span>
<span class="line-removed">-         error = FT_THROW( Invalid_Table );</span>
<span class="line-removed">-         goto Exit;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       /* No padding for the last block. */</span>
<span class="line-removed">-       woff_offset += woff.privLength;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ( sfnt_offset != woff.totalSfntSize ||</span>
<span class="line-removed">-          woff_offset != woff.length        )</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       FT_ERROR(( &quot;woff_font_open: invalid `sfnt&#39; table structure\n&quot; ));</span>
<span class="line-removed">-       error = FT_THROW( Invalid_Table );</span>
<span class="line-removed">-       goto Exit;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* Now use `totalSfntSize&#39;. */</span>
<span class="line-removed">-     if ( FT_REALLOC( sfnt,</span>
<span class="line-removed">-                      12 + woff.num_tables * 16UL,</span>
<span class="line-removed">-                      woff.totalSfntSize ) )</span>
<span class="line-removed">-       goto Exit;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     sfnt_header = sfnt + 12;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* Write the tables. */</span>
<span class="line-removed">- </span>
<span class="line-removed">-     for ( nn = 0; nn &lt; woff.num_tables; nn++ )</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       WOFF_Table  table = tables + nn;</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-       /* Write SFNT table entry. */</span>
<span class="line-removed">-       WRITE_ULONG( sfnt_header, table-&gt;Tag );</span>
<span class="line-removed">-       WRITE_ULONG( sfnt_header, table-&gt;CheckSum );</span>
<span class="line-removed">-       WRITE_ULONG( sfnt_header, table-&gt;OrigOffset );</span>
<span class="line-removed">-       WRITE_ULONG( sfnt_header, table-&gt;OrigLength );</span>
<span class="line-removed">- </span>
<span class="line-removed">-       /* Write table data. */</span>
<span class="line-removed">-       if ( FT_STREAM_SEEK( table-&gt;Offset )     ||</span>
<span class="line-removed">-            FT_FRAME_ENTER( table-&gt;CompLength ) )</span>
<span class="line-removed">-         goto Exit;</span>
<span class="line-removed">- </span>
<span class="line-removed">-       if ( table-&gt;CompLength == table-&gt;OrigLength )</span>
<span class="line-removed">-       {</span>
<span class="line-removed">-         /* Uncompressed data; just copy. */</span>
<span class="line-removed">-         ft_memcpy( sfnt + table-&gt;OrigOffset,</span>
<span class="line-removed">-                    stream-&gt;cursor,</span>
<span class="line-removed">-                    table-&gt;OrigLength );</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-       else</span>
<span class="line-removed">-       {</span>
<span class="line-removed">- #ifdef FT_CONFIG_OPTION_USE_ZLIB</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* Uncompress with zlib. */</span>
<span class="line-removed">-         FT_ULong  output_len = table-&gt;OrigLength;</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-         error = FT_Gzip_Uncompress( memory,</span>
<span class="line-removed">-                                     sfnt + table-&gt;OrigOffset, &amp;output_len,</span>
<span class="line-removed">-                                     stream-&gt;cursor, table-&gt;CompLength );</span>
<span class="line-removed">-         if ( error )</span>
<span class="line-removed">-           goto Exit;</span>
<span class="line-removed">-         if ( output_len != table-&gt;OrigLength )</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-           FT_ERROR(( &quot;woff_font_open: compressed table length mismatch\n&quot; ));</span>
<span class="line-removed">-           error = FT_THROW( Invalid_Table );</span>
<span class="line-removed">-           goto Exit;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #else /* !FT_CONFIG_OPTION_USE_ZLIB */</span>
<span class="line-removed">- </span>
<span class="line-removed">-         error = FT_THROW( Unimplemented_Feature );</span>
<span class="line-removed">-         goto Exit;</span>
<span class="line-removed">- </span>
<span class="line-removed">- #endif /* !FT_CONFIG_OPTION_USE_ZLIB */</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       FT_FRAME_EXIT();</span>
<span class="line-removed">- </span>
<span class="line-removed">-       /* We don&#39;t check whether the padding bytes in the WOFF file are     */</span>
<span class="line-removed">-       /* actually &#39;\0&#39;.  For the output, however, we do set them properly. */</span>
<span class="line-removed">-       sfnt_offset = table-&gt;OrigOffset + table-&gt;OrigLength;</span>
<span class="line-removed">-       while ( sfnt_offset &amp; 3 )</span>
<span class="line-removed">-       {</span>
<span class="line-removed">-         sfnt[sfnt_offset] = &#39;\0&#39;;</span>
<span class="line-removed">-         sfnt_offset++;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* Ok!  Finally ready.  Swap out stream and return. */</span>
<span class="line-removed">-     FT_Stream_OpenMemory( sfnt_stream, sfnt, woff.totalSfntSize );</span>
<span class="line-removed">-     sfnt_stream-&gt;memory = stream-&gt;memory;</span>
<span class="line-removed">-     sfnt_stream-&gt;close  = sfnt_stream_close;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     FT_Stream_Free(</span>
<span class="line-removed">-       face-&gt;root.stream,</span>
<span class="line-removed">-       ( face-&gt;root.face_flags &amp; FT_FACE_FLAG_EXTERNAL_STREAM ) != 0 );</span>
<span class="line-removed">- </span>
<span class="line-removed">-     face-&gt;root.stream = sfnt_stream;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     face-&gt;root.face_flags &amp;= ~FT_FACE_FLAG_EXTERNAL_STREAM;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   Exit:</span>
<span class="line-removed">-     FT_FREE( tables );</span>
<span class="line-removed">-     FT_FREE( indices );</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ( error )</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       FT_FREE( sfnt );</span>
<span class="line-removed">-       FT_Stream_Close( sfnt_stream );</span>
<span class="line-removed">-       FT_FREE( sfnt_stream );</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return error;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- #undef WRITE_USHORT</span>
<span class="line-removed">- #undef WRITE_ULONG</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
    /* Fill in face-&gt;ttc_header.  If the font is not a TTC, it is */
    /* synthesized into a TTC with one offset table.              */
    static FT_Error
    sfnt_open_font( FT_Stream  stream,
                    TT_Face    face )
<span class="line-new-header">--- 335,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 916,11 ***</span>
        return error;
  
      /* Stream may have changed in sfnt_open_font. */
      stream = face-&gt;root.stream;
  
<span class="line-modified">!     FT_TRACE2(( &quot;sfnt_init_face: %08p, %d\n&quot;, face, face_instance_index ));</span>
  
      face_index = FT_ABS( face_instance_index ) &amp; 0xFFFF;
  
      /* value -(N+1) requests information on index N */
      if ( face_instance_index &lt; 0 )
<span class="line-new-header">--- 519,13 ---</span>
        return error;
  
      /* Stream may have changed in sfnt_open_font. */
      stream = face-&gt;root.stream;
  
<span class="line-modified">!     FT_TRACE2(( &quot;sfnt_init_face: %08p (index %d)\n&quot;,</span>
<span class="line-added">+                 face,</span>
<span class="line-added">+                 face_instance_index ));</span>
  
      face_index = FT_ABS( face_instance_index ) &amp; 0xFFFF;
  
      /* value -(N+1) requests information on index N */
      if ( face_instance_index &lt; 0 )
</pre>
<hr />
<pre>
<span class="line-old-header">*** 999,19 ***</span>
          num_instances = 0;
        else
          face-&gt;variation_support |= TT_FACE_FLAG_VAR_FVAR;
  
        /*
<span class="line-modified">!        *  As documented in the OpenType specification, an entry for the</span>
<span class="line-modified">!        *  default instance may be omitted in the named instance table.  In</span>
<span class="line-modified">!        *  particular this means that even if there is no named instance</span>
<span class="line-modified">!        *  table in the font we actually do have a named instance, namely the</span>
<span class="line-modified">!        *  default instance.</span>
         *
<span class="line-modified">!        *  For consistency, we always want the default instance in our list</span>
<span class="line-modified">!        *  of named instances.  If it is missing, we try to synthesize it</span>
<span class="line-modified">!        *  later on.  Here, we have to adjust `num_instances&#39; accordingly.</span>
         */
  
        if ( ( face-&gt;variation_support &amp; TT_FACE_FLAG_VAR_FVAR ) &amp;&amp;
             !( FT_ALLOC( default_values, num_axes * 4 )  ||
                FT_ALLOC( instance_values, num_axes * 4 ) )      )
<span class="line-new-header">--- 604,19 ---</span>
          num_instances = 0;
        else
          face-&gt;variation_support |= TT_FACE_FLAG_VAR_FVAR;
  
        /*
<span class="line-modified">!        * As documented in the OpenType specification, an entry for the</span>
<span class="line-modified">!        * default instance may be omitted in the named instance table.  In</span>
<span class="line-modified">!        * particular this means that even if there is no named instance</span>
<span class="line-modified">!        * table in the font we actually do have a named instance, namely the</span>
<span class="line-modified">!        * default instance.</span>
         *
<span class="line-modified">!        * For consistency, we always want the default instance in our list</span>
<span class="line-modified">!        * of named instances.  If it is missing, we try to synthesize it</span>
<span class="line-modified">!        * later on.  Here, we have to adjust `num_instances&#39; accordingly.</span>
         */
  
        if ( ( face-&gt;variation_support &amp; TT_FACE_FLAG_VAR_FVAR ) &amp;&amp;
             !( FT_ALLOC( default_values, num_axes * 4 )  ||
                FT_ALLOC( instance_values, num_axes * 4 ) )      )
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1339,10 ***</span>
<span class="line-new-header">--- 944,17 ---</span>
  
      /* embedded bitmap support */
      if ( sfnt-&gt;load_eblc )
        LOAD_( eblc );
  
<span class="line-added">+     /* colored glyph support */</span>
<span class="line-added">+     if ( sfnt-&gt;load_cpal )</span>
<span class="line-added">+     {</span>
<span class="line-added">+       LOAD_( cpal );</span>
<span class="line-added">+       LOAD_( colr );</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /* consider the pclt, kerning, and gasp tables as optional */
      LOAD_( pclt );
      LOAD_( gasp );
      LOAD_( kern );
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1387,16 ***</span>
      {
        FT_Face  root  = &amp;face-&gt;root;
        FT_Long  flags = root-&gt;face_flags;
  
  
<span class="line-modified">!       /*********************************************************************/</span>
<span class="line-modified">!       /*                                                                   */</span>
<span class="line-modified">!       /* Compute face flags.                                               */</span>
<span class="line-modified">!       /*                                                                   */</span>
        if ( face-&gt;sbit_table_type == TT_SBIT_TABLE_TYPE_CBLC ||
<span class="line-modified">!            face-&gt;sbit_table_type == TT_SBIT_TABLE_TYPE_SBIX )</span>
          flags |= FT_FACE_FLAG_COLOR;      /* color glyphs */
  
        if ( has_outline == TRUE )
          flags |= FT_FACE_FLAG_SCALABLE;   /* scalable outlines */
  
<span class="line-new-header">--- 999,17 ---</span>
      {
        FT_Face  root  = &amp;face-&gt;root;
        FT_Long  flags = root-&gt;face_flags;
  
  
<span class="line-modified">!       /**********************************************************************</span>
<span class="line-modified">!        *</span>
<span class="line-modified">!        * Compute face flags.</span>
<span class="line-modified">!        */</span>
        if ( face-&gt;sbit_table_type == TT_SBIT_TABLE_TYPE_CBLC ||
<span class="line-modified">!            face-&gt;sbit_table_type == TT_SBIT_TABLE_TYPE_SBIX ||</span>
<span class="line-added">+            face-&gt;colr                                       )</span>
          flags |= FT_FACE_FLAG_COLOR;      /* color glyphs */
  
        if ( has_outline == TRUE )
          flags |= FT_FACE_FLAG_SCALABLE;   /* scalable outlines */
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1436,14 ***</span>
        }
  #endif
  
        root-&gt;face_flags = flags;
  
<span class="line-modified">!       /*********************************************************************/</span>
<span class="line-modified">!       /*                                                                   */</span>
<span class="line-modified">!       /* Compute style flags.                                              */</span>
<span class="line-modified">!       /*                                                                   */</span>
  
        flags = 0;
        if ( has_outline == TRUE &amp;&amp; face-&gt;os2.version != 0xFFFFU )
        {
          /* We have an OS/2 table; use the `fsSelection&#39; field.  Bit 9 */
<span class="line-new-header">--- 1049,14 ---</span>
        }
  #endif
  
        root-&gt;face_flags = flags;
  
<span class="line-modified">!       /**********************************************************************</span>
<span class="line-modified">!        *</span>
<span class="line-modified">!        * Compute style flags.</span>
<span class="line-modified">!        */</span>
  
        flags = 0;
        if ( has_outline == TRUE &amp;&amp; face-&gt;os2.version != 0xFFFFU )
        {
          /* We have an OS/2 table; use the `fsSelection&#39; field.  Bit 9 */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1469,18 ***</span>
            flags |= FT_STYLE_FLAG_ITALIC;
        }
  
        root-&gt;style_flags |= flags;
  
<span class="line-modified">!       /*********************************************************************/</span>
<span class="line-modified">!       /*                                                                   */</span>
<span class="line-modified">!       /* Polish the charmaps.                                              */</span>
<span class="line-modified">!       /*                                                                   */</span>
<span class="line-modified">!       /*   Try to set the charmap encoding according to the platform &amp;     */</span>
<span class="line-modified">!       /*   encoding ID of each charmap.  Emulate Unicode charmap if one    */</span>
<span class="line-modified">!       /*   is missing.                                                     */</span>
<span class="line-modified">!       /*                                                                   */</span>
  
        tt_face_build_cmaps( face );  /* ignore errors */
  
  
        /* set the encoding fields */
<span class="line-new-header">--- 1082,18 ---</span>
            flags |= FT_STYLE_FLAG_ITALIC;
        }
  
        root-&gt;style_flags |= flags;
  
<span class="line-modified">!       /**********************************************************************</span>
<span class="line-modified">!        *</span>
<span class="line-modified">!        * Polish the charmaps.</span>
<span class="line-modified">!        *</span>
<span class="line-modified">!        *   Try to set the charmap encoding according to the platform &amp;</span>
<span class="line-modified">!        *   encoding ID of each charmap.  Emulate Unicode charmap if one</span>
<span class="line-modified">!        *   is missing.</span>
<span class="line-modified">!        */</span>
  
        tt_face_build_cmaps( face );  /* ignore errors */
  
  
        /* set the encoding fields */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1519,11 ***</span>
  
  
            error = FT_CMap_New( (FT_CMap_Class)&amp;tt_cmap_unicode_class_rec,
                                 NULL, &amp;cmaprec, NULL );
            if ( error                                      &amp;&amp;
<span class="line-modified">!                FT_ERR_NEQ( error, No_Unicode_Glyph_Name ) )</span>
              goto Exit;
            error = FT_Err_Ok;
  
  #endif /* FT_CONFIG_OPTION_POSTSCRIPT_NAMES */
  
<span class="line-new-header">--- 1132,12 ---</span>
  
  
            error = FT_CMap_New( (FT_CMap_Class)&amp;tt_cmap_unicode_class_rec,
                                 NULL, &amp;cmaprec, NULL );
            if ( error                                      &amp;&amp;
<span class="line-modified">!                FT_ERR_NEQ( error, No_Unicode_Glyph_Name ) &amp;&amp;</span>
<span class="line-added">+                FT_ERR_NEQ( error, Unimplemented_Feature ) )</span>
              goto Exit;
            error = FT_Err_Ok;
  
  #endif /* FT_CONFIG_OPTION_POSTSCRIPT_NAMES */
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1531,13 ***</span>
        }
  
  #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
  
        /*
<span class="line-modified">!        *  Now allocate the root array of FT_Bitmap_Size records and</span>
<span class="line-modified">!        *  populate them.  Unfortunately, it isn&#39;t possible to indicate bit</span>
<span class="line-modified">!        *  depths in the FT_Bitmap_Size record.  This is a design error.</span>
         */
        {
          FT_UInt  count;
  
  
<span class="line-new-header">--- 1145,13 ---</span>
        }
  
  #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
  
        /*
<span class="line-modified">!        * Now allocate the root array of FT_Bitmap_Size records and</span>
<span class="line-modified">!        * populate them.  Unfortunately, it isn&#39;t possible to indicate bit</span>
<span class="line-modified">!        * depths in the FT_Bitmap_Size record.  This is a design error.</span>
         */
        {
          FT_UInt  count;
  
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1613,14 ***</span>
        /* it has only empty glyphs then                       */
        if ( !FT_HAS_FIXED_SIZES( root ) &amp;&amp; !FT_IS_SCALABLE( root ) )
          root-&gt;face_flags |= FT_FACE_FLAG_SCALABLE;
  
  
<span class="line-modified">!       /*********************************************************************/</span>
<span class="line-modified">!       /*                                                                   */</span>
<span class="line-modified">!       /*  Set up metrics.                                                  */</span>
<span class="line-modified">!       /*                                                                   */</span>
        if ( FT_IS_SCALABLE( root ) )
        {
          /* XXX What about if outline header is missing */
          /*     (e.g. sfnt wrapped bitmap)?             */
          root-&gt;bbox.xMin    = face-&gt;header.xMin;
<span class="line-new-header">--- 1227,14 ---</span>
        /* it has only empty glyphs then                       */
        if ( !FT_HAS_FIXED_SIZES( root ) &amp;&amp; !FT_IS_SCALABLE( root ) )
          root-&gt;face_flags |= FT_FACE_FLAG_SCALABLE;
  
  
<span class="line-modified">!       /**********************************************************************</span>
<span class="line-modified">!        *</span>
<span class="line-modified">!        * Set up metrics.</span>
<span class="line-modified">!        */</span>
        if ( FT_IS_SCALABLE( root ) )
        {
          /* XXX What about if outline header is missing */
          /*     (e.g. sfnt wrapped bitmap)?             */
          root-&gt;bbox.xMin    = face-&gt;header.xMin;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1628,63 ***</span>
          root-&gt;bbox.xMax    = face-&gt;header.xMax;
          root-&gt;bbox.yMax    = face-&gt;header.yMax;
          root-&gt;units_per_EM = face-&gt;header.Units_Per_EM;
  
  
<span class="line-modified">!         /* XXX: Computing the ascender/descender/height is very different */</span>
<span class="line-modified">!         /*      from what the specification tells you.  Apparently, we    */</span>
<span class="line-modified">!         /*      must be careful because                                   */</span>
<span class="line-modified">!         /*                                                                */</span>
<span class="line-modified">!         /*      - not all fonts have an OS/2 table; in this case, we take */</span>
<span class="line-modified">!         /*        the values in the horizontal header.  However, these    */</span>
<span class="line-modified">!         /*        values very often are not reliable.                     */</span>
<span class="line-modified">!         /*                                                                */</span>
<span class="line-modified">!         /*      - otherwise, the correct typographic values are in the    */</span>
<span class="line-modified">!         /*        sTypoAscender, sTypoDescender &amp; sTypoLineGap fields.    */</span>
<span class="line-modified">!         /*                                                                */</span>
<span class="line-modified">!         /*        However, certain fonts have these fields set to 0.      */</span>
<span class="line-modified">!         /*        Rather, they have usWinAscent &amp; usWinDescent correctly  */</span>
<span class="line-modified">!         /*        set (but with different values).                        */</span>
<span class="line-modified">!         /*                                                                */</span>
<span class="line-modified">!         /*      As an example, Arial Narrow is implemented through four   */</span>
<span class="line-modified">!         /*      files ARIALN.TTF, ARIALNI.TTF, ARIALNB.TTF &amp; ARIALNBI.TTF */</span>
<span class="line-modified">!         /*                                                                */</span>
<span class="line-modified">!         /*      Strangely, all fonts have the same values in their        */</span>
<span class="line-modified">!         /*      sTypoXXX fields, except ARIALNB which sets them to 0.     */</span>
<span class="line-modified">!         /*                                                                */</span>
<span class="line-modified">!         /*      On the other hand, they all have different                */</span>
<span class="line-modified">!         /*      usWinAscent/Descent values -- as a conclusion, the OS/2   */</span>
<span class="line-modified">!         /*      table cannot be used to compute the text height reliably! */</span>
<span class="line-modified">!         /*                                                                */</span>
<span class="line-modified">! </span>
<span class="line-modified">!         /* The ascender and descender are taken from the `hhea&#39; table. */</span>
<span class="line-modified">!         /* If zero, they are taken from the `OS/2&#39; table.              */</span>
<span class="line-modified">! </span>
<span class="line-modified">!         root-&gt;ascender  = face-&gt;horizontal.Ascender;</span>
<span class="line-modified">!         root-&gt;descender = face-&gt;horizontal.Descender;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         root-&gt;height = root-&gt;ascender - root-&gt;descender +</span>
<span class="line-modified">!                        face-&gt;horizontal.Line_Gap;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         if ( !( root-&gt;ascender || root-&gt;descender ) )</span>
          {
<span class="line-modified">!           if ( face-&gt;os2.version != 0xFFFFU )</span>
<span class="line-modified">!           {</span>
<span class="line-modified">!             if ( face-&gt;os2.sTypoAscender || face-&gt;os2.sTypoDescender )</span>
<span class="line-modified">!             {</span>
<span class="line-modified">!               root-&gt;ascender  = face-&gt;os2.sTypoAscender;</span>
<span class="line-modified">!               root-&gt;descender = face-&gt;os2.sTypoDescender;</span>
  
<span class="line-modified">!               root-&gt;height = root-&gt;ascender - root-&gt;descender +</span>
<span class="line-modified">!                              face-&gt;os2.sTypoLineGap;</span>
<span class="line-modified">!             }</span>
<span class="line-removed">-             else</span>
              {
<span class="line-modified">!               root-&gt;ascender  =  (FT_Short)face-&gt;os2.usWinAscent;</span>
<span class="line-modified">!               root-&gt;descender = -(FT_Short)face-&gt;os2.usWinDescent;</span>
<span class="line-modified">! </span>
<span class="line-modified">!               root-&gt;height = root-&gt;ascender - root-&gt;descender;</span>
              }
            }
          }
  
          root-&gt;max_advance_width  =
<span class="line-new-header">--- 1242,77 ---</span>
          root-&gt;bbox.xMax    = face-&gt;header.xMax;
          root-&gt;bbox.yMax    = face-&gt;header.yMax;
          root-&gt;units_per_EM = face-&gt;header.Units_Per_EM;
  
  
<span class="line-modified">!         /*</span>
<span class="line-modified">!          * Computing the ascender/descender/height is tricky.</span>
<span class="line-modified">!          *</span>
<span class="line-modified">!          * The OpenType specification v1.8.3 says:</span>
<span class="line-modified">!          *</span>
<span class="line-modified">!          *   [OS/2&#39;s] sTypoAscender, sTypoDescender and sTypoLineGap fields</span>
<span class="line-modified">!          *   are intended to allow applications to lay out documents in a</span>
<span class="line-modified">!          *   typographically-correct and portable fashion.</span>
<span class="line-modified">!          *</span>
<span class="line-modified">!          * This is somewhat at odds with the decades of backwards</span>
<span class="line-modified">!          * compatibility, operating systems and applications doing whatever</span>
<span class="line-modified">!          * they want, not to mention broken fonts.</span>
<span class="line-modified">!          *</span>
<span class="line-modified">!          * Not all fonts have an OS/2 table; in this case, we take the values</span>
<span class="line-modified">!          * in the horizontal header, although there is nothing stopping the</span>
<span class="line-modified">!          * values from being unreliable. Even with a OS/2 table, certain fonts</span>
<span class="line-modified">!          * set the sTypoAscender, sTypoDescender and sTypoLineGap fields to 0</span>
<span class="line-modified">!          * and instead correctly set usWinAscent and usWinDescent.</span>
<span class="line-modified">!          *</span>
<span class="line-modified">!          * As an example, Arial Narrow is shipped as four files ARIALN.TTF,</span>
<span class="line-modified">!          * ARIALNI.TTF, ARIALNB.TTF and ARIALNBI.TTF. Strangely, all fonts have</span>
<span class="line-modified">!          * the same values in their sTypo* fields, except ARIALNB.ttf which</span>
<span class="line-modified">!          * sets them to 0. All of them have different usWinAscent/Descent</span>
<span class="line-modified">!          * values. The OS/2 table therefore cannot be trusted for computing the</span>
<span class="line-modified">!          * text height reliably.</span>
<span class="line-modified">!          *</span>
<span class="line-modified">!          * As a compromise, do the following:</span>
<span class="line-modified">!          *</span>
<span class="line-modified">!          * 1. If the OS/2 table exists and the fsSelection bit 7 is set</span>
<span class="line-modified">!          *    (USE_TYPO_METRICS), trust the font and use the sTypo* metrics.</span>
<span class="line-modified">!          * 2. Otherwise, use the `hhea&#39; table&#39;s metrics.</span>
<span class="line-modified">!          * 3. If they are zero and the OS/2 table exists,</span>
<span class="line-modified">!          *    1. use the OS/2 table&#39;s sTypo* metrics if they are non-zero.</span>
<span class="line-modified">!          *    2. Otherwise, use the OS/2 table&#39;s usWin* metrics.</span>
<span class="line-modified">!          */</span>
<span class="line-modified">! </span>
<span class="line-added">+         if ( face-&gt;os2.version != 0xFFFFU &amp;&amp; face-&gt;os2.fsSelection &amp; 128 )</span>
          {
<span class="line-modified">!           root-&gt;ascender  = face-&gt;os2.sTypoAscender;</span>
<span class="line-modified">!           root-&gt;descender = face-&gt;os2.sTypoDescender;</span>
<span class="line-modified">!           root-&gt;height    = root-&gt;ascender - root-&gt;descender +</span>
<span class="line-modified">!                             face-&gt;os2.sTypoLineGap;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         else</span>
<span class="line-added">+         {</span>
<span class="line-added">+           root-&gt;ascender  = face-&gt;horizontal.Ascender;</span>
<span class="line-added">+           root-&gt;descender = face-&gt;horizontal.Descender;</span>
<span class="line-added">+           root-&gt;height    = root-&gt;ascender - root-&gt;descender +</span>
<span class="line-added">+                             face-&gt;horizontal.Line_Gap;</span>
  
<span class="line-modified">!           if ( !( root-&gt;ascender || root-&gt;descender ) )</span>
<span class="line-modified">!           {</span>
<span class="line-modified">!             if ( face-&gt;os2.version != 0xFFFFU )</span>
              {
<span class="line-modified">!               if ( face-&gt;os2.sTypoAscender || face-&gt;os2.sTypoDescender )</span>
<span class="line-modified">!               {</span>
<span class="line-modified">!                 root-&gt;ascender  = face-&gt;os2.sTypoAscender;</span>
<span class="line-modified">!                 root-&gt;descender = face-&gt;os2.sTypoDescender;</span>
<span class="line-added">+                 root-&gt;height    = root-&gt;ascender - root-&gt;descender +</span>
<span class="line-added">+                                   face-&gt;os2.sTypoLineGap;</span>
<span class="line-added">+               }</span>
<span class="line-added">+               else</span>
<span class="line-added">+               {</span>
<span class="line-added">+                 root-&gt;ascender  =  (FT_Short)face-&gt;os2.usWinAscent;</span>
<span class="line-added">+                 root-&gt;descender = -(FT_Short)face-&gt;os2.usWinDescent;</span>
<span class="line-added">+                 root-&gt;height    =  root-&gt;ascender - root-&gt;descender;</span>
<span class="line-added">+               }</span>
              }
            }
          }
  
          root-&gt;max_advance_width  =
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1735,10 ***</span>
<span class="line-new-header">--- 1363,17 ---</span>
          sfnt-&gt;free_psnames( face );
  
        /* destroy the embedded bitmaps table if it is loaded */
        if ( sfnt-&gt;free_eblc )
          sfnt-&gt;free_eblc( face );
<span class="line-added">+ </span>
<span class="line-added">+       /* destroy color table data if it is loaded */</span>
<span class="line-added">+       if ( sfnt-&gt;free_cpal )</span>
<span class="line-added">+       {</span>
<span class="line-added">+         sfnt-&gt;free_cpal( face );</span>
<span class="line-added">+         sfnt-&gt;free_colr( face );</span>
<span class="line-added">+       }</span>
      }
  
  #ifdef TT_CONFIG_OPTION_BDF
      /* freeing the embedded BDF properties */
      tt_face_free_bdf_props( face );
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1790,15 ***</span>
      /* freeing sbit size table */
      FT_FREE( face-&gt;root.available_sizes );
      FT_FREE( face-&gt;sbit_strike_map );
      face-&gt;root.num_fixed_sizes = 0;
  
<span class="line-removed">- #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</span>
      FT_FREE( face-&gt;postscript_name );
      FT_FREE( face-&gt;var_postscript_prefix );
  #endif
  
      face-&gt;sfnt = NULL;
    }
  
  
  /* END */
<span class="line-new-header">--- 1425,22 ---</span>
      /* freeing sbit size table */
      FT_FREE( face-&gt;root.available_sizes );
      FT_FREE( face-&gt;sbit_strike_map );
      face-&gt;root.num_fixed_sizes = 0;
  
      FT_FREE( face-&gt;postscript_name );
<span class="line-added">+ </span>
<span class="line-added">+ #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</span>
      FT_FREE( face-&gt;var_postscript_prefix );
  #endif
  
<span class="line-added">+     /* freeing glyph color palette data */</span>
<span class="line-added">+     FT_FREE( face-&gt;palette_data.palette_name_ids );</span>
<span class="line-added">+     FT_FREE( face-&gt;palette_data.palette_flags );</span>
<span class="line-added">+     FT_FREE( face-&gt;palette_data.palette_entry_name_ids );</span>
<span class="line-added">+     FT_FREE( face-&gt;palette );</span>
<span class="line-added">+ </span>
      face-&gt;sfnt = NULL;
    }
  
  
  /* END */
</pre>
<center><a href="sferrors.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="sfobjs.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>