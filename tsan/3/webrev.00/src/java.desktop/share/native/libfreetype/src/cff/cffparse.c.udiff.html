<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfreetype/src/cff/cffparse.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="cffobjs.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cffparse.h.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/cff/cffparse.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,43 +1,43 @@</span>
<span class="udiff-line-modified-removed">- /***************************************************************************/</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  cffparse.c                                                             */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*    CFF token stream parser (body)                                       */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  Copyright 1996-2018 by                                                 */</span>
<span class="udiff-line-modified-removed">- /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="udiff-line-modified-removed">- /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="udiff-line-modified-removed">- /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="udiff-line-modified-removed">- /*  this file you indicate that you have read the license and              */</span>
<span class="udiff-line-modified-removed">- /*  understand and accept it fully.                                        */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /***************************************************************************/</span>
<span class="udiff-line-modified-added">+ /****************************************************************************</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * cffparse.c</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  *   CFF token stream parser (body)</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 1996-2019 by</span>
<span class="udiff-line-modified-added">+  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * This file is part of the FreeType project, and may only be used,</span>
<span class="udiff-line-modified-added">+  * modified, and distributed under the terms of the FreeType project</span>
<span class="udiff-line-modified-added">+  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="udiff-line-modified-added">+  * this file you indicate that you have read the license and</span>
<span class="udiff-line-modified-added">+  * understand and accept it fully.</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  */</span>
  
  
  #include &lt;ft2build.h&gt;
  #include &quot;cffparse.h&quot;
  #include FT_INTERNAL_STREAM_H
  #include FT_INTERNAL_DEBUG_H
  #include FT_INTERNAL_CALC_H
  #include FT_INTERNAL_POSTSCRIPT_AUX_H
<span class="udiff-line-added">+ #include FT_LIST_H</span>
  
  #include &quot;cfferrs.h&quot;
<span class="udiff-line-removed">- #include &quot;cffpic.h&quot;</span>
  #include &quot;cffload.h&quot;
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="udiff-line-modified-removed">-   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="udiff-line-modified-removed">-   /* messages during execution.                                            */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="udiff-line-modified-added">+    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="udiff-line-modified-added">+    * messages during execution.</span>
<span class="udiff-line-modified-added">+    */</span>
  #undef  FT_COMPONENT
<span class="udiff-line-modified-removed">- #define FT_COMPONENT  trace_cffparse</span>
<span class="udiff-line-modified-added">+ #define FT_COMPONENT  cffparse</span>
  
  
    FT_LOCAL_DEF( FT_Error )
    cff_parser_init( CFF_Parser  parser,
                     FT_UInt     code,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -75,40 +75,109 @@</span>
    Exit:
      return error;
    }
  
  
<span class="udiff-line-added">+ #ifdef CFF_CONFIG_OPTION_OLD_ENGINE</span>
<span class="udiff-line-added">+   static void</span>
<span class="udiff-line-added">+   finalize_t2_strings( FT_Memory  memory,</span>
<span class="udiff-line-added">+                        void*      data,</span>
<span class="udiff-line-added">+                        void*      user )</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     CFF_T2_String  t2 = (CFF_T2_String)data;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     FT_UNUSED( user );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     memory-&gt;free( memory, t2-&gt;start );</span>
<span class="udiff-line-added">+     memory-&gt;free( memory, data );</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ #endif /* CFF_CONFIG_OPTION_OLD_ENGINE */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
    FT_LOCAL_DEF( void )
    cff_parser_done( CFF_Parser  parser )
    {
      FT_Memory  memory = parser-&gt;library-&gt;memory;    /* for FT_FREE */
  
  
      FT_FREE( parser-&gt;stack );
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #ifdef CFF_CONFIG_OPTION_OLD_ENGINE</span>
<span class="udiff-line-added">+     FT_List_Finalize( &amp;parser-&gt;t2_strings,</span>
<span class="udiff-line-added">+                       finalize_t2_strings,</span>
<span class="udiff-line-added">+                       memory,</span>
<span class="udiff-line-added">+                       NULL );</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* Assuming `first &gt;= last&#39;. */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   static FT_Error</span>
<span class="udiff-line-added">+   cff_parser_within_limits( CFF_Parser  parser,</span>
<span class="udiff-line-added">+                             FT_Byte*    first,</span>
<span class="udiff-line-added">+                             FT_Byte*    last )</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+ #ifndef CFF_CONFIG_OPTION_OLD_ENGINE</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* Fast path for regular FreeType builds with the &quot;new&quot; engine; */</span>
<span class="udiff-line-added">+     /*   `first &gt;= parser-&gt;start&#39; can be assumed.                   */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     FT_UNUSED( first );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return last &lt; parser-&gt;limit ? FT_Err_Ok : FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #else /* CFF_CONFIG_OPTION_OLD_ENGINE */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     FT_ListNode  node;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if ( first &gt;= parser-&gt;start &amp;&amp;</span>
<span class="udiff-line-added">+          last  &lt;  parser-&gt;limit )</span>
<span class="udiff-line-added">+       return FT_Err_Ok;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     node = parser-&gt;t2_strings.head;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     while ( node )</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       CFF_T2_String  t2 = (CFF_T2_String)node-&gt;data;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if ( first &gt;= t2-&gt;start &amp;&amp;</span>
<span class="udiff-line-added">+            last  &lt;  t2-&gt;limit )</span>
<span class="udiff-line-added">+         return FT_Err_Ok;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       node = node-&gt;next;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return FT_THROW( Invalid_Argument );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #endif /* CFF_CONFIG_OPTION_OLD_ENGINE */</span>
    }
  
  
    /* read an integer */
    static FT_Long
<span class="udiff-line-modified-removed">-   cff_parse_integer( FT_Byte*  start,</span>
<span class="udiff-line-modified-removed">-                      FT_Byte*  limit )</span>
<span class="udiff-line-modified-added">+   cff_parse_integer( CFF_Parser  parser,</span>
<span class="udiff-line-modified-added">+                      FT_Byte*    start )</span>
    {
      FT_Byte*  p   = start;
      FT_Int    v   = *p++;
      FT_Long   val = 0;
  
  
      if ( v == 28 )
      {
<span class="udiff-line-modified-removed">-       if ( p + 2 &gt; limit )</span>
<span class="udiff-line-modified-added">+       if ( cff_parser_within_limits( parser, p, p + 1 ) )</span>
          goto Bad;
  
        val = (FT_Short)( ( (FT_UShort)p[0] &lt;&lt; 8 ) | p[1] );
      }
      else if ( v == 29 )
      {
<span class="udiff-line-modified-removed">-       if ( p + 4 &gt; limit )</span>
<span class="udiff-line-modified-added">+       if ( cff_parser_within_limits( parser, p, p + 3 ) )</span>
          goto Bad;
  
        val = (FT_Long)( ( (FT_ULong)p[0] &lt;&lt; 24 ) |
                         ( (FT_ULong)p[1] &lt;&lt; 16 ) |
                         ( (FT_ULong)p[2] &lt;&lt;  8 ) |
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -118,18 +187,18 @@</span>
      {
        val = v - 139;
      }
      else if ( v &lt; 251 )
      {
<span class="udiff-line-modified-removed">-       if ( p + 1 &gt; limit )</span>
<span class="udiff-line-modified-added">+       if ( cff_parser_within_limits( parser, p, p ) )</span>
          goto Bad;
  
        val = ( v - 247 ) * 256 + p[0] + 108;
      }
      else
      {
<span class="udiff-line-modified-removed">-       if ( p + 1 &gt; limit )</span>
<span class="udiff-line-modified-added">+       if ( cff_parser_within_limits( parser, p, p ) )</span>
          goto Bad;
  
        val = -( v - 251 ) * 256 - p[0] - 108;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -174,14 +243,14 @@</span>
    };
  
  
    /* read a real */
    static FT_Fixed
<span class="udiff-line-modified-removed">-   cff_parse_real( FT_Byte*  start,</span>
<span class="udiff-line-modified-removed">-                   FT_Byte*  limit,</span>
<span class="udiff-line-modified-removed">-                   FT_Long   power_ten,</span>
<span class="udiff-line-modified-removed">-                   FT_Long*  scaling )</span>
<span class="udiff-line-modified-added">+   cff_parse_real( CFF_Parser  parser,</span>
<span class="udiff-line-modified-added">+                   FT_Byte*    start,</span>
<span class="udiff-line-modified-added">+                   FT_Long     power_ten,</span>
<span class="udiff-line-modified-added">+                   FT_Long*    scaling )</span>
    {
      FT_Byte*  p = start;
      FT_Int    nib;
      FT_UInt   phase;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -212,11 +281,11 @@</span>
        if ( phase )
        {
          p++;
  
          /* Make sure we don&#39;t read past the end. */
<span class="udiff-line-modified-removed">-         if ( p &gt;= limit )</span>
<span class="udiff-line-modified-added">+         if ( cff_parser_within_limits( parser, p, p ) )</span>
            goto Bad;
        }
  
        /* Get the nibble. */
        nib   = (FT_Int)( p[0] &gt;&gt; phase ) &amp; 0xF;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -249,11 +318,11 @@</span>
          if ( phase )
          {
            p++;
  
            /* Make sure we don&#39;t read past the end. */
<span class="udiff-line-modified-removed">-           if ( p &gt;= limit )</span>
<span class="udiff-line-modified-added">+           if ( cff_parser_within_limits( parser, p, p ) )</span>
              goto Bad;
          }
  
          /* Get the nibble. */
          nib   = ( p[0] &gt;&gt; phase ) &amp; 0xF;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -288,11 +357,11 @@</span>
          if ( phase )
          {
            p++;
  
            /* Make sure we don&#39;t read past the end. */
<span class="udiff-line-modified-removed">-           if ( p &gt;= limit )</span>
<span class="udiff-line-modified-added">+           if ( cff_parser_within_limits( parser, p, p ) )</span>
              goto Bad;
          }
  
          /* Get the nibble. */
          nib   = ( p[0] &gt;&gt; phase ) &amp; 0xF;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -455,11 +524,11 @@</span>
                   FT_Byte**   d )
    {
      if ( **d == 30 )
      {
        /* binary-coded decimal is truncated to integer */
<span class="udiff-line-modified-removed">-       return cff_parse_real( *d, parser-&gt;limit, 0, NULL ) &gt;&gt; 16;</span>
<span class="udiff-line-modified-added">+       return cff_parse_real( parser, *d, 0, NULL ) &gt;&gt; 16;</span>
      }
  
      else if ( **d == 255 )
      {
        /* 16.16 fixed point is used internally for CFF2 blend results. */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -481,25 +550,25 @@</span>
                       (FT_UInt32)*( d[0] + 3 )         ) + 0x80U ) &gt;&gt; 8 );
  #endif
      }
  
      else
<span class="udiff-line-modified-removed">-       return cff_parse_integer( *d, parser-&gt;limit );</span>
<span class="udiff-line-modified-added">+       return cff_parse_integer( parser, *d );</span>
    }
  
  
    /* read a floating point number, either integer or real */
    static FT_Fixed
    do_fixed( CFF_Parser  parser,
              FT_Byte**   d,
              FT_Long     scaling )
    {
      if ( **d == 30 )
<span class="udiff-line-modified-removed">-       return cff_parse_real( *d, parser-&gt;limit, scaling, NULL );</span>
<span class="udiff-line-modified-added">+       return cff_parse_real( parser, *d, scaling, NULL );</span>
      else
      {
<span class="udiff-line-modified-removed">-       FT_Long  val = cff_parse_integer( *d, parser-&gt;limit );</span>
<span class="udiff-line-modified-added">+       FT_Long  val = cff_parse_integer( parser, *d );</span>
  
  
        if ( scaling )
        {
          if ( FT_ABS( val ) &gt; power_ten_limits[scaling] )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -560,18 +629,18 @@</span>
                             FT_Long*    scaling )
    {
      FT_ASSERT( scaling );
  
      if ( **d == 30 )
<span class="udiff-line-modified-removed">-       return cff_parse_real( *d, parser-&gt;limit, 0, scaling );</span>
<span class="udiff-line-modified-added">+       return cff_parse_real( parser, *d, 0, scaling );</span>
      else
      {
        FT_Long  number;
        FT_Int   integer_length;
  
  
<span class="udiff-line-modified-removed">-       number = cff_parse_integer( d[0], d[1] );</span>
<span class="udiff-line-modified-added">+       number = cff_parse_integer( parser, d[0] );</span>
  
        if ( number &gt; 0x7FFFL )
        {
          for ( integer_length = 5; integer_length &lt; 10; integer_length++ )
            if ( number &lt; power_tens[integer_length] )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -603,11 +672,10 @@</span>
      CFF_FontRecDict  dict   = (CFF_FontRecDict)parser-&gt;object;
      FT_Matrix*       matrix = &amp;dict-&gt;font_matrix;
      FT_Vector*       offset = &amp;dict-&gt;font_offset;
      FT_ULong*        upm    = &amp;dict-&gt;units_per_em;
      FT_Byte**        data   = parser-&gt;stack;
<span class="udiff-line-removed">-     FT_Error         error  = FT_ERR( Stack_Underflow );</span>
  
  
      if ( parser-&gt;top &gt;= parser-&gt;stack + 6 )
      {
        FT_Fixed  values[6];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -615,12 +683,10 @@</span>
  
        FT_Long  min_scaling, max_scaling;
        int      i;
  
  
<span class="udiff-line-removed">-       error = FT_Err_Ok;</span>
<span class="udiff-line-removed">- </span>
        dict-&gt;has_font_matrix = TRUE;
  
        /* We expect a well-formed font matrix, this is, the matrix elements */
        /* `xx&#39; and `yy&#39; are of approximately the same magnitude.  To avoid  */
        /* loss of precision, we use the magnitude of the largest matrix     */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -645,26 +711,15 @@</span>
        if ( max_scaling &lt; -9                  ||
             max_scaling &gt; 0                   ||
             ( max_scaling - min_scaling ) &lt; 0 ||
             ( max_scaling - min_scaling ) &gt; 9 )
        {
<span class="udiff-line-removed">-         /* Return default matrix in case of unlikely values. */</span>
<span class="udiff-line-removed">- </span>
          FT_TRACE1(( &quot;cff_parse_font_matrix:&quot;
                      &quot; strange scaling values (minimum %d, maximum %d),\n&quot;
                      &quot;                      &quot;
                      &quot; using default matrix\n&quot;, min_scaling, max_scaling ));
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         matrix-&gt;xx = 0x10000L;</span>
<span class="udiff-line-removed">-         matrix-&gt;yx = 0;</span>
<span class="udiff-line-removed">-         matrix-&gt;xy = 0;</span>
<span class="udiff-line-removed">-         matrix-&gt;yy = 0x10000L;</span>
<span class="udiff-line-removed">-         offset-&gt;x  = 0;</span>
<span class="udiff-line-removed">-         offset-&gt;y  = 0;</span>
<span class="udiff-line-removed">-         *upm       = 1;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         goto Exit;</span>
<span class="udiff-line-modified-added">+         goto Unlikely;</span>
        }
  
        for ( i = 0; i &lt; 6; i++ )
        {
          FT_Fixed  value = values[i];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -707,14 +762,35 @@</span>
                    (double)matrix-&gt;xy / *upm / 65536,
                    (double)matrix-&gt;yx / *upm / 65536,
                    (double)matrix-&gt;yy / *upm / 65536,
                    (double)offset-&gt;x  / *upm / 65536,
                    (double)offset-&gt;y  / *upm / 65536 ));
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if ( !FT_Matrix_Check( matrix ) )</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         FT_TRACE1(( &quot;cff_parse_font_matrix:&quot;</span>
<span class="udiff-line-added">+                     &quot; degenerate values, using default matrix\n&quot; ));</span>
<span class="udiff-line-added">+         goto Unlikely;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       return FT_Err_Ok;</span>
      }
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+       return FT_THROW( Stack_Underflow );</span>
  
<span class="udiff-line-modified-removed">-   Exit:</span>
<span class="udiff-line-modified-removed">-     return error;</span>
<span class="udiff-line-modified-added">+   Unlikely:</span>
<span class="udiff-line-modified-added">+     /* Return default matrix in case of unlikely values. */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     matrix-&gt;xx = 0x10000L;</span>
<span class="udiff-line-added">+     matrix-&gt;yx = 0;</span>
<span class="udiff-line-added">+     matrix-&gt;xy = 0;</span>
<span class="udiff-line-added">+     matrix-&gt;yy = 0x10000L;</span>
<span class="udiff-line-added">+     offset-&gt;x  = 0;</span>
<span class="udiff-line-added">+     offset-&gt;y  = 0;</span>
<span class="udiff-line-added">+     *upm       = 1;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return FT_Err_Ok;</span>
    }
  
  
    static FT_Error
    cff_parse_font_bbox( CFF_Parser  parser )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -800,11 +876,11 @@</span>
      FT_Error         error;
  
  
  #ifdef FT_DEBUG_LEVEL_TRACE
      /* beautify tracing message */
<span class="udiff-line-modified-removed">-     if ( ft_trace_levels[FT_COMPONENT] &lt; 4 )</span>
<span class="udiff-line-modified-added">+     if ( ft_trace_levels[FT_TRACE_COMP( FT_COMPONENT )] &lt; 4 )</span>
        FT_TRACE1(( &quot;Multiple Master CFFs not supported yet,&quot;
                    &quot; handling first master design only\n&quot; ));
      else
        FT_TRACE1(( &quot; (not supported yet,&quot;
                    &quot; handling first master design only)\n&quot; ));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1001,13 +1077,10 @@</span>
            CFF_FIELD( code, name, id, cff_kind_string )
  #define CFF_FIELD_BOOL( code, name, id )             \
            CFF_FIELD( code, name, id, cff_kind_bool )
  
  
<span class="udiff-line-removed">- #ifndef FT_CONFIG_OPTION_PIC</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  #undef  CFF_FIELD
  #undef  CFF_FIELD_DELTA
  
  
  #ifndef FT_DEBUG_LEVEL_TRACE
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1116,213 +1189,35 @@</span>
  
  
  #endif /* FT_DEBUG_LEVEL_TRACE */
  
  
<span class="udiff-line-removed">- #else /* FT_CONFIG_OPTION_PIC */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   void</span>
<span class="udiff-line-removed">-   FT_Destroy_Class_cff_field_handlers( FT_Library          library,</span>
<span class="udiff-line-removed">-                                        CFF_Field_Handler*  clazz )</span>
<span class="udiff-line-removed">-   {</span>
<span class="udiff-line-removed">-     FT_Memory  memory = library-&gt;memory;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if ( clazz )</span>
<span class="udiff-line-removed">-       FT_FREE( clazz );</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   FT_Error</span>
<span class="udiff-line-removed">-   FT_Create_Class_cff_field_handlers( FT_Library           library,</span>
<span class="udiff-line-removed">-                                       CFF_Field_Handler**  output_class )</span>
<span class="udiff-line-removed">-   {</span>
<span class="udiff-line-removed">-     CFF_Field_Handler*  clazz  = NULL;</span>
<span class="udiff-line-removed">-     FT_Error            error;</span>
<span class="udiff-line-removed">-     FT_Memory           memory = library-&gt;memory;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     int  i = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef CFF_FIELD</span>
<span class="udiff-line-removed">- #define CFF_FIELD( code, name, id, kind ) i++;</span>
<span class="udiff-line-removed">- #undef CFF_FIELD_DELTA</span>
<span class="udiff-line-removed">- #define CFF_FIELD_DELTA( code, name, max, id ) i++;</span>
<span class="udiff-line-removed">- #undef CFF_FIELD_CALLBACK</span>
<span class="udiff-line-removed">- #define CFF_FIELD_CALLBACK( code, name, id ) i++;</span>
<span class="udiff-line-removed">- #undef CFF_FIELD_BLEND</span>
<span class="udiff-line-removed">- #define CFF_FIELD_BLEND( code, id ) i++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #include &quot;cfftoken.h&quot;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     i++; /* { 0, 0, 0, 0, 0, 0, 0 } */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if ( FT_ALLOC( clazz, sizeof ( CFF_Field_Handler ) * i ) )</span>
<span class="udiff-line-removed">-       return error;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     i = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #ifndef FT_DEBUG_LEVEL_TRACE</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef CFF_FIELD_CALLBACK</span>
<span class="udiff-line-removed">- #define CFF_FIELD_CALLBACK( code_, name_, id_ )        \</span>
<span class="udiff-line-removed">-           clazz[i].kind         = cff_kind_callback;   \</span>
<span class="udiff-line-removed">-           clazz[i].code         = code_ | CFFCODE;     \</span>
<span class="udiff-line-removed">-           clazz[i].offset       = 0;                   \</span>
<span class="udiff-line-removed">-           clazz[i].size         = 0;                   \</span>
<span class="udiff-line-removed">-           clazz[i].reader       = cff_parse_ ## name_; \</span>
<span class="udiff-line-removed">-           clazz[i].array_max    = 0;                   \</span>
<span class="udiff-line-removed">-           clazz[i].count_offset = 0;                   \</span>
<span class="udiff-line-removed">-           i++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef  CFF_FIELD</span>
<span class="udiff-line-removed">- #define CFF_FIELD( code_, name_, id_, kind_ )               \</span>
<span class="udiff-line-removed">-           clazz[i].kind         = kind_;                    \</span>
<span class="udiff-line-removed">-           clazz[i].code         = code_ | CFFCODE;          \</span>
<span class="udiff-line-removed">-           clazz[i].offset       = FT_FIELD_OFFSET( name_ ); \</span>
<span class="udiff-line-removed">-           clazz[i].size         = FT_FIELD_SIZE( name_ );   \</span>
<span class="udiff-line-removed">-           clazz[i].reader       = 0;                        \</span>
<span class="udiff-line-removed">-           clazz[i].array_max    = 0;                        \</span>
<span class="udiff-line-removed">-           clazz[i].count_offset = 0;                        \</span>
<span class="udiff-line-removed">-           i++;                                              \</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef  CFF_FIELD_DELTA</span>
<span class="udiff-line-removed">- #define CFF_FIELD_DELTA( code_, name_, max_, id_ )                  \</span>
<span class="udiff-line-removed">-           clazz[i].kind         = cff_kind_delta;                   \</span>
<span class="udiff-line-removed">-           clazz[i].code         = code_ | CFFCODE;                  \</span>
<span class="udiff-line-removed">-           clazz[i].offset       = FT_FIELD_OFFSET( name_ );         \</span>
<span class="udiff-line-removed">-           clazz[i].size         = FT_FIELD_SIZE_DELTA( name_ );     \</span>
<span class="udiff-line-removed">-           clazz[i].reader       = 0;                                \</span>
<span class="udiff-line-removed">-           clazz[i].array_max    = max_;                             \</span>
<span class="udiff-line-removed">-           clazz[i].count_offset = FT_FIELD_OFFSET( num_ ## name_ ); \</span>
<span class="udiff-line-removed">-           i++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef  CFF_FIELD_BLEND</span>
<span class="udiff-line-removed">- #define CFF_FIELD_BLEND( code_, id_ )              \</span>
<span class="udiff-line-removed">-           clazz[i].kind         = cff_kind_blend;  \</span>
<span class="udiff-line-removed">-           clazz[i].code         = code_ | CFFCODE; \</span>
<span class="udiff-line-removed">-           clazz[i].offset       = 0;               \</span>
<span class="udiff-line-removed">-           clazz[i].size         = 0;               \</span>
<span class="udiff-line-removed">-           clazz[i].reader       = cff_parse_blend; \</span>
<span class="udiff-line-removed">-           clazz[i].array_max    = 0;               \</span>
<span class="udiff-line-removed">-           clazz[i].count_offset = 0;               \</span>
<span class="udiff-line-removed">-           i++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #include &quot;cfftoken.h&quot;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     clazz[i].kind         = 0;</span>
<span class="udiff-line-removed">-     clazz[i].code         = 0;</span>
<span class="udiff-line-removed">-     clazz[i].offset       = 0;</span>
<span class="udiff-line-removed">-     clazz[i].size         = 0;</span>
<span class="udiff-line-removed">-     clazz[i].reader       = 0;</span>
<span class="udiff-line-removed">-     clazz[i].array_max    = 0;</span>
<span class="udiff-line-removed">-     clazz[i].count_offset = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #else /* FT_DEBUG_LEVEL_TRACE */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef CFF_FIELD_CALLBACK</span>
<span class="udiff-line-removed">- #define CFF_FIELD_CALLBACK( code_, name_, id_ )        \</span>
<span class="udiff-line-removed">-           clazz[i].kind         = cff_kind_callback;   \</span>
<span class="udiff-line-removed">-           clazz[i].code         = code_ | CFFCODE;     \</span>
<span class="udiff-line-removed">-           clazz[i].offset       = 0;                   \</span>
<span class="udiff-line-removed">-           clazz[i].size         = 0;                   \</span>
<span class="udiff-line-removed">-           clazz[i].reader       = cff_parse_ ## name_; \</span>
<span class="udiff-line-removed">-           clazz[i].array_max    = 0;                   \</span>
<span class="udiff-line-removed">-           clazz[i].count_offset = 0;                   \</span>
<span class="udiff-line-removed">-           clazz[i].id           = id_;                 \</span>
<span class="udiff-line-removed">-           i++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef  CFF_FIELD</span>
<span class="udiff-line-removed">- #define CFF_FIELD( code_, name_, id_, kind_ )               \</span>
<span class="udiff-line-removed">-           clazz[i].kind         = kind_;                    \</span>
<span class="udiff-line-removed">-           clazz[i].code         = code_ | CFFCODE;          \</span>
<span class="udiff-line-removed">-           clazz[i].offset       = FT_FIELD_OFFSET( name_ ); \</span>
<span class="udiff-line-removed">-           clazz[i].size         = FT_FIELD_SIZE( name_ );   \</span>
<span class="udiff-line-removed">-           clazz[i].reader       = 0;                        \</span>
<span class="udiff-line-removed">-           clazz[i].array_max    = 0;                        \</span>
<span class="udiff-line-removed">-           clazz[i].count_offset = 0;                        \</span>
<span class="udiff-line-removed">-           clazz[i].id           = id_;                      \</span>
<span class="udiff-line-removed">-           i++;                                              \</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef  CFF_FIELD_DELTA</span>
<span class="udiff-line-removed">- #define CFF_FIELD_DELTA( code_, name_, max_, id_ )                  \</span>
<span class="udiff-line-removed">-           clazz[i].kind         = cff_kind_delta;                   \</span>
<span class="udiff-line-removed">-           clazz[i].code         = code_ | CFFCODE;                  \</span>
<span class="udiff-line-removed">-           clazz[i].offset       = FT_FIELD_OFFSET( name_ );         \</span>
<span class="udiff-line-removed">-           clazz[i].size         = FT_FIELD_SIZE_DELTA( name_ );     \</span>
<span class="udiff-line-removed">-           clazz[i].reader       = 0;                                \</span>
<span class="udiff-line-removed">-           clazz[i].array_max    = max_;                             \</span>
<span class="udiff-line-removed">-           clazz[i].count_offset = FT_FIELD_OFFSET( num_ ## name_ ); \</span>
<span class="udiff-line-removed">-           clazz[i].id           = id_;                              \</span>
<span class="udiff-line-removed">-           i++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #undef  CFF_FIELD_BLEND</span>
<span class="udiff-line-removed">- #define CFF_FIELD_BLEND( code_, id_ )              \</span>
<span class="udiff-line-removed">-           clazz[i].kind         = cff_kind_blend;  \</span>
<span class="udiff-line-removed">-           clazz[i].code         = code_ | CFFCODE; \</span>
<span class="udiff-line-removed">-           clazz[i].offset       = 0;               \</span>
<span class="udiff-line-removed">-           clazz[i].size         = 0;               \</span>
<span class="udiff-line-removed">-           clazz[i].reader       = cff_parse_blend; \</span>
<span class="udiff-line-removed">-           clazz[i].array_max    = 0;               \</span>
<span class="udiff-line-removed">-           clazz[i].count_offset = 0;               \</span>
<span class="udiff-line-removed">-           clazz[i].id           = id_;             \</span>
<span class="udiff-line-removed">-           i++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #include &quot;cfftoken.h&quot;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     clazz[i].kind         = 0;</span>
<span class="udiff-line-removed">-     clazz[i].code         = 0;</span>
<span class="udiff-line-removed">-     clazz[i].offset       = 0;</span>
<span class="udiff-line-removed">-     clazz[i].size         = 0;</span>
<span class="udiff-line-removed">-     clazz[i].reader       = 0;</span>
<span class="udiff-line-removed">-     clazz[i].array_max    = 0;</span>
<span class="udiff-line-removed">-     clazz[i].count_offset = 0;</span>
<span class="udiff-line-removed">-     clazz[i].id           = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #endif /* FT_DEBUG_LEVEL_TRACE */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     *output_class = clazz;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return FT_Err_Ok;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #endif /* FT_CONFIG_OPTION_PIC */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
    FT_LOCAL_DEF( FT_Error )
    cff_parser_run( CFF_Parser  parser,
                    FT_Byte*    start,
                    FT_Byte*    limit )
    {
<span class="udiff-line-added">+     FT_Byte*  p     = start;</span>
<span class="udiff-line-added">+     FT_Error  error = FT_Err_Ok;</span>
<span class="udiff-line-added">+ </span>
  #ifdef CFF_CONFIG_OPTION_OLD_ENGINE
      PSAux_Service  psaux;
<span class="udiff-line-removed">- #endif</span>
  
<span class="udiff-line-removed">-     FT_Byte*    p       = start;</span>
<span class="udiff-line-removed">-     FT_Error    error   = FT_Err_Ok;</span>
      FT_Library  library = parser-&gt;library;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     FT_UNUSED( library );</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+     FT_Memory   memory  = library-&gt;memory;</span>
<span class="udiff-line-modified-added">+ #endif</span>
  
      parser-&gt;top    = parser-&gt;stack;
      parser-&gt;start  = start;
      parser-&gt;limit  = limit;
      parser-&gt;cursor = start;
  
      while ( p &lt; limit )
      {
        FT_UInt  v = *p;
  
<span class="udiff-line-added">+ </span>
        /* Opcode 31 is legacy MM T2 operator, not a number.      */
        /* Opcode 255 is reserved and should not appear in fonts; */
        /* it is used internally for CFF2 blends.                 */
        if ( v &gt;= 27 &amp;&amp; v != 31 &amp;&amp; v != 255 )
        {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1367,12 +1262,15 @@</span>
          CFF_Decoder  decoder;
          CFF_FontRec  cff_rec;
          FT_Byte*     charstring_base;
          FT_ULong     charstring_len;
  
<span class="udiff-line-modified-removed">-         FT_Fixed*  stack;</span>
<span class="udiff-line-modified-removed">-         FT_Byte*   q;</span>
<span class="udiff-line-modified-added">+         FT_Fixed*     stack;</span>
<span class="udiff-line-modified-added">+         FT_ListNode   node;</span>
<span class="udiff-line-added">+         CFF_T2_String t2;</span>
<span class="udiff-line-added">+         size_t        t2_size;</span>
<span class="udiff-line-added">+         FT_Byte*      q;</span>
  
  
          charstring_base = ++p;
  
          /* search `endchar&#39; operator */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1403,21 +1301,43 @@</span>
            goto Exit;
          }
  
          error = psaux-&gt;cff_decoder_funcs-&gt;parse_charstrings_old(
                    &amp;decoder, charstring_base, charstring_len, 1 );
<span class="udiff-line-added">+         if ( error )</span>
<span class="udiff-line-added">+           goto Exit;</span>
  
          /* Now copy the stack data in the temporary decoder object,    */
          /* converting it back to charstring number representations     */
          /* (this is ugly, I know).                                     */
<span class="udiff-line-removed">-         /*                                                             */</span>
<span class="udiff-line-removed">-         /* We overwrite the original top DICT charstring under the     */</span>
<span class="udiff-line-removed">-         /* assumption that the charstring representation of the result */</span>
<span class="udiff-line-removed">-         /* of `cff_decoder_parse_charstrings&#39; is shorter, which should */</span>
<span class="udiff-line-removed">-         /* be always true.                                             */</span>
  
<span class="udiff-line-modified-removed">-         q     = charstring_base - 1;</span>
<span class="udiff-line-modified-added">+         node = (FT_ListNode)memory-&gt;alloc( memory,</span>
<span class="udiff-line-added">+                                            sizeof ( FT_ListNodeRec ) );</span>
<span class="udiff-line-added">+         if ( !node )</span>
<span class="udiff-line-added">+           goto Out_Of_Memory_Error;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         FT_List_Add( &amp;parser-&gt;t2_strings, node );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         t2 = (CFF_T2_String)memory-&gt;alloc( memory,</span>
<span class="udiff-line-added">+                                            sizeof ( CFF_T2_StringRec ) );</span>
<span class="udiff-line-added">+         if ( !t2 )</span>
<span class="udiff-line-added">+           goto Out_Of_Memory_Error;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         node-&gt;data = t2;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         /* `5&#39; is the conservative upper bound of required bytes per stack */</span>
<span class="udiff-line-added">+         /* element.                                                        */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         t2_size = 5 * ( decoder.top - decoder.stack );</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         q = (FT_Byte*)memory-&gt;alloc( memory, t2_size );</span>
<span class="udiff-line-added">+         if ( !q )</span>
<span class="udiff-line-added">+           goto Out_Of_Memory_Error;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         t2-&gt;start = q;</span>
<span class="udiff-line-added">+         t2-&gt;limit = q + t2_size;</span>
<span class="udiff-line-added">+ </span>
          stack = decoder.stack;
  
          while ( stack &lt; decoder.top )
          {
            FT_ULong  num;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1429,11 +1349,11 @@</span>
  
            *parser-&gt;top++ = q;
  
            if ( *stack &lt; 0 )
            {
<span class="udiff-line-modified-removed">-             num = (FT_ULong)-*stack;</span>
<span class="udiff-line-modified-added">+             num = (FT_ULong)NEG_LONG( *stack );</span>
              neg = 1;
            }
            else
            {
              num = (FT_ULong)*stack;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1521,11 +1441,11 @@</span>
  
            code = 0x100 | p[0];
          }
          code = code | parser-&gt;object_code;
  
<span class="udiff-line-modified-removed">-         for ( field = CFF_FIELD_HANDLERS_GET; field-&gt;kind; field++ )</span>
<span class="udiff-line-modified-added">+         for ( field = cff_field_handlers; field-&gt;kind; field++ )</span>
          {
            if ( field-&gt;code == (FT_Int)code )
            {
              /* we found our field&#39;s handler; read it */
              FT_Long   val;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1670,15 +1590,21 @@</span>
          /*       but we don&#39;t have access to subFont */
          if ( field-&gt;kind != cff_kind_blend )
            parser-&gt;top = parser-&gt;stack;
        }
        p++;
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     } /* while ( p &lt; limit ) */</span>
  
    Exit:
      return error;
  
<span class="udiff-line-added">+ #ifdef CFF_CONFIG_OPTION_OLD_ENGINE</span>
<span class="udiff-line-added">+   Out_Of_Memory_Error:</span>
<span class="udiff-line-added">+     error = FT_THROW( Out_Of_Memory );</span>
<span class="udiff-line-added">+     goto Exit;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
    Stack_Overflow:
      error = FT_THROW( Invalid_Argument );
      goto Exit;
  
    Stack_Underflow:
</pre>
<center><a href="cffobjs.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cffparse.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>