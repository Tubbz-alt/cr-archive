<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/sfnt/ttload.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ttkern.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttload.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/sfnt/ttload.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 /***************************************************************************/</span>
<span class="line-modified">   2 /*                                                                         */</span>
<span class="line-modified">   3 /*  ttload.c                                                               */</span>
<span class="line-modified">   4 /*                                                                         */</span>
<span class="line-modified">   5 /*    Load the basic TrueType tables, i.e., tables that can be either in   */</span>
<span class="line-modified">   6 /*    TTF or OTF fonts (body).                                             */</span>
<span class="line-modified">   7 /*                                                                         */</span>
<span class="line-modified">   8 /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">   9 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">  10 /*                                                                         */</span>
<span class="line-modified">  11 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">  12 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">  13 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">  14 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">  15 /*  understand and accept it fully.                                        */</span>
<span class="line-modified">  16 /*                                                                         */</span>
<span class="line-modified">  17 /***************************************************************************/</span>
  18 
  19 
  20 #include &lt;ft2build.h&gt;
  21 #include FT_INTERNAL_DEBUG_H
  22 #include FT_INTERNAL_STREAM_H
  23 #include FT_TRUETYPE_TAGS_H
  24 #include &quot;ttload.h&quot;
  25 
  26 #include &quot;sferrors.h&quot;
  27 
  28 
<span class="line-modified">  29   /*************************************************************************/</span>
<span class="line-modified">  30   /*                                                                       */</span>
<span class="line-modified">  31   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified">  32   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified">  33   /* messages during execution.                                            */</span>
<span class="line-modified">  34   /*                                                                       */</span>
  35 #undef  FT_COMPONENT
<span class="line-modified">  36 #define FT_COMPONENT  trace_ttload</span>
<span class="line-modified">  37 </span>
<span class="line-modified">  38 </span>
<span class="line-modified">  39   /*************************************************************************/</span>
<span class="line-modified">  40   /*                                                                       */</span>
<span class="line-modified">  41   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">  42   /*    tt_face_lookup_table                                               */</span>
<span class="line-modified">  43   /*                                                                       */</span>
<span class="line-modified">  44   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">  45   /*    Looks for a TrueType table by name.                                */</span>
<span class="line-modified">  46   /*                                                                       */</span>
<span class="line-modified">  47   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">  48   /*    face :: A face object handle.                                      */</span>
<span class="line-modified">  49   /*                                                                       */</span>
<span class="line-modified">  50   /*    tag  :: The searched tag.                                          */</span>
<span class="line-modified">  51   /*                                                                       */</span>
<span class="line-modified">  52   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">  53   /*    A pointer to the table directory entry.  0 if not found.           */</span>
<span class="line-modified">  54   /*                                                                       */</span>


  55   FT_LOCAL_DEF( TT_Table  )
  56   tt_face_lookup_table( TT_Face   face,
  57                         FT_ULong  tag  )
  58   {
  59     TT_Table  entry;
  60     TT_Table  limit;
  61 #ifdef FT_DEBUG_LEVEL_TRACE
  62     FT_Bool   zero_length = FALSE;
  63 #endif
  64 
  65 
  66     FT_TRACE4(( &quot;tt_face_lookup_table: %08p, `%c%c%c%c&#39; -- &quot;,
  67                 face,
  68                 (FT_Char)( tag &gt;&gt; 24 ),
  69                 (FT_Char)( tag &gt;&gt; 16 ),
  70                 (FT_Char)( tag &gt;&gt; 8  ),
  71                 (FT_Char)( tag       ) ));
  72 
  73     entry = face-&gt;dir_tables;
  74     limit = entry + face-&gt;num_tables;
</pre>
<hr />
<pre>
  84           FT_TRACE4(( &quot;found table.\n&quot; ));
  85           return entry;
  86         }
  87 #ifdef FT_DEBUG_LEVEL_TRACE
  88         zero_length = TRUE;
  89 #endif
  90       }
  91     }
  92 
  93 #ifdef FT_DEBUG_LEVEL_TRACE
  94     if ( zero_length )
  95       FT_TRACE4(( &quot;ignoring empty table\n&quot; ));
  96     else
  97       FT_TRACE4(( &quot;could not find table\n&quot; ));
  98 #endif
  99 
 100     return NULL;
 101   }
 102 
 103 
<span class="line-modified"> 104   /*************************************************************************/</span>
<span class="line-modified"> 105   /*                                                                       */</span>
<span class="line-modified"> 106   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 107   /*    tt_face_goto_table                                                 */</span>
<span class="line-modified"> 108   /*                                                                       */</span>
<span class="line-modified"> 109   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 110   /*    Looks for a TrueType table by name, then seek a stream to it.      */</span>
<span class="line-modified"> 111   /*                                                                       */</span>
<span class="line-modified"> 112   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 113   /*    face   :: A face object handle.                                    */</span>
<span class="line-modified"> 114   /*                                                                       */</span>
<span class="line-modified"> 115   /*    tag    :: The searched tag.                                        */</span>
<span class="line-modified"> 116   /*                                                                       */</span>
<span class="line-modified"> 117   /*    stream :: The stream to seek when the table is found.              */</span>
<span class="line-modified"> 118   /*                                                                       */</span>
<span class="line-modified"> 119   /* &lt;Output&gt;                                                              */</span>
<span class="line-modified"> 120   /*    length :: The length of the table if found, undefined otherwise.   */</span>
<span class="line-modified"> 121   /*                                                                       */</span>
<span class="line-modified"> 122   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 123   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 124   /*                                                                       */</span>




 125   FT_LOCAL_DEF( FT_Error )
 126   tt_face_goto_table( TT_Face    face,
 127                       FT_ULong   tag,
 128                       FT_Stream  stream,
 129                       FT_ULong*  length )
 130   {
 131     TT_Table  table;
 132     FT_Error  error;
 133 
 134 
 135     table = tt_face_lookup_table( face, tag );
 136     if ( table )
 137     {
 138       if ( length )
 139         *length = table-&gt;Length;
 140 
 141       if ( FT_STREAM_SEEK( table-&gt;Offset ) )
 142         goto Exit;
 143     }
 144     else
</pre>
<hr />
<pre>
 292     {
 293       error = FT_Err_Ok;
 294       goto Exit;
 295     }
 296     else
 297     {
 298       FT_TRACE2(( &quot;check_table_dir:&quot; ));
 299 #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
 300       FT_TRACE2(( &quot; neither `head&#39;, `bhed&#39;, nor `sing&#39; table found\n&quot; ));
 301 #else
 302       FT_TRACE2(( &quot; neither `head&#39; nor `sing&#39; table found\n&quot; ));
 303 #endif
 304       error = FT_THROW( Table_Missing );
 305     }
 306 
 307   Exit:
 308     return error;
 309   }
 310 
 311 
<span class="line-modified"> 312   /*************************************************************************/</span>
<span class="line-modified"> 313   /*                                                                       */</span>
<span class="line-modified"> 314   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 315   /*    tt_face_load_font_dir                                              */</span>
<span class="line-modified"> 316   /*                                                                       */</span>
<span class="line-modified"> 317   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 318   /*    Loads the header of a SFNT font file.                              */</span>
<span class="line-modified"> 319   /*                                                                       */</span>
<span class="line-modified"> 320   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 321   /*    face       :: A handle to the target face object.                  */</span>
<span class="line-modified"> 322   /*                                                                       */</span>
<span class="line-modified"> 323   /*    stream     :: The input stream.                                    */</span>
<span class="line-modified"> 324   /*                                                                       */</span>
<span class="line-modified"> 325   /* &lt;Output&gt;                                                              */</span>
<span class="line-modified"> 326   /*    sfnt       :: The SFNT header.                                     */</span>
<span class="line-modified"> 327   /*                                                                       */</span>
<span class="line-modified"> 328   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 329   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 330   /*                                                                       */</span>
<span class="line-modified"> 331   /* &lt;Note&gt;                                                                */</span>
<span class="line-modified"> 332   /*    The stream cursor must be at the beginning of the font directory.  */</span>
<span class="line-modified"> 333   /*                                                                       */</span>



 334   FT_LOCAL_DEF( FT_Error )
 335   tt_face_load_font_dir( TT_Face    face,
 336                          FT_Stream  stream )
 337   {
 338     SFNT_HeaderRec  sfnt;
 339     FT_Error        error;
 340     FT_Memory       memory = stream-&gt;memory;
 341     FT_UShort       nn, valid_entries = 0;
 342 
 343     static const FT_Frame_Field  offset_table_fields[] =
 344     {
 345 #undef  FT_STRUCTURE
 346 #define FT_STRUCTURE  SFNT_HeaderRec
 347 
 348       FT_FRAME_START( 8 ),
 349         FT_FRAME_USHORT( num_tables ),
 350         FT_FRAME_USHORT( search_range ),
 351         FT_FRAME_USHORT( entry_selector ),
 352         FT_FRAME_USHORT( range_shift ),
 353       FT_FRAME_END
</pre>
<hr />
<pre>
 479       {
 480         FT_TRACE2(( &quot;\n&quot; ));
 481 
 482         /* we finally have a valid entry */
 483         face-&gt;dir_tables[valid_entries++] = entry;
 484       }
 485     }
 486 
 487     /* final adjustment to number of tables */
 488     face-&gt;num_tables = valid_entries;
 489 
 490     FT_FRAME_EXIT();
 491 
 492     FT_TRACE2(( &quot;table directory loaded\n\n&quot; ));
 493 
 494   Exit:
 495     return error;
 496   }
 497 
 498 
<span class="line-modified"> 499   /*************************************************************************/</span>
<span class="line-modified"> 500   /*                                                                       */</span>
<span class="line-modified"> 501   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 502   /*    tt_face_load_any                                                   */</span>
<span class="line-modified"> 503   /*                                                                       */</span>
<span class="line-modified"> 504   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 505   /*    Loads any font table into client memory.                           */</span>
<span class="line-modified"> 506   /*                                                                       */</span>
<span class="line-modified"> 507   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 508   /*    face   :: The face object to look for.                             */</span>
<span class="line-modified"> 509   /*                                                                       */</span>
<span class="line-modified"> 510   /*    tag    :: The tag of table to load.  Use the value 0 if you want   */</span>
<span class="line-modified"> 511   /*              to access the whole font file, else set this parameter   */</span>
<span class="line-modified"> 512   /*              to a valid TrueType table tag that you can forge with    */</span>
<span class="line-modified"> 513   /*              the MAKE_TT_TAG macro.                                   */</span>
<span class="line-modified"> 514   /*                                                                       */</span>
<span class="line-modified"> 515   /*    offset :: The starting offset in the table (or the file if         */</span>
<span class="line-modified"> 516   /*              tag == 0).                                               */</span>
<span class="line-modified"> 517   /*                                                                       */</span>
<span class="line-modified"> 518   /*    length :: The address of the decision variable:                    */</span>
<span class="line-modified"> 519   /*                                                                       */</span>
<span class="line-modified"> 520   /*                If length == NULL:                                     */</span>
<span class="line-modified"> 521   /*                  Loads the whole table.  Returns an error if          */</span>
<span class="line-modified"> 522   /*                  `offset&#39; == 0!                                       */</span>
<span class="line-modified"> 523   /*                                                                       */</span>
<span class="line-modified"> 524   /*                If *length == 0:                                       */</span>
<span class="line-modified"> 525   /*                  Exits immediately; returning the length of the given */</span>
<span class="line-modified"> 526   /*                  table or of the font file, depending on the value of */</span>
<span class="line-modified"> 527   /*                  `tag&#39;.                                               */</span>
<span class="line-modified"> 528   /*                                                                       */</span>
<span class="line-modified"> 529   /*                If *length != 0:                                       */</span>
<span class="line-modified"> 530   /*                  Loads the next `length&#39; bytes of table or font,      */</span>
<span class="line-modified"> 531   /*                  starting at offset `offset&#39; (in table or font too).  */</span>
<span class="line-modified"> 532   /*                                                                       */</span>
<span class="line-modified"> 533   /* &lt;Output&gt;                                                              */</span>
<span class="line-modified"> 534   /*    buffer :: The address of target buffer.                            */</span>
<span class="line-modified"> 535   /*                                                                       */</span>
<span class="line-modified"> 536   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 537   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 538   /*                                                                       */</span>





 539   FT_LOCAL_DEF( FT_Error )
 540   tt_face_load_any( TT_Face    face,
 541                     FT_ULong   tag,
 542                     FT_Long    offset,
 543                     FT_Byte*   buffer,
 544                     FT_ULong*  length )
 545   {
 546     FT_Error   error;
 547     FT_Stream  stream;
 548     TT_Table   table;
 549     FT_ULong   size;
 550 
 551 
 552     if ( tag != 0 )
 553     {
 554       /* look for tag in font directory */
 555       table = tt_face_lookup_table( face, tag );
 556       if ( !table )
 557       {
 558         error = FT_THROW( Table_Missing );
</pre>
<hr />
<pre>
 569     if ( length &amp;&amp; *length == 0 )
 570     {
 571       *length = size;
 572 
 573       return FT_Err_Ok;
 574     }
 575 
 576     if ( length )
 577       size = *length;
 578 
 579     stream = face-&gt;root.stream;
 580     /* the `if&#39; is syntactic sugar for picky compilers */
 581     if ( FT_STREAM_READ_AT( offset, buffer, size ) )
 582       goto Exit;
 583 
 584   Exit:
 585     return error;
 586   }
 587 
 588 
<span class="line-modified"> 589   /*************************************************************************/</span>
<span class="line-modified"> 590   /*                                                                       */</span>
<span class="line-modified"> 591   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 592   /*    tt_face_load_generic_header                                        */</span>
<span class="line-modified"> 593   /*                                                                       */</span>
<span class="line-modified"> 594   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 595   /*    Loads the TrueType table `head&#39; or `bhed&#39;.                         */</span>
<span class="line-modified"> 596   /*                                                                       */</span>
<span class="line-modified"> 597   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 598   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified"> 599   /*                                                                       */</span>
<span class="line-modified"> 600   /*    stream :: The input stream.                                        */</span>
<span class="line-modified"> 601   /*                                                                       */</span>
<span class="line-modified"> 602   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 603   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 604   /*                                                                       */</span>


 605   static FT_Error
 606   tt_face_load_generic_header( TT_Face    face,
 607                                FT_Stream  stream,
 608                                FT_ULong   tag )
 609   {
 610     FT_Error    error;
 611     TT_Header*  header;
 612 
 613     static const FT_Frame_Field  header_fields[] =
 614     {
 615 #undef  FT_STRUCTURE
 616 #define FT_STRUCTURE  TT_Header
 617 
 618       FT_FRAME_START( 54 ),
 619         FT_FRAME_ULONG ( Table_Version ),
 620         FT_FRAME_ULONG ( Font_Revision ),
 621         FT_FRAME_LONG  ( CheckSum_Adjust ),
 622         FT_FRAME_LONG  ( Magic_Number ),
 623         FT_FRAME_USHORT( Flags ),
 624         FT_FRAME_USHORT( Units_Per_EM ),
<span class="line-modified"> 625         FT_FRAME_LONG  ( Created[0] ),</span>
<span class="line-modified"> 626         FT_FRAME_LONG  ( Created[1] ),</span>
<span class="line-modified"> 627         FT_FRAME_LONG  ( Modified[0] ),</span>
<span class="line-modified"> 628         FT_FRAME_LONG  ( Modified[1] ),</span>
 629         FT_FRAME_SHORT ( xMin ),
 630         FT_FRAME_SHORT ( yMin ),
 631         FT_FRAME_SHORT ( xMax ),
 632         FT_FRAME_SHORT ( yMax ),
 633         FT_FRAME_USHORT( Mac_Style ),
 634         FT_FRAME_USHORT( Lowest_Rec_PPEM ),
 635         FT_FRAME_SHORT ( Font_Direction ),
 636         FT_FRAME_SHORT ( Index_To_Loc_Format ),
 637         FT_FRAME_SHORT ( Glyph_Data_Format ),
 638       FT_FRAME_END
 639     };
 640 
 641 
 642     error = face-&gt;goto_table( face, tag, stream, 0 );
 643     if ( error )
 644       goto Exit;
 645 
 646     header = &amp;face-&gt;header;
 647 
 648     if ( FT_STREAM_READ_FIELDS( header_fields, header ) )
</pre>
<hr />
<pre>
 659   FT_LOCAL_DEF( FT_Error )
 660   tt_face_load_head( TT_Face    face,
 661                      FT_Stream  stream )
 662   {
 663     return tt_face_load_generic_header( face, stream, TTAG_head );
 664   }
 665 
 666 
 667 #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
 668 
 669   FT_LOCAL_DEF( FT_Error )
 670   tt_face_load_bhed( TT_Face    face,
 671                      FT_Stream  stream )
 672   {
 673     return tt_face_load_generic_header( face, stream, TTAG_bhed );
 674   }
 675 
 676 #endif /* TT_CONFIG_OPTION_EMBEDDED_BITMAPS */
 677 
 678 
<span class="line-modified"> 679   /*************************************************************************/</span>
<span class="line-modified"> 680   /*                                                                       */</span>
<span class="line-modified"> 681   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 682   /*    tt_face_load_maxp                                                  */</span>
<span class="line-modified"> 683   /*                                                                       */</span>
<span class="line-modified"> 684   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 685   /*    Loads the maximum profile into a face object.                      */</span>
<span class="line-modified"> 686   /*                                                                       */</span>
<span class="line-modified"> 687   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 688   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified"> 689   /*                                                                       */</span>
<span class="line-modified"> 690   /*    stream :: The input stream.                                        */</span>
<span class="line-modified"> 691   /*                                                                       */</span>
<span class="line-modified"> 692   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 693   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 694   /*                                                                       */</span>


 695   FT_LOCAL_DEF( FT_Error )
 696   tt_face_load_maxp( TT_Face    face,
 697                      FT_Stream  stream )
 698   {
 699     FT_Error        error;
 700     TT_MaxProfile*  maxProfile = &amp;face-&gt;max_profile;
 701 
 702     static const FT_Frame_Field  maxp_fields[] =
 703     {
 704 #undef  FT_STRUCTURE
 705 #define FT_STRUCTURE  TT_MaxProfile
 706 
 707       FT_FRAME_START( 6 ),
 708         FT_FRAME_LONG  ( version ),
 709         FT_FRAME_USHORT( numGlyphs ),
 710       FT_FRAME_END
 711     };
 712 
 713     static const FT_Frame_Field  maxp_fields_extra[] =
 714     {
</pre>
<hr />
<pre>
 767 
 768       /* we add 4 phantom points later */
 769       if ( maxProfile-&gt;maxTwilightPoints &gt; ( 0xFFFFU - 4 ) )
 770       {
 771         FT_TRACE0(( &quot;tt_face_load_maxp:&quot;
 772                     &quot; too much twilight points in `maxp&#39; table;\n&quot;
 773                     &quot;                  &quot;
 774                     &quot; some glyphs might be rendered incorrectly\n&quot; ));
 775 
 776         maxProfile-&gt;maxTwilightPoints = 0xFFFFU - 4;
 777       }
 778     }
 779 
 780     FT_TRACE3(( &quot;numGlyphs: %u\n&quot;, maxProfile-&gt;numGlyphs ));
 781 
 782   Exit:
 783     return error;
 784   }
 785 
 786 
<span class="line-modified"> 787   /*************************************************************************/</span>
<span class="line-modified"> 788   /*                                                                       */</span>
<span class="line-modified"> 789   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 790   /*    tt_face_load_name                                                  */</span>
<span class="line-modified"> 791   /*                                                                       */</span>
<span class="line-modified"> 792   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 793   /*    Loads the name records.                                            */</span>
<span class="line-modified"> 794   /*                                                                       */</span>
<span class="line-modified"> 795   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 796   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified"> 797   /*                                                                       */</span>
<span class="line-modified"> 798   /*    stream :: The input stream.                                        */</span>
<span class="line-modified"> 799   /*                                                                       */</span>
<span class="line-modified"> 800   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 801   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 802   /*                                                                       */</span>


 803   FT_LOCAL_DEF( FT_Error )
 804   tt_face_load_name( TT_Face    face,
 805                      FT_Stream  stream )
 806   {
 807     FT_Error      error;
 808     FT_Memory     memory = stream-&gt;memory;
 809     FT_ULong      table_pos, table_len;
 810     FT_ULong      storage_start, storage_limit;
 811     TT_NameTable  table;
 812 
 813     static const FT_Frame_Field  name_table_fields[] =
 814     {
 815 #undef  FT_STRUCTURE
 816 #define FT_STRUCTURE  TT_NameTableRec
 817 
 818       FT_FRAME_START( 6 ),
 819         FT_FRAME_USHORT( format ),
 820         FT_FRAME_USHORT( numNameRecords ),
 821         FT_FRAME_USHORT( storageOffset ),
 822       FT_FRAME_END
</pre>
<hr />
<pre>
 964       }
 965 
 966       /* reduce array size to the actually used elements */
 967       count = (FT_UInt)( entry - table-&gt;names );
 968       (void)FT_RENEW_ARRAY( table-&gt;names,
 969                             table-&gt;numNameRecords,
 970                             count );
 971       table-&gt;numNameRecords = count;
 972     }
 973 
 974     FT_FRAME_EXIT();
 975 
 976     /* everything went well, update face-&gt;num_names */
 977     face-&gt;num_names = (FT_UShort)table-&gt;numNameRecords;
 978 
 979   Exit:
 980     return error;
 981   }
 982 
 983 
<span class="line-modified"> 984   /*************************************************************************/</span>
<span class="line-modified"> 985   /*                                                                       */</span>
<span class="line-modified"> 986   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 987   /*    tt_face_free_name                                                  */</span>
<span class="line-modified"> 988   /*                                                                       */</span>
<span class="line-modified"> 989   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 990   /*    Frees the name records.                                            */</span>
<span class="line-modified"> 991   /*                                                                       */</span>
<span class="line-modified"> 992   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 993   /*    face :: A handle to the target face object.                        */</span>
<span class="line-modified"> 994   /*                                                                       */</span>

 995   FT_LOCAL_DEF( void )
 996   tt_face_free_name( TT_Face  face )
 997   {
 998     FT_Memory     memory = face-&gt;root.driver-&gt;root.memory;
 999     TT_NameTable  table  = &amp;face-&gt;name_table;
1000 
1001 
1002     if ( table-&gt;names )
1003     {
1004       TT_Name  entry = table-&gt;names;
1005       TT_Name  limit = entry + table-&gt;numNameRecords;
1006 
1007 
1008       for ( ; entry &lt; limit; entry++ )
1009         FT_FREE( entry-&gt;string );
1010 
1011       FT_FREE( table-&gt;names );
1012     }
1013 
1014     if ( table-&gt;langTags )
1015     {
1016       TT_LangTag  entry = table-&gt;langTags;
1017       TT_LangTag  limit = entry + table-&gt;numLangTagRecords;
1018 
1019 
1020       for ( ; entry &lt; limit; entry++ )
1021         FT_FREE( entry-&gt;string );
1022 
1023       FT_FREE( table-&gt;langTags );
1024     }
1025 
1026     table-&gt;numNameRecords    = 0;
1027     table-&gt;numLangTagRecords = 0;
1028     table-&gt;format            = 0;
1029     table-&gt;storageOffset     = 0;
1030   }
1031 
1032 
<span class="line-modified">1033   /*************************************************************************/</span>
<span class="line-modified">1034   /*                                                                       */</span>
<span class="line-modified">1035   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1036   /*    tt_face_load_cmap                                                  */</span>
<span class="line-modified">1037   /*                                                                       */</span>
<span class="line-modified">1038   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1039   /*    Loads the cmap directory in a face object.  The cmaps themselves   */</span>
<span class="line-modified">1040   /*    are loaded on demand in the `ttcmap.c&#39; module.                     */</span>
<span class="line-modified">1041   /*                                                                       */</span>
<span class="line-modified">1042   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">1043   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified">1044   /*                                                                       */</span>
<span class="line-modified">1045   /*    stream :: A handle to the input stream.                            */</span>
<span class="line-modified">1046   /*                                                                       */</span>
<span class="line-modified">1047   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">1048   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">1049   /*                                                                       */</span>


1050 
1051   FT_LOCAL_DEF( FT_Error )
1052   tt_face_load_cmap( TT_Face    face,
1053                      FT_Stream  stream )
1054   {
1055     FT_Error  error;
1056 
1057 
1058     error = face-&gt;goto_table( face, TTAG_cmap, stream, &amp;face-&gt;cmap_size );
1059     if ( error )
1060       goto Exit;
1061 
1062     if ( FT_FRAME_EXTRACT( face-&gt;cmap_size, face-&gt;cmap_table ) )
1063       face-&gt;cmap_size = 0;
1064 
1065   Exit:
1066     return error;
1067   }
1068 
1069 
1070 
<span class="line-modified">1071   /*************************************************************************/</span>
<span class="line-modified">1072   /*                                                                       */</span>
<span class="line-modified">1073   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1074   /*    tt_face_load_os2                                                   */</span>
<span class="line-modified">1075   /*                                                                       */</span>
<span class="line-modified">1076   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1077   /*    Loads the OS2 table.                                               */</span>
<span class="line-modified">1078   /*                                                                       */</span>
<span class="line-modified">1079   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">1080   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified">1081   /*                                                                       */</span>
<span class="line-modified">1082   /*    stream :: A handle to the input stream.                            */</span>
<span class="line-modified">1083   /*                                                                       */</span>
<span class="line-modified">1084   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">1085   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">1086   /*                                                                       */</span>


1087   FT_LOCAL_DEF( FT_Error )
1088   tt_face_load_os2( TT_Face    face,
1089                     FT_Stream  stream )
1090   {
1091     FT_Error  error;
1092     TT_OS2*   os2;
1093 
1094     static const FT_Frame_Field  os2_fields[] =
1095     {
1096 #undef  FT_STRUCTURE
1097 #define FT_STRUCTURE  TT_OS2
1098 
1099       FT_FRAME_START( 78 ),
1100         FT_FRAME_USHORT( version ),
1101         FT_FRAME_SHORT ( xAvgCharWidth ),
1102         FT_FRAME_USHORT( usWeightClass ),
1103         FT_FRAME_USHORT( usWidthClass ),
1104         FT_FRAME_SHORT ( fsType ),
1105         FT_FRAME_SHORT ( ySubscriptXSize ),
1106         FT_FRAME_SHORT ( ySubscriptYSize ),
</pre>
<hr />
<pre>
1211         if ( os2-&gt;version &gt;= 0x0005 )
1212         {
1213           /* only version 5 tables */
1214           if ( FT_STREAM_READ_FIELDS( os2_fields_extra5, os2 ) )
1215             goto Exit;
1216         }
1217       }
1218     }
1219 
1220     FT_TRACE3(( &quot;sTypoAscender:  %4d\n&quot;,   os2-&gt;sTypoAscender ));
1221     FT_TRACE3(( &quot;sTypoDescender: %4d\n&quot;,   os2-&gt;sTypoDescender ));
1222     FT_TRACE3(( &quot;usWinAscent:    %4u\n&quot;,   os2-&gt;usWinAscent ));
1223     FT_TRACE3(( &quot;usWinDescent:   %4u\n&quot;,   os2-&gt;usWinDescent ));
1224     FT_TRACE3(( &quot;fsSelection:    0x%2x\n&quot;, os2-&gt;fsSelection ));
1225 
1226   Exit:
1227     return error;
1228   }
1229 
1230 
<span class="line-modified">1231   /*************************************************************************/</span>
<span class="line-modified">1232   /*                                                                       */</span>
<span class="line-modified">1233   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1234   /*    tt_face_load_postscript                                            */</span>
<span class="line-modified">1235   /*                                                                       */</span>
<span class="line-modified">1236   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1237   /*    Loads the Postscript table.                                        */</span>
<span class="line-modified">1238   /*                                                                       */</span>
<span class="line-modified">1239   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">1240   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified">1241   /*                                                                       */</span>
<span class="line-modified">1242   /*    stream :: A handle to the input stream.                            */</span>
<span class="line-modified">1243   /*                                                                       */</span>
<span class="line-modified">1244   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">1245   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">1246   /*                                                                       */</span>


1247   FT_LOCAL_DEF( FT_Error )
1248   tt_face_load_post( TT_Face    face,
1249                      FT_Stream  stream )
1250   {
1251     FT_Error        error;
1252     TT_Postscript*  post = &amp;face-&gt;postscript;
1253 
1254     static const FT_Frame_Field  post_fields[] =
1255     {
1256 #undef  FT_STRUCTURE
1257 #define FT_STRUCTURE  TT_Postscript
1258 
1259       FT_FRAME_START( 32 ),
1260         FT_FRAME_LONG ( FormatType ),
1261         FT_FRAME_LONG ( italicAngle ),
1262         FT_FRAME_SHORT( underlinePosition ),
1263         FT_FRAME_SHORT( underlineThickness ),
1264         FT_FRAME_ULONG( isFixedPitch ),
1265         FT_FRAME_ULONG( minMemType42 ),
1266         FT_FRAME_ULONG( maxMemType42 ),
</pre>
<hr />
<pre>
1271 
1272 
1273     error = face-&gt;goto_table( face, TTAG_post, stream, 0 );
1274     if ( error )
1275       return error;
1276 
1277     if ( FT_STREAM_READ_FIELDS( post_fields, post ) )
1278       return error;
1279 
1280     /* we don&#39;t load the glyph names, we do that in another */
1281     /* module (ttpost).                                     */
1282 
1283     FT_TRACE3(( &quot;FormatType:   0x%x\n&quot;, post-&gt;FormatType ));
1284     FT_TRACE3(( &quot;isFixedPitch:   %s\n&quot;, post-&gt;isFixedPitch
1285                                         ? &quot;  yes&quot; : &quot;   no&quot; ));
1286 
1287     return FT_Err_Ok;
1288   }
1289 
1290 
<span class="line-modified">1291   /*************************************************************************/</span>
<span class="line-modified">1292   /*                                                                       */</span>
<span class="line-modified">1293   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1294   /*    tt_face_load_pclt                                                  */</span>
<span class="line-modified">1295   /*                                                                       */</span>
<span class="line-modified">1296   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1297   /*    Loads the PCL 5 Table.                                             */</span>
<span class="line-modified">1298   /*                                                                       */</span>
<span class="line-modified">1299   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">1300   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified">1301   /*                                                                       */</span>
<span class="line-modified">1302   /*    stream :: A handle to the input stream.                            */</span>
<span class="line-modified">1303   /*                                                                       */</span>
<span class="line-modified">1304   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">1305   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">1306   /*                                                                       */</span>


1307   FT_LOCAL_DEF( FT_Error )
1308   tt_face_load_pclt( TT_Face    face,
1309                      FT_Stream  stream )
1310   {
1311     static const FT_Frame_Field  pclt_fields[] =
1312     {
1313 #undef  FT_STRUCTURE
1314 #define FT_STRUCTURE  TT_PCLT
1315 
1316       FT_FRAME_START( 54 ),
1317         FT_FRAME_ULONG ( Version ),
1318         FT_FRAME_ULONG ( FontNumber ),
1319         FT_FRAME_USHORT( Pitch ),
1320         FT_FRAME_USHORT( xHeight ),
1321         FT_FRAME_USHORT( Style ),
1322         FT_FRAME_USHORT( TypeFamily ),
1323         FT_FRAME_USHORT( CapHeight ),
1324         FT_FRAME_USHORT( SymbolSet ),
1325         FT_FRAME_BYTES ( TypeFace, 16 ),
1326         FT_FRAME_BYTES ( CharacterComplement, 8 ),
</pre>
<hr />
<pre>
1332       FT_FRAME_END
1333     };
1334 
1335     FT_Error  error;
1336     TT_PCLT*  pclt = &amp;face-&gt;pclt;
1337 
1338 
1339     /* optional table */
1340     error = face-&gt;goto_table( face, TTAG_PCLT, stream, 0 );
1341     if ( error )
1342       goto Exit;
1343 
1344     if ( FT_STREAM_READ_FIELDS( pclt_fields, pclt ) )
1345       goto Exit;
1346 
1347   Exit:
1348     return error;
1349   }
1350 
1351 
<span class="line-modified">1352   /*************************************************************************/</span>
<span class="line-modified">1353   /*                                                                       */</span>
<span class="line-modified">1354   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">1355   /*    tt_face_load_gasp                                                  */</span>
<span class="line-modified">1356   /*                                                                       */</span>
<span class="line-modified">1357   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">1358   /*    Loads the `gasp&#39; table into a face object.                         */</span>
<span class="line-modified">1359   /*                                                                       */</span>
<span class="line-modified">1360   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">1361   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified">1362   /*                                                                       */</span>
<span class="line-modified">1363   /*    stream :: The input stream.                                        */</span>
<span class="line-modified">1364   /*                                                                       */</span>
<span class="line-modified">1365   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">1366   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">1367   /*                                                                       */</span>


1368   FT_LOCAL_DEF( FT_Error )
1369   tt_face_load_gasp( TT_Face    face,
1370                      FT_Stream  stream )
1371   {
1372     FT_Error   error;
1373     FT_Memory  memory = stream-&gt;memory;
1374 
1375     FT_UInt        j,num_ranges;
1376     TT_GaspRange   gaspranges = NULL;
1377 
1378 
1379     /* the gasp table is optional */
1380     error = face-&gt;goto_table( face, TTAG_gasp, stream, 0 );
1381     if ( error )
1382       goto Exit;
1383 
1384     if ( FT_FRAME_ENTER( 4L ) )
1385       goto Exit;
1386 
1387     face-&gt;gasp.version   = FT_GET_USHORT();
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 /****************************************************************************</span>
<span class="line-modified">   2  *</span>
<span class="line-modified">   3  * ttload.c</span>
<span class="line-modified">   4  *</span>
<span class="line-modified">   5  *   Load the basic TrueType tables, i.e., tables that can be either in</span>
<span class="line-modified">   6  *   TTF or OTF fonts (body).</span>
<span class="line-modified">   7  *</span>
<span class="line-modified">   8  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">   9  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">  10  *</span>
<span class="line-modified">  11  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">  12  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">  13  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">  14  * this file you indicate that you have read the license and</span>
<span class="line-modified">  15  * understand and accept it fully.</span>
<span class="line-modified">  16  *</span>
<span class="line-modified">  17  */</span>
  18 
  19 
  20 #include &lt;ft2build.h&gt;
  21 #include FT_INTERNAL_DEBUG_H
  22 #include FT_INTERNAL_STREAM_H
  23 #include FT_TRUETYPE_TAGS_H
  24 #include &quot;ttload.h&quot;
  25 
  26 #include &quot;sferrors.h&quot;
  27 
  28 
<span class="line-modified">  29   /**************************************************************************</span>
<span class="line-modified">  30    *</span>
<span class="line-modified">  31    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified">  32    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified">  33    * messages during execution.</span>
<span class="line-modified">  34    */</span>
  35 #undef  FT_COMPONENT
<span class="line-modified">  36 #define FT_COMPONENT  ttload</span>
<span class="line-modified">  37 </span>
<span class="line-modified">  38 </span>
<span class="line-modified">  39   /**************************************************************************</span>
<span class="line-modified">  40    *</span>
<span class="line-modified">  41    * @Function:</span>
<span class="line-modified">  42    *   tt_face_lookup_table</span>
<span class="line-modified">  43    *</span>
<span class="line-modified">  44    * @Description:</span>
<span class="line-modified">  45    *   Looks for a TrueType table by name.</span>
<span class="line-modified">  46    *</span>
<span class="line-modified">  47    * @Input:</span>
<span class="line-modified">  48    *   face ::</span>
<span class="line-modified">  49    *     A face object handle.</span>
<span class="line-modified">  50    *</span>
<span class="line-modified">  51    *   tag ::</span>
<span class="line-modified">  52    *     The searched tag.</span>
<span class="line-modified">  53    *</span>
<span class="line-modified">  54    * @Return:</span>
<span class="line-added">  55    *   A pointer to the table directory entry.  0 if not found.</span>
<span class="line-added">  56    */</span>
  57   FT_LOCAL_DEF( TT_Table  )
  58   tt_face_lookup_table( TT_Face   face,
  59                         FT_ULong  tag  )
  60   {
  61     TT_Table  entry;
  62     TT_Table  limit;
  63 #ifdef FT_DEBUG_LEVEL_TRACE
  64     FT_Bool   zero_length = FALSE;
  65 #endif
  66 
  67 
  68     FT_TRACE4(( &quot;tt_face_lookup_table: %08p, `%c%c%c%c&#39; -- &quot;,
  69                 face,
  70                 (FT_Char)( tag &gt;&gt; 24 ),
  71                 (FT_Char)( tag &gt;&gt; 16 ),
  72                 (FT_Char)( tag &gt;&gt; 8  ),
  73                 (FT_Char)( tag       ) ));
  74 
  75     entry = face-&gt;dir_tables;
  76     limit = entry + face-&gt;num_tables;
</pre>
<hr />
<pre>
  86           FT_TRACE4(( &quot;found table.\n&quot; ));
  87           return entry;
  88         }
  89 #ifdef FT_DEBUG_LEVEL_TRACE
  90         zero_length = TRUE;
  91 #endif
  92       }
  93     }
  94 
  95 #ifdef FT_DEBUG_LEVEL_TRACE
  96     if ( zero_length )
  97       FT_TRACE4(( &quot;ignoring empty table\n&quot; ));
  98     else
  99       FT_TRACE4(( &quot;could not find table\n&quot; ));
 100 #endif
 101 
 102     return NULL;
 103   }
 104 
 105 
<span class="line-modified"> 106   /**************************************************************************</span>
<span class="line-modified"> 107    *</span>
<span class="line-modified"> 108    * @Function:</span>
<span class="line-modified"> 109    *   tt_face_goto_table</span>
<span class="line-modified"> 110    *</span>
<span class="line-modified"> 111    * @Description:</span>
<span class="line-modified"> 112    *   Looks for a TrueType table by name, then seek a stream to it.</span>
<span class="line-modified"> 113    *</span>
<span class="line-modified"> 114    * @Input:</span>
<span class="line-modified"> 115    *   face ::</span>
<span class="line-modified"> 116    *     A face object handle.</span>
<span class="line-modified"> 117    *</span>
<span class="line-modified"> 118    *   tag ::</span>
<span class="line-modified"> 119    *     The searched tag.</span>
<span class="line-modified"> 120    *</span>
<span class="line-modified"> 121    *   stream ::</span>
<span class="line-modified"> 122    *     The stream to seek when the table is found.</span>
<span class="line-modified"> 123    *</span>
<span class="line-modified"> 124    * @Output:</span>
<span class="line-modified"> 125    *   length ::</span>
<span class="line-modified"> 126    *     The length of the table if found, undefined otherwise.</span>
<span class="line-added"> 127    *</span>
<span class="line-added"> 128    * @Return:</span>
<span class="line-added"> 129    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 130    */</span>
 131   FT_LOCAL_DEF( FT_Error )
 132   tt_face_goto_table( TT_Face    face,
 133                       FT_ULong   tag,
 134                       FT_Stream  stream,
 135                       FT_ULong*  length )
 136   {
 137     TT_Table  table;
 138     FT_Error  error;
 139 
 140 
 141     table = tt_face_lookup_table( face, tag );
 142     if ( table )
 143     {
 144       if ( length )
 145         *length = table-&gt;Length;
 146 
 147       if ( FT_STREAM_SEEK( table-&gt;Offset ) )
 148         goto Exit;
 149     }
 150     else
</pre>
<hr />
<pre>
 298     {
 299       error = FT_Err_Ok;
 300       goto Exit;
 301     }
 302     else
 303     {
 304       FT_TRACE2(( &quot;check_table_dir:&quot; ));
 305 #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
 306       FT_TRACE2(( &quot; neither `head&#39;, `bhed&#39;, nor `sing&#39; table found\n&quot; ));
 307 #else
 308       FT_TRACE2(( &quot; neither `head&#39; nor `sing&#39; table found\n&quot; ));
 309 #endif
 310       error = FT_THROW( Table_Missing );
 311     }
 312 
 313   Exit:
 314     return error;
 315   }
 316 
 317 
<span class="line-modified"> 318   /**************************************************************************</span>
<span class="line-modified"> 319    *</span>
<span class="line-modified"> 320    * @Function:</span>
<span class="line-modified"> 321    *   tt_face_load_font_dir</span>
<span class="line-modified"> 322    *</span>
<span class="line-modified"> 323    * @Description:</span>
<span class="line-modified"> 324    *   Loads the header of a SFNT font file.</span>
<span class="line-modified"> 325    *</span>
<span class="line-modified"> 326    * @Input:</span>
<span class="line-modified"> 327    *   face ::</span>
<span class="line-modified"> 328    *     A handle to the target face object.</span>
<span class="line-modified"> 329    *</span>
<span class="line-modified"> 330    *   stream ::</span>
<span class="line-modified"> 331    *     The input stream.</span>
<span class="line-modified"> 332    *</span>
<span class="line-modified"> 333    * @Output:</span>
<span class="line-modified"> 334    *   sfnt ::</span>
<span class="line-modified"> 335    *     The SFNT header.</span>
<span class="line-modified"> 336    *</span>
<span class="line-modified"> 337    * @Return:</span>
<span class="line-modified"> 338    *   FreeType error code.  0 means success.</span>
<span class="line-modified"> 339    *</span>
<span class="line-added"> 340    * @Note:</span>
<span class="line-added"> 341    *   The stream cursor must be at the beginning of the font directory.</span>
<span class="line-added"> 342    */</span>
 343   FT_LOCAL_DEF( FT_Error )
 344   tt_face_load_font_dir( TT_Face    face,
 345                          FT_Stream  stream )
 346   {
 347     SFNT_HeaderRec  sfnt;
 348     FT_Error        error;
 349     FT_Memory       memory = stream-&gt;memory;
 350     FT_UShort       nn, valid_entries = 0;
 351 
 352     static const FT_Frame_Field  offset_table_fields[] =
 353     {
 354 #undef  FT_STRUCTURE
 355 #define FT_STRUCTURE  SFNT_HeaderRec
 356 
 357       FT_FRAME_START( 8 ),
 358         FT_FRAME_USHORT( num_tables ),
 359         FT_FRAME_USHORT( search_range ),
 360         FT_FRAME_USHORT( entry_selector ),
 361         FT_FRAME_USHORT( range_shift ),
 362       FT_FRAME_END
</pre>
<hr />
<pre>
 488       {
 489         FT_TRACE2(( &quot;\n&quot; ));
 490 
 491         /* we finally have a valid entry */
 492         face-&gt;dir_tables[valid_entries++] = entry;
 493       }
 494     }
 495 
 496     /* final adjustment to number of tables */
 497     face-&gt;num_tables = valid_entries;
 498 
 499     FT_FRAME_EXIT();
 500 
 501     FT_TRACE2(( &quot;table directory loaded\n\n&quot; ));
 502 
 503   Exit:
 504     return error;
 505   }
 506 
 507 
<span class="line-modified"> 508   /**************************************************************************</span>
<span class="line-modified"> 509    *</span>
<span class="line-modified"> 510    * @Function:</span>
<span class="line-modified"> 511    *   tt_face_load_any</span>
<span class="line-modified"> 512    *</span>
<span class="line-modified"> 513    * @Description:</span>
<span class="line-modified"> 514    *   Loads any font table into client memory.</span>
<span class="line-modified"> 515    *</span>
<span class="line-modified"> 516    * @Input:</span>
<span class="line-modified"> 517    *   face ::</span>
<span class="line-modified"> 518    *     The face object to look for.</span>
<span class="line-modified"> 519    *</span>
<span class="line-modified"> 520    *   tag ::</span>
<span class="line-modified"> 521    *     The tag of table to load.  Use the value 0 if you want</span>
<span class="line-modified"> 522    *     to access the whole font file, else set this parameter</span>
<span class="line-modified"> 523    *     to a valid TrueType table tag that you can forge with</span>
<span class="line-modified"> 524    *     the MAKE_TT_TAG macro.</span>
<span class="line-modified"> 525    *</span>
<span class="line-modified"> 526    *   offset ::</span>
<span class="line-modified"> 527    *     The starting offset in the table (or the file if</span>
<span class="line-modified"> 528    *     tag == 0).</span>
<span class="line-modified"> 529    *</span>
<span class="line-modified"> 530    *   length ::</span>
<span class="line-modified"> 531    *     The address of the decision variable:</span>
<span class="line-modified"> 532    *</span>
<span class="line-modified"> 533    *     If length == NULL:</span>
<span class="line-modified"> 534    *       Loads the whole table.  Returns an error if</span>
<span class="line-modified"> 535    *       `offset&#39; == 0!</span>
<span class="line-modified"> 536    *</span>
<span class="line-modified"> 537    *     If *length == 0:</span>
<span class="line-modified"> 538    *       Exits immediately; returning the length of the given</span>
<span class="line-modified"> 539    *       table or of the font file, depending on the value of</span>
<span class="line-modified"> 540    *       `tag&#39;.</span>
<span class="line-modified"> 541    *</span>
<span class="line-modified"> 542    *     If *length != 0:</span>
<span class="line-modified"> 543    *       Loads the next `length&#39; bytes of table or font,</span>
<span class="line-modified"> 544    *       starting at offset `offset&#39; (in table or font too).</span>
<span class="line-modified"> 545    *</span>
<span class="line-modified"> 546    * @Output:</span>
<span class="line-modified"> 547    *   buffer ::</span>
<span class="line-added"> 548    *     The address of target buffer.</span>
<span class="line-added"> 549    *</span>
<span class="line-added"> 550    * @Return:</span>
<span class="line-added"> 551    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 552    */</span>
 553   FT_LOCAL_DEF( FT_Error )
 554   tt_face_load_any( TT_Face    face,
 555                     FT_ULong   tag,
 556                     FT_Long    offset,
 557                     FT_Byte*   buffer,
 558                     FT_ULong*  length )
 559   {
 560     FT_Error   error;
 561     FT_Stream  stream;
 562     TT_Table   table;
 563     FT_ULong   size;
 564 
 565 
 566     if ( tag != 0 )
 567     {
 568       /* look for tag in font directory */
 569       table = tt_face_lookup_table( face, tag );
 570       if ( !table )
 571       {
 572         error = FT_THROW( Table_Missing );
</pre>
<hr />
<pre>
 583     if ( length &amp;&amp; *length == 0 )
 584     {
 585       *length = size;
 586 
 587       return FT_Err_Ok;
 588     }
 589 
 590     if ( length )
 591       size = *length;
 592 
 593     stream = face-&gt;root.stream;
 594     /* the `if&#39; is syntactic sugar for picky compilers */
 595     if ( FT_STREAM_READ_AT( offset, buffer, size ) )
 596       goto Exit;
 597 
 598   Exit:
 599     return error;
 600   }
 601 
 602 
<span class="line-modified"> 603   /**************************************************************************</span>
<span class="line-modified"> 604    *</span>
<span class="line-modified"> 605    * @Function:</span>
<span class="line-modified"> 606    *   tt_face_load_generic_header</span>
<span class="line-modified"> 607    *</span>
<span class="line-modified"> 608    * @Description:</span>
<span class="line-modified"> 609    *   Loads the TrueType table `head&#39; or `bhed&#39;.</span>
<span class="line-modified"> 610    *</span>
<span class="line-modified"> 611    * @Input:</span>
<span class="line-modified"> 612    *   face ::</span>
<span class="line-modified"> 613    *     A handle to the target face object.</span>
<span class="line-modified"> 614    *</span>
<span class="line-modified"> 615    *   stream ::</span>
<span class="line-modified"> 616    *     The input stream.</span>
<span class="line-modified"> 617    *</span>
<span class="line-modified"> 618    * @Return:</span>
<span class="line-added"> 619    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 620    */</span>
 621   static FT_Error
 622   tt_face_load_generic_header( TT_Face    face,
 623                                FT_Stream  stream,
 624                                FT_ULong   tag )
 625   {
 626     FT_Error    error;
 627     TT_Header*  header;
 628 
 629     static const FT_Frame_Field  header_fields[] =
 630     {
 631 #undef  FT_STRUCTURE
 632 #define FT_STRUCTURE  TT_Header
 633 
 634       FT_FRAME_START( 54 ),
 635         FT_FRAME_ULONG ( Table_Version ),
 636         FT_FRAME_ULONG ( Font_Revision ),
 637         FT_FRAME_LONG  ( CheckSum_Adjust ),
 638         FT_FRAME_LONG  ( Magic_Number ),
 639         FT_FRAME_USHORT( Flags ),
 640         FT_FRAME_USHORT( Units_Per_EM ),
<span class="line-modified"> 641         FT_FRAME_ULONG ( Created[0] ),</span>
<span class="line-modified"> 642         FT_FRAME_ULONG ( Created[1] ),</span>
<span class="line-modified"> 643         FT_FRAME_ULONG ( Modified[0] ),</span>
<span class="line-modified"> 644         FT_FRAME_ULONG ( Modified[1] ),</span>
 645         FT_FRAME_SHORT ( xMin ),
 646         FT_FRAME_SHORT ( yMin ),
 647         FT_FRAME_SHORT ( xMax ),
 648         FT_FRAME_SHORT ( yMax ),
 649         FT_FRAME_USHORT( Mac_Style ),
 650         FT_FRAME_USHORT( Lowest_Rec_PPEM ),
 651         FT_FRAME_SHORT ( Font_Direction ),
 652         FT_FRAME_SHORT ( Index_To_Loc_Format ),
 653         FT_FRAME_SHORT ( Glyph_Data_Format ),
 654       FT_FRAME_END
 655     };
 656 
 657 
 658     error = face-&gt;goto_table( face, tag, stream, 0 );
 659     if ( error )
 660       goto Exit;
 661 
 662     header = &amp;face-&gt;header;
 663 
 664     if ( FT_STREAM_READ_FIELDS( header_fields, header ) )
</pre>
<hr />
<pre>
 675   FT_LOCAL_DEF( FT_Error )
 676   tt_face_load_head( TT_Face    face,
 677                      FT_Stream  stream )
 678   {
 679     return tt_face_load_generic_header( face, stream, TTAG_head );
 680   }
 681 
 682 
 683 #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
 684 
 685   FT_LOCAL_DEF( FT_Error )
 686   tt_face_load_bhed( TT_Face    face,
 687                      FT_Stream  stream )
 688   {
 689     return tt_face_load_generic_header( face, stream, TTAG_bhed );
 690   }
 691 
 692 #endif /* TT_CONFIG_OPTION_EMBEDDED_BITMAPS */
 693 
 694 
<span class="line-modified"> 695   /**************************************************************************</span>
<span class="line-modified"> 696    *</span>
<span class="line-modified"> 697    * @Function:</span>
<span class="line-modified"> 698    *   tt_face_load_maxp</span>
<span class="line-modified"> 699    *</span>
<span class="line-modified"> 700    * @Description:</span>
<span class="line-modified"> 701    *   Loads the maximum profile into a face object.</span>
<span class="line-modified"> 702    *</span>
<span class="line-modified"> 703    * @Input:</span>
<span class="line-modified"> 704    *   face ::</span>
<span class="line-modified"> 705    *     A handle to the target face object.</span>
<span class="line-modified"> 706    *</span>
<span class="line-modified"> 707    *   stream ::</span>
<span class="line-modified"> 708    *     The input stream.</span>
<span class="line-modified"> 709    *</span>
<span class="line-modified"> 710    * @Return:</span>
<span class="line-added"> 711    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 712    */</span>
 713   FT_LOCAL_DEF( FT_Error )
 714   tt_face_load_maxp( TT_Face    face,
 715                      FT_Stream  stream )
 716   {
 717     FT_Error        error;
 718     TT_MaxProfile*  maxProfile = &amp;face-&gt;max_profile;
 719 
 720     static const FT_Frame_Field  maxp_fields[] =
 721     {
 722 #undef  FT_STRUCTURE
 723 #define FT_STRUCTURE  TT_MaxProfile
 724 
 725       FT_FRAME_START( 6 ),
 726         FT_FRAME_LONG  ( version ),
 727         FT_FRAME_USHORT( numGlyphs ),
 728       FT_FRAME_END
 729     };
 730 
 731     static const FT_Frame_Field  maxp_fields_extra[] =
 732     {
</pre>
<hr />
<pre>
 785 
 786       /* we add 4 phantom points later */
 787       if ( maxProfile-&gt;maxTwilightPoints &gt; ( 0xFFFFU - 4 ) )
 788       {
 789         FT_TRACE0(( &quot;tt_face_load_maxp:&quot;
 790                     &quot; too much twilight points in `maxp&#39; table;\n&quot;
 791                     &quot;                  &quot;
 792                     &quot; some glyphs might be rendered incorrectly\n&quot; ));
 793 
 794         maxProfile-&gt;maxTwilightPoints = 0xFFFFU - 4;
 795       }
 796     }
 797 
 798     FT_TRACE3(( &quot;numGlyphs: %u\n&quot;, maxProfile-&gt;numGlyphs ));
 799 
 800   Exit:
 801     return error;
 802   }
 803 
 804 
<span class="line-modified"> 805   /**************************************************************************</span>
<span class="line-modified"> 806    *</span>
<span class="line-modified"> 807    * @Function:</span>
<span class="line-modified"> 808    *   tt_face_load_name</span>
<span class="line-modified"> 809    *</span>
<span class="line-modified"> 810    * @Description:</span>
<span class="line-modified"> 811    *   Loads the name records.</span>
<span class="line-modified"> 812    *</span>
<span class="line-modified"> 813    * @Input:</span>
<span class="line-modified"> 814    *   face ::</span>
<span class="line-modified"> 815    *     A handle to the target face object.</span>
<span class="line-modified"> 816    *</span>
<span class="line-modified"> 817    *   stream ::</span>
<span class="line-modified"> 818    *     The input stream.</span>
<span class="line-modified"> 819    *</span>
<span class="line-modified"> 820    * @Return:</span>
<span class="line-added"> 821    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 822    */</span>
 823   FT_LOCAL_DEF( FT_Error )
 824   tt_face_load_name( TT_Face    face,
 825                      FT_Stream  stream )
 826   {
 827     FT_Error      error;
 828     FT_Memory     memory = stream-&gt;memory;
 829     FT_ULong      table_pos, table_len;
 830     FT_ULong      storage_start, storage_limit;
 831     TT_NameTable  table;
 832 
 833     static const FT_Frame_Field  name_table_fields[] =
 834     {
 835 #undef  FT_STRUCTURE
 836 #define FT_STRUCTURE  TT_NameTableRec
 837 
 838       FT_FRAME_START( 6 ),
 839         FT_FRAME_USHORT( format ),
 840         FT_FRAME_USHORT( numNameRecords ),
 841         FT_FRAME_USHORT( storageOffset ),
 842       FT_FRAME_END
</pre>
<hr />
<pre>
 984       }
 985 
 986       /* reduce array size to the actually used elements */
 987       count = (FT_UInt)( entry - table-&gt;names );
 988       (void)FT_RENEW_ARRAY( table-&gt;names,
 989                             table-&gt;numNameRecords,
 990                             count );
 991       table-&gt;numNameRecords = count;
 992     }
 993 
 994     FT_FRAME_EXIT();
 995 
 996     /* everything went well, update face-&gt;num_names */
 997     face-&gt;num_names = (FT_UShort)table-&gt;numNameRecords;
 998 
 999   Exit:
1000     return error;
1001   }
1002 
1003 
<span class="line-modified">1004   /**************************************************************************</span>
<span class="line-modified">1005    *</span>
<span class="line-modified">1006    * @Function:</span>
<span class="line-modified">1007    *   tt_face_free_name</span>
<span class="line-modified">1008    *</span>
<span class="line-modified">1009    * @Description:</span>
<span class="line-modified">1010    *   Frees the name records.</span>
<span class="line-modified">1011    *</span>
<span class="line-modified">1012    * @Input:</span>
<span class="line-modified">1013    *   face ::</span>
<span class="line-modified">1014    *     A handle to the target face object.</span>
<span class="line-added">1015    */</span>
1016   FT_LOCAL_DEF( void )
1017   tt_face_free_name( TT_Face  face )
1018   {
1019     FT_Memory     memory = face-&gt;root.driver-&gt;root.memory;
1020     TT_NameTable  table  = &amp;face-&gt;name_table;
1021 
1022 
1023     if ( table-&gt;names )
1024     {
1025       TT_Name  entry = table-&gt;names;
1026       TT_Name  limit = entry + table-&gt;numNameRecords;
1027 
1028 
1029       for ( ; entry &lt; limit; entry++ )
1030         FT_FREE( entry-&gt;string );
1031 
1032       FT_FREE( table-&gt;names );
1033     }
1034 
1035     if ( table-&gt;langTags )
1036     {
1037       TT_LangTag  entry = table-&gt;langTags;
1038       TT_LangTag  limit = entry + table-&gt;numLangTagRecords;
1039 
1040 
1041       for ( ; entry &lt; limit; entry++ )
1042         FT_FREE( entry-&gt;string );
1043 
1044       FT_FREE( table-&gt;langTags );
1045     }
1046 
1047     table-&gt;numNameRecords    = 0;
1048     table-&gt;numLangTagRecords = 0;
1049     table-&gt;format            = 0;
1050     table-&gt;storageOffset     = 0;
1051   }
1052 
1053 
<span class="line-modified">1054   /**************************************************************************</span>
<span class="line-modified">1055    *</span>
<span class="line-modified">1056    * @Function:</span>
<span class="line-modified">1057    *   tt_face_load_cmap</span>
<span class="line-modified">1058    *</span>
<span class="line-modified">1059    * @Description:</span>
<span class="line-modified">1060    *   Loads the cmap directory in a face object.  The cmaps themselves</span>
<span class="line-modified">1061    *   are loaded on demand in the `ttcmap.c&#39; module.</span>
<span class="line-modified">1062    *</span>
<span class="line-modified">1063    * @Input:</span>
<span class="line-modified">1064    *   face ::</span>
<span class="line-modified">1065    *     A handle to the target face object.</span>
<span class="line-modified">1066    *</span>
<span class="line-modified">1067    *   stream ::</span>
<span class="line-modified">1068    *     A handle to the input stream.</span>
<span class="line-modified">1069    *</span>
<span class="line-modified">1070    * @Return:</span>
<span class="line-added">1071    *   FreeType error code.  0 means success.</span>
<span class="line-added">1072    */</span>
1073 
1074   FT_LOCAL_DEF( FT_Error )
1075   tt_face_load_cmap( TT_Face    face,
1076                      FT_Stream  stream )
1077   {
1078     FT_Error  error;
1079 
1080 
1081     error = face-&gt;goto_table( face, TTAG_cmap, stream, &amp;face-&gt;cmap_size );
1082     if ( error )
1083       goto Exit;
1084 
1085     if ( FT_FRAME_EXTRACT( face-&gt;cmap_size, face-&gt;cmap_table ) )
1086       face-&gt;cmap_size = 0;
1087 
1088   Exit:
1089     return error;
1090   }
1091 
1092 
1093 
<span class="line-modified">1094   /**************************************************************************</span>
<span class="line-modified">1095    *</span>
<span class="line-modified">1096    * @Function:</span>
<span class="line-modified">1097    *   tt_face_load_os2</span>
<span class="line-modified">1098    *</span>
<span class="line-modified">1099    * @Description:</span>
<span class="line-modified">1100    *   Loads the OS2 table.</span>
<span class="line-modified">1101    *</span>
<span class="line-modified">1102    * @Input:</span>
<span class="line-modified">1103    *   face ::</span>
<span class="line-modified">1104    *     A handle to the target face object.</span>
<span class="line-modified">1105    *</span>
<span class="line-modified">1106    *   stream ::</span>
<span class="line-modified">1107    *     A handle to the input stream.</span>
<span class="line-modified">1108    *</span>
<span class="line-modified">1109    * @Return:</span>
<span class="line-added">1110    *   FreeType error code.  0 means success.</span>
<span class="line-added">1111    */</span>
1112   FT_LOCAL_DEF( FT_Error )
1113   tt_face_load_os2( TT_Face    face,
1114                     FT_Stream  stream )
1115   {
1116     FT_Error  error;
1117     TT_OS2*   os2;
1118 
1119     static const FT_Frame_Field  os2_fields[] =
1120     {
1121 #undef  FT_STRUCTURE
1122 #define FT_STRUCTURE  TT_OS2
1123 
1124       FT_FRAME_START( 78 ),
1125         FT_FRAME_USHORT( version ),
1126         FT_FRAME_SHORT ( xAvgCharWidth ),
1127         FT_FRAME_USHORT( usWeightClass ),
1128         FT_FRAME_USHORT( usWidthClass ),
1129         FT_FRAME_SHORT ( fsType ),
1130         FT_FRAME_SHORT ( ySubscriptXSize ),
1131         FT_FRAME_SHORT ( ySubscriptYSize ),
</pre>
<hr />
<pre>
1236         if ( os2-&gt;version &gt;= 0x0005 )
1237         {
1238           /* only version 5 tables */
1239           if ( FT_STREAM_READ_FIELDS( os2_fields_extra5, os2 ) )
1240             goto Exit;
1241         }
1242       }
1243     }
1244 
1245     FT_TRACE3(( &quot;sTypoAscender:  %4d\n&quot;,   os2-&gt;sTypoAscender ));
1246     FT_TRACE3(( &quot;sTypoDescender: %4d\n&quot;,   os2-&gt;sTypoDescender ));
1247     FT_TRACE3(( &quot;usWinAscent:    %4u\n&quot;,   os2-&gt;usWinAscent ));
1248     FT_TRACE3(( &quot;usWinDescent:   %4u\n&quot;,   os2-&gt;usWinDescent ));
1249     FT_TRACE3(( &quot;fsSelection:    0x%2x\n&quot;, os2-&gt;fsSelection ));
1250 
1251   Exit:
1252     return error;
1253   }
1254 
1255 
<span class="line-modified">1256   /**************************************************************************</span>
<span class="line-modified">1257    *</span>
<span class="line-modified">1258    * @Function:</span>
<span class="line-modified">1259    *   tt_face_load_postscript</span>
<span class="line-modified">1260    *</span>
<span class="line-modified">1261    * @Description:</span>
<span class="line-modified">1262    *   Loads the Postscript table.</span>
<span class="line-modified">1263    *</span>
<span class="line-modified">1264    * @Input:</span>
<span class="line-modified">1265    *   face ::</span>
<span class="line-modified">1266    *     A handle to the target face object.</span>
<span class="line-modified">1267    *</span>
<span class="line-modified">1268    *   stream ::</span>
<span class="line-modified">1269    *     A handle to the input stream.</span>
<span class="line-modified">1270    *</span>
<span class="line-modified">1271    * @Return:</span>
<span class="line-added">1272    *   FreeType error code.  0 means success.</span>
<span class="line-added">1273    */</span>
1274   FT_LOCAL_DEF( FT_Error )
1275   tt_face_load_post( TT_Face    face,
1276                      FT_Stream  stream )
1277   {
1278     FT_Error        error;
1279     TT_Postscript*  post = &amp;face-&gt;postscript;
1280 
1281     static const FT_Frame_Field  post_fields[] =
1282     {
1283 #undef  FT_STRUCTURE
1284 #define FT_STRUCTURE  TT_Postscript
1285 
1286       FT_FRAME_START( 32 ),
1287         FT_FRAME_LONG ( FormatType ),
1288         FT_FRAME_LONG ( italicAngle ),
1289         FT_FRAME_SHORT( underlinePosition ),
1290         FT_FRAME_SHORT( underlineThickness ),
1291         FT_FRAME_ULONG( isFixedPitch ),
1292         FT_FRAME_ULONG( minMemType42 ),
1293         FT_FRAME_ULONG( maxMemType42 ),
</pre>
<hr />
<pre>
1298 
1299 
1300     error = face-&gt;goto_table( face, TTAG_post, stream, 0 );
1301     if ( error )
1302       return error;
1303 
1304     if ( FT_STREAM_READ_FIELDS( post_fields, post ) )
1305       return error;
1306 
1307     /* we don&#39;t load the glyph names, we do that in another */
1308     /* module (ttpost).                                     */
1309 
1310     FT_TRACE3(( &quot;FormatType:   0x%x\n&quot;, post-&gt;FormatType ));
1311     FT_TRACE3(( &quot;isFixedPitch:   %s\n&quot;, post-&gt;isFixedPitch
1312                                         ? &quot;  yes&quot; : &quot;   no&quot; ));
1313 
1314     return FT_Err_Ok;
1315   }
1316 
1317 
<span class="line-modified">1318   /**************************************************************************</span>
<span class="line-modified">1319    *</span>
<span class="line-modified">1320    * @Function:</span>
<span class="line-modified">1321    *   tt_face_load_pclt</span>
<span class="line-modified">1322    *</span>
<span class="line-modified">1323    * @Description:</span>
<span class="line-modified">1324    *   Loads the PCL 5 Table.</span>
<span class="line-modified">1325    *</span>
<span class="line-modified">1326    * @Input:</span>
<span class="line-modified">1327    *   face ::</span>
<span class="line-modified">1328    *     A handle to the target face object.</span>
<span class="line-modified">1329    *</span>
<span class="line-modified">1330    *   stream ::</span>
<span class="line-modified">1331    *     A handle to the input stream.</span>
<span class="line-modified">1332    *</span>
<span class="line-modified">1333    * @Return:</span>
<span class="line-added">1334    *   FreeType error code.  0 means success.</span>
<span class="line-added">1335    */</span>
1336   FT_LOCAL_DEF( FT_Error )
1337   tt_face_load_pclt( TT_Face    face,
1338                      FT_Stream  stream )
1339   {
1340     static const FT_Frame_Field  pclt_fields[] =
1341     {
1342 #undef  FT_STRUCTURE
1343 #define FT_STRUCTURE  TT_PCLT
1344 
1345       FT_FRAME_START( 54 ),
1346         FT_FRAME_ULONG ( Version ),
1347         FT_FRAME_ULONG ( FontNumber ),
1348         FT_FRAME_USHORT( Pitch ),
1349         FT_FRAME_USHORT( xHeight ),
1350         FT_FRAME_USHORT( Style ),
1351         FT_FRAME_USHORT( TypeFamily ),
1352         FT_FRAME_USHORT( CapHeight ),
1353         FT_FRAME_USHORT( SymbolSet ),
1354         FT_FRAME_BYTES ( TypeFace, 16 ),
1355         FT_FRAME_BYTES ( CharacterComplement, 8 ),
</pre>
<hr />
<pre>
1361       FT_FRAME_END
1362     };
1363 
1364     FT_Error  error;
1365     TT_PCLT*  pclt = &amp;face-&gt;pclt;
1366 
1367 
1368     /* optional table */
1369     error = face-&gt;goto_table( face, TTAG_PCLT, stream, 0 );
1370     if ( error )
1371       goto Exit;
1372 
1373     if ( FT_STREAM_READ_FIELDS( pclt_fields, pclt ) )
1374       goto Exit;
1375 
1376   Exit:
1377     return error;
1378   }
1379 
1380 
<span class="line-modified">1381   /**************************************************************************</span>
<span class="line-modified">1382    *</span>
<span class="line-modified">1383    * @Function:</span>
<span class="line-modified">1384    *   tt_face_load_gasp</span>
<span class="line-modified">1385    *</span>
<span class="line-modified">1386    * @Description:</span>
<span class="line-modified">1387    *   Loads the `gasp&#39; table into a face object.</span>
<span class="line-modified">1388    *</span>
<span class="line-modified">1389    * @Input:</span>
<span class="line-modified">1390    *   face ::</span>
<span class="line-modified">1391    *     A handle to the target face object.</span>
<span class="line-modified">1392    *</span>
<span class="line-modified">1393    *   stream ::</span>
<span class="line-modified">1394    *     The input stream.</span>
<span class="line-modified">1395    *</span>
<span class="line-modified">1396    * @Return:</span>
<span class="line-added">1397    *   FreeType error code.  0 means success.</span>
<span class="line-added">1398    */</span>
1399   FT_LOCAL_DEF( FT_Error )
1400   tt_face_load_gasp( TT_Face    face,
1401                      FT_Stream  stream )
1402   {
1403     FT_Error   error;
1404     FT_Memory  memory = stream-&gt;memory;
1405 
1406     FT_UInt        j,num_ranges;
1407     TT_GaspRange   gaspranges = NULL;
1408 
1409 
1410     /* the gasp table is optional */
1411     error = face-&gt;goto_table( face, TTAG_gasp, stream, 0 );
1412     if ( error )
1413       goto Exit;
1414 
1415     if ( FT_FRAME_ENTER( 4L ) )
1416       goto Exit;
1417 
1418     face-&gt;gasp.version   = FT_GET_USHORT();
</pre>
</td>
</tr>
</table>
<center><a href="ttkern.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttload.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>