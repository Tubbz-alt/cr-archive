<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/truetype/ttpload.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ttobjs.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttpload.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/truetype/ttpload.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">  1 /***************************************************************************/</span>
<span class="line-modified">  2 /*                                                                         */</span>
<span class="line-modified">  3 /*  ttpload.c                                                              */</span>
<span class="line-modified">  4 /*                                                                         */</span>
<span class="line-modified">  5 /*    TrueType-specific tables loader (body).                              */</span>
<span class="line-modified">  6 /*                                                                         */</span>
<span class="line-modified">  7 /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">  8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">  9 /*                                                                         */</span>
<span class="line-modified"> 10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified"> 11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified"> 12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified"> 13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified"> 14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified"> 15 /*                                                                         */</span>
<span class="line-modified"> 16 /***************************************************************************/</span>
 17 
 18 
 19 #include &lt;ft2build.h&gt;
 20 #include FT_INTERNAL_DEBUG_H
 21 #include FT_INTERNAL_OBJECTS_H
 22 #include FT_INTERNAL_STREAM_H
 23 #include FT_TRUETYPE_TAGS_H
 24 
 25 #include &quot;ttpload.h&quot;
 26 
 27 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
 28 #include &quot;ttgxvar.h&quot;
 29 #endif
 30 
 31 #include &quot;tterrors.h&quot;
 32 
 33 
<span class="line-modified"> 34   /*************************************************************************/</span>
<span class="line-modified"> 35   /*                                                                       */</span>
<span class="line-modified"> 36   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified"> 37   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified"> 38   /* messages during execution.                                            */</span>
<span class="line-modified"> 39   /*                                                                       */</span>
 40 #undef  FT_COMPONENT
<span class="line-modified"> 41 #define FT_COMPONENT  trace_ttpload</span>
<span class="line-modified"> 42 </span>
<span class="line-modified"> 43 </span>
<span class="line-modified"> 44   /*************************************************************************/</span>
<span class="line-modified"> 45   /*                                                                       */</span>
<span class="line-modified"> 46   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified"> 47   /*    tt_face_load_loca                                                  */</span>
<span class="line-modified"> 48   /*                                                                       */</span>
<span class="line-modified"> 49   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified"> 50   /*    Load the locations table.                                          */</span>
<span class="line-modified"> 51   /*                                                                       */</span>
<span class="line-modified"> 52   /* &lt;InOut&gt;                                                               */</span>
<span class="line-modified"> 53   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified"> 54   /*                                                                       */</span>
<span class="line-modified"> 55   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified"> 56   /*    stream :: The input stream.                                        */</span>
<span class="line-modified"> 57   /*                                                                       */</span>
<span class="line-modified"> 58   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified"> 59   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified"> 60   /*                                                                       */</span>


 61   FT_LOCAL_DEF( FT_Error )
 62   tt_face_load_loca( TT_Face    face,
 63                      FT_Stream  stream )
 64   {
 65     FT_Error  error;
 66     FT_ULong  table_len;
 67     FT_Int    shift;
 68 
 69 
 70     /* we need the size of the `glyf&#39; table for malformed `loca&#39; tables */
 71     error = face-&gt;goto_table( face, TTAG_glyf, stream, &amp;face-&gt;glyf_len );
 72 
 73     /* it is possible that a font doesn&#39;t have a glyf table at all */
 74     /* or its size is zero                                         */
 75     if ( FT_ERR_EQ( error, Table_Missing ) )
 76     {
 77       face-&gt;glyf_len    = 0;
 78       face-&gt;glyf_offset = 0;
 79     }
 80     else if ( error )
</pre>
<hr />
<pre>
280       *asize = (FT_UInt)( pos2 - pos1 );
281     else
282       *asize = (FT_UInt)( face-&gt;glyf_len - pos1 );
283 
284     return pos1;
285   }
286 
287 
288   FT_LOCAL_DEF( void )
289   tt_face_done_loca( TT_Face  face )
290   {
291     FT_Stream  stream = face-&gt;root.stream;
292 
293 
294     FT_FRAME_RELEASE( face-&gt;glyph_locations );
295     face-&gt;num_locations = 0;
296   }
297 
298 
299 
<span class="line-modified">300   /*************************************************************************/</span>
<span class="line-modified">301   /*                                                                       */</span>
<span class="line-modified">302   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">303   /*    tt_face_load_cvt                                                   */</span>
<span class="line-modified">304   /*                                                                       */</span>
<span class="line-modified">305   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">306   /*    Load the control value table into a face object.                   */</span>
<span class="line-modified">307   /*                                                                       */</span>
<span class="line-modified">308   /* &lt;InOut&gt;                                                               */</span>
<span class="line-modified">309   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified">310   /*                                                                       */</span>
<span class="line-modified">311   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">312   /*    stream :: A handle to the input stream.                            */</span>
<span class="line-modified">313   /*                                                                       */</span>
<span class="line-modified">314   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">315   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">316   /*                                                                       */</span>


317   FT_LOCAL_DEF( FT_Error )
318   tt_face_load_cvt( TT_Face    face,
319                     FT_Stream  stream )
320   {
321 #ifdef TT_USE_BYTECODE_INTERPRETER
322 
323     FT_Error   error;
324     FT_Memory  memory = stream-&gt;memory;
325     FT_ULong   table_len;
326 
327 
328     FT_TRACE2(( &quot;CVT &quot; ));
329 
330     error = face-&gt;goto_table( face, TTAG_cvt, stream, &amp;table_len );
331     if ( error )
332     {
333       FT_TRACE2(( &quot;is missing\n&quot; ));
334 
335       face-&gt;cvt_size = 0;
336       face-&gt;cvt      = NULL;
337       error          = FT_Err_Ok;
338 
339       goto Exit;
340     }
341 
342     face-&gt;cvt_size = table_len / 2;
343 
344     if ( FT_NEW_ARRAY( face-&gt;cvt, face-&gt;cvt_size ) )
345       goto Exit;
346 
347     if ( FT_FRAME_ENTER( face-&gt;cvt_size * 2L ) )
348       goto Exit;
349 
350     {
<span class="line-modified">351       FT_Short*  cur   = face-&gt;cvt;</span>
<span class="line-modified">352       FT_Short*  limit = cur + face-&gt;cvt_size;</span>
353 
354 
355       for ( ; cur &lt; limit; cur++ )
<span class="line-modified">356         *cur = FT_GET_SHORT();</span>
357     }
358 
359     FT_FRAME_EXIT();
360     FT_TRACE2(( &quot;loaded\n&quot; ));
361 
362 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
363     if ( face-&gt;doblend )
364       error = tt_face_vary_cvt( face, stream );
365 #endif
366 
367   Exit:
368     return error;
369 
370 #else /* !TT_USE_BYTECODE_INTERPRETER */
371 
372     FT_UNUSED( face   );
373     FT_UNUSED( stream );
374 
375     return FT_Err_Ok;
376 
377 #endif
378   }
379 
380 
<span class="line-modified">381   /*************************************************************************/</span>
<span class="line-modified">382   /*                                                                       */</span>
<span class="line-modified">383   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">384   /*    tt_face_load_fpgm                                                  */</span>
<span class="line-modified">385   /*                                                                       */</span>
<span class="line-modified">386   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">387   /*    Load the font program.                                             */</span>
<span class="line-modified">388   /*                                                                       */</span>
<span class="line-modified">389   /* &lt;InOut&gt;                                                               */</span>
<span class="line-modified">390   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified">391   /*                                                                       */</span>
<span class="line-modified">392   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">393   /*    stream :: A handle to the input stream.                            */</span>
<span class="line-modified">394   /*                                                                       */</span>
<span class="line-modified">395   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">396   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">397   /*                                                                       */</span>


398   FT_LOCAL_DEF( FT_Error )
399   tt_face_load_fpgm( TT_Face    face,
400                      FT_Stream  stream )
401   {
402 #ifdef TT_USE_BYTECODE_INTERPRETER
403 
404     FT_Error  error;
405     FT_ULong  table_len;
406 
407 
408     FT_TRACE2(( &quot;Font program &quot; ));
409 
410     /* The font program is optional */
411     error = face-&gt;goto_table( face, TTAG_fpgm, stream, &amp;table_len );
412     if ( error )
413     {
414       face-&gt;font_program      = NULL;
415       face-&gt;font_program_size = 0;
416       error                   = FT_Err_Ok;
417 
</pre>
<hr />
<pre>
423       if ( FT_FRAME_EXTRACT( table_len, face-&gt;font_program ) )
424         goto Exit;
425 
426       FT_TRACE2(( &quot;loaded, %12d bytes\n&quot;, face-&gt;font_program_size ));
427     }
428 
429   Exit:
430     return error;
431 
432 #else /* !TT_USE_BYTECODE_INTERPRETER */
433 
434     FT_UNUSED( face   );
435     FT_UNUSED( stream );
436 
437     return FT_Err_Ok;
438 
439 #endif
440   }
441 
442 
<span class="line-modified">443   /*************************************************************************/</span>
<span class="line-modified">444   /*                                                                       */</span>
<span class="line-modified">445   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">446   /*    tt_face_load_prep                                                  */</span>
<span class="line-modified">447   /*                                                                       */</span>
<span class="line-modified">448   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">449   /*    Load the cvt program.                                              */</span>
<span class="line-modified">450   /*                                                                       */</span>
<span class="line-modified">451   /* &lt;InOut&gt;                                                               */</span>
<span class="line-modified">452   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified">453   /*                                                                       */</span>
<span class="line-modified">454   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">455   /*    stream :: A handle to the input stream.                            */</span>
<span class="line-modified">456   /*                                                                       */</span>
<span class="line-modified">457   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">458   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">459   /*                                                                       */</span>


460   FT_LOCAL_DEF( FT_Error )
461   tt_face_load_prep( TT_Face    face,
462                      FT_Stream  stream )
463   {
464 #ifdef TT_USE_BYTECODE_INTERPRETER
465 
466     FT_Error  error;
467     FT_ULong  table_len;
468 
469 
470     FT_TRACE2(( &quot;Prep program &quot; ));
471 
472     error = face-&gt;goto_table( face, TTAG_prep, stream, &amp;table_len );
473     if ( error )
474     {
475       face-&gt;cvt_program      = NULL;
476       face-&gt;cvt_program_size = 0;
477       error                  = FT_Err_Ok;
478 
479       FT_TRACE2(( &quot;is missing\n&quot; ));
</pre>
<hr />
<pre>
484       if ( FT_FRAME_EXTRACT( table_len, face-&gt;cvt_program ) )
485         goto Exit;
486 
487       FT_TRACE2(( &quot;loaded, %12d bytes\n&quot;, face-&gt;cvt_program_size ));
488     }
489 
490   Exit:
491     return error;
492 
493 #else /* !TT_USE_BYTECODE_INTERPRETER */
494 
495     FT_UNUSED( face   );
496     FT_UNUSED( stream );
497 
498     return FT_Err_Ok;
499 
500 #endif
501   }
502 
503 
<span class="line-modified">504   /*************************************************************************/</span>
<span class="line-modified">505   /*                                                                       */</span>
<span class="line-modified">506   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">507   /*    tt_face_load_hdmx                                                  */</span>
<span class="line-modified">508   /*                                                                       */</span>
<span class="line-modified">509   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">510   /*    Load the `hdmx&#39; table into the face object.                        */</span>
<span class="line-modified">511   /*                                                                       */</span>
<span class="line-modified">512   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">513   /*    face   :: A handle to the target face object.                      */</span>
<span class="line-modified">514   /*                                                                       */</span>
<span class="line-modified">515   /*    stream :: A handle to the input stream.                            */</span>
<span class="line-modified">516   /*                                                                       */</span>
<span class="line-modified">517   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">518   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">519   /*                                                                       */</span>


520 
521   FT_LOCAL_DEF( FT_Error )
522   tt_face_load_hdmx( TT_Face    face,
523                      FT_Stream  stream )
524   {
525     FT_Error   error;
526     FT_Memory  memory = stream-&gt;memory;
527     FT_UInt    nn, num_records;
528     FT_ULong   table_size, record_size;
529     FT_Byte*   p;
530     FT_Byte*   limit;
531 
532 
533     /* this table is optional */
534     error = face-&gt;goto_table( face, TTAG_hdmx, stream, &amp;table_size );
535     if ( error || table_size &lt; 8 )
536       return FT_Err_Ok;
537 
538     if ( FT_FRAME_EXTRACT( table_size, face-&gt;hdmx_table ) )
539       goto Exit;
</pre>
<hr />
<pre>
593 
594   Fail:
595     FT_FRAME_RELEASE( face-&gt;hdmx_table );
596     face-&gt;hdmx_table_size = 0;
597     goto Exit;
598   }
599 
600 
601   FT_LOCAL_DEF( void )
602   tt_face_free_hdmx( TT_Face  face )
603   {
604     FT_Stream  stream = face-&gt;root.stream;
605     FT_Memory  memory = stream-&gt;memory;
606 
607 
608     FT_FREE( face-&gt;hdmx_record_sizes );
609     FT_FRAME_RELEASE( face-&gt;hdmx_table );
610   }
611 
612 
<span class="line-modified">613   /*************************************************************************/</span>
<span class="line-modified">614   /*                                                                       */</span>
<span class="line-modified">615   /* Return the advance width table for a given pixel size if it is found  */</span>
<span class="line-modified">616   /* in the font&#39;s `hdmx&#39; table (if any).                                  */</span>
<span class="line-modified">617   /*                                                                       */</span>
618   FT_LOCAL_DEF( FT_Byte* )
619   tt_face_get_device_metrics( TT_Face  face,
620                               FT_UInt  ppem,
621                               FT_UInt  gindex )
622   {
623     FT_UInt   nn;
624     FT_Byte*  result      = NULL;
625     FT_ULong  record_size = face-&gt;hdmx_record_size;
626     FT_Byte*  record      = face-&gt;hdmx_table + 8;
627 
628 
629     for ( nn = 0; nn &lt; face-&gt;hdmx_record_count; nn++ )
630       if ( face-&gt;hdmx_record_sizes[nn] == ppem )
631       {
632         gindex += 2;
633         if ( gindex &lt; record_size )
634           result = record + nn * record_size + gindex;
635         break;
636       }
637 
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">  1 /****************************************************************************</span>
<span class="line-modified">  2  *</span>
<span class="line-modified">  3  * ttpload.c</span>
<span class="line-modified">  4  *</span>
<span class="line-modified">  5  *   TrueType-specific tables loader (body).</span>
<span class="line-modified">  6  *</span>
<span class="line-modified">  7  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">  8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">  9  *</span>
<span class="line-modified"> 10  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified"> 11  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified"> 12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified"> 13  * this file you indicate that you have read the license and</span>
<span class="line-modified"> 14  * understand and accept it fully.</span>
<span class="line-modified"> 15  *</span>
<span class="line-modified"> 16  */</span>
 17 
 18 
 19 #include &lt;ft2build.h&gt;
 20 #include FT_INTERNAL_DEBUG_H
 21 #include FT_INTERNAL_OBJECTS_H
 22 #include FT_INTERNAL_STREAM_H
 23 #include FT_TRUETYPE_TAGS_H
 24 
 25 #include &quot;ttpload.h&quot;
 26 
 27 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
 28 #include &quot;ttgxvar.h&quot;
 29 #endif
 30 
 31 #include &quot;tterrors.h&quot;
 32 
 33 
<span class="line-modified"> 34   /**************************************************************************</span>
<span class="line-modified"> 35    *</span>
<span class="line-modified"> 36    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified"> 37    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified"> 38    * messages during execution.</span>
<span class="line-modified"> 39    */</span>
 40 #undef  FT_COMPONENT
<span class="line-modified"> 41 #define FT_COMPONENT  ttpload</span>
<span class="line-modified"> 42 </span>
<span class="line-modified"> 43 </span>
<span class="line-modified"> 44   /**************************************************************************</span>
<span class="line-modified"> 45    *</span>
<span class="line-modified"> 46    * @Function:</span>
<span class="line-modified"> 47    *   tt_face_load_loca</span>
<span class="line-modified"> 48    *</span>
<span class="line-modified"> 49    * @Description:</span>
<span class="line-modified"> 50    *   Load the locations table.</span>
<span class="line-modified"> 51    *</span>
<span class="line-modified"> 52    * @InOut:</span>
<span class="line-modified"> 53    *   face ::</span>
<span class="line-modified"> 54    *     A handle to the target face object.</span>
<span class="line-modified"> 55    *</span>
<span class="line-modified"> 56    * @Input:</span>
<span class="line-modified"> 57    *   stream ::</span>
<span class="line-modified"> 58    *     The input stream.</span>
<span class="line-modified"> 59    *</span>
<span class="line-modified"> 60    * @Return:</span>
<span class="line-added"> 61    *   FreeType error code.  0 means success.</span>
<span class="line-added"> 62    */</span>
 63   FT_LOCAL_DEF( FT_Error )
 64   tt_face_load_loca( TT_Face    face,
 65                      FT_Stream  stream )
 66   {
 67     FT_Error  error;
 68     FT_ULong  table_len;
 69     FT_Int    shift;
 70 
 71 
 72     /* we need the size of the `glyf&#39; table for malformed `loca&#39; tables */
 73     error = face-&gt;goto_table( face, TTAG_glyf, stream, &amp;face-&gt;glyf_len );
 74 
 75     /* it is possible that a font doesn&#39;t have a glyf table at all */
 76     /* or its size is zero                                         */
 77     if ( FT_ERR_EQ( error, Table_Missing ) )
 78     {
 79       face-&gt;glyf_len    = 0;
 80       face-&gt;glyf_offset = 0;
 81     }
 82     else if ( error )
</pre>
<hr />
<pre>
282       *asize = (FT_UInt)( pos2 - pos1 );
283     else
284       *asize = (FT_UInt)( face-&gt;glyf_len - pos1 );
285 
286     return pos1;
287   }
288 
289 
290   FT_LOCAL_DEF( void )
291   tt_face_done_loca( TT_Face  face )
292   {
293     FT_Stream  stream = face-&gt;root.stream;
294 
295 
296     FT_FRAME_RELEASE( face-&gt;glyph_locations );
297     face-&gt;num_locations = 0;
298   }
299 
300 
301 
<span class="line-modified">302   /**************************************************************************</span>
<span class="line-modified">303    *</span>
<span class="line-modified">304    * @Function:</span>
<span class="line-modified">305    *   tt_face_load_cvt</span>
<span class="line-modified">306    *</span>
<span class="line-modified">307    * @Description:</span>
<span class="line-modified">308    *   Load the control value table into a face object.</span>
<span class="line-modified">309    *</span>
<span class="line-modified">310    * @InOut:</span>
<span class="line-modified">311    *   face ::</span>
<span class="line-modified">312    *     A handle to the target face object.</span>
<span class="line-modified">313    *</span>
<span class="line-modified">314    * @Input:</span>
<span class="line-modified">315    *   stream ::</span>
<span class="line-modified">316    *     A handle to the input stream.</span>
<span class="line-modified">317    *</span>
<span class="line-modified">318    * @Return:</span>
<span class="line-added">319    *   FreeType error code.  0 means success.</span>
<span class="line-added">320    */</span>
321   FT_LOCAL_DEF( FT_Error )
322   tt_face_load_cvt( TT_Face    face,
323                     FT_Stream  stream )
324   {
325 #ifdef TT_USE_BYTECODE_INTERPRETER
326 
327     FT_Error   error;
328     FT_Memory  memory = stream-&gt;memory;
329     FT_ULong   table_len;
330 
331 
332     FT_TRACE2(( &quot;CVT &quot; ));
333 
334     error = face-&gt;goto_table( face, TTAG_cvt, stream, &amp;table_len );
335     if ( error )
336     {
337       FT_TRACE2(( &quot;is missing\n&quot; ));
338 
339       face-&gt;cvt_size = 0;
340       face-&gt;cvt      = NULL;
341       error          = FT_Err_Ok;
342 
343       goto Exit;
344     }
345 
346     face-&gt;cvt_size = table_len / 2;
347 
348     if ( FT_NEW_ARRAY( face-&gt;cvt, face-&gt;cvt_size ) )
349       goto Exit;
350 
351     if ( FT_FRAME_ENTER( face-&gt;cvt_size * 2L ) )
352       goto Exit;
353 
354     {
<span class="line-modified">355       FT_Int32*  cur   = face-&gt;cvt;</span>
<span class="line-modified">356       FT_Int32*  limit = cur + face-&gt;cvt_size;</span>
357 
358 
359       for ( ; cur &lt; limit; cur++ )
<span class="line-modified">360         *cur = FT_GET_SHORT() * 64;</span>
361     }
362 
363     FT_FRAME_EXIT();
364     FT_TRACE2(( &quot;loaded\n&quot; ));
365 
366 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
367     if ( face-&gt;doblend )
368       error = tt_face_vary_cvt( face, stream );
369 #endif
370 
371   Exit:
372     return error;
373 
374 #else /* !TT_USE_BYTECODE_INTERPRETER */
375 
376     FT_UNUSED( face   );
377     FT_UNUSED( stream );
378 
379     return FT_Err_Ok;
380 
381 #endif
382   }
383 
384 
<span class="line-modified">385   /**************************************************************************</span>
<span class="line-modified">386    *</span>
<span class="line-modified">387    * @Function:</span>
<span class="line-modified">388    *   tt_face_load_fpgm</span>
<span class="line-modified">389    *</span>
<span class="line-modified">390    * @Description:</span>
<span class="line-modified">391    *   Load the font program.</span>
<span class="line-modified">392    *</span>
<span class="line-modified">393    * @InOut:</span>
<span class="line-modified">394    *   face ::</span>
<span class="line-modified">395    *     A handle to the target face object.</span>
<span class="line-modified">396    *</span>
<span class="line-modified">397    * @Input:</span>
<span class="line-modified">398    *   stream ::</span>
<span class="line-modified">399    *     A handle to the input stream.</span>
<span class="line-modified">400    *</span>
<span class="line-modified">401    * @Return:</span>
<span class="line-added">402    *   FreeType error code.  0 means success.</span>
<span class="line-added">403    */</span>
404   FT_LOCAL_DEF( FT_Error )
405   tt_face_load_fpgm( TT_Face    face,
406                      FT_Stream  stream )
407   {
408 #ifdef TT_USE_BYTECODE_INTERPRETER
409 
410     FT_Error  error;
411     FT_ULong  table_len;
412 
413 
414     FT_TRACE2(( &quot;Font program &quot; ));
415 
416     /* The font program is optional */
417     error = face-&gt;goto_table( face, TTAG_fpgm, stream, &amp;table_len );
418     if ( error )
419     {
420       face-&gt;font_program      = NULL;
421       face-&gt;font_program_size = 0;
422       error                   = FT_Err_Ok;
423 
</pre>
<hr />
<pre>
429       if ( FT_FRAME_EXTRACT( table_len, face-&gt;font_program ) )
430         goto Exit;
431 
432       FT_TRACE2(( &quot;loaded, %12d bytes\n&quot;, face-&gt;font_program_size ));
433     }
434 
435   Exit:
436     return error;
437 
438 #else /* !TT_USE_BYTECODE_INTERPRETER */
439 
440     FT_UNUSED( face   );
441     FT_UNUSED( stream );
442 
443     return FT_Err_Ok;
444 
445 #endif
446   }
447 
448 
<span class="line-modified">449   /**************************************************************************</span>
<span class="line-modified">450    *</span>
<span class="line-modified">451    * @Function:</span>
<span class="line-modified">452    *   tt_face_load_prep</span>
<span class="line-modified">453    *</span>
<span class="line-modified">454    * @Description:</span>
<span class="line-modified">455    *   Load the cvt program.</span>
<span class="line-modified">456    *</span>
<span class="line-modified">457    * @InOut:</span>
<span class="line-modified">458    *   face ::</span>
<span class="line-modified">459    *     A handle to the target face object.</span>
<span class="line-modified">460    *</span>
<span class="line-modified">461    * @Input:</span>
<span class="line-modified">462    *   stream ::</span>
<span class="line-modified">463    *     A handle to the input stream.</span>
<span class="line-modified">464    *</span>
<span class="line-modified">465    * @Return:</span>
<span class="line-added">466    *   FreeType error code.  0 means success.</span>
<span class="line-added">467    */</span>
468   FT_LOCAL_DEF( FT_Error )
469   tt_face_load_prep( TT_Face    face,
470                      FT_Stream  stream )
471   {
472 #ifdef TT_USE_BYTECODE_INTERPRETER
473 
474     FT_Error  error;
475     FT_ULong  table_len;
476 
477 
478     FT_TRACE2(( &quot;Prep program &quot; ));
479 
480     error = face-&gt;goto_table( face, TTAG_prep, stream, &amp;table_len );
481     if ( error )
482     {
483       face-&gt;cvt_program      = NULL;
484       face-&gt;cvt_program_size = 0;
485       error                  = FT_Err_Ok;
486 
487       FT_TRACE2(( &quot;is missing\n&quot; ));
</pre>
<hr />
<pre>
492       if ( FT_FRAME_EXTRACT( table_len, face-&gt;cvt_program ) )
493         goto Exit;
494 
495       FT_TRACE2(( &quot;loaded, %12d bytes\n&quot;, face-&gt;cvt_program_size ));
496     }
497 
498   Exit:
499     return error;
500 
501 #else /* !TT_USE_BYTECODE_INTERPRETER */
502 
503     FT_UNUSED( face   );
504     FT_UNUSED( stream );
505 
506     return FT_Err_Ok;
507 
508 #endif
509   }
510 
511 
<span class="line-modified">512   /**************************************************************************</span>
<span class="line-modified">513    *</span>
<span class="line-modified">514    * @Function:</span>
<span class="line-modified">515    *   tt_face_load_hdmx</span>
<span class="line-modified">516    *</span>
<span class="line-modified">517    * @Description:</span>
<span class="line-modified">518    *   Load the `hdmx&#39; table into the face object.</span>
<span class="line-modified">519    *</span>
<span class="line-modified">520    * @Input:</span>
<span class="line-modified">521    *   face ::</span>
<span class="line-modified">522    *     A handle to the target face object.</span>
<span class="line-modified">523    *</span>
<span class="line-modified">524    *   stream ::</span>
<span class="line-modified">525    *     A handle to the input stream.</span>
<span class="line-modified">526    *</span>
<span class="line-modified">527    * @Return:</span>
<span class="line-added">528    *   FreeType error code.  0 means success.</span>
<span class="line-added">529    */</span>
530 
531   FT_LOCAL_DEF( FT_Error )
532   tt_face_load_hdmx( TT_Face    face,
533                      FT_Stream  stream )
534   {
535     FT_Error   error;
536     FT_Memory  memory = stream-&gt;memory;
537     FT_UInt    nn, num_records;
538     FT_ULong   table_size, record_size;
539     FT_Byte*   p;
540     FT_Byte*   limit;
541 
542 
543     /* this table is optional */
544     error = face-&gt;goto_table( face, TTAG_hdmx, stream, &amp;table_size );
545     if ( error || table_size &lt; 8 )
546       return FT_Err_Ok;
547 
548     if ( FT_FRAME_EXTRACT( table_size, face-&gt;hdmx_table ) )
549       goto Exit;
</pre>
<hr />
<pre>
603 
604   Fail:
605     FT_FRAME_RELEASE( face-&gt;hdmx_table );
606     face-&gt;hdmx_table_size = 0;
607     goto Exit;
608   }
609 
610 
611   FT_LOCAL_DEF( void )
612   tt_face_free_hdmx( TT_Face  face )
613   {
614     FT_Stream  stream = face-&gt;root.stream;
615     FT_Memory  memory = stream-&gt;memory;
616 
617 
618     FT_FREE( face-&gt;hdmx_record_sizes );
619     FT_FRAME_RELEASE( face-&gt;hdmx_table );
620   }
621 
622 
<span class="line-modified">623   /**************************************************************************</span>
<span class="line-modified">624    *</span>
<span class="line-modified">625    * Return the advance width table for a given pixel size if it is found</span>
<span class="line-modified">626    * in the font&#39;s `hdmx&#39; table (if any).</span>
<span class="line-modified">627    */</span>
628   FT_LOCAL_DEF( FT_Byte* )
629   tt_face_get_device_metrics( TT_Face  face,
630                               FT_UInt  ppem,
631                               FT_UInt  gindex )
632   {
633     FT_UInt   nn;
634     FT_Byte*  result      = NULL;
635     FT_ULong  record_size = face-&gt;hdmx_record_size;
636     FT_Byte*  record      = face-&gt;hdmx_table + 8;
637 
638 
639     for ( nn = 0; nn &lt; face-&gt;hdmx_record_count; nn++ )
640       if ( face-&gt;hdmx_record_sizes[nn] == ppem )
641       {
642         gindex += 2;
643         if ( gindex &lt; record_size )
644           result = record + nn * record_size + gindex;
645         break;
646       }
647 
</pre>
</td>
</tr>
</table>
<center><a href="ttobjs.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttpload.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>