<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/base/ftglyph.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ftgloadr.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="fthash.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/base/ftglyph.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">  1 /***************************************************************************/</span>
<span class="line-modified">  2 /*                                                                         */</span>
<span class="line-modified">  3 /*  ftglyph.c                                                              */</span>
<span class="line-modified">  4 /*                                                                         */</span>
<span class="line-modified">  5 /*    FreeType convenience functions to handle glyphs (body).              */</span>
<span class="line-modified">  6 /*                                                                         */</span>
<span class="line-modified">  7 /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">  8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">  9 /*                                                                         */</span>
<span class="line-modified"> 10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified"> 11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified"> 12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified"> 13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified"> 14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified"> 15 /*                                                                         */</span>
<span class="line-modified"> 16 /***************************************************************************/</span>
<span class="line-modified"> 17 </span>
<span class="line-modified"> 18   /*************************************************************************/</span>
<span class="line-modified"> 19   /*                                                                       */</span>
<span class="line-modified"> 20   /*  This file contains the definition of several convenience functions   */</span>
<span class="line-modified"> 21   /*  that can be used by client applications to easily retrieve glyph     */</span>
<span class="line-modified"> 22   /*  bitmaps and outlines from a given face.                              */</span>
<span class="line-modified"> 23   /*                                                                       */</span>
<span class="line-modified"> 24   /*  These functions should be optional if you are writing a font server  */</span>
<span class="line-modified"> 25   /*  or text layout engine on top of FreeType.  However, they are pretty  */</span>
<span class="line-modified"> 26   /*  handy for many other simple uses of the library.                     */</span>
<span class="line-modified"> 27   /*                                                                       */</span>
<span class="line-modified"> 28   /*************************************************************************/</span>
 29 
 30 
 31 #include &lt;ft2build.h&gt;
 32 #include FT_INTERNAL_DEBUG_H
 33 
 34 #include FT_GLYPH_H
 35 #include FT_OUTLINE_H
 36 #include FT_BITMAP_H
 37 #include FT_INTERNAL_OBJECTS_H
 38 
<span class="line-removed"> 39 #include &quot;basepic.h&quot;</span>
 40 
<span class="line-modified"> 41   /*************************************************************************/</span>
<span class="line-modified"> 42   /*                                                                       */</span>
<span class="line-modified"> 43   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified"> 44   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified"> 45   /* messages during execution.                                            */</span>
<span class="line-modified"> 46   /*                                                                       */</span>
 47 #undef  FT_COMPONENT
<span class="line-modified"> 48 #define FT_COMPONENT  trace_glyph</span>
 49 
 50 
 51   /*************************************************************************/
 52   /*************************************************************************/
 53   /****                                                                 ****/
 54   /****   FT_BitmapGlyph support                                        ****/
 55   /****                                                                 ****/
 56   /*************************************************************************/
 57   /*************************************************************************/
 58 
 59   FT_CALLBACK_DEF( FT_Error )
 60   ft_bitmap_glyph_init( FT_Glyph      bitmap_glyph,
 61                         FT_GlyphSlot  slot )
 62   {
 63     FT_BitmapGlyph  glyph   = (FT_BitmapGlyph)bitmap_glyph;
 64     FT_Error        error   = FT_Err_Ok;
 65     FT_Library      library = FT_GLYPH( glyph )-&gt;library;
 66 
 67 
 68     if ( slot-&gt;format != FT_GLYPH_FORMAT_BITMAP )
 69     {
 70       error = FT_THROW( Invalid_Glyph_Format );
 71       goto Exit;
 72     }
 73 
 74     glyph-&gt;left = slot-&gt;bitmap_left;
 75     glyph-&gt;top  = slot-&gt;bitmap_top;
 76 
 77     /* do lazy copying whenever possible */
 78     if ( slot-&gt;internal-&gt;flags &amp; FT_GLYPH_OWN_BITMAP )
 79     {
<span class="line-modified"> 80       glyph-&gt;bitmap = slot-&gt;bitmap;</span>
 81       slot-&gt;internal-&gt;flags &amp;= ~FT_GLYPH_OWN_BITMAP;
 82     }
 83     else
 84     {
 85       FT_Bitmap_Init( &amp;glyph-&gt;bitmap );
 86       error = FT_Bitmap_Copy( library, &amp;slot-&gt;bitmap, &amp;glyph-&gt;bitmap );
 87     }
 88 
 89   Exit:
 90     return error;
 91   }
 92 
 93 
 94   FT_CALLBACK_DEF( FT_Error )
 95   ft_bitmap_glyph_copy( FT_Glyph  bitmap_source,
 96                         FT_Glyph  bitmap_target )
 97   {
 98     FT_Library      library = bitmap_source-&gt;library;
 99     FT_BitmapGlyph  source  = (FT_BitmapGlyph)bitmap_source;
100     FT_BitmapGlyph  target  = (FT_BitmapGlyph)bitmap_target;
</pre>
<hr />
<pre>
342       goto Exit;
343 
344     copy-&gt;advance = source-&gt;advance;
345     copy-&gt;format  = source-&gt;format;
346 
347     if ( clazz-&gt;glyph_copy )
348       error = clazz-&gt;glyph_copy( source, copy );
349 
350     if ( error )
351       FT_Done_Glyph( copy );
352     else
353       *target = copy;
354 
355   Exit:
356     return error;
357   }
358 
359 
360   /* documentation is in ftglyph.h */
361 
<span class="line-modified">362   FT_EXPORT_DEF( FT_Error )</span>
<span class="line-modified">363   FT_Get_Glyph( FT_GlyphSlot  slot,</span>
<span class="line-modified">364                 FT_Glyph     *aglyph )</span>

365   {
<span class="line-removed">366     FT_Library  library;</span>
<span class="line-removed">367     FT_Error    error;</span>
<span class="line-removed">368     FT_Glyph    glyph;</span>
<span class="line-removed">369 </span>
370     const FT_Glyph_Class*  clazz = NULL;
371 
<span class="line-modified">372 </span>
<span class="line-removed">373     if ( !slot )</span>
<span class="line-removed">374       return FT_THROW( Invalid_Slot_Handle );</span>
<span class="line-removed">375 </span>
<span class="line-removed">376     library = slot-&gt;library;</span>
<span class="line-removed">377 </span>
<span class="line-removed">378     if ( !aglyph )</span>
379       return FT_THROW( Invalid_Argument );
380 
381     /* if it is a bitmap, that&#39;s easy :-) */
<span class="line-modified">382     if ( slot-&gt;format == FT_GLYPH_FORMAT_BITMAP )</span>
<span class="line-modified">383       clazz = FT_BITMAP_GLYPH_CLASS_GET;</span>
384 
385     /* if it is an outline */
<span class="line-modified">386     else if ( slot-&gt;format == FT_GLYPH_FORMAT_OUTLINE )</span>
<span class="line-modified">387       clazz = FT_OUTLINE_GLYPH_CLASS_GET;</span>
388 
389     else
390     {
391       /* try to find a renderer that supports the glyph image format */
<span class="line-modified">392       FT_Renderer  render = FT_Lookup_Renderer( library, slot-&gt;format, 0 );</span>
393 
394 
395       if ( render )
396         clazz = &amp;render-&gt;glyph_class;
397     }
398 
399     if ( !clazz )
<span class="line-modified">400     {</span>
<span class="line-modified">401       error = FT_THROW( Invalid_Glyph_Format );</span>
<span class="line-modified">402       goto Exit;</span>
<span class="line-modified">403     }</span>


















404 
405     /* create FT_Glyph object */
<span class="line-modified">406     error = ft_new_glyph( library, clazz, &amp;glyph );</span>
407     if ( error )
408       goto Exit;
409 
410     /* copy advance while converting 26.6 to 16.16 format */
411     if ( slot-&gt;advance.x &gt;=  0x8000L * 64 ||
412          slot-&gt;advance.x &lt;= -0x8000L * 64 )
413     {
414       FT_ERROR(( &quot;FT_Get_Glyph: advance width too large\n&quot; ));
415       error = FT_THROW( Invalid_Argument );
416       goto Exit2;
417     }
418     if ( slot-&gt;advance.y &gt;=  0x8000L * 64 ||
419          slot-&gt;advance.y &lt;= -0x8000L * 64 )
420     {
421       FT_ERROR(( &quot;FT_Get_Glyph: advance height too large\n&quot; ));
422       error = FT_THROW( Invalid_Argument );
423       goto Exit2;
424     }
425 
426     glyph-&gt;advance.x = slot-&gt;advance.x * 1024;
427     glyph-&gt;advance.y = slot-&gt;advance.y * 1024;
428 
429     /* now import the image from the glyph slot */
<span class="line-modified">430     error = clazz-&gt;glyph_init( glyph, slot );</span>
431 
432   Exit2:
433     /* if an error occurred, destroy the glyph */
434     if ( error )
435       FT_Done_Glyph( glyph );
436     else
437       *aglyph = glyph;
438 
439   Exit:
440     return error;
441   }
442 
443 
444   /* documentation is in ftglyph.h */
445 
446   FT_EXPORT_DEF( FT_Error )
447   FT_Glyph_Transform( FT_Glyph    glyph,
448                       FT_Matrix*  matrix,
449                       FT_Vector*  delta )
450   {
</pre>
<hr />
<pre>
488       return;
489 
490     acbox-&gt;xMin = acbox-&gt;yMin = acbox-&gt;xMax = acbox-&gt;yMax = 0;
491 
492     if ( !glyph || !glyph-&gt;clazz )
493       return;
494 
495     clazz = glyph-&gt;clazz;
496     if ( !clazz-&gt;glyph_bbox )
497       return;
498 
499     /* retrieve bbox in 26.6 coordinates */
500     clazz-&gt;glyph_bbox( glyph, acbox );
501 
502     /* perform grid fitting if needed */
503     if ( bbox_mode == FT_GLYPH_BBOX_GRIDFIT ||
504          bbox_mode == FT_GLYPH_BBOX_PIXELS  )
505     {
506       acbox-&gt;xMin = FT_PIX_FLOOR( acbox-&gt;xMin );
507       acbox-&gt;yMin = FT_PIX_FLOOR( acbox-&gt;yMin );
<span class="line-modified">508       acbox-&gt;xMax = FT_PIX_CEIL( acbox-&gt;xMax );</span>
<span class="line-modified">509       acbox-&gt;yMax = FT_PIX_CEIL( acbox-&gt;yMax );</span>
510     }
511 
512     /* convert to integer pixels if needed */
513     if ( bbox_mode == FT_GLYPH_BBOX_TRUNCATE ||
514          bbox_mode == FT_GLYPH_BBOX_PIXELS   )
515     {
516       acbox-&gt;xMin &gt;&gt;= 6;
517       acbox-&gt;yMin &gt;&gt;= 6;
518       acbox-&gt;xMax &gt;&gt;= 6;
519       acbox-&gt;yMax &gt;&gt;= 6;
520     }
521   }
522 
523 
524   /* documentation is in ftglyph.h */
525 
526   FT_EXPORT_DEF( FT_Error )
527   FT_Glyph_To_Bitmap( FT_Glyph*       the_glyph,
528                       FT_Render_Mode  render_mode,
529                       FT_Vector*      origin,
530                       FT_Bool         destroy )
531   {
532     FT_GlyphSlotRec           dummy;
533     FT_GlyphSlot_InternalRec  dummy_internal;
534     FT_Error                  error = FT_Err_Ok;
535     FT_Glyph                  b, glyph;
536     FT_BitmapGlyph            bitmap = NULL;
537     const FT_Glyph_Class*     clazz;
538 
<span class="line-removed">539     /* FT_BITMAP_GLYPH_CLASS_GET dereferences `library&#39; in PIC mode */</span>
540     FT_Library                library;
541 
542 
543     /* check argument */
544     if ( !the_glyph )
545       goto Bad;
546     glyph = *the_glyph;
547     if ( !glyph )
548       goto Bad;
549 
550     clazz   = glyph-&gt;clazz;
551     library = glyph-&gt;library;
552     if ( !library || !clazz )
553       goto Bad;
554 
555     /* when called with a bitmap glyph, do nothing and return successfully */
<span class="line-modified">556     if ( clazz == FT_BITMAP_GLYPH_CLASS_GET )</span>
557       goto Exit;
558 
559     if ( !clazz-&gt;glyph_prepare )
560       goto Bad;
561 
562     /* we render the glyph into a glyph bitmap using a `dummy&#39; glyph slot */
563     /* then calling FT_Render_Glyph_Internal()                            */
564 
565     FT_ZERO( &amp;dummy );
566     FT_ZERO( &amp;dummy_internal );
567     dummy.internal = &amp;dummy_internal;
568     dummy.library  = library;
569     dummy.format   = clazz-&gt;glyph_format;
570 
571     /* create result bitmap glyph */
<span class="line-modified">572     error = ft_new_glyph( library, FT_BITMAP_GLYPH_CLASS_GET, &amp;b );</span>
573     if ( error )
574       goto Exit;
575     bitmap = (FT_BitmapGlyph)b;
576 
577 #if 1
578     /* if `origin&#39; is set, translate the glyph image */
579     if ( origin )
580       FT_Glyph_Transform( glyph, 0, origin );
581 #else
582     FT_UNUSED( origin );
583 #endif
584 
585     /* prepare dummy slot for rendering */
586     error = clazz-&gt;glyph_prepare( glyph, &amp;dummy );
587     if ( !error )
588       error = FT_Render_Glyph_Internal( glyph-&gt;library, &amp;dummy, render_mode );
589 
590 #if 1
591     if ( !destroy &amp;&amp; origin )
592     {
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">  1 /****************************************************************************</span>
<span class="line-modified">  2  *</span>
<span class="line-modified">  3  * ftglyph.c</span>
<span class="line-modified">  4  *</span>
<span class="line-modified">  5  *   FreeType convenience functions to handle glyphs (body).</span>
<span class="line-modified">  6  *</span>
<span class="line-modified">  7  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">  8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">  9  *</span>
<span class="line-modified"> 10  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified"> 11  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified"> 12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified"> 13  * this file you indicate that you have read the license and</span>
<span class="line-modified"> 14  * understand and accept it fully.</span>
<span class="line-modified"> 15  *</span>
<span class="line-modified"> 16  */</span>
<span class="line-modified"> 17 </span>
<span class="line-modified"> 18   /**************************************************************************</span>
<span class="line-modified"> 19    *</span>
<span class="line-modified"> 20    * This file contains the definition of several convenience functions</span>
<span class="line-modified"> 21    * that can be used by client applications to easily retrieve glyph</span>
<span class="line-modified"> 22    * bitmaps and outlines from a given face.</span>
<span class="line-modified"> 23    *</span>
<span class="line-modified"> 24    * These functions should be optional if you are writing a font server</span>
<span class="line-modified"> 25    * or text layout engine on top of FreeType.  However, they are pretty</span>
<span class="line-modified"> 26    * handy for many other simple uses of the library.</span>
<span class="line-modified"> 27    *</span>
<span class="line-modified"> 28    */</span>
 29 
 30 
 31 #include &lt;ft2build.h&gt;
 32 #include FT_INTERNAL_DEBUG_H
 33 
 34 #include FT_GLYPH_H
 35 #include FT_OUTLINE_H
 36 #include FT_BITMAP_H
 37 #include FT_INTERNAL_OBJECTS_H
 38 

 39 
<span class="line-modified"> 40   /**************************************************************************</span>
<span class="line-modified"> 41    *</span>
<span class="line-modified"> 42    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified"> 43    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified"> 44    * messages during execution.</span>
<span class="line-modified"> 45    */</span>
 46 #undef  FT_COMPONENT
<span class="line-modified"> 47 #define FT_COMPONENT  glyph</span>
 48 
 49 
 50   /*************************************************************************/
 51   /*************************************************************************/
 52   /****                                                                 ****/
 53   /****   FT_BitmapGlyph support                                        ****/
 54   /****                                                                 ****/
 55   /*************************************************************************/
 56   /*************************************************************************/
 57 
 58   FT_CALLBACK_DEF( FT_Error )
 59   ft_bitmap_glyph_init( FT_Glyph      bitmap_glyph,
 60                         FT_GlyphSlot  slot )
 61   {
 62     FT_BitmapGlyph  glyph   = (FT_BitmapGlyph)bitmap_glyph;
 63     FT_Error        error   = FT_Err_Ok;
 64     FT_Library      library = FT_GLYPH( glyph )-&gt;library;
 65 
 66 
 67     if ( slot-&gt;format != FT_GLYPH_FORMAT_BITMAP )
 68     {
 69       error = FT_THROW( Invalid_Glyph_Format );
 70       goto Exit;
 71     }
 72 
 73     glyph-&gt;left = slot-&gt;bitmap_left;
 74     glyph-&gt;top  = slot-&gt;bitmap_top;
 75 
 76     /* do lazy copying whenever possible */
 77     if ( slot-&gt;internal-&gt;flags &amp; FT_GLYPH_OWN_BITMAP )
 78     {
<span class="line-modified"> 79       glyph-&gt;bitmap          = slot-&gt;bitmap;</span>
 80       slot-&gt;internal-&gt;flags &amp;= ~FT_GLYPH_OWN_BITMAP;
 81     }
 82     else
 83     {
 84       FT_Bitmap_Init( &amp;glyph-&gt;bitmap );
 85       error = FT_Bitmap_Copy( library, &amp;slot-&gt;bitmap, &amp;glyph-&gt;bitmap );
 86     }
 87 
 88   Exit:
 89     return error;
 90   }
 91 
 92 
 93   FT_CALLBACK_DEF( FT_Error )
 94   ft_bitmap_glyph_copy( FT_Glyph  bitmap_source,
 95                         FT_Glyph  bitmap_target )
 96   {
 97     FT_Library      library = bitmap_source-&gt;library;
 98     FT_BitmapGlyph  source  = (FT_BitmapGlyph)bitmap_source;
 99     FT_BitmapGlyph  target  = (FT_BitmapGlyph)bitmap_target;
</pre>
<hr />
<pre>
341       goto Exit;
342 
343     copy-&gt;advance = source-&gt;advance;
344     copy-&gt;format  = source-&gt;format;
345 
346     if ( clazz-&gt;glyph_copy )
347       error = clazz-&gt;glyph_copy( source, copy );
348 
349     if ( error )
350       FT_Done_Glyph( copy );
351     else
352       *target = copy;
353 
354   Exit:
355     return error;
356   }
357 
358 
359   /* documentation is in ftglyph.h */
360 
<span class="line-modified">361   FT_EXPORT( FT_Error )</span>
<span class="line-modified">362   FT_New_Glyph( FT_Library       library,</span>
<span class="line-modified">363                 FT_Glyph_Format  format,</span>
<span class="line-added">364                 FT_Glyph        *aglyph )</span>
365   {




366     const FT_Glyph_Class*  clazz = NULL;
367 
<span class="line-modified">368     if ( !library || !aglyph )</span>






369       return FT_THROW( Invalid_Argument );
370 
371     /* if it is a bitmap, that&#39;s easy :-) */
<span class="line-modified">372     if ( format == FT_GLYPH_FORMAT_BITMAP )</span>
<span class="line-modified">373       clazz = &amp;ft_bitmap_glyph_class;</span>
374 
375     /* if it is an outline */
<span class="line-modified">376     else if ( format == FT_GLYPH_FORMAT_OUTLINE )</span>
<span class="line-modified">377       clazz = &amp;ft_outline_glyph_class;</span>
378 
379     else
380     {
381       /* try to find a renderer that supports the glyph image format */
<span class="line-modified">382       FT_Renderer  render = FT_Lookup_Renderer( library, format, 0 );</span>
383 
384 
385       if ( render )
386         clazz = &amp;render-&gt;glyph_class;
387     }
388 
389     if ( !clazz )
<span class="line-modified">390       return FT_THROW( Invalid_Glyph_Format );</span>
<span class="line-modified">391 </span>
<span class="line-modified">392     /* create FT_Glyph object */</span>
<span class="line-modified">393     return ft_new_glyph( library, clazz, aglyph );</span>
<span class="line-added">394   }</span>
<span class="line-added">395 </span>
<span class="line-added">396 </span>
<span class="line-added">397   /* documentation is in ftglyph.h */</span>
<span class="line-added">398 </span>
<span class="line-added">399   FT_EXPORT_DEF( FT_Error )</span>
<span class="line-added">400   FT_Get_Glyph( FT_GlyphSlot  slot,</span>
<span class="line-added">401                 FT_Glyph     *aglyph )</span>
<span class="line-added">402   {</span>
<span class="line-added">403     FT_Error  error;</span>
<span class="line-added">404     FT_Glyph  glyph;</span>
<span class="line-added">405 </span>
<span class="line-added">406 </span>
<span class="line-added">407     if ( !slot )</span>
<span class="line-added">408       return FT_THROW( Invalid_Slot_Handle );</span>
<span class="line-added">409 </span>
<span class="line-added">410     if ( !aglyph )</span>
<span class="line-added">411       return FT_THROW( Invalid_Argument );</span>
412 
413     /* create FT_Glyph object */
<span class="line-modified">414     error = FT_New_Glyph( slot-&gt;library, slot-&gt;format, &amp;glyph );</span>
415     if ( error )
416       goto Exit;
417 
418     /* copy advance while converting 26.6 to 16.16 format */
419     if ( slot-&gt;advance.x &gt;=  0x8000L * 64 ||
420          slot-&gt;advance.x &lt;= -0x8000L * 64 )
421     {
422       FT_ERROR(( &quot;FT_Get_Glyph: advance width too large\n&quot; ));
423       error = FT_THROW( Invalid_Argument );
424       goto Exit2;
425     }
426     if ( slot-&gt;advance.y &gt;=  0x8000L * 64 ||
427          slot-&gt;advance.y &lt;= -0x8000L * 64 )
428     {
429       FT_ERROR(( &quot;FT_Get_Glyph: advance height too large\n&quot; ));
430       error = FT_THROW( Invalid_Argument );
431       goto Exit2;
432     }
433 
434     glyph-&gt;advance.x = slot-&gt;advance.x * 1024;
435     glyph-&gt;advance.y = slot-&gt;advance.y * 1024;
436 
437     /* now import the image from the glyph slot */
<span class="line-modified">438     error = glyph-&gt;clazz-&gt;glyph_init( glyph, slot );</span>
439 
440   Exit2:
441     /* if an error occurred, destroy the glyph */
442     if ( error )
443       FT_Done_Glyph( glyph );
444     else
445       *aglyph = glyph;
446 
447   Exit:
448     return error;
449   }
450 
451 
452   /* documentation is in ftglyph.h */
453 
454   FT_EXPORT_DEF( FT_Error )
455   FT_Glyph_Transform( FT_Glyph    glyph,
456                       FT_Matrix*  matrix,
457                       FT_Vector*  delta )
458   {
</pre>
<hr />
<pre>
496       return;
497 
498     acbox-&gt;xMin = acbox-&gt;yMin = acbox-&gt;xMax = acbox-&gt;yMax = 0;
499 
500     if ( !glyph || !glyph-&gt;clazz )
501       return;
502 
503     clazz = glyph-&gt;clazz;
504     if ( !clazz-&gt;glyph_bbox )
505       return;
506 
507     /* retrieve bbox in 26.6 coordinates */
508     clazz-&gt;glyph_bbox( glyph, acbox );
509 
510     /* perform grid fitting if needed */
511     if ( bbox_mode == FT_GLYPH_BBOX_GRIDFIT ||
512          bbox_mode == FT_GLYPH_BBOX_PIXELS  )
513     {
514       acbox-&gt;xMin = FT_PIX_FLOOR( acbox-&gt;xMin );
515       acbox-&gt;yMin = FT_PIX_FLOOR( acbox-&gt;yMin );
<span class="line-modified">516       acbox-&gt;xMax = FT_PIX_CEIL_LONG( acbox-&gt;xMax );</span>
<span class="line-modified">517       acbox-&gt;yMax = FT_PIX_CEIL_LONG( acbox-&gt;yMax );</span>
518     }
519 
520     /* convert to integer pixels if needed */
521     if ( bbox_mode == FT_GLYPH_BBOX_TRUNCATE ||
522          bbox_mode == FT_GLYPH_BBOX_PIXELS   )
523     {
524       acbox-&gt;xMin &gt;&gt;= 6;
525       acbox-&gt;yMin &gt;&gt;= 6;
526       acbox-&gt;xMax &gt;&gt;= 6;
527       acbox-&gt;yMax &gt;&gt;= 6;
528     }
529   }
530 
531 
532   /* documentation is in ftglyph.h */
533 
534   FT_EXPORT_DEF( FT_Error )
535   FT_Glyph_To_Bitmap( FT_Glyph*       the_glyph,
536                       FT_Render_Mode  render_mode,
537                       FT_Vector*      origin,
538                       FT_Bool         destroy )
539   {
540     FT_GlyphSlotRec           dummy;
541     FT_GlyphSlot_InternalRec  dummy_internal;
542     FT_Error                  error = FT_Err_Ok;
543     FT_Glyph                  b, glyph;
544     FT_BitmapGlyph            bitmap = NULL;
545     const FT_Glyph_Class*     clazz;
546 

547     FT_Library                library;
548 
549 
550     /* check argument */
551     if ( !the_glyph )
552       goto Bad;
553     glyph = *the_glyph;
554     if ( !glyph )
555       goto Bad;
556 
557     clazz   = glyph-&gt;clazz;
558     library = glyph-&gt;library;
559     if ( !library || !clazz )
560       goto Bad;
561 
562     /* when called with a bitmap glyph, do nothing and return successfully */
<span class="line-modified">563     if ( clazz == &amp;ft_bitmap_glyph_class )</span>
564       goto Exit;
565 
566     if ( !clazz-&gt;glyph_prepare )
567       goto Bad;
568 
569     /* we render the glyph into a glyph bitmap using a `dummy&#39; glyph slot */
570     /* then calling FT_Render_Glyph_Internal()                            */
571 
572     FT_ZERO( &amp;dummy );
573     FT_ZERO( &amp;dummy_internal );
574     dummy.internal = &amp;dummy_internal;
575     dummy.library  = library;
576     dummy.format   = clazz-&gt;glyph_format;
577 
578     /* create result bitmap glyph */
<span class="line-modified">579     error = ft_new_glyph( library, &amp;ft_bitmap_glyph_class, &amp;b );</span>
580     if ( error )
581       goto Exit;
582     bitmap = (FT_BitmapGlyph)b;
583 
584 #if 1
585     /* if `origin&#39; is set, translate the glyph image */
586     if ( origin )
587       FT_Glyph_Transform( glyph, 0, origin );
588 #else
589     FT_UNUSED( origin );
590 #endif
591 
592     /* prepare dummy slot for rendering */
593     error = clazz-&gt;glyph_prepare( glyph, &amp;dummy );
594     if ( !error )
595       error = FT_Render_Glyph_Internal( glyph-&gt;library, &amp;dummy, render_mode );
596 
597 #if 1
598     if ( !destroy &amp;&amp; origin )
599     {
</pre>
</td>
</tr>
</table>
<center><a href="ftgloadr.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="fthash.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>