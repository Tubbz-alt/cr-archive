<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfreetype/src/truetype/ttgload.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="tterrors.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttgload.h.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/truetype/ttgload.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,21 +1,21 @@</span>
<span class="udiff-line-modified-removed">- /***************************************************************************/</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  ttgload.c                                                              */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*    TrueType Glyph Loader (body).                                        */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  Copyright 1996-2018 by                                                 */</span>
<span class="udiff-line-modified-removed">- /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="udiff-line-modified-removed">- /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="udiff-line-modified-removed">- /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="udiff-line-modified-removed">- /*  this file you indicate that you have read the license and              */</span>
<span class="udiff-line-modified-removed">- /*  understand and accept it fully.                                        */</span>
<span class="udiff-line-modified-removed">- /*                                                                         */</span>
<span class="udiff-line-modified-removed">- /***************************************************************************/</span>
<span class="udiff-line-modified-added">+ /****************************************************************************</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * ttgload.c</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  *   TrueType Glyph Loader (body).</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * Copyright (C) 1996-2019 by</span>
<span class="udiff-line-modified-added">+  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * This file is part of the FreeType project, and may only be used,</span>
<span class="udiff-line-modified-added">+  * modified, and distributed under the terms of the FreeType project</span>
<span class="udiff-line-modified-added">+  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="udiff-line-modified-added">+  * this file you indicate that you have read the license and</span>
<span class="udiff-line-modified-added">+  * understand and accept it fully.</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  */</span>
  
  
  #include &lt;ft2build.h&gt;
  #include FT_INTERNAL_DEBUG_H
  #include FT_CONFIG_CONFIG_H
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -36,43 +36,67 @@</span>
  
  #include &quot;tterrors.h&quot;
  #include &quot;ttsubpix.h&quot;
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="udiff-line-modified-removed">-   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="udiff-line-modified-removed">-   /* messages during execution.                                            */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="udiff-line-modified-added">+    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="udiff-line-modified-added">+    * messages during execution.</span>
<span class="udiff-line-modified-added">+    */</span>
  #undef  FT_COMPONENT
<span class="udiff-line-modified-removed">- #define FT_COMPONENT  trace_ttgload</span>
<span class="udiff-line-modified-added">+ #define FT_COMPONENT  ttgload</span>
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* Composite glyph flags.                                                */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * Simple glyph flags.</span>
<span class="udiff-line-modified-added">+    */</span>
<span class="udiff-line-added">+ #define ON_CURVE_POINT  0x01  /* same value as FT_CURVE_TAG_ON            */</span>
<span class="udiff-line-added">+ #define X_SHORT_VECTOR  0x02</span>
<span class="udiff-line-added">+ #define Y_SHORT_VECTOR  0x04</span>
<span class="udiff-line-added">+ #define REPEAT_FLAG     0x08</span>
<span class="udiff-line-added">+ #define X_POSITIVE      0x10  /* two meanings depending on X_SHORT_VECTOR */</span>
<span class="udiff-line-added">+ #define SAME_X          0x10</span>
<span class="udiff-line-added">+ #define Y_POSITIVE      0x20  /* two meanings depending on Y_SHORT_VECTOR */</span>
<span class="udiff-line-added">+ #define SAME_Y          0x20</span>
<span class="udiff-line-added">+ #define OVERLAP_SIMPLE  0x40  /* we ignore this value                     */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /**************************************************************************</span>
<span class="udiff-line-added">+    *</span>
<span class="udiff-line-added">+    * Composite glyph flags.</span>
<span class="udiff-line-added">+    */</span>
  #define ARGS_ARE_WORDS             0x0001
  #define ARGS_ARE_XY_VALUES         0x0002
  #define ROUND_XY_TO_GRID           0x0004
  #define WE_HAVE_A_SCALE            0x0008
  /* reserved                        0x0010 */
  #define MORE_COMPONENTS            0x0020
  #define WE_HAVE_AN_XY_SCALE        0x0040
  #define WE_HAVE_A_2X2              0x0080
  #define WE_HAVE_INSTR              0x0100
  #define USE_MY_METRICS             0x0200
<span class="udiff-line-modified-removed">- #define OVERLAP_COMPOUND           0x0400</span>
<span class="udiff-line-modified-added">+ #define OVERLAP_COMPOUND           0x0400  /* we ignore this value */</span>
  #define SCALED_COMPONENT_OFFSET    0x0800
  #define UNSCALED_COMPONENT_OFFSET  0x1000
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* Return the horizontal metrics in font units for a given glyph.        */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+ #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</span>
<span class="udiff-line-modified-added">+ #define IS_DEFAULT_INSTANCE( _face )             \</span>
<span class="udiff-line-modified-added">+           ( !( FT_IS_NAMED_INSTANCE( _face ) ||  \</span>
<span class="udiff-line-modified-added">+                FT_IS_VARIATION( _face )      ) )</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+ #define IS_DEFAULT_INSTANCE( _face )  1</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /**************************************************************************</span>
<span class="udiff-line-added">+    *</span>
<span class="udiff-line-added">+    * Return the horizontal metrics in font units for a given glyph.</span>
<span class="udiff-line-added">+    */</span>
    FT_LOCAL_DEF( void )
    TT_Get_HMetrics( TT_Face     face,
                     FT_UInt     idx,
                     FT_Short*   lsb,
                     FT_UShort*  aw )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -82,15 +106,15 @@</span>
      FT_TRACE5(( &quot;  advance width (font units): %d\n&quot;, *aw ));
      FT_TRACE5(( &quot;  left side bearing (font units): %d\n&quot;, *lsb ));
    }
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* Return the vertical metrics in font units for a given glyph.          */</span>
<span class="udiff-line-modified-removed">-   /* See function `tt_loader_set_pp&#39; below for explanations.               */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * Return the vertical metrics in font units for a given glyph.</span>
<span class="udiff-line-modified-added">+    * See function `tt_loader_set_pp&#39; below for explanations.</span>
<span class="udiff-line-modified-added">+    */</span>
    FT_LOCAL_DEF( void )
    TT_Get_VMetrics( TT_Face     face,
                     FT_UInt     idx,
                     FT_Pos      yMax,
                     FT_Short*   tsb,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -248,33 +272,30 @@</span>
    }
  
  #endif /* FT_CONFIG_OPTION_INCREMENTAL */
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* The following functions are used by default with TrueType fonts.      */</span>
<span class="udiff-line-modified-removed">-   /* However, they can be replaced by alternatives if we need to support   */</span>
<span class="udiff-line-modified-removed">-   /* TrueType-compressed formats (like MicroType) in the future.           */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * The following functions are used by default with TrueType fonts.</span>
<span class="udiff-line-modified-added">+    * However, they can be replaced by alternatives if we need to support</span>
<span class="udiff-line-modified-added">+    * TrueType-compressed formats (like MicroType) in the future.</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    */</span>
  
    FT_CALLBACK_DEF( FT_Error )
    TT_Access_Glyph_Frame( TT_Loader  loader,
                           FT_UInt    glyph_index,
                           FT_ULong   offset,
                           FT_UInt    byte_count )
    {
      FT_Error   error;
      FT_Stream  stream = loader-&gt;stream;
  
<span class="udiff-line-removed">-     /* for non-debug mode */</span>
      FT_UNUSED( glyph_index );
  
  
<span class="udiff-line-removed">-     FT_TRACE4(( &quot;Glyph %ld\n&quot;, glyph_index ));</span>
<span class="udiff-line-removed">- </span>
      /* the following line sets the `error&#39; variable through macros! */
      if ( FT_STREAM_SEEK( offset ) || FT_FRAME_ENTER( byte_count ) )
        return error;
  
      loader-&gt;cursor = stream-&gt;cursor;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -335,11 +356,11 @@</span>
      FT_Int          n_points;
  
      FT_Byte         *flag, *flag_limit;
      FT_Byte         c, count;
      FT_Vector       *vec, *vec_limit;
<span class="udiff-line-modified-removed">-     FT_Pos          x;</span>
<span class="udiff-line-modified-added">+     FT_Pos          x, y;</span>
      FT_Short        *cont, *cont_limit, prev_cont;
      FT_Int          xy_size = 0;
  
  
      /* check that we can add the contours to the glyph */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -380,10 +401,12 @@</span>
        n_points = cont[-1] + 1;
        if ( n_points &lt; 0 )
          goto Invalid_Outline;
      }
  
<span class="udiff-line-added">+     FT_TRACE5(( &quot;  # of points: %d\n&quot;, n_points ));</span>
<span class="udiff-line-added">+ </span>
      /* note that we will add four phantom points later */
      error = FT_GLYPHLOADER_CHECK_POINTS( gloader, n_points + 4, 0 );
      if ( error )
        goto Fail;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -450,11 +473,11 @@</span>
      {
        if ( p + 1 &gt; limit )
          goto Invalid_Outline;
  
        *flag++ = c = FT_NEXT_BYTE( p );
<span class="udiff-line-modified-removed">-       if ( c &amp; 8 )</span>
<span class="udiff-line-modified-added">+       if ( c &amp; REPEAT_FLAG )</span>
        {
          if ( p + 1 &gt; limit )
            goto Invalid_Outline;
  
          count = FT_NEXT_BYTE( p );
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -476,71 +499,70 @@</span>
      if ( p + xy_size &gt; limit )
        goto Invalid_Outline;
  
      for ( ; vec &lt; vec_limit; vec++, flag++ )
      {
<span class="udiff-line-modified-removed">-       FT_Pos   y = 0;</span>
<span class="udiff-line-modified-removed">-       FT_Byte  f = *flag;</span>
<span class="udiff-line-modified-added">+       FT_Pos   delta = 0;</span>
<span class="udiff-line-modified-added">+       FT_Byte  f     = *flag;</span>
  
  
<span class="udiff-line-modified-removed">-       if ( f &amp; 2 )</span>
<span class="udiff-line-modified-added">+       if ( f &amp; X_SHORT_VECTOR )</span>
        {
          if ( p + 1 &gt; limit )
            goto Invalid_Outline;
  
<span class="udiff-line-modified-removed">-         y = (FT_Pos)FT_NEXT_BYTE( p );</span>
<span class="udiff-line-modified-removed">-         if ( ( f &amp; 16 ) == 0 )</span>
<span class="udiff-line-modified-removed">-           y = -y;</span>
<span class="udiff-line-modified-added">+         delta = (FT_Pos)FT_NEXT_BYTE( p );</span>
<span class="udiff-line-modified-added">+         if ( !( f &amp; X_POSITIVE ) )</span>
<span class="udiff-line-modified-added">+           delta = -delta;</span>
        }
<span class="udiff-line-modified-removed">-       else if ( ( f &amp; 16 ) == 0 )</span>
<span class="udiff-line-modified-added">+       else if ( !( f &amp; SAME_X ) )</span>
        {
          if ( p + 2 &gt; limit )
            goto Invalid_Outline;
  
<span class="udiff-line-modified-removed">-         y = (FT_Pos)FT_NEXT_SHORT( p );</span>
<span class="udiff-line-modified-added">+         delta = (FT_Pos)FT_NEXT_SHORT( p );</span>
        }
  
<span class="udiff-line-modified-removed">-       x     += y;</span>
<span class="udiff-line-modified-added">+       x     += delta;</span>
        vec-&gt;x = x;
<span class="udiff-line-removed">-       /* the cast is for stupid compilers */</span>
<span class="udiff-line-removed">-       *flag  = (FT_Byte)( f &amp; ~( 2 | 16 ) );</span>
      }
  
      /* reading the Y coordinates */
  
      vec       = gloader-&gt;current.outline.points;
      vec_limit = vec + n_points;
      flag      = (FT_Byte*)outline-&gt;tags;
<span class="udiff-line-modified-removed">-     x         = 0;</span>
<span class="udiff-line-modified-added">+     y         = 0;</span>
  
      for ( ; vec &lt; vec_limit; vec++, flag++ )
      {
<span class="udiff-line-modified-removed">-       FT_Pos   y = 0;</span>
<span class="udiff-line-modified-removed">-       FT_Byte  f = *flag;</span>
<span class="udiff-line-modified-added">+       FT_Pos   delta = 0;</span>
<span class="udiff-line-modified-added">+       FT_Byte  f     = *flag;</span>
  
  
<span class="udiff-line-modified-removed">-       if ( f &amp; 4 )</span>
<span class="udiff-line-modified-added">+       if ( f &amp; Y_SHORT_VECTOR )</span>
        {
          if ( p + 1 &gt; limit )
            goto Invalid_Outline;
  
<span class="udiff-line-modified-removed">-         y = (FT_Pos)FT_NEXT_BYTE( p );</span>
<span class="udiff-line-modified-removed">-         if ( ( f &amp; 32 ) == 0 )</span>
<span class="udiff-line-modified-removed">-           y = -y;</span>
<span class="udiff-line-modified-added">+         delta = (FT_Pos)FT_NEXT_BYTE( p );</span>
<span class="udiff-line-modified-added">+         if ( !( f &amp; Y_POSITIVE ) )</span>
<span class="udiff-line-modified-added">+           delta = -delta;</span>
        }
<span class="udiff-line-modified-removed">-       else if ( ( f &amp; 32 ) == 0 )</span>
<span class="udiff-line-modified-added">+       else if ( !( f &amp; SAME_Y ) )</span>
        {
          if ( p + 2 &gt; limit )
            goto Invalid_Outline;
  
<span class="udiff-line-modified-removed">-         y = (FT_Pos)FT_NEXT_SHORT( p );</span>
<span class="udiff-line-modified-added">+         delta = (FT_Pos)FT_NEXT_SHORT( p );</span>
        }
  
<span class="udiff-line-modified-removed">-       x     += y;</span>
<span class="udiff-line-modified-removed">-       vec-&gt;y = x;</span>
<span class="udiff-line-modified-added">+       y     += delta;</span>
<span class="udiff-line-modified-added">+       vec-&gt;y = y;</span>
<span class="udiff-line-added">+ </span>
        /* the cast is for stupid compilers */
<span class="udiff-line-modified-removed">-       *flag  = (FT_Byte)( f &amp; FT_CURVE_TAG_ON );</span>
<span class="udiff-line-modified-added">+       *flag  = (FT_Byte)( f &amp; ON_CURVE_POINT );</span>
      }
  
      outline-&gt;n_points   = (FT_Short)n_points;
      outline-&gt;n_contours = (FT_Short)n_contours;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -557,13 +579,14 @@</span>
  
    FT_CALLBACK_DEF( FT_Error )
    TT_Load_Composite_Glyph( TT_Loader  loader )
    {
      FT_Error        error;
<span class="udiff-line-modified-removed">-     FT_Byte*        p       = loader-&gt;cursor;</span>
<span class="udiff-line-modified-removed">-     FT_Byte*        limit   = loader-&gt;limit;</span>
<span class="udiff-line-modified-removed">-     FT_GlyphLoader  gloader = loader-&gt;gloader;</span>
<span class="udiff-line-modified-added">+     FT_Byte*        p          = loader-&gt;cursor;</span>
<span class="udiff-line-modified-added">+     FT_Byte*        limit      = loader-&gt;limit;</span>
<span class="udiff-line-modified-added">+     FT_GlyphLoader  gloader    = loader-&gt;gloader;</span>
<span class="udiff-line-added">+     FT_Long         num_glyphs = loader-&gt;face-&gt;root.num_glyphs;</span>
      FT_SubGlyph     subglyph;
      FT_UInt         num_subglyphs;
  
  
      num_subglyphs = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -588,10 +611,15 @@</span>
        subglyph-&gt;arg1 = subglyph-&gt;arg2 = 0;
  
        subglyph-&gt;flags = FT_NEXT_USHORT( p );
        subglyph-&gt;index = FT_NEXT_USHORT( p );
  
<span class="udiff-line-added">+       /* we reject composites that have components */</span>
<span class="udiff-line-added">+       /* with invalid glyph indices                */</span>
<span class="udiff-line-added">+       if ( subglyph-&gt;index &gt;= num_glyphs )</span>
<span class="udiff-line-added">+         goto Invalid_Composite;</span>
<span class="udiff-line-added">+ </span>
        /* check space */
        count = 2;
        if ( subglyph-&gt;flags &amp; ARGS_ARE_WORDS )
          count += 2;
        if ( subglyph-&gt;flags &amp; WE_HAVE_A_SCALE )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -766,19 +794,19 @@</span>
      zone-&gt;contours    = (FT_UShort*)load-&gt;outline.contours + start_contour;
      zone-&gt;first_point = (FT_UShort)start_point;
    }
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Function&gt;                                                            */</span>
<span class="udiff-line-modified-removed">-   /*    TT_Hint_Glyph                                                      */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Description&gt;                                                         */</span>
<span class="udiff-line-modified-removed">-   /*    Hint the glyph using the zone prepared by the caller.  Note that   */</span>
<span class="udiff-line-modified-removed">-   /*    the zone is supposed to include four phantom points.               */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Function:</span>
<span class="udiff-line-modified-added">+    *   TT_Hint_Glyph</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Description:</span>
<span class="udiff-line-modified-added">+    *   Hint the glyph using the zone prepared by the caller.  Note that</span>
<span class="udiff-line-modified-added">+    *   the zone is supposed to include four phantom points.</span>
<span class="udiff-line-modified-added">+    */</span>
    static FT_Error
    TT_Hint_Glyph( TT_Loader  loader,
                   FT_Bool    is_composite )
    {
  #if defined TT_SUPPORT_SUBPIXEL_HINTING_INFINALITY || \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -795,19 +823,13 @@</span>
      FT_UNUSED( is_composite );
  #endif
  
  
  #ifdef TT_USE_BYTECODE_INTERPRETER
<span class="udiff-line-removed">-     if ( loader-&gt;glyph-&gt;control_len &gt; 0xFFFFL )</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       FT_TRACE1(( &quot;TT_Hint_Glyph: too long instructions&quot; ));</span>
<span class="udiff-line-removed">-       FT_TRACE1(( &quot; (0x%lx byte) is truncated\n&quot;,</span>
<span class="udiff-line-removed">-                   loader-&gt;glyph-&gt;control_len ));</span>
<span class="udiff-line-removed">-     }</span>
      n_ins = loader-&gt;glyph-&gt;control_len;
  
<span class="udiff-line-modified-removed">-     /* save original point position in org */</span>
<span class="udiff-line-modified-added">+     /* save original point positions in `org&#39; array */</span>
      if ( n_ins &gt; 0 )
        FT_ARRAY_COPY( zone-&gt;org, zone-&gt;cur, zone-&gt;n_points );
  
      /* Reset graphics state. */
      loader-&gt;exec-&gt;GS = loader-&gt;size-&gt;GS;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -894,28 +916,33 @@</span>
  
      return FT_Err_Ok;
    }
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Function&gt;                                                            */</span>
<span class="udiff-line-modified-removed">-   /*    TT_Process_Simple_Glyph                                            */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Description&gt;                                                         */</span>
<span class="udiff-line-modified-removed">-   /*    Once a simple glyph has been loaded, it needs to be processed.     */</span>
<span class="udiff-line-modified-removed">-   /*    Usually, this means scaling and hinting through bytecode           */</span>
<span class="udiff-line-modified-removed">-   /*    interpretation.                                                    */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Function:</span>
<span class="udiff-line-modified-added">+    *   TT_Process_Simple_Glyph</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Description:</span>
<span class="udiff-line-modified-added">+    *   Once a simple glyph has been loaded, it needs to be processed.</span>
<span class="udiff-line-modified-added">+    *   Usually, this means scaling and hinting through bytecode</span>
<span class="udiff-line-modified-added">+    *   interpretation.</span>
<span class="udiff-line-modified-added">+    */</span>
    static FT_Error
    TT_Process_Simple_Glyph( TT_Loader  loader )
    {
      FT_GlyphLoader  gloader = loader-&gt;gloader;
      FT_Error        error   = FT_Err_Ok;
      FT_Outline*     outline;
      FT_Int          n_points;
  
<span class="udiff-line-added">+ #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</span>
<span class="udiff-line-added">+     FT_Memory   memory    = loader-&gt;face-&gt;root.memory;</span>
<span class="udiff-line-added">+     FT_Vector*  unrounded = NULL;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  
      outline  = &amp;gloader-&gt;current.outline;
      n_points = outline-&gt;n_points;
  
      /* set phantom points */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -932,30 +959,36 @@</span>
  
      n_points += 4;
  
  #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  
<span class="udiff-line-modified-removed">-     if ( FT_IS_NAMED_INSTANCE( FT_FACE( loader-&gt;face ) ) ||</span>
<span class="udiff-line-removed">-          FT_IS_VARIATION( FT_FACE( loader-&gt;face ) )      )</span>
<span class="udiff-line-modified-added">+     if ( !IS_DEFAULT_INSTANCE( FT_FACE( loader-&gt;face ) ) )</span>
      {
<span class="udiff-line-added">+       if ( FT_NEW_ARRAY( unrounded, n_points ) )</span>
<span class="udiff-line-added">+         goto Exit;</span>
<span class="udiff-line-added">+ </span>
        /* Deltas apply to the unscaled data. */
        error = TT_Vary_Apply_Glyph_Deltas( loader-&gt;face,
                                            loader-&gt;glyph_index,
                                            outline,
<span class="udiff-line-added">+                                           unrounded,</span>
                                            (FT_UInt)n_points );
  
        /* recalculate linear horizontal and vertical advances */
        /* if we don&#39;t have HVAR and VVAR, respectively        */
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       /* XXX: change all FreeType modules to store `linear&#39; and `vadvance&#39; */</span>
<span class="udiff-line-added">+       /*      in 26.6 format before the `base&#39; module scales them to 16.16 */</span>
        if ( !( loader-&gt;face-&gt;variation_support &amp; TT_FACE_FLAG_VAR_HADVANCE ) )
<span class="udiff-line-modified-removed">-         loader-&gt;linear = outline-&gt;points[n_points - 3].x -</span>
<span class="udiff-line-modified-removed">-                          outline-&gt;points[n_points - 4].x;</span>
<span class="udiff-line-modified-added">+         loader-&gt;linear = FT_PIX_ROUND( unrounded[n_points - 3].x -</span>
<span class="udiff-line-modified-added">+                                        unrounded[n_points - 4].x ) / 64;</span>
        if ( !( loader-&gt;face-&gt;variation_support &amp; TT_FACE_FLAG_VAR_VADVANCE ) )
<span class="udiff-line-modified-removed">-         loader-&gt;vadvance = outline-&gt;points[n_points - 1].x -</span>
<span class="udiff-line-modified-removed">-                            outline-&gt;points[n_points - 2].x;</span>
<span class="udiff-line-modified-added">+         loader-&gt;vadvance = FT_PIX_ROUND( unrounded[n_points - 1].x -</span>
<span class="udiff-line-modified-added">+                                          unrounded[n_points - 2].x ) / 64;</span>
  
        if ( error )
<span class="udiff-line-modified-removed">-         return error;</span>
<span class="udiff-line-modified-added">+         goto Exit;</span>
      }
  
  #endif /* TT_CONFIG_OPTION_GX_VAR_SUPPORT */
  
      if ( IS_HINTED( loader-&gt;load_flags ) )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1006,14 +1039,27 @@</span>
            y_scale = loader-&gt;size-&gt;metrics-&gt;y_scale;
  
            /* compensate for any scaling by de/emboldening; */
            /* the amount was determined via experimentation */
            if ( x_scale_factor != 1000 &amp;&amp; ppem &gt; 11 )
<span class="udiff-line-added">+           {</span>
<span class="udiff-line-added">+ #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</span>
<span class="udiff-line-added">+             FT_Vector*  orig_points = outline-&gt;points;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if ( !IS_DEFAULT_INSTANCE( FT_FACE( loader-&gt;face ) ) )</span>
<span class="udiff-line-added">+               outline-&gt;points = unrounded;</span>
<span class="udiff-line-added">+ #endif</span>
              FT_Outline_EmboldenXY( outline,
                                     FT_MulFix( 1280 * ppem,
                                                1000 - x_scale_factor ),
                                     0 );
<span class="udiff-line-added">+ #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</span>
<span class="udiff-line-added">+             if ( !IS_DEFAULT_INSTANCE( FT_FACE( loader-&gt;face ) ) )</span>
<span class="udiff-line-added">+               outline-&gt;points = orig_points;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+           }</span>
            do_scale = TRUE;
          }
        }
        else
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1030,14 +1076,30 @@</span>
          }
        }
  
        if ( do_scale )
        {
<span class="udiff-line-modified-removed">-         for ( ; vec &lt; limit; vec++ )</span>
<span class="udiff-line-modified-added">+ #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</span>
<span class="udiff-line-added">+         if ( !IS_DEFAULT_INSTANCE( FT_FACE( loader-&gt;face ) ) )</span>
          {
<span class="udiff-line-modified-removed">-           vec-&gt;x = FT_MulFix( vec-&gt;x, x_scale );</span>
<span class="udiff-line-modified-removed">-           vec-&gt;y = FT_MulFix( vec-&gt;y, y_scale );</span>
<span class="udiff-line-modified-added">+           FT_Vector*  u = unrounded;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           for ( ; vec &lt; limit; vec++, u++ )</span>
<span class="udiff-line-added">+           {</span>
<span class="udiff-line-added">+             vec-&gt;x = ( FT_MulFix( u-&gt;x, x_scale ) + 32 ) &gt;&gt; 6;</span>
<span class="udiff-line-added">+             vec-&gt;y = ( FT_MulFix( u-&gt;y, y_scale ) + 32 ) &gt;&gt; 6;</span>
<span class="udiff-line-added">+           }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         else</span>
<span class="udiff-line-added">+ #endif /* TT_CONFIG_OPTION_GX_VAR_SUPPORT */</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+           for ( ; vec &lt; limit; vec++ )</span>
<span class="udiff-line-added">+           {</span>
<span class="udiff-line-added">+             vec-&gt;x = FT_MulFix( vec-&gt;x, x_scale );</span>
<span class="udiff-line-added">+             vec-&gt;y = FT_MulFix( vec-&gt;y, y_scale );</span>
<span class="udiff-line-added">+           }</span>
          }
        }
  
  #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
        /* if we have a HVAR table, `pp1&#39; and/or `pp2&#39; are already adjusted */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1065,23 +1127,28 @@</span>
        loader-&gt;zone.n_points += 4;
  
        error = TT_Hint_Glyph( loader, 0 );
      }
  
<span class="udiff-line-added">+ #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</span>
<span class="udiff-line-added">+   Exit:</span>
<span class="udiff-line-added">+     FT_FREE( unrounded );</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
      return error;
    }
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Function&gt;                                                            */</span>
<span class="udiff-line-modified-removed">-   /*    TT_Process_Composite_Component                                     */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Description&gt;                                                         */</span>
<span class="udiff-line-modified-removed">-   /*    Once a composite component has been loaded, it needs to be         */</span>
<span class="udiff-line-modified-removed">-   /*    processed.  Usually, this means transforming and translating.      */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Function:</span>
<span class="udiff-line-modified-added">+    *   TT_Process_Composite_Component</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Description:</span>
<span class="udiff-line-modified-added">+    *   Once a composite component has been loaded, it needs to be</span>
<span class="udiff-line-modified-added">+    *   processed.  Usually, this means transforming and translating.</span>
<span class="udiff-line-modified-added">+    */</span>
    static FT_Error
    TT_Process_Composite_Component( TT_Loader    loader,
                                    FT_SubGlyph  subglyph,
                                    FT_UInt      start_point,
                                    FT_UInt      num_base_points )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1151,14 +1218,14 @@</span>
  #endif
        {
  
  #if 0
  
<span class="udiff-line-modified-removed">-         /*******************************************************************/</span>
<span class="udiff-line-modified-removed">-         /*                                                                 */</span>
<span class="udiff-line-modified-removed">-         /* This algorithm is what Apple documents.  But it doesn&#39;t work.   */</span>
<span class="udiff-line-modified-removed">-         /*                                                                 */</span>
<span class="udiff-line-modified-added">+         /********************************************************************</span>
<span class="udiff-line-modified-added">+          *</span>
<span class="udiff-line-modified-added">+          * This algorithm is what Apple documents.  But it doesn&#39;t work.</span>
<span class="udiff-line-modified-added">+          */</span>
          int  a = subglyph-&gt;transform.xx &gt; 0 ?  subglyph-&gt;transform.xx
                                              : -subglyph-&gt;transform.xx;
          int  b = subglyph-&gt;transform.yx &gt; 0 ?  subglyph-&gt;transform.yx
                                              : -subglyph-&gt;transform.yx;
          int  c = subglyph-&gt;transform.xy &gt; 0 ?  subglyph-&gt;transform.xy
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1176,14 +1243,14 @@</span>
          x = FT_MulFix( x, m );
          y = FT_MulFix( y, n );
  
  #else /* 1 */
  
<span class="udiff-line-modified-removed">-         /*******************************************************************/</span>
<span class="udiff-line-modified-removed">-         /*                                                                 */</span>
<span class="udiff-line-modified-removed">-         /* This algorithm is a guess and works much better than the above. */</span>
<span class="udiff-line-modified-removed">-         /*                                                                 */</span>
<span class="udiff-line-modified-added">+         /********************************************************************</span>
<span class="udiff-line-modified-added">+          *</span>
<span class="udiff-line-modified-added">+          * This algorithm is a guess and works much better than the above.</span>
<span class="udiff-line-modified-added">+          */</span>
          FT_Fixed  mac_xscale = FT_Hypot( subglyph-&gt;transform.xx,
                                           subglyph-&gt;transform.xy );
          FT_Fixed  mac_yscale = FT_Hypot( subglyph-&gt;transform.yy,
                                           subglyph-&gt;transform.yx );
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1237,20 +1304,20 @@</span>
  
      return FT_Err_Ok;
    }
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Function&gt;                                                            */</span>
<span class="udiff-line-modified-removed">-   /*    TT_Process_Composite_Glyph                                         */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Description&gt;                                                         */</span>
<span class="udiff-line-modified-removed">-   /*    This is slightly different from TT_Process_Simple_Glyph, in that   */</span>
<span class="udiff-line-modified-removed">-   /*    its sole purpose is to hint the glyph.  Thus this function is      */</span>
<span class="udiff-line-modified-removed">-   /*    only available when bytecode interpreter is enabled.               */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Function:</span>
<span class="udiff-line-modified-added">+    *   TT_Process_Composite_Glyph</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Description:</span>
<span class="udiff-line-modified-added">+    *   This is slightly different from TT_Process_Simple_Glyph, in that</span>
<span class="udiff-line-modified-added">+    *   its sole purpose is to hint the glyph.  Thus this function is</span>
<span class="udiff-line-modified-added">+    *   only available when bytecode interpreter is enabled.</span>
<span class="udiff-line-modified-added">+    */</span>
    static FT_Error
    TT_Process_Composite_Glyph( TT_Loader  loader,
                                FT_UInt    start_point,
                                FT_UInt    start_contour )
    {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1458,11 +1525,11 @@</span>
        grayscale        = loader-&gt;exec ? loader-&gt;exec-&gt;grayscale_cleartype
                                        : 0;
      }
  #endif
  
<span class="udiff-line-modified-removed">-     use_aw_2 = (FT_Bool)( subpixel_hinting &amp;&amp; grayscale );</span>
<span class="udiff-line-modified-added">+     use_aw_2 = FT_BOOL( subpixel_hinting &amp;&amp; grayscale );</span>
  
      loader-&gt;pp1.x = loader-&gt;bbox.xMin - loader-&gt;left_bearing;
      loader-&gt;pp1.y = 0;
      loader-&gt;pp2.x = loader-&gt;pp1.x + loader-&gt;advance;
      loader-&gt;pp2.y = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1495,31 +1562,32 @@</span>
  
      return NULL;
    }
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Function&gt;                                                            */</span>
<span class="udiff-line-modified-removed">-   /*    load_truetype_glyph                                                */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Description&gt;                                                         */</span>
<span class="udiff-line-modified-removed">-   /*    Loads a given truetype glyph.  Handles composites and uses a       */</span>
<span class="udiff-line-modified-removed">-   /*    TT_Loader object.                                                  */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Function:</span>
<span class="udiff-line-modified-added">+    *   load_truetype_glyph</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Description:</span>
<span class="udiff-line-modified-added">+    *   Loads a given truetype glyph.  Handles composites and uses a</span>
<span class="udiff-line-modified-added">+    *   TT_Loader object.</span>
<span class="udiff-line-modified-added">+    */</span>
    static FT_Error
    load_truetype_glyph( TT_Loader  loader,
                         FT_UInt    glyph_index,
                         FT_UInt    recurse_count,
                         FT_Bool    header_only )
    {
<span class="udiff-line-modified-removed">-     FT_Error        error        = FT_Err_Ok;</span>
<span class="udiff-line-modified-added">+     FT_Error        error   = FT_Err_Ok;</span>
      FT_Fixed        x_scale, y_scale;
      FT_ULong        offset;
<span class="udiff-line-modified-removed">-     TT_Face         face         = loader-&gt;face;</span>
<span class="udiff-line-modified-removed">-     FT_GlyphLoader  gloader      = loader-&gt;gloader;</span>
<span class="udiff-line-modified-removed">-     FT_Bool         opened_frame = 0;</span>
<span class="udiff-line-modified-added">+     TT_Face         face    = loader-&gt;face;</span>
<span class="udiff-line-modified-added">+     FT_GlyphLoader  gloader = loader-&gt;gloader;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     FT_Bool  opened_frame = 0;</span>
  
  #ifdef FT_CONFIG_OPTION_INCREMENTAL
      FT_StreamRec    inc_stream;
      FT_Data         glyph_data;
      FT_Bool         glyph_data_loaded = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1548,19 +1616,19 @@</span>
      }
  #endif
  
      loader-&gt;glyph_index = glyph_index;
  
<span class="udiff-line-modified-removed">-     if ( ( loader-&gt;load_flags &amp; FT_LOAD_NO_SCALE ) == 0 )</span>
<span class="udiff-line-modified-added">+     if ( loader-&gt;load_flags &amp; FT_LOAD_NO_SCALE )</span>
      {
<span class="udiff-line-modified-removed">-       x_scale = loader-&gt;size-&gt;metrics-&gt;x_scale;</span>
<span class="udiff-line-modified-removed">-       y_scale = loader-&gt;size-&gt;metrics-&gt;y_scale;</span>
<span class="udiff-line-modified-added">+       x_scale = 0x10000L;</span>
<span class="udiff-line-modified-added">+       y_scale = 0x10000L;</span>
      }
      else
      {
<span class="udiff-line-modified-removed">-       x_scale = 0x10000L;</span>
<span class="udiff-line-modified-removed">-       y_scale = 0x10000L;</span>
<span class="udiff-line-modified-added">+       x_scale = loader-&gt;size-&gt;metrics-&gt;x_scale;</span>
<span class="udiff-line-modified-added">+       y_scale = loader-&gt;size-&gt;metrics-&gt;y_scale;</span>
      }
  
      /* Set `offset&#39; to the start of the glyph relative to the start of */
      /* the `glyf&#39; table, and `byte_len&#39; to the length of the glyph in  */
      /* bytes.                                                          */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1615,42 +1683,40 @@</span>
                                          face-&gt;glyf_offset + offset,
                                          (FT_UInt)loader-&gt;byte_len );
        if ( error )
          goto Exit;
  
<span class="udiff-line-removed">-       opened_frame = 1;</span>
<span class="udiff-line-removed">- </span>
        /* read glyph header first */
        error = face-&gt;read_glyph_header( loader );
<span class="udiff-line-removed">-       if ( error )</span>
<span class="udiff-line-removed">-         goto Exit;</span>
  
<span class="udiff-line-modified-removed">-       /* the metrics must be computed after loading the glyph header */</span>
<span class="udiff-line-removed">-       /* since we need the glyph&#39;s `yMax&#39; value in case the vertical */</span>
<span class="udiff-line-removed">-       /* metrics must be emulated                                    */</span>
<span class="udiff-line-removed">-       error = tt_get_metrics( loader, glyph_index );</span>
<span class="udiff-line-removed">-       if ( error )</span>
<span class="udiff-line-removed">-         goto Exit;</span>
<span class="udiff-line-modified-added">+       face-&gt;forget_glyph_frame( loader );</span>
  
<span class="udiff-line-modified-removed">-       if ( header_only )</span>
<span class="udiff-line-modified-added">+       if ( error )</span>
          goto Exit;
      }
  
<span class="udiff-line-added">+     /* a space glyph */</span>
      if ( loader-&gt;byte_len == 0 || loader-&gt;n_contours == 0 )
      {
        loader-&gt;bbox.xMin = 0;
        loader-&gt;bbox.xMax = 0;
        loader-&gt;bbox.yMin = 0;
        loader-&gt;bbox.yMax = 0;
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-       error = tt_get_metrics( loader, glyph_index );</span>
<span class="udiff-line-modified-removed">-       if ( error )</span>
<span class="udiff-line-modified-removed">-         goto Exit;</span>
<span class="udiff-line-modified-added">+     /* the metrics must be computed after loading the glyph header */</span>
<span class="udiff-line-modified-added">+     /* since we need the glyph&#39;s `yMax&#39; value in case the vertical */</span>
<span class="udiff-line-modified-added">+     /* metrics must be emulated                                    */</span>
<span class="udiff-line-added">+     error = tt_get_metrics( loader, glyph_index );</span>
<span class="udiff-line-added">+     if ( error )</span>
<span class="udiff-line-added">+       goto Exit;</span>
  
<span class="udiff-line-modified-removed">-       if ( header_only )</span>
<span class="udiff-line-modified-removed">-         goto Exit;</span>
<span class="udiff-line-modified-added">+     if ( header_only )</span>
<span class="udiff-line-modified-added">+       goto Exit;</span>
  
<span class="udiff-line-added">+     if ( loader-&gt;byte_len == 0 || loader-&gt;n_contours == 0 )</span>
<span class="udiff-line-added">+     {</span>
        /* must initialize points before (possibly) overriding */
        /* glyph metrics from the incremental interface        */
        tt_loader_set_pp( loader );
  
  #ifdef FT_CONFIG_OPTION_INCREMENTAL
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1667,10 +1733,13 @@</span>
          FT_Vector   points[4];
          char        tags[4]     = { 1, 1, 1, 1 };
          short       contours[4] = { 0, 1, 2, 3 };
          FT_Outline  outline;
  
<span class="udiff-line-added">+         /* unrounded values */</span>
<span class="udiff-line-added">+         FT_Vector  unrounded[4] = { {0, 0}, {0, 0}, {0, 0}, {0, 0} };</span>
<span class="udiff-line-added">+ </span>
  
          points[0].x = loader-&gt;pp1.x;
          points[0].y = loader-&gt;pp1.y;
          points[1].x = loader-&gt;pp2.x;
          points[1].y = loader-&gt;pp2.y;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1688,10 +1757,11 @@</span>
  
          /* this must be done before scaling */
          error = TT_Vary_Apply_Glyph_Deltas( loader-&gt;face,
                                              glyph_index,
                                              &amp;outline,
<span class="udiff-line-added">+                                             unrounded,</span>
                                              (FT_UInt)outline.n_points );
          if ( error )
            goto Exit;
  
          loader-&gt;pp1.x = points[0].x;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1702,17 +1772,18 @@</span>
          loader-&gt;pp3.x = points[2].x;
          loader-&gt;pp3.y = points[2].y;
          loader-&gt;pp4.x = points[3].x;
          loader-&gt;pp4.y = points[3].y;
  
<span class="udiff-line-removed">- </span>
          /* recalculate linear horizontal and vertical advances */
          /* if we don&#39;t have HVAR and VVAR, respectively        */
          if ( !( loader-&gt;face-&gt;variation_support &amp; TT_FACE_FLAG_VAR_HADVANCE ) )
<span class="udiff-line-modified-removed">-           loader-&gt;linear = loader-&gt;pp2.x - loader-&gt;pp1.x;</span>
<span class="udiff-line-modified-added">+           loader-&gt;linear = FT_PIX_ROUND( unrounded[1].x -</span>
<span class="udiff-line-added">+                                          unrounded[0].x ) / 64;</span>
          if ( !( loader-&gt;face-&gt;variation_support &amp; TT_FACE_FLAG_VAR_VADVANCE ) )
<span class="udiff-line-modified-removed">-           loader-&gt;vadvance = loader-&gt;pp4.x - loader-&gt;pp3.x;</span>
<span class="udiff-line-modified-added">+           loader-&gt;vadvance = FT_PIX_ROUND( unrounded[3].x -</span>
<span class="udiff-line-added">+                                            unrounded[2].x ) / 64;</span>
        }
  
  #endif /* TT_CONFIG_OPTION_GX_VAR_SUPPORT */
  
        /* scale phantom points, if necessary; */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1743,10 +1814,20 @@</span>
  
      /***********************************************************************/
      /***********************************************************************/
      /***********************************************************************/
  
<span class="udiff-line-added">+     /* we now open a frame again, right after the glyph header */</span>
<span class="udiff-line-added">+     /* (which consists of 10 bytes)                            */</span>
<span class="udiff-line-added">+     error = face-&gt;access_glyph_frame( loader, glyph_index,</span>
<span class="udiff-line-added">+                                       face-&gt;glyf_offset + offset + 10,</span>
<span class="udiff-line-added">+                                       (FT_UInt)loader-&gt;byte_len - 10 );</span>
<span class="udiff-line-added">+     if ( error )</span>
<span class="udiff-line-added">+       goto Exit;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     opened_frame = 1;</span>
<span class="udiff-line-added">+ </span>
      /* if it is a simple glyph, load it */
  
      if ( loader-&gt;n_contours &gt; 0 )
      {
        error = face-&gt;read_simple_glyph( loader );
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1788,11 +1869,10 @@</span>
         * following the glib solution (cf. macro `GUINT_TO_POINTER&#39;) with a
         * double cast to make this portable.  Note, however, that this needs
         * pointers with a width of at least 32 bits.
         */
  
<span class="udiff-line-removed">- </span>
        /* clear the nodes filled by sibling chains */
        node = ft_list_get_node_at( &amp;loader-&gt;composites, recurse_count );
        for ( node2 = node; node2; node2 = node2-&gt;next )
          node2-&gt;data = (void*)FT_ULONG_MAX;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1839,13 +1919,14 @@</span>
        {
          short        i, limit;
          FT_SubGlyph  subglyph;
  
          FT_Outline  outline;
<span class="udiff-line-modified-removed">-         FT_Vector*  points   = NULL;</span>
<span class="udiff-line-modified-removed">-         char*       tags     = NULL;</span>
<span class="udiff-line-modified-removed">-         short*      contours = NULL;</span>
<span class="udiff-line-modified-added">+         FT_Vector*  points    = NULL;</span>
<span class="udiff-line-modified-added">+         char*       tags      = NULL;</span>
<span class="udiff-line-modified-added">+         short*      contours  = NULL;</span>
<span class="udiff-line-added">+         FT_Vector*  unrounded = NULL;</span>
  
  
          limit = (short)gloader-&gt;current.num_subglyphs;
  
          /* construct an outline structure for              */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1855,13 +1936,14 @@</span>
  
          outline.points   = NULL;
          outline.tags     = NULL;
          outline.contours = NULL;
  
<span class="udiff-line-modified-removed">-         if ( FT_NEW_ARRAY( points, outline.n_points )   ||</span>
<span class="udiff-line-modified-removed">-              FT_NEW_ARRAY( tags, outline.n_points )     ||</span>
<span class="udiff-line-modified-removed">-              FT_NEW_ARRAY( contours, outline.n_points ) )</span>
<span class="udiff-line-modified-added">+         if ( FT_NEW_ARRAY( points, outline.n_points )    ||</span>
<span class="udiff-line-modified-added">+              FT_NEW_ARRAY( tags, outline.n_points )      ||</span>
<span class="udiff-line-modified-added">+              FT_NEW_ARRAY( contours, outline.n_points )  ||</span>
<span class="udiff-line-added">+              FT_NEW_ARRAY( unrounded, outline.n_points ) )</span>
            goto Exit1;
  
          subglyph = gloader-&gt;current.subglyphs;
  
          for ( i = 0; i &lt; limit; i++, subglyph++ )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1906,10 +1988,11 @@</span>
          /* for each component&#39;s translation      */
          if ( FT_SET_ERROR( TT_Vary_Apply_Glyph_Deltas(
                               face,
                               glyph_index,
                               &amp;outline,
<span class="udiff-line-added">+                              unrounded,</span>
                               (FT_UInt)outline.n_points ) ) )
            goto Exit1;
  
          subglyph = gloader-&gt;current.subglyphs;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1933,18 +2016,23 @@</span>
          loader-&gt;pp4.y = points[i + 3].y;
  
          /* recalculate linear horizontal and vertical advances */
          /* if we don&#39;t have HVAR and VVAR, respectively        */
          if ( !( face-&gt;variation_support &amp; TT_FACE_FLAG_VAR_HADVANCE ) )
<span class="udiff-line-modified-removed">-           loader-&gt;linear = loader-&gt;pp2.x - loader-&gt;pp1.x;</span>
<span class="udiff-line-modified-added">+           loader-&gt;linear =</span>
<span class="udiff-line-added">+             FT_PIX_ROUND( unrounded[outline.n_points - 3].x -</span>
<span class="udiff-line-added">+                           unrounded[outline.n_points - 4].x ) / 64;</span>
          if ( !( face-&gt;variation_support &amp; TT_FACE_FLAG_VAR_VADVANCE ) )
<span class="udiff-line-modified-removed">-           loader-&gt;vadvance = loader-&gt;pp4.x - loader-&gt;pp3.x;</span>
<span class="udiff-line-modified-added">+           loader-&gt;vadvance =</span>
<span class="udiff-line-added">+             FT_PIX_ROUND( unrounded[outline.n_points - 1].x -</span>
<span class="udiff-line-added">+                           unrounded[outline.n_points - 2].x ) / 64;</span>
  
        Exit1:
          FT_FREE( outline.points );
          FT_FREE( outline.tags );
          FT_FREE( outline.contours );
<span class="udiff-line-added">+         FT_FREE( unrounded );</span>
  
          if ( error )
            goto Exit;
        }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2000,11 +2088,11 @@</span>
  
            FT_Int  linear_hadvance;
            FT_Int  linear_vadvance;
  
  
<span class="udiff-line-modified-removed">-           /* Each time we call load_truetype_glyph in this loop, the   */</span>
<span class="udiff-line-modified-added">+           /* Each time we call `load_truetype_glyph&#39; in this loop, the */</span>
            /* value of `gloader.base.subglyphs&#39; can change due to table */
            /* reallocations.  We thus need to recompute the subglyph    */
            /* pointer on each iteration.                                */
            subglyph = gloader-&gt;base.subglyphs + num_base_subgs + n;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2043,16 +2131,18 @@</span>
            num_points = (FT_UInt)gloader-&gt;base.outline.n_points;
  
            if ( num_points == num_base_points )
              continue;
  
<span class="udiff-line-modified-removed">-           /* gloader-&gt;base.outline consists of three parts:               */</span>
<span class="udiff-line-modified-removed">-           /* 0 -(1)-&gt; start_point -(2)-&gt; num_base_points -(3)-&gt; n_points. */</span>
<span class="udiff-line-modified-removed">-           /*                                                              */</span>
<span class="udiff-line-modified-removed">-           /* (1): exists from the beginning                               */</span>
<span class="udiff-line-modified-removed">-           /* (2): components that have been loaded so far                 */</span>
<span class="udiff-line-modified-removed">-           /* (3): the newly loaded component                              */</span>
<span class="udiff-line-modified-added">+           /* gloader-&gt;base.outline consists of three parts:           */</span>
<span class="udiff-line-modified-added">+           /*                                                          */</span>
<span class="udiff-line-modified-added">+           /* 0 ----&gt; start_point ----&gt; num_base_points ----&gt; n_points */</span>
<span class="udiff-line-modified-added">+           /*    (1)               (2)                   (3)           */</span>
<span class="udiff-line-modified-added">+           /*                                                          */</span>
<span class="udiff-line-modified-added">+           /* (1) points that exist from the beginning                 */</span>
<span class="udiff-line-added">+           /* (2) component points that have been loaded so far        */</span>
<span class="udiff-line-added">+           /* (3) points of the newly loaded component                 */</span>
            error = TT_Process_Composite_Component( loader,
                                                    subglyph,
                                                    start_point,
                                                    num_base_points );
            if ( error )
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2064,10 +2154,11 @@</span>
  
          /* process the glyph */
          loader-&gt;ins_pos = ins_pos;
          if ( IS_HINTED( loader-&gt;load_flags ) &amp;&amp;
  #ifdef TT_USE_BYTECODE_INTERPRETER
<span class="udiff-line-added">+              subglyph                        &amp;&amp;</span>
               subglyph-&gt;flags &amp; WE_HAVE_INSTR &amp;&amp;
  #endif
               num_points &gt; start_point )
          {
            error = TT_Process_Composite_Glyph( loader,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2130,11 +2221,11 @@</span>
      /* by the base layer.                                                */
      glyph-&gt;linearHoriAdvance = loader-&gt;linear;
  
      glyph-&gt;metrics.horiBearingX = bbox.xMin;
      glyph-&gt;metrics.horiBearingY = bbox.yMax;
<span class="udiff-line-modified-removed">-     glyph-&gt;metrics.horiAdvance  = loader-&gt;pp2.x - loader-&gt;pp1.x;</span>
<span class="udiff-line-modified-added">+     glyph-&gt;metrics.horiAdvance  = SUB_LONG(loader-&gt;pp2.x, loader-&gt;pp1.x);</span>
  
      /* Adjust advance width to the value contained in the hdmx table   */
      /* unless FT_LOAD_COMPUTE_METRICS is set or backward compatibility */
      /* mode of the v40 interpreter is active.  See `ttinterp.h&#39; for    */
      /* details on backward compatibility mode.                         */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2274,17 +2365,17 @@</span>
        }
  
        /* XXX: for now, we have no better algorithm for the lsb, but it */
        /*      should work fine.                                        */
        /*                                                               */
<span class="udiff-line-modified-removed">-       glyph-&gt;metrics.vertBearingX = glyph-&gt;metrics.horiBearingX -</span>
<span class="udiff-line-modified-removed">-                                       glyph-&gt;metrics.horiAdvance / 2;</span>
<span class="udiff-line-modified-added">+       glyph-&gt;metrics.vertBearingX = SUB_LONG( glyph-&gt;metrics.horiBearingX,</span>
<span class="udiff-line-modified-added">+                                               glyph-&gt;metrics.horiAdvance / 2 );</span>
        glyph-&gt;metrics.vertBearingY = top;
        glyph-&gt;metrics.vertAdvance  = advance;
      }
  
<span class="udiff-line-modified-removed">-     return 0;</span>
<span class="udiff-line-modified-added">+     return FT_Err_Ok;</span>
    }
  
  
  #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2587,15 +2678,10 @@</span>
          }
        }
  
        if ( reexecute )
        {
<span class="udiff-line-removed">-         FT_UInt  i;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         for ( i = 0; i &lt; size-&gt;cvt_size; i++ )</span>
<span class="udiff-line-removed">-           size-&gt;cvt[i] = FT_MulFix( face-&gt;cvt[i], size-&gt;ttmetrics.scale );</span>
          error = tt_size_run_prep( size, pedantic );
          if ( error )
            return error;
        }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2654,62 +2740,59 @@</span>
                        loader-&gt;face-&gt;root.memory,
                        NULL );
    }
  
  
<span class="udiff-line-modified-removed">-   /*************************************************************************/</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Function&gt;                                                            */</span>
<span class="udiff-line-modified-removed">-   /*    TT_Load_Glyph                                                      */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Description&gt;                                                         */</span>
<span class="udiff-line-modified-removed">-   /*    A function used to load a single glyph within a given glyph slot,  */</span>
<span class="udiff-line-modified-removed">-   /*    for a given size.                                                  */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Input&gt;                                                               */</span>
<span class="udiff-line-modified-removed">-   /*    glyph       :: A handle to a target slot object where the glyph    */</span>
<span class="udiff-line-modified-removed">-   /*                   will be loaded.                                     */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /*    size        :: A handle to the source face size at which the glyph */</span>
<span class="udiff-line-modified-removed">-   /*                   must be scaled/loaded.                              */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /*    glyph_index :: The index of the glyph in the font file.            */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /*    load_flags  :: A flag indicating what to load for this glyph.  The */</span>
<span class="udiff-line-modified-removed">-   /*                   FT_LOAD_XXX constants can be used to control the    */</span>
<span class="udiff-line-modified-removed">-   /*                   glyph loading process (e.g., whether the outline    */</span>
<span class="udiff-line-modified-removed">-   /*                   should be scaled, whether to load bitmaps or not,   */</span>
<span class="udiff-line-modified-removed">-   /*                   whether to hint the outline, etc).                  */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-removed">-   /* &lt;Return&gt;                                                              */</span>
<span class="udiff-line-modified-removed">-   /*    FreeType error code.  0 means success.                             */</span>
<span class="udiff-line-modified-removed">-   /*                                                                       */</span>
<span class="udiff-line-modified-added">+   /**************************************************************************</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Function:</span>
<span class="udiff-line-modified-added">+    *   TT_Load_Glyph</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Description:</span>
<span class="udiff-line-modified-added">+    *   A function used to load a single glyph within a given glyph slot,</span>
<span class="udiff-line-modified-added">+    *   for a given size.</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    * @Input:</span>
<span class="udiff-line-modified-added">+    *   glyph ::</span>
<span class="udiff-line-modified-added">+    *     A handle to a target slot object where the glyph</span>
<span class="udiff-line-modified-added">+    *     will be loaded.</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    *   size ::</span>
<span class="udiff-line-modified-added">+    *     A handle to the source face size at which the glyph</span>
<span class="udiff-line-modified-added">+    *     must be scaled/loaded.</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    *   glyph_index ::</span>
<span class="udiff-line-modified-added">+    *     The index of the glyph in the font file.</span>
<span class="udiff-line-modified-added">+    *</span>
<span class="udiff-line-modified-added">+    *   load_flags ::</span>
<span class="udiff-line-modified-added">+    *     A flag indicating what to load for this glyph.  The</span>
<span class="udiff-line-modified-added">+    *     FT_LOAD_XXX constants can be used to control the</span>
<span class="udiff-line-modified-added">+    *     glyph loading process (e.g., whether the outline</span>
<span class="udiff-line-modified-added">+    *     should be scaled, whether to load bitmaps or not,</span>
<span class="udiff-line-modified-added">+    *     whether to hint the outline, etc).</span>
<span class="udiff-line-added">+    *</span>
<span class="udiff-line-added">+    * @Return:</span>
<span class="udiff-line-added">+    *   FreeType error code.  0 means success.</span>
<span class="udiff-line-added">+    */</span>
    FT_LOCAL_DEF( FT_Error )
    TT_Load_Glyph( TT_Size       size,
                   TT_GlyphSlot  glyph,
                   FT_UInt       glyph_index,
                   FT_Int32      load_flags )
    {
      FT_Error      error;
      TT_LoaderRec  loader;
  
<span class="udiff-line-removed">- #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT</span>
<span class="udiff-line-removed">- #define IS_DEFAULT_INSTANCE  ( !( FT_IS_NAMED_INSTANCE( glyph-&gt;face ) ||  \</span>
<span class="udiff-line-removed">-                                   FT_IS_VARIATION( glyph-&gt;face )      ) )</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">- #define IS_DEFAULT_INSTANCE  1</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
  
      FT_TRACE1(( &quot;TT_Load_Glyph: glyph index %d\n&quot;, glyph_index ));
  
  #ifdef TT_CONFIG_OPTION_EMBEDDED_BITMAPS
  
      /* try to load embedded bitmap (if any) */
      if ( size-&gt;strike_index != 0xFFFFFFFFUL      &amp;&amp;
           ( load_flags &amp; FT_LOAD_NO_BITMAP ) == 0 &amp;&amp;
<span class="udiff-line-modified-removed">-          IS_DEFAULT_INSTANCE                     )</span>
<span class="udiff-line-modified-added">+          IS_DEFAULT_INSTANCE( glyph-&gt;face )      )</span>
      {
        FT_Fixed  x_scale = size-&gt;root.metrics.x_scale;
        FT_Fixed  y_scale = size-&gt;root.metrics.y_scale;
  
  
</pre>
<center><a href="tterrors.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ttgload.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>