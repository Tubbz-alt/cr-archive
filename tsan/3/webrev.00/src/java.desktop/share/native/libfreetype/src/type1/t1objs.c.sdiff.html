<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/type1/t1objs.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="t1load.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="t1objs.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/type1/t1objs.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">  1 /***************************************************************************/</span>
<span class="line-modified">  2 /*                                                                         */</span>
<span class="line-modified">  3 /*  t1objs.c                                                               */</span>
<span class="line-modified">  4 /*                                                                         */</span>
<span class="line-modified">  5 /*    Type 1 objects manager (body).                                       */</span>
<span class="line-modified">  6 /*                                                                         */</span>
<span class="line-modified">  7 /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">  8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">  9 /*                                                                         */</span>
<span class="line-modified"> 10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified"> 11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified"> 12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified"> 13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified"> 14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified"> 15 /*                                                                         */</span>
<span class="line-modified"> 16 /***************************************************************************/</span>
 17 
 18 
 19 #include &lt;ft2build.h&gt;
 20 #include FT_INTERNAL_CALC_H
 21 #include FT_INTERNAL_DEBUG_H
 22 #include FT_INTERNAL_STREAM_H
 23 #include FT_TRUETYPE_IDS_H
 24 #include FT_DRIVER_H
 25 
 26 #include &quot;t1gload.h&quot;
 27 #include &quot;t1load.h&quot;
 28 
 29 #include &quot;t1errors.h&quot;
 30 
 31 #ifndef T1_CONFIG_OPTION_NO_AFM
 32 #include &quot;t1afm.h&quot;
 33 #endif
 34 
 35 #include FT_SERVICE_POSTSCRIPT_CMAPS_H
 36 #include FT_INTERNAL_POSTSCRIPT_AUX_H
 37 
 38 
<span class="line-modified"> 39   /*************************************************************************/</span>
<span class="line-modified"> 40   /*                                                                       */</span>
<span class="line-modified"> 41   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified"> 42   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified"> 43   /* messages during execution.                                            */</span>
<span class="line-modified"> 44   /*                                                                       */</span>
 45 #undef  FT_COMPONENT
<span class="line-modified"> 46 #define FT_COMPONENT  trace_t1objs</span>
 47 
 48 
<span class="line-modified"> 49   /*************************************************************************/</span>
<span class="line-modified"> 50   /*                                                                       */</span>
<span class="line-modified"> 51   /*                            SIZE FUNCTIONS                             */</span>
<span class="line-modified"> 52   /*                                                                       */</span>
<span class="line-modified"> 53   /*************************************************************************/</span>
 54 
 55 
 56   static PSH_Globals_Funcs
 57   T1_Size_Get_Globals_Funcs( T1_Size  size )
 58   {
 59     T1_Face           face     = (T1_Face)size-&gt;root.face;
 60     PSHinter_Service  pshinter = (PSHinter_Service)face-&gt;pshinter;
 61     FT_Module         module;
 62 
 63 
 64     module = FT_Get_Module( size-&gt;root.face-&gt;driver-&gt;root.library,
 65                             &quot;pshinter&quot; );
 66     return ( module &amp;&amp; pshinter &amp;&amp; pshinter-&gt;get_globals_funcs )
 67            ? pshinter-&gt;get_globals_funcs( module )
 68            : 0;
 69   }
 70 
 71 
 72   FT_LOCAL_DEF( void )
 73   T1_Size_Done( FT_Size  t1size )          /* T1_Size */
</pre>
<hr />
<pre>
116   FT_LOCAL_DEF( FT_Error )
117   T1_Size_Request( FT_Size          t1size,     /* T1_Size */
118                    FT_Size_Request  req )
119   {
120     T1_Size            size  = (T1_Size)t1size;
121     PSH_Globals_Funcs  funcs = T1_Size_Get_Globals_Funcs( size );
122 
123 
124     FT_Request_Metrics( size-&gt;root.face, req );
125 
126     if ( funcs )
127       funcs-&gt;set_scale( (PSH_Globals)t1size-&gt;internal-&gt;module_data,
128                         size-&gt;root.metrics.x_scale,
129                         size-&gt;root.metrics.y_scale,
130                         0, 0 );
131 
132     return FT_Err_Ok;
133   }
134 
135 
<span class="line-modified">136   /*************************************************************************/</span>
<span class="line-modified">137   /*                                                                       */</span>
<span class="line-modified">138   /*                            SLOT  FUNCTIONS                            */</span>
<span class="line-modified">139   /*                                                                       */</span>
<span class="line-modified">140   /*************************************************************************/</span>
141 
142   FT_LOCAL_DEF( void )
143   T1_GlyphSlot_Done( FT_GlyphSlot  slot )
144   {
145     slot-&gt;internal-&gt;glyph_hints = NULL;
146   }
147 
148 
149   FT_LOCAL_DEF( FT_Error )
150   T1_GlyphSlot_Init( FT_GlyphSlot  slot )
151   {
152     T1_Face           face;
153     PSHinter_Service  pshinter;
154 
155 
156     face     = (T1_Face)slot-&gt;face;
157     pshinter = (PSHinter_Service)face-&gt;pshinter;
158 
159     if ( pshinter )
160     {
161       FT_Module  module;
162 
163 
164       module = FT_Get_Module( slot-&gt;face-&gt;driver-&gt;root.library,
165                               &quot;pshinter&quot; );
166       if ( module )
167       {
168         T1_Hints_Funcs  funcs;
169 
170 
171         funcs = pshinter-&gt;get_t1_funcs( module );
172         slot-&gt;internal-&gt;glyph_hints = (void*)funcs;
173       }
174     }
175 
176     return 0;
177   }
178 
179 
<span class="line-modified">180   /*************************************************************************/</span>
<span class="line-modified">181   /*                                                                       */</span>
<span class="line-modified">182   /*                            FACE  FUNCTIONS                            */</span>
<span class="line-modified">183   /*                                                                       */</span>
<span class="line-modified">184   /*************************************************************************/</span>
<span class="line-modified">185 </span>
<span class="line-modified">186 </span>
<span class="line-modified">187   /*************************************************************************/</span>
<span class="line-modified">188   /*                                                                       */</span>
<span class="line-modified">189   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">190   /*    T1_Face_Done                                                       */</span>
<span class="line-modified">191   /*                                                                       */</span>
<span class="line-modified">192   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">193   /*    The face object destructor.                                        */</span>
<span class="line-modified">194   /*                                                                       */</span>
<span class="line-modified">195   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">196   /*    face :: A typeless pointer to the face object to destroy.          */</span>
<span class="line-modified">197   /*                                                                       */</span>

198   FT_LOCAL_DEF( void )
199   T1_Face_Done( FT_Face  t1face )         /* T1_Face */
200   {
201     T1_Face    face = (T1_Face)t1face;
202     FT_Memory  memory;
203     T1_Font    type1;
204 
205 
206     if ( !face )
207       return;
208 
209     memory = face-&gt;root.memory;
210     type1  = &amp;face-&gt;type1;
211 
212 #ifndef T1_CONFIG_OPTION_NO_MM_SUPPORT
213     /* release multiple masters information */
214     FT_ASSERT( ( face-&gt;len_buildchar == 0 ) == ( face-&gt;buildchar == NULL ) );
215 
216     if ( face-&gt;buildchar )
217     {
</pre>
<hr />
<pre>
257     FT_FREE( type1-&gt;font_name );
258 
259 #ifndef T1_CONFIG_OPTION_NO_AFM
260     /* release afm data if present */
261     if ( face-&gt;afm_data )
262       T1_Done_Metrics( memory, (AFM_FontInfo)face-&gt;afm_data );
263 #endif
264 
265     /* release unicode map, if any */
266 #if 0
267     FT_FREE( face-&gt;unicode_map_rec.maps );
268     face-&gt;unicode_map_rec.num_maps = 0;
269     face-&gt;unicode_map              = NULL;
270 #endif
271 
272     face-&gt;root.family_name = NULL;
273     face-&gt;root.style_name  = NULL;
274   }
275 
276 
<span class="line-modified">277   /*************************************************************************/</span>
<span class="line-modified">278   /*                                                                       */</span>
<span class="line-modified">279   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">280   /*    T1_Face_Init                                                       */</span>
<span class="line-modified">281   /*                                                                       */</span>
<span class="line-modified">282   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">283   /*    The face object constructor.                                       */</span>
<span class="line-modified">284   /*                                                                       */</span>
<span class="line-modified">285   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">286   /*    stream     ::  input stream where to load font data.               */</span>
<span class="line-modified">287   /*                                                                       */</span>
<span class="line-modified">288   /*    face_index :: The index of the font face in the resource.          */</span>
<span class="line-modified">289   /*                                                                       */</span>
<span class="line-modified">290   /*    num_params :: Number of additional generic parameters.  Ignored.   */</span>
<span class="line-modified">291   /*                                                                       */</span>
<span class="line-modified">292   /*    params     :: Additional generic parameters.  Ignored.             */</span>
<span class="line-modified">293   /*                                                                       */</span>
<span class="line-modified">294   /* &lt;InOut&gt;                                                               */</span>
<span class="line-modified">295   /*    face       :: The face record to build.                            */</span>
<span class="line-modified">296   /*                                                                       */</span>
<span class="line-modified">297   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">298   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">299   /*                                                                       */</span>





300   FT_LOCAL_DEF( FT_Error )
301   T1_Face_Init( FT_Stream      stream,
302                 FT_Face        t1face,          /* T1_Face */
303                 FT_Int         face_index,
304                 FT_Int         num_params,
305                 FT_Parameter*  params )
306   {
307     T1_Face             face = (T1_Face)t1face;
308     FT_Error            error;
309     FT_Service_PsCMaps  psnames;
310     PSAux_Service       psaux;
311     T1_Font             type1 = &amp;face-&gt;type1;
312     PS_FontInfo         info = &amp;type1-&gt;font_info;
313 
314     FT_UNUSED( num_params );
315     FT_UNUSED( params );
316     FT_UNUSED( stream );
317 
318 
319     face-&gt;root.num_faces = 1;
</pre>
<hr />
<pre>
324     face-&gt;psaux = FT_Get_Module_Interface( FT_FACE_LIBRARY( face ),
325                                            &quot;psaux&quot; );
326     psaux = (PSAux_Service)face-&gt;psaux;
327     if ( !psaux )
328     {
329       FT_ERROR(( &quot;T1_Face_Init: cannot access `psaux&#39; module\n&quot; ));
330       error = FT_THROW( Missing_Module );
331       goto Exit;
332     }
333 
334     face-&gt;pshinter = FT_Get_Module_Interface( FT_FACE_LIBRARY( face ),
335                                               &quot;pshinter&quot; );
336 
337     FT_TRACE2(( &quot;Type 1 driver\n&quot; ));
338 
339     /* open the tokenizer; this will also check the font format */
340     error = T1_Open_Face( face );
341     if ( error )
342       goto Exit;
343 




344     /* if we just wanted to check the format, leave successfully now */
345     if ( face_index &lt; 0 )
346       goto Exit;
347 
348     /* check the face index */
349     if ( ( face_index &amp; 0xFFFF ) &gt; 0 )
350     {
351       FT_ERROR(( &quot;T1_Face_Init: invalid face index\n&quot; ));
352       error = FT_THROW( Invalid_Argument );
353       goto Exit;
354     }
355 
356     /* now load the font program into the face object */
357 
358     /* initialize the face object fields */
359 
360     /* set up root face fields */
361     {
362       FT_Face  root = (FT_Face)&amp;face-&gt;root;
363 
</pre>
<hr />
<pre>
499     {
500       FT_Face  root = &amp;face-&gt;root;
501 
502 
503       if ( psnames )
504       {
505         FT_CharMapRec    charmap;
506         T1_CMap_Classes  cmap_classes = psaux-&gt;t1_cmap_classes;
507         FT_CMap_Class    clazz;
508 
509 
510         charmap.face = root;
511 
512         /* first of all, try to synthesize a Unicode charmap */
513         charmap.platform_id = TT_PLATFORM_MICROSOFT;
514         charmap.encoding_id = TT_MS_ID_UNICODE_CS;
515         charmap.encoding    = FT_ENCODING_UNICODE;
516 
517         error = FT_CMap_New( cmap_classes-&gt;unicode, NULL, &amp;charmap, NULL );
518         if ( error                                      &amp;&amp;
<span class="line-modified">519              FT_ERR_NEQ( error, No_Unicode_Glyph_Name ) )</span>

520           goto Exit;
521         error = FT_Err_Ok;
522 
523         /* now, generate an Adobe Standard encoding when appropriate */
524         charmap.platform_id = TT_PLATFORM_ADOBE;
525         clazz               = NULL;
526 
527         switch ( type1-&gt;encoding_type )
528         {
529         case T1_ENCODING_TYPE_STANDARD:
530           charmap.encoding    = FT_ENCODING_ADOBE_STANDARD;
531           charmap.encoding_id = TT_ADOBE_ID_STANDARD;
532           clazz               = cmap_classes-&gt;standard;
533           break;
534 
535         case T1_ENCODING_TYPE_EXPERT:
536           charmap.encoding    = FT_ENCODING_ADOBE_EXPERT;
537           charmap.encoding_id = TT_ADOBE_ID_EXPERT;
538           clazz               = cmap_classes-&gt;expert;
539           break;
</pre>
<hr />
<pre>
547         case T1_ENCODING_TYPE_ISOLATIN1:
548           charmap.encoding    = FT_ENCODING_ADOBE_LATIN_1;
549           charmap.encoding_id = TT_ADOBE_ID_LATIN_1;
550           clazz               = cmap_classes-&gt;unicode;
551           break;
552 
553         default:
554           ;
555         }
556 
557         if ( clazz )
558           error = FT_CMap_New( clazz, NULL, &amp;charmap, NULL );
559       }
560     }
561 
562   Exit:
563     return error;
564   }
565 
566 
<span class="line-modified">567   /*************************************************************************/</span>
<span class="line-modified">568   /*                                                                       */</span>
<span class="line-modified">569   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">570   /*    T1_Driver_Init                                                     */</span>
<span class="line-modified">571   /*                                                                       */</span>
<span class="line-modified">572   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">573   /*    Initializes a given Type 1 driver object.                          */</span>
<span class="line-modified">574   /*                                                                       */</span>
<span class="line-modified">575   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">576   /*    driver :: A handle to the target driver object.                    */</span>
<span class="line-modified">577   /*                                                                       */</span>
<span class="line-modified">578   /* &lt;Return&gt;                                                              */</span>
<span class="line-modified">579   /*    FreeType error code.  0 means success.                             */</span>
<span class="line-modified">580   /*                                                                       */</span>

581   FT_LOCAL_DEF( FT_Error )
582   T1_Driver_Init( FT_Module  module )
583   {
584     PS_Driver  driver = (PS_Driver)module;
585 
586     FT_UInt32  seed;
587 
588 
589     /* set default property values, cf. `ftt1drv.h&#39; */
590 #ifdef T1_CONFIG_OPTION_OLD_ENGINE
591     driver-&gt;hinting_engine = FT_HINTING_FREETYPE;
592 #else
593     driver-&gt;hinting_engine = FT_HINTING_ADOBE;
594 #endif
595 
596     driver-&gt;no_stem_darkening = TRUE;
597 
598     driver-&gt;darken_params[0] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_X1;
599     driver-&gt;darken_params[1] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_Y1;
600     driver-&gt;darken_params[2] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_X2;
</pre>
<hr />
<pre>
603     driver-&gt;darken_params[5] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_Y3;
604     driver-&gt;darken_params[6] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_X4;
605     driver-&gt;darken_params[7] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_Y4;
606 
607     /* compute random seed from some memory addresses */
608     seed = (FT_UInt32)( (FT_Offset)(char*)&amp;seed          ^
609                         (FT_Offset)(char*)&amp;module        ^
610                         (FT_Offset)(char*)module-&gt;memory );
611     seed = seed ^ ( seed &gt;&gt; 10 ) ^ ( seed &gt;&gt; 20 );
612 
613     driver-&gt;random_seed = (FT_Int32)seed;
614     if ( driver-&gt;random_seed &lt; 0 )
615       driver-&gt;random_seed = -driver-&gt;random_seed;
616     else if ( driver-&gt;random_seed == 0 )
617       driver-&gt;random_seed = 123456789;
618 
619     return FT_Err_Ok;
620   }
621 
622 
<span class="line-modified">623   /*************************************************************************/</span>
<span class="line-modified">624   /*                                                                       */</span>
<span class="line-modified">625   /* &lt;Function&gt;                                                            */</span>
<span class="line-modified">626   /*    T1_Driver_Done                                                     */</span>
<span class="line-modified">627   /*                                                                       */</span>
<span class="line-modified">628   /* &lt;Description&gt;                                                         */</span>
<span class="line-modified">629   /*    Finalizes a given Type 1 driver.                                   */</span>
<span class="line-modified">630   /*                                                                       */</span>
<span class="line-modified">631   /* &lt;Input&gt;                                                               */</span>
<span class="line-modified">632   /*    driver :: A handle to the target Type 1 driver.                    */</span>
<span class="line-modified">633   /*                                                                       */</span>

634   FT_LOCAL_DEF( void )
635   T1_Driver_Done( FT_Module  driver )
636   {
637     FT_UNUSED( driver );
638   }
639 
640 
641 /* END */
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">  1 /****************************************************************************</span>
<span class="line-modified">  2  *</span>
<span class="line-modified">  3  * t1objs.c</span>
<span class="line-modified">  4  *</span>
<span class="line-modified">  5  *   Type 1 objects manager (body).</span>
<span class="line-modified">  6  *</span>
<span class="line-modified">  7  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">  8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">  9  *</span>
<span class="line-modified"> 10  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified"> 11  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified"> 12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified"> 13  * this file you indicate that you have read the license and</span>
<span class="line-modified"> 14  * understand and accept it fully.</span>
<span class="line-modified"> 15  *</span>
<span class="line-modified"> 16  */</span>
 17 
 18 
 19 #include &lt;ft2build.h&gt;
 20 #include FT_INTERNAL_CALC_H
 21 #include FT_INTERNAL_DEBUG_H
 22 #include FT_INTERNAL_STREAM_H
 23 #include FT_TRUETYPE_IDS_H
 24 #include FT_DRIVER_H
 25 
 26 #include &quot;t1gload.h&quot;
 27 #include &quot;t1load.h&quot;
 28 
 29 #include &quot;t1errors.h&quot;
 30 
 31 #ifndef T1_CONFIG_OPTION_NO_AFM
 32 #include &quot;t1afm.h&quot;
 33 #endif
 34 
 35 #include FT_SERVICE_POSTSCRIPT_CMAPS_H
 36 #include FT_INTERNAL_POSTSCRIPT_AUX_H
 37 
 38 
<span class="line-modified"> 39   /**************************************************************************</span>
<span class="line-modified"> 40    *</span>
<span class="line-modified"> 41    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified"> 42    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified"> 43    * messages during execution.</span>
<span class="line-modified"> 44    */</span>
 45 #undef  FT_COMPONENT
<span class="line-modified"> 46 #define FT_COMPONENT  t1objs</span>
 47 
 48 
<span class="line-modified"> 49   /**************************************************************************</span>
<span class="line-modified"> 50    *</span>
<span class="line-modified"> 51    *                           SIZE FUNCTIONS</span>
<span class="line-modified"> 52    *</span>
<span class="line-modified"> 53    */</span>
 54 
 55 
 56   static PSH_Globals_Funcs
 57   T1_Size_Get_Globals_Funcs( T1_Size  size )
 58   {
 59     T1_Face           face     = (T1_Face)size-&gt;root.face;
 60     PSHinter_Service  pshinter = (PSHinter_Service)face-&gt;pshinter;
 61     FT_Module         module;
 62 
 63 
 64     module = FT_Get_Module( size-&gt;root.face-&gt;driver-&gt;root.library,
 65                             &quot;pshinter&quot; );
 66     return ( module &amp;&amp; pshinter &amp;&amp; pshinter-&gt;get_globals_funcs )
 67            ? pshinter-&gt;get_globals_funcs( module )
 68            : 0;
 69   }
 70 
 71 
 72   FT_LOCAL_DEF( void )
 73   T1_Size_Done( FT_Size  t1size )          /* T1_Size */
</pre>
<hr />
<pre>
116   FT_LOCAL_DEF( FT_Error )
117   T1_Size_Request( FT_Size          t1size,     /* T1_Size */
118                    FT_Size_Request  req )
119   {
120     T1_Size            size  = (T1_Size)t1size;
121     PSH_Globals_Funcs  funcs = T1_Size_Get_Globals_Funcs( size );
122 
123 
124     FT_Request_Metrics( size-&gt;root.face, req );
125 
126     if ( funcs )
127       funcs-&gt;set_scale( (PSH_Globals)t1size-&gt;internal-&gt;module_data,
128                         size-&gt;root.metrics.x_scale,
129                         size-&gt;root.metrics.y_scale,
130                         0, 0 );
131 
132     return FT_Err_Ok;
133   }
134 
135 
<span class="line-modified">136   /**************************************************************************</span>
<span class="line-modified">137    *</span>
<span class="line-modified">138    *                           SLOT  FUNCTIONS</span>
<span class="line-modified">139    *</span>
<span class="line-modified">140    */</span>
141 
142   FT_LOCAL_DEF( void )
143   T1_GlyphSlot_Done( FT_GlyphSlot  slot )
144   {
145     slot-&gt;internal-&gt;glyph_hints = NULL;
146   }
147 
148 
149   FT_LOCAL_DEF( FT_Error )
150   T1_GlyphSlot_Init( FT_GlyphSlot  slot )
151   {
152     T1_Face           face;
153     PSHinter_Service  pshinter;
154 
155 
156     face     = (T1_Face)slot-&gt;face;
157     pshinter = (PSHinter_Service)face-&gt;pshinter;
158 
159     if ( pshinter )
160     {
161       FT_Module  module;
162 
163 
164       module = FT_Get_Module( slot-&gt;face-&gt;driver-&gt;root.library,
165                               &quot;pshinter&quot; );
166       if ( module )
167       {
168         T1_Hints_Funcs  funcs;
169 
170 
171         funcs = pshinter-&gt;get_t1_funcs( module );
172         slot-&gt;internal-&gt;glyph_hints = (void*)funcs;
173       }
174     }
175 
176     return 0;
177   }
178 
179 
<span class="line-modified">180   /**************************************************************************</span>
<span class="line-modified">181    *</span>
<span class="line-modified">182    *                           FACE  FUNCTIONS</span>
<span class="line-modified">183    *</span>
<span class="line-modified">184    */</span>
<span class="line-modified">185 </span>
<span class="line-modified">186 </span>
<span class="line-modified">187   /**************************************************************************</span>
<span class="line-modified">188    *</span>
<span class="line-modified">189    * @Function:</span>
<span class="line-modified">190    *   T1_Face_Done</span>
<span class="line-modified">191    *</span>
<span class="line-modified">192    * @Description:</span>
<span class="line-modified">193    *   The face object destructor.</span>
<span class="line-modified">194    *</span>
<span class="line-modified">195    * @Input:</span>
<span class="line-modified">196    *   face ::</span>
<span class="line-modified">197    *     A typeless pointer to the face object to destroy.</span>
<span class="line-added">198    */</span>
199   FT_LOCAL_DEF( void )
200   T1_Face_Done( FT_Face  t1face )         /* T1_Face */
201   {
202     T1_Face    face = (T1_Face)t1face;
203     FT_Memory  memory;
204     T1_Font    type1;
205 
206 
207     if ( !face )
208       return;
209 
210     memory = face-&gt;root.memory;
211     type1  = &amp;face-&gt;type1;
212 
213 #ifndef T1_CONFIG_OPTION_NO_MM_SUPPORT
214     /* release multiple masters information */
215     FT_ASSERT( ( face-&gt;len_buildchar == 0 ) == ( face-&gt;buildchar == NULL ) );
216 
217     if ( face-&gt;buildchar )
218     {
</pre>
<hr />
<pre>
258     FT_FREE( type1-&gt;font_name );
259 
260 #ifndef T1_CONFIG_OPTION_NO_AFM
261     /* release afm data if present */
262     if ( face-&gt;afm_data )
263       T1_Done_Metrics( memory, (AFM_FontInfo)face-&gt;afm_data );
264 #endif
265 
266     /* release unicode map, if any */
267 #if 0
268     FT_FREE( face-&gt;unicode_map_rec.maps );
269     face-&gt;unicode_map_rec.num_maps = 0;
270     face-&gt;unicode_map              = NULL;
271 #endif
272 
273     face-&gt;root.family_name = NULL;
274     face-&gt;root.style_name  = NULL;
275   }
276 
277 
<span class="line-modified">278   /**************************************************************************</span>
<span class="line-modified">279    *</span>
<span class="line-modified">280    * @Function:</span>
<span class="line-modified">281    *   T1_Face_Init</span>
<span class="line-modified">282    *</span>
<span class="line-modified">283    * @Description:</span>
<span class="line-modified">284    *   The face object constructor.</span>
<span class="line-modified">285    *</span>
<span class="line-modified">286    * @Input:</span>
<span class="line-modified">287    *   stream ::</span>
<span class="line-modified">288    *     input stream where to load font data.</span>
<span class="line-modified">289    *</span>
<span class="line-modified">290    *   face_index ::</span>
<span class="line-modified">291    *     The index of the font face in the resource.</span>
<span class="line-modified">292    *</span>
<span class="line-modified">293    *   num_params ::</span>
<span class="line-modified">294    *     Number of additional generic parameters.  Ignored.</span>
<span class="line-modified">295    *</span>
<span class="line-modified">296    *   params ::</span>
<span class="line-modified">297    *     Additional generic parameters.  Ignored.</span>
<span class="line-modified">298    *</span>
<span class="line-modified">299    * @InOut:</span>
<span class="line-modified">300    *   face ::</span>
<span class="line-added">301    *     The face record to build.</span>
<span class="line-added">302    *</span>
<span class="line-added">303    * @Return:</span>
<span class="line-added">304    *   FreeType error code.  0 means success.</span>
<span class="line-added">305    */</span>
306   FT_LOCAL_DEF( FT_Error )
307   T1_Face_Init( FT_Stream      stream,
308                 FT_Face        t1face,          /* T1_Face */
309                 FT_Int         face_index,
310                 FT_Int         num_params,
311                 FT_Parameter*  params )
312   {
313     T1_Face             face = (T1_Face)t1face;
314     FT_Error            error;
315     FT_Service_PsCMaps  psnames;
316     PSAux_Service       psaux;
317     T1_Font             type1 = &amp;face-&gt;type1;
318     PS_FontInfo         info = &amp;type1-&gt;font_info;
319 
320     FT_UNUSED( num_params );
321     FT_UNUSED( params );
322     FT_UNUSED( stream );
323 
324 
325     face-&gt;root.num_faces = 1;
</pre>
<hr />
<pre>
330     face-&gt;psaux = FT_Get_Module_Interface( FT_FACE_LIBRARY( face ),
331                                            &quot;psaux&quot; );
332     psaux = (PSAux_Service)face-&gt;psaux;
333     if ( !psaux )
334     {
335       FT_ERROR(( &quot;T1_Face_Init: cannot access `psaux&#39; module\n&quot; ));
336       error = FT_THROW( Missing_Module );
337       goto Exit;
338     }
339 
340     face-&gt;pshinter = FT_Get_Module_Interface( FT_FACE_LIBRARY( face ),
341                                               &quot;pshinter&quot; );
342 
343     FT_TRACE2(( &quot;Type 1 driver\n&quot; ));
344 
345     /* open the tokenizer; this will also check the font format */
346     error = T1_Open_Face( face );
347     if ( error )
348       goto Exit;
349 
<span class="line-added">350     FT_TRACE2(( &quot;T1_Face_Init: %08p (index %d)\n&quot;,</span>
<span class="line-added">351                 face,</span>
<span class="line-added">352                 face_index ));</span>
<span class="line-added">353 </span>
354     /* if we just wanted to check the format, leave successfully now */
355     if ( face_index &lt; 0 )
356       goto Exit;
357 
358     /* check the face index */
359     if ( ( face_index &amp; 0xFFFF ) &gt; 0 )
360     {
361       FT_ERROR(( &quot;T1_Face_Init: invalid face index\n&quot; ));
362       error = FT_THROW( Invalid_Argument );
363       goto Exit;
364     }
365 
366     /* now load the font program into the face object */
367 
368     /* initialize the face object fields */
369 
370     /* set up root face fields */
371     {
372       FT_Face  root = (FT_Face)&amp;face-&gt;root;
373 
</pre>
<hr />
<pre>
509     {
510       FT_Face  root = &amp;face-&gt;root;
511 
512 
513       if ( psnames )
514       {
515         FT_CharMapRec    charmap;
516         T1_CMap_Classes  cmap_classes = psaux-&gt;t1_cmap_classes;
517         FT_CMap_Class    clazz;
518 
519 
520         charmap.face = root;
521 
522         /* first of all, try to synthesize a Unicode charmap */
523         charmap.platform_id = TT_PLATFORM_MICROSOFT;
524         charmap.encoding_id = TT_MS_ID_UNICODE_CS;
525         charmap.encoding    = FT_ENCODING_UNICODE;
526 
527         error = FT_CMap_New( cmap_classes-&gt;unicode, NULL, &amp;charmap, NULL );
528         if ( error                                      &amp;&amp;
<span class="line-modified">529              FT_ERR_NEQ( error, No_Unicode_Glyph_Name ) &amp;&amp;</span>
<span class="line-added">530              FT_ERR_NEQ( error, Unimplemented_Feature ) )</span>
531           goto Exit;
532         error = FT_Err_Ok;
533 
534         /* now, generate an Adobe Standard encoding when appropriate */
535         charmap.platform_id = TT_PLATFORM_ADOBE;
536         clazz               = NULL;
537 
538         switch ( type1-&gt;encoding_type )
539         {
540         case T1_ENCODING_TYPE_STANDARD:
541           charmap.encoding    = FT_ENCODING_ADOBE_STANDARD;
542           charmap.encoding_id = TT_ADOBE_ID_STANDARD;
543           clazz               = cmap_classes-&gt;standard;
544           break;
545 
546         case T1_ENCODING_TYPE_EXPERT:
547           charmap.encoding    = FT_ENCODING_ADOBE_EXPERT;
548           charmap.encoding_id = TT_ADOBE_ID_EXPERT;
549           clazz               = cmap_classes-&gt;expert;
550           break;
</pre>
<hr />
<pre>
558         case T1_ENCODING_TYPE_ISOLATIN1:
559           charmap.encoding    = FT_ENCODING_ADOBE_LATIN_1;
560           charmap.encoding_id = TT_ADOBE_ID_LATIN_1;
561           clazz               = cmap_classes-&gt;unicode;
562           break;
563 
564         default:
565           ;
566         }
567 
568         if ( clazz )
569           error = FT_CMap_New( clazz, NULL, &amp;charmap, NULL );
570       }
571     }
572 
573   Exit:
574     return error;
575   }
576 
577 
<span class="line-modified">578   /**************************************************************************</span>
<span class="line-modified">579    *</span>
<span class="line-modified">580    * @Function:</span>
<span class="line-modified">581    *   T1_Driver_Init</span>
<span class="line-modified">582    *</span>
<span class="line-modified">583    * @Description:</span>
<span class="line-modified">584    *   Initializes a given Type 1 driver object.</span>
<span class="line-modified">585    *</span>
<span class="line-modified">586    * @Input:</span>
<span class="line-modified">587    *   driver ::</span>
<span class="line-modified">588    *     A handle to the target driver object.</span>
<span class="line-modified">589    *</span>
<span class="line-modified">590    * @Return:</span>
<span class="line-modified">591    *   FreeType error code.  0 means success.</span>
<span class="line-added">592    */</span>
593   FT_LOCAL_DEF( FT_Error )
594   T1_Driver_Init( FT_Module  module )
595   {
596     PS_Driver  driver = (PS_Driver)module;
597 
598     FT_UInt32  seed;
599 
600 
601     /* set default property values, cf. `ftt1drv.h&#39; */
602 #ifdef T1_CONFIG_OPTION_OLD_ENGINE
603     driver-&gt;hinting_engine = FT_HINTING_FREETYPE;
604 #else
605     driver-&gt;hinting_engine = FT_HINTING_ADOBE;
606 #endif
607 
608     driver-&gt;no_stem_darkening = TRUE;
609 
610     driver-&gt;darken_params[0] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_X1;
611     driver-&gt;darken_params[1] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_Y1;
612     driver-&gt;darken_params[2] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_X2;
</pre>
<hr />
<pre>
615     driver-&gt;darken_params[5] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_Y3;
616     driver-&gt;darken_params[6] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_X4;
617     driver-&gt;darken_params[7] = CFF_CONFIG_OPTION_DARKENING_PARAMETER_Y4;
618 
619     /* compute random seed from some memory addresses */
620     seed = (FT_UInt32)( (FT_Offset)(char*)&amp;seed          ^
621                         (FT_Offset)(char*)&amp;module        ^
622                         (FT_Offset)(char*)module-&gt;memory );
623     seed = seed ^ ( seed &gt;&gt; 10 ) ^ ( seed &gt;&gt; 20 );
624 
625     driver-&gt;random_seed = (FT_Int32)seed;
626     if ( driver-&gt;random_seed &lt; 0 )
627       driver-&gt;random_seed = -driver-&gt;random_seed;
628     else if ( driver-&gt;random_seed == 0 )
629       driver-&gt;random_seed = 123456789;
630 
631     return FT_Err_Ok;
632   }
633 
634 
<span class="line-modified">635   /**************************************************************************</span>
<span class="line-modified">636    *</span>
<span class="line-modified">637    * @Function:</span>
<span class="line-modified">638    *   T1_Driver_Done</span>
<span class="line-modified">639    *</span>
<span class="line-modified">640    * @Description:</span>
<span class="line-modified">641    *   Finalizes a given Type 1 driver.</span>
<span class="line-modified">642    *</span>
<span class="line-modified">643    * @Input:</span>
<span class="line-modified">644    *   driver ::</span>
<span class="line-modified">645    *     A handle to the target Type 1 driver.</span>
<span class="line-added">646    */</span>
647   FT_LOCAL_DEF( void )
648   T1_Driver_Done( FT_Module  driver )
649   {
650     FT_UNUSED( driver );
651   }
652 
653 
654 /* END */
</pre>
</td>
</tr>
</table>
<center><a href="t1load.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="t1objs.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>