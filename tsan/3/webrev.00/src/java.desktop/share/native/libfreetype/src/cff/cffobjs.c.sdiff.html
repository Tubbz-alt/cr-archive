<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfreetype/src/cff/cffobjs.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="cffload.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cffobjs.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/cff/cffobjs.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
<span class="line-modified">   1 /***************************************************************************/</span>
<span class="line-modified">   2 /*                                                                         */</span>
<span class="line-modified">   3 /*  cffobjs.c                                                              */</span>
<span class="line-modified">   4 /*                                                                         */</span>
<span class="line-modified">   5 /*    OpenType objects manager (body).                                     */</span>
<span class="line-modified">   6 /*                                                                         */</span>
<span class="line-modified">   7 /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">   8 /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">   9 /*                                                                         */</span>
<span class="line-modified">  10 /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">  11 /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">  12 /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">  13 /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">  14 /*  understand and accept it fully.                                        */</span>
<span class="line-modified">  15 /*                                                                         */</span>
<span class="line-modified">  16 /***************************************************************************/</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 
  21 #include FT_INTERNAL_DEBUG_H
  22 #include FT_INTERNAL_CALC_H
  23 #include FT_INTERNAL_STREAM_H
  24 #include FT_ERRORS_H
  25 #include FT_TRUETYPE_IDS_H
  26 #include FT_TRUETYPE_TAGS_H
  27 #include FT_INTERNAL_SFNT_H
  28 #include FT_DRIVER_H
  29 
  30 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  31 #include FT_MULTIPLE_MASTERS_H
  32 #include FT_SERVICE_MULTIPLE_MASTERS_H
  33 #include FT_SERVICE_METRICS_VARIATIONS_H
  34 #endif
  35 
  36 #include FT_INTERNAL_CFF_OBJECTS_TYPES_H
  37 #include &quot;cffobjs.h&quot;
  38 #include &quot;cffload.h&quot;
  39 #include &quot;cffcmap.h&quot;
<span class="line-removed">  40 #include &quot;cffpic.h&quot;</span>
  41 
  42 #include &quot;cfferrs.h&quot;
  43 
  44 #include FT_INTERNAL_POSTSCRIPT_AUX_H
  45 #include FT_SERVICE_CFF_TABLE_LOAD_H
  46 
  47 
<span class="line-modified">  48   /*************************************************************************/</span>
<span class="line-modified">  49   /*                                                                       */</span>
<span class="line-modified">  50   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified">  51   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified">  52   /* messages during execution.                                            */</span>
<span class="line-modified">  53   /*                                                                       */</span>
  54 #undef  FT_COMPONENT
<span class="line-modified">  55 #define FT_COMPONENT  trace_cffobjs</span>
  56 
  57 
<span class="line-modified">  58   /*************************************************************************/</span>
<span class="line-modified">  59   /*                                                                       */</span>
<span class="line-modified">  60   /*                            SIZE FUNCTIONS                             */</span>
<span class="line-modified">  61   /*                                                                       */</span>
<span class="line-modified">  62   /*************************************************************************/</span>
  63 
  64 
  65   static PSH_Globals_Funcs
  66   cff_size_get_globals_funcs( CFF_Size  size )
  67   {
  68     CFF_Face          face     = (CFF_Face)size-&gt;root.face;
  69     CFF_Font          font     = (CFF_Font)face-&gt;extra.data;
  70     PSHinter_Service  pshinter = font-&gt;pshinter;
  71     FT_Module         module;
  72 
  73 
  74     module = FT_Get_Module( size-&gt;root.face-&gt;driver-&gt;root.library,
  75                             &quot;pshinter&quot; );
  76     return ( module &amp;&amp; pshinter &amp;&amp; pshinter-&gt;get_globals_funcs )
  77            ? pshinter-&gt;get_globals_funcs( module )
  78            : 0;
  79   }
  80 
  81 
  82   FT_LOCAL_DEF( void )
</pre>
<hr />
<pre>
 324         if ( top_upm != sub_upm )
 325         {
 326           x_scale = FT_MulDiv( size-&gt;metrics.x_scale, top_upm, sub_upm );
 327           y_scale = FT_MulDiv( size-&gt;metrics.y_scale, top_upm, sub_upm );
 328         }
 329         else
 330         {
 331           x_scale = size-&gt;metrics.x_scale;
 332           y_scale = size-&gt;metrics.y_scale;
 333         }
 334 
 335         funcs-&gt;set_scale( internal-&gt;subfonts[i - 1],
 336                           x_scale, y_scale, 0, 0 );
 337       }
 338     }
 339 
 340     return FT_Err_Ok;
 341   }
 342 
 343 
<span class="line-modified"> 344   /*************************************************************************/</span>
<span class="line-modified"> 345   /*                                                                       */</span>
<span class="line-modified"> 346   /*                            SLOT  FUNCTIONS                            */</span>
<span class="line-modified"> 347   /*                                                                       */</span>
<span class="line-modified"> 348   /*************************************************************************/</span>
 349 
 350   FT_LOCAL_DEF( void )
 351   cff_slot_done( FT_GlyphSlot  slot )
 352   {
 353     slot-&gt;internal-&gt;glyph_hints = NULL;
 354   }
 355 
 356 
 357   FT_LOCAL_DEF( FT_Error )
 358   cff_slot_init( FT_GlyphSlot  slot )
 359   {
 360     CFF_Face          face     = (CFF_Face)slot-&gt;face;
 361     CFF_Font          font     = (CFF_Font)face-&gt;extra.data;
 362     PSHinter_Service  pshinter = font-&gt;pshinter;
 363 
 364 
 365     if ( pshinter )
 366     {
 367       FT_Module  module;
 368 
 369 
 370       module = FT_Get_Module( slot-&gt;face-&gt;driver-&gt;root.library,
 371                               &quot;pshinter&quot; );
 372       if ( module )
 373       {
 374         T2_Hints_Funcs  funcs;
 375 
 376 
 377         funcs = pshinter-&gt;get_t2_funcs( module );
 378         slot-&gt;internal-&gt;glyph_hints = (void*)funcs;
 379       }
 380     }
 381 
 382     return FT_Err_Ok;
 383   }
 384 
 385 
<span class="line-modified"> 386   /*************************************************************************/</span>
<span class="line-modified"> 387   /*                                                                       */</span>
<span class="line-modified"> 388   /*                           FACE  FUNCTIONS                             */</span>
<span class="line-modified"> 389   /*                                                                       */</span>
<span class="line-modified"> 390   /*************************************************************************/</span>
 391 
 392   static FT_String*
 393   cff_strcpy( FT_Memory         memory,
 394               const FT_String*  source )
 395   {
 396     FT_Error    error;
 397     FT_String*  result;
 398 
 399 
 400     (void)FT_STRDUP( result, source );
 401 
 402     FT_UNUSED( error );
 403 
 404     return result;
 405   }
 406 
 407 
 408   /* Strip all subset prefixes of the form `ABCDEF+&#39;.  Usually, there */
 409   /* is only one, but font names like `APCOOG+JFABTD+FuturaBQ-Bold&#39;   */
 410   /* have been seen in the wild.                                      */
</pre>
<hr />
<pre>
 628       if ( face_index &lt; 0 )
 629       {
 630         cffface-&gt;num_faces = (FT_Long)cff-&gt;num_faces;
 631         return FT_Err_Ok;
 632       }
 633 
 634       cff-&gt;pshinter = pshinter;
 635       cff-&gt;psnames  = psnames;
 636       cff-&gt;cffload  = cffload;
 637 
 638       cffface-&gt;face_index = face_index &amp; 0xFFFF;
 639 
 640       /* Complement the root flags with some interesting information. */
 641       /* Note that this is only necessary for pure CFF and CEF fonts; */
 642       /* SFNT based fonts use the `name&#39; table instead.               */
 643 
 644       cffface-&gt;num_glyphs = (FT_Long)cff-&gt;num_glyphs;
 645 
 646       dict = &amp;cff-&gt;top_font.font_dict;
 647 
<span class="line-modified"> 648       /* we need the `PSNames&#39; module for CFF and CEF formats */</span>
 649       /* which aren&#39;t CID-keyed                               */
 650       if ( dict-&gt;cid_registry == 0xFFFFU &amp;&amp; !psnames )
 651       {
 652         FT_ERROR(( &quot;cff_face_init:&quot;
 653                    &quot; cannot open CFF &amp; CEF fonts\n&quot;
 654                    &quot;              &quot;
<span class="line-modified"> 655                    &quot; without the `PSNames&#39; module\n&quot; ));</span>
 656         error = FT_THROW( Missing_Module );
 657         goto Exit;
 658       }
 659 
 660 #ifdef FT_DEBUG_LEVEL_TRACE
 661       {
 662         FT_UInt     idx;
 663         FT_String*  s;
 664 
 665 
 666         FT_TRACE4(( &quot;SIDs\n&quot; ));
 667 
 668         /* dump string index, including default strings for convenience */
 669         for ( idx = 0; idx &lt;= 390; idx++ )
 670         {
 671           s = cff_index_get_sid_string( cff, idx );
 672           if ( s )
 673             FT_TRACE4(( &quot;  %5d %s\n&quot;, idx, s ));
 674         }
 675 
</pre>
<hr />
<pre>
 946               break;
 947             }
 948           }
 949         }
 950         else
 951         {
 952           char  *cid_font_name =
 953                    cff_index_get_sid_string( cff,
 954                                              dict-&gt;cid_font_name );
 955 
 956 
 957           /* do we have a `/FontName&#39; for a CID-keyed font? */
 958           if ( cid_font_name )
 959             cffface-&gt;family_name = cff_strcpy( memory, cid_font_name );
 960         }
 961 
 962         if ( style_name )
 963           cffface-&gt;style_name = style_name;
 964         else
 965           /* assume &quot;Regular&quot; style if we don&#39;t know better */
<span class="line-modified"> 966           cffface-&gt;style_name = cff_strcpy( memory, (char *)&quot;Regular&quot; );</span>
 967 
<span class="line-modified"> 968         /*******************************************************************/</span>
<span class="line-modified"> 969         /*                                                                 */</span>
<span class="line-modified"> 970         /* Compute face flags.                                             */</span>
<span class="line-modified"> 971         /*                                                                 */</span>
 972         flags = FT_FACE_FLAG_SCALABLE   | /* scalable outlines */
 973                 FT_FACE_FLAG_HORIZONTAL | /* horizontal data   */
 974                 FT_FACE_FLAG_HINTER;      /* has native hinter */
 975 
 976         if ( sfnt_format )
 977           flags |= FT_FACE_FLAG_SFNT;
 978 
 979         /* fixed width font? */
 980         if ( dict-&gt;is_fixed_pitch )
 981           flags |= FT_FACE_FLAG_FIXED_WIDTH;
 982 
 983   /* XXX: WE DO NOT SUPPORT KERNING METRICS IN THE GPOS TABLE FOR NOW */
 984 #if 0
 985         /* kerning available? */
 986         if ( face-&gt;kern_pairs )
 987           flags |= FT_FACE_FLAG_KERNING;
 988 #endif
 989 
 990         cffface-&gt;face_flags |= flags;
 991 
<span class="line-modified"> 992         /*******************************************************************/</span>
<span class="line-modified"> 993         /*                                                                 */</span>
<span class="line-modified"> 994         /* Compute style flags.                                            */</span>
<span class="line-modified"> 995         /*                                                                 */</span>
 996         flags = 0;
 997 
 998         if ( dict-&gt;italic_angle )
 999           flags |= FT_STYLE_FLAG_ITALIC;
1000 
1001         {
1002           char  *weight = cff_index_get_sid_string( cff,
1003                                                     dict-&gt;weight );
1004 
1005 
1006           if ( weight )
1007             if ( !ft_strcmp( weight, &quot;Bold&quot;  ) ||
1008                  !ft_strcmp( weight, &quot;Black&quot; ) )
1009               flags |= FT_STYLE_FLAG_BOLD;
1010         }
1011 
1012         /* double check */
1013         if ( !(flags &amp; FT_STYLE_FLAG_BOLD) &amp;&amp; cffface-&gt;style_name )
1014           if ( !ft_strncmp( cffface-&gt;style_name, &quot;Bold&quot;, 4 )  ||
1015                !ft_strncmp( cffface-&gt;style_name, &quot;Black&quot;, 5 ) )
1016             flags |= FT_STYLE_FLAG_BOLD;
1017 
1018         cffface-&gt;style_flags = flags;
1019       }
1020 
1021 #ifndef FT_CONFIG_OPTION_NO_GLYPH_NAMES
1022       /* CID-keyed CFF fonts don&#39;t have glyph names -- the SFNT loader */
1023       /* has unset this flag because of the 3.0 `post&#39; table.          */
1024       if ( dict-&gt;cid_registry == 0xFFFFU )
1025         cffface-&gt;face_flags |= FT_FACE_FLAG_GLYPH_NAMES;
1026 #endif
1027 
1028       if ( dict-&gt;cid_registry != 0xFFFFU &amp;&amp; pure_cff )
1029         cffface-&gt;face_flags |= FT_FACE_FLAG_CID_KEYED;
1030 
<span class="line-modified">1031       /*******************************************************************/</span>
<span class="line-modified">1032       /*                                                                 */</span>
<span class="line-modified">1033       /* Compute char maps.                                              */</span>
<span class="line-modified">1034       /*                                                                 */</span>
1035 
1036       /* Try to synthesize a Unicode charmap if there is none available */
1037       /* already.  If an OpenType font contains a Unicode &quot;cmap&quot;, we    */
1038       /* will use it, whatever be in the CFF part of the file.          */
1039       {
1040         FT_CharMapRec  cmaprec;
1041         FT_CharMap     cmap;
1042         FT_UInt        nn;
1043         CFF_Encoding   encoding = &amp;cff-&gt;encoding;
1044 
1045 
1046         for ( nn = 0; nn &lt; (FT_UInt)cffface-&gt;num_charmaps; nn++ )
1047         {
1048           cmap = cffface-&gt;charmaps[nn];
1049 
1050           /* Windows Unicode? */
1051           if ( cmap-&gt;platform_id == TT_PLATFORM_MICROSOFT &amp;&amp;
1052                cmap-&gt;encoding_id == TT_MS_ID_UNICODE_CS   )
1053             goto Skip_Unicode;
1054 
1055           /* Apple Unicode platform id? */
1056           if ( cmap-&gt;platform_id == TT_PLATFORM_APPLE_UNICODE )
1057             goto Skip_Unicode; /* Apple Unicode */
1058         }
1059 
1060         /* since CID-keyed fonts don&#39;t contain glyph names, we can&#39;t */
1061         /* construct a cmap                                          */
1062         if ( pure_cff &amp;&amp; cff-&gt;top_font.font_dict.cid_registry != 0xFFFFU )
1063           goto Exit;
1064 
1065         /* we didn&#39;t find a Unicode charmap -- synthesize one */
1066         cmaprec.face        = cffface;
1067         cmaprec.platform_id = TT_PLATFORM_MICROSOFT;
1068         cmaprec.encoding_id = TT_MS_ID_UNICODE_CS;
1069         cmaprec.encoding    = FT_ENCODING_UNICODE;
1070 
1071         nn = (FT_UInt)cffface-&gt;num_charmaps;
1072 
<span class="line-modified">1073         error = FT_CMap_New( &amp;CFF_CMAP_UNICODE_CLASS_REC_GET, NULL,</span>
1074                              &amp;cmaprec, NULL );
1075         if ( error                                      &amp;&amp;
<span class="line-modified">1076              FT_ERR_NEQ( error, No_Unicode_Glyph_Name ) )</span>

1077           goto Exit;
1078         error = FT_Err_Ok;
1079 
1080         /* if no Unicode charmap was previously selected, select this one */
1081         if ( !cffface-&gt;charmap &amp;&amp; nn != (FT_UInt)cffface-&gt;num_charmaps )
1082           cffface-&gt;charmap = cffface-&gt;charmaps[nn];
1083 
1084       Skip_Unicode:
1085         if ( encoding-&gt;count &gt; 0 )
1086         {
1087           FT_CMap_Class  clazz;
1088 
1089 
1090           cmaprec.face        = cffface;
1091           cmaprec.platform_id = TT_PLATFORM_ADOBE;  /* Adobe platform id */
1092 
1093           if ( encoding-&gt;offset == 0 )
1094           {
1095             cmaprec.encoding_id = TT_ADOBE_ID_STANDARD;
1096             cmaprec.encoding    = FT_ENCODING_ADOBE_STANDARD;
<span class="line-modified">1097             clazz               = &amp;CFF_CMAP_ENCODING_CLASS_REC_GET;</span>
1098           }
1099           else if ( encoding-&gt;offset == 1 )
1100           {
1101             cmaprec.encoding_id = TT_ADOBE_ID_EXPERT;
1102             cmaprec.encoding    = FT_ENCODING_ADOBE_EXPERT;
<span class="line-modified">1103             clazz               = &amp;CFF_CMAP_ENCODING_CLASS_REC_GET;</span>
1104           }
1105           else
1106           {
1107             cmaprec.encoding_id = TT_ADOBE_ID_CUSTOM;
1108             cmaprec.encoding    = FT_ENCODING_ADOBE_CUSTOM;
<span class="line-modified">1109             clazz               = &amp;CFF_CMAP_ENCODING_CLASS_REC_GET;</span>
1110           }
1111 
1112           error = FT_CMap_New( clazz, NULL, &amp;cmaprec, NULL );
1113         }
1114       }
1115     }
1116 
1117   Exit:
1118     return error;
1119   }
1120 
1121 
1122   FT_LOCAL_DEF( void )
1123   cff_face_done( FT_Face  cffface )         /* CFF_Face */
1124   {
1125     CFF_Face      face = (CFF_Face)cffface;
1126     FT_Memory     memory;
1127     SFNT_Service  sfnt;
1128 
1129 
</pre>
</td>
<td>
<hr />
<pre>
<span class="line-modified">   1 /****************************************************************************</span>
<span class="line-modified">   2  *</span>
<span class="line-modified">   3  * cffobjs.c</span>
<span class="line-modified">   4  *</span>
<span class="line-modified">   5  *   OpenType objects manager (body).</span>
<span class="line-modified">   6  *</span>
<span class="line-modified">   7  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">   8  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">   9  *</span>
<span class="line-modified">  10  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">  11  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">  12  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">  13  * this file you indicate that you have read the license and</span>
<span class="line-modified">  14  * understand and accept it fully.</span>
<span class="line-modified">  15  *</span>
<span class="line-modified">  16  */</span>
  17 
  18 
  19 #include &lt;ft2build.h&gt;
  20 
  21 #include FT_INTERNAL_DEBUG_H
  22 #include FT_INTERNAL_CALC_H
  23 #include FT_INTERNAL_STREAM_H
  24 #include FT_ERRORS_H
  25 #include FT_TRUETYPE_IDS_H
  26 #include FT_TRUETYPE_TAGS_H
  27 #include FT_INTERNAL_SFNT_H
  28 #include FT_DRIVER_H
  29 
  30 #ifdef TT_CONFIG_OPTION_GX_VAR_SUPPORT
  31 #include FT_MULTIPLE_MASTERS_H
  32 #include FT_SERVICE_MULTIPLE_MASTERS_H
  33 #include FT_SERVICE_METRICS_VARIATIONS_H
  34 #endif
  35 
  36 #include FT_INTERNAL_CFF_OBJECTS_TYPES_H
  37 #include &quot;cffobjs.h&quot;
  38 #include &quot;cffload.h&quot;
  39 #include &quot;cffcmap.h&quot;

  40 
  41 #include &quot;cfferrs.h&quot;
  42 
  43 #include FT_INTERNAL_POSTSCRIPT_AUX_H
  44 #include FT_SERVICE_CFF_TABLE_LOAD_H
  45 
  46 
<span class="line-modified">  47   /**************************************************************************</span>
<span class="line-modified">  48    *</span>
<span class="line-modified">  49    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified">  50    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified">  51    * messages during execution.</span>
<span class="line-modified">  52    */</span>
  53 #undef  FT_COMPONENT
<span class="line-modified">  54 #define FT_COMPONENT  cffobjs</span>
  55 
  56 
<span class="line-modified">  57   /**************************************************************************</span>
<span class="line-modified">  58    *</span>
<span class="line-modified">  59    *                           SIZE FUNCTIONS</span>
<span class="line-modified">  60    *</span>
<span class="line-modified">  61    */</span>
  62 
  63 
  64   static PSH_Globals_Funcs
  65   cff_size_get_globals_funcs( CFF_Size  size )
  66   {
  67     CFF_Face          face     = (CFF_Face)size-&gt;root.face;
  68     CFF_Font          font     = (CFF_Font)face-&gt;extra.data;
  69     PSHinter_Service  pshinter = font-&gt;pshinter;
  70     FT_Module         module;
  71 
  72 
  73     module = FT_Get_Module( size-&gt;root.face-&gt;driver-&gt;root.library,
  74                             &quot;pshinter&quot; );
  75     return ( module &amp;&amp; pshinter &amp;&amp; pshinter-&gt;get_globals_funcs )
  76            ? pshinter-&gt;get_globals_funcs( module )
  77            : 0;
  78   }
  79 
  80 
  81   FT_LOCAL_DEF( void )
</pre>
<hr />
<pre>
 323         if ( top_upm != sub_upm )
 324         {
 325           x_scale = FT_MulDiv( size-&gt;metrics.x_scale, top_upm, sub_upm );
 326           y_scale = FT_MulDiv( size-&gt;metrics.y_scale, top_upm, sub_upm );
 327         }
 328         else
 329         {
 330           x_scale = size-&gt;metrics.x_scale;
 331           y_scale = size-&gt;metrics.y_scale;
 332         }
 333 
 334         funcs-&gt;set_scale( internal-&gt;subfonts[i - 1],
 335                           x_scale, y_scale, 0, 0 );
 336       }
 337     }
 338 
 339     return FT_Err_Ok;
 340   }
 341 
 342 
<span class="line-modified"> 343   /**************************************************************************</span>
<span class="line-modified"> 344    *</span>
<span class="line-modified"> 345    *                           SLOT  FUNCTIONS</span>
<span class="line-modified"> 346    *</span>
<span class="line-modified"> 347    */</span>
 348 
 349   FT_LOCAL_DEF( void )
 350   cff_slot_done( FT_GlyphSlot  slot )
 351   {
 352     slot-&gt;internal-&gt;glyph_hints = NULL;
 353   }
 354 
 355 
 356   FT_LOCAL_DEF( FT_Error )
 357   cff_slot_init( FT_GlyphSlot  slot )
 358   {
 359     CFF_Face          face     = (CFF_Face)slot-&gt;face;
 360     CFF_Font          font     = (CFF_Font)face-&gt;extra.data;
 361     PSHinter_Service  pshinter = font-&gt;pshinter;
 362 
 363 
 364     if ( pshinter )
 365     {
 366       FT_Module  module;
 367 
 368 
 369       module = FT_Get_Module( slot-&gt;face-&gt;driver-&gt;root.library,
 370                               &quot;pshinter&quot; );
 371       if ( module )
 372       {
 373         T2_Hints_Funcs  funcs;
 374 
 375 
 376         funcs = pshinter-&gt;get_t2_funcs( module );
 377         slot-&gt;internal-&gt;glyph_hints = (void*)funcs;
 378       }
 379     }
 380 
 381     return FT_Err_Ok;
 382   }
 383 
 384 
<span class="line-modified"> 385   /**************************************************************************</span>
<span class="line-modified"> 386    *</span>
<span class="line-modified"> 387    *                          FACE  FUNCTIONS</span>
<span class="line-modified"> 388    *</span>
<span class="line-modified"> 389    */</span>
 390 
 391   static FT_String*
 392   cff_strcpy( FT_Memory         memory,
 393               const FT_String*  source )
 394   {
 395     FT_Error    error;
 396     FT_String*  result;
 397 
 398 
 399     (void)FT_STRDUP( result, source );
 400 
 401     FT_UNUSED( error );
 402 
 403     return result;
 404   }
 405 
 406 
 407   /* Strip all subset prefixes of the form `ABCDEF+&#39;.  Usually, there */
 408   /* is only one, but font names like `APCOOG+JFABTD+FuturaBQ-Bold&#39;   */
 409   /* have been seen in the wild.                                      */
</pre>
<hr />
<pre>
 627       if ( face_index &lt; 0 )
 628       {
 629         cffface-&gt;num_faces = (FT_Long)cff-&gt;num_faces;
 630         return FT_Err_Ok;
 631       }
 632 
 633       cff-&gt;pshinter = pshinter;
 634       cff-&gt;psnames  = psnames;
 635       cff-&gt;cffload  = cffload;
 636 
 637       cffface-&gt;face_index = face_index &amp; 0xFFFF;
 638 
 639       /* Complement the root flags with some interesting information. */
 640       /* Note that this is only necessary for pure CFF and CEF fonts; */
 641       /* SFNT based fonts use the `name&#39; table instead.               */
 642 
 643       cffface-&gt;num_glyphs = (FT_Long)cff-&gt;num_glyphs;
 644 
 645       dict = &amp;cff-&gt;top_font.font_dict;
 646 
<span class="line-modified"> 647       /* we need the `psnames&#39; module for CFF and CEF formats */</span>
 648       /* which aren&#39;t CID-keyed                               */
 649       if ( dict-&gt;cid_registry == 0xFFFFU &amp;&amp; !psnames )
 650       {
 651         FT_ERROR(( &quot;cff_face_init:&quot;
 652                    &quot; cannot open CFF &amp; CEF fonts\n&quot;
 653                    &quot;              &quot;
<span class="line-modified"> 654                    &quot; without the `psnames&#39; module\n&quot; ));</span>
 655         error = FT_THROW( Missing_Module );
 656         goto Exit;
 657       }
 658 
 659 #ifdef FT_DEBUG_LEVEL_TRACE
 660       {
 661         FT_UInt     idx;
 662         FT_String*  s;
 663 
 664 
 665         FT_TRACE4(( &quot;SIDs\n&quot; ));
 666 
 667         /* dump string index, including default strings for convenience */
 668         for ( idx = 0; idx &lt;= 390; idx++ )
 669         {
 670           s = cff_index_get_sid_string( cff, idx );
 671           if ( s )
 672             FT_TRACE4(( &quot;  %5d %s\n&quot;, idx, s ));
 673         }
 674 
</pre>
<hr />
<pre>
 945               break;
 946             }
 947           }
 948         }
 949         else
 950         {
 951           char  *cid_font_name =
 952                    cff_index_get_sid_string( cff,
 953                                              dict-&gt;cid_font_name );
 954 
 955 
 956           /* do we have a `/FontName&#39; for a CID-keyed font? */
 957           if ( cid_font_name )
 958             cffface-&gt;family_name = cff_strcpy( memory, cid_font_name );
 959         }
 960 
 961         if ( style_name )
 962           cffface-&gt;style_name = style_name;
 963         else
 964           /* assume &quot;Regular&quot; style if we don&#39;t know better */
<span class="line-modified"> 965           cffface-&gt;style_name = cff_strcpy( memory, &quot;Regular&quot; );</span>
 966 
<span class="line-modified"> 967         /********************************************************************</span>
<span class="line-modified"> 968          *</span>
<span class="line-modified"> 969          * Compute face flags.</span>
<span class="line-modified"> 970          */</span>
 971         flags = FT_FACE_FLAG_SCALABLE   | /* scalable outlines */
 972                 FT_FACE_FLAG_HORIZONTAL | /* horizontal data   */
 973                 FT_FACE_FLAG_HINTER;      /* has native hinter */
 974 
 975         if ( sfnt_format )
 976           flags |= FT_FACE_FLAG_SFNT;
 977 
 978         /* fixed width font? */
 979         if ( dict-&gt;is_fixed_pitch )
 980           flags |= FT_FACE_FLAG_FIXED_WIDTH;
 981 
 982   /* XXX: WE DO NOT SUPPORT KERNING METRICS IN THE GPOS TABLE FOR NOW */
 983 #if 0
 984         /* kerning available? */
 985         if ( face-&gt;kern_pairs )
 986           flags |= FT_FACE_FLAG_KERNING;
 987 #endif
 988 
 989         cffface-&gt;face_flags |= flags;
 990 
<span class="line-modified"> 991         /********************************************************************</span>
<span class="line-modified"> 992          *</span>
<span class="line-modified"> 993          * Compute style flags.</span>
<span class="line-modified"> 994          */</span>
 995         flags = 0;
 996 
 997         if ( dict-&gt;italic_angle )
 998           flags |= FT_STYLE_FLAG_ITALIC;
 999 
1000         {
1001           char  *weight = cff_index_get_sid_string( cff,
1002                                                     dict-&gt;weight );
1003 
1004 
1005           if ( weight )
1006             if ( !ft_strcmp( weight, &quot;Bold&quot;  ) ||
1007                  !ft_strcmp( weight, &quot;Black&quot; ) )
1008               flags |= FT_STYLE_FLAG_BOLD;
1009         }
1010 
1011         /* double check */
1012         if ( !(flags &amp; FT_STYLE_FLAG_BOLD) &amp;&amp; cffface-&gt;style_name )
1013           if ( !ft_strncmp( cffface-&gt;style_name, &quot;Bold&quot;, 4 )  ||
1014                !ft_strncmp( cffface-&gt;style_name, &quot;Black&quot;, 5 ) )
1015             flags |= FT_STYLE_FLAG_BOLD;
1016 
1017         cffface-&gt;style_flags = flags;
1018       }
1019 
1020 #ifndef FT_CONFIG_OPTION_NO_GLYPH_NAMES
1021       /* CID-keyed CFF fonts don&#39;t have glyph names -- the SFNT loader */
1022       /* has unset this flag because of the 3.0 `post&#39; table.          */
1023       if ( dict-&gt;cid_registry == 0xFFFFU )
1024         cffface-&gt;face_flags |= FT_FACE_FLAG_GLYPH_NAMES;
1025 #endif
1026 
1027       if ( dict-&gt;cid_registry != 0xFFFFU &amp;&amp; pure_cff )
1028         cffface-&gt;face_flags |= FT_FACE_FLAG_CID_KEYED;
1029 
<span class="line-modified">1030       /********************************************************************</span>
<span class="line-modified">1031        *</span>
<span class="line-modified">1032        * Compute char maps.</span>
<span class="line-modified">1033        */</span>
1034 
1035       /* Try to synthesize a Unicode charmap if there is none available */
1036       /* already.  If an OpenType font contains a Unicode &quot;cmap&quot;, we    */
1037       /* will use it, whatever be in the CFF part of the file.          */
1038       {
1039         FT_CharMapRec  cmaprec;
1040         FT_CharMap     cmap;
1041         FT_UInt        nn;
1042         CFF_Encoding   encoding = &amp;cff-&gt;encoding;
1043 
1044 
1045         for ( nn = 0; nn &lt; (FT_UInt)cffface-&gt;num_charmaps; nn++ )
1046         {
1047           cmap = cffface-&gt;charmaps[nn];
1048 
1049           /* Windows Unicode? */
1050           if ( cmap-&gt;platform_id == TT_PLATFORM_MICROSOFT &amp;&amp;
1051                cmap-&gt;encoding_id == TT_MS_ID_UNICODE_CS   )
1052             goto Skip_Unicode;
1053 
1054           /* Apple Unicode platform id? */
1055           if ( cmap-&gt;platform_id == TT_PLATFORM_APPLE_UNICODE )
1056             goto Skip_Unicode; /* Apple Unicode */
1057         }
1058 
1059         /* since CID-keyed fonts don&#39;t contain glyph names, we can&#39;t */
1060         /* construct a cmap                                          */
1061         if ( pure_cff &amp;&amp; cff-&gt;top_font.font_dict.cid_registry != 0xFFFFU )
1062           goto Exit;
1063 
1064         /* we didn&#39;t find a Unicode charmap -- synthesize one */
1065         cmaprec.face        = cffface;
1066         cmaprec.platform_id = TT_PLATFORM_MICROSOFT;
1067         cmaprec.encoding_id = TT_MS_ID_UNICODE_CS;
1068         cmaprec.encoding    = FT_ENCODING_UNICODE;
1069 
1070         nn = (FT_UInt)cffface-&gt;num_charmaps;
1071 
<span class="line-modified">1072         error = FT_CMap_New( &amp;cff_cmap_unicode_class_rec, NULL,</span>
1073                              &amp;cmaprec, NULL );
1074         if ( error                                      &amp;&amp;
<span class="line-modified">1075              FT_ERR_NEQ( error, No_Unicode_Glyph_Name ) &amp;&amp;</span>
<span class="line-added">1076              FT_ERR_NEQ( error, Unimplemented_Feature ) )</span>
1077           goto Exit;
1078         error = FT_Err_Ok;
1079 
1080         /* if no Unicode charmap was previously selected, select this one */
1081         if ( !cffface-&gt;charmap &amp;&amp; nn != (FT_UInt)cffface-&gt;num_charmaps )
1082           cffface-&gt;charmap = cffface-&gt;charmaps[nn];
1083 
1084       Skip_Unicode:
1085         if ( encoding-&gt;count &gt; 0 )
1086         {
1087           FT_CMap_Class  clazz;
1088 
1089 
1090           cmaprec.face        = cffface;
1091           cmaprec.platform_id = TT_PLATFORM_ADOBE;  /* Adobe platform id */
1092 
1093           if ( encoding-&gt;offset == 0 )
1094           {
1095             cmaprec.encoding_id = TT_ADOBE_ID_STANDARD;
1096             cmaprec.encoding    = FT_ENCODING_ADOBE_STANDARD;
<span class="line-modified">1097             clazz               = &amp;cff_cmap_encoding_class_rec;</span>
1098           }
1099           else if ( encoding-&gt;offset == 1 )
1100           {
1101             cmaprec.encoding_id = TT_ADOBE_ID_EXPERT;
1102             cmaprec.encoding    = FT_ENCODING_ADOBE_EXPERT;
<span class="line-modified">1103             clazz               = &amp;cff_cmap_encoding_class_rec;</span>
1104           }
1105           else
1106           {
1107             cmaprec.encoding_id = TT_ADOBE_ID_CUSTOM;
1108             cmaprec.encoding    = FT_ENCODING_ADOBE_CUSTOM;
<span class="line-modified">1109             clazz               = &amp;cff_cmap_encoding_class_rec;</span>
1110           }
1111 
1112           error = FT_CMap_New( clazz, NULL, &amp;cmaprec, NULL );
1113         }
1114       }
1115     }
1116 
1117   Exit:
1118     return error;
1119   }
1120 
1121 
1122   FT_LOCAL_DEF( void )
1123   cff_face_done( FT_Face  cffface )         /* CFF_Face */
1124   {
1125     CFF_Face      face = (CFF_Face)cffface;
1126     FT_Memory     memory;
1127     SFNT_Service  sfnt;
1128 
1129 
</pre>
</td>
</tr>
</table>
<center><a href="cffload.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cffobjs.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>