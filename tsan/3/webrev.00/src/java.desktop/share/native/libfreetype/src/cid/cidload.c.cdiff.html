<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfreetype/src/cid/cidload.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="cidgload.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cidload.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfreetype/src/cid/cidload.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,42 ***</span>
<span class="line-modified">! /***************************************************************************/</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*  cidload.c                                                              */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*    CID-keyed Type1 font loader (body).                                  */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*  Copyright 1996-2018 by                                                 */</span>
<span class="line-modified">! /*  David Turner, Robert Wilhelm, and Werner Lemberg.                      */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /*  This file is part of the FreeType project, and may only be used,       */</span>
<span class="line-modified">! /*  modified, and distributed under the terms of the FreeType project      */</span>
<span class="line-modified">! /*  license, LICENSE.TXT.  By continuing to use, modify, or distribute     */</span>
<span class="line-modified">! /*  this file you indicate that you have read the license and              */</span>
<span class="line-modified">! /*  understand and accept it fully.                                        */</span>
<span class="line-modified">! /*                                                                         */</span>
<span class="line-modified">! /***************************************************************************/</span>
  
  
  #include &lt;ft2build.h&gt;
  #include FT_INTERNAL_DEBUG_H
  #include FT_CONFIG_CONFIG_H
  #include FT_MULTIPLE_MASTERS_H
  #include FT_INTERNAL_TYPE1_TYPES_H
  
  #include &quot;cidload.h&quot;
  
  #include &quot;ciderrs.h&quot;
  
  
<span class="line-modified">!   /*************************************************************************/</span>
<span class="line-modified">!   /*                                                                       */</span>
<span class="line-modified">!   /* The macro FT_COMPONENT is used in trace mode.  It is an implicit      */</span>
<span class="line-modified">!   /* parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log  */</span>
<span class="line-modified">!   /* messages during execution.                                            */</span>
<span class="line-modified">!   /*                                                                       */</span>
  #undef  FT_COMPONENT
<span class="line-modified">! #define FT_COMPONENT  trace_cidload</span>
  
  
    /* read a single offset */
    FT_LOCAL_DEF( FT_ULong )
    cid_get_offset( FT_Byte*  *start,
<span class="line-new-header">--- 1,43 ---</span>
<span class="line-modified">! /****************************************************************************</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * cidload.c</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  *   CID-keyed Type1 font loader (body).</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * Copyright (C) 1996-2019 by</span>
<span class="line-modified">!  * David Turner, Robert Wilhelm, and Werner Lemberg.</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * This file is part of the FreeType project, and may only be used,</span>
<span class="line-modified">!  * modified, and distributed under the terms of the FreeType project</span>
<span class="line-modified">!  * license, LICENSE.TXT.  By continuing to use, modify, or distribute</span>
<span class="line-modified">!  * this file you indicate that you have read the license and</span>
<span class="line-modified">!  * understand and accept it fully.</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  */</span>
  
  
  #include &lt;ft2build.h&gt;
  #include FT_INTERNAL_DEBUG_H
  #include FT_CONFIG_CONFIG_H
  #include FT_MULTIPLE_MASTERS_H
  #include FT_INTERNAL_TYPE1_TYPES_H
<span class="line-added">+ #include FT_INTERNAL_POSTSCRIPT_AUX_H</span>
  
  #include &quot;cidload.h&quot;
  
  #include &quot;ciderrs.h&quot;
  
  
<span class="line-modified">!   /**************************************************************************</span>
<span class="line-modified">!    *</span>
<span class="line-modified">!    * The macro FT_COMPONENT is used in trace mode.  It is an implicit</span>
<span class="line-modified">!    * parameter of the FT_TRACE() and FT_ERROR() macros, used to print/log</span>
<span class="line-modified">!    * messages during execution.</span>
<span class="line-modified">!    */</span>
  #undef  FT_COMPONENT
<span class="line-modified">! #define FT_COMPONENT  cidload</span>
  
  
    /* read a single offset */
    FT_LOCAL_DEF( FT_ULong )
    cid_get_offset( FT_Byte*  *start,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 79,10 ***</span>
<span class="line-new-header">--- 80,12 ---</span>
  
  
      /* if the keyword has a dedicated callback, call it */
      if ( keyword-&gt;type == T1_FIELD_TYPE_CALLBACK )
      {
<span class="line-added">+       FT_TRACE4(( &quot;  %s&quot;, keyword-&gt;ident ));</span>
<span class="line-added">+ </span>
        keyword-&gt;reader( (FT_Face)face, parser );
        error = parser-&gt;root.error;
        goto Exit;
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 129,26 ***</span>
            object = (FT_Byte*)dict;
          }
        }
      }
  
      dummy_object = object;
  
      /* now, load the keyword data in the object&#39;s field(s) */
      if ( keyword-&gt;type == T1_FIELD_TYPE_INTEGER_ARRAY ||
           keyword-&gt;type == T1_FIELD_TYPE_FIXED_ARRAY   )
        error = cid_parser_load_field_table( &amp;loader-&gt;parser, keyword,
                                             &amp;dummy_object );
      else
        error = cid_parser_load_field( &amp;loader-&gt;parser,
                                       keyword, &amp;dummy_object );
    Exit:
      return error;
    }
  
  
<span class="line-modified">!   FT_CALLBACK_DEF( FT_Error )</span>
    cid_parse_font_matrix( CID_Face     face,
                           CID_Parser*  parser )
    {
      CID_FaceDict  dict;
      FT_Face       root = (FT_Face)&amp;face-&gt;root;
<span class="line-new-header">--- 132,31 ---</span>
            object = (FT_Byte*)dict;
          }
        }
      }
  
<span class="line-added">+     FT_TRACE4(( &quot;  %s&quot;, keyword-&gt;ident ));</span>
<span class="line-added">+ </span>
      dummy_object = object;
  
      /* now, load the keyword data in the object&#39;s field(s) */
      if ( keyword-&gt;type == T1_FIELD_TYPE_INTEGER_ARRAY ||
           keyword-&gt;type == T1_FIELD_TYPE_FIXED_ARRAY   )
        error = cid_parser_load_field_table( &amp;loader-&gt;parser, keyword,
                                             &amp;dummy_object );
      else
        error = cid_parser_load_field( &amp;loader-&gt;parser,
                                       keyword, &amp;dummy_object );
<span class="line-added">+ </span>
<span class="line-added">+     FT_TRACE4(( &quot;\n&quot; ));</span>
<span class="line-added">+ </span>
    Exit:
      return error;
    }
  
  
<span class="line-modified">!   FT_CALLBACK_DEF( void )</span>
    cid_parse_font_matrix( CID_Face     face,
                           CID_Parser*  parser )
    {
      CID_FaceDict  dict;
      FT_Face       root = (FT_Face)&amp;face-&gt;root;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 169,18 ***</span>
  
        /* input is scaled by 1000 to accommodate default FontMatrix */
        result = cid_parser_to_fixed_array( parser, 6, temp, 3 );
  
        if ( result &lt; 6 )
<span class="line-modified">!         return FT_THROW( Invalid_File_Format );</span>
  
        temp_scale = FT_ABS( temp[3] );
  
        if ( temp_scale == 0 )
        {
          FT_ERROR(( &quot;cid_parse_font_matrix: invalid font matrix\n&quot; ));
<span class="line-modified">!         return FT_THROW( Invalid_File_Format );</span>
        }
  
        /* atypical case */
        if ( temp_scale != 0x10000L )
        {
<span class="line-new-header">--- 177,29 ---</span>
  
        /* input is scaled by 1000 to accommodate default FontMatrix */
        result = cid_parser_to_fixed_array( parser, 6, temp, 3 );
  
        if ( result &lt; 6 )
<span class="line-modified">!       {</span>
<span class="line-added">+         FT_ERROR(( &quot;cid_parse_font_matrix: not enough matrix elements\n&quot; ));</span>
<span class="line-added">+         goto Exit;</span>
<span class="line-added">+       }</span>
<span class="line-added">+ </span>
<span class="line-added">+       FT_TRACE4(( &quot; [%f %f %f %f %f %f]\n&quot;,</span>
<span class="line-added">+                   (double)temp[0] / 65536 / 1000,</span>
<span class="line-added">+                   (double)temp[1] / 65536 / 1000,</span>
<span class="line-added">+                   (double)temp[2] / 65536 / 1000,</span>
<span class="line-added">+                   (double)temp[3] / 65536 / 1000,</span>
<span class="line-added">+                   (double)temp[4] / 65536 / 1000,</span>
<span class="line-added">+                   (double)temp[5] / 65536 / 1000 ));</span>
  
        temp_scale = FT_ABS( temp[3] );
  
        if ( temp_scale == 0 )
        {
          FT_ERROR(( &quot;cid_parse_font_matrix: invalid font matrix\n&quot; ));
<span class="line-modified">!         goto Exit;</span>
        }
  
        /* atypical case */
        if ( temp_scale != 0x10000L )
        {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 198,20 ***</span>
        matrix-&gt;xx = temp[0];
        matrix-&gt;yx = temp[1];
        matrix-&gt;xy = temp[2];
        matrix-&gt;yy = temp[3];
  
        /* note that the font offsets are expressed in integer font units */
        offset-&gt;x  = temp[4] &gt;&gt; 16;
        offset-&gt;y  = temp[5] &gt;&gt; 16;
      }
  
<span class="line-modified">!     return FT_Err_Ok;</span>
    }
  
  
<span class="line-modified">!   FT_CALLBACK_DEF( FT_Error )</span>
    parse_fd_array( CID_Face     face,
                    CID_Parser*  parser )
    {
      CID_FaceInfo  cid    = &amp;face-&gt;cid;
      FT_Memory     memory = face-&gt;root.memory;
<span class="line-new-header">--- 217,28 ---</span>
        matrix-&gt;xx = temp[0];
        matrix-&gt;yx = temp[1];
        matrix-&gt;xy = temp[2];
        matrix-&gt;yy = temp[3];
  
<span class="line-added">+       if ( !FT_Matrix_Check( matrix ) )</span>
<span class="line-added">+       {</span>
<span class="line-added">+         FT_ERROR(( &quot;t1_parse_font_matrix: invalid font matrix\n&quot; ));</span>
<span class="line-added">+         parser-&gt;root.error = FT_THROW( Invalid_File_Format );</span>
<span class="line-added">+         goto Exit;</span>
<span class="line-added">+       }</span>
<span class="line-added">+ </span>
        /* note that the font offsets are expressed in integer font units */
        offset-&gt;x  = temp[4] &gt;&gt; 16;
        offset-&gt;y  = temp[5] &gt;&gt; 16;
      }
  
<span class="line-modified">!   Exit:</span>
<span class="line-added">+     return;</span>
    }
  
  
<span class="line-modified">!   FT_CALLBACK_DEF( void )</span>
    parse_fd_array( CID_Face     face,
                    CID_Parser*  parser )
    {
      CID_FaceInfo  cid    = &amp;face-&gt;cid;
      FT_Memory     memory = face-&gt;root.memory;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 222,14 ***</span>
  
      num_dicts = cid_parser_to_int( parser );
      if ( num_dicts &lt; 0 )
      {
        FT_ERROR(( &quot;parse_fd_array: invalid number of dictionaries\n&quot; ));
<span class="line-removed">-       error = FT_THROW( Invalid_File_Format );</span>
        goto Exit;
      }
  
      /*
       * A single entry in the FDArray must (at least) contain the following
       * structure elements.
       *
       *   %ADOBeginFontDict              18
<span class="line-new-header">--- 249,15 ---</span>
  
      num_dicts = cid_parser_to_int( parser );
      if ( num_dicts &lt; 0 )
      {
        FT_ERROR(( &quot;parse_fd_array: invalid number of dictionaries\n&quot; ));
        goto Exit;
      }
  
<span class="line-added">+     FT_TRACE4(( &quot; %d\n&quot;, num_dicts ));</span>
<span class="line-added">+ </span>
      /*
       * A single entry in the FDArray must (at least) contain the following
       * structure elements.
       *
       *   %ADOBeginFontDict              18
</pre>
<hr />
<pre>
<span class="line-old-header">*** 261,31 ***</span>
        if ( FT_NEW_ARRAY( cid-&gt;font_dicts, num_dicts ) )
          goto Exit;
  
        cid-&gt;num_dicts = num_dicts;
  
<span class="line-modified">!       /* don&#39;t forget to set a few defaults */</span>
        for ( n = 0; n &lt; cid-&gt;num_dicts; n++ )
        {
          CID_FaceDict  dict = cid-&gt;font_dicts + n;
  
  
<span class="line-modified">!         /* default value for lenIV */</span>
<span class="line-modified">!         dict-&gt;private_dict.lenIV = 4;</span>
        }
      }
  
    Exit:
<span class="line-modified">!     return error;</span>
    }
  
  
<span class="line-modified">!   /* by mistake, `expansion_factor&#39; appears both in PS_PrivateRec */</span>
    /* and CID_FaceDictRec (both are public header files and can&#39;t  */
<span class="line-modified">!   /* changed); we simply copy the value                           */</span>
  
<span class="line-modified">!   FT_CALLBACK_DEF( FT_Error )</span>
    parse_expansion_factor( CID_Face     face,
                            CID_Parser*  parser )
    {
      CID_FaceDict  dict;
  
<span class="line-new-header">--- 289,35 ---</span>
        if ( FT_NEW_ARRAY( cid-&gt;font_dicts, num_dicts ) )
          goto Exit;
  
        cid-&gt;num_dicts = num_dicts;
  
<span class="line-modified">!       /* set some default values (the same as for Type 1 fonts) */</span>
        for ( n = 0; n &lt; cid-&gt;num_dicts; n++ )
        {
          CID_FaceDict  dict = cid-&gt;font_dicts + n;
  
  
<span class="line-modified">!         dict-&gt;private_dict.blue_shift       = 7;</span>
<span class="line-modified">!         dict-&gt;private_dict.blue_fuzz        = 1;</span>
<span class="line-added">+         dict-&gt;private_dict.lenIV            = 4;</span>
<span class="line-added">+         dict-&gt;private_dict.expansion_factor = (FT_Fixed)( 0.06 * 0x10000L );</span>
<span class="line-added">+         dict-&gt;private_dict.blue_scale       = (FT_Fixed)(</span>
<span class="line-added">+                                                 0.039625 * 0x10000L * 1000 );</span>
        }
      }
  
    Exit:
<span class="line-modified">!     return;</span>
    }
  
  
<span class="line-modified">!   /* By mistake, `expansion_factor&#39; appears both in PS_PrivateRec */</span>
    /* and CID_FaceDictRec (both are public header files and can&#39;t  */
<span class="line-modified">!   /* changed).  We simply copy the value.                         */</span>
  
<span class="line-modified">!   FT_CALLBACK_DEF( void )</span>
    parse_expansion_factor( CID_Face     face,
                            CID_Parser*  parser )
    {
      CID_FaceDict  dict;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 294,13 ***</span>
      {
        dict = face-&gt;cid.font_dicts + parser-&gt;num_dict;
  
        dict-&gt;expansion_factor              = cid_parser_to_fixed( parser, 0 );
        dict-&gt;private_dict.expansion_factor = dict-&gt;expansion_factor;
      }
  
<span class="line-modified">!     return FT_Err_Ok;</span>
    }
  
  
    static
    const T1_FieldRec  cid_field_records[] =
<span class="line-new-header">--- 326,47 ---</span>
      {
        dict = face-&gt;cid.font_dicts + parser-&gt;num_dict;
  
        dict-&gt;expansion_factor              = cid_parser_to_fixed( parser, 0 );
        dict-&gt;private_dict.expansion_factor = dict-&gt;expansion_factor;
<span class="line-added">+ </span>
<span class="line-added">+       FT_TRACE4(( &quot;%d\n&quot;, dict-&gt;expansion_factor ));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     return;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+   /* By mistake, `CID_FaceDictRec&#39; doesn&#39;t contain a field for the */</span>
<span class="line-added">+   /* `FontName&#39; keyword.  FreeType doesn&#39;t need it, but it is nice */</span>
<span class="line-added">+   /* to catch it for producing better trace output.                */</span>
<span class="line-added">+ </span>
<span class="line-added">+   FT_CALLBACK_DEF( void )</span>
<span class="line-added">+   parse_font_name( CID_Face     face,</span>
<span class="line-added">+                    CID_Parser*  parser )</span>
<span class="line-added">+   {</span>
<span class="line-added">+ #ifdef FT_DEBUG_LEVEL_TRACE</span>
<span class="line-added">+     if ( parser-&gt;num_dict &gt;= 0 &amp;&amp; parser-&gt;num_dict &lt; face-&gt;cid.num_dicts )</span>
<span class="line-added">+     {</span>
<span class="line-added">+       T1_TokenRec  token;</span>
<span class="line-added">+       FT_UInt      len;</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+       cid_parser_to_token( parser, &amp;token );</span>
<span class="line-added">+ </span>
<span class="line-added">+       len = (FT_UInt)( token.limit - token.start );</span>
<span class="line-added">+       if ( len )</span>
<span class="line-added">+         FT_TRACE4(( &quot; %.*s\n&quot;, len, token.start ));</span>
<span class="line-added">+       else</span>
<span class="line-added">+         FT_TRACE4(( &quot; &lt;no value&gt;\n&quot; ));</span>
      }
<span class="line-added">+ #else</span>
<span class="line-added">+     FT_UNUSED( face );</span>
<span class="line-added">+     FT_UNUSED( parser );</span>
<span class="line-added">+ #endif</span>
  
<span class="line-modified">!     return;</span>
    }
  
  
    static
    const T1_FieldRec  cid_field_records[] =
</pre>
<hr />
<pre>
<span class="line-old-header">*** 309,10 ***</span>
<span class="line-new-header">--- 375,11 ---</span>
  #include &quot;cidtoken.h&quot;
  
      T1_FIELD_CALLBACK( &quot;FDArray&quot;,         parse_fd_array, 0 )
      T1_FIELD_CALLBACK( &quot;FontMatrix&quot;,      cid_parse_font_matrix, 0 )
      T1_FIELD_CALLBACK( &quot;ExpansionFactor&quot;, parse_expansion_factor, 0 )
<span class="line-added">+     T1_FIELD_CALLBACK( &quot;FontName&quot;,        parse_font_name, 0 )</span>
  
      { 0, T1_FIELD_LOCATION_CID_INFO, T1_FIELD_TYPE_NONE, 0, 0, 0, 0, 0, 0 }
    };
  
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 354,11 ***</span>
<span class="line-new-header">--- 421,20 ---</span>
                 ft_strncmp( (char*)cur, &quot;%ADOBeginFontDict&quot;, 17 ) == 0 )
            {
              /* if /FDArray was found, then cid-&gt;num_dicts is &gt; 0, and */
              /* we can start increasing parser-&gt;num_dict               */
              if ( face-&gt;cid.num_dicts &gt; 0 )
<span class="line-added">+             {</span>
                parser-&gt;num_dict++;
<span class="line-added">+ </span>
<span class="line-added">+ #ifdef FT_DEBUG_LEVEL_TRACE</span>
<span class="line-added">+               FT_TRACE4(( &quot; FontDict %d&quot;, parser-&gt;num_dict ));</span>
<span class="line-added">+               if ( parser-&gt;num_dict &gt; face-&gt;cid.num_dicts )</span>
<span class="line-added">+                 FT_TRACE4(( &quot; (ignored)&quot; ));</span>
<span class="line-added">+               FT_TRACE4(( &quot;\n&quot; ));</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+             }</span>
            }
          }
  
          cur = parser-&gt;root.cursor;
          /* no error can occur in cid_parser_skip_spaces */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 755,20 ***</span>
  
      /* sanity tests */
  
      if ( cid-&gt;fd_bytes &lt; 0 || cid-&gt;gd_bytes &lt; 1 )
      {
<span class="line-modified">!       FT_ERROR(( &quot;cid_parse_dict:&quot;</span>
                   &quot; Invalid `FDBytes&#39; or `GDBytes&#39; value\n&quot; ));
        error = FT_THROW( Invalid_File_Format );
        goto Exit;
      }
  
      /* allow at most 32bit offsets */
      if ( cid-&gt;fd_bytes &gt; 4 || cid-&gt;gd_bytes &gt; 4 )
      {
<span class="line-modified">!       FT_ERROR(( &quot;cid_parse_dict:&quot;</span>
                   &quot; Values of `FDBytes&#39; or `GDBytes&#39; larger than 4\n&quot;
                   &quot;               &quot;
                   &quot; are not supported\n&quot; ));
        error = FT_THROW( Invalid_File_Format );
        goto Exit;
<span class="line-new-header">--- 831,20 ---</span>
  
      /* sanity tests */
  
      if ( cid-&gt;fd_bytes &lt; 0 || cid-&gt;gd_bytes &lt; 1 )
      {
<span class="line-modified">!       FT_ERROR(( &quot;cid_face_open:&quot;</span>
                   &quot; Invalid `FDBytes&#39; or `GDBytes&#39; value\n&quot; ));
        error = FT_THROW( Invalid_File_Format );
        goto Exit;
      }
  
      /* allow at most 32bit offsets */
      if ( cid-&gt;fd_bytes &gt; 4 || cid-&gt;gd_bytes &gt; 4 )
      {
<span class="line-modified">!       FT_ERROR(( &quot;cid_face_open:&quot;</span>
                   &quot; Values of `FDBytes&#39; or `GDBytes&#39; larger than 4\n&quot;
                   &quot;               &quot;
                   &quot; are not supported\n&quot; ));
        error = FT_THROW( Invalid_File_Format );
        goto Exit;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 780,58 ***</span>
      for ( n = 0; n &lt; cid-&gt;num_dicts; n++ )
      {
        CID_FaceDict  dict = cid-&gt;font_dicts + n;
  
  
        if ( dict-&gt;sd_bytes &lt; 0                        ||
             ( dict-&gt;num_subrs &amp;&amp; dict-&gt;sd_bytes &lt; 1 ) )
        {
<span class="line-modified">!         FT_ERROR(( &quot;cid_parse_dict: Invalid `SDBytes&#39; value\n&quot; ));</span>
          error = FT_THROW( Invalid_File_Format );
          goto Exit;
        }
  
        if ( dict-&gt;sd_bytes &gt; 4 )
        {
<span class="line-modified">!         FT_ERROR(( &quot;cid_parse_dict:&quot;</span>
                     &quot; Values of `SDBytes&#39; larger than 4&quot;
                     &quot; are not supported\n&quot; ));
          error = FT_THROW( Invalid_File_Format );
          goto Exit;
        }
  
        if ( dict-&gt;subrmap_offset &gt; binary_length )
        {
<span class="line-modified">!         FT_ERROR(( &quot;cid_parse_dict: Invalid `SubrMapOffset&#39; value\n&quot; ));</span>
          error = FT_THROW( Invalid_File_Format );
          goto Exit;
        }
  
        /* `num_subrs&#39; is scanned as a signed integer */
        if ( (FT_Int)dict-&gt;num_subrs &lt; 0                                     ||
             ( dict-&gt;sd_bytes                                              &amp;&amp;
               dict-&gt;num_subrs &gt; ( binary_length - dict-&gt;subrmap_offset ) /
                                   (FT_UInt)dict-&gt;sd_bytes                 ) )
        {
<span class="line-modified">!         FT_ERROR(( &quot;cid_parse_dict: Invalid `SubrCount&#39; value\n&quot; ));</span>
          error = FT_THROW( Invalid_File_Format );
          goto Exit;
        }
      }
  
      if ( cid-&gt;cidmap_offset &gt; binary_length )
      {
<span class="line-modified">!       FT_ERROR(( &quot;cid_parse_dict: Invalid `CIDMapOffset&#39; value\n&quot; ));</span>
        error = FT_THROW( Invalid_File_Format );
        goto Exit;
      }
  
      if ( entry_len                                            &amp;&amp;
           cid-&gt;cid_count &gt;
             ( binary_length - cid-&gt;cidmap_offset ) / entry_len )
      {
<span class="line-modified">!       FT_ERROR(( &quot;cid_parse_dict: Invalid `CIDCount&#39; value\n&quot; ));</span>
        error = FT_THROW( Invalid_File_Format );
        goto Exit;
      }
  
      /* we can now safely proceed */
<span class="line-new-header">--- 856,77 ---</span>
      for ( n = 0; n &lt; cid-&gt;num_dicts; n++ )
      {
        CID_FaceDict  dict = cid-&gt;font_dicts + n;
  
  
<span class="line-added">+       /* the upper limits are ad-hoc values */</span>
<span class="line-added">+       if ( dict-&gt;private_dict.blue_shift &gt; 1000 ||</span>
<span class="line-added">+            dict-&gt;private_dict.blue_shift &lt; 0    )</span>
<span class="line-added">+       {</span>
<span class="line-added">+         FT_TRACE2(( &quot;cid_face_open:&quot;</span>
<span class="line-added">+                     &quot; setting unlikely BlueShift value %d to default (7)\n&quot;,</span>
<span class="line-added">+                     dict-&gt;private_dict.blue_shift ));</span>
<span class="line-added">+         dict-&gt;private_dict.blue_shift = 7;</span>
<span class="line-added">+       }</span>
<span class="line-added">+ </span>
<span class="line-added">+       if ( dict-&gt;private_dict.blue_fuzz &gt; 1000 ||</span>
<span class="line-added">+            dict-&gt;private_dict.blue_fuzz &lt; 0    )</span>
<span class="line-added">+       {</span>
<span class="line-added">+         FT_TRACE2(( &quot;cid_face_open:&quot;</span>
<span class="line-added">+                     &quot; setting unlikely BlueFuzz value %d to default (1)\n&quot;,</span>
<span class="line-added">+                     dict-&gt;private_dict.blue_fuzz ));</span>
<span class="line-added">+         dict-&gt;private_dict.blue_fuzz = 1;</span>
<span class="line-added">+       }</span>
<span class="line-added">+ </span>
        if ( dict-&gt;sd_bytes &lt; 0                        ||
             ( dict-&gt;num_subrs &amp;&amp; dict-&gt;sd_bytes &lt; 1 ) )
        {
<span class="line-modified">!         FT_ERROR(( &quot;cid_face_open: Invalid `SDBytes&#39; value\n&quot; ));</span>
          error = FT_THROW( Invalid_File_Format );
          goto Exit;
        }
  
        if ( dict-&gt;sd_bytes &gt; 4 )
        {
<span class="line-modified">!         FT_ERROR(( &quot;cid_face_open:&quot;</span>
                     &quot; Values of `SDBytes&#39; larger than 4&quot;
                     &quot; are not supported\n&quot; ));
          error = FT_THROW( Invalid_File_Format );
          goto Exit;
        }
  
        if ( dict-&gt;subrmap_offset &gt; binary_length )
        {
<span class="line-modified">!         FT_ERROR(( &quot;cid_face_open: Invalid `SubrMapOffset&#39; value\n&quot; ));</span>
          error = FT_THROW( Invalid_File_Format );
          goto Exit;
        }
  
        /* `num_subrs&#39; is scanned as a signed integer */
        if ( (FT_Int)dict-&gt;num_subrs &lt; 0                                     ||
             ( dict-&gt;sd_bytes                                              &amp;&amp;
               dict-&gt;num_subrs &gt; ( binary_length - dict-&gt;subrmap_offset ) /
                                   (FT_UInt)dict-&gt;sd_bytes                 ) )
        {
<span class="line-modified">!         FT_ERROR(( &quot;cid_face_open: Invalid `SubrCount&#39; value\n&quot; ));</span>
          error = FT_THROW( Invalid_File_Format );
          goto Exit;
        }
      }
  
      if ( cid-&gt;cidmap_offset &gt; binary_length )
      {
<span class="line-modified">!       FT_ERROR(( &quot;cid_face_open: Invalid `CIDMapOffset&#39; value\n&quot; ));</span>
        error = FT_THROW( Invalid_File_Format );
        goto Exit;
      }
  
      if ( entry_len                                            &amp;&amp;
           cid-&gt;cid_count &gt;
             ( binary_length - cid-&gt;cidmap_offset ) / entry_len )
      {
<span class="line-modified">!       FT_ERROR(( &quot;cid_face_open: Invalid `CIDCount&#39; value\n&quot; ));</span>
        error = FT_THROW( Invalid_File_Format );
        goto Exit;
      }
  
      /* we can now safely proceed */
</pre>
<center><a href="cidgload.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="cidload.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>