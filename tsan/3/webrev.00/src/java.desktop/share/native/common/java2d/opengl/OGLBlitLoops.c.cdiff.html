<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/common/java2d/opengl/OGLBlitLoops.c</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="J2D_GL/glext.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="OGLRenderQueue.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/common/java2d/opengl/OGLBlitLoops.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2014, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 206,25 ***</span>
      j2d_glRasterPos2i(0, 0);
      j2d_glBitmap(0, 0, 0, 0, (GLfloat)dx1, (GLfloat)-dy1, NULL);
  
      j2d_glPixelZoom(scalex, -scaley);
  
      // in case pixel stride is not a multiple of scanline stride the copy
      // has to be done line by line (see 6207877)
      if (srcInfo-&gt;scanStride % srcInfo-&gt;pixelStride != 0) {
          jint width = sx2-sx1;
          jint height = sy2-sy1;
<span class="line-removed">-         GLvoid *pSrc = srcInfo-&gt;rasBase;</span>
<span class="line-removed">- </span>
          while (height &gt; 0) {
              j2d_glDrawPixels(width, 1, pf-&gt;format, pf-&gt;type, pSrc);
<span class="line-modified">!             j2d_glBitmap(0, 0, 0, 0, (GLfloat)0, (GLfloat)-1, NULL);</span>
              pSrc = PtrAddBytes(pSrc, srcInfo-&gt;scanStride);
              height--;
          }
      } else {
<span class="line-modified">!         j2d_glDrawPixels(sx2-sx1, sy2-sy1, pf-&gt;format, pf-&gt;type, srcInfo-&gt;rasBase);</span>
      }
  
      j2d_glPixelZoom(1.0, 1.0);
  
      if (oglc-&gt;extraAlpha != 1.0f) {
<span class="line-new-header">--- 206,26 ---</span>
      j2d_glRasterPos2i(0, 0);
      j2d_glBitmap(0, 0, 0, 0, (GLfloat)dx1, (GLfloat)-dy1, NULL);
  
      j2d_glPixelZoom(scalex, -scaley);
  
<span class="line-added">+     GLvoid *pSrc = PtrCoord(srcInfo-&gt;rasBase, sx1, srcInfo-&gt;pixelStride,</span>
<span class="line-added">+                                               sy1, srcInfo-&gt;scanStride);</span>
<span class="line-added">+ </span>
      // in case pixel stride is not a multiple of scanline stride the copy
      // has to be done line by line (see 6207877)
      if (srcInfo-&gt;scanStride % srcInfo-&gt;pixelStride != 0) {
          jint width = sx2-sx1;
          jint height = sy2-sy1;
          while (height &gt; 0) {
              j2d_glDrawPixels(width, 1, pf-&gt;format, pf-&gt;type, pSrc);
<span class="line-modified">!             j2d_glBitmap(0, 0, 0, 0, (GLfloat)0, (GLfloat)-scaley, NULL);</span>
              pSrc = PtrAddBytes(pSrc, srcInfo-&gt;scanStride);
              height--;
          }
      } else {
<span class="line-modified">!         j2d_glDrawPixels(sx2-sx1, sy2-sy1, pf-&gt;format, pf-&gt;type, pSrc);</span>
      }
  
      j2d_glPixelZoom(1.0, 1.0);
  
      if (oglc-&gt;extraAlpha != 1.0f) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 315,35 ***</span>
  
              tx2 = ((GLdouble)sw) / tw;
              ty2 = ((GLdouble)sh) / th;
  
              if (swsurface) {
                  if (slowPath) {
                      jint tmph = sh;
<span class="line-removed">-                     GLvoid *pSrc = PtrCoord(srcInfo-&gt;rasBase,</span>
<span class="line-removed">-                                             sx, srcInfo-&gt;pixelStride,</span>
<span class="line-removed">-                                             sy, srcInfo-&gt;scanStride);</span>
<span class="line-removed">- </span>
                      while (tmph &gt; 0) {
                          j2d_glTexSubImage2D(GL_TEXTURE_2D, 0,
                                              0, sh - tmph, sw, 1,
                                              pf-&gt;format, pf-&gt;type,
                                              pSrc);
                          pSrc = PtrAddBytes(pSrc, srcInfo-&gt;scanStride);
                          tmph--;
                      }
                  } else {
<span class="line-removed">-                     j2d_glPixelStorei(GL_UNPACK_SKIP_PIXELS, sx);</span>
<span class="line-removed">-                     j2d_glPixelStorei(GL_UNPACK_SKIP_ROWS, sy);</span>
<span class="line-removed">- </span>
                      j2d_glTexSubImage2D(GL_TEXTURE_2D, 0,
                                          0, 0, sw, sh,
                                          pf-&gt;format, pf-&gt;type,
<span class="line-modified">!                                         srcInfo-&gt;rasBase);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                     j2d_glPixelStorei(GL_UNPACK_SKIP_PIXELS, 0);</span>
<span class="line-removed">-                     j2d_glPixelStorei(GL_UNPACK_SKIP_ROWS, 0);</span>
                  }
  
                  // the texture image is &quot;right side up&quot;, so we align the
                  // upper-left texture corner with the upper-left quad corner
                  j2d_glBegin(GL_QUADS);
<span class="line-new-header">--- 316,28 ---</span>
  
              tx2 = ((GLdouble)sw) / tw;
              ty2 = ((GLdouble)sh) / th;
  
              if (swsurface) {
<span class="line-added">+                 GLvoid *pSrc = PtrCoord(srcInfo-&gt;rasBase,</span>
<span class="line-added">+                                         sx, srcInfo-&gt;pixelStride,</span>
<span class="line-added">+                                         sy, srcInfo-&gt;scanStride);</span>
                  if (slowPath) {
                      jint tmph = sh;
                      while (tmph &gt; 0) {
                          j2d_glTexSubImage2D(GL_TEXTURE_2D, 0,
                                              0, sh - tmph, sw, 1,
                                              pf-&gt;format, pf-&gt;type,
                                              pSrc);
                          pSrc = PtrAddBytes(pSrc, srcInfo-&gt;scanStride);
                          tmph--;
                      }
                  } else {
                      j2d_glTexSubImage2D(GL_TEXTURE_2D, 0,
                                          0, 0, sw, sh,
                                          pf-&gt;format, pf-&gt;type,
<span class="line-modified">!                                         pSrc);</span>
                  }
  
                  // the texture image is &quot;right side up&quot;, so we align the
                  // upper-left texture corner with the upper-left quad corner
                  j2d_glBegin(GL_QUADS);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 636,12 ***</span>
              J2dTraceLn4(J2D_TRACE_VERBOSE, &quot;  sx1=%d sy1=%d sx2=%d sy2=%d&quot;,
                          sx1, sy1, sx2, sy2);
              J2dTraceLn4(J2D_TRACE_VERBOSE, &quot;  dx1=%f dy1=%f dx2=%f dy2=%f&quot;,
                          dx1, dy1, dx2, dy2);
  
<span class="line-modified">!             j2d_glPixelStorei(GL_UNPACK_SKIP_PIXELS, sx1);</span>
<span class="line-modified">!             j2d_glPixelStorei(GL_UNPACK_SKIP_ROWS, sy1);</span>
              j2d_glPixelStorei(GL_UNPACK_ROW_LENGTH,
                                srcInfo.scanStride / srcInfo.pixelStride);
              j2d_glPixelStorei(GL_UNPACK_ALIGNMENT, pf.alignment);
  
              if (texture) {
<span class="line-new-header">--- 630,13 ---</span>
              J2dTraceLn4(J2D_TRACE_VERBOSE, &quot;  sx1=%d sy1=%d sx2=%d sy2=%d&quot;,
                          sx1, sy1, sx2, sy2);
              J2dTraceLn4(J2D_TRACE_VERBOSE, &quot;  dx1=%f dy1=%f dx2=%f dy2=%f&quot;,
                          dx1, dy1, dx2, dy2);
  
<span class="line-modified">!             // Note: we will calculate x/y positions in the raster manually</span>
<span class="line-modified">!             j2d_glPixelStorei(GL_UNPACK_SKIP_PIXELS, 0);</span>
<span class="line-added">+             j2d_glPixelStorei(GL_UNPACK_SKIP_ROWS, 0);</span>
              j2d_glPixelStorei(GL_UNPACK_ROW_LENGTH,
                                srcInfo.scanStride / srcInfo.pixelStride);
              j2d_glPixelStorei(GL_UNPACK_ALIGNMENT, pf.alignment);
  
              if (texture) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 694,12 ***</span>
                                         sx1, sy1, sx2, sy2,
                                         dx1, dy1, dx2, dy2);
                  }
              }
  
<span class="line-removed">-             j2d_glPixelStorei(GL_UNPACK_SKIP_PIXELS, 0);</span>
<span class="line-removed">-             j2d_glPixelStorei(GL_UNPACK_SKIP_ROWS, 0);</span>
              j2d_glPixelStorei(GL_UNPACK_ROW_LENGTH, 0);
              j2d_glPixelStorei(GL_UNPACK_ALIGNMENT, 4);
          }
          SurfaceData_InvokeRelease(env, srcOps, &amp;srcInfo);
      }
<span class="line-new-header">--- 689,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 715,12 ***</span>
      void *tempRow = (h &gt; 1 &amp;&amp; !convert) ? malloc(clippedStride) : NULL;
      juint i = 0;
      juint step = 0;
      // vertical flip and convert argbpre to argb if necessary
      for (; i &lt; h / 2; ++i) {
<span class="line-modified">!         juint *r1 = PtrAddBytes(pDst, (i * scanStride));</span>
<span class="line-modified">!         juint *r2 = PtrAddBytes(pDst, (h - i - 1) * scanStride);</span>
          if (tempRow) {
              // fast path
              memcpy(tempRow, r1, clippedStride);
              memcpy(r1, r2, clippedStride);
              memcpy(r2, tempRow, clippedStride);
<span class="line-new-header">--- 708,12 ---</span>
      void *tempRow = (h &gt; 1 &amp;&amp; !convert) ? malloc(clippedStride) : NULL;
      juint i = 0;
      juint step = 0;
      // vertical flip and convert argbpre to argb if necessary
      for (; i &lt; h / 2; ++i) {
<span class="line-modified">!         juint *r1 = PtrPixelsRow(pDst, i, scanStride);</span>
<span class="line-modified">!         juint *r2 = PtrPixelsRow(pDst, h - i - 1, scanStride);</span>
          if (tempRow) {
              // fast path
              memcpy(tempRow, r1, clippedStride);
              memcpy(r1, r2, clippedStride);
              memcpy(r2, tempRow, clippedStride);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 738,11 ***</span>
              }
          }
      }
      // convert the middle line if necessary
      if (convert &amp;&amp; h % 2) {
<span class="line-modified">!         juint *r1 = PtrAddBytes(pDst, (i * scanStride));</span>
          for (step = 0; step &lt; w; ++step) {
              LoadIntArgbPreTo1IntArgb(r1, 0, step, r1[step]);
          }
      }
      if (tempRow) {
<span class="line-new-header">--- 731,11 ---</span>
              }
          }
      }
      // convert the middle line if necessary
      if (convert &amp;&amp; h % 2) {
<span class="line-modified">!         juint *r1 = PtrPixelsRow(pDst, i, scanStride);</span>
          for (step = 0; step &lt; w; ++step) {
              LoadIntArgbPreTo1IntArgb(r1, 0, step, r1[step]);
          }
      }
      if (tempRow) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 811,11 ***</span>
              dsty = dstInfo.bounds.y1;
              width = srcInfo.bounds.x2 - srcInfo.bounds.x1;
              height = srcInfo.bounds.y2 - srcInfo.bounds.y1;
  
              pDst = PtrAddBytes(pDst, dstx * dstInfo.pixelStride);
<span class="line-modified">!             pDst = PtrAddBytes(pDst, dsty * dstInfo.scanStride);</span>
  
              j2d_glPixelStorei(GL_PACK_ROW_LENGTH,
                                dstInfo.scanStride / dstInfo.pixelStride);
              j2d_glPixelStorei(GL_PACK_ALIGNMENT, pf.alignment);
  #ifdef MACOSX
<span class="line-new-header">--- 804,11 ---</span>
              dsty = dstInfo.bounds.y1;
              width = srcInfo.bounds.x2 - srcInfo.bounds.x1;
              height = srcInfo.bounds.y2 - srcInfo.bounds.y1;
  
              pDst = PtrAddBytes(pDst, dstx * dstInfo.pixelStride);
<span class="line-modified">!             pDst = PtrPixelsRow(pDst, dsty, dstInfo.scanStride);</span>
  
              j2d_glPixelStorei(GL_PACK_ROW_LENGTH,
                                dstInfo.scanStride / dstInfo.pixelStride);
              j2d_glPixelStorei(GL_PACK_ALIGNMENT, pf.alignment);
  #ifdef MACOSX
</pre>
<center><a href="J2D_GL/glext.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="OGLRenderQueue.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>