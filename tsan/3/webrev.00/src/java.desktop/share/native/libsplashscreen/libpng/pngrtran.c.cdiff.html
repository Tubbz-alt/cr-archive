<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libsplashscreen/libpng/pngrtran.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="pngrio.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="pngrutil.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libsplashscreen/libpng/pngrtran.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 27,14 ***</span>
   * This file is available under and governed by the GNU General Public
   * License version 2 only, as published by the Free Software Foundation.
   * However, the following notice accompanied the original version of this
   * file and, per its terms, should not be removed:
   *
<span class="line-modified">!  * Last changed in libpng 1.6.35 [July 15, 2018]</span>
   * Copyright (c) 1998-2002,2004,2006-2018 Glenn Randers-Pehrson
<span class="line-modified">!  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)</span>
<span class="line-modified">!  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)</span>
   *
   * This code is released under the libpng license.
   * For conditions of distribution and use, see the disclaimer
   * and license in png.h
   *
<span class="line-new-header">--- 27,14 ---</span>
   * This file is available under and governed by the GNU General Public
   * License version 2 only, as published by the Free Software Foundation.
   * However, the following notice accompanied the original version of this
   * file and, per its terms, should not be removed:
   *
<span class="line-modified">!  * Copyright (c) 2018-2019 Cosmin Truta</span>
   * Copyright (c) 1998-2002,2004,2006-2018 Glenn Randers-Pehrson
<span class="line-modified">!  * Copyright (c) 1996-1997 Andreas Dilger</span>
<span class="line-modified">!  * Copyright (c) 1995-1996 Guy Eric Schalnat, Group 42, Inc.</span>
   *
   * This code is released under the libpng license.
   * For conditions of distribution and use, see the disclaimer
   * and license in png.h
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 44,10 ***</span>
<span class="line-new-header">--- 44,21 ---</span>
   * in pngtrans.c.
   */
  
  #include &quot;pngpriv.h&quot;
  
<span class="line-added">+ #ifdef PNG_ARM_NEON_IMPLEMENTATION</span>
<span class="line-added">+ #  if PNG_ARM_NEON_IMPLEMENTATION == 1</span>
<span class="line-added">+ #    define PNG_ARM_NEON_INTRINSICS_AVAILABLE</span>
<span class="line-added">+ #    if defined(_MSC_VER) &amp;&amp; defined(_M_ARM64)</span>
<span class="line-added">+ #      include &lt;arm64_neon.h&gt;</span>
<span class="line-added">+ #    else</span>
<span class="line-added">+ #      include &lt;arm_neon.h&gt;</span>
<span class="line-added">+ #    endif</span>
<span class="line-added">+ #  endif</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
  #ifdef PNG_READ_SUPPORTED
  
  /* Set the action on getting a CRC error for an ancillary or critical chunk. */
  void PNGAPI
  png_set_crc_action(png_structrp png_ptr, int crit_action, int ancil_action)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1197,24 ***</span>
               png_ptr-&gt;palette[png_ptr-&gt;background.index].green;
           png_ptr-&gt;background.blue  =
               png_ptr-&gt;palette[png_ptr-&gt;background.index].blue;
  
  #ifdef PNG_READ_INVERT_ALPHA_SUPPORTED
<span class="line-modified">!         if ((png_ptr-&gt;transformations &amp; PNG_INVERT_ALPHA) != 0)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!            if ((png_ptr-&gt;transformations &amp; PNG_EXPAND_tRNS) == 0)</span>
<span class="line-modified">!            {</span>
<span class="line-modified">!               /* Invert the alpha channel (in tRNS) unless the pixels are</span>
<span class="line-modified">!                * going to be expanded, in which case leave it for later</span>
<span class="line-modified">!                */</span>
<span class="line-modified">!               int i, istop = png_ptr-&gt;num_trans;</span>
<span class="line-modified">! </span>
<span class="line-modified">!               for (i=0; i&lt;istop; i++)</span>
<span class="line-modified">!                  png_ptr-&gt;trans_alpha[i] = (png_byte)(255 -</span>
<span class="line-modified">!                     png_ptr-&gt;trans_alpha[i]);</span>
<span class="line-modified">!            }</span>
<span class="line-modified">!         }</span>
  #endif /* READ_INVERT_ALPHA */
        }
     } /* background expand and (therefore) no alpha association. */
  #endif /* READ_EXPAND &amp;&amp; READ_BACKGROUND */
  }
<span class="line-new-header">--- 1208,24 ---</span>
               png_ptr-&gt;palette[png_ptr-&gt;background.index].green;
           png_ptr-&gt;background.blue  =
               png_ptr-&gt;palette[png_ptr-&gt;background.index].blue;
  
  #ifdef PNG_READ_INVERT_ALPHA_SUPPORTED
<span class="line-modified">!          if ((png_ptr-&gt;transformations &amp; PNG_INVERT_ALPHA) != 0)</span>
<span class="line-modified">!          {</span>
<span class="line-modified">!             if ((png_ptr-&gt;transformations &amp; PNG_EXPAND_tRNS) == 0)</span>
<span class="line-modified">!             {</span>
<span class="line-modified">!                /* Invert the alpha channel (in tRNS) unless the pixels are</span>
<span class="line-modified">!                 * going to be expanded, in which case leave it for later</span>
<span class="line-modified">!                 */</span>
<span class="line-modified">!                int i, istop = png_ptr-&gt;num_trans;</span>
<span class="line-modified">! </span>
<span class="line-modified">!                for (i = 0; i &lt; istop; i++)</span>
<span class="line-modified">!                   png_ptr-&gt;trans_alpha[i] =</span>
<span class="line-modified">!                       (png_byte)(255 - png_ptr-&gt;trans_alpha[i]);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!          }</span>
  #endif /* READ_INVERT_ALPHA */
        }
     } /* background expand and (therefore) no alpha association. */
  #endif /* READ_EXPAND &amp;&amp; READ_BACKGROUND */
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3012,25 ***</span>
   *  calculated to make the sum 32768.  This will result in different rounding
   *  to that used above.
   */
  static int
  png_do_rgb_to_gray(png_structrp png_ptr, png_row_infop row_info, png_bytep row)
<span class="line-removed">- </span>
  {
     int rgb_error = 0;
  
     png_debug(1, &quot;in png_do_rgb_to_gray&quot;);
  
     if ((row_info-&gt;color_type &amp; PNG_COLOR_MASK_PALETTE) == 0 &amp;&amp;
         (row_info-&gt;color_type &amp; PNG_COLOR_MASK_COLOR) != 0)
     {
<span class="line-modified">!       PNG_CONST png_uint_32 rc = png_ptr-&gt;rgb_to_gray_red_coeff;</span>
<span class="line-modified">!       PNG_CONST png_uint_32 gc = png_ptr-&gt;rgb_to_gray_green_coeff;</span>
<span class="line-modified">!       PNG_CONST png_uint_32 bc = 32768 - rc - gc;</span>
<span class="line-modified">!       PNG_CONST png_uint_32 row_width = row_info-&gt;width;</span>
<span class="line-modified">!       PNG_CONST int have_alpha =</span>
<span class="line-removed">-          (row_info-&gt;color_type &amp; PNG_COLOR_MASK_ALPHA) != 0;</span>
  
        if (row_info-&gt;bit_depth == 8)
        {
  #ifdef PNG_READ_GAMMA_SUPPORTED
           /* Notice that gamma to/from 1 are not necessarily inverses (if
<span class="line-new-header">--- 3023,23 ---</span>
   *  calculated to make the sum 32768.  This will result in different rounding
   *  to that used above.
   */
  static int
  png_do_rgb_to_gray(png_structrp png_ptr, png_row_infop row_info, png_bytep row)
  {
     int rgb_error = 0;
  
     png_debug(1, &quot;in png_do_rgb_to_gray&quot;);
  
     if ((row_info-&gt;color_type &amp; PNG_COLOR_MASK_PALETTE) == 0 &amp;&amp;
         (row_info-&gt;color_type &amp; PNG_COLOR_MASK_COLOR) != 0)
     {
<span class="line-modified">!       png_uint_32 rc = png_ptr-&gt;rgb_to_gray_red_coeff;</span>
<span class="line-modified">!       png_uint_32 gc = png_ptr-&gt;rgb_to_gray_green_coeff;</span>
<span class="line-modified">!       png_uint_32 bc = 32768 - rc - gc;</span>
<span class="line-modified">!       png_uint_32 row_width = row_info-&gt;width;</span>
<span class="line-modified">!       int have_alpha = (row_info-&gt;color_type &amp; PNG_COLOR_MASK_ALPHA) != 0;</span>
  
        if (row_info-&gt;bit_depth == 8)
        {
  #ifdef PNG_READ_GAMMA_SUPPORTED
           /* Notice that gamma to/from 1 are not necessarily inverses (if
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4169,16 ***</span>
  
     if ((row_info-&gt;color_type &amp; PNG_COLOR_MASK_ALPHA) != 0)
     {
        if (row_info-&gt;bit_depth == 8)
        {
<span class="line-modified">!          PNG_CONST png_bytep table = png_ptr-&gt;gamma_from_1;</span>
  
           if (table != NULL)
           {
<span class="line-modified">!             PNG_CONST int step =</span>
<span class="line-removed">-                (row_info-&gt;color_type &amp; PNG_COLOR_MASK_COLOR) ? 4 : 2;</span>
  
              /* The alpha channel is the last component: */
              row += step - 1;
  
              for (; row_width &gt; 0; --row_width, row += step)
<span class="line-new-header">--- 4178,15 ---</span>
  
     if ((row_info-&gt;color_type &amp; PNG_COLOR_MASK_ALPHA) != 0)
     {
        if (row_info-&gt;bit_depth == 8)
        {
<span class="line-modified">!          png_bytep table = png_ptr-&gt;gamma_from_1;</span>
  
           if (table != NULL)
           {
<span class="line-modified">!             int step = (row_info-&gt;color_type &amp; PNG_COLOR_MASK_COLOR) ? 4 : 2;</span>
  
              /* The alpha channel is the last component: */
              row += step - 1;
  
              for (; row_width &gt; 0; --row_width, row += step)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4188,17 ***</span>
           }
        }
  
        else if (row_info-&gt;bit_depth == 16)
        {
<span class="line-modified">!          PNG_CONST png_uint_16pp table = png_ptr-&gt;gamma_16_from_1;</span>
<span class="line-modified">!          PNG_CONST int gamma_shift = png_ptr-&gt;gamma_shift;</span>
  
           if (table != NULL)
           {
<span class="line-modified">!             PNG_CONST int step =</span>
<span class="line-removed">-                (row_info-&gt;color_type &amp; PNG_COLOR_MASK_COLOR) ? 8 : 4;</span>
  
              /* The alpha channel is the last component: */
              row += step - 2;
  
              for (; row_width &gt; 0; --row_width, row += step)
<span class="line-new-header">--- 4196,16 ---</span>
           }
        }
  
        else if (row_info-&gt;bit_depth == 16)
        {
<span class="line-modified">!          png_uint_16pp table = png_ptr-&gt;gamma_16_from_1;</span>
<span class="line-modified">!          int gamma_shift = png_ptr-&gt;gamma_shift;</span>
  
           if (table != NULL)
           {
<span class="line-modified">!             int step = (row_info-&gt;color_type &amp; PNG_COLOR_MASK_COLOR) ? 8 : 4;</span>
  
              /* The alpha channel is the last component: */
              row += step - 2;
  
              for (; row_width &gt; 0; --row_width, row += step)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4225,12 ***</span>
  #ifdef PNG_READ_EXPAND_SUPPORTED
  /* Expands a palette row to an RGB or RGBA row depending
   * upon whether you supply trans and num_trans.
   */
  static void
<span class="line-modified">! png_do_expand_palette(png_row_infop row_info, png_bytep row,</span>
<span class="line-modified">!     png_const_colorp palette, png_const_bytep trans_alpha, int num_trans)</span>
  {
     int shift, value;
     png_bytep sp, dp;
     png_uint_32 i;
     png_uint_32 row_width=row_info-&gt;width;
<span class="line-new-header">--- 4232,13 ---</span>
  #ifdef PNG_READ_EXPAND_SUPPORTED
  /* Expands a palette row to an RGB or RGBA row depending
   * upon whether you supply trans and num_trans.
   */
  static void
<span class="line-modified">! png_do_expand_palette(png_structrp png_ptr, png_row_infop row_info,</span>
<span class="line-modified">!     png_bytep row, png_const_colorp palette, png_const_bytep trans_alpha,</span>
<span class="line-added">+     int num_trans)</span>
  {
     int shift, value;
     png_bytep sp, dp;
     png_uint_32 i;
     png_uint_32 row_width=row_info-&gt;width;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4330,18 ***</span>
              if (num_trans &gt; 0)
              {
                 sp = row + (size_t)row_width - 1;
                 dp = row + ((size_t)row_width &lt;&lt; 2) - 1;
  
<span class="line-modified">!                for (i = 0; i &lt; row_width; i++)</span>
                 {
                    if ((int)(*sp) &gt;= num_trans)
                       *dp-- = 0xff;
<span class="line-removed">- </span>
                    else
                       *dp-- = trans_alpha[*sp];
<span class="line-removed">- </span>
                    *dp-- = palette[*sp].blue;
                    *dp-- = palette[*sp].green;
                    *dp-- = palette[*sp].red;
                    sp--;
                 }
<span class="line-new-header">--- 4338,31 ---</span>
              if (num_trans &gt; 0)
              {
                 sp = row + (size_t)row_width - 1;
                 dp = row + ((size_t)row_width &lt;&lt; 2) - 1;
  
<span class="line-modified">!                i = 0;</span>
<span class="line-added">+ #ifdef PNG_ARM_NEON_INTRINSICS_AVAILABLE</span>
<span class="line-added">+                if (png_ptr-&gt;riffled_palette != NULL)</span>
<span class="line-added">+                {</span>
<span class="line-added">+                   /* The RGBA optimization works with png_ptr-&gt;bit_depth == 8</span>
<span class="line-added">+                    * but sometimes row_info-&gt;bit_depth has been changed to 8.</span>
<span class="line-added">+                    * In these cases, the palette hasn&#39;t been riffled.</span>
<span class="line-added">+                    */</span>
<span class="line-added">+                   i = png_do_expand_palette_rgba8_neon(png_ptr, row_info, row,</span>
<span class="line-added">+                       &amp;sp, &amp;dp);</span>
<span class="line-added">+                }</span>
<span class="line-added">+ #else</span>
<span class="line-added">+                PNG_UNUSED(png_ptr)</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
<span class="line-added">+                for (; i &lt; row_width; i++)</span>
                 {
                    if ((int)(*sp) &gt;= num_trans)
                       *dp-- = 0xff;
                    else
                       *dp-- = trans_alpha[*sp];
                    *dp-- = palette[*sp].blue;
                    *dp-- = palette[*sp].green;
                    *dp-- = palette[*sp].red;
                    sp--;
                 }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4354,12 ***</span>
  
              else
              {
                 sp = row + (size_t)row_width - 1;
                 dp = row + (size_t)(row_width * 3) - 1;
  
<span class="line-modified">!                for (i = 0; i &lt; row_width; i++)</span>
                 {
                    *dp-- = palette[*sp].blue;
                    *dp-- = palette[*sp].green;
                    *dp-- = palette[*sp].red;
                    sp--;
<span class="line-new-header">--- 4375,19 ---</span>
  
              else
              {
                 sp = row + (size_t)row_width - 1;
                 dp = row + (size_t)(row_width * 3) - 1;
<span class="line-added">+                i = 0;</span>
<span class="line-added">+ #ifdef PNG_ARM_NEON_INTRINSICS_AVAILABLE</span>
<span class="line-added">+                i = png_do_expand_palette_rgb8_neon(png_ptr, row_info, row,</span>
<span class="line-added">+                    &amp;sp, &amp;dp);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+                PNG_UNUSED(png_ptr)</span>
<span class="line-added">+ #endif</span>
  
<span class="line-modified">!                for (; i &lt; row_width; i++)</span>
                 {
                    *dp-- = palette[*sp].blue;
                    *dp-- = palette[*sp].green;
                    *dp-- = palette[*sp].red;
                    sp--;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 4769,11 ***</span>
  #ifdef PNG_READ_EXPAND_SUPPORTED
     if ((png_ptr-&gt;transformations &amp; PNG_EXPAND) != 0)
     {
        if (row_info-&gt;color_type == PNG_COLOR_TYPE_PALETTE)
        {
<span class="line-modified">!          png_do_expand_palette(row_info, png_ptr-&gt;row_buf + 1,</span>
               png_ptr-&gt;palette, png_ptr-&gt;trans_alpha, png_ptr-&gt;num_trans);
        }
  
        else
        {
<span class="line-new-header">--- 4797,23 ---</span>
  #ifdef PNG_READ_EXPAND_SUPPORTED
     if ((png_ptr-&gt;transformations &amp; PNG_EXPAND) != 0)
     {
        if (row_info-&gt;color_type == PNG_COLOR_TYPE_PALETTE)
        {
<span class="line-modified">! #ifdef PNG_ARM_NEON_INTRINSICS_AVAILABLE</span>
<span class="line-added">+          if ((png_ptr-&gt;num_trans &gt; 0) &amp;&amp; (png_ptr-&gt;bit_depth == 8))</span>
<span class="line-added">+          {</span>
<span class="line-added">+             if (png_ptr-&gt;riffled_palette == NULL)</span>
<span class="line-added">+             {</span>
<span class="line-added">+                /* Initialize the accelerated palette expansion. */</span>
<span class="line-added">+                png_ptr-&gt;riffled_palette =</span>
<span class="line-added">+                    (png_bytep)png_malloc(png_ptr, 256 * 4);</span>
<span class="line-added">+                png_riffle_palette_neon(png_ptr);</span>
<span class="line-added">+             }</span>
<span class="line-added">+          }</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+          png_do_expand_palette(png_ptr, row_info, png_ptr-&gt;row_buf + 1,</span>
               png_ptr-&gt;palette, png_ptr-&gt;trans_alpha, png_ptr-&gt;num_trans);
        }
  
        else
        {
</pre>
<center><a href="pngrio.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="pngrutil.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>