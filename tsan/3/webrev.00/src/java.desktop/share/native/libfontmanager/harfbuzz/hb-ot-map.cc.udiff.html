<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-map.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-layout.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-maxp-table.hh.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-map.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,18 +24,18 @@</span>
   *
   * Red Hat Author(s): Behdad Esfahbod
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="udiff-line-modified-removed">- #include &quot;hb-ot-map-private.hh&quot;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">- #include &quot;hb-ot-layout-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-ot-map.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-ot-shape.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-ot-layout.hh&quot;</span>
  
  
  void hb_ot_map_t::collect_lookups (unsigned int table_index, hb_set_t *lookups_out) const
  {
<span class="udiff-line-modified-removed">-   for (unsigned int i = 0; i &lt; lookups[table_index].len; i++)</span>
<span class="udiff-line-modified-added">+   for (unsigned int i = 0; i &lt; lookups[table_index].length; i++)</span>
      hb_set_add (lookups_out, lookups[table_index][i].index);
  }
  
  
  hb_ot_map_builder_t::hb_ot_map_builder_t (hb_face_t *face_,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -52,37 +52,39 @@</span>
  
  
    /* Fetch script/language indices for GSUB/GPOS.  We need these later to skip
     * features not available in either table and not waste precious bits for them. */
  
<span class="udiff-line-modified-removed">-   hb_tag_t script_tags[3] = {HB_TAG_NONE, HB_TAG_NONE, HB_TAG_NONE};</span>
<span class="udiff-line-modified-removed">-   hb_tag_t language_tag;</span>
<span class="udiff-line-modified-added">+   unsigned int script_count = HB_OT_MAX_TAGS_PER_SCRIPT;</span>
<span class="udiff-line-modified-added">+   unsigned int language_count = HB_OT_MAX_TAGS_PER_LANGUAGE;</span>
<span class="udiff-line-added">+   hb_tag_t script_tags[HB_OT_MAX_TAGS_PER_SCRIPT];</span>
<span class="udiff-line-added">+   hb_tag_t language_tags[HB_OT_MAX_TAGS_PER_LANGUAGE];</span>
  
<span class="udiff-line-modified-removed">-   hb_ot_tags_from_script (props.script, &amp;script_tags[0], &amp;script_tags[1]);</span>
<span class="udiff-line-removed">-   language_tag = hb_ot_tag_from_language (props.language);</span>
<span class="udiff-line-modified-added">+   hb_ot_tags_from_script_and_language (props.script, props.language, &amp;script_count, script_tags, &amp;language_count, language_tags);</span>
  
    for (unsigned int table_index = 0; table_index &lt; 2; table_index++) {
      hb_tag_t table_tag = table_tags[table_index];
<span class="udiff-line-modified-removed">-     found_script[table_index] = (bool) hb_ot_layout_table_choose_script (face, table_tag, script_tags, &amp;script_index[table_index], &amp;chosen_script[table_index]);</span>
<span class="udiff-line-modified-removed">-     hb_ot_layout_script_find_language (face, table_tag, script_index[table_index], language_tag, &amp;language_index[table_index]);</span>
<span class="udiff-line-modified-added">+     found_script[table_index] = (bool) hb_ot_layout_table_select_script (face, table_tag, script_count, script_tags, &amp;script_index[table_index], &amp;chosen_script[table_index]);</span>
<span class="udiff-line-modified-added">+     hb_ot_layout_script_select_language (face, table_tag, script_index[table_index], language_count, language_tags, &amp;language_index[table_index]);</span>
    }
  }
  
<span class="udiff-line-modified-removed">- hb_ot_map_builder_t::~hb_ot_map_builder_t (void)</span>
<span class="udiff-line-modified-added">+ hb_ot_map_builder_t::~hb_ot_map_builder_t ()</span>
  {
    feature_infos.fini ();
    for (unsigned int table_index = 0; table_index &lt; 2; table_index++)
      stages[table_index].fini ();
  }
  
<span class="udiff-line-modified-removed">- void hb_ot_map_builder_t::add_feature (hb_tag_t tag, unsigned int value,</span>
<span class="udiff-line-modified-removed">-                                        hb_ot_map_feature_flags_t flags)</span>
<span class="udiff-line-modified-added">+ void hb_ot_map_builder_t::add_feature (hb_tag_t tag,</span>
<span class="udiff-line-modified-added">+                                        hb_ot_map_feature_flags_t flags,</span>
<span class="udiff-line-added">+                                        unsigned int value)</span>
  {
<span class="udiff-line-removed">-   feature_info_t *info = feature_infos.push();</span>
    if (unlikely (!tag)) return;
<span class="udiff-line-added">+   feature_info_t *info = feature_infos.push();</span>
    info-&gt;tag = tag;
<span class="udiff-line-modified-removed">-   info-&gt;seq = feature_infos.len;</span>
<span class="udiff-line-modified-added">+   info-&gt;seq = feature_infos.length;</span>
    info-&gt;max_value = value;
    info-&gt;flags = flags;
    info-&gt;default_value = (flags &amp; F_GLOBAL) ? value : 0;
    info-&gt;stage[0] = current_stage[0];
    info-&gt;stage[1] = current_stage[1];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -93,11 +95,12 @@</span>
                                    unsigned int  table_index,
                                    unsigned int  feature_index,
                                    unsigned int  variations_index,
                                    hb_mask_t     mask,
                                    bool          auto_zwnj,
<span class="udiff-line-modified-removed">-                                   bool          auto_zwj)</span>
<span class="udiff-line-modified-added">+                                   bool          auto_zwj,</span>
<span class="udiff-line-added">+                                   bool          random)</span>
  {
    unsigned int lookup_indices[32];
    unsigned int offset, len;
    unsigned int table_lookup_count;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -120,10 +123,11 @@</span>
        hb_ot_map_t::lookup_map_t *lookup = m.lookups[table_index].push ();
        lookup-&gt;mask = mask;
        lookup-&gt;index = lookup_indices[i];
        lookup-&gt;auto_zwnj = auto_zwnj;
        lookup-&gt;auto_zwj = auto_zwj;
<span class="udiff-line-added">+       lookup-&gt;random = random;</span>
      }
  
      offset += len;
    } while (len == ARRAY_LENGTH (lookup_indices));
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -137,17 +141,16 @@</span>
  
    current_stage[table_index]++;
  }
  
  void
<span class="udiff-line-modified-removed">- hb_ot_map_builder_t::compile (hb_ot_map_t  &amp;m,</span>
<span class="udiff-line-modified-removed">-                               const int    *coords,</span>
<span class="udiff-line-removed">-                               unsigned int  num_coords)</span>
<span class="udiff-line-modified-added">+ hb_ot_map_builder_t::compile (hb_ot_map_t                  &amp;m,</span>
<span class="udiff-line-modified-added">+                               const hb_ot_shape_plan_key_t &amp;key)</span>
  {
    static_assert ((!(HB_GLYPH_FLAG_DEFINED &amp; (HB_GLYPH_FLAG_DEFINED + 1))), &quot;&quot;);
    unsigned int global_bit_mask = HB_GLYPH_FLAG_DEFINED + 1;
<span class="udiff-line-modified-removed">-   unsigned int global_bit_shift = _hb_popcount (HB_GLYPH_FLAG_DEFINED);</span>
<span class="udiff-line-modified-added">+   unsigned int global_bit_shift = hb_popcount (HB_GLYPH_FLAG_DEFINED);</span>
  
    m.global_mask = global_bit_mask;
  
    unsigned int required_feature_index[2];
    hb_tag_t required_feature_tag[2];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -169,14 +172,15 @@</span>
                                                  &amp;required_feature_index[table_index],
                                                  &amp;required_feature_tag[table_index]);
    }
  
    /* Sort features and merge duplicates */
<span class="udiff-line-added">+   if (feature_infos.length)</span>
    {
      feature_infos.qsort ();
      unsigned int j = 0;
<span class="udiff-line-modified-removed">-     for (unsigned int i = 1; i &lt; feature_infos.len; i++)</span>
<span class="udiff-line-modified-added">+     for (unsigned int i = 1; i &lt; feature_infos.length; i++)</span>
        if (feature_infos[i].tag != feature_infos[j].tag)
          feature_infos[++j] = feature_infos[i];
        else {
          if (feature_infos[i].flags &amp; F_GLOBAL) {
            feature_infos[j].flags |= F_GLOBAL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -196,22 +200,22 @@</span>
  
  
    /* Allocate bits now */
    unsigned int next_bit = global_bit_shift + 1;
  
<span class="udiff-line-modified-removed">-   for (unsigned int i = 0; i &lt; feature_infos.len; i++)</span>
<span class="udiff-line-modified-added">+   for (unsigned int i = 0; i &lt; feature_infos.length; i++)</span>
    {
      const feature_info_t *info = &amp;feature_infos[i];
  
      unsigned int bits_needed;
  
      if ((info-&gt;flags &amp; F_GLOBAL) &amp;&amp; info-&gt;max_value == 1)
        /* Uses the global bit */
        bits_needed = 0;
      else
<span class="udiff-line-modified-removed">-       /* Limit to 8 bits per feature. */</span>
<span class="udiff-line-modified-removed">-       bits_needed = MIN(8u, _hb_bit_storage (info-&gt;max_value));</span>
<span class="udiff-line-modified-added">+       /* Limit bits per feature. */</span>
<span class="udiff-line-modified-added">+       bits_needed = MIN(HB_OT_MAP_MAX_BITS, hb_bit_storage (info-&gt;max_value));</span>
  
      if (!info-&gt;max_value || next_bit + bits_needed &gt; 8 * sizeof (hb_mask_t))
        continue; /* Feature disabled, or not enough bits. */
  
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -250,10 +254,11 @@</span>
      map-&gt;index[1] = feature_index[1];
      map-&gt;stage[0] = info-&gt;stage[0];
      map-&gt;stage[1] = info-&gt;stage[1];
      map-&gt;auto_zwnj = !(info-&gt;flags &amp; F_MANUAL_ZWNJ);
      map-&gt;auto_zwj = !(info-&gt;flags &amp; F_MANUAL_ZWJ);
<span class="udiff-line-added">+     map-&gt;random = !!(info-&gt;flags &amp; F_RANDOM);</span>
      if ((info-&gt;flags &amp; F_GLOBAL) &amp;&amp; info-&gt;max_value == 1) {
        /* Uses the global bit */
        map-&gt;shift = global_bit_shift;
        map-&gt;mask = global_bit_mask;
      } else {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -274,44 +279,38 @@</span>
  
    for (unsigned int table_index = 0; table_index &lt; 2; table_index++)
    {
      /* Collect lookup indices for features */
  
<span class="udiff-line-removed">-     unsigned int variations_index;</span>
<span class="udiff-line-removed">-     hb_ot_layout_table_find_feature_variations (face,</span>
<span class="udiff-line-removed">-                                                 table_tags[table_index],</span>
<span class="udiff-line-removed">-                                                 coords,</span>
<span class="udiff-line-removed">-                                                 num_coords,</span>
<span class="udiff-line-removed">-                                                 &amp;variations_index);</span>
<span class="udiff-line-removed">- </span>
      unsigned int stage_index = 0;
      unsigned int last_num_lookups = 0;
      for (unsigned stage = 0; stage &lt; current_stage[table_index]; stage++)
      {
        if (required_feature_index[table_index] != HB_OT_LAYOUT_NO_FEATURE_INDEX &amp;&amp;
            required_feature_stage[table_index] == stage)
          add_lookups (m, table_index,
                       required_feature_index[table_index],
<span class="udiff-line-modified-removed">-                      variations_index,</span>
<span class="udiff-line-modified-added">+                      key.variations_index[table_index],</span>
                       global_bit_mask);
  
<span class="udiff-line-modified-removed">-       for (unsigned i = 0; i &lt; m.features.len; i++)</span>
<span class="udiff-line-modified-added">+       for (unsigned i = 0; i &lt; m.features.length; i++)</span>
          if (m.features[i].stage[table_index] == stage)
            add_lookups (m, table_index,
                         m.features[i].index[table_index],
<span class="udiff-line-modified-removed">-                        variations_index,</span>
<span class="udiff-line-modified-added">+                        key.variations_index[table_index],</span>
                         m.features[i].mask,
                         m.features[i].auto_zwnj,
<span class="udiff-line-modified-removed">-                        m.features[i].auto_zwj);</span>
<span class="udiff-line-modified-added">+                        m.features[i].auto_zwj,</span>
<span class="udiff-line-added">+                        m.features[i].random);</span>
  
        /* Sort lookups and merge duplicates */
<span class="udiff-line-modified-removed">-       if (last_num_lookups &lt; m.lookups[table_index].len)</span>
<span class="udiff-line-modified-added">+       if (last_num_lookups &lt; m.lookups[table_index].length)</span>
        {
<span class="udiff-line-modified-removed">-         m.lookups[table_index].qsort (last_num_lookups, m.lookups[table_index].len);</span>
<span class="udiff-line-modified-added">+         m.lookups[table_index].qsort (last_num_lookups, m.lookups[table_index].length);</span>
  
          unsigned int j = last_num_lookups;
<span class="udiff-line-modified-removed">-         for (unsigned int i = j + 1; i &lt; m.lookups[table_index].len; i++)</span>
<span class="udiff-line-modified-added">+         for (unsigned int i = j + 1; i &lt; m.lookups[table_index].length; i++)</span>
            if (m.lookups[table_index][i].index != m.lookups[table_index][j].index)
              m.lookups[table_index][++j] = m.lookups[table_index][i];
            else
            {
              m.lookups[table_index][j].mask |= m.lookups[table_index][i].mask;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -319,13 +318,13 @@</span>
              m.lookups[table_index][j].auto_zwj &amp;= m.lookups[table_index][i].auto_zwj;
            }
          m.lookups[table_index].shrink (j + 1);
        }
  
<span class="udiff-line-modified-removed">-       last_num_lookups = m.lookups[table_index].len;</span>
<span class="udiff-line-modified-added">+       last_num_lookups = m.lookups[table_index].length;</span>
  
<span class="udiff-line-modified-removed">-       if (stage_index &lt; stages[table_index].len &amp;&amp; stages[table_index][stage_index].index == stage) {</span>
<span class="udiff-line-modified-added">+       if (stage_index &lt; stages[table_index].length &amp;&amp; stages[table_index][stage_index].index == stage) {</span>
          hb_ot_map_t::stage_map_t *stage_map = m.stages[table_index].push ();
          stage_map-&gt;last_lookup = last_num_lookups;
          stage_map-&gt;pause_func = stages[table_index][stage_index].pause_func;
  
          stage_index++;
</pre>
<center><a href="hb-ot-layout.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-maxp-table.hh.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>