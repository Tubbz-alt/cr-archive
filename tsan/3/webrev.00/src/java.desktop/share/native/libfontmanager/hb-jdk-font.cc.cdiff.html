<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfontmanager/hb-jdk-font.cc</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="harfbuzz/hb.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="hb-jdk.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/hb-jdk-font.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 21,10 ***</span>
<span class="line-new-header">--- 21,13 ---</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-added">+ #include &quot;jlong.h&quot;</span>
<span class="line-added">+ #include &quot;sun_font_SunLayoutEngine.h&quot;</span>
<span class="line-added">+ </span>
  #include &quot;hb.h&quot;
  #include &quot;hb-jdk.h&quot;
  #ifdef MACOSX
  #include &quot;hb-coretext.h&quot;
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 34,30 ***</span>
  #define HB_UNUSED       __attribute__((unused))
  #else
  #define HB_UNUSED
  #endif
  
  static hb_bool_t
<span class="line-modified">! hb_jdk_get_glyph (hb_font_t *font HB_UNUSED,</span>
  		 void *font_data,
  		 hb_codepoint_t unicode,
  		 hb_codepoint_t variation_selector,
  		 hb_codepoint_t *glyph,
  		 void *user_data HB_UNUSED)
  {
  
      JDKFontInfo *jdkFontInfo = (JDKFontInfo*)font_data;
      JNIEnv* env = jdkFontInfo-&gt;env;
      jobject font2D = jdkFontInfo-&gt;font2D;
<span class="line-modified">!     if (variation_selector == 0) {</span>
<span class="line-modified">!         *glyph = (hb_codepoint_t)env-&gt;CallIntMethod(</span>
<span class="line-modified">!                      font2D, sunFontIDs.f2dCharToGlyphMID, unicode);</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         *glyph = (hb_codepoint_t)env-&gt;CallIntMethod(</span>
<span class="line-removed">-                      font2D, sunFontIDs.f2dCharToVariationGlyphMID, </span>
<span class="line-removed">-                      unicode, variation_selector);</span>
<span class="line-removed">-     }</span>
      if (env-&gt;ExceptionOccurred())
      {
          env-&gt;ExceptionClear();
      }
      if ((int)*glyph &lt; 0) {
<span class="line-new-header">--- 37,49 ---</span>
  #define HB_UNUSED       __attribute__((unused))
  #else
  #define HB_UNUSED
  #endif
  
<span class="line-added">+ </span>
  static hb_bool_t
<span class="line-modified">! hb_jdk_get_nominal_glyph (hb_font_t *font HB_UNUSED,</span>
<span class="line-added">+ 		          void *font_data,</span>
<span class="line-added">+ 		          hb_codepoint_t unicode,</span>
<span class="line-added">+ 		          hb_codepoint_t *glyph,</span>
<span class="line-added">+ 		          void *user_data HB_UNUSED)</span>
<span class="line-added">+ {</span>
<span class="line-added">+ </span>
<span class="line-added">+     JDKFontInfo *jdkFontInfo = (JDKFontInfo*)font_data;</span>
<span class="line-added">+     JNIEnv* env = jdkFontInfo-&gt;env;</span>
<span class="line-added">+     jobject font2D = jdkFontInfo-&gt;font2D;</span>
<span class="line-added">+     *glyph = (hb_codepoint_t)env-&gt;CallIntMethod(</span>
<span class="line-added">+               font2D, sunFontIDs.f2dCharToGlyphMID, unicode);</span>
<span class="line-added">+     if (env-&gt;ExceptionOccurred())</span>
<span class="line-added">+     {</span>
<span class="line-added">+         env-&gt;ExceptionClear();</span>
<span class="line-added">+     }</span>
<span class="line-added">+     if ((int)*glyph &lt; 0) {</span>
<span class="line-added">+         *glyph = 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return (*glyph != 0);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static hb_bool_t</span>
<span class="line-added">+ hb_jdk_get_variation_glyph (hb_font_t *font HB_UNUSED,</span>
  		 void *font_data,
  		 hb_codepoint_t unicode,
  		 hb_codepoint_t variation_selector,
  		 hb_codepoint_t *glyph,
  		 void *user_data HB_UNUSED)
  {
  
      JDKFontInfo *jdkFontInfo = (JDKFontInfo*)font_data;
      JNIEnv* env = jdkFontInfo-&gt;env;
      jobject font2D = jdkFontInfo-&gt;font2D;
<span class="line-modified">!     *glyph = (hb_codepoint_t)env-&gt;CallIntMethod(</span>
<span class="line-modified">!               font2D, sunFontIDs.f2dCharToVariationGlyphMID, </span>
<span class="line-modified">!               unicode, variation_selector);</span>
      if (env-&gt;ExceptionOccurred())
      {
          env-&gt;ExceptionClear();
      }
      if ((int)*glyph &lt; 0) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 249,11 ***</span>
    hb_font_funcs_t *ff;
  
    if (!jdk_ffuncs) {
        ff = hb_font_funcs_create();
  
<span class="line-modified">!       hb_font_funcs_set_glyph_func(ff, hb_jdk_get_glyph, NULL, NULL);</span>
        hb_font_funcs_set_glyph_h_advance_func(ff,
                      hb_jdk_get_glyph_h_advance, NULL, NULL);
        hb_font_funcs_set_glyph_v_advance_func(ff,
                      hb_jdk_get_glyph_v_advance, NULL, NULL);
        hb_font_funcs_set_glyph_h_origin_func(ff,
<span class="line-new-header">--- 271,12 ---</span>
    hb_font_funcs_t *ff;
  
    if (!jdk_ffuncs) {
        ff = hb_font_funcs_create();
  
<span class="line-modified">!       hb_font_funcs_set_nominal_glyph_func(ff, hb_jdk_get_nominal_glyph, NULL, NULL);</span>
<span class="line-added">+       hb_font_funcs_set_variation_glyph_func(ff, hb_jdk_get_variation_glyph, NULL, NULL);</span>
        hb_font_funcs_set_glyph_h_advance_func(ff,
                      hb_jdk_get_glyph_h_advance, NULL, NULL);
        hb_font_funcs_set_glyph_v_advance_func(ff,
                      hb_jdk_get_glyph_v_advance, NULL, NULL);
        hb_font_funcs_set_glyph_h_origin_func(ff,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 282,121 ***</span>
  }
  
  static void _free_nothing(void*) {
  }
  
  static hb_blob_t *
  reference_table(hb_face_t *face HB_UNUSED, hb_tag_t tag, void *user_data) {
  
<span class="line-modified">!   JDKFontInfo *jdkFontInfo = (JDKFontInfo*)user_data;</span>
<span class="line-modified">!   JNIEnv* env = jdkFontInfo-&gt;env;</span>
<span class="line-modified">!   jobject font2D = jdkFontInfo-&gt;font2D;</span>
<span class="line-modified">!   jsize length = 0;</span>
<span class="line-modified">!   void* buffer = NULL;</span>
<span class="line-removed">-   int cacheIdx = 0;</span>
  
    // HB_TAG_NONE is 0 and is used to get the whole font file.
    // It is not expected to be needed for JDK.
<span class="line-modified">!   if (tag == 0 || jdkFontInfo-&gt;layoutTables == NULL) {</span>
        return NULL;
    }
  
<span class="line-modified">!   for (cacheIdx=0; cacheIdx&lt;LAYOUTCACHE_ENTRIES; cacheIdx++) {</span>
<span class="line-modified">!     if (tag == jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].tag) break;</span>
    }
  
<span class="line-modified">!   if (cacheIdx &lt; LAYOUTCACHE_ENTRIES) { // if found</span>
<span class="line-modified">!       if (jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].len != -1) {</span>
<span class="line-modified">!           length = jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].len;</span>
<span class="line-modified">!           buffer = (void*)jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].ptr;</span>
<span class="line-removed">-       }</span>
    }
<span class="line-modified">! </span>
    if (buffer == NULL) {
<span class="line-modified">!       jbyteArray tableBytes = (jbyteArray)</span>
<span class="line-removed">-          env-&gt;CallObjectMethod(font2D, sunFontIDs.getTableBytesMID, tag);</span>
<span class="line-removed">-       if (tableBytes == NULL) {</span>
<span class="line-removed">-           return NULL;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-       length = env-&gt;GetArrayLength(tableBytes);</span>
<span class="line-removed">-       buffer = calloc(length, sizeof(jbyte));</span>
<span class="line-removed">-       env-&gt;GetByteArrayRegion(tableBytes, 0, length, (jbyte*)buffer);</span>
<span class="line-removed">- </span>
<span class="line-removed">-      if (cacheIdx &gt;= LAYOUTCACHE_ENTRIES) { // not a cacheable table</span>
<span class="line-removed">-           return hb_blob_create((const char *)buffer, length,</span>
<span class="line-removed">-                                  HB_MEMORY_MODE_WRITABLE,</span>
<span class="line-removed">-                                  buffer, free);</span>
<span class="line-removed">-       } else {</span>
<span class="line-removed">-         jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].len = length;</span>
<span class="line-removed">-         jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].ptr = buffer;</span>
<span class="line-removed">-       }</span>
    }
  
    return hb_blob_create((const char *)buffer, length,
<span class="line-modified">!                          HB_MEMORY_MODE_READONLY,</span>
<span class="line-modified">!                          NULL, _free_nothing);</span>
  }
  
  
  
<span class="line-modified">! hb_face_t*</span>
<span class="line-modified">! hb_jdk_face_create(JDKFontInfo *jdkFontInfo,</span>
<span class="line-modified">!                    hb_destroy_func_t destroy) {</span>
<span class="line-modified">! </span>
<span class="line-modified">!     hb_face_t *face =</span>
<span class="line-modified">!          hb_face_create_for_tables(reference_table, jdkFontInfo, destroy);</span>
<span class="line-modified">! </span>
<span class="line-modified">!     return face;</span>
  }
  
<span class="line-modified">! static hb_font_t* _hb_jdk_font_create(JDKFontInfo *jdkFontInfo,</span>
                                        hb_destroy_func_t destroy) {
  
      hb_font_t *font;
<span class="line-removed">-     hb_face_t *face;</span>
  
<span class="line-removed">-     face = hb_jdk_face_create(jdkFontInfo, destroy);</span>
      font = hb_font_create(face);
<span class="line-removed">-     hb_face_destroy (face);</span>
      hb_font_set_funcs (font,
                         _hb_jdk_get_font_funcs (),
                         jdkFontInfo, (hb_destroy_func_t) _do_nothing);
      hb_font_set_scale (font,
                        HBFloatToFixed(jdkFontInfo-&gt;ptSize*jdkFontInfo-&gt;devScale),
                        HBFloatToFixed(jdkFontInfo-&gt;ptSize*jdkFontInfo-&gt;devScale));
    return font;
  }
  
  #ifdef MACOSX
<span class="line-modified">! static hb_font_t* _hb_jdk_ct_font_create(JDKFontInfo *jdkFontInfo) {</span>
  
      hb_font_t *font = NULL;
<span class="line-removed">-     hb_face_t *face = NULL;</span>
<span class="line-removed">-     if (jdkFontInfo-&gt;nativeFont == 0) {</span>
<span class="line-removed">-         return NULL;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     face = hb_coretext_face_create((CGFontRef)(jdkFontInfo-&gt;nativeFont));</span>
      font = hb_font_create(face);
<span class="line-removed">-     hb_face_destroy(face);</span>
<span class="line-removed">- </span>
      hb_font_set_scale(font,
                       HBFloatToFixed(jdkFontInfo-&gt;ptSize),
                       HBFloatToFixed(jdkFontInfo-&gt;ptSize));
      return font;
  }
  #endif
  
<span class="line-modified">! hb_font_t* hb_jdk_font_create(JDKFontInfo *jdkFontInfo,</span>
                               hb_destroy_func_t destroy) {
<span class="line-removed">- </span>
<span class="line-removed">-    hb_font_t* font = NULL;</span>
<span class="line-removed">- </span>
  #ifdef MACOSX
<span class="line-modified">!      if (jdkFontInfo-&gt;aat) {</span>
<span class="line-modified">!          font = _hb_jdk_ct_font_create(jdkFontInfo);</span>
       }
  #endif
<span class="line-modified">!     if (font == NULL) {</span>
<span class="line-removed">-         font = _hb_jdk_font_create(jdkFontInfo, destroy);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     return font;</span>
  }
<span class="line-new-header">--- 305,147 ---</span>
  }
  
  static void _free_nothing(void*) {
  }
  
<span class="line-added">+ struct Font2DPtr {</span>
<span class="line-added">+     JavaVM* vmPtr;</span>
<span class="line-added">+     jweak font2DRef;</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ static void cleanupFontInfo(void* data) {</span>
<span class="line-added">+   Font2DPtr* fontInfo;</span>
<span class="line-added">+   JNIEnv* env;</span>
<span class="line-added">+ </span>
<span class="line-added">+   fontInfo = (Font2DPtr*) data;</span>
<span class="line-added">+   fontInfo-&gt;vmPtr-&gt;GetEnv((void**)&amp;env, JNI_VERSION_1_1);</span>
<span class="line-added">+   env-&gt;DeleteWeakGlobalRef(fontInfo-&gt;font2DRef);</span>
<span class="line-added">+   free(data);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  static hb_blob_t *
  reference_table(hb_face_t *face HB_UNUSED, hb_tag_t tag, void *user_data) {
  
<span class="line-modified">!   Font2DPtr *fontInfo;</span>
<span class="line-modified">!   JNIEnv* env;</span>
<span class="line-modified">!   jobject font2D;</span>
<span class="line-modified">!   jsize length;</span>
<span class="line-modified">!   void* buffer;</span>
  
    // HB_TAG_NONE is 0 and is used to get the whole font file.
    // It is not expected to be needed for JDK.
<span class="line-modified">!   if (tag == 0) {</span>
        return NULL;
    }
  
<span class="line-modified">!   fontInfo = (Font2DPtr*)user_data;</span>
<span class="line-modified">!   fontInfo-&gt;vmPtr-&gt;GetEnv((void**)&amp;env, JNI_VERSION_1_1);</span>
<span class="line-added">+   if (env == NULL) {</span>
<span class="line-added">+     return NULL;</span>
    }
<span class="line-added">+   font2D = fontInfo-&gt;font2DRef;</span>
  
<span class="line-modified">!   jbyteArray tableBytes = (jbyteArray)</span>
<span class="line-modified">!      env-&gt;CallObjectMethod(font2D, sunFontIDs.getTableBytesMID, tag);</span>
<span class="line-modified">!   if (tableBytes == NULL) {</span>
<span class="line-modified">!       return NULL;</span>
    }
<span class="line-modified">!   length = env-&gt;GetArrayLength(tableBytes);</span>
<span class="line-added">+   buffer = calloc(length, sizeof(jbyte));</span>
    if (buffer == NULL) {
<span class="line-modified">!       return NULL;</span>
    }
<span class="line-added">+   env-&gt;GetByteArrayRegion(tableBytes, 0, length, (jbyte*)buffer);</span>
  
    return hb_blob_create((const char *)buffer, length,
<span class="line-modified">!                          HB_MEMORY_MODE_WRITABLE,</span>
<span class="line-modified">!                          buffer, free);</span>
  }
  
<span class="line-added">+ extern &quot;C&quot; {</span>
  
<span class="line-added">+ /*</span>
<span class="line-added">+  * Class:     sun_font_SunLayoutEngine</span>
<span class="line-added">+  * Method:    createFace</span>
<span class="line-added">+  * Signature: (Lsun/font/Font2D;ZJJ)J</span>
<span class="line-added">+  */</span>
<span class="line-added">+ JNIEXPORT jlong JNICALL Java_sun_font_SunLayoutEngine_createFace(JNIEnv *env,</span>
<span class="line-added">+                          jclass cls,</span>
<span class="line-added">+                          jobject font2D,</span>
<span class="line-added">+                          jboolean aat,</span>
<span class="line-added">+                          jlong platformFontPtr) {</span>
<span class="line-added">+ #ifdef MACOSX</span>
<span class="line-added">+     if (aat &amp;&amp; platformFontPtr) {</span>
<span class="line-added">+         hb_face_t *face = hb_coretext_face_create((CGFontRef)platformFontPtr);</span>
<span class="line-added">+         return ptr_to_jlong(face);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+     Font2DPtr *fi = (Font2DPtr*)malloc(sizeof(Font2DPtr));</span>
<span class="line-added">+     if (!fi) {</span>
<span class="line-added">+         return 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     JavaVM* vmPtr;</span>
<span class="line-added">+     env-&gt;GetJavaVM(&amp;vmPtr);</span>
<span class="line-added">+     fi-&gt;vmPtr = vmPtr;</span>
<span class="line-added">+     fi-&gt;font2DRef = env-&gt;NewWeakGlobalRef(font2D);</span>
<span class="line-added">+     if (!fi-&gt;font2DRef) {</span>
<span class="line-added">+         free(fi);</span>
<span class="line-added">+         return 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     hb_face_t *face = hb_face_create_for_tables(reference_table, fi,</span>
<span class="line-added">+                                                 cleanupFontInfo);</span>
<span class="line-added">+     return ptr_to_jlong(face);</span>
<span class="line-added">+ }</span>
  
<span class="line-modified">! /*</span>
<span class="line-modified">!  * Class:     sun_font_SunLayoutEngine</span>
<span class="line-modified">!  * Method:    disposeFace</span>
<span class="line-modified">!  * Signature: (J)V</span>
<span class="line-modified">!  */</span>
<span class="line-modified">! JNIEXPORT void JNICALL Java_sun_font_SunLayoutEngine_disposeFace(JNIEnv *env,</span>
<span class="line-modified">!                         jclass cls,</span>
<span class="line-modified">!                         jlong ptr) {</span>
<span class="line-added">+     hb_face_t* face = (hb_face_t*) jlong_to_ptr(ptr);</span>
<span class="line-added">+     hb_face_destroy(face);</span>
  }
  
<span class="line-modified">! } // extern &quot;C&quot;</span>
<span class="line-added">+ </span>
<span class="line-added">+ static hb_font_t* _hb_jdk_font_create(hb_face_t* face,</span>
<span class="line-added">+                                       JDKFontInfo *jdkFontInfo,</span>
                                        hb_destroy_func_t destroy) {
  
      hb_font_t *font;
  
      font = hb_font_create(face);
      hb_font_set_funcs (font,
                         _hb_jdk_get_font_funcs (),
                         jdkFontInfo, (hb_destroy_func_t) _do_nothing);
      hb_font_set_scale (font,
                        HBFloatToFixed(jdkFontInfo-&gt;ptSize*jdkFontInfo-&gt;devScale),
                        HBFloatToFixed(jdkFontInfo-&gt;ptSize*jdkFontInfo-&gt;devScale));
    return font;
  }
  
  #ifdef MACOSX
<span class="line-modified">! static hb_font_t* _hb_jdk_ct_font_create(hb_face_t* face,</span>
<span class="line-added">+                    JDKFontInfo *jdkFontInfo) {</span>
  
      hb_font_t *font = NULL;
      font = hb_font_create(face);
      hb_font_set_scale(font,
                       HBFloatToFixed(jdkFontInfo-&gt;ptSize),
                       HBFloatToFixed(jdkFontInfo-&gt;ptSize));
      return font;
  }
  #endif
  
<span class="line-modified">! hb_font_t* hb_jdk_font_create(hb_face_t* hbFace,</span>
<span class="line-added">+                              JDKFontInfo *jdkFontInfo,</span>
                               hb_destroy_func_t destroy) {
  #ifdef MACOSX
<span class="line-modified">!      if (jdkFontInfo-&gt;aat &amp;&amp; jdkFontInfo-&gt;nativeFont) {</span>
<span class="line-modified">!          return _hb_jdk_ct_font_create(hbFace, jdkFontInfo);</span>
       }
  #endif
<span class="line-modified">!     return _hb_jdk_font_create(hbFace, jdkFontInfo, destroy);</span>
  }
</pre>
<center><a href="harfbuzz/hb.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="hb-jdk.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>