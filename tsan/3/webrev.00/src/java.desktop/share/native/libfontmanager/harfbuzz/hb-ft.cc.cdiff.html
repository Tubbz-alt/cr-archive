<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ft.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-font.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-map.cc.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ft.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 25,67 ***</span>
   *
   * Red Hat Author(s): Behdad Esfahbod
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="line-modified">! #include &quot;hb-private.hh&quot;</span>
<span class="line-removed">- #include &quot;hb-debug.hh&quot;</span>
  
  #include &quot;hb-ft.h&quot;
  
<span class="line-modified">! #include &quot;hb-font-private.hh&quot;</span>
  
  #include FT_ADVANCES_H
  #include FT_MULTIPLE_MASTERS_H
  #include FT_TRUETYPE_TABLES_H
  
  
  /* TODO:
   *
   * In general, this file does a fine job of what it&#39;s supposed to do.
   * There are, however, things that need more work:
   *
<span class="line-removed">-  *   - I remember seeing FT_Get_Advance() without the NO_HINTING flag to be buggy.</span>
<span class="line-removed">-  *     Have not investigated.</span>
<span class="line-removed">-  *</span>
   *   - FreeType works in 26.6 mode.  Clients can decide to use that mode, and everything
   *     would work fine.  However, we also abuse this API for performing in font-space,
   *     but don&#39;t pass the correct flags to FreeType.  We just abuse the no-hinting mode
   *     for that, such that no rounding etc happens.  As such, we don&#39;t set ppem, and
   *     pass NO_HINTING as load_flags.  Would be much better to use NO_SCALE, and scale
<span class="line-modified">!  *     ourselves, like we do in uniscribe, etc.</span>
   *
   *   - We don&#39;t handle / allow for emboldening / obliqueing.
   *
   *   - In the future, we should add constructors to create fonts in font space?
<span class="line-removed">-  *</span>
<span class="line-removed">-  *   - FT_Load_Glyph() is extremely costly.  Do something about it?</span>
   */
  
  
  struct hb_ft_font_t
  {
    FT_Face ft_face;
    int load_flags;
    bool symbol; /* Whether selected cmap is symbol cmap. */
    bool unref; /* Whether to destroy ft_face when done. */
  };
  
  static hb_ft_font_t *
  _hb_ft_font_create (FT_Face ft_face, bool symbol, bool unref)
  {
    hb_ft_font_t *ft_font = (hb_ft_font_t *) calloc (1, sizeof (hb_ft_font_t));
  
    if (unlikely (!ft_font))
      return nullptr;
  
    ft_font-&gt;ft_face = ft_face;
    ft_font-&gt;symbol = symbol;
    ft_font-&gt;unref = unref;
  
    ft_font-&gt;load_flags = FT_LOAD_DEFAULT | FT_LOAD_NO_HINTING;
  
    return ft_font;
  }
  
  static void
  _hb_ft_face_destroy (void *data)
<span class="line-new-header">--- 25,82 ---</span>
   *
   * Red Hat Author(s): Behdad Esfahbod
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="line-modified">! #include &quot;hb.hh&quot;</span>
  
  #include &quot;hb-ft.h&quot;
  
<span class="line-modified">! #include &quot;hb-font.hh&quot;</span>
<span class="line-added">+ #include &quot;hb-machinery.hh&quot;</span>
<span class="line-added">+ #include &quot;hb-cache.hh&quot;</span>
  
  #include FT_ADVANCES_H
  #include FT_MULTIPLE_MASTERS_H
  #include FT_TRUETYPE_TABLES_H
  
  
<span class="line-added">+ /**</span>
<span class="line-added">+  * SECTION:hb-ft</span>
<span class="line-added">+  * @title: hb-ft</span>
<span class="line-added">+  * @short_description: FreeType integration</span>
<span class="line-added">+  * @include: hb-ft.h</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Functions for using HarfBuzz with the FreeType library to provide face and</span>
<span class="line-added">+  * font data.</span>
<span class="line-added">+  **/</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
  /* TODO:
   *
   * In general, this file does a fine job of what it&#39;s supposed to do.
   * There are, however, things that need more work:
   *
   *   - FreeType works in 26.6 mode.  Clients can decide to use that mode, and everything
   *     would work fine.  However, we also abuse this API for performing in font-space,
   *     but don&#39;t pass the correct flags to FreeType.  We just abuse the no-hinting mode
   *     for that, such that no rounding etc happens.  As such, we don&#39;t set ppem, and
   *     pass NO_HINTING as load_flags.  Would be much better to use NO_SCALE, and scale
<span class="line-modified">!  *     ourselves.</span>
   *
   *   - We don&#39;t handle / allow for emboldening / obliqueing.
   *
   *   - In the future, we should add constructors to create fonts in font space?
   */
  
  
  struct hb_ft_font_t
  {
<span class="line-added">+   mutable hb_mutex_t lock;</span>
    FT_Face ft_face;
    int load_flags;
    bool symbol; /* Whether selected cmap is symbol cmap. */
    bool unref; /* Whether to destroy ft_face when done. */
<span class="line-added">+ </span>
<span class="line-added">+   mutable hb_atomic_int_t cached_x_scale;</span>
<span class="line-added">+   mutable hb_advance_cache_t advance_cache;</span>
  };
  
  static hb_ft_font_t *
  _hb_ft_font_create (FT_Face ft_face, bool symbol, bool unref)
  {
    hb_ft_font_t *ft_font = (hb_ft_font_t *) calloc (1, sizeof (hb_ft_font_t));
  
    if (unlikely (!ft_font))
      return nullptr;
  
<span class="line-added">+   ft_font-&gt;lock.init ();</span>
    ft_font-&gt;ft_face = ft_face;
    ft_font-&gt;symbol = symbol;
    ft_font-&gt;unref = unref;
  
    ft_font-&gt;load_flags = FT_LOAD_DEFAULT | FT_LOAD_NO_HINTING;
  
<span class="line-added">+   ft_font-&gt;cached_x_scale.set (0);</span>
<span class="line-added">+   ft_font-&gt;advance_cache.init ();</span>
<span class="line-added">+ </span>
    return ft_font;
  }
  
  static void
  _hb_ft_face_destroy (void *data)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 96,13 ***</span>
<span class="line-new-header">--- 111,17 ---</span>
  static void
  _hb_ft_font_destroy (void *data)
  {
    hb_ft_font_t *ft_font = (hb_ft_font_t *) data;
  
<span class="line-added">+   ft_font-&gt;advance_cache.fini ();</span>
<span class="line-added">+ </span>
    if (ft_font-&gt;unref)
      _hb_ft_face_destroy (ft_font-&gt;ft_face);
  
<span class="line-added">+   ft_font-&gt;lock.fini ();</span>
<span class="line-added">+ </span>
    free (ft_font);
  }
  
  /**
   * hb_ft_font_set_load_flags:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 114,11 ***</span>
   * Since: 1.0.5
   **/
  void
  hb_ft_font_set_load_flags (hb_font_t *font, int load_flags)
  {
<span class="line-modified">!   if (font-&gt;immutable)</span>
      return;
  
    if (font-&gt;destroy != (hb_destroy_func_t) _hb_ft_font_destroy)
      return;
  
<span class="line-new-header">--- 133,11 ---</span>
   * Since: 1.0.5
   **/
  void
  hb_ft_font_set_load_flags (hb_font_t *font, int load_flags)
  {
<span class="line-modified">!   if (hb_object_is_immutable (font))</span>
      return;
  
    if (font-&gt;destroy != (hb_destroy_func_t) _hb_ft_font_destroy)
      return;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 166,10 ***</span>
<span class="line-new-header">--- 185,11 ---</span>
                           hb_codepoint_t unicode,
                           hb_codepoint_t *glyph,
                           void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
    unsigned int g = FT_Get_Char_Index (ft_font-&gt;ft_face, unicode);
  
    if (unlikely (!g))
    {
      if (unlikely (ft_font-&gt;symbol) &amp;&amp; unicode &lt;= 0x00FFu)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 189,53 ***</span>
  
    *glyph = g;
    return true;
  }
  
  static hb_bool_t
  hb_ft_get_variation_glyph (hb_font_t *font HB_UNUSED,
                             void *font_data,
                             hb_codepoint_t unicode,
                             hb_codepoint_t variation_selector,
                             hb_codepoint_t *glyph,
                             void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
    unsigned int g = FT_Face_GetCharVariantIndex (ft_font-&gt;ft_face, unicode, variation_selector);
  
    if (unlikely (!g))
      return false;
  
    *glyph = g;
    return true;
  }
  
<span class="line-modified">! static hb_position_t</span>
<span class="line-modified">! hb_ft_get_glyph_h_advance (hb_font_t *font,</span>
<span class="line-modified">!                            void *font_data,</span>
<span class="line-modified">!                            hb_codepoint_t glyph,</span>
<span class="line-modified">!                            void *user_data HB_UNUSED)</span>
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-modified">!   FT_Fixed v;</span>
  
<span class="line-modified">!   if (unlikely (FT_Get_Advance (ft_font-&gt;ft_face, glyph, ft_font-&gt;load_flags, &amp;v)))</span>
<span class="line-modified">!     return 0;</span>
  
<span class="line-modified">!   if (font-&gt;x_scale &lt; 0)</span>
<span class="line-modified">!     v = -v;</span>
  
<span class="line-modified">!   return (v + (1&lt;&lt;9)) &gt;&gt; 10;</span>
  }
  
  static hb_position_t
  hb_ft_get_glyph_v_advance (hb_font_t *font,
                             void *font_data,
                             hb_codepoint_t glyph,
                             void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
    FT_Fixed v;
  
    if (unlikely (FT_Get_Advance (ft_font-&gt;ft_face, glyph, ft_font-&gt;load_flags | FT_LOAD_VERTICAL_LAYOUT, &amp;v)))
      return 0;
  
<span class="line-new-header">--- 209,104 ---</span>
  
    *glyph = g;
    return true;
  }
  
<span class="line-added">+ static unsigned int</span>
<span class="line-added">+ hb_ft_get_nominal_glyphs (hb_font_t *font HB_UNUSED,</span>
<span class="line-added">+                           void *font_data,</span>
<span class="line-added">+                           unsigned int count,</span>
<span class="line-added">+                           const hb_codepoint_t *first_unicode,</span>
<span class="line-added">+                           unsigned int unicode_stride,</span>
<span class="line-added">+                           hb_codepoint_t *first_glyph,</span>
<span class="line-added">+                           unsigned int glyph_stride,</span>
<span class="line-added">+                           void *user_data HB_UNUSED)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;</span>
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
<span class="line-added">+   unsigned int done;</span>
<span class="line-added">+   for (done = 0;</span>
<span class="line-added">+        done &lt; count &amp;&amp; (*first_glyph = FT_Get_Char_Index (ft_font-&gt;ft_face, *first_unicode));</span>
<span class="line-added">+        done++)</span>
<span class="line-added">+   {</span>
<span class="line-added">+     first_unicode = &amp;StructAtOffsetUnaligned&lt;hb_codepoint_t&gt; (first_unicode, unicode_stride);</span>
<span class="line-added">+     first_glyph = &amp;StructAtOffsetUnaligned&lt;hb_codepoint_t&gt; (first_glyph, glyph_stride);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   /* We don&#39;t need to do ft_font-&gt;symbol dance here, since HB calls the singular</span>
<span class="line-added">+    * nominal_glyph() for what we don&#39;t handle here. */</span>
<span class="line-added">+   return done;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
  static hb_bool_t
  hb_ft_get_variation_glyph (hb_font_t *font HB_UNUSED,
                             void *font_data,
                             hb_codepoint_t unicode,
                             hb_codepoint_t variation_selector,
                             hb_codepoint_t *glyph,
                             void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
    unsigned int g = FT_Face_GetCharVariantIndex (ft_font-&gt;ft_face, unicode, variation_selector);
  
    if (unlikely (!g))
      return false;
  
    *glyph = g;
    return true;
  }
  
<span class="line-modified">! static void</span>
<span class="line-modified">! hb_ft_get_glyph_h_advances (hb_font_t* font, void* font_data,</span>
<span class="line-modified">!                             unsigned count,</span>
<span class="line-modified">!                             const hb_codepoint_t *first_glyph,</span>
<span class="line-modified">!                             unsigned glyph_stride,</span>
<span class="line-added">+                             hb_position_t *first_advance,</span>
<span class="line-added">+                             unsigned advance_stride,</span>
<span class="line-added">+                             void *user_data HB_UNUSED)</span>
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-modified">!   hb_lock_t lock (ft_font-&gt;lock);</span>
<span class="line-added">+   FT_Face ft_face = ft_font-&gt;ft_face;</span>
<span class="line-added">+   int load_flags = ft_font-&gt;load_flags;</span>
<span class="line-added">+   int mult = font-&gt;x_scale &lt; 0 ? -1 : +1;</span>
  
<span class="line-modified">!   if (font-&gt;x_scale != ft_font-&gt;cached_x_scale.get ())</span>
<span class="line-modified">!   {</span>
<span class="line-added">+     ft_font-&gt;advance_cache.clear ();</span>
<span class="line-added">+     ft_font-&gt;cached_x_scale.set (font-&gt;x_scale);</span>
<span class="line-added">+   }</span>
  
<span class="line-modified">!   for (unsigned int i = 0; i &lt; count; i++)</span>
<span class="line-modified">!   {</span>
<span class="line-added">+     FT_Fixed v = 0;</span>
<span class="line-added">+     hb_codepoint_t glyph = *first_glyph;</span>
  
<span class="line-modified">!     unsigned int cv;</span>
<span class="line-added">+     if (ft_font-&gt;advance_cache.get (glyph, &amp;cv))</span>
<span class="line-added">+       v = cv;</span>
<span class="line-added">+     else</span>
<span class="line-added">+     {</span>
<span class="line-added">+       FT_Get_Advance (ft_face, glyph, load_flags, &amp;v);</span>
<span class="line-added">+       ft_font-&gt;advance_cache.set (glyph, v);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     *first_advance = (v * mult + (1&lt;&lt;9)) &gt;&gt; 10;</span>
<span class="line-added">+     first_glyph = &amp;StructAtOffsetUnaligned&lt;hb_codepoint_t&gt; (first_glyph, glyph_stride);</span>
<span class="line-added">+     first_advance = &amp;StructAtOffsetUnaligned&lt;hb_position_t&gt; (first_advance, advance_stride);</span>
<span class="line-added">+   }</span>
  }
  
  static hb_position_t
  hb_ft_get_glyph_v_advance (hb_font_t *font,
                             void *font_data,
                             hb_codepoint_t glyph,
                             void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
    FT_Fixed v;
  
    if (unlikely (FT_Get_Advance (ft_font-&gt;ft_face, glyph, ft_font-&gt;load_flags | FT_LOAD_VERTICAL_LAYOUT, &amp;v)))
      return 0;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 254,10 ***</span>
<span class="line-new-header">--- 325,11 ---</span>
                            hb_position_t *x,
                            hb_position_t *y,
                            void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
    FT_Face ft_face = ft_font-&gt;ft_face;
  
    if (unlikely (FT_Load_Glyph (ft_face, glyph, ft_font-&gt;load_flags)))
      return false;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 272,35 ***</span>
      *y = -*y;
  
    return true;
  }
  
<span class="line-removed">- static hb_position_t</span>
<span class="line-removed">- hb_ft_get_glyph_h_kerning (hb_font_t *font,</span>
<span class="line-removed">-                            void *font_data,</span>
<span class="line-removed">-                            hb_codepoint_t left_glyph,</span>
<span class="line-removed">-                            hb_codepoint_t right_glyph,</span>
<span class="line-removed">-                            void *user_data HB_UNUSED)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-   const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;</span>
<span class="line-removed">-   FT_Vector kerningv;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   FT_Kerning_Mode mode = font-&gt;x_ppem ? FT_KERNING_DEFAULT : FT_KERNING_UNFITTED;</span>
<span class="line-removed">-   if (FT_Get_Kerning (ft_font-&gt;ft_face, left_glyph, right_glyph, mode, &amp;kerningv))</span>
<span class="line-removed">-     return 0;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   return kerningv.x;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  static hb_bool_t
  hb_ft_get_glyph_extents (hb_font_t *font,
                           void *font_data,
                           hb_codepoint_t glyph,
                           hb_glyph_extents_t *extents,
                           void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
    FT_Face ft_face = ft_font-&gt;ft_face;
  
    if (unlikely (FT_Load_Glyph (ft_face, glyph, ft_font-&gt;load_flags)))
      return false;
  
<span class="line-new-header">--- 344,19 ---</span>
      *y = -*y;
  
    return true;
  }
  
  static hb_bool_t
  hb_ft_get_glyph_extents (hb_font_t *font,
                           void *font_data,
                           hb_codepoint_t glyph,
                           hb_glyph_extents_t *extents,
                           void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
    FT_Face ft_face = ft_font-&gt;ft_face;
  
    if (unlikely (FT_Load_Glyph (ft_face, glyph, ft_font-&gt;load_flags)))
      return false;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 329,10 ***</span>
<span class="line-new-header">--- 385,11 ---</span>
                                 hb_position_t *x,
                                 hb_position_t *y,
                                 void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
    FT_Face ft_face = ft_font-&gt;ft_face;
  
    if (unlikely (FT_Load_Glyph (ft_face, glyph, ft_font-&gt;load_flags)))
        return false;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 354,12 ***</span>
                        hb_codepoint_t glyph,
                        char *name, unsigned int size,
                        void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
  
<span class="line-modified">!   hb_bool_t ret = !FT_Get_Glyph_Name (ft_font-&gt;ft_face, glyph, name, size);</span>
    if (ret &amp;&amp; (size &amp;&amp; !*name))
      ret = false;
  
    return ret;
  }
<span class="line-new-header">--- 411,14 ---</span>
                        hb_codepoint_t glyph,
                        char *name, unsigned int size,
                        void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
<span class="line-added">+   FT_Face ft_face = ft_font-&gt;ft_face;</span>
  
<span class="line-modified">!   hb_bool_t ret = !FT_Get_Glyph_Name (ft_face, glyph, name, size);</span>
    if (ret &amp;&amp; (size &amp;&amp; !*name))
      ret = false;
  
    return ret;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 370,10 ***</span>
<span class="line-new-header">--- 429,11 ---</span>
                             const char *name, int len, /* -1 means nul-terminated */
                             hb_codepoint_t *glyph,
                             void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
    FT_Face ft_face = ft_font-&gt;ft_face;
  
    if (len &lt; 0)
      *glyph = FT_Get_Name_Index (ft_face, (FT_String *) name);
    else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 402,79 ***</span>
                            void *font_data,
                            hb_font_extents_t *metrics,
                            void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
    FT_Face ft_face = ft_font-&gt;ft_face;
<span class="line-modified">!   metrics-&gt;ascender = ft_face-&gt;size-&gt;metrics.ascender;</span>
<span class="line-modified">!   metrics-&gt;descender = ft_face-&gt;size-&gt;metrics.descender;</span>
<span class="line-modified">!   metrics-&gt;line_gap = ft_face-&gt;size-&gt;metrics.height - (ft_face-&gt;size-&gt;metrics.ascender - ft_face-&gt;size-&gt;metrics.descender);</span>
    if (font-&gt;y_scale &lt; 0)
    {
      metrics-&gt;ascender = -metrics-&gt;ascender;
      metrics-&gt;descender = -metrics-&gt;descender;
      metrics-&gt;line_gap = -metrics-&gt;line_gap;
    }
    return true;
  }
  
<span class="line-modified">! static hb_font_funcs_t *static_ft_funcs = nullptr;</span>
<span class="line-modified">! </span>
<span class="line-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="line-removed">- static</span>
<span class="line-removed">- void free_static_ft_funcs (void)</span>
<span class="line-removed">- {</span>
<span class="line-removed">- retry:</span>
<span class="line-removed">-   hb_font_funcs_t *ft_funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ft_funcs);</span>
<span class="line-removed">-   if (!hb_atomic_ptr_cmpexch (&amp;static_ft_funcs, ft_funcs, nullptr))</span>
<span class="line-removed">-     goto retry;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   hb_font_funcs_destroy (ft_funcs);</span>
<span class="line-removed">- }</span>
  #endif
  
<span class="line-modified">! static void</span>
<span class="line-removed">- _hb_ft_font_set_funcs (hb_font_t *font, FT_Face ft_face, bool unref)</span>
  {
<span class="line-modified">! retry:</span>
<span class="line-removed">-   hb_font_funcs_t *funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ft_funcs);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   if (unlikely (!funcs))</span>
    {
<span class="line-modified">!     funcs = hb_font_funcs_create ();</span>
  
      hb_font_funcs_set_font_h_extents_func (funcs, hb_ft_get_font_h_extents, nullptr, nullptr);
      //hb_font_funcs_set_font_v_extents_func (funcs, hb_ft_get_font_v_extents, nullptr, nullptr);
      hb_font_funcs_set_nominal_glyph_func (funcs, hb_ft_get_nominal_glyph, nullptr, nullptr);
      hb_font_funcs_set_variation_glyph_func (funcs, hb_ft_get_variation_glyph, nullptr, nullptr);
<span class="line-modified">!     hb_font_funcs_set_glyph_h_advance_func (funcs, hb_ft_get_glyph_h_advance, nullptr, nullptr);</span>
      hb_font_funcs_set_glyph_v_advance_func (funcs, hb_ft_get_glyph_v_advance, nullptr, nullptr);
      //hb_font_funcs_set_glyph_h_origin_func (funcs, hb_ft_get_glyph_h_origin, nullptr, nullptr);
      hb_font_funcs_set_glyph_v_origin_func (funcs, hb_ft_get_glyph_v_origin, nullptr, nullptr);
<span class="line-removed">-     hb_font_funcs_set_glyph_h_kerning_func (funcs, hb_ft_get_glyph_h_kerning, nullptr, nullptr);</span>
<span class="line-removed">-     //hb_font_funcs_set_glyph_v_kerning_func (funcs, hb_ft_get_glyph_v_kerning, nullptr, nullptr);</span>
      hb_font_funcs_set_glyph_extents_func (funcs, hb_ft_get_glyph_extents, nullptr, nullptr);
      hb_font_funcs_set_glyph_contour_point_func (funcs, hb_ft_get_glyph_contour_point, nullptr, nullptr);
      hb_font_funcs_set_glyph_name_func (funcs, hb_ft_get_glyph_name, nullptr, nullptr);
      hb_font_funcs_set_glyph_from_name_func (funcs, hb_ft_get_glyph_from_name, nullptr, nullptr);
  
      hb_font_funcs_make_immutable (funcs);
  
<span class="line-modified">!     if (!hb_atomic_ptr_cmpexch (&amp;static_ft_funcs, nullptr, funcs)) {</span>
<span class="line-modified">!       hb_font_funcs_destroy (funcs);</span>
<span class="line-modified">!       goto retry;</span>
<span class="line-removed">-     }</span>
  
<span class="line-modified">! #ifdef HB_USE_ATEXIT</span>
<span class="line-modified">!     atexit (free_static_ft_funcs); /* First person registers atexit() callback. */</span>
  #endif
<span class="line-removed">-   };</span>
  
    bool symbol = ft_face-&gt;charmap &amp;&amp; ft_face-&gt;charmap-&gt;encoding == FT_ENCODING_MS_SYMBOL;
  
    hb_font_set_funcs (font,
<span class="line-modified">!                      funcs,</span>
                       _hb_ft_font_create (ft_face, symbol, unref),
                       _hb_ft_font_destroy);
  }
  
  
<span class="line-new-header">--- 462,79 ---</span>
                            void *font_data,
                            hb_font_extents_t *metrics,
                            void *user_data HB_UNUSED)
  {
    const hb_ft_font_t *ft_font = (const hb_ft_font_t *) font_data;
<span class="line-added">+   hb_lock_t lock (ft_font-&gt;lock);</span>
    FT_Face ft_face = ft_font-&gt;ft_face;
<span class="line-modified">!   metrics-&gt;ascender = FT_MulFix(ft_face-&gt;ascender, ft_face-&gt;size-&gt;metrics.y_scale);</span>
<span class="line-modified">!   metrics-&gt;descender = FT_MulFix(ft_face-&gt;descender, ft_face-&gt;size-&gt;metrics.y_scale);</span>
<span class="line-modified">!   metrics-&gt;line_gap = FT_MulFix( ft_face-&gt;height, ft_face-&gt;size-&gt;metrics.y_scale ) - (metrics-&gt;ascender - metrics-&gt;descender);</span>
    if (font-&gt;y_scale &lt; 0)
    {
      metrics-&gt;ascender = -metrics-&gt;ascender;
      metrics-&gt;descender = -metrics-&gt;descender;
      metrics-&gt;line_gap = -metrics-&gt;line_gap;
    }
    return true;
  }
  
<span class="line-modified">! #if HB_USE_ATEXIT</span>
<span class="line-modified">! static void free_static_ft_funcs ();</span>
  #endif
  
<span class="line-modified">! static struct hb_ft_font_funcs_lazy_loader_t : hb_font_funcs_lazy_loader_t&lt;hb_ft_font_funcs_lazy_loader_t&gt;</span>
  {
<span class="line-modified">!   static hb_font_funcs_t *create ()</span>
    {
<span class="line-modified">!     hb_font_funcs_t *funcs = hb_font_funcs_create ();</span>
  
      hb_font_funcs_set_font_h_extents_func (funcs, hb_ft_get_font_h_extents, nullptr, nullptr);
      //hb_font_funcs_set_font_v_extents_func (funcs, hb_ft_get_font_v_extents, nullptr, nullptr);
      hb_font_funcs_set_nominal_glyph_func (funcs, hb_ft_get_nominal_glyph, nullptr, nullptr);
<span class="line-added">+     hb_font_funcs_set_nominal_glyphs_func (funcs, hb_ft_get_nominal_glyphs, nullptr, nullptr);</span>
      hb_font_funcs_set_variation_glyph_func (funcs, hb_ft_get_variation_glyph, nullptr, nullptr);
<span class="line-modified">!     hb_font_funcs_set_glyph_h_advances_func (funcs, hb_ft_get_glyph_h_advances, nullptr, nullptr);</span>
      hb_font_funcs_set_glyph_v_advance_func (funcs, hb_ft_get_glyph_v_advance, nullptr, nullptr);
      //hb_font_funcs_set_glyph_h_origin_func (funcs, hb_ft_get_glyph_h_origin, nullptr, nullptr);
      hb_font_funcs_set_glyph_v_origin_func (funcs, hb_ft_get_glyph_v_origin, nullptr, nullptr);
      hb_font_funcs_set_glyph_extents_func (funcs, hb_ft_get_glyph_extents, nullptr, nullptr);
      hb_font_funcs_set_glyph_contour_point_func (funcs, hb_ft_get_glyph_contour_point, nullptr, nullptr);
      hb_font_funcs_set_glyph_name_func (funcs, hb_ft_get_glyph_name, nullptr, nullptr);
      hb_font_funcs_set_glyph_from_name_func (funcs, hb_ft_get_glyph_from_name, nullptr, nullptr);
  
      hb_font_funcs_make_immutable (funcs);
  
<span class="line-modified">! #if HB_USE_ATEXIT</span>
<span class="line-modified">!     atexit (free_static_ft_funcs);</span>
<span class="line-modified">! #endif</span>
  
<span class="line-modified">!     return funcs;</span>
<span class="line-modified">!   }</span>
<span class="line-added">+ } static_ft_funcs;</span>
<span class="line-added">+ </span>
<span class="line-added">+ #if HB_USE_ATEXIT</span>
<span class="line-added">+ static</span>
<span class="line-added">+ void free_static_ft_funcs ()</span>
<span class="line-added">+ {</span>
<span class="line-added">+   static_ft_funcs.free_instance ();</span>
<span class="line-added">+ }</span>
  #endif
  
<span class="line-added">+ static hb_font_funcs_t *</span>
<span class="line-added">+ _hb_ft_get_font_funcs ()</span>
<span class="line-added">+ {</span>
<span class="line-added">+   return static_ft_funcs.get_unconst ();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static void</span>
<span class="line-added">+ _hb_ft_font_set_funcs (hb_font_t *font, FT_Face ft_face, bool unref)</span>
<span class="line-added">+ {</span>
    bool symbol = ft_face-&gt;charmap &amp;&amp; ft_face-&gt;charmap-&gt;encoding == FT_ENCODING_MS_SYMBOL;
  
    hb_font_set_funcs (font,
<span class="line-modified">!                      _hb_ft_get_font_funcs (),</span>
                       _hb_ft_font_create (ft_face, symbol, unref),
                       _hb_ft_font_destroy);
  }
  
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 495,11 ***</span>
    buffer = (FT_Byte *) malloc (length);
    if (!buffer)
      return nullptr;
  
    error = FT_Load_Sfnt_Table (ft_face, tag, 0, buffer, &amp;length);
<span class="line-modified">!   if (error) {</span>
      free (buffer);
      return nullptr;
    }
  
    return hb_blob_create ((const char *) buffer, length,
<span class="line-new-header">--- 555,12 ---</span>
    buffer = (FT_Byte *) malloc (length);
    if (!buffer)
      return nullptr;
  
    error = FT_Load_Sfnt_Table (ft_face, tag, 0, buffer, &amp;length);
<span class="line-modified">!   if (error)</span>
<span class="line-added">+   {</span>
      free (buffer);
      return nullptr;
    }
  
    return hb_blob_create ((const char *) buffer, length,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 681,51 ***</span>
  {
    FT_Reference_Face (ft_face);
    return hb_ft_font_create (ft_face, _hb_ft_face_destroy);
  }
  
  
<span class="line-modified">! /* Thread-safe, lock-free, FT_Library */</span>
  
<span class="line-modified">! static FT_Library ft_library;</span>
  
<span class="line-modified">! #ifdef HB_USE_ATEXIT</span>
  static
<span class="line-modified">! void free_ft_library (void)</span>
  {
<span class="line-modified">! retry:</span>
<span class="line-removed">-   FT_Library library = (FT_Library) hb_atomic_ptr_get (&amp;ft_library);</span>
<span class="line-removed">-   if (!hb_atomic_ptr_cmpexch (&amp;ft_library, library, nullptr))</span>
<span class="line-removed">-     goto retry;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   FT_Done_FreeType (library);</span>
  }
  #endif
  
  static FT_Library
<span class="line-modified">! get_ft_library (void)</span>
  {
<span class="line-modified">! retry:</span>
<span class="line-removed">-   FT_Library library = (FT_Library) hb_atomic_ptr_get (&amp;ft_library);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   if (unlikely (!library))</span>
<span class="line-removed">-   {</span>
<span class="line-removed">-     /* Not found; allocate one. */</span>
<span class="line-removed">-     if (FT_Init_FreeType (&amp;library))</span>
<span class="line-removed">-       return nullptr;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (!hb_atomic_ptr_cmpexch (&amp;ft_library, nullptr, library)) {</span>
<span class="line-removed">-       FT_Done_FreeType (library);</span>
<span class="line-removed">-       goto retry;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="line-removed">-     atexit (free_ft_library); /* First person registers atexit() callback. */</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   return library;</span>
  }
  
  static void
  _release_blob (FT_Face ft_face)
  {
<span class="line-new-header">--- 742,51 ---</span>
  {
    FT_Reference_Face (ft_face);
    return hb_ft_font_create (ft_face, _hb_ft_face_destroy);
  }
  
<span class="line-added">+ #if HB_USE_ATEXIT</span>
<span class="line-added">+ static void free_static_ft_library ();</span>
<span class="line-added">+ #endif</span>
  
<span class="line-modified">! static struct hb_ft_library_lazy_loader_t : hb_lazy_loader_t&lt;hb_remove_pointer (FT_Library),</span>
<span class="line-added">+                                                              hb_ft_library_lazy_loader_t&gt;</span>
<span class="line-added">+ {</span>
<span class="line-added">+   static FT_Library create ()</span>
<span class="line-added">+   {</span>
<span class="line-added">+     FT_Library l;</span>
<span class="line-added">+     if (FT_Init_FreeType (&amp;l))</span>
<span class="line-added">+       return nullptr;</span>
  
<span class="line-modified">! #if HB_USE_ATEXIT</span>
<span class="line-added">+     atexit (free_static_ft_library);</span>
<span class="line-added">+ #endif</span>
  
<span class="line-modified">!     return l;</span>
<span class="line-added">+   }</span>
<span class="line-added">+   static void destroy (FT_Library l)</span>
<span class="line-added">+   {</span>
<span class="line-added">+     FT_Done_FreeType (l);</span>
<span class="line-added">+   }</span>
<span class="line-added">+   static FT_Library get_null ()</span>
<span class="line-added">+   {</span>
<span class="line-added">+     return nullptr;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ } static_ft_library;</span>
<span class="line-added">+ </span>
<span class="line-added">+ #if HB_USE_ATEXIT</span>
  static
<span class="line-modified">! void free_static_ft_library ()</span>
  {
<span class="line-modified">!   static_ft_library.free_instance ();</span>
  }
  #endif
  
  static FT_Library
<span class="line-modified">! get_ft_library ()</span>
  {
<span class="line-modified">!   return static_ft_library.get_unconst ();</span>
  }
  
  static void
  _release_blob (FT_Face ft_face)
  {
</pre>
<center><a href="hb-font.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-map.cc.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>