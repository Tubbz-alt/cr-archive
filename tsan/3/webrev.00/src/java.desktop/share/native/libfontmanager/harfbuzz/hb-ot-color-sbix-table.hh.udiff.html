<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-color-sbix-table.hh</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-color-cpal-table.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-color-svg-table.hh.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-color-sbix-table.hh</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,11 +23,11 @@</span>
   */
  
  #ifndef HB_OT_COLOR_SBIX_TABLE_HH
  #define HB_OT_COLOR_SBIX_TABLE_HH
  
<span class="udiff-line-modified-removed">- #include &quot;hb-open-type-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-open-type.hh&quot;</span>
  
  /*
   * sbix -- Standard Bitmap Graphics
   * https://docs.microsoft.com/en-us/typography/opentype/spec/sbix
   * https://developer.apple.com/fonts/TrueType-Reference-Manual/RM06/Chap6sbix.html
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -60,94 +60,227 @@</span>
    DEFINE_SIZE_ARRAY (8, data);
  };
  
  struct SBIXStrike
  {
<span class="udiff-line-modified-removed">-   friend struct sbix;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   inline bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="udiff-line-modified-added">+   bool sanitize (hb_sanitize_context_t *c) const</span>
    {
      TRACE_SANITIZE (this);
      return_trace (c-&gt;check_struct (this) &amp;&amp;
<span class="udiff-line-modified-removed">-                   imageOffsetsZ.sanitize_shallow (c, c-&gt;num_glyphs + 1));</span>
<span class="udiff-line-modified-added">+                   imageOffsetsZ.sanitize_shallow (c, c-&gt;get_num_glyphs () + 1));</span>
    }
  
<span class="udiff-line-modified-removed">-   protected:</span>
<span class="udiff-line-modified-added">+   hb_blob_t *get_glyph_blob (unsigned int  glyph_id,</span>
<span class="udiff-line-added">+                              hb_blob_t    *sbix_blob,</span>
<span class="udiff-line-added">+                              hb_tag_t      file_type,</span>
<span class="udiff-line-added">+                              int          *x_offset,</span>
<span class="udiff-line-added">+                              int          *y_offset,</span>
<span class="udiff-line-added">+                              unsigned int  num_glyphs,</span>
<span class="udiff-line-added">+                              unsigned int *strike_ppem) const</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     if (unlikely (!ppem)) return hb_blob_get_empty (); /* To get Null() object out of the way. */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     unsigned int retry_count = 8;</span>
<span class="udiff-line-added">+     unsigned int sbix_len = sbix_blob-&gt;length;</span>
<span class="udiff-line-added">+     unsigned int strike_offset = (const char *) this - (const char *) sbix_blob-&gt;data;</span>
<span class="udiff-line-added">+     assert (strike_offset &lt; sbix_len);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   retry:</span>
<span class="udiff-line-added">+     if (unlikely (glyph_id &gt;= num_glyphs ||</span>
<span class="udiff-line-added">+                   imageOffsetsZ[glyph_id + 1] &lt;= imageOffsetsZ[glyph_id] ||</span>
<span class="udiff-line-added">+                   imageOffsetsZ[glyph_id + 1] - imageOffsetsZ[glyph_id] &lt;= SBIXGlyph::min_size ||</span>
<span class="udiff-line-added">+                   (unsigned int) imageOffsetsZ[glyph_id + 1] &gt; sbix_len - strike_offset))</span>
<span class="udiff-line-added">+       return hb_blob_get_empty ();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     unsigned int glyph_offset = strike_offset + (unsigned int) imageOffsetsZ[glyph_id] + SBIXGlyph::min_size;</span>
<span class="udiff-line-added">+     unsigned int glyph_length = imageOffsetsZ[glyph_id + 1] - imageOffsetsZ[glyph_id] - SBIXGlyph::min_size;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const SBIXGlyph *glyph = &amp;(this+imageOffsetsZ[glyph_id]);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (glyph-&gt;graphicType == HB_TAG (&#39;d&#39;,&#39;u&#39;,&#39;p&#39;,&#39;e&#39;))</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       if (glyph_length &gt;= 2)</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         glyph_id = *((HBUINT16 *) &amp;glyph-&gt;data);</span>
<span class="udiff-line-added">+         if (retry_count--)</span>
<span class="udiff-line-added">+           goto retry;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+       return hb_blob_get_empty ();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (unlikely (file_type != glyph-&gt;graphicType))</span>
<span class="udiff-line-added">+       return hb_blob_get_empty ();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (strike_ppem) *strike_ppem = ppem;</span>
<span class="udiff-line-added">+     if (x_offset) *x_offset = glyph-&gt;xOffset;</span>
<span class="udiff-line-added">+     if (y_offset) *y_offset = glyph-&gt;yOffset;</span>
<span class="udiff-line-added">+     return hb_blob_create_sub_blob (sbix_blob, glyph_offset, glyph_length);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   public:</span>
    HBUINT16      ppem;           /* The PPEM size for which this strike was designed. */
    HBUINT16      resolution;     /* The device pixel density (in PPI) for which this
                                   * strike was designed. (E.g., 96 PPI, 192 PPI.) */
<span class="udiff-line-added">+   protected:</span>
    UnsizedArrayOf&lt;LOffsetTo&lt;SBIXGlyph&gt; &gt;
                  imageOffsetsZ;  /* Offset from the beginning of the strike data header
                                   * to bitmap data for an individual glyph ID. */
    public:
    DEFINE_SIZE_STATIC (8);
  };
  
  struct sbix
  {
<span class="udiff-line-modified-removed">-   static const hb_tag_t tableTag = HB_OT_TAG_sbix;</span>
<span class="udiff-line-modified-added">+   static constexpr hb_tag_t tableTag = HB_OT_TAG_sbix;</span>
  
<span class="udiff-line-modified-removed">-   inline bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="udiff-line-modified-removed">-   {</span>
<span class="udiff-line-modified-removed">-     TRACE_SANITIZE (this);</span>
<span class="udiff-line-removed">-     return_trace (likely (c-&gt;check_struct (this) &amp;&amp; strikes.sanitize (c, this)));</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   bool has_data () const { return version; }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   const SBIXStrike &amp;get_strike (unsigned int i) const { return this+strikes[i]; }</span>
  
    struct accelerator_t
    {
<span class="udiff-line-modified-removed">-     inline void init (hb_face_t *face)</span>
<span class="udiff-line-modified-added">+     void init (hb_face_t *face)</span>
      {
<span class="udiff-line-modified-removed">-       num_glyphs = hb_face_get_glyph_count (face);</span>
<span class="udiff-line-modified-added">+       table = hb_sanitize_context_t().reference_table&lt;sbix&gt; (face);</span>
<span class="udiff-line-added">+       num_glyphs = face-&gt;get_num_glyphs ();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     void fini () { table.destroy (); }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool has_data () const { return table-&gt;has_data (); }</span>
  
<span class="udiff-line-modified-removed">-       OT::Sanitizer&lt;OT::sbix&gt; sanitizer;</span>
<span class="udiff-line-modified-removed">-       sanitizer.set_num_glyphs (num_glyphs);</span>
<span class="udiff-line-modified-removed">-       sbix_blob = sanitizer.sanitize (face-&gt;reference_table (HB_OT_TAG_sbix));</span>
<span class="udiff-line-modified-removed">-       sbix_len = hb_blob_get_length (sbix_blob);</span>
<span class="udiff-line-modified-removed">-       sbix_table = sbix_blob-&gt;as&lt;OT::sbix&gt; ();</span>
<span class="udiff-line-modified-added">+     bool get_extents (hb_font_t          *font,</span>
<span class="udiff-line-modified-added">+                       hb_codepoint_t      glyph,</span>
<span class="udiff-line-modified-added">+                       hb_glyph_extents_t *extents) const</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-modified-added">+       /* We only support PNG right now, and following function checks type. */</span>
<span class="udiff-line-added">+       return get_png_extents (font, glyph, extents);</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-added">+     hb_blob_t *reference_png (hb_font_t      *font,</span>
<span class="udiff-line-added">+                               hb_codepoint_t  glyph_id,</span>
<span class="udiff-line-added">+                               int            *x_offset,</span>
<span class="udiff-line-added">+                               int            *y_offset,</span>
<span class="udiff-line-added">+                               unsigned int   *available_ppem) const</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       return choose_strike (font).get_glyph_blob (glyph_id, table.get_blob (),</span>
<span class="udiff-line-added">+                                                   HB_TAG (&#39;p&#39;,&#39;n&#39;,&#39;g&#39;,&#39; &#39;),</span>
<span class="udiff-line-added">+                                                   x_offset, y_offset,</span>
<span class="udiff-line-added">+                                                   num_glyphs, available_ppem);</span>
      }
  
<span class="udiff-line-modified-removed">-     inline void fini (void)</span>
<span class="udiff-line-modified-added">+     private:</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const SBIXStrike &amp;choose_strike (hb_font_t *font) const</span>
      {
<span class="udiff-line-modified-removed">-       hb_blob_destroy (sbix_blob);</span>
<span class="udiff-line-modified-added">+       unsigned count = table-&gt;strikes.len;</span>
<span class="udiff-line-added">+       if (unlikely (!count))</span>
<span class="udiff-line-added">+         return Null(SBIXStrike);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       unsigned int requested_ppem = MAX (font-&gt;x_ppem, font-&gt;y_ppem);</span>
<span class="udiff-line-added">+       if (!requested_ppem)</span>
<span class="udiff-line-added">+         requested_ppem = 1&lt;&lt;30; /* Choose largest strike. */</span>
<span class="udiff-line-added">+       /* TODO Add DPI sensitivity as well? */</span>
<span class="udiff-line-added">+       unsigned int best_i = 0;</span>
<span class="udiff-line-added">+       unsigned int best_ppem = table-&gt;get_strike (0).ppem;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       for (unsigned int i = 1; i &lt; count; i++)</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         unsigned int ppem = (table-&gt;get_strike (i)).ppem;</span>
<span class="udiff-line-added">+         if ((requested_ppem &lt;= ppem &amp;&amp; ppem &lt; best_ppem) ||</span>
<span class="udiff-line-added">+             (requested_ppem &gt; best_ppem &amp;&amp; ppem &gt; best_ppem))</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+           best_i = i;</span>
<span class="udiff-line-added">+           best_ppem = ppem;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       return table-&gt;get_strike (best_i);</span>
      }
  
<span class="udiff-line-modified-removed">-     inline void dump (void (*callback) (const uint8_t* data, unsigned int length,</span>
<span class="udiff-line-removed">-                                         unsigned int group, unsigned int gid)) const</span>
<span class="udiff-line-modified-added">+     struct PNGHeader</span>
      {
<span class="udiff-line-modified-removed">-       for (unsigned group = 0; group &lt; sbix_table-&gt;strikes.len; ++group)</span>
<span class="udiff-line-modified-added">+       HBUINT8   signature[8];</span>
<span class="udiff-line-added">+       struct</span>
        {
<span class="udiff-line-modified-removed">-         const SBIXStrike &amp;strike = sbix_table-&gt;strikes[group](sbix_table);</span>
<span class="udiff-line-modified-removed">-         for (unsigned int glyph = 0; glyph &lt; num_glyphs; ++glyph)</span>
<span class="udiff-line-modified-removed">-           if (strike.imageOffsetsZ[glyph + 1] - strike.imageOffsetsZ[glyph] &gt; 0)</span>
<span class="udiff-line-modified-removed">-           {</span>
<span class="udiff-line-modified-removed">-             const SBIXGlyph &amp;sbixGlyph = strike.imageOffsetsZ[glyph]((const void *) &amp;strike);</span>
<span class="udiff-line-modified-removed">-             callback ((const uint8_t*) &amp;sbixGlyph.data,</span>
<span class="udiff-line-modified-removed">-                       strike.imageOffsetsZ[glyph + 1] - strike.imageOffsetsZ[glyph] - 8,</span>
<span class="udiff-line-modified-removed">-                       group, glyph);</span>
<span class="udiff-line-modified-removed">-           }</span>
<span class="udiff-line-modified-added">+         struct</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+           HBUINT32      length;</span>
<span class="udiff-line-modified-added">+           Tag           type;</span>
<span class="udiff-line-modified-added">+         }               header;</span>
<span class="udiff-line-modified-added">+         HBUINT32        width;</span>
<span class="udiff-line-modified-added">+         HBUINT32        height;</span>
<span class="udiff-line-modified-added">+         HBUINT8         bitDepth;</span>
<span class="udiff-line-modified-added">+         HBUINT8         colorType;</span>
<span class="udiff-line-added">+         HBUINT8         compressionMethod;</span>
<span class="udiff-line-added">+         HBUINT8         filterMethod;</span>
<span class="udiff-line-added">+         HBUINT8         interlaceMethod;</span>
<span class="udiff-line-added">+       } IHDR;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       public:</span>
<span class="udiff-line-added">+       DEFINE_SIZE_STATIC (29);</span>
<span class="udiff-line-added">+     };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     bool get_png_extents (hb_font_t          *font,</span>
<span class="udiff-line-added">+                           hb_codepoint_t      glyph,</span>
<span class="udiff-line-added">+                           hb_glyph_extents_t *extents) const</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       /* Following code is safe to call even without data.</span>
<span class="udiff-line-added">+        * But faster to short-circuit. */</span>
<span class="udiff-line-added">+       if (!has_data ())</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       int x_offset = 0, y_offset = 0;</span>
<span class="udiff-line-added">+       unsigned int strike_ppem = 0;</span>
<span class="udiff-line-added">+       hb_blob_t *blob = reference_png (font, glyph, &amp;x_offset, &amp;y_offset, &amp;strike_ppem);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       const PNGHeader &amp;png = *blob-&gt;as&lt;PNGHeader&gt;();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       extents-&gt;x_bearing = x_offset;</span>
<span class="udiff-line-added">+       extents-&gt;y_bearing = y_offset;</span>
<span class="udiff-line-added">+       extents-&gt;width     = png.IHDR.width;</span>
<span class="udiff-line-added">+       extents-&gt;height    = png.IHDR.height;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       /* Convert to font units. */</span>
<span class="udiff-line-added">+       if (strike_ppem)</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         double scale = font-&gt;face-&gt;get_upem () / (double) strike_ppem;</span>
<span class="udiff-line-added">+         extents-&gt;x_bearing = round (extents-&gt;x_bearing * scale);</span>
<span class="udiff-line-added">+         extents-&gt;y_bearing = round (extents-&gt;y_bearing * scale);</span>
<span class="udiff-line-added">+         extents-&gt;width = round (extents-&gt;width * scale);</span>
<span class="udiff-line-added">+         extents-&gt;height = round (extents-&gt;height * scale);</span>
        }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       hb_blob_destroy (blob);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       return strike_ppem;</span>
      }
  
      private:
<span class="udiff-line-modified-removed">-     hb_blob_t *sbix_blob;</span>
<span class="udiff-line-removed">-     const sbix *sbix_table;</span>
<span class="udiff-line-modified-added">+     hb_blob_ptr_t&lt;sbix&gt; table;</span>
  
<span class="udiff-line-removed">-     unsigned int sbix_len;</span>
      unsigned int num_glyphs;
<span class="udiff-line-removed">- </span>
    };
  
<span class="udiff-line-added">+   bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     TRACE_SANITIZE (this);</span>
<span class="udiff-line-added">+     return_trace (likely (c-&gt;check_struct (this) &amp;&amp;</span>
<span class="udiff-line-added">+                           version &gt;= 1 &amp;&amp;</span>
<span class="udiff-line-added">+                           strikes.sanitize (c, this)));</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    protected:
    HBUINT16      version;        /* Table version number — set to 1 */
    HBUINT16      flags;          /* Bit 0: Set to 1. Bit 1: Draw outlines.
                                   * Bits 2 to 15: reserved (set to 0). */
<span class="udiff-line-modified-removed">-   LArrayOf&lt;LOffsetTo&lt;SBIXStrike&gt; &gt;</span>
<span class="udiff-line-modified-added">+   LOffsetLArrayOf&lt;SBIXStrike&gt;</span>
                  strikes;        /* Offsets from the beginning of the &#39;sbix&#39;
                                   * table to data for each individual bitmap strike. */
    public:
    DEFINE_SIZE_ARRAY (8, strikes);
  };
  
<span class="udiff-line-added">+ struct sbix_accelerator_t : sbix::accelerator_t {};</span>
<span class="udiff-line-added">+ </span>
  } /* namespace OT */
  
  #endif /* HB_OT_COLOR_SBIX_TABLE_HH */
</pre>
<center><a href="hb-ot-color-cpal-table.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-color-svg-table.hh.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>