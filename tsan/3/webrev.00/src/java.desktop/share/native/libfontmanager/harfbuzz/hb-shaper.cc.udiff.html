<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-shaper.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-shaper-list.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-static.cc.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-shaper.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,77 +22,55 @@</span>
   * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
   *
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="udiff-line-modified-removed">- #include &quot;hb-private.hh&quot;</span>
<span class="udiff-line-modified-removed">- #include &quot;hb-shaper-private.hh&quot;</span>
<span class="udiff-line-modified-removed">- #include &quot;hb-atomic-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-shaper.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-machinery.hh&quot;</span>
  
  
<span class="udiff-line-modified-removed">- static const hb_shaper_pair_t all_shapers[] = {</span>
<span class="udiff-line-modified-added">+ static const hb_shaper_entry_t all_shapers[] = {</span>
  #define HB_SHAPER_IMPLEMENT(name) {#name, _hb_##name##_shape},
  #include &quot;hb-shaper-list.hh&quot;
  #undef HB_SHAPER_IMPLEMENT
  };
  
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">- /* Thread-safe, lock-free, shapers */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static const hb_shaper_pair_t *static_shapers;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="udiff-line-removed">- static</span>
<span class="udiff-line-removed">- void free_static_shapers (void)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- retry:</span>
<span class="udiff-line-removed">-   hb_shaper_pair_t *shapers = (hb_shaper_pair_t *) hb_atomic_ptr_get (&amp;static_shapers);</span>
<span class="udiff-line-removed">-   if (!hb_atomic_ptr_cmpexch (&amp;static_shapers, shapers, nullptr))</span>
<span class="udiff-line-removed">-     goto retry;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (unlikely (shapers != all_shapers))</span>
<span class="udiff-line-removed">-     free ((void *) shapers);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-modified-added">+ static void free_static_shapers ();</span>
  #endif
  
<span class="udiff-line-modified-removed">- const hb_shaper_pair_t *</span>
<span class="udiff-line-modified-removed">- _hb_shapers_get (void)</span>
<span class="udiff-line-modified-added">+ static struct hb_shapers_lazy_loader_t : hb_lazy_loader_t&lt;const hb_shaper_entry_t,</span>
<span class="udiff-line-modified-added">+                                                           hb_shapers_lazy_loader_t&gt;</span>
  {
<span class="udiff-line-modified-removed">- retry:</span>
<span class="udiff-line-removed">-   hb_shaper_pair_t *shapers = (hb_shaper_pair_t *) hb_atomic_ptr_get (&amp;static_shapers);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (unlikely (!shapers))</span>
<span class="udiff-line-modified-added">+   static hb_shaper_entry_t *create ()</span>
    {
      char *env = getenv (&quot;HB_SHAPER_LIST&quot;);
<span class="udiff-line-modified-removed">-     if (!env || !*env) {</span>
<span class="udiff-line-modified-removed">-       (void) hb_atomic_ptr_cmpexch (&amp;static_shapers, nullptr, &amp;all_shapers[0]);</span>
<span class="udiff-line-removed">-       return (const hb_shaper_pair_t *) all_shapers;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     if (!env || !*env)</span>
<span class="udiff-line-modified-added">+       return nullptr;</span>
  
<span class="udiff-line-modified-removed">-     /* Not found; allocate one. */</span>
<span class="udiff-line-modified-removed">-     shapers = (hb_shaper_pair_t *) calloc (1, sizeof (all_shapers));</span>
<span class="udiff-line-modified-removed">-     if (unlikely (!shapers)) {</span>
<span class="udiff-line-removed">-       (void) hb_atomic_ptr_cmpexch (&amp;static_shapers, nullptr, &amp;all_shapers[0]);</span>
<span class="udiff-line-removed">-       return (const hb_shaper_pair_t *) all_shapers;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     hb_shaper_entry_t *shapers = (hb_shaper_entry_t *) calloc (1, sizeof (all_shapers));</span>
<span class="udiff-line-modified-added">+     if (unlikely (!shapers))</span>
<span class="udiff-line-modified-added">+       return nullptr;</span>
  
      memcpy (shapers, all_shapers, sizeof (all_shapers));
  
       /* Reorder shaper list to prefer requested shapers. */
      unsigned int i = 0;
      char *end, *p = env;
<span class="udiff-line-modified-removed">-     for (;;) {</span>
<span class="udiff-line-modified-added">+     for (;;)</span>
<span class="udiff-line-added">+     {</span>
        end = strchr (p, &#39;,&#39;);
        if (!end)
          end = p + strlen (p);
  
        for (unsigned int j = i; j &lt; ARRAY_LENGTH (all_shapers); j++)
          if (end - p == (int) strlen (shapers[j].name) &amp;&amp;
              0 == strncmp (shapers[j].name, p, end - p))
          {
            /* Reorder this shaper to position i */
<span class="udiff-line-modified-removed">-          struct hb_shaper_pair_t t = shapers[j];</span>
<span class="udiff-line-modified-added">+          struct hb_shaper_entry_t t = shapers[j];</span>
           memmove (&amp;shapers[i + 1], &amp;shapers[i], sizeof (shapers[i]) * (j - i));
           shapers[i] = t;
           i++;
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -100,17 +78,28 @@</span>
          break;
        else
          p = end + 1;
      }
  
<span class="udiff-line-modified-removed">-     if (!hb_atomic_ptr_cmpexch (&amp;static_shapers, nullptr, shapers)) {</span>
<span class="udiff-line-modified-removed">-       free (shapers);</span>
<span class="udiff-line-removed">-       goto retry;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="udiff-line-removed">-     atexit (free_static_shapers); /* First person registers atexit() callback. */</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-modified-added">+     atexit (free_static_shapers);</span>
  #endif
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return shapers;</span>
    }
<span class="udiff-line-added">+   static void destroy (const hb_shaper_entry_t *p) { free ((void *) p); }</span>
<span class="udiff-line-added">+   static const hb_shaper_entry_t *get_null ()      { return all_shapers; }</span>
<span class="udiff-line-added">+ } static_shapers;</span>
  
<span class="udiff-line-modified-removed">-   return shapers;</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-added">+ static</span>
<span class="udiff-line-added">+ void free_static_shapers ()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   static_shapers.free_instance ();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ const hb_shaper_entry_t *</span>
<span class="udiff-line-added">+ _hb_shapers_get ()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   return static_shapers.get_unconst ();</span>
  }
</pre>
<center><a href="hb-shaper-list.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-static.cc.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>