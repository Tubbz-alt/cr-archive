<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-color-cpal-table.hh</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright © 2016  Google, Inc.
  3  * Copyright © 2018  Ebrahim Byagowi
  4  *
  5  *  This is part of HarfBuzz, a text shaping library.
  6  *
  7  * Permission is hereby granted, without written agreement and without
  8  * license or royalty fees, to use, copy, modify, and distribute this
  9  * software and its documentation for any purpose, provided that the
 10  * above copyright notice and the following two paragraphs appear in
 11  * all copies of this software.
 12  *
 13  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 14  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 15  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 16  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 17  * DAMAGE.
 18  *
 19  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 20  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 21  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 22  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 23  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 24  *
 25  * Google Author(s): Sascha Brawer
 26  */
 27 
 28 #ifndef HB_OT_COLOR_CPAL_TABLE_HH
 29 #define HB_OT_COLOR_CPAL_TABLE_HH
 30 
<a name="1" id="anc1"></a><span class="line-modified"> 31 #include &quot;hb-open-type.hh&quot;</span>
<span class="line-modified"> 32 #include &quot;hb-ot-color.h&quot;</span>
<span class="line-modified"> 33 #include &quot;hb-ot-name.h&quot;</span>













































 34 
 35 
 36 /*
 37  * CPAL -- Color Palette
 38  * https://docs.microsoft.com/en-us/typography/opentype/spec/cpal
 39  */
 40 #define HB_OT_TAG_CPAL HB_TAG(&#39;C&#39;,&#39;P&#39;,&#39;A&#39;,&#39;L&#39;)
 41 
 42 
 43 namespace OT {
 44 
 45 
 46 struct CPALV1Tail
 47 {
 48   friend struct CPAL;
 49 
<a name="2" id="anc2"></a><span class="line-modified"> 50   private:</span>
<span class="line-modified"> 51   hb_ot_color_palette_flags_t get_palette_flags (const void *base,</span>
<span class="line-added"> 52                                                  unsigned int palette_index,</span>
<span class="line-added"> 53                                                  unsigned int palette_count) const</span>
 54   {
<a name="3" id="anc3"></a><span class="line-modified"> 55     if (!paletteFlagsZ) return HB_OT_COLOR_PALETTE_FLAG_DEFAULT;</span>
<span class="line-modified"> 56     return (hb_ot_color_palette_flags_t) (uint32_t)</span>
<span class="line-modified"> 57            (base+paletteFlagsZ).as_array (palette_count)[palette_index];</span>


 58   }
 59 
<a name="4" id="anc4"></a><span class="line-modified"> 60   hb_ot_name_id_t get_palette_name_id (const void *base,</span>
<span class="line-modified"> 61                                        unsigned int palette_index,</span>
<span class="line-modified"> 62                                        unsigned int palette_count) const</span>
 63   {
<a name="5" id="anc5"></a><span class="line-modified"> 64     if (!paletteLabelsZ) return HB_OT_NAME_ID_INVALID;</span>
<span class="line-modified"> 65     return (base+paletteLabelsZ).as_array (palette_count)[palette_index];</span>
 66   }
 67 
<a name="6" id="anc6"></a><span class="line-modified"> 68   hb_ot_name_id_t get_color_name_id (const void *base,</span>
<span class="line-modified"> 69                                      unsigned int color_index,</span>
<span class="line-added"> 70                                      unsigned int color_count) const</span>
 71   {
<a name="7" id="anc7"></a><span class="line-modified"> 72     if (!colorLabelsZ) return HB_OT_NAME_ID_INVALID;</span>
<span class="line-modified"> 73     return (base+colorLabelsZ).as_array (color_count)[color_index];</span>
<span class="line-added"> 74   }</span>
<span class="line-added"> 75 </span>
<span class="line-added"> 76   public:</span>
<span class="line-added"> 77   bool sanitize (hb_sanitize_context_t *c,</span>
<span class="line-added"> 78                  const void *base,</span>
<span class="line-added"> 79                  unsigned int palette_count,</span>
<span class="line-added"> 80                  unsigned int color_count) const</span>
<span class="line-added"> 81   {</span>
<span class="line-added"> 82     TRACE_SANITIZE (this);</span>
<span class="line-added"> 83     return_trace (c-&gt;check_struct (this) &amp;&amp;</span>
<span class="line-added"> 84                   (!paletteFlagsZ  || (base+paletteFlagsZ).sanitize (c, palette_count)) &amp;&amp;</span>
<span class="line-added"> 85                   (!paletteLabelsZ || (base+paletteLabelsZ).sanitize (c, palette_count)) &amp;&amp;</span>
<span class="line-added"> 86                   (!colorLabelsZ   || (base+colorLabelsZ).sanitize (c, color_count)));</span>
 87   }
 88 
 89   protected:
<a name="8" id="anc8"></a><span class="line-modified"> 90   LNNOffsetTo&lt;UnsizedArrayOf&lt;HBUINT32&gt; &gt;</span>
 91                 paletteFlagsZ;          /* Offset from the beginning of CPAL table to
 92                                          * the Palette Type Array. Set to 0 if no array
 93                                          * is provided. */
<a name="9" id="anc9"></a><span class="line-modified"> 94   LNNOffsetTo&lt;UnsizedArrayOf&lt;NameID&gt; &gt;</span>
<span class="line-modified"> 95                 paletteLabelsZ;         /* Offset from the beginning of CPAL table to</span>
<span class="line-modified"> 96                                          * the palette labels array. Set to 0 if no</span>
 97                                          * array is provided. */
<a name="10" id="anc10"></a><span class="line-modified"> 98   LNNOffsetTo&lt;UnsizedArrayOf&lt;NameID&gt; &gt;</span>
<span class="line-modified"> 99                 colorLabelsZ;           /* Offset from the beginning of CPAL table to</span>
<span class="line-modified">100                                          * the color labels array. Set to 0</span>
101                                          * if no array is provided. */
102   public:
103   DEFINE_SIZE_STATIC (12);
104 };
105 
106 typedef HBUINT32 BGRAColor;
107 
108 struct CPAL
109 {
<a name="11" id="anc11"></a><span class="line-modified">110   static constexpr hb_tag_t tableTag = HB_OT_TAG_CPAL;</span>
111 
<a name="12" id="anc12"></a><span class="line-modified">112   bool has_data () const { return numPalettes; }</span>



















113 
<a name="13" id="anc13"></a><span class="line-modified">114   unsigned int get_size () const</span>
<span class="line-modified">115   { return min_size + numPalettes * sizeof (colorRecordIndicesZ[0]); }</span>


116 
<a name="14" id="anc14"></a><span class="line-modified">117   unsigned int get_palette_count () const { return numPalettes; }</span>
<span class="line-modified">118   unsigned int get_color_count () const   { return numColors; }</span>


119 
<a name="15" id="anc15"></a><span class="line-modified">120   hb_ot_color_palette_flags_t get_palette_flags (unsigned int palette_index) const</span>
<span class="line-modified">121   { return v1 ().get_palette_flags (this, palette_index, numPalettes); }</span>

122 
<a name="16" id="anc16"></a><span class="line-modified">123   hb_ot_name_id_t get_palette_name_id (unsigned int palette_index) const</span>
<span class="line-modified">124   { return v1 ().get_palette_name_id (this, palette_index, numPalettes); }</span>


125 
<a name="17" id="anc17"></a><span class="line-modified">126   hb_ot_name_id_t get_color_name_id (unsigned int color_index) const</span>
<span class="line-modified">127   { return v1 ().get_color_name_id (this, color_index, numColors); }</span>

128 
<a name="18" id="anc18"></a><span class="line-modified">129   unsigned int get_palette_colors (unsigned int  palette_index,</span>
<span class="line-added">130                                    unsigned int  start_offset,</span>
<span class="line-added">131                                    unsigned int *color_count, /* IN/OUT.  May be NULL. */</span>
<span class="line-added">132                                    hb_color_t   *colors       /* OUT.     May be NULL. */) const</span>
133   {
<a name="19" id="anc19"></a><span class="line-modified">134     if (unlikely (palette_index &gt;= numPalettes))</span>
<span class="line-added">135     {</span>
<span class="line-added">136       if (color_count) *color_count = 0;</span>
<span class="line-added">137       return 0;</span>
<span class="line-added">138     }</span>
<span class="line-added">139     unsigned int start_index = colorRecordIndicesZ[palette_index];</span>
<span class="line-added">140     hb_array_t&lt;const BGRAColor&gt; all_colors ((this+colorRecordsZ).arrayZ, numColorRecords);</span>
<span class="line-added">141     hb_array_t&lt;const BGRAColor&gt; palette_colors = all_colors.sub_array (start_index,</span>
<span class="line-added">142                                                                        numColors);</span>
<span class="line-added">143     if (color_count)</span>
<span class="line-added">144     {</span>
<span class="line-added">145       hb_array_t&lt;const BGRAColor&gt; segment_colors = palette_colors.sub_array (start_offset, *color_count);</span>
<span class="line-added">146       /* Always return numColors colors per palette even if it has out-of-bounds start index. */</span>
<span class="line-added">147       unsigned int count = MIN&lt;unsigned int&gt; (MAX&lt;int&gt; (numColors - start_offset, 0), *color_count);</span>
<span class="line-added">148       *color_count = count;</span>
<span class="line-added">149       for (unsigned int i = 0; i &lt; count; i++)</span>
<span class="line-added">150         colors[i] = segment_colors[i]; /* Bound-checked read. */</span>
<span class="line-added">151     }</span>
<span class="line-added">152     return numColors;</span>
153   }
154 
<a name="20" id="anc20"></a><span class="line-modified">155   private:</span>
<span class="line-modified">156   const CPALV1Tail&amp; v1 () const</span>
157   {
<a name="21" id="anc21"></a><span class="line-modified">158     if (version == 0) return Null(CPALV1Tail);</span>
<span class="line-modified">159     return StructAfter&lt;CPALV1Tail&gt; (*this);</span>
<span class="line-added">160   }</span>
161 
<a name="22" id="anc22"></a><span class="line-modified">162   public:</span>
<span class="line-modified">163   bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="line-modified">164   {</span>
<span class="line-added">165     TRACE_SANITIZE (this);</span>
<span class="line-added">166     return_trace (c-&gt;check_struct (this) &amp;&amp;</span>
<span class="line-added">167                   (this+colorRecordsZ).sanitize (c, numColorRecords) &amp;&amp;</span>
<span class="line-added">168                   colorRecordIndicesZ.sanitize (c, numPalettes) &amp;&amp;</span>
<span class="line-added">169                   (version == 0 || v1 ().sanitize (c, this, numPalettes, numColors)));</span>
170   }
171 
172   protected:
173   HBUINT16      version;                /* Table version number */
174   /* Version 0 */
<a name="23" id="anc23"></a><span class="line-modified">175   HBUINT16      numColors;              /* Number of colors in each palette. */</span>
176   HBUINT16      numPalettes;            /* Number of palettes in the table. */
177   HBUINT16      numColorRecords;        /* Total number of color records, combined for
178                                          * all palettes. */
<a name="24" id="anc24"></a><span class="line-modified">179   LNNOffsetTo&lt;UnsizedArrayOf&lt;BGRAColor&gt; &gt;</span>
180                 colorRecordsZ;          /* Offset from the beginning of CPAL table to
181                                          * the first ColorRecord. */
182   UnsizedArrayOf&lt;HBUINT16&gt;
183                 colorRecordIndicesZ;    /* Index of each palette’s first color record in
184                                          * the combined color record array. */
185 /*CPALV1Tail    v1;*/
186   public:
187   DEFINE_SIZE_ARRAY (12, colorRecordIndicesZ);
188 };
189 
190 } /* namespace OT */
191 
192 
193 #endif /* HB_OT_COLOR_CPAL_TABLE_HH */
<a name="25" id="anc25"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="25" type="hidden" />
</body>
</html>