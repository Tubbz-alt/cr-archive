<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-shape-complex-use.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-shape-complex-use-table.cc.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-shape-fallback.cc.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-shape-complex-use.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,12 +24,13 @@</span>
   *
   * Mozilla Author(s): Jonathan Kew
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="udiff-line-modified-removed">- #include &quot;hb-ot-shape-complex-use-private.hh&quot;</span>
<span class="udiff-line-modified-removed">- #include &quot;hb-ot-shape-complex-arabic-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-ot-shape-complex-use.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-ot-shape-complex-arabic.hh&quot;</span>
<span class="udiff-line-added">+ #include &quot;hb-ot-shape-complex-vowel-constraints.hh&quot;</span>
  
  /* buffer var allocations */
  #define use_category() complex_var_u8_0()
  
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -77,18 +78,26 @@</span>
  static const hb_tag_t
  other_features[] =
  {
    /*
     * Other features.
<span class="udiff-line-modified-removed">-    * These features are applied all at once, after reordering.</span>
<span class="udiff-line-modified-added">+    * These features are applied all at once, after reordering and</span>
<span class="udiff-line-added">+    * clearing syllables.</span>
     */
    HB_TAG(&#39;a&#39;,&#39;b&#39;,&#39;v&#39;,&#39;s&#39;),
    HB_TAG(&#39;b&#39;,&#39;l&#39;,&#39;w&#39;,&#39;s&#39;),
    HB_TAG(&#39;h&#39;,&#39;a&#39;,&#39;l&#39;,&#39;n&#39;),
    HB_TAG(&#39;p&#39;,&#39;r&#39;,&#39;e&#39;,&#39;s&#39;),
    HB_TAG(&#39;p&#39;,&#39;s&#39;,&#39;t&#39;,&#39;s&#39;),
<span class="udiff-line-modified-removed">-   /* Positioning features, though we don&#39;t care about the types. */</span>
<span class="udiff-line-modified-added">+ };</span>
<span class="udiff-line-added">+ static const hb_tag_t</span>
<span class="udiff-line-added">+ positioning_features[] =</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   /*</span>
<span class="udiff-line-added">+    * Positioning features.</span>
<span class="udiff-line-added">+    * We don&#39;t care about the types.</span>
<span class="udiff-line-added">+    */</span>
    HB_TAG(&#39;d&#39;,&#39;i&#39;,&#39;s&#39;,&#39;t&#39;),
    HB_TAG(&#39;a&#39;,&#39;b&#39;,&#39;v&#39;,&#39;m&#39;),
    HB_TAG(&#39;b&#39;,&#39;l&#39;,&#39;w&#39;,&#39;m&#39;),
  };
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -110,53 +119,60 @@</span>
               hb_buffer_t *buffer);
  static void
  reorder (const hb_ot_shape_plan_t *plan,
           hb_font_t *font,
           hb_buffer_t *buffer);
<span class="udiff-line-added">+ static void</span>
<span class="udiff-line-added">+ clear_syllables (const hb_ot_shape_plan_t *plan,</span>
<span class="udiff-line-added">+                  hb_font_t *font,</span>
<span class="udiff-line-added">+                  hb_buffer_t *buffer);</span>
  
  static void
  collect_features_use (hb_ot_shape_planner_t *plan)
  {
    hb_ot_map_builder_t *map = &amp;plan-&gt;map;
  
    /* Do this before any lookups have been applied. */
    map-&gt;add_gsub_pause (setup_syllables);
  
    /* &quot;Default glyph pre-processing group&quot; */
<span class="udiff-line-modified-removed">-   map-&gt;add_global_bool_feature (HB_TAG(&#39;l&#39;,&#39;o&#39;,&#39;c&#39;,&#39;l&#39;));</span>
<span class="udiff-line-modified-removed">-   map-&gt;add_global_bool_feature (HB_TAG(&#39;c&#39;,&#39;c&#39;,&#39;m&#39;,&#39;p&#39;));</span>
<span class="udiff-line-modified-removed">-   map-&gt;add_global_bool_feature (HB_TAG(&#39;n&#39;,&#39;u&#39;,&#39;k&#39;,&#39;t&#39;));</span>
<span class="udiff-line-modified-removed">-   map-&gt;add_global_bool_feature (HB_TAG(&#39;a&#39;,&#39;k&#39;,&#39;h&#39;,&#39;n&#39;));</span>
<span class="udiff-line-modified-added">+   map-&gt;enable_feature (HB_TAG(&#39;l&#39;,&#39;o&#39;,&#39;c&#39;,&#39;l&#39;));</span>
<span class="udiff-line-modified-added">+   map-&gt;enable_feature (HB_TAG(&#39;c&#39;,&#39;c&#39;,&#39;m&#39;,&#39;p&#39;));</span>
<span class="udiff-line-modified-added">+   map-&gt;enable_feature (HB_TAG(&#39;n&#39;,&#39;u&#39;,&#39;k&#39;,&#39;t&#39;));</span>
<span class="udiff-line-modified-added">+   map-&gt;enable_feature (HB_TAG(&#39;a&#39;,&#39;k&#39;,&#39;h&#39;,&#39;n&#39;), F_MANUAL_ZWJ);</span>
  
    /* &quot;Reordering group&quot; */
    map-&gt;add_gsub_pause (clear_substitution_flags);
<span class="udiff-line-modified-removed">-   map-&gt;add_feature (HB_TAG(&#39;r&#39;,&#39;p&#39;,&#39;h&#39;,&#39;f&#39;), 1, F_MANUAL_ZWJ);</span>
<span class="udiff-line-modified-added">+   map-&gt;add_feature (HB_TAG(&#39;r&#39;,&#39;p&#39;,&#39;h&#39;,&#39;f&#39;), F_MANUAL_ZWJ);</span>
    map-&gt;add_gsub_pause (record_rphf);
    map-&gt;add_gsub_pause (clear_substitution_flags);
<span class="udiff-line-modified-removed">-   map-&gt;add_feature (HB_TAG(&#39;p&#39;,&#39;r&#39;,&#39;e&#39;,&#39;f&#39;), 1, F_GLOBAL | F_MANUAL_ZWJ);</span>
<span class="udiff-line-modified-added">+   map-&gt;enable_feature (HB_TAG(&#39;p&#39;,&#39;r&#39;,&#39;e&#39;,&#39;f&#39;), F_MANUAL_ZWJ);</span>
    map-&gt;add_gsub_pause (record_pref);
  
    /* &quot;Orthographic unit shaping group&quot; */
    for (unsigned int i = 0; i &lt; ARRAY_LENGTH (basic_features); i++)
<span class="udiff-line-modified-removed">-     map-&gt;add_feature (basic_features[i], 1, F_GLOBAL | F_MANUAL_ZWJ);</span>
<span class="udiff-line-modified-added">+     map-&gt;enable_feature (basic_features[i], F_MANUAL_ZWJ);</span>
  
    map-&gt;add_gsub_pause (reorder);
<span class="udiff-line-added">+   map-&gt;add_gsub_pause (clear_syllables);</span>
  
    /* &quot;Topographical features&quot; */
    for (unsigned int i = 0; i &lt; ARRAY_LENGTH (arabic_features); i++)
<span class="udiff-line-modified-removed">-     map-&gt;add_feature (arabic_features[i], 1, F_NONE);</span>
<span class="udiff-line-modified-added">+     map-&gt;add_feature (arabic_features[i]);</span>
    map-&gt;add_gsub_pause (nullptr);
  
<span class="udiff-line-modified-removed">-   /* &quot;Standard typographic presentation&quot; and &quot;Positional feature application&quot; */</span>
<span class="udiff-line-modified-added">+   /* &quot;Standard typographic presentation&quot; */</span>
    for (unsigned int i = 0; i &lt; ARRAY_LENGTH (other_features); i++)
<span class="udiff-line-modified-removed">-     map-&gt;add_feature (other_features[i], 1, F_GLOBAL | F_MANUAL_ZWJ);</span>
<span class="udiff-line-modified-added">+     map-&gt;enable_feature (other_features[i], F_MANUAL_ZWJ);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* &quot;Positional feature application&quot; */</span>
<span class="udiff-line-added">+   for (unsigned int i = 0; i &lt; ARRAY_LENGTH (positioning_features); i++)</span>
<span class="udiff-line-added">+     map-&gt;enable_feature (positioning_features[i]);</span>
  }
  
  struct use_shape_plan_t
  {
<span class="udiff-line-removed">-   ASSERT_POD ();</span>
<span class="udiff-line-removed">- </span>
    hb_mask_t rphf_mask;
  
    arabic_shape_plan_t *arabic_plan;
  };
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -359,11 +375,11 @@</span>
    setup_rphf_mask (plan, buffer);
    setup_topographical_masks (plan, buffer);
  }
  
  static void
<span class="udiff-line-modified-removed">- clear_substitution_flags (const hb_ot_shape_plan_t *plan,</span>
<span class="udiff-line-modified-added">+ clear_substitution_flags (const hb_ot_shape_plan_t *plan HB_UNUSED,</span>
                            hb_font_t *font HB_UNUSED,
                            hb_buffer_t *buffer)
  {
    hb_glyph_info_t *info = buffer-&gt;info;
    unsigned int count = buffer-&gt;len;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -371,11 +387,11 @@</span>
      _hb_glyph_info_clear_substituted (&amp;info[i]);
  }
  
  static void
  record_rphf (const hb_ot_shape_plan_t *plan,
<span class="udiff-line-modified-removed">-              hb_font_t *font,</span>
<span class="udiff-line-modified-added">+              hb_font_t *font HB_UNUSED,</span>
               hb_buffer_t *buffer)
  {
    const use_shape_plan_t *use_plan = (const use_shape_plan_t *) plan-&gt;data;
  
    hb_mask_t mask = use_plan-&gt;rphf_mask;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -393,12 +409,12 @@</span>
        }
    }
  }
  
  static void
<span class="udiff-line-modified-removed">- record_pref (const hb_ot_shape_plan_t *plan,</span>
<span class="udiff-line-modified-removed">-              hb_font_t *font,</span>
<span class="udiff-line-modified-added">+ record_pref (const hb_ot_shape_plan_t *plan HB_UNUSED,</span>
<span class="udiff-line-modified-added">+              hb_font_t *font HB_UNUSED,</span>
               hb_buffer_t *buffer)
  {
    hb_glyph_info_t *info = buffer-&gt;info;
  
    foreach_syllable (buffer, start, end)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -414,11 +430,12 @@</span>
  }
  
  static inline bool
  is_halant (const hb_glyph_info_t &amp;info)
  {
<span class="udiff-line-modified-removed">-   return info.use_category() == USE_H &amp;&amp; !_hb_glyph_info_ligated (&amp;info);</span>
<span class="udiff-line-modified-added">+   return (info.use_category() == USE_H || info.use_category() == USE_HVM) &amp;&amp;</span>
<span class="udiff-line-added">+          !_hb_glyph_info_ligated (&amp;info);</span>
  }
  
  static void
  reorder_syllable (hb_buffer_t *buffer, unsigned int start, unsigned int end)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -431,47 +448,64 @@</span>
                     0))))
      return;
  
    hb_glyph_info_t *info = buffer-&gt;info;
  
<span class="udiff-line-modified-removed">- #define BASE_FLAGS (FLAG (USE_B) | FLAG (USE_GB))</span>
<span class="udiff-line-modified-added">+ #define POST_BASE_FLAGS64 (FLAG64 (USE_FM) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_FAbv) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_FBlw) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_FPst) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_MAbv) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_MBlw) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_MPst) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_MPre) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_VAbv) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_VBlw) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_VPst) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_VPre) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_VMAbv) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_VMBlw) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_VMPst) | \</span>
<span class="udiff-line-added">+                            FLAG64 (USE_VMPre))</span>
  
    /* Move things forward. */
    if (info[start].use_category() == USE_R &amp;&amp; end - start &gt; 1)
    {
<span class="udiff-line-modified-removed">-     /* Got a repha.  Reorder it to after first base, before first halant. */</span>
<span class="udiff-line-modified-added">+     /* Got a repha.  Reorder it towards the end, but before the first post-base</span>
<span class="udiff-line-added">+      * glyph. */</span>
      for (unsigned int i = start + 1; i &lt; end; i++)
<span class="udiff-line-modified-removed">-       if ((FLAG_UNSAFE (info[i].use_category()) &amp; (BASE_FLAGS)) || is_halant (info[i]))</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-added">+       bool is_post_base_glyph = (FLAG64_UNSAFE (info[i].use_category()) &amp; POST_BASE_FLAGS64) ||</span>
<span class="udiff-line-added">+                                 is_halant (info[i]);</span>
<span class="udiff-line-added">+       if (is_post_base_glyph || i == end - 1)</span>
        {
<span class="udiff-line-modified-removed">-         /* If we hit a halant, move before it; otherwise it&#39;s a base: move to it&#39;s</span>
<span class="udiff-line-modified-removed">-          * place, and shift things in between backward. */</span>
<span class="udiff-line-modified-added">+         /* If we hit a post-base glyph, move before it; otherwise move to the</span>
<span class="udiff-line-modified-added">+          * end. Shift things in between backward. */</span>
  
<span class="udiff-line-modified-removed">-         if (is_halant (info[i]))</span>
<span class="udiff-line-modified-added">+         if (is_post_base_glyph)</span>
            i--;
  
          buffer-&gt;merge_clusters (start, i + 1);
          hb_glyph_info_t t = info[start];
          memmove (&amp;info[start], &amp;info[start + 1], (i - start) * sizeof (info[0]));
          info[i] = t;
  
          break;
        }
<span class="udiff-line-added">+     }</span>
    }
  
    /* Move things back. */
<span class="udiff-line-modified-removed">-   unsigned int j = end;</span>
<span class="udiff-line-modified-added">+   unsigned int j = start;</span>
    for (unsigned int i = start; i &lt; end; i++)
    {
      uint32_t flag = FLAG_UNSAFE (info[i].use_category());
<span class="udiff-line-modified-removed">-     if ((flag &amp; (BASE_FLAGS)) || is_halant (info[i]))</span>
<span class="udiff-line-modified-added">+     if (is_halant (info[i]))</span>
      {
<span class="udiff-line-modified-removed">-       /* If we hit a halant, move after it; otherwise it&#39;s a base: move to it&#39;s</span>
<span class="udiff-line-modified-removed">-        * place, and shift things in between backward. */</span>
<span class="udiff-line-modified-removed">-       if (is_halant (info[i]))</span>
<span class="udiff-line-removed">-         j = i + 1;</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-         j = i;</span>
<span class="udiff-line-modified-added">+       /* If we hit a halant, move after it; otherwise move to the beginning, and</span>
<span class="udiff-line-modified-added">+        * shift things in between forward. */</span>
<span class="udiff-line-modified-added">+       j = i + 1;</span>
      }
      else if (((flag) &amp; (FLAG (USE_VPre) | FLAG (USE_VMPre))) &amp;&amp;
               /* Only move the first component of a MultipleSubst. */
               0 == _hb_glyph_info_get_lig_comp (&amp;info[i]) &amp;&amp;
               j &lt; i)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -534,51 +568,44 @@</span>
        buffer-&gt;output_info (ginfo);
      }
      else
        buffer-&gt;next_glyph ();
    }
<span class="udiff-line-removed">- </span>
    buffer-&gt;swap_buffers ();
  }
  
  static void
  reorder (const hb_ot_shape_plan_t *plan,
           hb_font_t *font,
           hb_buffer_t *buffer)
  {
    insert_dotted_circles (plan, font, buffer);
  
<span class="udiff-line-removed">-   hb_glyph_info_t *info = buffer-&gt;info;</span>
<span class="udiff-line-removed">- </span>
    foreach_syllable (buffer, start, end)
      reorder_syllable (buffer, start, end);
  
<span class="udiff-line-modified-removed">-   /* Zero syllables now... */</span>
<span class="udiff-line-modified-added">+   HB_BUFFER_DEALLOCATE_VAR (buffer, use_category);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static void</span>
<span class="udiff-line-added">+ clear_syllables (const hb_ot_shape_plan_t *plan HB_UNUSED,</span>
<span class="udiff-line-added">+                  hb_font_t *font HB_UNUSED,</span>
<span class="udiff-line-added">+                  hb_buffer_t *buffer)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   hb_glyph_info_t *info = buffer-&gt;info;</span>
    unsigned int count = buffer-&gt;len;
    for (unsigned int i = 0; i &lt; count; i++)
      info[i].syllable() = 0;
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   HB_BUFFER_DEALLOCATE_VAR (buffer, use_category);</span>
  }
  
<span class="udiff-line-removed">- static bool</span>
<span class="udiff-line-removed">- decompose_use (const hb_ot_shape_normalize_context_t *c,</span>
<span class="udiff-line-removed">-                 hb_codepoint_t  ab,</span>
<span class="udiff-line-removed">-                 hb_codepoint_t *a,</span>
<span class="udiff-line-removed">-                 hb_codepoint_t *b)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-   switch (ab)</span>
<span class="udiff-line-removed">-   {</span>
<span class="udiff-line-removed">-     /* Chakma:</span>
<span class="udiff-line-removed">-      * Special case where the Unicode decomp gives matras in the wrong order</span>
<span class="udiff-line-removed">-      * for cluster validation.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     case 0x1112Eu : *a = 0x11127u; *b= 0x11131u; return true;</span>
<span class="udiff-line-removed">-     case 0x1112Fu : *a = 0x11127u; *b= 0x11132u; return true;</span>
<span class="udiff-line-removed">-   }</span>
  
<span class="udiff-line-modified-removed">-   return (bool) c-&gt;unicode-&gt;decompose (ab, a, b);</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-added">+ preprocess_text_use (const hb_ot_shape_plan_t *plan,</span>
<span class="udiff-line-added">+                      hb_buffer_t              *buffer,</span>
<span class="udiff-line-added">+                      hb_font_t                *font)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   _hb_preprocess_text_vowel_constraints (plan, buffer, font);</span>
  }
  
  static bool
  compose_use (const hb_ot_shape_normalize_context_t *c,
               hb_codepoint_t  a,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -597,16 +624,16 @@</span>
  {
    collect_features_use,
    nullptr, /* override_features */
    data_create_use,
    data_destroy_use,
<span class="udiff-line-modified-removed">-   nullptr, /* preprocess_text */</span>
<span class="udiff-line-modified-added">+   preprocess_text_use,</span>
    nullptr, /* postprocess_glyphs */
    HB_OT_SHAPE_NORMALIZATION_MODE_COMPOSED_DIACRITICS_NO_SHORT_CIRCUIT,
<span class="udiff-line-modified-removed">-   decompose_use,</span>
<span class="udiff-line-modified-added">+   nullptr, /* decompose */</span>
    compose_use,
    setup_masks_use,
<span class="udiff-line-modified-removed">-   nullptr, /* disable_otl */</span>
<span class="udiff-line-modified-added">+   HB_TAG_NONE, /* gpos_tag */</span>
    nullptr, /* reorder_marks */
    HB_OT_SHAPE_ZERO_WIDTH_MARKS_BY_GDEF_EARLY,
    false, /* fallback_position */
  };
</pre>
<center><a href="hb-ot-shape-complex-use-table.cc.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-shape-fallback.cc.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>