<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-shape-complex-myanmar.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-shape-complex-myanmar-machine.hh.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-shape-complex-thai.cc.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-shape-complex-myanmar.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 22,11 ***</span>
   * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
   *
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="line-modified">! #include &quot;hb-ot-shape-complex-myanmar-private.hh&quot;</span>
  
  
  /*
   * Myanmar shaper.
   */
<span class="line-new-header">--- 22,11 ---</span>
   * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
   *
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="line-modified">! #include &quot;hb-ot-shape-complex-myanmar.hh&quot;</span>
  
  
  /*
   * Myanmar shaper.
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 34,11 ***</span>
  static const hb_tag_t
  basic_features[] =
  {
    /*
     * Basic features.
<span class="line-modified">!    * These features are applied in order, one at a time, after initial_reordering.</span>
     */
    HB_TAG(&#39;r&#39;,&#39;p&#39;,&#39;h&#39;,&#39;f&#39;),
    HB_TAG(&#39;p&#39;,&#39;r&#39;,&#39;e&#39;,&#39;f&#39;),
    HB_TAG(&#39;b&#39;,&#39;l&#39;,&#39;w&#39;,&#39;f&#39;),
    HB_TAG(&#39;p&#39;,&#39;s&#39;,&#39;t&#39;,&#39;f&#39;),
<span class="line-new-header">--- 34,11 ---</span>
  static const hb_tag_t
  basic_features[] =
  {
    /*
     * Basic features.
<span class="line-modified">!    * These features are applied in order, one at a time, after reordering.</span>
     */
    HB_TAG(&#39;r&#39;,&#39;p&#39;,&#39;h&#39;,&#39;f&#39;),
    HB_TAG(&#39;p&#39;,&#39;r&#39;,&#39;e&#39;,&#39;f&#39;),
    HB_TAG(&#39;b&#39;,&#39;l&#39;,&#39;w&#39;,&#39;f&#39;),
    HB_TAG(&#39;p&#39;,&#39;s&#39;,&#39;t&#39;,&#39;f&#39;),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,17 ***</span>
  static const hb_tag_t
  other_features[] =
  {
    /*
     * Other features.
<span class="line-modified">!    * These features are applied all at once, after final_reordering.</span>
     */
    HB_TAG(&#39;p&#39;,&#39;r&#39;,&#39;e&#39;,&#39;s&#39;),
    HB_TAG(&#39;a&#39;,&#39;b&#39;,&#39;v&#39;,&#39;s&#39;),
    HB_TAG(&#39;b&#39;,&#39;l&#39;,&#39;w&#39;,&#39;s&#39;),
    HB_TAG(&#39;p&#39;,&#39;s&#39;,&#39;t&#39;,&#39;s&#39;),
<span class="line-modified">!   /* Positioning features, though we don&#39;t care about the types. */</span>
    HB_TAG(&#39;d&#39;,&#39;i&#39;,&#39;s&#39;,&#39;t&#39;),
    /* Pre-release version of Windows 8 Myanmar font had abvm,blwm
     * features.  The released Windows 8 version of the font (as well
     * as the released spec) used &#39;mark&#39; instead.  The Windows 8
     * shaper however didn&#39;t apply &#39;mark&#39; but did apply &#39;mkmk&#39;.
<span class="line-new-header">--- 46,24 ---</span>
  static const hb_tag_t
  other_features[] =
  {
    /*
     * Other features.
<span class="line-modified">!    * These features are applied all at once, after clearing syllables.</span>
     */
    HB_TAG(&#39;p&#39;,&#39;r&#39;,&#39;e&#39;,&#39;s&#39;),
    HB_TAG(&#39;a&#39;,&#39;b&#39;,&#39;v&#39;,&#39;s&#39;),
    HB_TAG(&#39;b&#39;,&#39;l&#39;,&#39;w&#39;,&#39;s&#39;),
    HB_TAG(&#39;p&#39;,&#39;s&#39;,&#39;t&#39;,&#39;s&#39;),
<span class="line-modified">! };</span>
<span class="line-added">+ static const hb_tag_t</span>
<span class="line-added">+ positioning_features[] =</span>
<span class="line-added">+ {</span>
<span class="line-added">+   /*</span>
<span class="line-added">+    * Positioning features.</span>
<span class="line-added">+    * We don&#39;t care about the types.</span>
<span class="line-added">+    */</span>
    HB_TAG(&#39;d&#39;,&#39;i&#39;,&#39;s&#39;,&#39;t&#39;),
    /* Pre-release version of Windows 8 Myanmar font had abvm,blwm
     * features.  The released Windows 8 version of the font (as well
     * as the released spec) used &#39;mark&#39; instead.  The Windows 8
     * shaper however didn&#39;t apply &#39;mark&#39; but did apply &#39;mkmk&#39;.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 71,47 ***</span>
  static void
  setup_syllables (const hb_ot_shape_plan_t *plan,
                   hb_font_t *font,
                   hb_buffer_t *buffer);
  static void
<span class="line-modified">! initial_reordering (const hb_ot_shape_plan_t *plan,</span>
<span class="line-modified">!                     hb_font_t *font,</span>
<span class="line-modified">!                     hb_buffer_t *buffer);</span>
  static void
<span class="line-modified">! final_reordering (const hb_ot_shape_plan_t *plan,</span>
<span class="line-modified">!                   hb_font_t *font,</span>
<span class="line-modified">!                   hb_buffer_t *buffer);</span>
  
  static void
  collect_features_myanmar (hb_ot_shape_planner_t *plan)
  {
    hb_ot_map_builder_t *map = &amp;plan-&gt;map;
  
    /* Do this before any lookups have been applied. */
    map-&gt;add_gsub_pause (setup_syllables);
  
<span class="line-modified">!   map-&gt;add_global_bool_feature (HB_TAG(&#39;l&#39;,&#39;o&#39;,&#39;c&#39;,&#39;l&#39;));</span>
    /* The Indic specs do not require ccmp, but we apply it here since if
     * there is a use of it, it&#39;s typically at the beginning. */
<span class="line-modified">!   map-&gt;add_global_bool_feature (HB_TAG(&#39;c&#39;,&#39;c&#39;,&#39;m&#39;,&#39;p&#39;));</span>
  
  
<span class="line-removed">-   map-&gt;add_gsub_pause (initial_reordering);</span>
    for (unsigned int i = 0; i &lt; ARRAY_LENGTH (basic_features); i++)
    {
<span class="line-modified">!     map-&gt;add_feature (basic_features[i], 1, F_GLOBAL | F_MANUAL_ZWJ);</span>
      map-&gt;add_gsub_pause (nullptr);
    }
<span class="line-modified">!   map-&gt;add_gsub_pause (final_reordering);</span>
    for (unsigned int i = 0; i &lt; ARRAY_LENGTH (other_features); i++)
<span class="line-modified">!     map-&gt;add_feature (other_features[i], 1, F_GLOBAL | F_MANUAL_ZWJ);</span>
  }
  
  static void
  override_features_myanmar (hb_ot_shape_planner_t *plan)
  {
<span class="line-modified">!   plan-&gt;map.add_feature (HB_TAG(&#39;l&#39;,&#39;i&#39;,&#39;g&#39;,&#39;a&#39;), 0, F_GLOBAL);</span>
  }
  
  
  enum syllable_type_t {
    consonant_syllable,
<span class="line-new-header">--- 78,53 ---</span>
  static void
  setup_syllables (const hb_ot_shape_plan_t *plan,
                   hb_font_t *font,
                   hb_buffer_t *buffer);
  static void
<span class="line-modified">! reorder (const hb_ot_shape_plan_t *plan,</span>
<span class="line-modified">!          hb_font_t *font,</span>
<span class="line-modified">!          hb_buffer_t *buffer);</span>
  static void
<span class="line-modified">! clear_syllables (const hb_ot_shape_plan_t *plan,</span>
<span class="line-modified">!                  hb_font_t *font,</span>
<span class="line-modified">!                  hb_buffer_t *buffer);</span>
  
  static void
  collect_features_myanmar (hb_ot_shape_planner_t *plan)
  {
    hb_ot_map_builder_t *map = &amp;plan-&gt;map;
  
    /* Do this before any lookups have been applied. */
    map-&gt;add_gsub_pause (setup_syllables);
  
<span class="line-modified">!   map-&gt;enable_feature (HB_TAG(&#39;l&#39;,&#39;o&#39;,&#39;c&#39;,&#39;l&#39;));</span>
    /* The Indic specs do not require ccmp, but we apply it here since if
     * there is a use of it, it&#39;s typically at the beginning. */
<span class="line-modified">!   map-&gt;enable_feature (HB_TAG(&#39;c&#39;,&#39;c&#39;,&#39;m&#39;,&#39;p&#39;));</span>
<span class="line-added">+ </span>
  
<span class="line-added">+   map-&gt;add_gsub_pause (reorder);</span>
  
    for (unsigned int i = 0; i &lt; ARRAY_LENGTH (basic_features); i++)
    {
<span class="line-modified">!     map-&gt;enable_feature (basic_features[i], F_MANUAL_ZWJ);</span>
      map-&gt;add_gsub_pause (nullptr);
    }
<span class="line-modified">! </span>
<span class="line-added">+   map-&gt;add_gsub_pause (clear_syllables);</span>
<span class="line-added">+ </span>
    for (unsigned int i = 0; i &lt; ARRAY_LENGTH (other_features); i++)
<span class="line-modified">!     map-&gt;enable_feature (other_features[i], F_MANUAL_ZWJ);</span>
<span class="line-added">+ </span>
<span class="line-added">+   for (unsigned int i = 0; i &lt; ARRAY_LENGTH (positioning_features); i++)</span>
<span class="line-added">+     map-&gt;enable_feature (positioning_features[i]);</span>
  }
  
  static void
  override_features_myanmar (hb_ot_shape_planner_t *plan)
  {
<span class="line-modified">!   plan-&gt;map.disable_feature (HB_TAG(&#39;l&#39;,&#39;i&#39;,&#39;g&#39;,&#39;a&#39;));</span>
  }
  
  
  enum syllable_type_t {
    consonant_syllable,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 259,12 ***</span>
    /* Sit tight, rock &#39;n roll! */
    buffer-&gt;sort (start, end, compare_myanmar_order);
  }
  
  static void
<span class="line-modified">! initial_reordering_syllable (const hb_ot_shape_plan_t *plan,</span>
<span class="line-modified">!                              hb_face_t *face,</span>
                               hb_buffer_t *buffer,
                               unsigned int start, unsigned int end)
  {
    syllable_type_t syllable_type = (syllable_type_t) (buffer-&gt;info[start].syllable() &amp; 0x0F);
    switch (syllable_type) {
<span class="line-new-header">--- 272,12 ---</span>
    /* Sit tight, rock &#39;n roll! */
    buffer-&gt;sort (start, end, compare_myanmar_order);
  }
  
  static void
<span class="line-modified">! initial_reordering_syllable (const hb_ot_shape_plan_t *plan HB_UNUSED,</span>
<span class="line-modified">!                              hb_face_t *face HB_UNUSED,</span>
                               hb_buffer_t *buffer,
                               unsigned int start, unsigned int end)
  {
    syllable_type_t syllable_type = (syllable_type_t) (buffer-&gt;info[start].syllable() &amp; 0x0F);
    switch (syllable_type) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 328,74 ***</span>
        buffer-&gt;output_info (ginfo);
      }
      else
        buffer-&gt;next_glyph ();
    }
<span class="line-removed">- </span>
    buffer-&gt;swap_buffers ();
  }
  
  static void
<span class="line-modified">! initial_reordering (const hb_ot_shape_plan_t *plan,</span>
<span class="line-modified">!                     hb_font_t *font,</span>
<span class="line-modified">!                     hb_buffer_t *buffer)</span>
  {
    insert_dotted_circles (plan, font, buffer);
  
    foreach_syllable (buffer, start, end)
      initial_reordering_syllable (plan, font-&gt;face, buffer, start, end);
  }
  
  static void
<span class="line-modified">! final_reordering (const hb_ot_shape_plan_t *plan,</span>
<span class="line-modified">!                   hb_font_t *font HB_UNUSED,</span>
<span class="line-modified">!                   hb_buffer_t *buffer)</span>
  {
    hb_glyph_info_t *info = buffer-&gt;info;
    unsigned int count = buffer-&gt;len;
<span class="line-removed">- </span>
<span class="line-removed">-   /* Zero syllables now... */</span>
    for (unsigned int i = 0; i &lt; count; i++)
      info[i].syllable() = 0;
<span class="line-removed">- </span>
<span class="line-removed">-   HB_BUFFER_DEALLOCATE_VAR (buffer, myanmar_category);</span>
<span class="line-removed">-   HB_BUFFER_DEALLOCATE_VAR (buffer, myanmar_position);</span>
  }
  
  
<span class="line-modified">! /* Uniscribe seems to have a shaper for &#39;mymr&#39; that is like the</span>
<span class="line-removed">-  * generic shaper, except that it zeros mark advances GDEF_LATE. */</span>
<span class="line-removed">- const hb_ot_complex_shaper_t _hb_ot_complex_shaper_myanmar_old =</span>
  {
<span class="line-modified">!   nullptr, /* collect_features */</span>
<span class="line-modified">!   nullptr, /* override_features */</span>
    nullptr, /* data_create */
    nullptr, /* data_destroy */
    nullptr, /* preprocess_text */
    nullptr, /* postprocess_glyphs */
<span class="line-modified">!   HB_OT_SHAPE_NORMALIZATION_MODE_DEFAULT,</span>
    nullptr, /* decompose */
    nullptr, /* compose */
<span class="line-modified">!   nullptr, /* setup_masks */</span>
<span class="line-modified">!   nullptr, /* disable_otl */</span>
    nullptr, /* reorder_marks */
<span class="line-modified">!   HB_OT_SHAPE_ZERO_WIDTH_MARKS_BY_GDEF_LATE,</span>
<span class="line-modified">!   true, /* fallback_position */</span>
  };
  
<span class="line-modified">! const hb_ot_complex_shaper_t _hb_ot_complex_shaper_myanmar =</span>
  {
<span class="line-modified">!   collect_features_myanmar,</span>
<span class="line-modified">!   override_features_myanmar,</span>
    nullptr, /* data_create */
    nullptr, /* data_destroy */
    nullptr, /* preprocess_text */
    nullptr, /* postprocess_glyphs */
<span class="line-modified">!   HB_OT_SHAPE_NORMALIZATION_MODE_COMPOSED_DIACRITICS_NO_SHORT_CIRCUIT,</span>
    nullptr, /* decompose */
    nullptr, /* compose */
<span class="line-modified">!   setup_masks_myanmar,</span>
<span class="line-modified">!   nullptr, /* disable_otl */</span>
    nullptr, /* reorder_marks */
<span class="line-modified">!   HB_OT_SHAPE_ZERO_WIDTH_MARKS_BY_GDEF_EARLY,</span>
    false, /* fallback_position */
  };
<span class="line-new-header">--- 341,73 ---</span>
        buffer-&gt;output_info (ginfo);
      }
      else
        buffer-&gt;next_glyph ();
    }
    buffer-&gt;swap_buffers ();
  }
  
  static void
<span class="line-modified">! reorder (const hb_ot_shape_plan_t *plan,</span>
<span class="line-modified">!          hb_font_t *font,</span>
<span class="line-modified">!          hb_buffer_t *buffer)</span>
  {
    insert_dotted_circles (plan, font, buffer);
  
    foreach_syllable (buffer, start, end)
      initial_reordering_syllable (plan, font-&gt;face, buffer, start, end);
<span class="line-added">+ </span>
<span class="line-added">+   HB_BUFFER_DEALLOCATE_VAR (buffer, myanmar_category);</span>
<span class="line-added">+   HB_BUFFER_DEALLOCATE_VAR (buffer, myanmar_position);</span>
  }
  
  static void
<span class="line-modified">! clear_syllables (const hb_ot_shape_plan_t *plan HB_UNUSED,</span>
<span class="line-modified">!                  hb_font_t *font HB_UNUSED,</span>
<span class="line-modified">!                  hb_buffer_t *buffer)</span>
  {
    hb_glyph_info_t *info = buffer-&gt;info;
    unsigned int count = buffer-&gt;len;
    for (unsigned int i = 0; i &lt; count; i++)
      info[i].syllable() = 0;
  }
  
  
<span class="line-modified">! const hb_ot_complex_shaper_t _hb_ot_complex_shaper_myanmar =</span>
  {
<span class="line-modified">!   collect_features_myanmar,</span>
<span class="line-modified">!   override_features_myanmar,</span>
    nullptr, /* data_create */
    nullptr, /* data_destroy */
    nullptr, /* preprocess_text */
    nullptr, /* postprocess_glyphs */
<span class="line-modified">!   HB_OT_SHAPE_NORMALIZATION_MODE_COMPOSED_DIACRITICS_NO_SHORT_CIRCUIT,</span>
    nullptr, /* decompose */
    nullptr, /* compose */
<span class="line-modified">!   setup_masks_myanmar,</span>
<span class="line-modified">!   HB_TAG_NONE, /* gpos_tag */</span>
    nullptr, /* reorder_marks */
<span class="line-modified">!   HB_OT_SHAPE_ZERO_WIDTH_MARKS_BY_GDEF_EARLY,</span>
<span class="line-modified">!   false, /* fallback_position */</span>
  };
  
<span class="line-modified">! </span>
<span class="line-added">+ /* Ugly Zawgyi encoding.</span>
<span class="line-added">+  * Disable all auto processing.</span>
<span class="line-added">+  * https://github.com/harfbuzz/harfbuzz/issues/1162 */</span>
<span class="line-added">+ const hb_ot_complex_shaper_t _hb_ot_complex_shaper_myanmar_zawgyi =</span>
  {
<span class="line-modified">!   nullptr, /* collect_features */</span>
<span class="line-modified">!   nullptr, /* override_features */</span>
    nullptr, /* data_create */
    nullptr, /* data_destroy */
    nullptr, /* preprocess_text */
    nullptr, /* postprocess_glyphs */
<span class="line-modified">!   HB_OT_SHAPE_NORMALIZATION_MODE_NONE,</span>
    nullptr, /* decompose */
    nullptr, /* compose */
<span class="line-modified">!   nullptr, /* setup_masks */</span>
<span class="line-modified">!   HB_TAG_NONE, /* gpos_tag */</span>
    nullptr, /* reorder_marks */
<span class="line-modified">!   HB_OT_SHAPE_ZERO_WIDTH_MARKS_NONE,</span>
    false, /* fallback_position */
  };
</pre>
<center><a href="hb-ot-shape-complex-myanmar-machine.hh.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-shape-complex-thai.cc.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>