<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-shaper.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-shaper-list.hh.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-static.cc.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-shaper.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod
 25  */
 26 
<span class="line-modified"> 27 #include &quot;hb-private.hh&quot;</span>
<span class="line-modified"> 28 #include &quot;hb-shaper-private.hh&quot;</span>
<span class="line-modified"> 29 #include &quot;hb-atomic-private.hh&quot;</span>
 30 
 31 
<span class="line-modified"> 32 static const hb_shaper_pair_t all_shapers[] = {</span>
 33 #define HB_SHAPER_IMPLEMENT(name) {#name, _hb_##name##_shape},
 34 #include &quot;hb-shaper-list.hh&quot;
 35 #undef HB_SHAPER_IMPLEMENT
 36 };
 37 
<span class="line-modified"> 38 </span>
<span class="line-modified"> 39 /* Thread-safe, lock-free, shapers */</span>
<span class="line-removed"> 40 </span>
<span class="line-removed"> 41 static const hb_shaper_pair_t *static_shapers;</span>
<span class="line-removed"> 42 </span>
<span class="line-removed"> 43 #ifdef HB_USE_ATEXIT</span>
<span class="line-removed"> 44 static</span>
<span class="line-removed"> 45 void free_static_shapers (void)</span>
<span class="line-removed"> 46 {</span>
<span class="line-removed"> 47 retry:</span>
<span class="line-removed"> 48   hb_shaper_pair_t *shapers = (hb_shaper_pair_t *) hb_atomic_ptr_get (&amp;static_shapers);</span>
<span class="line-removed"> 49   if (!hb_atomic_ptr_cmpexch (&amp;static_shapers, shapers, nullptr))</span>
<span class="line-removed"> 50     goto retry;</span>
<span class="line-removed"> 51 </span>
<span class="line-removed"> 52   if (unlikely (shapers != all_shapers))</span>
<span class="line-removed"> 53     free ((void *) shapers);</span>
<span class="line-removed"> 54 }</span>
 55 #endif
 56 
<span class="line-modified"> 57 const hb_shaper_pair_t *</span>
<span class="line-modified"> 58 _hb_shapers_get (void)</span>
 59 {
<span class="line-modified"> 60 retry:</span>
<span class="line-removed"> 61   hb_shaper_pair_t *shapers = (hb_shaper_pair_t *) hb_atomic_ptr_get (&amp;static_shapers);</span>
<span class="line-removed"> 62 </span>
<span class="line-removed"> 63   if (unlikely (!shapers))</span>
 64   {
 65     char *env = getenv (&quot;HB_SHAPER_LIST&quot;);
<span class="line-modified"> 66     if (!env || !*env) {</span>
<span class="line-modified"> 67       (void) hb_atomic_ptr_cmpexch (&amp;static_shapers, nullptr, &amp;all_shapers[0]);</span>
<span class="line-removed"> 68       return (const hb_shaper_pair_t *) all_shapers;</span>
<span class="line-removed"> 69     }</span>
 70 
<span class="line-modified"> 71     /* Not found; allocate one. */</span>
<span class="line-modified"> 72     shapers = (hb_shaper_pair_t *) calloc (1, sizeof (all_shapers));</span>
<span class="line-modified"> 73     if (unlikely (!shapers)) {</span>
<span class="line-removed"> 74       (void) hb_atomic_ptr_cmpexch (&amp;static_shapers, nullptr, &amp;all_shapers[0]);</span>
<span class="line-removed"> 75       return (const hb_shaper_pair_t *) all_shapers;</span>
<span class="line-removed"> 76     }</span>
 77 
 78     memcpy (shapers, all_shapers, sizeof (all_shapers));
 79 
 80      /* Reorder shaper list to prefer requested shapers. */
 81     unsigned int i = 0;
 82     char *end, *p = env;
<span class="line-modified"> 83     for (;;) {</span>

 84       end = strchr (p, &#39;,&#39;);
 85       if (!end)
 86         end = p + strlen (p);
 87 
 88       for (unsigned int j = i; j &lt; ARRAY_LENGTH (all_shapers); j++)
 89         if (end - p == (int) strlen (shapers[j].name) &amp;&amp;
 90             0 == strncmp (shapers[j].name, p, end - p))
 91         {
 92           /* Reorder this shaper to position i */
<span class="line-modified"> 93          struct hb_shaper_pair_t t = shapers[j];</span>
 94          memmove (&amp;shapers[i + 1], &amp;shapers[i], sizeof (shapers[i]) * (j - i));
 95          shapers[i] = t;
 96          i++;
 97         }
 98 
 99       if (!*end)
100         break;
101       else
102         p = end + 1;
103     }
104 
<span class="line-modified">105     if (!hb_atomic_ptr_cmpexch (&amp;static_shapers, nullptr, shapers)) {</span>
<span class="line-modified">106       free (shapers);</span>
<span class="line-removed">107       goto retry;</span>
<span class="line-removed">108     }</span>
<span class="line-removed">109 </span>
<span class="line-removed">110 #ifdef HB_USE_ATEXIT</span>
<span class="line-removed">111     atexit (free_static_shapers); /* First person registers atexit() callback. */</span>
112 #endif


113   }



114 
<span class="line-modified">115   return shapers;</span>











116 }
</pre>
</td>
<td>
<hr />
<pre>
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod
 25  */
 26 
<span class="line-modified"> 27 #include &quot;hb.hh&quot;</span>
<span class="line-modified"> 28 #include &quot;hb-shaper.hh&quot;</span>
<span class="line-modified"> 29 #include &quot;hb-machinery.hh&quot;</span>
 30 
 31 
<span class="line-modified"> 32 static const hb_shaper_entry_t all_shapers[] = {</span>
 33 #define HB_SHAPER_IMPLEMENT(name) {#name, _hb_##name##_shape},
 34 #include &quot;hb-shaper-list.hh&quot;
 35 #undef HB_SHAPER_IMPLEMENT
 36 };
 37 
<span class="line-modified"> 38 #if HB_USE_ATEXIT</span>
<span class="line-modified"> 39 static void free_static_shapers ();</span>















 40 #endif
 41 
<span class="line-modified"> 42 static struct hb_shapers_lazy_loader_t : hb_lazy_loader_t&lt;const hb_shaper_entry_t,</span>
<span class="line-modified"> 43                                                           hb_shapers_lazy_loader_t&gt;</span>
 44 {
<span class="line-modified"> 45   static hb_shaper_entry_t *create ()</span>



 46   {
 47     char *env = getenv (&quot;HB_SHAPER_LIST&quot;);
<span class="line-modified"> 48     if (!env || !*env)</span>
<span class="line-modified"> 49       return nullptr;</span>


 50 
<span class="line-modified"> 51     hb_shaper_entry_t *shapers = (hb_shaper_entry_t *) calloc (1, sizeof (all_shapers));</span>
<span class="line-modified"> 52     if (unlikely (!shapers))</span>
<span class="line-modified"> 53       return nullptr;</span>



 54 
 55     memcpy (shapers, all_shapers, sizeof (all_shapers));
 56 
 57      /* Reorder shaper list to prefer requested shapers. */
 58     unsigned int i = 0;
 59     char *end, *p = env;
<span class="line-modified"> 60     for (;;)</span>
<span class="line-added"> 61     {</span>
 62       end = strchr (p, &#39;,&#39;);
 63       if (!end)
 64         end = p + strlen (p);
 65 
 66       for (unsigned int j = i; j &lt; ARRAY_LENGTH (all_shapers); j++)
 67         if (end - p == (int) strlen (shapers[j].name) &amp;&amp;
 68             0 == strncmp (shapers[j].name, p, end - p))
 69         {
 70           /* Reorder this shaper to position i */
<span class="line-modified"> 71          struct hb_shaper_entry_t t = shapers[j];</span>
 72          memmove (&amp;shapers[i + 1], &amp;shapers[i], sizeof (shapers[i]) * (j - i));
 73          shapers[i] = t;
 74          i++;
 75         }
 76 
 77       if (!*end)
 78         break;
 79       else
 80         p = end + 1;
 81     }
 82 
<span class="line-modified"> 83 #if HB_USE_ATEXIT</span>
<span class="line-modified"> 84     atexit (free_static_shapers);</span>





 85 #endif
<span class="line-added"> 86 </span>
<span class="line-added"> 87     return shapers;</span>
 88   }
<span class="line-added"> 89   static void destroy (const hb_shaper_entry_t *p) { free ((void *) p); }</span>
<span class="line-added"> 90   static const hb_shaper_entry_t *get_null ()      { return all_shapers; }</span>
<span class="line-added"> 91 } static_shapers;</span>
 92 
<span class="line-modified"> 93 #if HB_USE_ATEXIT</span>
<span class="line-added"> 94 static</span>
<span class="line-added"> 95 void free_static_shapers ()</span>
<span class="line-added"> 96 {</span>
<span class="line-added"> 97   static_shapers.free_instance ();</span>
<span class="line-added"> 98 }</span>
<span class="line-added"> 99 #endif</span>
<span class="line-added">100 </span>
<span class="line-added">101 const hb_shaper_entry_t *</span>
<span class="line-added">102 _hb_shapers_get ()</span>
<span class="line-added">103 {</span>
<span class="line-added">104   return static_shapers.get_unconst ();</span>
105 }
</pre>
</td>
</tr>
</table>
<center><a href="hb-shaper-list.hh.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-static.cc.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>