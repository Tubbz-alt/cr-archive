<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ucdn.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-subset.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ucdn/ucdn.h.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ucdn.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -12,13 +12,13 @@</span>
   * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
   * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
   * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
   */
  
<span class="udiff-line-modified-removed">- #include &quot;hb-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb.hh&quot;</span>
  
<span class="udiff-line-modified-removed">- #include &quot;hb-unicode-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-machinery.hh&quot;</span>
  
  #include &quot;ucdn.h&quot;
  
  static const hb_script_t ucdn_script_translate[] =
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -179,19 +179,10 @@</span>
                          void *user_data HB_UNUSED)
  {
      return (hb_unicode_combining_class_t) ucdn_get_combining_class(unicode);
  }
  
<span class="udiff-line-removed">- static unsigned int</span>
<span class="udiff-line-removed">- hb_ucdn_eastasian_width(hb_unicode_funcs_t *ufuncs HB_UNUSED,</span>
<span class="udiff-line-removed">-                         hb_codepoint_t unicode,</span>
<span class="udiff-line-removed">-                         void *user_data HB_UNUSED)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     int w = ucdn_get_east_asian_width(unicode);</span>
<span class="udiff-line-removed">-     return (w == UCDN_EAST_ASIAN_F || w == UCDN_EAST_ASIAN_W) ? 2 : 1;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  static hb_unicode_general_category_t
  hb_ucdn_general_category(hb_unicode_funcs_t *ufuncs HB_UNUSED,
                           hb_codepoint_t unicode,
                           void *user_data HB_UNUSED)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -228,58 +219,50 @@</span>
                    void *user_data HB_UNUSED)
  {
      return ucdn_decompose(ab, a, b);
  }
  
<span class="udiff-line-removed">- static unsigned int</span>
<span class="udiff-line-removed">- hb_ucdn_decompose_compatibility(hb_unicode_funcs_t *ufuncs HB_UNUSED,</span>
<span class="udiff-line-removed">-                                 hb_codepoint_t u, hb_codepoint_t *decomposed,</span>
<span class="udiff-line-removed">-                                 void *user_data HB_UNUSED)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     return ucdn_compat_decompose(u, decomposed);</span>
<span class="udiff-line-removed">- }</span>
  
<span class="udiff-line-modified-removed">- static hb_unicode_funcs_t *static_ucdn_funcs = nullptr;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="udiff-line-removed">- static</span>
<span class="udiff-line-removed">- void free_static_ucdn_funcs (void)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- retry:</span>
<span class="udiff-line-removed">-   hb_unicode_funcs_t *ucdn_funcs = (hb_unicode_funcs_t *) hb_atomic_ptr_get (&amp;static_ucdn_funcs);</span>
<span class="udiff-line-removed">-   if (!hb_atomic_ptr_cmpexch (&amp;static_ucdn_funcs, ucdn_funcs, nullptr))</span>
<span class="udiff-line-removed">-     goto retry;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   hb_unicode_funcs_destroy (ucdn_funcs);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-modified-added">+ static void free_static_ucdn_funcs ();</span>
  #endif
  
<span class="udiff-line-modified-removed">- extern &quot;C&quot; HB_INTERNAL</span>
<span class="udiff-line-removed">- hb_unicode_funcs_t *</span>
<span class="udiff-line-removed">- hb_ucdn_get_unicode_funcs (void)</span>
<span class="udiff-line-modified-added">+ static struct hb_ucdn_unicode_funcs_lazy_loader_t : hb_unicode_funcs_lazy_loader_t&lt;hb_ucdn_unicode_funcs_lazy_loader_t&gt;</span>
  {
<span class="udiff-line-modified-removed">- retry:</span>
<span class="udiff-line-removed">-   hb_unicode_funcs_t *funcs = (hb_unicode_funcs_t *) hb_atomic_ptr_get (&amp;static_ucdn_funcs);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (unlikely (!funcs))</span>
<span class="udiff-line-modified-added">+   static hb_unicode_funcs_t *create ()</span>
    {
<span class="udiff-line-modified-removed">-     funcs = hb_unicode_funcs_create (nullptr);</span>
<span class="udiff-line-modified-added">+     hb_unicode_funcs_t *funcs = hb_unicode_funcs_create (nullptr);</span>
  
<span class="udiff-line-modified-removed">- #define HB_UNICODE_FUNC_IMPLEMENT(name) \</span>
<span class="udiff-line-modified-removed">-     hb_unicode_funcs_set_##name##_func (funcs, hb_ucdn_##name, nullptr, nullptr);</span>
<span class="udiff-line-modified-removed">-       HB_UNICODE_FUNCS_IMPLEMENT_CALLBACKS</span>
<span class="udiff-line-modified-removed">- #undef HB_UNICODE_FUNC_IMPLEMENT</span>
<span class="udiff-line-modified-added">+     hb_unicode_funcs_set_combining_class_func (funcs, hb_ucdn_combining_class, nullptr, nullptr);</span>
<span class="udiff-line-modified-added">+     hb_unicode_funcs_set_general_category_func (funcs, hb_ucdn_general_category, nullptr, nullptr);</span>
<span class="udiff-line-modified-added">+     hb_unicode_funcs_set_mirroring_func (funcs, hb_ucdn_mirroring, nullptr, nullptr);</span>
<span class="udiff-line-modified-added">+     hb_unicode_funcs_set_script_func (funcs, hb_ucdn_script, nullptr, nullptr);</span>
<span class="udiff-line-added">+     hb_unicode_funcs_set_compose_func (funcs, hb_ucdn_compose, nullptr, nullptr);</span>
<span class="udiff-line-added">+     hb_unicode_funcs_set_decompose_func (funcs, hb_ucdn_decompose, nullptr, nullptr);</span>
  
      hb_unicode_funcs_make_immutable (funcs);
  
<span class="udiff-line-modified-removed">-     if (!hb_atomic_ptr_cmpexch (&amp;static_ucdn_funcs, nullptr, funcs)) {</span>
<span class="udiff-line-modified-removed">-       hb_unicode_funcs_destroy (funcs);</span>
<span class="udiff-line-modified-removed">-       goto retry;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-modified-added">+     atexit (free_static_ucdn_funcs);</span>
<span class="udiff-line-modified-added">+ #endif</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     return funcs;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ } static_ucdn_funcs;</span>
  
<span class="udiff-line-modified-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="udiff-line-modified-removed">-     atexit (free_static_ucdn_funcs); /* First person registers atexit() callback. */</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-modified-added">+ static</span>
<span class="udiff-line-added">+ void free_static_ucdn_funcs ()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   static_ucdn_funcs.free_instance ();</span>
<span class="udiff-line-added">+ }</span>
  #endif
<span class="udiff-line-removed">-   };</span>
  
<span class="udiff-line-modified-removed">-   return hb_unicode_funcs_reference (funcs);</span>
<span class="udiff-line-modified-added">+ extern &quot;C&quot; HB_INTERNAL</span>
<span class="udiff-line-added">+ hb_unicode_funcs_t *</span>
<span class="udiff-line-added">+ hb_ucdn_get_unicode_funcs ();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ hb_unicode_funcs_t *</span>
<span class="udiff-line-added">+ hb_ucdn_get_unicode_funcs ()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   return static_ucdn_funcs.get_unconst ();</span>
  }
</pre>
<center><a href="hb-subset.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ucdn/ucdn.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>