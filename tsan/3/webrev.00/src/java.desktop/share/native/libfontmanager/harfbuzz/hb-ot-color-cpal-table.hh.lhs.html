<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-color-cpal-table.hh</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright © 2016  Google, Inc.
  3  * Copyright © 2018  Ebrahim Byagowi
  4  *
  5  *  This is part of HarfBuzz, a text shaping library.
  6  *
  7  * Permission is hereby granted, without written agreement and without
  8  * license or royalty fees, to use, copy, modify, and distribute this
  9  * software and its documentation for any purpose, provided that the
 10  * above copyright notice and the following two paragraphs appear in
 11  * all copies of this software.
 12  *
 13  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 14  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 15  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 16  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 17  * DAMAGE.
 18  *
 19  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 20  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 21  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 22  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 23  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 24  *
 25  * Google Author(s): Sascha Brawer
 26  */
 27 
 28 #ifndef HB_OT_COLOR_CPAL_TABLE_HH
 29 #define HB_OT_COLOR_CPAL_TABLE_HH
 30 
<a name="1" id="anc1"></a><span class="line-modified"> 31 #include &quot;hb-open-type-private.hh&quot;</span>
<span class="line-modified"> 32 </span>
<span class="line-modified"> 33 </span>
<span class="line-removed"> 34 /*</span>
<span class="line-removed"> 35  * Following parts to be moved to a public header.</span>
<span class="line-removed"> 36  */</span>
<span class="line-removed"> 37 </span>
<span class="line-removed"> 38 /**</span>
<span class="line-removed"> 39  * hb_ot_color_t:</span>
<span class="line-removed"> 40  * ARGB data type for holding color values.</span>
<span class="line-removed"> 41  *</span>
<span class="line-removed"> 42  * Since: REPLACEME</span>
<span class="line-removed"> 43  */</span>
<span class="line-removed"> 44 typedef uint32_t hb_ot_color_t;</span>
<span class="line-removed"> 45 </span>
<span class="line-removed"> 46 </span>
<span class="line-removed"> 47 /**</span>
<span class="line-removed"> 48  * hb_ot_color_palette_flags_t:</span>
<span class="line-removed"> 49  * @HB_OT_COLOR_PALETTE_FLAG_DEFAULT: default indicating that there is nothing special to note about a color palette.</span>
<span class="line-removed"> 50  * @HB_OT_COLOR_PALETTE_FLAG_FOR_LIGHT_BACKGROUND: flag indicating that the color palette is suitable for rendering text on light background.</span>
<span class="line-removed"> 51  * @HB_OT_COLOR_PALETTE_FLAG_FOR_DARK_BACKGROUND: flag indicating that the color palette is suitable for rendering text on dark background.</span>
<span class="line-removed"> 52  *</span>
<span class="line-removed"> 53  * Since: REPLACEME</span>
<span class="line-removed"> 54  */</span>
<span class="line-removed"> 55 typedef enum { /*&lt; flags &gt;*/</span>
<span class="line-removed"> 56   HB_OT_COLOR_PALETTE_FLAG_DEFAULT = 0x00000000u,</span>
<span class="line-removed"> 57   HB_OT_COLOR_PALETTE_FLAG_FOR_LIGHT_BACKGROUND = 0x00000001u,</span>
<span class="line-removed"> 58   HB_OT_COLOR_PALETTE_FLAG_FOR_DARK_BACKGROUND = 0x00000002u,</span>
<span class="line-removed"> 59 } hb_ot_color_palette_flags_t;</span>
<span class="line-removed"> 60 </span>
<span class="line-removed"> 61 // HB_EXTERN unsigned int</span>
<span class="line-removed"> 62 // hb_ot_color_get_palette_count (hb_face_t *face);</span>
<span class="line-removed"> 63 </span>
<span class="line-removed"> 64 // HB_EXTERN unsigned int</span>
<span class="line-removed"> 65 // hb_ot_color_get_palette_name_id (hb_face_t *face, unsigned int palette);</span>
<span class="line-removed"> 66 </span>
<span class="line-removed"> 67 // HB_EXTERN hb_ot_color_palette_flags_t</span>
<span class="line-removed"> 68 // hb_ot_color_get_palette_flags (hb_face_t *face, unsigned int palette);</span>
<span class="line-removed"> 69 </span>
<span class="line-removed"> 70 // HB_EXTERN unsigned int</span>
<span class="line-removed"> 71 // hb_ot_color_get_palette_colors (hb_face_t       *face,</span>
<span class="line-removed"> 72 //                              unsigned int     palette, /* default=0 */</span>
<span class="line-removed"> 73 //                              unsigned int     start_offset,</span>
<span class="line-removed"> 74 //                              unsigned int    *color_count /* IN/OUT */,</span>
<span class="line-removed"> 75 //                              hb_ot_color_t   *colors /* OUT */);</span>
<span class="line-removed"> 76 </span>
<span class="line-removed"> 77 </span>
<span class="line-removed"> 78 </span>
 79 
 80 
 81 /*
 82  * CPAL -- Color Palette
 83  * https://docs.microsoft.com/en-us/typography/opentype/spec/cpal
 84  */
 85 #define HB_OT_TAG_CPAL HB_TAG(&#39;C&#39;,&#39;P&#39;,&#39;A&#39;,&#39;L&#39;)
 86 
 87 
 88 namespace OT {
 89 
 90 
 91 struct CPALV1Tail
 92 {
 93   friend struct CPAL;
 94 
<a name="2" id="anc2"></a><span class="line-modified"> 95   inline bool</span>
<span class="line-modified"> 96   sanitize (hb_sanitize_context_t *c, const void *base, unsigned int palettes) const</span>


 97   {
<a name="3" id="anc3"></a><span class="line-modified"> 98     TRACE_SANITIZE (this);</span>
<span class="line-modified"> 99     return_trace (c-&gt;check_struct (this) &amp;&amp;</span>
<span class="line-modified">100                   (base+paletteFlagsZ).sanitize (c, palettes) &amp;&amp;</span>
<span class="line-removed">101                   (base+paletteLabelZ).sanitize (c, palettes) &amp;&amp;</span>
<span class="line-removed">102                   (base+paletteEntryLabelZ).sanitize (c, palettes));</span>
103   }
104 
<a name="4" id="anc4"></a><span class="line-modified">105   private:</span>
<span class="line-modified">106   inline hb_ot_color_palette_flags_t</span>
<span class="line-modified">107   get_palette_flags (const void *base, unsigned int palette) const</span>
108   {
<a name="5" id="anc5"></a><span class="line-modified">109     // range checked at the CPAL caller</span>
<span class="line-modified">110     return (hb_ot_color_palette_flags_t) (uint32_t) (base+paletteFlagsZ)[palette];</span>
111   }
112 
<a name="6" id="anc6"></a><span class="line-modified">113   inline unsigned int</span>
<span class="line-modified">114   get_palette_name_id (const void *base, unsigned int palette) const</span>

115   {
<a name="7" id="anc7"></a><span class="line-modified">116     // range checked at the CPAL caller</span>
<span class="line-modified">117     return (base+paletteLabelZ)[palette];</span>













118   }
119 
120   protected:
<a name="8" id="anc8"></a><span class="line-modified">121   LOffsetTo&lt;UnsizedArrayOf&lt;HBUINT32&gt; &gt;</span>
122                 paletteFlagsZ;          /* Offset from the beginning of CPAL table to
123                                          * the Palette Type Array. Set to 0 if no array
124                                          * is provided. */
<a name="9" id="anc9"></a><span class="line-modified">125   LOffsetTo&lt;UnsizedArrayOf&lt;HBUINT16&gt; &gt;</span>
<span class="line-modified">126                 paletteLabelZ;          /* Offset from the beginning of CPAL table to</span>
<span class="line-modified">127                                          * the Palette Labels Array. Set to 0 if no</span>
128                                          * array is provided. */
<a name="10" id="anc10"></a><span class="line-modified">129   LOffsetTo&lt;UnsizedArrayOf&lt;HBUINT16&gt; &gt;</span>
<span class="line-modified">130                 paletteEntryLabelZ;     /* Offset from the beginning of CPAL table to</span>
<span class="line-modified">131                                          * the Palette Entry Label Array. Set to 0</span>
132                                          * if no array is provided. */
133   public:
134   DEFINE_SIZE_STATIC (12);
135 };
136 
137 typedef HBUINT32 BGRAColor;
138 
139 struct CPAL
140 {
<a name="11" id="anc11"></a><span class="line-modified">141   static const hb_tag_t tableTag = HB_OT_TAG_CPAL;</span>
142 
<a name="12" id="anc12"></a><span class="line-modified">143   inline bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="line-removed">144   {</span>
<span class="line-removed">145     TRACE_SANITIZE (this);</span>
<span class="line-removed">146     if (unlikely (!(c-&gt;check_struct (this) &amp;&amp;   // it checks colorRecordIndices also</span>
<span class="line-removed">147                                                 // see #get_size</span>
<span class="line-removed">148                     (this+colorRecordsZ).sanitize (c, numColorRecords))))</span>
<span class="line-removed">149       return_trace (false);</span>
<span class="line-removed">150 </span>
<span class="line-removed">151     // Check for indices sanity so no need for doing it runtime</span>
<span class="line-removed">152     for (unsigned int i = 0; i &lt; numPalettes; ++i)</span>
<span class="line-removed">153       if (unlikely (colorRecordIndicesZ[i] + numPaletteEntries &gt; numColorRecords))</span>
<span class="line-removed">154         return_trace (false);</span>
<span class="line-removed">155 </span>
<span class="line-removed">156     // If version is zero, we are done here; otherwise we need to check tail also</span>
<span class="line-removed">157     if (version == 0)</span>
<span class="line-removed">158       return_trace (true);</span>
<span class="line-removed">159 </span>
<span class="line-removed">160     const CPALV1Tail &amp;v1 = StructAfter&lt;CPALV1Tail&gt; (*this);</span>
<span class="line-removed">161     return_trace (likely (v1.sanitize (c, this, numPalettes)));</span>
<span class="line-removed">162   }</span>
163 
<a name="13" id="anc13"></a><span class="line-modified">164   inline unsigned int get_size (void) const</span>
<span class="line-modified">165   {</span>
<span class="line-removed">166     return min_size + numPalettes * sizeof (HBUINT16);</span>
<span class="line-removed">167   }</span>
168 
<a name="14" id="anc14"></a><span class="line-modified">169   inline hb_ot_color_palette_flags_t get_palette_flags (unsigned int palette) const</span>
<span class="line-modified">170   {</span>
<span class="line-removed">171     if (unlikely (version == 0 || palette &gt;= numPalettes))</span>
<span class="line-removed">172       return HB_OT_COLOR_PALETTE_FLAG_DEFAULT;</span>
173 
<a name="15" id="anc15"></a><span class="line-modified">174     const CPALV1Tail&amp; cpal1 = StructAfter&lt;CPALV1Tail&gt; (*this);</span>
<span class="line-modified">175     return cpal1.get_palette_flags (this, palette);</span>
<span class="line-removed">176   }</span>
177 
<a name="16" id="anc16"></a><span class="line-modified">178   inline unsigned int get_palette_name_id (unsigned int palette) const</span>
<span class="line-modified">179   {</span>
<span class="line-removed">180     if (unlikely (version == 0 || palette &gt;= numPalettes))</span>
<span class="line-removed">181       return 0xFFFF;</span>
182 
<a name="17" id="anc17"></a><span class="line-modified">183     const CPALV1Tail&amp; cpal1 = StructAfter&lt;CPALV1Tail&gt; (*this);</span>
<span class="line-modified">184     return cpal1.get_palette_name_id (this, palette);</span>
<span class="line-removed">185   }</span>
186 
<a name="18" id="anc18"></a><span class="line-modified">187   inline unsigned int get_palette_count () const</span>



188   {
<a name="19" id="anc19"></a><span class="line-modified">189     return numPalettes;</span>


















190   }
191 
<a name="20" id="anc20"></a><span class="line-modified">192   inline hb_ot_color_t</span>
<span class="line-modified">193   get_color_record_argb (unsigned int color_index, unsigned int palette) const</span>
194   {
<a name="21" id="anc21"></a><span class="line-modified">195     if (unlikely (color_index &gt;= numPaletteEntries || palette &gt;= numPalettes))</span>
<span class="line-modified">196       return 0;</span>

197 
<a name="22" id="anc22"></a><span class="line-modified">198     // No need for more range check as it is already done on #sanitize</span>
<span class="line-modified">199     const UnsizedArrayOf&lt;BGRAColor&gt;&amp; color_records = this+colorRecordsZ;</span>
<span class="line-modified">200     return color_records[colorRecordIndicesZ[palette] + color_index];</span>





201   }
202 
203   protected:
204   HBUINT16      version;                /* Table version number */
205   /* Version 0 */
<a name="23" id="anc23"></a><span class="line-modified">206   HBUINT16      numPaletteEntries;      /* Number of palette entries in each palette. */</span>
207   HBUINT16      numPalettes;            /* Number of palettes in the table. */
208   HBUINT16      numColorRecords;        /* Total number of color records, combined for
209                                          * all palettes. */
<a name="24" id="anc24"></a><span class="line-modified">210   LOffsetTo&lt;UnsizedArrayOf&lt;BGRAColor&gt; &gt;</span>
211                 colorRecordsZ;          /* Offset from the beginning of CPAL table to
212                                          * the first ColorRecord. */
213   UnsizedArrayOf&lt;HBUINT16&gt;
214                 colorRecordIndicesZ;    /* Index of each palette’s first color record in
215                                          * the combined color record array. */
216 /*CPALV1Tail    v1;*/
217   public:
218   DEFINE_SIZE_ARRAY (12, colorRecordIndicesZ);
219 };
220 
221 } /* namespace OT */
222 
223 
224 #endif /* HB_OT_COLOR_CPAL_TABLE_HH */
<a name="25" id="anc25"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="25" type="hidden" />
</body>
</html>