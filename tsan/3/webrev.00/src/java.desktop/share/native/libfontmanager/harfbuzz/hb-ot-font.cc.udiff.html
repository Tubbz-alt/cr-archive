<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-font.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-color-svg-table.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-glyf-table.hh.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-font.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,139 +22,175 @@</span>
   * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
   *
   * Google Author(s): Behdad Esfahbod, Roozbeh Pournader
   */
  
<span class="udiff-line-modified-removed">- #include &quot;hb-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb.hh&quot;</span>
  
  #include &quot;hb-ot.h&quot;
  
<span class="udiff-line-modified-removed">- #include &quot;hb-font-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-font.hh&quot;</span>
<span class="udiff-line-added">+ #include &quot;hb-machinery.hh&quot;</span>
<span class="udiff-line-added">+ #include &quot;hb-ot-face.hh&quot;</span>
  
  #include &quot;hb-ot-cmap-table.hh&quot;
  #include &quot;hb-ot-glyf-table.hh&quot;
<span class="udiff-line-added">+ #include &quot;hb-ot-cff1-table.hh&quot;</span>
<span class="udiff-line-added">+ #include &quot;hb-ot-cff2-table.hh&quot;</span>
  #include &quot;hb-ot-hmtx-table.hh&quot;
  #include &quot;hb-ot-kern-table.hh&quot;
<span class="udiff-line-added">+ #include &quot;hb-ot-os2-table.hh&quot;</span>
  #include &quot;hb-ot-post-table.hh&quot;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+ #include &quot;hb-ot-stat-table.hh&quot; // Just so we compile it; unused otherwise.</span>
<span class="udiff-line-added">+ #include &quot;hb-ot-vorg-table.hh&quot;</span>
  #include &quot;hb-ot-color-cbdt-table.hh&quot;
<span class="udiff-line-added">+ #include &quot;hb-ot-color-sbix-table.hh&quot;</span>
  
  
<span class="udiff-line-modified-removed">- struct hb_ot_font_t</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-modified-removed">-   OT::cmap::accelerator_t cmap;</span>
<span class="udiff-line-modified-removed">-   OT::hmtx::accelerator_t h_metrics;</span>
<span class="udiff-line-modified-removed">-   OT::vmtx::accelerator_t v_metrics;</span>
<span class="udiff-line-modified-removed">-   OT::hb_lazy_loader_t&lt;OT::glyf::accelerator_t&gt; glyf;</span>
<span class="udiff-line-modified-removed">-   OT::hb_lazy_loader_t&lt;OT::CBDT::accelerator_t&gt; cbdt;</span>
<span class="udiff-line-modified-removed">-   OT::hb_lazy_loader_t&lt;OT::post::accelerator_t&gt; post;</span>
<span class="udiff-line-modified-removed">-   OT::hb_lazy_loader_t&lt;OT::kern::accelerator_t&gt; kern;</span>
<span class="udiff-line-modified-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static hb_ot_font_t *</span>
<span class="udiff-line-removed">- _hb_ot_font_create (hb_face_t *face)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-   hb_ot_font_t *ot_font = (hb_ot_font_t *) calloc (1, sizeof (hb_ot_font_t));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (unlikely (!ot_font))</span>
<span class="udiff-line-removed">-     return nullptr;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   ot_font-&gt;cmap.init (face);</span>
<span class="udiff-line-removed">-   ot_font-&gt;h_metrics.init (face);</span>
<span class="udiff-line-removed">-   ot_font-&gt;v_metrics.init (face, ot_font-&gt;h_metrics.ascender - ot_font-&gt;h_metrics.descender); /* TODO Can we do this lazily? */</span>
<span class="udiff-line-removed">-   ot_font-&gt;glyf.init (face);</span>
<span class="udiff-line-removed">-   ot_font-&gt;cbdt.init (face);</span>
<span class="udiff-line-removed">-   ot_font-&gt;post.init (face);</span>
<span class="udiff-line-removed">-   ot_font-&gt;kern.init (face);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   return ot_font;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static void</span>
<span class="udiff-line-removed">- _hb_ot_font_destroy (void *data)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-   hb_ot_font_t *ot_font = (hb_ot_font_t *) data;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   ot_font-&gt;cmap.fini ();</span>
<span class="udiff-line-removed">-   ot_font-&gt;h_metrics.fini ();</span>
<span class="udiff-line-removed">-   ot_font-&gt;v_metrics.fini ();</span>
<span class="udiff-line-removed">-   ot_font-&gt;glyf.fini ();</span>
<span class="udiff-line-removed">-   ot_font-&gt;cbdt.fini ();</span>
<span class="udiff-line-removed">-   ot_font-&gt;post.fini ();</span>
<span class="udiff-line-removed">-   ot_font-&gt;kern.fini ();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   free (ot_font);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+ /**</span>
<span class="udiff-line-modified-added">+  * SECTION:hb-ot-font</span>
<span class="udiff-line-modified-added">+  * @title: hb-ot-font</span>
<span class="udiff-line-modified-added">+  * @short_description: OpenType font implementation</span>
<span class="udiff-line-modified-added">+  * @include: hb-ot.h</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-modified-added">+  * Functions for using OpenType fonts with hb_shape().  Not that fonts returned</span>
<span class="udiff-line-modified-added">+  * by hb_font_create() default to using these functions, so most clients would</span>
<span class="udiff-line-modified-added">+  * never need to call these functions directly.</span>
<span class="udiff-line-modified-added">+  **/</span>
  
  
  static hb_bool_t
  hb_ot_get_nominal_glyph (hb_font_t *font HB_UNUSED,
                           void *font_data,
                           hb_codepoint_t unicode,
                           hb_codepoint_t *glyph,
                           void *user_data HB_UNUSED)
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-added">+   return ot_face-&gt;cmap-&gt;get_nominal_glyph (unicode, glyph);</span>
<span class="udiff-line-added">+ }</span>
  
<span class="udiff-line-added">+ static unsigned int</span>
<span class="udiff-line-added">+ hb_ot_get_nominal_glyphs (hb_font_t *font HB_UNUSED,</span>
<span class="udiff-line-added">+                           void *font_data,</span>
<span class="udiff-line-added">+                           unsigned int count,</span>
<span class="udiff-line-added">+                           const hb_codepoint_t *first_unicode,</span>
<span class="udiff-line-added">+                           unsigned int unicode_stride,</span>
<span class="udiff-line-added">+                           hb_codepoint_t *first_glyph,</span>
<span class="udiff-line-added">+                           unsigned int glyph_stride,</span>
<span class="udiff-line-added">+                           void *user_data HB_UNUSED)</span>
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   return ot_font-&gt;cmap.get_nominal_glyph (unicode, glyph);</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+   return ot_face-&gt;cmap-&gt;get_nominal_glyphs (count,</span>
<span class="udiff-line-added">+                                             first_unicode, unicode_stride,</span>
<span class="udiff-line-added">+                                             first_glyph, glyph_stride);</span>
  }
  
  static hb_bool_t
  hb_ot_get_variation_glyph (hb_font_t *font HB_UNUSED,
                             void *font_data,
                             hb_codepoint_t unicode,
                             hb_codepoint_t variation_selector,
                             hb_codepoint_t *glyph,
                             void *user_data HB_UNUSED)
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   return ot_font-&gt;cmap.get_variation_glyph (unicode, variation_selector, glyph);</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+   return ot_face-&gt;cmap-&gt;get_variation_glyph (unicode, variation_selector, glyph);</span>
  }
  
<span class="udiff-line-modified-removed">- static hb_position_t</span>
<span class="udiff-line-modified-removed">- hb_ot_get_glyph_h_advance (hb_font_t *font,</span>
<span class="udiff-line-modified-removed">-                            void *font_data,</span>
<span class="udiff-line-modified-removed">-                            hb_codepoint_t glyph,</span>
<span class="udiff-line-modified-removed">-                            void *user_data HB_UNUSED)</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ hb_ot_get_glyph_h_advances (hb_font_t* font, void* font_data,</span>
<span class="udiff-line-modified-added">+                             unsigned count,</span>
<span class="udiff-line-modified-added">+                             const hb_codepoint_t *first_glyph,</span>
<span class="udiff-line-modified-added">+                             unsigned glyph_stride,</span>
<span class="udiff-line-added">+                             hb_position_t *first_advance,</span>
<span class="udiff-line-added">+                             unsigned advance_stride,</span>
<span class="udiff-line-added">+                             void *user_data HB_UNUSED)</span>
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   return font-&gt;em_scale_x (ot_font-&gt;h_metrics.get_advance (glyph, font));</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+   const OT::hmtx_accelerator_t &amp;hmtx = *ot_face-&gt;hmtx;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   for (unsigned int i = 0; i &lt; count; i++)</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     *first_advance = font-&gt;em_scale_x (hmtx.get_advance (*first_glyph, font));</span>
<span class="udiff-line-added">+     first_glyph = &amp;StructAtOffsetUnaligned&lt;hb_codepoint_t&gt; (first_glyph, glyph_stride);</span>
<span class="udiff-line-added">+     first_advance = &amp;StructAtOffsetUnaligned&lt;hb_position_t&gt; (first_advance, advance_stride);</span>
<span class="udiff-line-added">+   }</span>
  }
  
<span class="udiff-line-modified-removed">- static hb_position_t</span>
<span class="udiff-line-modified-removed">- hb_ot_get_glyph_v_advance (hb_font_t *font,</span>
<span class="udiff-line-modified-removed">-                            void *font_data,</span>
<span class="udiff-line-modified-removed">-                            hb_codepoint_t glyph,</span>
<span class="udiff-line-modified-removed">-                            void *user_data HB_UNUSED)</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ hb_ot_get_glyph_v_advances (hb_font_t* font, void* font_data,</span>
<span class="udiff-line-modified-added">+                             unsigned count,</span>
<span class="udiff-line-modified-added">+                             const hb_codepoint_t *first_glyph,</span>
<span class="udiff-line-modified-added">+                             unsigned glyph_stride,</span>
<span class="udiff-line-added">+                             hb_position_t *first_advance,</span>
<span class="udiff-line-added">+                             unsigned advance_stride,</span>
<span class="udiff-line-added">+                             void *user_data HB_UNUSED)</span>
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   return font-&gt;em_scale_y (-(int) ot_font-&gt;v_metrics.get_advance (glyph, font));</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+   const OT::vmtx_accelerator_t &amp;vmtx = *ot_face-&gt;vmtx;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   for (unsigned int i = 0; i &lt; count; i++)</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     *first_advance = font-&gt;em_scale_y (-(int) vmtx.get_advance (*first_glyph, font));</span>
<span class="udiff-line-added">+     first_glyph = &amp;StructAtOffsetUnaligned&lt;hb_codepoint_t&gt; (first_glyph, glyph_stride);</span>
<span class="udiff-line-added">+     first_advance = &amp;StructAtOffsetUnaligned&lt;hb_position_t&gt; (first_advance, advance_stride);</span>
<span class="udiff-line-added">+   }</span>
  }
  
<span class="udiff-line-modified-removed">- static hb_position_t</span>
<span class="udiff-line-modified-removed">- hb_ot_get_glyph_h_kerning (hb_font_t *font,</span>
<span class="udiff-line-modified-removed">-                            void *font_data,</span>
<span class="udiff-line-modified-removed">-                            hb_codepoint_t left_glyph,</span>
<span class="udiff-line-modified-removed">-                            hb_codepoint_t right_glyph,</span>
<span class="udiff-line-modified-removed">-                            void *user_data HB_UNUSED)</span>
<span class="udiff-line-modified-added">+ static hb_bool_t</span>
<span class="udiff-line-modified-added">+ hb_ot_get_glyph_v_origin (hb_font_t *font,</span>
<span class="udiff-line-modified-added">+                           void *font_data,</span>
<span class="udiff-line-modified-added">+                           hb_codepoint_t glyph,</span>
<span class="udiff-line-modified-added">+                           hb_position_t *x,</span>
<span class="udiff-line-modified-added">+                           hb_position_t *y,</span>
<span class="udiff-line-added">+                           void *user_data HB_UNUSED)</span>
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   return font-&gt;em_scale_x (ot_font-&gt;kern-&gt;get_h_kerning (left_glyph, right_glyph));</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+   *x = font-&gt;get_glyph_h_advance (glyph) / 2;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   const OT::VORG &amp;VORG = *ot_face-&gt;VORG;</span>
<span class="udiff-line-added">+   if (VORG.has_data ())</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     *y = font-&gt;em_scale_y (VORG.get_y_origin (glyph));</span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   hb_glyph_extents_t extents = {0};</span>
<span class="udiff-line-added">+   if (ot_face-&gt;glyf-&gt;get_extents (glyph, &amp;extents))</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     const OT::vmtx_accelerator_t &amp;vmtx = *ot_face-&gt;vmtx;</span>
<span class="udiff-line-added">+     hb_position_t tsb = vmtx.get_side_bearing (glyph);</span>
<span class="udiff-line-added">+     *y = font-&gt;em_scale_y (extents.y_bearing + tsb);</span>
<span class="udiff-line-added">+     return true;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   hb_font_extents_t font_extents;</span>
<span class="udiff-line-added">+   font-&gt;get_h_extents_with_fallback (&amp;font_extents);</span>
<span class="udiff-line-added">+   *y = font_extents.ascender;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return true;</span>
  }
  
  static hb_bool_t
  hb_ot_get_glyph_extents (hb_font_t *font,
                           void *font_data,
                           hb_codepoint_t glyph,
                           hb_glyph_extents_t *extents,
                           void *user_data HB_UNUSED)
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   bool ret = ot_font-&gt;glyf-&gt;get_extents (glyph, extents);</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+   bool ret = ot_face-&gt;sbix-&gt;get_extents (font, glyph, extents);</span>
<span class="udiff-line-added">+   if (!ret)</span>
<span class="udiff-line-added">+     ret = ot_face-&gt;glyf-&gt;get_extents (glyph, extents);</span>
<span class="udiff-line-added">+   if (!ret)</span>
<span class="udiff-line-added">+     ret = ot_face-&gt;cff1-&gt;get_extents (glyph, extents);</span>
<span class="udiff-line-added">+   if (!ret)</span>
<span class="udiff-line-added">+     ret = ot_face-&gt;cff2-&gt;get_extents (font, glyph, extents);</span>
    if (!ret)
<span class="udiff-line-modified-removed">-     ret = ot_font-&gt;cbdt-&gt;get_extents (glyph, extents);</span>
<span class="udiff-line-modified-added">+     ret = ot_face-&gt;CBDT-&gt;get_extents (font, glyph, extents);</span>
    // TODO Hook up side-bearings variations.
    extents-&gt;x_bearing = font-&gt;em_scale_x (extents-&gt;x_bearing);
    extents-&gt;y_bearing = font-&gt;em_scale_y (extents-&gt;y_bearing);
    extents-&gt;width     = font-&gt;em_scale_x (extents-&gt;width);
    extents-&gt;height    = font-&gt;em_scale_y (extents-&gt;height);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,106 +202,101 @@</span>
                        void *font_data,
                        hb_codepoint_t glyph,
                        char *name, unsigned int size,
                        void *user_data HB_UNUSED)
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   return ot_font-&gt;post-&gt;get_glyph_name (glyph, name, size);</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+   return ot_face-&gt;post-&gt;get_glyph_name (glyph, name, size);</span>
  }
  
  static hb_bool_t
  hb_ot_get_glyph_from_name (hb_font_t *font HB_UNUSED,
                             void *font_data,
                             const char *name, int len,
                             hb_codepoint_t *glyph,
                             void *user_data HB_UNUSED)
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   return ot_font-&gt;post-&gt;get_glyph_from_name (name, len, glyph);</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+   return ot_face-&gt;post-&gt;get_glyph_from_name (name, len, glyph);</span>
  }
  
  static hb_bool_t
  hb_ot_get_font_h_extents (hb_font_t *font,
                            void *font_data,
                            hb_font_extents_t *metrics,
                            void *user_data HB_UNUSED)
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   metrics-&gt;ascender = font-&gt;em_scale_y (ot_font-&gt;h_metrics.ascender);</span>
<span class="udiff-line-modified-removed">-   metrics-&gt;descender = font-&gt;em_scale_y (ot_font-&gt;h_metrics.descender);</span>
<span class="udiff-line-modified-removed">-   metrics-&gt;line_gap = font-&gt;em_scale_y (ot_font-&gt;h_metrics.line_gap);</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+   const OT::hmtx_accelerator_t &amp;hmtx = *ot_face-&gt;hmtx;</span>
<span class="udiff-line-modified-added">+   metrics-&gt;ascender = font-&gt;em_scale_y (hmtx.ascender);</span>
<span class="udiff-line-modified-added">+   metrics-&gt;descender = font-&gt;em_scale_y (hmtx.descender);</span>
<span class="udiff-line-added">+   metrics-&gt;line_gap = font-&gt;em_scale_y (hmtx.line_gap);</span>
    // TODO Hook up variations.
<span class="udiff-line-modified-removed">-   return ot_font-&gt;h_metrics.has_font_extents;</span>
<span class="udiff-line-modified-added">+   return hmtx.has_font_extents;</span>
  }
  
  static hb_bool_t
  hb_ot_get_font_v_extents (hb_font_t *font,
                            void *font_data,
                            hb_font_extents_t *metrics,
                            void *user_data HB_UNUSED)
  {
<span class="udiff-line-modified-removed">-   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="udiff-line-modified-removed">-   metrics-&gt;ascender = font-&gt;em_scale_x (ot_font-&gt;v_metrics.ascender);</span>
<span class="udiff-line-modified-removed">-   metrics-&gt;descender = font-&gt;em_scale_x (ot_font-&gt;v_metrics.descender);</span>
<span class="udiff-line-modified-removed">-   metrics-&gt;line_gap = font-&gt;em_scale_x (ot_font-&gt;v_metrics.line_gap);</span>
<span class="udiff-line-modified-added">+   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="udiff-line-modified-added">+   const OT::vmtx_accelerator_t &amp;vmtx = *ot_face-&gt;vmtx;</span>
<span class="udiff-line-modified-added">+   metrics-&gt;ascender = font-&gt;em_scale_x (vmtx.ascender);</span>
<span class="udiff-line-modified-added">+   metrics-&gt;descender = font-&gt;em_scale_x (vmtx.descender);</span>
<span class="udiff-line-added">+   metrics-&gt;line_gap = font-&gt;em_scale_x (vmtx.line_gap);</span>
    // TODO Hook up variations.
<span class="udiff-line-modified-removed">-   return ot_font-&gt;v_metrics.has_font_extents;</span>
<span class="udiff-line-modified-added">+   return vmtx.has_font_extents;</span>
  }
  
<span class="udiff-line-modified-removed">- static hb_font_funcs_t *static_ot_funcs = nullptr;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="udiff-line-removed">- static</span>
<span class="udiff-line-removed">- void free_static_ot_funcs (void)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- retry:</span>
<span class="udiff-line-removed">-   hb_font_funcs_t *ot_funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ot_funcs);</span>
<span class="udiff-line-removed">-   if (!hb_atomic_ptr_cmpexch (&amp;static_ot_funcs, ot_funcs, nullptr))</span>
<span class="udiff-line-removed">-     goto retry;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   hb_font_funcs_destroy (ot_funcs);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-modified-added">+ static void free_static_ot_funcs ();</span>
  #endif
  
<span class="udiff-line-modified-removed">- static hb_font_funcs_t *</span>
<span class="udiff-line-removed">- _hb_ot_get_font_funcs (void)</span>
<span class="udiff-line-modified-added">+ static struct hb_ot_font_funcs_lazy_loader_t : hb_font_funcs_lazy_loader_t&lt;hb_ot_font_funcs_lazy_loader_t&gt;</span>
  {
<span class="udiff-line-modified-removed">- retry:</span>
<span class="udiff-line-removed">-   hb_font_funcs_t *funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ot_funcs);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (unlikely (!funcs))</span>
<span class="udiff-line-modified-added">+   static hb_font_funcs_t *create ()</span>
    {
<span class="udiff-line-modified-removed">-     funcs = hb_font_funcs_create ();</span>
<span class="udiff-line-modified-added">+     hb_font_funcs_t *funcs = hb_font_funcs_create ();</span>
  
      hb_font_funcs_set_font_h_extents_func (funcs, hb_ot_get_font_h_extents, nullptr, nullptr);
      hb_font_funcs_set_font_v_extents_func (funcs, hb_ot_get_font_v_extents, nullptr, nullptr);
      hb_font_funcs_set_nominal_glyph_func (funcs, hb_ot_get_nominal_glyph, nullptr, nullptr);
<span class="udiff-line-added">+     hb_font_funcs_set_nominal_glyphs_func (funcs, hb_ot_get_nominal_glyphs, nullptr, nullptr);</span>
      hb_font_funcs_set_variation_glyph_func (funcs, hb_ot_get_variation_glyph, nullptr, nullptr);
<span class="udiff-line-modified-removed">-     hb_font_funcs_set_glyph_h_advance_func (funcs, hb_ot_get_glyph_h_advance, nullptr, nullptr);</span>
<span class="udiff-line-modified-removed">-     hb_font_funcs_set_glyph_v_advance_func (funcs, hb_ot_get_glyph_v_advance, nullptr, nullptr);</span>
<span class="udiff-line-modified-added">+     hb_font_funcs_set_glyph_h_advances_func (funcs, hb_ot_get_glyph_h_advances, nullptr, nullptr);</span>
<span class="udiff-line-modified-added">+     hb_font_funcs_set_glyph_v_advances_func (funcs, hb_ot_get_glyph_v_advances, nullptr, nullptr);</span>
      //hb_font_funcs_set_glyph_h_origin_func (funcs, hb_ot_get_glyph_h_origin, nullptr, nullptr);
<span class="udiff-line-modified-removed">-     //hb_font_funcs_set_glyph_v_origin_func (funcs, hb_ot_get_glyph_v_origin, nullptr, nullptr);</span>
<span class="udiff-line-removed">-     hb_font_funcs_set_glyph_h_kerning_func (funcs, hb_ot_get_glyph_h_kerning, nullptr, nullptr);</span>
<span class="udiff-line-removed">-     //hb_font_funcs_set_glyph_v_kerning_func (funcs, hb_ot_get_glyph_v_kerning, nullptr, nullptr);</span>
<span class="udiff-line-modified-added">+     hb_font_funcs_set_glyph_v_origin_func (funcs, hb_ot_get_glyph_v_origin, nullptr, nullptr);</span>
      hb_font_funcs_set_glyph_extents_func (funcs, hb_ot_get_glyph_extents, nullptr, nullptr);
      //hb_font_funcs_set_glyph_contour_point_func (funcs, hb_ot_get_glyph_contour_point, nullptr, nullptr);
      hb_font_funcs_set_glyph_name_func (funcs, hb_ot_get_glyph_name, nullptr, nullptr);
      hb_font_funcs_set_glyph_from_name_func (funcs, hb_ot_get_glyph_from_name, nullptr, nullptr);
  
      hb_font_funcs_make_immutable (funcs);
  
<span class="udiff-line-modified-removed">-     if (!hb_atomic_ptr_cmpexch (&amp;static_ot_funcs, nullptr, funcs)) {</span>
<span class="udiff-line-modified-removed">-       hb_font_funcs_destroy (funcs);</span>
<span class="udiff-line-modified-removed">-       goto retry;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-modified-added">+     atexit (free_static_ot_funcs);</span>
<span class="udiff-line-modified-added">+ #endif</span>
  
<span class="udiff-line-modified-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="udiff-line-modified-removed">-     atexit (free_static_ot_funcs); /* First person registers atexit() callback. */</span>
<span class="udiff-line-modified-added">+     return funcs;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-added">+ } static_ot_funcs;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-added">+ static</span>
<span class="udiff-line-added">+ void free_static_ot_funcs ()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   static_ot_funcs.free_instance ();</span>
<span class="udiff-line-added">+ }</span>
  #endif
<span class="udiff-line-removed">-   };</span>
  
<span class="udiff-line-modified-removed">-   return funcs;</span>
<span class="udiff-line-modified-added">+ static hb_font_funcs_t *</span>
<span class="udiff-line-added">+ _hb_ot_get_font_funcs ()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   return static_ot_funcs.get_unconst ();</span>
  }
  
  
  /**
   * hb_ot_font_set_funcs:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -273,14 +304,10 @@</span>
   * Since: 0.9.28
   **/
  void
  hb_ot_font_set_funcs (hb_font_t *font)
  {
<span class="udiff-line-removed">-   hb_ot_font_t *ot_font = _hb_ot_font_create (font-&gt;face);</span>
<span class="udiff-line-removed">-   if (unlikely (!ot_font))</span>
<span class="udiff-line-removed">-     return;</span>
<span class="udiff-line-removed">- </span>
    hb_font_set_funcs (font,
                       _hb_ot_get_font_funcs (),
<span class="udiff-line-modified-removed">-                      ot_font,</span>
<span class="udiff-line-modified-removed">-                      _hb_ot_font_destroy);</span>
<span class="udiff-line-modified-added">+                      &amp;font-&gt;face-&gt;table,</span>
<span class="udiff-line-modified-added">+                      nullptr);</span>
  }
</pre>
<center><a href="hb-ot-color-svg-table.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-glyf-table.hh.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>