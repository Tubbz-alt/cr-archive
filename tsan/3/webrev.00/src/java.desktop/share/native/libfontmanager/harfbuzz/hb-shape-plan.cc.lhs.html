<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/share/native/libfontmanager/harfbuzz/hb-shape-plan.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright Â© 2012  Google, Inc.
  3  *
  4  *  This is part of HarfBuzz, a text shaping library.
  5  *
  6  * Permission is hereby granted, without written agreement and without
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod
 25  */
 26 
<a name="1" id="anc1"></a><span class="line-modified"> 27 #include &quot;hb-private.hh&quot;</span>
<span class="line-modified"> 28 #include &quot;hb-debug.hh&quot;</span>
<span class="line-modified"> 29 #include &quot;hb-shape-plan-private.hh&quot;</span>
<span class="line-modified"> 30 #include &quot;hb-shaper-private.hh&quot;</span>
<span class="line-modified"> 31 #include &quot;hb-font-private.hh&quot;</span>
<span class="line-modified"> 32 #include &quot;hb-buffer-private.hh&quot;</span>
<span class="line-modified"> 33 </span>
<span class="line-modified"> 34 </span>
<span class="line-modified"> 35 static void</span>
<span class="line-modified"> 36 hb_shape_plan_plan (hb_shape_plan_t    *shape_plan,</span>
<span class="line-modified"> 37                     const hb_feature_t *user_features,</span>
<span class="line-modified"> 38                     unsigned int        num_user_features,</span>
<span class="line-modified"> 39                     const int          *coords,</span>
<span class="line-modified"> 40                     unsigned int        num_coords,</span>
<span class="line-modified"> 41                     const char * const *shaper_list)</span>


















 42 {
<a name="2" id="anc2"></a><span class="line-modified"> 43   DEBUG_MSG_FUNC (SHAPE_PLAN, shape_plan,</span>
<span class="line-modified"> 44                   &quot;num_features=%d num_coords=%d shaper_list=%p&quot;,</span>
<span class="line-modified"> 45                   num_user_features,</span>
<span class="line-modified"> 46                   num_coords,</span>
<span class="line-modified"> 47                   shaper_list);</span>

















 48 
<a name="3" id="anc3"></a><span class="line-modified"> 49   const hb_shaper_pair_t *shapers = _hb_shapers_get ();</span>


 50 
 51 #define HB_SHAPER_PLAN(shaper) \
 52         HB_STMT_START { \
<a name="4" id="anc4"></a><span class="line-modified"> 53           if (hb_##shaper##_shaper_face_data_ensure (shape_plan-&gt;face_unsafe)) { \</span>
<span class="line-modified"> 54             HB_SHAPER_DATA (shaper, shape_plan) = \</span>
<span class="line-modified"> 55               HB_SHAPER_DATA_CREATE_FUNC (shaper, shape_plan) (shape_plan, \</span>
<span class="line-modified"> 56                                                                user_features, num_user_features, \</span>
<span class="line-modified"> 57                                                                coords, num_coords); \</span>
<span class="line-removed"> 58             shape_plan-&gt;shaper_func = _hb_##shaper##_shape; \</span>
<span class="line-removed"> 59             shape_plan-&gt;shaper_name = #shaper; \</span>
<span class="line-removed"> 60             return; \</span>
 61           } \
 62         } HB_STMT_END
 63 
<a name="5" id="anc5"></a><span class="line-modified"> 64   if (likely (!shaper_list)) {</span>
<span class="line-modified"> 65     for (unsigned int i = 0; i &lt; HB_SHAPERS_COUNT; i++)</span>
<span class="line-modified"> 66       if (0)</span>

 67         ;
 68 #define HB_SHAPER_IMPLEMENT(shaper) \
<a name="6" id="anc6"></a><span class="line-modified"> 69       else if (shapers[i].func == _hb_##shaper##_shape) \</span>
 70         HB_SHAPER_PLAN (shaper);
 71 #include &quot;hb-shaper-list.hh&quot;
 72 #undef HB_SHAPER_IMPLEMENT
<a name="7" id="anc7"></a><span class="line-modified"> 73   } else {</span>
<span class="line-modified"> 74     for (; *shaper_list; shaper_list++)</span>
<span class="line-modified"> 75       if (0)</span>



 76         ;
 77 #define HB_SHAPER_IMPLEMENT(shaper) \
<a name="8" id="anc8"></a><span class="line-modified"> 78       else if (0 == strcmp (*shaper_list, #shaper)) \</span>
 79         HB_SHAPER_PLAN (shaper);
 80 #include &quot;hb-shaper-list.hh&quot;
 81 #undef HB_SHAPER_IMPLEMENT
 82   }
<a name="9" id="anc9"></a><span class="line-removed"> 83 </span>
 84 #undef HB_SHAPER_PLAN
<a name="10" id="anc10"></a>






























 85 }
 86 
 87 
 88 /*
 89  * hb_shape_plan_t
 90  */
 91 
<a name="11" id="anc11"></a>
 92 /**
 93  * hb_shape_plan_create: (Xconstructor)
 94  * @face:
 95  * @props:
 96  * @user_features: (array length=num_user_features):
 97  * @num_user_features:
 98  * @shaper_list: (array zero-terminated=1):
 99  *
100  *
101  *
102  * Return value: (transfer full):
103  *
104  * Since: 0.9.7
105  **/
106 hb_shape_plan_t *
107 hb_shape_plan_create (hb_face_t                     *face,
108                       const hb_segment_properties_t *props,
109                       const hb_feature_t            *user_features,
110                       unsigned int                   num_user_features,
111                       const char * const            *shaper_list)
112 {
113   return hb_shape_plan_create2 (face, props,
114                                 user_features, num_user_features,
115                                 nullptr, 0,
116                                 shaper_list);
117 }
118 
119 hb_shape_plan_t *
120 hb_shape_plan_create2 (hb_face_t                     *face,
121                        const hb_segment_properties_t *props,
122                        const hb_feature_t            *user_features,
123                        unsigned int                   num_user_features,
<a name="12" id="anc12"></a><span class="line-modified">124                        const int                     *orig_coords,</span>
125                        unsigned int                   num_coords,
126                        const char * const            *shaper_list)
127 {
128   DEBUG_MSG_FUNC (SHAPE_PLAN, nullptr,
129                   &quot;face=%p num_features=%d num_coords=%d shaper_list=%p&quot;,
130                   face,
131                   num_user_features,
132                   num_coords,
133                   shaper_list);
134 
<a name="13" id="anc13"></a>

135   hb_shape_plan_t *shape_plan;
<a name="14" id="anc14"></a><span class="line-removed">136   hb_feature_t *features = nullptr;</span>
<span class="line-removed">137   int *coords = nullptr;</span>
138 
<a name="15" id="anc15"></a><span class="line-removed">139   if (unlikely (!face))</span>
<span class="line-removed">140     face = hb_face_get_empty ();</span>
141   if (unlikely (!props))
<a name="16" id="anc16"></a><span class="line-modified">142     return hb_shape_plan_get_empty ();</span>
<span class="line-removed">143   if (num_user_features &amp;&amp; !(features = (hb_feature_t *) calloc (num_user_features, sizeof (hb_feature_t))))</span>
<span class="line-removed">144     return hb_shape_plan_get_empty ();</span>
<span class="line-removed">145   if (num_coords &amp;&amp; !(coords = (int *) calloc (num_coords, sizeof (int))))</span>
<span class="line-removed">146   {</span>
<span class="line-removed">147     free (features);</span>
<span class="line-removed">148     return hb_shape_plan_get_empty ();</span>
<span class="line-removed">149   }</span>
150   if (!(shape_plan = hb_object_create&lt;hb_shape_plan_t&gt; ()))
<a name="17" id="anc17"></a><span class="line-modified">151   {</span>
<span class="line-removed">152     free (coords);</span>
<span class="line-removed">153     free (features);</span>
<span class="line-removed">154     return hb_shape_plan_get_empty ();</span>
<span class="line-removed">155   }</span>
<span class="line-removed">156 </span>
<span class="line-removed">157   assert (props-&gt;direction != HB_DIRECTION_INVALID);</span>
158 
<a name="18" id="anc18"></a>

159   hb_face_make_immutable (face);
<a name="19" id="anc19"></a><span class="line-removed">160   shape_plan-&gt;default_shaper_list = !shaper_list;</span>
161   shape_plan-&gt;face_unsafe = face;
<a name="20" id="anc20"></a><span class="line-removed">162   shape_plan-&gt;props = *props;</span>
<span class="line-removed">163   shape_plan-&gt;num_user_features = num_user_features;</span>
<span class="line-removed">164   shape_plan-&gt;user_features = features;</span>
<span class="line-removed">165   if (num_user_features)</span>
<span class="line-removed">166     memcpy (features, user_features, num_user_features * sizeof (hb_feature_t));</span>
<span class="line-removed">167   shape_plan-&gt;num_coords = num_coords;</span>
<span class="line-removed">168   shape_plan-&gt;coords = coords;</span>
<span class="line-removed">169   if (num_coords)</span>
<span class="line-removed">170     memcpy (coords, orig_coords, num_coords * sizeof (int));</span>
171 
<a name="21" id="anc21"></a><span class="line-modified">172   hb_shape_plan_plan (shape_plan,</span>
<span class="line-modified">173                       user_features, num_user_features,</span>
<span class="line-modified">174                       coords, num_coords,</span>
<span class="line-modified">175                       shaper_list);</span>







176 
177   return shape_plan;
<a name="22" id="anc22"></a>






178 }
179 
180 /**
181  * hb_shape_plan_get_empty:
182  *
183  *
184  *
185  * Return value: (transfer full):
186  *
187  * Since: 0.9.7
188  **/
189 hb_shape_plan_t *
<a name="23" id="anc23"></a><span class="line-modified">190 hb_shape_plan_get_empty (void)</span>
191 {
<a name="24" id="anc24"></a><span class="line-modified">192   static const hb_shape_plan_t _hb_shape_plan_nil = {</span>
<span class="line-removed">193     HB_OBJECT_HEADER_STATIC,</span>
<span class="line-removed">194 </span>
<span class="line-removed">195     true, /* default_shaper_list */</span>
<span class="line-removed">196     nullptr, /* face */</span>
<span class="line-removed">197     HB_SEGMENT_PROPERTIES_DEFAULT, /* props */</span>
<span class="line-removed">198 </span>
<span class="line-removed">199     nullptr, /* shaper_func */</span>
<span class="line-removed">200     nullptr, /* shaper_name */</span>
<span class="line-removed">201 </span>
<span class="line-removed">202     nullptr, /* user_features */</span>
<span class="line-removed">203     0,    /* num_user_featurs */</span>
<span class="line-removed">204 </span>
<span class="line-removed">205     nullptr, /* coords */</span>
<span class="line-removed">206     0,    /* num_coords */</span>
<span class="line-removed">207 </span>
<span class="line-removed">208     {</span>
<span class="line-removed">209 #define HB_SHAPER_IMPLEMENT(shaper) HB_SHAPER_DATA_INVALID,</span>
<span class="line-removed">210 #include &quot;hb-shaper-list.hh&quot;</span>
<span class="line-removed">211 #undef HB_SHAPER_IMPLEMENT</span>
<span class="line-removed">212     }</span>
<span class="line-removed">213   };</span>
<span class="line-removed">214 </span>
<span class="line-removed">215   return const_cast&lt;hb_shape_plan_t *&gt; (&amp;_hb_shape_plan_nil);</span>
216 }
217 
218 /**
219  * hb_shape_plan_reference: (skip)
220  * @shape_plan: a shape plan.
221  *
222  *
223  *
224  * Return value: (transfer full):
225  *
226  * Since: 0.9.7
227  **/
228 hb_shape_plan_t *
229 hb_shape_plan_reference (hb_shape_plan_t *shape_plan)
230 {
231   return hb_object_reference (shape_plan);
232 }
233 
234 /**
235  * hb_shape_plan_destroy: (skip)
236  * @shape_plan: a shape plan.
237  *
238  *
239  *
240  * Since: 0.9.7
241  **/
242 void
243 hb_shape_plan_destroy (hb_shape_plan_t *shape_plan)
244 {
245   if (!hb_object_destroy (shape_plan)) return;
246 
<a name="25" id="anc25"></a><span class="line-modified">247 #define HB_SHAPER_IMPLEMENT(shaper) HB_SHAPER_DATA_DESTROY(shaper, shape_plan);</span>
<span class="line-modified">248 #include &quot;hb-shaper-list.hh&quot;</span>
<span class="line-removed">249 #undef HB_SHAPER_IMPLEMENT</span>
<span class="line-removed">250 </span>
<span class="line-removed">251   free (shape_plan-&gt;user_features);</span>
<span class="line-removed">252   free (shape_plan-&gt;coords);</span>
<span class="line-removed">253 </span>
254   free (shape_plan);
255 }
256 
257 /**
258  * hb_shape_plan_set_user_data: (skip)
259  * @shape_plan: a shape plan.
260  * @key:
261  * @data:
262  * @destroy:
263  * @replace:
264  *
265  *
266  *
267  * Return value:
268  *
269  * Since: 0.9.7
270  **/
271 hb_bool_t
272 hb_shape_plan_set_user_data (hb_shape_plan_t    *shape_plan,
273                              hb_user_data_key_t *key,
274                              void *              data,
275                              hb_destroy_func_t   destroy,
276                              hb_bool_t           replace)
277 {
278   return hb_object_set_user_data (shape_plan, key, data, destroy, replace);
279 }
280 
281 /**
282  * hb_shape_plan_get_user_data: (skip)
283  * @shape_plan: a shape plan.
284  * @key:
285  *
286  *
287  *
288  * Return value: (transfer none):
289  *
290  * Since: 0.9.7
291  **/
292 void *
293 hb_shape_plan_get_user_data (hb_shape_plan_t    *shape_plan,
294                              hb_user_data_key_t *key)
295 {
296   return hb_object_get_user_data (shape_plan, key);
297 }
298 
<a name="26" id="anc26"></a>















299 
300 /**
301  * hb_shape_plan_execute:
302  * @shape_plan: a shape plan.
303  * @font: a font.
304  * @buffer: a buffer.
305  * @features: (array length=num_features):
306  * @num_features:
307  *
308  *
309  *
310  * Return value:
311  *
312  * Since: 0.9.7
313  **/
314 hb_bool_t
315 hb_shape_plan_execute (hb_shape_plan_t    *shape_plan,
316                        hb_font_t          *font,
317                        hb_buffer_t        *buffer,
318                        const hb_feature_t *features,
319                        unsigned int        num_features)
320 {
321   DEBUG_MSG_FUNC (SHAPE_PLAN, shape_plan,
322                   &quot;num_features=%d shaper_func=%p, shaper_name=%s&quot;,
323                   num_features,
<a name="27" id="anc27"></a><span class="line-modified">324                   shape_plan-&gt;shaper_func,</span>
<span class="line-modified">325                   shape_plan-&gt;shaper_name);</span>
326 
327   if (unlikely (!buffer-&gt;len))
328     return true;
329 
<a name="28" id="anc28"></a><span class="line-modified">330   assert (!hb_object_is_inert (buffer));</span>
331   assert (buffer-&gt;content_type == HB_BUFFER_CONTENT_TYPE_UNICODE);
332 
333   if (unlikely (hb_object_is_inert (shape_plan)))
334     return false;
335 
336   assert (shape_plan-&gt;face_unsafe == font-&gt;face);
<a name="29" id="anc29"></a><span class="line-modified">337   assert (hb_segment_properties_equal (&amp;shape_plan-&gt;props, &amp;buffer-&gt;props));</span>
338 
339 #define HB_SHAPER_EXECUTE(shaper) \
340         HB_STMT_START { \
<a name="30" id="anc30"></a><span class="line-modified">341           return HB_SHAPER_DATA (shaper, shape_plan) &amp;&amp; \</span>
<span class="line-removed">342                  hb_##shaper##_shaper_font_data_ensure (font) &amp;&amp; \</span>
343                  _hb_##shaper##_shape (shape_plan, font, buffer, features, num_features); \
344         } HB_STMT_END
345 
<a name="31" id="anc31"></a><span class="line-modified">346   if (0)</span>
347     ;
348 #define HB_SHAPER_IMPLEMENT(shaper) \
<a name="32" id="anc32"></a><span class="line-modified">349   else if (shape_plan-&gt;shaper_func == _hb_##shaper##_shape) \</span>
350     HB_SHAPER_EXECUTE (shaper);
351 #include &quot;hb-shaper-list.hh&quot;
352 #undef HB_SHAPER_IMPLEMENT
353 
354 #undef HB_SHAPER_EXECUTE
355 
356   return false;
357 }
358 
359 
360 /*
<a name="33" id="anc33"></a><span class="line-modified">361  * caching</span>
<span class="line-removed">362  */</span>
<span class="line-removed">363 </span>
<span class="line-removed">364 #if 0</span>
<span class="line-removed">365 static unsigned int</span>
<span class="line-removed">366 hb_shape_plan_hash (const hb_shape_plan_t *shape_plan)</span>
<span class="line-removed">367 {</span>
<span class="line-removed">368   return hb_segment_properties_hash (&amp;shape_plan-&gt;props) +</span>
<span class="line-removed">369          shape_plan-&gt;default_shaper_list ? 0 : (intptr_t) shape_plan-&gt;shaper_func;</span>
<span class="line-removed">370 }</span>
<span class="line-removed">371 #endif</span>
<span class="line-removed">372 </span>
<span class="line-removed">373 /* User-feature caching is currently somewhat dumb:</span>
<span class="line-removed">374  * it only finds matches where the feature array is identical,</span>
<span class="line-removed">375  * not cases where the feature lists would be compatible for plan purposes</span>
<span class="line-removed">376  * but have different ranges, for example.</span>
377  */
<a name="34" id="anc34"></a><span class="line-removed">378 struct hb_shape_plan_proposal_t</span>
<span class="line-removed">379 {</span>
<span class="line-removed">380   const hb_segment_properties_t  props;</span>
<span class="line-removed">381   const char * const            *shaper_list;</span>
<span class="line-removed">382   const hb_feature_t            *user_features;</span>
<span class="line-removed">383   unsigned int                   num_user_features;</span>
<span class="line-removed">384   const int                     *coords;</span>
<span class="line-removed">385   unsigned int                   num_coords;</span>
<span class="line-removed">386   hb_shape_func_t               *shaper_func;</span>
<span class="line-removed">387 };</span>
<span class="line-removed">388 </span>
<span class="line-removed">389 static inline hb_bool_t</span>
<span class="line-removed">390 hb_shape_plan_user_features_match (const hb_shape_plan_t          *shape_plan,</span>
<span class="line-removed">391                                    const hb_shape_plan_proposal_t *proposal)</span>
<span class="line-removed">392 {</span>
<span class="line-removed">393   if (proposal-&gt;num_user_features != shape_plan-&gt;num_user_features)</span>
<span class="line-removed">394     return false;</span>
<span class="line-removed">395   for (unsigned int i = 0, n = proposal-&gt;num_user_features; i &lt; n; i++)</span>
<span class="line-removed">396     if (proposal-&gt;user_features[i].tag   != shape_plan-&gt;user_features[i].tag   ||</span>
<span class="line-removed">397         proposal-&gt;user_features[i].value != shape_plan-&gt;user_features[i].value ||</span>
<span class="line-removed">398         proposal-&gt;user_features[i].start != shape_plan-&gt;user_features[i].start ||</span>
<span class="line-removed">399         proposal-&gt;user_features[i].end   != shape_plan-&gt;user_features[i].end)</span>
<span class="line-removed">400       return false;</span>
<span class="line-removed">401   return true;</span>
<span class="line-removed">402 }</span>
<span class="line-removed">403 </span>
<span class="line-removed">404 static inline hb_bool_t</span>
<span class="line-removed">405 hb_shape_plan_coords_match (const hb_shape_plan_t          *shape_plan,</span>
<span class="line-removed">406                             const hb_shape_plan_proposal_t *proposal)</span>
<span class="line-removed">407 {</span>
<span class="line-removed">408   if (proposal-&gt;num_coords != shape_plan-&gt;num_coords)</span>
<span class="line-removed">409     return false;</span>
<span class="line-removed">410   for (unsigned int i = 0, n = proposal-&gt;num_coords; i &lt; n; i++)</span>
<span class="line-removed">411     if (proposal-&gt;coords[i] != shape_plan-&gt;coords[i])</span>
<span class="line-removed">412       return false;</span>
<span class="line-removed">413   return true;</span>
<span class="line-removed">414 }</span>
<span class="line-removed">415 </span>
<span class="line-removed">416 static hb_bool_t</span>
<span class="line-removed">417 hb_shape_plan_matches (const hb_shape_plan_t          *shape_plan,</span>
<span class="line-removed">418                        const hb_shape_plan_proposal_t *proposal)</span>
<span class="line-removed">419 {</span>
<span class="line-removed">420   return hb_segment_properties_equal (&amp;shape_plan-&gt;props, &amp;proposal-&gt;props) &amp;&amp;</span>
<span class="line-removed">421          hb_shape_plan_user_features_match (shape_plan, proposal) &amp;&amp;</span>
<span class="line-removed">422          hb_shape_plan_coords_match (shape_plan, proposal) &amp;&amp;</span>
<span class="line-removed">423          ((shape_plan-&gt;default_shaper_list &amp;&amp; !proposal-&gt;shaper_list) ||</span>
<span class="line-removed">424           (shape_plan-&gt;shaper_func == proposal-&gt;shaper_func));</span>
<span class="line-removed">425 }</span>
<span class="line-removed">426 </span>
<span class="line-removed">427 static inline hb_bool_t</span>
<span class="line-removed">428 hb_non_global_user_features_present (const hb_feature_t *user_features,</span>
<span class="line-removed">429                                      unsigned int        num_user_features)</span>
<span class="line-removed">430 {</span>
<span class="line-removed">431   while (num_user_features) {</span>
<span class="line-removed">432     if (user_features-&gt;start != 0 || user_features-&gt;end != (unsigned int) -1)</span>
<span class="line-removed">433       return true;</span>
<span class="line-removed">434     num_user_features--;</span>
<span class="line-removed">435     user_features++;</span>
<span class="line-removed">436   }</span>
<span class="line-removed">437   return false;</span>
<span class="line-removed">438 }</span>
<span class="line-removed">439 </span>
<span class="line-removed">440 static inline hb_bool_t</span>
<span class="line-removed">441 hb_coords_present (const int *coords,</span>
<span class="line-removed">442                    unsigned int num_coords)</span>
<span class="line-removed">443 {</span>
<span class="line-removed">444   return num_coords != 0;</span>
<span class="line-removed">445 }</span>
446 
447 /**
448  * hb_shape_plan_create_cached:
449  * @face:
450  * @props:
451  * @user_features: (array length=num_user_features):
452  * @num_user_features:
453  * @shaper_list: (array zero-terminated=1):
454  *
455  *
456  *
457  * Return value: (transfer full):
458  *
459  * Since: 0.9.7
460  **/
461 hb_shape_plan_t *
462 hb_shape_plan_create_cached (hb_face_t                     *face,
463                              const hb_segment_properties_t *props,
464                              const hb_feature_t            *user_features,
465                              unsigned int                   num_user_features,
466                              const char * const            *shaper_list)
467 {
468   return hb_shape_plan_create_cached2 (face, props,
469                                        user_features, num_user_features,
470                                        nullptr, 0,
471                                        shaper_list);
472 }
473 
474 hb_shape_plan_t *
475 hb_shape_plan_create_cached2 (hb_face_t                     *face,
476                               const hb_segment_properties_t *props,
477                               const hb_feature_t            *user_features,
478                               unsigned int                   num_user_features,
479                               const int                     *coords,
480                               unsigned int                   num_coords,
481                               const char * const            *shaper_list)
482 {
483   DEBUG_MSG_FUNC (SHAPE_PLAN, nullptr,
484                   &quot;face=%p num_features=%d shaper_list=%p&quot;,
485                   face,
486                   num_user_features,
487                   shaper_list);
488 
<a name="35" id="anc35"></a><span class="line-modified">489   hb_shape_plan_proposal_t proposal = {</span>
<span class="line-modified">490     *props,</span>
<span class="line-removed">491     shaper_list,</span>
<span class="line-removed">492     user_features,</span>
<span class="line-removed">493     num_user_features,</span>
<span class="line-removed">494     nullptr</span>
<span class="line-removed">495   };</span>
<span class="line-removed">496 </span>
<span class="line-removed">497   if (shaper_list) {</span>
<span class="line-removed">498     /* Choose shaper.  Adapted from hb_shape_plan_plan().</span>
<span class="line-removed">499      * Must choose shaper exactly the same way as that function. */</span>
<span class="line-removed">500     for (const char * const *shaper_item = shaper_list; *shaper_item; shaper_item++)</span>
<span class="line-removed">501       if (0)</span>
<span class="line-removed">502         ;</span>
<span class="line-removed">503 #define HB_SHAPER_IMPLEMENT(shaper) \</span>
<span class="line-removed">504       else if (0 == strcmp (*shaper_item, #shaper) &amp;&amp; \</span>
<span class="line-removed">505                hb_##shaper##_shaper_face_data_ensure (face)) \</span>
<span class="line-removed">506       { \</span>
<span class="line-removed">507         proposal.shaper_func = _hb_##shaper##_shape; \</span>
<span class="line-removed">508         break; \</span>
<span class="line-removed">509       }</span>
<span class="line-removed">510 #include &quot;hb-shaper-list.hh&quot;</span>
<span class="line-removed">511 #undef HB_SHAPER_IMPLEMENT</span>
<span class="line-removed">512 </span>
<span class="line-removed">513     if (unlikely (!proposal.shaper_func))</span>
<span class="line-removed">514       return hb_shape_plan_get_empty ();</span>
<span class="line-removed">515   }</span>
516 
<a name="36" id="anc36"></a>
517 
<a name="37" id="anc37"></a><span class="line-modified">518 retry:</span>
<span class="line-modified">519   hb_face_t::plan_node_t *cached_plan_nodes = (hb_face_t::plan_node_t *) hb_atomic_ptr_get (&amp;face-&gt;shape_plans);</span>










520 
<a name="38" id="anc38"></a><span class="line-removed">521   /* Don&#39;t look for plan in the cache if there were variation coordinates XXX Fix me. */</span>
<span class="line-removed">522   if (!hb_coords_present (coords, num_coords))</span>
523     for (hb_face_t::plan_node_t *node = cached_plan_nodes; node; node = node-&gt;next)
<a name="39" id="anc39"></a><span class="line-modified">524       if (hb_shape_plan_matches (node-&gt;shape_plan, &amp;proposal))</span>
525       {
526         DEBUG_MSG_FUNC (SHAPE_PLAN, node-&gt;shape_plan, &quot;fulfilled from cache&quot;);
527         return hb_shape_plan_reference (node-&gt;shape_plan);
528       }
<a name="40" id="anc40"></a>
529 
<a name="41" id="anc41"></a><span class="line-removed">530   /* Not found. */</span>
531   hb_shape_plan_t *shape_plan = hb_shape_plan_create2 (face, props,
532                                                        user_features, num_user_features,
533                                                        coords, num_coords,
534                                                        shaper_list);
535 
<a name="42" id="anc42"></a><span class="line-modified">536   /* Don&#39;t add to the cache if face is inert. */</span>
<span class="line-removed">537   if (unlikely (hb_object_is_inert (face)))</span>
<span class="line-removed">538     return shape_plan;</span>
<span class="line-removed">539 </span>
<span class="line-removed">540   /* Don&#39;t add the plan to the cache if there were user features with non-global ranges */</span>
<span class="line-removed">541   if (hb_non_global_user_features_present (user_features, num_user_features))</span>
<span class="line-removed">542     return shape_plan;</span>
<span class="line-removed">543   /* Don&#39;t add the plan to the cache if there were variation coordinates XXX Fix me. */</span>
<span class="line-removed">544   if (hb_coords_present (coords, num_coords))</span>
545     return shape_plan;
546 
547   hb_face_t::plan_node_t *node = (hb_face_t::plan_node_t *) calloc (1, sizeof (hb_face_t::plan_node_t));
548   if (unlikely (!node))
549     return shape_plan;
550 
551   node-&gt;shape_plan = shape_plan;
552   node-&gt;next = cached_plan_nodes;
553 
<a name="43" id="anc43"></a><span class="line-modified">554   if (!hb_atomic_ptr_cmpexch (&amp;face-&gt;shape_plans, cached_plan_nodes, node)) {</span>

555     hb_shape_plan_destroy (shape_plan);
556     free (node);
557     goto retry;
558   }
559   DEBUG_MSG_FUNC (SHAPE_PLAN, shape_plan, &quot;inserted into cache&quot;);
560 
561   return hb_shape_plan_reference (shape_plan);
562 }
<a name="44" id="anc44"></a><span class="line-removed">563 </span>
<span class="line-removed">564 /**</span>
<span class="line-removed">565  * hb_shape_plan_get_shaper:</span>
<span class="line-removed">566  * @shape_plan: a shape plan.</span>
<span class="line-removed">567  *</span>
<span class="line-removed">568  *</span>
<span class="line-removed">569  *</span>
<span class="line-removed">570  * Return value: (transfer none):</span>
<span class="line-removed">571  *</span>
<span class="line-removed">572  * Since: 0.9.7</span>
<span class="line-removed">573  **/</span>
<span class="line-removed">574 const char *</span>
<span class="line-removed">575 hb_shape_plan_get_shaper (hb_shape_plan_t *shape_plan)</span>
<span class="line-removed">576 {</span>
<span class="line-removed">577   return shape_plan-&gt;shaper_name;</span>
<span class="line-removed">578 }</span>
<a name="45" id="anc45"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="45" type="hidden" />
</body>
</html>