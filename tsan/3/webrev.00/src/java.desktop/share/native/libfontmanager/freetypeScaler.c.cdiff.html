<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfontmanager/freetypeScaler.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="HBShaper.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="harfbuzz/hb-blob.cc.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/freetypeScaler.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2007, 2013, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 27,20 ***</span>
  #include &quot;jni_util.h&quot;
  #include &quot;jlong.h&quot;
  #include &quot;sunfontids.h&quot;
  #include &quot;sun_font_FreetypeFontScaler.h&quot;
  
<span class="line-modified">! #include&lt;stdlib.h&gt;</span>
  #include &lt;math.h&gt;
  #include &quot;ft2build.h&quot;
  #include FT_FREETYPE_H
  #include FT_GLYPH_H
  #include FT_BBOX_H
  #include FT_SIZES_H
  #include FT_OUTLINE_H
  #include FT_SYNTHESIS_H
  #include FT_LCD_FILTER_H
  
  #include &quot;fontscaler.h&quot;
  
  #define  ftFixed1  (FT_Fixed) (1 &lt;&lt; 16)
  #define  FloatToFTFixed(f) (FT_Fixed)((f) * (float)(ftFixed1))
<span class="line-new-header">--- 27,24 ---</span>
  #include &quot;jni_util.h&quot;
  #include &quot;jlong.h&quot;
  #include &quot;sunfontids.h&quot;
  #include &quot;sun_font_FreetypeFontScaler.h&quot;
  
<span class="line-modified">! #include &lt;stdlib.h&gt;</span>
<span class="line-added">+ #if !defined(_WIN32) &amp;&amp; !defined(__APPLE_)</span>
<span class="line-added">+ #include &lt;dlfcn.h&gt;</span>
<span class="line-added">+ #endif</span>
  #include &lt;math.h&gt;
  #include &quot;ft2build.h&quot;
  #include FT_FREETYPE_H
  #include FT_GLYPH_H
  #include FT_BBOX_H
  #include FT_SIZES_H
  #include FT_OUTLINE_H
  #include FT_SYNTHESIS_H
  #include FT_LCD_FILTER_H
<span class="line-added">+ #include FT_MODULE_H</span>
  
  #include &quot;fontscaler.h&quot;
  
  #define  ftFixed1  (FT_Fixed) (1 &lt;&lt; 16)
  #define  FloatToFTFixed(f) (FT_Fixed)((f) * (float)(ftFixed1))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 67,11 ***</span>
  
      unsigned char* fontData;
      unsigned fontDataOffset;
      unsigned fontDataLength;
      unsigned fileSize;
<span class="line-removed">-     TTLayoutTableCache* layoutTables;</span>
  } FTScalerInfo;
  
  typedef struct FTScalerContext {
      FT_Matrix  transform;     /* glyph transform, including device transform */
      jboolean   useSbits;      /* sbit usage enabled? */
<span class="line-new-header">--- 71,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 149,21 ***</span>
      FTScalerInfo *scalerInfo = (FTScalerInfo *) stream-&gt;pathname.pointer;
      JNIEnv* env = scalerInfo-&gt;env;
      jobject bBuffer;
      int bread = 0;
  
<span class="line-modified">!     if (numBytes == 0) return 0;</span>
  
      /* Large reads will bypass the cache and data copying */
      if (numBytes &gt; FILEDATACACHESIZE) {
          bBuffer = (*env)-&gt;NewDirectByteBuffer(env, destBuffer, numBytes);
          if (bBuffer != NULL) {
              bread = (*env)-&gt;CallIntMethod(env,
                                            scalerInfo-&gt;font2D,
                                            sunFontIDs.ttReadBlockMID,
                                            bBuffer, offset, numBytes);
<span class="line-modified">!             return bread;</span>
          } else {
              /* We probably hit bug 4845371. For reasons that
               * are currently unclear, the call stacks after the initial
               * createScaler call that read large amounts of data seem to
               * be OK and can create the byte buffer above, but this code
<span class="line-new-header">--- 152,49 ---</span>
      FTScalerInfo *scalerInfo = (FTScalerInfo *) stream-&gt;pathname.pointer;
      JNIEnv* env = scalerInfo-&gt;env;
      jobject bBuffer;
      int bread = 0;
  
<span class="line-modified">!     /* A call with numBytes == 0 is a seek. It should return 0 if the</span>
<span class="line-added">+      * seek position is within the file and non-zero otherwise.</span>
<span class="line-added">+      * For all other cases, ie numBytes !=0, return the number of bytes</span>
<span class="line-added">+      * actually read. This applies to truncated reads and also failed reads.</span>
<span class="line-added">+      */</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (numBytes == 0) {</span>
<span class="line-added">+         if (offset &gt; scalerInfo-&gt;fileSize) {</span>
<span class="line-added">+             return -1;</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             return 0;</span>
<span class="line-added">+        }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (offset + numBytes &lt; offset) {</span>
<span class="line-added">+         return 0; // ft should not do this, but just in case.</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (offset &gt;= scalerInfo-&gt;fileSize) {</span>
<span class="line-added">+         return 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (offset + numBytes &gt; scalerInfo-&gt;fileSize) {</span>
<span class="line-added">+         numBytes = scalerInfo-&gt;fileSize - offset;</span>
<span class="line-added">+     }</span>
  
      /* Large reads will bypass the cache and data copying */
      if (numBytes &gt; FILEDATACACHESIZE) {
          bBuffer = (*env)-&gt;NewDirectByteBuffer(env, destBuffer, numBytes);
          if (bBuffer != NULL) {
              bread = (*env)-&gt;CallIntMethod(env,
                                            scalerInfo-&gt;font2D,
                                            sunFontIDs.ttReadBlockMID,
                                            bBuffer, offset, numBytes);
<span class="line-modified">!             if (bread &lt; 0) {</span>
<span class="line-added">+                 return 0;</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                return bread;</span>
<span class="line-added">+             }</span>
          } else {
              /* We probably hit bug 4845371. For reasons that
               * are currently unclear, the call stacks after the initial
               * createScaler call that read large amounts of data seem to
               * be OK and can create the byte buffer above, but this code
</pre>
<hr />
<pre>
<span class="line-old-header">*** 174,13 ***</span>
               */
              jbyteArray byteArray = (jbyteArray)
              (*env)-&gt;CallObjectMethod(env, scalerInfo-&gt;font2D,
                                       sunFontIDs.ttReadBytesMID,
                                       offset, numBytes);
<span class="line-modified">!             (*env)-&gt;GetByteArrayRegion(env, byteArray,</span>
<span class="line-modified">!                                        0, numBytes, (jbyte*)destBuffer);</span>
<span class="line-modified">!             return numBytes;</span>
          }
      } /* Do we have a cache hit? */
        else if (scalerInfo-&gt;fontDataOffset &lt;= offset &amp;&amp;
          scalerInfo-&gt;fontDataOffset + scalerInfo-&gt;fontDataLength &gt;=
                                                           offset + numBytes)
<span class="line-new-header">--- 205,22 ---</span>
               */
              jbyteArray byteArray = (jbyteArray)
              (*env)-&gt;CallObjectMethod(env, scalerInfo-&gt;font2D,
                                       sunFontIDs.ttReadBytesMID,
                                       offset, numBytes);
<span class="line-modified">!             /* If there&#39;s an OutofMemoryError then byteArray will be null */</span>
<span class="line-modified">!             if (byteArray == NULL) {</span>
<span class="line-modified">!                 return 0;</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 jsize len = (*env)-&gt;GetArrayLength(env, byteArray);</span>
<span class="line-added">+                 if (len &lt; numBytes) {</span>
<span class="line-added">+                     numBytes = len; // don&#39;t get more bytes than there are ..</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 (*env)-&gt;GetByteArrayRegion(env, byteArray,</span>
<span class="line-added">+                                            0, numBytes, (jbyte*)destBuffer);</span>
<span class="line-added">+                 return numBytes;</span>
<span class="line-added">+             }</span>
          }
      } /* Do we have a cache hit? */
        else if (scalerInfo-&gt;fontDataOffset &lt;= offset &amp;&amp;
          scalerInfo-&gt;fontDataOffset + scalerInfo-&gt;fontDataLength &gt;=
                                                           offset + numBytes)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 198,15 ***</span>
<span class="line-new-header">--- 238,66 ---</span>
          bBuffer = scalerInfo-&gt;directBuffer;
          bread = (*env)-&gt;CallIntMethod(env, scalerInfo-&gt;font2D,
                                        sunFontIDs.ttReadBlockMID,
                                        bBuffer, offset,
                                        scalerInfo-&gt;fontDataLength);
<span class="line-added">+         if (bread &lt;= 0) {</span>
<span class="line-added">+             return 0;</span>
<span class="line-added">+         } else if (bread &lt; numBytes) {</span>
<span class="line-added">+            numBytes = bread;</span>
<span class="line-added">+         }</span>
          memcpy(destBuffer, scalerInfo-&gt;fontData, numBytes);
          return numBytes;
      }
  }
  
<span class="line-added">+ typedef FT_Error (*FT_Prop_Set_Func)(FT_Library library,</span>
<span class="line-added">+                                      const FT_String*  module_name,</span>
<span class="line-added">+                                      const FT_String*  property_name,</span>
<span class="line-added">+                                      const void*       value );</span>
<span class="line-added">+ </span>
<span class="line-added">+ /**</span>
<span class="line-added">+  * Prefer the older v35 freetype byte code interpreter.</span>
<span class="line-added">+  */</span>
<span class="line-added">+ static void setInterpreterVersion(FT_Library library) {</span>
<span class="line-added">+ </span>
<span class="line-added">+     char* props = getenv(&quot;FREETYPE_PROPERTIES&quot;);</span>
<span class="line-added">+     int version = 35;</span>
<span class="line-added">+     const char* module = &quot;truetype&quot;;</span>
<span class="line-added">+     const char* property = &quot;interpreter-version&quot;;</span>
<span class="line-added">+ </span>
<span class="line-added">+     /* If some one is setting this, don&#39;t override it */</span>
<span class="line-added">+     if (props != NULL &amp;&amp; strstr(property, props)) {</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     /*</span>
<span class="line-added">+      * FT_Property_Set was introduced in 2.4.11.</span>
<span class="line-added">+      * Some older supported Linux OSes may not include it so look</span>
<span class="line-added">+      * this up dynamically.</span>
<span class="line-added">+      * And if its not available it doesn&#39;t matter, since the reason</span>
<span class="line-added">+      * we need it dates from 2.7.</span>
<span class="line-added">+      * On Windows &amp; Mac the library is always bundled so it is safe</span>
<span class="line-added">+      * to use directly in those cases.</span>
<span class="line-added">+      */</span>
<span class="line-added">+ #if defined(_WIN32) || defined(__APPLE__)</span>
<span class="line-added">+     FT_Property_Set(library, module, property, (void*)(&amp;version));</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     void *lib = dlopen(&quot;libfreetype.so&quot;, RTLD_LOCAL|RTLD_LAZY);</span>
<span class="line-added">+     if (lib == NULL) {</span>
<span class="line-added">+         lib = dlopen(&quot;libfreetype.so.6&quot;, RTLD_LOCAL|RTLD_LAZY);</span>
<span class="line-added">+         if (lib == NULL) {</span>
<span class="line-added">+             return;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+     FT_Prop_Set_Func func = (FT_Prop_Set_Func)dlsym(lib, &quot;FT_Property_Set&quot;);</span>
<span class="line-added">+     if (func != NULL) {</span>
<span class="line-added">+         func(library, module, property, (void*)(&amp;version));</span>
<span class="line-added">+     }</span>
<span class="line-added">+     dlclose(lib);</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  /*
   * Class:     sun_font_FreetypeFontScaler
   * Method:    initNativeScaler
   * Signature: (Lsun/font/Font2D;IIZI)J
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 242,18 ***</span>
      error = FT_Init_FreeType(&amp;scalerInfo-&gt;library);
      if (error) {
          free(scalerInfo);
          return 0;
      }
  
  #define TYPE1_FROM_JAVA        2
  
      error = 1; /* triggers memory freeing unless we clear it */
      if (type == TYPE1_FROM_JAVA) { /* TYPE1 */
          scalerInfo-&gt;fontData = (unsigned char*) malloc(filesize);
          scalerInfo-&gt;directBuffer = NULL;
<span class="line-removed">-         scalerInfo-&gt;layoutTables = NULL;</span>
          scalerInfo-&gt;fontDataLength = filesize;
  
          if (scalerInfo-&gt;fontData != NULL) {
              bBuffer = (*env)-&gt;NewDirectByteBuffer(env,
                                                scalerInfo-&gt;fontData,
<span class="line-new-header">--- 333,18 ---</span>
      error = FT_Init_FreeType(&amp;scalerInfo-&gt;library);
      if (error) {
          free(scalerInfo);
          return 0;
      }
<span class="line-added">+     setInterpreterVersion(scalerInfo-&gt;library);</span>
  
  #define TYPE1_FROM_JAVA        2
  
      error = 1; /* triggers memory freeing unless we clear it */
      if (type == TYPE1_FROM_JAVA) { /* TYPE1 */
          scalerInfo-&gt;fontData = (unsigned char*) malloc(filesize);
          scalerInfo-&gt;directBuffer = NULL;
          scalerInfo-&gt;fontDataLength = filesize;
  
          if (scalerInfo-&gt;fontData != NULL) {
              bBuffer = (*env)-&gt;NewDirectByteBuffer(env,
                                                scalerInfo-&gt;fontData,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 379,21 ***</span>
          context-&gt;useSbits = 1;
      }
      return ptr_to_jlong(context);
  }
  
  static int setupFTContext(JNIEnv *env,
                            jobject font2D,
                            FTScalerInfo *scalerInfo,
                            FTScalerContext *context) {
      int errCode = 0;
  
      scalerInfo-&gt;env = env;
      scalerInfo-&gt;font2D = font2D;
  
      if (context != NULL) {
<span class="line-modified">!         FT_Set_Transform(scalerInfo-&gt;face, &amp;context-&gt;transform, NULL);</span>
  
          errCode = FT_Set_Char_Size(scalerInfo-&gt;face, 0, context-&gt;ptsz, 72, 72);
  
          if (errCode == 0) {
              errCode = FT_Activate_Size(scalerInfo-&gt;face-&gt;size);
<span class="line-new-header">--- 470,45 ---</span>
          context-&gt;useSbits = 1;
      }
      return ptr_to_jlong(context);
  }
  
<span class="line-added">+ // values used by FreeType (as of version 2.10.1) for italics transformation matrix in FT_GlyphSlot_Oblique</span>
<span class="line-added">+ #define FT_MATRIX_ONE 0x10000</span>
<span class="line-added">+ #define FT_MATRIX_OBLIQUE_XY 0x0366A</span>
<span class="line-added">+ </span>
<span class="line-added">+ static void setupTransform(FT_Matrix* target, FTScalerContext *context) {</span>
<span class="line-added">+     FT_Matrix* transform = &amp;context-&gt;transform;</span>
<span class="line-added">+     if (context-&gt;doItalize) {</span>
<span class="line-added">+         // we cannot use FT_GlyphSlot_Oblique as it doesn&#39;t work well with arbitrary transforms,</span>
<span class="line-added">+         // so we add corresponding shear transform to the requested glyph transformation</span>
<span class="line-added">+         target-&gt;xx = FT_MATRIX_ONE;</span>
<span class="line-added">+         target-&gt;xy = FT_MATRIX_OBLIQUE_XY;</span>
<span class="line-added">+         target-&gt;yx = 0;</span>
<span class="line-added">+         target-&gt;yy = FT_MATRIX_ONE;</span>
<span class="line-added">+         FT_Matrix_Multiply(transform, target);</span>
<span class="line-added">+     } else {</span>
<span class="line-added">+         target-&gt;xx = transform-&gt;xx;</span>
<span class="line-added">+         target-&gt;xy = transform-&gt;xy;</span>
<span class="line-added">+         target-&gt;yx = transform-&gt;yx;</span>
<span class="line-added">+         target-&gt;yy = transform-&gt;yy;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  static int setupFTContext(JNIEnv *env,
                            jobject font2D,
                            FTScalerInfo *scalerInfo,
                            FTScalerContext *context) {
<span class="line-added">+     FT_Matrix matrix;</span>
      int errCode = 0;
  
      scalerInfo-&gt;env = env;
      scalerInfo-&gt;font2D = font2D;
  
      if (context != NULL) {
<span class="line-modified">!         setupTransform(&amp;matrix, context);</span>
<span class="line-added">+         FT_Set_Transform(scalerInfo-&gt;face, &amp;matrix, NULL);</span>
  
          errCode = FT_Set_Char_Size(scalerInfo-&gt;face, 0, context-&gt;ptsz, 72, 72);
  
          if (errCode == 0) {
              errCode = FT_Activate_Size(scalerInfo-&gt;face-&gt;size);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 403,14 ***</span>
      }
  
      return errCode;
  }
  
<span class="line-modified">! /* ftsynth.c uses (0x10000, 0x06000, 0x0, 0x10000) matrix to get oblique</span>
<span class="line-modified">!    outline.  Therefore x coordinate will change by 0x06000*y.</span>
<span class="line-modified">!    Note that y coordinate does not change. */</span>
<span class="line-modified">! #define OBLIQUE_MODIFIER(y)  (context-&gt;doItalize ? ((y)*6/16) : 0)</span>
  
  /*
   * Class:     sun_font_FreetypeFontScaler
   * Method:    getFontMetricsNative
   * Signature: (Lsun/font/Font2D;J)Lsun/font/StrikeMetrics;
<span class="line-new-header">--- 518,19 ---</span>
      }
  
      return errCode;
  }
  
<span class="line-modified">! // using same values as for the transformation matrix</span>
<span class="line-modified">! #define OBLIQUE_MODIFIER(y)  (context-&gt;doItalize ? ((y)*FT_MATRIX_OBLIQUE_XY/FT_MATRIX_ONE) : 0)</span>
<span class="line-modified">! </span>
<span class="line-modified">! /* FT_GlyphSlot_Embolden (ftsynth.c) uses FT_MulFix(units_per_EM, y_scale) / 24</span>
<span class="line-added">+  * strength value when glyph format is FT_GLYPH_FORMAT_OUTLINE. This value has</span>
<span class="line-added">+  * been taken from libfreetype version 2.6 and remain valid at least up to</span>
<span class="line-added">+  * 2.9.1. */</span>
<span class="line-added">+ #define BOLD_MODIFIER(units_per_EM, y_scale) \</span>
<span class="line-added">+     (context-&gt;doBold ? FT_MulFix(units_per_EM, y_scale) / 24 : 0)</span>
  
  /*
   * Class:     sun_font_FreetypeFontScaler
   * Method:    getFontMetricsNative
   * Signature: (Lsun/font/Font2D;J)Lsun/font/StrikeMetrics;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 493,11 ***</span>
                        (jlong) scalerInfo-&gt;face-&gt;size-&gt;metrics.y_scale))
                    + ay - dy;
      /* max advance */
      mx = (jfloat) FT26Dot6ToFloat(
                       scalerInfo-&gt;face-&gt;size-&gt;metrics.max_advance +
<span class="line-modified">!                      OBLIQUE_MODIFIER(scalerInfo-&gt;face-&gt;size-&gt;metrics.height));</span>
      my = 0;
  
      metrics = (*env)-&gt;NewObject(env,
          sunFontIDs.strikeMetricsClass,
          sunFontIDs.strikeMetricsCtr,
<span class="line-new-header">--- 613,13 ---</span>
                        (jlong) scalerInfo-&gt;face-&gt;size-&gt;metrics.y_scale))
                    + ay - dy;
      /* max advance */
      mx = (jfloat) FT26Dot6ToFloat(
                       scalerInfo-&gt;face-&gt;size-&gt;metrics.max_advance +
<span class="line-modified">!                      OBLIQUE_MODIFIER(scalerInfo-&gt;face-&gt;size-&gt;metrics.height) +</span>
<span class="line-added">+                      BOLD_MODIFIER(scalerInfo-&gt;face-&gt;units_per_EM,</span>
<span class="line-added">+                              scalerInfo-&gt;face-&gt;size-&gt;metrics.y_scale));</span>
      my = 0;
  
      metrics = (*env)-&gt;NewObject(env,
          sunFontIDs.strikeMetricsClass,
          sunFontIDs.strikeMetricsCtr,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 508,10 ***</span>
<span class="line-new-header">--- 630,16 ---</span>
          contextAwareMetricsX(mx, my), contextAwareMetricsY(mx, my));
  
      return metrics;
  }
  
<span class="line-added">+ static jlong</span>
<span class="line-added">+     getGlyphImageNativeInternal(</span>
<span class="line-added">+         JNIEnv *env, jobject scaler, jobject font2D,</span>
<span class="line-added">+         jlong pScalerContext, jlong pScaler, jint glyphCode,</span>
<span class="line-added">+         jboolean renderImage);</span>
<span class="line-added">+ </span>
  /*
   * Class:     sun_font_FreetypeFontScaler
   * Method:    getGlyphAdvanceNative
   * Signature: (Lsun/font/Font2D;JI)F
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 519,33 ***</span>
  Java_sun_font_FreetypeFontScaler_getGlyphAdvanceNative(
          JNIEnv *env, jobject scaler, jobject font2D,
          jlong pScalerContext, jlong pScaler, jint glyphCode) {
  
     /* This method is rarely used because requests for metrics are usually
<span class="line-modified">!       coupled with request for bitmap and to large extend work can be reused</span>
<span class="line-modified">!       (to find out metrics we need to hint glyph).</span>
<span class="line-modified">!       So, we typically go through getGlyphImage code path.</span>
<span class="line-modified">! </span>
<span class="line-modified">!       For initial freetype implementation we delegate</span>
<span class="line-modified">!       all work to getGlyphImage but drop result image.</span>
<span class="line-modified">!       This is waste of work related to scan conversion and conversion from</span>
<span class="line-modified">!       freetype format to our format but for now this seems to be ok.</span>
<span class="line-modified">! </span>
<span class="line-modified">!       NB: investigate performance benefits of refactoring code</span>
<span class="line-removed">-       to avoid unnecesary work with bitmaps. */</span>
  
      GlyphInfo *info;
<span class="line-modified">!     jfloat advance;</span>
      jlong image;
  
<span class="line-modified">!     image = Java_sun_font_FreetypeFontScaler_getGlyphImageNative(</span>
<span class="line-modified">!                  env, scaler, font2D, pScalerContext, pScaler, glyphCode);</span>
      info = (GlyphInfo*) jlong_to_ptr(image);
  
<span class="line-modified">!     advance = info-&gt;advanceX;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     free(info);</span>
  
      return advance;
  }
  
  /*
<span class="line-new-header">--- 647,33 ---</span>
  Java_sun_font_FreetypeFontScaler_getGlyphAdvanceNative(
          JNIEnv *env, jobject scaler, jobject font2D,
          jlong pScalerContext, jlong pScaler, jint glyphCode) {
  
     /* This method is rarely used because requests for metrics are usually
<span class="line-modified">!     * coupled with a request for the bitmap and to a large extent the</span>
<span class="line-modified">!     * work can be reused (to find out metrics we may need to hint the glyph).</span>
<span class="line-modified">!     * So, we typically go through the getGlyphImage code path.</span>
<span class="line-modified">!     * When we do get here, we need to pass a parameter which indicates</span>
<span class="line-modified">!     * that we don&#39;t need freetype to render the bitmap, and consequently</span>
<span class="line-modified">!     * don&#39;t need to allocate our own storage either.</span>
<span class="line-modified">!     * This is also important when enter here requesting metrics for sizes</span>
<span class="line-modified">!     * of text which a large size would be rejected for a bitmap but we</span>
<span class="line-modified">!     * still need the metrics.</span>
<span class="line-modified">!     */</span>
  
      GlyphInfo *info;
<span class="line-modified">!     jfloat advance = 0.0f;</span>
      jlong image;
  
<span class="line-modified">!     image = getGlyphImageNativeInternal(</span>
<span class="line-modified">!           env, scaler, font2D, pScalerContext, pScaler, glyphCode, JNI_FALSE);</span>
      info = (GlyphInfo*) jlong_to_ptr(image);
  
<span class="line-modified">!     if (info != NULL) {</span>
<span class="line-modified">!         advance = info-&gt;advanceX;</span>
<span class="line-modified">!         free(info);</span>
<span class="line-added">+     }</span>
  
      return advance;
  }
  
  /*
</pre>
<hr />
<pre>
<span class="line-old-header">*** 556,27 ***</span>
  JNIEXPORT void JNICALL
  Java_sun_font_FreetypeFontScaler_getGlyphMetricsNative(
          JNIEnv *env, jobject scaler, jobject font2D, jlong pScalerContext,
          jlong pScaler, jint glyphCode, jobject metrics) {
  
<span class="line-modified">!      /* As initial implementation we delegate all work to getGlyphImage</span>
<span class="line-removed">-         but drop result image. This is clearly waste of resorces.</span>
<span class="line-removed">- </span>
<span class="line-removed">-         TODO: investigate performance benefits of refactoring code</span>
<span class="line-removed">-               by avoiding bitmap generation and conversion from FT</span>
<span class="line-removed">-               bitmap format. */</span>
       GlyphInfo *info;
  
<span class="line-modified">!      jlong image = Java_sun_font_FreetypeFontScaler_getGlyphImageNative(</span>
                                   env, scaler, font2D,
<span class="line-modified">!                                  pScalerContext, pScaler, glyphCode);</span>
       info = (GlyphInfo*) jlong_to_ptr(image);
  
<span class="line-modified">!      (*env)-&gt;SetFloatField(env, metrics, sunFontIDs.xFID, info-&gt;advanceX);</span>
<span class="line-modified">!      (*env)-&gt;SetFloatField(env, metrics, sunFontIDs.yFID, info-&gt;advanceY);</span>
<span class="line-modified">! </span>
<span class="line-modified">!      free(info);</span>
  }
  
  
  static GlyphInfo* getNullGlyphImage() {
      GlyphInfo *glyphInfo =  (GlyphInfo*) calloc(1, sizeof(GlyphInfo));
<span class="line-new-header">--- 684,26 ---</span>
  JNIEXPORT void JNICALL
  Java_sun_font_FreetypeFontScaler_getGlyphMetricsNative(
          JNIEnv *env, jobject scaler, jobject font2D, jlong pScalerContext,
          jlong pScaler, jint glyphCode, jobject metrics) {
  
<span class="line-modified">!      /* See the comments in getGlyphMetricsNative. They apply here too. */</span>
       GlyphInfo *info;
  
<span class="line-modified">!      jlong image = getGlyphImageNativeInternal(</span>
                                   env, scaler, font2D,
<span class="line-modified">!                                  pScalerContext, pScaler, glyphCode, JNI_FALSE);</span>
       info = (GlyphInfo*) jlong_to_ptr(image);
  
<span class="line-modified">!      if (info != NULL) {</span>
<span class="line-modified">!          (*env)-&gt;SetFloatField(env, metrics, sunFontIDs.xFID, info-&gt;advanceX);</span>
<span class="line-modified">!          (*env)-&gt;SetFloatField(env, metrics, sunFontIDs.yFID, info-&gt;advanceY);</span>
<span class="line-modified">!          free(info);</span>
<span class="line-added">+      } else {</span>
<span class="line-added">+          (*env)-&gt;SetFloatField(env, metrics, sunFontIDs.xFID, 0.0f);</span>
<span class="line-added">+          (*env)-&gt;SetFloatField(env, metrics, sunFontIDs.yFID, 0.0f);</span>
<span class="line-added">+      }</span>
  }
  
  
  static GlyphInfo* getNullGlyphImage() {
      GlyphInfo *glyphInfo =  (GlyphInfo*) calloc(1, sizeof(GlyphInfo));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 679,20 ***</span>
<span class="line-new-header">--- 806,38 ---</span>
          height -= 3;
      }
  }
  
  
<span class="line-added">+ /* JDK does not use glyph images for fonts with a</span>
<span class="line-added">+  * pixel size &gt; 100 (see THRESHOLD in OutlineTextRenderer.java)</span>
<span class="line-added">+  * so if the glyph bitmap image dimension is &gt; 1024 pixels,</span>
<span class="line-added">+  * something is up.</span>
<span class="line-added">+  */</span>
<span class="line-added">+ #define MAX_GLYPH_DIM 1024</span>
<span class="line-added">+ </span>
  /*
   * Class:     sun_font_FreetypeFontScaler
   * Method:    getGlyphImageNative
   * Signature: (Lsun/font/Font2D;JI)J
   */
  JNIEXPORT jlong JNICALL
  Java_sun_font_FreetypeFontScaler_getGlyphImageNative(
          JNIEnv *env, jobject scaler, jobject font2D,
          jlong pScalerContext, jlong pScaler, jint glyphCode) {
  
<span class="line-added">+     return getGlyphImageNativeInternal(</span>
<span class="line-added">+         env, scaler, font2D,</span>
<span class="line-added">+         pScalerContext, pScaler, glyphCode, JNI_TRUE);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static jlong</span>
<span class="line-added">+      getGlyphImageNativeInternal(</span>
<span class="line-added">+         JNIEnv *env, jobject scaler, jobject font2D,</span>
<span class="line-added">+         jlong pScalerContext, jlong pScaler, jint glyphCode,</span>
<span class="line-added">+         jboolean renderImage) {</span>
<span class="line-added">+ </span>
      int error, imageSize;
      UInt16 width, height;
      GlyphInfo *glyphInfo;
      int renderFlags = FT_LOAD_DEFAULT, target;
      FT_GlyphSlot ftglyph;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 710,10 ***</span>
<span class="line-new-header">--- 855,21 ---</span>
      if (error) {
          invalidateJavaScaler(env, scaler, scalerInfo);
          return ptr_to_jlong(getNullGlyphImage());
      }
  
<span class="line-added">+     /*</span>
<span class="line-added">+      * When using Fractional metrics (linearly scaling advances) and</span>
<span class="line-added">+      * greyscale antialiasing, disable hinting so that the glyph shapes</span>
<span class="line-added">+      * are constant as size increases. This is good for animation as well</span>
<span class="line-added">+      * as being compatible with what happened in earlier JDK versions</span>
<span class="line-added">+      * which did not use freetype.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     if (context-&gt;aaType == TEXT_AA_ON &amp;&amp; context-&gt;fmType == TEXT_FM_ON) {</span>
<span class="line-added">+          renderFlags |= FT_LOAD_NO_HINTING;</span>
<span class="line-added">+      }</span>
<span class="line-added">+ </span>
      if (!context-&gt;useSbits) {
          renderFlags |= FT_LOAD_NO_BITMAP;
      }
  
      /* NB: in case of non identity transform
</pre>
<hr />
<pre>
<span class="line-old-header">*** 745,25 ***</span>
  
      /* apply styles */
      if (context-&gt;doBold) { /* if bold style */
          FT_GlyphSlot_Embolden(ftglyph);
      }
<span class="line-removed">-     if (context-&gt;doItalize) { /* if oblique */</span>
<span class="line-removed">-         FT_GlyphSlot_Oblique(ftglyph);</span>
<span class="line-removed">-     }</span>
  
      /* generate bitmap if it is not done yet
       e.g. if algorithmic styling is performed and style was added to outline */
<span class="line-modified">!     if (ftglyph-&gt;format == FT_GLYPH_FORMAT_OUTLINE) {</span>
          error = FT_Render_Glyph(ftglyph, FT_LOAD_TARGET_MODE(target));
          if (error != 0) {
              return ptr_to_jlong(getNullGlyphImage());
          }
      }
  
<span class="line-modified">!     width  = (UInt16) ftglyph-&gt;bitmap.width;</span>
<span class="line-modified">!     height = (UInt16) ftglyph-&gt;bitmap.rows;</span>
  
      imageSize = width*height;
      glyphInfo = (GlyphInfo*) malloc(sizeof(GlyphInfo) + imageSize);
      if (glyphInfo == NULL) {
          glyphInfo = getNullGlyphImage();
<span class="line-new-header">--- 901,40 ---</span>
  
      /* apply styles */
      if (context-&gt;doBold) { /* if bold style */
          FT_GlyphSlot_Embolden(ftglyph);
      }
  
      /* generate bitmap if it is not done yet
       e.g. if algorithmic styling is performed and style was added to outline */
<span class="line-modified">!     if (renderImage &amp;&amp; (ftglyph-&gt;format == FT_GLYPH_FORMAT_OUTLINE)) {</span>
<span class="line-added">+         FT_BBox bbox;</span>
<span class="line-added">+         FT_Outline_Get_CBox(&amp;(ftglyph-&gt;outline), &amp;bbox);</span>
<span class="line-added">+         int w = (int)((bbox.xMax&gt;&gt;6)-(bbox.xMin&gt;&gt;6));</span>
<span class="line-added">+         int h = (int)((bbox.yMax&gt;&gt;6)-(bbox.yMin&gt;&gt;6));</span>
<span class="line-added">+         if (w &gt; MAX_GLYPH_DIM || h &gt; MAX_GLYPH_DIM) {</span>
<span class="line-added">+             glyphInfo = getNullGlyphImage();</span>
<span class="line-added">+             return ptr_to_jlong(glyphInfo);</span>
<span class="line-added">+         }</span>
          error = FT_Render_Glyph(ftglyph, FT_LOAD_TARGET_MODE(target));
          if (error != 0) {
              return ptr_to_jlong(getNullGlyphImage());
          }
      }
  
<span class="line-modified">!     if (renderImage) {</span>
<span class="line-modified">!         width  = (UInt16) ftglyph-&gt;bitmap.width;</span>
<span class="line-added">+         height = (UInt16) ftglyph-&gt;bitmap.rows;</span>
<span class="line-added">+             if (width &gt; MAX_GLYPH_DIM || height &gt; MAX_GLYPH_DIM) {</span>
<span class="line-added">+               glyphInfo = getNullGlyphImage();</span>
<span class="line-added">+               return ptr_to_jlong(glyphInfo);</span>
<span class="line-added">+             }</span>
<span class="line-added">+      } else {</span>
<span class="line-added">+         width = 0;</span>
<span class="line-added">+         height = 0;</span>
<span class="line-added">+      }</span>
<span class="line-added">+ </span>
  
      imageSize = width*height;
      glyphInfo = (GlyphInfo*) malloc(sizeof(GlyphInfo) + imageSize);
      if (glyphInfo == NULL) {
          glyphInfo = getNullGlyphImage();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 772,25 ***</span>
      glyphInfo-&gt;cellInfo  = NULL;
      glyphInfo-&gt;managed   = UNMANAGED_GLYPH;
      glyphInfo-&gt;rowBytes  = width;
      glyphInfo-&gt;width     = width;
      glyphInfo-&gt;height    = height;
<span class="line-removed">-     glyphInfo-&gt;topLeftX  = (float)  ftglyph-&gt;bitmap_left;</span>
<span class="line-removed">-     glyphInfo-&gt;topLeftY  = (float) -ftglyph-&gt;bitmap_top;</span>
  
<span class="line-modified">!     if (ftglyph-&gt;bitmap.pixel_mode ==  FT_PIXEL_MODE_LCD) {</span>
<span class="line-modified">!         glyphInfo-&gt;width = width/3;</span>
<span class="line-modified">!     } else if (ftglyph-&gt;bitmap.pixel_mode ==  FT_PIXEL_MODE_LCD_V) {</span>
<span class="line-modified">!         glyphInfo-&gt;height = glyphInfo-&gt;height/3;</span>
      }
  
      if (context-&gt;fmType == TEXT_FM_ON) {
<span class="line-modified">!         double advh = FTFixedToFloat(ftglyph-&gt;linearHoriAdvance);</span>
          glyphInfo-&gt;advanceX =
              (float) (advh * FTFixedToFloat(context-&gt;transform.xx));
          glyphInfo-&gt;advanceY =
<span class="line-modified">!             (float) (advh * FTFixedToFloat(context-&gt;transform.xy));</span>
      } else {
          if (!ftglyph-&gt;advance.y) {
              glyphInfo-&gt;advanceX =
                  (float) FT26Dot6ToInt(ftglyph-&gt;advance.x);
              glyphInfo-&gt;advanceY = 0;
<span class="line-new-header">--- 943,28 ---</span>
      glyphInfo-&gt;cellInfo  = NULL;
      glyphInfo-&gt;managed   = UNMANAGED_GLYPH;
      glyphInfo-&gt;rowBytes  = width;
      glyphInfo-&gt;width     = width;
      glyphInfo-&gt;height    = height;
  
<span class="line-modified">!     if (renderImage) {</span>
<span class="line-modified">!         glyphInfo-&gt;topLeftX  = (float)  ftglyph-&gt;bitmap_left;</span>
<span class="line-modified">!         glyphInfo-&gt;topLeftY  = (float) -ftglyph-&gt;bitmap_top;</span>
<span class="line-modified">! </span>
<span class="line-added">+         if (ftglyph-&gt;bitmap.pixel_mode ==  FT_PIXEL_MODE_LCD) {</span>
<span class="line-added">+             glyphInfo-&gt;width = width/3;</span>
<span class="line-added">+         } else if (ftglyph-&gt;bitmap.pixel_mode ==  FT_PIXEL_MODE_LCD_V) {</span>
<span class="line-added">+             glyphInfo-&gt;height = glyphInfo-&gt;height/3;</span>
<span class="line-added">+         }</span>
      }
  
      if (context-&gt;fmType == TEXT_FM_ON) {
<span class="line-modified">!         float advh = FTFixedToFloat(ftglyph-&gt;linearHoriAdvance);</span>
          glyphInfo-&gt;advanceX =
              (float) (advh * FTFixedToFloat(context-&gt;transform.xx));
          glyphInfo-&gt;advanceY =
<span class="line-modified">!             (float) - (advh * FTFixedToFloat(context-&gt;transform.yx));</span>
      } else {
          if (!ftglyph-&gt;advance.y) {
              glyphInfo-&gt;advanceX =
                  (float) FT26Dot6ToInt(ftglyph-&gt;advance.x);
              glyphInfo-&gt;advanceY = 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 854,36 ***</span>
      }
  
      return ptr_to_jlong(glyphInfo);
  }
  
<span class="line-removed">- </span>
<span class="line-removed">- /*</span>
<span class="line-removed">-  * Class:     sun_font_FreetypeFontScaler</span>
<span class="line-removed">-  * Method:    getLayoutTableCacheNative</span>
<span class="line-removed">-  * Signature: (J)J</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- JNIEXPORT jlong JNICALL</span>
<span class="line-removed">- Java_sun_font_FreetypeFontScaler_getLayoutTableCacheNative(</span>
<span class="line-removed">-         JNIEnv *env, jobject scaler, jlong pScaler) {</span>
<span class="line-removed">-     FTScalerInfo *scalerInfo = (FTScalerInfo*) jlong_to_ptr(pScaler);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (scalerInfo == NULL) {</span>
<span class="line-removed">-         invalidateJavaScaler(env, scaler, scalerInfo);</span>
<span class="line-removed">-         return 0L;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // init layout table cache in font</span>
<span class="line-removed">-     // we&#39;re assuming the font is a file font and moreover it is Truetype font</span>
<span class="line-removed">-     // otherwise we shouldn&#39;t be able to get here...</span>
<span class="line-removed">-     if (scalerInfo-&gt;layoutTables == NULL) {</span>
<span class="line-removed">-         scalerInfo-&gt;layoutTables = newLayoutTableCache();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return ptr_to_jlong(scalerInfo-&gt;layoutTables);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  /*
   * Class:     sun_font_FreetypeFontScaler
   * Method:    disposeNativeScaler
   * Signature: (J)V
   */
<span class="line-new-header">--- 1028,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 997,13 ***</span>
  
      /* apply styles */
      if (context-&gt;doBold) { /* if bold style */
          FT_GlyphSlot_Embolden(ftglyph);
      }
<span class="line-removed">-     if (context-&gt;doItalize) { /* if oblique */</span>
<span class="line-removed">-         FT_GlyphSlot_Oblique(ftglyph);</span>
<span class="line-removed">-     }</span>
  
      FT_Outline_Translate(&amp;ftglyph-&gt;outline,
                           FloatToF26Dot6(xpos),
                           -FloatToF26Dot6(ypos));
  
<span class="line-new-header">--- 1145,10 ---</span>
</pre>
<center><a href="HBShaper.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="harfbuzz/hb-blob.cc.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>