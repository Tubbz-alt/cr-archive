<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ucdn.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-subset.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ucdn/ucdn.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ucdn.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2012 Grigori Goronzy &lt;greg@kinoho.net&gt;
  3  *
  4  * Permission to use, copy, modify, and/or distribute this software for any
  5  * purpose with or without fee is hereby granted, provided that the above
  6  * copyright notice and this permission notice appear in all copies.
  7  *
  8  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES
  9  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 10  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 11  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 12  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 13  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 14  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 15  */
 16 
<span class="line-modified"> 17 #include &quot;hb-private.hh&quot;</span>
 18 
<span class="line-modified"> 19 #include &quot;hb-unicode-private.hh&quot;</span>
 20 
 21 #include &quot;ucdn.h&quot;
 22 
 23 static const hb_script_t ucdn_script_translate[] =
 24 {
 25     HB_SCRIPT_COMMON,
 26     HB_SCRIPT_LATIN,
 27     HB_SCRIPT_GREEK,
 28     HB_SCRIPT_CYRILLIC,
 29     HB_SCRIPT_ARMENIAN,
 30     HB_SCRIPT_HEBREW,
 31     HB_SCRIPT_ARABIC,
 32     HB_SCRIPT_SYRIAC,
 33     HB_SCRIPT_THAANA,
 34     HB_SCRIPT_DEVANAGARI,
 35     HB_SCRIPT_BENGALI,
 36     HB_SCRIPT_GURMUKHI,
 37     HB_SCRIPT_GUJARATI,
 38     HB_SCRIPT_ORIYA,
 39     HB_SCRIPT_TAMIL,
</pre>
<hr />
<pre>
164     HB_SCRIPT_NUSHU,
165     HB_SCRIPT_SOYOMBO,
166     HB_SCRIPT_ZANABAZAR_SQUARE,
167     HB_SCRIPT_DOGRA,
168     HB_SCRIPT_GUNJALA_GONDI,
169     HB_SCRIPT_HANIFI_ROHINGYA,
170     HB_SCRIPT_MAKASAR,
171     HB_SCRIPT_MEDEFAIDRIN,
172     HB_SCRIPT_OLD_SOGDIAN,
173     HB_SCRIPT_SOGDIAN,
174 };
175 
176 static hb_unicode_combining_class_t
177 hb_ucdn_combining_class(hb_unicode_funcs_t *ufuncs HB_UNUSED,
178                         hb_codepoint_t unicode,
179                         void *user_data HB_UNUSED)
180 {
181     return (hb_unicode_combining_class_t) ucdn_get_combining_class(unicode);
182 }
183 
<span class="line-removed">184 static unsigned int</span>
<span class="line-removed">185 hb_ucdn_eastasian_width(hb_unicode_funcs_t *ufuncs HB_UNUSED,</span>
<span class="line-removed">186                         hb_codepoint_t unicode,</span>
<span class="line-removed">187                         void *user_data HB_UNUSED)</span>
<span class="line-removed">188 {</span>
<span class="line-removed">189     int w = ucdn_get_east_asian_width(unicode);</span>
<span class="line-removed">190     return (w == UCDN_EAST_ASIAN_F || w == UCDN_EAST_ASIAN_W) ? 2 : 1;</span>
<span class="line-removed">191 }</span>
<span class="line-removed">192 </span>
193 static hb_unicode_general_category_t
194 hb_ucdn_general_category(hb_unicode_funcs_t *ufuncs HB_UNUSED,
195                          hb_codepoint_t unicode,
196                          void *user_data HB_UNUSED)
197 {
198     return (hb_unicode_general_category_t)ucdn_get_general_category(unicode);
199 }
200 
201 static hb_codepoint_t
202 hb_ucdn_mirroring(hb_unicode_funcs_t *ufuncs HB_UNUSED,
203                   hb_codepoint_t unicode,
204                   void *user_data HB_UNUSED)
205 {
206     return ucdn_mirror(unicode);
207 }
208 
209 static hb_script_t
210 hb_ucdn_script(hb_unicode_funcs_t *ufuncs HB_UNUSED,
211                hb_codepoint_t unicode,
212                void *user_data HB_UNUSED)
213 {
214     return ucdn_script_translate[ucdn_get_script(unicode)];
215 }
216 
217 static hb_bool_t
218 hb_ucdn_compose(hb_unicode_funcs_t *ufuncs HB_UNUSED,
219                 hb_codepoint_t a, hb_codepoint_t b, hb_codepoint_t *ab,
220                 void *user_data HB_UNUSED)
221 {
222     return ucdn_compose(ab, a, b);
223 }
224 
225 static hb_bool_t
226 hb_ucdn_decompose(hb_unicode_funcs_t *ufuncs HB_UNUSED,
227                   hb_codepoint_t ab, hb_codepoint_t *a, hb_codepoint_t *b,
228                   void *user_data HB_UNUSED)
229 {
230     return ucdn_decompose(ab, a, b);
231 }
232 
<span class="line-removed">233 static unsigned int</span>
<span class="line-removed">234 hb_ucdn_decompose_compatibility(hb_unicode_funcs_t *ufuncs HB_UNUSED,</span>
<span class="line-removed">235                                 hb_codepoint_t u, hb_codepoint_t *decomposed,</span>
<span class="line-removed">236                                 void *user_data HB_UNUSED)</span>
<span class="line-removed">237 {</span>
<span class="line-removed">238     return ucdn_compat_decompose(u, decomposed);</span>
<span class="line-removed">239 }</span>
240 
<span class="line-modified">241 static hb_unicode_funcs_t *static_ucdn_funcs = nullptr;</span>
<span class="line-modified">242 </span>
<span class="line-removed">243 #ifdef HB_USE_ATEXIT</span>
<span class="line-removed">244 static</span>
<span class="line-removed">245 void free_static_ucdn_funcs (void)</span>
<span class="line-removed">246 {</span>
<span class="line-removed">247 retry:</span>
<span class="line-removed">248   hb_unicode_funcs_t *ucdn_funcs = (hb_unicode_funcs_t *) hb_atomic_ptr_get (&amp;static_ucdn_funcs);</span>
<span class="line-removed">249   if (!hb_atomic_ptr_cmpexch (&amp;static_ucdn_funcs, ucdn_funcs, nullptr))</span>
<span class="line-removed">250     goto retry;</span>
<span class="line-removed">251 </span>
<span class="line-removed">252   hb_unicode_funcs_destroy (ucdn_funcs);</span>
<span class="line-removed">253 }</span>
254 #endif
255 
<span class="line-modified">256 extern &quot;C&quot; HB_INTERNAL</span>
<span class="line-removed">257 hb_unicode_funcs_t *</span>
<span class="line-removed">258 hb_ucdn_get_unicode_funcs (void)</span>
259 {
<span class="line-modified">260 retry:</span>
<span class="line-removed">261   hb_unicode_funcs_t *funcs = (hb_unicode_funcs_t *) hb_atomic_ptr_get (&amp;static_ucdn_funcs);</span>
<span class="line-removed">262 </span>
<span class="line-removed">263   if (unlikely (!funcs))</span>
264   {
<span class="line-modified">265     funcs = hb_unicode_funcs_create (nullptr);</span>
266 
<span class="line-modified">267 #define HB_UNICODE_FUNC_IMPLEMENT(name) \</span>
<span class="line-modified">268     hb_unicode_funcs_set_##name##_func (funcs, hb_ucdn_##name, nullptr, nullptr);</span>
<span class="line-modified">269       HB_UNICODE_FUNCS_IMPLEMENT_CALLBACKS</span>
<span class="line-modified">270 #undef HB_UNICODE_FUNC_IMPLEMENT</span>


271 
272     hb_unicode_funcs_make_immutable (funcs);
273 
<span class="line-modified">274     if (!hb_atomic_ptr_cmpexch (&amp;static_ucdn_funcs, nullptr, funcs)) {</span>
<span class="line-modified">275       hb_unicode_funcs_destroy (funcs);</span>
<span class="line-modified">276       goto retry;</span>
<span class="line-modified">277     }</span>



278 
<span class="line-modified">279 #ifdef HB_USE_ATEXIT</span>
<span class="line-modified">280     atexit (free_static_ucdn_funcs); /* First person registers atexit() callback. */</span>




281 #endif
<span class="line-removed">282   };</span>
283 
<span class="line-modified">284   return hb_unicode_funcs_reference (funcs);</span>







285 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
  2  * Copyright (C) 2012 Grigori Goronzy &lt;greg@kinoho.net&gt;
  3  *
  4  * Permission to use, copy, modify, and/or distribute this software for any
  5  * purpose with or without fee is hereby granted, provided that the above
  6  * copyright notice and this permission notice appear in all copies.
  7  *
  8  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES
  9  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 10  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 11  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 12  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 13  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 14  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 15  */
 16 
<span class="line-modified"> 17 #include &quot;hb.hh&quot;</span>
 18 
<span class="line-modified"> 19 #include &quot;hb-machinery.hh&quot;</span>
 20 
 21 #include &quot;ucdn.h&quot;
 22 
 23 static const hb_script_t ucdn_script_translate[] =
 24 {
 25     HB_SCRIPT_COMMON,
 26     HB_SCRIPT_LATIN,
 27     HB_SCRIPT_GREEK,
 28     HB_SCRIPT_CYRILLIC,
 29     HB_SCRIPT_ARMENIAN,
 30     HB_SCRIPT_HEBREW,
 31     HB_SCRIPT_ARABIC,
 32     HB_SCRIPT_SYRIAC,
 33     HB_SCRIPT_THAANA,
 34     HB_SCRIPT_DEVANAGARI,
 35     HB_SCRIPT_BENGALI,
 36     HB_SCRIPT_GURMUKHI,
 37     HB_SCRIPT_GUJARATI,
 38     HB_SCRIPT_ORIYA,
 39     HB_SCRIPT_TAMIL,
</pre>
<hr />
<pre>
164     HB_SCRIPT_NUSHU,
165     HB_SCRIPT_SOYOMBO,
166     HB_SCRIPT_ZANABAZAR_SQUARE,
167     HB_SCRIPT_DOGRA,
168     HB_SCRIPT_GUNJALA_GONDI,
169     HB_SCRIPT_HANIFI_ROHINGYA,
170     HB_SCRIPT_MAKASAR,
171     HB_SCRIPT_MEDEFAIDRIN,
172     HB_SCRIPT_OLD_SOGDIAN,
173     HB_SCRIPT_SOGDIAN,
174 };
175 
176 static hb_unicode_combining_class_t
177 hb_ucdn_combining_class(hb_unicode_funcs_t *ufuncs HB_UNUSED,
178                         hb_codepoint_t unicode,
179                         void *user_data HB_UNUSED)
180 {
181     return (hb_unicode_combining_class_t) ucdn_get_combining_class(unicode);
182 }
183 









184 static hb_unicode_general_category_t
185 hb_ucdn_general_category(hb_unicode_funcs_t *ufuncs HB_UNUSED,
186                          hb_codepoint_t unicode,
187                          void *user_data HB_UNUSED)
188 {
189     return (hb_unicode_general_category_t)ucdn_get_general_category(unicode);
190 }
191 
192 static hb_codepoint_t
193 hb_ucdn_mirroring(hb_unicode_funcs_t *ufuncs HB_UNUSED,
194                   hb_codepoint_t unicode,
195                   void *user_data HB_UNUSED)
196 {
197     return ucdn_mirror(unicode);
198 }
199 
200 static hb_script_t
201 hb_ucdn_script(hb_unicode_funcs_t *ufuncs HB_UNUSED,
202                hb_codepoint_t unicode,
203                void *user_data HB_UNUSED)
204 {
205     return ucdn_script_translate[ucdn_get_script(unicode)];
206 }
207 
208 static hb_bool_t
209 hb_ucdn_compose(hb_unicode_funcs_t *ufuncs HB_UNUSED,
210                 hb_codepoint_t a, hb_codepoint_t b, hb_codepoint_t *ab,
211                 void *user_data HB_UNUSED)
212 {
213     return ucdn_compose(ab, a, b);
214 }
215 
216 static hb_bool_t
217 hb_ucdn_decompose(hb_unicode_funcs_t *ufuncs HB_UNUSED,
218                   hb_codepoint_t ab, hb_codepoint_t *a, hb_codepoint_t *b,
219                   void *user_data HB_UNUSED)
220 {
221     return ucdn_decompose(ab, a, b);
222 }
223 







224 
<span class="line-modified">225 #if HB_USE_ATEXIT</span>
<span class="line-modified">226 static void free_static_ucdn_funcs ();</span>











227 #endif
228 
<span class="line-modified">229 static struct hb_ucdn_unicode_funcs_lazy_loader_t : hb_unicode_funcs_lazy_loader_t&lt;hb_ucdn_unicode_funcs_lazy_loader_t&gt;</span>


230 {
<span class="line-modified">231   static hb_unicode_funcs_t *create ()</span>



232   {
<span class="line-modified">233     hb_unicode_funcs_t *funcs = hb_unicode_funcs_create (nullptr);</span>
234 
<span class="line-modified">235     hb_unicode_funcs_set_combining_class_func (funcs, hb_ucdn_combining_class, nullptr, nullptr);</span>
<span class="line-modified">236     hb_unicode_funcs_set_general_category_func (funcs, hb_ucdn_general_category, nullptr, nullptr);</span>
<span class="line-modified">237     hb_unicode_funcs_set_mirroring_func (funcs, hb_ucdn_mirroring, nullptr, nullptr);</span>
<span class="line-modified">238     hb_unicode_funcs_set_script_func (funcs, hb_ucdn_script, nullptr, nullptr);</span>
<span class="line-added">239     hb_unicode_funcs_set_compose_func (funcs, hb_ucdn_compose, nullptr, nullptr);</span>
<span class="line-added">240     hb_unicode_funcs_set_decompose_func (funcs, hb_ucdn_decompose, nullptr, nullptr);</span>
241 
242     hb_unicode_funcs_make_immutable (funcs);
243 
<span class="line-modified">244 #if HB_USE_ATEXIT</span>
<span class="line-modified">245     atexit (free_static_ucdn_funcs);</span>
<span class="line-modified">246 #endif</span>
<span class="line-modified">247 </span>
<span class="line-added">248     return funcs;</span>
<span class="line-added">249   }</span>
<span class="line-added">250 } static_ucdn_funcs;</span>
251 
<span class="line-modified">252 #if HB_USE_ATEXIT</span>
<span class="line-modified">253 static</span>
<span class="line-added">254 void free_static_ucdn_funcs ()</span>
<span class="line-added">255 {</span>
<span class="line-added">256   static_ucdn_funcs.free_instance ();</span>
<span class="line-added">257 }</span>
258 #endif

259 
<span class="line-modified">260 extern &quot;C&quot; HB_INTERNAL</span>
<span class="line-added">261 hb_unicode_funcs_t *</span>
<span class="line-added">262 hb_ucdn_get_unicode_funcs ();</span>
<span class="line-added">263 </span>
<span class="line-added">264 hb_unicode_funcs_t *</span>
<span class="line-added">265 hb_ucdn_get_unicode_funcs ()</span>
<span class="line-added">266 {</span>
<span class="line-added">267   return static_ucdn_funcs.get_unconst ();</span>
268 }
</pre>
</td>
</tr>
</table>
<center><a href="hb-subset.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ucdn/ucdn.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>