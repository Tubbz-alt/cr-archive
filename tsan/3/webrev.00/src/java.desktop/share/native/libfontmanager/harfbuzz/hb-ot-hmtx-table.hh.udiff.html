<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-hmtx-table.hh</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-hhea-table.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-kern-table.hh.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-hmtx-table.hh</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,15 +25,14 @@</span>
   */
  
  #ifndef HB_OT_HMTX_TABLE_HH
  #define HB_OT_HMTX_TABLE_HH
  
<span class="udiff-line-modified-removed">- #include &quot;hb-open-type-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-open-type.hh&quot;</span>
  #include &quot;hb-ot-hhea-table.hh&quot;
  #include &quot;hb-ot-os2-table.hh&quot;
  #include &quot;hb-ot-var-hvar-table.hh&quot;
<span class="udiff-line-removed">- #include &quot;hb-subset-plan.hh&quot;</span>
  
  /*
   * hmtx -- Horizontal Metrics
   * https://docs.microsoft.com/en-us/typography/opentype/spec/hmtx
   * vmtx -- Vertical Metrics
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -47,32 +46,32 @@</span>
  
  
  struct LongMetric
  {
    UFWORD        advance; /* Advance width/height. */
<span class="udiff-line-modified-removed">-   FWORD         lsb; /* Leading (left/top) side bearing. */</span>
<span class="udiff-line-modified-added">+   FWORD         sb; /* Leading (left/top) side bearing. */</span>
    public:
    DEFINE_SIZE_STATIC (4);
  };
  
  template &lt;typename T, typename H&gt;
  struct hmtxvmtx
  {
<span class="udiff-line-modified-removed">-   inline bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="udiff-line-modified-added">+   bool sanitize (hb_sanitize_context_t *c HB_UNUSED) const</span>
    {
      TRACE_SANITIZE (this);
      /* We don&#39;t check for anything specific here.  The users of the
       * struct do all the hard work... */
      return_trace (true);
    }
  
  
<span class="udiff-line-modified-removed">-   inline bool subset_update_header (hb_subset_plan_t *plan,</span>
<span class="udiff-line-modified-added">+   bool subset_update_header (hb_subset_plan_t *plan,</span>
                                      unsigned int num_hmetrics) const
    {
<span class="udiff-line-modified-removed">-     hb_blob_t *src_blob = OT::Sanitizer&lt;H&gt; ().sanitize (plan-&gt;source-&gt;reference_table (H::tableTag));</span>
<span class="udiff-line-modified-removed">-     hb_blob_t *dest_blob = hb_blob_copy_writable_or_fail(src_blob);</span>
<span class="udiff-line-modified-added">+     hb_blob_t *src_blob = hb_sanitize_context_t ().reference_table&lt;H&gt; (plan-&gt;source, H::tableTag);</span>
<span class="udiff-line-modified-added">+     hb_blob_t *dest_blob = hb_blob_copy_writable_or_fail (src_blob);</span>
      hb_blob_destroy (src_blob);
  
      if (unlikely (!dest_blob)) {
        return false;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -85,45 +84,45 @@</span>
      hb_blob_destroy (dest_blob);
  
      return result;
    }
  
<span class="udiff-line-modified-removed">-   inline bool subset (hb_subset_plan_t *plan) const</span>
<span class="udiff-line-modified-added">+   bool subset (hb_subset_plan_t *plan) const</span>
    {
      typename T::accelerator_t _mtx;
      _mtx.init (plan-&gt;source);
  
      /* All the trailing glyphs with the same advance can use one LongMetric
       * and just keep LSB */
      hb_vector_t&lt;hb_codepoint_t&gt; &amp;gids = plan-&gt;glyphs;
<span class="udiff-line-modified-removed">-     unsigned int num_advances = gids.len;</span>
<span class="udiff-line-modified-added">+     unsigned int num_advances = gids.length;</span>
      unsigned int last_advance = _mtx.get_advance (gids[num_advances - 1]);
<span class="udiff-line-modified-removed">-     while (num_advances &gt; 1</span>
<span class="udiff-line-modified-removed">-         &amp;&amp; last_advance == _mtx.get_advance (gids[num_advances - 2]))</span>
<span class="udiff-line-modified-added">+     while (num_advances &gt; 1 &amp;&amp;</span>
<span class="udiff-line-modified-added">+            last_advance == _mtx.get_advance (gids[num_advances - 2]))</span>
      {
        num_advances--;
      }
  
      /* alloc the new table */
      size_t dest_sz = num_advances * 4
<span class="udiff-line-modified-removed">-                   + (gids.len - num_advances) * 2;</span>
<span class="udiff-line-modified-added">+                   + (gids.length - num_advances) * 2;</span>
      void *dest = (void *) malloc (dest_sz);
      if (unlikely (!dest))
      {
        return false;
      }
      DEBUG_MSG(SUBSET, nullptr, &quot;%c%c%c%c in src has %d advances, %d lsbs&quot;, HB_UNTAG(T::tableTag), _mtx.num_advances, _mtx.num_metrics - _mtx.num_advances);
<span class="udiff-line-modified-removed">-     DEBUG_MSG(SUBSET, nullptr, &quot;%c%c%c%c in dest has %d advances, %d lsbs, %u bytes&quot;, HB_UNTAG(T::tableTag), num_advances, gids.len - num_advances, (unsigned int) dest_sz);</span>
<span class="udiff-line-modified-added">+     DEBUG_MSG(SUBSET, nullptr, &quot;%c%c%c%c in dest has %d advances, %d lsbs, %u bytes&quot;, HB_UNTAG(T::tableTag), num_advances, gids.length - num_advances, (unsigned int) dest_sz);</span>
  
<span class="udiff-line-modified-removed">-     const char *source_table = hb_blob_get_data (_mtx.blob, nullptr);</span>
<span class="udiff-line-modified-added">+     const char *source_table = hb_blob_get_data (_mtx.table.get_blob (), nullptr);</span>
      // Copy everything over
      LongMetric * old_metrics = (LongMetric *) source_table;
      FWORD *lsbs = (FWORD *) (old_metrics + _mtx.num_advances);
      char * dest_pos = (char *) dest;
  
      bool failed = false;
<span class="udiff-line-modified-removed">-     for (unsigned int i = 0; i &lt; gids.len; i++)</span>
<span class="udiff-line-modified-added">+     for (unsigned int i = 0; i &lt; gids.length; i++)</span>
      {
        /* the last metric or the one for gids[i] */
        LongMetric *src_metric = old_metrics + MIN ((hb_codepoint_t) _mtx.num_advances - 1, gids[i]);
        if (gids[i] &lt; _mtx.num_advances)
        {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -133,12 +132,12 @@</span>
            /* dest is a LongMetric, copy it */
            *((LongMetric *) dest_pos) = *src_metric;
          }
          else
          {
<span class="udiff-line-modified-removed">-           /* dest just lsb */</span>
<span class="udiff-line-modified-removed">-           *((FWORD *) dest_pos) = src_metric-&gt;lsb;</span>
<span class="udiff-line-modified-added">+           /* dest just sb */</span>
<span class="udiff-line-modified-added">+           *((FWORD *) dest_pos) = src_metric-&gt;sb;</span>
          }
        }
        else
        {
          if (gids[i] &gt;= _mtx.num_metrics)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -146,22 +145,22 @@</span>
            DEBUG_MSG(SUBSET, nullptr, &quot;gid %d is &gt;= number of source metrics %d&quot;,
                      gids[i], _mtx.num_metrics);
            failed = true;
            break;
          }
<span class="udiff-line-modified-removed">-         FWORD src_lsb = *(lsbs + gids[i] - _mtx.num_advances);</span>
<span class="udiff-line-modified-added">+         FWORD src_sb = *(lsbs + gids[i] - _mtx.num_advances);</span>
          if (i &lt; num_advances)
          {
            /* dest needs a full LongMetric */
            LongMetric *metric = (LongMetric *)dest_pos;
            metric-&gt;advance = src_metric-&gt;advance;
<span class="udiff-line-modified-removed">-           metric-&gt;lsb = src_lsb;</span>
<span class="udiff-line-modified-added">+           metric-&gt;sb = src_sb;</span>
          }
          else
          {
<span class="udiff-line-modified-removed">-           /* dest just needs an lsb */</span>
<span class="udiff-line-modified-removed">-           *((FWORD *) dest_pos) = src_lsb;</span>
<span class="udiff-line-modified-added">+           /* dest just needs an sb */</span>
<span class="udiff-line-modified-added">+           *((FWORD *) dest_pos) = src_sb;</span>
          }
        }
        dest_pos += (i &lt; num_advances ? 4 : 2);
      }
      _mtx.fini ();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -185,74 +184,78 @@</span>
  
    struct accelerator_t
    {
      friend struct hmtxvmtx;
  
<span class="udiff-line-modified-removed">-     inline void init (hb_face_t *face,</span>
<span class="udiff-line-modified-added">+     void init (hb_face_t *face,</span>
                        unsigned int default_advance_ = 0)
      {
        default_advance = default_advance_ ? default_advance_ : hb_face_get_upem (face);
  
        bool got_font_extents = false;
<span class="udiff-line-modified-removed">-       if (T::os2Tag)</span>
<span class="udiff-line-modified-added">+       if (T::os2Tag != HB_TAG_NONE &amp;&amp; face-&gt;table.OS2-&gt;is_typo_metrics ())</span>
        {
<span class="udiff-line-modified-removed">-         hb_blob_t *os2_blob = Sanitizer&lt;os2&gt; ().sanitize (face-&gt;reference_table (T::os2Tag));</span>
<span class="udiff-line-modified-removed">-         const os2 *os2_table = os2_blob-&gt;as&lt;os2&gt; ();</span>
<span class="udiff-line-modified-removed">- #define USE_TYPO_METRICS (1u&lt;&lt;7)</span>
<span class="udiff-line-modified-removed">-         if (0 != (os2_table-&gt;fsSelection &amp; USE_TYPO_METRICS))</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           ascender = os2_table-&gt;sTypoAscender;</span>
<span class="udiff-line-removed">-           descender = os2_table-&gt;sTypoDescender;</span>
<span class="udiff-line-removed">-           line_gap = os2_table-&gt;sTypoLineGap;</span>
<span class="udiff-line-removed">-           got_font_extents = (ascender | descender) != 0;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         hb_blob_destroy (os2_blob);</span>
<span class="udiff-line-modified-added">+         ascender = abs (face-&gt;table.OS2-&gt;sTypoAscender);</span>
<span class="udiff-line-modified-added">+         descender = -abs (face-&gt;table.OS2-&gt;sTypoDescender);</span>
<span class="udiff-line-modified-added">+         line_gap = face-&gt;table.OS2-&gt;sTypoLineGap;</span>
<span class="udiff-line-modified-added">+         got_font_extents = (ascender | descender) != 0;</span>
        }
  
<span class="udiff-line-modified-removed">-       hb_blob_t *_hea_blob = Sanitizer&lt;H&gt; ().sanitize (face-&gt;reference_table (H::tableTag));</span>
<span class="udiff-line-modified-added">+       hb_blob_t *_hea_blob = hb_sanitize_context_t().reference_table&lt;H&gt; (face);</span>
        const H *_hea_table = _hea_blob-&gt;as&lt;H&gt; ();
        num_advances = _hea_table-&gt;numberOfLongMetrics;
        if (!got_font_extents)
        {
<span class="udiff-line-modified-removed">-         ascender = _hea_table-&gt;ascender;</span>
<span class="udiff-line-modified-removed">-         descender = _hea_table-&gt;descender;</span>
<span class="udiff-line-modified-added">+         ascender = abs (_hea_table-&gt;ascender);</span>
<span class="udiff-line-modified-added">+         descender = -abs (_hea_table-&gt;descender);</span>
          line_gap = _hea_table-&gt;lineGap;
          got_font_extents = (ascender | descender) != 0;
        }
        hb_blob_destroy (_hea_blob);
  
        has_font_extents = got_font_extents;
  
<span class="udiff-line-modified-removed">-       blob = Sanitizer&lt;hmtxvmtx&gt; ().sanitize (face-&gt;reference_table (T::tableTag));</span>
<span class="udiff-line-modified-added">+       table = hb_sanitize_context_t().reference_table&lt;hmtxvmtx&gt; (face, T::tableTag);</span>
  
        /* Cap num_metrics() and num_advances() based on table length. */
<span class="udiff-line-modified-removed">-       unsigned int len = hb_blob_get_length (blob);</span>
<span class="udiff-line-modified-added">+       unsigned int len = table.get_length ();</span>
        if (unlikely (num_advances * 4 &gt; len))
          num_advances = len / 4;
        num_metrics = num_advances + (len - 4 * num_advances) / 2;
  
        /* We MUST set num_metrics to zero if num_advances is zero.
         * Our get_advance() depends on that. */
        if (unlikely (!num_advances))
        {
          num_metrics = num_advances = 0;
<span class="udiff-line-modified-removed">-         hb_blob_destroy (blob);</span>
<span class="udiff-line-modified-removed">-         blob = hb_blob_get_empty ();</span>
<span class="udiff-line-modified-added">+         table.destroy ();</span>
<span class="udiff-line-modified-added">+         table = hb_blob_get_empty ();</span>
        }
<span class="udiff-line-removed">-       table = blob-&gt;as&lt;hmtxvmtx&gt; ();</span>
  
<span class="udiff-line-modified-removed">-       var_blob = Sanitizer&lt;HVARVVAR&gt; ().sanitize (face-&gt;reference_table (T::variationsTag));</span>
<span class="udiff-line-modified-removed">-       var_table = var_blob-&gt;as&lt;HVARVVAR&gt; ();</span>
<span class="udiff-line-modified-added">+       var_table = hb_sanitize_context_t().reference_table&lt;HVARVVAR&gt; (face, T::variationsTag);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void fini ()</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       table.destroy ();</span>
<span class="udiff-line-added">+       var_table.destroy ();</span>
      }
  
<span class="udiff-line-modified-removed">-     inline void fini (void)</span>
<span class="udiff-line-modified-added">+     /* TODO Add variations version. */</span>
<span class="udiff-line-added">+     unsigned int get_side_bearing (hb_codepoint_t glyph) const</span>
      {
<span class="udiff-line-modified-removed">-       hb_blob_destroy (blob);</span>
<span class="udiff-line-modified-removed">-       hb_blob_destroy (var_blob);</span>
<span class="udiff-line-modified-added">+       if (glyph &lt; num_advances)</span>
<span class="udiff-line-modified-added">+         return table-&gt;longMetricZ[glyph].sb;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if (unlikely (glyph &gt;= num_metrics))</span>
<span class="udiff-line-added">+         return 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       const FWORD *bearings = (const FWORD *) &amp;table-&gt;longMetricZ[num_advances];</span>
<span class="udiff-line-added">+       return bearings[glyph - num_advances];</span>
      }
  
<span class="udiff-line-modified-removed">-     inline unsigned int get_advance (hb_codepoint_t  glyph) const</span>
<span class="udiff-line-modified-added">+     unsigned int get_advance (hb_codepoint_t glyph) const</span>
      {
        if (unlikely (glyph &gt;= num_metrics))
        {
          /* If num_metrics is zero, it means we don&#39;t have the metrics table
           * for this direction: return default advance.  Otherwise, it means that the
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -261,52 +264,50 @@</span>
            return 0;
          else
            return default_advance;
        }
  
<span class="udiff-line-modified-removed">-       return table-&gt;longMetric[MIN (glyph, (uint32_t) num_advances - 1)].advance;</span>
<span class="udiff-line-modified-added">+       return table-&gt;longMetricZ[MIN (glyph, (uint32_t) num_advances - 1)].advance;</span>
      }
  
<span class="udiff-line-modified-removed">-     inline unsigned int get_advance (hb_codepoint_t  glyph,</span>
<span class="udiff-line-modified-removed">-                                      hb_font_t      *font) const</span>
<span class="udiff-line-modified-added">+     unsigned int get_advance (hb_codepoint_t  glyph,</span>
<span class="udiff-line-modified-added">+                               hb_font_t      *font) const</span>
      {
        unsigned int advance = get_advance (glyph);
<span class="udiff-line-modified-removed">-       if (likely(glyph &lt; num_metrics))</span>
<span class="udiff-line-modified-added">+       if (likely (glyph &lt; num_metrics))</span>
        {
          advance += (font-&gt;num_coords ? var_table-&gt;get_advance_var (glyph, font-&gt;coords, font-&gt;num_coords) : 0); // TODO Optimize?!
        }
        return advance;
      }
  
      public:
      bool has_font_extents;
<span class="udiff-line-modified-removed">-     unsigned short ascender;</span>
<span class="udiff-line-modified-removed">-     unsigned short descender;</span>
<span class="udiff-line-modified-removed">-     unsigned short line_gap;</span>
<span class="udiff-line-modified-added">+     int ascender;</span>
<span class="udiff-line-modified-added">+     int descender;</span>
<span class="udiff-line-modified-added">+     int line_gap;</span>
  
      protected:
      unsigned int num_metrics;
      unsigned int num_advances;
      unsigned int default_advance;
  
      private:
<span class="udiff-line-modified-removed">-     const hmtxvmtx *table;</span>
<span class="udiff-line-modified-removed">-     hb_blob_t *blob;</span>
<span class="udiff-line-removed">-     const HVARVVAR *var_table;</span>
<span class="udiff-line-removed">-     hb_blob_t *var_blob;</span>
<span class="udiff-line-modified-added">+     hb_blob_ptr_t&lt;hmtxvmtx&gt; table;</span>
<span class="udiff-line-modified-added">+     hb_blob_ptr_t&lt;HVARVVAR&gt; var_table;</span>
    };
  
    protected:
<span class="udiff-line-modified-removed">-   LongMetric    longMetric[VAR];        /* Paired advance width and leading</span>
<span class="udiff-line-modified-added">+   UnsizedArrayOf&lt;LongMetric&gt;longMetricZ;/* Paired advance width and leading</span>
                                           * bearing values for each glyph. The
                                           * value numOfHMetrics comes from
                                           * the &#39;hhea&#39; table. If the font is
                                           * monospaced, only one entry need
                                           * be in the array, but that entry is
                                           * required. The last entry applies to
                                           * all subsequent glyphs. */
<span class="udiff-line-modified-removed">- /*FWORD         leadingBearingX[VAR];*/ /* Here the advance is assumed</span>
<span class="udiff-line-modified-added">+ /*UnsizedArrayOf&lt;FWORD&gt; leadingBearingX;*//* Here the advance is assumed</span>
                                           * to be the same as the advance
                                           * for the last entry above. The
                                           * number of entries in this array is
                                           * derived from numGlyphs (from &#39;maxp&#39;
                                           * table) minus numberOfLongMetrics.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -316,23 +317,26 @@</span>
                                           * run is allowed and it must be at
                                           * the end. This allows a monospaced
                                           * font to vary the side bearing
                                           * values for each glyph. */
    public:
<span class="udiff-line-modified-removed">-   DEFINE_SIZE_ARRAY (0, longMetric);</span>
<span class="udiff-line-modified-added">+   DEFINE_SIZE_ARRAY (0, longMetricZ);</span>
  };
  
  struct hmtx : hmtxvmtx&lt;hmtx, hhea&gt; {
<span class="udiff-line-modified-removed">-   static const hb_tag_t tableTag        = HB_OT_TAG_hmtx;</span>
<span class="udiff-line-modified-removed">-   static const hb_tag_t variationsTag   = HB_OT_TAG_HVAR;</span>
<span class="udiff-line-modified-removed">-   static const hb_tag_t os2Tag          = HB_OT_TAG_os2;</span>
<span class="udiff-line-modified-added">+   static constexpr hb_tag_t tableTag = HB_OT_TAG_hmtx;</span>
<span class="udiff-line-modified-added">+   static constexpr hb_tag_t variationsTag = HB_OT_TAG_HVAR;</span>
<span class="udiff-line-modified-added">+   static constexpr hb_tag_t os2Tag = HB_OT_TAG_OS2;</span>
  };
  struct vmtx : hmtxvmtx&lt;vmtx, vhea&gt; {
<span class="udiff-line-modified-removed">-   static const hb_tag_t tableTag        = HB_OT_TAG_vmtx;</span>
<span class="udiff-line-modified-removed">-   static const hb_tag_t variationsTag   = HB_OT_TAG_VVAR;</span>
<span class="udiff-line-modified-removed">-   static const hb_tag_t os2Tag          = HB_TAG_NONE;</span>
<span class="udiff-line-modified-added">+   static constexpr hb_tag_t tableTag = HB_OT_TAG_vmtx;</span>
<span class="udiff-line-modified-added">+   static constexpr hb_tag_t variationsTag = HB_OT_TAG_VVAR;</span>
<span class="udiff-line-modified-added">+   static constexpr hb_tag_t os2Tag = HB_TAG_NONE;</span>
  };
  
<span class="udiff-line-added">+ struct hmtx_accelerator_t : hmtx::accelerator_t {};</span>
<span class="udiff-line-added">+ struct vmtx_accelerator_t : vmtx::accelerator_t {};</span>
<span class="udiff-line-added">+ </span>
  } /* namespace OT */
  
  
  #endif /* HB_OT_HMTX_TABLE_HH */
</pre>
<center><a href="hb-ot-hhea-table.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-kern-table.hh.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>