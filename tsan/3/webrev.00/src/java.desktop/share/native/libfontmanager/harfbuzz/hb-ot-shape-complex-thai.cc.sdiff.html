<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-shape-complex-thai.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-shape-complex-myanmar.cc.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-shape-complex-use-machine.hh.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-shape-complex-thai.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod
 25  */
 26 
<span class="line-modified"> 27 #include &quot;hb-ot-shape-complex-private.hh&quot;</span>
 28 
 29 
 30 /* Thai / Lao shaper */
 31 
 32 
 33 /* PUA shaping */
 34 
 35 
 36 enum thai_consonant_type_t
 37 {
 38   NC,
 39   AC,
 40   RC,
 41   DC,
 42   NOT_CONSONANT,
 43   NUM_CONSONANT_TYPES = NOT_CONSONANT
 44 };
 45 
 46 static thai_consonant_type_t
 47 get_consonant_type (hb_codepoint_t u)
</pre>
<hr />
<pre>
307    */
308 
309   /* We only get one script at a time, so a script-agnostic implementation
310    * is adequate here. */
311 #define IS_SARA_AM(x) (((x) &amp; ~0x0080u) == 0x0E33u)
312 #define NIKHAHIT_FROM_SARA_AM(x) ((x) - 0x0E33u + 0x0E4Du)
313 #define SARA_AA_FROM_SARA_AM(x) ((x) - 1)
314 #define IS_TONE_MARK(x) (hb_in_ranges&lt;hb_codepoint_t&gt; ((x) &amp; ~0x0080u, 0x0E34u, 0x0E37u, 0x0E47u, 0x0E4Eu, 0x0E31u, 0x0E31u))
315 
316   buffer-&gt;clear_output ();
317   unsigned int count = buffer-&gt;len;
318   for (buffer-&gt;idx = 0; buffer-&gt;idx &lt; count &amp;&amp; buffer-&gt;successful;)
319   {
320     hb_codepoint_t u = buffer-&gt;cur().codepoint;
321     if (likely (!IS_SARA_AM (u))) {
322       buffer-&gt;next_glyph ();
323       continue;
324     }
325 
326     /* Is SARA AM. Decompose and reorder. */
<span class="line-modified">327     hb_codepoint_t decomposed[2] = {hb_codepoint_t (NIKHAHIT_FROM_SARA_AM (u)),</span>
<span class="line-modified">328                                     hb_codepoint_t (SARA_AA_FROM_SARA_AM (u))};</span>
<span class="line-modified">329     buffer-&gt;replace_glyphs (1, 2, decomposed);</span>
330     if (unlikely (!buffer-&gt;successful))
331       return;
332 
333     /* Make Nikhahit be recognized as a ccc=0 mark when zeroing widths. */
334     unsigned int end = buffer-&gt;out_len;
335     _hb_glyph_info_set_general_category (&amp;buffer-&gt;out_info[end - 2], HB_UNICODE_GENERAL_CATEGORY_NON_SPACING_MARK);
336 
337     /* Ok, let&#39;s see... */
338     unsigned int start = end - 2;
339     while (start &gt; 0 &amp;&amp; IS_TONE_MARK (buffer-&gt;out_info[start - 1].codepoint))
340       start--;
341 
342     if (start + 2 &lt; end)
343     {
344       /* Move Nikhahit (end-2) to the beginning */
345       buffer-&gt;merge_out_clusters (start, end);
346       hb_glyph_info_t t = buffer-&gt;out_info[end - 2];
347       memmove (buffer-&gt;out_info + start + 1,
348                buffer-&gt;out_info + start,
349                sizeof (buffer-&gt;out_info[0]) * (end - start - 2));
</pre>
<hr />
<pre>
359   }
360   buffer-&gt;swap_buffers ();
361 
362   /* If font has Thai GSUB, we are done. */
363   if (plan-&gt;props.script == HB_SCRIPT_THAI &amp;&amp; !plan-&gt;map.found_script[0])
364     do_thai_pua_shaping (plan, buffer, font);
365 }
366 
367 const hb_ot_complex_shaper_t _hb_ot_complex_shaper_thai =
368 {
369   nullptr, /* collect_features */
370   nullptr, /* override_features */
371   nullptr, /* data_create */
372   nullptr, /* data_destroy */
373   preprocess_text_thai,
374   nullptr, /* postprocess_glyphs */
375   HB_OT_SHAPE_NORMALIZATION_MODE_DEFAULT,
376   nullptr, /* decompose */
377   nullptr, /* compose */
378   nullptr, /* setup_masks */
<span class="line-modified">379   nullptr, /* disable_otl */</span>
380   nullptr, /* reorder_marks */
381   HB_OT_SHAPE_ZERO_WIDTH_MARKS_BY_GDEF_LATE,
382   false,/* fallback_position */
383 };
</pre>
</td>
<td>
<hr />
<pre>
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod
 25  */
 26 
<span class="line-modified"> 27 #include &quot;hb-ot-shape-complex.hh&quot;</span>
 28 
 29 
 30 /* Thai / Lao shaper */
 31 
 32 
 33 /* PUA shaping */
 34 
 35 
 36 enum thai_consonant_type_t
 37 {
 38   NC,
 39   AC,
 40   RC,
 41   DC,
 42   NOT_CONSONANT,
 43   NUM_CONSONANT_TYPES = NOT_CONSONANT
 44 };
 45 
 46 static thai_consonant_type_t
 47 get_consonant_type (hb_codepoint_t u)
</pre>
<hr />
<pre>
307    */
308 
309   /* We only get one script at a time, so a script-agnostic implementation
310    * is adequate here. */
311 #define IS_SARA_AM(x) (((x) &amp; ~0x0080u) == 0x0E33u)
312 #define NIKHAHIT_FROM_SARA_AM(x) ((x) - 0x0E33u + 0x0E4Du)
313 #define SARA_AA_FROM_SARA_AM(x) ((x) - 1)
314 #define IS_TONE_MARK(x) (hb_in_ranges&lt;hb_codepoint_t&gt; ((x) &amp; ~0x0080u, 0x0E34u, 0x0E37u, 0x0E47u, 0x0E4Eu, 0x0E31u, 0x0E31u))
315 
316   buffer-&gt;clear_output ();
317   unsigned int count = buffer-&gt;len;
318   for (buffer-&gt;idx = 0; buffer-&gt;idx &lt; count &amp;&amp; buffer-&gt;successful;)
319   {
320     hb_codepoint_t u = buffer-&gt;cur().codepoint;
321     if (likely (!IS_SARA_AM (u))) {
322       buffer-&gt;next_glyph ();
323       continue;
324     }
325 
326     /* Is SARA AM. Decompose and reorder. */
<span class="line-modified">327     hb_glyph_info_t &amp;nikhahit = buffer-&gt;output_glyph (NIKHAHIT_FROM_SARA_AM (u));</span>
<span class="line-modified">328     _hb_glyph_info_set_continuation (&amp;nikhahit);</span>
<span class="line-modified">329     buffer-&gt;replace_glyph (SARA_AA_FROM_SARA_AM (u));</span>
330     if (unlikely (!buffer-&gt;successful))
331       return;
332 
333     /* Make Nikhahit be recognized as a ccc=0 mark when zeroing widths. */
334     unsigned int end = buffer-&gt;out_len;
335     _hb_glyph_info_set_general_category (&amp;buffer-&gt;out_info[end - 2], HB_UNICODE_GENERAL_CATEGORY_NON_SPACING_MARK);
336 
337     /* Ok, let&#39;s see... */
338     unsigned int start = end - 2;
339     while (start &gt; 0 &amp;&amp; IS_TONE_MARK (buffer-&gt;out_info[start - 1].codepoint))
340       start--;
341 
342     if (start + 2 &lt; end)
343     {
344       /* Move Nikhahit (end-2) to the beginning */
345       buffer-&gt;merge_out_clusters (start, end);
346       hb_glyph_info_t t = buffer-&gt;out_info[end - 2];
347       memmove (buffer-&gt;out_info + start + 1,
348                buffer-&gt;out_info + start,
349                sizeof (buffer-&gt;out_info[0]) * (end - start - 2));
</pre>
<hr />
<pre>
359   }
360   buffer-&gt;swap_buffers ();
361 
362   /* If font has Thai GSUB, we are done. */
363   if (plan-&gt;props.script == HB_SCRIPT_THAI &amp;&amp; !plan-&gt;map.found_script[0])
364     do_thai_pua_shaping (plan, buffer, font);
365 }
366 
367 const hb_ot_complex_shaper_t _hb_ot_complex_shaper_thai =
368 {
369   nullptr, /* collect_features */
370   nullptr, /* override_features */
371   nullptr, /* data_create */
372   nullptr, /* data_destroy */
373   preprocess_text_thai,
374   nullptr, /* postprocess_glyphs */
375   HB_OT_SHAPE_NORMALIZATION_MODE_DEFAULT,
376   nullptr, /* decompose */
377   nullptr, /* compose */
378   nullptr, /* setup_masks */
<span class="line-modified">379   HB_TAG_NONE, /* gpos_tag */</span>
380   nullptr, /* reorder_marks */
381   HB_OT_SHAPE_ZERO_WIDTH_MARKS_BY_GDEF_LATE,
382   false,/* fallback_position */
383 };
</pre>
</td>
</tr>
</table>
<center><a href="hb-ot-shape-complex-myanmar.cc.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-shape-complex-use-machine.hh.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>