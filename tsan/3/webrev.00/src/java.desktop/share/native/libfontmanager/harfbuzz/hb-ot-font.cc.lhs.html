<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-font.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright Â© 2011,2014  Google, Inc.
  3  *
  4  *  This is part of HarfBuzz, a text shaping library.
  5  *
  6  * Permission is hereby granted, without written agreement and without
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod, Roozbeh Pournader
 25  */
 26 
<a name="1" id="anc1"></a><span class="line-modified"> 27 #include &quot;hb-private.hh&quot;</span>
 28 
 29 #include &quot;hb-ot.h&quot;
 30 
<a name="2" id="anc2"></a><span class="line-modified"> 31 #include &quot;hb-font-private.hh&quot;</span>


 32 
 33 #include &quot;hb-ot-cmap-table.hh&quot;
 34 #include &quot;hb-ot-glyf-table.hh&quot;
<a name="3" id="anc3"></a>

 35 #include &quot;hb-ot-hmtx-table.hh&quot;
 36 #include &quot;hb-ot-kern-table.hh&quot;
<a name="4" id="anc4"></a>
 37 #include &quot;hb-ot-post-table.hh&quot;
<a name="5" id="anc5"></a><span class="line-modified"> 38 </span>

 39 #include &quot;hb-ot-color-cbdt-table.hh&quot;
<a name="6" id="anc6"></a>
 40 
 41 
<a name="7" id="anc7"></a><span class="line-modified"> 42 struct hb_ot_font_t</span>
<span class="line-modified"> 43 {</span>
<span class="line-modified"> 44   OT::cmap::accelerator_t cmap;</span>
<span class="line-modified"> 45   OT::hmtx::accelerator_t h_metrics;</span>
<span class="line-modified"> 46   OT::vmtx::accelerator_t v_metrics;</span>
<span class="line-modified"> 47   OT::hb_lazy_loader_t&lt;OT::glyf::accelerator_t&gt; glyf;</span>
<span class="line-modified"> 48   OT::hb_lazy_loader_t&lt;OT::CBDT::accelerator_t&gt; cbdt;</span>
<span class="line-modified"> 49   OT::hb_lazy_loader_t&lt;OT::post::accelerator_t&gt; post;</span>
<span class="line-modified"> 50   OT::hb_lazy_loader_t&lt;OT::kern::accelerator_t&gt; kern;</span>
<span class="line-modified"> 51 };</span>
<span class="line-removed"> 52 </span>
<span class="line-removed"> 53 </span>
<span class="line-removed"> 54 static hb_ot_font_t *</span>
<span class="line-removed"> 55 _hb_ot_font_create (hb_face_t *face)</span>
<span class="line-removed"> 56 {</span>
<span class="line-removed"> 57   hb_ot_font_t *ot_font = (hb_ot_font_t *) calloc (1, sizeof (hb_ot_font_t));</span>
<span class="line-removed"> 58 </span>
<span class="line-removed"> 59   if (unlikely (!ot_font))</span>
<span class="line-removed"> 60     return nullptr;</span>
<span class="line-removed"> 61 </span>
<span class="line-removed"> 62   ot_font-&gt;cmap.init (face);</span>
<span class="line-removed"> 63   ot_font-&gt;h_metrics.init (face);</span>
<span class="line-removed"> 64   ot_font-&gt;v_metrics.init (face, ot_font-&gt;h_metrics.ascender - ot_font-&gt;h_metrics.descender); /* TODO Can we do this lazily? */</span>
<span class="line-removed"> 65   ot_font-&gt;glyf.init (face);</span>
<span class="line-removed"> 66   ot_font-&gt;cbdt.init (face);</span>
<span class="line-removed"> 67   ot_font-&gt;post.init (face);</span>
<span class="line-removed"> 68   ot_font-&gt;kern.init (face);</span>
<span class="line-removed"> 69 </span>
<span class="line-removed"> 70   return ot_font;</span>
<span class="line-removed"> 71 }</span>
<span class="line-removed"> 72 </span>
<span class="line-removed"> 73 static void</span>
<span class="line-removed"> 74 _hb_ot_font_destroy (void *data)</span>
<span class="line-removed"> 75 {</span>
<span class="line-removed"> 76   hb_ot_font_t *ot_font = (hb_ot_font_t *) data;</span>
<span class="line-removed"> 77 </span>
<span class="line-removed"> 78   ot_font-&gt;cmap.fini ();</span>
<span class="line-removed"> 79   ot_font-&gt;h_metrics.fini ();</span>
<span class="line-removed"> 80   ot_font-&gt;v_metrics.fini ();</span>
<span class="line-removed"> 81   ot_font-&gt;glyf.fini ();</span>
<span class="line-removed"> 82   ot_font-&gt;cbdt.fini ();</span>
<span class="line-removed"> 83   ot_font-&gt;post.fini ();</span>
<span class="line-removed"> 84   ot_font-&gt;kern.fini ();</span>
<span class="line-removed"> 85 </span>
<span class="line-removed"> 86   free (ot_font);</span>
<span class="line-removed"> 87 }</span>
 88 
 89 
 90 static hb_bool_t
 91 hb_ot_get_nominal_glyph (hb_font_t *font HB_UNUSED,
 92                          void *font_data,
 93                          hb_codepoint_t unicode,
 94                          hb_codepoint_t *glyph,
 95                          void *user_data HB_UNUSED)
<a name="8" id="anc8"></a>



 96 
<a name="9" id="anc9"></a>








 97 {
<a name="10" id="anc10"></a><span class="line-modified"> 98   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified"> 99   return ot_font-&gt;cmap.get_nominal_glyph (unicode, glyph);</span>


100 }
101 
102 static hb_bool_t
103 hb_ot_get_variation_glyph (hb_font_t *font HB_UNUSED,
104                            void *font_data,
105                            hb_codepoint_t unicode,
106                            hb_codepoint_t variation_selector,
107                            hb_codepoint_t *glyph,
108                            void *user_data HB_UNUSED)
109 {
<a name="11" id="anc11"></a><span class="line-modified">110   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">111   return ot_font-&gt;cmap.get_variation_glyph (unicode, variation_selector, glyph);</span>
112 }
113 
<a name="12" id="anc12"></a><span class="line-modified">114 static hb_position_t</span>
<span class="line-modified">115 hb_ot_get_glyph_h_advance (hb_font_t *font,</span>
<span class="line-modified">116                            void *font_data,</span>
<span class="line-modified">117                            hb_codepoint_t glyph,</span>
<span class="line-modified">118                            void *user_data HB_UNUSED)</span>



119 {
<a name="13" id="anc13"></a><span class="line-modified">120   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">121   return font-&gt;em_scale_x (ot_font-&gt;h_metrics.get_advance (glyph, font));</span>







122 }
123 
<a name="14" id="anc14"></a><span class="line-modified">124 static hb_position_t</span>
<span class="line-modified">125 hb_ot_get_glyph_v_advance (hb_font_t *font,</span>
<span class="line-modified">126                            void *font_data,</span>
<span class="line-modified">127                            hb_codepoint_t glyph,</span>
<span class="line-modified">128                            void *user_data HB_UNUSED)</span>



129 {
<a name="15" id="anc15"></a><span class="line-modified">130   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">131   return font-&gt;em_scale_y (-(int) ot_font-&gt;v_metrics.get_advance (glyph, font));</span>







132 }
133 
<a name="16" id="anc16"></a><span class="line-modified">134 static hb_position_t</span>
<span class="line-modified">135 hb_ot_get_glyph_h_kerning (hb_font_t *font,</span>
<span class="line-modified">136                            void *font_data,</span>
<span class="line-modified">137                            hb_codepoint_t left_glyph,</span>
<span class="line-modified">138                            hb_codepoint_t right_glyph,</span>
<span class="line-modified">139                            void *user_data HB_UNUSED)</span>

140 {
<a name="17" id="anc17"></a><span class="line-modified">141   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">142   return font-&gt;em_scale_x (ot_font-&gt;kern-&gt;get_h_kerning (left_glyph, right_glyph));</span>























143 }
144 
145 static hb_bool_t
146 hb_ot_get_glyph_extents (hb_font_t *font,
147                          void *font_data,
148                          hb_codepoint_t glyph,
149                          hb_glyph_extents_t *extents,
150                          void *user_data HB_UNUSED)
151 {
<a name="18" id="anc18"></a><span class="line-modified">152   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">153   bool ret = ot_font-&gt;glyf-&gt;get_extents (glyph, extents);</span>






154   if (!ret)
<a name="19" id="anc19"></a><span class="line-modified">155     ret = ot_font-&gt;cbdt-&gt;get_extents (glyph, extents);</span>
156   // TODO Hook up side-bearings variations.
157   extents-&gt;x_bearing = font-&gt;em_scale_x (extents-&gt;x_bearing);
158   extents-&gt;y_bearing = font-&gt;em_scale_y (extents-&gt;y_bearing);
159   extents-&gt;width     = font-&gt;em_scale_x (extents-&gt;width);
160   extents-&gt;height    = font-&gt;em_scale_y (extents-&gt;height);
161   return ret;
162 }
163 
164 static hb_bool_t
165 hb_ot_get_glyph_name (hb_font_t *font HB_UNUSED,
166                       void *font_data,
167                       hb_codepoint_t glyph,
168                       char *name, unsigned int size,
169                       void *user_data HB_UNUSED)
170 {
<a name="20" id="anc20"></a><span class="line-modified">171   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">172   return ot_font-&gt;post-&gt;get_glyph_name (glyph, name, size);</span>
173 }
174 
175 static hb_bool_t
176 hb_ot_get_glyph_from_name (hb_font_t *font HB_UNUSED,
177                            void *font_data,
178                            const char *name, int len,
179                            hb_codepoint_t *glyph,
180                            void *user_data HB_UNUSED)
181 {
<a name="21" id="anc21"></a><span class="line-modified">182   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">183   return ot_font-&gt;post-&gt;get_glyph_from_name (name, len, glyph);</span>
184 }
185 
186 static hb_bool_t
187 hb_ot_get_font_h_extents (hb_font_t *font,
188                           void *font_data,
189                           hb_font_extents_t *metrics,
190                           void *user_data HB_UNUSED)
191 {
<a name="22" id="anc22"></a><span class="line-modified">192   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">193   metrics-&gt;ascender = font-&gt;em_scale_y (ot_font-&gt;h_metrics.ascender);</span>
<span class="line-modified">194   metrics-&gt;descender = font-&gt;em_scale_y (ot_font-&gt;h_metrics.descender);</span>
<span class="line-modified">195   metrics-&gt;line_gap = font-&gt;em_scale_y (ot_font-&gt;h_metrics.line_gap);</span>

196   // TODO Hook up variations.
<a name="23" id="anc23"></a><span class="line-modified">197   return ot_font-&gt;h_metrics.has_font_extents;</span>
198 }
199 
200 static hb_bool_t
201 hb_ot_get_font_v_extents (hb_font_t *font,
202                           void *font_data,
203                           hb_font_extents_t *metrics,
204                           void *user_data HB_UNUSED)
205 {
<a name="24" id="anc24"></a><span class="line-modified">206   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">207   metrics-&gt;ascender = font-&gt;em_scale_x (ot_font-&gt;v_metrics.ascender);</span>
<span class="line-modified">208   metrics-&gt;descender = font-&gt;em_scale_x (ot_font-&gt;v_metrics.descender);</span>
<span class="line-modified">209   metrics-&gt;line_gap = font-&gt;em_scale_x (ot_font-&gt;v_metrics.line_gap);</span>

210   // TODO Hook up variations.
<a name="25" id="anc25"></a><span class="line-modified">211   return ot_font-&gt;v_metrics.has_font_extents;</span>
212 }
213 
<a name="26" id="anc26"></a><span class="line-modified">214 static hb_font_funcs_t *static_ot_funcs = nullptr;</span>
<span class="line-modified">215 </span>
<span class="line-removed">216 #ifdef HB_USE_ATEXIT</span>
<span class="line-removed">217 static</span>
<span class="line-removed">218 void free_static_ot_funcs (void)</span>
<span class="line-removed">219 {</span>
<span class="line-removed">220 retry:</span>
<span class="line-removed">221   hb_font_funcs_t *ot_funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ot_funcs);</span>
<span class="line-removed">222   if (!hb_atomic_ptr_cmpexch (&amp;static_ot_funcs, ot_funcs, nullptr))</span>
<span class="line-removed">223     goto retry;</span>
<span class="line-removed">224 </span>
<span class="line-removed">225   hb_font_funcs_destroy (ot_funcs);</span>
<span class="line-removed">226 }</span>
227 #endif
228 
<a name="27" id="anc27"></a><span class="line-modified">229 static hb_font_funcs_t *</span>
<span class="line-removed">230 _hb_ot_get_font_funcs (void)</span>
231 {
<a name="28" id="anc28"></a><span class="line-modified">232 retry:</span>
<span class="line-removed">233   hb_font_funcs_t *funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ot_funcs);</span>
<span class="line-removed">234 </span>
<span class="line-removed">235   if (unlikely (!funcs))</span>
236   {
<a name="29" id="anc29"></a><span class="line-modified">237     funcs = hb_font_funcs_create ();</span>
238 
239     hb_font_funcs_set_font_h_extents_func (funcs, hb_ot_get_font_h_extents, nullptr, nullptr);
240     hb_font_funcs_set_font_v_extents_func (funcs, hb_ot_get_font_v_extents, nullptr, nullptr);
241     hb_font_funcs_set_nominal_glyph_func (funcs, hb_ot_get_nominal_glyph, nullptr, nullptr);
<a name="30" id="anc30"></a>
242     hb_font_funcs_set_variation_glyph_func (funcs, hb_ot_get_variation_glyph, nullptr, nullptr);
<a name="31" id="anc31"></a><span class="line-modified">243     hb_font_funcs_set_glyph_h_advance_func (funcs, hb_ot_get_glyph_h_advance, nullptr, nullptr);</span>
<span class="line-modified">244     hb_font_funcs_set_glyph_v_advance_func (funcs, hb_ot_get_glyph_v_advance, nullptr, nullptr);</span>
245     //hb_font_funcs_set_glyph_h_origin_func (funcs, hb_ot_get_glyph_h_origin, nullptr, nullptr);
<a name="32" id="anc32"></a><span class="line-modified">246     //hb_font_funcs_set_glyph_v_origin_func (funcs, hb_ot_get_glyph_v_origin, nullptr, nullptr);</span>
<span class="line-removed">247     hb_font_funcs_set_glyph_h_kerning_func (funcs, hb_ot_get_glyph_h_kerning, nullptr, nullptr);</span>
<span class="line-removed">248     //hb_font_funcs_set_glyph_v_kerning_func (funcs, hb_ot_get_glyph_v_kerning, nullptr, nullptr);</span>
249     hb_font_funcs_set_glyph_extents_func (funcs, hb_ot_get_glyph_extents, nullptr, nullptr);
250     //hb_font_funcs_set_glyph_contour_point_func (funcs, hb_ot_get_glyph_contour_point, nullptr, nullptr);
251     hb_font_funcs_set_glyph_name_func (funcs, hb_ot_get_glyph_name, nullptr, nullptr);
252     hb_font_funcs_set_glyph_from_name_func (funcs, hb_ot_get_glyph_from_name, nullptr, nullptr);
253 
254     hb_font_funcs_make_immutable (funcs);
255 
<a name="33" id="anc33"></a><span class="line-modified">256     if (!hb_atomic_ptr_cmpexch (&amp;static_ot_funcs, nullptr, funcs)) {</span>
<span class="line-modified">257       hb_font_funcs_destroy (funcs);</span>
<span class="line-modified">258       goto retry;</span>
<span class="line-removed">259     }</span>
260 
<a name="34" id="anc34"></a><span class="line-modified">261 #ifdef HB_USE_ATEXIT</span>
<span class="line-modified">262     atexit (free_static_ot_funcs); /* First person registers atexit() callback. */</span>








263 #endif
<a name="35" id="anc35"></a><span class="line-removed">264   };</span>
265 
<a name="36" id="anc36"></a><span class="line-modified">266   return funcs;</span>



267 }
268 
269 
270 /**
271  * hb_ot_font_set_funcs:
272  *
273  * Since: 0.9.28
274  **/
275 void
276 hb_ot_font_set_funcs (hb_font_t *font)
277 {
<a name="37" id="anc37"></a><span class="line-removed">278   hb_ot_font_t *ot_font = _hb_ot_font_create (font-&gt;face);</span>
<span class="line-removed">279   if (unlikely (!ot_font))</span>
<span class="line-removed">280     return;</span>
<span class="line-removed">281 </span>
282   hb_font_set_funcs (font,
283                      _hb_ot_get_font_funcs (),
<a name="38" id="anc38"></a><span class="line-modified">284                      ot_font,</span>
<span class="line-modified">285                      _hb_ot_font_destroy);</span>
286 }
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>