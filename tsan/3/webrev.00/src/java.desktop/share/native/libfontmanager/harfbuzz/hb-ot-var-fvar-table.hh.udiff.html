<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-var-fvar-table.hh</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-var-avar-table.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-var-hvar-table.hh.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-var-fvar-table.hh</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,11 +25,11 @@</span>
   */
  
  #ifndef HB_OT_VAR_FVAR_TABLE_HH
  #define HB_OT_VAR_FVAR_TABLE_HH
  
<span class="udiff-line-modified-removed">- #include &quot;hb-open-type-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-open-type.hh&quot;</span>
  
  /*
   * fvar -- Font Variations
   * https://docs.microsoft.com/en-us/typography/opentype/spec/fvar
   */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -40,156 +40,258 @@</span>
  namespace OT {
  
  
  struct InstanceRecord
  {
<span class="udiff-line-modified-removed">-   inline bool sanitize (hb_sanitize_context_t *c, unsigned int axis_count) const</span>
<span class="udiff-line-modified-added">+   friend struct fvar;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   hb_array_t&lt;const Fixed&gt; get_coordinates (unsigned int axis_count) const</span>
<span class="udiff-line-added">+   { return coordinatesZ.as_array (axis_count); }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   bool sanitize (hb_sanitize_context_t *c, unsigned int axis_count) const</span>
    {
      TRACE_SANITIZE (this);
      return_trace (c-&gt;check_struct (this) &amp;&amp;
<span class="udiff-line-modified-removed">-                   c-&gt;check_array (coordinates, coordinates[0].static_size, axis_count));</span>
<span class="udiff-line-modified-added">+                   c-&gt;check_array (coordinatesZ.arrayZ, axis_count));</span>
    }
  
    protected:
    NameID        subfamilyNameID;/* The name ID for entries in the &#39;name&#39; table
                                   * that provide subfamily names for this instance. */
<span class="udiff-line-modified-removed">-   HBUINT16      reserved;       /* Reserved for future use — set to 0. */</span>
<span class="udiff-line-modified-removed">-   Fixed         coordinates[VAR];/* The coordinates array for this instance. */</span>
<span class="udiff-line-modified-added">+   HBUINT16      flags;          /* Reserved for future use — set to 0. */</span>
<span class="udiff-line-modified-added">+   UnsizedArrayOf&lt;Fixed&gt;</span>
<span class="udiff-line-added">+                 coordinatesZ;   /* The coordinates array for this instance. */</span>
    //NameID      postScriptNameIDX;/*Optional. The name ID for entries in the &#39;name&#39;
    //                              * table that provide PostScript names for this
    //                              * instance. */
  
    public:
<span class="udiff-line-modified-removed">-   DEFINE_SIZE_ARRAY (4, coordinates);</span>
<span class="udiff-line-modified-added">+   DEFINE_SIZE_UNBOUNDED (4);</span>
  };
  
  struct AxisRecord
  {
<span class="udiff-line-modified-removed">-   inline bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="udiff-line-modified-added">+   enum</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     AXIS_FLAG_HIDDEN    = 0x0001,</span>
<span class="udiff-line-added">+   };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   bool sanitize (hb_sanitize_context_t *c) const</span>
    {
      TRACE_SANITIZE (this);
      return_trace (c-&gt;check_struct (this));
    }
  
    public:
    Tag           axisTag;        /* Tag identifying the design variation for the axis. */
    Fixed         minValue;       /* The minimum coordinate value for the axis. */
    Fixed         defaultValue;   /* The default coordinate value for the axis. */
    Fixed         maxValue;       /* The maximum coordinate value for the axis. */
<span class="udiff-line-modified-removed">-   HBUINT16      reserved;       /* Reserved for future use — set to 0. */</span>
<span class="udiff-line-modified-added">+   HBUINT16      flags;          /* Axis flags. */</span>
    NameID        axisNameID;     /* The name ID for entries in the &#39;name&#39; table that
                                   * provide a display name for this axis. */
  
    public:
    DEFINE_SIZE_STATIC (20);
  };
  
  struct fvar
  {
<span class="udiff-line-modified-removed">-   static const hb_tag_t tableTag        = HB_OT_TAG_fvar;</span>
<span class="udiff-line-modified-added">+   static constexpr hb_tag_t tableTag = HB_OT_TAG_fvar;</span>
  
<span class="udiff-line-modified-removed">-   inline bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="udiff-line-modified-added">+   bool has_data () const { return version.to_int (); }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   bool sanitize (hb_sanitize_context_t *c) const</span>
    {
      TRACE_SANITIZE (this);
      return_trace (version.sanitize (c) &amp;&amp;
                    likely (version.major == 1) &amp;&amp;
                    c-&gt;check_struct (this) &amp;&amp;
<span class="udiff-line-added">+                   axisSize == 20 &amp;&amp; /* Assumed in our code. */</span>
                    instanceSize &gt;= axisCount * 4 + 4 &amp;&amp;
<span class="udiff-line-modified-removed">-                   axisSize &lt;= 1024 &amp;&amp; /* Arbitrary, just to simplify overflow checks. */</span>
<span class="udiff-line-modified-removed">-                   instanceSize &lt;= 1024 &amp;&amp; /* Arbitrary, just to simplify overflow checks. */</span>
<span class="udiff-line-removed">-                   c-&gt;check_range (this, things) &amp;&amp;</span>
<span class="udiff-line-removed">-                   c-&gt;check_range (&amp;StructAtOffset&lt;char&gt; (this, things),</span>
<span class="udiff-line-removed">-                                   axisCount * axisSize + instanceCount * instanceSize));</span>
<span class="udiff-line-modified-added">+                   get_axes ().sanitize (c) &amp;&amp;</span>
<span class="udiff-line-modified-added">+                   c-&gt;check_range (get_instance (0), instanceCount, instanceSize));</span>
    }
  
<span class="udiff-line-modified-removed">-   inline unsigned int get_axis_count (void) const</span>
<span class="udiff-line-modified-removed">-   { return axisCount; }</span>
<span class="udiff-line-modified-added">+   unsigned int get_axis_count () const { return axisCount; }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+   void get_axis_deprecated (unsigned int axis_index,</span>
<span class="udiff-line-added">+                                    hb_ot_var_axis_t *info) const</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     const AxisRecord &amp;axis = get_axes ()[axis_index];</span>
<span class="udiff-line-added">+     info-&gt;tag = axis.axisTag;</span>
<span class="udiff-line-added">+     info-&gt;name_id =  axis.axisNameID;</span>
<span class="udiff-line-added">+     info-&gt;default_value = axis.defaultValue / 65536.;</span>
<span class="udiff-line-added">+     /* Ensure order, to simplify client math. */</span>
<span class="udiff-line-added">+     info-&gt;min_value = MIN&lt;float&gt; (info-&gt;default_value, axis.minValue / 65536.);</span>
<span class="udiff-line-added">+     info-&gt;max_value = MAX&lt;float&gt; (info-&gt;default_value, axis.maxValue / 65536.);</span>
<span class="udiff-line-added">+   }</span>
  
<span class="udiff-line-modified-removed">-   inline bool get_axis (unsigned int index, hb_ot_var_axis_t *info) const</span>
<span class="udiff-line-modified-added">+   void get_axis_info (unsigned int axis_index,</span>
<span class="udiff-line-added">+                       hb_ot_var_axis_info_t *info) const</span>
    {
<span class="udiff-line-modified-removed">-     if (unlikely (index &gt;= axisCount))</span>
<span class="udiff-line-modified-removed">-       return false;</span>
<span class="udiff-line-modified-added">+     const AxisRecord &amp;axis = get_axes ()[axis_index];</span>
<span class="udiff-line-modified-added">+     info-&gt;axis_index = axis_index;</span>
<span class="udiff-line-added">+     info-&gt;tag = axis.axisTag;</span>
<span class="udiff-line-added">+     info-&gt;name_id =  axis.axisNameID;</span>
<span class="udiff-line-added">+     info-&gt;flags = (hb_ot_var_axis_flags_t) (unsigned int) axis.flags;</span>
<span class="udiff-line-added">+     info-&gt;default_value = axis.defaultValue / 65536.;</span>
<span class="udiff-line-added">+     /* Ensure order, to simplify client math. */</span>
<span class="udiff-line-added">+     info-&gt;min_value = MIN&lt;float&gt; (info-&gt;default_value, axis.minValue / 65536.);</span>
<span class="udiff-line-added">+     info-&gt;max_value = MAX&lt;float&gt; (info-&gt;default_value, axis.maxValue / 65536.);</span>
<span class="udiff-line-added">+     info-&gt;reserved = 0;</span>
<span class="udiff-line-added">+   }</span>
  
<span class="udiff-line-modified-removed">-     if (info)</span>
<span class="udiff-line-modified-added">+   unsigned int get_axes_deprecated (unsigned int      start_offset,</span>
<span class="udiff-line-added">+                                     unsigned int     *axes_count /* IN/OUT */,</span>
<span class="udiff-line-added">+                                     hb_ot_var_axis_t *axes_array /* OUT */) const</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     if (axes_count)</span>
      {
<span class="udiff-line-modified-removed">-       const AxisRecord &amp;axis = get_axes ()[index];</span>
<span class="udiff-line-modified-removed">-       info-&gt;tag = axis.axisTag;</span>
<span class="udiff-line-modified-removed">-       info-&gt;name_id =  axis.axisNameID;</span>
<span class="udiff-line-removed">-       info-&gt;default_value = axis.defaultValue / 65536.;</span>
<span class="udiff-line-removed">-       /* Ensure order, to simplify client math. */</span>
<span class="udiff-line-removed">-       info-&gt;min_value = MIN&lt;float&gt; (info-&gt;default_value, axis.minValue / 65536.);</span>
<span class="udiff-line-removed">-       info-&gt;max_value = MAX&lt;float&gt; (info-&gt;default_value, axis.maxValue / 65536.);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+       /* TODO Rewrite as hb_array_t&lt;&gt;::sub-array() */</span>
<span class="udiff-line-modified-added">+       unsigned int count = axisCount;</span>
<span class="udiff-line-modified-added">+       start_offset = MIN (start_offset, count);</span>
  
<span class="udiff-line-modified-removed">-     return true;</span>
<span class="udiff-line-modified-added">+       count -= start_offset;</span>
<span class="udiff-line-added">+       axes_array += start_offset;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       count = MIN (count, *axes_count);</span>
<span class="udiff-line-added">+       *axes_count = count;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       for (unsigned int i = 0; i &lt; count; i++)</span>
<span class="udiff-line-added">+         get_axis_deprecated (start_offset + i, axes_array + i);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return axisCount;</span>
    }
  
<span class="udiff-line-modified-removed">-   inline unsigned int get_axis_infos (unsigned int      start_offset,</span>
<span class="udiff-line-modified-removed">-                                       unsigned int     *axes_count /* IN/OUT */,</span>
<span class="udiff-line-modified-removed">-                                       hb_ot_var_axis_t *axes_array /* OUT */) const</span>
<span class="udiff-line-modified-added">+   unsigned int get_axis_infos (unsigned int           start_offset,</span>
<span class="udiff-line-modified-added">+                                unsigned int          *axes_count /* IN/OUT */,</span>
<span class="udiff-line-modified-added">+                                hb_ot_var_axis_info_t *axes_array /* OUT */) const</span>
    {
      if (axes_count)
      {
<span class="udiff-line-added">+       /* TODO Rewrite as hb_array_t&lt;&gt;::sub-array() */</span>
        unsigned int count = axisCount;
        start_offset = MIN (start_offset, count);
  
        count -= start_offset;
        axes_array += start_offset;
  
        count = MIN (count, *axes_count);
        *axes_count = count;
  
        for (unsigned int i = 0; i &lt; count; i++)
<span class="udiff-line-modified-removed">-         get_axis (start_offset + i, axes_array + i);</span>
<span class="udiff-line-modified-added">+         get_axis_info (start_offset + i, axes_array + i);</span>
      }
      return axisCount;
    }
  
<span class="udiff-line-modified-removed">-   inline bool find_axis (hb_tag_t tag, unsigned int *index, hb_ot_var_axis_t *info) const</span>
<span class="udiff-line-modified-added">+   bool find_axis_deprecated (hb_tag_t tag,</span>
<span class="udiff-line-added">+                              unsigned int *axis_index,</span>
<span class="udiff-line-added">+                              hb_ot_var_axis_t *info) const</span>
    {
      const AxisRecord *axes = get_axes ();
      unsigned int count = get_axis_count ();
      for (unsigned int i = 0; i &lt; count; i++)
        if (axes[i].axisTag == tag)
        {
<span class="udiff-line-modified-removed">-         if (index)</span>
<span class="udiff-line-modified-removed">-           *index = i;</span>
<span class="udiff-line-modified-removed">-         return get_axis (i, info);</span>
<span class="udiff-line-modified-added">+         if (axis_index)</span>
<span class="udiff-line-modified-added">+           *axis_index = i;</span>
<span class="udiff-line-modified-added">+         get_axis_deprecated (i, info);</span>
<span class="udiff-line-added">+         return true;</span>
        }
<span class="udiff-line-modified-removed">-     if (index)</span>
<span class="udiff-line-modified-removed">-       *index = HB_OT_VAR_NO_AXIS_INDEX;</span>
<span class="udiff-line-modified-added">+     if (axis_index)</span>
<span class="udiff-line-modified-added">+       *axis_index = HB_OT_VAR_NO_AXIS_INDEX;</span>
      return false;
    }
  
<span class="udiff-line-modified-removed">-   inline int normalize_axis_value (unsigned int axis_index, float v) const</span>
<span class="udiff-line-modified-added">+   bool find_axis_info (hb_tag_t tag,</span>
<span class="udiff-line-added">+                        hb_ot_var_axis_info_t *info) const</span>
    {
<span class="udiff-line-modified-removed">-     hb_ot_var_axis_t axis;</span>
<span class="udiff-line-modified-removed">-     if (!get_axis (axis_index, &amp;axis))</span>
<span class="udiff-line-modified-removed">-       return 0;</span>
<span class="udiff-line-modified-added">+     const AxisRecord *axes = get_axes ();</span>
<span class="udiff-line-modified-added">+     unsigned int count = get_axis_count ();</span>
<span class="udiff-line-modified-added">+     for (unsigned int i = 0; i &lt; count; i++)</span>
<span class="udiff-line-added">+       if (axes[i].axisTag == tag)</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         get_axis_info (i, info);</span>
<span class="udiff-line-added">+         return true;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   int normalize_axis_value (unsigned int axis_index, float v) const</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     hb_ot_var_axis_info_t axis;</span>
<span class="udiff-line-added">+     get_axis_info (axis_index, &amp;axis);</span>
  
      v = MAX (MIN (v, axis.max_value), axis.min_value); /* Clamp. */
  
      if (v == axis.default_value)
        return 0;
      else if (v &lt; axis.default_value)
        v = (v - axis.default_value) / (axis.default_value - axis.min_value);
      else
        v = (v - axis.default_value) / (axis.max_value - axis.default_value);
<span class="udiff-line-modified-removed">-     return (int) (v * 16384. + (v &gt;= 0. ? .5 : -.5));</span>
<span class="udiff-line-modified-added">+     return (int) (v * 16384.f + (v &gt;= 0.f ? .5f : -.5f));</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   unsigned int get_instance_count () const { return instanceCount; }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   hb_ot_name_id_t get_instance_subfamily_name_id (unsigned int instance_index) const</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     const InstanceRecord *instance = get_instance (instance_index);</span>
<span class="udiff-line-added">+     if (unlikely (!instance)) return HB_OT_NAME_ID_INVALID;</span>
<span class="udiff-line-added">+     return instance-&gt;subfamilyNameID;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   hb_ot_name_id_t get_instance_postscript_name_id (unsigned int instance_index) const</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     const InstanceRecord *instance = get_instance (instance_index);</span>
<span class="udiff-line-added">+     if (unlikely (!instance)) return HB_OT_NAME_ID_INVALID;</span>
<span class="udiff-line-added">+     if (instanceSize &gt;= axisCount * 4 + 6)</span>
<span class="udiff-line-added">+       return StructAfter&lt;NameID&gt; (instance-&gt;get_coordinates (axisCount));</span>
<span class="udiff-line-added">+     return HB_OT_NAME_ID_INVALID;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   unsigned int get_instance_coords (unsigned int  instance_index,</span>
<span class="udiff-line-added">+                                            unsigned int *coords_length, /* IN/OUT */</span>
<span class="udiff-line-added">+                                            float        *coords         /* OUT */) const</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     const InstanceRecord *instance = get_instance (instance_index);</span>
<span class="udiff-line-added">+     if (unlikely (!instance))</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       if (coords_length)</span>
<span class="udiff-line-added">+         *coords_length = 0;</span>
<span class="udiff-line-added">+       return 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (coords_length &amp;&amp; *coords_length)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       hb_array_t&lt;const Fixed&gt; instanceCoords = instance-&gt;get_coordinates (axisCount)</span>
<span class="udiff-line-added">+                                                          .sub_array (0, *coords_length);</span>
<span class="udiff-line-added">+       for (unsigned int i = 0; i &lt; instanceCoords.length; i++)</span>
<span class="udiff-line-added">+         coords[i] = instanceCoords.arrayZ[i].to_float ();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return axisCount;</span>
    }
  
    protected:
<span class="udiff-line-modified-removed">-   inline const AxisRecord * get_axes (void) const</span>
<span class="udiff-line-modified-removed">-   { return &amp;StructAtOffset&lt;AxisRecord&gt; (this, things); }</span>
<span class="udiff-line-modified-added">+   hb_array_t&lt;const AxisRecord&gt; get_axes () const</span>
<span class="udiff-line-modified-added">+   { return hb_array (&amp;(this+firstAxis), axisCount); }</span>
  
<span class="udiff-line-modified-removed">-   inline const InstanceRecord * get_instances (void) const</span>
<span class="udiff-line-modified-removed">-   { return &amp;StructAtOffset&lt;InstanceRecord&gt; (get_axes () + axisCount, 0); }</span>
<span class="udiff-line-modified-added">+   const InstanceRecord *get_instance (unsigned int i) const</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-added">+     if (unlikely (i &gt;= instanceCount)) return nullptr;</span>
<span class="udiff-line-added">+    return &amp;StructAtOffset&lt;InstanceRecord&gt; (&amp;StructAfter&lt;InstanceRecord&gt; (get_axes ()),</span>
<span class="udiff-line-added">+                                            i * instanceSize);</span>
<span class="udiff-line-added">+   }</span>
  
    protected:
    FixedVersion&lt;&gt;version;        /* Version of the fvar table
                                   * initially set to 0x00010000u */
<span class="udiff-line-modified-removed">-   Offset16      things;         /* Offset in bytes from the beginning of the table</span>
<span class="udiff-line-modified-added">+   OffsetTo&lt;AxisRecord&gt;</span>
<span class="udiff-line-added">+                 firstAxis;      /* Offset in bytes from the beginning of the table</span>
                                   * to the start of the AxisRecord array. */
    HBUINT16      reserved;       /* This field is permanently reserved. Set to 2. */
    HBUINT16      axisCount;      /* The number of variation axes in the font (the
                                   * number of records in the axes array). */
    HBUINT16      axisSize;       /* The size in bytes of each VariationAxisRecord —
</pre>
<center><a href="hb-ot-var-avar-table.hh.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-var-hvar-table.hh.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>