<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-face.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-dsalgs.hh.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-face.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-face.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,66 ***</span>
   *
   * Red Hat Author(s): Behdad Esfahbod
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="line-modified">! #include &quot;hb-private.hh&quot;</span>
  
<span class="line-modified">! #include &quot;hb-face-private.hh&quot;</span>
<span class="line-modified">! #include &quot;hb-blob-private.hh&quot;</span>
<span class="line-modified">! #include &quot;hb-open-file-private.hh&quot;</span>
<span class="line-modified">! #include &quot;hb-ot-head-table.hh&quot;</span>
<span class="line-modified">! #include &quot;hb-ot-maxp-table.hh&quot;</span>
  
  
  
  /**
<span class="line-modified">!  * hb_face_count: Get number of faces on the blob</span>
<span class="line-modified">!  * @blob:</span>
   *
   *
<span class="line-modified">!  *</span>
<span class="line-removed">-  * Return value: Number of faces on the blob</span>
   *
   * Since: 1.7.7
   **/
  unsigned int
  hb_face_count (hb_blob_t *blob)
  {
    if (unlikely (!blob))
      return 0;
  
<span class="line-modified">!   hb_blob_t *sanitized = OT::Sanitizer&lt;OT::OpenTypeFontFile&gt; ().sanitize (blob);</span>
    const OT::OpenTypeFontFile&amp; ot = *sanitized-&gt;as&lt;OT::OpenTypeFontFile&gt; ();
  
<span class="line-modified">!   return ot.get_face_count ();</span>
  }
  
  /*
   * hb_face_t
   */
  
<span class="line-modified">! const hb_face_t _hb_face_nil = {</span>
    HB_OBJECT_HEADER_STATIC,
  
<span class="line-removed">-   true, /* immutable */</span>
<span class="line-removed">- </span>
    nullptr, /* reference_table_func */
    nullptr, /* user_data */
    nullptr, /* destroy */
  
    0,    /* index */
<span class="line-modified">!   1000, /* upem */</span>
<span class="line-modified">!   0,    /* num_glyphs */</span>
  
<span class="line-modified">!   {</span>
<span class="line-removed">- #define HB_SHAPER_IMPLEMENT(shaper) HB_SHAPER_DATA_INVALID,</span>
<span class="line-removed">- #include &quot;hb-shaper-list.hh&quot;</span>
<span class="line-removed">- #undef HB_SHAPER_IMPLEMENT</span>
<span class="line-removed">-   },</span>
<span class="line-removed">- </span>
<span class="line-removed">-   nullptr, /* shape_plans */</span>
  };
  
  
  /**
   * hb_face_create_for_tables:
<span class="line-new-header">--- 24,75 ---</span>
   *
   * Red Hat Author(s): Behdad Esfahbod
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="line-modified">! #include &quot;hb.hh&quot;</span>
  
<span class="line-modified">! #include &quot;hb-face.hh&quot;</span>
<span class="line-modified">! #include &quot;hb-blob.hh&quot;</span>
<span class="line-modified">! #include &quot;hb-open-file.hh&quot;</span>
<span class="line-modified">! #include &quot;hb-ot-face.hh&quot;</span>
<span class="line-modified">! #include &quot;hb-ot-cmap-table.hh&quot;</span>
  
  
<span class="line-added">+ /**</span>
<span class="line-added">+  * SECTION:hb-face</span>
<span class="line-added">+  * @title: hb-face</span>
<span class="line-added">+  * @short_description: Font face objects</span>
<span class="line-added">+  * @include: hb.h</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Font face is objects represent a single face in a font family.</span>
<span class="line-added">+  * More exactly, a font face represents a single face in a binary font file.</span>
<span class="line-added">+  * Font faces are typically built from a binary blob and a face index.</span>
<span class="line-added">+  * Font faces are used to create fonts.</span>
<span class="line-added">+  **/</span>
<span class="line-added">+ </span>
  
  /**
<span class="line-modified">!  * hb_face_count:</span>
<span class="line-modified">!  * @blob: a blob.</span>
   *
<span class="line-added">+  * Get number of faces in a blob.</span>
   *
<span class="line-modified">!  * Return value: Number of faces in @blob</span>
   *
   * Since: 1.7.7
   **/
  unsigned int
  hb_face_count (hb_blob_t *blob)
  {
    if (unlikely (!blob))
      return 0;
  
<span class="line-modified">!   /* TODO We shouldn&#39;t be sanitizing blob.  Port to run sanitizer and return if not sane. */</span>
<span class="line-added">+   /* Make API signature const after. */</span>
<span class="line-added">+   hb_blob_t *sanitized = hb_sanitize_context_t ().sanitize_blob&lt;OT::OpenTypeFontFile&gt; (hb_blob_reference (blob));</span>
    const OT::OpenTypeFontFile&amp; ot = *sanitized-&gt;as&lt;OT::OpenTypeFontFile&gt; ();
<span class="line-added">+   unsigned int ret = ot.get_face_count ();</span>
<span class="line-added">+   hb_blob_destroy (sanitized);</span>
  
<span class="line-modified">!   return ret;</span>
  }
  
  /*
   * hb_face_t
   */
  
<span class="line-modified">! DEFINE_NULL_INSTANCE (hb_face_t) =</span>
<span class="line-added">+ {</span>
    HB_OBJECT_HEADER_STATIC,
  
    nullptr, /* reference_table_func */
    nullptr, /* user_data */
    nullptr, /* destroy */
  
    0,    /* index */
<span class="line-modified">!   HB_ATOMIC_INT_INIT (1000), /* upem */</span>
<span class="line-modified">!   HB_ATOMIC_INT_INIT (0),    /* num_glyphs */</span>
  
<span class="line-modified">!   /* Zero for the rest is fine. */</span>
  };
  
  
  /**
   * hb_face_create_for_tables:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 112,12 ***</span>
  
    face-&gt;reference_table_func = reference_table_func;
    face-&gt;user_data = user_data;
    face-&gt;destroy = destroy;
  
<span class="line-modified">!   face-&gt;upem = 0;</span>
<span class="line-modified">!   face-&gt;num_glyphs = (unsigned int) -1;</span>
  
    return face;
  }
  
  
<span class="line-new-header">--- 121,14 ---</span>
  
    face-&gt;reference_table_func = reference_table_func;
    face-&gt;user_data = user_data;
    face-&gt;destroy = destroy;
  
<span class="line-modified">!   face-&gt;num_glyphs.set_relaxed (-1);</span>
<span class="line-modified">! </span>
<span class="line-added">+   face-&gt;data.init0 (face);</span>
<span class="line-added">+   face-&gt;table.init0 (face);</span>
  
    return face;
  }
  
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 157,15 ***</span>
  
    if (tag == HB_TAG_NONE)
      return hb_blob_reference (data-&gt;blob);
  
    const OT::OpenTypeFontFile &amp;ot_file = *data-&gt;blob-&gt;as&lt;OT::OpenTypeFontFile&gt; ();
<span class="line-modified">!   const OT::OpenTypeFontFace &amp;ot_face = ot_file.get_face (data-&gt;index);</span>
  
    const OT::OpenTypeTable &amp;table = ot_face.get_table_by_tag (tag);
  
<span class="line-modified">!   hb_blob_t *blob = hb_blob_create_sub_blob (data-&gt;blob, table.offset, table.length);</span>
  
    return blob;
  }
  
  /**
<span class="line-new-header">--- 168,16 ---</span>
  
    if (tag == HB_TAG_NONE)
      return hb_blob_reference (data-&gt;blob);
  
    const OT::OpenTypeFontFile &amp;ot_file = *data-&gt;blob-&gt;as&lt;OT::OpenTypeFontFile&gt; ();
<span class="line-modified">!   unsigned int base_offset;</span>
<span class="line-added">+   const OT::OpenTypeFontFace &amp;ot_face = ot_file.get_face (data-&gt;index, &amp;base_offset);</span>
  
    const OT::OpenTypeTable &amp;table = ot_face.get_table_by_tag (tag);
  
<span class="line-modified">!   hb_blob_t *blob = hb_blob_create_sub_blob (data-&gt;blob, base_offset + table.offset, table.length);</span>
  
    return blob;
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 186,11 ***</span>
    hb_face_t *face;
  
    if (unlikely (!blob))
      blob = hb_blob_get_empty ();
  
<span class="line-modified">!   hb_face_for_data_closure_t *closure = _hb_face_for_data_closure_create (OT::Sanitizer&lt;OT::OpenTypeFontFile&gt;().sanitize (hb_blob_reference (blob)), index);</span>
  
    if (unlikely (!closure))
      return hb_face_get_empty ();
  
    face = hb_face_create_for_tables (_hb_face_for_data_reference_table,
<span class="line-new-header">--- 198,11 ---</span>
    hb_face_t *face;
  
    if (unlikely (!blob))
      blob = hb_blob_get_empty ();
  
<span class="line-modified">!   hb_face_for_data_closure_t *closure = _hb_face_for_data_closure_create (hb_sanitize_context_t ().sanitize_blob&lt;OT::OpenTypeFontFile&gt; (hb_blob_reference (blob)), index);</span>
  
    if (unlikely (!closure))
      return hb_face_get_empty ();
  
    face = hb_face_create_for_tables (_hb_face_for_data_reference_table,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 210,13 ***</span>
   * Return value: (transfer full)
   *
   * Since: 0.9.2
   **/
  hb_face_t *
<span class="line-modified">! hb_face_get_empty (void)</span>
  {
<span class="line-modified">!   return const_cast&lt;hb_face_t *&gt; (&amp;_hb_face_nil);</span>
  }
  
  
  /**
   * hb_face_reference: (skip)
<span class="line-new-header">--- 222,13 ---</span>
   * Return value: (transfer full)
   *
   * Since: 0.9.2
   **/
  hb_face_t *
<span class="line-modified">! hb_face_get_empty ()</span>
  {
<span class="line-modified">!   return const_cast&lt;hb_face_t *&gt; (&amp;Null(hb_face_t));</span>
  }
  
  
  /**
   * hb_face_reference: (skip)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 253,13 ***</span>
      hb_shape_plan_destroy (node-&gt;shape_plan);
      free (node);
      node = next;
    }
  
<span class="line-modified">! #define HB_SHAPER_IMPLEMENT(shaper) HB_SHAPER_DATA_DESTROY(shaper, face);</span>
<span class="line-modified">! #include &quot;hb-shaper-list.hh&quot;</span>
<span class="line-removed">- #undef HB_SHAPER_IMPLEMENT</span>
  
    if (face-&gt;destroy)
      face-&gt;destroy (face-&gt;user_data);
  
    free (face);
<span class="line-new-header">--- 265,12 ---</span>
      hb_shape_plan_destroy (node-&gt;shape_plan);
      free (node);
      node = next;
    }
  
<span class="line-modified">!   face-&gt;data.fini ();</span>
<span class="line-modified">!   face-&gt;table.fini ();</span>
  
    if (face-&gt;destroy)
      face-&gt;destroy (face-&gt;user_data);
  
    free (face);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 299,11 ***</span>
   * Return value: (transfer none):
   *
   * Since: 0.9.2
   **/
  void *
<span class="line-modified">! hb_face_get_user_data (hb_face_t          *face,</span>
                         hb_user_data_key_t *key)
  {
    return hb_object_get_user_data (face, key);
  }
  
<span class="line-new-header">--- 310,11 ---</span>
   * Return value: (transfer none):
   *
   * Since: 0.9.2
   **/
  void *
<span class="line-modified">! hb_face_get_user_data (const hb_face_t    *face,</span>
                         hb_user_data_key_t *key)
  {
    return hb_object_get_user_data (face, key);
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 316,14 ***</span>
   * Since: 0.9.2
   **/
  void
  hb_face_make_immutable (hb_face_t *face)
  {
<span class="line-modified">!   if (unlikely (hb_object_is_inert (face)))</span>
      return;
  
<span class="line-modified">!   face-&gt;immutable = true;</span>
  }
  
  /**
   * hb_face_is_immutable:
   * @face: a face.
<span class="line-new-header">--- 327,14 ---</span>
   * Since: 0.9.2
   **/
  void
  hb_face_make_immutable (hb_face_t *face)
  {
<span class="line-modified">!   if (hb_object_is_immutable (face))</span>
      return;
  
<span class="line-modified">!   hb_object_make_immutable (face);</span>
  }
  
  /**
   * hb_face_is_immutable:
   * @face: a face.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 333,13 ***</span>
   * Return value:
   *
   * Since: 0.9.2
   **/
  hb_bool_t
<span class="line-modified">! hb_face_is_immutable (hb_face_t *face)</span>
  {
<span class="line-modified">!   return face-&gt;immutable;</span>
  }
  
  
  /**
   * hb_face_reference_table:
<span class="line-new-header">--- 344,13 ---</span>
   * Return value:
   *
   * Since: 0.9.2
   **/
  hb_bool_t
<span class="line-modified">! hb_face_is_immutable (const hb_face_t *face)</span>
  {
<span class="line-modified">!   return hb_object_is_immutable (face);</span>
  }
  
  
  /**
   * hb_face_reference_table:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 351,12 ***</span>
   * Return value: (transfer full):
   *
   * Since: 0.9.2
   **/
  hb_blob_t *
<span class="line-modified">! hb_face_reference_table (hb_face_t *face,</span>
<span class="line-modified">!                          hb_tag_t   tag)</span>
  {
    return face-&gt;reference_table (tag);
  }
  
  /**
<span class="line-new-header">--- 362,12 ---</span>
   * Return value: (transfer full):
   *
   * Since: 0.9.2
   **/
  hb_blob_t *
<span class="line-modified">! hb_face_reference_table (const hb_face_t *face,</span>
<span class="line-modified">!                          hb_tag_t tag)</span>
  {
    return face-&gt;reference_table (tag);
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 386,11 ***</span>
   **/
  void
  hb_face_set_index (hb_face_t    *face,
                     unsigned int  index)
  {
<span class="line-modified">!   if (face-&gt;immutable)</span>
      return;
  
    face-&gt;index = index;
  }
  
<span class="line-new-header">--- 397,11 ---</span>
   **/
  void
  hb_face_set_index (hb_face_t    *face,
                     unsigned int  index)
  {
<span class="line-modified">!   if (hb_object_is_immutable (face))</span>
      return;
  
    face-&gt;index = index;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 403,11 ***</span>
   * Return value:
   *
   * Since: 0.9.2
   **/
  unsigned int
<span class="line-modified">! hb_face_get_index (hb_face_t    *face)</span>
  {
    return face-&gt;index;
  }
  
  /**
<span class="line-new-header">--- 414,11 ---</span>
   * Return value:
   *
   * Since: 0.9.2
   **/
  unsigned int
<span class="line-modified">! hb_face_get_index (const hb_face_t *face)</span>
  {
    return face-&gt;index;
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 421,14 ***</span>
   **/
  void
  hb_face_set_upem (hb_face_t    *face,
                    unsigned int  upem)
  {
<span class="line-modified">!   if (face-&gt;immutable)</span>
      return;
  
<span class="line-modified">!   face-&gt;upem = upem;</span>
  }
  
  /**
   * hb_face_get_upem:
   * @face: a face.
<span class="line-new-header">--- 432,14 ---</span>
   **/
  void
  hb_face_set_upem (hb_face_t    *face,
                    unsigned int  upem)
  {
<span class="line-modified">!   if (hb_object_is_immutable (face))</span>
      return;
  
<span class="line-modified">!   face-&gt;upem.set_relaxed (upem);</span>
  }
  
  /**
   * hb_face_get_upem:
   * @face: a face.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 438,24 ***</span>
   * Return value:
   *
   * Since: 0.9.2
   **/
  unsigned int
<span class="line-modified">! hb_face_get_upem (hb_face_t *face)</span>
  {
    return face-&gt;get_upem ();
  }
  
<span class="line-removed">- void</span>
<span class="line-removed">- hb_face_t::load_upem (void) const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-   hb_blob_t *head_blob = OT::Sanitizer&lt;OT::head&gt;().sanitize (reference_table (HB_OT_TAG_head));</span>
<span class="line-removed">-   const OT::head *head_table = head_blob-&gt;as&lt;OT::head&gt; ();</span>
<span class="line-removed">-   upem = head_table-&gt;get_upem ();</span>
<span class="line-removed">-   hb_blob_destroy (head_blob);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  /**
   * hb_face_set_glyph_count:
   * @face: a face.
   * @glyph_count:
   *
<span class="line-new-header">--- 449,15 ---</span>
   * Return value:
   *
   * Since: 0.9.2
   **/
  unsigned int
<span class="line-modified">! hb_face_get_upem (const hb_face_t *face)</span>
  {
    return face-&gt;get_upem ();
  }
  
  /**
   * hb_face_set_glyph_count:
   * @face: a face.
   * @glyph_count:
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 465,14 ***</span>
   **/
  void
  hb_face_set_glyph_count (hb_face_t    *face,
                           unsigned int  glyph_count)
  {
<span class="line-modified">!   if (face-&gt;immutable)</span>
      return;
  
<span class="line-modified">!   face-&gt;num_glyphs = glyph_count;</span>
  }
  
  /**
   * hb_face_get_glyph_count:
   * @face: a face.
<span class="line-new-header">--- 467,14 ---</span>
   **/
  void
  hb_face_set_glyph_count (hb_face_t    *face,
                           unsigned int  glyph_count)
  {
<span class="line-modified">!   if (hb_object_is_immutable (face))</span>
      return;
  
<span class="line-modified">!   face-&gt;num_glyphs.set_relaxed (glyph_count);</span>
  }
  
  /**
   * hb_face_get_glyph_count:
   * @face: a face.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 482,36 ***</span>
   * Return value:
   *
   * Since: 0.9.7
   **/
  unsigned int
<span class="line-modified">! hb_face_get_glyph_count (hb_face_t *face)</span>
  {
    return face-&gt;get_num_glyphs ();
  }
  
<span class="line-removed">- void</span>
<span class="line-removed">- hb_face_t::load_num_glyphs (void) const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-   hb_blob_t *maxp_blob = OT::Sanitizer&lt;OT::maxp&gt;().sanitize (reference_table (HB_OT_TAG_maxp));</span>
<span class="line-removed">-   const OT::maxp *maxp_table = maxp_blob-&gt;as&lt;OT::maxp&gt; ();</span>
<span class="line-removed">-   num_glyphs = maxp_table-&gt;get_num_glyphs ();</span>
<span class="line-removed">-   hb_blob_destroy (maxp_blob);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  /**
   * hb_face_get_table_tags:
   * @face: a face.
   *
   * Retrieves table tags for a face, if possible.
   *
   * Return value: total number of tables, or 0 if not possible to list.
   *
   * Since: 1.6.0
   **/
  unsigned int
<span class="line-modified">! hb_face_get_table_tags (hb_face_t    *face,</span>
                          unsigned int  start_offset,
                          unsigned int *table_count, /* IN/OUT */
                          hb_tag_t     *table_tags /* OUT */)
  {
    if (face-&gt;destroy != (hb_destroy_func_t) _hb_face_for_data_closure_destroy)
<span class="line-new-header">--- 484,30 ---</span>
   * Return value:
   *
   * Since: 0.9.7
   **/
  unsigned int
<span class="line-modified">! hb_face_get_glyph_count (const hb_face_t *face)</span>
  {
    return face-&gt;get_num_glyphs ();
  }
  
  /**
   * hb_face_get_table_tags:
   * @face: a face.
<span class="line-added">+  * @start_offset: index of first tag to return.</span>
<span class="line-added">+  * @table_count: input length of @table_tags array, output number of items written.</span>
<span class="line-added">+  * @table_tags: array to write tags into.</span>
   *
   * Retrieves table tags for a face, if possible.
   *
   * Return value: total number of tables, or 0 if not possible to list.
   *
   * Since: 1.6.0
   **/
  unsigned int
<span class="line-modified">! hb_face_get_table_tags (const hb_face_t *face,</span>
                          unsigned int  start_offset,
                          unsigned int *table_count, /* IN/OUT */
                          hb_tag_t     *table_tags /* OUT */)
  {
    if (face-&gt;destroy != (hb_destroy_func_t) _hb_face_for_data_closure_destroy)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 526,5 ***</span>
<span class="line-new-header">--- 522,202 ---</span>
    const OT::OpenTypeFontFile &amp;ot_file = *data-&gt;blob-&gt;as&lt;OT::OpenTypeFontFile&gt; ();
    const OT::OpenTypeFontFace &amp;ot_face = ot_file.get_face (data-&gt;index);
  
    return ot_face.get_table_tags (start_offset, table_count, table_tags);
  }
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ /*</span>
<span class="line-added">+  * Character set.</span>
<span class="line-added">+  */</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ /**</span>
<span class="line-added">+  * hb_face_collect_unicodes:</span>
<span class="line-added">+  * @face: font face.</span>
<span class="line-added">+  * @out: set to add Unicode characters covered by @face to.</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Since: 1.9.0</span>
<span class="line-added">+  */</span>
<span class="line-added">+ void</span>
<span class="line-added">+ hb_face_collect_unicodes (hb_face_t *face,</span>
<span class="line-added">+                           hb_set_t  *out)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   face-&gt;table.cmap-&gt;collect_unicodes (out);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ /**</span>
<span class="line-added">+  * hb_face_collect_variation_selectors:</span>
<span class="line-added">+  * @face: font face.</span>
<span class="line-added">+  * @out: set to add Variation Selector characters covered by @face to.</span>
<span class="line-added">+  *</span>
<span class="line-added">+  *</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Since: 1.9.0</span>
<span class="line-added">+  */</span>
<span class="line-added">+ void</span>
<span class="line-added">+ hb_face_collect_variation_selectors (hb_face_t *face,</span>
<span class="line-added">+                                      hb_set_t  *out)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   face-&gt;table.cmap-&gt;collect_variation_selectors (out);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ /**</span>
<span class="line-added">+  * hb_face_collect_variation_unicodes:</span>
<span class="line-added">+  * @face: font face.</span>
<span class="line-added">+  * @out: set to add Unicode characters for @variation_selector covered by @face to.</span>
<span class="line-added">+  *</span>
<span class="line-added">+  *</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Since: 1.9.0</span>
<span class="line-added">+  */</span>
<span class="line-added">+ void</span>
<span class="line-added">+ hb_face_collect_variation_unicodes (hb_face_t *face,</span>
<span class="line-added">+                                     hb_codepoint_t variation_selector,</span>
<span class="line-added">+                                     hb_set_t  *out)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   face-&gt;table.cmap-&gt;collect_variation_unicodes (variation_selector, out);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ /*</span>
<span class="line-added">+  * face-builder: A face that has add_table().</span>
<span class="line-added">+  */</span>
<span class="line-added">+ </span>
<span class="line-added">+ struct hb_face_builder_data_t</span>
<span class="line-added">+ {</span>
<span class="line-added">+   struct table_entry_t</span>
<span class="line-added">+   {</span>
<span class="line-added">+     int cmp (hb_tag_t t) const</span>
<span class="line-added">+     {</span>
<span class="line-added">+       if (t &lt; tag) return -1;</span>
<span class="line-added">+       if (t &gt; tag) return -1;</span>
<span class="line-added">+       return 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     hb_tag_t   tag;</span>
<span class="line-added">+     hb_blob_t *blob;</span>
<span class="line-added">+   };</span>
<span class="line-added">+ </span>
<span class="line-added">+   hb_vector_t&lt;table_entry_t&gt; tables;</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ static hb_face_builder_data_t *</span>
<span class="line-added">+ _hb_face_builder_data_create ()</span>
<span class="line-added">+ {</span>
<span class="line-added">+   hb_face_builder_data_t *data = (hb_face_builder_data_t *) calloc (1, sizeof (hb_face_builder_data_t));</span>
<span class="line-added">+   if (unlikely (!data))</span>
<span class="line-added">+     return nullptr;</span>
<span class="line-added">+ </span>
<span class="line-added">+   data-&gt;tables.init ();</span>
<span class="line-added">+ </span>
<span class="line-added">+   return data;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static void</span>
<span class="line-added">+ _hb_face_builder_data_destroy (void *user_data)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   hb_face_builder_data_t *data = (hb_face_builder_data_t *) user_data;</span>
<span class="line-added">+ </span>
<span class="line-added">+   for (unsigned int i = 0; i &lt; data-&gt;tables.length; i++)</span>
<span class="line-added">+     hb_blob_destroy (data-&gt;tables[i].blob);</span>
<span class="line-added">+ </span>
<span class="line-added">+   data-&gt;tables.fini ();</span>
<span class="line-added">+ </span>
<span class="line-added">+   free (data);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static hb_blob_t *</span>
<span class="line-added">+ _hb_face_builder_data_reference_blob (hb_face_builder_data_t *data)</span>
<span class="line-added">+ {</span>
<span class="line-added">+ </span>
<span class="line-added">+   unsigned int table_count = data-&gt;tables.length;</span>
<span class="line-added">+   unsigned int face_length = table_count * 16 + 12;</span>
<span class="line-added">+ </span>
<span class="line-added">+   for (unsigned int i = 0; i &lt; table_count; i++)</span>
<span class="line-added">+     face_length += hb_ceil_to_4 (hb_blob_get_length (data-&gt;tables[i].blob));</span>
<span class="line-added">+ </span>
<span class="line-added">+   char *buf = (char *) malloc (face_length);</span>
<span class="line-added">+   if (unlikely (!buf))</span>
<span class="line-added">+     return nullptr;</span>
<span class="line-added">+ </span>
<span class="line-added">+   hb_serialize_context_t c (buf, face_length);</span>
<span class="line-added">+   c.propagate_error (data-&gt;tables);</span>
<span class="line-added">+   OT::OpenTypeFontFile *f = c.start_serialize&lt;OT::OpenTypeFontFile&gt; ();</span>
<span class="line-added">+ </span>
<span class="line-added">+   bool is_cff = data-&gt;tables.lsearch (HB_TAG (&#39;C&#39;,&#39;F&#39;,&#39;F&#39;,&#39; &#39;)) || data-&gt;tables.lsearch (HB_TAG (&#39;C&#39;,&#39;F&#39;,&#39;F&#39;,&#39;2&#39;));</span>
<span class="line-added">+   hb_tag_t sfnt_tag = is_cff ? OT::OpenTypeFontFile::CFFTag : OT::OpenTypeFontFile::TrueTypeTag;</span>
<span class="line-added">+ </span>
<span class="line-added">+   bool ret = f-&gt;serialize_single (&amp;c, sfnt_tag, data-&gt;tables.as_array ());</span>
<span class="line-added">+ </span>
<span class="line-added">+   c.end_serialize ();</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (unlikely (!ret))</span>
<span class="line-added">+   {</span>
<span class="line-added">+     free (buf);</span>
<span class="line-added">+     return nullptr;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   return hb_blob_create (buf, face_length, HB_MEMORY_MODE_WRITABLE, buf, free);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static hb_blob_t *</span>
<span class="line-added">+ _hb_face_builder_reference_table (hb_face_t *face HB_UNUSED, hb_tag_t tag, void *user_data)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   hb_face_builder_data_t *data = (hb_face_builder_data_t *) user_data;</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (!tag)</span>
<span class="line-added">+     return _hb_face_builder_data_reference_blob (data);</span>
<span class="line-added">+ </span>
<span class="line-added">+   hb_face_builder_data_t::table_entry_t *entry = data-&gt;tables.lsearch (tag);</span>
<span class="line-added">+   if (entry)</span>
<span class="line-added">+     return hb_blob_reference (entry-&gt;blob);</span>
<span class="line-added">+ </span>
<span class="line-added">+   return nullptr;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ /**</span>
<span class="line-added">+  * hb_face_builder_create:</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Creates a #hb_face_t that can be used with hb_face_builder_add_table().</span>
<span class="line-added">+  * After tables are added to the face, it can be compiled to a binary</span>
<span class="line-added">+  * font file by calling hb_face_reference_blob().</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Return value: (transfer full): New face.</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Since: 1.9.0</span>
<span class="line-added">+  **/</span>
<span class="line-added">+ hb_face_t *</span>
<span class="line-added">+ hb_face_builder_create ()</span>
<span class="line-added">+ {</span>
<span class="line-added">+   hb_face_builder_data_t *data = _hb_face_builder_data_create ();</span>
<span class="line-added">+   if (unlikely (!data)) return hb_face_get_empty ();</span>
<span class="line-added">+ </span>
<span class="line-added">+   return hb_face_create_for_tables (_hb_face_builder_reference_table,</span>
<span class="line-added">+                                     data,</span>
<span class="line-added">+                                     _hb_face_builder_data_destroy);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ /**</span>
<span class="line-added">+  * hb_face_builder_add_table:</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Add table for @tag with data provided by @blob to the face.  @face must</span>
<span class="line-added">+  * be created using hb_face_builder_create().</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Since: 1.9.0</span>
<span class="line-added">+  **/</span>
<span class="line-added">+ hb_bool_t</span>
<span class="line-added">+ hb_face_builder_add_table (hb_face_t *face, hb_tag_t tag, hb_blob_t *blob)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   if (unlikely (face-&gt;destroy != (hb_destroy_func_t) _hb_face_builder_data_destroy))</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+   hb_face_builder_data_t *data = (hb_face_builder_data_t *) face-&gt;user_data;</span>
<span class="line-added">+   hb_face_builder_data_t::table_entry_t *entry = data-&gt;tables.push ();</span>
<span class="line-added">+ </span>
<span class="line-added">+   entry-&gt;tag = tag;</span>
<span class="line-added">+   entry-&gt;blob = hb_blob_reference (blob);</span>
<span class="line-added">+ </span>
<span class="line-added">+   return true;</span>
<span class="line-added">+ }</span>
</pre>
<center><a href="hb-dsalgs.hh.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-face.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>