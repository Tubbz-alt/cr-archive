<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-font.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-color-svg-table.hh.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-glyf-table.hh.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-font.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod, Roozbeh Pournader
 25  */
 26 
<span class="line-modified"> 27 #include &quot;hb-private.hh&quot;</span>
 28 
 29 #include &quot;hb-ot.h&quot;
 30 
<span class="line-modified"> 31 #include &quot;hb-font-private.hh&quot;</span>


 32 
 33 #include &quot;hb-ot-cmap-table.hh&quot;
 34 #include &quot;hb-ot-glyf-table.hh&quot;


 35 #include &quot;hb-ot-hmtx-table.hh&quot;
 36 #include &quot;hb-ot-kern-table.hh&quot;

 37 #include &quot;hb-ot-post-table.hh&quot;
<span class="line-modified"> 38 </span>

 39 #include &quot;hb-ot-color-cbdt-table.hh&quot;

 40 
 41 
<span class="line-modified"> 42 struct hb_ot_font_t</span>
<span class="line-modified"> 43 {</span>
<span class="line-modified"> 44   OT::cmap::accelerator_t cmap;</span>
<span class="line-modified"> 45   OT::hmtx::accelerator_t h_metrics;</span>
<span class="line-modified"> 46   OT::vmtx::accelerator_t v_metrics;</span>
<span class="line-modified"> 47   OT::hb_lazy_loader_t&lt;OT::glyf::accelerator_t&gt; glyf;</span>
<span class="line-modified"> 48   OT::hb_lazy_loader_t&lt;OT::CBDT::accelerator_t&gt; cbdt;</span>
<span class="line-modified"> 49   OT::hb_lazy_loader_t&lt;OT::post::accelerator_t&gt; post;</span>
<span class="line-modified"> 50   OT::hb_lazy_loader_t&lt;OT::kern::accelerator_t&gt; kern;</span>
<span class="line-modified"> 51 };</span>
<span class="line-removed"> 52 </span>
<span class="line-removed"> 53 </span>
<span class="line-removed"> 54 static hb_ot_font_t *</span>
<span class="line-removed"> 55 _hb_ot_font_create (hb_face_t *face)</span>
<span class="line-removed"> 56 {</span>
<span class="line-removed"> 57   hb_ot_font_t *ot_font = (hb_ot_font_t *) calloc (1, sizeof (hb_ot_font_t));</span>
<span class="line-removed"> 58 </span>
<span class="line-removed"> 59   if (unlikely (!ot_font))</span>
<span class="line-removed"> 60     return nullptr;</span>
<span class="line-removed"> 61 </span>
<span class="line-removed"> 62   ot_font-&gt;cmap.init (face);</span>
<span class="line-removed"> 63   ot_font-&gt;h_metrics.init (face);</span>
<span class="line-removed"> 64   ot_font-&gt;v_metrics.init (face, ot_font-&gt;h_metrics.ascender - ot_font-&gt;h_metrics.descender); /* TODO Can we do this lazily? */</span>
<span class="line-removed"> 65   ot_font-&gt;glyf.init (face);</span>
<span class="line-removed"> 66   ot_font-&gt;cbdt.init (face);</span>
<span class="line-removed"> 67   ot_font-&gt;post.init (face);</span>
<span class="line-removed"> 68   ot_font-&gt;kern.init (face);</span>
<span class="line-removed"> 69 </span>
<span class="line-removed"> 70   return ot_font;</span>
<span class="line-removed"> 71 }</span>
<span class="line-removed"> 72 </span>
<span class="line-removed"> 73 static void</span>
<span class="line-removed"> 74 _hb_ot_font_destroy (void *data)</span>
<span class="line-removed"> 75 {</span>
<span class="line-removed"> 76   hb_ot_font_t *ot_font = (hb_ot_font_t *) data;</span>
<span class="line-removed"> 77 </span>
<span class="line-removed"> 78   ot_font-&gt;cmap.fini ();</span>
<span class="line-removed"> 79   ot_font-&gt;h_metrics.fini ();</span>
<span class="line-removed"> 80   ot_font-&gt;v_metrics.fini ();</span>
<span class="line-removed"> 81   ot_font-&gt;glyf.fini ();</span>
<span class="line-removed"> 82   ot_font-&gt;cbdt.fini ();</span>
<span class="line-removed"> 83   ot_font-&gt;post.fini ();</span>
<span class="line-removed"> 84   ot_font-&gt;kern.fini ();</span>
<span class="line-removed"> 85 </span>
<span class="line-removed"> 86   free (ot_font);</span>
<span class="line-removed"> 87 }</span>
 88 
 89 
 90 static hb_bool_t
 91 hb_ot_get_nominal_glyph (hb_font_t *font HB_UNUSED,
 92                          void *font_data,
 93                          hb_codepoint_t unicode,
 94                          hb_codepoint_t *glyph,
 95                          void *user_data HB_UNUSED)




 96 









 97 {
<span class="line-modified"> 98   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified"> 99   return ot_font-&gt;cmap.get_nominal_glyph (unicode, glyph);</span>


100 }
101 
102 static hb_bool_t
103 hb_ot_get_variation_glyph (hb_font_t *font HB_UNUSED,
104                            void *font_data,
105                            hb_codepoint_t unicode,
106                            hb_codepoint_t variation_selector,
107                            hb_codepoint_t *glyph,
108                            void *user_data HB_UNUSED)
109 {
<span class="line-modified">110   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">111   return ot_font-&gt;cmap.get_variation_glyph (unicode, variation_selector, glyph);</span>
112 }
113 
<span class="line-modified">114 static hb_position_t</span>
<span class="line-modified">115 hb_ot_get_glyph_h_advance (hb_font_t *font,</span>
<span class="line-modified">116                            void *font_data,</span>
<span class="line-modified">117                            hb_codepoint_t glyph,</span>
<span class="line-modified">118                            void *user_data HB_UNUSED)</span>



119 {
<span class="line-modified">120   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">121   return font-&gt;em_scale_x (ot_font-&gt;h_metrics.get_advance (glyph, font));</span>







122 }
123 
<span class="line-modified">124 static hb_position_t</span>
<span class="line-modified">125 hb_ot_get_glyph_v_advance (hb_font_t *font,</span>
<span class="line-modified">126                            void *font_data,</span>
<span class="line-modified">127                            hb_codepoint_t glyph,</span>
<span class="line-modified">128                            void *user_data HB_UNUSED)</span>



129 {
<span class="line-modified">130   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">131   return font-&gt;em_scale_y (-(int) ot_font-&gt;v_metrics.get_advance (glyph, font));</span>







132 }
133 
<span class="line-modified">134 static hb_position_t</span>
<span class="line-modified">135 hb_ot_get_glyph_h_kerning (hb_font_t *font,</span>
<span class="line-modified">136                            void *font_data,</span>
<span class="line-modified">137                            hb_codepoint_t left_glyph,</span>
<span class="line-modified">138                            hb_codepoint_t right_glyph,</span>
<span class="line-modified">139                            void *user_data HB_UNUSED)</span>

140 {
<span class="line-modified">141   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">142   return font-&gt;em_scale_x (ot_font-&gt;kern-&gt;get_h_kerning (left_glyph, right_glyph));</span>























143 }
144 
145 static hb_bool_t
146 hb_ot_get_glyph_extents (hb_font_t *font,
147                          void *font_data,
148                          hb_codepoint_t glyph,
149                          hb_glyph_extents_t *extents,
150                          void *user_data HB_UNUSED)
151 {
<span class="line-modified">152   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">153   bool ret = ot_font-&gt;glyf-&gt;get_extents (glyph, extents);</span>






154   if (!ret)
<span class="line-modified">155     ret = ot_font-&gt;cbdt-&gt;get_extents (glyph, extents);</span>
156   // TODO Hook up side-bearings variations.
157   extents-&gt;x_bearing = font-&gt;em_scale_x (extents-&gt;x_bearing);
158   extents-&gt;y_bearing = font-&gt;em_scale_y (extents-&gt;y_bearing);
159   extents-&gt;width     = font-&gt;em_scale_x (extents-&gt;width);
160   extents-&gt;height    = font-&gt;em_scale_y (extents-&gt;height);
161   return ret;
162 }
163 
164 static hb_bool_t
165 hb_ot_get_glyph_name (hb_font_t *font HB_UNUSED,
166                       void *font_data,
167                       hb_codepoint_t glyph,
168                       char *name, unsigned int size,
169                       void *user_data HB_UNUSED)
170 {
<span class="line-modified">171   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">172   return ot_font-&gt;post-&gt;get_glyph_name (glyph, name, size);</span>
173 }
174 
175 static hb_bool_t
176 hb_ot_get_glyph_from_name (hb_font_t *font HB_UNUSED,
177                            void *font_data,
178                            const char *name, int len,
179                            hb_codepoint_t *glyph,
180                            void *user_data HB_UNUSED)
181 {
<span class="line-modified">182   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">183   return ot_font-&gt;post-&gt;get_glyph_from_name (name, len, glyph);</span>
184 }
185 
186 static hb_bool_t
187 hb_ot_get_font_h_extents (hb_font_t *font,
188                           void *font_data,
189                           hb_font_extents_t *metrics,
190                           void *user_data HB_UNUSED)
191 {
<span class="line-modified">192   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">193   metrics-&gt;ascender = font-&gt;em_scale_y (ot_font-&gt;h_metrics.ascender);</span>
<span class="line-modified">194   metrics-&gt;descender = font-&gt;em_scale_y (ot_font-&gt;h_metrics.descender);</span>
<span class="line-modified">195   metrics-&gt;line_gap = font-&gt;em_scale_y (ot_font-&gt;h_metrics.line_gap);</span>

196   // TODO Hook up variations.
<span class="line-modified">197   return ot_font-&gt;h_metrics.has_font_extents;</span>
198 }
199 
200 static hb_bool_t
201 hb_ot_get_font_v_extents (hb_font_t *font,
202                           void *font_data,
203                           hb_font_extents_t *metrics,
204                           void *user_data HB_UNUSED)
205 {
<span class="line-modified">206   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;</span>
<span class="line-modified">207   metrics-&gt;ascender = font-&gt;em_scale_x (ot_font-&gt;v_metrics.ascender);</span>
<span class="line-modified">208   metrics-&gt;descender = font-&gt;em_scale_x (ot_font-&gt;v_metrics.descender);</span>
<span class="line-modified">209   metrics-&gt;line_gap = font-&gt;em_scale_x (ot_font-&gt;v_metrics.line_gap);</span>

210   // TODO Hook up variations.
<span class="line-modified">211   return ot_font-&gt;v_metrics.has_font_extents;</span>
212 }
213 
<span class="line-modified">214 static hb_font_funcs_t *static_ot_funcs = nullptr;</span>
<span class="line-modified">215 </span>
<span class="line-removed">216 #ifdef HB_USE_ATEXIT</span>
<span class="line-removed">217 static</span>
<span class="line-removed">218 void free_static_ot_funcs (void)</span>
<span class="line-removed">219 {</span>
<span class="line-removed">220 retry:</span>
<span class="line-removed">221   hb_font_funcs_t *ot_funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ot_funcs);</span>
<span class="line-removed">222   if (!hb_atomic_ptr_cmpexch (&amp;static_ot_funcs, ot_funcs, nullptr))</span>
<span class="line-removed">223     goto retry;</span>
<span class="line-removed">224 </span>
<span class="line-removed">225   hb_font_funcs_destroy (ot_funcs);</span>
<span class="line-removed">226 }</span>
227 #endif
228 
<span class="line-modified">229 static hb_font_funcs_t *</span>
<span class="line-removed">230 _hb_ot_get_font_funcs (void)</span>
231 {
<span class="line-modified">232 retry:</span>
<span class="line-removed">233   hb_font_funcs_t *funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ot_funcs);</span>
<span class="line-removed">234 </span>
<span class="line-removed">235   if (unlikely (!funcs))</span>
236   {
<span class="line-modified">237     funcs = hb_font_funcs_create ();</span>
238 
239     hb_font_funcs_set_font_h_extents_func (funcs, hb_ot_get_font_h_extents, nullptr, nullptr);
240     hb_font_funcs_set_font_v_extents_func (funcs, hb_ot_get_font_v_extents, nullptr, nullptr);
241     hb_font_funcs_set_nominal_glyph_func (funcs, hb_ot_get_nominal_glyph, nullptr, nullptr);

242     hb_font_funcs_set_variation_glyph_func (funcs, hb_ot_get_variation_glyph, nullptr, nullptr);
<span class="line-modified">243     hb_font_funcs_set_glyph_h_advance_func (funcs, hb_ot_get_glyph_h_advance, nullptr, nullptr);</span>
<span class="line-modified">244     hb_font_funcs_set_glyph_v_advance_func (funcs, hb_ot_get_glyph_v_advance, nullptr, nullptr);</span>
245     //hb_font_funcs_set_glyph_h_origin_func (funcs, hb_ot_get_glyph_h_origin, nullptr, nullptr);
<span class="line-modified">246     //hb_font_funcs_set_glyph_v_origin_func (funcs, hb_ot_get_glyph_v_origin, nullptr, nullptr);</span>
<span class="line-removed">247     hb_font_funcs_set_glyph_h_kerning_func (funcs, hb_ot_get_glyph_h_kerning, nullptr, nullptr);</span>
<span class="line-removed">248     //hb_font_funcs_set_glyph_v_kerning_func (funcs, hb_ot_get_glyph_v_kerning, nullptr, nullptr);</span>
249     hb_font_funcs_set_glyph_extents_func (funcs, hb_ot_get_glyph_extents, nullptr, nullptr);
250     //hb_font_funcs_set_glyph_contour_point_func (funcs, hb_ot_get_glyph_contour_point, nullptr, nullptr);
251     hb_font_funcs_set_glyph_name_func (funcs, hb_ot_get_glyph_name, nullptr, nullptr);
252     hb_font_funcs_set_glyph_from_name_func (funcs, hb_ot_get_glyph_from_name, nullptr, nullptr);
253 
254     hb_font_funcs_make_immutable (funcs);
255 
<span class="line-modified">256     if (!hb_atomic_ptr_cmpexch (&amp;static_ot_funcs, nullptr, funcs)) {</span>
<span class="line-modified">257       hb_font_funcs_destroy (funcs);</span>
<span class="line-modified">258       goto retry;</span>
<span class="line-removed">259     }</span>
260 
<span class="line-modified">261 #ifdef HB_USE_ATEXIT</span>
<span class="line-modified">262     atexit (free_static_ot_funcs); /* First person registers atexit() callback. */</span>








263 #endif
<span class="line-removed">264   };</span>
265 
<span class="line-modified">266   return funcs;</span>



267 }
268 
269 
270 /**
271  * hb_ot_font_set_funcs:
272  *
273  * Since: 0.9.28
274  **/
275 void
276 hb_ot_font_set_funcs (hb_font_t *font)
277 {
<span class="line-removed">278   hb_ot_font_t *ot_font = _hb_ot_font_create (font-&gt;face);</span>
<span class="line-removed">279   if (unlikely (!ot_font))</span>
<span class="line-removed">280     return;</span>
<span class="line-removed">281 </span>
282   hb_font_set_funcs (font,
283                      _hb_ot_get_font_funcs (),
<span class="line-modified">284                      ot_font,</span>
<span class="line-modified">285                      _hb_ot_font_destroy);</span>
286 }
</pre>
</td>
<td>
<hr />
<pre>
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod, Roozbeh Pournader
 25  */
 26 
<span class="line-modified"> 27 #include &quot;hb.hh&quot;</span>
 28 
 29 #include &quot;hb-ot.h&quot;
 30 
<span class="line-modified"> 31 #include &quot;hb-font.hh&quot;</span>
<span class="line-added"> 32 #include &quot;hb-machinery.hh&quot;</span>
<span class="line-added"> 33 #include &quot;hb-ot-face.hh&quot;</span>
 34 
 35 #include &quot;hb-ot-cmap-table.hh&quot;
 36 #include &quot;hb-ot-glyf-table.hh&quot;
<span class="line-added"> 37 #include &quot;hb-ot-cff1-table.hh&quot;</span>
<span class="line-added"> 38 #include &quot;hb-ot-cff2-table.hh&quot;</span>
 39 #include &quot;hb-ot-hmtx-table.hh&quot;
 40 #include &quot;hb-ot-kern-table.hh&quot;
<span class="line-added"> 41 #include &quot;hb-ot-os2-table.hh&quot;</span>
 42 #include &quot;hb-ot-post-table.hh&quot;
<span class="line-modified"> 43 #include &quot;hb-ot-stat-table.hh&quot; // Just so we compile it; unused otherwise.</span>
<span class="line-added"> 44 #include &quot;hb-ot-vorg-table.hh&quot;</span>
 45 #include &quot;hb-ot-color-cbdt-table.hh&quot;
<span class="line-added"> 46 #include &quot;hb-ot-color-sbix-table.hh&quot;</span>
 47 
 48 
<span class="line-modified"> 49 /**</span>
<span class="line-modified"> 50  * SECTION:hb-ot-font</span>
<span class="line-modified"> 51  * @title: hb-ot-font</span>
<span class="line-modified"> 52  * @short_description: OpenType font implementation</span>
<span class="line-modified"> 53  * @include: hb-ot.h</span>
<span class="line-modified"> 54  *</span>
<span class="line-modified"> 55  * Functions for using OpenType fonts with hb_shape().  Not that fonts returned</span>
<span class="line-modified"> 56  * by hb_font_create() default to using these functions, so most clients would</span>
<span class="line-modified"> 57  * never need to call these functions directly.</span>
<span class="line-modified"> 58  **/</span>




































 59 
 60 
 61 static hb_bool_t
 62 hb_ot_get_nominal_glyph (hb_font_t *font HB_UNUSED,
 63                          void *font_data,
 64                          hb_codepoint_t unicode,
 65                          hb_codepoint_t *glyph,
 66                          void *user_data HB_UNUSED)
<span class="line-added"> 67 {</span>
<span class="line-added"> 68   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-added"> 69   return ot_face-&gt;cmap-&gt;get_nominal_glyph (unicode, glyph);</span>
<span class="line-added"> 70 }</span>
 71 
<span class="line-added"> 72 static unsigned int</span>
<span class="line-added"> 73 hb_ot_get_nominal_glyphs (hb_font_t *font HB_UNUSED,</span>
<span class="line-added"> 74                           void *font_data,</span>
<span class="line-added"> 75                           unsigned int count,</span>
<span class="line-added"> 76                           const hb_codepoint_t *first_unicode,</span>
<span class="line-added"> 77                           unsigned int unicode_stride,</span>
<span class="line-added"> 78                           hb_codepoint_t *first_glyph,</span>
<span class="line-added"> 79                           unsigned int glyph_stride,</span>
<span class="line-added"> 80                           void *user_data HB_UNUSED)</span>
 81 {
<span class="line-modified"> 82   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified"> 83   return ot_face-&gt;cmap-&gt;get_nominal_glyphs (count,</span>
<span class="line-added"> 84                                             first_unicode, unicode_stride,</span>
<span class="line-added"> 85                                             first_glyph, glyph_stride);</span>
 86 }
 87 
 88 static hb_bool_t
 89 hb_ot_get_variation_glyph (hb_font_t *font HB_UNUSED,
 90                            void *font_data,
 91                            hb_codepoint_t unicode,
 92                            hb_codepoint_t variation_selector,
 93                            hb_codepoint_t *glyph,
 94                            void *user_data HB_UNUSED)
 95 {
<span class="line-modified"> 96   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified"> 97   return ot_face-&gt;cmap-&gt;get_variation_glyph (unicode, variation_selector, glyph);</span>
 98 }
 99 
<span class="line-modified">100 static void</span>
<span class="line-modified">101 hb_ot_get_glyph_h_advances (hb_font_t* font, void* font_data,</span>
<span class="line-modified">102                             unsigned count,</span>
<span class="line-modified">103                             const hb_codepoint_t *first_glyph,</span>
<span class="line-modified">104                             unsigned glyph_stride,</span>
<span class="line-added">105                             hb_position_t *first_advance,</span>
<span class="line-added">106                             unsigned advance_stride,</span>
<span class="line-added">107                             void *user_data HB_UNUSED)</span>
108 {
<span class="line-modified">109   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified">110   const OT::hmtx_accelerator_t &amp;hmtx = *ot_face-&gt;hmtx;</span>
<span class="line-added">111 </span>
<span class="line-added">112   for (unsigned int i = 0; i &lt; count; i++)</span>
<span class="line-added">113   {</span>
<span class="line-added">114     *first_advance = font-&gt;em_scale_x (hmtx.get_advance (*first_glyph, font));</span>
<span class="line-added">115     first_glyph = &amp;StructAtOffsetUnaligned&lt;hb_codepoint_t&gt; (first_glyph, glyph_stride);</span>
<span class="line-added">116     first_advance = &amp;StructAtOffsetUnaligned&lt;hb_position_t&gt; (first_advance, advance_stride);</span>
<span class="line-added">117   }</span>
118 }
119 
<span class="line-modified">120 static void</span>
<span class="line-modified">121 hb_ot_get_glyph_v_advances (hb_font_t* font, void* font_data,</span>
<span class="line-modified">122                             unsigned count,</span>
<span class="line-modified">123                             const hb_codepoint_t *first_glyph,</span>
<span class="line-modified">124                             unsigned glyph_stride,</span>
<span class="line-added">125                             hb_position_t *first_advance,</span>
<span class="line-added">126                             unsigned advance_stride,</span>
<span class="line-added">127                             void *user_data HB_UNUSED)</span>
128 {
<span class="line-modified">129   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified">130   const OT::vmtx_accelerator_t &amp;vmtx = *ot_face-&gt;vmtx;</span>
<span class="line-added">131 </span>
<span class="line-added">132   for (unsigned int i = 0; i &lt; count; i++)</span>
<span class="line-added">133   {</span>
<span class="line-added">134     *first_advance = font-&gt;em_scale_y (-(int) vmtx.get_advance (*first_glyph, font));</span>
<span class="line-added">135     first_glyph = &amp;StructAtOffsetUnaligned&lt;hb_codepoint_t&gt; (first_glyph, glyph_stride);</span>
<span class="line-added">136     first_advance = &amp;StructAtOffsetUnaligned&lt;hb_position_t&gt; (first_advance, advance_stride);</span>
<span class="line-added">137   }</span>
138 }
139 
<span class="line-modified">140 static hb_bool_t</span>
<span class="line-modified">141 hb_ot_get_glyph_v_origin (hb_font_t *font,</span>
<span class="line-modified">142                           void *font_data,</span>
<span class="line-modified">143                           hb_codepoint_t glyph,</span>
<span class="line-modified">144                           hb_position_t *x,</span>
<span class="line-modified">145                           hb_position_t *y,</span>
<span class="line-added">146                           void *user_data HB_UNUSED)</span>
147 {
<span class="line-modified">148   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified">149 </span>
<span class="line-added">150   *x = font-&gt;get_glyph_h_advance (glyph) / 2;</span>
<span class="line-added">151 </span>
<span class="line-added">152   const OT::VORG &amp;VORG = *ot_face-&gt;VORG;</span>
<span class="line-added">153   if (VORG.has_data ())</span>
<span class="line-added">154   {</span>
<span class="line-added">155     *y = font-&gt;em_scale_y (VORG.get_y_origin (glyph));</span>
<span class="line-added">156     return true;</span>
<span class="line-added">157   }</span>
<span class="line-added">158 </span>
<span class="line-added">159   hb_glyph_extents_t extents = {0};</span>
<span class="line-added">160   if (ot_face-&gt;glyf-&gt;get_extents (glyph, &amp;extents))</span>
<span class="line-added">161   {</span>
<span class="line-added">162     const OT::vmtx_accelerator_t &amp;vmtx = *ot_face-&gt;vmtx;</span>
<span class="line-added">163     hb_position_t tsb = vmtx.get_side_bearing (glyph);</span>
<span class="line-added">164     *y = font-&gt;em_scale_y (extents.y_bearing + tsb);</span>
<span class="line-added">165     return true;</span>
<span class="line-added">166   }</span>
<span class="line-added">167 </span>
<span class="line-added">168   hb_font_extents_t font_extents;</span>
<span class="line-added">169   font-&gt;get_h_extents_with_fallback (&amp;font_extents);</span>
<span class="line-added">170   *y = font_extents.ascender;</span>
<span class="line-added">171 </span>
<span class="line-added">172   return true;</span>
173 }
174 
175 static hb_bool_t
176 hb_ot_get_glyph_extents (hb_font_t *font,
177                          void *font_data,
178                          hb_codepoint_t glyph,
179                          hb_glyph_extents_t *extents,
180                          void *user_data HB_UNUSED)
181 {
<span class="line-modified">182   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified">183   bool ret = ot_face-&gt;sbix-&gt;get_extents (font, glyph, extents);</span>
<span class="line-added">184   if (!ret)</span>
<span class="line-added">185     ret = ot_face-&gt;glyf-&gt;get_extents (glyph, extents);</span>
<span class="line-added">186   if (!ret)</span>
<span class="line-added">187     ret = ot_face-&gt;cff1-&gt;get_extents (glyph, extents);</span>
<span class="line-added">188   if (!ret)</span>
<span class="line-added">189     ret = ot_face-&gt;cff2-&gt;get_extents (font, glyph, extents);</span>
190   if (!ret)
<span class="line-modified">191     ret = ot_face-&gt;CBDT-&gt;get_extents (font, glyph, extents);</span>
192   // TODO Hook up side-bearings variations.
193   extents-&gt;x_bearing = font-&gt;em_scale_x (extents-&gt;x_bearing);
194   extents-&gt;y_bearing = font-&gt;em_scale_y (extents-&gt;y_bearing);
195   extents-&gt;width     = font-&gt;em_scale_x (extents-&gt;width);
196   extents-&gt;height    = font-&gt;em_scale_y (extents-&gt;height);
197   return ret;
198 }
199 
200 static hb_bool_t
201 hb_ot_get_glyph_name (hb_font_t *font HB_UNUSED,
202                       void *font_data,
203                       hb_codepoint_t glyph,
204                       char *name, unsigned int size,
205                       void *user_data HB_UNUSED)
206 {
<span class="line-modified">207   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified">208   return ot_face-&gt;post-&gt;get_glyph_name (glyph, name, size);</span>
209 }
210 
211 static hb_bool_t
212 hb_ot_get_glyph_from_name (hb_font_t *font HB_UNUSED,
213                            void *font_data,
214                            const char *name, int len,
215                            hb_codepoint_t *glyph,
216                            void *user_data HB_UNUSED)
217 {
<span class="line-modified">218   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified">219   return ot_face-&gt;post-&gt;get_glyph_from_name (name, len, glyph);</span>
220 }
221 
222 static hb_bool_t
223 hb_ot_get_font_h_extents (hb_font_t *font,
224                           void *font_data,
225                           hb_font_extents_t *metrics,
226                           void *user_data HB_UNUSED)
227 {
<span class="line-modified">228   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified">229   const OT::hmtx_accelerator_t &amp;hmtx = *ot_face-&gt;hmtx;</span>
<span class="line-modified">230   metrics-&gt;ascender = font-&gt;em_scale_y (hmtx.ascender);</span>
<span class="line-modified">231   metrics-&gt;descender = font-&gt;em_scale_y (hmtx.descender);</span>
<span class="line-added">232   metrics-&gt;line_gap = font-&gt;em_scale_y (hmtx.line_gap);</span>
233   // TODO Hook up variations.
<span class="line-modified">234   return hmtx.has_font_extents;</span>
235 }
236 
237 static hb_bool_t
238 hb_ot_get_font_v_extents (hb_font_t *font,
239                           void *font_data,
240                           hb_font_extents_t *metrics,
241                           void *user_data HB_UNUSED)
242 {
<span class="line-modified">243   const hb_ot_face_t *ot_face = (const hb_ot_face_t *) font_data;</span>
<span class="line-modified">244   const OT::vmtx_accelerator_t &amp;vmtx = *ot_face-&gt;vmtx;</span>
<span class="line-modified">245   metrics-&gt;ascender = font-&gt;em_scale_x (vmtx.ascender);</span>
<span class="line-modified">246   metrics-&gt;descender = font-&gt;em_scale_x (vmtx.descender);</span>
<span class="line-added">247   metrics-&gt;line_gap = font-&gt;em_scale_x (vmtx.line_gap);</span>
248   // TODO Hook up variations.
<span class="line-modified">249   return vmtx.has_font_extents;</span>
250 }
251 
<span class="line-modified">252 #if HB_USE_ATEXIT</span>
<span class="line-modified">253 static void free_static_ot_funcs ();</span>











254 #endif
255 
<span class="line-modified">256 static struct hb_ot_font_funcs_lazy_loader_t : hb_font_funcs_lazy_loader_t&lt;hb_ot_font_funcs_lazy_loader_t&gt;</span>

257 {
<span class="line-modified">258   static hb_font_funcs_t *create ()</span>



259   {
<span class="line-modified">260     hb_font_funcs_t *funcs = hb_font_funcs_create ();</span>
261 
262     hb_font_funcs_set_font_h_extents_func (funcs, hb_ot_get_font_h_extents, nullptr, nullptr);
263     hb_font_funcs_set_font_v_extents_func (funcs, hb_ot_get_font_v_extents, nullptr, nullptr);
264     hb_font_funcs_set_nominal_glyph_func (funcs, hb_ot_get_nominal_glyph, nullptr, nullptr);
<span class="line-added">265     hb_font_funcs_set_nominal_glyphs_func (funcs, hb_ot_get_nominal_glyphs, nullptr, nullptr);</span>
266     hb_font_funcs_set_variation_glyph_func (funcs, hb_ot_get_variation_glyph, nullptr, nullptr);
<span class="line-modified">267     hb_font_funcs_set_glyph_h_advances_func (funcs, hb_ot_get_glyph_h_advances, nullptr, nullptr);</span>
<span class="line-modified">268     hb_font_funcs_set_glyph_v_advances_func (funcs, hb_ot_get_glyph_v_advances, nullptr, nullptr);</span>
269     //hb_font_funcs_set_glyph_h_origin_func (funcs, hb_ot_get_glyph_h_origin, nullptr, nullptr);
<span class="line-modified">270     hb_font_funcs_set_glyph_v_origin_func (funcs, hb_ot_get_glyph_v_origin, nullptr, nullptr);</span>


271     hb_font_funcs_set_glyph_extents_func (funcs, hb_ot_get_glyph_extents, nullptr, nullptr);
272     //hb_font_funcs_set_glyph_contour_point_func (funcs, hb_ot_get_glyph_contour_point, nullptr, nullptr);
273     hb_font_funcs_set_glyph_name_func (funcs, hb_ot_get_glyph_name, nullptr, nullptr);
274     hb_font_funcs_set_glyph_from_name_func (funcs, hb_ot_get_glyph_from_name, nullptr, nullptr);
275 
276     hb_font_funcs_make_immutable (funcs);
277 
<span class="line-modified">278 #if HB_USE_ATEXIT</span>
<span class="line-modified">279     atexit (free_static_ot_funcs);</span>
<span class="line-modified">280 #endif</span>

281 
<span class="line-modified">282     return funcs;</span>
<span class="line-modified">283   }</span>
<span class="line-added">284 } static_ot_funcs;</span>
<span class="line-added">285 </span>
<span class="line-added">286 #if HB_USE_ATEXIT</span>
<span class="line-added">287 static</span>
<span class="line-added">288 void free_static_ot_funcs ()</span>
<span class="line-added">289 {</span>
<span class="line-added">290   static_ot_funcs.free_instance ();</span>
<span class="line-added">291 }</span>
292 #endif

293 
<span class="line-modified">294 static hb_font_funcs_t *</span>
<span class="line-added">295 _hb_ot_get_font_funcs ()</span>
<span class="line-added">296 {</span>
<span class="line-added">297   return static_ot_funcs.get_unconst ();</span>
298 }
299 
300 
301 /**
302  * hb_ot_font_set_funcs:
303  *
304  * Since: 0.9.28
305  **/
306 void
307 hb_ot_font_set_funcs (hb_font_t *font)
308 {




309   hb_font_set_funcs (font,
310                      _hb_ot_get_font_funcs (),
<span class="line-modified">311                      &amp;font-&gt;face-&gt;table,</span>
<span class="line-modified">312                      nullptr);</span>
313 }
</pre>
</td>
</tr>
</table>
<center><a href="hb-ot-color-svg-table.hh.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-glyf-table.hh.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>