<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-font.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright Â© 2011,2014  Google, Inc.
  3  *
  4  *  This is part of HarfBuzz, a text shaping library.
  5  *
  6  * Permission is hereby granted, without written agreement and without
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod, Roozbeh Pournader
 25  */
 26 
 27 #include &quot;hb-private.hh&quot;
 28 
 29 #include &quot;hb-ot.h&quot;
 30 
 31 #include &quot;hb-font-private.hh&quot;
 32 
 33 #include &quot;hb-ot-cmap-table.hh&quot;
 34 #include &quot;hb-ot-glyf-table.hh&quot;
 35 #include &quot;hb-ot-hmtx-table.hh&quot;
 36 #include &quot;hb-ot-kern-table.hh&quot;
 37 #include &quot;hb-ot-post-table.hh&quot;
 38 
 39 #include &quot;hb-ot-color-cbdt-table.hh&quot;
 40 
 41 
 42 struct hb_ot_font_t
 43 {
 44   OT::cmap::accelerator_t cmap;
 45   OT::hmtx::accelerator_t h_metrics;
 46   OT::vmtx::accelerator_t v_metrics;
 47   OT::hb_lazy_loader_t&lt;OT::glyf::accelerator_t&gt; glyf;
 48   OT::hb_lazy_loader_t&lt;OT::CBDT::accelerator_t&gt; cbdt;
 49   OT::hb_lazy_loader_t&lt;OT::post::accelerator_t&gt; post;
 50   OT::hb_lazy_loader_t&lt;OT::kern::accelerator_t&gt; kern;
 51 };
 52 
 53 
 54 static hb_ot_font_t *
 55 _hb_ot_font_create (hb_face_t *face)
 56 {
 57   hb_ot_font_t *ot_font = (hb_ot_font_t *) calloc (1, sizeof (hb_ot_font_t));
 58 
 59   if (unlikely (!ot_font))
 60     return nullptr;
 61 
 62   ot_font-&gt;cmap.init (face);
 63   ot_font-&gt;h_metrics.init (face);
 64   ot_font-&gt;v_metrics.init (face, ot_font-&gt;h_metrics.ascender - ot_font-&gt;h_metrics.descender); /* TODO Can we do this lazily? */
 65   ot_font-&gt;glyf.init (face);
 66   ot_font-&gt;cbdt.init (face);
 67   ot_font-&gt;post.init (face);
 68   ot_font-&gt;kern.init (face);
 69 
 70   return ot_font;
 71 }
 72 
 73 static void
 74 _hb_ot_font_destroy (void *data)
 75 {
 76   hb_ot_font_t *ot_font = (hb_ot_font_t *) data;
 77 
 78   ot_font-&gt;cmap.fini ();
 79   ot_font-&gt;h_metrics.fini ();
 80   ot_font-&gt;v_metrics.fini ();
 81   ot_font-&gt;glyf.fini ();
 82   ot_font-&gt;cbdt.fini ();
 83   ot_font-&gt;post.fini ();
 84   ot_font-&gt;kern.fini ();
 85 
 86   free (ot_font);
 87 }
 88 
 89 
 90 static hb_bool_t
 91 hb_ot_get_nominal_glyph (hb_font_t *font HB_UNUSED,
 92                          void *font_data,
 93                          hb_codepoint_t unicode,
 94                          hb_codepoint_t *glyph,
 95                          void *user_data HB_UNUSED)
 96 
 97 {
 98   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
 99   return ot_font-&gt;cmap.get_nominal_glyph (unicode, glyph);
100 }
101 
102 static hb_bool_t
103 hb_ot_get_variation_glyph (hb_font_t *font HB_UNUSED,
104                            void *font_data,
105                            hb_codepoint_t unicode,
106                            hb_codepoint_t variation_selector,
107                            hb_codepoint_t *glyph,
108                            void *user_data HB_UNUSED)
109 {
110   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
111   return ot_font-&gt;cmap.get_variation_glyph (unicode, variation_selector, glyph);
112 }
113 
114 static hb_position_t
115 hb_ot_get_glyph_h_advance (hb_font_t *font,
116                            void *font_data,
117                            hb_codepoint_t glyph,
118                            void *user_data HB_UNUSED)
119 {
120   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
121   return font-&gt;em_scale_x (ot_font-&gt;h_metrics.get_advance (glyph, font));
122 }
123 
124 static hb_position_t
125 hb_ot_get_glyph_v_advance (hb_font_t *font,
126                            void *font_data,
127                            hb_codepoint_t glyph,
128                            void *user_data HB_UNUSED)
129 {
130   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
131   return font-&gt;em_scale_y (-(int) ot_font-&gt;v_metrics.get_advance (glyph, font));
132 }
133 
134 static hb_position_t
135 hb_ot_get_glyph_h_kerning (hb_font_t *font,
136                            void *font_data,
137                            hb_codepoint_t left_glyph,
138                            hb_codepoint_t right_glyph,
139                            void *user_data HB_UNUSED)
140 {
141   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
142   return font-&gt;em_scale_x (ot_font-&gt;kern-&gt;get_h_kerning (left_glyph, right_glyph));
143 }
144 
145 static hb_bool_t
146 hb_ot_get_glyph_extents (hb_font_t *font,
147                          void *font_data,
148                          hb_codepoint_t glyph,
149                          hb_glyph_extents_t *extents,
150                          void *user_data HB_UNUSED)
151 {
152   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
153   bool ret = ot_font-&gt;glyf-&gt;get_extents (glyph, extents);
154   if (!ret)
155     ret = ot_font-&gt;cbdt-&gt;get_extents (glyph, extents);
156   // TODO Hook up side-bearings variations.
157   extents-&gt;x_bearing = font-&gt;em_scale_x (extents-&gt;x_bearing);
158   extents-&gt;y_bearing = font-&gt;em_scale_y (extents-&gt;y_bearing);
159   extents-&gt;width     = font-&gt;em_scale_x (extents-&gt;width);
160   extents-&gt;height    = font-&gt;em_scale_y (extents-&gt;height);
161   return ret;
162 }
163 
164 static hb_bool_t
165 hb_ot_get_glyph_name (hb_font_t *font HB_UNUSED,
166                       void *font_data,
167                       hb_codepoint_t glyph,
168                       char *name, unsigned int size,
169                       void *user_data HB_UNUSED)
170 {
171   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
172   return ot_font-&gt;post-&gt;get_glyph_name (glyph, name, size);
173 }
174 
175 static hb_bool_t
176 hb_ot_get_glyph_from_name (hb_font_t *font HB_UNUSED,
177                            void *font_data,
178                            const char *name, int len,
179                            hb_codepoint_t *glyph,
180                            void *user_data HB_UNUSED)
181 {
182   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
183   return ot_font-&gt;post-&gt;get_glyph_from_name (name, len, glyph);
184 }
185 
186 static hb_bool_t
187 hb_ot_get_font_h_extents (hb_font_t *font,
188                           void *font_data,
189                           hb_font_extents_t *metrics,
190                           void *user_data HB_UNUSED)
191 {
192   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
193   metrics-&gt;ascender = font-&gt;em_scale_y (ot_font-&gt;h_metrics.ascender);
194   metrics-&gt;descender = font-&gt;em_scale_y (ot_font-&gt;h_metrics.descender);
195   metrics-&gt;line_gap = font-&gt;em_scale_y (ot_font-&gt;h_metrics.line_gap);
196   // TODO Hook up variations.
197   return ot_font-&gt;h_metrics.has_font_extents;
198 }
199 
200 static hb_bool_t
201 hb_ot_get_font_v_extents (hb_font_t *font,
202                           void *font_data,
203                           hb_font_extents_t *metrics,
204                           void *user_data HB_UNUSED)
205 {
206   const hb_ot_font_t *ot_font = (const hb_ot_font_t *) font_data;
207   metrics-&gt;ascender = font-&gt;em_scale_x (ot_font-&gt;v_metrics.ascender);
208   metrics-&gt;descender = font-&gt;em_scale_x (ot_font-&gt;v_metrics.descender);
209   metrics-&gt;line_gap = font-&gt;em_scale_x (ot_font-&gt;v_metrics.line_gap);
210   // TODO Hook up variations.
211   return ot_font-&gt;v_metrics.has_font_extents;
212 }
213 
214 static hb_font_funcs_t *static_ot_funcs = nullptr;
215 
216 #ifdef HB_USE_ATEXIT
217 static
218 void free_static_ot_funcs (void)
219 {
220 retry:
221   hb_font_funcs_t *ot_funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ot_funcs);
222   if (!hb_atomic_ptr_cmpexch (&amp;static_ot_funcs, ot_funcs, nullptr))
223     goto retry;
224 
225   hb_font_funcs_destroy (ot_funcs);
226 }
227 #endif
228 
229 static hb_font_funcs_t *
230 _hb_ot_get_font_funcs (void)
231 {
232 retry:
233   hb_font_funcs_t *funcs = (hb_font_funcs_t *) hb_atomic_ptr_get (&amp;static_ot_funcs);
234 
235   if (unlikely (!funcs))
236   {
237     funcs = hb_font_funcs_create ();
238 
239     hb_font_funcs_set_font_h_extents_func (funcs, hb_ot_get_font_h_extents, nullptr, nullptr);
240     hb_font_funcs_set_font_v_extents_func (funcs, hb_ot_get_font_v_extents, nullptr, nullptr);
241     hb_font_funcs_set_nominal_glyph_func (funcs, hb_ot_get_nominal_glyph, nullptr, nullptr);
242     hb_font_funcs_set_variation_glyph_func (funcs, hb_ot_get_variation_glyph, nullptr, nullptr);
243     hb_font_funcs_set_glyph_h_advance_func (funcs, hb_ot_get_glyph_h_advance, nullptr, nullptr);
244     hb_font_funcs_set_glyph_v_advance_func (funcs, hb_ot_get_glyph_v_advance, nullptr, nullptr);
245     //hb_font_funcs_set_glyph_h_origin_func (funcs, hb_ot_get_glyph_h_origin, nullptr, nullptr);
246     //hb_font_funcs_set_glyph_v_origin_func (funcs, hb_ot_get_glyph_v_origin, nullptr, nullptr);
247     hb_font_funcs_set_glyph_h_kerning_func (funcs, hb_ot_get_glyph_h_kerning, nullptr, nullptr);
248     //hb_font_funcs_set_glyph_v_kerning_func (funcs, hb_ot_get_glyph_v_kerning, nullptr, nullptr);
249     hb_font_funcs_set_glyph_extents_func (funcs, hb_ot_get_glyph_extents, nullptr, nullptr);
250     //hb_font_funcs_set_glyph_contour_point_func (funcs, hb_ot_get_glyph_contour_point, nullptr, nullptr);
251     hb_font_funcs_set_glyph_name_func (funcs, hb_ot_get_glyph_name, nullptr, nullptr);
252     hb_font_funcs_set_glyph_from_name_func (funcs, hb_ot_get_glyph_from_name, nullptr, nullptr);
253 
254     hb_font_funcs_make_immutable (funcs);
255 
256     if (!hb_atomic_ptr_cmpexch (&amp;static_ot_funcs, nullptr, funcs)) {
257       hb_font_funcs_destroy (funcs);
258       goto retry;
259     }
260 
261 #ifdef HB_USE_ATEXIT
262     atexit (free_static_ot_funcs); /* First person registers atexit() callback. */
263 #endif
264   };
265 
266   return funcs;
267 }
268 
269 
270 /**
271  * hb_ot_font_set_funcs:
272  *
273  * Since: 0.9.28
274  **/
275 void
276 hb_ot_font_set_funcs (hb_font_t *font)
277 {
278   hb_ot_font_t *ot_font = _hb_ot_font_create (font-&gt;face);
279   if (unlikely (!ot_font))
280     return;
281 
282   hb_font_set_funcs (font,
283                      _hb_ot_get_font_funcs (),
284                      ot_font,
285                      _hb_ot_font_destroy);
286 }
    </pre>
  </body>
</html>