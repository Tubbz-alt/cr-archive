<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-blob.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../freetypeScaler.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-buffer-deserialize-json.hh.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-blob.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,18 +23,24 @@</span>
   * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
   *
   * Red Hat Author(s): Behdad Esfahbod
   */
  
<span class="udiff-line-modified-removed">- /* http://www.oracle.com/technetwork/articles/servers-storage-dev/standardheaderfiles-453865.html */</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+ /* https://github.com/harfbuzz/harfbuzz/issues/1308</span>
<span class="udiff-line-added">+  * http://www.gnu.org/software/libc/manual/html_node/Feature-Test-Macros.html</span>
<span class="udiff-line-added">+  * https://www.oracle.com/technetwork/articles/servers-storage-dev/standardheaderfiles-453865.html</span>
<span class="udiff-line-added">+  */</span>
  #ifndef _POSIX_C_SOURCE
<span class="udiff-line-added">+ #pragma GCC diagnostic push</span>
<span class="udiff-line-added">+ #pragma GCC diagnostic ignored &quot;-Wunused-macros&quot;</span>
  #define _POSIX_C_SOURCE 200809L
<span class="udiff-line-added">+ #pragma GCC diagnostic pop</span>
  #endif
  
<span class="udiff-line-modified-removed">- #include &quot;hb-private.hh&quot;</span>
<span class="udiff-line-modified-removed">- #include &quot;hb-debug.hh&quot;</span>
<span class="udiff-line-removed">- #include &quot;hb-blob-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb-blob.hh&quot;</span>
  
  #ifdef HAVE_SYS_MMAN_H
  #ifdef HAVE_UNISTD_H
  #include &lt;unistd.h&gt;
  #endif /* HAVE_UNISTD_H */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -44,10 +50,23 @@</span>
  #include &lt;stdio.h&gt;
  #include &lt;errno.h&gt;
  #include &lt;stdlib.h&gt;
  
  
<span class="udiff-line-added">+ /**</span>
<span class="udiff-line-added">+  * SECTION: hb-blob</span>
<span class="udiff-line-added">+  * @title: hb-blob</span>
<span class="udiff-line-added">+  * @short_description: Binary data containers</span>
<span class="udiff-line-added">+  * @include: hb.h</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Blobs wrap a chunk of binary data to handle lifecycle management of data</span>
<span class="udiff-line-added">+  * while it is passed between client and HarfBuzz.  Blobs are primarily used</span>
<span class="udiff-line-added">+  * to create font faces, but also to access font face tables, as well as</span>
<span class="udiff-line-added">+  * pass around other binary data.</span>
<span class="udiff-line-added">+  **/</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
  /**
   * hb_blob_create: (skip)
   * @data: Pointer to blob data.
   * @length: Length of @data in bytes.
   * @mode: Memory mode for @data.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -128,11 +147,11 @@</span>
                           unsigned int  offset,
                           unsigned int  length)
  {
    hb_blob_t *blob;
  
<span class="udiff-line-modified-removed">-   if (!length || offset &gt;= parent-&gt;length)</span>
<span class="udiff-line-modified-added">+   if (!length || !parent || offset &gt;= parent-&gt;length)</span>
      return hb_blob_get_empty ();
  
    hb_blob_make_immutable (parent);
  
    blob = hb_blob_create (parent-&gt;data + offset,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -179,26 +198,13 @@</span>
   * Return value: (transfer full): the empty blob.
   *
   * Since: 0.9.2
   **/
  hb_blob_t *
<span class="udiff-line-modified-removed">- hb_blob_get_empty (void)</span>
<span class="udiff-line-modified-added">+ hb_blob_get_empty ()</span>
  {
<span class="udiff-line-modified-removed">-   static const hb_blob_t _hb_blob_nil = {</span>
<span class="udiff-line-removed">-     HB_OBJECT_HEADER_STATIC,</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     true, /* immutable */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     nullptr, /* data */</span>
<span class="udiff-line-removed">-     0, /* length */</span>
<span class="udiff-line-removed">-     HB_MEMORY_MODE_READONLY, /* mode */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     nullptr, /* user_data */</span>
<span class="udiff-line-removed">-     nullptr  /* destroy */</span>
<span class="udiff-line-removed">-   };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   return const_cast&lt;hb_blob_t *&gt; (&amp;_hb_blob_nil);</span>
<span class="udiff-line-modified-added">+   return const_cast&lt;hb_blob_t *&gt; (&amp;Null(hb_blob_t));</span>
  }
  
  /**
   * hb_blob_reference: (skip)
   * @blob: a blob.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -289,14 +295,14 @@</span>
   * Since: 0.9.2
   **/
  void
  hb_blob_make_immutable (hb_blob_t *blob)
  {
<span class="udiff-line-modified-removed">-   if (hb_object_is_inert (blob))</span>
<span class="udiff-line-modified-added">+   if (hb_object_is_immutable (blob))</span>
      return;
  
<span class="udiff-line-modified-removed">-   blob-&gt;immutable = true;</span>
<span class="udiff-line-modified-added">+   hb_object_make_immutable (blob);</span>
  }
  
  /**
   * hb_blob_is_immutable:
   * @blob: a blob.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -308,11 +314,11 @@</span>
   * Since: 0.9.2
   **/
  hb_bool_t
  hb_blob_is_immutable (hb_blob_t *blob)
  {
<span class="udiff-line-modified-removed">-   return blob-&gt;immutable;</span>
<span class="udiff-line-modified-added">+   return hb_object_is_immutable (blob);</span>
  }
  
  
  /**
   * hb_blob_get_length:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -382,11 +388,11 @@</span>
    return const_cast&lt;char *&gt; (blob-&gt;data);
  }
  
  
  bool
<span class="udiff-line-modified-removed">- hb_blob_t::try_make_writable_inplace_unix (void)</span>
<span class="udiff-line-modified-added">+ hb_blob_t::try_make_writable_inplace_unix ()</span>
  {
  #if defined(HAVE_SYS_MMAN_H) &amp;&amp; defined(HAVE_MPROTECT)
    uintptr_t pagesize = -1, mask, length;
    const char *addr;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -425,11 +431,11 @@</span>
    return false;
  #endif
  }
  
  bool
<span class="udiff-line-modified-removed">- hb_blob_t::try_make_writable_inplace (void)</span>
<span class="udiff-line-modified-added">+ hb_blob_t::try_make_writable_inplace ()</span>
  {
    DEBUG_MSG_FUNC (BLOB, this, &quot;making writable inplace\n&quot;);
  
    if (this-&gt;try_make_writable_inplace_unix ())
      return true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -440,13 +446,13 @@</span>
    this-&gt;mode = HB_MEMORY_MODE_READONLY;
    return false;
  }
  
  bool
<span class="udiff-line-modified-removed">- hb_blob_t::try_make_writable (void)</span>
<span class="udiff-line-modified-added">+ hb_blob_t::try_make_writable ()</span>
  {
<span class="udiff-line-modified-removed">-   if (this-&gt;immutable)</span>
<span class="udiff-line-modified-added">+   if (hb_object_is_immutable (this))</span>
      return false;
  
    if (this-&gt;mode == HB_MEMORY_MODE_WRITABLE)
      return true;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -485,15 +491,15 @@</span>
  # include &lt;sys/types.h&gt;
  # include &lt;sys/stat.h&gt;
  # include &lt;fcntl.h&gt;
  #endif
  
<span class="udiff-line-modified-removed">- #if defined(_WIN32) || defined(__CYGWIN__)</span>
<span class="udiff-line-modified-added">+ #ifdef _WIN32</span>
  # include &lt;windows.h&gt;
  #else
<span class="udiff-line-modified-removed">- # ifndef _O_BINARY</span>
<span class="udiff-line-modified-removed">- #  define _O_BINARY 0</span>
<span class="udiff-line-modified-added">+ # ifndef O_BINARY</span>
<span class="udiff-line-modified-added">+ #  define O_BINARY 0</span>
  # endif
  #endif
  
  #ifndef MAP_NORESERVE
  # define MAP_NORESERVE 0
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -501,29 +507,32 @@</span>
  
  struct hb_mapped_file_t
  {
    char *contents;
    unsigned long length;
<span class="udiff-line-modified-removed">- #if defined(_WIN32) || defined(__CYGWIN__)</span>
<span class="udiff-line-modified-added">+ #ifdef _WIN32</span>
    HANDLE mapping;
  #endif
  };
  
<span class="udiff-line-added">+ #if (defined(HAVE_MMAP) || defined(_WIN32)) &amp;&amp; !defined(HB_NO_MMAP)</span>
  static void
<span class="udiff-line-modified-removed">- _hb_mapped_file_destroy (hb_mapped_file_t *file)</span>
<span class="udiff-line-modified-added">+ _hb_mapped_file_destroy (void *file_)</span>
  {
<span class="udiff-line-added">+   hb_mapped_file_t *file = (hb_mapped_file_t *) file_;</span>
  #ifdef HAVE_MMAP
    munmap (file-&gt;contents, file-&gt;length);
<span class="udiff-line-modified-removed">- #elif defined(_WIN32) || defined(__CYGWIN__)</span>
<span class="udiff-line-modified-added">+ #elif defined(_WIN32)</span>
    UnmapViewOfFile (file-&gt;contents);
    CloseHandle (file-&gt;mapping);
  #else
    assert (0); // If we don&#39;t have mmap we shouldn&#39;t reach here
  #endif
  
    free (file);
  }
<span class="udiff-line-added">+ #endif</span>
  
  /**
   * hb_blob_create_from_file:
   * @file_name: font filename.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -538,11 +547,11 @@</span>
       Allison Lortie permission but changed a lot to suit our need. */
  #if defined(HAVE_MMAP) &amp;&amp; !defined(HB_NO_MMAP)
    hb_mapped_file_t *file = (hb_mapped_file_t *) calloc (1, sizeof (hb_mapped_file_t));
    if (unlikely (!file)) return hb_blob_get_empty ();
  
<span class="udiff-line-modified-removed">-   int fd = open (file_name, O_RDONLY | _O_BINARY, 0);</span>
<span class="udiff-line-modified-added">+   int fd = open (file_name, O_RDONLY | O_BINARY, 0);</span>
    if (unlikely (fd == -1)) goto fail_without_close;
  
    struct stat st;
    if (unlikely (fstat (fd, &amp;st) == -1)) goto fail;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -561,25 +570,58 @@</span>
  fail:
    close (fd);
  fail_without_close:
    free (file);
  
<span class="udiff-line-modified-removed">- #elif (defined(_WIN32) || defined(__CYGWIN__)) &amp;&amp; !defined(HB_NO_MMAP)</span>
<span class="udiff-line-modified-added">+ #elif defined(_WIN32) &amp;&amp; !defined(HB_NO_MMAP)</span>
    hb_mapped_file_t *file = (hb_mapped_file_t *) calloc (1, sizeof (hb_mapped_file_t));
    if (unlikely (!file)) return hb_blob_get_empty ();
  
<span class="udiff-line-modified-removed">-   HANDLE fd = CreateFile (file_name, GENERIC_READ, FILE_SHARE_READ, nullptr,</span>
<span class="udiff-line-modified-removed">-                           OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL|FILE_FLAG_OVERLAPPED,</span>
<span class="udiff-line-modified-removed">-                           nullptr);</span>
<span class="udiff-line-modified-added">+   HANDLE fd;</span>
<span class="udiff-line-modified-added">+   unsigned int size = strlen (file_name) + 1;</span>
<span class="udiff-line-modified-added">+   wchar_t * wchar_file_name = (wchar_t *) malloc (sizeof (wchar_t) * size);</span>
<span class="udiff-line-added">+   if (unlikely (wchar_file_name == nullptr)) goto fail_without_close;</span>
<span class="udiff-line-added">+   mbstowcs (wchar_file_name, file_name, size);</span>
<span class="udiff-line-added">+ #if defined(WINAPI_FAMILY) &amp;&amp; (WINAPI_FAMILY==WINAPI_FAMILY_PC_APP || WINAPI_FAMILY==WINAPI_FAMILY_PHONE_APP)</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     CREATEFILE2_EXTENDED_PARAMETERS ceparams = { 0 };</span>
<span class="udiff-line-added">+     ceparams.dwSize = sizeof(CREATEFILE2_EXTENDED_PARAMETERS);</span>
<span class="udiff-line-added">+     ceparams.dwFileAttributes = FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED &amp; 0xFFFF;</span>
<span class="udiff-line-added">+     ceparams.dwFileFlags = FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED &amp; 0xFFF00000;</span>
<span class="udiff-line-added">+     ceparams.dwSecurityQosFlags = FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED &amp; 0x000F0000;</span>
<span class="udiff-line-added">+     ceparams.lpSecurityAttributes = nullptr;</span>
<span class="udiff-line-added">+     ceparams.hTemplateFile = nullptr;</span>
<span class="udiff-line-added">+     fd = CreateFile2 (wchar_file_name, GENERIC_READ, FILE_SHARE_READ,</span>
<span class="udiff-line-added">+                       OPEN_EXISTING, &amp;ceparams);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+   fd = CreateFileW (wchar_file_name, GENERIC_READ, FILE_SHARE_READ, nullptr,</span>
<span class="udiff-line-added">+                     OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL|FILE_FLAG_OVERLAPPED,</span>
<span class="udiff-line-added">+                     nullptr);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+   free (wchar_file_name);</span>
  
    if (unlikely (fd == INVALID_HANDLE_VALUE)) goto fail_without_close;
  
<span class="udiff-line-added">+ #if defined(WINAPI_FAMILY) &amp;&amp; (WINAPI_FAMILY==WINAPI_FAMILY_PC_APP || WINAPI_FAMILY==WINAPI_FAMILY_PHONE_APP)</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     LARGE_INTEGER length;</span>
<span class="udiff-line-added">+     GetFileSizeEx (fd, &amp;length);</span>
<span class="udiff-line-added">+     file-&gt;length = length.LowPart;</span>
<span class="udiff-line-added">+     file-&gt;mapping = CreateFileMappingFromApp (fd, nullptr, PAGE_READONLY, length.QuadPart, nullptr);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ #else</span>
    file-&gt;length = (unsigned long) GetFileSize (fd, nullptr);
    file-&gt;mapping = CreateFileMapping (fd, nullptr, PAGE_READONLY, 0, 0, nullptr);
<span class="udiff-line-added">+ #endif</span>
    if (unlikely (file-&gt;mapping == nullptr)) goto fail;
  
<span class="udiff-line-added">+ #if defined(WINAPI_FAMILY) &amp;&amp; (WINAPI_FAMILY==WINAPI_FAMILY_PC_APP || WINAPI_FAMILY==WINAPI_FAMILY_PHONE_APP)</span>
<span class="udiff-line-added">+   file-&gt;contents = (char *) MapViewOfFileFromApp (file-&gt;mapping, FILE_MAP_READ, 0, 0);</span>
<span class="udiff-line-added">+ #else</span>
    file-&gt;contents = (char *) MapViewOfFile (file-&gt;mapping, FILE_MAP_READ, 0, 0, 0);
<span class="udiff-line-added">+ #endif</span>
    if (unlikely (file-&gt;contents == nullptr)) goto fail;
  
    CloseHandle (fd);
    return hb_blob_create (file-&gt;contents, file-&gt;length,
                           HB_MEMORY_MODE_READONLY_MAY_MAKE_WRITABLE, (void *) file,
</pre>
<center><a href="../freetypeScaler.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-buffer-deserialize-json.hh.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>