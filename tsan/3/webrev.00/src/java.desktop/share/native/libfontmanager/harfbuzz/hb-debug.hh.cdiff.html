<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-debug.hh</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-coretext.cc.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-deprecated.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-debug.hh</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 25,17 ***</span>
   */
  
  #ifndef HB_DEBUG_HH
  #define HB_DEBUG_HH
  
<span class="line-modified">! #include &quot;hb-private.hh&quot;</span>
  
  
  #ifndef HB_DEBUG
  #define HB_DEBUG 0
  #endif
  
  static inline bool
  _hb_debug (unsigned int level,
             unsigned int max_level)
  {
    return level &lt; max_level;
<span class="line-new-header">--- 25,64 ---</span>
   */
  
  #ifndef HB_DEBUG_HH
  #define HB_DEBUG_HH
  
<span class="line-modified">! #include &quot;hb.hh&quot;</span>
<span class="line-added">+ #include &quot;hb-atomic.hh&quot;</span>
<span class="line-added">+ #include &quot;hb-dsalgs.hh&quot;</span>
  
  
  #ifndef HB_DEBUG
  #define HB_DEBUG 0
  #endif
  
<span class="line-added">+ </span>
<span class="line-added">+ /*</span>
<span class="line-added">+  * Global runtime options.</span>
<span class="line-added">+  */</span>
<span class="line-added">+ </span>
<span class="line-added">+ struct hb_options_t</span>
<span class="line-added">+ {</span>
<span class="line-added">+   bool unused : 1; /* In-case sign bit is here. */</span>
<span class="line-added">+   bool initialized : 1;</span>
<span class="line-added">+   bool uniscribe_bug_compatible : 1;</span>
<span class="line-added">+   bool aat : 1;</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ union hb_options_union_t {</span>
<span class="line-added">+   int i;</span>
<span class="line-added">+   hb_options_t opts;</span>
<span class="line-added">+ };</span>
<span class="line-added">+ static_assert ((sizeof (hb_atomic_int_t) &gt;= sizeof (hb_options_union_t)), &quot;&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+ HB_INTERNAL void</span>
<span class="line-added">+ _hb_options_init ();</span>
<span class="line-added">+ </span>
<span class="line-added">+ extern HB_INTERNAL hb_atomic_int_t _hb_options;</span>
<span class="line-added">+ </span>
<span class="line-added">+ static inline hb_options_t</span>
<span class="line-added">+ hb_options ()</span>
<span class="line-added">+ {</span>
<span class="line-added">+   /* Make a local copy, so we can access bitfield threadsafely. */</span>
<span class="line-added">+   hb_options_union_t u;</span>
<span class="line-added">+   u.i = _hb_options.get_relaxed ();</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (unlikely (!u.i))</span>
<span class="line-added">+   {</span>
<span class="line-added">+     _hb_options_init ();</span>
<span class="line-added">+     u.i = _hb_options.get_relaxed ();</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   return u.opts;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ /*</span>
<span class="line-added">+  * Debug output (needs enabling at compile time.)</span>
<span class="line-added">+  */</span>
<span class="line-added">+ </span>
  static inline bool
  _hb_debug (unsigned int level,
             unsigned int max_level)
  {
    return level &lt; max_level;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 124,11 ***</span>
      vfprintf (stderr, message, ap);
    }
  
    fprintf (stderr, &quot;\n&quot;);
  }
<span class="line-modified">! template &lt;&gt; inline void</span>
  _hb_debug_msg_va&lt;0&gt; (const char *what HB_UNUSED,
                       const void *obj HB_UNUSED,
                       const char *func HB_UNUSED,
                       bool indented HB_UNUSED,
                       unsigned int level HB_UNUSED,
<span class="line-new-header">--- 171,11 ---</span>
      vfprintf (stderr, message, ap);
    }
  
    fprintf (stderr, &quot;\n&quot;);
  }
<span class="line-modified">! template &lt;&gt; inline void HB_PRINTF_FUNC(7, 0)</span>
  _hb_debug_msg_va&lt;0&gt; (const char *what HB_UNUSED,
                       const void *obj HB_UNUSED,
                       const char *func HB_UNUSED,
                       bool indented HB_UNUSED,
                       unsigned int level HB_UNUSED,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 143,11 ***</span>
                 bool indented,
                 unsigned int level,
                 int level_dir,
                 const char *message,
                 ...) HB_PRINTF_FUNC(7, 8);
<span class="line-modified">! template &lt;int max_level&gt; static inline void</span>
  _hb_debug_msg (const char *what,
                 const void *obj,
                 const char *func,
                 bool indented,
                 unsigned int level,
<span class="line-new-header">--- 190,11 ---</span>
                 bool indented,
                 unsigned int level,
                 int level_dir,
                 const char *message,
                 ...) HB_PRINTF_FUNC(7, 8);
<span class="line-modified">! template &lt;int max_level&gt; static inline void HB_PRINTF_FUNC(7, 8)</span>
  _hb_debug_msg (const char *what,
                 const void *obj,
                 const char *func,
                 bool indented,
                 unsigned int level,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 167,11 ***</span>
                    bool indented HB_UNUSED,
                    unsigned int level HB_UNUSED,
                    int level_dir HB_UNUSED,
                    const char *message HB_UNUSED,
                    ...) HB_PRINTF_FUNC(7, 8);
<span class="line-modified">! template &lt;&gt; inline void</span>
  _hb_debug_msg&lt;0&gt; (const char *what HB_UNUSED,
                    const void *obj HB_UNUSED,
                    const char *func HB_UNUSED,
                    bool indented HB_UNUSED,
                    unsigned int level HB_UNUSED,
<span class="line-new-header">--- 214,11 ---</span>
                    bool indented HB_UNUSED,
                    unsigned int level HB_UNUSED,
                    int level_dir HB_UNUSED,
                    const char *message HB_UNUSED,
                    ...) HB_PRINTF_FUNC(7, 8);
<span class="line-modified">! template &lt;&gt; inline void HB_PRINTF_FUNC(7, 8)</span>
  _hb_debug_msg&lt;0&gt; (const char *what HB_UNUSED,
                    const void *obj HB_UNUSED,
                    const char *func HB_UNUSED,
                    bool indented HB_UNUSED,
                    unsigned int level HB_UNUSED,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 235,27 ***</span>
      va_list ap;
      va_start (ap, message);
      _hb_debug_msg_va&lt;max_level&gt; (what, obj, func, true, plevel ? *plevel : 0, +1, message, ap);
      va_end (ap);
    }
<span class="line-modified">!   inline ~hb_auto_trace_t (void)</span>
    {
      _hb_warn_no_return&lt;ret_t&gt; (returned);
      if (!returned) {
        _hb_debug_msg&lt;max_level&gt; (what, obj, nullptr, true, plevel ? *plevel : 1, -1, &quot; &quot;);
      }
      if (plevel) --*plevel;
    }
  
<span class="line-modified">!   inline ret_t ret (ret_t v, unsigned int line = 0)</span>
    {
      if (unlikely (returned)) {
        fprintf (stderr, &quot;OUCH, double calls to return_trace().  This is a bug, please report.\n&quot;);
        return v;
      }
  
<span class="line-modified">!     _hb_debug_msg&lt;max_level&gt; (what, obj, nullptr, true, plevel ? *plevel : 1, -1,</span>
                                &quot;return %s (line %d)&quot;,
                                hb_printer_t&lt;ret_t&gt;().print (v), line);
      if (plevel) --*plevel;
      plevel = nullptr;
      returned = true;
<span class="line-new-header">--- 282,29 ---</span>
      va_list ap;
      va_start (ap, message);
      _hb_debug_msg_va&lt;max_level&gt; (what, obj, func, true, plevel ? *plevel : 0, +1, message, ap);
      va_end (ap);
    }
<span class="line-modified">!   ~hb_auto_trace_t ()</span>
    {
      _hb_warn_no_return&lt;ret_t&gt; (returned);
      if (!returned) {
        _hb_debug_msg&lt;max_level&gt; (what, obj, nullptr, true, plevel ? *plevel : 1, -1, &quot; &quot;);
      }
      if (plevel) --*plevel;
    }
  
<span class="line-modified">!   ret_t ret (ret_t v,</span>
<span class="line-added">+              const char *func = &quot;&quot;,</span>
<span class="line-added">+              unsigned int line = 0)</span>
    {
      if (unlikely (returned)) {
        fprintf (stderr, &quot;OUCH, double calls to return_trace().  This is a bug, please report.\n&quot;);
        return v;
      }
  
<span class="line-modified">!     _hb_debug_msg&lt;max_level&gt; (what, obj, func, true, plevel ? *plevel : 1, -1,</span>
                                &quot;return %s (line %d)&quot;,
                                hb_printer_t&lt;ret_t&gt;().print (v), line);
      if (plevel) --*plevel;
      plevel = nullptr;
      returned = true;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 276,21 ***</span>
                                     const void *obj_,
                                     const char *func,
                                     const char *message,
                                     ...) HB_PRINTF_FUNC(6, 7) {}
  
<span class="line-modified">!   inline ret_t ret (ret_t v, unsigned int line HB_UNUSED = 0) { return v; }</span>
  };
  
  /* For disabled tracing; optimize out everything.
   * https://github.com/harfbuzz/harfbuzz/pull/605 */
  template &lt;typename ret_t&gt;
  struct hb_no_trace_t {
<span class="line-modified">!   inline ret_t ret (ret_t v, unsigned int line HB_UNUSED = 0) { return v; }</span>
  };
  
<span class="line-modified">! #define return_trace(RET) return trace.ret (RET, __LINE__)</span>
  
  
  /*
   * Instances.
   */
<span class="line-new-header">--- 325,25 ---</span>
                                     const void *obj_,
                                     const char *func,
                                     const char *message,
                                     ...) HB_PRINTF_FUNC(6, 7) {}
  
<span class="line-modified">!   ret_t ret (ret_t v,</span>
<span class="line-added">+              const char *func HB_UNUSED = nullptr,</span>
<span class="line-added">+              unsigned int line HB_UNUSED = 0) { return v; }</span>
  };
  
  /* For disabled tracing; optimize out everything.
   * https://github.com/harfbuzz/harfbuzz/pull/605 */
  template &lt;typename ret_t&gt;
  struct hb_no_trace_t {
<span class="line-modified">!   ret_t ret (ret_t v,</span>
<span class="line-added">+              const char *func HB_UNUSED = &quot;&quot;,</span>
<span class="line-added">+              unsigned int line HB_UNUSED = 0) { return v; }</span>
  };
  
<span class="line-modified">! #define return_trace(RET) return trace.ret (RET, HB_FUNC, __LINE__)</span>
  
  
  /*
   * Instances.
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 346,34 ***</span>
           c-&gt;buffer-&gt;idx, c-&gt;buffer-&gt;cur().codepoint, (int) c-&gt;lookup_index)
  #else
  #define TRACE_APPLY(this) hb_no_trace_t&lt;bool&gt; trace
  #endif
  
<span class="line-removed">- #ifndef HB_DEBUG_CLOSURE</span>
<span class="line-removed">- #define HB_DEBUG_CLOSURE (HB_DEBUG+0)</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- #if HB_DEBUG_CLOSURE</span>
<span class="line-removed">- #define TRACE_CLOSURE(this) \</span>
<span class="line-removed">-         hb_auto_trace_t&lt;HB_DEBUG_CLOSURE, hb_void_t&gt; trace \</span>
<span class="line-removed">-         (&amp;c-&gt;debug_depth, c-&gt;get_name (), this, HB_FUNC, \</span>
<span class="line-removed">-          &quot; &quot;)</span>
<span class="line-removed">- #else</span>
<span class="line-removed">- #define TRACE_CLOSURE(this) hb_no_trace_t&lt;hb_void_t&gt; trace HB_UNUSED</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
<span class="line-removed">- #ifndef HB_DEBUG_COLLECT_GLYPHS</span>
<span class="line-removed">- #define HB_DEBUG_COLLECT_GLYPHS (HB_DEBUG+0)</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- #if HB_DEBUG_COLLECT_GLYPHS</span>
<span class="line-removed">- #define TRACE_COLLECT_GLYPHS(this) \</span>
<span class="line-removed">-         hb_auto_trace_t&lt;HB_DEBUG_COLLECT_GLYPHS, hb_void_t&gt; trace \</span>
<span class="line-removed">-         (&amp;c-&gt;debug_depth, c-&gt;get_name (), this, HB_FUNC, \</span>
<span class="line-removed">-          &quot; &quot;)</span>
<span class="line-removed">- #else</span>
<span class="line-removed">- #define TRACE_COLLECT_GLYPHS(this) hb_no_trace_t&lt;hb_void_t&gt; trace HB_UNUSED</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
  #ifndef HB_DEBUG_SANITIZE
  #define HB_DEBUG_SANITIZE (HB_DEBUG+0)
  #endif
  #if HB_DEBUG_SANITIZE
  #define TRACE_SANITIZE(this) \
<span class="line-new-header">--- 399,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 421,12 ***</span>
  #endif
  
  #ifndef HB_DEBUG_DISPATCH
  #define HB_DEBUG_DISPATCH ( \
          HB_DEBUG_APPLY + \
<span class="line-removed">-         HB_DEBUG_CLOSURE + \</span>
<span class="line-removed">-         HB_DEBUG_COLLECT_GLYPHS + \</span>
          HB_DEBUG_SANITIZE + \
          HB_DEBUG_SERIALIZE + \
    HB_DEBUG_SUBSET + \
          HB_DEBUG_WOULD_APPLY + \
          0)
<span class="line-new-header">--- 450,10 ---</span>
</pre>
<center><a href="hb-coretext.cc.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-deprecated.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>