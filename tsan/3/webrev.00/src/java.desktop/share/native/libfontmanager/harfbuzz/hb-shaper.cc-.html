<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.desktop/share/native/libfontmanager/harfbuzz/hb-shaper.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright Â© 2012  Google, Inc.
  3  *
  4  *  This is part of HarfBuzz, a text shaping library.
  5  *
  6  * Permission is hereby granted, without written agreement and without
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod
 25  */
 26 
 27 #include &quot;hb-private.hh&quot;
 28 #include &quot;hb-shaper-private.hh&quot;
 29 #include &quot;hb-atomic-private.hh&quot;
 30 
 31 
 32 static const hb_shaper_pair_t all_shapers[] = {
 33 #define HB_SHAPER_IMPLEMENT(name) {#name, _hb_##name##_shape},
 34 #include &quot;hb-shaper-list.hh&quot;
 35 #undef HB_SHAPER_IMPLEMENT
 36 };
 37 
 38 
 39 /* Thread-safe, lock-free, shapers */
 40 
 41 static const hb_shaper_pair_t *static_shapers;
 42 
 43 #ifdef HB_USE_ATEXIT
 44 static
 45 void free_static_shapers (void)
 46 {
 47 retry:
 48   hb_shaper_pair_t *shapers = (hb_shaper_pair_t *) hb_atomic_ptr_get (&amp;static_shapers);
 49   if (!hb_atomic_ptr_cmpexch (&amp;static_shapers, shapers, nullptr))
 50     goto retry;
 51 
 52   if (unlikely (shapers != all_shapers))
 53     free ((void *) shapers);
 54 }
 55 #endif
 56 
 57 const hb_shaper_pair_t *
 58 _hb_shapers_get (void)
 59 {
 60 retry:
 61   hb_shaper_pair_t *shapers = (hb_shaper_pair_t *) hb_atomic_ptr_get (&amp;static_shapers);
 62 
 63   if (unlikely (!shapers))
 64   {
 65     char *env = getenv (&quot;HB_SHAPER_LIST&quot;);
 66     if (!env || !*env) {
 67       (void) hb_atomic_ptr_cmpexch (&amp;static_shapers, nullptr, &amp;all_shapers[0]);
 68       return (const hb_shaper_pair_t *) all_shapers;
 69     }
 70 
 71     /* Not found; allocate one. */
 72     shapers = (hb_shaper_pair_t *) calloc (1, sizeof (all_shapers));
 73     if (unlikely (!shapers)) {
 74       (void) hb_atomic_ptr_cmpexch (&amp;static_shapers, nullptr, &amp;all_shapers[0]);
 75       return (const hb_shaper_pair_t *) all_shapers;
 76     }
 77 
 78     memcpy (shapers, all_shapers, sizeof (all_shapers));
 79 
 80      /* Reorder shaper list to prefer requested shapers. */
 81     unsigned int i = 0;
 82     char *end, *p = env;
 83     for (;;) {
 84       end = strchr (p, &#39;,&#39;);
 85       if (!end)
 86         end = p + strlen (p);
 87 
 88       for (unsigned int j = i; j &lt; ARRAY_LENGTH (all_shapers); j++)
 89         if (end - p == (int) strlen (shapers[j].name) &amp;&amp;
 90             0 == strncmp (shapers[j].name, p, end - p))
 91         {
 92           /* Reorder this shaper to position i */
 93          struct hb_shaper_pair_t t = shapers[j];
 94          memmove (&amp;shapers[i + 1], &amp;shapers[i], sizeof (shapers[i]) * (j - i));
 95          shapers[i] = t;
 96          i++;
 97         }
 98 
 99       if (!*end)
100         break;
101       else
102         p = end + 1;
103     }
104 
105     if (!hb_atomic_ptr_cmpexch (&amp;static_shapers, nullptr, shapers)) {
106       free (shapers);
107       goto retry;
108     }
109 
110 #ifdef HB_USE_ATEXIT
111     atexit (free_static_shapers); /* First person registers atexit() callback. */
112 #endif
113   }
114 
115   return shapers;
116 }
    </pre>
  </body>
</html>