<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-shape.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-shape-plan.cc.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-shaper-list.hh.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-shape.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,44 +24,74 @@</span>
   *
   * Red Hat Author(s): Behdad Esfahbod
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="udiff-line-modified-removed">- #include &quot;hb-private.hh&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;hb.hh&quot;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #include &quot;hb-shaper.hh&quot;</span>
<span class="udiff-line-added">+ #include &quot;hb-shape-plan.hh&quot;</span>
<span class="udiff-line-added">+ #include &quot;hb-buffer.hh&quot;</span>
<span class="udiff-line-added">+ #include &quot;hb-font.hh&quot;</span>
<span class="udiff-line-added">+ #include &quot;hb-machinery.hh&quot;</span>
  
<span class="udiff-line-removed">- #include &quot;hb-shaper-private.hh&quot;</span>
<span class="udiff-line-removed">- #include &quot;hb-shape-plan-private.hh&quot;</span>
<span class="udiff-line-removed">- #include &quot;hb-buffer-private.hh&quot;</span>
<span class="udiff-line-removed">- #include &quot;hb-font-private.hh&quot;</span>
  
  /**
   * SECTION:hb-shape
<span class="udiff-line-modified-removed">-  * @title: Shaping</span>
<span class="udiff-line-modified-added">+  * @title: hb-shape</span>
   * @short_description: Conversion of text strings into positioned glyphs
   * @include: hb.h
   *
   * Shaping is the central operation of HarfBuzz. Shaping operates on buffers,
   * which are sequences of Unicode characters that use the same font and have
<span class="udiff-line-modified-removed">-  * the same text direction, script and language. After shaping the buffer</span>
<span class="udiff-line-modified-added">+  * the same text direction, script, and language. After shaping the buffer</span>
   * contains the output glyphs and their positions.
   **/
  
<span class="udiff-line-removed">- static const char **static_shaper_list;</span>
  
<span class="udiff-line-modified-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="udiff-line-modified-removed">- static</span>
<span class="udiff-line-modified-removed">- void free_static_shaper_list (void)</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-modified-added">+ static void free_static_shaper_list ();</span>
<span class="udiff-line-modified-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static const char *nil_shaper_list[] = {nullptr};</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static struct hb_shaper_list_lazy_loader_t : hb_lazy_loader_t&lt;const char *,</span>
<span class="udiff-line-added">+                                                               hb_shaper_list_lazy_loader_t&gt;</span>
  {
<span class="udiff-line-modified-removed">- retry:</span>
<span class="udiff-line-modified-removed">-   const char **shaper_list = (const char **) hb_atomic_ptr_get (&amp;static_shaper_list);</span>
<span class="udiff-line-modified-removed">-   if (!hb_atomic_ptr_cmpexch (&amp;static_shaper_list, shaper_list, nullptr))</span>
<span class="udiff-line-modified-removed">-     goto retry;</span>
<span class="udiff-line-modified-added">+   static const char ** create ()</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     const char **shaper_list = (const char **) calloc (1 + HB_SHAPERS_COUNT, sizeof (const char *));</span>
<span class="udiff-line-modified-added">+     if (unlikely (!shaper_list))</span>
<span class="udiff-line-added">+       return nullptr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const hb_shaper_entry_t *shapers = _hb_shapers_get ();</span>
<span class="udiff-line-added">+     unsigned int i;</span>
<span class="udiff-line-added">+     for (i = 0; i &lt; HB_SHAPERS_COUNT; i++)</span>
<span class="udiff-line-added">+       shaper_list[i] = shapers[i].name;</span>
<span class="udiff-line-added">+     shaper_list[i] = nullptr;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-added">+     atexit (free_static_shaper_list);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return shaper_list;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+   static void destroy (const char **l)</span>
<span class="udiff-line-added">+   { free (l); }</span>
<span class="udiff-line-added">+   static const char ** get_null ()</span>
<span class="udiff-line-added">+   { return nil_shaper_list; }</span>
<span class="udiff-line-added">+ } static_shaper_list;</span>
  
<span class="udiff-line-modified-removed">-   free (shaper_list);</span>
<span class="udiff-line-modified-added">+ #if HB_USE_ATEXIT</span>
<span class="udiff-line-added">+ static</span>
<span class="udiff-line-added">+ void free_static_shaper_list ()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   static_shaper_list.free_instance ();</span>
  }
  #endif
  
<span class="udiff-line-added">+ </span>
  /**
   * hb_shape_list_shapers:
   *
   * Retrieves the list of shapers supported by HarfBuzz.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -69,41 +99,13 @@</span>
   *    constant strings
   *
   * Since: 0.9.2
   **/
  const char **
<span class="udiff-line-modified-removed">- hb_shape_list_shapers (void)</span>
<span class="udiff-line-modified-added">+ hb_shape_list_shapers ()</span>
  {
<span class="udiff-line-modified-removed">- retry:</span>
<span class="udiff-line-removed">-   const char **shaper_list = (const char **) hb_atomic_ptr_get (&amp;static_shaper_list);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (unlikely (!shaper_list))</span>
<span class="udiff-line-removed">-   {</span>
<span class="udiff-line-removed">-     /* Not found; allocate one. */</span>
<span class="udiff-line-removed">-     shaper_list = (const char **) calloc (1 + HB_SHAPERS_COUNT, sizeof (const char *));</span>
<span class="udiff-line-removed">-     if (unlikely (!shaper_list)) {</span>
<span class="udiff-line-removed">-       static const char *nil_shaper_list[] = {nullptr};</span>
<span class="udiff-line-removed">-       return nil_shaper_list;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     const hb_shaper_pair_t *shapers = _hb_shapers_get ();</span>
<span class="udiff-line-removed">-     unsigned int i;</span>
<span class="udiff-line-removed">-     for (i = 0; i &lt; HB_SHAPERS_COUNT; i++)</span>
<span class="udiff-line-removed">-       shaper_list[i] = shapers[i].name;</span>
<span class="udiff-line-removed">-     shaper_list[i] = nullptr;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (!hb_atomic_ptr_cmpexch (&amp;static_shaper_list, nullptr, shaper_list)) {</span>
<span class="udiff-line-removed">-       free (shaper_list);</span>
<span class="udiff-line-removed">-       goto retry;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #ifdef HB_USE_ATEXIT</span>
<span class="udiff-line-removed">-     atexit (free_static_shaper_list); /* First person registers atexit() callback. */</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   return shaper_list;</span>
<span class="udiff-line-modified-added">+   return static_shaper_list.get_unconst ();</span>
  }
  
  
  /**
   * hb_shape_full:
</pre>
<center><a href="hb-shape-plan.cc.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-shaper-list.hh.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>