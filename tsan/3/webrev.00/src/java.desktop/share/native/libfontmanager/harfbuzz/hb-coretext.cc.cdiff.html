<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-coretext.cc</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-common.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-debug.hh.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-coretext.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,19 ***</span>
   *
   * Mozilla Author(s): Jonathan Kew
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="line-modified">! #define HB_SHAPER coretext</span>
<span class="line-modified">! </span>
<span class="line-removed">- #include &quot;hb-private.hh&quot;</span>
<span class="line-removed">- #include &quot;hb-debug.hh&quot;</span>
<span class="line-removed">- #include &quot;hb-shaper-impl-private.hh&quot;</span>
  
  #include &quot;hb-coretext.h&quot;
  #include &lt;math.h&gt;
  
  /* https://developer.apple.com/documentation/coretext/1508745-ctfontcreatewithgraphicsfont */
  #define HB_CORETEXT_DEFAULT_FONT_SIZE 12.f
  
  static CGFloat
  coretext_font_size_from_ptem (float ptem)
<span class="line-new-header">--- 24,27 ---</span>
   *
   * Mozilla Author(s): Jonathan Kew
   * Google Author(s): Behdad Esfahbod
   */
  
<span class="line-modified">! #include &quot;hb.hh&quot;</span>
<span class="line-modified">! #include &quot;hb-shaper-impl.hh&quot;</span>
  
  #include &quot;hb-coretext.h&quot;
<span class="line-added">+ #include &quot;hb-aat-layout.hh&quot;</span>
  #include &lt;math.h&gt;
  
<span class="line-added">+ </span>
<span class="line-added">+ /**</span>
<span class="line-added">+  * SECTION:hb-coretext</span>
<span class="line-added">+  * @title: hb-coretext</span>
<span class="line-added">+  * @short_description: CoreText integration</span>
<span class="line-added">+  * @include: hb-coretext.h</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Functions for using HarfBuzz with the CoreText fonts.</span>
<span class="line-added">+  **/</span>
<span class="line-added">+ </span>
  /* https://developer.apple.com/documentation/coretext/1508745-ctfontcreatewithgraphicsfont */
  #define HB_CORETEXT_DEFAULT_FONT_SIZE 12.f
  
  static CGFloat
  coretext_font_size_from_ptem (float ptem)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 89,17 ***</span>
  {
    CGFontRelease ((CGFontRef) data);
  }
  
  
<span class="line-removed">- HB_SHAPER_DATA_ENSURE_DEFINE(coretext, face)</span>
<span class="line-removed">- HB_SHAPER_DATA_ENSURE_DEFINE_WITH_CONDITION(coretext, font,</span>
<span class="line-removed">-         fabs (CTFontGetSize((CTFontRef) data) - coretext_font_size_from_ptem (font-&gt;ptem)) &lt;= .5</span>
<span class="line-removed">- )</span>
<span class="line-removed">- </span>
  static CTFontDescriptorRef
<span class="line-modified">! get_last_resort_font_desc (void)</span>
  {
    // TODO Handle allocation failures?
    CTFontDescriptorRef last_resort = CTFontDescriptorCreateWithNameAndSize (CFSTR(&quot;LastResort&quot;), 0);
    CFArrayRef cascade_list = CFArrayCreate (kCFAllocatorDefault,
                                             (const void **) &amp;last_resort,
<span class="line-new-header">--- 97,12 ---</span>
  {
    CGFontRelease ((CGFontRef) data);
  }
  
  
  static CTFontDescriptorRef
<span class="line-modified">! get_last_resort_font_desc ()</span>
  {
    // TODO Handle allocation failures?
    CTFontDescriptorRef last_resort = CTFontDescriptorCreateWithNameAndSize (CFSTR(&quot;LastResort&quot;), 0);
    CFArrayRef cascade_list = CFArrayCreate (kCFAllocatorDefault,
                                             (const void **) &amp;last_resort,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 209,11 ***</span>
      if (!isEmojiFont)
        return ct_font;
    }
  
    CFURLRef original_url = nullptr;
<span class="line-modified">! #if MAC_OS_X_VERSION_MIN_REQUIRED &lt; 1060</span>
    ATSFontRef atsFont;
    FSRef fsref;
    OSStatus status;
    atsFont = CTFontGetPlatformFont (ct_font, NULL);
    status = ATSFontGetFileReference (atsFont, &amp;fsref);
<span class="line-new-header">--- 212,11 ---</span>
      if (!isEmojiFont)
        return ct_font;
    }
  
    CFURLRef original_url = nullptr;
<span class="line-modified">! #if TARGET_OS_OSX &amp;&amp; MAC_OS_X_VERSION_MIN_REQUIRED &lt; 1060</span>
    ATSFontRef atsFont;
    FSRef fsref;
    OSStatus status;
    atsFont = CTFontGetPlatformFont (ct_font, NULL);
    status = ATSFontGetFileReference (atsFont, &amp;fsref);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 239,11 ***</span>
         * Avoid reconfiguring the cascade lists if the new font is outside the
         * system locations that we cannot access from the sandboxed renderer
         * process in Blink. This can be detected by the new file URL location
         * that the newly found font points to. */
        CFURLRef new_url = nullptr;
<span class="line-modified">! #if MAC_OS_X_VERSION_MIN_REQUIRED &lt; 1060</span>
        atsFont = CTFontGetPlatformFont (new_ct_font, NULL);
        status = ATSFontGetFileReference (atsFont, &amp;fsref);
        if (status == noErr)
          new_url = CFURLCreateFromFSRef (NULL, &amp;fsref);
  #else
<span class="line-new-header">--- 242,11 ---</span>
         * Avoid reconfiguring the cascade lists if the new font is outside the
         * system locations that we cannot access from the sandboxed renderer
         * process in Blink. This can be detected by the new file URL location
         * that the newly found font points to. */
        CFURLRef new_url = nullptr;
<span class="line-modified">! #if TARGET_OS_OSX &amp;&amp; MAC_OS_X_VERSION_MIN_REQUIRED &lt; 1060</span>
        atsFont = CTFontGetPlatformFont (new_ct_font, NULL);
        status = ATSFontGetFileReference (atsFont, &amp;fsref);
        if (status == noErr)
          new_url = CFURLCreateFromFSRef (NULL, &amp;fsref);
  #else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 268,26 ***</span>
    if (original_url)
      CFRelease (original_url);
    return ct_font;
  }
  
<span class="line-modified">! hb_coretext_shaper_face_data_t *</span>
  _hb_coretext_shaper_face_data_create (hb_face_t *face)
  {
    CGFontRef cg_font = create_cg_font (face);
  
    if (unlikely (!cg_font))
    {
      DEBUG_MSG (CORETEXT, face, &quot;CGFont creation failed..&quot;);
      return nullptr;
    }
  
<span class="line-modified">!   return (hb_coretext_shaper_face_data_t *) cg_font;</span>
  }
  
  void
<span class="line-modified">! _hb_coretext_shaper_face_data_destroy (hb_coretext_shaper_face_data_t *data)</span>
  {
    CFRelease ((CGFontRef) data);
  }
  
  hb_face_t *
<span class="line-new-header">--- 271,26 ---</span>
    if (original_url)
      CFRelease (original_url);
    return ct_font;
  }
  
<span class="line-modified">! hb_coretext_face_data_t *</span>
  _hb_coretext_shaper_face_data_create (hb_face_t *face)
  {
    CGFontRef cg_font = create_cg_font (face);
  
    if (unlikely (!cg_font))
    {
      DEBUG_MSG (CORETEXT, face, &quot;CGFont creation failed..&quot;);
      return nullptr;
    }
  
<span class="line-modified">!   return (hb_coretext_face_data_t *) cg_font;</span>
  }
  
  void
<span class="line-modified">! _hb_coretext_shaper_face_data_destroy (hb_coretext_face_data_t *data)</span>
  {
    CFRelease ((CGFontRef) data);
  }
  
  hb_face_t *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 300,39 ***</span>
   * Since: 0.9.10
   */
  CGFontRef
  hb_coretext_face_get_cg_font (hb_face_t *face)
  {
<span class="line-modified">!   if (unlikely (!hb_coretext_shaper_face_data_ensure (face))) return nullptr;</span>
<span class="line-removed">-   return (CGFontRef) HB_SHAPER_DATA_GET (face);</span>
  }
  
  
<span class="line-modified">! hb_coretext_shaper_font_data_t *</span>
  _hb_coretext_shaper_font_data_create (hb_font_t *font)
  {
    hb_face_t *face = font-&gt;face;
<span class="line-modified">!   if (unlikely (!hb_coretext_shaper_face_data_ensure (face))) return nullptr;</span>
<span class="line-modified">!   CGFontRef cg_font = (CGFontRef) HB_SHAPER_DATA_GET (face);</span>
  
    CTFontRef ct_font = create_ct_font (cg_font, coretext_font_size_from_ptem (font-&gt;ptem));
  
    if (unlikely (!ct_font))
    {
      DEBUG_MSG (CORETEXT, font, &quot;CGFont creation failed..&quot;);
      return nullptr;
    }
  
<span class="line-modified">!   return (hb_coretext_shaper_font_data_t *) ct_font;</span>
  }
  
  void
<span class="line-modified">! _hb_coretext_shaper_font_data_destroy (hb_coretext_shaper_font_data_t *data)</span>
  {
    CFRelease ((CTFontRef) data);
  }
  
  /*
   * Since: 1.7.2
   */
  hb_font_t *
  hb_coretext_font_create (CTFontRef ct_font)
<span class="line-new-header">--- 303,71 ---</span>
   * Since: 0.9.10
   */
  CGFontRef
  hb_coretext_face_get_cg_font (hb_face_t *face)
  {
<span class="line-modified">!   return (CGFontRef) (const void *) face-&gt;data.coretext;</span>
  }
  
  
<span class="line-modified">! hb_coretext_font_data_t *</span>
  _hb_coretext_shaper_font_data_create (hb_font_t *font)
  {
    hb_face_t *face = font-&gt;face;
<span class="line-modified">!   const hb_coretext_face_data_t *face_data = face-&gt;data.coretext;</span>
<span class="line-modified">!   if (unlikely (!face_data)) return nullptr;</span>
<span class="line-added">+   CGFontRef cg_font = (CGFontRef) (const void *) face-&gt;data.coretext;</span>
  
    CTFontRef ct_font = create_ct_font (cg_font, coretext_font_size_from_ptem (font-&gt;ptem));
  
    if (unlikely (!ct_font))
    {
      DEBUG_MSG (CORETEXT, font, &quot;CGFont creation failed..&quot;);
      return nullptr;
    }
  
<span class="line-modified">!   return (hb_coretext_font_data_t *) ct_font;</span>
  }
  
  void
<span class="line-modified">! _hb_coretext_shaper_font_data_destroy (hb_coretext_font_data_t *data)</span>
  {
    CFRelease ((CTFontRef) data);
  }
  
<span class="line-added">+ static const hb_coretext_font_data_t *</span>
<span class="line-added">+ hb_coretext_font_data_sync (hb_font_t *font)</span>
<span class="line-added">+ {</span>
<span class="line-added">+ retry:</span>
<span class="line-added">+   const hb_coretext_font_data_t *data = font-&gt;data.coretext;</span>
<span class="line-added">+   if (unlikely (!data)) return nullptr;</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (fabs (CTFontGetSize((CTFontRef) data) - coretext_font_size_from_ptem (font-&gt;ptem)) &gt; .5)</span>
<span class="line-added">+   {</span>
<span class="line-added">+     /* XXX-MT-bug</span>
<span class="line-added">+      * Note that evaluating condition above can be dangerous if another thread</span>
<span class="line-added">+      * got here first and destructed data.  That&#39;s, as always, bad use pattern.</span>
<span class="line-added">+      * If you modify the font (change font size), other threads must not be</span>
<span class="line-added">+      * using it at the same time.  However, since this check is delayed to</span>
<span class="line-added">+      * when one actually tries to shape something, this is a XXX race condition</span>
<span class="line-added">+      * (and the only one we have that I know of) right now.  Ie. you modify the</span>
<span class="line-added">+      * font size in one thread, then (supposedly safely) try to use it from two</span>
<span class="line-added">+      * or more threads and BOOM!  I&#39;m not sure how to fix this.  We want RCU.</span>
<span class="line-added">+      */</span>
<span class="line-added">+ </span>
<span class="line-added">+     /* Drop and recreate. */</span>
<span class="line-added">+     /* If someone dropped it in the mean time, throw it away and don&#39;t touch it.</span>
<span class="line-added">+      * Otherwise, destruct it. */</span>
<span class="line-added">+     if (likely (font-&gt;data.coretext.cmpexch (const_cast&lt;hb_coretext_font_data_t *&gt; (data), nullptr)))</span>
<span class="line-added">+       _hb_coretext_shaper_font_data_destroy (const_cast&lt;hb_coretext_font_data_t *&gt; (data));</span>
<span class="line-added">+     else</span>
<span class="line-added">+       goto retry;</span>
<span class="line-added">+   }</span>
<span class="line-added">+   return font-&gt;data.coretext;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
  /*
   * Since: 1.7.2
   */
  hb_font_t *
  hb_coretext_font_create (CTFontRef ct_font)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 341,49 ***</span>
    hb_face_t *face = hb_coretext_face_create (cg_font);
    CFRelease (cg_font);
    hb_font_t *font = hb_font_create (face);
    hb_face_destroy (face);
  
<span class="line-modified">!   if (unlikely (hb_object_is_inert (font)))</span>
      return font;
  
    hb_font_set_ptem (font, coretext_font_size_to_ptem (CTFontGetSize(ct_font)));
  
    /* Let there be dragons here... */
<span class="line-modified">!   HB_SHAPER_DATA_GET (font) = (hb_coretext_shaper_font_data_t *) CFRetain (ct_font);</span>
  
    return font;
  }
  
  CTFontRef
  hb_coretext_font_get_ct_font (hb_font_t *font)
  {
<span class="line-modified">!   if (unlikely (!hb_coretext_shaper_font_data_ensure (font))) return nullptr;</span>
<span class="line-modified">!   return (CTFontRef) HB_SHAPER_DATA_GET (font);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- /*</span>
<span class="line-removed">-  * shaper shape_plan data</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- </span>
<span class="line-removed">- struct hb_coretext_shaper_shape_plan_data_t {};</span>
<span class="line-removed">- </span>
<span class="line-removed">- hb_coretext_shaper_shape_plan_data_t *</span>
<span class="line-removed">- _hb_coretext_shaper_shape_plan_data_create (hb_shape_plan_t    *shape_plan HB_UNUSED,</span>
<span class="line-removed">-                                              const hb_feature_t *user_features HB_UNUSED,</span>
<span class="line-removed">-                                              unsigned int        num_user_features HB_UNUSED,</span>
<span class="line-removed">-                                              const int          *coords HB_UNUSED,</span>
<span class="line-removed">-                                              unsigned int        num_coords HB_UNUSED)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-   return (hb_coretext_shaper_shape_plan_data_t *) HB_SHAPER_DATA_SUCCEEDED;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void</span>
<span class="line-removed">- _hb_coretext_shaper_shape_plan_data_destroy (hb_coretext_shaper_shape_plan_data_t *data HB_UNUSED)</span>
<span class="line-removed">- {</span>
  }
  
  
  /*
   * shaper
<span class="line-new-header">--- 376,26 ---</span>
    hb_face_t *face = hb_coretext_face_create (cg_font);
    CFRelease (cg_font);
    hb_font_t *font = hb_font_create (face);
    hb_face_destroy (face);
  
<span class="line-modified">!   if (unlikely (hb_object_is_immutable (font)))</span>
      return font;
  
    hb_font_set_ptem (font, coretext_font_size_to_ptem (CTFontGetSize(ct_font)));
  
    /* Let there be dragons here... */
<span class="line-modified">!   font-&gt;data.coretext.cmpexch (nullptr, (hb_coretext_font_data_t *) CFRetain (ct_font));</span>
  
    return font;
  }
  
  CTFontRef
  hb_coretext_font_get_ct_font (hb_font_t *font)
  {
<span class="line-modified">!   const hb_coretext_font_data_t *data = hb_coretext_font_data_sync (font);</span>
<span class="line-modified">!   return data ? (CTFontRef) data : nullptr;</span>
  }
  
  
  /*
   * shaper
</pre>
<hr />
<pre>
<span class="line-old-header">*** 430,204 ***</span>
    unsigned int index_first; /* == start */
    unsigned int index_last;  /* == end - 1 */
  };
  
  
<span class="line-removed">- /* The following enum members are added in OS X 10.8. */</span>
<span class="line-removed">- #define kAltHalfWidthTextSelector               6</span>
<span class="line-removed">- #define kAltProportionalTextSelector            5</span>
<span class="line-removed">- #define kAlternateHorizKanaOffSelector          1</span>
<span class="line-removed">- #define kAlternateHorizKanaOnSelector           0</span>
<span class="line-removed">- #define kAlternateKanaType                      34</span>
<span class="line-removed">- #define kAlternateVertKanaOffSelector           3</span>
<span class="line-removed">- #define kAlternateVertKanaOnSelector            2</span>
<span class="line-removed">- #define kCaseSensitiveLayoutOffSelector         1</span>
<span class="line-removed">- #define kCaseSensitiveLayoutOnSelector          0</span>
<span class="line-removed">- #define kCaseSensitiveLayoutType                33</span>
<span class="line-removed">- #define kCaseSensitiveSpacingOffSelector        3</span>
<span class="line-removed">- #define kCaseSensitiveSpacingOnSelector         2</span>
<span class="line-removed">- #define kContextualAlternatesOffSelector        1</span>
<span class="line-removed">- #define kContextualAlternatesOnSelector         0</span>
<span class="line-removed">- #define kContextualAlternatesType               36</span>
<span class="line-removed">- #define kContextualLigaturesOffSelector         19</span>
<span class="line-removed">- #define kContextualLigaturesOnSelector          18</span>
<span class="line-removed">- #define kContextualSwashAlternatesOffSelector   5</span>
<span class="line-removed">- #define kContextualSwashAlternatesOnSelector    4</span>
<span class="line-removed">- #define kDefaultLowerCaseSelector               0</span>
<span class="line-removed">- #define kDefaultUpperCaseSelector               0</span>
<span class="line-removed">- #define kHistoricalLigaturesOffSelector         21</span>
<span class="line-removed">- #define kHistoricalLigaturesOnSelector          20</span>
<span class="line-removed">- #define kHojoCharactersSelector                 12</span>
<span class="line-removed">- #define kJIS2004CharactersSelector              11</span>
<span class="line-removed">- #define kLowerCasePetiteCapsSelector            2</span>
<span class="line-removed">- #define kLowerCaseSmallCapsSelector             1</span>
<span class="line-removed">- #define kLowerCaseType                          37</span>
<span class="line-removed">- #define kMathematicalGreekOffSelector           11</span>
<span class="line-removed">- #define kMathematicalGreekOnSelector            10</span>
<span class="line-removed">- #define kNLCCharactersSelector                  13</span>
<span class="line-removed">- #define kQuarterWidthTextSelector               4</span>
<span class="line-removed">- #define kScientificInferiorsSelector            4</span>
<span class="line-removed">- #define kStylisticAltEightOffSelector           17</span>
<span class="line-removed">- #define kStylisticAltEightOnSelector            16</span>
<span class="line-removed">- #define kStylisticAltEighteenOffSelector        37</span>
<span class="line-removed">- #define kStylisticAltEighteenOnSelector         36</span>
<span class="line-removed">- #define kStylisticAltElevenOffSelector          23</span>
<span class="line-removed">- #define kStylisticAltElevenOnSelector           22</span>
<span class="line-removed">- #define kStylisticAltFifteenOffSelector         31</span>
<span class="line-removed">- #define kStylisticAltFifteenOnSelector          30</span>
<span class="line-removed">- #define kStylisticAltFiveOffSelector            11</span>
<span class="line-removed">- #define kStylisticAltFiveOnSelector             10</span>
<span class="line-removed">- #define kStylisticAltFourOffSelector            9</span>
<span class="line-removed">- #define kStylisticAltFourOnSelector             8</span>
<span class="line-removed">- #define kStylisticAltFourteenOffSelector        29</span>
<span class="line-removed">- #define kStylisticAltFourteenOnSelector         28</span>
<span class="line-removed">- #define kStylisticAltNineOffSelector            19</span>
<span class="line-removed">- #define kStylisticAltNineOnSelector             18</span>
<span class="line-removed">- #define kStylisticAltNineteenOffSelector        39</span>
<span class="line-removed">- #define kStylisticAltNineteenOnSelector         38</span>
<span class="line-removed">- #define kStylisticAltOneOffSelector             3</span>
<span class="line-removed">- #define kStylisticAltOneOnSelector              2</span>
<span class="line-removed">- #define kStylisticAltSevenOffSelector           15</span>
<span class="line-removed">- #define kStylisticAltSevenOnSelector            14</span>
<span class="line-removed">- #define kStylisticAltSeventeenOffSelector       35</span>
<span class="line-removed">- #define kStylisticAltSeventeenOnSelector        34</span>
<span class="line-removed">- #define kStylisticAltSixOffSelector             13</span>
<span class="line-removed">- #define kStylisticAltSixOnSelector              12</span>
<span class="line-removed">- #define kStylisticAltSixteenOffSelector         33</span>
<span class="line-removed">- #define kStylisticAltSixteenOnSelector          32</span>
<span class="line-removed">- #define kStylisticAltTenOffSelector             21</span>
<span class="line-removed">- #define kStylisticAltTenOnSelector              20</span>
<span class="line-removed">- #define kStylisticAltThirteenOffSelector        27</span>
<span class="line-removed">- #define kStylisticAltThirteenOnSelector         26</span>
<span class="line-removed">- #define kStylisticAltThreeOffSelector           7</span>
<span class="line-removed">- #define kStylisticAltThreeOnSelector            6</span>
<span class="line-removed">- #define kStylisticAltTwelveOffSelector          25</span>
<span class="line-removed">- #define kStylisticAltTwelveOnSelector           24</span>
<span class="line-removed">- #define kStylisticAltTwentyOffSelector          41</span>
<span class="line-removed">- #define kStylisticAltTwentyOnSelector           40</span>
<span class="line-removed">- #define kStylisticAltTwoOffSelector             5</span>
<span class="line-removed">- #define kStylisticAltTwoOnSelector              4</span>
<span class="line-removed">- #define kStylisticAlternativesType              35</span>
<span class="line-removed">- #define kSwashAlternatesOffSelector             3</span>
<span class="line-removed">- #define kSwashAlternatesOnSelector              2</span>
<span class="line-removed">- #define kThirdWidthTextSelector                 3</span>
<span class="line-removed">- #define kTraditionalNamesCharactersSelector     14</span>
<span class="line-removed">- #define kUpperCasePetiteCapsSelector            2</span>
<span class="line-removed">- #define kUpperCaseSmallCapsSelector             1</span>
<span class="line-removed">- #define kUpperCaseType                          38</span>
<span class="line-removed">- </span>
<span class="line-removed">- /* Table data courtesy of Apple. */</span>
<span class="line-removed">- static const struct feature_mapping_t {</span>
<span class="line-removed">-     FourCharCode otFeatureTag;</span>
<span class="line-removed">-     uint16_t aatFeatureType;</span>
<span class="line-removed">-     uint16_t selectorToEnable;</span>
<span class="line-removed">-     uint16_t selectorToDisable;</span>
<span class="line-removed">- } feature_mappings[] = {</span>
<span class="line-removed">-     { &#39;c2pc&#39;,   kUpperCaseType,             kUpperCasePetiteCapsSelector,           kDefaultUpperCaseSelector },</span>
<span class="line-removed">-     { &#39;c2sc&#39;,   kUpperCaseType,             kUpperCaseSmallCapsSelector,            kDefaultUpperCaseSelector },</span>
<span class="line-removed">-     { &#39;calt&#39;,   kContextualAlternatesType,  kContextualAlternatesOnSelector,        kContextualAlternatesOffSelector },</span>
<span class="line-removed">-     { &#39;case&#39;,   kCaseSensitiveLayoutType,   kCaseSensitiveLayoutOnSelector,         kCaseSensitiveLayoutOffSelector },</span>
<span class="line-removed">-     { &#39;clig&#39;,   kLigaturesType,             kContextualLigaturesOnSelector,         kContextualLigaturesOffSelector },</span>
<span class="line-removed">-     { &#39;cpsp&#39;,   kCaseSensitiveLayoutType,   kCaseSensitiveSpacingOnSelector,        kCaseSensitiveSpacingOffSelector },</span>
<span class="line-removed">-     { &#39;cswh&#39;,   kContextualAlternatesType,  kContextualSwashAlternatesOnSelector,   kContextualSwashAlternatesOffSelector },</span>
<span class="line-removed">-     { &#39;dlig&#39;,   kLigaturesType,             kRareLigaturesOnSelector,               kRareLigaturesOffSelector },</span>
<span class="line-removed">-     { &#39;expt&#39;,   kCharacterShapeType,        kExpertCharactersSelector,              16 },</span>
<span class="line-removed">-     { &#39;frac&#39;,   kFractionsType,             kDiagonalFractionsSelector,             kNoFractionsSelector },</span>
<span class="line-removed">-     { &#39;fwid&#39;,   kTextSpacingType,           kMonospacedTextSelector,                7 },</span>
<span class="line-removed">-     { &#39;halt&#39;,   kTextSpacingType,           kAltHalfWidthTextSelector,              7 },</span>
<span class="line-removed">-     { &#39;hist&#39;,   kLigaturesType,             kHistoricalLigaturesOnSelector,         kHistoricalLigaturesOffSelector },</span>
<span class="line-removed">-     { &#39;hkna&#39;,   kAlternateKanaType,         kAlternateHorizKanaOnSelector,          kAlternateHorizKanaOffSelector, },</span>
<span class="line-removed">-     { &#39;hlig&#39;,   kLigaturesType,             kHistoricalLigaturesOnSelector,         kHistoricalLigaturesOffSelector },</span>
<span class="line-removed">-     { &#39;hngl&#39;,   kTransliterationType,       kHanjaToHangulSelector,                 kNoTransliterationSelector },</span>
<span class="line-removed">-     { &#39;hojo&#39;,   kCharacterShapeType,        kHojoCharactersSelector,                16 },</span>
<span class="line-removed">-     { &#39;hwid&#39;,   kTextSpacingType,           kHalfWidthTextSelector,                 7 },</span>
<span class="line-removed">-     { &#39;ital&#39;,   kItalicCJKRomanType,        kCJKItalicRomanOnSelector,              kCJKItalicRomanOffSelector },</span>
<span class="line-removed">-     { &#39;jp04&#39;,   kCharacterShapeType,        kJIS2004CharactersSelector,             16 },</span>
<span class="line-removed">-     { &#39;jp78&#39;,   kCharacterShapeType,        kJIS1978CharactersSelector,             16 },</span>
<span class="line-removed">-     { &#39;jp83&#39;,   kCharacterShapeType,        kJIS1983CharactersSelector,             16 },</span>
<span class="line-removed">-     { &#39;jp90&#39;,   kCharacterShapeType,        kJIS1990CharactersSelector,             16 },</span>
<span class="line-removed">-     { &#39;liga&#39;,   kLigaturesType,             kCommonLigaturesOnSelector,             kCommonLigaturesOffSelector },</span>
<span class="line-removed">-     { &#39;lnum&#39;,   kNumberCaseType,            kUpperCaseNumbersSelector,              2 },</span>
<span class="line-removed">-     { &#39;mgrk&#39;,   kMathematicalExtrasType,    kMathematicalGreekOnSelector,           kMathematicalGreekOffSelector },</span>
<span class="line-removed">-     { &#39;nlck&#39;,   kCharacterShapeType,        kNLCCharactersSelector,                 16 },</span>
<span class="line-removed">-     { &#39;onum&#39;,   kNumberCaseType,            kLowerCaseNumbersSelector,              2 },</span>
<span class="line-removed">-     { &#39;ordn&#39;,   kVerticalPositionType,      kOrdinalsSelector,                      kNormalPositionSelector },</span>
<span class="line-removed">-     { &#39;palt&#39;,   kTextSpacingType,           kAltProportionalTextSelector,           7 },</span>
<span class="line-removed">-     { &#39;pcap&#39;,   kLowerCaseType,             kLowerCasePetiteCapsSelector,           kDefaultLowerCaseSelector },</span>
<span class="line-removed">-     { &#39;pkna&#39;,   kTextSpacingType,           kProportionalTextSelector,              7 },</span>
<span class="line-removed">-     { &#39;pnum&#39;,   kNumberSpacingType,         kProportionalNumbersSelector,           4 },</span>
<span class="line-removed">-     { &#39;pwid&#39;,   kTextSpacingType,           kProportionalTextSelector,              7 },</span>
<span class="line-removed">-     { &#39;qwid&#39;,   kTextSpacingType,           kQuarterWidthTextSelector,              7 },</span>
<span class="line-removed">-     { &#39;ruby&#39;,   kRubyKanaType,              kRubyKanaOnSelector,                    kRubyKanaOffSelector },</span>
<span class="line-removed">-     { &#39;sinf&#39;,   kVerticalPositionType,      kScientificInferiorsSelector,           kNormalPositionSelector },</span>
<span class="line-removed">-     { &#39;smcp&#39;,   kLowerCaseType,             kLowerCaseSmallCapsSelector,            kDefaultLowerCaseSelector },</span>
<span class="line-removed">-     { &#39;smpl&#39;,   kCharacterShapeType,        kSimplifiedCharactersSelector,          16 },</span>
<span class="line-removed">-     { &#39;ss01&#39;,   kStylisticAlternativesType, kStylisticAltOneOnSelector,             kStylisticAltOneOffSelector },</span>
<span class="line-removed">-     { &#39;ss02&#39;,   kStylisticAlternativesType, kStylisticAltTwoOnSelector,             kStylisticAltTwoOffSelector },</span>
<span class="line-removed">-     { &#39;ss03&#39;,   kStylisticAlternativesType, kStylisticAltThreeOnSelector,           kStylisticAltThreeOffSelector },</span>
<span class="line-removed">-     { &#39;ss04&#39;,   kStylisticAlternativesType, kStylisticAltFourOnSelector,            kStylisticAltFourOffSelector },</span>
<span class="line-removed">-     { &#39;ss05&#39;,   kStylisticAlternativesType, kStylisticAltFiveOnSelector,            kStylisticAltFiveOffSelector },</span>
<span class="line-removed">-     { &#39;ss06&#39;,   kStylisticAlternativesType, kStylisticAltSixOnSelector,             kStylisticAltSixOffSelector },</span>
<span class="line-removed">-     { &#39;ss07&#39;,   kStylisticAlternativesType, kStylisticAltSevenOnSelector,           kStylisticAltSevenOffSelector },</span>
<span class="line-removed">-     { &#39;ss08&#39;,   kStylisticAlternativesType, kStylisticAltEightOnSelector,           kStylisticAltEightOffSelector },</span>
<span class="line-removed">-     { &#39;ss09&#39;,   kStylisticAlternativesType, kStylisticAltNineOnSelector,            kStylisticAltNineOffSelector },</span>
<span class="line-removed">-     { &#39;ss10&#39;,   kStylisticAlternativesType, kStylisticAltTenOnSelector,             kStylisticAltTenOffSelector },</span>
<span class="line-removed">-     { &#39;ss11&#39;,   kStylisticAlternativesType, kStylisticAltElevenOnSelector,          kStylisticAltElevenOffSelector },</span>
<span class="line-removed">-     { &#39;ss12&#39;,   kStylisticAlternativesType, kStylisticAltTwelveOnSelector,          kStylisticAltTwelveOffSelector },</span>
<span class="line-removed">-     { &#39;ss13&#39;,   kStylisticAlternativesType, kStylisticAltThirteenOnSelector,        kStylisticAltThirteenOffSelector },</span>
<span class="line-removed">-     { &#39;ss14&#39;,   kStylisticAlternativesType, kStylisticAltFourteenOnSelector,        kStylisticAltFourteenOffSelector },</span>
<span class="line-removed">-     { &#39;ss15&#39;,   kStylisticAlternativesType, kStylisticAltFifteenOnSelector,         kStylisticAltFifteenOffSelector },</span>
<span class="line-removed">-     { &#39;ss16&#39;,   kStylisticAlternativesType, kStylisticAltSixteenOnSelector,         kStylisticAltSixteenOffSelector },</span>
<span class="line-removed">-     { &#39;ss17&#39;,   kStylisticAlternativesType, kStylisticAltSeventeenOnSelector,       kStylisticAltSeventeenOffSelector },</span>
<span class="line-removed">-     { &#39;ss18&#39;,   kStylisticAlternativesType, kStylisticAltEighteenOnSelector,        kStylisticAltEighteenOffSelector },</span>
<span class="line-removed">-     { &#39;ss19&#39;,   kStylisticAlternativesType, kStylisticAltNineteenOnSelector,        kStylisticAltNineteenOffSelector },</span>
<span class="line-removed">-     { &#39;ss20&#39;,   kStylisticAlternativesType, kStylisticAltTwentyOnSelector,          kStylisticAltTwentyOffSelector },</span>
<span class="line-removed">-     { &#39;subs&#39;,   kVerticalPositionType,      kInferiorsSelector,                     kNormalPositionSelector },</span>
<span class="line-removed">-     { &#39;sups&#39;,   kVerticalPositionType,      kSuperiorsSelector,                     kNormalPositionSelector },</span>
<span class="line-removed">-     { &#39;swsh&#39;,   kContextualAlternatesType,  kSwashAlternatesOnSelector,             kSwashAlternatesOffSelector },</span>
<span class="line-removed">-     { &#39;titl&#39;,   kStyleOptionsType,          kTitlingCapsSelector,                   kNoStyleOptionsSelector },</span>
<span class="line-removed">-     { &#39;tnam&#39;,   kCharacterShapeType,        kTraditionalNamesCharactersSelector,    16 },</span>
<span class="line-removed">-     { &#39;tnum&#39;,   kNumberSpacingType,         kMonospacedNumbersSelector,             4 },</span>
<span class="line-removed">-     { &#39;trad&#39;,   kCharacterShapeType,        kTraditionalCharactersSelector,         16 },</span>
<span class="line-removed">-     { &#39;twid&#39;,   kTextSpacingType,           kThirdWidthTextSelector,                7 },</span>
<span class="line-removed">-     { &#39;unic&#39;,   kLetterCaseType,            14,                                     15 },</span>
<span class="line-removed">-     { &#39;valt&#39;,   kTextSpacingType,           kAltProportionalTextSelector,           7 },</span>
<span class="line-removed">-     { &#39;vert&#39;,   kVerticalSubstitutionType,  kSubstituteVerticalFormsOnSelector,     kSubstituteVerticalFormsOffSelector },</span>
<span class="line-removed">-     { &#39;vhal&#39;,   kTextSpacingType,           kAltHalfWidthTextSelector,              7 },</span>
<span class="line-removed">-     { &#39;vkna&#39;,   kAlternateKanaType,         kAlternateVertKanaOnSelector,           kAlternateVertKanaOffSelector },</span>
<span class="line-removed">-     { &#39;vpal&#39;,   kTextSpacingType,           kAltProportionalTextSelector,           7 },</span>
<span class="line-removed">-     { &#39;vrt2&#39;,   kVerticalSubstitutionType,  kSubstituteVerticalFormsOnSelector,     kSubstituteVerticalFormsOffSelector },</span>
<span class="line-removed">-     { &#39;zero&#39;,   kTypographicExtrasType,     kSlashedZeroOnSelector,                 kSlashedZeroOffSelector },</span>
<span class="line-removed">- };</span>
<span class="line-removed">- </span>
<span class="line-removed">- static int</span>
<span class="line-removed">- _hb_feature_mapping_cmp (const void *key_, const void *entry_)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-   unsigned int key = * (unsigned int *) key_;</span>
<span class="line-removed">-   const feature_mapping_t * entry = (const feature_mapping_t *) entry_;</span>
<span class="line-removed">-   return key &lt; entry-&gt;otFeatureTag ? -1 :</span>
<span class="line-removed">-          key &gt; entry-&gt;otFeatureTag ? 1 :</span>
<span class="line-removed">-          0;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  hb_bool_t
  _hb_coretext_shape (hb_shape_plan_t    *shape_plan,
                      hb_font_t          *font,
                      hb_buffer_t        *buffer,
                      const hb_feature_t *features,
                      unsigned int        num_features)
  {
    hb_face_t *face = font-&gt;face;
<span class="line-modified">!   CGFontRef cg_font = (CGFontRef) HB_SHAPER_DATA_GET (face);</span>
<span class="line-modified">!   CTFontRef ct_font = (CTFontRef) HB_SHAPER_DATA_GET (font);</span>
  
    CGFloat ct_font_size = CTFontGetSize (ct_font);
    CGFloat x_mult = (CGFloat) font-&gt;x_scale / ct_font_size;
    CGFloat y_mult = (CGFloat) font-&gt;y_scale / ct_font_size;
  
    /* Attach marks to their bases, to match the &#39;ot&#39; shaper.
<span class="line-modified">!    * Adapted from hb-ot-shape:hb_form_clusters().</span>
     * Note that this only makes us be closer to the &#39;ot&#39; shaper,
     * but by no means the same.  For example, if there&#39;s
     * B1 M1 B2 M2, and B1-B2 form a ligature, M2&#39;s cluster will
     * continue pointing to B2 even though B2 was merged into B1&#39;s
     * cluster... */
<span class="line-new-header">--- 442,27 ---</span>
    unsigned int index_first; /* == start */
    unsigned int index_last;  /* == end - 1 */
  };
  
  
  hb_bool_t
  _hb_coretext_shape (hb_shape_plan_t    *shape_plan,
                      hb_font_t          *font,
                      hb_buffer_t        *buffer,
                      const hb_feature_t *features,
                      unsigned int        num_features)
  {
    hb_face_t *face = font-&gt;face;
<span class="line-modified">!   CGFontRef cg_font = (CGFontRef) (const void *) face-&gt;data.coretext;</span>
<span class="line-modified">!   CTFontRef ct_font = (CTFontRef) hb_coretext_font_data_sync (font);</span>
  
    CGFloat ct_font_size = CTFontGetSize (ct_font);
    CGFloat x_mult = (CGFloat) font-&gt;x_scale / ct_font_size;
    CGFloat y_mult = (CGFloat) font-&gt;y_scale / ct_font_size;
  
    /* Attach marks to their bases, to match the &#39;ot&#39; shaper.
<span class="line-modified">!    * Adapted from a very old version of hb-ot-shape:hb_form_clusters().</span>
     * Note that this only makes us be closer to the &#39;ot&#39; shaper,
     * but by no means the same.  For example, if there&#39;s
     * B1 M1 B2 M2, and B1-B2 form a ligature, M2&#39;s cluster will
     * continue pointing to B2 even though B2 was merged into B1&#39;s
     * cluster... */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 639,28 ***</span>
      for (unsigned int i = 1; i &lt; count; i++)
        if (HB_UNICODE_GENERAL_CATEGORY_IS_MARK (unicode-&gt;general_category (info[i].codepoint)))
          buffer-&gt;merge_clusters (i - 1, i + 1);
    }
  
<span class="line-modified">!   hb_auto_t&lt;hb_vector_t&lt;feature_record_t&gt; &gt; feature_records;</span>
<span class="line-modified">!   hb_auto_t&lt;hb_vector_t&lt;range_record_t&gt; &gt; range_records;</span>
  
    /*
     * Set up features.
     * (copied + modified from code from hb-uniscribe.cc)
     */
    if (num_features)
    {
      /* Sort features by start/end events. */
<span class="line-modified">!     hb_auto_t&lt;hb_vector_t&lt;feature_event_t&gt; &gt; feature_events;</span>
      for (unsigned int i = 0; i &lt; num_features; i++)
      {
<span class="line-modified">!       const feature_mapping_t * mapping = (const feature_mapping_t *) bsearch (&amp;features[i].tag,</span>
<span class="line-removed">-                                                                                feature_mappings,</span>
<span class="line-removed">-                                                                                ARRAY_LENGTH (feature_mappings),</span>
<span class="line-removed">-                                                                                sizeof (feature_mappings[0]),</span>
<span class="line-removed">-                                                                                _hb_feature_mapping_cmp);</span>
        if (!mapping)
          continue;
  
        active_feature_t feature;
        feature.rec.feature = mapping-&gt;aatFeatureType;
<span class="line-new-header">--- 474,24 ---</span>
      for (unsigned int i = 1; i &lt; count; i++)
        if (HB_UNICODE_GENERAL_CATEGORY_IS_MARK (unicode-&gt;general_category (info[i].codepoint)))
          buffer-&gt;merge_clusters (i - 1, i + 1);
    }
  
<span class="line-modified">!   hb_vector_t&lt;feature_record_t&gt; feature_records;</span>
<span class="line-modified">!   hb_vector_t&lt;range_record_t&gt; range_records;</span>
  
    /*
     * Set up features.
     * (copied + modified from code from hb-uniscribe.cc)
     */
    if (num_features)
    {
      /* Sort features by start/end events. */
<span class="line-modified">!     hb_vector_t&lt;feature_event_t&gt; feature_events;</span>
      for (unsigned int i = 0; i &lt; num_features; i++)
      {
<span class="line-modified">!       const hb_aat_feature_mapping_t * mapping = hb_aat_layout_find_feature_mapping (features[i].tag);</span>
        if (!mapping)
          continue;
  
        active_feature_t feature;
        feature.rec.feature = mapping-&gt;aatFeatureType;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 692,28 ***</span>
        event-&gt;start = false;
        event-&gt;feature = feature;
      }
  
      /* Scan events and save features for each range. */
<span class="line-modified">!     hb_auto_t&lt;hb_vector_t&lt;active_feature_t&gt; &gt; active_features;</span>
      unsigned int last_index = 0;
<span class="line-modified">!     for (unsigned int i = 0; i &lt; feature_events.len; i++)</span>
      {
        feature_event_t *event = &amp;feature_events[i];
  
        if (event-&gt;index != last_index)
        {
          /* Save a snapshot of active features and the range. */
          range_record_t *range = range_records.push ();
  
<span class="line-modified">!         if (active_features.len)</span>
          {
            CFMutableArrayRef features_array = CFArrayCreateMutable(kCFAllocatorDefault, 0, &amp;kCFTypeArrayCallBacks);
  
            /* TODO sort and resolve conflicting features? */
            /* active_features.qsort (); */
<span class="line-modified">!           for (unsigned int j = 0; j &lt; active_features.len; j++)</span>
            {
              CFStringRef keys[] = {
                kCTFontFeatureTypeIdentifierKey,
                kCTFontFeatureSelectorIdentifierKey
              };
<span class="line-new-header">--- 523,28 ---</span>
        event-&gt;start = false;
        event-&gt;feature = feature;
      }
  
      /* Scan events and save features for each range. */
<span class="line-modified">!     hb_vector_t&lt;active_feature_t&gt; active_features;</span>
      unsigned int last_index = 0;
<span class="line-modified">!     for (unsigned int i = 0; i &lt; feature_events.length; i++)</span>
      {
        feature_event_t *event = &amp;feature_events[i];
  
        if (event-&gt;index != last_index)
        {
          /* Save a snapshot of active features and the range. */
          range_record_t *range = range_records.push ();
  
<span class="line-modified">!         if (active_features.length)</span>
          {
            CFMutableArrayRef features_array = CFArrayCreateMutable(kCFAllocatorDefault, 0, &amp;kCFTypeArrayCallBacks);
  
            /* TODO sort and resolve conflicting features? */
            /* active_features.qsort (); */
<span class="line-modified">!           for (unsigned int j = 0; j &lt; active_features.length; j++)</span>
            {
              CFStringRef keys[] = {
                kCTFontFeatureTypeIdentifierKey,
                kCTFontFeatureSelectorIdentifierKey
              };
</pre>
<hr />
<pre>
<span class="line-old-header">*** 765,11 ***</span>
        {
          active_features.push (event-&gt;feature);
        } else {
          active_feature_t *feature = active_features.find (&amp;event-&gt;feature);
          if (feature)
<span class="line-modified">!           active_features.remove (feature - active_features.arrayZ);</span>
        }
      }
    }
  
    unsigned int scratch_size;
<span class="line-new-header">--- 596,11 ---</span>
        {
          active_features.push (event-&gt;feature);
        } else {
          active_feature_t *feature = active_features.find (&amp;event-&gt;feature);
          if (feature)
<span class="line-modified">!           active_features.remove (feature - active_features.arrayZ ());</span>
        }
      }
    }
  
    unsigned int scratch_size;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 822,11 ***</span>
  
    bool ret = true;
    CFStringRef string_ref = nullptr;
    CTLineRef line = nullptr;
  
<span class="line-modified">!   if (0)</span>
    {
  resize_and_retry:
      DEBUG_MSG (CORETEXT, buffer, &quot;Buffer resize&quot;);
      /* string_ref uses the scratch-buffer for backing store, and line references
       * string_ref (via attr_string).  We must release those before resizing buffer. */
<span class="line-new-header">--- 653,11 ---</span>
  
    bool ret = true;
    CFStringRef string_ref = nullptr;
    CTLineRef line = nullptr;
  
<span class="line-modified">!   if (false)</span>
    {
  resize_and_retry:
      DEBUG_MSG (CORETEXT, buffer, &quot;Buffer resize&quot;);
      /* string_ref uses the scratch-buffer for backing store, and line references
       * string_ref (via attr_string).  We must release those before resizing buffer. */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 897,11 ***</span>
          CFRelease (lang);
        }
        CFAttributedStringSetAttribute (attr_string, CFRangeMake (0, chars_len),
                                        kCTFontAttributeName, ct_font);
  
<span class="line-modified">!       if (num_features &amp;&amp; range_records.len)</span>
        {
          unsigned int start = 0;
          range_record_t *last_range = &amp;range_records[0];
          for (unsigned int k = 0; k &lt; chars_len; k++)
          {
<span class="line-new-header">--- 728,11 ---</span>
          CFRelease (lang);
        }
        CFAttributedStringSetAttribute (attr_string, CFRangeMake (0, chars_len),
                                        kCTFontAttributeName, ct_font);
  
<span class="line-modified">!       if (num_features &amp;&amp; range_records.length)</span>
        {
          unsigned int start = 0;
          range_record_t *last_range = &amp;range_records[0];
          for (unsigned int k = 0; k &lt; chars_len; k++)
          {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1046,11 ***</span>
           * See: https://github.com/harfbuzz/harfbuzz/pull/36
           *
           * Also see: https://bugs.chromium.org/p/chromium/issues/detail?id=597098
           */
          bool matched = false;
<span class="line-modified">!         for (unsigned int i = 0; i &lt; range_records.len; i++)</span>
            if (range_records[i].font &amp;&amp; CFEqual (run_ct_font, range_records[i].font))
            {
              matched = true;
              break;
            }
<span class="line-new-header">--- 877,11 ---</span>
           * See: https://github.com/harfbuzz/harfbuzz/pull/36
           *
           * Also see: https://bugs.chromium.org/p/chromium/issues/detail?id=597098
           */
          bool matched = false;
<span class="line-modified">!         for (unsigned int i = 0; i &lt; range_records.length; i++)</span>
            if (range_records[i].font &amp;&amp; CFEqual (run_ct_font, range_records[i].font))
            {
              matched = true;
              break;
            }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1233,11 ***</span>
       * directions.  As such, disable the assert...  It wouldn&#39;t crash, but
       * cursoring will be off...
       *
       * https://crbug.com/419769
       */
<span class="line-modified">!     if (0)</span>
      {
        /* Make sure all runs had the expected direction. */
        bool backward = HB_DIRECTION_IS_BACKWARD (buffer-&gt;props.direction);
        assert (bool (status_and &amp; kCTRunStatusRightToLeft) == backward);
        assert (bool (status_or  &amp; kCTRunStatusRightToLeft) == backward);
<span class="line-new-header">--- 1064,11 ---</span>
       * directions.  As such, disable the assert...  It wouldn&#39;t crash, but
       * cursoring will be off...
       *
       * https://crbug.com/419769
       */
<span class="line-modified">!     if (false)</span>
      {
        /* Make sure all runs had the expected direction. */
        bool backward = HB_DIRECTION_IS_BACKWARD (buffer-&gt;props.direction);
        assert (bool (status_and &amp; kCTRunStatusRightToLeft) == backward);
        assert (bool (status_or  &amp; kCTRunStatusRightToLeft) == backward);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1309,11 ***</span>
    if (string_ref)
      CFRelease (string_ref);
    if (line)
      CFRelease (line);
  
<span class="line-modified">!   for (unsigned int i = 0; i &lt; range_records.len; i++)</span>
      if (range_records[i].font)
        CFRelease (range_records[i].font);
  
    return ret;
  }
<span class="line-new-header">--- 1140,11 ---</span>
    if (string_ref)
      CFRelease (string_ref);
    if (line)
      CFRelease (line);
  
<span class="line-modified">!   for (unsigned int i = 0; i &lt; range_records.length; i++)</span>
      if (range_records[i].font)
        CFRelease (range_records[i].font);
  
    return ret;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1321,80 ***</span>
  
  /*
   * AAT shaper
   */
  
<span class="line-removed">- HB_SHAPER_DATA_ENSURE_DEFINE(coretext_aat, face)</span>
<span class="line-removed">- HB_SHAPER_DATA_ENSURE_DEFINE(coretext_aat, font)</span>
<span class="line-removed">- </span>
  /*
   * shaper face data
   */
  
<span class="line-modified">! struct hb_coretext_aat_shaper_face_data_t {};</span>
  
<span class="line-modified">! hb_coretext_aat_shaper_face_data_t *</span>
  _hb_coretext_aat_shaper_face_data_create (hb_face_t *face)
  {
<span class="line-modified">!   static const hb_tag_t tags[] = {HB_CORETEXT_TAG_MORX, HB_CORETEXT_TAG_MORT, HB_CORETEXT_TAG_KERX};</span>
<span class="line-modified">! </span>
<span class="line-removed">-   for (unsigned int i = 0; i &lt; ARRAY_LENGTH (tags); i++)</span>
<span class="line-removed">-   {</span>
<span class="line-removed">-     hb_blob_t *blob = face-&gt;reference_table (tags[i]);</span>
<span class="line-removed">-     if (hb_blob_get_length (blob))</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-       hb_blob_destroy (blob);</span>
<span class="line-removed">-       return hb_coretext_shaper_face_data_ensure (face) ? (hb_coretext_aat_shaper_face_data_t *) HB_SHAPER_DATA_SUCCEEDED : nullptr;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     hb_blob_destroy (blob);</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   return nullptr;</span>
  }
  
  void
<span class="line-modified">! _hb_coretext_aat_shaper_face_data_destroy (hb_coretext_aat_shaper_face_data_t *data HB_UNUSED)</span>
  {
  }
  
  
  /*
   * shaper font data
   */
  
<span class="line-modified">! struct hb_coretext_aat_shaper_font_data_t {};</span>
  
<span class="line-modified">! hb_coretext_aat_shaper_font_data_t *</span>
  _hb_coretext_aat_shaper_font_data_create (hb_font_t *font)
  {
<span class="line-modified">!   return hb_coretext_shaper_font_data_ensure (font) ? (hb_coretext_aat_shaper_font_data_t *) HB_SHAPER_DATA_SUCCEEDED : nullptr;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void</span>
<span class="line-removed">- _hb_coretext_aat_shaper_font_data_destroy (hb_coretext_aat_shaper_font_data_t *data HB_UNUSED)</span>
<span class="line-removed">- {</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- /*</span>
<span class="line-removed">-  * shaper shape_plan data</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- </span>
<span class="line-removed">- struct hb_coretext_aat_shaper_shape_plan_data_t {};</span>
<span class="line-removed">- </span>
<span class="line-removed">- hb_coretext_aat_shaper_shape_plan_data_t *</span>
<span class="line-removed">- _hb_coretext_aat_shaper_shape_plan_data_create (hb_shape_plan_t    *shape_plan HB_UNUSED,</span>
<span class="line-removed">-                                              const hb_feature_t *user_features HB_UNUSED,</span>
<span class="line-removed">-                                              unsigned int        num_user_features HB_UNUSED,</span>
<span class="line-removed">-                                              const int          *coords HB_UNUSED,</span>
<span class="line-removed">-                                              unsigned int        num_coords HB_UNUSED)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-   return (hb_coretext_aat_shaper_shape_plan_data_t *) HB_SHAPER_DATA_SUCCEEDED;</span>
  }
  
  void
<span class="line-modified">! _hb_coretext_aat_shaper_shape_plan_data_destroy (hb_coretext_aat_shaper_shape_plan_data_t *data HB_UNUSED)</span>
  {
  }
  
  
  /*
<span class="line-new-header">--- 1152,43 ---</span>
  
  /*
   * AAT shaper
   */
  
  /*
   * shaper face data
   */
  
<span class="line-modified">! struct hb_coretext_aat_face_data_t {};</span>
  
<span class="line-modified">! hb_coretext_aat_face_data_t *</span>
  _hb_coretext_aat_shaper_face_data_create (hb_face_t *face)
  {
<span class="line-modified">!   return hb_aat_layout_has_substitution (face) || hb_aat_layout_has_positioning (face) ?</span>
<span class="line-modified">!          (hb_coretext_aat_face_data_t *) HB_SHAPER_DATA_SUCCEEDED : nullptr;</span>
  }
  
  void
<span class="line-modified">! _hb_coretext_aat_shaper_face_data_destroy (hb_coretext_aat_face_data_t *data HB_UNUSED)</span>
  {
  }
  
  
  /*
   * shaper font data
   */
  
<span class="line-modified">! struct hb_coretext_aat_font_data_t {};</span>
  
<span class="line-modified">! hb_coretext_aat_font_data_t *</span>
  _hb_coretext_aat_shaper_font_data_create (hb_font_t *font)
  {
<span class="line-modified">!   return font-&gt;data.coretext ? (hb_coretext_aat_font_data_t *) HB_SHAPER_DATA_SUCCEEDED : nullptr;</span>
  }
  
  void
<span class="line-modified">! _hb_coretext_aat_shaper_font_data_destroy (hb_coretext_aat_font_data_t *data HB_UNUSED)</span>
  {
  }
  
  
  /*
</pre>
<center><a href="hb-common.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-debug.hh.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>