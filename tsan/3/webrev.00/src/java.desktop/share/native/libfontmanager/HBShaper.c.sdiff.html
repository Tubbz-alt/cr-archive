<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfontmanager/HBShaper.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="DrawGlyphList.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="freetypeScaler.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/HBShaper.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
184     if (b == 0) {
185         return a;
186     }
187 
188     /* Do an initial approximation, in root */
189     root = a &gt; b ? a + (b / 2) : b + (a / 2);
190 
191     /* An unrolled Newton-Raphson iteration sequence */
192     root = (root + (a * (a / root)) + (b * (b / root)) + 1) / 2;
193     root = (root + (a * (a / root)) + (b * (b / root)) + 1) / 2;
194     root = (root + (a * (a / root)) + (b * (b / root)) + 1) / 2;
195 
196     return root;
197 }
198 
199 JDKFontInfo*
200      createJDKFontInfo(JNIEnv *env,
201                        jobject font2D,
202                        jobject fontStrike,
203                        jfloat ptSize,
<span class="line-removed">204                        jlong pScaler,</span>
205                        jlong pNativeFont,
<span class="line-removed">206                        jlong layoutTables,</span>
207                        jfloatArray matrix,
208                        jboolean aat) {
209 
210 
211     JDKFontInfo *fi = (JDKFontInfo*)malloc(sizeof(JDKFontInfo));
212     if (!fi) {
213        return NULL;
214     }
215     fi-&gt;env = env; // this is valid only for the life of this JNI call.
216     fi-&gt;font2D = font2D;
217     fi-&gt;fontStrike = fontStrike;
218     fi-&gt;nativeFont = pNativeFont;
<span class="line-removed">219     fi-&gt;layoutTables = (TTLayoutTableCache*)layoutTables;</span>
220     fi-&gt;aat = aat;
221     (*env)-&gt;GetFloatArrayRegion(env, matrix, 0, 4, fi-&gt;matrix);
222     fi-&gt;ptSize = ptSize;
223     fi-&gt;xPtSize = euclidianDistance(fi-&gt;matrix[0], fi-&gt;matrix[1]);
224     fi-&gt;yPtSize = euclidianDistance(fi-&gt;matrix[2], fi-&gt;matrix[3]);
225     if (!aat &amp;&amp; (getenv(&quot;HB_NODEVTX&quot;) != NULL)) {
226         fi-&gt;devScale = fi-&gt;xPtSize / fi-&gt;ptSize;
227     } else {
228         fi-&gt;devScale = 1.0f;
229     }
230     return fi;
231 }
232 
233 
234 #define TYPO_KERN 0x00000001
235 #define TYPO_LIGA 0x00000002
236 #define TYPO_RTL  0x80000000
237 
238 JNIEXPORT jboolean JNICALL Java_sun_font_SunLayoutEngine_shape
239     (JNIEnv *env, jclass cls,
240      jobject font2D,
241      jobject fontStrike,
242      jfloat ptSize,
243      jfloatArray matrix,
<span class="line-removed">244      jlong pScaler,</span>
245      jlong pNativeFont,
<span class="line-modified">246      jlong layoutTables,</span>
247      jboolean aat,
248      jcharArray text,
249      jobject gvdata,
250      jint script,
251      jint offset,
252      jint limit,
253      jint baseIndex,
254      jobject startPt,
255      jint flags,
256      jint slot) {
257 
258      hb_buffer_t *buffer;

259      hb_font_t* hbfont;
260      jchar  *chars;
261      jsize len;
262      int glyphCount;
263      hb_glyph_info_t *glyphInfo;
264      hb_glyph_position_t *glyphPos;
265      hb_direction_t direction = HB_DIRECTION_LTR;
266      hb_feature_t *features = NULL;
267      int featureCount = 0;
268      char* kern = (flags &amp; TYPO_KERN) ? &quot;kern&quot; : &quot;-kern&quot;;
269      char* liga = (flags &amp; TYPO_LIGA) ? &quot;liga&quot; : &quot;-liga&quot;;
270      jboolean ret;
271      unsigned int buflen;
272 
273      JDKFontInfo *jdkFontInfo =
274          createJDKFontInfo(env, font2D, fontStrike, ptSize,
<span class="line-modified">275                            pScaler, pNativeFont, layoutTables, matrix, aat);</span>
276      if (!jdkFontInfo) {
277         return JNI_FALSE;
278      }
279      jdkFontInfo-&gt;env = env; // this is valid only for the life of this JNI call.
280      jdkFontInfo-&gt;font2D = font2D;
281      jdkFontInfo-&gt;fontStrike = fontStrike;
282 
<span class="line-modified">283      hbfont = hb_jdk_font_create(jdkFontInfo, NULL);</span>

284 
285      buffer = hb_buffer_create();
286      hb_buffer_set_script(buffer, getHBScriptCode(script));
287      hb_buffer_set_language(buffer,
288                             hb_ot_tag_to_language(HB_OT_TAG_DEFAULT_LANGUAGE));
289      if ((flags &amp; TYPO_RTL) != 0) {
290          direction = HB_DIRECTION_RTL;
291      }
292      hb_buffer_set_direction(buffer, direction);
293      hb_buffer_set_cluster_level(buffer,
294                                  HB_BUFFER_CLUSTER_LEVEL_MONOTONE_CHARACTERS);
295 
296      chars = (*env)-&gt;GetCharArrayElements(env, text, NULL);
297      if ((*env)-&gt;ExceptionCheck(env)) {
298          hb_buffer_destroy(buffer);
299          hb_font_destroy(hbfont);
300          free((void*)jdkFontInfo);
301          return JNI_FALSE;
302      }
303      len = (*env)-&gt;GetArrayLength(env, text);
</pre>
</td>
<td>
<hr />
<pre>
184     if (b == 0) {
185         return a;
186     }
187 
188     /* Do an initial approximation, in root */
189     root = a &gt; b ? a + (b / 2) : b + (a / 2);
190 
191     /* An unrolled Newton-Raphson iteration sequence */
192     root = (root + (a * (a / root)) + (b * (b / root)) + 1) / 2;
193     root = (root + (a * (a / root)) + (b * (b / root)) + 1) / 2;
194     root = (root + (a * (a / root)) + (b * (b / root)) + 1) / 2;
195 
196     return root;
197 }
198 
199 JDKFontInfo*
200      createJDKFontInfo(JNIEnv *env,
201                        jobject font2D,
202                        jobject fontStrike,
203                        jfloat ptSize,

204                        jlong pNativeFont,

205                        jfloatArray matrix,
206                        jboolean aat) {
207 
208 
209     JDKFontInfo *fi = (JDKFontInfo*)malloc(sizeof(JDKFontInfo));
210     if (!fi) {
211        return NULL;
212     }
213     fi-&gt;env = env; // this is valid only for the life of this JNI call.
214     fi-&gt;font2D = font2D;
215     fi-&gt;fontStrike = fontStrike;
216     fi-&gt;nativeFont = pNativeFont;

217     fi-&gt;aat = aat;
218     (*env)-&gt;GetFloatArrayRegion(env, matrix, 0, 4, fi-&gt;matrix);
219     fi-&gt;ptSize = ptSize;
220     fi-&gt;xPtSize = euclidianDistance(fi-&gt;matrix[0], fi-&gt;matrix[1]);
221     fi-&gt;yPtSize = euclidianDistance(fi-&gt;matrix[2], fi-&gt;matrix[3]);
222     if (!aat &amp;&amp; (getenv(&quot;HB_NODEVTX&quot;) != NULL)) {
223         fi-&gt;devScale = fi-&gt;xPtSize / fi-&gt;ptSize;
224     } else {
225         fi-&gt;devScale = 1.0f;
226     }
227     return fi;
228 }
229 
230 
231 #define TYPO_KERN 0x00000001
232 #define TYPO_LIGA 0x00000002
233 #define TYPO_RTL  0x80000000
234 
235 JNIEXPORT jboolean JNICALL Java_sun_font_SunLayoutEngine_shape
236     (JNIEnv *env, jclass cls,
237      jobject font2D,
238      jobject fontStrike,
239      jfloat ptSize,
240      jfloatArray matrix,

241      jlong pNativeFont,
<span class="line-modified">242      jlong pFace,</span>
243      jboolean aat,
244      jcharArray text,
245      jobject gvdata,
246      jint script,
247      jint offset,
248      jint limit,
249      jint baseIndex,
250      jobject startPt,
251      jint flags,
252      jint slot) {
253 
254      hb_buffer_t *buffer;
<span class="line-added">255      hb_face_t* hbface;</span>
256      hb_font_t* hbfont;
257      jchar  *chars;
258      jsize len;
259      int glyphCount;
260      hb_glyph_info_t *glyphInfo;
261      hb_glyph_position_t *glyphPos;
262      hb_direction_t direction = HB_DIRECTION_LTR;
263      hb_feature_t *features = NULL;
264      int featureCount = 0;
265      char* kern = (flags &amp; TYPO_KERN) ? &quot;kern&quot; : &quot;-kern&quot;;
266      char* liga = (flags &amp; TYPO_LIGA) ? &quot;liga&quot; : &quot;-liga&quot;;
267      jboolean ret;
268      unsigned int buflen;
269 
270      JDKFontInfo *jdkFontInfo =
271          createJDKFontInfo(env, font2D, fontStrike, ptSize,
<span class="line-modified">272                            pNativeFont, matrix, aat);</span>
273      if (!jdkFontInfo) {
274         return JNI_FALSE;
275      }
276      jdkFontInfo-&gt;env = env; // this is valid only for the life of this JNI call.
277      jdkFontInfo-&gt;font2D = font2D;
278      jdkFontInfo-&gt;fontStrike = fontStrike;
279 
<span class="line-modified">280      hbface = (hb_face_t*) jlong_to_ptr(pFace);</span>
<span class="line-added">281      hbfont = hb_jdk_font_create(hbface, jdkFontInfo, NULL);</span>
282 
283      buffer = hb_buffer_create();
284      hb_buffer_set_script(buffer, getHBScriptCode(script));
285      hb_buffer_set_language(buffer,
286                             hb_ot_tag_to_language(HB_OT_TAG_DEFAULT_LANGUAGE));
287      if ((flags &amp; TYPO_RTL) != 0) {
288          direction = HB_DIRECTION_RTL;
289      }
290      hb_buffer_set_direction(buffer, direction);
291      hb_buffer_set_cluster_level(buffer,
292                                  HB_BUFFER_CLUSTER_LEVEL_MONOTONE_CHARACTERS);
293 
294      chars = (*env)-&gt;GetCharArrayElements(env, text, NULL);
295      if ((*env)-&gt;ExceptionCheck(env)) {
296          hb_buffer_destroy(buffer);
297          hb_font_destroy(hbfont);
298          free((void*)jdkFontInfo);
299          return JNI_FALSE;
300      }
301      len = (*env)-&gt;GetArrayLength(env, text);
</pre>
</td>
</tr>
</table>
<center><a href="DrawGlyphList.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="freetypeScaler.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>