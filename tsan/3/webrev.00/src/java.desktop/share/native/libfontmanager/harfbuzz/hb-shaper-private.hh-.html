<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.desktop/share/native/libfontmanager/harfbuzz/hb-shaper-private.hh</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright Â© 2012  Google, Inc.
  3  *
  4  *  This is part of HarfBuzz, a text shaping library.
  5  *
  6  * Permission is hereby granted, without written agreement and without
  7  * license or royalty fees, to use, copy, modify, and distribute this
  8  * software and its documentation for any purpose, provided that the
  9  * above copyright notice and the following two paragraphs appear in
 10  * all copies of this software.
 11  *
 12  * IN NO EVENT SHALL THE COPYRIGHT HOLDER BE LIABLE TO ANY PARTY FOR
 13  * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
 14  * ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN
 15  * IF THE COPYRIGHT HOLDER HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH
 16  * DAMAGE.
 17  *
 18  * THE COPYRIGHT HOLDER SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING,
 19  * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 20  * FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS
 21  * ON AN &quot;AS IS&quot; BASIS, AND THE COPYRIGHT HOLDER HAS NO OBLIGATION TO
 22  * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 23  *
 24  * Google Author(s): Behdad Esfahbod
 25  */
 26 
 27 #ifndef HB_SHAPER_PRIVATE_HH
 28 #define HB_SHAPER_PRIVATE_HH
 29 
 30 #include &quot;hb-private.hh&quot;
 31 
 32 typedef hb_bool_t hb_shape_func_t (hb_shape_plan_t    *shape_plan,
 33                                    hb_font_t          *font,
 34                                    hb_buffer_t        *buffer,
 35                                    const hb_feature_t *features,
 36                                    unsigned int        num_features);
 37 
 38 #define HB_SHAPER_IMPLEMENT(name) \
 39         extern &quot;C&quot; HB_INTERNAL hb_shape_func_t _hb_##name##_shape;
 40 #include &quot;hb-shaper-list.hh&quot;
 41 #undef HB_SHAPER_IMPLEMENT
 42 
 43 struct hb_shaper_pair_t {
 44   char name[16];
 45   hb_shape_func_t *func;
 46 };
 47 
 48 HB_INTERNAL const hb_shaper_pair_t *
 49 _hb_shapers_get (void);
 50 
 51 
 52 /* For embedding in face / font / ... */
 53 struct hb_shaper_data_t {
 54 #define HB_SHAPER_IMPLEMENT(shaper) void *shaper;
 55 #include &quot;hb-shaper-list.hh&quot;
 56 #undef HB_SHAPER_IMPLEMENT
 57 };
 58 
 59 #define HB_SHAPERS_COUNT (sizeof (hb_shaper_data_t) / sizeof (void *))
 60 
 61 /* Means: succeeded, but don&#39;t need to keep any data. */
 62 #define HB_SHAPER_DATA_SUCCEEDED ((void *) +1)
 63 
 64 /* Means: tried but failed to create. */
 65 #define HB_SHAPER_DATA_INVALID ((void *) -1)
 66 #define HB_SHAPER_DATA_IS_INVALID(data) ((void *) (data) == HB_SHAPER_DATA_INVALID)
 67 
 68 #define HB_SHAPER_DATA_TYPE_NAME(shaper, object)        hb_##shaper##_shaper_##object##_data_t
 69 #define HB_SHAPER_DATA_TYPE(shaper, object)             struct HB_SHAPER_DATA_TYPE_NAME(shaper, object)
 70 #define HB_SHAPER_DATA_INSTANCE(shaper, object, instance)       (* (HB_SHAPER_DATA_TYPE(shaper, object) **) &amp;(instance)-&gt;shaper_data.shaper)
 71 #define HB_SHAPER_DATA(shaper, object)                  HB_SHAPER_DATA_INSTANCE(shaper, object, object)
 72 #define HB_SHAPER_DATA_CREATE_FUNC(shaper, object)      _hb_##shaper##_shaper_##object##_data_create
 73 #define HB_SHAPER_DATA_DESTROY_FUNC(shaper, object)     _hb_##shaper##_shaper_##object##_data_destroy
 74 #define HB_SHAPER_DATA_ENSURE_FUNC(shaper, object)      hb_##shaper##_shaper_##object##_data_ensure
 75 
 76 #define HB_SHAPER_DATA_PROTOTYPE(shaper, object) \
 77         HB_SHAPER_DATA_TYPE (shaper, object); /* Type forward declaration. */ \
 78         extern &quot;C&quot; HB_INTERNAL HB_SHAPER_DATA_TYPE (shaper, object) * \
 79         HB_SHAPER_DATA_CREATE_FUNC (shaper, object) (hb_##object##_t *object HB_SHAPER_DATA_CREATE_FUNC_EXTRA_ARGS); \
 80         extern &quot;C&quot; HB_INTERNAL void \
 81         HB_SHAPER_DATA_DESTROY_FUNC (shaper, object) (HB_SHAPER_DATA_TYPE (shaper, object) *data); \
 82         extern &quot;C&quot; HB_INTERNAL bool \
 83         HB_SHAPER_DATA_ENSURE_FUNC (shaper, object) (hb_##object##_t *object)
 84 
 85 #define HB_SHAPER_DATA_DESTROY(shaper, object) \
 86     if (HB_SHAPER_DATA_TYPE (shaper, object) *data = HB_SHAPER_DATA (shaper, object)) \
 87       if (data != HB_SHAPER_DATA_INVALID &amp;&amp; data != HB_SHAPER_DATA_SUCCEEDED) \
 88         HB_SHAPER_DATA_DESTROY_FUNC (shaper, object) (data);
 89 
 90 #define HB_SHAPER_DATA_ENSURE_DEFINE(shaper, object) \
 91         HB_SHAPER_DATA_ENSURE_DEFINE_WITH_CONDITION(shaper, object, true)
 92 
 93 #define HB_SHAPER_DATA_ENSURE_DEFINE_WITH_CONDITION(shaper, object, condition) \
 94 bool \
 95 HB_SHAPER_DATA_ENSURE_FUNC(shaper, object) (hb_##object##_t *object) \
 96 {\
 97   retry: \
 98   HB_SHAPER_DATA_TYPE (shaper, object) *data = (HB_SHAPER_DATA_TYPE (shaper, object) *) hb_atomic_ptr_get (&amp;HB_SHAPER_DATA (shaper, object)); \
 99   if (likely (data) &amp;&amp; !(condition)) { \
100     /* Drop and recreate. */ \
101     /* If someone dropped it in the mean time, throw it away and don&#39;t touch it. \
102      * Otherwise, destruct it. */ \
103     if (hb_atomic_ptr_cmpexch (&amp;HB_SHAPER_DATA (shaper, object), data, nullptr)) { \
104       HB_SHAPER_DATA_DESTROY_FUNC (shaper, object) (data); \
105     } \
106     goto retry; \
107   } \
108   if (unlikely (!data)) { \
109     data = HB_SHAPER_DATA_CREATE_FUNC (shaper, object) (object); \
110     if (unlikely (!data)) \
111       data = (HB_SHAPER_DATA_TYPE (shaper, object) *) HB_SHAPER_DATA_INVALID; \
112     if (!hb_atomic_ptr_cmpexch (&amp;HB_SHAPER_DATA (shaper, object), nullptr, data)) { \
113       if (data &amp;&amp; \
114           data != HB_SHAPER_DATA_INVALID &amp;&amp; \
115           data != HB_SHAPER_DATA_SUCCEEDED) \
116         HB_SHAPER_DATA_DESTROY_FUNC (shaper, object) (data); \
117       goto retry; \
118     } \
119   } \
120   return data != nullptr &amp;&amp; !HB_SHAPER_DATA_IS_INVALID (data); \
121 }
122 
123 
124 #endif /* HB_SHAPER_PRIVATE_HH */
    </pre>
  </body>
</html>