<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/native/libfontmanager/hb-jdk-font.cc</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="harfbuzz/hb.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="hb-jdk.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/hb-jdk-font.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 



 26 #include &quot;hb.h&quot;
 27 #include &quot;hb-jdk.h&quot;
 28 #ifdef MACOSX
 29 #include &quot;hb-coretext.h&quot;
 30 #endif
 31 #include &lt;stdlib.h&gt;
 32 
 33 #if defined(__GNUC__) &amp;&amp;  __GNUC__ &gt;= 4
 34 #define HB_UNUSED       __attribute__((unused))
 35 #else
 36 #define HB_UNUSED
 37 #endif
 38 

 39 static hb_bool_t
<span class="line-modified"> 40 hb_jdk_get_glyph (hb_font_t *font HB_UNUSED,</span>























 41 		 void *font_data,
 42 		 hb_codepoint_t unicode,
 43 		 hb_codepoint_t variation_selector,
 44 		 hb_codepoint_t *glyph,
 45 		 void *user_data HB_UNUSED)
 46 {
 47 
 48     JDKFontInfo *jdkFontInfo = (JDKFontInfo*)font_data;
 49     JNIEnv* env = jdkFontInfo-&gt;env;
 50     jobject font2D = jdkFontInfo-&gt;font2D;
<span class="line-modified"> 51     if (variation_selector == 0) {</span>
<span class="line-modified"> 52         *glyph = (hb_codepoint_t)env-&gt;CallIntMethod(</span>
<span class="line-modified"> 53                      font2D, sunFontIDs.f2dCharToGlyphMID, unicode);</span>
<span class="line-removed"> 54     } else {</span>
<span class="line-removed"> 55         *glyph = (hb_codepoint_t)env-&gt;CallIntMethod(</span>
<span class="line-removed"> 56                      font2D, sunFontIDs.f2dCharToVariationGlyphMID, </span>
<span class="line-removed"> 57                      unicode, variation_selector);</span>
<span class="line-removed"> 58     }</span>
 59     if (env-&gt;ExceptionOccurred())
 60     {
 61         env-&gt;ExceptionClear();
 62     }
 63     if ((int)*glyph &lt; 0) {
 64         *glyph = 0;
 65     }
 66     return (*glyph != 0);
 67 }
 68 
 69 static hb_position_t
 70 hb_jdk_get_glyph_h_advance (hb_font_t *font HB_UNUSED,
 71 			   void *font_data,
 72 			   hb_codepoint_t glyph,
 73 			   void *user_data HB_UNUSED)
 74 {
 75 
 76     float fadv = 0.0f;
 77     if ((glyph &amp; 0xfffe) == 0xfffe) {
 78         return 0; // JDK uses this glyph code.
</pre>
<hr />
<pre>
234 			   void *font_data,
235 			   const char *name, int len,
236 			   hb_codepoint_t *glyph,
237 			   void *user_data HB_UNUSED)
238 {
239   return false;
240 }
241 
242 // remind : can we initialise this from the code we call
243 // from the class static method in Java to make it
244 // completely thread safe.
245 static hb_font_funcs_t *
246 _hb_jdk_get_font_funcs (void)
247 {
248   static hb_font_funcs_t *jdk_ffuncs = NULL;
249   hb_font_funcs_t *ff;
250 
251   if (!jdk_ffuncs) {
252       ff = hb_font_funcs_create();
253 
<span class="line-modified">254       hb_font_funcs_set_glyph_func(ff, hb_jdk_get_glyph, NULL, NULL);</span>

255       hb_font_funcs_set_glyph_h_advance_func(ff,
256                     hb_jdk_get_glyph_h_advance, NULL, NULL);
257       hb_font_funcs_set_glyph_v_advance_func(ff,
258                     hb_jdk_get_glyph_v_advance, NULL, NULL);
259       hb_font_funcs_set_glyph_h_origin_func(ff,
260                     hb_jdk_get_glyph_h_origin, NULL, NULL);
261       hb_font_funcs_set_glyph_v_origin_func(ff,
262                     hb_jdk_get_glyph_v_origin, NULL, NULL);
263       hb_font_funcs_set_glyph_h_kerning_func(ff,
264                     hb_jdk_get_glyph_h_kerning, NULL, NULL);
265       hb_font_funcs_set_glyph_v_kerning_func(ff,
266                     hb_jdk_get_glyph_v_kerning, NULL, NULL);
267       hb_font_funcs_set_glyph_extents_func(ff,
268                     hb_jdk_get_glyph_extents, NULL, NULL);
269       hb_font_funcs_set_glyph_contour_point_func(ff,
270                     hb_jdk_get_glyph_contour_point, NULL, NULL);
271       hb_font_funcs_set_glyph_name_func(ff,
272                     hb_jdk_get_glyph_name, NULL, NULL);
273       hb_font_funcs_set_glyph_from_name_func(ff,
274                     hb_jdk_get_glyph_from_name, NULL, NULL);
275       hb_font_funcs_make_immutable(ff); // done setting functions.
276       jdk_ffuncs = ff;
277   }
278   return jdk_ffuncs;
279 }
280 
281 static void _do_nothing(void) {
282 }
283 
284 static void _free_nothing(void*) {
285 }
286 















287 static hb_blob_t *
288 reference_table(hb_face_t *face HB_UNUSED, hb_tag_t tag, void *user_data) {
289 
<span class="line-modified">290   JDKFontInfo *jdkFontInfo = (JDKFontInfo*)user_data;</span>
<span class="line-modified">291   JNIEnv* env = jdkFontInfo-&gt;env;</span>
<span class="line-modified">292   jobject font2D = jdkFontInfo-&gt;font2D;</span>
<span class="line-modified">293   jsize length = 0;</span>
<span class="line-modified">294   void* buffer = NULL;</span>
<span class="line-removed">295   int cacheIdx = 0;</span>
296 
297   // HB_TAG_NONE is 0 and is used to get the whole font file.
298   // It is not expected to be needed for JDK.
<span class="line-modified">299   if (tag == 0 || jdkFontInfo-&gt;layoutTables == NULL) {</span>
300       return NULL;
301   }
302 
<span class="line-modified">303   for (cacheIdx=0; cacheIdx&lt;LAYOUTCACHE_ENTRIES; cacheIdx++) {</span>
<span class="line-modified">304     if (tag == jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].tag) break;</span>


305   }

306 
<span class="line-modified">307   if (cacheIdx &lt; LAYOUTCACHE_ENTRIES) { // if found</span>
<span class="line-modified">308       if (jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].len != -1) {</span>
<span class="line-modified">309           length = jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].len;</span>
<span class="line-modified">310           buffer = (void*)jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].ptr;</span>
<span class="line-removed">311       }</span>
312   }
<span class="line-modified">313 </span>

314   if (buffer == NULL) {
<span class="line-modified">315       jbyteArray tableBytes = (jbyteArray)</span>
<span class="line-removed">316          env-&gt;CallObjectMethod(font2D, sunFontIDs.getTableBytesMID, tag);</span>
<span class="line-removed">317       if (tableBytes == NULL) {</span>
<span class="line-removed">318           return NULL;</span>
<span class="line-removed">319       }</span>
<span class="line-removed">320       length = env-&gt;GetArrayLength(tableBytes);</span>
<span class="line-removed">321       buffer = calloc(length, sizeof(jbyte));</span>
<span class="line-removed">322       env-&gt;GetByteArrayRegion(tableBytes, 0, length, (jbyte*)buffer);</span>
<span class="line-removed">323 </span>
<span class="line-removed">324      if (cacheIdx &gt;= LAYOUTCACHE_ENTRIES) { // not a cacheable table</span>
<span class="line-removed">325           return hb_blob_create((const char *)buffer, length,</span>
<span class="line-removed">326                                  HB_MEMORY_MODE_WRITABLE,</span>
<span class="line-removed">327                                  buffer, free);</span>
<span class="line-removed">328       } else {</span>
<span class="line-removed">329         jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].len = length;</span>
<span class="line-removed">330         jdkFontInfo-&gt;layoutTables-&gt;entries[cacheIdx].ptr = buffer;</span>
<span class="line-removed">331       }</span>
332   }

333 
334   return hb_blob_create((const char *)buffer, length,
<span class="line-modified">335                          HB_MEMORY_MODE_READONLY,</span>
<span class="line-modified">336                          NULL, _free_nothing);</span>
337 }
338 

339 
































340 
<span class="line-modified">341 hb_face_t*</span>
<span class="line-modified">342 hb_jdk_face_create(JDKFontInfo *jdkFontInfo,</span>
<span class="line-modified">343                    hb_destroy_func_t destroy) {</span>
<span class="line-modified">344 </span>
<span class="line-modified">345     hb_face_t *face =</span>
<span class="line-modified">346          hb_face_create_for_tables(reference_table, jdkFontInfo, destroy);</span>
<span class="line-modified">347 </span>
<span class="line-modified">348     return face;</span>


349 }
350 
<span class="line-modified">351 static hb_font_t* _hb_jdk_font_create(JDKFontInfo *jdkFontInfo,</span>



352                                       hb_destroy_func_t destroy) {
353 
354     hb_font_t *font;
<span class="line-removed">355     hb_face_t *face;</span>
356 
<span class="line-removed">357     face = hb_jdk_face_create(jdkFontInfo, destroy);</span>
358     font = hb_font_create(face);
<span class="line-removed">359     hb_face_destroy (face);</span>
360     hb_font_set_funcs (font,
361                        _hb_jdk_get_font_funcs (),
362                        jdkFontInfo, (hb_destroy_func_t) _do_nothing);
363     hb_font_set_scale (font,
364                       HBFloatToFixed(jdkFontInfo-&gt;ptSize*jdkFontInfo-&gt;devScale),
365                       HBFloatToFixed(jdkFontInfo-&gt;ptSize*jdkFontInfo-&gt;devScale));
366   return font;
367 }
368 
369 #ifdef MACOSX
<span class="line-modified">370 static hb_font_t* _hb_jdk_ct_font_create(JDKFontInfo *jdkFontInfo) {</span>

371 
372     hb_font_t *font = NULL;
<span class="line-removed">373     hb_face_t *face = NULL;</span>
<span class="line-removed">374     if (jdkFontInfo-&gt;nativeFont == 0) {</span>
<span class="line-removed">375         return NULL;</span>
<span class="line-removed">376     }</span>
<span class="line-removed">377     face = hb_coretext_face_create((CGFontRef)(jdkFontInfo-&gt;nativeFont));</span>
378     font = hb_font_create(face);
<span class="line-removed">379     hb_face_destroy(face);</span>
<span class="line-removed">380 </span>
381     hb_font_set_scale(font,
382                      HBFloatToFixed(jdkFontInfo-&gt;ptSize),
383                      HBFloatToFixed(jdkFontInfo-&gt;ptSize));
384     return font;
385 }
386 #endif
387 
<span class="line-modified">388 hb_font_t* hb_jdk_font_create(JDKFontInfo *jdkFontInfo,</span>

389                              hb_destroy_func_t destroy) {
<span class="line-removed">390 </span>
<span class="line-removed">391    hb_font_t* font = NULL;</span>
<span class="line-removed">392 </span>
393 #ifdef MACOSX
<span class="line-modified">394      if (jdkFontInfo-&gt;aat) {</span>
<span class="line-modified">395          font = _hb_jdk_ct_font_create(jdkFontInfo);</span>
396      }
397 #endif
<span class="line-modified">398     if (font == NULL) {</span>
<span class="line-removed">399         font = _hb_jdk_font_create(jdkFontInfo, destroy);</span>
<span class="line-removed">400     }</span>
<span class="line-removed">401     return font;</span>
402 }
</pre>
</td>
<td>
<hr />
<pre>
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
<span class="line-added"> 26 #include &quot;jlong.h&quot;</span>
<span class="line-added"> 27 #include &quot;sun_font_SunLayoutEngine.h&quot;</span>
<span class="line-added"> 28 </span>
 29 #include &quot;hb.h&quot;
 30 #include &quot;hb-jdk.h&quot;
 31 #ifdef MACOSX
 32 #include &quot;hb-coretext.h&quot;
 33 #endif
 34 #include &lt;stdlib.h&gt;
 35 
 36 #if defined(__GNUC__) &amp;&amp;  __GNUC__ &gt;= 4
 37 #define HB_UNUSED       __attribute__((unused))
 38 #else
 39 #define HB_UNUSED
 40 #endif
 41 
<span class="line-added"> 42 </span>
 43 static hb_bool_t
<span class="line-modified"> 44 hb_jdk_get_nominal_glyph (hb_font_t *font HB_UNUSED,</span>
<span class="line-added"> 45 		          void *font_data,</span>
<span class="line-added"> 46 		          hb_codepoint_t unicode,</span>
<span class="line-added"> 47 		          hb_codepoint_t *glyph,</span>
<span class="line-added"> 48 		          void *user_data HB_UNUSED)</span>
<span class="line-added"> 49 {</span>
<span class="line-added"> 50 </span>
<span class="line-added"> 51     JDKFontInfo *jdkFontInfo = (JDKFontInfo*)font_data;</span>
<span class="line-added"> 52     JNIEnv* env = jdkFontInfo-&gt;env;</span>
<span class="line-added"> 53     jobject font2D = jdkFontInfo-&gt;font2D;</span>
<span class="line-added"> 54     *glyph = (hb_codepoint_t)env-&gt;CallIntMethod(</span>
<span class="line-added"> 55               font2D, sunFontIDs.f2dCharToGlyphMID, unicode);</span>
<span class="line-added"> 56     if (env-&gt;ExceptionOccurred())</span>
<span class="line-added"> 57     {</span>
<span class="line-added"> 58         env-&gt;ExceptionClear();</span>
<span class="line-added"> 59     }</span>
<span class="line-added"> 60     if ((int)*glyph &lt; 0) {</span>
<span class="line-added"> 61         *glyph = 0;</span>
<span class="line-added"> 62     }</span>
<span class="line-added"> 63     return (*glyph != 0);</span>
<span class="line-added"> 64 }</span>
<span class="line-added"> 65 </span>
<span class="line-added"> 66 static hb_bool_t</span>
<span class="line-added"> 67 hb_jdk_get_variation_glyph (hb_font_t *font HB_UNUSED,</span>
 68 		 void *font_data,
 69 		 hb_codepoint_t unicode,
 70 		 hb_codepoint_t variation_selector,
 71 		 hb_codepoint_t *glyph,
 72 		 void *user_data HB_UNUSED)
 73 {
 74 
 75     JDKFontInfo *jdkFontInfo = (JDKFontInfo*)font_data;
 76     JNIEnv* env = jdkFontInfo-&gt;env;
 77     jobject font2D = jdkFontInfo-&gt;font2D;
<span class="line-modified"> 78     *glyph = (hb_codepoint_t)env-&gt;CallIntMethod(</span>
<span class="line-modified"> 79               font2D, sunFontIDs.f2dCharToVariationGlyphMID, </span>
<span class="line-modified"> 80               unicode, variation_selector);</span>





 81     if (env-&gt;ExceptionOccurred())
 82     {
 83         env-&gt;ExceptionClear();
 84     }
 85     if ((int)*glyph &lt; 0) {
 86         *glyph = 0;
 87     }
 88     return (*glyph != 0);
 89 }
 90 
 91 static hb_position_t
 92 hb_jdk_get_glyph_h_advance (hb_font_t *font HB_UNUSED,
 93 			   void *font_data,
 94 			   hb_codepoint_t glyph,
 95 			   void *user_data HB_UNUSED)
 96 {
 97 
 98     float fadv = 0.0f;
 99     if ((glyph &amp; 0xfffe) == 0xfffe) {
100         return 0; // JDK uses this glyph code.
</pre>
<hr />
<pre>
256 			   void *font_data,
257 			   const char *name, int len,
258 			   hb_codepoint_t *glyph,
259 			   void *user_data HB_UNUSED)
260 {
261   return false;
262 }
263 
264 // remind : can we initialise this from the code we call
265 // from the class static method in Java to make it
266 // completely thread safe.
267 static hb_font_funcs_t *
268 _hb_jdk_get_font_funcs (void)
269 {
270   static hb_font_funcs_t *jdk_ffuncs = NULL;
271   hb_font_funcs_t *ff;
272 
273   if (!jdk_ffuncs) {
274       ff = hb_font_funcs_create();
275 
<span class="line-modified">276       hb_font_funcs_set_nominal_glyph_func(ff, hb_jdk_get_nominal_glyph, NULL, NULL);</span>
<span class="line-added">277       hb_font_funcs_set_variation_glyph_func(ff, hb_jdk_get_variation_glyph, NULL, NULL);</span>
278       hb_font_funcs_set_glyph_h_advance_func(ff,
279                     hb_jdk_get_glyph_h_advance, NULL, NULL);
280       hb_font_funcs_set_glyph_v_advance_func(ff,
281                     hb_jdk_get_glyph_v_advance, NULL, NULL);
282       hb_font_funcs_set_glyph_h_origin_func(ff,
283                     hb_jdk_get_glyph_h_origin, NULL, NULL);
284       hb_font_funcs_set_glyph_v_origin_func(ff,
285                     hb_jdk_get_glyph_v_origin, NULL, NULL);
286       hb_font_funcs_set_glyph_h_kerning_func(ff,
287                     hb_jdk_get_glyph_h_kerning, NULL, NULL);
288       hb_font_funcs_set_glyph_v_kerning_func(ff,
289                     hb_jdk_get_glyph_v_kerning, NULL, NULL);
290       hb_font_funcs_set_glyph_extents_func(ff,
291                     hb_jdk_get_glyph_extents, NULL, NULL);
292       hb_font_funcs_set_glyph_contour_point_func(ff,
293                     hb_jdk_get_glyph_contour_point, NULL, NULL);
294       hb_font_funcs_set_glyph_name_func(ff,
295                     hb_jdk_get_glyph_name, NULL, NULL);
296       hb_font_funcs_set_glyph_from_name_func(ff,
297                     hb_jdk_get_glyph_from_name, NULL, NULL);
298       hb_font_funcs_make_immutable(ff); // done setting functions.
299       jdk_ffuncs = ff;
300   }
301   return jdk_ffuncs;
302 }
303 
304 static void _do_nothing(void) {
305 }
306 
307 static void _free_nothing(void*) {
308 }
309 
<span class="line-added">310 struct Font2DPtr {</span>
<span class="line-added">311     JavaVM* vmPtr;</span>
<span class="line-added">312     jweak font2DRef;</span>
<span class="line-added">313 };</span>
<span class="line-added">314 </span>
<span class="line-added">315 static void cleanupFontInfo(void* data) {</span>
<span class="line-added">316   Font2DPtr* fontInfo;</span>
<span class="line-added">317   JNIEnv* env;</span>
<span class="line-added">318 </span>
<span class="line-added">319   fontInfo = (Font2DPtr*) data;</span>
<span class="line-added">320   fontInfo-&gt;vmPtr-&gt;GetEnv((void**)&amp;env, JNI_VERSION_1_1);</span>
<span class="line-added">321   env-&gt;DeleteWeakGlobalRef(fontInfo-&gt;font2DRef);</span>
<span class="line-added">322   free(data);</span>
<span class="line-added">323 }</span>
<span class="line-added">324 </span>
325 static hb_blob_t *
326 reference_table(hb_face_t *face HB_UNUSED, hb_tag_t tag, void *user_data) {
327 
<span class="line-modified">328   Font2DPtr *fontInfo;</span>
<span class="line-modified">329   JNIEnv* env;</span>
<span class="line-modified">330   jobject font2D;</span>
<span class="line-modified">331   jsize length;</span>
<span class="line-modified">332   void* buffer;</span>

333 
334   // HB_TAG_NONE is 0 and is used to get the whole font file.
335   // It is not expected to be needed for JDK.
<span class="line-modified">336   if (tag == 0) {</span>
337       return NULL;
338   }
339 
<span class="line-modified">340   fontInfo = (Font2DPtr*)user_data;</span>
<span class="line-modified">341   fontInfo-&gt;vmPtr-&gt;GetEnv((void**)&amp;env, JNI_VERSION_1_1);</span>
<span class="line-added">342   if (env == NULL) {</span>
<span class="line-added">343     return NULL;</span>
344   }
<span class="line-added">345   font2D = fontInfo-&gt;font2DRef;</span>
346 
<span class="line-modified">347   jbyteArray tableBytes = (jbyteArray)</span>
<span class="line-modified">348      env-&gt;CallObjectMethod(font2D, sunFontIDs.getTableBytesMID, tag);</span>
<span class="line-modified">349   if (tableBytes == NULL) {</span>
<span class="line-modified">350       return NULL;</span>

351   }
<span class="line-modified">352   length = env-&gt;GetArrayLength(tableBytes);</span>
<span class="line-added">353   buffer = calloc(length, sizeof(jbyte));</span>
354   if (buffer == NULL) {
<span class="line-modified">355       return NULL;</span>
















356   }
<span class="line-added">357   env-&gt;GetByteArrayRegion(tableBytes, 0, length, (jbyte*)buffer);</span>
358 
359   return hb_blob_create((const char *)buffer, length,
<span class="line-modified">360                          HB_MEMORY_MODE_WRITABLE,</span>
<span class="line-modified">361                          buffer, free);</span>
362 }
363 
<span class="line-added">364 extern &quot;C&quot; {</span>
365 
<span class="line-added">366 /*</span>
<span class="line-added">367  * Class:     sun_font_SunLayoutEngine</span>
<span class="line-added">368  * Method:    createFace</span>
<span class="line-added">369  * Signature: (Lsun/font/Font2D;ZJJ)J</span>
<span class="line-added">370  */</span>
<span class="line-added">371 JNIEXPORT jlong JNICALL Java_sun_font_SunLayoutEngine_createFace(JNIEnv *env,</span>
<span class="line-added">372                          jclass cls,</span>
<span class="line-added">373                          jobject font2D,</span>
<span class="line-added">374                          jboolean aat,</span>
<span class="line-added">375                          jlong platformFontPtr) {</span>
<span class="line-added">376 #ifdef MACOSX</span>
<span class="line-added">377     if (aat &amp;&amp; platformFontPtr) {</span>
<span class="line-added">378         hb_face_t *face = hb_coretext_face_create((CGFontRef)platformFontPtr);</span>
<span class="line-added">379         return ptr_to_jlong(face);</span>
<span class="line-added">380     }</span>
<span class="line-added">381 #endif</span>
<span class="line-added">382     Font2DPtr *fi = (Font2DPtr*)malloc(sizeof(Font2DPtr));</span>
<span class="line-added">383     if (!fi) {</span>
<span class="line-added">384         return 0;</span>
<span class="line-added">385     }</span>
<span class="line-added">386     JavaVM* vmPtr;</span>
<span class="line-added">387     env-&gt;GetJavaVM(&amp;vmPtr);</span>
<span class="line-added">388     fi-&gt;vmPtr = vmPtr;</span>
<span class="line-added">389     fi-&gt;font2DRef = env-&gt;NewWeakGlobalRef(font2D);</span>
<span class="line-added">390     if (!fi-&gt;font2DRef) {</span>
<span class="line-added">391         free(fi);</span>
<span class="line-added">392         return 0;</span>
<span class="line-added">393     }</span>
<span class="line-added">394     hb_face_t *face = hb_face_create_for_tables(reference_table, fi,</span>
<span class="line-added">395                                                 cleanupFontInfo);</span>
<span class="line-added">396     return ptr_to_jlong(face);</span>
<span class="line-added">397 }</span>
398 
<span class="line-modified">399 /*</span>
<span class="line-modified">400  * Class:     sun_font_SunLayoutEngine</span>
<span class="line-modified">401  * Method:    disposeFace</span>
<span class="line-modified">402  * Signature: (J)V</span>
<span class="line-modified">403  */</span>
<span class="line-modified">404 JNIEXPORT void JNICALL Java_sun_font_SunLayoutEngine_disposeFace(JNIEnv *env,</span>
<span class="line-modified">405                         jclass cls,</span>
<span class="line-modified">406                         jlong ptr) {</span>
<span class="line-added">407     hb_face_t* face = (hb_face_t*) jlong_to_ptr(ptr);</span>
<span class="line-added">408     hb_face_destroy(face);</span>
409 }
410 
<span class="line-modified">411 } // extern &quot;C&quot;</span>
<span class="line-added">412 </span>
<span class="line-added">413 static hb_font_t* _hb_jdk_font_create(hb_face_t* face,</span>
<span class="line-added">414                                       JDKFontInfo *jdkFontInfo,</span>
415                                       hb_destroy_func_t destroy) {
416 
417     hb_font_t *font;

418 

419     font = hb_font_create(face);

420     hb_font_set_funcs (font,
421                        _hb_jdk_get_font_funcs (),
422                        jdkFontInfo, (hb_destroy_func_t) _do_nothing);
423     hb_font_set_scale (font,
424                       HBFloatToFixed(jdkFontInfo-&gt;ptSize*jdkFontInfo-&gt;devScale),
425                       HBFloatToFixed(jdkFontInfo-&gt;ptSize*jdkFontInfo-&gt;devScale));
426   return font;
427 }
428 
429 #ifdef MACOSX
<span class="line-modified">430 static hb_font_t* _hb_jdk_ct_font_create(hb_face_t* face,</span>
<span class="line-added">431                    JDKFontInfo *jdkFontInfo) {</span>
432 
433     hb_font_t *font = NULL;





434     font = hb_font_create(face);


435     hb_font_set_scale(font,
436                      HBFloatToFixed(jdkFontInfo-&gt;ptSize),
437                      HBFloatToFixed(jdkFontInfo-&gt;ptSize));
438     return font;
439 }
440 #endif
441 
<span class="line-modified">442 hb_font_t* hb_jdk_font_create(hb_face_t* hbFace,</span>
<span class="line-added">443                              JDKFontInfo *jdkFontInfo,</span>
444                              hb_destroy_func_t destroy) {



445 #ifdef MACOSX
<span class="line-modified">446      if (jdkFontInfo-&gt;aat &amp;&amp; jdkFontInfo-&gt;nativeFont) {</span>
<span class="line-modified">447          return _hb_jdk_ct_font_create(hbFace, jdkFontInfo);</span>
448      }
449 #endif
<span class="line-modified">450     return _hb_jdk_font_create(hbFace, jdkFontInfo, destroy);</span>



451 }
</pre>
</td>
</tr>
</table>
<center><a href="harfbuzz/hb.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="hb-jdk.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>