<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-color-colr-table.hh</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="hb-ot-color-cbdt-table.hh.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-color-cpal-table.hh.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/native/libfontmanager/harfbuzz/hb-ot-color-colr-table.hh</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 23,11 ***</span>
   */
  
  #ifndef HB_OT_COLOR_COLR_TABLE_HH
  #define HB_OT_COLOR_COLR_TABLE_HH
  
<span class="line-modified">! #include &quot;hb-open-type-private.hh&quot;</span>
  
  /*
   * COLR -- Color
   * https://docs.microsoft.com/en-us/typography/opentype/spec/colr
   */
<span class="line-new-header">--- 23,11 ---</span>
   */
  
  #ifndef HB_OT_COLOR_COLR_TABLE_HH
  #define HB_OT_COLOR_COLR_TABLE_HH
  
<span class="line-modified">! #include &quot;hb-open-type.hh&quot;</span>
  
  /*
   * COLR -- Color
   * https://docs.microsoft.com/en-us/typography/opentype/spec/colr
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 37,105 ***</span>
  namespace OT {
  
  
  struct LayerRecord
  {
<span class="line-modified">!   friend struct COLR;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   inline bool sanitize (hb_sanitize_context_t *c) const</span>
    {
      TRACE_SANITIZE (this);
      return_trace (c-&gt;check_struct (this));
    }
  
<span class="line-modified">!   protected:</span>
<span class="line-modified">!   GlyphID       glyphid;        /* Glyph ID of layer glyph */</span>
<span class="line-modified">!   HBUINT16      colorIdx;       /* Index value to use with a selected color palette */</span>
    public:
    DEFINE_SIZE_STATIC (4);
  };
  
  struct BaseGlyphRecord
  {
<span class="line-modified">!   friend struct COLR;</span>
  
<span class="line-modified">!   inline bool sanitize (hb_sanitize_context_t *c) const</span>
    {
      TRACE_SANITIZE (this);
      return_trace (likely (c-&gt;check_struct (this)));
    }
  
<span class="line-modified">!   inline int cmp (hb_codepoint_t g) const {</span>
<span class="line-modified">!     return g &lt; glyphid ? -1 : g &gt; glyphid ? 1 : 0;</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-modified">!   protected:</span>
<span class="line-modified">!   GlyphID       glyphid;        /* Glyph ID of reference glyph */</span>
<span class="line-modified">!   HBUINT16      firstLayerIdx;  /* Index to the layer record */</span>
<span class="line-modified">!   HBUINT16      numLayers;      /* Number of color layers associated with this glyph */</span>
    public:
    DEFINE_SIZE_STATIC (6);
  };
  
<span class="line-removed">- static int compare_bgr (const void *pa, const void *pb)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-   const hb_codepoint_t *a = (const hb_codepoint_t *) pa;</span>
<span class="line-removed">-   const BaseGlyphRecord *b = (const BaseGlyphRecord *) pb;</span>
<span class="line-removed">-   return b-&gt;cmp (*a);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  struct COLR
  {
<span class="line-modified">!   static const hb_tag_t tableTag = HB_OT_TAG_COLR;</span>
  
<span class="line-modified">!   inline bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="line-removed">-   {</span>
<span class="line-removed">-     TRACE_SANITIZE (this);</span>
<span class="line-removed">-     return_trace (likely (c-&gt;check_struct (this) &amp;&amp;</span>
<span class="line-removed">-                           (this+baseGlyphsZ).sanitize (c, numBaseGlyphs) &amp;&amp;</span>
<span class="line-removed">-                           (this+layersZ).sanitize (c, numLayers)));</span>
<span class="line-removed">-   }</span>
  
<span class="line-modified">!   inline bool get_base_glyph_record (hb_codepoint_t glyph_id,</span>
<span class="line-modified">!                                      unsigned int *first_layer /* OUT */,</span>
<span class="line-modified">!                                      unsigned int *num_layers /* OUT */) const</span>
    {
<span class="line-modified">!     const BaseGlyphRecord* record;</span>
<span class="line-removed">-     record = (BaseGlyphRecord *) bsearch (&amp;glyph_id, &amp;(this+baseGlyphsZ), numBaseGlyphs,</span>
<span class="line-removed">-                                           sizeof (BaseGlyphRecord), compare_bgr);</span>
<span class="line-removed">-     if (unlikely (!record))</span>
<span class="line-removed">-       return false;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     *first_layer = record-&gt;firstLayerIdx;</span>
<span class="line-removed">-     *num_layers = record-&gt;numLayers;</span>
<span class="line-removed">-     return true;</span>
<span class="line-removed">-   }</span>
  
<span class="line-modified">!   inline bool get_layer_record (unsigned int record,</span>
<span class="line-modified">!                                 hb_codepoint_t *glyph_id /* OUT */,</span>
<span class="line-modified">!                                 unsigned int *palette_index /* OUT */) const</span>
<span class="line-modified">!   {</span>
<span class="line-removed">-     if (unlikely (record &gt;= numLayers))</span>
      {
<span class="line-modified">!       *glyph_id = 0;</span>
<span class="line-modified">!       *palette_index = 0xFFFF;</span>
<span class="line-modified">!       return false;</span>
      }
<span class="line-modified">!     const LayerRecord &amp;layer = (this+layersZ)[record];</span>
<span class="line-modified">!     *glyph_id = layer.glyphid;</span>
<span class="line-modified">!     *palette_index = layer.colorIdx;</span>
<span class="line-modified">!     return true;</span>
    }
  
    protected:
<span class="line-modified">!   HBUINT16      version;        /* Table version number */</span>
<span class="line-modified">!   HBUINT16      numBaseGlyphs;  /* Number of Base Glyph Records */</span>
<span class="line-modified">!   LOffsetTo&lt;UnsizedArrayOf&lt;BaseGlyphRecord&gt; &gt;</span>
                  baseGlyphsZ;    /* Offset to Base Glyph records. */
<span class="line-modified">!   LOffsetTo&lt;UnsizedArrayOf&lt;LayerRecord&gt; &gt;</span>
<span class="line-modified">!                 layersZ;        /* Offset to Layer Records */</span>
<span class="line-modified">!   HBUINT16      numLayers;      /* Number of Layer Records */</span>
    public:
    DEFINE_SIZE_STATIC (14);
  };
  
  } /* namespace OT */
<span class="line-new-header">--- 37,101 ---</span>
  namespace OT {
  
  
  struct LayerRecord
  {
<span class="line-modified">!   bool sanitize (hb_sanitize_context_t *c) const</span>
    {
      TRACE_SANITIZE (this);
      return_trace (c-&gt;check_struct (this));
    }
  
<span class="line-modified">!   public:</span>
<span class="line-modified">!   GlyphID       glyphId;        /* Glyph ID of layer glyph */</span>
<span class="line-modified">!   Index         colorIdx;       /* Index value to use with a</span>
<span class="line-added">+                                  * selected color palette.</span>
<span class="line-added">+                                  * An index value of 0xFFFF</span>
<span class="line-added">+                                  * is a special case indicating</span>
<span class="line-added">+                                  * that the text foreground</span>
<span class="line-added">+                                  * color (defined by a</span>
<span class="line-added">+                                  * higher-level client) should</span>
<span class="line-added">+                                  * be used and shall not be</span>
<span class="line-added">+                                  * treated as actual index</span>
<span class="line-added">+                                  * into CPAL ColorRecord array. */</span>
    public:
    DEFINE_SIZE_STATIC (4);
  };
  
  struct BaseGlyphRecord
  {
<span class="line-modified">!   int cmp (hb_codepoint_t g) const</span>
<span class="line-added">+   { return g &lt; glyphId ? -1 : g &gt; glyphId ? 1 : 0; }</span>
  
<span class="line-modified">!   bool sanitize (hb_sanitize_context_t *c) const</span>
    {
      TRACE_SANITIZE (this);
      return_trace (likely (c-&gt;check_struct (this)));
    }
  
<span class="line-modified">!   public:</span>
<span class="line-modified">!   GlyphID       glyphId;        /* Glyph ID of reference glyph */</span>
<span class="line-modified">!   HBUINT16      firstLayerIdx;  /* Index (from beginning of</span>
<span class="line-modified">!                                  * the Layer Records) to the</span>
<span class="line-modified">!                                  * layer record. There will be</span>
<span class="line-modified">!                                  * numLayers consecutive entries</span>
<span class="line-modified">!                                  * for this base glyph. */</span>
<span class="line-modified">!   HBUINT16      numLayers;      /* Number of color layers</span>
<span class="line-added">+                                  * associated with this glyph */</span>
    public:
    DEFINE_SIZE_STATIC (6);
  };
  
  struct COLR
  {
<span class="line-modified">!   static constexpr hb_tag_t tableTag = HB_OT_TAG_COLR;</span>
  
<span class="line-modified">!   bool has_data () const { return numBaseGlyphs; }</span>
  
<span class="line-modified">!   unsigned int get_glyph_layers (hb_codepoint_t       glyph,</span>
<span class="line-modified">!                                  unsigned int         start_offset,</span>
<span class="line-modified">!                                  unsigned int        *count, /* IN/OUT.  May be NULL. */</span>
<span class="line-added">+                                  hb_ot_color_layer_t *layers /* OUT.     May be NULL. */) const</span>
    {
<span class="line-modified">!     const BaseGlyphRecord &amp;record = (this+baseGlyphsZ).bsearch (numBaseGlyphs, glyph);</span>
  
<span class="line-modified">!     hb_array_t&lt;const LayerRecord&gt; all_layers ((this+layersZ).arrayZ, numLayers);</span>
<span class="line-modified">!     hb_array_t&lt;const LayerRecord&gt; glyph_layers = all_layers.sub_array (record.firstLayerIdx,</span>
<span class="line-modified">!                                                                        record.numLayers);</span>
<span class="line-modified">!     if (count)</span>
      {
<span class="line-modified">!       hb_array_t&lt;const LayerRecord&gt; segment_layers = glyph_layers.sub_array (start_offset, *count);</span>
<span class="line-modified">!       *count = segment_layers.length;</span>
<span class="line-modified">!       for (unsigned int i = 0; i &lt; segment_layers.length; i++)</span>
<span class="line-added">+       {</span>
<span class="line-added">+         layers[i].glyph = segment_layers.arrayZ[i].glyphId;</span>
<span class="line-added">+         layers[i].color_index = segment_layers.arrayZ[i].colorIdx;</span>
<span class="line-added">+       }</span>
      }
<span class="line-modified">!     return glyph_layers.length;</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-modified">!   bool sanitize (hb_sanitize_context_t *c) const</span>
<span class="line-added">+   {</span>
<span class="line-added">+     TRACE_SANITIZE (this);</span>
<span class="line-added">+     return_trace (likely (c-&gt;check_struct (this) &amp;&amp;</span>
<span class="line-added">+                           (this+baseGlyphsZ).sanitize (c, numBaseGlyphs) &amp;&amp;</span>
<span class="line-added">+                           (this+layersZ).sanitize (c, numLayers)));</span>
    }
  
    protected:
<span class="line-modified">!   HBUINT16      version;        /* Table version number (starts at 0). */</span>
<span class="line-modified">!   HBUINT16      numBaseGlyphs;  /* Number of Base Glyph Records. */</span>
<span class="line-modified">!   LNNOffsetTo&lt;SortedUnsizedArrayOf&lt;BaseGlyphRecord&gt; &gt;</span>
                  baseGlyphsZ;    /* Offset to Base Glyph records. */
<span class="line-modified">!   LNNOffsetTo&lt;UnsizedArrayOf&lt;LayerRecord&gt; &gt;</span>
<span class="line-modified">!                 layersZ;        /* Offset to Layer Records. */</span>
<span class="line-modified">!   HBUINT16      numLayers;      /* Number of Layer Records. */</span>
    public:
    DEFINE_SIZE_STATIC (14);
  };
  
  } /* namespace OT */
</pre>
<center><a href="hb-ot-color-cbdt-table.hh.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="hb-ot-color-cpal-table.hh.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>