<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/classes/com/sun/media/sound/DataPusher.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AuFileReader.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DirectAudioDevice.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/com/sun/media/sound/DataPusher.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2002, 2013, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,11 +42,10 @@</span>
   */
  
  public final class DataPusher implements Runnable {
  
      private static final int AUTO_CLOSE_TIME = 5000;
<span class="udiff-line-removed">-     private static final boolean DEBUG = false;</span>
  
      private final SourceDataLine source;
      private final AudioFormat format;
  
      // stream as source data
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -92,71 +91,57 @@</span>
      public synchronized void start() {
          start(false);
      }
  
      public synchronized void start(boolean loop) {
<span class="udiff-line-removed">-         if (DEBUG || Printer.debug) Printer.debug(&quot;&gt; DataPusher.start(loop=&quot;+loop+&quot;)&quot;);</span>
          try {
              if (threadState == STATE_STOPPING) {
                  // wait that the thread has finished stopping
<span class="udiff-line-removed">-                 if (DEBUG || Printer.trace)Printer.trace(&quot;DataPusher.start(): calling stop()&quot;);</span>
                  stop();
              }
              looping = loop;
              newPos = 0;
              wantedState = STATE_PLAYING;
              if (!source.isOpen()) {
<span class="udiff-line-removed">-                 if (DEBUG || Printer.trace)Printer.trace(&quot;DataPusher: source.open()&quot;);</span>
                  source.open(format);
              }
<span class="udiff-line-removed">-             if (DEBUG || Printer.trace)Printer.trace(&quot;DataPusher: source.flush()&quot;);</span>
              source.flush();
<span class="udiff-line-removed">-             if (DEBUG || Printer.trace)Printer.trace(&quot;DataPusher: source.start()&quot;);</span>
              source.start();
              if (pushThread == null) {
<span class="udiff-line-removed">-                 if (DEBUG || Printer.debug) Printer.debug(&quot;DataPusher.start(): Starting push&quot;);</span>
                  pushThread = JSSecurityManager.createThread(this,
                                                              null,   // name
                                                              false,  // daemon
                                                              -1,    // priority
                                                              true); // doStart
              }
              notifyAll();
          } catch (Exception e) {
<span class="udiff-line-modified-removed">-             if (DEBUG || Printer.err) e.printStackTrace();</span>
<span class="udiff-line-modified-added">+             if (Printer.err) e.printStackTrace();</span>
          }
<span class="udiff-line-removed">-         if (DEBUG || Printer.debug) Printer.debug(&quot;&lt; DataPusher.start(loop=&quot;+loop+&quot;)&quot;);</span>
      }
  
      public synchronized void stop() {
<span class="udiff-line-removed">-         if (DEBUG || Printer.debug) Printer.debug(&quot;&gt; DataPusher.stop()&quot;);</span>
          if (threadState == STATE_STOPPING
              || threadState == STATE_STOPPED
              || pushThread == null) {
<span class="udiff-line-removed">-             if (DEBUG || Printer.debug) Printer.debug(&quot;DataPusher.stop(): nothing to do&quot;);</span>
              return;
          }
<span class="udiff-line-removed">-         if (DEBUG || Printer.debug) Printer.debug(&quot;DataPusher.stop(): Stopping push&quot;);</span>
<span class="udiff-line-removed">- </span>
          wantedState = STATE_WAITING;
          if (source != null) {
<span class="udiff-line-removed">-             if (DEBUG || Printer.trace)Printer.trace(&quot;DataPusher: source.flush()&quot;);</span>
              source.flush();
          }
          notifyAll();
          int maxWaitCount = 50; // 5 seconds
          while ((maxWaitCount-- &gt;= 0) &amp;&amp; (threadState == STATE_PLAYING)) {
              try {
                  wait(100);
              } catch (InterruptedException e) {  }
          }
<span class="udiff-line-removed">-         if (DEBUG || Printer.debug) Printer.debug(&quot;&lt; DataPusher.stop()&quot;);</span>
      }
  
      synchronized void close() {
          if (source != null) {
<span class="udiff-line-removed">-                 if (DEBUG || Printer.trace)Printer.trace(&quot;DataPusher.close(): source.close()&quot;);</span>
                  source.close();
          }
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -173,19 +158,17 @@</span>
          }
          while (wantedState != STATE_STOPPING) {
              //try {
                  if (wantedState == STATE_WAITING) {
                      // wait for 5 seconds - maybe the clip is to be played again
<span class="udiff-line-removed">-                     if (DEBUG || Printer.debug)Printer.debug(&quot;DataPusher.run(): waiting 5 seconds&quot;);</span>
                      try {
                          synchronized(this) {
                                  threadState = STATE_WAITING;
                                  wantedState = STATE_STOPPING;
                                  wait(AUTO_CLOSE_TIME);
                          }
                      } catch (InterruptedException ie) {}
<span class="udiff-line-removed">-                     if (DEBUG || Printer.debug)Printer.debug(&quot;DataPusher.run(): waiting finished&quot;);</span>
                      continue;
                  }
                  if (newPos &gt;= 0) {
                          pos = newPos;
                          newPos = -1;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -209,39 +192,28 @@</span>
                      if (toWrite == 0) {
                          toWrite = -1; // end of &quot;stream&quot;
                      }
                  }
                  if (toWrite &lt; 0) {
<span class="udiff-line-removed">-                     if (DEBUG || Printer.debug) Printer.debug(&quot;DataPusher.run(): Found end of stream&quot;);</span>
                          if (!useStream &amp;&amp; looping) {
<span class="udiff-line-removed">-                             if (DEBUG || Printer.debug)Printer.debug(&quot;DataPusher.run(): setting pos back to 0&quot;);</span>
                              pos = 0;
                              continue;
                          }
<span class="udiff-line-removed">-                     if (DEBUG || Printer.debug)Printer.debug(&quot;DataPusher.run(): calling drain()&quot;);</span>
                      wantedState = STATE_WAITING;
                      source.drain();
                      continue;
                  }
<span class="udiff-line-modified-removed">-                 if (DEBUG || Printer.debug) Printer.debug(&quot;&gt; DataPusher.run(): Writing &quot; + toWrite + &quot; bytes&quot;);</span>
<span class="udiff-line-modified-removed">-                     int bytesWritten = source.write(buffer, pos, toWrite);</span>
<span class="udiff-line-removed">-                     pos += bytesWritten;</span>
<span class="udiff-line-removed">-                 if (DEBUG || Printer.debug) Printer.debug(&quot;&lt; DataPusher.run(): Wrote &quot; + bytesWritten + &quot; bytes&quot;);</span>
<span class="udiff-line-modified-added">+                 int bytesWritten = source.write(buffer, pos, toWrite);</span>
<span class="udiff-line-modified-added">+                 pos += bytesWritten;</span>
          }
          threadState = STATE_STOPPING;
<span class="udiff-line-removed">-         if (DEBUG || Printer.debug)Printer.debug(&quot;DataPusher: closing device&quot;);</span>
<span class="udiff-line-removed">-         if (Printer.trace)Printer.trace(&quot;DataPusher: source.flush()&quot;);</span>
          source.flush();
<span class="udiff-line-removed">-         if (DEBUG || Printer.trace)Printer.trace(&quot;DataPusher: source.stop()&quot;);</span>
          source.stop();
<span class="udiff-line-removed">-         if (DEBUG || Printer.trace)Printer.trace(&quot;DataPusher: source.flush()&quot;);</span>
          source.flush();
<span class="udiff-line-removed">-         if (DEBUG || Printer.trace)Printer.trace(&quot;DataPusher: source.close()&quot;);</span>
          source.close();
          threadState = STATE_STOPPED;
          synchronized (this) {
                  pushThread = null;
                  notifyAll();
          }
<span class="udiff-line-removed">-         if (DEBUG || Printer.debug)Printer.debug(&quot;DataPusher:end of thread&quot;);</span>
      }
  } // class DataPusher
</pre>
<center><a href="AuFileReader.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DirectAudioDevice.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>