<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/classes/com/sun/media/sound/DirectAudioDevice.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DataPusher.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DirectAudioDeviceProvider.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/com/sun/media/sound/DirectAudioDevice.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 62,13 ***</span>
          // pass in Line.Info, mixer, controls
          super(portMixerInfo,              // Mixer.Info
                null,                       // Control[]
                null,                       // Line.Info[] sourceLineInfo
                null);                      // Line.Info[] targetLineInfo
<span class="line-removed">- </span>
<span class="line-removed">-         if (Printer.trace) Printer.trace(&quot;&gt;&gt; DirectAudioDevice: constructor&quot;);</span>
<span class="line-removed">- </span>
          // source lines
          DirectDLI srcLineInfo = createDataLineInfo(true);
          if (srcLineInfo != null) {
              sourceLineInfo = new Line.Info[2];
              // SourcedataLine
<span class="line-new-header">--- 62,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 88,11 ***</span>
              targetLineInfo = new Line.Info[1];
              targetLineInfo[0] = dstLineInfo;
          } else {
              targetLineInfo = new Line.Info[0];
          }
<span class="line-removed">-         if (Printer.trace) Printer.trace(&quot;&lt;&lt; DirectAudioDevice: constructor completed&quot;);</span>
      }
  
      private DirectDLI createDataLineInfo(boolean isSource) {
          Vector&lt;AudioFormat&gt; formats = new Vector&lt;&gt;();
          AudioFormat[] hardwareFormatArray = null;
<span class="line-new-header">--- 85,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 234,26 ***</span>
          return 0;
      }
  
      @Override
      protected void implOpen() throws LineUnavailableException {
<span class="line-removed">-         if (Printer.trace) Printer.trace(&quot;DirectAudioDevice: implOpen - void method&quot;);</span>
      }
  
      @Override
      protected void implClose() {
<span class="line-removed">-         if (Printer.trace) Printer.trace(&quot;DirectAudioDevice: implClose - void method&quot;);</span>
      }
  
      @Override
      protected void implStart() {
<span class="line-removed">-         if (Printer.trace) Printer.trace(&quot;DirectAudioDevice: implStart - void method&quot;);</span>
      }
  
      @Override
      protected void implStop() {
<span class="line-removed">-         if (Printer.trace) Printer.trace(&quot;DirectAudioDevice: implStop - void method&quot;);</span>
      }
  
      int getMixerIndex() {
          return ((DirectAudioDeviceProvider.DirectAudioDeviceInfo) getMixerInfo()).getIndex();
      }
<span class="line-new-header">--- 230,22 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 398,22 ***</span>
                             int bufferSize,
                             int mixerIndex,
                             int deviceID,
                             boolean isSource) {
              super(info, mixer, null, format, bufferSize);
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;DirectDL CONSTRUCTOR: info: &quot; + info);</span>
              this.mixerIndex = mixerIndex;
              this.deviceID = deviceID;
              this.waitTime = 10; // 10 milliseconds default wait time
              this.isSource = isSource;
  
          }
  
          @Override
          void implOpen(AudioFormat format, int bufferSize) throws LineUnavailableException {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt;&gt; DirectDL: implOpen(&quot;+format+&quot;, &quot;+bufferSize+&quot; bytes)&quot;);</span>
<span class="line-removed">- </span>
              // $$fb part of fix for 4679187: Clip.open() throws unexpected Exceptions
              Toolkit.isFullySpecifiedAudioFormat(format);
  
              // check for record permission
              if (!isSource) {
<span class="line-new-header">--- 390,19 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 460,12 ***</span>
                      }
                      controls[0] = gainControl;
                      controls[1] = muteControl;
                  }
              }
<span class="line-removed">-             if (Printer.debug) Printer.debug(&quot;DirectAudioDevice: got &quot;+controls.length+&quot; controls.&quot;);</span>
<span class="line-removed">- </span>
              hardwareFormat = format;
  
              /* some magic to account for not-supported endianness or signed-ness */
              softwareConversionSize = 0;
              if (ddli != null &amp;&amp; !ddli.isFormatSupportedInHardware(format)) {
<span class="line-new-header">--- 449,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 473,16 ***</span>
                  if (ddli.isFormatSupportedInHardware(newFormat)) {
                      // apparently, the new format can be used.
                      hardwareFormat = newFormat;
                      // So do endian/sign conversion in software
                      softwareConversionSize = format.getFrameSize() / format.getChannels();
<span class="line-removed">-                     if (Printer.debug) {</span>
<span class="line-removed">-                         Printer.debug(&quot;DirectAudioDevice: softwareConversionSize &quot;</span>
<span class="line-removed">-                                       +softwareConversionSize+&quot;:&quot;);</span>
<span class="line-removed">-                         Printer.debug(&quot;  from &quot;+format);</span>
<span class="line-removed">-                         Printer.debug(&quot;  to   &quot;+newFormat);</span>
<span class="line-removed">-                     }</span>
                  }
              }
  
              // align buffer to full frames
              bufferSize = ( bufferSize / format.getFrameSize()) * format.getFrameSize();
<span class="line-new-header">--- 460,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 522,18 ***</span>
              }
              bytePosition = 0;
              stoppedWritten = false;
              doIO = false;
              calcVolume();
<span class="line-removed">- </span>
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt;&lt; DirectDL: implOpen() succeeded&quot;);</span>
          }
  
          @Override
          void implStart() {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot; &gt;&gt; DirectDL: implStart()&quot;);</span>
<span class="line-removed">- </span>
              // check for record permission
              if (!isSource) {
                  JSSecurityManager.checkRecordPermission();
              }
  
<span class="line-new-header">--- 503,14 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 555,18 ***</span>
                  if (isSource &amp;&amp; stoppedWritten) {
                      setStarted(true);
                      setActive(true);
                  }
              }
<span class="line-removed">- </span>
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt;&lt; DirectDL: implStart() succeeded&quot;);</span>
          }
  
          @Override
          void implStop() {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt;&gt; DirectDL: implStop()&quot;);</span>
<span class="line-removed">- </span>
              // check for record permission
              if (!isSource) {
                  JSSecurityManager.checkRecordPermission();
              }
  
<span class="line-new-header">--- 532,14 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 586,18 ***</span>
                  setActive(false);
                  setStarted(false);
                  lock.notifyAll();
              }
              stoppedWritten = false;
<span class="line-removed">- </span>
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot; &lt;&lt; DirectDL: implStop() succeeded&quot;);</span>
          }
  
          @Override
          void implClose() {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt;&gt; DirectDL: implClose()&quot;);</span>
<span class="line-removed">- </span>
              // check for record permission
              if (!isSource) {
                  JSSecurityManager.checkRecordPermission();
              }
  
<span class="line-new-header">--- 559,14 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 613,11 ***</span>
              synchronized (lockNative) {
                  nClose(oldID, isSource);
              }
              bytePosition = 0;
              softwareConversionSize = 0;
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt;&lt; DirectDL: implClose() succeeded&quot;);</span>
          }
  
          @Override
          public int available() {
              if (id == 0) {
<span class="line-new-header">--- 582,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 698,12 ***</span>
              synchronized (lockNative) {
                  pos = nGetBytePosition(id, isSource, bytePosition);
              }
              // hack because ALSA sometimes reports wrong framepos
              if (pos &lt; 0) {
<span class="line-removed">-                 if (Printer.debug) Printer.debug(&quot;DirectLine.getLongFramePosition: Native reported pos=&quot;</span>
<span class="line-removed">-                                                  +pos+&quot;! is changed to 0. byteposition=&quot;+bytePosition);</span>
                  pos = 0;
              }
              return (pos / getFormat().getFrameSize());
          }
  
<span class="line-new-header">--- 666,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 918,13 ***</span>
          private DirectSDL(DataLine.Info info,
                            AudioFormat format,
                            int bufferSize,
                            DirectAudioDevice mixer) {
              super(info, mixer, format, bufferSize, mixer.getMixerIndex(), mixer.getDeviceID(), true);
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;DirectSDL CONSTRUCTOR: completed&quot;);</span>
          }
<span class="line-removed">- </span>
      }
  
      /**
       * Private inner class representing a TargetDataLine.
       */
<span class="line-new-header">--- 884,11 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 934,11 ***</span>
          private DirectTDL(DataLine.Info info,
                            AudioFormat format,
                            int bufferSize,
                            DirectAudioDevice mixer) {
              super(info, mixer, format, bufferSize, mixer.getMixerIndex(), mixer.getDeviceID(), false);
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;DirectTDL CONSTRUCTOR: completed&quot;);</span>
          }
  
          @Override
          public int read(byte[] b, int off, int len) {
              flushing = false;
<span class="line-new-header">--- 898,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1027,11 ***</span>
          private DirectClip(DataLine.Info info,
                             AudioFormat format,
                             int bufferSize,
                             DirectAudioDevice mixer) {
              super(info, mixer, format, bufferSize, mixer.getMixerIndex(), mixer.getDeviceID(), true);
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;DirectClip CONSTRUCTOR: completed&quot;);</span>
          }
  
          // CLIP METHODS
  
          @Override
<span class="line-new-header">--- 990,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1053,14 ***</span>
  
              // $$fb part of fix for 4679187: Clip.open() throws unexpected Exceptions
              Toolkit.isFullySpecifiedAudioFormat(format);
  
              synchronized (mixer) {
<span class="line-removed">-                 if (Printer.trace) Printer.trace(&quot;&gt; DirectClip.open(format, data, frameLength)&quot;);</span>
<span class="line-removed">-                 if (Printer.debug) Printer.debug(&quot;   data=&quot;+((data==null)?&quot;null&quot;:&quot;&quot;+data.length+&quot; bytes&quot;));</span>
<span class="line-removed">-                 if (Printer.debug) Printer.debug(&quot;   frameLength=&quot;+frameLength);</span>
<span class="line-removed">- </span>
                  if (isOpen()) {
                      throw new IllegalStateException(&quot;Clip is already open with format &quot; + getFormat() +
                                                      &quot; and frame lengh of &quot; + getFrameLength());
                  } else {
                      // if the line is not currently open, try to open it with this format and buffer size
<span class="line-new-header">--- 1015,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1101,30 ***</span>
                  }
              }
              if (isAutoClosing()) {
                  getEventDispatcher().autoClosingClipOpened(this);
              }
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt; DirectClip.open completed&quot;);</span>
          }
  
          @Override
          public void open(AudioInputStream stream) throws LineUnavailableException, IOException {
  
              // $$fb part of fix for 4679187: Clip.open() throws unexpected Exceptions
              Toolkit.isFullySpecifiedAudioFormat(format);
  
              synchronized (mixer) {
<span class="line-removed">-                 if (Printer.trace) Printer.trace(&quot;&gt; DirectClip.open(stream)&quot;);</span>
                  byte[] streamData = null;
  
                  if (isOpen()) {
                      throw new IllegalStateException(&quot;Clip is already open with format &quot; + getFormat() +
                                                      &quot; and frame lengh of &quot; + getFrameLength());
                  }
                  int lengthInFrames = (int)stream.getFrameLength();
<span class="line-removed">-                 if (Printer.debug) Printer.debug(&quot;DirectClip: open(AIS): lengthInFrames: &quot; + lengthInFrames);</span>
<span class="line-removed">- </span>
                  int bytesRead = 0;
                  if (lengthInFrames != AudioSystem.NOT_SPECIFIED) {
                      // read the data from the stream into an array in one fell swoop.
                      int arraysize = lengthInFrames * stream.getFormat().getFrameSize();
                      streamData = new byte[arraysize];
<span class="line-new-header">--- 1059,26 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1162,16 ***</span>
                      } // while
                      streamData = dbaos.getInternalBuffer();
                  }
                  lengthInFrames = bytesRead / stream.getFormat().getFrameSize();
  
<span class="line-removed">-                 if (Printer.debug) Printer.debug(&quot;Read to end of stream. lengthInFrames: &quot; + lengthInFrames);</span>
<span class="line-removed">- </span>
                  // now try to open the device
                  open(stream.getFormat(), streamData, lengthInFrames);
<span class="line-removed">- </span>
<span class="line-removed">-                 if (Printer.trace) Printer.trace(&quot;&lt; DirectClip.open(stream) succeeded&quot;);</span>
              } // synchronized
          }
  
          @Override
          public int getFrameLength() {
<span class="line-new-header">--- 1116,12 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1183,12 ***</span>
              return Toolkit.frames2micros(getFormat(), getFrameLength());
          }
  
          @Override
          public void setFramePosition(int frames) {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt; DirectClip: setFramePosition: &quot; + frames);</span>
<span class="line-removed">- </span>
              if (frames &lt; 0) {
                  frames = 0;
              }
              else if (frames &gt;= getFrameLength()) {
                  frames = getFrameLength();
<span class="line-new-header">--- 1133,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1211,18 ***</span>
              // set new native position (if necessary)
              // this must come after the flush!
              synchronized (lockNative) {
                  nSetBytePosition(id, isSource, frames * frameSize);
              }
<span class="line-removed">- </span>
<span class="line-removed">-             if (Printer.debug) Printer.debug(&quot;  DirectClip.setFramePosition: &quot;</span>
<span class="line-removed">-                                              +&quot; doIO=&quot;+doIO</span>
<span class="line-removed">-                                              +&quot; newFramePosition=&quot;+newFramePosition</span>
<span class="line-removed">-                                              +&quot; clipBytePosition=&quot;+clipBytePosition</span>
<span class="line-removed">-                                              +&quot; bytePosition=&quot;+bytePosition</span>
<span class="line-removed">-                                              +&quot; getLongFramePosition()=&quot;+getLongFramePosition());</span>
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt; DirectClip: setFramePosition&quot;);</span>
          }
  
          // replacement for getFramePosition (see AbstractDataLine)
          @Override
          public long getLongFramePosition() {
<span class="line-new-header">--- 1159,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1239,22 ***</span>
              return super.getLongFramePosition();
          }
  
          @Override
          public synchronized void setMicrosecondPosition(long microseconds) {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt; DirectClip: setMicrosecondPosition: &quot; + microseconds);</span>
<span class="line-removed">- </span>
              long frames = Toolkit.micros2frames(getFormat(), microseconds);
              setFramePosition((int) frames);
<span class="line-removed">- </span>
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt; DirectClip: setMicrosecondPosition succeeded&quot;);</span>
          }
  
          @Override
          public void setLoopPoints(int start, int end) {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt; DirectClip: setLoopPoints: start: &quot; + start + &quot; end: &quot; + end);</span>
<span class="line-removed">- </span>
              if (start &lt; 0 || start &gt;= getFrameLength()) {
                  throw new IllegalArgumentException(&quot;illegal value for start: &quot;+start);
              }
              if (end &gt;= getFrameLength()) {
                  throw new IllegalArgumentException(&quot;illegal value for end: &quot;+end);
<span class="line-new-header">--- 1179,16 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1273,13 ***</span>
              }
  
              // slight race condition with the run() method, but not a big problem
              loopStartFrame = start;
              loopEndFrame = end;
<span class="line-removed">- </span>
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;  loopStart: &quot; + loopStartFrame + &quot; loopEnd: &quot; + loopEndFrame);</span>
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt; DirectClip: setLoopPoints completed&quot;);</span>
          }
  
          @Override
          public void loop(int count) {
              // note: when count reaches 0, it means that the entire clip
<span class="line-new-header">--- 1207,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1298,12 ***</span>
              super.implOpen(format, bufferSize);
          }
  
          @Override
          void implClose() {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt;&gt; DirectClip: implClose()&quot;);</span>
<span class="line-removed">- </span>
              // dispose of thread
              Thread oldThread = thread;
              thread = null;
              doIO = false;
              if (oldThread != null) {
<span class="line-new-header">--- 1229,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1322,37 ***</span>
              audioData = null;
              newFramePosition = -1;
  
              // remove this instance from the list of auto closing clips
              getEventDispatcher().autoClosingClipClosed(this);
<span class="line-removed">- </span>
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt;&lt; DirectClip: implClose() succeeded&quot;);</span>
          }
  
          @Override
          void implStart() {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt; DirectClip: implStart()&quot;);</span>
              super.implStart();
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt; DirectClip: implStart() succeeded&quot;);</span>
          }
  
          @Override
          void implStop() {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt;&gt; DirectClip: implStop()&quot;);</span>
<span class="line-removed">- </span>
              super.implStop();
              // reset loopCount field so that playback will be normal with
              // next call to start()
              loopCount = 0;
<span class="line-removed">- </span>
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt;&lt; DirectClip: implStop() succeeded&quot;);</span>
          }
  
          // main playback loop
          @Override
          public void run() {
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&gt;&gt;&gt; DirectClip: run() threadID=&quot;+Thread.currentThread().getId());</span>
              Thread curThread = Thread.currentThread();
              while (thread == curThread) {
                  // doIO is volatile, but we could check it, then get
                  // pre-empted while another thread changes doIO and notifies,
                  // before we wait (so we sleep in wait forever).
<span class="line-new-header">--- 1251,28 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1394,21 ***</span>
                                      loopCount--;
                                  }
                                  newFramePosition = loopStartFrame;
                              } else {
                                  // no looping, stop playback
<span class="line-removed">-                                 if (Printer.debug) Printer.debug(&quot;stop clip in run() loop:&quot;);</span>
<span class="line-removed">-                                 if (Printer.debug) Printer.debug(&quot;  doIO=&quot;+doIO+&quot; written=&quot;+written+&quot; clipBytePosition=&quot;+clipBytePosition);</span>
<span class="line-removed">-                                 if (Printer.debug) Printer.debug(&quot;  framePos=&quot;+framePos+&quot; endFrame=&quot;+endFrame);</span>
                                  drain();
                                  stop();
                              }
                          }
                      }
                  }
              }
<span class="line-removed">-             if (Printer.trace) Printer.trace(&quot;&lt;&lt;&lt; DirectClip: run() threadID=&quot;+Thread.currentThread().getId());</span>
          }
  
          // AUTO CLOSING CLIP SUPPORT
  
          /* $$mp 2003-10-01
<span class="line-new-header">--- 1314,17 ---</span>
</pre>
<center><a href="DataPusher.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DirectAudioDeviceProvider.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>