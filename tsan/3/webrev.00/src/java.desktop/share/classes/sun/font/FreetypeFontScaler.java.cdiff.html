<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.desktop/share/classes/sun/font/FreetypeFontScaler.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="FontUtilities.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="GlyphList.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/sun/font/FreetypeFontScaler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 161,21 ***</span>
          }
          return FontScaler
              .getNullScaler().getGlyphVectorOutline(0L, glyphs, numGlyphs, x, y);
      }
  
<span class="line-modified">!     synchronized long getLayoutTableCache() throws FontScalerException {</span>
<span class="line-modified">!         return getLayoutTableCacheNative(nativeScaler);</span>
<span class="line-modified">!     }</span>
<span class="line-removed">- </span>
      public synchronized void dispose() {
          if (nativeScaler != 0L) {
              disposeNativeScaler(font.get(), nativeScaler);
              nativeScaler = 0L;
          }
      }
  
      synchronized int getNumGlyphs() throws FontScalerException {
          if (nativeScaler != 0L) {
              return getNumGlyphsNative(nativeScaler);
          }
          return FontScaler.getNullScaler().getNumGlyphs();
<span class="line-new-header">--- 161,35 ---</span>
          }
          return FontScaler
              .getNullScaler().getGlyphVectorOutline(0L, glyphs, numGlyphs, x, y);
      }
  
<span class="line-modified">!     /* This method should not be called directly, in case</span>
<span class="line-modified">!      * it is being invoked from a thread with a native context.</span>
<span class="line-modified">!      */</span>
      public synchronized void dispose() {
          if (nativeScaler != 0L) {
              disposeNativeScaler(font.get(), nativeScaler);
              nativeScaler = 0L;
          }
      }
  
<span class="line-added">+     public synchronized void disposeScaler() {</span>
<span class="line-added">+         if (nativeScaler != 0L) {</span>
<span class="line-added">+            /*</span>
<span class="line-added">+             * The current thread may be calling this method from the context</span>
<span class="line-added">+             * of a JNI up-call. It will hold the native lock from the</span>
<span class="line-added">+             * original down-call so can directly enter dispose and free</span>
<span class="line-added">+             * the resources. So we need to schedule the disposal to happen</span>
<span class="line-added">+             * only once we&#39;ve returned from native. So by running the dispose</span>
<span class="line-added">+             * on another thread which does nothing except that disposal we</span>
<span class="line-added">+             * are sure that this is safe.</span>
<span class="line-added">+             */</span>
<span class="line-added">+             new Thread(null, () -&gt; dispose(), &quot;free scaler&quot;, 0, false).start();</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      synchronized int getNumGlyphs() throws FontScalerException {
          if (nativeScaler != 0L) {
              return getNumGlyphsNative(nativeScaler);
          }
          return FontScaler.getNullScaler().getNumGlyphs();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 208,11 ***</span>
  
      synchronized long getUnitsPerEm() {
          return getUnitsPerEMNative(nativeScaler);
      }
  
<span class="line-modified">!     long createScalerContext(double[] matrix,</span>
              int aa, int fm, float boldness, float italic,
              boolean disableHinting) {
          if (nativeScaler != 0L) {
              return createScalerContextNative(nativeScaler, matrix,
                                               aa, fm, boldness, italic);
<span class="line-new-header">--- 222,11 ---</span>
  
      synchronized long getUnitsPerEm() {
          return getUnitsPerEMNative(nativeScaler);
      }
  
<span class="line-modified">!     synchronized long createScalerContext(double[] matrix,</span>
              int aa, int fm, float boldness, float italic,
              boolean disableHinting) {
          if (nativeScaler != 0L) {
              return createScalerContextNative(nativeScaler, matrix,
                                               aa, fm, boldness, italic);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 238,24 ***</span>
              long pScalerContext, long pScaler,
              int glyphCode, float x, float y);
      private native GeneralPath getGlyphVectorOutlineNative(Font2D font,
              long pScalerContext, long pScaler,
              int[] glyphs, int numGlyphs, float x, float y);
<span class="line-modified">!     native Point2D.Float getGlyphPointNative(Font2D font,</span>
              long pScalerContext, long pScaler, int glyphCode, int ptNumber);
  
<span class="line-removed">-     private native long getLayoutTableCacheNative(long pScaler);</span>
<span class="line-removed">- </span>
      private native void disposeNativeScaler(Font2D font2D, long pScaler);
  
      private native int getGlyphCodeNative(Font2D font, long pScaler, char charCode);
      private native int getNumGlyphsNative(long pScaler);
      private native int getMissingGlyphCodeNative(long pScaler);
  
      private native long getUnitsPerEMNative(long pScaler);
  
<span class="line-modified">!     native long createScalerContextNative(long pScaler, double[] matrix,</span>
              int aa, int fm, float boldness, float italic);
  
      /* Freetype scaler context does not contain any pointers that
         has to be invalidated if native scaler is bad */
      void invalidateScalerContext(long pScalerContext) {}
<span class="line-new-header">--- 252,22 ---</span>
              long pScalerContext, long pScaler,
              int glyphCode, float x, float y);
      private native GeneralPath getGlyphVectorOutlineNative(Font2D font,
              long pScalerContext, long pScaler,
              int[] glyphs, int numGlyphs, float x, float y);
<span class="line-modified">!     private native Point2D.Float getGlyphPointNative(Font2D font,</span>
              long pScalerContext, long pScaler, int glyphCode, int ptNumber);
  
      private native void disposeNativeScaler(Font2D font2D, long pScaler);
  
      private native int getGlyphCodeNative(Font2D font, long pScaler, char charCode);
      private native int getNumGlyphsNative(long pScaler);
      private native int getMissingGlyphCodeNative(long pScaler);
  
      private native long getUnitsPerEMNative(long pScaler);
  
<span class="line-modified">!     private native long createScalerContextNative(long pScaler, double[] matrix,</span>
              int aa, int fm, float boldness, float italic);
  
      /* Freetype scaler context does not contain any pointers that
         has to be invalidated if native scaler is bad */
      void invalidateScalerContext(long pScalerContext) {}
</pre>
<center><a href="FontUtilities.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="GlyphList.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>