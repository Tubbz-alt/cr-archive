<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/classes/sun/font/SunFontManager.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="PhysicalFont.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SunLayoutEngine.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/sun/font/SunFontManager.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -127,10 +127,12 @@</span>
                  }
              }
          }
      }
  
<span class="udiff-line-added">+     private static Font2DHandle FONT_HANDLE_NULL = new Font2DHandle(null);</span>
<span class="udiff-line-added">+ </span>
       public static final int FONTFORMAT_NONE = -1;
       public static final int FONTFORMAT_TRUETYPE = 0;
       public static final int FONTFORMAT_TYPE1 = 1;
       public static final int FONTFORMAT_TTC = 2;
       public static final int FONTFORMAT_COMPOSITE = 3;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -254,10 +256,17 @@</span>
  
      public FilenameFilter getType1Filter() {
          return t1Filter;
      }
  
<span class="udiff-line-added">+     /* After we reach MAXSOFTREFCNT, use weak refs for created fonts.</span>
<span class="udiff-line-added">+      * This means that a small number of created fonts as used in a UI app</span>
<span class="udiff-line-added">+      * will not be eagerly collected, but an app that create many will</span>
<span class="udiff-line-added">+      * have them collected more frequently to reclaim storage.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static int maxSoftRefCnt = 10;</span>
<span class="udiff-line-added">+ </span>
      static {
  
          java.security.AccessController.doPrivileged(
                                      new java.security.PrivilegedAction&lt;Object&gt;() {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -278,10 +287,13 @@</span>
                     &quot;true&quot;.equals(System.getProperty(&quot;sun.java2d.noType1Font&quot;));
                 jreLibDirName =
                     System.getProperty(&quot;java.home&quot;,&quot;&quot;) + File.separator + &quot;lib&quot;;
                 jreFontDirName = jreLibDirName + File.separator + &quot;fonts&quot;;
  
<span class="udiff-line-added">+                 maxSoftRefCnt =</span>
<span class="udiff-line-added">+                     Integer.getInteger(&quot;sun.java2d.font.maxSoftRefs&quot;, 10);</span>
<span class="udiff-line-added">+ </span>
                 return null;
             }
          });
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -643,11 +655,11 @@</span>
      protected PhysicalFont addToFontList(PhysicalFont f, int rank) {
      // MACOSX end
  
          String fontName = f.fullName;
          String familyName = f.familyName;
<span class="udiff-line-modified-removed">-         if (fontName == null || &quot;&quot;.equals(fontName)) {</span>
<span class="udiff-line-modified-added">+         if (fontName == null || fontName.isEmpty()) {</span>
              return null;
          }
          if (compositeFonts.containsKey(fontName)) {
              /* Don&#39;t register any font that has the same name as a composite */
              return null;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -937,35 +949,33 @@</span>
          if (FontUtilities.isLogging()) {
              FontUtilities.getLogger()
                              .info(&quot;Opening deferred font file &quot; + fileNameKey);
          }
  
<span class="udiff-line-modified-removed">-         PhysicalFont physicalFont;</span>
<span class="udiff-line-modified-added">+         PhysicalFont physicalFont = null;</span>
          FontRegistrationInfo regInfo = deferredFontFiles.get(fileNameKey);
          if (regInfo != null) {
              deferredFontFiles.remove(fileNameKey);
              physicalFont = registerFontFile(regInfo.fontFilePath,
                                              regInfo.nativeNames,
                                              regInfo.fontFormat,
                                              regInfo.javaRasterizer,
                                              regInfo.fontRank);
  
<span class="udiff-line-removed">- </span>
              if (physicalFont != null) {
                  /* Store the handle, so that if a font is bad, we
                   * retrieve the substituted font.
                   */
                  initialisedFonts.put(fileNameKey, physicalFont.handle);
              } else {
<span class="udiff-line-modified-removed">-                 initialisedFonts.put(fileNameKey,</span>
<span class="udiff-line-removed">-                                      getDefaultPhysicalFont().handle);</span>
<span class="udiff-line-modified-added">+                 initialisedFonts.put(fileNameKey, FONT_HANDLE_NULL);</span>
              }
          } else {
              Font2DHandle handle = initialisedFonts.get(fileNameKey);
              if (handle == null) {
                  /* Probably shouldn&#39;t happen, but just in case */
<span class="udiff-line-modified-removed">-                 physicalFont = getDefaultPhysicalFont();</span>
<span class="udiff-line-modified-added">+                 initialisedFonts.put(fileNameKey, FONT_HANDLE_NULL);</span>
              } else {
                  physicalFont = (PhysicalFont)(handle.font2D);
              }
          }
          return physicalFont;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1068,32 +1078,33 @@</span>
       * system is not useful and the graphics environment cannot sustain
       * the Java platform.
       */
      public PhysicalFont getDefaultPhysicalFont() {
          if (defaultPhysicalFont == null) {
<span class="udiff-line-modified-removed">-             /* findFont2D will load all fonts before giving up the search.</span>
<span class="udiff-line-modified-removed">-              * If the JRE Lucida isn&#39;t found (eg because the JRE fonts</span>
<span class="udiff-line-modified-removed">-              * directory is missing), it could find another version of Lucida</span>
<span class="udiff-line-modified-removed">-              * from the host system. This is OK because at that point we are</span>
<span class="udiff-line-modified-removed">-              * trying to gracefully handle/recover from a system</span>
<span class="udiff-line-modified-removed">-              * misconfiguration and this is probably a reasonable substitution.</span>
<span class="udiff-line-modified-removed">-              */</span>
<span class="udiff-line-modified-removed">-             defaultPhysicalFont = (PhysicalFont)</span>
<span class="udiff-line-modified-removed">-                 findFont2D(getDefaultFontFaceName(), Font.PLAIN, NO_FALLBACK);</span>
<span class="udiff-line-modified-added">+             String defaultFontName = getDefaultFontFaceName();</span>
<span class="udiff-line-modified-added">+             // findFont2D will load all fonts</span>
<span class="udiff-line-modified-added">+             Font2D font2d = findFont2D(defaultFontName, Font.PLAIN, NO_FALLBACK);</span>
<span class="udiff-line-modified-added">+             if (font2d != null) {</span>
<span class="udiff-line-modified-added">+                 if (font2d instanceof PhysicalFont) {</span>
<span class="udiff-line-modified-added">+                     defaultPhysicalFont = (PhysicalFont)font2d;</span>
<span class="udiff-line-modified-added">+                 } else {</span>
<span class="udiff-line-modified-added">+                     if (FontUtilities.isLogging()) {</span>
<span class="udiff-line-modified-added">+                         FontUtilities.getLogger()</span>
<span class="udiff-line-added">+                             .warning(&quot;Font returned by findFont2D for default font name &quot; +</span>
<span class="udiff-line-added">+                                      defaultFontName + &quot; is not a physical font: &quot; + font2d.getFontName(null));</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
              if (defaultPhysicalFont == null) {
                  /* Because of the findFont2D call above, if we reach here, we
                   * know all fonts have already been loaded, just accept any
                   * match at this point. If this fails we are in real trouble
                   * and I don&#39;t know how to recover from there being absolutely
                   * no fonts anywhere on the system.
                   */
<span class="udiff-line-modified-removed">-                 Iterator&lt;PhysicalFont&gt; i = physicalFonts.values().iterator();</span>
<span class="udiff-line-modified-removed">-                 if (i.hasNext()) {</span>
<span class="udiff-line-removed">-                     defaultPhysicalFont = i.next();</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     throw new Error(&quot;Probable fatal error:No fonts found.&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-modified-added">+                 defaultPhysicalFont = physicalFonts.values().stream().findFirst()</span>
<span class="udiff-line-modified-added">+                     .orElseThrow(()-&gt;new Error(&quot;Probable fatal error: No physical fonts found.&quot;));</span>
              }
          }
          return defaultPhysicalFont;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1978,10 +1989,13 @@</span>
          if (family != null) {
              font = family.getFontWithExactStyleMatch(style);
              if (font == null) {
                  font = findDeferredFont(name, style);
              }
<span class="udiff-line-added">+             if (font == null) {</span>
<span class="udiff-line-added">+                 font = findFontFromPlatform(lowerCaseName, style);</span>
<span class="udiff-line-added">+             }</span>
              if (font == null) {
                  font = family.getFont(style);
              }
              if (font == null) {
                  font = family.getClosestStyle(style);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2278,36 +2292,52 @@</span>
      protected abstract String getFontPath(boolean noType1Fonts);
  
      Thread fileCloser = null;
      Vector&lt;File&gt; tmpFontFiles = null;
  
<span class="udiff-line-added">+     private int createdFontCount = 0;</span>
<span class="udiff-line-added">+ </span>
      public Font2D[] createFont2D(File fontFile, int fontFormat, boolean all,
                                   boolean isCopy, CreatedFontTracker tracker)
      throws FontFormatException {
  
          List&lt;Font2D&gt; fList = new ArrayList&lt;Font2D&gt;();
          int cnt = 1;
          String fontFilePath = fontFile.getPath();
          FileFont font2D = null;
          final File fFile = fontFile;
          final CreatedFontTracker _tracker = tracker;
<span class="udiff-line-added">+         boolean weakRefs = false;</span>
<span class="udiff-line-added">+         int maxStrikes = 0;</span>
<span class="udiff-line-added">+         synchronized (this) {</span>
<span class="udiff-line-added">+             if (createdFontCount &lt; maxSoftRefCnt) {</span>
<span class="udiff-line-added">+                 createdFontCount++;</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                   weakRefs = true;</span>
<span class="udiff-line-added">+                       maxStrikes = 10;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
          try {
              switch (fontFormat) {
              case Font.TRUETYPE_FONT:
                  font2D = new TrueTypeFont(fontFilePath, null, 0, true);
<span class="udiff-line-added">+                 font2D.setUseWeakRefs(weakRefs, maxStrikes);</span>
                  fList.add(font2D);
                  if (!all) {
                      break;
                  }
                  cnt = ((TrueTypeFont)font2D).getFontCount();
                  int index = 1;
                  while (index &lt; cnt) {
<span class="udiff-line-modified-removed">-                     fList.add(new TrueTypeFont(fontFilePath, null, index++, true));</span>
<span class="udiff-line-modified-added">+                     font2D = new TrueTypeFont(fontFilePath, null, index++, true);</span>
<span class="udiff-line-added">+                     font2D.setUseWeakRefs(weakRefs, maxStrikes);</span>
<span class="udiff-line-added">+                     fList.add(font2D);</span>
                  }
                  break;
              case Font.TYPE1_FONT:
                  font2D = new Type1Font(fontFilePath, null, isCopy);
<span class="udiff-line-added">+                 font2D.setUseWeakRefs(weakRefs, maxStrikes);</span>
                  fList.add(font2D);
                  break;
              default:
                  throw new FontFormatException(&quot;Unrecognised Font Format&quot;);
              }
</pre>
<center><a href="PhysicalFont.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SunLayoutEngine.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>