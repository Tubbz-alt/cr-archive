<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/classes/sun/font/TrueTypeFont.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="SunLayoutEngine.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/SunGraphics2D.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/sun/font/TrueTypeFont.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -37,10 +37,13 @@</span>
  import java.nio.CharBuffer;
  import java.nio.IntBuffer;
  import java.nio.ShortBuffer;
  import java.nio.channels.ClosedChannelException;
  import java.nio.channels.FileChannel;
<span class="udiff-line-added">+ import java.security.AccessController;</span>
<span class="udiff-line-added">+ import java.security.PrivilegedActionException;</span>
<span class="udiff-line-added">+ import java.security.PrivilegedExceptionAction;</span>
  import java.util.ArrayList;
  import java.util.HashMap;
  import java.util.HashSet;
  import java.util.List;
  import java.util.Locale;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -178,10 +181,19 @@</span>
       */
      private Locale nameLocale;
      private String localeFamilyName;
      private String localeFullName;
  
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * Used on Windows to validate the font selected by GDI for (sub-pixel</span>
<span class="udiff-line-added">+      * antialiased) rendering. For &#39;standalone&#39; fonts it&#39;s equal to the font</span>
<span class="udiff-line-added">+      * file size, for collection (TTC, OTC) members it&#39;s the number of bytes in</span>
<span class="udiff-line-added">+      * the collection file from the start of this font&#39;s offset table till the</span>
<span class="udiff-line-added">+      * end of the file.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     int fontDataSize;</span>
<span class="udiff-line-added">+ </span>
      public TrueTypeFont(String platname, Object nativeNames, int fIndex,
                   boolean javaRasterizer)
          throws FontFormatException
      {
          this(platname, nativeNames, fIndex, javaRasterizer, true);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -310,32 +322,31 @@</span>
          if (disposerRecord.channel == null) {
              if (FontUtilities.isLogging()) {
                  FontUtilities.getLogger().info(&quot;open TTF: &quot; + platName);
              }
              try {
<span class="udiff-line-modified-removed">-                 RandomAccessFile raf = (RandomAccessFile)</span>
<span class="udiff-line-modified-removed">-                 java.security.AccessController.doPrivileged(</span>
<span class="udiff-line-modified-removed">-                     new java.security.PrivilegedAction&lt;Object&gt;() {</span>
<span class="udiff-line-modified-removed">-                         public Object run() {</span>
<span class="udiff-line-removed">-                             try {</span>
<span class="udiff-line-removed">-                                 return new RandomAccessFile(platName, &quot;r&quot;);</span>
<span class="udiff-line-removed">-                             } catch (FileNotFoundException ffne) {</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                             return null;</span>
<span class="udiff-line-modified-added">+                 RandomAccessFile raf = AccessController.doPrivileged(</span>
<span class="udiff-line-modified-added">+                     new PrivilegedExceptionAction&lt;RandomAccessFile&gt;() {</span>
<span class="udiff-line-modified-added">+                         public RandomAccessFile run() throws FileNotFoundException {</span>
<span class="udiff-line-modified-added">+                             return new RandomAccessFile(platName, &quot;r&quot;);</span>
                      }
                  });
                  disposerRecord.channel = raf.getChannel();
                  fileSize = (int)disposerRecord.channel.size();
                  if (usePool) {
                      FontManager fm = FontManagerFactory.getInstance();
                      if (fm instanceof SunFontManager) {
                          ((SunFontManager) fm).addToPool(this);
                      }
                  }
<span class="udiff-line-modified-removed">-             } catch (NullPointerException e) {</span>
<span class="udiff-line-modified-added">+             } catch (PrivilegedActionException e) {</span>
                  close();
<span class="udiff-line-modified-removed">-                 throw new FontFormatException(e.toString());</span>
<span class="udiff-line-modified-added">+                 Throwable reason = e.getCause();</span>
<span class="udiff-line-added">+                 if (reason == null) {</span>
<span class="udiff-line-added">+                     reason = e;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 throw new FontFormatException(reason.toString());</span>
              } catch (ClosedChannelException e) {
                  /* NIO I/O is interruptible, recurse to retry operation.
                   * The call to channel.size() above can throw this exception.
                   * Clear interrupts before recursing in case NIO didn&#39;t.
                   * Note that close() sets disposerRecord.channel to null.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -535,15 +546,17 @@</span>
                      throw new FontFormatException(&quot;Bad collection index&quot;);
                  }
                  fontIndex = fIndex;
                  buffer = readBlock(TTCHEADERSIZE+4*fIndex, 4);
                  headerOffset = buffer.getInt();
<span class="udiff-line-added">+                 fontDataSize = Math.max(0, fileSize - headerOffset);</span>
                  break;
  
              case v1ttTag:
              case trueTag:
              case ottoTag:
<span class="udiff-line-added">+                 fontDataSize = fileSize;</span>
                  break;
  
              default:
                  throw new FontFormatException(&quot;Unsupported sfnt &quot; +
                                                getPublicFileName());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -894,19 +907,10 @@</span>
                  return buffer;
              }
          }
      }
  
<span class="udiff-line-removed">-     @Override</span>
<span class="udiff-line-removed">-     protected long getLayoutTableCache() {</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-           return getScaler().getLayoutTableCache();</span>
<span class="udiff-line-removed">-         } catch(FontScalerException fe) {</span>
<span class="udiff-line-removed">-             return 0L;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      @Override
      protected byte[] getTableBytes(int tag) {
          ByteBuffer buffer = getTableBuffer(tag);
          if (buffer == null) {
              return null;
</pre>
<center><a href="SunLayoutEngine.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../java2d/SunGraphics2D.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>