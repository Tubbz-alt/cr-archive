<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/classes/sun/font/CMap.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../awt/resources/awt_zh_TW.properties.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="FileFont.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/sun/font/CMap.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -128,11 +128,11 @@</span>
      static final short JohabEncoding    = 6;
      static final short MSUnicodeSurrogateEncoding = 10;
  
      static final char noSuchChar = (char)0xfffd;
      static final int SHORTMASK = 0x0000ffff;
<span class="udiff-line-modified-removed">-     static final int INTMASK   = 0xffffffff;</span>
<span class="udiff-line-modified-added">+     static final int INTMASK   = 0x7fffffff;</span>
  
      static final char[][] converterMaps = new char[7][];
  
      /*
       * Unicode-&gt;other encoding translation array. A pre-computed look up
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -917,11 +917,15 @@</span>
  
           CMapFormat8(ByteBuffer bbuffer, int offset, char[] xlat) {
  
               bbuffer.position(12);
               bbuffer.get(is32);
<span class="udiff-line-modified-removed">-              nGroups = bbuffer.getInt();</span>
<span class="udiff-line-modified-added">+              nGroups = bbuffer.getInt() &amp; INTMASK;</span>
<span class="udiff-line-added">+              // A map group record is three uint32&#39;s making for 12 bytes total</span>
<span class="udiff-line-added">+              if (bbuffer.remaining() &lt; (12 * (long)nGroups)) {</span>
<span class="udiff-line-added">+                  throw new RuntimeException(&quot;Format 8 table exceeded&quot;);</span>
<span class="udiff-line-added">+              }</span>
               startCharCode = new int[nGroups];
               endCharCode   = new int[nGroups];
               startGlyphID  = new int[nGroups];
           }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -945,13 +949,17 @@</span>
           int entryCount;
           char[] glyphIdArray;
  
           CMapFormat10(ByteBuffer bbuffer, int offset, char[] xlat) {
  
<span class="udiff-line-added">+              bbuffer.position(offset+12);</span>
               firstCode = bbuffer.getInt() &amp; INTMASK;
               entryCount = bbuffer.getInt() &amp; INTMASK;
<span class="udiff-line-modified-removed">-              bbuffer.position(offset+20);</span>
<span class="udiff-line-modified-added">+              // each glyph is a uint16, so 2 bytes per value.</span>
<span class="udiff-line-added">+              if (bbuffer.remaining() &lt; (2 * (long)entryCount)) {</span>
<span class="udiff-line-added">+                  throw new RuntimeException(&quot;Format 10 table exceeded&quot;);</span>
<span class="udiff-line-added">+              }</span>
               CharBuffer buffer = bbuffer.asCharBuffer();
               glyphIdArray = new char[entryCount];
               for (int i=0; i&lt; entryCount; i++) {
                   glyphIdArray[i] = buffer.get();
               }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -987,15 +995,19 @@</span>
          CMapFormat12(ByteBuffer buffer, int offset, char[] xlat) {
              if (xlat != null) {
                  throw new RuntimeException(&quot;xlat array for cmap fmt=12&quot;);
              }
  
<span class="udiff-line-modified-removed">-             numGroups = buffer.getInt(offset+12);</span>
<span class="udiff-line-modified-added">+             buffer.position(offset+12);</span>
<span class="udiff-line-added">+             numGroups = buffer.getInt() &amp; INTMASK;</span>
<span class="udiff-line-added">+             // A map group record is three uint32&#39;s making for 12 bytes total</span>
<span class="udiff-line-added">+             if (buffer.remaining() &lt; (12 * (long)numGroups)) {</span>
<span class="udiff-line-added">+                 throw new RuntimeException(&quot;Format 12 table exceeded&quot;);</span>
<span class="udiff-line-added">+             }</span>
              startCharCode = new long[numGroups];
              endCharCode = new long[numGroups];
              startGlyphID = new int[numGroups];
<span class="udiff-line-removed">-             buffer.position(offset+16);</span>
              buffer = buffer.slice();
              IntBuffer ibuffer = buffer.asIntBuffer();
              for (int i=0; i&lt;numGroups; i++) {
                  startCharCode[i] = ibuffer.get() &amp; INTMASK;
                  endCharCode[i] = ibuffer.get() &amp; INTMASK;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1108,11 +1120,17 @@</span>
          int[] numUVSMapping;
          int[][] unicodeValue;
          char[][] glyphID;
  
          UVS(ByteBuffer buffer, int offset) {
<span class="udiff-line-modified-removed">-             numSelectors = buffer.getInt(offset+6);</span>
<span class="udiff-line-modified-added">+             buffer.position(offset+6);</span>
<span class="udiff-line-added">+             numSelectors = buffer.getInt() &amp; INTMASK;</span>
<span class="udiff-line-added">+             // A variation selector record is one 3 byte int + two int32&#39;s</span>
<span class="udiff-line-added">+             // making for 11 bytes per record.</span>
<span class="udiff-line-added">+             if (buffer.remaining() &lt; (11 * (long)numSelectors)) {</span>
<span class="udiff-line-added">+                 throw new RuntimeException(&quot;Variations exceed buffer&quot;);</span>
<span class="udiff-line-added">+             }</span>
              selector = new int[numSelectors];
              numUVSMapping = new int[numSelectors];
              unicodeValue = new int[numSelectors][];
              glyphID = new char[numSelectors][];
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1129,10 +1147,15 @@</span>
                  if (tableOffset == 0) {
                      numUVSMapping[i] = 0;
                  } else if (tableOffset &gt; 0) {
                      buffer.position(offset+tableOffset);
                      numUVSMapping[i] = buffer.getInt() &amp; INTMASK;
<span class="udiff-line-added">+                     // a UVS mapping record is one 3 byte int + uint16</span>
<span class="udiff-line-added">+                     // making for 5 bytes per record.</span>
<span class="udiff-line-added">+                     if (buffer.remaining() &lt; (5 * (long)numUVSMapping[i])) {</span>
<span class="udiff-line-added">+                         throw new RuntimeException(&quot;Variations exceed buffer&quot;);</span>
<span class="udiff-line-added">+                     }</span>
                      unicodeValue[i] = new int[numUVSMapping[i]];
                      glyphID[i] = new char[numUVSMapping[i]];
  
                      for (int j = 0; j &lt; numUVSMapping[i]; j++) {
                          int temp = (buffer.get() &amp; 0xff) &lt;&lt; 16; //UINT24
</pre>
<center><a href="../awt/resources/awt_zh_TW.properties.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="FileFont.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>