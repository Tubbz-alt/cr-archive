<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/classes/sun/font/Font2D.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="FileFontStrike.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="FontScaler.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/sun/font/Font2D.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,12 +28,14 @@</span>
  import java.awt.Font;
  import java.awt.font.FontRenderContext;
  import java.awt.geom.AffineTransform;
  import java.lang.ref.Reference;
  import java.lang.ref.SoftReference;
<span class="udiff-line-added">+ import java.lang.ref.WeakReference;</span>
  import java.util.concurrent.ConcurrentHashMap;
  import java.util.Locale;
<span class="udiff-line-added">+ import java.util.Set;</span>
  
  public abstract class Font2D {
  
      /* Note: JRE and FONT_CONFIG ranks are identical. I don&#39;t know of a reason
       * to distingish these. Possibly if a user adds fonts to the JRE font
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -103,11 +105,26 @@</span>
       * strike obtained from this Font2D satifies the needs of the next
       * client too.
       * This pre-supposes that a FontStrike is a shareable object, which
       * it should.
       */
<span class="udiff-line-modified-removed">-     protected Reference&lt;FontStrike&gt; lastFontStrike = new SoftReference&lt;&gt;(null);</span>
<span class="udiff-line-modified-added">+     protected Reference&lt;FontStrike&gt; lastFontStrike = new WeakReference&lt;&gt;(null);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * if useWeak is true, proactively clear the cache after this</span>
<span class="udiff-line-added">+      * many strikes are present. 0 means leave it alone.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private int strikeCacheMax = 0;</span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * Whether to use weak refs for this font, even if soft refs is the default.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private boolean useWeak;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void setUseWeakRefs(boolean weak, int maxStrikes) {</span>
<span class="udiff-line-added">+         this.useWeak = weak;</span>
<span class="udiff-line-added">+         this.strikeCacheMax = weak &amp;&amp; maxStrikes &gt; 0 ? maxStrikes : 0;</span>
<span class="udiff-line-added">+     }</span>
  
      /*
       * POSSIBLE OPTIMISATION:
       * Array of length 1024 elements of 64 bits indicating if a font
       * contains these. This kind of information can be shared between
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -302,10 +319,19 @@</span>
                                                   at, font.getStyle(),
                                                   aa, fm);
          return getStrike(desc, false);
      }
  
<span class="udiff-line-added">+     void updateLastStrikeRef(FontStrike strike) {</span>
<span class="udiff-line-added">+         lastFontStrike.clear();</span>
<span class="udiff-line-added">+         if (useWeak) {</span>
<span class="udiff-line-added">+             lastFontStrike = new WeakReference&lt;&gt;(strike);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             lastFontStrike = new SoftReference&lt;&gt;(strike);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      FontStrike getStrike(FontStrikeDesc desc) {
          return getStrike(desc, true);
      }
  
      private FontStrike getStrike(FontStrikeDesc desc, boolean copy) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -322,19 +348,17 @@</span>
           * collected, then we create a new strike, put it in the map and
           * set it to be the last strike.
           */
          FontStrike strike = lastFontStrike.get();
          if (strike != null &amp;&amp; desc.equals(strike.desc)) {
<span class="udiff-line-removed">-             //strike.lastlookupTime = System.currentTimeMillis();</span>
              return strike;
          } else {
              Reference&lt;FontStrike&gt; strikeRef = strikeCache.get(desc);
              if (strikeRef != null) {
                  strike = strikeRef.get();
                  if (strike != null) {
<span class="udiff-line-modified-removed">-                     //strike.lastlookupTime = System.currentTimeMillis();</span>
<span class="udiff-line-removed">-                     lastFontStrike = new SoftReference&lt;&gt;(strike);</span>
<span class="udiff-line-modified-added">+                     updateLastStrikeRef(strike);</span>
                      StrikeCache.refStrike(strike);
                      return strike;
                  }
              }
              /* When we create a new FontStrike instance, we *must*
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -364,35 +388,25 @@</span>
               * of weak references rather than soft references.
               * This means that it won&#39;t live much beyond the next GC,
               * which is what we want for what is likely a transient strike.
               */
              int txType = desc.glyphTx.getType();
<span class="udiff-line-modified-removed">-             if (txType == AffineTransform.TYPE_GENERAL_TRANSFORM ||</span>
<span class="udiff-line-modified-added">+             if (useWeak ||</span>
<span class="udiff-line-added">+                 txType == AffineTransform.TYPE_GENERAL_TRANSFORM ||</span>
                  (txType &amp; AffineTransform.TYPE_GENERAL_ROTATION) != 0 &amp;&amp;
                  strikeCache.size() &gt; 10) {
                  strikeRef = StrikeCache.getStrikeRef(strike, true);
              } else {
<span class="udiff-line-modified-removed">-                 strikeRef = StrikeCache.getStrikeRef(strike);</span>
<span class="udiff-line-modified-added">+                 strikeRef = StrikeCache.getStrikeRef(strike, useWeak);</span>
              }
              strikeCache.put(desc, strikeRef);
<span class="udiff-line-modified-removed">-             //strike.lastlookupTime = System.currentTimeMillis();</span>
<span class="udiff-line-removed">-             lastFontStrike = new SoftReference&lt;&gt;(strike);</span>
<span class="udiff-line-modified-added">+             updateLastStrikeRef(strike);</span>
              StrikeCache.refStrike(strike);
              return strike;
          }
      }
  
<span class="udiff-line-removed">-     void removeFromCache(FontStrikeDesc desc) {</span>
<span class="udiff-line-removed">-         Reference&lt;FontStrike&gt; ref = strikeCache.get(desc);</span>
<span class="udiff-line-removed">-         if (ref != null) {</span>
<span class="udiff-line-removed">-             Object o = ref.get();</span>
<span class="udiff-line-removed">-             if (o == null) {</span>
<span class="udiff-line-removed">-                 strikeCache.remove(desc);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      /**
       * The length of the metrics array must be &gt;= 8.  This method will
       * store the following elements in that array before returning:
       *    metrics[0]: ascent
       *    metrics[1]: descent
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -463,17 +477,10 @@</span>
       */
      protected byte[] getTableBytes(int tag) {
          return null;
      }
  
<span class="udiff-line-removed">-     /* implemented for fonts backed by an sfnt that has</span>
<span class="udiff-line-removed">-      * OpenType or AAT layout tables.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     protected long getLayoutTableCache() {</span>
<span class="udiff-line-removed">-         return 0L;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      /* Used only on OS X.
       */
      protected long getPlatformNativeFontPtr() {
          return 0L;
      }
</pre>
<center><a href="FileFontStrike.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="FontScaler.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>