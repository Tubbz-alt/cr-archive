<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/classes/sun/font/FreetypeFontScaler.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="FontUtilities.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="GlyphList.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/sun/font/FreetypeFontScaler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
146         }
147         return FontScaler.getNullScaler().
148             getGlyphOutline(0L, glyphCode, x,y);
149     }
150 
151     synchronized GeneralPath getGlyphVectorOutline(
152                      long pScalerContext, int[] glyphs, int numGlyphs,
153                      float x, float y) throws FontScalerException {
154         if (nativeScaler != 0L) {
155             return getGlyphVectorOutlineNative(font.get(),
156                                                pScalerContext,
157                                                nativeScaler,
158                                                glyphs,
159                                                numGlyphs,
160                                                x, y);
161         }
162         return FontScaler
163             .getNullScaler().getGlyphVectorOutline(0L, glyphs, numGlyphs, x, y);
164     }
165 
<span class="line-modified">166     synchronized long getLayoutTableCache() throws FontScalerException {</span>
<span class="line-modified">167         return getLayoutTableCacheNative(nativeScaler);</span>
<span class="line-modified">168     }</span>
<span class="line-removed">169 </span>
170     public synchronized void dispose() {
171         if (nativeScaler != 0L) {
172             disposeNativeScaler(font.get(), nativeScaler);
173             nativeScaler = 0L;
174         }
175     }
176 















177     synchronized int getNumGlyphs() throws FontScalerException {
178         if (nativeScaler != 0L) {
179             return getNumGlyphsNative(nativeScaler);
180         }
181         return FontScaler.getNullScaler().getNumGlyphs();
182     }
183 
184     synchronized int getMissingGlyphCode()  throws FontScalerException {
185         if (nativeScaler != 0L) {
186             return getMissingGlyphCodeNative(nativeScaler);
187         }
188         return FontScaler.getNullScaler().getMissingGlyphCode();
189     }
190 
191     synchronized int getGlyphCode(char charCode) throws FontScalerException {
192         if (nativeScaler != 0L) {
193             return getGlyphCodeNative(font.get(), nativeScaler, charCode);
194         }
195         return FontScaler.getNullScaler().getGlyphCode(charCode);
196     }
197 
198     synchronized Point2D.Float getGlyphPoint(long pScalerContext,
199                                        int glyphCode, int ptNumber)
200                                throws FontScalerException {
201         if (nativeScaler != 0L) {
202             return getGlyphPointNative(font.get(), pScalerContext,
203                                       nativeScaler, glyphCode, ptNumber);
204         }
205         return FontScaler.getNullScaler().getGlyphPoint(
206                    pScalerContext, glyphCode,  ptNumber);
207     }
208 
209     synchronized long getUnitsPerEm() {
210         return getUnitsPerEMNative(nativeScaler);
211     }
212 
<span class="line-modified">213     long createScalerContext(double[] matrix,</span>
214             int aa, int fm, float boldness, float italic,
215             boolean disableHinting) {
216         if (nativeScaler != 0L) {
217             return createScalerContextNative(nativeScaler, matrix,
218                                              aa, fm, boldness, italic);
219         }
220         return NullFontScaler.getNullScalerContext();
221     }
222 
223     //Note: native methods can throw RuntimeException if processing fails
224     private native long initNativeScaler(Font2D font, int type,
225             int indexInCollection, boolean supportsCJK, int filesize);
226     private native StrikeMetrics getFontMetricsNative(Font2D font,
227             long pScalerContext, long pScaler);
228     private native float getGlyphAdvanceNative(Font2D font,
229             long pScalerContext, long pScaler, int glyphCode);
230     private native void getGlyphMetricsNative(Font2D font,
231             long pScalerContext, long pScaler,
232             int glyphCode, Point2D.Float metrics);
233     private native long getGlyphImageNative(Font2D font,
234             long pScalerContext, long pScaler, int glyphCode);
235     private native Rectangle2D.Float getGlyphOutlineBoundsNative(Font2D font,
236             long pScalerContext, long pScaler, int glyphCode);
237     private native GeneralPath getGlyphOutlineNative(Font2D font,
238             long pScalerContext, long pScaler,
239             int glyphCode, float x, float y);
240     private native GeneralPath getGlyphVectorOutlineNative(Font2D font,
241             long pScalerContext, long pScaler,
242             int[] glyphs, int numGlyphs, float x, float y);
<span class="line-modified">243     native Point2D.Float getGlyphPointNative(Font2D font,</span>
244             long pScalerContext, long pScaler, int glyphCode, int ptNumber);
245 
<span class="line-removed">246     private native long getLayoutTableCacheNative(long pScaler);</span>
<span class="line-removed">247 </span>
248     private native void disposeNativeScaler(Font2D font2D, long pScaler);
249 
250     private native int getGlyphCodeNative(Font2D font, long pScaler, char charCode);
251     private native int getNumGlyphsNative(long pScaler);
252     private native int getMissingGlyphCodeNative(long pScaler);
253 
254     private native long getUnitsPerEMNative(long pScaler);
255 
<span class="line-modified">256     native long createScalerContextNative(long pScaler, double[] matrix,</span>
257             int aa, int fm, float boldness, float italic);
258 
259     /* Freetype scaler context does not contain any pointers that
260        has to be invalidated if native scaler is bad */
261     void invalidateScalerContext(long pScalerContext) {}
262 }
</pre>
</td>
<td>
<hr />
<pre>
146         }
147         return FontScaler.getNullScaler().
148             getGlyphOutline(0L, glyphCode, x,y);
149     }
150 
151     synchronized GeneralPath getGlyphVectorOutline(
152                      long pScalerContext, int[] glyphs, int numGlyphs,
153                      float x, float y) throws FontScalerException {
154         if (nativeScaler != 0L) {
155             return getGlyphVectorOutlineNative(font.get(),
156                                                pScalerContext,
157                                                nativeScaler,
158                                                glyphs,
159                                                numGlyphs,
160                                                x, y);
161         }
162         return FontScaler
163             .getNullScaler().getGlyphVectorOutline(0L, glyphs, numGlyphs, x, y);
164     }
165 
<span class="line-modified">166     /* This method should not be called directly, in case</span>
<span class="line-modified">167      * it is being invoked from a thread with a native context.</span>
<span class="line-modified">168      */</span>

169     public synchronized void dispose() {
170         if (nativeScaler != 0L) {
171             disposeNativeScaler(font.get(), nativeScaler);
172             nativeScaler = 0L;
173         }
174     }
175 
<span class="line-added">176     public synchronized void disposeScaler() {</span>
<span class="line-added">177         if (nativeScaler != 0L) {</span>
<span class="line-added">178            /*</span>
<span class="line-added">179             * The current thread may be calling this method from the context</span>
<span class="line-added">180             * of a JNI up-call. It will hold the native lock from the</span>
<span class="line-added">181             * original down-call so can directly enter dispose and free</span>
<span class="line-added">182             * the resources. So we need to schedule the disposal to happen</span>
<span class="line-added">183             * only once we&#39;ve returned from native. So by running the dispose</span>
<span class="line-added">184             * on another thread which does nothing except that disposal we</span>
<span class="line-added">185             * are sure that this is safe.</span>
<span class="line-added">186             */</span>
<span class="line-added">187             new Thread(null, () -&gt; dispose(), &quot;free scaler&quot;, 0, false).start();</span>
<span class="line-added">188         }</span>
<span class="line-added">189     }</span>
<span class="line-added">190 </span>
191     synchronized int getNumGlyphs() throws FontScalerException {
192         if (nativeScaler != 0L) {
193             return getNumGlyphsNative(nativeScaler);
194         }
195         return FontScaler.getNullScaler().getNumGlyphs();
196     }
197 
198     synchronized int getMissingGlyphCode()  throws FontScalerException {
199         if (nativeScaler != 0L) {
200             return getMissingGlyphCodeNative(nativeScaler);
201         }
202         return FontScaler.getNullScaler().getMissingGlyphCode();
203     }
204 
205     synchronized int getGlyphCode(char charCode) throws FontScalerException {
206         if (nativeScaler != 0L) {
207             return getGlyphCodeNative(font.get(), nativeScaler, charCode);
208         }
209         return FontScaler.getNullScaler().getGlyphCode(charCode);
210     }
211 
212     synchronized Point2D.Float getGlyphPoint(long pScalerContext,
213                                        int glyphCode, int ptNumber)
214                                throws FontScalerException {
215         if (nativeScaler != 0L) {
216             return getGlyphPointNative(font.get(), pScalerContext,
217                                       nativeScaler, glyphCode, ptNumber);
218         }
219         return FontScaler.getNullScaler().getGlyphPoint(
220                    pScalerContext, glyphCode,  ptNumber);
221     }
222 
223     synchronized long getUnitsPerEm() {
224         return getUnitsPerEMNative(nativeScaler);
225     }
226 
<span class="line-modified">227     synchronized long createScalerContext(double[] matrix,</span>
228             int aa, int fm, float boldness, float italic,
229             boolean disableHinting) {
230         if (nativeScaler != 0L) {
231             return createScalerContextNative(nativeScaler, matrix,
232                                              aa, fm, boldness, italic);
233         }
234         return NullFontScaler.getNullScalerContext();
235     }
236 
237     //Note: native methods can throw RuntimeException if processing fails
238     private native long initNativeScaler(Font2D font, int type,
239             int indexInCollection, boolean supportsCJK, int filesize);
240     private native StrikeMetrics getFontMetricsNative(Font2D font,
241             long pScalerContext, long pScaler);
242     private native float getGlyphAdvanceNative(Font2D font,
243             long pScalerContext, long pScaler, int glyphCode);
244     private native void getGlyphMetricsNative(Font2D font,
245             long pScalerContext, long pScaler,
246             int glyphCode, Point2D.Float metrics);
247     private native long getGlyphImageNative(Font2D font,
248             long pScalerContext, long pScaler, int glyphCode);
249     private native Rectangle2D.Float getGlyphOutlineBoundsNative(Font2D font,
250             long pScalerContext, long pScaler, int glyphCode);
251     private native GeneralPath getGlyphOutlineNative(Font2D font,
252             long pScalerContext, long pScaler,
253             int glyphCode, float x, float y);
254     private native GeneralPath getGlyphVectorOutlineNative(Font2D font,
255             long pScalerContext, long pScaler,
256             int[] glyphs, int numGlyphs, float x, float y);
<span class="line-modified">257     private native Point2D.Float getGlyphPointNative(Font2D font,</span>
258             long pScalerContext, long pScaler, int glyphCode, int ptNumber);
259 


260     private native void disposeNativeScaler(Font2D font2D, long pScaler);
261 
262     private native int getGlyphCodeNative(Font2D font, long pScaler, char charCode);
263     private native int getNumGlyphsNative(long pScaler);
264     private native int getMissingGlyphCodeNative(long pScaler);
265 
266     private native long getUnitsPerEMNative(long pScaler);
267 
<span class="line-modified">268     private native long createScalerContextNative(long pScaler, double[] matrix,</span>
269             int aa, int fm, float boldness, float italic);
270 
271     /* Freetype scaler context does not contain any pointers that
272        has to be invalidated if native scaler is bad */
273     void invalidateScalerContext(long pScalerContext) {}
274 }
</pre>
</td>
</tr>
</table>
<center><a href="FontUtilities.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="GlyphList.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>