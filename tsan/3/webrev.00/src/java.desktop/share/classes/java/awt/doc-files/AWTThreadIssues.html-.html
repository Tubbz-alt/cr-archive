<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.desktop/share/classes/java/awt/doc-files/AWTThreadIssues.html</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 &lt;!doctype html&gt;
  2 &lt;html lang=&quot;en&quot;&gt;
  3 &lt;head&gt;
  4   &lt;meta charset=&quot;utf-8&quot;/&gt;
  5   &lt;title&gt;AWT Threading Issues&lt;/title&gt;
  6 &lt;/head&gt;
  7 &lt;!--
  8  Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.
  9  DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 10 
 11  This code is free software; you can redistribute it and/or modify it
 12  under the terms of the GNU General Public License version 2 only, as
 13  published by the Free Software Foundation.  Oracle designates this
 14  particular file as subject to the &quot;Classpath&quot; exception as provided
 15  by Oracle in the LICENSE file that accompanied this code.
 16 
 17  This code is distributed in the hope that it will be useful, but WITHOUT
 18  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 19  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 20  version 2 for more details (a copy is included in the LICENSE file that
 21  accompanied this code).
 22 
 23  You should have received a copy of the GNU General Public License version
 24  2 along with this work; if not, write to the Free Software Foundation,
 25  Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 26 
 27  Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 28  or visit www.oracle.com if you need additional information or have any
 29  questions.
 30 --&gt;
 31 
 32 &lt;body&gt;
 33 &lt;main role=&quot;main&quot;&gt;
 34 &lt;h1&gt;AWT Threading Issues&lt;/h1&gt;
 35 
 36 &lt;a id=&quot;ListenersThreads&quot;&gt;&lt;/a&gt;
 37 &lt;h2&gt;Listeners and threads&lt;/h2&gt;
 38 
 39 Unless otherwise noted all AWT listeners are notified on the event
 40 dispatch thread. It is safe to remove/add listeners from any thread
 41 during dispatching, but the changes only effect subsequent notification.
 42 &lt;br&gt;For example, if a key listeners is added from another key listener, the
 43 newly added listener is only notified on subsequent key events.
 44 
 45 &lt;a id=&quot;Autoshutdown&quot;&gt;&lt;/a&gt;
 46 &lt;h2&gt;Auto-shutdown&lt;/h2&gt;
 47 
 48 According to
 49 &lt;cite&gt;The Java&amp;trade; Virtual Machine Specification&lt;/cite&gt;,
 50 sections 2.17.9 and 2.19,
 51 the Java virtual machine (JVM) initially starts up with a single non-daemon
 52 thread, which typically calls the &lt;code&gt;main&lt;/code&gt; method of some class.
 53 The virtual machine terminates all its activity and exits when
 54 one of two things happens:
 55 &lt;ul&gt;
 56   &lt;li&gt; All the threads that are not daemon threads terminate.
 57   &lt;li&gt; Some thread invokes the &lt;code&gt;exit&lt;/code&gt; method of class
 58   &lt;code&gt;Runtime&lt;/code&gt; or class &lt;code&gt;System&lt;/code&gt;, and the exit
 59   operation is permitted by the security manager.
 60 &lt;/ul&gt;
 61 &lt;p&gt;
 62 This implies that if an application doesn&#39;t start any threads itself,
 63 the JVM will exit as soon as &lt;code&gt;main&lt;/code&gt; terminates.
 64 This is not the case, however, for a simple application
 65 that creates and displays a &lt;code&gt;java.awt.Frame&lt;/code&gt;:
 66 &lt;pre&gt;
 67         public static void main(String[] args) {
 68             Frame frame = new Frame();
 69             frame.setVisible(true);
 70          }
 71 &lt;/pre&gt;
 72 The reason is that AWT encapsulates asynchronous event dispatch
 73 machinery to process events AWT or Swing components can fire. The
 74 exact behavior of this machinery is implementation-dependent. In
 75 particular, it can start non-daemon helper threads for its internal
 76 purposes. In fact, these are the threads that prevent the example
 77 above from exiting. The only restrictions imposed on the behavior of
 78 this machinery are as follows:
 79 &lt;ul&gt;
 80   &lt;li&gt; &lt;a href=&quot;../EventQueue.html#isDispatchThread()&quot;&gt;&lt;code&gt;EventQueue.isDispatchThread&lt;/code&gt;&lt;/a&gt;
 81        returns &lt;code&gt;true&lt;/code&gt; if and only if the calling thread is the
 82        event dispatch thread started by the machinery;
 83   &lt;li&gt; &lt;code&gt;AWTEvents&lt;/code&gt; which were actually enqueued to a
 84        particular &lt;code&gt;EventQueue&lt;/code&gt; (note that events being
 85        posted to the &lt;code&gt;EventQueue&lt;/code&gt; can be coalesced) are
 86        dispatched:
 87        &lt;ul&gt;
 88            &lt;li&gt;
 89            &lt;dl&gt;&lt;dt&gt;Sequentially.
 90              &lt;dd&gt; That is, it is not permitted that several events from
 91 	        this queue are dispatched simultaneously. &lt;/dd&gt;&lt;/dl&gt;
 92            &lt;li&gt;
 93            &lt;dl&gt;&lt;dt&gt;In the same order as they are enqueued.
 94              &lt;dd&gt; That is, if &lt;code&gt;AWTEvent&lt;/code&gt;&amp;nbsp;A is enqueued
 95 	        to the &lt;code&gt;EventQueue&lt;/code&gt; before
 96 		&lt;code&gt;AWTEvent&lt;/code&gt;&amp;nbsp;B then event B will not be
 97                 dispatched before event A.&lt;/dd&gt;&lt;/dl&gt;
 98        &lt;/ul&gt;
 99   &lt;li&gt; There is at least one alive non-daemon thread while there is at
100        least one displayable AWT or Swing component within the
101        application (see
102        &lt;a href=&quot;../Component.html#isDisplayable()&quot;&gt;&lt;code&gt;Component.isDisplayable&lt;/code&gt;&lt;/a&gt;).
103 &lt;/ul&gt;
104 The implications of the third restriction are as follows:
105 &lt;ul&gt;
106   &lt;li&gt; The JVM will exit if some thread invokes the &lt;code&gt;exit&lt;/code&gt;
107   method of class &lt;code&gt;Runtime&lt;/code&gt; or class &lt;code&gt;System&lt;/code&gt;
108   regardless of the presence of displayable components;
109   &lt;li&gt; Even if the application terminates all non-daemon threads it
110   started, the JVM will not exit while there is at least one
111   displayable component.
112 &lt;/ul&gt;
113 It depends on the implementation if and when the non-daemon helper
114 threads are terminated once all components are made undisplayable.
115 The implementation-specific details are given below.
116 
117 &lt;h3&gt;
118 Implementation-dependent behavior.
119 &lt;/h3&gt;
120 
121 Prior to 1.4, the helper threads were never terminated.
122 &lt;p&gt;
123 Starting with 1.4, the behavior has changed as a result of the fix for
124 &lt;a href=&quot;https://bugs.java.com/view_bug.do?bug_id=4030718&quot;&gt;
125 4030718&lt;/a&gt;. With the current implementation, AWT terminates all its
126 helper threads allowing the application to exit cleanly when the
127 following three conditions are true:
128 &lt;ul&gt;
129   &lt;li&gt; There are no displayable AWT or Swing components.
130   &lt;li&gt; There are no native events in the native event queue.
131   &lt;li&gt; There are no AWT events in java EventQueues.
132 &lt;/ul&gt;
133 Therefore, a stand-alone AWT application that wishes to exit
134 cleanly without calling &lt;code&gt;System.exit&lt;/code&gt; must:
135 &lt;ul&gt;
136   &lt;li&gt; Make sure that all AWT or Swing components are made
137        undisplayable when the application finishes. This can be done
138        by calling
139 &lt;a href=&quot;../Window.html#dispose()&quot;&gt;&lt;code&gt;Window.dispose&lt;/code&gt;&lt;/a&gt;
140        on all top-level &lt;code&gt;Windows&lt;/code&gt;. See
141 &lt;a href=&quot;../Frame.html#getFrames()&quot;&gt;&lt;code&gt;Frame.getFrames&lt;/code&gt;&lt;/a&gt;.
142   &lt;li&gt; Make sure that no method of AWT event listeners registered by
143        the application with any AWT or Swing component can run into an
144        infinite loop or hang indefinitely. For example, an AWT listener
145        method triggered by some AWT event can post a new AWT event of
146        the same type to the &lt;code&gt;EventQueue&lt;/code&gt;.
147        The argument is that methods
148        of AWT event listeners are typically executed on helper
149        threads.
150 &lt;/ul&gt;
151 Note, that while an application following these recommendations will
152 exit cleanly under normal conditions, it is not guaranteed that it
153 will exit cleanly in all cases. Two examples:
154 &lt;ul&gt;
155   &lt;li&gt; Other packages can create displayable components for internal
156        needs and never make them undisplayable. See
157 &lt;a href=&quot;https://bugs.java.com/view_bug.do?bug_id=4515058&quot;&gt;
158 4515058&lt;/a&gt;,
159 &lt;a href=&quot;https://bugs.java.com/view_bug.do?bug_id=4671025&quot;&gt;
160 4671025&lt;/a&gt;, and
161 &lt;a href=&quot;https://bugs.java.com/view_bug.do?bug_id=4465537&quot;&gt;
162 4465537&lt;/a&gt;.
163   &lt;li&gt; Both Microsoft Windows and X11 allow an application to send native
164        events to windows that belong to another application. With this
165        feature it is possible to write a malicious program that will
166        continuously send events to all available windows preventing
167        any AWT application from exiting cleanly.
168 &lt;/ul&gt;
169 On the other hand, if you require the JVM to continue running even after
170 the application has made all components undisplayable you should start a
171 non-daemon thread that blocks forever.
172 
173 &lt;pre&gt;
174         &amp;lt;...&amp;gt;
175         Runnable r = new Runnable() {
176             public void run() {
177                 Object o = new Object();
178                 try {
179                     synchronized (o) {
180                         o.wait();
181                     }
182                 } catch (InterruptedException ie) {
183                 }
184             }
185         };
186         Thread t = new Thread(r);
187         t.setDaemon(false);
188         t.start();
189         &amp;lt;...&amp;gt;
190 &lt;/pre&gt;
191 
192 &lt;cite&gt;The Java&amp;trade; Virtual Machine Specification&lt;/cite&gt;
193  guarantees
194 that the JVM doesn&#39;t exit until this thread terminates.
195 &lt;/main&gt;
196 &lt;/body&gt;
197 &lt;/html&gt;
    </pre>
  </body>
</html>