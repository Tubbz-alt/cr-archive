<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.desktop/share/classes/java/awt/doc-files/AWTThreadIssues.html</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 &lt;!doctype html&gt;
  2 &lt;html lang=&quot;en&quot;&gt;
  3 &lt;head&gt;
  4   &lt;meta charset=&quot;utf-8&quot;/&gt;
  5   &lt;title&gt;AWT Threading Issues&lt;/title&gt;
  6 &lt;/head&gt;
  7 &lt;!--
  8  Copyright (c) 2002, 2019, Oracle and/or its affiliates. All rights reserved.
  9  DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 10 
 11  This code is free software; you can redistribute it and/or modify it
 12  under the terms of the GNU General Public License version 2 only, as
 13  published by the Free Software Foundation.  Oracle designates this
 14  particular file as subject to the &quot;Classpath&quot; exception as provided
 15  by Oracle in the LICENSE file that accompanied this code.
 16 
 17  This code is distributed in the hope that it will be useful, but WITHOUT
 18  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 19  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 20  version 2 for more details (a copy is included in the LICENSE file that
 21  accompanied this code).
 22 
 23  You should have received a copy of the GNU General Public License version
 24  2 along with this work; if not, write to the Free Software Foundation,
 25  Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 26 
 27  Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 28  or visit www.oracle.com if you need additional information or have any
 29  questions.
 30 --&gt;
 31 
 32 &lt;body&gt;
 33 &lt;main role=&quot;main&quot;&gt;
 34 &lt;div class=&quot;contentContainer&quot;&gt;
 35 &lt;h1&gt;AWT Threading Issues&lt;/h1&gt;
 36 
 37 &lt;a id=&quot;ListenersThreads&quot;&gt;&lt;/a&gt;
 38 &lt;h2&gt;Listeners and threads&lt;/h2&gt;
 39 
 40 Unless otherwise noted all AWT listeners are notified on the event
 41 dispatch thread. It is safe to remove/add listeners from any thread
 42 during dispatching, but the changes only effect subsequent notification.
 43 &lt;br&gt;For example, if a key listeners is added from another key listener, the
 44 newly added listener is only notified on subsequent key events.
 45 
 46 &lt;a id=&quot;Autoshutdown&quot;&gt;&lt;/a&gt;
 47 &lt;h2&gt;Auto-shutdown&lt;/h2&gt;
 48 
 49 According to
 50 &lt;cite&gt;The Java&amp;trade; Virtual Machine Specification&lt;/cite&gt;,
 51 sections 2.17.9 and 2.19,
 52 the Java virtual machine (JVM) initially starts up with a single non-daemon
 53 thread, which typically calls the &lt;code&gt;main&lt;/code&gt; method of some class.
 54 The virtual machine terminates all its activity and exits when
 55 one of two things happens:
 56 &lt;ul&gt;
 57   &lt;li&gt; All the threads that are not daemon threads terminate.
 58   &lt;li&gt; Some thread invokes the &lt;code&gt;exit&lt;/code&gt; method of class
 59   &lt;code&gt;Runtime&lt;/code&gt; or class &lt;code&gt;System&lt;/code&gt;, and the exit
 60   operation is permitted by the security manager.
 61 &lt;/ul&gt;
 62 &lt;p&gt;
 63 This implies that if an application doesn&#39;t start any threads itself,
 64 the JVM will exit as soon as &lt;code&gt;main&lt;/code&gt; terminates.
 65 This is not the case, however, for a simple application
 66 that creates and displays a &lt;code&gt;java.awt.Frame&lt;/code&gt;:
 67 &lt;pre&gt;
 68         public static void main(String[] args) {
 69             Frame frame = new Frame();
 70             frame.setVisible(true);
 71          }
 72 &lt;/pre&gt;
 73 The reason is that AWT encapsulates asynchronous event dispatch
 74 machinery to process events AWT or Swing components can fire. The
 75 exact behavior of this machinery is implementation-dependent. In
 76 particular, it can start non-daemon helper threads for its internal
 77 purposes. In fact, these are the threads that prevent the example
 78 above from exiting. The only restrictions imposed on the behavior of
 79 this machinery are as follows:
 80 &lt;ul&gt;
 81   &lt;li&gt; &lt;a href=&quot;../EventQueue.html#isDispatchThread()&quot;&gt;&lt;code&gt;EventQueue.isDispatchThread&lt;/code&gt;&lt;/a&gt;
 82        returns &lt;code&gt;true&lt;/code&gt; if and only if the calling thread is the
 83        event dispatch thread started by the machinery;
 84   &lt;li&gt; &lt;code&gt;AWTEvents&lt;/code&gt; which were actually enqueued to a
 85        particular &lt;code&gt;EventQueue&lt;/code&gt; (note that events being
 86        posted to the &lt;code&gt;EventQueue&lt;/code&gt; can be coalesced) are
 87        dispatched:
 88        &lt;ul&gt;
 89            &lt;li&gt;
 90            &lt;dl&gt;&lt;dt&gt;Sequentially.
 91              &lt;dd&gt; That is, it is not permitted that several events from
 92 	        this queue are dispatched simultaneously. &lt;/dd&gt;&lt;/dl&gt;
 93            &lt;li&gt;
 94            &lt;dl&gt;&lt;dt&gt;In the same order as they are enqueued.
 95              &lt;dd&gt; That is, if &lt;code&gt;AWTEvent&lt;/code&gt;&amp;nbsp;A is enqueued
 96 	        to the &lt;code&gt;EventQueue&lt;/code&gt; before
 97 		&lt;code&gt;AWTEvent&lt;/code&gt;&amp;nbsp;B then event B will not be
 98                 dispatched before event A.&lt;/dd&gt;&lt;/dl&gt;
 99        &lt;/ul&gt;
100   &lt;li&gt; There is at least one alive non-daemon thread while there is at
101        least one displayable AWT or Swing component within the
102        application (see
103        &lt;a href=&quot;../Component.html#isDisplayable()&quot;&gt;&lt;code&gt;Component.isDisplayable&lt;/code&gt;&lt;/a&gt;).
104 &lt;/ul&gt;
105 The implications of the third restriction are as follows:
106 &lt;ul&gt;
107   &lt;li&gt; The JVM will exit if some thread invokes the &lt;code&gt;exit&lt;/code&gt;
108   method of class &lt;code&gt;Runtime&lt;/code&gt; or class &lt;code&gt;System&lt;/code&gt;
109   regardless of the presence of displayable components;
110   &lt;li&gt; Even if the application terminates all non-daemon threads it
111   started, the JVM will not exit while there is at least one
112   displayable component.
113 &lt;/ul&gt;
114 It depends on the implementation if and when the non-daemon helper
115 threads are terminated once all components are made undisplayable.
116 The implementation-specific details are given below.
117 
118 &lt;h3&gt;
119 Implementation-dependent behavior.
120 &lt;/h3&gt;
121 
122 Prior to 1.4, the helper threads were never terminated.
123 &lt;p&gt;
124 Starting with 1.4, the behavior has changed as a result of the fix for
125 &lt;a href=&quot;https://bugs.java.com/view_bug.do?bug_id=4030718&quot;&gt;
126 4030718&lt;/a&gt;. With the current implementation, AWT terminates all its
127 helper threads allowing the application to exit cleanly when the
128 following three conditions are true:
129 &lt;ul&gt;
130   &lt;li&gt; There are no displayable AWT or Swing components.
131   &lt;li&gt; There are no native events in the native event queue.
132   &lt;li&gt; There are no AWT events in java EventQueues.
133 &lt;/ul&gt;
134 Therefore, a stand-alone AWT application that wishes to exit
135 cleanly without calling &lt;code&gt;System.exit&lt;/code&gt; must:
136 &lt;ul&gt;
137   &lt;li&gt; Make sure that all AWT or Swing components are made
138        undisplayable when the application finishes. This can be done
139        by calling
140 &lt;a href=&quot;../Window.html#dispose()&quot;&gt;&lt;code&gt;Window.dispose&lt;/code&gt;&lt;/a&gt;
141        on all top-level &lt;code&gt;Windows&lt;/code&gt;. See
142 &lt;a href=&quot;../Frame.html#getFrames()&quot;&gt;&lt;code&gt;Frame.getFrames&lt;/code&gt;&lt;/a&gt;.
143   &lt;li&gt; Make sure that no method of AWT event listeners registered by
144        the application with any AWT or Swing component can run into an
145        infinite loop or hang indefinitely. For example, an AWT listener
146        method triggered by some AWT event can post a new AWT event of
147        the same type to the &lt;code&gt;EventQueue&lt;/code&gt;.
148        The argument is that methods
149        of AWT event listeners are typically executed on helper
150        threads.
151 &lt;/ul&gt;
152 Note, that while an application following these recommendations will
153 exit cleanly under normal conditions, it is not guaranteed that it
154 will exit cleanly in all cases. Two examples:
155 &lt;ul&gt;
156   &lt;li&gt; Other packages can create displayable components for internal
157        needs and never make them undisplayable. See
158 &lt;a href=&quot;https://bugs.java.com/view_bug.do?bug_id=4515058&quot;&gt;
159 4515058&lt;/a&gt;,
160 &lt;a href=&quot;https://bugs.java.com/view_bug.do?bug_id=4671025&quot;&gt;
161 4671025&lt;/a&gt;, and
162 &lt;a href=&quot;https://bugs.java.com/view_bug.do?bug_id=4465537&quot;&gt;
163 4465537&lt;/a&gt;.
164   &lt;li&gt; Both Microsoft Windows and X11 allow an application to send native
165        events to windows that belong to another application. With this
166        feature it is possible to write a malicious program that will
167        continuously send events to all available windows preventing
168        any AWT application from exiting cleanly.
169 &lt;/ul&gt;
170 On the other hand, if you require the JVM to continue running even after
171 the application has made all components undisplayable you should start a
172 non-daemon thread that blocks forever.
173 
174 &lt;pre&gt;
175         &amp;lt;...&amp;gt;
176         Runnable r = new Runnable() {
177             public void run() {
178                 Object o = new Object();
179                 try {
180                     synchronized (o) {
181                         o.wait();
182                     }
183                 } catch (InterruptedException ie) {
184                 }
185             }
186         };
187         Thread t = new Thread(r);
188         t.setDaemon(false);
189         t.start();
190         &amp;lt;...&amp;gt;
191 &lt;/pre&gt;
192 
193 &lt;cite&gt;The Java&amp;trade; Virtual Machine Specification&lt;/cite&gt;
194  guarantees
195 that the JVM doesn&#39;t exit until this thread terminates.
196 &lt;/div&gt;
197 &lt;/main&gt;
198 &lt;/body&gt;
199 &lt;/html&gt;
    </pre>
  </body>
</html>