<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/classes/java/awt/color/ICC_Profile.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../Window.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../desktop/FilesEvent.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/java/awt/color/ICC_Profile.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 /* ********************************************************************
  27  **********************************************************************
  28  **********************************************************************
  29  *** COPYRIGHT (c) Eastman Kodak Company, 1997                      ***
  30  *** As  an unpublished  work pursuant to Title 17 of the United    ***
  31  *** States Code.  All rights reserved.                             ***
  32  **********************************************************************
  33  **********************************************************************
  34  **********************************************************************/
  35 
  36 package java.awt.color;
  37 

  38 import java.io.File;
  39 import java.io.FileInputStream;
  40 import java.io.FileOutputStream;
  41 import java.io.FilePermission;
  42 import java.io.IOException;
  43 import java.io.InputStream;
  44 import java.io.ObjectInputStream;
  45 import java.io.ObjectOutputStream;
  46 import java.io.ObjectStreamException;
  47 import java.io.OutputStream;
  48 import java.io.Serializable;
  49 import java.security.AccessController;
  50 import java.security.PrivilegedAction;
  51 import java.util.StringTokenizer;
  52 
  53 import sun.java2d.cmm.CMSManager;
  54 import sun.java2d.cmm.PCMM;
  55 import sun.java2d.cmm.Profile;
  56 import sun.java2d.cmm.ProfileActivator;
  57 import sun.java2d.cmm.ProfileDataVerifier;
</pre>
<hr />
<pre>
 743             }
 744         };
 745         ProfileDeferralMgr.registerDeferral(this.profileActivator);
 746     }
 747 
 748     /**
 749      * Frees the resources associated with an {@code ICC_Profile} object.
 750      *
 751      * @deprecated The {@code finalize} method has been deprecated. Subclasses
 752      *         that override {@code finalize} in order to perform cleanup should
 753      *         be modified to use alternative cleanup mechanisms and to remove
 754      *         the overriding {@code finalize} method. When overriding the
 755      *         {@code finalize} method, its implementation must explicitly
 756      *         ensure that {@code super.finalize()} is invoked as described in
 757      *         {@link Object#finalize}. See the specification for {@link
 758      *         Object#finalize()} for further information about migration
 759      *         options.
 760      */
 761     @Deprecated(since=&quot;9&quot;)
 762     protected void finalize () {
<span class="line-removed"> 763         if (cmmProfile != null) {</span>
<span class="line-removed"> 764             CMSManager.getModule().freeProfile(cmmProfile);</span>
<span class="line-removed"> 765         } else if (profileActivator != null) {</span>
<span class="line-removed"> 766             ProfileDeferralMgr.unregisterDeferral(profileActivator);</span>
<span class="line-removed"> 767         }</span>
 768     }
 769 
 770     /**
 771      * Constructs an {@code ICC_Profile} object corresponding to the data in a
 772      * byte array. Throws an {@code IllegalArgumentException} if the data does
 773      * not correspond to a valid ICC Profile.
 774      *
 775      * @param  data the specified ICC Profile data
 776      * @return an {@code ICC_Profile} object corresponding to the data in the
 777      *         specified {@code data} array
 778      */
 779     public static ICC_Profile getInstance(byte[] data) {
 780     ICC_Profile thisProfile;
 781 
 782         Profile p = null;
 783 
 784         if (ProfileDeferralMgr.deferring) {
 785             ProfileDeferralMgr.activateProfiles();
 786         }
 787 
</pre>
<hr />
<pre>
1005      * @throws IllegalArgumentException If the stream does not contain valid ICC
1006      *         Profile data
1007      */
1008     public static ICC_Profile getInstance(InputStream s) throws IOException {
1009     byte[] profileData;
1010 
1011         if (s instanceof ProfileDeferralInfo) {
1012             /* hack to detect profiles whose loading can be deferred */
1013             return getDeferredInstance((ProfileDeferralInfo) s);
1014         }
1015 
1016         if ((profileData = getProfileDataFromStream(s)) == null) {
1017             throw new IllegalArgumentException(&quot;Invalid ICC Profile Data&quot;);
1018         }
1019 
1020         return getInstance(profileData);
1021     }
1022 
1023 
1024     static byte[] getProfileDataFromStream(InputStream s) throws IOException {
<span class="line-removed">1025     byte[] profileData;</span>
<span class="line-removed">1026     int profileSize;</span>
1027 
<span class="line-modified">1028         byte[] header = new byte[128];</span>
<span class="line-modified">1029         int bytestoread = 128;</span>
<span class="line-removed">1030         int bytesread = 0;</span>
<span class="line-removed">1031         int n;</span>
1032 
<span class="line-modified">1033         while (bytestoread != 0) {</span>
<span class="line-removed">1034             if ((n = s.read(header, bytesread, bytestoread)) &lt; 0) {</span>
<span class="line-removed">1035                 return null;</span>
<span class="line-removed">1036             }</span>
<span class="line-removed">1037             bytesread += n;</span>
<span class="line-removed">1038             bytestoread -= n;</span>
<span class="line-removed">1039         }</span>
1040         if (header[36] != 0x61 || header[37] != 0x63 ||
1041             header[38] != 0x73 || header[39] != 0x70) {
1042             return null;   /* not a valid profile */
1043         }
<span class="line-modified">1044         profileSize = ((header[0] &amp; 0xff) &lt;&lt; 24) |</span>
<span class="line-modified">1045                       ((header[1] &amp; 0xff) &lt;&lt; 16) |</span>
<span class="line-modified">1046                       ((header[2] &amp; 0xff) &lt;&lt;  8) |</span>
<span class="line-modified">1047                        (header[3] &amp; 0xff);</span>
<span class="line-modified">1048         profileData = new byte[profileSize];</span>
<span class="line-modified">1049         System.arraycopy(header, 0, profileData, 0, 128);</span>
<span class="line-modified">1050         bytestoread = profileSize - 128;</span>
<span class="line-modified">1051         bytesread = 128;</span>
<span class="line-modified">1052         while (bytestoread != 0) {</span>
<span class="line-removed">1053             if ((n = s.read(profileData, bytesread, bytestoread)) &lt; 0) {</span>
<span class="line-removed">1054                 return null;</span>
<span class="line-removed">1055             }</span>
<span class="line-removed">1056             bytesread += n;</span>
<span class="line-removed">1057             bytestoread -= n;</span>
1058         }
<span class="line-removed">1059 </span>
<span class="line-removed">1060         return profileData;</span>
1061     }
1062 
1063     /**
1064      * Constructs an {@code ICC_Profile} for which the actual loading of the
1065      * profile data from a file and the initialization of the CMM should be
1066      * deferred as long as possible. Deferral is only used for standard
1067      * profiles. If deferring is disabled, then getStandardProfile() ensures
1068      * that all of the appropriate access privileges are granted when loading
1069      * this profile. If deferring is enabled, then the deferred activation code
1070      * will take care of access privileges.
1071      *
1072      * @see #activateDeferredProfile()
1073      */
1074     static ICC_Profile getDeferredInstance(ProfileDeferralInfo pdi) {
1075         if (!ProfileDeferralMgr.deferring) {
1076             return getStandardProfile(pdi.filename);
1077         }
1078         if (pdi.colorSpaceType == ColorSpace.TYPE_RGB) {
1079             return new ICC_ProfileRGB(pdi);
1080         } else if (pdi.colorSpaceType == ColorSpace.TYPE_GRAY) {
</pre>
</td>
<td>
<hr />
<pre>
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 /* ********************************************************************
  27  **********************************************************************
  28  **********************************************************************
  29  *** COPYRIGHT (c) Eastman Kodak Company, 1997                      ***
  30  *** As  an unpublished  work pursuant to Title 17 of the United    ***
  31  *** States Code.  All rights reserved.                             ***
  32  **********************************************************************
  33  **********************************************************************
  34  **********************************************************************/
  35 
  36 package java.awt.color;
  37 
<span class="line-added">  38 import java.io.BufferedInputStream;</span>
  39 import java.io.File;
  40 import java.io.FileInputStream;
  41 import java.io.FileOutputStream;
  42 import java.io.FilePermission;
  43 import java.io.IOException;
  44 import java.io.InputStream;
  45 import java.io.ObjectInputStream;
  46 import java.io.ObjectOutputStream;
  47 import java.io.ObjectStreamException;
  48 import java.io.OutputStream;
  49 import java.io.Serializable;
  50 import java.security.AccessController;
  51 import java.security.PrivilegedAction;
  52 import java.util.StringTokenizer;
  53 
  54 import sun.java2d.cmm.CMSManager;
  55 import sun.java2d.cmm.PCMM;
  56 import sun.java2d.cmm.Profile;
  57 import sun.java2d.cmm.ProfileActivator;
  58 import sun.java2d.cmm.ProfileDataVerifier;
</pre>
<hr />
<pre>
 744             }
 745         };
 746         ProfileDeferralMgr.registerDeferral(this.profileActivator);
 747     }
 748 
 749     /**
 750      * Frees the resources associated with an {@code ICC_Profile} object.
 751      *
 752      * @deprecated The {@code finalize} method has been deprecated. Subclasses
 753      *         that override {@code finalize} in order to perform cleanup should
 754      *         be modified to use alternative cleanup mechanisms and to remove
 755      *         the overriding {@code finalize} method. When overriding the
 756      *         {@code finalize} method, its implementation must explicitly
 757      *         ensure that {@code super.finalize()} is invoked as described in
 758      *         {@link Object#finalize}. See the specification for {@link
 759      *         Object#finalize()} for further information about migration
 760      *         options.
 761      */
 762     @Deprecated(since=&quot;9&quot;)
 763     protected void finalize () {





 764     }
 765 
 766     /**
 767      * Constructs an {@code ICC_Profile} object corresponding to the data in a
 768      * byte array. Throws an {@code IllegalArgumentException} if the data does
 769      * not correspond to a valid ICC Profile.
 770      *
 771      * @param  data the specified ICC Profile data
 772      * @return an {@code ICC_Profile} object corresponding to the data in the
 773      *         specified {@code data} array
 774      */
 775     public static ICC_Profile getInstance(byte[] data) {
 776     ICC_Profile thisProfile;
 777 
 778         Profile p = null;
 779 
 780         if (ProfileDeferralMgr.deferring) {
 781             ProfileDeferralMgr.activateProfiles();
 782         }
 783 
</pre>
<hr />
<pre>
1001      * @throws IllegalArgumentException If the stream does not contain valid ICC
1002      *         Profile data
1003      */
1004     public static ICC_Profile getInstance(InputStream s) throws IOException {
1005     byte[] profileData;
1006 
1007         if (s instanceof ProfileDeferralInfo) {
1008             /* hack to detect profiles whose loading can be deferred */
1009             return getDeferredInstance((ProfileDeferralInfo) s);
1010         }
1011 
1012         if ((profileData = getProfileDataFromStream(s)) == null) {
1013             throw new IllegalArgumentException(&quot;Invalid ICC Profile Data&quot;);
1014         }
1015 
1016         return getInstance(profileData);
1017     }
1018 
1019 
1020     static byte[] getProfileDataFromStream(InputStream s) throws IOException {


1021 
<span class="line-modified">1022         BufferedInputStream bis = new BufferedInputStream(s);</span>
<span class="line-modified">1023         bis.mark(128);</span>


1024 
<span class="line-modified">1025         byte[] header = bis.readNBytes(128);</span>






1026         if (header[36] != 0x61 || header[37] != 0x63 ||
1027             header[38] != 0x73 || header[39] != 0x70) {
1028             return null;   /* not a valid profile */
1029         }
<span class="line-modified">1030         int profileSize = ((header[0] &amp; 0xff) &lt;&lt; 24) |</span>
<span class="line-modified">1031                           ((header[1] &amp; 0xff) &lt;&lt; 16) |</span>
<span class="line-modified">1032                           ((header[2] &amp; 0xff) &lt;&lt; 8) |</span>
<span class="line-modified">1033                           (header[3] &amp; 0xff);</span>
<span class="line-modified">1034         bis.reset();</span>
<span class="line-modified">1035         try {</span>
<span class="line-modified">1036             return bis.readNBytes(profileSize);</span>
<span class="line-modified">1037         } catch (OutOfMemoryError e) {</span>
<span class="line-modified">1038             throw new IOException(&quot;Color profile is too big&quot;);</span>





1039         }


1040     }
1041 
1042     /**
1043      * Constructs an {@code ICC_Profile} for which the actual loading of the
1044      * profile data from a file and the initialization of the CMM should be
1045      * deferred as long as possible. Deferral is only used for standard
1046      * profiles. If deferring is disabled, then getStandardProfile() ensures
1047      * that all of the appropriate access privileges are granted when loading
1048      * this profile. If deferring is enabled, then the deferred activation code
1049      * will take care of access privileges.
1050      *
1051      * @see #activateDeferredProfile()
1052      */
1053     static ICC_Profile getDeferredInstance(ProfileDeferralInfo pdi) {
1054         if (!ProfileDeferralMgr.deferring) {
1055             return getStandardProfile(pdi.filename);
1056         }
1057         if (pdi.colorSpaceType == ColorSpace.TYPE_RGB) {
1058             return new ICC_ProfileRGB(pdi);
1059         } else if (pdi.colorSpaceType == ColorSpace.TYPE_GRAY) {
</pre>
</td>
</tr>
</table>
<center><a href="../Window.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../desktop/FilesEvent.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>