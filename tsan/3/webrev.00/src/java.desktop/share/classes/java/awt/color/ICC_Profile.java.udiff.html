<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.desktop/share/classes/java/awt/color/ICC_Profile.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../Window.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../desktop/FilesEvent.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/java/awt/color/ICC_Profile.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -33,10 +33,11 @@</span>
   **********************************************************************
   **********************************************************************/
  
  package java.awt.color;
  
<span class="udiff-line-added">+ import java.io.BufferedInputStream;</span>
  import java.io.File;
  import java.io.FileInputStream;
  import java.io.FileOutputStream;
  import java.io.FilePermission;
  import java.io.IOException;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -758,15 +759,10 @@</span>
       *         Object#finalize()} for further information about migration
       *         options.
       */
      @Deprecated(since=&quot;9&quot;)
      protected void finalize () {
<span class="udiff-line-removed">-         if (cmmProfile != null) {</span>
<span class="udiff-line-removed">-             CMSManager.getModule().freeProfile(cmmProfile);</span>
<span class="udiff-line-removed">-         } else if (profileActivator != null) {</span>
<span class="udiff-line-removed">-             ProfileDeferralMgr.unregisterDeferral(profileActivator);</span>
<span class="udiff-line-removed">-         }</span>
      }
  
      /**
       * Constructs an {@code ICC_Profile} object corresponding to the data in a
       * byte array. Throws an {@code IllegalArgumentException} if the data does
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1020,46 +1016,29 @@</span>
          return getInstance(profileData);
      }
  
  
      static byte[] getProfileDataFromStream(InputStream s) throws IOException {
<span class="udiff-line-removed">-     byte[] profileData;</span>
<span class="udiff-line-removed">-     int profileSize;</span>
  
<span class="udiff-line-modified-removed">-         byte[] header = new byte[128];</span>
<span class="udiff-line-modified-removed">-         int bytestoread = 128;</span>
<span class="udiff-line-removed">-         int bytesread = 0;</span>
<span class="udiff-line-removed">-         int n;</span>
<span class="udiff-line-modified-added">+         BufferedInputStream bis = new BufferedInputStream(s);</span>
<span class="udiff-line-modified-added">+         bis.mark(128);</span>
  
<span class="udiff-line-modified-removed">-         while (bytestoread != 0) {</span>
<span class="udiff-line-removed">-             if ((n = s.read(header, bytesread, bytestoread)) &lt; 0) {</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             bytesread += n;</span>
<span class="udiff-line-removed">-             bytestoread -= n;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         byte[] header = bis.readNBytes(128);</span>
          if (header[36] != 0x61 || header[37] != 0x63 ||
              header[38] != 0x73 || header[39] != 0x70) {
              return null;   /* not a valid profile */
          }
<span class="udiff-line-modified-removed">-         profileSize = ((header[0] &amp; 0xff) &lt;&lt; 24) |</span>
<span class="udiff-line-modified-removed">-                       ((header[1] &amp; 0xff) &lt;&lt; 16) |</span>
<span class="udiff-line-modified-removed">-                       ((header[2] &amp; 0xff) &lt;&lt;  8) |</span>
<span class="udiff-line-modified-removed">-                        (header[3] &amp; 0xff);</span>
<span class="udiff-line-modified-removed">-         profileData = new byte[profileSize];</span>
<span class="udiff-line-modified-removed">-         System.arraycopy(header, 0, profileData, 0, 128);</span>
<span class="udiff-line-modified-removed">-         bytestoread = profileSize - 128;</span>
<span class="udiff-line-modified-removed">-         bytesread = 128;</span>
<span class="udiff-line-modified-removed">-         while (bytestoread != 0) {</span>
<span class="udiff-line-removed">-             if ((n = s.read(profileData, bytesread, bytestoread)) &lt; 0) {</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             bytesread += n;</span>
<span class="udiff-line-removed">-             bytestoread -= n;</span>
<span class="udiff-line-modified-added">+         int profileSize = ((header[0] &amp; 0xff) &lt;&lt; 24) |</span>
<span class="udiff-line-modified-added">+                           ((header[1] &amp; 0xff) &lt;&lt; 16) |</span>
<span class="udiff-line-modified-added">+                           ((header[2] &amp; 0xff) &lt;&lt; 8) |</span>
<span class="udiff-line-modified-added">+                           (header[3] &amp; 0xff);</span>
<span class="udiff-line-modified-added">+         bis.reset();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             return bis.readNBytes(profileSize);</span>
<span class="udiff-line-modified-added">+         } catch (OutOfMemoryError e) {</span>
<span class="udiff-line-modified-added">+             throw new IOException(&quot;Color profile is too big&quot;);</span>
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return profileData;</span>
      }
  
      /**
       * Constructs an {@code ICC_Profile} for which the actual loading of the
       * profile data from a file and the initialization of the CMM should be
</pre>
<center><a href="../Window.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../desktop/FilesEvent.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>