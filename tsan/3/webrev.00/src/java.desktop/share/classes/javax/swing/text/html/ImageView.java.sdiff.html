<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.desktop/share/classes/javax/swing/text/html/ImageView.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HTMLEditorKit.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../sun/awt/DebugSettings.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.desktop/share/classes/javax/swing/text/html/ImageView.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 package javax.swing.text.html;
  26 
  27 import java.awt.Rectangle;
  28 import java.awt.Image;

  29 import java.awt.Container;
  30 import java.awt.Color;
  31 import java.awt.Shape;
  32 import java.awt.Graphics;
  33 import java.awt.Toolkit;
  34 
  35 import java.awt.image.ImageObserver;
  36 import java.net.URL;
  37 import java.net.MalformedURLException;
  38 
  39 import java.util.Dictionary;
  40 
  41 import javax.swing.GrayFilter;
  42 import javax.swing.ImageIcon;
  43 import javax.swing.Icon;
  44 import javax.swing.UIManager;
  45 import javax.swing.SwingUtilities;
  46 
  47 import javax.swing.text.JTextComponent;
  48 import javax.swing.text.StyledDocument;
</pre>
<hr />
<pre>
 765         Image newImage = getImage();
 766 
 767         if (newImage != null) {
 768             Element elem = getElement();
 769             AttributeSet attr = elem.getAttributes();
 770 
 771             // Get the width/height and set the state ivar before calling
 772             // anything that might cause the image to be loaded, and thus the
 773             // ImageHandler to be called.
 774             newWidth = getIntAttr(HTML.Attribute.WIDTH, -1);
 775             newHeight = getIntAttr(HTML.Attribute.HEIGHT, -1);
 776 
 777             if (newWidth &gt; 0) {
 778                 newState |= WIDTH_FLAG;
 779             }
 780 
 781             if (newHeight &gt; 0) {
 782                 newState |= HEIGHT_FLAG;
 783             }
 784 





























 785             // Make sure the image starts loading:
 786             if ((newState &amp; (WIDTH_FLAG | HEIGHT_FLAG)) != 0) {
 787                 Toolkit.getDefaultToolkit().prepareImage(newImage, newWidth,
 788                                                          newHeight,
 789                                                          imageObserver);
 790             }
 791             else {
 792                 Toolkit.getDefaultToolkit().prepareImage(newImage, -1, -1,
 793                                                          imageObserver);
 794             }
 795 
 796             boolean createText = false;
 797             synchronized(this) {
 798                 // If imageloading failed, other thread may have called
 799                 // ImageLoader which will null out image, hence we check
 800                 // for it.
 801                 if (image != null) {
 802                     if ((newState &amp; WIDTH_FLAG) == WIDTH_FLAG || width == 0) {
 803                         width = newWidth;
 804                     }
</pre>
<hr />
<pre>
 868     private void safePreferenceChanged() {
 869         if (SwingUtilities.isEventDispatchThread()) {
 870             Document doc = getDocument();
 871             if (doc instanceof AbstractDocument) {
 872                 ((AbstractDocument)doc).readLock();
 873             }
 874             preferenceChanged(null, true, true);
 875             if (doc instanceof AbstractDocument) {
 876                 ((AbstractDocument)doc).readUnlock();
 877             }
 878         }
 879         else {
 880             SwingUtilities.invokeLater(new Runnable() {
 881                     public void run() {
 882                         safePreferenceChanged();
 883                     }
 884                 });
 885         }
 886     }
 887 


































 888     /**
 889      * ImageHandler implements the ImageObserver to correctly update the
 890      * display as new parts of the image become available.
 891      */
 892     private class ImageHandler implements ImageObserver {
 893         // This can come on any thread. If we are in the process of reloading
 894         // the image and determining our state (loading == true) we don&#39;t fire
 895         // preference changed, or repaint, we just reset the fWidth/fHeight as
 896         // necessary and return. This is ok as we know when loading finishes
 897         // it will pick up the new height/width, if necessary.
 898         public boolean imageUpdate(Image img, int flags, int x, int y,
 899                                    int newWidth, int newHeight ) {
 900             if (img != image &amp;&amp; img != disabledImage ||
 901                 image == null || getParent() == null) {
 902 
 903                 return false;
 904             }
 905 
 906             // Bail out if there was an error:
 907             if ((flags &amp; (ABORT|ERROR)) != 0) {
</pre>
<hr />
<pre>
 933 
 934             if (image == img) {
 935                 // Resize image if necessary:
 936                 short changed = 0;
 937                 if ((flags &amp; ImageObserver.HEIGHT) != 0 &amp;&amp; !getElement().
 938                       getAttributes().isDefined(HTML.Attribute.HEIGHT)) {
 939                     changed |= 1;
 940                 }
 941                 if ((flags &amp; ImageObserver.WIDTH) != 0 &amp;&amp; !getElement().
 942                       getAttributes().isDefined(HTML.Attribute.WIDTH)) {
 943                     changed |= 2;
 944                 }
 945 
 946                 /**
 947                  * If the image properties (height and width) have been loaded,
 948                  * then figure out if scaling is necessary based on the
 949                  * specified HTML attributes.
 950                  */
 951                 if (((flags &amp; ImageObserver.HEIGHT) != 0) &amp;&amp;
 952                     ((flags &amp; ImageObserver.WIDTH) != 0)) {
<span class="line-modified"> 953                     double proportion = 0.0;</span>
<span class="line-modified"> 954                     final int specifiedWidth = getIntAttr(HTML.Attribute.WIDTH, -1);</span>
<span class="line-modified"> 955                     final int specifiedHeight = getIntAttr(HTML.Attribute.HEIGHT, -1);</span>
<span class="line-removed"> 956                     /**</span>
<span class="line-removed"> 957                      * If either of the attributes are not specified, then calculate the</span>
<span class="line-removed"> 958                      * proportion for the specified dimension wrt actual value, and then</span>
<span class="line-removed"> 959                      * apply the same proportion to the unspecified dimension as well,</span>
<span class="line-removed"> 960                      * so that the aspect ratio of the image is maintained.</span>
<span class="line-removed"> 961                      */</span>
<span class="line-removed"> 962                     if (specifiedWidth != -1 ^ specifiedHeight != -1) {</span>
<span class="line-removed"> 963                         if (specifiedWidth &lt;= 0) {</span>
<span class="line-removed"> 964                             proportion = specifiedHeight / ((double)newHeight);</span>
<span class="line-removed"> 965                             newWidth = (int)(proportion * newWidth);</span>
<span class="line-removed"> 966                         }</span>
<span class="line-removed"> 967 </span>
<span class="line-removed"> 968                         if (specifiedHeight &lt;= 0) {</span>
<span class="line-removed"> 969                             proportion = specifiedWidth / ((double)newWidth);</span>
<span class="line-removed"> 970                             newHeight = (int)(proportion * newHeight);</span>
<span class="line-removed"> 971                         }</span>
 972                         changed |= 3;
<span class="line-removed"> 973                     }</span>
 974                 }
 975                 synchronized(ImageView.this) {
 976                     if ((changed &amp; 1) == 1 &amp;&amp; (state &amp; HEIGHT_FLAG) == 0) {
 977                         height = newHeight;
 978                     }
 979                     if ((changed &amp; 2) == 2 &amp;&amp; (state &amp; WIDTH_FLAG) == 0) {
 980                         width = newWidth;
 981                     }
 982                     if ((state &amp; LOADING_FLAG) == LOADING_FLAG) {
 983                         // No need to resize or repaint, still in the process of
 984                         // loading.
 985                         return true;
 986                     }
 987                 }
 988                 if (changed != 0) {
 989                     // May need to resize myself, asynchronously:
 990                     safePreferenceChanged();
 991                     return true;
 992                 }
 993             }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 package javax.swing.text.html;
  26 
  27 import java.awt.Rectangle;
  28 import java.awt.Image;
<span class="line-added">  29 import java.awt.Dimension;</span>
  30 import java.awt.Container;
  31 import java.awt.Color;
  32 import java.awt.Shape;
  33 import java.awt.Graphics;
  34 import java.awt.Toolkit;
  35 
  36 import java.awt.image.ImageObserver;
  37 import java.net.URL;
  38 import java.net.MalformedURLException;
  39 
  40 import java.util.Dictionary;
  41 
  42 import javax.swing.GrayFilter;
  43 import javax.swing.ImageIcon;
  44 import javax.swing.Icon;
  45 import javax.swing.UIManager;
  46 import javax.swing.SwingUtilities;
  47 
  48 import javax.swing.text.JTextComponent;
  49 import javax.swing.text.StyledDocument;
</pre>
<hr />
<pre>
 766         Image newImage = getImage();
 767 
 768         if (newImage != null) {
 769             Element elem = getElement();
 770             AttributeSet attr = elem.getAttributes();
 771 
 772             // Get the width/height and set the state ivar before calling
 773             // anything that might cause the image to be loaded, and thus the
 774             // ImageHandler to be called.
 775             newWidth = getIntAttr(HTML.Attribute.WIDTH, -1);
 776             newHeight = getIntAttr(HTML.Attribute.HEIGHT, -1);
 777 
 778             if (newWidth &gt; 0) {
 779                 newState |= WIDTH_FLAG;
 780             }
 781 
 782             if (newHeight &gt; 0) {
 783                 newState |= HEIGHT_FLAG;
 784             }
 785 
<span class="line-added"> 786             Image img;</span>
<span class="line-added"> 787             synchronized(this) {</span>
<span class="line-added"> 788                 img = image;</span>
<span class="line-added"> 789             }</span>
<span class="line-added"> 790             if (newWidth &lt;= 0) {</span>
<span class="line-added"> 791                 newWidth = img.getWidth(imageObserver);</span>
<span class="line-added"> 792                 if (newWidth &lt;= 0) {</span>
<span class="line-added"> 793                     newWidth = DEFAULT_WIDTH;</span>
<span class="line-added"> 794                 }</span>
<span class="line-added"> 795             }</span>
<span class="line-added"> 796             if (newHeight &lt;= 0) {</span>
<span class="line-added"> 797                 newHeight = img.getHeight(imageObserver);</span>
<span class="line-added"> 798                 if (newHeight &lt;= 0) {</span>
<span class="line-added"> 799                     newHeight = DEFAULT_HEIGHT;</span>
<span class="line-added"> 800                 }</span>
<span class="line-added"> 801             }</span>
<span class="line-added"> 802             /*</span>
<span class="line-added"> 803             If synchronous loading flag is set, then make sure that the image is</span>
<span class="line-added"> 804             scaled appropriately.</span>
<span class="line-added"> 805             Otherwise, the ImageHandler::imageUpdate takes care of scaling the image</span>
<span class="line-added"> 806             appropriately.</span>
<span class="line-added"> 807             */</span>
<span class="line-added"> 808             if (getLoadsSynchronously()) {</span>
<span class="line-added"> 809                 Dimension d = adjustWidthHeight(newWidth, newHeight);</span>
<span class="line-added"> 810                 newWidth = d.width;</span>
<span class="line-added"> 811                 newHeight = d.height;</span>
<span class="line-added"> 812                 newState |= (WIDTH_FLAG | HEIGHT_FLAG);</span>
<span class="line-added"> 813             }</span>
<span class="line-added"> 814 </span>
 815             // Make sure the image starts loading:
 816             if ((newState &amp; (WIDTH_FLAG | HEIGHT_FLAG)) != 0) {
 817                 Toolkit.getDefaultToolkit().prepareImage(newImage, newWidth,
 818                                                          newHeight,
 819                                                          imageObserver);
 820             }
 821             else {
 822                 Toolkit.getDefaultToolkit().prepareImage(newImage, -1, -1,
 823                                                          imageObserver);
 824             }
 825 
 826             boolean createText = false;
 827             synchronized(this) {
 828                 // If imageloading failed, other thread may have called
 829                 // ImageLoader which will null out image, hence we check
 830                 // for it.
 831                 if (image != null) {
 832                     if ((newState &amp; WIDTH_FLAG) == WIDTH_FLAG || width == 0) {
 833                         width = newWidth;
 834                     }
</pre>
<hr />
<pre>
 898     private void safePreferenceChanged() {
 899         if (SwingUtilities.isEventDispatchThread()) {
 900             Document doc = getDocument();
 901             if (doc instanceof AbstractDocument) {
 902                 ((AbstractDocument)doc).readLock();
 903             }
 904             preferenceChanged(null, true, true);
 905             if (doc instanceof AbstractDocument) {
 906                 ((AbstractDocument)doc).readUnlock();
 907             }
 908         }
 909         else {
 910             SwingUtilities.invokeLater(new Runnable() {
 911                     public void run() {
 912                         safePreferenceChanged();
 913                     }
 914                 });
 915         }
 916     }
 917 
<span class="line-added"> 918     private Dimension adjustWidthHeight(int newWidth, int newHeight) {</span>
<span class="line-added"> 919         Dimension d = new Dimension();</span>
<span class="line-added"> 920         double proportion = 0.0;</span>
<span class="line-added"> 921         final int specifiedWidth = getIntAttr(HTML.Attribute.WIDTH, -1);</span>
<span class="line-added"> 922         final int specifiedHeight = getIntAttr(HTML.Attribute.HEIGHT, -1);</span>
<span class="line-added"> 923         /**</span>
<span class="line-added"> 924          * If either of the attributes are not specified, then calculate the</span>
<span class="line-added"> 925          * proportion for the specified dimension wrt actual value, and then</span>
<span class="line-added"> 926          * apply the same proportion to the unspecified dimension as well,</span>
<span class="line-added"> 927          * so that the aspect ratio of the image is maintained.</span>
<span class="line-added"> 928          */</span>
<span class="line-added"> 929         if (specifiedWidth != -1 &amp;&amp; specifiedHeight != -1) {</span>
<span class="line-added"> 930             newWidth = specifiedWidth;</span>
<span class="line-added"> 931             newHeight = specifiedHeight;</span>
<span class="line-added"> 932         } else if (specifiedWidth != -1 ^ specifiedHeight != -1) {</span>
<span class="line-added"> 933             if (specifiedWidth &lt;= 0) {</span>
<span class="line-added"> 934                 proportion = specifiedHeight / ((double)newHeight);</span>
<span class="line-added"> 935                 newWidth = (int)(proportion * newWidth);</span>
<span class="line-added"> 936                 newHeight = specifiedHeight;</span>
<span class="line-added"> 937             }</span>
<span class="line-added"> 938 </span>
<span class="line-added"> 939             if (specifiedHeight &lt;= 0) {</span>
<span class="line-added"> 940                 proportion = specifiedWidth / ((double)newWidth);</span>
<span class="line-added"> 941                 newHeight = (int)(proportion * newHeight);</span>
<span class="line-added"> 942                 newWidth = specifiedWidth;</span>
<span class="line-added"> 943             }</span>
<span class="line-added"> 944         }</span>
<span class="line-added"> 945 </span>
<span class="line-added"> 946         d.width = newWidth;</span>
<span class="line-added"> 947         d.height = newHeight;</span>
<span class="line-added"> 948 </span>
<span class="line-added"> 949         return d;</span>
<span class="line-added"> 950     }</span>
<span class="line-added"> 951 </span>
 952     /**
 953      * ImageHandler implements the ImageObserver to correctly update the
 954      * display as new parts of the image become available.
 955      */
 956     private class ImageHandler implements ImageObserver {
 957         // This can come on any thread. If we are in the process of reloading
 958         // the image and determining our state (loading == true) we don&#39;t fire
 959         // preference changed, or repaint, we just reset the fWidth/fHeight as
 960         // necessary and return. This is ok as we know when loading finishes
 961         // it will pick up the new height/width, if necessary.
 962         public boolean imageUpdate(Image img, int flags, int x, int y,
 963                                    int newWidth, int newHeight ) {
 964             if (img != image &amp;&amp; img != disabledImage ||
 965                 image == null || getParent() == null) {
 966 
 967                 return false;
 968             }
 969 
 970             // Bail out if there was an error:
 971             if ((flags &amp; (ABORT|ERROR)) != 0) {
</pre>
<hr />
<pre>
 997 
 998             if (image == img) {
 999                 // Resize image if necessary:
1000                 short changed = 0;
1001                 if ((flags &amp; ImageObserver.HEIGHT) != 0 &amp;&amp; !getElement().
1002                       getAttributes().isDefined(HTML.Attribute.HEIGHT)) {
1003                     changed |= 1;
1004                 }
1005                 if ((flags &amp; ImageObserver.WIDTH) != 0 &amp;&amp; !getElement().
1006                       getAttributes().isDefined(HTML.Attribute.WIDTH)) {
1007                     changed |= 2;
1008                 }
1009 
1010                 /**
1011                  * If the image properties (height and width) have been loaded,
1012                  * then figure out if scaling is necessary based on the
1013                  * specified HTML attributes.
1014                  */
1015                 if (((flags &amp; ImageObserver.HEIGHT) != 0) &amp;&amp;
1016                     ((flags &amp; ImageObserver.WIDTH) != 0)) {
<span class="line-modified">1017                         Dimension d = adjustWidthHeight(newWidth, newHeight);</span>
<span class="line-modified">1018                         newWidth = d.width;</span>
<span class="line-modified">1019                         newHeight = d.height;</span>
















1020                         changed |= 3;

1021                 }
1022                 synchronized(ImageView.this) {
1023                     if ((changed &amp; 1) == 1 &amp;&amp; (state &amp; HEIGHT_FLAG) == 0) {
1024                         height = newHeight;
1025                     }
1026                     if ((changed &amp; 2) == 2 &amp;&amp; (state &amp; WIDTH_FLAG) == 0) {
1027                         width = newWidth;
1028                     }
1029                     if ((state &amp; LOADING_FLAG) == LOADING_FLAG) {
1030                         // No need to resize or repaint, still in the process of
1031                         // loading.
1032                         return true;
1033                     }
1034                 }
1035                 if (changed != 0) {
1036                     // May need to resize myself, asynchronously:
1037                     safePreferenceChanged();
1038                     return true;
1039                 }
1040             }
</pre>
</td>
</tr>
</table>
<center><a href="HTMLEditorKit.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../sun/awt/DebugSettings.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>