<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jshell/share/classes/jdk/jshell/Wrap.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="VarSnippet.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../module-info.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jshell/share/classes/jdk/jshell/Wrap.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -32,12 +32,10 @@</span>
  import static jdk.jshell.Util.DOIT_METHOD_NAME;
  
  /**
   * Wrapping of source into Java methods, fields, etc.  All but outer layer
   * wrapping with imports and class.
<span class="udiff-line-removed">-  *</span>
<span class="udiff-line-removed">-  * @author Robert Field</span>
   */
  abstract class Wrap implements GeneralWrap {
  
      private static Wrap methodWrap(String prefix, String source, String suffix) {
          Wrap wunit = new NoWrap(source);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -182,11 +180,11 @@</span>
          return cnt;
      }
  
      public static final class Range {
          final int begin;
<span class="udiff-line-modified-removed">-         final int end;</span>
<span class="udiff-line-modified-added">+         final int end; // exclusive</span>
  
          Range(int begin, int end) {
              this.begin = begin;
              this.end = end;
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -214,11 +212,11 @@</span>
              }
          }
  
          @Override
          public String toString() {
<span class="udiff-line-modified-removed">-             return &quot;Range[&quot; + begin + &quot;,&quot; + end + &quot;]&quot;;</span>
<span class="udiff-line-modified-added">+             return &quot;Range[&quot; + begin + &quot;,&quot; + end + &quot;)&quot;;</span>
          }
      }
  
      public static class CompoundWrap extends Wrap {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -278,12 +276,16 @@</span>
                  if (o instanceof String) {
                      String s = (String) o;
                      before += s.length();
                  } else if (o instanceof Wrap) {
                      Wrap w = (Wrap) o;
<span class="udiff-line-modified-removed">-                     if (sni &gt;= w.firstSnippetIndex() &amp;&amp; sni &lt;= w.lastSnippetIndex()) {</span>
<span class="udiff-line-modified-removed">-                         return w.snippetIndexToWrapIndex(sni) + before;</span>
<span class="udiff-line-modified-added">+                     if (sni &gt;= w.firstSnippetIndex() &amp;&amp; sni &lt; w.lastSnippetIndex()) {</span>
<span class="udiff-line-modified-added">+                         int wwi = w.snippetIndexToWrapIndex(sni);</span>
<span class="udiff-line-added">+                         debugWrap(&quot;\nCommoundWrap.snippetIndexToWrapIndex: SnippetIndex(%d) -&gt; WrapIndex(%d + %d = %d)&quot;</span>
<span class="udiff-line-added">+                                         + &quot;\n   === %s&quot;,</span>
<span class="udiff-line-added">+                                 sni, wwi, before, wwi + before, wrapped());</span>
<span class="udiff-line-added">+                         return wwi + before;</span>
                      }
                      before += w.wrapped().length();
                  }
              }
              return 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -298,12 +300,12 @@</span>
                      before += s.length();
                  } else if (o instanceof Wrap) {
                      w = (Wrap) o;
                      int len = w.wrapped().length();
                      if ((wi - before) &lt;= len) {
<span class="udiff-line-modified-removed">-                         //System.err.printf(&quot;Defer to wrap %s - wi: %d. before; %d   -- %s  &gt;&gt;&gt; %s\n&quot;,</span>
<span class="udiff-line-modified-removed">-                         //        w, wi, before, w.debugPos(wi - before), w.wrapped());</span>
<span class="udiff-line-modified-added">+                         debugWrap(&quot;CommoundWrap.wrapIndexToWrap: Defer to wrap %s - wi: %d. before; %d   &gt;&gt;&gt; %s\n&quot;,</span>
<span class="udiff-line-modified-added">+                                 w, wi, before, w.wrapped());</span>
                          return w;
                      }
                      before += len;
                  }
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -319,13 +321,14 @@</span>
                      before += s.length();
                  } else if (o instanceof Wrap) {
                      Wrap w = (Wrap) o;
                      int len = w.wrapped().length();
                      if ((wi - before) &lt;= len) {
<span class="udiff-line-modified-removed">-                         //System.err.printf(&quot;Defer to wrap %s - wi: %d. before; %d   -- %s  &gt;&gt;&gt; %s\n&quot;,</span>
<span class="udiff-line-modified-removed">-                         //        w, wi, before, w.debugPos(wi - before), w.wrapped());</span>
<span class="udiff-line-modified-removed">-                         return w.wrapIndexToSnippetIndex(wi - before);</span>
<span class="udiff-line-modified-added">+                         int si = w.wrapIndexToSnippetIndex(wi - before);</span>
<span class="udiff-line-modified-added">+                         debugWrap(&quot;\nCommoundWrap.wrapIndexToSnippetIndex: WrapIndex(%d) -&gt; SnippetIndex(%d)\n&quot;,</span>
<span class="udiff-line-modified-added">+                                 wi, si);</span>
<span class="udiff-line-added">+                         return si;</span>
                      }
                      before += len;
                  }
              }
              return lastSnippetIndex();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -367,11 +370,11 @@</span>
                      String s = (String) o;
                      before += countLines(s);
                  } else if (o instanceof Wrap) {
                      w = (Wrap) o;
                      int lns = countLines(w.wrapped());
<span class="udiff-line-modified-removed">-                     if ((wline - before) &lt; lns) {</span>
<span class="udiff-line-modified-added">+                     if ((wline - before) &lt;= lns) {</span>
                          return w;
                      }
                      before += lns;
                  }
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -386,11 +389,11 @@</span>
                      String s = (String) o;
                      before += countLines(s);
                  } else if (o instanceof Wrap) {
                      Wrap w = (Wrap) o;
                      int lns = countLines(w.wrapped());
<span class="udiff-line-modified-removed">-                     if ((wline - before) &lt; lns) {</span>
<span class="udiff-line-modified-added">+                     if ((wline - before) &lt;= lns) {</span>
                          return w.wrapLineToSnippetLine(wline - before);
                      }
                      before += lns;
                  }
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -407,20 +410,25 @@</span>
              return snlineLast;
          }
  
          @Override
          public String toString() {
<span class="udiff-line-modified-removed">-             return &quot;CompoundWrap(&quot; + Arrays.stream(os).map(Object::toString).collect(joining(&quot;,&quot;)) + &quot;)&quot;;</span>
<span class="udiff-line-modified-added">+             return &quot;CompoundWrap(&quot; + Arrays.stream(os)</span>
<span class="udiff-line-added">+                     .map(o -&gt; (o instanceof String)</span>
<span class="udiff-line-added">+                             ? &quot;\&quot;&quot; + o + &quot;\&quot;&quot;</span>
<span class="udiff-line-added">+                             : o.toString())</span>
<span class="udiff-line-added">+                     .collect(joining(&quot;,&quot;))</span>
<span class="udiff-line-added">+                     + &quot;)&quot;;</span>
          }
      }
  
<span class="udiff-line-modified-removed">-     private static class RangeWrap extends Wrap {</span>
<span class="udiff-line-modified-added">+     static class RangeWrap extends Wrap {</span>
  
          final Range range;
<span class="udiff-line-modified-removed">-         final String wrapped;</span>
<span class="udiff-line-modified-removed">-         final int firstSnline;</span>
<span class="udiff-line-modified-removed">-         final int lastSnline;</span>
<span class="udiff-line-modified-added">+         final String wrapped;   // The snippet portion of the source</span>
<span class="udiff-line-modified-added">+         final int firstSnline;  // Line count to start of snippet portion</span>
<span class="udiff-line-modified-added">+         final int lastSnline;   // Line count to end of snippet portion</span>
  
          RangeWrap(String snippetSource, Range usedWithinSnippet) {
              this.range = usedWithinSnippet;
              this.wrapped = usedWithinSnippet.part(snippetSource);
              usedWithinSnippet.verify(snippetSource);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -434,28 +442,43 @@</span>
          }
  
          @Override
          public int snippetIndexToWrapIndex(int sni) {
              if (sni &lt; range.begin) {
<span class="udiff-line-added">+                 debugWrap(&quot;\nRangeWrap.snippetIndexToWrapIndex: ERR before SnippetIndex(%d) -&gt; WrapIndex(%d + %d = %d)\n&quot;,</span>
<span class="udiff-line-added">+                         sni, 0);</span>
                  return 0;
              }
              if (sni &gt; range.end) {
<span class="udiff-line-added">+                 debugWrap(&quot;\nRangeWrap.snippetIndexToWrapIndex: ERR after SnippetIndex(%d) -&gt; WrapIndex(%d + %d = %d)\n&quot;,</span>
<span class="udiff-line-added">+                         sni, range.length());</span>
                  return range.length();
              }
<span class="udiff-line-modified-removed">-             return sni - range.begin;</span>
<span class="udiff-line-modified-added">+             int wi = sni - range.begin;</span>
<span class="udiff-line-added">+             debugWrap(&quot;\nRangeWrap.snippetIndexToWrapIndex: SnippetIndex(%d) -&gt; WrapIndex(%d + %d = %d)&quot;</span>
<span class="udiff-line-added">+                             + &quot;\n   === %s&quot;,</span>
<span class="udiff-line-added">+                     sni, sni, range.begin, sni - range.begin, wrapped());</span>
<span class="udiff-line-added">+             return wi;</span>
          }
  
          @Override
          public int wrapIndexToSnippetIndex(int wi) {
              if (wi &lt; 0) {
<span class="udiff-line-added">+                 debugWrap(&quot;\nRangeWrap.wrapIndexToSnippetIndex: ERR before WrapIndex(%d) -&gt; SnippetIndex(%d)\n&quot;,</span>
<span class="udiff-line-added">+                         wi, 0);</span>
                  return 0; // bad index
              }
              int max = range.length();
              if (wi &gt; max) {
<span class="udiff-line-modified-removed">-                 wi = max;</span>
<span class="udiff-line-modified-added">+                 debugWrap(&quot;\nRangeWrap.wrapIndexToSnippetIndex: ERR after WrapIndex(%d) -&gt; SnippetIndex(%d)\n&quot;,</span>
<span class="udiff-line-added">+                         wi, max + range.begin);</span>
<span class="udiff-line-added">+                 return max + range.begin;</span>
              }
<span class="udiff-line-modified-removed">-             return wi + range.begin;</span>
<span class="udiff-line-modified-added">+             int sni = wi + range.begin;</span>
<span class="udiff-line-added">+             debugWrap(&quot;\nRangeWrap.wrapIndexToSnippetIndex: WrapIndex(%d) -&gt; SnippetIndex(%d)\n&quot;,</span>
<span class="udiff-line-added">+                     wi, sni);</span>
<span class="udiff-line-added">+             return sni;</span>
          }
  
          @Override
          public int firstSnippetIndex() {
              return range.begin;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -533,6 +556,11 @@</span>
  
          VarDeclareWrap(Wrap wtype, String brackets, Wrap wname) {
              super(&quot;    public static &quot;, wtype, brackets + &quot; &quot;, wname, semi(wname));
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void debugWrap(String format, Object... args) {</span>
<span class="udiff-line-added">+         //System.err.printf(format, args);</span>
<span class="udiff-line-added">+         //state.debug(this, InternalDebugControl.DBG_WRAP, format, args);</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="VarSnippet.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../module-info.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>