<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jartool/share/classes/jdk/security/jarsigner/JarSigner.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../jdk.internal.vm.compiler/share/classes/org.graalvm.util.test/src/org/graalvm/util/test/CollectionSizeTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../module-info.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jartool/share/classes/jdk/security/jarsigner/JarSigner.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -669,41 +669,32 @@</span>
              // Should not happen. User provided alg were checked, and default
              // alg should always be available.
              throw new AssertionError(asae);
          }
  
<span class="udiff-line-modified-removed">-         PrintStream ps = new PrintStream(os);</span>
<span class="udiff-line-removed">-         ZipOutputStream zos = new ZipOutputStream(ps);</span>
<span class="udiff-line-modified-added">+         ZipOutputStream zos = new ZipOutputStream(os);</span>
  
          Manifest manifest = new Manifest();
<span class="udiff-line-removed">-         Map&lt;String, Attributes&gt; mfEntries = manifest.getEntries();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // The Attributes of manifest before updating</span>
<span class="udiff-line-removed">-         Attributes oldAttr = null;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         boolean mfModified = false;</span>
<span class="udiff-line-removed">-         boolean mfCreated = false;</span>
          byte[] mfRawBytes = null;
  
          // Check if manifest exists
<span class="udiff-line-modified-removed">-         ZipEntry mfFile;</span>
<span class="udiff-line-modified-removed">-         if ((mfFile = getManifestFile(zipFile)) != null) {</span>
<span class="udiff-line-modified-added">+         ZipEntry mfFile = getManifestFile(zipFile);</span>
<span class="udiff-line-modified-added">+         boolean mfCreated = mfFile == null;</span>
<span class="udiff-line-added">+         if (!mfCreated) {</span>
              // Manifest exists. Read its raw bytes.
              mfRawBytes = zipFile.getInputStream(mfFile).readAllBytes();
              manifest.read(new ByteArrayInputStream(mfRawBytes));
<span class="udiff-line-removed">-             oldAttr = (Attributes) (manifest.getMainAttributes().clone());</span>
          } else {
              // Create new manifest
              Attributes mattr = manifest.getMainAttributes();
              mattr.putValue(Attributes.Name.MANIFEST_VERSION.toString(),
                      &quot;1.0&quot;);
              String javaVendor = System.getProperty(&quot;java.vendor&quot;);
              String jdkVersion = System.getProperty(&quot;java.version&quot;);
              mattr.putValue(&quot;Created-By&quot;, jdkVersion + &quot; (&quot; + javaVendor
                      + &quot;)&quot;);
              mfFile = new ZipEntry(JarFile.MANIFEST_NAME);
<span class="udiff-line-removed">-             mfCreated = true;</span>
          }
  
          /*
           * For each entry in jar
           * (except for signature-related META-INF entries),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -726,12 +717,16 @@</span>
              if (ze.getName().startsWith(META_INF)) {
                  // Store META-INF files in vector, so they can be written
                  // out first
                  mfFiles.addElement(ze);
  
<span class="udiff-line-modified-removed">-                 if (SignatureFileVerifier.isBlockOrSF(</span>
<span class="udiff-line-modified-removed">-                         ze.getName().toUpperCase(Locale.ENGLISH))) {</span>
<span class="udiff-line-modified-added">+                 String zeNameUp = ze.getName().toUpperCase(Locale.ENGLISH);</span>
<span class="udiff-line-modified-added">+                 if (SignatureFileVerifier.isBlockOrSF(zeNameUp)</span>
<span class="udiff-line-added">+                     // no need to preserve binary manifest portions</span>
<span class="udiff-line-added">+                     // if the only existing signature will be replaced</span>
<span class="udiff-line-added">+                         &amp;&amp; !zeNameUp.startsWith(SignatureFile</span>
<span class="udiff-line-added">+                             .getBaseSignatureFilesName(signerName))) {</span>
                      wasSigned = true;
                  }
  
                  if (SignatureFileVerifier.isSigningRelated(ze.getName())) {
                      // ignore signature-related and manifest files
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -740,76 +735,89 @@</span>
              }
  
              if (manifest.getAttributes(ze.getName()) != null) {
                  // jar entry is contained in manifest, check and
                  // possibly update its digest attributes
<span class="udiff-line-modified-removed">-                 if (updateDigests(ze, zipFile, digests,</span>
<span class="udiff-line-removed">-                         manifest)) {</span>
<span class="udiff-line-removed">-                     mfModified = true;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-modified-added">+                 updateDigests(ze, zipFile, digests, manifest);</span>
              } else if (!ze.isDirectory()) {
                  // Add entry to manifest
                  Attributes attrs = getDigestAttributes(ze, zipFile, digests);
<span class="udiff-line-modified-removed">-                 mfEntries.put(ze.getName(), attrs);</span>
<span class="udiff-line-removed">-                 mfModified = true;</span>
<span class="udiff-line-modified-added">+                 manifest.getEntries().put(ze.getName(), attrs);</span>
              }
          }
  
<span class="udiff-line-modified-removed">-         // Recalculate the manifest raw bytes if necessary</span>
<span class="udiff-line-modified-removed">-         if (mfModified) {</span>
<span class="udiff-line-modified-removed">-             ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="udiff-line-modified-added">+         /*</span>
<span class="udiff-line-modified-added">+          * Note:</span>
<span class="udiff-line-modified-added">+          *</span>
<span class="udiff-line-added">+          * The Attributes object is based on HashMap and can handle</span>
<span class="udiff-line-added">+          * continuation lines. Therefore, even if the contents are not changed</span>
<span class="udiff-line-added">+          * (in a Map view), the bytes that it write() may be different from</span>
<span class="udiff-line-added">+          * the original bytes that it read() from. Since the signature is</span>
<span class="udiff-line-added">+          * based on raw bytes, we must retain the exact bytes.</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         boolean mfModified;</span>
<span class="udiff-line-added">+         ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="udiff-line-added">+         if (mfCreated || !wasSigned) {</span>
<span class="udiff-line-added">+             mfModified = true;</span>
              manifest.write(baos);
<span class="udiff-line-modified-removed">-             if (wasSigned) {</span>
<span class="udiff-line-modified-removed">-                 byte[] newBytes = baos.toByteArray();</span>
<span class="udiff-line-modified-removed">-                 if (mfRawBytes != null</span>
<span class="udiff-line-modified-removed">-                         &amp;&amp; oldAttr.equals(manifest.getMainAttributes())) {</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                     /*</span>
<span class="udiff-line-modified-removed">-                      * Note:</span>
<span class="udiff-line-modified-removed">-                      *</span>
<span class="udiff-line-modified-removed">-                      * The Attributes object is based on HashMap and can handle</span>
<span class="udiff-line-modified-removed">-                      * continuation columns. Therefore, even if the contents are</span>
<span class="udiff-line-modified-removed">-                      * not changed (in a Map view), the bytes that it write()</span>
<span class="udiff-line-modified-removed">-                      * may be different from the original bytes that it read()</span>
<span class="udiff-line-modified-removed">-                      * from. Since the signature on the main attributes is based</span>
<span class="udiff-line-modified-removed">-                      * on raw bytes, we must retain the exact bytes.</span>
<span class="udiff-line-modified-removed">-                      */</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                     int newPos = findHeaderEnd(newBytes);</span>
<span class="udiff-line-modified-removed">-                     int oldPos = findHeaderEnd(mfRawBytes);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                     if (newPos == oldPos) {</span>
<span class="udiff-line-modified-removed">-                         System.arraycopy(mfRawBytes, 0, newBytes, 0, oldPos);</span>
<span class="udiff-line-modified-added">+             mfRawBytes = baos.toByteArray();</span>
<span class="udiff-line-modified-added">+         } else {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             // the manifest before updating</span>
<span class="udiff-line-modified-added">+             Manifest oldManifest = new Manifest(</span>
<span class="udiff-line-modified-added">+                     new ByteArrayInputStream(mfRawBytes));</span>
<span class="udiff-line-modified-added">+             mfModified = !oldManifest.equals(manifest);</span>
<span class="udiff-line-modified-added">+             if (!mfModified) {</span>
<span class="udiff-line-modified-added">+                 // leave whole manifest (mfRawBytes) unmodified</span>
<span class="udiff-line-modified-added">+             } else {</span>
<span class="udiff-line-modified-added">+                 // reproduce the manifest raw bytes for unmodified sections</span>
<span class="udiff-line-modified-added">+                 manifest.write(baos);</span>
<span class="udiff-line-modified-added">+                 byte[] mfNewRawBytes = baos.toByteArray();</span>
<span class="udiff-line-modified-added">+                 baos.reset();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+                 ManifestDigester oldMd = new ManifestDigester(mfRawBytes);</span>
<span class="udiff-line-modified-added">+                 ManifestDigester newMd = new ManifestDigester(mfNewRawBytes);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+                 // main attributes</span>
<span class="udiff-line-modified-added">+                 if (manifest.getMainAttributes().equals(</span>
<span class="udiff-line-modified-added">+                         oldManifest.getMainAttributes())</span>
<span class="udiff-line-added">+                         &amp;&amp; (manifest.getEntries().isEmpty() ||</span>
<span class="udiff-line-added">+                             oldMd.getMainAttsEntry().isProperlyDelimited())) {</span>
<span class="udiff-line-added">+                     oldMd.getMainAttsEntry().reproduceRaw(baos);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     newMd.getMainAttsEntry().reproduceRaw(baos);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 // individual sections</span>
<span class="udiff-line-added">+                 for (Map.Entry&lt;String,Attributes&gt; entry :</span>
<span class="udiff-line-added">+                         manifest.getEntries().entrySet()) {</span>
<span class="udiff-line-added">+                     String sectionName = entry.getKey();</span>
<span class="udiff-line-added">+                     Attributes entryAtts = entry.getValue();</span>
<span class="udiff-line-added">+                     if (entryAtts.equals(oldManifest.getAttributes(sectionName))</span>
<span class="udiff-line-added">+                             &amp;&amp; oldMd.get(sectionName).isProperlyDelimited()) {</span>
<span class="udiff-line-added">+                         oldMd.get(sectionName).reproduceRaw(baos);</span>
                      } else {
<span class="udiff-line-modified-removed">-                         // cat oldHead newTail &gt; newBytes</span>
<span class="udiff-line-removed">-                         byte[] lastBytes = new byte[oldPos +</span>
<span class="udiff-line-removed">-                                 newBytes.length - newPos];</span>
<span class="udiff-line-removed">-                         System.arraycopy(mfRawBytes, 0, lastBytes, 0, oldPos);</span>
<span class="udiff-line-removed">-                         System.arraycopy(newBytes, newPos, lastBytes, oldPos,</span>
<span class="udiff-line-removed">-                                 newBytes.length - newPos);</span>
<span class="udiff-line-removed">-                         newBytes = lastBytes;</span>
<span class="udiff-line-modified-added">+                         newMd.get(sectionName).reproduceRaw(baos);</span>
                      }
                  }
<span class="udiff-line-modified-removed">-                 mfRawBytes = newBytes;</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-modified-added">+ </span>
                  mfRawBytes = baos.toByteArray();
              }
          }
  
          // Write out the manifest
          if (mfModified) {
              // manifest file has new length
              mfFile = new ZipEntry(JarFile.MANIFEST_NAME);
          }
          if (handler != null) {
<span class="udiff-line-modified-removed">-             if (mfCreated) {</span>
<span class="udiff-line-modified-added">+             if (mfCreated || !mfModified) {</span>
                  handler.accept(&quot;adding&quot;, mfFile.getName());
<span class="udiff-line-modified-removed">-             } else if (mfModified) {</span>
<span class="udiff-line-modified-added">+             } else {</span>
                  handler.accept(&quot;updating&quot;, mfFile.getName());
              }
          }
<span class="udiff-line-removed">- </span>
          zos.putNextEntry(mfFile);
          zos.write(mfRawBytes);
  
          // Calculate SignatureFile (&quot;.SF&quot;) and SignatureBlockFile
          ManifestDigester manDig = new ManifestDigester(mfRawBytes);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -824,13 +832,12 @@</span>
          } else {
              signer = Signature.getInstance(sigalg, sigProvider);
          }
          signer.initSign(privateKey);
  
<span class="udiff-line-modified-removed">-         ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="udiff-line-modified-added">+         baos.reset();</span>
          sf.write(baos);
<span class="udiff-line-removed">- </span>
          byte[] content = baos.toByteArray();
  
          signer.update(content);
          byte[] signature = signer.sign();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -887,10 +894,18 @@</span>
          for (int i = 0; i &lt; mfFiles.size(); i++) {
              ZipEntry ze = mfFiles.elementAt(i);
              if (!ze.getName().equalsIgnoreCase(JarFile.MANIFEST_NAME)
                      &amp;&amp; !ze.getName().equalsIgnoreCase(sfFilename)
                      &amp;&amp; !ze.getName().equalsIgnoreCase(bkFilename)) {
<span class="udiff-line-added">+                 if (ze.getName().startsWith(SignatureFile</span>
<span class="udiff-line-added">+                         .getBaseSignatureFilesName(signerName))</span>
<span class="udiff-line-added">+                         &amp;&amp; SignatureFileVerifier.isBlockOrSF(ze.getName())) {</span>
<span class="udiff-line-added">+                     if (handler != null) {</span>
<span class="udiff-line-added">+                         handler.accept(&quot;updating&quot;, ze.getName());</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+                 }</span>
                  if (handler != null) {
                      if (manifest.getAttributes(ze.getName()) != null) {
                          handler.accept(&quot;signing&quot;, ze.getName());
                      } else if (!ze.isDirectory()) {
                          handler.accept(&quot;adding&quot;, ze.getName());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -940,15 +955,13 @@</span>
          try (InputStream is = zf.getInputStream(ze)) {
              is.transferTo(os);
          }
      }
  
<span class="udiff-line-modified-removed">-     private boolean updateDigests(ZipEntry ze, ZipFile zf,</span>
<span class="udiff-line-modified-added">+     private void updateDigests(ZipEntry ze, ZipFile zf,</span>
                                    MessageDigest[] digests,
                                    Manifest mf) throws IOException {
<span class="udiff-line-removed">-         boolean update = false;</span>
<span class="udiff-line-removed">- </span>
          Attributes attrs = mf.getAttributes(ze.getName());
          String[] base64Digests = getDigests(ze, zf, digests);
  
          for (int i = 0; i &lt; digests.length; i++) {
              // The entry name to be written into attrs
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -974,23 +987,13 @@</span>
                  // Ignored. Writing new digest entry.
              }
  
              if (name == null) {
                  name = digests[i].getAlgorithm() + &quot;-Digest&quot;;
<span class="udiff-line-removed">-                 attrs.putValue(name, base64Digests[i]);</span>
<span class="udiff-line-removed">-                 update = true;</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 // compare digests, and replace the one in the manifest</span>
<span class="udiff-line-removed">-                 // if they are different</span>
<span class="udiff-line-removed">-                 String mfDigest = attrs.getValue(name);</span>
<span class="udiff-line-removed">-                 if (!mfDigest.equalsIgnoreCase(base64Digests[i])) {</span>
<span class="udiff-line-removed">-                     attrs.putValue(name, base64Digests[i]);</span>
<span class="udiff-line-removed">-                     update = true;</span>
<span class="udiff-line-removed">-                 }</span>
              }
<span class="udiff-line-added">+             attrs.putValue(name, base64Digests[i]);</span>
          }
<span class="udiff-line-removed">-         return update;</span>
      }
  
      private Attributes getDigestAttributes(
              ZipEntry ze, ZipFile zf, MessageDigest[] digests)
              throws IOException {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1049,34 +1052,10 @@</span>
                      .encodeToString(digests[i].digest());
          }
          return base64Digests;
      }
  
<span class="udiff-line-removed">-     @SuppressWarnings(&quot;fallthrough&quot;)</span>
<span class="udiff-line-removed">-     private int findHeaderEnd(byte[] bs) {</span>
<span class="udiff-line-removed">-         // Initial state true to deal with empty header</span>
<span class="udiff-line-removed">-         boolean newline = true;     // just met a newline</span>
<span class="udiff-line-removed">-         int len = bs.length;</span>
<span class="udiff-line-removed">-         for (int i = 0; i &lt; len; i++) {</span>
<span class="udiff-line-removed">-             switch (bs[i]) {</span>
<span class="udiff-line-removed">-                 case &#39;\r&#39;:</span>
<span class="udiff-line-removed">-                     if (i &lt; len - 1 &amp;&amp; bs[i + 1] == &#39;\n&#39;) i++;</span>
<span class="udiff-line-removed">-                     // fallthrough</span>
<span class="udiff-line-removed">-                 case &#39;\n&#39;:</span>
<span class="udiff-line-removed">-                     if (newline) return i + 1;    //+1 to get length</span>
<span class="udiff-line-removed">-                     newline = true;</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 default:</span>
<span class="udiff-line-removed">-                     newline = false;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         // If header end is not found, it means the MANIFEST.MF has only</span>
<span class="udiff-line-removed">-         // the main attributes section and it does not end with 2 newlines.</span>
<span class="udiff-line-removed">-         // Returns the whole length so that it can be completely replaced.</span>
<span class="udiff-line-removed">-         return len;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      /*
       * Try to load the specified signing mechanism.
       * The URL class loader is used.
       */
      @SuppressWarnings(&quot;deprecation&quot;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1143,18 +1122,16 @@</span>
                                      md.manifestDigest(digest)));
                  }
              }
  
              // create digest of the manifest main attributes
<span class="udiff-line-modified-removed">-             ManifestDigester.Entry mde =</span>
<span class="udiff-line-removed">-                     md.get(ManifestDigester.MF_MAIN_ATTRS, false);</span>
<span class="udiff-line-modified-added">+             ManifestDigester.Entry mde = md.getMainAttsEntry(false);</span>
              if (mde != null) {
<span class="udiff-line-modified-removed">-                 for (MessageDigest digest: digests) {</span>
<span class="udiff-line-modified-removed">-                     mattr.putValue(digest.getAlgorithm() +</span>
<span class="udiff-line-modified-removed">-                                     &quot;-Digest-&quot; + ManifestDigester.MF_MAIN_ATTRS,</span>
<span class="udiff-line-modified-removed">-                             Base64.getEncoder().encodeToString(</span>
<span class="udiff-line-removed">-                                     mde.digest(digest)));</span>
<span class="udiff-line-modified-added">+                 for (MessageDigest digest : digests) {</span>
<span class="udiff-line-modified-added">+                     mattr.putValue(digest.getAlgorithm() + &quot;-Digest-&quot; +</span>
<span class="udiff-line-modified-added">+                             ManifestDigester.MF_MAIN_ATTRS,</span>
<span class="udiff-line-modified-added">+                             Base64.getEncoder().encodeToString(mde.digest(digest)));</span>
                  }
              } else {
                  throw new IllegalStateException
                          (&quot;ManifestDigester failed to create &quot; +
                                  &quot;Manifest-Main-Attribute entry&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1179,19 +1156,23 @@</span>
          // Write .SF file
          public void write(OutputStream out) throws IOException {
              sf.write(out);
          }
  
<span class="udiff-line-added">+         private static String getBaseSignatureFilesName(String baseName) {</span>
<span class="udiff-line-added">+             return &quot;META-INF/&quot; + baseName + &quot;.&quot;;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          // get .SF file name
          public String getMetaName() {
<span class="udiff-line-modified-removed">-             return &quot;META-INF/&quot; + baseName + &quot;.SF&quot;;</span>
<span class="udiff-line-modified-added">+             return getBaseSignatureFilesName(baseName) + &quot;SF&quot;;</span>
          }
  
          // get .DSA (or .DSA, .EC) file name
          public String getBlockName(PrivateKey privateKey) {
              String keyAlgorithm = privateKey.getAlgorithm();
<span class="udiff-line-modified-removed">-             return &quot;META-INF/&quot; + baseName + &quot;.&quot; + keyAlgorithm;</span>
<span class="udiff-line-modified-added">+             return getBaseSignatureFilesName(baseName) + keyAlgorithm;</span>
          }
  
          // Generates the PKCS#7 content of block file
          @SuppressWarnings(&quot;deprecation&quot;)
          public byte[] generateBlock(ContentSignerParameters params,
</pre>
<center><a href="../../../../../../jdk.internal.vm.compiler/share/classes/org.graalvm.util.test/src/org/graalvm/util/test/CollectionSizeTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../module-info.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>