<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.jartool/share/classes/sun/tools/jar/GNUStyleOptions.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.tools.jar;
 27 
 28 import java.io.File;
 29 import java.io.PrintWriter;
 30 import java.lang.module.ModuleDescriptor.Version;
 31 import java.nio.file.Path;
 32 import java.nio.file.Paths;
 33 import java.util.regex.Pattern;
 34 import java.util.regex.PatternSyntaxException;
 35 import jdk.internal.module.ModulePath;
 36 import jdk.internal.module.ModuleResolution;
 37 
 38 /**
 39  * Parser for GNU Style Options.
 40  */
 41 class GNUStyleOptions {
 42 
 43     static class BadArgs extends Exception {
 44         static final long serialVersionUID = 0L;
 45 
 46         boolean showUsage;
 47 
 48         BadArgs(String key, String arg) { super(Main.formatMsg(key, arg)); }
 49         BadArgs(String key) { super(Main.getMsg(key)); }
 50 
 51         BadArgs showUsage(boolean b) {
 52             showUsage = b;
 53             return this;
 54         }
 55     }
 56 
 57     static Option[] recognizedOptions = {
 58             // Main operations
 59             new Option(false, OptionType.MAIN_OPERATION, &quot;--create&quot;, &quot;-c&quot;) {
 60                 void process(Main tool, String opt, String arg) throws BadArgs {
 61                     if (tool.iflag || tool.tflag || tool.uflag || tool.xflag || tool.dflag)
 62                         throw new BadArgs(&quot;error.multiple.main.operations&quot;).showUsage(true);
 63                     tool.cflag = true;
 64                 }
 65             },
 66             new Option(true, OptionType.MAIN_OPERATION, &quot;--generate-index&quot;, &quot;-i&quot;) {
 67                 void process(Main tool, String opt, String arg) throws BadArgs {
 68                     if (tool.cflag || tool.tflag || tool.uflag || tool.xflag || tool.dflag)
 69                         throw new BadArgs(&quot;error.multiple.main.operations&quot;).showUsage(true);
 70                     tool.iflag = true;
 71                     tool.rootjar = arg;
 72                 }
 73             },
 74             new Option(false, OptionType.MAIN_OPERATION, &quot;--list&quot;, &quot;-t&quot;) {
 75                 void process(Main tool, String opt, String arg) throws BadArgs {
 76                     if (tool.cflag || tool.iflag || tool.uflag || tool.xflag || tool.dflag)
 77                         throw new BadArgs(&quot;error.multiple.main.operations&quot;).showUsage(true);
 78                     tool.tflag = true;
 79                 }
 80             },
 81             new Option(false, OptionType.MAIN_OPERATION, &quot;--update&quot;, &quot;-u&quot;) {
 82                 void process(Main tool, String opt, String arg) throws BadArgs {
 83                     if (tool.cflag || tool.iflag || tool.tflag || tool.xflag || tool.dflag)
 84                         throw new BadArgs(&quot;error.multiple.main.operations&quot;).showUsage(true);
 85                     tool.uflag = true;
 86                 }
 87             },
 88             new Option(false, OptionType.MAIN_OPERATION, &quot;--extract&quot;, &quot;-x&quot;) {
 89                 void process(Main tool, String opt, String arg) throws BadArgs {
 90                     if (tool.cflag || tool.iflag  || tool.tflag || tool.uflag || tool.dflag)
 91                         throw new BadArgs(&quot;error.multiple.main.operations&quot;).showUsage(true);
 92                     tool.xflag = true;
 93                 }
 94             },
 95             new Option(false, OptionType.MAIN_OPERATION, &quot;--describe-module&quot;, &quot;-d&quot;) {
 96                 void process(Main tool, String opt, String arg) throws BadArgs {
 97                     if (tool.cflag || tool.iflag  || tool.tflag || tool.uflag || tool.xflag)
 98                         throw new BadArgs(&quot;error.multiple.main.operations&quot;).showUsage(true);
 99                     tool.dflag = true;
100                 }
101             },
102 
103             // Additional options
104             new Option(true, OptionType.ANY, &quot;--file&quot;, &quot;-f&quot;) {
105                 void process(Main jartool, String opt, String arg) {
106                     jartool.fname = arg;
107                 }
108             },
109             new Option(false, OptionType.ANY, &quot;--verbose&quot;, &quot;-v&quot;) {
110                 void process(Main jartool, String opt, String arg) {
111                     jartool.vflag = true;
112                 }
113             },
<a name="1" id="anc1"></a><span class="line-removed">114             new Option(false, OptionType.CREATE, &quot;--normalize&quot;, &quot;-n&quot;) {</span>
<span class="line-removed">115                 void process(Main jartool, String opt, String arg) {</span>
<span class="line-removed">116                     jartool.nflag = true;</span>
<span class="line-removed">117                 }</span>
<span class="line-removed">118                 boolean isExtra() { return true; }</span>
<span class="line-removed">119             },</span>
120             new Option(true, OptionType.CREATE_UPDATE, &quot;--main-class&quot;, &quot;-e&quot;) {
121                 void process(Main jartool, String opt, String arg) {
122                     jartool.ename = arg;
123                 }
124             },
125             new Option(true, OptionType.CREATE_UPDATE, &quot;--manifest&quot;, &quot;-m&quot;) {
126                 void process(Main jartool, String opt, String arg) {
127                     jartool.mname = arg;
128                 }
129             },
130             new Option(false, OptionType.CREATE_UPDATE, &quot;--no-manifest&quot;, &quot;-M&quot;) {
131                 void process(Main jartool, String opt, String arg) {
132                     jartool.Mflag = true;
133                 }
134             },
135             new Option(true, OptionType.CREATE_UPDATE, &quot;--module-version&quot;) {
136                 void process(Main jartool, String opt, String arg) {
137                     jartool.moduleVersion = Version.parse(arg);
138                 }
139             },
140             new Option(true, OptionType.CREATE_UPDATE, &quot;--hash-modules&quot;) {
141                 void process(Main jartool, String opt, String arg) throws BadArgs {
142                     try {
143                         jartool.modulesToHash = Pattern.compile(arg);
144                     } catch (PatternSyntaxException e) {
145                         throw new BadArgs(&quot;err.badpattern&quot;, arg).showUsage(true);
146                     }
147                 }
148             },
149             new Option(true, OptionType.CREATE_UPDATE, &quot;--module-path&quot;, &quot;-p&quot;) {
150                 void process(Main jartool, String opt, String arg) {
151                     String[] dirs = arg.split(File.pathSeparator);
152                     Path[] paths = new Path[dirs.length];
153                     int i = 0;
154                     for (String dir : dirs) {
155                         paths[i++] = Paths.get(dir);
156                     }
157                     jartool.moduleFinder = ModulePath.of(Runtime.version(), true, paths);
158                 }
159             },
160             new Option(false, OptionType.CREATE_UPDATE, &quot;--do-not-resolve-by-default&quot;) {
161                 void process(Main jartool, String opt, String arg) {
162                     ModuleResolution mres = jartool.moduleResolution;
163                     jartool.moduleResolution = mres.withDoNotResolveByDefault();
164                 }
165                 boolean isExtra() { return true; }
166             },
167             new Option(true, OptionType.CREATE_UPDATE, &quot;--warn-if-resolved&quot;) {
168                 void process(Main jartool, String opt, String arg) throws BadArgs {
169                     ModuleResolution mres = ModuleResolution.empty();
170                     if (jartool.moduleResolution.doNotResolveByDefault()) {
171                         mres.withDoNotResolveByDefault();
172                     }
173                     if (arg.equals(&quot;deprecated&quot;)) {
174                         jartool.moduleResolution = mres.withDeprecated();
175                     } else if (arg.equals(&quot;deprecated-for-removal&quot;)) {
176                         jartool.moduleResolution = mres.withDeprecatedForRemoval();
177                     } else if (arg.equals(&quot;incubating&quot;)) {
178                         jartool.moduleResolution = mres.withIncubating();
179                     } else {
180                         throw new BadArgs(&quot;error.bad.reason&quot;, arg);
181                     }
182                 }
183                 boolean isExtra() { return true; }
184             },
185             new Option(false, OptionType.CREATE_UPDATE_INDEX, &quot;--no-compress&quot;, &quot;-0&quot;) {
186                 void process(Main jartool, String opt, String arg) {
187                     jartool.flag0 = true;
188                 }
189             },
190 
191             // Hidden options
192             new Option(false, OptionType.OTHER, &quot;-P&quot;) {
193                 void process(Main jartool, String opt, String arg) {
194                     jartool.pflag = true;
195                 }
196                 boolean isHidden() { return true; }
197             },
198 
199             // Other options
200             new Option(true, true, OptionType.OTHER, &quot;--help&quot;, &quot;-h&quot;, &quot;-?&quot;) {
201                 void process(Main jartool, String opt, String arg) throws BadArgs {
202                     if (jartool.info == null) {
203                         if (arg == null) {
204                             jartool.info = GNUStyleOptions::printHelp;  //  Main.Info.HELP;
205                             return;
206                         }
207                         if (!arg.equals(&quot;compat&quot;))
208                             throw new BadArgs(&quot;error.illegal.option&quot;, arg).showUsage(true);
209                         // jartool.info = Main.Info.COMPAT_HELP;
210                         jartool.info = GNUStyleOptions::printCompatHelp;
211                     }
212                 }
213             },
214             new Option(false, OptionType.OTHER, &quot;--help-extra&quot;) {
215                 void process(Main jartool, String opt, String arg) throws BadArgs {
216                     jartool.info = GNUStyleOptions::printHelpExtra;
217                 }
218             },
219             new Option(false, OptionType.OTHER, &quot;--version&quot;) {
220                 void process(Main jartool, String opt, String arg) {
221                     if (jartool.info == null)
222                         jartool.info = GNUStyleOptions::printVersion;
223                 }
224             }
225     };
226 
227     enum OptionType {
228         MAIN_OPERATION(&quot;main&quot;),
229         ANY(&quot;any&quot;),
230         CREATE(&quot;create&quot;),
231         CREATE_UPDATE(&quot;create.update&quot;),
232         CREATE_UPDATE_INDEX(&quot;create.update.index&quot;),
233         OTHER(&quot;other&quot;);
234 
235         /** Resource lookup section prefix. */
236         final String name;
237 
238         OptionType(String name) { this.name = name; }
239     }
240 
241     static abstract class Option {
242         final boolean hasArg;
243         final boolean argIsOptional;
244         final String[] aliases;
245         final OptionType type;
246 
247         Option(boolean hasArg, OptionType type, String... aliases) {
248             this(hasArg, false, type, aliases);
249         }
250 
251         Option(boolean hasArg, boolean argIsOptional, OptionType type, String... aliases) {
252             this.hasArg = hasArg;
253             this.argIsOptional = argIsOptional;
254             this.type = type;
255             this.aliases = aliases;
256         }
257 
258         boolean isHidden() { return false; }
259 
260         boolean isExtra() { return false; }
261 
262         boolean matches(String opt) {
263             for (String a : aliases) {
264                 if (a.equals(opt)) {
265                     return true;
266                 } else if (opt.startsWith(&quot;--&quot;) &amp;&amp; hasArg &amp;&amp; opt.startsWith(a + &quot;=&quot;)) {
267                     return true;
268                 } else if (opt.startsWith(&quot;--help&quot;) &amp;&amp; opt.startsWith(a + &quot;:&quot;)) {
269                     return true;
270                 }
271             }
272             return false;
273         }
274 
275         abstract void process(Main jartool, String opt, String arg) throws BadArgs;
276     }
277 
278     static int parseOptions(Main jartool, String[] args) throws BadArgs {
279         int count = 0;
280         if (args.length == 0) {
281             jartool.info = GNUStyleOptions::printUsageTryHelp;  //  never be here
282             return 0;
283         }
284 
285         // process options
286         for (; count &lt; args.length; count++) {
287             if (args[count].charAt(0) != &#39;-&#39; || args[count].equals(&quot;-C&quot;) ||
288                 args[count].equals(&quot;--release&quot;))
289                 break;
290 
291             String name = args[count];
292             if (name.equals(&quot;-XDsuppress-tool-removal-message&quot;)) {
293                 jartool.suppressDeprecateMsg = true;
294                 continue;
295             }
296             Option option = getOption(name);
297             String param = null;
298             if (option.hasArg) {
299                 if (name.startsWith(&quot;--help&quot;)) {  // &quot;special&quot; optional separator
300                     if (name.indexOf(&#39;:&#39;) &gt; 0) {
301                         param = name.substring(name.indexOf(&#39;:&#39;) + 1, name.length());
302                     }
303                 } else if (name.startsWith(&quot;--&quot;) &amp;&amp; name.indexOf(&#39;=&#39;) &gt; 0) {
304                     param = name.substring(name.indexOf(&#39;=&#39;) + 1, name.length());
305                 } else if (count + 1 &lt; args.length) {
306                     param = args[++count];
307                 }
308                 if (!option.argIsOptional &amp;&amp;
309                     (param == null || param.isEmpty() || param.charAt(0) == &#39;-&#39;)) {
310                     throw new BadArgs(&quot;error.missing.arg&quot;, name).showUsage(true);
311                 }
312             }
313             option.process(jartool, name, param);
314         }
315 
316         return count;
317     }
318 
319     private static Option getOption(String name) throws BadArgs {
320         for (Option o : recognizedOptions) {
321             if (o.matches(name)) {
322                 return o;
323             }
324         }
325         throw new BadArgs(&quot;error.unrecognized.option&quot;, name).showUsage(true);
326     }
327 
328     static void printHelpExtra(PrintWriter out) {
329         printHelp0(out, true);
330     }
331 
332     static void printHelp(PrintWriter out) {
333         printHelp0(out, false);
334     }
335 
336     private static void printHelp0(PrintWriter out, boolean printExtra) {
337         out.format(&quot;%s%n&quot;, Main.getMsg(&quot;main.help.preopt&quot;));
338         for (OptionType type : OptionType.values()) {
339             boolean typeHeadingWritten = false;
340 
341             for (Option o : recognizedOptions) {
342                 if (!o.type.equals(type))
343                     continue;
344                 String name = o.aliases[0].substring(1); // there must always be at least one name
345                 name = name.charAt(0) == &#39;-&#39; ? name.substring(1) : name;
346                 if (o.isHidden() || name.equals(&quot;h&quot;)) {
347                     continue;
348                 }
349                 if (o.isExtra() &amp;&amp; !printExtra) {
350                     continue;
351                 }
352                 if (!typeHeadingWritten) {
353                     out.format(&quot;%n%s%n&quot;, Main.getMsg(&quot;main.help.opt.&quot; + type.name));
354                     typeHeadingWritten = true;
355                 }
356                 out.format(&quot;%s%n&quot;, Main.getMsg(&quot;main.help.opt.&quot; + type.name + &quot;.&quot; + name));
357             }
358         }
359         out.format(&quot;%n%s%n%n&quot;, Main.getMsg(&quot;main.help.postopt&quot;));
360     }
361 
362     static void printCompatHelp(PrintWriter out) {
363         out.format(&quot;%s%n&quot;, Main.getMsg(&quot;usage.compat&quot;));
364     }
365 
366     static void printUsageTryHelp(PrintWriter out) {
367         out.format(&quot;%s%n&quot;, Main.getMsg(&quot;main.usage.summary.try&quot;));
368     }
369 
370     static void printVersion(PrintWriter out) {
371         out.format(&quot;%s %s%n&quot;, &quot;jar&quot;, System.getProperty(&quot;java.version&quot;));
372     }
373 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>