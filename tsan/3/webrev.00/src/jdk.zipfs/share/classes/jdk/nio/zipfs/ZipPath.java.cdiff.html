<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.zipfs/share/classes/jdk/nio/zipfs/ZipPath.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ZipInfo.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ZipUtils.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.zipfs/share/classes/jdk/nio/zipfs/ZipPath.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 32,13 ***</span>
  import java.net.URI;
  import java.nio.channels.FileChannel;
  import java.nio.channels.SeekableByteChannel;
  import java.nio.file.*;
  import java.nio.file.DirectoryStream.Filter;
<span class="line-modified">! import java.nio.file.attribute.BasicFileAttributeView;</span>
<span class="line-removed">- import java.nio.file.attribute.FileAttribute;</span>
<span class="line-removed">- import java.nio.file.attribute.FileTime;</span>
  import java.util.Arrays;
  import java.util.Iterator;
  import java.util.Map;
  import java.util.NoSuchElementException;
  import java.util.Objects;
<span class="line-new-header">--- 32,11 ---</span>
  import java.net.URI;
  import java.nio.channels.FileChannel;
  import java.nio.channels.SeekableByteChannel;
  import java.nio.file.*;
  import java.nio.file.DirectoryStream.Filter;
<span class="line-modified">! import java.nio.file.attribute.*;</span>
  import java.util.Arrays;
  import java.util.Iterator;
  import java.util.Map;
  import java.util.NoSuchElementException;
  import java.util.Objects;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 209,17 ***</span>
          }
      }
  
      private boolean equalsNameAt(ZipPath other, int index) {
          int mbegin = offsets[index];
<span class="line-modified">!         int mlen = 0;</span>
          if (index == (offsets.length-1))
              mlen = path.length - mbegin;
          else
              mlen = offsets[index + 1] - mbegin - 1;
          int obegin = other.offsets[index];
<span class="line-modified">!         int olen = 0;</span>
          if (index == (other.offsets.length - 1))
              olen = other.path.length - obegin;
          else
              olen = other.offsets[index + 1] - obegin - 1;
          if (mlen != olen)
<span class="line-new-header">--- 207,17 ---</span>
          }
      }
  
      private boolean equalsNameAt(ZipPath other, int index) {
          int mbegin = offsets[index];
<span class="line-modified">!         int mlen;</span>
          if (index == (offsets.length-1))
              mlen = path.length - mbegin;
          else
              mlen = offsets[index + 1] - mbegin - 1;
          int obegin = other.offsets[index];
<span class="line-modified">!         int olen;</span>
          if (index == (other.offsets.length - 1))
              olen = other.path.length - obegin;
          else
              olen = other.offsets[index + 1] - obegin - 1;
          if (mlen != olen)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 296,11 ***</span>
          return resolve(o.path);
      }
  
      // opath is normalized, just concat
      private ZipPath resolve(byte[] opath) {
<span class="line-modified">!         byte[] resolved = null;</span>
          byte[] tpath = this.path;
          int tlen = tpath.length;
          int olen = opath.length;
          if (path[tlen - 1] == &#39;/&#39;) {
              resolved = new byte[tlen + olen];
<span class="line-new-header">--- 294,11 ---</span>
          return resolve(o.path);
      }
  
      // opath is normalized, just concat
      private ZipPath resolve(byte[] opath) {
<span class="line-modified">!         byte[] resolved;</span>
          byte[] tpath = this.path;
          int tlen = tpath.length;
          int olen = opath.length;
          if (path[tlen - 1] == &#39;/&#39;) {
              resolved = new byte[tlen + olen];
</pre>
<hr />
<pre>
<span class="line-old-header">*** 624,30 ***</span>
          return h;
      }
  
      @Override
      public boolean equals(Object obj) {
<span class="line-modified">!         return obj != null &amp;&amp;</span>
<span class="line-modified">!                obj instanceof ZipPath &amp;&amp;</span>
<span class="line-removed">-                this.zfs == ((ZipPath)obj).zfs &amp;&amp;</span>
                 compareTo((Path) obj) == 0;
      }
  
      @Override
      public int compareTo(Path other) {
          final ZipPath o = checkPath(other);
          int len1 = this.path.length;
          int len2 = o.path.length;
  
          int n = Math.min(len1, len2);
<span class="line-removed">-         byte v1[] = this.path;</span>
<span class="line-removed">-         byte v2[] = o.path;</span>
  
          int k = 0;
          while (k &lt; n) {
<span class="line-modified">!             int c1 = v1[k] &amp; 0xff;</span>
<span class="line-modified">!             int c2 = v2[k] &amp; 0xff;</span>
              if (c1 != c2)
                  return c1 - c2;
              k++;
          }
          return len1 - len2;
<span class="line-new-header">--- 622,27 ---</span>
          return h;
      }
  
      @Override
      public boolean equals(Object obj) {
<span class="line-modified">!         return obj instanceof ZipPath &amp;&amp;</span>
<span class="line-modified">!                this.zfs == ((ZipPath) obj).zfs &amp;&amp;</span>
                 compareTo((Path) obj) == 0;
      }
  
      @Override
      public int compareTo(Path other) {
          final ZipPath o = checkPath(other);
          int len1 = this.path.length;
          int len2 = o.path.length;
  
          int n = Math.min(len1, len2);
  
          int k = 0;
          while (k &lt; n) {
<span class="line-modified">!             int c1 = this.path[k] &amp; 0xff;</span>
<span class="line-modified">!             int c2 = o.path[k] &amp; 0xff;</span>
              if (c1 != c2)
                  return c1 - c2;
              k++;
          }
          return len1 - len2;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 674,11 ***</span>
          throw new UnsupportedOperationException();
      }
  
      @Override
      public Iterator&lt;Path&gt; iterator() {
<span class="line-modified">!         return new Iterator&lt;Path&gt;() {</span>
              private int i = 0;
  
              @Override
              public boolean hasNext() {
                  return (i &lt; getNameCount());
<span class="line-new-header">--- 669,11 ---</span>
          throw new UnsupportedOperationException();
      }
  
      @Override
      public Iterator&lt;Path&gt; iterator() {
<span class="line-modified">!         return new Iterator&lt;&gt;() {</span>
              private int i = 0;
  
              @Override
              public boolean hasNext() {
                  return (i &lt; getNameCount());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 702,10 ***</span>
<span class="line-new-header">--- 697,43 ---</span>
          };
      }
  
      /////////////////////////////////////////////////////////////////////
  
<span class="line-added">+     @SuppressWarnings(&quot;unchecked&quot;) // Cast to V</span>
<span class="line-added">+     &lt;V extends FileAttributeView&gt; V getFileAttributeView(Class&lt;V&gt; type) {</span>
<span class="line-added">+         if (type == null)</span>
<span class="line-added">+             throw new NullPointerException();</span>
<span class="line-added">+         if (type == BasicFileAttributeView.class)</span>
<span class="line-added">+             return (V)new ZipFileAttributeView(this, false);</span>
<span class="line-added">+         if (type == ZipFileAttributeView.class)</span>
<span class="line-added">+             return (V)new ZipFileAttributeView(this, true);</span>
<span class="line-added">+         if (zfs.supportPosix) {</span>
<span class="line-added">+             if (type == PosixFileAttributeView.class)</span>
<span class="line-added">+                 return (V)new ZipPosixFileAttributeView(this, false);</span>
<span class="line-added">+             if (type == FileOwnerAttributeView.class)</span>
<span class="line-added">+                 return (V)new ZipPosixFileAttributeView(this,true);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         throw new UnsupportedOperationException(&quot;view &lt;&quot; + type + &quot;&gt; is not supported&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private ZipFileAttributeView getFileAttributeView(String type) {</span>
<span class="line-added">+         if (type == null)</span>
<span class="line-added">+             throw new NullPointerException();</span>
<span class="line-added">+         if (&quot;basic&quot;.equals(type))</span>
<span class="line-added">+             return new ZipFileAttributeView(this, false);</span>
<span class="line-added">+         if (&quot;zip&quot;.equals(type))</span>
<span class="line-added">+             return new ZipFileAttributeView(this, true);</span>
<span class="line-added">+         if (zfs.supportPosix) {</span>
<span class="line-added">+             if (&quot;posix&quot;.equals(type))</span>
<span class="line-added">+                 return new ZipPosixFileAttributeView(this, false);</span>
<span class="line-added">+             if (&quot;owner&quot;.equals(type))</span>
<span class="line-added">+                 return new ZipPosixFileAttributeView(this, true);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         throw new UnsupportedOperationException(&quot;view &lt;&quot; + type + &quot;&gt; is not supported&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      void createDirectory(FileAttribute&lt;?&gt;... attrs)
          throws IOException
      {
          zfs.createDirectory(getResolvedPath(), attrs);
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 729,66 ***</span>
  
      void delete() throws IOException {
          zfs.deleteFile(getResolvedPath(), true);
      }
  
<span class="line-modified">!     void deleteIfExists() throws IOException {</span>
          zfs.deleteFile(getResolvedPath(), false);
      }
  
<span class="line-modified">!     ZipFileAttributes getAttributes() throws IOException</span>
<span class="line-removed">-     {</span>
          ZipFileAttributes zfas = zfs.getFileAttributes(getResolvedPath());
          if (zfas == null)
              throw new NoSuchFileException(toString());
          return zfas;
      }
  
      void setAttribute(String attribute, Object value, LinkOption... options)
          throws IOException
      {
<span class="line-modified">!         String type = null;</span>
<span class="line-modified">!         String attr = null;</span>
          int colonPos = attribute.indexOf(&#39;:&#39;);
          if (colonPos == -1) {
              type = &quot;basic&quot;;
              attr = attribute;
          } else {
              type = attribute.substring(0, colonPos++);
              attr = attribute.substring(colonPos);
          }
<span class="line-modified">!         ZipFileAttributeView view = ZipFileAttributeView.get(this, type);</span>
<span class="line-removed">-         if (view == null)</span>
<span class="line-removed">-             throw new UnsupportedOperationException(&quot;view &lt;&quot; + view + &quot;&gt; is not supported&quot;);</span>
<span class="line-removed">-         view.setAttribute(attr, value);</span>
      }
  
      void setTimes(FileTime mtime, FileTime atime, FileTime ctime)
          throws IOException
      {
          zfs.setTimes(getResolvedPath(), mtime, atime, ctime);
      }
  
<span class="line-modified">!     Map&lt;String, Object&gt; readAttributes(String attributes, LinkOption... options)</span>
          throws IOException
  
      {
<span class="line-modified">!         String view = null;</span>
<span class="line-modified">!         String attrs = null;</span>
          int colonPos = attributes.indexOf(&#39;:&#39;);
          if (colonPos == -1) {
              view = &quot;basic&quot;;
              attrs = attributes;
          } else {
              view = attributes.substring(0, colonPos++);
              attrs = attributes.substring(colonPos);
          }
<span class="line-modified">!         ZipFileAttributeView zfv = ZipFileAttributeView.get(this, view);</span>
<span class="line-removed">-         if (zfv == null) {</span>
<span class="line-removed">-             throw new UnsupportedOperationException(&quot;view not supported&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return zfv.readAttributes(attrs);</span>
      }
  
      FileStore getFileStore() throws IOException {
          // each ZipFileSystem only has one root (as requested for now)
          if (exists())
<span class="line-new-header">--- 757,87 ---</span>
  
      void delete() throws IOException {
          zfs.deleteFile(getResolvedPath(), true);
      }
  
<span class="line-modified">!     private void deleteIfExists() throws IOException {</span>
          zfs.deleteFile(getResolvedPath(), false);
      }
  
<span class="line-modified">!     ZipFileAttributes readAttributes() throws IOException {</span>
          ZipFileAttributes zfas = zfs.getFileAttributes(getResolvedPath());
          if (zfas == null)
              throw new NoSuchFileException(toString());
          return zfas;
      }
  
<span class="line-added">+     @SuppressWarnings(&quot;unchecked&quot;) // Cast to A</span>
<span class="line-added">+     &lt;A extends BasicFileAttributes&gt; A readAttributes(Class&lt;A&gt; type) throws IOException {</span>
<span class="line-added">+         // unconditionally support BasicFileAttributes and ZipFileAttributes</span>
<span class="line-added">+         if (type == BasicFileAttributes.class || type == ZipFileAttributes.class) {</span>
<span class="line-added">+             return (A)readAttributes();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         // support PosixFileAttributes when activated</span>
<span class="line-added">+         if (type == PosixFileAttributes.class &amp;&amp; zfs.supportPosix) {</span>
<span class="line-added">+             return (A)readAttributes();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         throw new UnsupportedOperationException(&quot;Attributes of type &quot; +</span>
<span class="line-added">+             type.getName() + &quot; not supported&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      void setAttribute(String attribute, Object value, LinkOption... options)
          throws IOException
      {
<span class="line-modified">!         String type;</span>
<span class="line-modified">!         String attr;</span>
          int colonPos = attribute.indexOf(&#39;:&#39;);
          if (colonPos == -1) {
              type = &quot;basic&quot;;
              attr = attribute;
          } else {
              type = attribute.substring(0, colonPos++);
              attr = attribute.substring(colonPos);
          }
<span class="line-modified">!         getFileAttributeView(type).setAttribute(attr, value);</span>
      }
  
      void setTimes(FileTime mtime, FileTime atime, FileTime ctime)
          throws IOException
      {
          zfs.setTimes(getResolvedPath(), mtime, atime, ctime);
      }
  
<span class="line-modified">!     void setOwner(UserPrincipal owner) throws IOException {</span>
<span class="line-added">+         zfs.setOwner(getResolvedPath(), owner);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     void setPermissions(Set&lt;PosixFilePermission&gt; perms)</span>
          throws IOException
<span class="line-added">+     {</span>
<span class="line-added">+         zfs.setPermissions(getResolvedPath(), perms);</span>
<span class="line-added">+     }</span>
  
<span class="line-added">+     void setGroup(GroupPrincipal group) throws IOException {</span>
<span class="line-added">+         zfs.setGroup(getResolvedPath(), group);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     Map&lt;String, Object&gt; readAttributes(String attributes, LinkOption... options)</span>
<span class="line-added">+         throws IOException</span>
      {
<span class="line-modified">!         String view;</span>
<span class="line-modified">!         String attrs;</span>
          int colonPos = attributes.indexOf(&#39;:&#39;);
          if (colonPos == -1) {
              view = &quot;basic&quot;;
              attrs = attributes;
          } else {
              view = attributes.substring(0, colonPos++);
              attrs = attributes.substring(colonPos);
          }
<span class="line-modified">!         return getFileAttributeView(view).readAttributes(attrs);</span>
      }
  
      FileStore getFileStore() throws IOException {
          // each ZipFileSystem only has one root (as requested for now)
          if (exists())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 844,15 ***</span>
          if ((w &amp;&amp; zfs.isReadOnly()) || x) {
              throw new AccessDeniedException(toString());
          }
      }
  
<span class="line-modified">!     boolean exists() {</span>
<span class="line-modified">!         try {</span>
<span class="line-removed">-             return zfs.exists(getResolvedPath());</span>
<span class="line-removed">-         } catch (IOException x) {}</span>
<span class="line-removed">-         return false;</span>
      }
  
      OutputStream newOutputStream(OpenOption... options) throws IOException
      {
          if (options.length == 0)
<span class="line-new-header">--- 893,12 ---</span>
          if ((w &amp;&amp; zfs.isReadOnly()) || x) {
              throw new AccessDeniedException(toString());
          }
      }
  
<span class="line-modified">!     private boolean exists() {</span>
<span class="line-modified">!         return zfs.exists(getResolvedPath());</span>
      }
  
      OutputStream newOutputStream(OpenOption... options) throws IOException
      {
          if (options.length == 0)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 896,11 ***</span>
                  replaceExisting = true;
              else if (opt == COPY_ATTRIBUTES)
                  copyAttrs = true;
          }
          // attributes of source file
<span class="line-modified">!         ZipFileAttributes zfas = getAttributes();</span>
          // check if target exists
          boolean exists;
          if (replaceExisting) {
              try {
                  target.deleteIfExists();
<span class="line-new-header">--- 942,11 ---</span>
                  replaceExisting = true;
              else if (opt == COPY_ATTRIBUTES)
                  copyAttrs = true;
          }
          // attributes of source file
<span class="line-modified">!         ZipFileAttributes zfas = readAttributes();</span>
          // check if target exists
          boolean exists;
          if (replaceExisting) {
              try {
                  target.deleteIfExists();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 916,33 ***</span>
  
          if (zfas.isDirectory()) {
              // create directory or file
              target.createDirectory();
          } else {
<span class="line-modified">!             InputStream is = zfs.newInputStream(getResolvedPath());</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 OutputStream os = target.newOutputStream();</span>
<span class="line-modified">!                 try {</span>
<span class="line-modified">!                     byte[] buf = new byte[8192];</span>
<span class="line-modified">!                     int n = 0;</span>
<span class="line-modified">!                     while ((n = is.read(buf)) != -1) {</span>
<span class="line-removed">-                         os.write(buf, 0, n);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 } finally {</span>
<span class="line-removed">-                     os.close();</span>
                  }
<span class="line-removed">-             } finally {</span>
<span class="line-removed">-                 is.close();</span>
              }
          }
          if (copyAttrs) {
<span class="line-modified">!             BasicFileAttributeView view =</span>
<span class="line-modified">!                 ZipFileAttributeView.get(target, BasicFileAttributeView.class);</span>
              try {
                  view.setTimes(zfas.lastModifiedTime(),
                                zfas.lastAccessTime(),
                                zfas.creationTime());
              } catch (IOException x) {
                  // rollback?
                  try {
                      target.delete();
                  } catch (IOException ignore) { }
<span class="line-new-header">--- 962,29 ---</span>
  
          if (zfas.isDirectory()) {
              // create directory or file
              target.createDirectory();
          } else {
<span class="line-modified">!             try (InputStream is = zfs.newInputStream(getResolvedPath());</span>
<span class="line-modified">!                  OutputStream os = target.newOutputStream())</span>
<span class="line-modified">!             {</span>
<span class="line-modified">!                 byte[] buf = new byte[8192];</span>
<span class="line-modified">!                 int n;</span>
<span class="line-modified">!                 while ((n = is.read(buf)) != -1) {</span>
<span class="line-modified">!                     os.write(buf, 0, n);</span>
                  }
              }
          }
          if (copyAttrs) {
<span class="line-modified">!             ZipFileAttributeView view =</span>
<span class="line-modified">!                 target.getFileAttributeView(ZipFileAttributeView.class);</span>
              try {
                  view.setTimes(zfas.lastModifiedTime(),
                                zfas.lastAccessTime(),
                                zfas.creationTime());
<span class="line-added">+                 // copy permissions</span>
<span class="line-added">+                 view.setPermissions(zfas.storedPermissions().orElse(null));</span>
              } catch (IOException x) {
                  // rollback?
                  try {
                      target.delete();
                  } catch (IOException ignore) { }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 961,13 ***</span>
          assert false;
          return -1;
      }
  
      // to avoid double escape
<span class="line-modified">!     static String decodeUri(String s) {</span>
          if (s == null)
<span class="line-modified">!             return s;</span>
          int n = s.length();
          if (n == 0)
              return s;
          if (s.indexOf(&#39;%&#39;) &lt; 0)
              return s;
<span class="line-new-header">--- 1003,13 ---</span>
          assert false;
          return -1;
      }
  
      // to avoid double escape
<span class="line-modified">!     private static String decodeUri(String s) {</span>
          if (s == null)
<span class="line-modified">!             return null;</span>
          int n = s.length();
          if (n == 0)
              return s;
          if (s.indexOf(&#39;%&#39;) &lt; 0)
              return s;
</pre>
<center><a href="ZipInfo.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ZipUtils.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>