<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.le/share/classes/jdk/internal/org/jline/terminal/impl/AbstractWindowsTerminal.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AbstractWindowsConsoleWriter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CursorSupport.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.le/share/classes/jdk/internal/org/jline/terminal/impl/AbstractWindowsTerminal.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002-2018, the original author or authors.</span>
  3  *
  4  * This software is distributable under the BSD license. See the terms of the
  5  * BSD license in the documentation provided with this software.
  6  *
<span class="line-modified">  7  * http://www.opensource.org/licenses/bsd-license.php</span>
  8  */
  9 package jdk.internal.org.jline.terminal.impl;
 10 
 11 import jdk.internal.org.jline.terminal.Attributes;
 12 import jdk.internal.org.jline.terminal.Size;
 13 import jdk.internal.org.jline.utils.Curses;
 14 import jdk.internal.org.jline.utils.InfoCmp;
 15 import jdk.internal.org.jline.utils.Log;
 16 import jdk.internal.org.jline.utils.NonBlocking;
 17 import jdk.internal.org.jline.utils.NonBlockingInputStream;
 18 import jdk.internal.org.jline.utils.NonBlockingPumpReader;
 19 import jdk.internal.org.jline.utils.NonBlockingReader;
 20 import jdk.internal.org.jline.utils.ShutdownHooks;
 21 import jdk.internal.org.jline.utils.Signals;
 22 import jdk.internal.org.jline.utils.WriterOutputStream;
 23 
<span class="line-removed"> 24 import java.io.IOError;</span>
 25 import java.io.IOException;
 26 import java.io.InputStream;
 27 import java.io.OutputStream;
 28 import java.io.PrintWriter;
<span class="line-removed"> 29 import java.io.StringWriter;</span>
 30 import java.io.Writer;
 31 import java.nio.charset.Charset;
 32 import java.nio.charset.StandardCharsets;
 33 import java.util.HashMap;
 34 import java.util.Map;
 35 import java.util.function.Function;
 36 
 37 /**
 38  * The AbstractWindowsTerminal is used as the base class for windows terminal.
 39  * Due to windows limitations, mostly the missing support for ansi sequences,
 40  * the only way to create a correct terminal is to use the windows api to set
 41  * character attributes, move the cursor, erasing, etc...
 42  *
 43  * UTF-8 support is also lacking in windows and the code page supposed to
 44  * emulate UTF-8 is a bit broken. In order to work around this broken
 45  * code page, windows api WriteConsoleW is used directly.  This means that
 46  * the writer() becomes the primary output, while the output() is bridged
 47  * to the writer() using a WriterOutputStream wrapper.
 48  */
 49 public abstract class AbstractWindowsTerminal extends AbstractTerminal {
 50 
 51     public static final String TYPE_WINDOWS = &quot;windows&quot;;
 52     public static final String TYPE_WINDOWS_256_COLOR = &quot;windows-256color&quot;;

 53     public static final String TYPE_WINDOWS_VTP = &quot;windows-vtp&quot;;
 54 
 55     public static final int ENABLE_VIRTUAL_TERMINAL_PROCESSING = 0x0004;
 56 
 57     private static final int UTF8_CODE_PAGE = 65001;
 58 
 59     protected static final int ENABLE_PROCESSED_INPUT = 0x0001;
 60     protected static final int ENABLE_LINE_INPUT      = 0x0002;
 61     protected static final int ENABLE_ECHO_INPUT      = 0x0004;
 62     protected static final int ENABLE_WINDOW_INPUT    = 0x0008;
 63     protected static final int ENABLE_MOUSE_INPUT     = 0x0010;
 64     protected static final int ENABLE_INSERT_MODE     = 0x0020;
 65     protected static final int ENABLE_QUICK_EDIT_MODE = 0x0040;
 66 
 67     protected final Writer slaveInputPipe;
 68     protected final InputStream input;
 69     protected final OutputStream output;
 70     protected final NonBlockingReader reader;
 71     protected final PrintWriter writer;
 72     protected final Map&lt;Signal, Object&gt; nativeHandlers = new HashMap&lt;&gt;();
</pre>
<hr />
<pre>
 93         parseInfoCmp();
 94         // Attributes
 95         originalConsoleMode = getConsoleMode();
 96         attributes.setLocalFlag(Attributes.LocalFlag.ISIG, true);
 97         attributes.setControlChar(Attributes.ControlChar.VINTR, ctrl(&#39;C&#39;));
 98         attributes.setControlChar(Attributes.ControlChar.VEOF,  ctrl(&#39;D&#39;));
 99         attributes.setControlChar(Attributes.ControlChar.VSUSP, ctrl(&#39;Z&#39;));
100         // Handle signals
101         if (nativeSignals) {
102             for (final Signal signal : Signal.values()) {
103                 if (signalHandler == SignalHandler.SIG_DFL) {
104                     nativeHandlers.put(signal, Signals.registerDefault(signal.name()));
105                 } else {
106                     nativeHandlers.put(signal, Signals.register(signal.name(), () -&gt; raise(signal)));
107                 }
108             }
109         }
110         closer = this::close;
111         ShutdownHooks.add(closer);
112         // ConEMU extended fonts support
<span class="line-modified">113         if (TYPE_WINDOWS_256_COLOR.equals(getType())</span>
114                 &amp;&amp; !Boolean.getBoolean(&quot;org.jline.terminal.conemu.disable-activate&quot;)) {
115             writer.write(&quot;\u001b[9999E&quot;);
116             writer.flush();
117         }
118     }
119 
120     private static Charset selectCharset(Charset encoding, int codepage) {
121         if (encoding != null) {
122             return encoding;
123         }
124 
125         if (codepage &gt;= 0) {
126             return getCodepageCharset(codepage);
127         }
128 
129         // Use UTF-8 as default
130         return StandardCharsets.UTF_8;
131     }
132 
133     private static Charset getCodepageCharset(int codepage) {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2002-2019, the original author or authors.</span>
  3  *
  4  * This software is distributable under the BSD license. See the terms of the
  5  * BSD license in the documentation provided with this software.
  6  *
<span class="line-modified">  7  * https://opensource.org/licenses/BSD-3-Clause</span>
  8  */
  9 package jdk.internal.org.jline.terminal.impl;
 10 
 11 import jdk.internal.org.jline.terminal.Attributes;
 12 import jdk.internal.org.jline.terminal.Size;
 13 import jdk.internal.org.jline.utils.Curses;
 14 import jdk.internal.org.jline.utils.InfoCmp;
 15 import jdk.internal.org.jline.utils.Log;
 16 import jdk.internal.org.jline.utils.NonBlocking;
 17 import jdk.internal.org.jline.utils.NonBlockingInputStream;
 18 import jdk.internal.org.jline.utils.NonBlockingPumpReader;
 19 import jdk.internal.org.jline.utils.NonBlockingReader;
 20 import jdk.internal.org.jline.utils.ShutdownHooks;
 21 import jdk.internal.org.jline.utils.Signals;
 22 import jdk.internal.org.jline.utils.WriterOutputStream;
 23 

 24 import java.io.IOException;
 25 import java.io.InputStream;
 26 import java.io.OutputStream;
 27 import java.io.PrintWriter;

 28 import java.io.Writer;
 29 import java.nio.charset.Charset;
 30 import java.nio.charset.StandardCharsets;
 31 import java.util.HashMap;
 32 import java.util.Map;
 33 import java.util.function.Function;
 34 
 35 /**
 36  * The AbstractWindowsTerminal is used as the base class for windows terminal.
 37  * Due to windows limitations, mostly the missing support for ansi sequences,
 38  * the only way to create a correct terminal is to use the windows api to set
 39  * character attributes, move the cursor, erasing, etc...
 40  *
 41  * UTF-8 support is also lacking in windows and the code page supposed to
 42  * emulate UTF-8 is a bit broken. In order to work around this broken
 43  * code page, windows api WriteConsoleW is used directly.  This means that
 44  * the writer() becomes the primary output, while the output() is bridged
 45  * to the writer() using a WriterOutputStream wrapper.
 46  */
 47 public abstract class AbstractWindowsTerminal extends AbstractTerminal {
 48 
 49     public static final String TYPE_WINDOWS = &quot;windows&quot;;
 50     public static final String TYPE_WINDOWS_256_COLOR = &quot;windows-256color&quot;;
<span class="line-added"> 51     public static final String TYPE_WINDOWS_CONEMU = &quot;windows-conemu&quot;;</span>
 52     public static final String TYPE_WINDOWS_VTP = &quot;windows-vtp&quot;;
 53 
 54     public static final int ENABLE_VIRTUAL_TERMINAL_PROCESSING = 0x0004;
 55 
 56     private static final int UTF8_CODE_PAGE = 65001;
 57 
 58     protected static final int ENABLE_PROCESSED_INPUT = 0x0001;
 59     protected static final int ENABLE_LINE_INPUT      = 0x0002;
 60     protected static final int ENABLE_ECHO_INPUT      = 0x0004;
 61     protected static final int ENABLE_WINDOW_INPUT    = 0x0008;
 62     protected static final int ENABLE_MOUSE_INPUT     = 0x0010;
 63     protected static final int ENABLE_INSERT_MODE     = 0x0020;
 64     protected static final int ENABLE_QUICK_EDIT_MODE = 0x0040;
 65 
 66     protected final Writer slaveInputPipe;
 67     protected final InputStream input;
 68     protected final OutputStream output;
 69     protected final NonBlockingReader reader;
 70     protected final PrintWriter writer;
 71     protected final Map&lt;Signal, Object&gt; nativeHandlers = new HashMap&lt;&gt;();
</pre>
<hr />
<pre>
 92         parseInfoCmp();
 93         // Attributes
 94         originalConsoleMode = getConsoleMode();
 95         attributes.setLocalFlag(Attributes.LocalFlag.ISIG, true);
 96         attributes.setControlChar(Attributes.ControlChar.VINTR, ctrl(&#39;C&#39;));
 97         attributes.setControlChar(Attributes.ControlChar.VEOF,  ctrl(&#39;D&#39;));
 98         attributes.setControlChar(Attributes.ControlChar.VSUSP, ctrl(&#39;Z&#39;));
 99         // Handle signals
100         if (nativeSignals) {
101             for (final Signal signal : Signal.values()) {
102                 if (signalHandler == SignalHandler.SIG_DFL) {
103                     nativeHandlers.put(signal, Signals.registerDefault(signal.name()));
104                 } else {
105                     nativeHandlers.put(signal, Signals.register(signal.name(), () -&gt; raise(signal)));
106                 }
107             }
108         }
109         closer = this::close;
110         ShutdownHooks.add(closer);
111         // ConEMU extended fonts support
<span class="line-modified">112         if (TYPE_WINDOWS_CONEMU.equals(getType())</span>
113                 &amp;&amp; !Boolean.getBoolean(&quot;org.jline.terminal.conemu.disable-activate&quot;)) {
114             writer.write(&quot;\u001b[9999E&quot;);
115             writer.flush();
116         }
117     }
118 
119     private static Charset selectCharset(Charset encoding, int codepage) {
120         if (encoding != null) {
121             return encoding;
122         }
123 
124         if (codepage &gt;= 0) {
125             return getCodepageCharset(codepage);
126         }
127 
128         // Use UTF-8 as default
129         return StandardCharsets.UTF_8;
130     }
131 
132     private static Charset getCodepageCharset(int codepage) {
</pre>
</td>
</tr>
</table>
<center><a href="AbstractWindowsConsoleWriter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CursorSupport.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>