<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.le/share/classes/jdk/internal/org/jline/reader/impl/history/DefaultHistory.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../completer/package-info.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="package-info.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.le/share/classes/jdk/internal/org/jline/reader/impl/history/DefaultHistory.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -2,16 +2,17 @@</span>
   * Copyright (c) 2002-2018, the original author or authors.
   *
   * This software is distributable under the BSD license. See the terms of the
   * BSD license in the documentation provided with this software.
   *
<span class="udiff-line-modified-removed">-  * http://www.opensource.org/licenses/bsd-license.php</span>
<span class="udiff-line-modified-added">+  * https://opensource.org/licenses/BSD-3-Clause</span>
   */
  package jdk.internal.org.jline.reader.impl.history;
  
  import java.io.*;
  import java.nio.file.*;
<span class="udiff-line-added">+ import java.time.DateTimeException;</span>
  import java.time.Instant;
  import java.util.*;
  
  import jdk.internal.org.jline.reader.History;
  import jdk.internal.org.jline.reader.LineReader;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -34,12 +35,11 @@</span>
  
      private final LinkedList&lt;Entry&gt; items = new LinkedList&lt;&gt;();
  
      private LineReader reader;
  
<span class="udiff-line-modified-removed">-     private int lastLoaded = 0;</span>
<span class="udiff-line-removed">-     private int nbEntriesInFile = 0;</span>
<span class="udiff-line-modified-added">+     private Map&lt;String, HistoryFileData&gt; historyFiles = new HashMap&lt;&gt;();</span>
      private int offset = 0;
      private int index = 0;
  
      public DefaultHistory() {
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,11 +66,11 @@</span>
          if (this.reader != reader) {
              this.reader = reader;
              try {
                  load();
              }
<span class="udiff-line-modified-removed">-             catch (IOException e) {</span>
<span class="udiff-line-modified-added">+             catch (IllegalArgumentException | IOException e) {</span>
                  Log.warn(&quot;Failed to load history&quot;, e);
              }
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -82,37 +82,116 @@</span>
                  if (Files.exists(path)) {
                      Log.trace(&quot;Loading history from: &quot;, path);
                      try (BufferedReader reader = Files.newBufferedReader(path)) {
                          internalClear();
                          reader.lines().forEach(line -&gt; addHistoryLine(path, line));
<span class="udiff-line-modified-removed">-                         lastLoaded = items.size();</span>
<span class="udiff-line-removed">-                         nbEntriesInFile = lastLoaded;</span>
<span class="udiff-line-modified-added">+                         setHistoryFileData(path, new HistoryFileData(items.size(), items.size()));</span>
                          maybeResize();
                      }
                  }
<span class="udiff-line-modified-removed">-             } catch (IOException e) {</span>
<span class="udiff-line-modified-added">+             } catch (IllegalArgumentException | IOException e) {</span>
                  Log.debug(&quot;Failed to load history; clearing&quot;, e);
                  internalClear();
                  throw e;
              }
          }
      }
  
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public void read(Path file, boolean incremental) throws IOException {</span>
<span class="udiff-line-added">+         Path path = file != null ? file : getPath();</span>
<span class="udiff-line-added">+         if (path != null) {</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 if (Files.exists(path)) {</span>
<span class="udiff-line-added">+                     Log.trace(&quot;Reading history from: &quot;, path);</span>
<span class="udiff-line-added">+                     try (BufferedReader reader = Files.newBufferedReader(path)) {</span>
<span class="udiff-line-added">+                         reader.lines().forEach(line -&gt; addHistoryLine(path, line, incremental));</span>
<span class="udiff-line-added">+                         setHistoryFileData(path, new HistoryFileData(items.size(), items.size()));</span>
<span class="udiff-line-added">+                         maybeResize();</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } catch (IllegalArgumentException | IOException e) {</span>
<span class="udiff-line-added">+                 Log.debug(&quot;Failed to read history; clearing&quot;, e);</span>
<span class="udiff-line-added">+                 internalClear();</span>
<span class="udiff-line-added">+                 throw e;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private String doHistoryFileDataKey (Path path){</span>
<span class="udiff-line-added">+         return path != null ? path.toAbsolutePath().toString() : null;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private HistoryFileData getHistoryFileData(Path path) {</span>
<span class="udiff-line-added">+         String key = doHistoryFileDataKey(path);</span>
<span class="udiff-line-added">+         if (!historyFiles.containsKey(key)){</span>
<span class="udiff-line-added">+             historyFiles.put(key, new HistoryFileData());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return historyFiles.get(key);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void setHistoryFileData(Path path, HistoryFileData historyFileData) {</span>
<span class="udiff-line-added">+         historyFiles.put(doHistoryFileDataKey(path), historyFileData);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private boolean isLineReaderHistory (Path path) throws IOException {</span>
<span class="udiff-line-added">+         Path lrp = getPath();</span>
<span class="udiff-line-added">+         if (lrp == null) {</span>
<span class="udiff-line-added">+             if (path != null) {</span>
<span class="udiff-line-added">+                 return false;</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return Files.isSameFile(lrp, path);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void setLastLoaded(Path path, int lastloaded){</span>
<span class="udiff-line-added">+         getHistoryFileData(path).setLastLoaded(lastloaded);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void setEntriesInFile(Path path, int entriesInFile){</span>
<span class="udiff-line-added">+         getHistoryFileData(path).setEntriesInFile(entriesInFile);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void incEntriesInFile(Path path, int amount){</span>
<span class="udiff-line-added">+         getHistoryFileData(path).incEntriesInFile(amount);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private int getLastLoaded(Path path){</span>
<span class="udiff-line-added">+         return getHistoryFileData(path).getLastLoaded();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private int getEntriesInFile(Path path){</span>
<span class="udiff-line-added">+         return getHistoryFileData(path).getEntriesInFile();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      protected void addHistoryLine(Path path, String line) {
<span class="udiff-line-added">+         addHistoryLine(path, line, false);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     protected void addHistoryLine(Path path, String line, boolean checkDuplicates) {</span>
          if (reader.isSet(LineReader.Option.HISTORY_TIMESTAMPED)) {
              int idx = line.indexOf(&#39;:&#39;);
<span class="udiff-line-added">+             final String badHistoryFileSyntax = &quot;Bad history file syntax! &quot; +</span>
<span class="udiff-line-added">+                 &quot;The history file `&quot; + path + &quot;` may be an older history: &quot; +</span>
<span class="udiff-line-added">+                 &quot;please remove it or use a different history file.&quot;;</span>
              if (idx &lt; 0) {
<span class="udiff-line-modified-removed">-                 throw new IllegalArgumentException(&quot;Bad history file syntax! &quot; +</span>
<span class="udiff-line-modified-removed">-                         &quot;The history file `&quot; + path + &quot;` may be an older history: &quot; +</span>
<span class="udiff-line-modified-removed">-                         &quot;please remove it or use a different history file.&quot;);</span>
<span class="udiff-line-modified-added">+                 throw new IllegalArgumentException(badHistoryFileSyntax);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+             Instant time;</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 time = Instant.ofEpochMilli(Long.parseLong(line.substring(0, idx)));</span>
<span class="udiff-line-added">+             } catch (DateTimeException | NumberFormatException e) {</span>
<span class="udiff-line-added">+                 throw new IllegalArgumentException(badHistoryFileSyntax);</span>
              }
<span class="udiff-line-modified-removed">-             Instant time = Instant.ofEpochMilli(Long.parseLong(line.substring(0, idx)));</span>
<span class="udiff-line-modified-added">+ </span>
              String unescaped = unescape(line.substring(idx + 1));
<span class="udiff-line-modified-removed">-             internalAdd(time, unescaped);</span>
<span class="udiff-line-modified-added">+             internalAdd(time, unescaped, checkDuplicates);</span>
          }
          else {
<span class="udiff-line-modified-removed">-             internalAdd(Instant.now(), unescape(line));</span>
<span class="udiff-line-modified-added">+             internalAdd(Instant.now(), unescape(line), checkDuplicates);</span>
          }
      }
  
      @Override
      public void purge() throws IOException {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -122,33 +201,50 @@</span>
              Log.trace(&quot;Purging history from: &quot;, path);
              Files.deleteIfExists(path);
          }
      }
  
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public void write(Path file, boolean incremental) throws IOException {</span>
<span class="udiff-line-added">+         Path path = file != null ? file : getPath();</span>
<span class="udiff-line-added">+         if (path != null &amp;&amp; Files.exists(path)) {</span>
<span class="udiff-line-added">+             path.toFile().delete();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         internalWrite(path, incremental ? getLastLoaded(path) : 0);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public void append(Path file, boolean incremental) throws IOException {</span>
<span class="udiff-line-added">+         internalWrite(file != null ? file : getPath(),</span>
<span class="udiff-line-added">+                       incremental ? getLastLoaded(file) : 0);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      @Override
      public void save() throws IOException {
<span class="udiff-line-modified-removed">-         Path path = getPath();</span>
<span class="udiff-line-modified-added">+         internalWrite(getPath(), getLastLoaded(getPath()));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void internalWrite(Path path, int from) throws IOException {</span>
          if (path != null) {
              Log.trace(&quot;Saving history to: &quot;, path);
              Files.createDirectories(path.toAbsolutePath().getParent());
              // Append new items to the history file
              try (BufferedWriter writer = Files.newBufferedWriter(path.toAbsolutePath(),
                StandardOpenOption.WRITE, StandardOpenOption.APPEND, StandardOpenOption.CREATE)) {
<span class="udiff-line-modified-removed">-                 for (Entry entry : items.subList(lastLoaded, items.size())) {</span>
<span class="udiff-line-modified-added">+                 for (Entry entry : items.subList(from, items.size())) {</span>
                      if (isPersistable(entry)) {
                          writer.append(format(entry));
                      }
                  }
              }
<span class="udiff-line-modified-removed">-             nbEntriesInFile += items.size() - lastLoaded;</span>
<span class="udiff-line-removed">-             // If we are over 25% max size, trim history file</span>
<span class="udiff-line-modified-added">+             incEntriesInFile(path, items.size() - from);</span>
              int max = getInt(reader, LineReader.HISTORY_FILE_SIZE, DEFAULT_HISTORY_FILE_SIZE);
<span class="udiff-line-modified-removed">-             if (nbEntriesInFile &gt; max + max / 4) {</span>
<span class="udiff-line-modified-added">+             if (getEntriesInFile(path) &gt; max + max / 4) {</span>
                  trimHistory(path, max);
              }
          }
<span class="udiff-line-modified-removed">-         lastLoaded = items.size();</span>
<span class="udiff-line-modified-added">+         setLastLoaded(path, items.size());</span>
      }
  
      protected void trimHistory(Path path, int max) throws IOException {
          Log.trace(&quot;Trimming history path: &quot;, path);
          // Load all history entries
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,15 +266,18 @@</span>
                  writer.append(format(entry));
              }
          }
          Files.move(temp, path, StandardCopyOption.REPLACE_EXISTING);
          // Keep items in memory
<span class="udiff-line-modified-removed">-         internalClear();</span>
<span class="udiff-line-modified-removed">-         offset = allItems.get(0).index();</span>
<span class="udiff-line-modified-removed">-         items.addAll(allItems);</span>
<span class="udiff-line-modified-removed">-         lastLoaded = items.size();</span>
<span class="udiff-line-modified-removed">-         nbEntriesInFile = items.size();</span>
<span class="udiff-line-modified-added">+         if (isLineReaderHistory(path)) {</span>
<span class="udiff-line-modified-added">+             internalClear();</span>
<span class="udiff-line-modified-added">+             offset = allItems.get(0).index();</span>
<span class="udiff-line-modified-added">+             items.addAll(allItems);</span>
<span class="udiff-line-modified-added">+             setHistoryFileData(path, new HistoryFileData(items.size(), items.size()));</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             setEntriesInFile(path, allItems.size());</span>
<span class="udiff-line-added">+         }</span>
          maybeResize();
      }
  
      /**
       * Create a history entry. Subclasses may override to use their own entry implementations.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -192,12 +291,11 @@</span>
      }
  
      private void internalClear() {
          offset = 0;
          index = 0;
<span class="udiff-line-modified-removed">-         lastLoaded = 0;</span>
<span class="udiff-line-removed">-         nbEntriesInFile = 0;</span>
<span class="udiff-line-modified-added">+         historyFiles = new HashMap&lt;&gt;();</span>
          items.clear();
      }
  
      static void doTrimHistory(List&lt;Entry&gt; allItems, int max) {
          int idx = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -300,19 +398,32 @@</span>
          }
          return line.matches(sb.toString());
      }
  
      protected void internalAdd(Instant time, String line) {
<span class="udiff-line-added">+         internalAdd(time, line, false);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     protected void internalAdd(Instant time, String line, boolean checkDuplicates) {</span>
          Entry entry = new EntryImpl(offset + items.size(), time, line);
<span class="udiff-line-added">+         if (checkDuplicates) {</span>
<span class="udiff-line-added">+             for (Entry e: items) {</span>
<span class="udiff-line-added">+                 if (e.line().trim().equals(line.trim())) {</span>
<span class="udiff-line-added">+                     return;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
          items.add(entry);
          maybeResize();
      }
  
      private void maybeResize() {
          while (size() &gt; getInt(reader, LineReader.HISTORY_SIZE, DEFAULT_HISTORY_SIZE)) {
              items.removeFirst();
<span class="udiff-line-modified-removed">-             lastLoaded--;</span>
<span class="udiff-line-modified-added">+             for (HistoryFileData hfd: historyFiles.values()) {</span>
<span class="udiff-line-added">+                 hfd.decLastLoaded();</span>
<span class="udiff-line-added">+             }</span>
              offset++;
          }
          index = size();
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -501,7 +612,48 @@</span>
              }
          }
          return sb.toString();
      }
  
<span class="udiff-line-added">+     private class HistoryFileData {</span>
<span class="udiff-line-added">+         private int lastLoaded = 0;</span>
<span class="udiff-line-added">+         private int entriesInFile = 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public HistoryFileData() {</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public HistoryFileData(int lastLoaded, int entriesInFile) {</span>
<span class="udiff-line-added">+             this.lastLoaded = lastLoaded;</span>
<span class="udiff-line-added">+             this.entriesInFile = entriesInFile;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public int getLastLoaded() {</span>
<span class="udiff-line-added">+             return lastLoaded;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public void setLastLoaded(int lastLoaded) {</span>
<span class="udiff-line-added">+             this.lastLoaded = lastLoaded;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public void decLastLoaded() {</span>
<span class="udiff-line-added">+             lastLoaded = lastLoaded - 1;</span>
<span class="udiff-line-added">+             if (lastLoaded &lt; 0) {</span>
<span class="udiff-line-added">+                 lastLoaded = 0;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public int getEntriesInFile() {</span>
<span class="udiff-line-added">+             return entriesInFile;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public void setEntriesInFile(int entriesInFile) {</span>
<span class="udiff-line-added">+             this.entriesInFile = entriesInFile;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public void incEntriesInFile(int amount) {</span>
<span class="udiff-line-added">+             entriesInFile = entriesInFile + amount;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
  }
  
</pre>
<center><a href="../completer/package-info.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="package-info.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>