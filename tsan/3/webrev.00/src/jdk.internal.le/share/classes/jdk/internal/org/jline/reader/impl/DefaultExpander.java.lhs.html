<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.le/share/classes/jdk/internal/org/jline/reader/impl/DefaultExpander.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2002-2016, the original author or authors.
  3  *
  4  * This software is distributable under the BSD license. See the terms of the
  5  * BSD license in the documentation provided with this software.
  6  *
<a name="1" id="anc1"></a><span class="line-modified">  7  * http://www.opensource.org/licenses/bsd-license.php</span>
  8  */
  9 package jdk.internal.org.jline.reader.impl;
 10 
 11 import java.util.ListIterator;
 12 
 13 import jdk.internal.org.jline.reader.Expander;
 14 import jdk.internal.org.jline.reader.History;
 15 import jdk.internal.org.jline.reader.History.Entry;
 16 
 17 public class DefaultExpander implements Expander {
 18 
 19     /**
 20      * Expand event designator such as !!, !#, !3, etc...
 21      * See http://www.gnu.org/software/bash/manual/html_node/Event-Designators.html
 22      */
 23     @SuppressWarnings(&quot;fallthrough&quot;)
 24     @Override
 25     public String expandHistory(History history, String line) {
 26         boolean inQuote = false;
 27         StringBuilder sb = new StringBuilder();
 28         boolean escaped = false;
 29         int unicode = 0;
 30         for (int i = 0; i &lt; line.length(); i++) {
 31             char c = line.charAt(i);
 32             if (unicode &gt; 0) {
 33                 escaped = (--unicode &gt;= 0);
 34                 sb.append(c);
 35             }
 36             else if (escaped) {
 37                 if (c == &#39;u&#39;) {
 38                     unicode = 4;
 39                 } else {
 40                     escaped = false;
 41                 }
 42                 sb.append(c);
 43             }
 44             else if (c == &#39;\&#39;&#39;) {
 45                 inQuote = !inQuote;
 46                 sb.append(c);
 47             }
 48             else if (inQuote) {
 49                 sb.append(c);
 50             }
 51             else {
 52                 switch (c) {
 53                     case &#39;\\&#39;:
 54                         // any &#39;\!&#39; should be considered an expansion escape, so skip expansion and strip the escape character
 55                         // a leading &#39;\^&#39; should be considered an expansion escape, so skip expansion and strip the escape character
 56                         // otherwise, add the escape
 57                         escaped = true;
 58                         sb.append(c);
 59                         break;
 60                     case &#39;!&#39;:
 61                         if (i + 1 &lt; line.length()) {
 62                             c = line.charAt(++i);
 63                             boolean neg = false;
 64                             String rep = null;
 65                             int i1, idx;
 66                             switch (c) {
 67                                 case &#39;!&#39;:
 68                                     if (history.size() == 0) {
 69                                         throw new IllegalArgumentException(&quot;!!: event not found&quot;);
 70                                     }
 71                                     rep = history.get(history.index() - 1);
 72                                     break;
 73                                 case &#39;#&#39;:
 74                                     sb.append(sb.toString());
 75                                     break;
 76                                 case &#39;?&#39;:
 77                                     i1 = line.indexOf(&#39;?&#39;, i + 1);
 78                                     if (i1 &lt; 0) {
 79                                         i1 = line.length();
 80                                     }
 81                                     String sc = line.substring(i + 1, i1);
 82                                     i = i1;
 83                                     idx = searchBackwards(history, sc, history.index(), false);
 84                                     if (idx &lt; 0) {
 85                                         throw new IllegalArgumentException(&quot;!?&quot; + sc + &quot;: event not found&quot;);
 86                                     } else {
 87                                         rep = history.get(idx);
 88                                     }
 89                                     break;
 90                                 case &#39;$&#39;:
 91                                     if (history.size() == 0) {
 92                                         throw new IllegalArgumentException(&quot;!$: event not found&quot;);
 93                                     }
 94                                     String previous = history.get(history.index() - 1).trim();
 95                                     int lastSpace = previous.lastIndexOf(&#39; &#39;);
 96                                     if (lastSpace != -1) {
 97                                         rep = previous.substring(lastSpace + 1);
 98                                     } else {
 99                                         rep = previous;
100                                     }
101                                     break;
102                                 case &#39; &#39;:
103                                 case &#39;\t&#39;:
104                                     sb.append(&#39;!&#39;);
105                                     sb.append(c);
106                                     break;
107                                 case &#39;-&#39;:
108                                     neg = true;
109                                     i++;
110                                     // fall through
111                                 case &#39;0&#39;:
112                                 case &#39;1&#39;:
113                                 case &#39;2&#39;:
114                                 case &#39;3&#39;:
115                                 case &#39;4&#39;:
116                                 case &#39;5&#39;:
117                                 case &#39;6&#39;:
118                                 case &#39;7&#39;:
119                                 case &#39;8&#39;:
120                                 case &#39;9&#39;:
121                                     i1 = i;
122                                     for (; i &lt; line.length(); i++) {
123                                         c = line.charAt(i);
124                                         if (c &lt; &#39;0&#39; || c &gt; &#39;9&#39;) {
125                                             break;
126                                         }
127                                     }
128                                     try {
129                                         idx = Integer.parseInt(line.substring(i1, i));
130                                     } catch (NumberFormatException e) {
131                                         throw new IllegalArgumentException((neg ? &quot;!-&quot; : &quot;!&quot;) + line.substring(i1, i) + &quot;: event not found&quot;);
132                                     }
133                                     if (neg &amp;&amp; idx &gt; 0 &amp;&amp; idx &lt;= history.size()) {
134                                         rep = history.get(history.index() - idx);
135                                     } else if (!neg &amp;&amp; idx &gt; history.index() - history.size() &amp;&amp; idx &lt;= history.index()) {
136                                         rep = history.get(idx - 1);
137                                     } else {
138                                         throw new IllegalArgumentException((neg ? &quot;!-&quot; : &quot;!&quot;) + line.substring(i1, i) + &quot;: event not found&quot;);
139                                     }
140                                     break;
141                                 default:
142                                     String ss = line.substring(i);
143                                     i = line.length();
144                                     idx = searchBackwards(history, ss, history.index(), true);
145                                     if (idx &lt; 0) {
146                                         throw new IllegalArgumentException(&quot;!&quot; + ss + &quot;: event not found&quot;);
147                                     } else {
148                                         rep = history.get(idx);
149                                     }
150                                     break;
151                             }
152                             if (rep != null) {
153                                 sb.append(rep);
154                             }
155                         } else {
156                             sb.append(c);
157                         }
158                         break;
159                     case &#39;^&#39;:
160                         if (i == 0) {
161                             int i1 = line.indexOf(&#39;^&#39;, i + 1);
162                             int i2 = line.indexOf(&#39;^&#39;, i1 + 1);
163                             if (i2 &lt; 0) {
164                                 i2 = line.length();
165                             }
166                             if (i1 &gt; 0 &amp;&amp; i2 &gt; 0) {
167                                 String s1 = line.substring(i + 1, i1);
168                                 String s2 = line.substring(i1 + 1, i2);
169                                 String s = history.get(history.index() - 1).replace(s1, s2);
170                                 sb.append(s);
171                                 i = i2 + 1;
172                                 break;
173                             }
174                         }
175                         sb.append(c);
176                         break;
177                     default:
178                         sb.append(c);
179                         break;
180                 }
181             }
182         }
183         return sb.toString();
184     }
185 
186     @Override
187     public String expandVar(String word) {
188         return word;
189     }
190 
191     protected int searchBackwards(History history, String searchTerm, int startIndex, boolean startsWith) {
192         ListIterator&lt;Entry&gt; it = history.iterator(startIndex);
193         while (it.hasPrevious()) {
194             History.Entry e = it.previous();
195             if (startsWith) {
196                 if (e.line().startsWith(searchTerm)) {
197                     return e.index();
198                 }
199             } else {
200                 if (e.line().contains(searchTerm)) {
201                     return e.index();
202                 }
203             }
204         }
205         return -1;
206     }
207 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>