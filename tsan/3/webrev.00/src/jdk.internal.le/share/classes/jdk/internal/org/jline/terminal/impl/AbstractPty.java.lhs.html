<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.le/share/classes/jdk/internal/org/jline/terminal/impl/AbstractPty.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre><a name="1" id="anc1"></a>







 1 package jdk.internal.org.jline.terminal.impl;
 2 
 3 import jdk.internal.org.jline.terminal.Attributes;
 4 import jdk.internal.org.jline.terminal.spi.Pty;
 5 import jdk.internal.org.jline.utils.NonBlockingInputStream;
 6 
 7 import java.io.IOError;
 8 import java.io.IOException;
 9 import java.io.InputStream;
10 import java.io.InterruptedIOException;
11 
12 import static jdk.internal.org.jline.terminal.TerminalBuilder.PROP_NON_BLOCKING_READS;
13 
14 public abstract class AbstractPty implements Pty {
15 
16     private Attributes current;
17 
18     @Override
19     public void setAttr(Attributes attr) throws IOException {
20         current = new Attributes(attr);
21         doSetAttr(attr);
22     }
23 
24     @Override
25     public InputStream getSlaveInput() throws IOException {
26         InputStream si = doGetSlaveInput();
27         if (Boolean.parseBoolean(System.getProperty(PROP_NON_BLOCKING_READS, &quot;true&quot;))) {
28             return new PtyInputStream(si);
29         } else {
30             return si;
31         }
32     }
33 
34     protected abstract void doSetAttr(Attributes attr) throws IOException;
35 
36     protected abstract InputStream doGetSlaveInput() throws IOException;
37 
38     protected void checkInterrupted() throws InterruptedIOException {
39         if (Thread.interrupted()) {
40             throw new InterruptedIOException();
41         }
42     }
43 
44     class PtyInputStream extends NonBlockingInputStream {
45         final InputStream in;
46         int c = 0;
47 
48         PtyInputStream(InputStream in) {
49             this.in = in;
50         }
51 
52         @Override
53         public int read(long timeout, boolean isPeek) throws IOException {
54             checkInterrupted();
55             if (c != 0) {
56                 int r = c;
57                 if (!isPeek) {
58                     c = 0;
59                 }
60                 return r;
61             } else {
62                 setNonBlocking();
63                 long start = System.currentTimeMillis();
64                 while (true) {
65                     int r = in.read();
66                     if (r &gt;= 0) {
67                         if (isPeek) {
68                             c = r;
69                         }
70                         return r;
71                     }
72                     checkInterrupted();
73                     long cur = System.currentTimeMillis();
74                     if (timeout &gt; 0 &amp;&amp; cur - start &gt; timeout) {
75                         return NonBlockingInputStream.READ_EXPIRED;
76                     }
77                 }
78             }
79         }
80 
81         private void setNonBlocking() {
82             if (current == null
83                     || current.getControlChar(Attributes.ControlChar.VMIN) != 0
84                     || current.getControlChar(Attributes.ControlChar.VTIME) != 1) {
85                 try {
86                     Attributes attr = getAttr();
87                     attr.setControlChar(Attributes.ControlChar.VMIN, 0);
88                     attr.setControlChar(Attributes.ControlChar.VTIME, 1);
89                     setAttr(attr);
90                 } catch (IOException e) {
91                     throw new IOError(e);
92                 }
93             }
94         }
95     }
96 
97 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>