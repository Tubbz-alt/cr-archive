<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.le/share/classes/jdk/internal/org/jline/utils/Signals.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2002-2016, the original author or authors.
  3  *
  4  * This software is distributable under the BSD license. See the terms of the
  5  * BSD license in the documentation provided with this software.
  6  *
<a name="1" id="anc1"></a><span class="line-modified">  7  * http://www.opensource.org/licenses/bsd-license.php</span>
  8  */
  9 package jdk.internal.org.jline.utils;
 10 
<a name="2" id="anc2"></a>
 11 import java.lang.reflect.Proxy;
 12 import java.util.Objects;
 13 
 14 /**
 15  * Signals helpers.
 16  *
 17  * @author &lt;a href=&quot;mailto:gnodet@gmail.com&quot;&gt;Guillaume Nodet&lt;/a&gt;
 18  * @since 3.0
 19  */
 20 public final class Signals {
 21 
 22     private Signals() {
 23     }
 24 
 25     /**
 26      *
 27      * @param name the signal, CONT, STOP, etc...
 28      * @param handler the callback to run
 29      *
 30      * @return an object that needs to be passed to the {@link #unregister(String, Object)}
 31      *         method to unregister the handler
 32      */
 33     public static Object register(String name, Runnable handler) {
 34         Objects.requireNonNull(handler);
 35         return register(name, handler, handler.getClass().getClassLoader());
 36     }
 37 
 38     public static Object register(String name, final Runnable handler, ClassLoader loader) {
 39         try {
 40             Class&lt;?&gt; signalHandlerClass = Class.forName(&quot;sun.misc.SignalHandler&quot;);
 41             // Implement signal handler
 42             Object signalHandler = Proxy.newProxyInstance(loader,
 43                     new Class&lt;?&gt;[]{signalHandlerClass}, (proxy, method, args) -&gt; {
 44                         // only method we are proxying is handle()
 45                         if (method.getDeclaringClass() == Object.class) {
 46                             if (&quot;toString&quot;.equals(method.getName())) {
 47                                 return handler.toString();
 48                             }
 49                         } else if (method.getDeclaringClass() == signalHandlerClass) {
 50                             Log.trace(() -&gt; &quot;Calling handler &quot; + toString(handler) + &quot; for signal &quot; + name);
 51                             handler.run();
 52                         }
 53                         return null;
 54                     });
 55             return doRegister(name, signalHandler);
 56         } catch (Exception e) {
 57             // Ignore this one too, if the above failed, the signal API is incompatible with what we&#39;re expecting
 58             Log.debug(&quot;Error registering handler for signal &quot;, name, e);
 59             return null;
 60         }
 61     }
 62 
 63     public static Object registerDefault(String name) {
 64         try {
 65             Class&lt;?&gt; signalHandlerClass = Class.forName(&quot;sun.misc.SignalHandler&quot;);
 66             return doRegister(name, signalHandlerClass.getField(&quot;SIG_DFL&quot;).get(null));
 67         } catch (Exception e) {
 68             // Ignore this one too, if the above failed, the signal API is incompatible with what we&#39;re expecting
 69             Log.debug(&quot;Error registering default handler for signal &quot;, name, e);
 70             return null;
 71         }
 72     }
 73 
 74     public static void unregister(String name, Object previous) {
 75         try {
 76             // We should make sure the current signal is the one we registered
 77             if (previous != null) {
 78                 doRegister(name, previous);
 79             }
 80         } catch (Exception e) {
 81             // Ignore
 82             Log.debug(&quot;Error unregistering handler for signal &quot;, name, e);
 83         }
 84     }
 85 
 86     private static Object doRegister(String name, Object handler) throws Exception {
 87         Log.trace(() -&gt; &quot;Registering signal &quot; + name + &quot; with handler &quot; + toString(handler));
<a name="3" id="anc3"></a><span class="line-modified"> 88         if (&quot;QUIT&quot;.equals(name) || &quot;INFO&quot;.equals(name) &amp;&amp; &quot;9&quot;.equals(System.getProperty(&quot;java.specification.version&quot;))) {</span>





 89             Log.trace(() -&gt; &quot;Ignoring unsupported signal &quot; + name);
 90             return null;
 91         }
<a name="4" id="anc4"></a><span class="line-removed"> 92         Class&lt;?&gt; signalClass = Class.forName(&quot;sun.misc.Signal&quot;);</span>
 93         Class&lt;?&gt; signalHandlerClass = Class.forName(&quot;sun.misc.SignalHandler&quot;);
<a name="5" id="anc5"></a><span class="line-removed"> 94         Object signal = signalClass.getConstructor(String.class).newInstance(name);</span>
 95         return signalClass.getMethod(&quot;handle&quot;, signalClass, signalHandlerClass)
 96                 .invoke(null, signal, handler);
 97     }
 98 
 99     @SuppressWarnings(&quot;&quot;)
100     private static String toString(Object handler) {
101         try {
102             Class&lt;?&gt; signalHandlerClass = Class.forName(&quot;sun.misc.SignalHandler&quot;);
103             if (handler == signalHandlerClass.getField(&quot;SIG_DFL&quot;).get(null)) {
104                 return &quot;SIG_DFL&quot;;
105             }
106             if (handler == signalHandlerClass.getField(&quot;SIG_IGN&quot;).get(null)) {
107                 return &quot;SIG_IGN&quot;;
108             }
109         } catch (Throwable t) {
110             // ignore
111         }
112         return handler != null ? handler.toString() : &quot;null&quot;;
113     }
114 
115 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>