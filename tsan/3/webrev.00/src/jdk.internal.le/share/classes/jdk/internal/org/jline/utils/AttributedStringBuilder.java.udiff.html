<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.le/share/classes/jdk/internal/org/jline/utils/AttributedStringBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AttributedString.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="AttributedStyle.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.le/share/classes/jdk/internal/org/jline/utils/AttributedStringBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -2,15 +2,17 @@</span>
   * Copyright (c) 2002-2018, the original author or authors.
   *
   * This software is distributable under the BSD license. See the terms of the
   * BSD license in the documentation provided with this software.
   *
<span class="udiff-line-modified-removed">-  * http://www.opensource.org/licenses/bsd-license.php</span>
<span class="udiff-line-modified-added">+  * https://opensource.org/licenses/BSD-3-Clause</span>
   */
  package jdk.internal.org.jline.utils;
  
<span class="udiff-line-added">+ import java.util.ArrayList;</span>
  import java.util.Arrays;
<span class="udiff-line-added">+ import java.util.List;</span>
  import java.util.function.Consumer;
  import java.util.function.Function;
  import java.util.regex.Matcher;
  import java.util.regex.Pattern;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,11 +24,11 @@</span>
  public class AttributedStringBuilder extends AttributedCharSequence implements Appendable {
  
      private char[] buffer;
      private int[] style;
      private int length;
<span class="udiff-line-modified-removed">-     private int tabs = 0;</span>
<span class="udiff-line-modified-added">+     private TabStops tabs = new TabStops(0);</span>
      private int lastLineLength = 0;
      private AttributedStyle current = AttributedStyle.DEFAULT;
  
      public static AttributedString append(CharSequence... strings) {
          AttributedStringBuilder sb = new AttributedStringBuilder();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -149,11 +151,11 @@</span>
      public AttributedStringBuilder append(AttributedCharSequence str, int start, int end) {
          ensureCapacity(length + end - start);
          for (int i = start; i &lt; end; i++) {
              char c = str.charAt(i);
              int s = str.styleCodeAt(i) &amp; ~current.getMask() | current.getStyle();
<span class="udiff-line-modified-removed">-             if (tabs &gt; 0 &amp;&amp; c == &#39;\t&#39;) {</span>
<span class="udiff-line-modified-added">+             if (tabs.defined() &amp;&amp; c == &#39;\t&#39;) {</span>
                  insertTab(new AttributedStyle(s, 0));
              } else {
                  ensureCapacity(length + 1);
                  buffer[length] = c;
                  style[length] = s;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -330,11 +332,11 @@</span>
                      ansiState = 0;
                  } else if (!(c &gt;= &#39;0&#39; &amp;&amp; c &lt;= &#39;9&#39; || c == &#39;;&#39;)) {
                      // This is not a SGR code, so ignore
                      ansiState = 0;
                  }
<span class="udiff-line-modified-removed">-             } else if (c == &#39;\t&#39; &amp;&amp; tabs &gt; 0) {</span>
<span class="udiff-line-modified-added">+             } else if (c == &#39;\t&#39; &amp;&amp; tabs.defined()) {</span>
                  insertTab(current);
              } else {
                  ensureCapacity(length + 1);
                  buffer[length] = c;
                  style[length] = this.current.getStyle();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -348,11 +350,11 @@</span>
          }
          return this;
      }
  
      protected void insertTab(AttributedStyle s) {
<span class="udiff-line-modified-removed">-         int nb = tabs - lastLineLength % tabs;</span>
<span class="udiff-line-modified-added">+         int nb = tabs.spaces(lastLineLength);</span>
          ensureCapacity(length + nb);
          for (int i = 0; i &lt; nb; i++) {
              buffer[length] = &#39; &#39;;
              style[length] = s.getStyle();
              length++;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -371,17 +373,21 @@</span>
       * If tab size is set to 0, tabs are not expanded (the default).
       * @param tabsize Spaces per tab or 0 for no tab expansion. Must be non-negative
       * @return this
       */
      public AttributedStringBuilder tabs(int tabsize) {
<span class="udiff-line-removed">-         if (length &gt; 0) {</span>
<span class="udiff-line-removed">-             throw new IllegalStateException(&quot;Cannot change tab size after appending text&quot;);</span>
<span class="udiff-line-removed">-         }</span>
          if (tabsize &lt; 0) {
              throw new IllegalArgumentException(&quot;Tab size must be non negative&quot;);
          }
<span class="udiff-line-modified-removed">-         this.tabs = tabsize;</span>
<span class="udiff-line-modified-added">+         return tabs(Arrays.asList(tabsize));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public AttributedStringBuilder tabs(List&lt;Integer&gt; tabs) {</span>
<span class="udiff-line-added">+         if (length &gt; 0) {</span>
<span class="udiff-line-added">+             throw new IllegalStateException(&quot;Cannot change tab size after appending text&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         this.tabs = new TabStops(tabs);</span>
          return this;
      }
  
      public AttributedStringBuilder styleMatches(Pattern pattern, AttributedStyle s) {
          Matcher matcher = pattern.matcher(this);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -391,6 +397,62 @@</span>
              }
          }
          return this;
      }
  
<span class="udiff-line-added">+     public AttributedStringBuilder styleMatches(Pattern pattern, List&lt;AttributedStyle&gt; styles) {</span>
<span class="udiff-line-added">+         Matcher matcher = pattern.matcher(this);</span>
<span class="udiff-line-added">+         while (matcher.find()) {</span>
<span class="udiff-line-added">+             for (int group = 0; group &lt; matcher.groupCount(); group++) {</span>
<span class="udiff-line-added">+                 AttributedStyle s = styles.get(group);</span>
<span class="udiff-line-added">+                 for (int i = matcher.start(group + 1); i &lt; matcher.end(group + 1); i++) {</span>
<span class="udiff-line-added">+                     style[i] = (style[i] &amp; ~s.getMask()) | s.getStyle();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return this;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private class TabStops {</span>
<span class="udiff-line-added">+         private List&lt;Integer&gt; tabs = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-added">+         private int lastStop = 0;</span>
<span class="udiff-line-added">+         private int lastSize = 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public TabStops(int tabs) {</span>
<span class="udiff-line-added">+             this.lastSize = tabs;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public TabStops(List&lt;Integer&gt; tabs) {</span>
<span class="udiff-line-added">+             this.tabs = tabs;</span>
<span class="udiff-line-added">+             int p = 0;</span>
<span class="udiff-line-added">+             for (int s: tabs) {</span>
<span class="udiff-line-added">+                 if (s &lt;= p) {</span>
<span class="udiff-line-added">+                     continue;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 lastStop = s;</span>
<span class="udiff-line-added">+                 lastSize = s - p;</span>
<span class="udiff-line-added">+                 p = s;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         boolean defined() {</span>
<span class="udiff-line-added">+             return lastSize &gt; 0;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         int spaces(int lastLineLength) {</span>
<span class="udiff-line-added">+             int out = 0;</span>
<span class="udiff-line-added">+             if (lastLineLength &gt;= lastStop) {</span>
<span class="udiff-line-added">+                 out = lastSize - (lastLineLength - lastStop) % lastSize;</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 for (int s: tabs) {</span>
<span class="udiff-line-added">+                     if (s &gt; lastLineLength) {</span>
<span class="udiff-line-added">+                         out = s - lastLineLength;</span>
<span class="udiff-line-added">+                         break;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return out;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
  }
</pre>
<center><a href="AttributedString.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="AttributedStyle.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>