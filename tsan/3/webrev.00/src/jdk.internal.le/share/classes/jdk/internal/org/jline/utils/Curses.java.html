<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.internal.le/share/classes/jdk/internal/org/jline/utils/Curses.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2002-2018, the original author or authors.
  3  *
  4  * This software is distributable under the BSD license. See the terms of the
  5  * BSD license in the documentation provided with this software.
  6  *
  7  * https://opensource.org/licenses/BSD-3-Clause
  8  */
  9 package jdk.internal.org.jline.utils;
 10 
 11 import java.io.Flushable;
 12 import java.io.IOError;
 13 import java.io.IOException;
 14 import java.io.StringWriter;
 15 import java.util.Stack;
 16 
 17 /**
 18  * Curses helper methods.
 19  *
 20  * @author &lt;a href=&quot;mailto:gnodet@gmail.com&quot;&gt;Guillaume Nodet&lt;/a&gt;
 21  */
 22 public final class Curses {
 23 
 24     private static Object[] sv = new Object[26];
 25     private static Object[] dv = new Object[26];
 26 
 27     private static final int IFTE_NONE = 0;
 28     private static final int IFTE_IF = 1;
 29     private static final int IFTE_THEN = 2;
 30     private static final int IFTE_ELSE = 3;
 31 
 32     private Curses() {
 33     }
 34 
 35     /**
 36      * Print the given terminal capabilities
 37      *
 38      * @param cap the capability to output
 39      * @param params optional parameters
 40      * @return the result string
 41      */
 42     public static String tputs(String cap, Object... params) {
 43         if (cap != null) {
 44             StringWriter sw = new StringWriter();
 45             tputs(sw, cap, params);
 46             return sw.toString();
 47         }
 48         return null;
 49     }
 50 
 51     /**
 52      * Print the given terminal capabilities
 53      *
 54      * @param out the output stream
 55      * @param str the capability to output
 56      * @param params optional parameters
 57      */
 58     public static void tputs(Appendable out, String str, Object... params) {
 59         try {
 60             doTputs(out, str, params);
 61         } catch (Exception e) {
 62             throw new IOError(e);
 63         }
 64     }
 65 
 66     private static void doTputs(Appendable out, String str, Object... params) throws IOException {
 67         int index = 0;
 68         int length = str.length();
 69         int ifte = IFTE_NONE;
 70         boolean exec = true;
 71         Stack&lt;Object&gt; stack = new Stack&lt;&gt;();
 72         while (index &lt; length) {
 73             char ch = str.charAt(index++);
 74             switch (ch) {
 75                 case &#39;\\&#39;:
 76                     ch = str.charAt(index++);
 77                     if (ch &gt;= &#39;0&#39; &amp;&amp; ch &lt;= &#39;7&#39;) {
 78                         int val = ch - &#39;0&#39;;
 79                         for (int i = 0; i &lt; 2; i++) {
 80                             ch = str.charAt(index++);
 81                             if (ch &lt; &#39;0&#39; || ch &gt; &#39;7&#39;) {
 82                                 throw new IllegalStateException();
 83                             }
 84                             val = val * 8 + (ch - &#39;0&#39;);
 85                         }
 86                         out.append((char) val);
 87                     } else {
 88                         switch (ch) {
 89                             case &#39;e&#39;:
 90                             case &#39;E&#39;:
 91                                 if (exec) {
 92                                     out.append((char) 27); // escape
 93                                 }
 94                                 break;
 95                             case &#39;n&#39;:
 96                                 out.append(&#39;\n&#39;);
 97                                 break;
 98 //                        case &#39;l&#39;:
 99 //                            rawPrint(&#39;\l&#39;);
100 //                            break;
101                             case &#39;r&#39;:
102                                 if (exec) {
103                                     out.append(&#39;\r&#39;);
104                                 }
105                                 break;
106                             case &#39;t&#39;:
107                                 if (exec) {
108                                     out.append(&#39;\t&#39;);
109                                 }
110                                 break;
111                             case &#39;b&#39;:
112                                 if (exec) {
113                                     out.append(&#39;\b&#39;);
114                                 }
115                                 break;
116                             case &#39;f&#39;:
117                                 if (exec) {
118                                     out.append(&#39;\f&#39;);
119                                 }
120                                 break;
121                             case &#39;s&#39;:
122                                 if (exec) {
123                                     out.append(&#39; &#39;);
124                                 }
125                                 break;
126                             case &#39;:&#39;:
127                             case &#39;^&#39;:
128                             case &#39;\\&#39;:
129                                 if (exec) {
130                                     out.append(ch);
131                                 }
132                                 break;
133                             default:
134                                 throw new IllegalArgumentException();
135                         }
136                     }
137                     break;
138                 case &#39;^&#39;:
139                     ch = str.charAt(index++);
140                     if (exec) {
141                         out.append((char)(ch - &#39;@&#39;));
142                     }
143                     break;
144                 case &#39;%&#39;:
145                     ch = str.charAt(index++);
146                     switch (ch) {
147                         case &#39;%&#39;:
148                             if (exec) {
149                                 out.append(&#39;%&#39;);
150                             }
151                             break;
152                         case &#39;p&#39;:
153                             ch = str.charAt(index++);
154                             if (exec) {
155                                 stack.push(params[ch - &#39;1&#39;]);
156                             }
157                             break;
158                         case &#39;P&#39;:
159                             ch = str.charAt(index++);
160                             if (ch &gt;= &#39;a&#39; &amp;&amp; ch &lt;= &#39;z&#39;) {
161                                 if (exec) {
162                                     dv[ch - &#39;a&#39;] = stack.pop();
163                                 }
164                             } else if (ch &gt;= &#39;A&#39; &amp;&amp; ch &lt;= &#39;Z&#39;) {
165                                 if (exec) {
166                                     sv[ch - &#39;A&#39;] = stack.pop();
167                                 }
168                             } else {
169                                 throw new IllegalArgumentException();
170                             }
171                             break;
172                         case &#39;g&#39;:
173                             ch = str.charAt(index++);
174                             if (ch &gt;= &#39;a&#39; &amp;&amp; ch &lt;= &#39;z&#39;) {
175                                 if (exec) {
176                                     stack.push(dv[ch - &#39;a&#39;]);
177                                 }
178                             } else if (ch &gt;= &#39;A&#39; &amp;&amp; ch &lt;= &#39;Z&#39;) {
179                                 if (exec) {
180                                     stack.push(sv[ch - &#39;A&#39;]);
181                                 }
182                             } else {
183                                 throw new IllegalArgumentException();
184                             }
185                             break;
186                         case &#39;\&#39;&#39;:
187                             ch = str.charAt(index++);
188                             if (exec) {
189                                 stack.push((int) ch);
190                             }
191                             ch = str.charAt(index++);
192                             if (ch != &#39;\&#39;&#39;) {
193                                 throw new IllegalArgumentException();
194                             }
195                             break;
196                         case &#39;{&#39;:
197                             int start = index;
198                             while (str.charAt(index++) != &#39;}&#39;) ;
199                             if (exec) {
200                                 int v = Integer.valueOf(str.substring(start, index - 1));
201                                 stack.push(v);
202                             }
203                             break;
204                         case &#39;l&#39;:
205                             if (exec) {
206                                 stack.push(stack.pop().toString().length());
207                             }
208                             break;
209                         case &#39;+&#39;:
210                             if (exec) {
211                                 int v2 = toInteger(stack.pop());
212                                 int v1 = toInteger(stack.pop());
213                                 stack.push(v1 + v2);
214                             }
215                             break;
216                         case &#39;-&#39;:
217                             if (exec) {
218                                 int v2 = toInteger(stack.pop());
219                                 int v1 = toInteger(stack.pop());
220                                 stack.push(v1 - v2);
221                             }
222                             break;
223                         case &#39;*&#39;:
224                             if (exec) {
225                                 int v2 = toInteger(stack.pop());
226                                 int v1 = toInteger(stack.pop());
227                                 stack.push(v1 * v2);
228                             }
229                             break;
230                         case &#39;/&#39;:
231                             if (exec) {
232                                 int v2 = toInteger(stack.pop());
233                                 int v1 = toInteger(stack.pop());
234                                 stack.push(v1 / v2);
235                             }
236                             break;
237                         case &#39;m&#39;:
238                             if (exec) {
239                                 int v2 = toInteger(stack.pop());
240                                 int v1 = toInteger(stack.pop());
241                                 stack.push(v1 % v2);
242                             }
243                             break;
244                         case &#39;&amp;&#39;:
245                             if (exec) {
246                                 int v2 = toInteger(stack.pop());
247                                 int v1 = toInteger(stack.pop());
248                                 stack.push(v1 &amp; v2);
249                             }
250                             break;
251                         case &#39;|&#39;:
252                             if (exec) {
253                                 int v2 = toInteger(stack.pop());
254                                 int v1 = toInteger(stack.pop());
255                                 stack.push(v1 | v2);
256                             }
257                             break;
258                         case &#39;^&#39;:
259                             if (exec) {
260                                 int v2 = toInteger(stack.pop());
261                                 int v1 = toInteger(stack.pop());
262                                 stack.push(v1 ^ v2);
263                             }
264                             break;
265                         case &#39;=&#39;:
266                             if (exec) {
267                                 int v2 = toInteger(stack.pop());
268                                 int v1 = toInteger(stack.pop());
269                                 stack.push(v1 == v2);
270                             }
271                             break;
272                         case &#39;&gt;&#39;:
273                             if (exec) {
274                                 int v2 = toInteger(stack.pop());
275                                 int v1 = toInteger(stack.pop());
276                                 stack.push(v1 &gt; v2);
277                             }
278                             break;
279                         case &#39;&lt;&#39;:
280                             if (exec) {
281                                 int v2 = toInteger(stack.pop());
282                                 int v1 = toInteger(stack.pop());
283                                 stack.push(v1 &lt; v2);
284                             }
285                             break;
286                         case &#39;A&#39;:
287                             if (exec) {
288                                 int v2 = toInteger(stack.pop());
289                                 int v1 = toInteger(stack.pop());
290                                 stack.push(v1 != 0 &amp;&amp; v2 != 0);
291                             }
292                             break;
293                         case &#39;!&#39;:
294                             if (exec) {
295                                 int v1 = toInteger(stack.pop());
296                                 stack.push(v1 == 0);
297                             }
298                             break;
299                         case &#39;~&#39;:
300                             if (exec) {
301                                 int v1 = toInteger(stack.pop());
302                                 stack.push(~v1);
303                             }
304                             break;
305                         case &#39;O&#39;:
306                             if (exec) {
307                                 int v2 = toInteger(stack.pop());
308                                 int v1 = toInteger(stack.pop());
309                                 stack.push(v1 != 0 || v2 != 0);
310                             }
311                             break;
312                         case &#39;?&#39;:
313                             if (ifte != IFTE_NONE) {
314                                 throw new IllegalArgumentException();
315                             } else {
316                                 ifte = IFTE_IF;
317                             }
318                             break;
319                         case &#39;t&#39;:
320                             if (ifte != IFTE_IF &amp;&amp; ifte != IFTE_ELSE) {
321                                 throw new IllegalArgumentException();
322                             } else {
323                                 ifte = IFTE_THEN;
324                             }
325                             exec = toInteger(stack.pop()) != 0;
326                             break;
327                         case &#39;e&#39;:
328                             if (ifte != IFTE_THEN) {
329                                 throw new IllegalArgumentException();
330                             } else {
331                                 ifte = IFTE_ELSE;
332                             }
333                             exec = !exec;
334                             break;
335                         case &#39;;&#39;:
336                             if (ifte == IFTE_NONE || ifte == IFTE_IF) {
337                                 throw new IllegalArgumentException();
338                             } else {
339                                 ifte = IFTE_NONE;
340                             }
341                             exec = true;
342                             break;
343                         case &#39;i&#39;:
344                             if (params.length &gt;= 1) {
345                                 params[0] = toInteger(params[0]) + 1;
346                             }
347                             if (params.length &gt;= 2) {
348                                 params[1] = toInteger(params[1]) + 1;
349                             }
350                             break;
351                         case &#39;d&#39;:
352                             out.append(Integer.toString(toInteger(stack.pop())));
353                             break;
354                         default:
355                             throw new UnsupportedOperationException();
356                     }
357                     break;
358                 case &#39;$&#39;:
359                     if (str.charAt(index) == &#39;&lt;&#39;) {
360                         // We don&#39;t honour delays, just skip
361                         int nb = 0;
362                         while ((ch = str.charAt(++index)) != &#39;&gt;&#39;) {
363                             if (ch &gt;= &#39;0&#39; &amp;&amp; ch &lt;= &#39;9&#39;) {
364                                 nb = nb * 10 + (ch - &#39;0&#39;);
365                             } else if (ch == &#39;*&#39;) {
366                                 // ignore
367                             } else if (ch == &#39;/&#39;) {
368                                 // ignore
369                             } else {
370                                 // illegal, but ...
371                             }
372                         }
373                         index++;
374                         try {
375                             if (out instanceof Flushable) {
376                                 ((Flushable) out).flush();
377                             }
378                             Thread.sleep(nb);
379                         } catch (InterruptedException e) {
380                         }
381                     } else {
382                         if (exec) {
383                             out.append(ch);
384                         }
385                     }
386                     break;
387                 default:
388                     if (exec) {
389                         out.append(ch);
390                     }
391                     break;
392             }
393         }
394     }
395 
396     private static int toInteger(Object pop) {
397         if (pop instanceof Number) {
398             return ((Number) pop).intValue();
399         } else if (pop instanceof Boolean) {
400             return (Boolean) pop ? 1 : 0;
401         } else {
402             return Integer.valueOf(pop.toString());
403         }
404     }
405 
406 }
    </pre>
  </body>
</html>