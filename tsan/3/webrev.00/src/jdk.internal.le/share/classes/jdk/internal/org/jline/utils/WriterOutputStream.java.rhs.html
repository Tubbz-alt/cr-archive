<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.le/share/classes/jdk/internal/org/jline/utils/WriterOutputStream.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2002-2017, the original author or authors.
  3  *
  4  * This software is distributable under the BSD license. See the terms of the
  5  * BSD license in the documentation provided with this software.
  6  *
<a name="1" id="anc1"></a><span class="line-modified">  7  * https://opensource.org/licenses/BSD-3-Clause</span>
  8  */
  9 package jdk.internal.org.jline.utils;
 10 
 11 import java.io.IOException;
 12 import java.io.OutputStream;
 13 import java.io.Writer;
 14 import java.nio.ByteBuffer;
 15 import java.nio.CharBuffer;
 16 import java.nio.charset.Charset;
 17 import java.nio.charset.CharsetDecoder;
 18 import java.nio.charset.CoderResult;
 19 import java.nio.charset.CodingErrorAction;
 20 
 21 /**
 22  * Redirects an {@link OutputStream} to a {@link Writer} by decoding the data
 23  * using the specified {@link Charset}.
 24  *
 25  * &lt;p&gt;&lt;b&gt;Note:&lt;/b&gt; This class should only be used if it is necessary to
 26  * redirect an {@link OutputStream} to a {@link Writer} for compatibility
 27  * purposes. It is much more efficient to write to the {@link Writer}
 28  * directly.&lt;/p&gt;
 29  */
 30 public class WriterOutputStream extends OutputStream {
 31 
 32     private final Writer out;
 33     private final CharsetDecoder decoder;
 34     private final ByteBuffer decoderIn = ByteBuffer.allocate(256);
 35     private final CharBuffer decoderOut = CharBuffer.allocate(128);
 36 
 37     public WriterOutputStream(Writer out, Charset charset) {
 38         this(out, charset.newDecoder()
 39                 .onMalformedInput(CodingErrorAction.REPLACE)
 40                 .onUnmappableCharacter(CodingErrorAction.REPLACE));
 41     }
 42 
 43     public WriterOutputStream(Writer out, CharsetDecoder decoder) {
 44         this.out = out;
 45         this.decoder = decoder;
 46     }
 47 
 48     @Override
 49     public void write(int b) throws IOException {
 50         write(new byte[] { (byte)b }, 0, 1);
 51     }
 52 
 53     @Override
 54     public void write(byte[] b) throws IOException {
 55         write(b, 0, b.length);
 56     }
 57 
 58     @Override
 59     public void write(byte[] b, int off, int len) throws IOException {
 60         while (len &gt; 0) {
 61             final int c = Math.min(len, decoderIn.remaining());
 62             decoderIn.put(b, off, c);
 63             processInput(false);
 64             len -= c;
 65             off += c;
 66         }
 67         flush();
 68     }
 69 
 70     @Override
 71     public void flush() throws IOException {
 72         flushOutput();
 73         out.flush();
 74     }
 75 
 76     @Override
 77     public void close() throws IOException {
 78         processInput(true);
 79         flush();
 80         out.close();
 81     }
 82 
 83     /**
 84      * Decode the contents of the input ByteBuffer into a CharBuffer.
 85      *
 86      * @param endOfInput indicates end of input
 87      * @throws IOException if an I/O error occurs
 88      */
 89     private void processInput(final boolean endOfInput) throws IOException {
 90         // Prepare decoderIn for reading
 91         decoderIn.flip();
 92         CoderResult coderResult;
 93         while (true) {
 94             coderResult = decoder.decode(decoderIn, decoderOut, endOfInput);
 95             if (coderResult.isOverflow()) {
 96                 flushOutput();
 97             } else if (coderResult.isUnderflow()) {
 98                 break;
 99             } else {
100                 // The decoder is configured to replace malformed input and unmappable characters,
101                 // so we should not get here.
102                 throw new IOException(&quot;Unexpected coder result&quot;);
103             }
104         }
105         // Discard the bytes that have been read
106         decoderIn.compact();
107     }
108 
109     /**
110      * Flush the output.
111      *
112      * @throws IOException if an I/O error occurs
113      */
114     private void flushOutput() throws IOException {
115         if (decoderOut.position() &gt; 0) {
116             out.write(decoderOut.array(), 0, decoderOut.position());
117             decoderOut.rewind();
118         }
119     }
120 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>