<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.le/share/classes/jdk/internal/org/jline/reader/impl/DefaultParser.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DefaultHighlighter.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="KillRing.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.le/share/classes/jdk/internal/org/jline/reader/impl/DefaultParser.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 2,11 ***</span>
   * Copyright (c) 2002-2018, the original author or authors.
   *
   * This software is distributable under the BSD license. See the terms of the
   * BSD license in the documentation provided with this software.
   *
<span class="line-modified">!  * http://www.opensource.org/licenses/bsd-license.php</span>
   */
  package jdk.internal.org.jline.reader.impl;
  
  import java.util.*;
  import java.util.function.Predicate;
<span class="line-new-header">--- 2,11 ---</span>
   * Copyright (c) 2002-2018, the original author or authors.
   *
   * This software is distributable under the BSD license. See the terms of the
   * BSD license in the documentation provided with this software.
   *
<span class="line-modified">!  * https://opensource.org/licenses/BSD-3-Clause</span>
   */
  package jdk.internal.org.jline.reader.impl;
  
  import java.util.*;
  import java.util.function.Predicate;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 16,18 ***</span>
<span class="line-new-header">--- 16,29 ---</span>
  import jdk.internal.org.jline.reader.ParsedLine;
  import jdk.internal.org.jline.reader.Parser;
  
  public class DefaultParser implements Parser {
  
<span class="line-added">+     public enum Bracket {</span>
<span class="line-added">+         ROUND,   // ()</span>
<span class="line-added">+         CURLY,   // {}</span>
<span class="line-added">+         SQUARE,  // []</span>
<span class="line-added">+         ANGLE;   // &lt;&gt;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      private char[] quoteChars = {&#39;\&#39;&#39;, &#39;&quot;&#39;};
  
      private char[] escapeChars = {&#39;\\&#39;};
  
      private boolean eofOnUnclosedQuote;
  
      private boolean eofOnEscapedNewLine;
  
<span class="line-added">+     private char[] openingBrackets = null;</span>
<span class="line-added">+ </span>
<span class="line-added">+     private char[] closingBrackets = null;</span>
<span class="line-added">+ </span>
      //
      // Chainable setters
      //
  
      public DefaultParser quoteChars(final char[] chars) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 43,10 ***</span>
<span class="line-new-header">--- 54,15 ---</span>
      public DefaultParser eofOnUnclosedQuote(boolean eofOnUnclosedQuote) {
          this.eofOnUnclosedQuote = eofOnUnclosedQuote;
          return this;
      }
  
<span class="line-added">+     public DefaultParser eofOnUnclosedBracket(Bracket... brackets){</span>
<span class="line-added">+         setEofOnUnclosedBracket(brackets);</span>
<span class="line-added">+         return this;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      public DefaultParser eofOnEscapedNewLine(boolean eofOnEscapedNewLine) {
          this.eofOnEscapedNewLine = eofOnEscapedNewLine;
          return this;
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 84,19 ***</span>
<span class="line-new-header">--- 100,54 ---</span>
  
      public boolean isEofOnEscapedNewLine() {
          return eofOnEscapedNewLine;
      }
  
<span class="line-added">+     public void setEofOnUnclosedBracket(Bracket... brackets){</span>
<span class="line-added">+         if (brackets == null) {</span>
<span class="line-added">+             openingBrackets = null;</span>
<span class="line-added">+             closingBrackets = null;</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             Set&lt;Bracket&gt; bs = new HashSet&lt;&gt;(Arrays.asList(brackets));</span>
<span class="line-added">+             openingBrackets = new char[bs.size()];</span>
<span class="line-added">+             closingBrackets = new char[bs.size()];</span>
<span class="line-added">+             int i = 0;</span>
<span class="line-added">+             for (Bracket b : bs) {</span>
<span class="line-added">+                 switch (b) {</span>
<span class="line-added">+                 case ROUND:</span>
<span class="line-added">+                     openingBrackets[i] = &#39;(&#39;;</span>
<span class="line-added">+                     closingBrackets[i] = &#39;)&#39;;</span>
<span class="line-added">+                     break;</span>
<span class="line-added">+                 case CURLY:</span>
<span class="line-added">+                     openingBrackets[i] = &#39;{&#39;;</span>
<span class="line-added">+                     closingBrackets[i] = &#39;}&#39;;</span>
<span class="line-added">+                     break;</span>
<span class="line-added">+                 case SQUARE:</span>
<span class="line-added">+                     openingBrackets[i] = &#39;[&#39;;</span>
<span class="line-added">+                     closingBrackets[i] = &#39;]&#39;;</span>
<span class="line-added">+                     break;</span>
<span class="line-added">+                 case ANGLE:</span>
<span class="line-added">+                     openingBrackets[i] = &#39;&lt;&#39;;</span>
<span class="line-added">+                     closingBrackets[i] = &#39;&gt;&#39;;</span>
<span class="line-added">+                     break;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 i++;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      public ParsedLine parse(final String line, final int cursor, ParseContext context) {
          List&lt;String&gt; words = new LinkedList&lt;&gt;();
          StringBuilder current = new StringBuilder();
          int wordCursor = -1;
          int wordIndex = -1;
          int quoteStart = -1;
          int rawWordCursor = -1;
          int rawWordLength = -1;
          int rawWordStart = 0;
<span class="line-added">+         BracketChecker bracketChecker = new BracketChecker();</span>
<span class="line-added">+         boolean quotedWord = false;</span>
  
          for (int i = 0; (line != null) &amp;&amp; (i &lt; line.length()); i++) {
              // once we reach the cursor, set the
              // position of the selected index
              if (i == cursor) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 108,40 ***</span>
              }
  
              if (quoteStart &lt; 0 &amp;&amp; isQuoteChar(line, i)) {
                  // Start a quote block
                  quoteStart = i;
<span class="line-modified">!             } else if (quoteStart &gt;= 0) {</span>
<span class="line-modified">!                 // In a quote block</span>
<span class="line-modified">!                 if (line.charAt(quoteStart) == line.charAt(i) &amp;&amp; !isEscaped(line, i)) {</span>
<span class="line-modified">!                     // End the block; arg could be empty, but that&#39;s fine</span>
                      words.add(current.toString());
<span class="line-modified">!                     current.setLength(0);</span>
<span class="line-removed">-                     quoteStart = -1;</span>
                      if (rawWordCursor &gt;= 0 &amp;&amp; rawWordLength &lt; 0) {
<span class="line-modified">!                         rawWordLength = i - rawWordStart + 1;</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     if (!isEscapeChar(line, i)) {</span>
<span class="line-removed">-                         // Take the next character</span>
<span class="line-removed">-                         current.append(line.charAt(i));</span>
                      }
                  }
              } else {
<span class="line-modified">!                 // Not in a quote block</span>
<span class="line-modified">!                 if (isDelimiter(line, i)) {</span>
<span class="line-modified">!                     if (current.length() &gt; 0) {</span>
<span class="line-modified">!                         words.add(current.toString());</span>
<span class="line-removed">-                         current.setLength(0); // reset the arg</span>
<span class="line-removed">-                         if (rawWordCursor &gt;= 0 &amp;&amp; rawWordLength &lt; 0) {</span>
<span class="line-removed">-                             rawWordLength = i - rawWordStart;</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     rawWordStart = i + 1;</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     if (!isEscapeChar(line, i)) {</span>
<span class="line-removed">-                         current.append(line.charAt(i));</span>
                      }
                  }
              }
          }
  
<span class="line-new-header">--- 159,39 ---</span>
              }
  
              if (quoteStart &lt; 0 &amp;&amp; isQuoteChar(line, i)) {
                  // Start a quote block
                  quoteStart = i;
<span class="line-modified">!                 if (current.length()==0) {</span>
<span class="line-modified">!                     quotedWord = true;</span>
<span class="line-modified">!                 } else {</span>
<span class="line-modified">!                     current.append(line.charAt(i));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             } else if (quoteStart &gt;= 0 &amp;&amp; line.charAt(quoteStart) == line.charAt(i) &amp;&amp; !isEscaped(line, i)) {</span>
<span class="line-added">+                 // End quote block</span>
<span class="line-added">+                 if (!quotedWord) {</span>
<span class="line-added">+                     current.append(line.charAt(i));</span>
<span class="line-added">+                 } else if (rawWordCursor &gt;= 0 &amp;&amp; rawWordLength &lt; 0) {</span>
<span class="line-added">+                     rawWordLength = i - rawWordStart + 1;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 quoteStart = -1;</span>
<span class="line-added">+                 quotedWord = false;</span>
<span class="line-added">+             } else if (quoteStart &lt; 0 &amp;&amp; isDelimiter(line, i)) {</span>
<span class="line-added">+                 // Delimiter</span>
<span class="line-added">+                 if (current.length() &gt; 0) {</span>
                      words.add(current.toString());
<span class="line-modified">!                     current.setLength(0); // reset the arg</span>
                      if (rawWordCursor &gt;= 0 &amp;&amp; rawWordLength &lt; 0) {
<span class="line-modified">!                         rawWordLength = i - rawWordStart;</span>
                      }
                  }
<span class="line-added">+                 rawWordStart = i + 1;</span>
              } else {
<span class="line-modified">!                 if (!isEscapeChar(line, i)) {</span>
<span class="line-modified">!                     current.append(line.charAt(i));</span>
<span class="line-modified">!                     if (quoteStart &lt; 0) {</span>
<span class="line-modified">!                         bracketChecker.check(line, i);</span>
                      }
                  }
              }
          }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 157,25 ***</span>
              wordCursor = words.get(words.size() - 1).length();
              rawWordCursor = cursor - rawWordStart;
              rawWordLength = rawWordCursor;
          }
  
<span class="line-modified">!         if (eofOnEscapedNewLine &amp;&amp; isEscapeChar(line, line.length() - 1)) {</span>
<span class="line-modified">!             throw new EOFError(-1, -1, &quot;Escaped new line&quot;, &quot;newline&quot;);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         if (eofOnUnclosedQuote &amp;&amp; quoteStart &gt;= 0 &amp;&amp; context != ParseContext.COMPLETE) {</span>
<span class="line-modified">!             throw new EOFError(-1, -1, &quot;Missing closing quote&quot;, line.charAt(quoteStart) == &#39;\&#39;&#39;</span>
<span class="line-modified">!                     ? &quot;quote&quot; : &quot;dquote&quot;);</span>
          }
  
<span class="line-modified">!         String openingQuote = quoteStart &gt;= 0 ? line.substring(quoteStart, quoteStart + 1) : null;</span>
          return new ArgumentList(line, words, wordIndex, wordCursor, cursor, openingQuote, rawWordCursor, rawWordLength);
      }
  
      /**
       * Returns true if the specified character is a whitespace parameter. Check to ensure that the character is not
<span class="line-modified">!      * escaped by any of {@link #getQuoteChars}, and is not escaped by ant of the {@link #getEscapeChars}, and</span>
       * returns true from {@link #isDelimiterChar}.
       *
       * @param buffer    The complete command buffer
       * @param pos       The index of the character in the buffer
       * @return          True if the character should be a delimiter
<span class="line-new-header">--- 207,33 ---</span>
              wordCursor = words.get(words.size() - 1).length();
              rawWordCursor = cursor - rawWordStart;
              rawWordLength = rawWordCursor;
          }
  
<span class="line-modified">!         if (context != ParseContext.COMPLETE) {</span>
<span class="line-modified">!             if (eofOnEscapedNewLine &amp;&amp; isEscapeChar(line, line.length() - 1)) {</span>
<span class="line-modified">!                 throw new EOFError(-1, -1, &quot;Escaped new line&quot;, &quot;newline&quot;);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             if (eofOnUnclosedQuote &amp;&amp; quoteStart &gt;= 0) {</span>
<span class="line-modified">!                 throw new EOFError(-1, -1, &quot;Missing closing quote&quot;, line.charAt(quoteStart) == &#39;\&#39;&#39;</span>
<span class="line-added">+                         ? &quot;quote&quot; : &quot;dquote&quot;);</span>
<span class="line-added">+             }</span>
<span class="line-added">+             if (bracketChecker.isOpeningBracketMissing()) {</span>
<span class="line-added">+                 throw new EOFError(-1, -1, &quot;Missing opening bracket&quot;, &quot;missing: &quot; + bracketChecker.getMissingOpeningBracket());</span>
<span class="line-added">+             }</span>
<span class="line-added">+             if (bracketChecker.isClosingBracketMissing()) {</span>
<span class="line-added">+                 throw new EOFError(-1, -1, &quot;Missing closing brackets&quot;, &quot;add: &quot; + bracketChecker.getMissingClosingBrackets());</span>
<span class="line-added">+             }</span>
          }
  
<span class="line-modified">!         String openingQuote = quotedWord ? line.substring(quoteStart, quoteStart + 1) : null;</span>
          return new ArgumentList(line, words, wordIndex, wordCursor, cursor, openingQuote, rawWordCursor, rawWordLength);
      }
  
      /**
       * Returns true if the specified character is a whitespace parameter. Check to ensure that the character is not
<span class="line-modified">!      * escaped by any of {@link #getQuoteChars}, and is not escaped by any of the {@link #getEscapeChars}, and</span>
       * returns true from {@link #isDelimiterChar}.
       *
       * @param buffer    The complete command buffer
       * @param pos       The index of the character in the buffer
       * @return          True if the character should be a delimiter
</pre>
<hr />
<pre>
<span class="line-old-header">*** 200,10 ***</span>
<span class="line-new-header">--- 258,22 ---</span>
              }
          }
          return false;
      }
  
<span class="line-added">+     @Override</span>
<span class="line-added">+     public boolean isEscapeChar(char ch) {</span>
<span class="line-added">+         if (escapeChars != null) {</span>
<span class="line-added">+             for (char e : escapeChars) {</span>
<span class="line-added">+                 if (e == ch) {</span>
<span class="line-added">+                     return true;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /**
       * Check if this character is a valid escape char (i.e. one that has not been escaped)
       *
       * @param buffer
       *          the buffer to check in
</pre>
<hr />
<pre>
<span class="line-old-header">*** 214,18 ***</span>
       */
      public boolean isEscapeChar(final CharSequence buffer, final int pos) {
          if (pos &lt; 0) {
              return false;
          }
<span class="line-modified">!         if (escapeChars != null) {</span>
<span class="line-modified">!             for (char e : escapeChars) {</span>
<span class="line-removed">-                 if (e == buffer.charAt(pos)) {</span>
<span class="line-removed">-                     return !isEscaped(buffer, pos);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return false;</span>
      }
  
      /**
       * Check if a character is escaped (i.e. if the previous character is an escape)
       *
<span class="line-new-header">--- 284,12 ---</span>
       */
      public boolean isEscapeChar(final CharSequence buffer, final int pos) {
          if (pos &lt; 0) {
              return false;
          }
<span class="line-modified">!         char ch = buffer.charAt(pos);</span>
<span class="line-modified">!         return isEscapeChar(ch) &amp;&amp; !isEscaped(buffer, pos);</span>
      }
  
      /**
       * Check if a character is escaped (i.e. if the previous character is an escape)
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 243,11 ***</span>
          return isEscapeChar(buffer, pos - 1);
      }
  
      /**
       * Returns true if the character at the specified position if a delimiter. This method will only be called if
<span class="line-modified">!      * the character is not enclosed in any of the {@link #getQuoteChars}, and is not escaped by ant of the</span>
       * {@link #getEscapeChars}. To perform escaping manually, override {@link #isDelimiter} instead.
       *
       * @param buffer
       *          the buffer to check in
       * @param pos
<span class="line-new-header">--- 307,11 ---</span>
          return isEscapeChar(buffer, pos - 1);
      }
  
      /**
       * Returns true if the character at the specified position if a delimiter. This method will only be called if
<span class="line-modified">!      * the character is not enclosed in any of the {@link #getQuoteChars}, and is not escaped by any of the</span>
       * {@link #getEscapeChars}. To perform escaping manually, override {@link #isDelimiter} instead.
       *
       * @param buffer
       *          the buffer to check in
       * @param pos
</pre>
<hr />
<pre>
<span class="line-old-header">*** 278,10 ***</span>
<span class="line-new-header">--- 342,71 ---</span>
              }
          }
          return false;
      }
  
<span class="line-added">+     private class BracketChecker {</span>
<span class="line-added">+         private int missingOpeningBracket = -1;</span>
<span class="line-added">+         private List&lt;Integer&gt; nested = new ArrayList&lt;&gt;();</span>
<span class="line-added">+ </span>
<span class="line-added">+         public BracketChecker(){}</span>
<span class="line-added">+ </span>
<span class="line-added">+         public void check(final CharSequence buffer, final int pos){</span>
<span class="line-added">+             if (openingBrackets == null || pos &lt; 0) {</span>
<span class="line-added">+                 return;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             int bid = bracketId(openingBrackets, buffer, pos);</span>
<span class="line-added">+             if (bid &gt;= 0) {</span>
<span class="line-added">+                 nested.add(bid);</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 bid = bracketId(closingBrackets, buffer, pos);</span>
<span class="line-added">+                 if (bid &gt;= 0) {</span>
<span class="line-added">+                     if (!nested.isEmpty() &amp;&amp; bid == nested.get(nested.size()-1)) {</span>
<span class="line-added">+                         nested.remove(nested.size()-1);</span>
<span class="line-added">+                     } else {</span>
<span class="line-added">+                         missingOpeningBracket = bid;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         public boolean isOpeningBracketMissing(){</span>
<span class="line-added">+             return missingOpeningBracket != -1;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         public String getMissingOpeningBracket(){</span>
<span class="line-added">+             if (!isOpeningBracketMissing()) {</span>
<span class="line-added">+                 return null;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return Character.toString(openingBrackets[missingOpeningBracket]);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         public boolean isClosingBracketMissing(){</span>
<span class="line-added">+             return !nested.isEmpty();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         public String getMissingClosingBrackets(){</span>
<span class="line-added">+             if (!isClosingBracketMissing()) {</span>
<span class="line-added">+                 return null;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             StringBuilder out = new StringBuilder();</span>
<span class="line-added">+             for (int i = nested.size() - 1; i &gt; -1; i--) {</span>
<span class="line-added">+                 out.append(closingBrackets[nested.get(i)]);</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return out.toString();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         private int bracketId(final char[] brackets, final CharSequence buffer, final int pos){</span>
<span class="line-added">+             for (int i=0; i &lt; brackets.length; i++) {</span>
<span class="line-added">+                 if (buffer.charAt(pos) == brackets[i]) {</span>
<span class="line-added">+                     return i;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return -1;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /**
       * The result of a delimited buffer.
       *
       * @author &lt;a href=&quot;mailto:mwp1@cornell.edu&quot;&gt;Marc Prud&#39;hommeaux&lt;/a&gt;
       */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 365,30 ***</span>
          }
  
          public CharSequence escape(CharSequence candidate, boolean complete) {
              StringBuilder sb = new StringBuilder(candidate);
              Predicate&lt;Integer&gt; needToBeEscaped;
<span class="line-modified">!             // Completion is protected by an opening quote:</span>
<span class="line-modified">!             // Delimiters (spaces) don&#39;t need to be escaped, nor do other quotes, but everything else does.</span>
<span class="line-modified">!             // Also, close the quote at the end</span>
<span class="line-modified">!             if (openingQuote != null) {</span>
<span class="line-modified">!                 needToBeEscaped = i -&gt; isRawEscapeChar(sb.charAt(i)) || String.valueOf(sb.charAt(i)).equals(openingQuote);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             // No quote protection, need to escape everything: delimiter chars (spaces), quote chars</span>
<span class="line-modified">!             // and escapes themselves</span>
<span class="line-modified">!             else {</span>
<span class="line-removed">-                 needToBeEscaped = i -&gt; isDelimiterChar(sb, i) || isRawEscapeChar(sb.charAt(i)) || isRawQuoteChar(sb.charAt(i));</span>
              }
<span class="line-modified">!             for (int i = 0; i &lt; sb.length(); i++) {</span>
<span class="line-modified">!                 if (needToBeEscaped.test(i)) {</span>
<span class="line-modified">!                     sb.insert(i++, escapeChars[0]);</span>
                  }
              }
<span class="line-modified">!             if (openingQuote != null) {</span>
<span class="line-modified">!                 sb.insert(0, openingQuote);</span>
                  if (complete) {
<span class="line-modified">!                     sb.append(openingQuote);</span>
                  }
              }
              return sb;
          }
  
<span class="line-new-header">--- 490,54 ---</span>
          }
  
          public CharSequence escape(CharSequence candidate, boolean complete) {
              StringBuilder sb = new StringBuilder(candidate);
              Predicate&lt;Integer&gt; needToBeEscaped;
<span class="line-modified">!             String quote = openingQuote;</span>
<span class="line-modified">!             boolean middleQuotes = false;</span>
<span class="line-modified">!             if (openingQuote==null) {</span>
<span class="line-modified">!                 for (int i=0; i &lt; sb.length(); i++) {</span>
<span class="line-modified">!                     if (isQuoteChar(sb, i)) {</span>
<span class="line-modified">!                         middleQuotes = true;</span>
<span class="line-modified">!                         break;</span>
<span class="line-modified">!                     }</span>
<span class="line-modified">!                 }</span>
              }
<span class="line-modified">!             if (escapeChars != null) {</span>
<span class="line-modified">!                 // Completion is protected by an opening quote:</span>
<span class="line-modified">!                 // Delimiters (spaces) don&#39;t need to be escaped, nor do other quotes, but everything else does.</span>
<span class="line-added">+                 // Also, close the quote at the end</span>
<span class="line-added">+                 if (openingQuote != null) {</span>
<span class="line-added">+                     needToBeEscaped = i -&gt; isRawEscapeChar(sb.charAt(i)) || String.valueOf(sb.charAt(i)).equals(openingQuote);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 // Completion is protected by middle quotes:</span>
<span class="line-added">+                 // Delimiters (spaces) don&#39;t need to be escaped, nor do quotes, but everything else does.</span>
<span class="line-added">+                 else if (middleQuotes) {</span>
<span class="line-added">+                     needToBeEscaped = i -&gt; isRawEscapeChar(sb.charAt(i));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 // No quote protection, need to escape everything: delimiter chars (spaces), quote chars</span>
<span class="line-added">+                 // and escapes themselves</span>
<span class="line-added">+                 else {</span>
<span class="line-added">+                     needToBeEscaped = i -&gt; isDelimiterChar(sb, i) || isRawEscapeChar(sb.charAt(i)) || isRawQuoteChar(sb.charAt(i));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 for (int i = 0; i &lt; sb.length(); i++) {</span>
<span class="line-added">+                     if (needToBeEscaped.test(i)) {</span>
<span class="line-added">+                         sb.insert(i++, escapeChars[0]);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             } else if (openingQuote == null &amp;&amp; !middleQuotes) {</span>
<span class="line-added">+                 for (int i = 0; i &lt; sb.length(); i++) {</span>
<span class="line-added">+                     if (isDelimiterChar(sb, i)) {</span>
<span class="line-added">+                         quote = &quot;&#39;&quot;;</span>
<span class="line-added">+                         break;</span>
<span class="line-added">+                     }</span>
                  }
              }
<span class="line-modified">!             if (quote != null) {</span>
<span class="line-modified">!                 sb.insert(0, quote);</span>
                  if (complete) {
<span class="line-modified">!                     sb.append(quote);</span>
                  }
              }
              return sb;
          }
  
</pre>
<center><a href="DefaultHighlighter.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="KillRing.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>