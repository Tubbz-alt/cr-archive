<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.management.agent/share/classes/sun/management/jmxremote/ConnectorBootstrap.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../jdk/internal/agent/AgentConfigurationError.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../conf/management.properties.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.management.agent/share/classes/sun/management/jmxremote/ConnectorBootstrap.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2003, 2017, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  99         public static final String USE_LOCAL_ONLY = &quot;true&quot;;
 100         public static final String USE_REGISTRY_SSL = &quot;false&quot;;
 101         public static final String USE_AUTHENTICATION = &quot;true&quot;;
 102         public static final String PASSWORD_FILE_NAME = &quot;jmxremote.password&quot;;
 103         public static final String HASH_PASSWORDS = &quot;true&quot;;
 104         public static final String ACCESS_FILE_NAME = &quot;jmxremote.access&quot;;
 105         public static final String SSL_NEED_CLIENT_AUTH = &quot;false&quot;;
 106     }
 107 
 108     /**
 109      * Names of JMX configuration properties.
 110      **/
 111     public static interface PropertyNames {
 112 
 113         public static final String PORT =
 114                 &quot;com.sun.management.jmxremote.port&quot;;
 115         public static final String HOST =
 116                 &quot;com.sun.management.jmxremote.host&quot;;
 117         public static final String RMI_PORT =
 118                 &quot;com.sun.management.jmxremote.rmi.port&quot;;


 119         public static final String CONFIG_FILE_NAME =
 120                 &quot;com.sun.management.config.file&quot;;
 121         public static final String USE_LOCAL_ONLY =
 122                 &quot;com.sun.management.jmxremote.local.only&quot;;
 123         public static final String USE_SSL =
 124                 &quot;com.sun.management.jmxremote.ssl&quot;;
 125         public static final String USE_REGISTRY_SSL =
 126                 &quot;com.sun.management.jmxremote.registry.ssl&quot;;
 127         public static final String USE_AUTHENTICATION =
 128                 &quot;com.sun.management.jmxremote.authenticate&quot;;
 129         public static final String PASSWORD_FILE_NAME =
 130                 &quot;com.sun.management.jmxremote.password.file&quot;;
 131         public static final String HASH_PASSWORDS
 132                 = &quot;com.sun.management.jmxremote.password.toHashes&quot;;
 133         public static final String ACCESS_FILE_NAME =
 134                 &quot;com.sun.management.jmxremote.access.file&quot;;
 135         public static final String LOGIN_CONFIG_NAME =
 136                 &quot;com.sun.management.jmxremote.login.config&quot;;
 137         public static final String SSL_ENABLED_CIPHER_SUITES =
 138                 &quot;com.sun.management.jmxremote.ssl.enabled.cipher.suites&quot;;
</pre>
<hr />
<pre>
 523         env.put(RMIExporter.EXPORTER_ATTRIBUTE, new PermanentExporter());
 524         env.put(RMIConnectorServer.CREDENTIALS_FILTER_PATTERN, String.class.getName() + &quot;;!*&quot;);
 525 
 526         // The local connector server need only be available via the
 527         // loopback connection.
 528         String localhost = &quot;localhost&quot;;
 529         InetAddress lh = null;
 530         try {
 531             lh = InetAddress.getByName(localhost);
 532             localhost = lh.getHostAddress();
 533         } catch (UnknownHostException x) {
 534         }
 535 
 536         // localhost unknown or (somehow) didn&#39;t resolve to
 537         // a loopback address.
 538         if (lh == null || !lh.isLoopbackAddress()) {
 539             localhost = &quot;127.0.0.1&quot;;
 540         }
 541 
 542         MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();


 543         try {
<span class="line-modified"> 544             JMXServiceURL url = new JMXServiceURL(&quot;rmi&quot;, localhost, 0);</span>
<span class="line-modified"> 545             // Do we accept connections from local interfaces only?</span>
<span class="line-removed"> 546             Properties props = Agent.getManagementProperties();</span>
<span class="line-removed"> 547             if (props ==  null) {</span>
 548                 props = new Properties();
 549             }






















 550             String useLocalOnlyStr = props.getProperty(
 551                     PropertyNames.USE_LOCAL_ONLY, DefaultValues.USE_LOCAL_ONLY);
 552             boolean useLocalOnly = Boolean.valueOf(useLocalOnlyStr).booleanValue();
 553             if (useLocalOnly) {
 554                 env.put(RMIConnectorServer.RMI_SERVER_SOCKET_FACTORY_ATTRIBUTE,
 555                         new LocalRMIServerSocketFactory());
 556             }
 557             JMXConnectorServer server =
 558                     JMXConnectorServerFactory.newJMXConnectorServer(url, env, mbs);
 559             server.start();
 560             return server;
 561         } catch (Exception e) {
 562             throw new AgentConfigurationError(AGENT_EXCEPTION, e, e.toString());
 563         }
 564     }
 565 
 566     private static void checkPasswordFile(String passwordFileName) {
 567         if (passwordFileName == null || passwordFileName.length() == 0) {
 568             throw new AgentConfigurationError(PASSWORD_FILE_NOT_SET);
 569         }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  99         public static final String USE_LOCAL_ONLY = &quot;true&quot;;
 100         public static final String USE_REGISTRY_SSL = &quot;false&quot;;
 101         public static final String USE_AUTHENTICATION = &quot;true&quot;;
 102         public static final String PASSWORD_FILE_NAME = &quot;jmxremote.password&quot;;
 103         public static final String HASH_PASSWORDS = &quot;true&quot;;
 104         public static final String ACCESS_FILE_NAME = &quot;jmxremote.access&quot;;
 105         public static final String SSL_NEED_CLIENT_AUTH = &quot;false&quot;;
 106     }
 107 
 108     /**
 109      * Names of JMX configuration properties.
 110      **/
 111     public static interface PropertyNames {
 112 
 113         public static final String PORT =
 114                 &quot;com.sun.management.jmxremote.port&quot;;
 115         public static final String HOST =
 116                 &quot;com.sun.management.jmxremote.host&quot;;
 117         public static final String RMI_PORT =
 118                 &quot;com.sun.management.jmxremote.rmi.port&quot;;
<span class="line-added"> 119         public static final String LOCAL_PORT =</span>
<span class="line-added"> 120                 &quot;com.sun.management.jmxremote.local.port&quot;;</span>
 121         public static final String CONFIG_FILE_NAME =
 122                 &quot;com.sun.management.config.file&quot;;
 123         public static final String USE_LOCAL_ONLY =
 124                 &quot;com.sun.management.jmxremote.local.only&quot;;
 125         public static final String USE_SSL =
 126                 &quot;com.sun.management.jmxremote.ssl&quot;;
 127         public static final String USE_REGISTRY_SSL =
 128                 &quot;com.sun.management.jmxremote.registry.ssl&quot;;
 129         public static final String USE_AUTHENTICATION =
 130                 &quot;com.sun.management.jmxremote.authenticate&quot;;
 131         public static final String PASSWORD_FILE_NAME =
 132                 &quot;com.sun.management.jmxremote.password.file&quot;;
 133         public static final String HASH_PASSWORDS
 134                 = &quot;com.sun.management.jmxremote.password.toHashes&quot;;
 135         public static final String ACCESS_FILE_NAME =
 136                 &quot;com.sun.management.jmxremote.access.file&quot;;
 137         public static final String LOGIN_CONFIG_NAME =
 138                 &quot;com.sun.management.jmxremote.login.config&quot;;
 139         public static final String SSL_ENABLED_CIPHER_SUITES =
 140                 &quot;com.sun.management.jmxremote.ssl.enabled.cipher.suites&quot;;
</pre>
<hr />
<pre>
 525         env.put(RMIExporter.EXPORTER_ATTRIBUTE, new PermanentExporter());
 526         env.put(RMIConnectorServer.CREDENTIALS_FILTER_PATTERN, String.class.getName() + &quot;;!*&quot;);
 527 
 528         // The local connector server need only be available via the
 529         // loopback connection.
 530         String localhost = &quot;localhost&quot;;
 531         InetAddress lh = null;
 532         try {
 533             lh = InetAddress.getByName(localhost);
 534             localhost = lh.getHostAddress();
 535         } catch (UnknownHostException x) {
 536         }
 537 
 538         // localhost unknown or (somehow) didn&#39;t resolve to
 539         // a loopback address.
 540         if (lh == null || !lh.isLoopbackAddress()) {
 541             localhost = &quot;127.0.0.1&quot;;
 542         }
 543 
 544         MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();
<span class="line-added"> 545 </span>
<span class="line-added"> 546         Properties props = null;</span>
 547         try {
<span class="line-modified"> 548             props = Agent.getManagementProperties();</span>
<span class="line-modified"> 549             if (props == null) {</span>


 550                 props = new Properties();
 551             }
<span class="line-added"> 552         } catch (Exception e) {</span>
<span class="line-added"> 553             throw new AgentConfigurationError(AGENT_EXCEPTION, e, e.toString());</span>
<span class="line-added"> 554         }</span>
<span class="line-added"> 555 </span>
<span class="line-added"> 556         // User can specify a port to be used to start local connector server.</span>
<span class="line-added"> 557         // Random one will be allocated if port is not specified.</span>
<span class="line-added"> 558         int localPort = 0;</span>
<span class="line-added"> 559         String localPortStr = props.getProperty(PropertyNames.LOCAL_PORT);</span>
<span class="line-added"> 560         try {</span>
<span class="line-added"> 561             if (localPortStr != null) {</span>
<span class="line-added"> 562                 localPort = Integer.parseInt(localPortStr);</span>
<span class="line-added"> 563             }</span>
<span class="line-added"> 564         } catch (NumberFormatException x) {</span>
<span class="line-added"> 565             throw new AgentConfigurationError(INVALID_JMXREMOTE_LOCAL_PORT, x, localPortStr);</span>
<span class="line-added"> 566         }</span>
<span class="line-added"> 567         if (localPort &lt; 0) {</span>
<span class="line-added"> 568             throw new AgentConfigurationError(INVALID_JMXREMOTE_LOCAL_PORT, localPortStr);</span>
<span class="line-added"> 569         }</span>
<span class="line-added"> 570 </span>
<span class="line-added"> 571         try {</span>
<span class="line-added"> 572             JMXServiceURL url = new JMXServiceURL(&quot;rmi&quot;, localhost, localPort);</span>
<span class="line-added"> 573             // Do we accept connections from local interfaces only?</span>
 574             String useLocalOnlyStr = props.getProperty(
 575                     PropertyNames.USE_LOCAL_ONLY, DefaultValues.USE_LOCAL_ONLY);
 576             boolean useLocalOnly = Boolean.valueOf(useLocalOnlyStr).booleanValue();
 577             if (useLocalOnly) {
 578                 env.put(RMIConnectorServer.RMI_SERVER_SOCKET_FACTORY_ATTRIBUTE,
 579                         new LocalRMIServerSocketFactory());
 580             }
 581             JMXConnectorServer server =
 582                     JMXConnectorServerFactory.newJMXConnectorServer(url, env, mbs);
 583             server.start();
 584             return server;
 585         } catch (Exception e) {
 586             throw new AgentConfigurationError(AGENT_EXCEPTION, e, e.toString());
 587         }
 588     }
 589 
 590     private static void checkPasswordFile(String passwordFileName) {
 591         if (passwordFileName == null || passwordFileName.length() == 0) {
 592             throw new AgentConfigurationError(PASSWORD_FILE_NOT_SET);
 593         }
</pre>
</td>
</tr>
</table>
<center><a href="../../../jdk/internal/agent/AgentConfigurationError.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../conf/management.properties.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>