<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.meta/src/jdk/vm/ci/meta/SpeculationLog.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ResolvedJavaMethod.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../jdk.vm.ci.runtime/src/jdk/vm/ci/runtime/JVMCI.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.meta/src/jdk/vm/ci/meta/SpeculationLog.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, 2014, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,33 +20,86 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package jdk.vm.ci.meta;
  
<span class="udiff-line-added">+ import java.util.Map;</span>
<span class="udiff-line-added">+ import java.util.function.Supplier;</span>
<span class="udiff-line-added">+ </span>
  /**
<span class="udiff-line-modified-removed">-  * Manages unique deoptimization reasons. Reasons are embedded in compiled code and can be</span>
<span class="udiff-line-modified-removed">-  * invalidated at run time. Subsequent compilations then should not speculate again on such</span>
<span class="udiff-line-modified-removed">-  * invalidated reasons to avoid repeated deoptimization.</span>
<span class="udiff-line-modified-removed">-  *</span>
<span class="udiff-line-modified-removed">-  * All methods of this interface are called by the compiler. There is no need for API to register</span>
<span class="udiff-line-modified-removed">-  * failed speculations during deoptimization, since every VM has different needs there.</span>
<span class="udiff-line-modified-added">+  * Manages unique {@link SpeculationReason} objects that denote why a deoptimization occurred.</span>
<span class="udiff-line-modified-added">+  * Reasons are embedded in compiled code for a method. If the compiled code deoptimizes at a</span>
<span class="udiff-line-modified-added">+  * position associated with a {@link SpeculationReason}, the reason is added to a set of failed</span>
<span class="udiff-line-modified-added">+  * speculations associated with the method. A subsequent compilation of the method can query the</span>
<span class="udiff-line-modified-added">+  * failed speculations via a {@link SpeculationLog} to avoid making a speculation based on</span>
<span class="udiff-line-modified-added">+  * invalidated reasons. This avoids repeated deoptimizations.</span>
   */
  public interface SpeculationLog {
      /**
<span class="udiff-line-modified-removed">-      * Marker interface for speculation objects that can be added to the speculation log.</span>
<span class="udiff-line-modified-added">+      * The specific attributes of a speculation that a compiler uses to denote a speculation in a</span>
<span class="udiff-line-added">+      * compiled method. Typical attributes of a speculation are a bytecode position, type</span>
<span class="udiff-line-added">+      * information about a variable being speculated on and an enum denoting the type of operation</span>
<span class="udiff-line-added">+      * to which the speculation applies. A {@link SpeculationReason} is used as a key in a</span>
<span class="udiff-line-added">+      * {@link Map} and so it must implement {@link Object#equals(Object)} and</span>
<span class="udiff-line-added">+      * {@link Object#hashCode()} in terms of its attributes.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * A JVMCI implementation may serialize speculations for storage off heap (e.g. in native memory</span>
<span class="udiff-line-added">+      * associated with an nmethod). For this reason, the attributes of a {@link SpeculationReason}</span>
<span class="udiff-line-added">+      * are restricted to those supported by the {@code add...} methods of</span>
<span class="udiff-line-added">+      * {@link SpeculationReasonEncoding}.</span>
       */
      public interface SpeculationReason {
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         /**</span>
<span class="udiff-line-added">+          * Encodes the attributes of this reason using a {@link SpeculationReasonEncoding}. For</span>
<span class="udiff-line-added">+          * efficiency, a {@link SpeculationReason} implementation should cache the returned value</span>
<span class="udiff-line-added">+          * and return it for all subsequent calls to this method. This also underlines the</span>
<span class="udiff-line-added">+          * requirement that the encoding for a specific reason instance should be stable.</span>
<span class="udiff-line-added">+          *</span>
<span class="udiff-line-added">+          * @param encodingSupplier source of a {@link SpeculationReasonEncoding}</span>
<span class="udiff-line-added">+          * @return a {@link SpeculationReasonEncoding} that encodes all the attributes that uniquely</span>
<span class="udiff-line-added">+          *         identify this reason</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         default SpeculationReasonEncoding encode(Supplier&lt;SpeculationReasonEncoding&gt; encodingSupplier) {</span>
<span class="udiff-line-added">+             return null;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Provides a facility for encoding the attributes of a {@link SpeculationReason}. The encoding</span>
<span class="udiff-line-added">+      * format is determined by the implementation of this interface.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public interface SpeculationReasonEncoding {</span>
<span class="udiff-line-added">+         void addByte(int value);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         void addShort(int value);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         void addInt(int value);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         void addLong(long value);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         void addMethod(ResolvedJavaMethod method);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         void addType(ResolvedJavaType type);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         void addString(String value);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         default void addField(ResolvedJavaField field) {</span>
<span class="udiff-line-added">+             addType(field.getDeclaringClass());</span>
<span class="udiff-line-added">+             addInt(field.getModifiers());</span>
<span class="udiff-line-added">+             addInt(field.getOffset());</span>
<span class="udiff-line-added">+         }</span>
      }
  
      /**
       * Marker class that indicates that a speculation has no reason.
       */
      final class NoSpeculationReason implements SpeculationReason {
      }
  
      class Speculation {
<span class="udiff-line-modified-removed">-         private SpeculationReason reason;</span>
<span class="udiff-line-modified-added">+         private final SpeculationReason reason;</span>
  
          public Speculation(SpeculationReason reason) {
              this.reason = reason;
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -75,11 +128,12 @@</span>
      }
  
      Speculation NO_SPECULATION = new Speculation(new NoSpeculationReason());
  
      /**
<span class="udiff-line-modified-removed">-      * Must be called before compilation, i.e., before a compiler calls {@link #maySpeculate}.</span>
<span class="udiff-line-modified-added">+      * Updates the set of failed speculations recorded in this log. This must be called before</span>
<span class="udiff-line-added">+      * compilation.</span>
       */
      void collectFailedSpeculations();
  
      /**
       * If this method returns true, the compiler is allowed to {@link #speculate} with the given
</pre>
<center><a href="ResolvedJavaMethod.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../jdk.vm.ci.runtime/src/jdk/vm/ci/runtime/JVMCI.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>