<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.meta/src/jdk/vm/ci/meta/SpeculationLog.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package jdk.vm.ci.meta;
 24 
<a name="2" id="anc2"></a><span class="line-added"> 25 import java.util.Map;</span>
<span class="line-added"> 26 import java.util.function.Supplier;</span>
<span class="line-added"> 27 </span>
 28 /**
<a name="3" id="anc3"></a><span class="line-modified"> 29  * Manages unique {@link SpeculationReason} objects that denote why a deoptimization occurred.</span>
<span class="line-modified"> 30  * Reasons are embedded in compiled code for a method. If the compiled code deoptimizes at a</span>
<span class="line-modified"> 31  * position associated with a {@link SpeculationReason}, the reason is added to a set of failed</span>
<span class="line-modified"> 32  * speculations associated with the method. A subsequent compilation of the method can query the</span>
<span class="line-modified"> 33  * failed speculations via a {@link SpeculationLog} to avoid making a speculation based on</span>
<span class="line-modified"> 34  * invalidated reasons. This avoids repeated deoptimizations.</span>
 35  */
 36 public interface SpeculationLog {
 37     /**
<a name="4" id="anc4"></a><span class="line-modified"> 38      * The specific attributes of a speculation that a compiler uses to denote a speculation in a</span>
<span class="line-added"> 39      * compiled method. Typical attributes of a speculation are a bytecode position, type</span>
<span class="line-added"> 40      * information about a variable being speculated on and an enum denoting the type of operation</span>
<span class="line-added"> 41      * to which the speculation applies. A {@link SpeculationReason} is used as a key in a</span>
<span class="line-added"> 42      * {@link Map} and so it must implement {@link Object#equals(Object)} and</span>
<span class="line-added"> 43      * {@link Object#hashCode()} in terms of its attributes.</span>
<span class="line-added"> 44      *</span>
<span class="line-added"> 45      * A JVMCI implementation may serialize speculations for storage off heap (e.g. in native memory</span>
<span class="line-added"> 46      * associated with an nmethod). For this reason, the attributes of a {@link SpeculationReason}</span>
<span class="line-added"> 47      * are restricted to those supported by the {@code add...} methods of</span>
<span class="line-added"> 48      * {@link SpeculationReasonEncoding}.</span>
 49      */
 50     public interface SpeculationReason {
<a name="5" id="anc5"></a><span class="line-added"> 51 </span>
<span class="line-added"> 52         /**</span>
<span class="line-added"> 53          * Encodes the attributes of this reason using a {@link SpeculationReasonEncoding}. For</span>
<span class="line-added"> 54          * efficiency, a {@link SpeculationReason} implementation should cache the returned value</span>
<span class="line-added"> 55          * and return it for all subsequent calls to this method. This also underlines the</span>
<span class="line-added"> 56          * requirement that the encoding for a specific reason instance should be stable.</span>
<span class="line-added"> 57          *</span>
<span class="line-added"> 58          * @param encodingSupplier source of a {@link SpeculationReasonEncoding}</span>
<span class="line-added"> 59          * @return a {@link SpeculationReasonEncoding} that encodes all the attributes that uniquely</span>
<span class="line-added"> 60          *         identify this reason</span>
<span class="line-added"> 61          */</span>
<span class="line-added"> 62         default SpeculationReasonEncoding encode(Supplier&lt;SpeculationReasonEncoding&gt; encodingSupplier) {</span>
<span class="line-added"> 63             return null;</span>
<span class="line-added"> 64         }</span>
<span class="line-added"> 65     }</span>
<span class="line-added"> 66 </span>
<span class="line-added"> 67     /**</span>
<span class="line-added"> 68      * Provides a facility for encoding the attributes of a {@link SpeculationReason}. The encoding</span>
<span class="line-added"> 69      * format is determined by the implementation of this interface.</span>
<span class="line-added"> 70      */</span>
<span class="line-added"> 71     public interface SpeculationReasonEncoding {</span>
<span class="line-added"> 72         void addByte(int value);</span>
<span class="line-added"> 73 </span>
<span class="line-added"> 74         void addShort(int value);</span>
<span class="line-added"> 75 </span>
<span class="line-added"> 76         void addInt(int value);</span>
<span class="line-added"> 77 </span>
<span class="line-added"> 78         void addLong(long value);</span>
<span class="line-added"> 79 </span>
<span class="line-added"> 80         void addMethod(ResolvedJavaMethod method);</span>
<span class="line-added"> 81 </span>
<span class="line-added"> 82         void addType(ResolvedJavaType type);</span>
<span class="line-added"> 83 </span>
<span class="line-added"> 84         void addString(String value);</span>
<span class="line-added"> 85 </span>
<span class="line-added"> 86         default void addField(ResolvedJavaField field) {</span>
<span class="line-added"> 87             addType(field.getDeclaringClass());</span>
<span class="line-added"> 88             addInt(field.getModifiers());</span>
<span class="line-added"> 89             addInt(field.getOffset());</span>
<span class="line-added"> 90         }</span>
 91     }
 92 
 93     /**
 94      * Marker class that indicates that a speculation has no reason.
 95      */
 96     final class NoSpeculationReason implements SpeculationReason {
 97     }
 98 
 99     class Speculation {
<a name="6" id="anc6"></a><span class="line-modified">100         private final SpeculationReason reason;</span>
101 
102         public Speculation(SpeculationReason reason) {
103             this.reason = reason;
104         }
105 
106         public SpeculationReason getReason() {
107             return reason;
108         }
109 
110         @Override
111         public String toString() {
112             return reason.toString();
113         }
114 
115         @Override
116         public boolean equals(Object obj) {
117             if (obj instanceof Speculation) {
118                 Speculation other = (Speculation) obj;
119                 return reason.equals(other.reason);
120             }
121             return false;
122         }
123 
124         @Override
125         public int hashCode() {
126             return getReason().hashCode();
127         }
128     }
129 
130     Speculation NO_SPECULATION = new Speculation(new NoSpeculationReason());
131 
132     /**
<a name="7" id="anc7"></a><span class="line-modified">133      * Updates the set of failed speculations recorded in this log. This must be called before</span>
<span class="line-added">134      * compilation.</span>
135      */
136     void collectFailedSpeculations();
137 
138     /**
139      * If this method returns true, the compiler is allowed to {@link #speculate} with the given
140      * reason.
141      */
142     boolean maySpeculate(SpeculationReason reason);
143 
144     /**
145      * Registers a speculation performed by the compiler. The compiler must guard every call to this
146      * method for a specific reason with a call to {@link #maySpeculate(SpeculationReason)}.
147      *
148      * This API is subject to a benign race where a during the course of a compilation another
149      * thread might fail a speculation such that {@link #maySpeculate(SpeculationReason)} will
150      * return false but an earlier call returned true. This method will still return a working
151      * {@link Speculation} in that case but the compile will eventually be invalidated and the
152      * compile attempted again without the now invalid speculation.
153      *
154      * @param reason an object representing the reason for the speculation
155      * @return a compiler constant encapsulating the provided reason. It is usually passed as an
156      *         argument to the deoptimization function.
157      */
158     Speculation speculate(SpeculationReason reason);
159 
160     /**
161      * Returns if this log has speculations.
162      *
163      * @return true if there are speculations, false otherwise
164      */
165     boolean hasSpeculations();
166 
167     /**
168      * Given a {@link JavaConstant} previously returned from
169      * {@link MetaAccessProvider#encodeSpeculation(Speculation)} return the original
170      * {@link Speculation} object.
171      */
172     Speculation lookupSpeculation(JavaConstant constant);
173 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>