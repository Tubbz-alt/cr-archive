<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotCodeCacheProvider.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CompilerToVM.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotCompilationRequest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotCodeCacheProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package jdk.vm.ci.hotspot;
 24 
 25 import java.util.Map;

 26 
 27 import jdk.vm.ci.code.BailoutException;
 28 import jdk.vm.ci.code.BytecodeFrame;
 29 import jdk.vm.ci.code.CodeCacheProvider;
 30 import jdk.vm.ci.code.CompiledCode;
 31 import jdk.vm.ci.code.InstalledCode;
 32 import jdk.vm.ci.code.RegisterConfig;
 33 import jdk.vm.ci.code.TargetDescription;
 34 import jdk.vm.ci.code.site.Call;
 35 import jdk.vm.ci.code.site.Mark;
 36 import jdk.vm.ci.meta.ResolvedJavaMethod;
 37 import jdk.vm.ci.meta.SpeculationLog;
 38 
 39 /**
 40  * HotSpot implementation of {@link CodeCacheProvider}.
 41  */
 42 public class HotSpotCodeCacheProvider implements CodeCacheProvider {
 43 
 44     protected final HotSpotJVMCIRuntime runtime;
 45     private final HotSpotVMConfig config;
</pre>
<hr />
<pre>
 85     }
 86 
 87     @Override
 88     public RegisterConfig getRegisterConfig() {
 89         return regConfig;
 90     }
 91 
 92     @Override
 93     public int getMinimumOutgoingSize() {
 94         return config.runtimeCallStackSize;
 95     }
 96 
 97     private InstalledCode logOrDump(InstalledCode installedCode, CompiledCode compiledCode) {
 98         runtime.notifyInstall(this, installedCode, compiledCode);
 99         return installedCode;
100     }
101 
102     @Override
103     public InstalledCode installCode(ResolvedJavaMethod method, CompiledCode compiledCode, InstalledCode installedCode, SpeculationLog log, boolean isDefault) {
104         InstalledCode resultInstalledCode;
<span class="line-modified">105         if (installedCode == null) {</span>
<span class="line-modified">106             if (method == null) {</span>
<span class="line-modified">107                 // Must be a stub</span>
<span class="line-modified">108                 resultInstalledCode = new HotSpotRuntimeStub(((HotSpotCompiledCode) compiledCode).getName());</span>
<span class="line-modified">109             } else {</span>
<span class="line-modified">110                 resultInstalledCode = new HotSpotNmethod((HotSpotResolvedJavaMethod) method, ((HotSpotCompiledCode) compiledCode).getName(), isDefault);</span>
<span class="line-modified">111             }</span>


112         } else {
<span class="line-modified">113             resultInstalledCode = installedCode;</span>


114         }
115 
<span class="line-modified">116         HotSpotSpeculationLog speculationLog = (log != null &amp;&amp; log.hasSpeculations()) ? (HotSpotSpeculationLog) log : null;</span>





117 
<span class="line-modified">118         int result = runtime.getCompilerToVM().installCode(target, (HotSpotCompiledCode) compiledCode, resultInstalledCode, speculationLog);</span>









119         if (result != config.codeInstallResultOk) {
120             String resultDesc = config.getCodeInstallResultDescription(result);
<span class="line-modified">121             if (compiledCode instanceof HotSpotCompiledNmethod) {</span>
<span class="line-modified">122                 HotSpotCompiledNmethod compiledNmethod = (HotSpotCompiledNmethod) compiledCode;</span>
<span class="line-removed">123                 String msg = compiledNmethod.getInstallationFailureMessage();</span>
124                 if (msg != null) {
125                     msg = String.format(&quot;Code installation failed: %s%n%s&quot;, resultDesc, msg);
126                 } else {
127                     msg = String.format(&quot;Code installation failed: %s&quot;, resultDesc);
128                 }
<span class="line-removed">129                 if (result == config.codeInstallResultDependenciesInvalid) {</span>
<span class="line-removed">130                     throw new AssertionError(resultDesc + &quot; &quot; + msg);</span>
<span class="line-removed">131                 }</span>
132                 throw new BailoutException(result != config.codeInstallResultDependenciesFailed, msg);
133             } else {
134                 throw new BailoutException(&quot;Error installing %s: %s&quot;, ((HotSpotCompiledCode) compiledCode).getName(), resultDesc);
135             }
136         }
137         return logOrDump(resultInstalledCode, compiledCode);
138     }
139 
140     @Override
141     public void invalidateInstalledCode(InstalledCode installedCode) {
<span class="line-modified">142         runtime.getCompilerToVM().invalidateInstalledCode(installedCode);</span>




143     }
144 
145     @Override
146     public TargetDescription getTarget() {
147         return target;
148     }
149 
150     public String disassemble(InstalledCode code) {
151         if (code.isValid()) {
152             return runtime.getCompilerToVM().disassembleCodeBlob(code);
153         }
154         return null;
155     }
156 
157     @Override
158     public SpeculationLog createSpeculationLog() {
159         return new HotSpotSpeculationLog();
160     }
161 
162     @Override
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package jdk.vm.ci.hotspot;
 24 
 25 import java.util.Map;
<span class="line-added"> 26 import java.util.Objects;</span>
 27 
 28 import jdk.vm.ci.code.BailoutException;
 29 import jdk.vm.ci.code.BytecodeFrame;
 30 import jdk.vm.ci.code.CodeCacheProvider;
 31 import jdk.vm.ci.code.CompiledCode;
 32 import jdk.vm.ci.code.InstalledCode;
 33 import jdk.vm.ci.code.RegisterConfig;
 34 import jdk.vm.ci.code.TargetDescription;
 35 import jdk.vm.ci.code.site.Call;
 36 import jdk.vm.ci.code.site.Mark;
 37 import jdk.vm.ci.meta.ResolvedJavaMethod;
 38 import jdk.vm.ci.meta.SpeculationLog;
 39 
 40 /**
 41  * HotSpot implementation of {@link CodeCacheProvider}.
 42  */
 43 public class HotSpotCodeCacheProvider implements CodeCacheProvider {
 44 
 45     protected final HotSpotJVMCIRuntime runtime;
 46     private final HotSpotVMConfig config;
</pre>
<hr />
<pre>
 86     }
 87 
 88     @Override
 89     public RegisterConfig getRegisterConfig() {
 90         return regConfig;
 91     }
 92 
 93     @Override
 94     public int getMinimumOutgoingSize() {
 95         return config.runtimeCallStackSize;
 96     }
 97 
 98     private InstalledCode logOrDump(InstalledCode installedCode, CompiledCode compiledCode) {
 99         runtime.notifyInstall(this, installedCode, compiledCode);
100         return installedCode;
101     }
102 
103     @Override
104     public InstalledCode installCode(ResolvedJavaMethod method, CompiledCode compiledCode, InstalledCode installedCode, SpeculationLog log, boolean isDefault) {
105         InstalledCode resultInstalledCode;
<span class="line-modified">106         if (installedCode != null) {</span>
<span class="line-modified">107             throw new IllegalArgumentException(&quot;InstalledCode argument must be null&quot;);</span>
<span class="line-modified">108         }</span>
<span class="line-modified">109         HotSpotCompiledCode hsCompiledCode = (HotSpotCompiledCode) compiledCode;</span>
<span class="line-modified">110         String name = hsCompiledCode.getName();</span>
<span class="line-modified">111         HotSpotCompiledNmethod hsCompiledNmethod = null;</span>
<span class="line-modified">112         if (method == null) {</span>
<span class="line-added">113             // Must be a stub</span>
<span class="line-added">114             resultInstalledCode = new HotSpotRuntimeStub(name);</span>
115         } else {
<span class="line-modified">116             hsCompiledNmethod = (HotSpotCompiledNmethod) hsCompiledCode;</span>
<span class="line-added">117             HotSpotResolvedJavaMethodImpl hsMethod = (HotSpotResolvedJavaMethodImpl) method;</span>
<span class="line-added">118             resultInstalledCode = new HotSpotNmethod(hsMethod, name, isDefault, hsCompiledNmethod.id);</span>
119         }
120 
<span class="line-modified">121         HotSpotSpeculationLog speculationLog = null;</span>
<span class="line-added">122         if (log != null) {</span>
<span class="line-added">123             if (log.hasSpeculations()) {</span>
<span class="line-added">124                 speculationLog = (HotSpotSpeculationLog) log;</span>
<span class="line-added">125             }</span>
<span class="line-added">126         }</span>
127 
<span class="line-modified">128         byte[] speculations;</span>
<span class="line-added">129         long failedSpeculationsAddress;</span>
<span class="line-added">130         if (speculationLog != null) {</span>
<span class="line-added">131             speculations = speculationLog.getFlattenedSpeculations(true);</span>
<span class="line-added">132             failedSpeculationsAddress = speculationLog.getFailedSpeculationsAddress();</span>
<span class="line-added">133         } else {</span>
<span class="line-added">134             speculations = new byte[0];</span>
<span class="line-added">135             failedSpeculationsAddress = 0L;</span>
<span class="line-added">136         }</span>
<span class="line-added">137         int result = runtime.getCompilerToVM().installCode(target, (HotSpotCompiledCode) compiledCode, resultInstalledCode, failedSpeculationsAddress, speculations);</span>
138         if (result != config.codeInstallResultOk) {
139             String resultDesc = config.getCodeInstallResultDescription(result);
<span class="line-modified">140             if (hsCompiledNmethod != null) {</span>
<span class="line-modified">141                 String msg = hsCompiledNmethod.getInstallationFailureMessage();</span>

142                 if (msg != null) {
143                     msg = String.format(&quot;Code installation failed: %s%n%s&quot;, resultDesc, msg);
144                 } else {
145                     msg = String.format(&quot;Code installation failed: %s&quot;, resultDesc);
146                 }



147                 throw new BailoutException(result != config.codeInstallResultDependenciesFailed, msg);
148             } else {
149                 throw new BailoutException(&quot;Error installing %s: %s&quot;, ((HotSpotCompiledCode) compiledCode).getName(), resultDesc);
150             }
151         }
152         return logOrDump(resultInstalledCode, compiledCode);
153     }
154 
155     @Override
156     public void invalidateInstalledCode(InstalledCode installedCode) {
<span class="line-modified">157         if (installedCode instanceof HotSpotNmethod) {</span>
<span class="line-added">158             runtime.getCompilerToVM().invalidateHotSpotNmethod((HotSpotNmethod) installedCode);</span>
<span class="line-added">159         } else {</span>
<span class="line-added">160             throw new IllegalArgumentException(&quot;Cannot invalidate a &quot; + Objects.requireNonNull(installedCode).getClass().getName());</span>
<span class="line-added">161         }</span>
162     }
163 
164     @Override
165     public TargetDescription getTarget() {
166         return target;
167     }
168 
169     public String disassemble(InstalledCode code) {
170         if (code.isValid()) {
171             return runtime.getCompilerToVM().disassembleCodeBlob(code);
172         }
173         return null;
174     }
175 
176     @Override
177     public SpeculationLog createSpeculationLog() {
178         return new HotSpotSpeculationLog();
179     }
180 
181     @Override
</pre>
</td>
</tr>
</table>
<center><a href="CompilerToVM.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotCompilationRequest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>