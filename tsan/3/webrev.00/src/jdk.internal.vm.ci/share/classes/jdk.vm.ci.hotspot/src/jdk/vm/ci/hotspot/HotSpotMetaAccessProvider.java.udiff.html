<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotMetaAccessProvider.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotMemoryAccessProviderImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotMetaData.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotMetaAccessProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,14 +20,10 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package jdk.vm.ci.hotspot;
  
<span class="udiff-line-removed">- import static jdk.vm.ci.hotspot.HotSpotResolvedObjectTypeImpl.fromObjectClass;</span>
<span class="udiff-line-removed">- import static jdk.vm.ci.hotspot.UnsafeAccess.UNSAFE;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- import java.lang.reflect.Array;</span>
  import java.lang.reflect.Executable;
  import java.lang.reflect.Field;
  import java.lang.reflect.Modifier;
  import java.util.Objects;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -41,10 +37,12 @@</span>
  import jdk.vm.ci.meta.ResolvedJavaField;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
  import jdk.vm.ci.meta.ResolvedJavaType;
  import jdk.vm.ci.meta.Signature;
  import jdk.vm.ci.meta.SpeculationLog;
<span class="udiff-line-added">+ import jdk.vm.ci.meta.SpeculationLog.NoSpeculationReason;</span>
<span class="udiff-line-added">+ import jdk.vm.ci.meta.SpeculationLog.Speculation;</span>
  
  // JaCoCo Exclude
  
  /**
   * HotSpot implementation of {@link MetaAccessProvider}.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -85,24 +83,23 @@</span>
  
      @Override
      public ResolvedJavaField lookupJavaField(Field reflectionField) {
          Class&lt;?&gt; fieldHolder = reflectionField.getDeclaringClass();
  
<span class="udiff-line-modified-removed">-         HotSpotResolvedObjectType holder = fromObjectClass(fieldHolder);</span>
<span class="udiff-line-modified-added">+         HotSpotResolvedJavaType holder = runtime.fromClass(fieldHolder);</span>
<span class="udiff-line-added">+         assert holder != null : fieldHolder;</span>
<span class="udiff-line-added">+         ResolvedJavaField[] fields;</span>
          if (Modifier.isStatic(reflectionField.getModifiers())) {
<span class="udiff-line-modified-removed">-             final long offset = UNSAFE.staticFieldOffset(reflectionField);</span>
<span class="udiff-line-removed">-             for (ResolvedJavaField field : holder.getStaticFields()) {</span>
<span class="udiff-line-removed">-                 if (offset == ((HotSpotResolvedJavaField) field).getOffset()) {</span>
<span class="udiff-line-removed">-                     return field;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+             fields = holder.getStaticFields();</span>
          } else {
<span class="udiff-line-modified-removed">-             final long offset = UNSAFE.objectFieldOffset(reflectionField);</span>
<span class="udiff-line-modified-removed">-             for (ResolvedJavaField field : holder.getInstanceFields(false)) {</span>
<span class="udiff-line-modified-removed">-                 if (offset == ((HotSpotResolvedJavaField) field).getOffset()) {</span>
<span class="udiff-line-modified-removed">-                     return field;</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-added">+             fields = holder.getInstanceFields(false);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         ResolvedJavaType fieldType = lookupJavaType(reflectionField.getType());</span>
<span class="udiff-line-modified-added">+         for (ResolvedJavaField field : fields) {</span>
<span class="udiff-line-modified-added">+             if (reflectionField.getName().equals(field.getName()) &amp;&amp; field.getType().equals(fieldType)) {</span>
<span class="udiff-line-added">+                 assert Modifier.isStatic(reflectionField.getModifiers()) == field.isStatic();</span>
<span class="udiff-line-added">+                 return field;</span>
              }
          }
  
          throw new JVMCIError(&quot;unresolved field %s&quot;, reflectionField);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -145,23 +142,25 @@</span>
          HotSpotVMConfig config = runtime.getConfig();
          return ((~constant.asInt()) &gt;&gt; config.deoptimizationDebugIdShift) &amp; intMaskRight(config.deoptimizationDebugIdBits);
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public JavaConstant encodeSpeculation(SpeculationLog.Speculation speculation) {</span>
<span class="udiff-line-modified-removed">-         if (speculation.getReason() instanceof SpeculationLog.NoSpeculationReason) {</span>
<span class="udiff-line-modified-added">+     public JavaConstant encodeSpeculation(Speculation speculation) {</span>
<span class="udiff-line-modified-added">+         if (speculation.getReason() instanceof NoSpeculationReason) {</span>
              return JavaConstant.LONG_0;
          }
          return ((HotSpotSpeculationLog.HotSpotSpeculation) speculation).getEncoding();
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public SpeculationLog.Speculation decodeSpeculation(JavaConstant constant, SpeculationLog speculationLog) {</span>
<span class="udiff-line-modified-added">+     public Speculation decodeSpeculation(JavaConstant constant, SpeculationLog speculationLog) {</span>
          if (constant.equals(JavaConstant.LONG_0)) {
              return SpeculationLog.NO_SPECULATION;
          }
<span class="udiff-line-modified-removed">-         assert speculationLog != null : &quot;Must have a speculation log&quot;;</span>
<span class="udiff-line-modified-added">+         if (speculationLog == null) {</span>
<span class="udiff-line-added">+             throw new IllegalArgumentException(&quot;A speculation log is required to decode the speculation denoted by &quot; + constant);</span>
<span class="udiff-line-added">+         }</span>
          return speculationLog.lookupSpeculation(constant);
      }
  
      public int convertDeoptAction(DeoptimizationAction action) {
          HotSpotVMConfig config = runtime.getConfig();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -301,15 +300,15 @@</span>
  
              if (lookupJavaType == null) {
                  return 0;
              } else {
                  if (lookupJavaType.isArray()) {
<span class="udiff-line-modified-removed">-                     int length = Array.getLength(((HotSpotObjectConstantImpl) constant).object());</span>
<span class="udiff-line-modified-added">+                     int length = runtime.getHostJVMCIBackend().getConstantReflection().readArrayLength(constant);</span>
                      ResolvedJavaType elementType = lookupJavaType.getComponentType();
                      JavaKind elementKind = elementType.getJavaKind();
<span class="udiff-line-modified-removed">-                     final int headerSize = getArrayBaseOffset(elementKind);</span>
<span class="udiff-line-modified-removed">-                     int sizeOfElement = getArrayIndexScale(elementKind);</span>
<span class="udiff-line-modified-added">+                     final int headerSize = runtime.getArrayBaseOffset(elementKind);</span>
<span class="udiff-line-modified-added">+                     int sizeOfElement = runtime.getArrayIndexScale(elementKind);</span>
                      int log2ElementSize = CodeUtil.log2(sizeOfElement);
                      return computeArrayAllocationSize(length, headerSize, log2ElementSize);
                  }
                  return lookupJavaType.instanceSize();
              }
</pre>
<center><a href="HotSpotMemoryAccessProviderImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotMetaData.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>