<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotConstantReflectionProvider.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotConstantPoolObject.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotInstalledCode.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotConstantReflectionProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 20,11 ***</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package jdk.vm.ci.hotspot;
  
<span class="line-removed">- import java.lang.reflect.Array;</span>
  import java.util.Objects;
  
  import jdk.vm.ci.common.JVMCIError;
  import jdk.vm.ci.meta.Constant;
  import jdk.vm.ci.meta.ConstantReflectionProvider;
<span class="line-new-header">--- 20,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 63,11 ***</span>
      @Override
      public Boolean constantEquals(Constant x, Constant y) {
          if (x == y) {
              return true;
          } else if (x instanceof HotSpotObjectConstantImpl) {
<span class="line-modified">!             return y instanceof HotSpotObjectConstantImpl &amp;&amp; ((HotSpotObjectConstantImpl) x).object() == ((HotSpotObjectConstantImpl) y).object();</span>
          } else {
              return Objects.equals(x, y);
          }
      }
  
<span class="line-new-header">--- 62,11 ---</span>
      @Override
      public Boolean constantEquals(Constant x, Constant y) {
          if (x == y) {
              return true;
          } else if (x instanceof HotSpotObjectConstantImpl) {
<span class="line-modified">!             return y instanceof HotSpotObjectConstantImpl &amp;&amp; x.equals(y);</span>
          } else {
              return Objects.equals(x, y);
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 75,34 ***</span>
      public Integer readArrayLength(JavaConstant array) {
          if (array == null || array.getJavaKind() != JavaKind.Object || array.isNull()) {
              return null;
          }
  
<span class="line-modified">!         Object arrayObject = ((HotSpotObjectConstantImpl) array).object();</span>
<span class="line-modified">!         if (!arrayObject.getClass().isArray()) {</span>
<span class="line-removed">-             return null;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return Array.getLength(arrayObject);</span>
      }
  
      @Override
      public JavaConstant readArrayElement(JavaConstant array, int index) {
          if (array == null || array.getJavaKind() != JavaKind.Object || array.isNull()) {
              return null;
          }
<span class="line-modified">!         Object a = ((HotSpotObjectConstantImpl) array).object();</span>
<span class="line-modified">! </span>
<span class="line-removed">-         if (!a.getClass().isArray() || index &lt; 0 || index &gt;= Array.getLength(a)) {</span>
<span class="line-removed">-             return null;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (a instanceof Object[]) {</span>
<span class="line-removed">-             Object element = ((Object[]) a)[index];</span>
<span class="line-removed">-             return HotSpotObjectConstantImpl.forObject(element);</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             return JavaConstant.forBoxedPrimitive(Array.get(a, index));</span>
<span class="line-removed">-         }</span>
      }
  
      /**
       * Check if the constant is a boxed value that is guaranteed to be cached by the platform.
       * Otherwise the generated code might be the only reference to the boxed value and since object
<span class="line-new-header">--- 74,21 ---</span>
      public Integer readArrayLength(JavaConstant array) {
          if (array == null || array.getJavaKind() != JavaKind.Object || array.isNull()) {
              return null;
          }
  
<span class="line-modified">!         HotSpotObjectConstantImpl arrayObject = ((HotSpotObjectConstantImpl) array);</span>
<span class="line-modified">!         return runtime.getReflection().getLength(arrayObject);</span>
      }
  
      @Override
      public JavaConstant readArrayElement(JavaConstant array, int index) {
          if (array == null || array.getJavaKind() != JavaKind.Object || array.isNull()) {
              return null;
          }
<span class="line-modified">!         HotSpotObjectConstantImpl arrayObject = ((HotSpotObjectConstantImpl) array);</span>
<span class="line-modified">!         return runtime.getReflection().readArrayElement(arrayObject, index);</span>
      }
  
      /**
       * Check if the constant is a boxed value that is guaranteed to be cached by the platform.
       * Otherwise the generated code might be the only reference to the boxed value and since object
</pre>
<hr />
<pre>
<span class="line-old-header">*** 133,43 ***</span>
      @Override
      public JavaConstant boxPrimitive(JavaConstant source) {
          if (source == null || !source.getJavaKind().isPrimitive() || !isBoxCached(source)) {
              return null;
          }
<span class="line-modified">!         return HotSpotObjectConstantImpl.forObject(source.asBoxedPrimitive());</span>
      }
  
      @Override
      public JavaConstant unboxPrimitive(JavaConstant source) {
          if (source == null || !source.getJavaKind().isObject()) {
              return null;
          }
          if (source.isNull()) {
              return null;
          }
<span class="line-modified">!         return JavaConstant.forBoxedPrimitive(((HotSpotObjectConstantImpl) source).object());</span>
      }
  
      @Override
      public JavaConstant forString(String value) {
<span class="line-modified">!         return HotSpotObjectConstantImpl.forObject(value);</span>
      }
  
      public JavaConstant forObject(Object value) {
<span class="line-modified">!         return HotSpotObjectConstantImpl.forObject(value);</span>
      }
  
      @Override
      public ResolvedJavaType asJavaType(Constant constant) {
<span class="line-modified">!         if (constant instanceof HotSpotObjectConstant) {</span>
<span class="line-modified">!             Object obj = ((HotSpotObjectConstantImpl) constant).object();</span>
<span class="line-removed">-             if (obj instanceof Class) {</span>
<span class="line-removed">-                 return runtime.getHostJVMCIBackend().getMetaAccess().lookupJavaType((Class&lt;?&gt;) obj);</span>
<span class="line-removed">-             }</span>
          }
          if (constant instanceof HotSpotMetaspaceConstant) {
<span class="line-modified">!             MetaspaceWrapperObject obj = HotSpotMetaspaceConstantImpl.getMetaspaceObject(constant);</span>
              if (obj instanceof HotSpotResolvedObjectTypeImpl) {
                  return (ResolvedJavaType) obj;
              }
          }
          return null;
<span class="line-new-header">--- 119,40 ---</span>
      @Override
      public JavaConstant boxPrimitive(JavaConstant source) {
          if (source == null || !source.getJavaKind().isPrimitive() || !isBoxCached(source)) {
              return null;
          }
<span class="line-modified">!         return runtime.getReflection().boxPrimitive(source);</span>
      }
  
      @Override
      public JavaConstant unboxPrimitive(JavaConstant source) {
          if (source == null || !source.getJavaKind().isObject()) {
              return null;
          }
          if (source.isNull()) {
              return null;
          }
<span class="line-modified">!         return runtime.getReflection().unboxPrimitive((HotSpotObjectConstantImpl) source);</span>
      }
  
      @Override
      public JavaConstant forString(String value) {
<span class="line-modified">!         return runtime.getReflection().forObject(value);</span>
      }
  
      public JavaConstant forObject(Object value) {
<span class="line-modified">!         return runtime.getReflection().forObject(value);</span>
      }
  
      @Override
      public ResolvedJavaType asJavaType(Constant constant) {
<span class="line-modified">!         if (constant instanceof HotSpotObjectConstantImpl) {</span>
<span class="line-modified">!             return ((HotSpotObjectConstantImpl) constant).asJavaType();</span>
          }
          if (constant instanceof HotSpotMetaspaceConstant) {
<span class="line-modified">!             MetaspaceObject obj = HotSpotMetaspaceConstantImpl.getMetaspaceObject(constant);</span>
              if (obj instanceof HotSpotResolvedObjectTypeImpl) {
                  return (ResolvedJavaType) obj;
              }
          }
          return null;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 177,28 ***</span>
  
      @Override
      public JavaConstant readFieldValue(ResolvedJavaField field, JavaConstant receiver) {
          HotSpotResolvedJavaField hotspotField = (HotSpotResolvedJavaField) field;
          if (hotspotField.isStatic()) {
<span class="line-modified">!             HotSpotResolvedJavaType holder = (HotSpotResolvedJavaType) hotspotField.getDeclaringClass();</span>
              if (holder.isInitialized()) {
<span class="line-modified">!                 return memoryAccess.readFieldValue(hotspotField, holder.mirror(), field.isVolatile());</span>
              }
          } else {
<span class="line-modified">!             if (receiver.isNonNull()) {</span>
<span class="line-modified">!                 Object object = ((HotSpotObjectConstantImpl) receiver).object();</span>
                  if (hotspotField.isInObject(receiver)) {
<span class="line-modified">!                     return memoryAccess.readFieldValue(hotspotField, object, field.isVolatile());</span>
                  }
              }
          }
          return null;
      }
  
      @Override
      public JavaConstant asJavaClass(ResolvedJavaType type) {
<span class="line-modified">!         return HotSpotObjectConstantImpl.forObject(((HotSpotResolvedJavaType) type).mirror());</span>
      }
  
      @Override
      public Constant asObjectHub(ResolvedJavaType type) {
          if (type instanceof HotSpotResolvedObjectType) {
<span class="line-new-header">--- 160,28 ---</span>
  
      @Override
      public JavaConstant readFieldValue(ResolvedJavaField field, JavaConstant receiver) {
          HotSpotResolvedJavaField hotspotField = (HotSpotResolvedJavaField) field;
          if (hotspotField.isStatic()) {
<span class="line-modified">!             HotSpotResolvedObjectTypeImpl holder = (HotSpotResolvedObjectTypeImpl) hotspotField.getDeclaringClass();</span>
              if (holder.isInitialized()) {
<span class="line-modified">!                 return holder.readFieldValue(hotspotField, field.isVolatile());</span>
              }
          } else {
<span class="line-modified">!             if (receiver.isNonNull() &amp;&amp; receiver instanceof HotSpotObjectConstantImpl) {</span>
<span class="line-modified">!                 HotSpotObjectConstantImpl object = ((HotSpotObjectConstantImpl) receiver);</span>
                  if (hotspotField.isInObject(receiver)) {
<span class="line-modified">!                     return object.readFieldValue(hotspotField, field.isVolatile());</span>
                  }
              }
          }
          return null;
      }
  
      @Override
      public JavaConstant asJavaClass(ResolvedJavaType type) {
<span class="line-modified">!         return ((HotSpotResolvedJavaType) type).getJavaMirror();</span>
      }
  
      @Override
      public Constant asObjectHub(ResolvedJavaType type) {
          if (type instanceof HotSpotResolvedObjectType) {
</pre>
<center><a href="HotSpotConstantPoolObject.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotInstalledCode.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>