<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotObjectConstantImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotNmethod.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotResolvedJavaFieldImpl.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotObjectConstantImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2009, 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2009, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -20,148 +20,82 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package jdk.vm.ci.hotspot;
  
<span class="udiff-line-modified-removed">- import static jdk.vm.ci.hotspot.HotSpotResolvedObjectTypeImpl.fromObjectClass;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- import java.lang.invoke.CallSite;</span>
<span class="udiff-line-removed">- import java.lang.invoke.ConstantCallSite;</span>
<span class="udiff-line-removed">- import java.lang.invoke.MethodHandle;</span>
<span class="udiff-line-modified-added">+ import static jdk.vm.ci.hotspot.HotSpotJVMCIRuntime.runtime;</span>
  
  import jdk.vm.ci.meta.Assumptions;
<span class="udiff-line-removed">- import jdk.vm.ci.meta.Constant;</span>
  import jdk.vm.ci.meta.JavaConstant;
  import jdk.vm.ci.meta.JavaKind;
  import jdk.vm.ci.meta.ResolvedJavaType;
  
  /**
   * Represents a constant non-{@code null} object reference, within the compiler and across the
   * compiler/runtime interface.
   */
<span class="udiff-line-modified-removed">- class HotSpotObjectConstantImpl implements HotSpotObjectConstant {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static JavaConstant forObject(Object object) {</span>
<span class="udiff-line-removed">-         return forObject(object, false);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static JavaConstant forObject(Object object, boolean compressed) {</span>
<span class="udiff-line-removed">-         if (object == null) {</span>
<span class="udiff-line-removed">-             return compressed ? HotSpotCompressedNullConstant.COMPRESSED_NULL : JavaConstant.NULL_POINTER;</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             return new HotSpotObjectConstantImpl(object, compressed);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static JavaConstant forBoxedValue(JavaKind kind, Object value) {</span>
<span class="udiff-line-removed">-         if (kind == JavaKind.Object) {</span>
<span class="udiff-line-removed">-             return HotSpotObjectConstantImpl.forObject(value);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             return JavaConstant.forBoxedPrimitive(value);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static Object asBoxedValue(Constant constant) {</span>
<span class="udiff-line-removed">-         if (JavaConstant.isNull(constant)) {</span>
<span class="udiff-line-removed">-             return null;</span>
<span class="udiff-line-removed">-         } else if (constant instanceof HotSpotObjectConstantImpl) {</span>
<span class="udiff-line-removed">-             return ((HotSpotObjectConstantImpl) constant).object;</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             return ((JavaConstant) constant).asBoxedPrimitive();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ abstract class HotSpotObjectConstantImpl implements HotSpotObjectConstant {</span>
  
<span class="udiff-line-modified-removed">-     private final Object object;</span>
<span class="udiff-line-removed">-     private final boolean compressed;</span>
<span class="udiff-line-modified-added">+     protected final boolean compressed;</span>
  
<span class="udiff-line-modified-removed">-     protected HotSpotObjectConstantImpl(Object object, boolean compressed) {</span>
<span class="udiff-line-removed">-         this.object = object;</span>
<span class="udiff-line-modified-added">+     HotSpotObjectConstantImpl(boolean compressed) {</span>
          this.compressed = compressed;
<span class="udiff-line-removed">-         assert object != null;</span>
      }
  
      @Override
      public JavaKind getJavaKind() {
          return JavaKind.Object;
      }
  
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Package-private accessor for the object represented by this constant.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     Object object() {</span>
<span class="udiff-line-removed">-         return object;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      @Override
      public boolean isCompressed() {
          return compressed;
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public JavaConstant compress() {</span>
<span class="udiff-line-removed">-         assert !compressed;</span>
<span class="udiff-line-removed">-         return new HotSpotObjectConstantImpl(object, true);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     public abstract JavaConstant compress();</span>
  
      @Override
<span class="udiff-line-modified-removed">-     public JavaConstant uncompress() {</span>
<span class="udiff-line-removed">-         assert compressed;</span>
<span class="udiff-line-removed">-         return new HotSpotObjectConstantImpl(object, false);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     public abstract JavaConstant uncompress();</span>
  
      @Override
      public HotSpotResolvedObjectType getType() {
<span class="udiff-line-modified-removed">-         return fromObjectClass(object.getClass());</span>
<span class="udiff-line-modified-added">+         return runtime().reflection.getType(this);</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public int getIdentityHashCode() {</span>
<span class="udiff-line-removed">-         return System.identityHashCode(object);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     public abstract int getIdentityHashCode();</span>
  
      @Override
      public JavaConstant getCallSiteTarget(Assumptions assumptions) {
<span class="udiff-line-modified-removed">-         if (object instanceof CallSite) {</span>
<span class="udiff-line-modified-removed">-             CallSite callSite = (CallSite) object;</span>
<span class="udiff-line-modified-removed">-             MethodHandle target = callSite.getTarget();</span>
<span class="udiff-line-modified-removed">-             JavaConstant targetConstant = HotSpotObjectConstantImpl.forObject(target);</span>
<span class="udiff-line-removed">-             if (!(callSite instanceof ConstantCallSite)) {</span>
<span class="udiff-line-modified-added">+         if (runtime().getCallSite().isInstance(this)) {</span>
<span class="udiff-line-modified-added">+             HotSpotObjectConstantImpl target = (HotSpotObjectConstantImpl) runtime().getHostJVMCIBackend().getConstantReflection().readFieldValue(</span>
<span class="udiff-line-modified-added">+                             HotSpotMethodHandleAccessProvider.Internals.instance().callSiteTargetField, this);</span>
<span class="udiff-line-modified-added">+             if (!runtime().getConstantCallSite().isInstance(this)) {</span>
                  if (assumptions == null) {
                      return null;
                  }
<span class="udiff-line-modified-removed">-                 assumptions.record(new Assumptions.CallSiteTargetValue(this, targetConstant));</span>
<span class="udiff-line-modified-added">+                 assumptions.record(new Assumptions.CallSiteTargetValue(this, target));</span>
              }
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-             return targetConstant;</span>
<span class="udiff-line-modified-added">+             return target;</span>
          }
          return null;
      }
  
      @Override
<span class="udiff-line-removed">-     @SuppressFBWarnings(value = &quot;ES_COMPARING_STRINGS_WITH_EQ&quot;, justification = &quot;reference equality is what we want&quot;)</span>
      public boolean isInternedString() {
<span class="udiff-line-modified-removed">-         if (object instanceof String) {</span>
<span class="udiff-line-removed">-             String s = (String) object;</span>
<span class="udiff-line-removed">-             return s.intern() == s;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-modified-added">+         return runtime().compilerToVm.isInternedString(this);</span>
      }
  
      @Override
      public &lt;T&gt; T asObject(Class&lt;T&gt; type) {
<span class="udiff-line-modified-removed">-         if (type.isInstance(object)) {</span>
<span class="udiff-line-removed">-             return type.cast(object);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return null;</span>
<span class="udiff-line-modified-added">+         return runtime().reflection.asObject(this, type);</span>
      }
  
      @Override
      public Object asObject(ResolvedJavaType type) {
<span class="udiff-line-modified-removed">-         if (type.isInstance(this)) {</span>
<span class="udiff-line-removed">-             return object;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return null;</span>
<span class="udiff-line-modified-added">+         return runtime().reflection.asObject(this, (HotSpotResolvedJavaType) type);</span>
      }
  
      @Override
      public boolean isNull() {
          return false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -200,35 +134,43 @@</span>
      @Override
      public double asDouble() {
          throw new IllegalArgumentException();
      }
  
<span class="udiff-line-removed">-     @Override</span>
<span class="udiff-line-removed">-     public int hashCode() {</span>
<span class="udiff-line-removed">-         return System.identityHashCode(object);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      @Override
      public boolean equals(Object o) {
          if (o == this) {
              return true;
          } else if (o instanceof HotSpotObjectConstantImpl) {
              HotSpotObjectConstantImpl other = (HotSpotObjectConstantImpl) o;
<span class="udiff-line-modified-removed">-             return object == other.object &amp;&amp; compressed == other.compressed;</span>
<span class="udiff-line-modified-added">+             return runtime().reflection.equals(this, other);</span>
          }
          return false;
      }
  
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public int hashCode() {</span>
<span class="udiff-line-added">+         return getIdentityHashCode();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      @Override
      public String toValueString() {
<span class="udiff-line-modified-removed">-         if (object instanceof String) {</span>
<span class="udiff-line-modified-removed">-             return &quot;\&quot;&quot; + (String) object + &quot;\&quot;&quot;;</span>
<span class="udiff-line-modified-added">+         if (runtime().getJavaLangString().isInstance(this)) {</span>
<span class="udiff-line-modified-added">+             return &quot;\&quot;&quot; + runtime().reflection.asString(this) + &quot;\&quot;&quot;;</span>
          } else {
<span class="udiff-line-modified-removed">-             return JavaKind.Object.format(object);</span>
<span class="udiff-line-modified-added">+             return runtime().reflection.formatString(this);</span>
          }
      }
  
      @Override
      public String toString() {
<span class="udiff-line-modified-removed">-         return (compressed ? &quot;NarrowOop&quot; : getJavaKind().getJavaName()) + &quot;[&quot; + JavaKind.Object.format(object) + &quot;]&quot;;</span>
<span class="udiff-line-modified-added">+         return (compressed ? &quot;NarrowOop&quot; : getJavaKind().getJavaName()) + &quot;[&quot; + runtime().reflection.formatString(this) + &quot;]&quot;;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public JavaConstant readFieldValue(HotSpotResolvedJavaField field, boolean isVolatile) {</span>
<span class="udiff-line-added">+         return runtime().reflection.readFieldValue(this, field, isVolatile);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public ResolvedJavaType asJavaType() {</span>
<span class="udiff-line-added">+         return runtime().reflection.asJavaType(this);</span>
      }
  }
</pre>
<center><a href="HotSpotNmethod.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotResolvedJavaFieldImpl.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>