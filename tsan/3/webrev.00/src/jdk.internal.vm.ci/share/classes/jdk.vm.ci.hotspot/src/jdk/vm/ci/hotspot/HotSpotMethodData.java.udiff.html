<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotMethodData.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotMethod.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotMethodDataAccessor.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotMethodData.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,10 +28,11 @@</span>
  import static jdk.vm.ci.hotspot.HotSpotVMConfig.config;
  import static jdk.vm.ci.hotspot.UnsafeAccess.UNSAFE;
  
  import java.util.Arrays;
  
<span class="udiff-line-added">+ import jdk.vm.ci.common.NativeImageReinitialize;</span>
  import jdk.internal.misc.Unsafe;
  import jdk.vm.ci.meta.DeoptimizationReason;
  import jdk.vm.ci.meta.JavaMethodProfile;
  import jdk.vm.ci.meta.JavaMethodProfile.ProfiledMethod;
  import jdk.vm.ci.meta.JavaTypeProfile;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -43,41 +44,154 @@</span>
  /**
   * Access to a HotSpot {@code MethodData} structure (defined in methodData.hpp).
   */
  final class HotSpotMethodData {
  
<span class="udiff-line-modified-removed">-     static final HotSpotVMConfig config = config();</span>
<span class="udiff-line-modified-removed">-     static final HotSpotMethodDataAccessor NO_DATA_NO_EXCEPTION_ACCESSOR = new NoMethodData(config, config.dataLayoutNoTag, TriState.FALSE);</span>
<span class="udiff-line-modified-removed">-     static final HotSpotMethodDataAccessor NO_DATA_EXCEPTION_POSSIBLY_NOT_RECORDED_ACCESSOR = new NoMethodData(config, config.dataLayoutNoTag, TriState.UNKNOWN);</span>
<span class="udiff-line-modified-added">+     /**</span>
<span class="udiff-line-modified-added">+      * VM state that can be reset when building an AOT image.</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-added">+     static final class VMState {</span>
<span class="udiff-line-added">+         final HotSpotVMConfig config = config();</span>
<span class="udiff-line-added">+         final HotSpotMethodDataAccessor noDataNoExceptionAccessor = new NoMethodData(this, config.dataLayoutNoTag, TriState.FALSE);</span>
<span class="udiff-line-added">+         final HotSpotMethodDataAccessor noDataExceptionPossiblyNotRecordedAccessor = new NoMethodData(this, config.dataLayoutNoTag, TriState.UNKNOWN);</span>
<span class="udiff-line-added">+         final int noDataSize = cellIndexToOffset(0);</span>
<span class="udiff-line-added">+         final int bitDataSize = cellIndexToOffset(0);</span>
<span class="udiff-line-added">+         final int bitDataNullSeenFlag = 1 &lt;&lt; config.bitDataNullSeenFlag;</span>
<span class="udiff-line-added">+         final int counterDataSize = cellIndexToOffset(1);</span>
<span class="udiff-line-added">+         final int counterDataCountOffset = cellIndexToOffset(config.methodDataCountOffset);</span>
<span class="udiff-line-added">+         final int jumpDataSize = cellIndexToOffset(2);</span>
<span class="udiff-line-added">+         final int takenCountOffset = cellIndexToOffset(config.jumpDataTakenOffset);</span>
<span class="udiff-line-added">+         final int takenDisplacementOffset = cellIndexToOffset(config.jumpDataDisplacementOffset);</span>
<span class="udiff-line-added">+         final int typeDataRowSize = cellsToBytes(config.receiverTypeDataReceiverTypeRowCellCount);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final int nonprofiledCountOffset = cellIndexToOffset(config.receiverTypeDataNonprofiledCountOffset);</span>
<span class="udiff-line-added">+         final int typeDataFirstTypeOffset = cellIndexToOffset(config.receiverTypeDataReceiver0Offset);</span>
<span class="udiff-line-added">+         final int typeDataFirstTypeCountOffset = cellIndexToOffset(config.receiverTypeDataCount0Offset);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final int typeCheckDataSize = cellIndexToOffset(2) + typeDataRowSize * config.typeProfileWidth;</span>
<span class="udiff-line-added">+         final int virtualCallDataSize = cellIndexToOffset(2) + typeDataRowSize * (config.typeProfileWidth + config.methodProfileWidth);</span>
<span class="udiff-line-added">+         final int virtualCallDataFirstMethodOffset = typeDataFirstTypeOffset + typeDataRowSize * config.typeProfileWidth;</span>
<span class="udiff-line-added">+         final int virtualCallDataFirstMethodCountOffset = typeDataFirstTypeCountOffset + typeDataRowSize * config.typeProfileWidth;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final int retDataRowSize = cellsToBytes(3);</span>
<span class="udiff-line-added">+         final int retDataSize = cellIndexToOffset(1) + retDataRowSize * config.bciProfileWidth;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final int branchDataSize = cellIndexToOffset(3);</span>
<span class="udiff-line-added">+         final int notTakenCountOffset = cellIndexToOffset(config.branchDataNotTakenOffset);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final int arrayDataLengthOffset = cellIndexToOffset(config.arrayDataArrayLenOffset);</span>
<span class="udiff-line-added">+         final int arrayDataStartOffset = cellIndexToOffset(config.arrayDataArrayStartOffset);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final int multiBranchDataSize = cellIndexToOffset(1);</span>
<span class="udiff-line-added">+         final int multiBranchDataRowSizeInCells = config.multiBranchDataPerCaseCellCount;</span>
<span class="udiff-line-added">+         final int multiBranchDataRowSize = cellsToBytes(multiBranchDataRowSizeInCells);</span>
<span class="udiff-line-added">+         final int multiBranchDataFirstCountOffset = arrayDataStartOffset + cellsToBytes(0);</span>
<span class="udiff-line-added">+         final int multiBranchDataFirstDisplacementOffset = arrayDataStartOffset + cellsToBytes(1);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         final int argInfoDataSize = cellIndexToOffset(1);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // sorted by tag</span>
<span class="udiff-line-added">+         // @formatter:off</span>
<span class="udiff-line-added">+         final HotSpotMethodDataAccessor[] profileDataAccessors = {</span>
<span class="udiff-line-added">+             null,</span>
<span class="udiff-line-added">+             new BitData(this, config.dataLayoutBitDataTag),</span>
<span class="udiff-line-added">+             new CounterData(this, config.dataLayoutCounterDataTag),</span>
<span class="udiff-line-added">+             new JumpData(this, config.dataLayoutJumpDataTag),</span>
<span class="udiff-line-added">+             new ReceiverTypeData(this, config.dataLayoutReceiverTypeDataTag),</span>
<span class="udiff-line-added">+             new VirtualCallData(this, config.dataLayoutVirtualCallDataTag),</span>
<span class="udiff-line-added">+             new RetData(this, config.dataLayoutRetDataTag),</span>
<span class="udiff-line-added">+             new BranchData(this, config.dataLayoutBranchDataTag),</span>
<span class="udiff-line-added">+             new MultiBranchData(this, config.dataLayoutMultiBranchDataTag),</span>
<span class="udiff-line-added">+             new ArgInfoData(this, config.dataLayoutArgInfoDataTag),</span>
<span class="udiff-line-added">+             new UnknownProfileData(this, config.dataLayoutCallTypeDataTag),</span>
<span class="udiff-line-added">+             new VirtualCallTypeData(this, config.dataLayoutVirtualCallTypeDataTag),</span>
<span class="udiff-line-added">+             new UnknownProfileData(this, config.dataLayoutParametersTypeDataTag),</span>
<span class="udiff-line-added">+             new UnknownProfileData(this, config.dataLayoutSpeculativeTrapDataTag),</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+         // @formatter:on</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private boolean checkAccessorTags() {</span>
<span class="udiff-line-added">+             int expectedTag = 0;</span>
<span class="udiff-line-added">+             for (HotSpotMethodDataAccessor accessor : profileDataAccessors) {</span>
<span class="udiff-line-added">+                 if (expectedTag == 0) {</span>
<span class="udiff-line-added">+                     assert accessor == null;</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     assert accessor.tag == expectedTag : expectedTag + &quot; != &quot; + accessor.tag + &quot; &quot; + accessor;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 expectedTag++;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private VMState() {</span>
<span class="udiff-line-added">+             assert checkAccessorTags();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private static int truncateLongToInt(long value) {</span>
<span class="udiff-line-added">+             return value &gt; Integer.MAX_VALUE ? Integer.MAX_VALUE : (int) value;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private int computeFullOffset(int position, int offsetInBytes) {</span>
<span class="udiff-line-added">+             return config.methodDataOopDataOffset + position + offsetInBytes;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private int cellIndexToOffset(int cells) {</span>
<span class="udiff-line-added">+             return config.dataLayoutHeaderSize + cellsToBytes(cells);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private int cellsToBytes(int cells) {</span>
<span class="udiff-line-added">+             return cells * config.dataLayoutCellSize;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         /**</span>
<span class="udiff-line-added">+          * Singleton instance lazily initialized via double-checked locking.</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         @NativeImageReinitialize private static volatile VMState instance;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static VMState instance() {</span>
<span class="udiff-line-added">+             VMState result = instance;</span>
<span class="udiff-line-added">+             if (result == null) {</span>
<span class="udiff-line-added">+                 synchronized (VMState.class) {</span>
<span class="udiff-line-added">+                     result = instance;</span>
<span class="udiff-line-added">+                     if (result == null) {</span>
<span class="udiff-line-added">+                         instance = result = new VMState();</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return result;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  
      /**
       * Reference to the C++ MethodData object.
       */
      final long metaspaceMethodData;
      private final HotSpotResolvedJavaMethodImpl method;
<span class="udiff-line-added">+     private final VMState state;</span>
  
      HotSpotMethodData(long metaspaceMethodData, HotSpotResolvedJavaMethodImpl method) {
          this.metaspaceMethodData = metaspaceMethodData;
          this.method = method;
<span class="udiff-line-added">+         this.state = VMState.instance();</span>
      }
  
      /**
       * @return value of the MethodData::_data_size field
       */
      private int normalDataSize() {
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(metaspaceMethodData + config.methodDataDataSize);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(metaspaceMethodData + state.config.methodDataDataSize);</span>
      }
  
      /**
       * Returns the size of the extra data records. This method does the same calculation as
       * MethodData::extra_data_size().
       *
       * @return size of extra data records
       */
      private int extraDataSize() {
<span class="udiff-line-modified-removed">-         final int extraDataBase = config.methodDataOopDataOffset + normalDataSize();</span>
<span class="udiff-line-modified-removed">-         final int extraDataLimit = UNSAFE.getInt(metaspaceMethodData + config.methodDataSize);</span>
<span class="udiff-line-modified-added">+         final int extraDataBase = state.config.methodDataOopDataOffset + normalDataSize();</span>
<span class="udiff-line-modified-added">+         final int extraDataLimit = UNSAFE.getInt(metaspaceMethodData + state.config.methodDataSize);</span>
          return extraDataLimit - extraDataBase;
      }
  
      public boolean hasNormalData() {
          return normalDataSize() &gt; 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -96,29 +210,29 @@</span>
      }
  
      public int getDeoptimizationCount(DeoptimizationReason reason) {
          HotSpotMetaAccessProvider metaAccess = (HotSpotMetaAccessProvider) runtime().getHostJVMCIBackend().getMetaAccess();
          int reasonIndex = metaAccess.convertDeoptReason(reason);
<span class="udiff-line-modified-removed">-         return UNSAFE.getByte(metaspaceMethodData + config.methodDataOopTrapHistoryOffset + reasonIndex) &amp; 0xFF;</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getByte(metaspaceMethodData + state.config.methodDataOopTrapHistoryOffset + reasonIndex) &amp; 0xFF;</span>
      }
  
      public int getOSRDeoptimizationCount(DeoptimizationReason reason) {
          HotSpotMetaAccessProvider metaAccess = (HotSpotMetaAccessProvider) runtime().getHostJVMCIBackend().getMetaAccess();
          int reasonIndex = metaAccess.convertDeoptReason(reason);
<span class="udiff-line-modified-removed">-         return UNSAFE.getByte(metaspaceMethodData + config.methodDataOopTrapHistoryOffset + config.deoptReasonOSROffset + reasonIndex) &amp; 0xFF;</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getByte(metaspaceMethodData + state.config.methodDataOopTrapHistoryOffset + state.config.deoptReasonOSROffset + reasonIndex) &amp; 0xFF;</span>
      }
  
      public int getDecompileCount() {
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(metaspaceMethodData + config.methodDataDecompiles);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(metaspaceMethodData + state.config.methodDataDecompiles);</span>
      }
  
      public int getOverflowRecompileCount() {
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(metaspaceMethodData + config.methodDataOverflowRecompiles);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(metaspaceMethodData + state.config.methodDataOverflowRecompiles);</span>
      }
  
      public int getOverflowTrapCount() {
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(metaspaceMethodData + config.methodDataOverflowTraps);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(metaspaceMethodData + state.config.methodDataOverflowTraps);</span>
      }
  
      public HotSpotMethodDataAccessor getNormalData(int position) {
          if (position &gt;= normalDataSize()) {
              return null;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -138,81 +252,65 @@</span>
          return data;
      }
  
      public static HotSpotMethodDataAccessor getNoDataAccessor(boolean exceptionPossiblyNotRecorded) {
          if (exceptionPossiblyNotRecorded) {
<span class="udiff-line-modified-removed">-             return NO_DATA_EXCEPTION_POSSIBLY_NOT_RECORDED_ACCESSOR;</span>
<span class="udiff-line-modified-added">+             return VMState.instance().noDataExceptionPossiblyNotRecordedAccessor;</span>
          } else {
<span class="udiff-line-modified-removed">-             return NO_DATA_NO_EXCEPTION_ACCESSOR;</span>
<span class="udiff-line-modified-added">+             return VMState.instance().noDataNoExceptionAccessor;</span>
          }
      }
  
      private HotSpotMethodDataAccessor getData(int position) {
          assert position &gt;= 0 : &quot;out of bounds&quot;;
<span class="udiff-line-modified-removed">-         final int tag = HotSpotMethodDataAccessor.readTag(config, this, position);</span>
<span class="udiff-line-modified-removed">-         HotSpotMethodDataAccessor accessor = PROFILE_DATA_ACCESSORS[tag];</span>
<span class="udiff-line-modified-added">+         final int tag = HotSpotMethodDataAccessor.readTag(state.config, this, position);</span>
<span class="udiff-line-modified-added">+         HotSpotMethodDataAccessor accessor = state.profileDataAccessors[tag];</span>
          assert accessor == null || accessor.getTag() == tag : &quot;wrong data accessor &quot; + accessor + &quot; for tag &quot; + tag;
          return accessor;
      }
  
      int readUnsignedByte(int position, int offsetInBytes) {
<span class="udiff-line-modified-removed">-         long fullOffsetInBytes = computeFullOffset(position, offsetInBytes);</span>
<span class="udiff-line-modified-added">+         long fullOffsetInBytes = state.computeFullOffset(position, offsetInBytes);</span>
          return UNSAFE.getByte(metaspaceMethodData + fullOffsetInBytes) &amp; 0xFF;
      }
  
      int readUnsignedShort(int position, int offsetInBytes) {
<span class="udiff-line-modified-removed">-         long fullOffsetInBytes = computeFullOffset(position, offsetInBytes);</span>
<span class="udiff-line-modified-added">+         long fullOffsetInBytes = state.computeFullOffset(position, offsetInBytes);</span>
          return UNSAFE.getShort(metaspaceMethodData + fullOffsetInBytes) &amp; 0xFFFF;
      }
  
      /**
       * Since the values are stored in cells (platform words) this method uses
       * {@link Unsafe#getAddress} to read the right value on both little and big endian machines.
       */
      private long readUnsignedInt(int position, int offsetInBytes) {
<span class="udiff-line-modified-removed">-         long fullOffsetInBytes = computeFullOffset(position, offsetInBytes);</span>
<span class="udiff-line-modified-added">+         long fullOffsetInBytes = state.computeFullOffset(position, offsetInBytes);</span>
          return UNSAFE.getAddress(metaspaceMethodData + fullOffsetInBytes) &amp; 0xFFFFFFFFL;
      }
  
      private int readUnsignedIntAsSignedInt(int position, int offsetInBytes) {
          long value = readUnsignedInt(position, offsetInBytes);
<span class="udiff-line-modified-removed">-         return truncateLongToInt(value);</span>
<span class="udiff-line-modified-added">+         return VMState.truncateLongToInt(value);</span>
      }
  
      /**
       * Since the values are stored in cells (platform words) this method uses
       * {@link Unsafe#getAddress} to read the right value on both little and big endian machines.
       */
      private int readInt(int position, int offsetInBytes) {
<span class="udiff-line-modified-removed">-         long fullOffsetInBytes = computeFullOffset(position, offsetInBytes);</span>
<span class="udiff-line-modified-added">+         long fullOffsetInBytes = state.computeFullOffset(position, offsetInBytes);</span>
          return (int) UNSAFE.getAddress(metaspaceMethodData + fullOffsetInBytes);
      }
  
      private HotSpotResolvedJavaMethod readMethod(int position, int offsetInBytes) {
<span class="udiff-line-modified-removed">-         long fullOffsetInBytes = computeFullOffset(position, offsetInBytes);</span>
<span class="udiff-line-modified-added">+         long fullOffsetInBytes = state.computeFullOffset(position, offsetInBytes);</span>
          return compilerToVM().getResolvedJavaMethod(null, metaspaceMethodData + fullOffsetInBytes);
      }
  
      private HotSpotResolvedObjectTypeImpl readKlass(int position, int offsetInBytes) {
<span class="udiff-line-modified-removed">-         long fullOffsetInBytes = computeFullOffset(position, offsetInBytes);</span>
<span class="udiff-line-modified-removed">-         return compilerToVM().getResolvedJavaType(null, metaspaceMethodData + fullOffsetInBytes, false);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static int truncateLongToInt(long value) {</span>
<span class="udiff-line-removed">-         return value &gt; Integer.MAX_VALUE ? Integer.MAX_VALUE : (int) value;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static int computeFullOffset(int position, int offsetInBytes) {</span>
<span class="udiff-line-removed">-         return config.methodDataOopDataOffset + position + offsetInBytes;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static int cellIndexToOffset(int cells) {</span>
<span class="udiff-line-removed">-         return config.dataLayoutHeaderSize + cellsToBytes(cells);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static int cellsToBytes(int cells) {</span>
<span class="udiff-line-removed">-         return cells * config.dataLayoutCellSize;</span>
<span class="udiff-line-modified-added">+         long fullOffsetInBytes = state.computeFullOffset(position, offsetInBytes);</span>
<span class="udiff-line-modified-added">+         return compilerToVM().getResolvedJavaType(metaspaceMethodData + fullOffsetInBytes, false);</span>
      }
  
      /**
       * Returns whether profiling ran long enough that the profile information is mature. Other
       * informational data will still be valid even if the profile isn&#39;t mature.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -261,18 +359,16 @@</span>
  
          }
          return sb.toString();
      }
  
<span class="udiff-line-removed">-     static final int NO_DATA_SIZE = cellIndexToOffset(0);</span>
<span class="udiff-line-removed">- </span>
      static class NoMethodData extends HotSpotMethodDataAccessor {
  
          private final TriState exceptionSeen;
  
<span class="udiff-line-modified-removed">-         protected NoMethodData(HotSpotVMConfig config, int tag, TriState exceptionSeen) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, NO_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         protected NoMethodData(VMState state, int tag, TriState exceptionSeen) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.noDataSize);</span>
              this.exceptionSeen = exceptionSeen;
          }
  
          @Override
          public int getBCI(HotSpotMethodData data, int position) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -288,88 +384,78 @@</span>
          public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
              return sb;
          }
      }
  
<span class="udiff-line-removed">-     static final int BIT_DATA_SIZE = cellIndexToOffset(0);</span>
<span class="udiff-line-removed">-     static final int BIT_DATA_NULL_SEEN_FLAG = 1 &lt;&lt; config.bitDataNullSeenFlag;</span>
<span class="udiff-line-removed">- </span>
      static class BitData extends HotSpotMethodDataAccessor {
  
<span class="udiff-line-modified-removed">-         private BitData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, BIT_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         private BitData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.bitDataSize);</span>
          }
  
<span class="udiff-line-modified-removed">-         protected BitData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, staticSize);</span>
<span class="udiff-line-modified-added">+         protected BitData(VMState state, int tag, int staticSize) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, staticSize);</span>
          }
  
          @Override
          public TriState getNullSeen(HotSpotMethodData data, int position) {
<span class="udiff-line-modified-removed">-             return TriState.get((getFlags(data, position) &amp; BIT_DATA_NULL_SEEN_FLAG) != 0);</span>
<span class="udiff-line-modified-added">+             return TriState.get((getFlags(data, position) &amp; state.bitDataNullSeenFlag) != 0);</span>
          }
  
          @Override
          public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
              return sb.append(format(&quot;exception_seen(%s)&quot;, getExceptionSeen(data, pos)));
          }
      }
  
<span class="udiff-line-removed">-     static final int COUNTER_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="udiff-line-removed">-     static final int COUNTER_DATA_COUNT_OFFSET = cellIndexToOffset(config.methodDataCountOffset);</span>
<span class="udiff-line-removed">- </span>
      static class CounterData extends BitData {
  
<span class="udiff-line-modified-removed">-         CounterData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, COUNTER_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         CounterData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.counterDataSize);</span>
          }
  
<span class="udiff-line-modified-removed">-         protected CounterData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, staticSize);</span>
<span class="udiff-line-modified-added">+         protected CounterData(VMState state, int tag, int staticSize) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, staticSize);</span>
          }
  
          @Override
          public int getExecutionCount(HotSpotMethodData data, int position) {
              return getCounterValue(data, position);
          }
  
          protected int getCounterValue(HotSpotMethodData data, int position) {
<span class="udiff-line-modified-removed">-             return data.readUnsignedIntAsSignedInt(position, COUNTER_DATA_COUNT_OFFSET);</span>
<span class="udiff-line-modified-added">+             return data.readUnsignedIntAsSignedInt(position, state.counterDataCountOffset);</span>
          }
  
          @Override
          public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
              return sb.append(format(&quot;count(%d) null_seen(%s) exception_seen(%s)&quot;, getCounterValue(data, pos), getNullSeen(data, pos), getExceptionSeen(data, pos)));
          }
      }
  
<span class="udiff-line-removed">-     static final int JUMP_DATA_SIZE = cellIndexToOffset(2);</span>
<span class="udiff-line-removed">-     static final int TAKEN_COUNT_OFFSET = cellIndexToOffset(config.jumpDataTakenOffset);</span>
<span class="udiff-line-removed">-     static final int TAKEN_DISPLACEMENT_OFFSET = cellIndexToOffset(config.jumpDataDisplacementOffset);</span>
<span class="udiff-line-removed">- </span>
      static class JumpData extends HotSpotMethodDataAccessor {
  
<span class="udiff-line-modified-removed">-         JumpData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, JUMP_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         JumpData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.jumpDataSize);</span>
          }
  
<span class="udiff-line-modified-removed">-         protected JumpData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, staticSize);</span>
<span class="udiff-line-modified-added">+         protected JumpData(VMState state, int tag, int staticSize) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, staticSize);</span>
          }
  
          @Override
          public double getBranchTakenProbability(HotSpotMethodData data, int position) {
              return getExecutionCount(data, position) != 0 ? 1 : 0;
          }
  
          @Override
          public int getExecutionCount(HotSpotMethodData data, int position) {
<span class="udiff-line-modified-removed">-             return data.readUnsignedIntAsSignedInt(position, TAKEN_COUNT_OFFSET);</span>
<span class="udiff-line-modified-added">+             return data.readUnsignedIntAsSignedInt(position, state.takenCountOffset);</span>
          }
  
          public int getTakenDisplacement(HotSpotMethodData data, int position) {
<span class="udiff-line-modified-removed">-             return data.readInt(position, TAKEN_DISPLACEMENT_OFFSET);</span>
<span class="udiff-line-modified-added">+             return data.readInt(position, state.takenDisplacementOffset);</span>
          }
  
          @Override
          public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
              return sb.append(format(&quot;taken(%d) displacement(%d)&quot;, getExecutionCount(data, pos), getTakenDisplacement(data, pos)));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -388,20 +474,14 @@</span>
              this.counts = counts;
              this.totalCount = totalCount;
          }
      }
  
<span class="udiff-line-removed">-     static final int TYPE_DATA_ROW_SIZE = cellsToBytes(config.receiverTypeDataReceiverTypeRowCellCount);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static final int NONPROFILED_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataNonprofiledCountOffset);</span>
<span class="udiff-line-removed">-     static final int TYPE_DATA_FIRST_TYPE_OFFSET = cellIndexToOffset(config.receiverTypeDataReceiver0Offset);</span>
<span class="udiff-line-removed">-     static final int TYPE_DATA_FIRST_TYPE_COUNT_OFFSET = cellIndexToOffset(config.receiverTypeDataCount0Offset);</span>
<span class="udiff-line-removed">- </span>
      abstract static class AbstractTypeData extends CounterData {
  
<span class="udiff-line-modified-removed">-         protected AbstractTypeData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, staticSize);</span>
<span class="udiff-line-modified-added">+         protected AbstractTypeData(VMState state, int tag, int staticSize) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, staticSize);</span>
          }
  
          @Override
          public JavaTypeProfile getTypeProfile(HotSpotMethodData data, int position) {
              return createTypeProfile(getNullSeen(data, position), getRawTypeProfile(data, position));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -444,11 +524,11 @@</span>
          }
  
          protected abstract long getTypesNotRecordedExecutionCount(HotSpotMethodData data, int position);
  
          public int getNonprofiledCount(HotSpotMethodData data, int position) {
<span class="udiff-line-modified-removed">-             return data.readUnsignedIntAsSignedInt(position, NONPROFILED_COUNT_OFFSET);</span>
<span class="udiff-line-modified-added">+             return data.readUnsignedIntAsSignedInt(position, state.nonprofiledCountOffset);</span>
          }
  
          private JavaTypeProfile createTypeProfile(TriState nullSeen, RawItemProfile&lt;ResolvedJavaType&gt; profile) {
              if (profile.entries &lt;= 0 || profile.totalCount &lt;= 0) {
                  return null;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -468,16 +548,16 @@</span>
              double notRecordedTypeProbability = profile.entries &lt; config.typeProfileWidth ? 0.0 : Math.min(1.0, Math.max(0.0, 1.0 - totalProbability));
              assert notRecordedTypeProbability == 0 || profile.entries == config.typeProfileWidth;
              return new JavaTypeProfile(nullSeen, notRecordedTypeProbability, ptypes);
          }
  
<span class="udiff-line-modified-removed">-         private static int getTypeOffset(int row) {</span>
<span class="udiff-line-modified-removed">-             return TYPE_DATA_FIRST_TYPE_OFFSET + row * TYPE_DATA_ROW_SIZE;</span>
<span class="udiff-line-modified-added">+         private int getTypeOffset(int row) {</span>
<span class="udiff-line-modified-added">+             return state.typeDataFirstTypeOffset + row * state.typeDataRowSize;</span>
          }
  
<span class="udiff-line-modified-removed">-         protected static int getTypeCountOffset(int row) {</span>
<span class="udiff-line-modified-removed">-             return TYPE_DATA_FIRST_TYPE_COUNT_OFFSET + row * TYPE_DATA_ROW_SIZE;</span>
<span class="udiff-line-modified-added">+         protected int getTypeCountOffset(int row) {</span>
<span class="udiff-line-modified-added">+             return state.typeDataFirstTypeCountOffset + row * state.typeDataRowSize;</span>
          }
  
          @Override
          public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
              RawItemProfile&lt;ResolvedJavaType&gt; profile = getRawTypeProfile(data, pos);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -491,20 +571,18 @@</span>
              }
              return sb;
          }
      }
  
<span class="udiff-line-removed">-     static final int TYPE_CHECK_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="udiff-line-removed">- </span>
      static class ReceiverTypeData extends AbstractTypeData {
  
<span class="udiff-line-modified-removed">-         ReceiverTypeData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, TYPE_CHECK_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         ReceiverTypeData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.typeCheckDataSize);</span>
          }
  
<span class="udiff-line-modified-removed">-         protected ReceiverTypeData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, staticSize);</span>
<span class="udiff-line-modified-added">+         protected ReceiverTypeData(VMState state, int tag, int staticSize) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, staticSize);</span>
          }
  
          @Override
          public int getExecutionCount(HotSpotMethodData data, int position) {
              return -1;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -514,22 +592,18 @@</span>
          protected long getTypesNotRecordedExecutionCount(HotSpotMethodData data, int position) {
              return getNonprofiledCount(data, position);
          }
      }
  
<span class="udiff-line-removed">-     static final int VIRTUAL_CALL_DATA_SIZE = cellIndexToOffset(2) + TYPE_DATA_ROW_SIZE * (config.typeProfileWidth + config.methodProfileWidth);</span>
<span class="udiff-line-removed">-     static final int VIRTUAL_CALL_DATA_FIRST_METHOD_OFFSET = TYPE_DATA_FIRST_TYPE_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="udiff-line-removed">-     static final int VIRTUAL_CALL_DATA_FIRST_METHOD_COUNT_OFFSET = TYPE_DATA_FIRST_TYPE_COUNT_OFFSET + TYPE_DATA_ROW_SIZE * config.typeProfileWidth;</span>
<span class="udiff-line-removed">- </span>
      static class VirtualCallData extends ReceiverTypeData {
  
<span class="udiff-line-modified-removed">-         VirtualCallData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, VIRTUAL_CALL_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         VirtualCallData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.virtualCallDataSize);</span>
          }
  
<span class="udiff-line-modified-removed">-         protected VirtualCallData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, staticSize);</span>
<span class="udiff-line-modified-added">+         protected VirtualCallData(VMState state, int tag, int staticSize) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, staticSize);</span>
          }
  
          @Override
          public int getExecutionCount(HotSpotMethodData data, int position) {
              final int typeProfileWidth = config.typeProfileWidth;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -538,20 +612,20 @@</span>
              for (int i = 0; i &lt; typeProfileWidth; i++) {
                  total += data.readUnsignedInt(position, getTypeCountOffset(i));
              }
  
              total += getCounterValue(data, position);
<span class="udiff-line-modified-removed">-             return truncateLongToInt(total);</span>
<span class="udiff-line-modified-added">+             return VMState.truncateLongToInt(total);</span>
          }
  
          @Override
          protected long getTypesNotRecordedExecutionCount(HotSpotMethodData data, int position) {
              return getCounterValue(data, position);
          }
  
<span class="udiff-line-modified-removed">-         private static long getMethodsNotRecordedExecutionCount(HotSpotMethodData data, int position) {</span>
<span class="udiff-line-modified-removed">-             return data.readUnsignedIntAsSignedInt(position, NONPROFILED_COUNT_OFFSET);</span>
<span class="udiff-line-modified-added">+         private long getMethodsNotRecordedExecutionCount(HotSpotMethodData data, int position) {</span>
<span class="udiff-line-modified-added">+             return data.readUnsignedIntAsSignedInt(position, state.nonprofiledCountOffset);</span>
          }
  
          @Override
          public JavaMethodProfile getMethodProfile(HotSpotMethodData data, int position) {
              return createMethodProfile(getRawMethodProfile(data, position));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -608,16 +682,16 @@</span>
              double notRecordedMethodProbability = profile.entries &lt; config.methodProfileWidth ? 0.0 : Math.min(1.0, Math.max(0.0, 1.0 - totalProbability));
              assert notRecordedMethodProbability == 0 || profile.entries == config.methodProfileWidth;
              return new JavaMethodProfile(notRecordedMethodProbability, pmethods);
          }
  
<span class="udiff-line-modified-removed">-         private static int getMethodOffset(int row) {</span>
<span class="udiff-line-modified-removed">-             return VIRTUAL_CALL_DATA_FIRST_METHOD_OFFSET + row * TYPE_DATA_ROW_SIZE;</span>
<span class="udiff-line-modified-added">+         private int getMethodOffset(int row) {</span>
<span class="udiff-line-modified-added">+             return state.virtualCallDataFirstMethodOffset + row * state.typeDataRowSize;</span>
          }
  
<span class="udiff-line-modified-removed">-         private static int getMethodCountOffset(int row) {</span>
<span class="udiff-line-modified-removed">-             return VIRTUAL_CALL_DATA_FIRST_METHOD_COUNT_OFFSET + row * TYPE_DATA_ROW_SIZE;</span>
<span class="udiff-line-modified-added">+         private int getMethodCountOffset(int row) {</span>
<span class="udiff-line-modified-added">+             return state.virtualCallDataFirstMethodCountOffset + row * state.typeDataRowSize;</span>
          }
  
          @Override
          public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
              RawItemProfile&lt;ResolvedJavaMethod&gt; profile = getRawMethodProfile(data, pos);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -630,107 +704,92 @@</span>
          }
      }
  
      static class VirtualCallTypeData extends VirtualCallData {
  
<span class="udiff-line-modified-removed">-         VirtualCallTypeData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, 0);</span>
<span class="udiff-line-modified-added">+         VirtualCallTypeData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, 0);</span>
          }
  
          @Override
          protected int getDynamicSize(HotSpotMethodData data, int position) {
              assert staticSize == 0;
              return HotSpotJVMCIRuntime.runtime().compilerToVm.methodDataProfileDataSize(data.metaspaceMethodData, position);
          }
      }
  
<span class="udiff-line-removed">-     static final int RET_DATA_ROW_SIZE = cellsToBytes(3);</span>
<span class="udiff-line-removed">-     static final int RET_DATA_SIZE = cellIndexToOffset(1) + RET_DATA_ROW_SIZE * config.bciProfileWidth;</span>
<span class="udiff-line-removed">- </span>
      static class RetData extends CounterData {
  
<span class="udiff-line-modified-removed">-         RetData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, RET_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         RetData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.retDataSize);</span>
          }
      }
  
<span class="udiff-line-removed">-     static final int BRANCH_DATA_SIZE = cellIndexToOffset(3);</span>
<span class="udiff-line-removed">-     static final int NOT_TAKEN_COUNT_OFFSET = cellIndexToOffset(config.branchDataNotTakenOffset);</span>
<span class="udiff-line-removed">- </span>
      static class BranchData extends JumpData {
  
<span class="udiff-line-modified-removed">-         BranchData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, BRANCH_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         BranchData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.branchDataSize);</span>
          }
  
          @Override
          public double getBranchTakenProbability(HotSpotMethodData data, int position) {
<span class="udiff-line-modified-removed">-             long takenCount = data.readUnsignedInt(position, TAKEN_COUNT_OFFSET);</span>
<span class="udiff-line-modified-removed">-             long notTakenCount = data.readUnsignedInt(position, NOT_TAKEN_COUNT_OFFSET);</span>
<span class="udiff-line-modified-added">+             long takenCount = data.readUnsignedInt(position, state.takenCountOffset);</span>
<span class="udiff-line-modified-added">+             long notTakenCount = data.readUnsignedInt(position, state.notTakenCountOffset);</span>
              long total = takenCount + notTakenCount;
  
              return total &lt;= 0 ? -1 : takenCount / (double) total;
          }
  
          @Override
          public int getExecutionCount(HotSpotMethodData data, int position) {
<span class="udiff-line-modified-removed">-             long count = data.readUnsignedInt(position, TAKEN_COUNT_OFFSET) + data.readUnsignedInt(position, NOT_TAKEN_COUNT_OFFSET);</span>
<span class="udiff-line-modified-removed">-             return truncateLongToInt(count);</span>
<span class="udiff-line-modified-added">+             long count = data.readUnsignedInt(position, state.takenCountOffset) + data.readUnsignedInt(position, state.notTakenCountOffset);</span>
<span class="udiff-line-modified-added">+             return VMState.truncateLongToInt(count);</span>
          }
  
          @Override
          public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
<span class="udiff-line-modified-removed">-             long taken = data.readUnsignedInt(pos, TAKEN_COUNT_OFFSET);</span>
<span class="udiff-line-modified-removed">-             long notTaken = data.readUnsignedInt(pos, NOT_TAKEN_COUNT_OFFSET);</span>
<span class="udiff-line-modified-added">+             long taken = data.readUnsignedInt(pos, state.takenCountOffset);</span>
<span class="udiff-line-modified-added">+             long notTaken = data.readUnsignedInt(pos, state.notTakenCountOffset);</span>
              double takenProbability = getBranchTakenProbability(data, pos);
              return sb.append(format(&quot;taken(%d, %4.2f) not_taken(%d, %4.2f) displacement(%d)&quot;, taken, takenProbability, notTaken, 1.0D - takenProbability, getTakenDisplacement(data, pos)));
          }
      }
  
<span class="udiff-line-removed">-     static final int ARRAY_DATA_LENGTH_OFFSET = cellIndexToOffset(config.arrayDataArrayLenOffset);</span>
<span class="udiff-line-removed">-     static final int ARRAY_DATA_START_OFFSET = cellIndexToOffset(config.arrayDataArrayStartOffset);</span>
<span class="udiff-line-removed">- </span>
      static class ArrayData extends HotSpotMethodDataAccessor {
  
<span class="udiff-line-modified-removed">-         ArrayData(HotSpotVMConfig config, int tag, int staticSize) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, staticSize);</span>
<span class="udiff-line-modified-added">+         ArrayData(VMState state, int tag, int staticSize) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, staticSize);</span>
          }
  
          @Override
          protected int getDynamicSize(HotSpotMethodData data, int position) {
<span class="udiff-line-modified-removed">-             return cellsToBytes(getLength(data, position));</span>
<span class="udiff-line-modified-added">+             return state.cellsToBytes(getLength(data, position));</span>
          }
  
<span class="udiff-line-modified-removed">-         protected static int getLength(HotSpotMethodData data, int position) {</span>
<span class="udiff-line-modified-removed">-             return data.readInt(position, ARRAY_DATA_LENGTH_OFFSET);</span>
<span class="udiff-line-modified-added">+         protected int getLength(HotSpotMethodData data, int position) {</span>
<span class="udiff-line-modified-added">+             return data.readInt(position, state.arrayDataLengthOffset);</span>
          }
  
          @Override
          public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
              return sb.append(format(&quot;length(%d)&quot;, getLength(data, pos)));
          }
      }
  
<span class="udiff-line-removed">-     static final int MULTI_BRANCH_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="udiff-line-removed">-     static final int MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS = config.multiBranchDataPerCaseCellCount;</span>
<span class="udiff-line-removed">-     static final int MULTI_BRANCH_DATA_ROW_SIZE = cellsToBytes(MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS);</span>
<span class="udiff-line-removed">-     static final int MULTI_BRANCH_DATA_FIRST_COUNT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(0);</span>
<span class="udiff-line-removed">-     static final int MULTI_BRANCH_DATA_FIRST_DISPLACEMENT_OFFSET = ARRAY_DATA_START_OFFSET + cellsToBytes(1);</span>
<span class="udiff-line-removed">- </span>
      static class MultiBranchData extends ArrayData {
  
<span class="udiff-line-modified-removed">-         MultiBranchData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, MULTI_BRANCH_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         MultiBranchData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.multiBranchDataSize);</span>
          }
  
          @Override
          public double[] getSwitchProbabilities(HotSpotMethodData data, int position) {
              int arrayLength = getLength(data, position);
              assert arrayLength &gt; 0 : &quot;switch must have at least the default case&quot;;
<span class="udiff-line-modified-removed">-             assert arrayLength % MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS == 0 : &quot;array must have full rows&quot;;</span>
<span class="udiff-line-modified-added">+             assert arrayLength % state.multiBranchDataRowSizeInCells == 0 : &quot;array must have full rows&quot;;</span>
  
<span class="udiff-line-modified-removed">-             int length = arrayLength / MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS;</span>
<span class="udiff-line-modified-added">+             int length = arrayLength / state.multiBranchDataRowSizeInCells;</span>
              long totalCount = 0;
              double[] result = new double[length];
  
              // default case is first in HotSpot but last for the compiler
              long count = readCount(data, position, 0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -751,11 +810,11 @@</span>
                  }
                  return result;
              }
          }
  
<span class="udiff-line-modified-removed">-         private static long readCount(HotSpotMethodData data, int position, int i) {</span>
<span class="udiff-line-modified-added">+         private long readCount(HotSpotMethodData data, int position, int i) {</span>
              int offset;
              long count;
              offset = getCountOffset(i);
              count = data.readUnsignedInt(position, offset);
              return count;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -763,53 +822,51 @@</span>
  
          @Override
          public int getExecutionCount(HotSpotMethodData data, int position) {
              int arrayLength = getLength(data, position);
              assert arrayLength &gt; 0 : &quot;switch must have at least the default case&quot;;
<span class="udiff-line-modified-removed">-             assert arrayLength % MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS == 0 : &quot;array must have full rows&quot;;</span>
<span class="udiff-line-modified-added">+             assert arrayLength % state.multiBranchDataRowSizeInCells == 0 : &quot;array must have full rows&quot;;</span>
  
<span class="udiff-line-modified-removed">-             int length = arrayLength / MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS;</span>
<span class="udiff-line-modified-added">+             int length = arrayLength / state.multiBranchDataRowSizeInCells;</span>
              long totalCount = 0;
              for (int i = 0; i &lt; length; i++) {
                  int offset = getCountOffset(i);
                  totalCount += data.readUnsignedInt(position, offset);
              }
  
<span class="udiff-line-modified-removed">-             return truncateLongToInt(totalCount);</span>
<span class="udiff-line-modified-added">+             return VMState.truncateLongToInt(totalCount);</span>
          }
  
<span class="udiff-line-modified-removed">-         private static int getCountOffset(int index) {</span>
<span class="udiff-line-modified-removed">-             return MULTI_BRANCH_DATA_FIRST_COUNT_OFFSET + index * MULTI_BRANCH_DATA_ROW_SIZE;</span>
<span class="udiff-line-modified-added">+         private int getCountOffset(int index) {</span>
<span class="udiff-line-modified-added">+             return state.multiBranchDataFirstCountOffset + index * state.multiBranchDataRowSize;</span>
          }
  
<span class="udiff-line-modified-removed">-         private static int getDisplacementOffset(int index) {</span>
<span class="udiff-line-modified-removed">-             return MULTI_BRANCH_DATA_FIRST_DISPLACEMENT_OFFSET + index * MULTI_BRANCH_DATA_ROW_SIZE;</span>
<span class="udiff-line-modified-added">+         private int getDisplacementOffset(int index) {</span>
<span class="udiff-line-modified-added">+             return state.multiBranchDataFirstDisplacementOffset + index * state.multiBranchDataRowSize;</span>
          }
  
          @Override
          public StringBuilder appendTo(StringBuilder sb, HotSpotMethodData data, int pos) {
<span class="udiff-line-modified-removed">-             int entries = getLength(data, pos) / MULTI_BRANCH_DATA_ROW_SIZE_IN_CELLS;</span>
<span class="udiff-line-modified-added">+             int entries = getLength(data, pos) / state.multiBranchDataRowSizeInCells;</span>
              sb.append(format(&quot;entries(%d)&quot;, entries));
              for (int i = 0; i &lt; entries; i++) {
                  sb.append(format(&quot;%n  %d: count(%d) displacement(%d)&quot;, i, data.readUnsignedInt(pos, getCountOffset(i)), data.readUnsignedInt(pos, getDisplacementOffset(i))));
              }
              return sb;
          }
      }
  
<span class="udiff-line-removed">-     static final int ARG_INFO_DATA_SIZE = cellIndexToOffset(1);</span>
<span class="udiff-line-removed">- </span>
      static class ArgInfoData extends ArrayData {
  
<span class="udiff-line-modified-removed">-         ArgInfoData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, ARG_INFO_DATA_SIZE);</span>
<span class="udiff-line-modified-added">+         ArgInfoData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, state.argInfoDataSize);</span>
          }
      }
  
      static class UnknownProfileData extends HotSpotMethodDataAccessor {
<span class="udiff-line-modified-removed">-         UnknownProfileData(HotSpotVMConfig config, int tag) {</span>
<span class="udiff-line-modified-removed">-             super(config, tag, 0);</span>
<span class="udiff-line-modified-added">+         UnknownProfileData(VMState state, int tag) {</span>
<span class="udiff-line-modified-added">+             super(state, tag, 0);</span>
          }
  
          @Override
          protected int getDynamicSize(HotSpotMethodData data, int position) {
              assert staticSize == 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -822,49 +879,12 @@</span>
              return sb;
          }
      }
  
      public void setCompiledIRSize(int size) {
<span class="udiff-line-modified-removed">-         UNSAFE.putInt(metaspaceMethodData + config.methodDataIRSizeOffset, size);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putInt(metaspaceMethodData + state.config.methodDataIRSizeOffset, size);</span>
      }
  
      public int getCompiledIRSize() {
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(metaspaceMethodData + config.methodDataIRSizeOffset);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // sorted by tag</span>
<span class="udiff-line-removed">-     // @formatter:off</span>
<span class="udiff-line-removed">-     static final HotSpotMethodDataAccessor[] PROFILE_DATA_ACCESSORS = {</span>
<span class="udiff-line-removed">-         null,</span>
<span class="udiff-line-removed">-         new BitData(config, config.dataLayoutBitDataTag),</span>
<span class="udiff-line-removed">-         new CounterData(config, config.dataLayoutCounterDataTag),</span>
<span class="udiff-line-removed">-         new JumpData(config, config.dataLayoutJumpDataTag),</span>
<span class="udiff-line-removed">-         new ReceiverTypeData(config, config.dataLayoutReceiverTypeDataTag),</span>
<span class="udiff-line-removed">-         new VirtualCallData(config, config.dataLayoutVirtualCallDataTag),</span>
<span class="udiff-line-removed">-         new RetData(config, config.dataLayoutRetDataTag),</span>
<span class="udiff-line-removed">-         new BranchData(config, config.dataLayoutBranchDataTag),</span>
<span class="udiff-line-removed">-         new MultiBranchData(config, config.dataLayoutMultiBranchDataTag),</span>
<span class="udiff-line-removed">-         new ArgInfoData(config, config.dataLayoutArgInfoDataTag),</span>
<span class="udiff-line-removed">-         new UnknownProfileData(config, config.dataLayoutCallTypeDataTag),</span>
<span class="udiff-line-removed">-         new VirtualCallTypeData(config, config.dataLayoutVirtualCallTypeDataTag),</span>
<span class="udiff-line-removed">-         new UnknownProfileData(config, config.dataLayoutParametersTypeDataTag),</span>
<span class="udiff-line-removed">-         new UnknownProfileData(config, config.dataLayoutSpeculativeTrapDataTag),</span>
<span class="udiff-line-removed">-     };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static boolean checkAccessorTags() {</span>
<span class="udiff-line-removed">-         int expectedTag = 0;</span>
<span class="udiff-line-removed">-         for (HotSpotMethodDataAccessor accessor : PROFILE_DATA_ACCESSORS) {</span>
<span class="udiff-line-removed">-             if (expectedTag == 0) {</span>
<span class="udiff-line-removed">-                 assert accessor == null;</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 assert accessor.tag == expectedTag : expectedTag + &quot; != &quot; + accessor.tag + &quot; &quot; + accessor;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             expectedTag++;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static {</span>
<span class="udiff-line-removed">-         assert checkAccessorTags();</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(metaspaceMethodData + state.config.methodDataIRSizeOffset);</span>
      }
<span class="udiff-line-removed">-     // @formatter:on</span>
  }
</pre>
<center><a href="HotSpotMethod.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotMethodDataAccessor.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>