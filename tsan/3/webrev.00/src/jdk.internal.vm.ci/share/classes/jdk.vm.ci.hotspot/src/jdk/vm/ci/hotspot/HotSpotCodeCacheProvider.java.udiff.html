<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotCodeCacheProvider.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CompilerToVM.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotCompilationRequest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.ci/share/classes/jdk.vm.ci.hotspot/src/jdk/vm/ci/hotspot/HotSpotCodeCacheProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2013, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,10 +21,11 @@</span>
   * questions.
   */
  package jdk.vm.ci.hotspot;
  
  import java.util.Map;
<span class="udiff-line-added">+ import java.util.Objects;</span>
  
  import jdk.vm.ci.code.BailoutException;
  import jdk.vm.ci.code.BytecodeFrame;
  import jdk.vm.ci.code.CodeCacheProvider;
  import jdk.vm.ci.code.CompiledCode;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -100,48 +101,66 @@</span>
      }
  
      @Override
      public InstalledCode installCode(ResolvedJavaMethod method, CompiledCode compiledCode, InstalledCode installedCode, SpeculationLog log, boolean isDefault) {
          InstalledCode resultInstalledCode;
<span class="udiff-line-modified-removed">-         if (installedCode == null) {</span>
<span class="udiff-line-modified-removed">-             if (method == null) {</span>
<span class="udiff-line-modified-removed">-                 // Must be a stub</span>
<span class="udiff-line-modified-removed">-                 resultInstalledCode = new HotSpotRuntimeStub(((HotSpotCompiledCode) compiledCode).getName());</span>
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-modified-removed">-                 resultInstalledCode = new HotSpotNmethod((HotSpotResolvedJavaMethod) method, ((HotSpotCompiledCode) compiledCode).getName(), isDefault);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+         if (installedCode != null) {</span>
<span class="udiff-line-modified-added">+             throw new IllegalArgumentException(&quot;InstalledCode argument must be null&quot;);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         HotSpotCompiledCode hsCompiledCode = (HotSpotCompiledCode) compiledCode;</span>
<span class="udiff-line-modified-added">+         String name = hsCompiledCode.getName();</span>
<span class="udiff-line-modified-added">+         HotSpotCompiledNmethod hsCompiledNmethod = null;</span>
<span class="udiff-line-modified-added">+         if (method == null) {</span>
<span class="udiff-line-added">+             // Must be a stub</span>
<span class="udiff-line-added">+             resultInstalledCode = new HotSpotRuntimeStub(name);</span>
          } else {
<span class="udiff-line-modified-removed">-             resultInstalledCode = installedCode;</span>
<span class="udiff-line-modified-added">+             hsCompiledNmethod = (HotSpotCompiledNmethod) hsCompiledCode;</span>
<span class="udiff-line-added">+             HotSpotResolvedJavaMethodImpl hsMethod = (HotSpotResolvedJavaMethodImpl) method;</span>
<span class="udiff-line-added">+             resultInstalledCode = new HotSpotNmethod(hsMethod, name, isDefault, hsCompiledNmethod.id);</span>
          }
  
<span class="udiff-line-modified-removed">-         HotSpotSpeculationLog speculationLog = (log != null &amp;&amp; log.hasSpeculations()) ? (HotSpotSpeculationLog) log : null;</span>
<span class="udiff-line-modified-added">+         HotSpotSpeculationLog speculationLog = null;</span>
<span class="udiff-line-added">+         if (log != null) {</span>
<span class="udiff-line-added">+             if (log.hasSpeculations()) {</span>
<span class="udiff-line-added">+                 speculationLog = (HotSpotSpeculationLog) log;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
  
<span class="udiff-line-modified-removed">-         int result = runtime.getCompilerToVM().installCode(target, (HotSpotCompiledCode) compiledCode, resultInstalledCode, speculationLog);</span>
<span class="udiff-line-modified-added">+         byte[] speculations;</span>
<span class="udiff-line-added">+         long failedSpeculationsAddress;</span>
<span class="udiff-line-added">+         if (speculationLog != null) {</span>
<span class="udiff-line-added">+             speculations = speculationLog.getFlattenedSpeculations(true);</span>
<span class="udiff-line-added">+             failedSpeculationsAddress = speculationLog.getFailedSpeculationsAddress();</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             speculations = new byte[0];</span>
<span class="udiff-line-added">+             failedSpeculationsAddress = 0L;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         int result = runtime.getCompilerToVM().installCode(target, (HotSpotCompiledCode) compiledCode, resultInstalledCode, failedSpeculationsAddress, speculations);</span>
          if (result != config.codeInstallResultOk) {
              String resultDesc = config.getCodeInstallResultDescription(result);
<span class="udiff-line-modified-removed">-             if (compiledCode instanceof HotSpotCompiledNmethod) {</span>
<span class="udiff-line-modified-removed">-                 HotSpotCompiledNmethod compiledNmethod = (HotSpotCompiledNmethod) compiledCode;</span>
<span class="udiff-line-removed">-                 String msg = compiledNmethod.getInstallationFailureMessage();</span>
<span class="udiff-line-modified-added">+             if (hsCompiledNmethod != null) {</span>
<span class="udiff-line-modified-added">+                 String msg = hsCompiledNmethod.getInstallationFailureMessage();</span>
                  if (msg != null) {
                      msg = String.format(&quot;Code installation failed: %s%n%s&quot;, resultDesc, msg);
                  } else {
                      msg = String.format(&quot;Code installation failed: %s&quot;, resultDesc);
                  }
<span class="udiff-line-removed">-                 if (result == config.codeInstallResultDependenciesInvalid) {</span>
<span class="udiff-line-removed">-                     throw new AssertionError(resultDesc + &quot; &quot; + msg);</span>
<span class="udiff-line-removed">-                 }</span>
                  throw new BailoutException(result != config.codeInstallResultDependenciesFailed, msg);
              } else {
                  throw new BailoutException(&quot;Error installing %s: %s&quot;, ((HotSpotCompiledCode) compiledCode).getName(), resultDesc);
              }
          }
          return logOrDump(resultInstalledCode, compiledCode);
      }
  
      @Override
      public void invalidateInstalledCode(InstalledCode installedCode) {
<span class="udiff-line-modified-removed">-         runtime.getCompilerToVM().invalidateInstalledCode(installedCode);</span>
<span class="udiff-line-modified-added">+         if (installedCode instanceof HotSpotNmethod) {</span>
<span class="udiff-line-added">+             runtime.getCompilerToVM().invalidateHotSpotNmethod((HotSpotNmethod) installedCode);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             throw new IllegalArgumentException(&quot;Cannot invalidate a &quot; + Objects.requireNonNull(installedCode).getClass().getName());</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
      public TargetDescription getTarget() {
          return target;
</pre>
<center><a href="CompilerToVM.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotCompilationRequest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>