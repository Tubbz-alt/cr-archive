<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jlink/share/classes/jdk/tools/jlink/internal/plugins/DefaultStripDebugPlugin.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../TaskHelper.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GenerateJLIClassesPlugin.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jlink/share/classes/jdk/tools/jlink/internal/plugins/DefaultStripDebugPlugin.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,10 +23,15 @@</span>
   * questions.
   */
  
  package jdk.tools.jlink.internal.plugins;
  
<span class="udiff-line-added">+ import java.util.Map;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import jdk.tools.jlink.internal.PluginRepository;</span>
<span class="udiff-line-added">+ import jdk.tools.jlink.internal.ResourcePoolManager;</span>
<span class="udiff-line-added">+ import jdk.tools.jlink.internal.ResourcePoolManager.ResourcePoolImpl;</span>
  import jdk.tools.jlink.plugin.Plugin;
  import jdk.tools.jlink.plugin.ResourcePool;
  import jdk.tools.jlink.plugin.ResourcePoolBuilder;
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -35,12 +40,26 @@</span>
   *
   */
  public final class DefaultStripDebugPlugin implements Plugin {
  
      public static final String NAME = &quot;strip-debug&quot;;
<span class="udiff-line-added">+     private static final String STRIP_NATIVE_DEBUG_PLUGIN = &quot;strip-native-debug-symbols&quot;;</span>
<span class="udiff-line-added">+     private static final String EXCLUDE_DEBUGINFO = &quot;exclude-debuginfo-files&quot;;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private final Plugin javaStripPlugin;</span>
<span class="udiff-line-added">+     private final NativePluginFactory stripNativePluginFactory;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public DefaultStripDebugPlugin() {</span>
<span class="udiff-line-added">+         this(new StripJavaDebugAttributesPlugin(),</span>
<span class="udiff-line-added">+              new DefaultNativePluginFactory());</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-     private final Plugin javaStripPlugin = new StripJavaDebugAttributesPlugin();</span>
<span class="udiff-line-modified-added">+     public DefaultStripDebugPlugin(Plugin javaStripPlugin,</span>
<span class="udiff-line-added">+                                    NativePluginFactory nativeStripPluginFact) {</span>
<span class="udiff-line-added">+         this.javaStripPlugin = javaStripPlugin;</span>
<span class="udiff-line-added">+         this.stripNativePluginFactory = nativeStripPluginFact;</span>
<span class="udiff-line-added">+     }</span>
  
      @Override
      public String getName() {
          return NAME;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -50,9 +69,36 @@</span>
          return PluginsResourceBundle.getDescription(NAME);
      }
  
      @Override
      public ResourcePool transform(ResourcePool in, ResourcePoolBuilder out) {
<span class="udiff-line-modified-removed">-         return javaStripPlugin.transform(in, out);</span>
<span class="udiff-line-modified-added">+         Plugin stripNativePlugin = stripNativePluginFactory.create();</span>
<span class="udiff-line-added">+         if (stripNativePlugin != null) {</span>
<span class="udiff-line-added">+             Map&lt;String, String&gt; stripNativeConfig = Map.of(</span>
<span class="udiff-line-added">+                                      STRIP_NATIVE_DEBUG_PLUGIN, EXCLUDE_DEBUGINFO);</span>
<span class="udiff-line-added">+             stripNativePlugin.configure(stripNativeConfig);</span>
<span class="udiff-line-added">+             ResourcePoolManager outRes =</span>
<span class="udiff-line-added">+                                  new ResourcePoolManager(in.byteOrder(),</span>
<span class="udiff-line-added">+                                                         ((ResourcePoolImpl)in).getStringTable());</span>
<span class="udiff-line-added">+             ResourcePool strippedJava = javaStripPlugin.transform(in,</span>
<span class="udiff-line-added">+                                                                   outRes.resourcePoolBuilder());</span>
<span class="udiff-line-added">+             return stripNativePlugin.transform(strippedJava, out);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return javaStripPlugin.transform(in, out);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public interface NativePluginFactory {</span>
<span class="udiff-line-added">+         Plugin create();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static class DefaultNativePluginFactory implements NativePluginFactory {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public Plugin create() {</span>
<span class="udiff-line-added">+             return PluginRepository.getPlugin(STRIP_NATIVE_DEBUG_PLUGIN,</span>
<span class="udiff-line-added">+                                               ModuleLayer.boot());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
      }
  
  }
</pre>
<center><a href="../TaskHelper.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GenerateJLIClassesPlugin.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>