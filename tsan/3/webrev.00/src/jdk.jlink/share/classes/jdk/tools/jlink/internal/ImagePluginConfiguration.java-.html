<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/jdk.jlink/share/classes/jdk/tools/jlink/internal/ImagePluginConfiguration.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package jdk.tools.jlink.internal;
 26 
 27 import java.io.DataOutputStream;
 28 
 29 import java.io.IOException;
 30 import java.util.ArrayList;
 31 import java.util.LinkedHashMap;
 32 import java.util.List;
 33 import java.util.Map;
 34 import java.util.Map.Entry;
 35 import jdk.tools.jlink.builder.ImageBuilder;
 36 import jdk.tools.jlink.plugin.Plugin;
 37 import jdk.tools.jlink.plugin.PluginException;
 38 import jdk.tools.jlink.plugin.Plugin.Category;
 39 import jdk.tools.jlink.plugin.ResourcePool;
 40 
 41 /**
 42  * Plugins configuration.
 43  */
 44 public final class ImagePluginConfiguration {
 45 
 46     // Order in which plugins are applied. Note that COMPRESSOR type plugins should come
 47     // after any plugin that reads .class resources and operate on binary data.
 48     // Plugin.Category enum element order matches this order for ease of read.
 49     private static final List&lt;Category&gt; CATEGORIES_ORDER = new ArrayList&lt;&gt;();
 50 
 51     static {
 52         CATEGORIES_ORDER.add(Category.FILTER);
 53         CATEGORIES_ORDER.add(Category.TRANSFORMER);
 54         CATEGORIES_ORDER.add(Category.MODULEINFO_TRANSFORMER);
 55         CATEGORIES_ORDER.add(Category.SORTER);
 56         CATEGORIES_ORDER.add(Category.METAINFO_ADDER);
 57         CATEGORIES_ORDER.add(Category.COMPRESSOR);
 58         CATEGORIES_ORDER.add(Category.VERIFIER);
 59         CATEGORIES_ORDER.add(Category.PROCESSOR);
 60         CATEGORIES_ORDER.add(Category.PACKAGER);
 61     }
 62 
 63     private ImagePluginConfiguration() {
 64     }
 65 
 66     /*
 67      * Create a stack of plugins from a a configuration.
 68      */
 69     public static ImagePluginStack parseConfiguration(Jlink.PluginsConfiguration pluginsConfiguration)
 70             throws Exception {
 71         if (pluginsConfiguration == null) {
 72             return new ImagePluginStack();
 73         }
 74         Map&lt;Category, List&lt;Plugin&gt;&gt; plugins = new LinkedHashMap&lt;&gt;();
 75         for (Category cat : CATEGORIES_ORDER) {
 76             plugins.put(cat, new ArrayList&lt;&gt;());
 77         }
 78 
 79         List&lt;String&gt; seen = new ArrayList&lt;&gt;();
 80         // split into categories and check for plugin with same name.
 81         for (Plugin plug : pluginsConfiguration.getPlugins()) {
 82             if (seen.contains(plug.getName())) {
 83                 throw new Exception(&quot;Plugin &quot; + plug.getName()
 84                         + &quot; added more than once to stack &quot;);
 85             }
 86             seen.add(plug.getName());
 87             Category category = plug.getType();
 88             if (category == null) {
 89                 throw new PluginException(&quot;Invalid category for &quot;
 90                         + plug.getName());
 91             }
 92             List&lt;Plugin&gt; lst = plugins.get(category);
 93             lst.add(plug);
 94         }
 95 
 96         List&lt;Plugin&gt; orderedPlugins = new ArrayList&lt;&gt;();
 97         plugins.entrySet().stream().forEach((entry) -&gt; {
 98             orderedPlugins.addAll(entry.getValue());
 99         });
100         Plugin lastSorter = null;
101         for (Plugin plugin : orderedPlugins) {
102             if (plugin.getName().equals(pluginsConfiguration.getLastSorterPluginName())) {
103                 lastSorter = plugin;
104                 break;
105             }
106         }
107         if (pluginsConfiguration.getLastSorterPluginName() != null &amp;&amp; lastSorter == null) {
108             throw new IOException(&quot;Unknown last plugin &quot;
109                     + pluginsConfiguration.getLastSorterPluginName());
110         }
111         ImageBuilder builder = pluginsConfiguration.getImageBuilder();
112         if (builder == null) {
113             // This should be the case for jimage only creation or post-install.
114             builder = new ImageBuilder() {
115 
116                 @Override
117                 public DataOutputStream getJImageOutputStream() {
118                     throw new PluginException(&quot;No directory setup to store files&quot;);
119                 }
120 
121                 @Override
122                 public ExecutableImage getExecutableImage() {
123                     throw new PluginException(&quot;No directory setup to store files&quot;);
124                 }
125 
126                 @Override
127                 public void storeFiles(ResourcePool files) {
128                     throw new PluginException(&quot;No directory setup to store files&quot;);
129                 }
130             };
131         }
132 
133         return new ImagePluginStack(builder, orderedPlugins, lastSorter);
134     }
135 }
    </pre>
  </body>
</html>