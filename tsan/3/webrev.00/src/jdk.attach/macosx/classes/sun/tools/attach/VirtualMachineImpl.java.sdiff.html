<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.attach/macosx/classes/sun/tools/attach/VirtualMachineImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../linux/classes/sun/tools/attach/VirtualMachineImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../share/classes/com/sun/tools/attach/spi/AttachProvider.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.attach/macosx/classes/sun/tools/attach/VirtualMachineImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 42     // location is the same for all processes, otherwise the tools
 43     // will not be able to find all Hotspot processes.
 44     // This is intentionally not the same as java.io.tmpdir, since
 45     // the latter can be changed by the user.
 46     // Any changes to this needs to be synchronized with HotSpot.
 47     private static final String tmpdir;
 48     String socket_path;
 49 
 50     /**
 51      * Attaches to the target VM
 52      */
 53     VirtualMachineImpl(AttachProvider provider, String vmid)
 54         throws AttachNotSupportedException, IOException
 55     {
 56         super(provider, vmid);
 57 
 58         // This provider only understands pids
 59         int pid;
 60         try {
 61             pid = Integer.parseInt(vmid);



 62         } catch (NumberFormatException x) {
<span class="line-modified"> 63             throw new AttachNotSupportedException(&quot;Invalid process identifier&quot;);</span>
 64         }
 65 
 66         // Find the socket file. If not found then we attempt to start the
 67         // attach mechanism in the target VM by sending it a QUIT signal.
 68         // Then we attempt to find the socket file again.
 69         File socket_file = new File(tmpdir, &quot;.java_pid&quot; + pid);
 70         socket_path = socket_file.getPath();
 71         if (!socket_file.exists()) {
 72             File f = createAttachFile(pid);
 73             try {
 74                 sendQuitTo(pid);
 75 
 76                 // give the target VM time to start the attach mechanism
 77                 final int delay_step = 100;
 78                 final long timeout = attachTimeout();
 79                 long time_spend = 0;
 80                 long delay = 0;
 81                 do {
 82                     // Increase timeout on each attempt to reduce polling
 83                     delay += delay_step;
</pre>
<hr />
<pre>
239             byte b[] = new byte[1];
240             int n = this.read(b, 0, 1);
241             if (n == 1) {
242                 return b[0] &amp; 0xff;
243             } else {
244                 return -1;
245             }
246         }
247 
248         public synchronized int read(byte[] bs, int off, int len) throws IOException {
249             if ((off &lt; 0) || (off &gt; bs.length) || (len &lt; 0) ||
250                 ((off + len) &gt; bs.length) || ((off + len) &lt; 0)) {
251                 throw new IndexOutOfBoundsException();
252             } else if (len == 0) {
253                 return 0;
254             }
255 
256             return VirtualMachineImpl.read(s, bs, off, len);
257         }
258 
<span class="line-modified">259         public void close() throws IOException {</span>
<span class="line-modified">260             VirtualMachineImpl.close(s);</span>




261         }
262     }
263 
264     /*
265      * Write/sends the given to the target VM. String is transmitted in
266      * UTF-8 encoding.
267      */
268     private void writeString(int fd, String s) throws IOException {
269         if (s.length() &gt; 0) {
270             byte b[];
271             try {
272                 b = s.getBytes(&quot;UTF-8&quot;);
273             } catch (java.io.UnsupportedEncodingException x) {
274                 throw new InternalError(x);
275             }
276             VirtualMachineImpl.write(fd, b, 0, b.length);
277         }
278         byte b[] = new byte[1];
279         b[0] = 0;
280         write(fd, b, 0, 1);
</pre>
</td>
<td>
<hr />
<pre>
 42     // location is the same for all processes, otherwise the tools
 43     // will not be able to find all Hotspot processes.
 44     // This is intentionally not the same as java.io.tmpdir, since
 45     // the latter can be changed by the user.
 46     // Any changes to this needs to be synchronized with HotSpot.
 47     private static final String tmpdir;
 48     String socket_path;
 49 
 50     /**
 51      * Attaches to the target VM
 52      */
 53     VirtualMachineImpl(AttachProvider provider, String vmid)
 54         throws AttachNotSupportedException, IOException
 55     {
 56         super(provider, vmid);
 57 
 58         // This provider only understands pids
 59         int pid;
 60         try {
 61             pid = Integer.parseInt(vmid);
<span class="line-added"> 62             if (pid &lt; 1) {</span>
<span class="line-added"> 63                 throw new NumberFormatException();</span>
<span class="line-added"> 64             }</span>
 65         } catch (NumberFormatException x) {
<span class="line-modified"> 66             throw new AttachNotSupportedException(&quot;Invalid process identifier: &quot; + vmid);</span>
 67         }
 68 
 69         // Find the socket file. If not found then we attempt to start the
 70         // attach mechanism in the target VM by sending it a QUIT signal.
 71         // Then we attempt to find the socket file again.
 72         File socket_file = new File(tmpdir, &quot;.java_pid&quot; + pid);
 73         socket_path = socket_file.getPath();
 74         if (!socket_file.exists()) {
 75             File f = createAttachFile(pid);
 76             try {
 77                 sendQuitTo(pid);
 78 
 79                 // give the target VM time to start the attach mechanism
 80                 final int delay_step = 100;
 81                 final long timeout = attachTimeout();
 82                 long time_spend = 0;
 83                 long delay = 0;
 84                 do {
 85                     // Increase timeout on each attempt to reduce polling
 86                     delay += delay_step;
</pre>
<hr />
<pre>
242             byte b[] = new byte[1];
243             int n = this.read(b, 0, 1);
244             if (n == 1) {
245                 return b[0] &amp; 0xff;
246             } else {
247                 return -1;
248             }
249         }
250 
251         public synchronized int read(byte[] bs, int off, int len) throws IOException {
252             if ((off &lt; 0) || (off &gt; bs.length) || (len &lt; 0) ||
253                 ((off + len) &gt; bs.length) || ((off + len) &lt; 0)) {
254                 throw new IndexOutOfBoundsException();
255             } else if (len == 0) {
256                 return 0;
257             }
258 
259             return VirtualMachineImpl.read(s, bs, off, len);
260         }
261 
<span class="line-modified">262         public synchronized void close() throws IOException {</span>
<span class="line-modified">263             if (s != -1) {</span>
<span class="line-added">264                 int toClose = s;</span>
<span class="line-added">265                 s = -1;</span>
<span class="line-added">266                 VirtualMachineImpl.close(toClose);</span>
<span class="line-added">267             }</span>
268         }
269     }
270 
271     /*
272      * Write/sends the given to the target VM. String is transmitted in
273      * UTF-8 encoding.
274      */
275     private void writeString(int fd, String s) throws IOException {
276         if (s.length() &gt; 0) {
277             byte b[];
278             try {
279                 b = s.getBytes(&quot;UTF-8&quot;);
280             } catch (java.io.UnsupportedEncodingException x) {
281                 throw new InternalError(x);
282             }
283             VirtualMachineImpl.write(fd, b, 0, b.length);
284         }
285         byte b[] = new byte[1];
286         b[0] = 0;
287         write(fd, b, 0, 1);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../linux/classes/sun/tools/attach/VirtualMachineImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../share/classes/com/sun/tools/attach/spi/AttachProvider.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>