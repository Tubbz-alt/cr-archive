<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.crypto.ec/share/classes/sun/security/ec/ECDSASignature.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../jdk.crypto.cryptoki/windows/native/libj2pkcs11/p11_md.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="XDHKeyAgreement.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.ec/share/classes/sun/security/ec/ECDSASignature.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -70,10 +70,13 @@</span>
      private ECPrivateKey privateKey;
  
      // public key, if initialized for verifying
      private ECPublicKey publicKey;
  
<span class="udiff-line-added">+     // signature parameters</span>
<span class="udiff-line-added">+     private ECParameterSpec sigParams = null;</span>
<span class="udiff-line-added">+ </span>
      // The format. true for the IEEE P1363 format. false (default) for ASN.1
      private final boolean p1363Format;
  
      /**
       * Constructs a new ECDSASignature.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -277,14 +280,18 @@</span>
  
      // initialize for verification. See JCA doc
      @Override
      protected void engineInitVerify(PublicKey publicKey)
      throws InvalidKeyException {
<span class="udiff-line-modified-removed">-         this.publicKey = (ECPublicKey) ECKeyFactory.toECKey(publicKey);</span>
<span class="udiff-line-modified-added">+         ECPublicKey key = (ECPublicKey) ECKeyFactory.toECKey(publicKey);</span>
<span class="udiff-line-added">+         if (!isCompatible(this.sigParams, key.getParams())) {</span>
<span class="udiff-line-added">+             throw new InvalidKeyException(&quot;Key params does not match signature params&quot;);</span>
<span class="udiff-line-added">+         }</span>
  
          // Should check that the supplied key is appropriate for signature
          // algorithm (e.g. P-256 for SHA256withECDSA)
<span class="udiff-line-added">+         this.publicKey = key;</span>
          this.privateKey = null;
          resetDigest();
      }
  
      // initialize for signing. See JCA doc
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -296,14 +303,18 @@</span>
  
      // initialize for signing. See JCA doc
      @Override
      protected void engineInitSign(PrivateKey privateKey, SecureRandom random)
      throws InvalidKeyException {
<span class="udiff-line-modified-removed">-         this.privateKey = (ECPrivateKey) ECKeyFactory.toECKey(privateKey);</span>
<span class="udiff-line-modified-added">+         ECPrivateKey key = (ECPrivateKey) ECKeyFactory.toECKey(privateKey);</span>
<span class="udiff-line-added">+         if (!isCompatible(this.sigParams, key.getParams())) {</span>
<span class="udiff-line-added">+             throw new InvalidKeyException(&quot;Key params does not match signature params&quot;);</span>
<span class="udiff-line-added">+         }</span>
  
          // Should check that the supplied key is appropriate for signature
          // algorithm (e.g. P-256 for SHA256withECDSA)
<span class="udiff-line-added">+         this.privateKey = key;</span>
          this.publicKey = null;
          this.random = random;
          resetDigest();
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -352,10 +363,20 @@</span>
  
          messageDigest.update(byteBuffer);
          needsReset = true;
      }
  
<span class="udiff-line-added">+     private static boolean isCompatible(ECParameterSpec sigParams,</span>
<span class="udiff-line-added">+             ECParameterSpec keyParams) {</span>
<span class="udiff-line-added">+         if (sigParams == null) {</span>
<span class="udiff-line-added">+             // no restriction on key param</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return ECUtil.equals(sigParams, keyParams);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
      private byte[] signDigestImpl(ECDSAOperations ops, int seedBits,
          byte[] digest, ECPrivateKeyImpl privImpl, SecureRandom random)
          throws SignatureException {
  
          byte[] seedBytes = new byte[(seedBits + 7) / 8];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -408,14 +429,14 @@</span>
          byte[] s = privateKey.getS().toByteArray();
          ECParameterSpec params = privateKey.getParams();
  
          // DER OID
          byte[] encodedParams = ECUtil.encodeECParameterSpec(null, params);
<span class="udiff-line-modified-removed">-         int keySize = params.getCurve().getField().getFieldSize();</span>
<span class="udiff-line-modified-added">+         int orderLength = params.getOrder().bitLength();</span>
  
<span class="udiff-line-modified-removed">-         // seed is twice the key size (in bytes) plus 1</span>
<span class="udiff-line-modified-removed">-         byte[] seed = new byte[(((keySize + 7) &gt;&gt; 3) + 1) * 2];</span>
<span class="udiff-line-modified-added">+         // seed is twice the order length (in bytes) plus 1</span>
<span class="udiff-line-modified-added">+         byte[] seed = new byte[(((orderLength + 7) &gt;&gt; 3) + 1) * 2];</span>
  
          random.nextBytes(seed);
  
          // random bits needed for timing countermeasures
          int timingArgument = random.nextInt();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -493,13 +514,20 @@</span>
      }
  
      @Override
      protected void engineSetParameter(AlgorithmParameterSpec params)
      throws InvalidAlgorithmParameterException {
<span class="udiff-line-modified-removed">-         if (params != null) {</span>
<span class="udiff-line-modified-added">+         if (params != null &amp;&amp; !(params instanceof ECParameterSpec)) {</span>
              throw new InvalidAlgorithmParameterException(&quot;No parameter accepted&quot;);
          }
<span class="udiff-line-added">+         ECKey key = (this.privateKey == null? this.publicKey : this.privateKey);</span>
<span class="udiff-line-added">+         if ((key != null) &amp;&amp; !isCompatible((ECParameterSpec)params, key.getParams())) {</span>
<span class="udiff-line-added">+             throw new InvalidAlgorithmParameterException</span>
<span class="udiff-line-added">+                 (&quot;Signature params does not match key params&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         sigParams = (ECParameterSpec) params;</span>
      }
  
      // get parameter, not supported. See JCA doc
      @Override
      @Deprecated
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -508,11 +536,21 @@</span>
          throw new UnsupportedOperationException(&quot;getParameter() not supported&quot;);
      }
  
      @Override
      protected AlgorithmParameters engineGetParameters() {
<span class="udiff-line-modified-removed">-         return null;</span>
<span class="udiff-line-modified-added">+         if (sigParams == null) {</span>
<span class="udiff-line-added">+             return null;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             AlgorithmParameters ap = AlgorithmParameters.getInstance(&quot;EC&quot;);</span>
<span class="udiff-line-added">+             ap.init(sigParams);</span>
<span class="udiff-line-added">+             return ap;</span>
<span class="udiff-line-added">+         } catch (Exception e) {</span>
<span class="udiff-line-added">+             // should never happen</span>
<span class="udiff-line-added">+             throw new ProviderException(&quot;Error retrieving EC parameters&quot;, e);</span>
<span class="udiff-line-added">+         }</span>
      }
  
      /**
       * Signs the digest using the private key.
       *
</pre>
<center><a href="../../../../../../jdk.crypto.cryptoki/windows/native/libj2pkcs11/p11_md.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="XDHKeyAgreement.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>