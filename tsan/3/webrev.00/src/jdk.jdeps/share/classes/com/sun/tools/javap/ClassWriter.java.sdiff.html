<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.jdeps/share/classes/com/sun/tools/javap/ClassWriter.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AttributeWriter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JavapTask.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jdeps/share/classes/com/sun/tools/javap/ClassWriter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2007, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.tools.javap;
 27 
 28 import java.net.URI;
 29 import java.text.DateFormat;
 30 import java.util.Collection;
 31 import java.util.Date;
 32 import java.util.List;

 33 
 34 import com.sun.tools.classfile.AccessFlags;
 35 import com.sun.tools.classfile.Attribute;
 36 import com.sun.tools.classfile.Attributes;
 37 import com.sun.tools.classfile.ClassFile;
 38 import com.sun.tools.classfile.Code_attribute;
 39 import com.sun.tools.classfile.ConstantPool;
 40 import com.sun.tools.classfile.ConstantPoolException;
 41 import com.sun.tools.classfile.ConstantValue_attribute;
 42 import com.sun.tools.classfile.Descriptor;
 43 import com.sun.tools.classfile.Descriptor.InvalidDescriptor;
 44 import com.sun.tools.classfile.Exceptions_attribute;
 45 import com.sun.tools.classfile.Field;
 46 import com.sun.tools.classfile.Method;
 47 import com.sun.tools.classfile.Module_attribute;
 48 import com.sun.tools.classfile.Signature;
 49 import com.sun.tools.classfile.Signature_attribute;
 50 import com.sun.tools.classfile.SourceFile_attribute;
 51 import com.sun.tools.classfile.Type;
 52 import com.sun.tools.classfile.Type.ArrayType;
</pre>
<hr />
<pre>
454             writeList(String.format(&quot;flags: (0x%04x) &quot;, flags.flags), flags.getFieldFlags(), &quot;\n&quot;);
455 
456         if (options.showAllAttrs) {
457             for (Attribute attr: f.attributes)
458                 attrWriter.write(f, attr, constant_pool);
459             showBlank = true;
460         }
461 
462         indent(-1);
463 
464         if (showBlank || options.showDisassembled || options.showLineAndLocalVariableTables)
465             println();
466     }
467 
468     protected void writeMethods() {
469         for (Method m: classFile.methods)
470             writeMethod(m);
471         setPendingNewline(false);
472     }
473 



474     protected void writeMethod(Method m) {
475         if (!options.checkAccess(m.access_flags))
476             return;
477 
478         method = m;
479 
480         AccessFlags flags = m.access_flags;
481 
482         Descriptor d;
483         Type.MethodType methodType;
484         List&lt;? extends Type&gt; methodExceptions;
485 
486         Signature_attribute sigAttr = getSignature(m.attributes);
487         if (sigAttr == null) {
488             d = m.descriptor;
489             methodType = null;
490             methodExceptions = null;
491         } else {
492             Signature methodSig = sigAttr.getParsedSignature();
493             d = methodSig;
494             try {
495                 methodType = (Type.MethodType) methodSig.getType(constant_pool);
496                 methodExceptions = methodType.throwsTypes;
497                 if (methodExceptions != null &amp;&amp; methodExceptions.isEmpty())
498                     methodExceptions = null;
499             } catch (ConstantPoolException e) {
500                 // report error?
501                 // fall back on standard descriptor
502                 methodType = null;
503                 methodExceptions = null;
504             }
505         }
506 
<span class="line-modified">507         writeModifiers(flags.getMethodModifiers());</span>













508         if (methodType != null) {
509             print(new JavaTypePrinter(false).printTypeArgs(methodType.typeParamTypes));
510         }
<span class="line-modified">511         switch (getName(m)) {</span>
512             case &quot;&lt;init&gt;&quot;:
513                 print(getJavaName(classFile));
514                 print(getJavaParameterTypes(d, flags));
515                 break;
516             case &quot;&lt;clinit&gt;&quot;:
517                 print(&quot;{}&quot;);
518                 break;
519             default:
520                 print(getJavaReturnType(d));
521                 print(&quot; &quot;);
<span class="line-modified">522                 print(getName(m));</span>
523                 print(getJavaParameterTypes(d, flags));
524                 break;
525         }
526 
527         Attribute e_attr = m.attributes.get(Attribute.Exceptions);
528         if (e_attr != null) { // if there are generic exceptions, there must be erased exceptions
529             if (e_attr instanceof Exceptions_attribute) {
530                 Exceptions_attribute exceptions = (Exceptions_attribute) e_attr;
531                 print(&quot; throws &quot;);
532                 if (methodExceptions != null) { // use generic list if available
533                     writeList(&quot;&quot;, methodExceptions, &quot;&quot;);
534                 } else {
535                     for (int i = 0; i &lt; exceptions.number_of_exceptions; i++) {
536                         if (i &gt; 0)
537                             print(&quot;, &quot;);
538                         print(getJavaException(exceptions, i));
539                     }
540                 }
541             } else {
542                 report(&quot;Unexpected or invalid value for Exceptions attribute&quot;);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.tools.javap;
 27 
 28 import java.net.URI;
 29 import java.text.DateFormat;
 30 import java.util.Collection;
 31 import java.util.Date;
 32 import java.util.List;
<span class="line-added"> 33 import java.util.Set;</span>
 34 
 35 import com.sun.tools.classfile.AccessFlags;
 36 import com.sun.tools.classfile.Attribute;
 37 import com.sun.tools.classfile.Attributes;
 38 import com.sun.tools.classfile.ClassFile;
 39 import com.sun.tools.classfile.Code_attribute;
 40 import com.sun.tools.classfile.ConstantPool;
 41 import com.sun.tools.classfile.ConstantPoolException;
 42 import com.sun.tools.classfile.ConstantValue_attribute;
 43 import com.sun.tools.classfile.Descriptor;
 44 import com.sun.tools.classfile.Descriptor.InvalidDescriptor;
 45 import com.sun.tools.classfile.Exceptions_attribute;
 46 import com.sun.tools.classfile.Field;
 47 import com.sun.tools.classfile.Method;
 48 import com.sun.tools.classfile.Module_attribute;
 49 import com.sun.tools.classfile.Signature;
 50 import com.sun.tools.classfile.Signature_attribute;
 51 import com.sun.tools.classfile.SourceFile_attribute;
 52 import com.sun.tools.classfile.Type;
 53 import com.sun.tools.classfile.Type.ArrayType;
</pre>
<hr />
<pre>
455             writeList(String.format(&quot;flags: (0x%04x) &quot;, flags.flags), flags.getFieldFlags(), &quot;\n&quot;);
456 
457         if (options.showAllAttrs) {
458             for (Attribute attr: f.attributes)
459                 attrWriter.write(f, attr, constant_pool);
460             showBlank = true;
461         }
462 
463         indent(-1);
464 
465         if (showBlank || options.showDisassembled || options.showLineAndLocalVariableTables)
466             println();
467     }
468 
469     protected void writeMethods() {
470         for (Method m: classFile.methods)
471             writeMethod(m);
472         setPendingNewline(false);
473     }
474 
<span class="line-added">475     private static final int DEFAULT_ALLOWED_MAJOR_VERSION = 52;</span>
<span class="line-added">476     private static final int DEFAULT_ALLOWED_MINOR_VERSION = 0;</span>
<span class="line-added">477 </span>
478     protected void writeMethod(Method m) {
479         if (!options.checkAccess(m.access_flags))
480             return;
481 
482         method = m;
483 
484         AccessFlags flags = m.access_flags;
485 
486         Descriptor d;
487         Type.MethodType methodType;
488         List&lt;? extends Type&gt; methodExceptions;
489 
490         Signature_attribute sigAttr = getSignature(m.attributes);
491         if (sigAttr == null) {
492             d = m.descriptor;
493             methodType = null;
494             methodExceptions = null;
495         } else {
496             Signature methodSig = sigAttr.getParsedSignature();
497             d = methodSig;
498             try {
499                 methodType = (Type.MethodType) methodSig.getType(constant_pool);
500                 methodExceptions = methodType.throwsTypes;
501                 if (methodExceptions != null &amp;&amp; methodExceptions.isEmpty())
502                     methodExceptions = null;
503             } catch (ConstantPoolException e) {
504                 // report error?
505                 // fall back on standard descriptor
506                 methodType = null;
507                 methodExceptions = null;
508             }
509         }
510 
<span class="line-modified">511         Set&lt;String&gt; modifiers = flags.getMethodModifiers();</span>
<span class="line-added">512 </span>
<span class="line-added">513         String name = getName(m);</span>
<span class="line-added">514         if (classFile.isInterface() &amp;&amp;</span>
<span class="line-added">515                 (!flags.is(AccessFlags.ACC_ABSTRACT)) &amp;&amp; !name.equals(&quot;&lt;clinit&gt;&quot;)) {</span>
<span class="line-added">516             if (classFile.major_version &gt; DEFAULT_ALLOWED_MAJOR_VERSION ||</span>
<span class="line-added">517                     (classFile.major_version == DEFAULT_ALLOWED_MAJOR_VERSION &amp;&amp; classFile.minor_version &gt;= DEFAULT_ALLOWED_MINOR_VERSION)) {</span>
<span class="line-added">518                 if (!flags.is(AccessFlags.ACC_STATIC | AccessFlags.ACC_PRIVATE)) {</span>
<span class="line-added">519                     modifiers.add(&quot;default&quot;);</span>
<span class="line-added">520                 }</span>
<span class="line-added">521             }</span>
<span class="line-added">522         }</span>
<span class="line-added">523 </span>
<span class="line-added">524         writeModifiers(modifiers);</span>
525         if (methodType != null) {
526             print(new JavaTypePrinter(false).printTypeArgs(methodType.typeParamTypes));
527         }
<span class="line-modified">528         switch (name) {</span>
529             case &quot;&lt;init&gt;&quot;:
530                 print(getJavaName(classFile));
531                 print(getJavaParameterTypes(d, flags));
532                 break;
533             case &quot;&lt;clinit&gt;&quot;:
534                 print(&quot;{}&quot;);
535                 break;
536             default:
537                 print(getJavaReturnType(d));
538                 print(&quot; &quot;);
<span class="line-modified">539                 print(name);</span>
540                 print(getJavaParameterTypes(d, flags));
541                 break;
542         }
543 
544         Attribute e_attr = m.attributes.get(Attribute.Exceptions);
545         if (e_attr != null) { // if there are generic exceptions, there must be erased exceptions
546             if (e_attr instanceof Exceptions_attribute) {
547                 Exceptions_attribute exceptions = (Exceptions_attribute) e_attr;
548                 print(&quot; throws &quot;);
549                 if (methodExceptions != null) { // use generic list if available
550                     writeList(&quot;&quot;, methodExceptions, &quot;&quot;);
551                 } else {
552                     for (int i = 0; i &lt; exceptions.number_of_exceptions; i++) {
553                         if (i &gt; 0)
554                             print(&quot;, &quot;);
555                         print(getJavaException(exceptions, i));
556                     }
557                 }
558             } else {
559                 report(&quot;Unexpected or invalid value for Exceptions attribute&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="AttributeWriter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="JavapTask.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>