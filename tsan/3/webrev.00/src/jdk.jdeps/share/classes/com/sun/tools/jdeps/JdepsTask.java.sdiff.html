<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.jdeps/share/classes/com/sun/tools/jdeps/JdepsTask.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ClassFileReader.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ModuleAnalyzer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jdeps/share/classes/com/sun/tools/jdeps/JdepsTask.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 898         final Path dir;
 899         final boolean openModule;
 900         GenModuleInfo(Path dir, boolean openModule) {
 901             super(CommandOption.GENERATE_MODULE_INFO);
 902             this.dir = dir;
 903             this.openModule = openModule;
 904         }
 905 
 906         @Override
 907         boolean checkOptions() {
 908             if (options.classpath != null) {
 909                 reportError(&quot;err.invalid.options&quot;, &quot;-classpath&quot;,
 910                             option);
 911                 return false;
 912             }
 913             if (options.hasFilter()) {
 914                 reportError(&quot;err.invalid.options&quot;, &quot;--package, --regex, --require&quot;,
 915                             option);
 916                 return false;
 917             }





 918             return true;
 919         }
 920 
 921         @Override
 922         boolean run(JdepsConfiguration config) throws IOException {
 923             // check if any JAR file contains unnamed package
 924             for (String arg : inputArgs) {
<span class="line-modified"> 925                 try (ClassFileReader reader = ClassFileReader.newInstance(Paths.get(arg))) {</span>
 926                     Optional&lt;String&gt; classInUnnamedPackage =
 927                         reader.entries().stream()
<span class="line-modified"> 928                              .filter(n -&gt; n.endsWith(&quot;.class&quot;))</span>
<span class="line-modified"> 929                              .filter(cn -&gt; toPackageName(cn).isEmpty())</span>
<span class="line-modified"> 930                              .findFirst();</span>
 931 
 932                     if (classInUnnamedPackage.isPresent()) {
 933                         if (classInUnnamedPackage.get().equals(&quot;module-info.class&quot;)) {
 934                             reportError(&quot;err.genmoduleinfo.not.jarfile&quot;, arg);
 935                         } else {
 936                             reportError(&quot;err.genmoduleinfo.unnamed.package&quot;, arg);
 937                         }
 938                         return false;
 939                     }
 940                 }
 941             }
 942 
 943             ModuleInfoBuilder builder
 944                  = new ModuleInfoBuilder(config, inputArgs, dir, openModule);
<span class="line-modified"> 945             boolean ok = builder.run();</span>
<span class="line-modified"> 946 </span>
<span class="line-removed"> 947             if (!ok &amp;&amp; !options.nowarning) {</span>
 948                 reportError(&quot;err.missing.dependences&quot;);

 949                 builder.visitMissingDeps(new SimpleDepVisitor());
 950             }
 951             return ok;
 952         }
 953 
 954         private String toPackageName(String name) {
 955             int i = name.lastIndexOf(&#39;/&#39;);
 956             return i &gt; 0 ? name.replace(&#39;/&#39;, &#39;.&#39;).substring(0, i) : &quot;&quot;;
 957         }
 958     }
 959 
 960     class CheckModuleDeps extends Command {
 961         final Set&lt;String&gt; modules;
 962         CheckModuleDeps(Set&lt;String&gt; mods) {
 963             super(CommandOption.CHECK_MODULES);
 964             this.modules = mods;
 965         }
 966 
 967         @Override
 968         boolean checkOptions() {
 969             if (!inputArgs.isEmpty()) {
 970                 reportError(&quot;err.invalid.options&quot;, inputArgs, &quot;--check&quot;);
 971                 return false;
 972             }
 973             return true;
 974         }
 975 
 976         @Override
 977         boolean run(JdepsConfiguration config) throws IOException {
 978             if (!config.initialArchives().isEmpty()) {
 979                 String list = config.initialArchives().stream()
 980                                     .map(Archive::getPathName).collect(joining(&quot; &quot;));
 981                 throw new UncheckedBadArgs(new BadArgs(&quot;err.invalid.options&quot;,
 982                                                        list, &quot;--check&quot;));
 983             }
<span class="line-modified"> 984             return new ModuleAnalyzer(config, log, modules).run();</span>
 985         }
 986 
 987         /*
 988          * Returns true to analyze all modules
 989          */
 990         Set&lt;String&gt; addModules() {
 991             return Set.of(&quot;ALL-SYSTEM&quot;, &quot;ALL-MODULE-PATH&quot;);
 992         }
 993     }
 994 
 995     class ListModuleDeps extends Command {
 996         final boolean jdkinternals;
 997         final boolean reduced;
 998         final String separator;
 999         ListModuleDeps(CommandOption option, boolean jdkinternals, boolean reduced) {
1000             this(option, jdkinternals, reduced, System.getProperty(&quot;line.separator&quot;));
1001         }
1002         ListModuleDeps(CommandOption option, boolean jdkinternals, boolean reduced, String sep) {
1003             super(option);
1004             this.jdkinternals = jdkinternals;
</pre>
<hr />
<pre>
1024             if (!inputArgs.isEmpty() &amp;&amp; !options.rootModules.isEmpty()) {
1025                 reportError(&quot;err.invalid.arg.for.option&quot;, &quot;-m&quot;);
1026             }
1027             if (inputArgs.isEmpty() &amp;&amp; !options.hasSourcePath()) {
1028                 showHelp();
1029                 return false;
1030             }
1031             return true;
1032         }
1033 
1034         @Override
1035         boolean run(JdepsConfiguration config) throws IOException {
1036             ModuleExportsAnalyzer analyzer = new ModuleExportsAnalyzer(config,
1037                                                                        dependencyFilter(config),
1038                                                                        jdkinternals,
1039                                                                        reduced,
1040                                                                        log,
1041                                                                        separator);
1042             boolean ok = analyzer.run(options.depth(), options.ignoreMissingDeps);
1043             if (!ok) {
<span class="line-modified">1044                 reportError(&quot;err.cant.list.module.deps&quot;);</span>
1045                 log.println();
1046                 analyzer.visitMissingDeps(new SimpleDepVisitor());
1047             }
1048             return ok;
1049         }
1050     }
1051 
1052     class GenDotFile extends AnalyzeDeps {
1053         final Path dotOutputDir;
1054         GenDotFile(Path dotOutputDir) {
1055             super(CommandOption.GENERATE_DOT_FILE);
1056 
1057             this.dotOutputDir = dotOutputDir;
1058         }
1059 
1060         @Override
1061         boolean run(JdepsConfiguration config) throws IOException {
1062             if ((options.showSummary || options.verbose == MODULE) &amp;&amp;
1063                 !options.addmods.isEmpty() &amp;&amp; inputArgs.isEmpty()) {
1064                 // generate dot graph from the resolved graph from module
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 898         final Path dir;
 899         final boolean openModule;
 900         GenModuleInfo(Path dir, boolean openModule) {
 901             super(CommandOption.GENERATE_MODULE_INFO);
 902             this.dir = dir;
 903             this.openModule = openModule;
 904         }
 905 
 906         @Override
 907         boolean checkOptions() {
 908             if (options.classpath != null) {
 909                 reportError(&quot;err.invalid.options&quot;, &quot;-classpath&quot;,
 910                             option);
 911                 return false;
 912             }
 913             if (options.hasFilter()) {
 914                 reportError(&quot;err.invalid.options&quot;, &quot;--package, --regex, --require&quot;,
 915                             option);
 916                 return false;
 917             }
<span class="line-added"> 918             if (!options.rootModules.isEmpty()) {</span>
<span class="line-added"> 919                 reportError(&quot;err.invalid.options&quot;, &quot;-m or --module&quot;,</span>
<span class="line-added"> 920                             option);</span>
<span class="line-added"> 921                 return false;</span>
<span class="line-added"> 922             }</span>
 923             return true;
 924         }
 925 
 926         @Override
 927         boolean run(JdepsConfiguration config) throws IOException {
 928             // check if any JAR file contains unnamed package
 929             for (String arg : inputArgs) {
<span class="line-modified"> 930                 try (ClassFileReader reader = ClassFileReader.newInstance(Paths.get(arg), config.getVersion())) {</span>
 931                     Optional&lt;String&gt; classInUnnamedPackage =
 932                         reader.entries().stream()
<span class="line-modified"> 933                               .filter(n -&gt; n.endsWith(&quot;.class&quot;))</span>
<span class="line-modified"> 934                               .filter(cn -&gt; toPackageName(cn).isEmpty())</span>
<span class="line-modified"> 935                               .findFirst();</span>
 936 
 937                     if (classInUnnamedPackage.isPresent()) {
 938                         if (classInUnnamedPackage.get().equals(&quot;module-info.class&quot;)) {
 939                             reportError(&quot;err.genmoduleinfo.not.jarfile&quot;, arg);
 940                         } else {
 941                             reportError(&quot;err.genmoduleinfo.unnamed.package&quot;, arg);
 942                         }
 943                         return false;
 944                     }
 945                 }
 946             }
 947 
 948             ModuleInfoBuilder builder
 949                  = new ModuleInfoBuilder(config, inputArgs, dir, openModule);
<span class="line-modified"> 950             boolean ok = builder.run(options.ignoreMissingDeps, log, options.nowarning);</span>
<span class="line-modified"> 951             if (!ok) {</span>

 952                 reportError(&quot;err.missing.dependences&quot;);
<span class="line-added"> 953                 log.println();</span>
 954                 builder.visitMissingDeps(new SimpleDepVisitor());
 955             }
 956             return ok;
 957         }
 958 
 959         private String toPackageName(String name) {
 960             int i = name.lastIndexOf(&#39;/&#39;);
 961             return i &gt; 0 ? name.replace(&#39;/&#39;, &#39;.&#39;).substring(0, i) : &quot;&quot;;
 962         }
 963     }
 964 
 965     class CheckModuleDeps extends Command {
 966         final Set&lt;String&gt; modules;
 967         CheckModuleDeps(Set&lt;String&gt; mods) {
 968             super(CommandOption.CHECK_MODULES);
 969             this.modules = mods;
 970         }
 971 
 972         @Override
 973         boolean checkOptions() {
 974             if (!inputArgs.isEmpty()) {
 975                 reportError(&quot;err.invalid.options&quot;, inputArgs, &quot;--check&quot;);
 976                 return false;
 977             }
 978             return true;
 979         }
 980 
 981         @Override
 982         boolean run(JdepsConfiguration config) throws IOException {
 983             if (!config.initialArchives().isEmpty()) {
 984                 String list = config.initialArchives().stream()
 985                                     .map(Archive::getPathName).collect(joining(&quot; &quot;));
 986                 throw new UncheckedBadArgs(new BadArgs(&quot;err.invalid.options&quot;,
 987                                                        list, &quot;--check&quot;));
 988             }
<span class="line-modified"> 989             return new ModuleAnalyzer(config, log, modules).run(options.ignoreMissingDeps);</span>
 990         }
 991 
 992         /*
 993          * Returns true to analyze all modules
 994          */
 995         Set&lt;String&gt; addModules() {
 996             return Set.of(&quot;ALL-SYSTEM&quot;, &quot;ALL-MODULE-PATH&quot;);
 997         }
 998     }
 999 
1000     class ListModuleDeps extends Command {
1001         final boolean jdkinternals;
1002         final boolean reduced;
1003         final String separator;
1004         ListModuleDeps(CommandOption option, boolean jdkinternals, boolean reduced) {
1005             this(option, jdkinternals, reduced, System.getProperty(&quot;line.separator&quot;));
1006         }
1007         ListModuleDeps(CommandOption option, boolean jdkinternals, boolean reduced, String sep) {
1008             super(option);
1009             this.jdkinternals = jdkinternals;
</pre>
<hr />
<pre>
1029             if (!inputArgs.isEmpty() &amp;&amp; !options.rootModules.isEmpty()) {
1030                 reportError(&quot;err.invalid.arg.for.option&quot;, &quot;-m&quot;);
1031             }
1032             if (inputArgs.isEmpty() &amp;&amp; !options.hasSourcePath()) {
1033                 showHelp();
1034                 return false;
1035             }
1036             return true;
1037         }
1038 
1039         @Override
1040         boolean run(JdepsConfiguration config) throws IOException {
1041             ModuleExportsAnalyzer analyzer = new ModuleExportsAnalyzer(config,
1042                                                                        dependencyFilter(config),
1043                                                                        jdkinternals,
1044                                                                        reduced,
1045                                                                        log,
1046                                                                        separator);
1047             boolean ok = analyzer.run(options.depth(), options.ignoreMissingDeps);
1048             if (!ok) {
<span class="line-modified">1049                 reportError(&quot;err.missing.dependences&quot;);</span>
1050                 log.println();
1051                 analyzer.visitMissingDeps(new SimpleDepVisitor());
1052             }
1053             return ok;
1054         }
1055     }
1056 
1057     class GenDotFile extends AnalyzeDeps {
1058         final Path dotOutputDir;
1059         GenDotFile(Path dotOutputDir) {
1060             super(CommandOption.GENERATE_DOT_FILE);
1061 
1062             this.dotOutputDir = dotOutputDir;
1063         }
1064 
1065         @Override
1066         boolean run(JdepsConfiguration config) throws IOException {
1067             if ((options.showSummary || options.verbose == MODULE) &amp;&amp;
1068                 !options.addmods.isEmpty() &amp;&amp; inputArgs.isEmpty()) {
1069                 // generate dot graph from the resolved graph from module
</pre>
</td>
</tr>
</table>
<center><a href="ClassFileReader.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ModuleAnalyzer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>