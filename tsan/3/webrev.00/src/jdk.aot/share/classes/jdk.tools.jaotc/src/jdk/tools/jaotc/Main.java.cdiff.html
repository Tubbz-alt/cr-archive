<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.aot/share/classes/jdk.tools.jaotc/src/jdk/tools/jaotc/Main.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DataPatchProcessor.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="MarkId.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.aot/share/classes/jdk.tools.jaotc/src/jdk/tools/jaotc/Main.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 49,14 ***</span>
<span class="line-new-header">--- 49,16 ---</span>
  import org.graalvm.compiler.hotspot.CompilerConfigurationFactory;
  import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
  import org.graalvm.compiler.hotspot.HotSpotGraalCompilerFactory;
  import org.graalvm.compiler.hotspot.HotSpotGraalOptionValues;
  import org.graalvm.compiler.hotspot.HotSpotGraalRuntime;
<span class="line-added">+ import org.graalvm.compiler.hotspot.HotSpotGraalRuntime.HotSpotGC;</span>
  import org.graalvm.compiler.hotspot.HotSpotHostBackend;
  import org.graalvm.compiler.hotspot.meta.HotSpotInvokeDynamicPlugin;
  import org.graalvm.compiler.java.GraphBuilderPhase;
  import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration;
<span class="line-added">+ import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;</span>
  import org.graalvm.compiler.options.OptionValues;
  import org.graalvm.compiler.phases.BasePhase;
  import org.graalvm.compiler.phases.PhaseSuite;
  import org.graalvm.compiler.phases.tiers.HighTierContext;
  import org.graalvm.compiler.printer.GraalDebugHandlersFactory;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 192,11 ***</span>
              }
  
              AOTDynamicTypeStore dynoStore = new AOTDynamicTypeStore();
              AOTCompiledClass.setDynamicTypeStore(dynoStore);
  
<span class="line-modified">!             AOTBackend aotBackend = new AOTBackend(this, graalOptions, backend, new HotSpotInvokeDynamicPlugin(dynoStore));</span>
              SnippetReflectionProvider snippetReflection = aotBackend.getProviders().getSnippetReflection();
              AOTCompiler compiler = new AOTCompiler(this, graalOptions, aotBackend, options.threads);
              classes = compiler.compileClasses(classes);
  
              GraalHotSpotVMConfig graalHotSpotVMConfig = runtime.getVMConfig();
<span class="line-new-header">--- 194,21 ---</span>
              }
  
              AOTDynamicTypeStore dynoStore = new AOTDynamicTypeStore();
              AOTCompiledClass.setDynamicTypeStore(dynoStore);
  
<span class="line-modified">!             // AOTBackend aotBackend = new AOTBackend(this, graalOptions, backend, new</span>
<span class="line-added">+             // HotSpotInvokeDynamicPlugin(dynoStore));</span>
<span class="line-added">+             // Temporary workaround until JDK-8223533 is fixed.</span>
<span class="line-added">+             // Disable invokedynamic support.</span>
<span class="line-added">+             var indyPlugin = new HotSpotInvokeDynamicPlugin(dynoStore) {</span>
<span class="line-added">+                 @Override</span>
<span class="line-added">+                 public boolean supportsDynamicInvoke(GraphBuilderContext builder, int index, int opcode) {</span>
<span class="line-added">+                     return false;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             };</span>
<span class="line-added">+             AOTBackend aotBackend = new AOTBackend(this, graalOptions, backend, indyPlugin);</span>
              SnippetReflectionProvider snippetReflection = aotBackend.getProviders().getSnippetReflection();
              AOTCompiler compiler = new AOTCompiler(this, graalOptions, aotBackend, options.threads);
              classes = compiler.compileClasses(classes);
  
              GraalHotSpotVMConfig graalHotSpotVMConfig = runtime.getVMConfig();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 210,11 ***</span>
                  aotBackend = null;
                  compiler = null;
                  System.gc();
              }
  
<span class="line-modified">!             int gc = runtime.getGarbageCollector().ordinal() + 1;</span>
              BinaryContainer binaryContainer = new BinaryContainer(graalOptions, graalHotSpotVMConfig, graphBuilderConfig, gc, JVM_VERSION);
              DataBuilder dataBuilder = new DataBuilder(this, backend, classes, binaryContainer);
  
              try (DebugContext debug = DebugContext.create(graalOptions, new GraalDebugHandlersFactory(snippetReflection)); Activation a = debug.activate()) {
                  dataBuilder.prepareData(debug);
<span class="line-new-header">--- 222,20 ---</span>
                  aotBackend = null;
                  compiler = null;
                  System.gc();
              }
  
<span class="line-modified">!             HotSpotGC graalGC = runtime.getGarbageCollector();</span>
<span class="line-added">+             // Prior to JDK 14, the Graal HotSpotGC enum order matched the JDK CollectedHeap enum</span>
<span class="line-added">+             // order, so using the ordinal value worked fine. In JDK 14, CMS was removed on the</span>
<span class="line-added">+             // JDK side, so we need a symbolic lookup of the JDK value.</span>
<span class="line-added">+             int def = graalGC.ordinal() + 1;</span>
<span class="line-added">+             // The GC names are spelled the same in both enums, so no clever remapping is needed</span>
<span class="line-added">+             // here.</span>
<span class="line-added">+             String name = &quot;CollectedHeap::&quot; + graalGC.name();</span>
<span class="line-added">+             int gc = graalHotSpotVMConfig.getConstant(name, Integer.class, def);</span>
<span class="line-added">+ </span>
              BinaryContainer binaryContainer = new BinaryContainer(graalOptions, graalHotSpotVMConfig, graphBuilderConfig, gc, JVM_VERSION);
              DataBuilder dataBuilder = new DataBuilder(this, backend, classes, binaryContainer);
  
              try (DebugContext debug = DebugContext.create(graalOptions, new GraalDebugHandlersFactory(snippetReflection)); Activation a = debug.activate()) {
                  dataBuilder.prepareData(debug);
</pre>
<center><a href="DataPatchProcessor.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="MarkId.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>