<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.rmi/share/classes/sun/rmi/runtime/Log.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../registry/RegistryImpl_Stub.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../server/ActivatableServerRef.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.rmi/share/classes/sun/rmi/runtime/Log.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,12 +26,14 @@</span>
  package sun.rmi.runtime;
  
  import java.io.ByteArrayOutputStream;
  import java.io.PrintStream;
  import java.io.OutputStream;
<span class="udiff-line-added">+ import java.lang.StackWalker.StackFrame;</span>
  import java.rmi.server.LogStream;
  import java.security.PrivilegedAction;
<span class="udiff-line-added">+ import java.util.Set;</span>
  import java.util.logging.Handler;
  import java.util.logging.SimpleFormatter;
  import java.util.logging.Level;
  import java.util.logging.Logger;
  import java.util.logging.LogRecord;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -60,10 +62,12 @@</span>
  
      /** Logger re-definition of old RMI log values */
      public static final Level BRIEF = Level.FINE;
      public static final Level VERBOSE = Level.FINER;
  
<span class="udiff-line-added">+     private static final StackWalker WALKER = StackWalker.getInstance(Set.of(), 4);</span>
<span class="udiff-line-added">+ </span>
      /* selects log implementation */
      private static final LogFactory logFactory;
      static {
          boolean useOld = java.security.AccessController.doPrivileged(
              (PrivilegedAction&lt;Boolean&gt;) () -&gt; Boolean.getBoolean(&quot;sun.rmi.log.useOld&quot;));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -215,20 +219,20 @@</span>
              return logger.isLoggable(level);
          }
  
          public void log(Level level, String message) {
              if (isLoggable(level)) {
<span class="udiff-line-modified-removed">-                 String[] source = getSource();</span>
<span class="udiff-line-modified-removed">-                 logger.logp(level, source[0], source[1],</span>
<span class="udiff-line-modified-added">+                 StackFrame sourceFrame = getSource();</span>
<span class="udiff-line-modified-added">+                 logger.logp(level, sourceFrame.getClassName(), sourceFrame.getMethodName(),</span>
                             Thread.currentThread().getName() + &quot;: &quot; + message);
              }
          }
  
          public void log(Level level, String message, Throwable thrown) {
              if (isLoggable(level)) {
<span class="udiff-line-modified-removed">-                 String[] source = getSource();</span>
<span class="udiff-line-modified-removed">-                 logger.logp(level, source[0], source[1],</span>
<span class="udiff-line-modified-added">+                 StackFrame sourceFrame = getSource();</span>
<span class="udiff-line-modified-added">+                 logger.logp(level, sourceFrame.getClassName(), sourceFrame.getMethodName(),</span>
                      Thread.currentThread().getName() + &quot;: &quot; +
                             message, thrown);
              }
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -388,26 +392,26 @@</span>
              return (level.intValue() &gt;= levelValue);
          }
  
          public void log(Level messageLevel, String message) {
              if (isLoggable(messageLevel)) {
<span class="udiff-line-modified-removed">-                 String[] source = getSource();</span>
<span class="udiff-line-modified-removed">-                 stream.println(unqualifiedName(source[0]) +</span>
<span class="udiff-line-modified-removed">-                                &quot;.&quot; + source[1] + &quot;: &quot; + message);</span>
<span class="udiff-line-modified-added">+                 StackFrame sourceFrame = getSource();</span>
<span class="udiff-line-modified-added">+                 stream.println(unqualifiedName(sourceFrame.getClassName()) +</span>
<span class="udiff-line-modified-added">+                                &quot;.&quot; + sourceFrame.getMethodName() + &quot;: &quot; + message);</span>
              }
          }
  
          public void log(Level level, String message, Throwable thrown) {
              if (isLoggable(level)) {
                  /*
                   * keep output contiguous and maintain the contract of
                   * RemoteServer.getLog
                   */
                  synchronized (stream) {
<span class="udiff-line-modified-removed">-                     String[] source = getSource();</span>
<span class="udiff-line-modified-removed">-                     stream.println(unqualifiedName(source[0]) + &quot;.&quot; +</span>
<span class="udiff-line-modified-removed">-                                    source[1] + &quot;: &quot; + message);</span>
<span class="udiff-line-modified-added">+                     StackFrame sourceFrame = getSource();</span>
<span class="udiff-line-modified-added">+                     stream.println(unqualifiedName(sourceFrame.getClassName()) + &quot;.&quot; +</span>
<span class="udiff-line-modified-added">+                                     sourceFrame.getMethodName() + &quot;: &quot; + message);</span>
                      thrown.printStackTrace(stream);
                  }
              }
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -439,15 +443,14 @@</span>
              return name;
          }
      }
  
      /**
<span class="udiff-line-modified-removed">-      * Obtain class and method names of code calling a log method.</span>
<span class="udiff-line-modified-added">+      * Obtain stack frame of code calling a log method.</span>
       */
<span class="udiff-line-modified-removed">-     private static String[] getSource() {</span>
<span class="udiff-line-modified-removed">-         StackTraceElement[] trace = (new Exception()).getStackTrace();</span>
<span class="udiff-line-modified-removed">-         return new String[] {</span>
<span class="udiff-line-modified-removed">-             trace[3].getClassName(),</span>
<span class="udiff-line-modified-removed">-             trace[3].getMethodName()</span>
<span class="udiff-line-removed">-         };</span>
<span class="udiff-line-modified-added">+     private static StackFrame getSource() {</span>
<span class="udiff-line-modified-added">+         return WALKER.walk(s -&gt; s</span>
<span class="udiff-line-modified-added">+                                  .skip(3)</span>
<span class="udiff-line-modified-added">+                                  .findFirst()</span>
<span class="udiff-line-modified-added">+                                  .get());</span>
      }
  }
</pre>
<center><a href="../registry/RegistryImpl_Stub.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../server/ActivatableServerRef.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>