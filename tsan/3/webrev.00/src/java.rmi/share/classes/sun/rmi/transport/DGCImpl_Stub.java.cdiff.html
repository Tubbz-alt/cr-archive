<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.rmi/share/classes/sun/rmi/transport/DGCImpl_Stub.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="DGCImpl_Skel.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="StreamRemoteCall.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.rmi/share/classes/sun/rmi/transport/DGCImpl_Stub.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,20 ***</span>
   * questions.
   */
  
  package sun.rmi.transport;
  
  import java.io.ObjectInputFilter;
<span class="line-modified">! import java.io.ObjectInputStream;</span>
  import java.rmi.dgc.Lease;
  import java.rmi.dgc.VMID;
  import java.rmi.server.UID;
  import java.security.AccessController;
  import java.security.PrivilegedAction;
<span class="line-modified">! </span>
<span class="line-removed">- import sun.rmi.server.UnicastRef;</span>
<span class="line-removed">- import sun.rmi.transport.tcp.TCPConnection;</span>
  
  /**
   * Stubs to invoke DGC remote methods.
   * Originally generated from RMIC but frozen to insert serialFilter.
   */
<span class="line-new-header">--- 23,21 ---</span>
   * questions.
   */
  
  package sun.rmi.transport;
  
<span class="line-added">+ import sun.rmi.transport.tcp.TCPConnection;</span>
<span class="line-added">+ </span>
<span class="line-added">+ import java.io.IOException;</span>
  import java.io.ObjectInputFilter;
<span class="line-modified">! import java.rmi.RemoteException;</span>
  import java.rmi.dgc.Lease;
  import java.rmi.dgc.VMID;
  import java.rmi.server.UID;
  import java.security.AccessController;
  import java.security.PrivilegedAction;
<span class="line-modified">! import java.util.ArrayList;</span>
  
  /**
   * Stubs to invoke DGC remote methods.
   * Originally generated from RMIC but frozen to insert serialFilter.
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 70,11 ***</span>
  
      // implementation of clean(ObjID[], long, VMID, boolean)
      public void clean(java.rmi.server.ObjID[] $param_arrayOf_ObjID_1, long $param_long_2, java.rmi.dgc.VMID $param_VMID_3, boolean $param_boolean_4)
              throws java.rmi.RemoteException {
          try {
<span class="line-modified">!             java.rmi.server.RemoteCall call = ref.newCall((java.rmi.server.RemoteObject) this, operations, 0, interfaceHash);</span>
              try {
                  java.io.ObjectOutput out = call.getOutputStream();
                  out.writeObject($param_arrayOf_ObjID_1);
                  out.writeLong($param_long_2);
                  out.writeObject($param_VMID_3);
<span class="line-new-header">--- 71,13 ---</span>
  
      // implementation of clean(ObjID[], long, VMID, boolean)
      public void clean(java.rmi.server.ObjID[] $param_arrayOf_ObjID_1, long $param_long_2, java.rmi.dgc.VMID $param_VMID_3, boolean $param_boolean_4)
              throws java.rmi.RemoteException {
          try {
<span class="line-modified">!             StreamRemoteCall call = (StreamRemoteCall)ref.newCall((java.rmi.server.RemoteObject) this,</span>
<span class="line-added">+                     operations, 0, interfaceHash);</span>
<span class="line-added">+             call.setObjectInputFilter(DGCImpl_Stub::leaseFilter);</span>
              try {
                  java.io.ObjectOutput out = call.getOutputStream();
                  out.writeObject($param_arrayOf_ObjID_1);
                  out.writeLong($param_long_2);
                  out.writeObject($param_VMID_3);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 95,41 ***</span>
  
      // implementation of dirty(ObjID[], long, Lease)
      public java.rmi.dgc.Lease dirty(java.rmi.server.ObjID[] $param_arrayOf_ObjID_1, long $param_long_2, java.rmi.dgc.Lease $param_Lease_3)
              throws java.rmi.RemoteException {
          try {
<span class="line-modified">!             java.rmi.server.RemoteCall call = ref.newCall((java.rmi.server.RemoteObject) this, operations, 1, interfaceHash);</span>
              try {
                  java.io.ObjectOutput out = call.getOutputStream();
                  out.writeObject($param_arrayOf_ObjID_1);
                  out.writeLong($param_long_2);
                  out.writeObject($param_Lease_3);
              } catch (java.io.IOException e) {
                  throw new java.rmi.MarshalException(&quot;error marshalling arguments&quot;, e);
              }
              ref.invoke(call);
              java.rmi.dgc.Lease $result;
<span class="line-modified">!             Connection connection = ((StreamRemoteCall) call).getConnection();</span>
              try {
                  java.io.ObjectInput in = call.getInputStream();
<span class="line-removed">- </span>
<span class="line-removed">-                 if (in instanceof ObjectInputStream) {</span>
<span class="line-removed">-                     /**</span>
<span class="line-removed">-                      * Set a filter on the stream for the return value.</span>
<span class="line-removed">-                      */</span>
<span class="line-removed">-                     ObjectInputStream ois = (ObjectInputStream) in;</span>
<span class="line-removed">-                     AccessController.doPrivileged((PrivilegedAction&lt;Void&gt;)() -&gt; {</span>
<span class="line-removed">-                         ois.setObjectInputFilter(DGCImpl_Stub::leaseFilter);</span>
<span class="line-removed">-                         return null;</span>
<span class="line-removed">-                     });</span>
<span class="line-removed">-                 }</span>
                  $result = (java.rmi.dgc.Lease) in.readObject();
<span class="line-modified">!             } catch (java.io.IOException | java.lang.ClassNotFoundException e) {</span>
                  if (connection instanceof TCPConnection) {
                      // Modified to prevent re-use of the connection after an exception
                      ((TCPConnection) connection).getChannel().free(connection, false);
                  }
                  throw new java.rmi.UnmarshalException(&quot;error unmarshalling return&quot;, e);
              } finally {
                  ref.done(call);
              }
              return $result;
<span class="line-new-header">--- 98,34 ---</span>
  
      // implementation of dirty(ObjID[], long, Lease)
      public java.rmi.dgc.Lease dirty(java.rmi.server.ObjID[] $param_arrayOf_ObjID_1, long $param_long_2, java.rmi.dgc.Lease $param_Lease_3)
              throws java.rmi.RemoteException {
          try {
<span class="line-modified">!             StreamRemoteCall call =</span>
<span class="line-added">+                     (StreamRemoteCall)ref.newCall((java.rmi.server.RemoteObject) this,</span>
<span class="line-added">+                             operations, 1, interfaceHash);</span>
<span class="line-added">+             call.setObjectInputFilter(DGCImpl_Stub::leaseFilter);</span>
              try {
                  java.io.ObjectOutput out = call.getOutputStream();
                  out.writeObject($param_arrayOf_ObjID_1);
                  out.writeLong($param_long_2);
                  out.writeObject($param_Lease_3);
              } catch (java.io.IOException e) {
                  throw new java.rmi.MarshalException(&quot;error marshalling arguments&quot;, e);
              }
              ref.invoke(call);
              java.rmi.dgc.Lease $result;
<span class="line-modified">!             Connection connection = call.getConnection();</span>
              try {
                  java.io.ObjectInput in = call.getInputStream();
                  $result = (java.rmi.dgc.Lease) in.readObject();
<span class="line-modified">!             } catch (ClassCastException | IOException | ClassNotFoundException e) {</span>
                  if (connection instanceof TCPConnection) {
                      // Modified to prevent re-use of the connection after an exception
                      ((TCPConnection) connection).getChannel().free(connection, false);
                  }
<span class="line-added">+                 call.discardPendingRefs();</span>
                  throw new java.rmi.UnmarshalException(&quot;error unmarshalling return&quot;, e);
              } finally {
                  ref.done(call);
              }
              return $result;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 144,10 ***</span>
<span class="line-new-header">--- 140,15 ---</span>
  
      /**
       * ObjectInputFilter to filter DGCClient return value (a Lease).
       * The list of acceptable classes is very short and explicit.
       * The depth and array sizes are limited.
<span class="line-added">+      * &lt;p&gt;</span>
<span class="line-added">+      * The filter must accept normal and exception returns.</span>
<span class="line-added">+      * A DGC server may throw exceptions that may have a cause</span>
<span class="line-added">+      * and suppressed exceptions.</span>
<span class="line-added">+      * Only exceptions in {@code java.base} and {@code java.rmi} are allowed.</span>
       *
       * @param filterInfo access to class, arrayLength, etc.
       * @return  {@link ObjectInputFilter.Status#ALLOWED} if allowed,
       *          {@link ObjectInputFilter.Status#REJECTED} if rejected,
       *          otherwise {@link ObjectInputFilter.Status#UNDECIDED}
</pre>
<hr />
<pre>
<span class="line-old-header">*** 170,11 ***</span>
                  // Arrays of primitives are allowed
                  return ObjectInputFilter.Status.ALLOWED;
              }
              return (clazz == UID.class ||
                      clazz == VMID.class ||
<span class="line-modified">!                     clazz == Lease.class)</span>
                      ? ObjectInputFilter.Status.ALLOWED
                      : ObjectInputFilter.Status.REJECTED;
          }
          // Not a class, not size limited
          return ObjectInputFilter.Status.UNDECIDED;
<span class="line-new-header">--- 171,18 ---</span>
                  // Arrays of primitives are allowed
                  return ObjectInputFilter.Status.ALLOWED;
              }
              return (clazz == UID.class ||
                      clazz == VMID.class ||
<span class="line-modified">!                     clazz == Lease.class ||</span>
<span class="line-added">+                     (Throwable.class.isAssignableFrom(clazz) &amp;&amp;</span>
<span class="line-added">+                             (Object.class.getModule() == clazz.getModule() ||</span>
<span class="line-added">+                                     RemoteException.class.getModule() == clazz.getModule())) ||</span>
<span class="line-added">+                     clazz == StackTraceElement.class ||</span>
<span class="line-added">+                     clazz == ArrayList.class ||     // for suppressed exceptions, if any</span>
<span class="line-added">+                     clazz == Object.class ||</span>
<span class="line-added">+                     clazz.getName().equals(&quot;java.util.Collections$EmptyList&quot;))</span>
                      ? ObjectInputFilter.Status.ALLOWED
                      : ObjectInputFilter.Status.REJECTED;
          }
          // Not a class, not size limited
          return ObjectInputFilter.Status.UNDECIDED;
</pre>
<center><a href="DGCImpl_Skel.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="StreamRemoteCall.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>