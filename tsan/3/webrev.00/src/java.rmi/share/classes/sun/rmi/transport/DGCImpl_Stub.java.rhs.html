<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.rmi/share/classes/sun/rmi/transport/DGCImpl_Stub.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.rmi.transport;
 27 
<a name="2" id="anc2"></a><span class="line-added"> 28 import sun.rmi.transport.tcp.TCPConnection;</span>
<span class="line-added"> 29 </span>
<span class="line-added"> 30 import java.io.IOException;</span>
 31 import java.io.ObjectInputFilter;
<a name="3" id="anc3"></a><span class="line-modified"> 32 import java.rmi.RemoteException;</span>
 33 import java.rmi.dgc.Lease;
 34 import java.rmi.dgc.VMID;
 35 import java.rmi.server.UID;
 36 import java.security.AccessController;
 37 import java.security.PrivilegedAction;
<a name="4" id="anc4"></a><span class="line-modified"> 38 import java.util.ArrayList;</span>


 39 
 40 /**
 41  * Stubs to invoke DGC remote methods.
 42  * Originally generated from RMIC but frozen to insert serialFilter.
 43  */
 44 @SuppressWarnings({&quot;deprecation&quot;, &quot;serial&quot;})
 45 public final class DGCImpl_Stub
 46         extends java.rmi.server.RemoteStub
 47         implements java.rmi.dgc.DGC {
 48     private static final java.rmi.server.Operation[] operations = {
 49             new java.rmi.server.Operation(&quot;void clean(java.rmi.server.ObjID[], long, java.rmi.dgc.VMID, boolean)&quot;),
 50             new java.rmi.server.Operation(&quot;java.rmi.dgc.Lease dirty(java.rmi.server.ObjID[], long, java.rmi.dgc.Lease)&quot;)
 51     };
 52 
 53     private static final long interfaceHash = -669196253586618813L;
 54 
 55     /** Registry max depth of remote invocations. **/
 56     private static int DGCCLIENT_MAX_DEPTH = 6;
 57 
 58     /** Registry maximum array size in remote invocations. **/
 59     private static int DGCCLIENT_MAX_ARRAY_SIZE = 10000;
 60 
 61     // constructors
 62     public DGCImpl_Stub() {
 63         super();
 64     }
 65 
 66     public DGCImpl_Stub(java.rmi.server.RemoteRef ref) {
 67         super(ref);
 68     }
 69 
 70     // methods from remote interfaces
 71 
 72     // implementation of clean(ObjID[], long, VMID, boolean)
 73     public void clean(java.rmi.server.ObjID[] $param_arrayOf_ObjID_1, long $param_long_2, java.rmi.dgc.VMID $param_VMID_3, boolean $param_boolean_4)
 74             throws java.rmi.RemoteException {
 75         try {
<a name="5" id="anc5"></a><span class="line-modified"> 76             StreamRemoteCall call = (StreamRemoteCall)ref.newCall((java.rmi.server.RemoteObject) this,</span>
<span class="line-added"> 77                     operations, 0, interfaceHash);</span>
<span class="line-added"> 78             call.setObjectInputFilter(DGCImpl_Stub::leaseFilter);</span>
 79             try {
 80                 java.io.ObjectOutput out = call.getOutputStream();
 81                 out.writeObject($param_arrayOf_ObjID_1);
 82                 out.writeLong($param_long_2);
 83                 out.writeObject($param_VMID_3);
 84                 out.writeBoolean($param_boolean_4);
 85             } catch (java.io.IOException e) {
 86                 throw new java.rmi.MarshalException(&quot;error marshalling arguments&quot;, e);
 87             }
 88             ref.invoke(call);
 89             ref.done(call);
 90         } catch (java.lang.RuntimeException e) {
 91             throw e;
 92         } catch (java.rmi.RemoteException e) {
 93             throw e;
 94         } catch (java.lang.Exception e) {
 95             throw new java.rmi.UnexpectedException(&quot;undeclared checked exception&quot;, e);
 96         }
 97     }
 98 
 99     // implementation of dirty(ObjID[], long, Lease)
100     public java.rmi.dgc.Lease dirty(java.rmi.server.ObjID[] $param_arrayOf_ObjID_1, long $param_long_2, java.rmi.dgc.Lease $param_Lease_3)
101             throws java.rmi.RemoteException {
102         try {
<a name="6" id="anc6"></a><span class="line-modified">103             StreamRemoteCall call =</span>
<span class="line-added">104                     (StreamRemoteCall)ref.newCall((java.rmi.server.RemoteObject) this,</span>
<span class="line-added">105                             operations, 1, interfaceHash);</span>
<span class="line-added">106             call.setObjectInputFilter(DGCImpl_Stub::leaseFilter);</span>
107             try {
108                 java.io.ObjectOutput out = call.getOutputStream();
109                 out.writeObject($param_arrayOf_ObjID_1);
110                 out.writeLong($param_long_2);
111                 out.writeObject($param_Lease_3);
112             } catch (java.io.IOException e) {
113                 throw new java.rmi.MarshalException(&quot;error marshalling arguments&quot;, e);
114             }
115             ref.invoke(call);
116             java.rmi.dgc.Lease $result;
<a name="7" id="anc7"></a><span class="line-modified">117             Connection connection = call.getConnection();</span>
118             try {
119                 java.io.ObjectInput in = call.getInputStream();
<a name="8" id="anc8"></a>










120                 $result = (java.rmi.dgc.Lease) in.readObject();
<a name="9" id="anc9"></a><span class="line-modified">121             } catch (ClassCastException | IOException | ClassNotFoundException e) {</span>
122                 if (connection instanceof TCPConnection) {
123                     // Modified to prevent re-use of the connection after an exception
124                     ((TCPConnection) connection).getChannel().free(connection, false);
125                 }
<a name="10" id="anc10"></a><span class="line-added">126                 call.discardPendingRefs();</span>
127                 throw new java.rmi.UnmarshalException(&quot;error unmarshalling return&quot;, e);
128             } finally {
129                 ref.done(call);
130             }
131             return $result;
132         } catch (java.lang.RuntimeException e) {
133             throw e;
134         } catch (java.rmi.RemoteException e) {
135             throw e;
136         } catch (java.lang.Exception e) {
137             throw new java.rmi.UnexpectedException(&quot;undeclared checked exception&quot;, e);
138         }
139     }
140 
141     /**
142      * ObjectInputFilter to filter DGCClient return value (a Lease).
143      * The list of acceptable classes is very short and explicit.
144      * The depth and array sizes are limited.
<a name="11" id="anc11"></a><span class="line-added">145      * &lt;p&gt;</span>
<span class="line-added">146      * The filter must accept normal and exception returns.</span>
<span class="line-added">147      * A DGC server may throw exceptions that may have a cause</span>
<span class="line-added">148      * and suppressed exceptions.</span>
<span class="line-added">149      * Only exceptions in {@code java.base} and {@code java.rmi} are allowed.</span>
150      *
151      * @param filterInfo access to class, arrayLength, etc.
152      * @return  {@link ObjectInputFilter.Status#ALLOWED} if allowed,
153      *          {@link ObjectInputFilter.Status#REJECTED} if rejected,
154      *          otherwise {@link ObjectInputFilter.Status#UNDECIDED}
155      */
156     private static ObjectInputFilter.Status leaseFilter(ObjectInputFilter.FilterInfo filterInfo) {
157 
158         if (filterInfo.depth() &gt; DGCCLIENT_MAX_DEPTH) {
159             return ObjectInputFilter.Status.REJECTED;
160         }
161         Class&lt;?&gt; clazz = filterInfo.serialClass();
162         if (clazz != null) {
163             while (clazz.isArray()) {
164                 if (filterInfo.arrayLength() &gt;= 0 &amp;&amp; filterInfo.arrayLength() &gt; DGCCLIENT_MAX_ARRAY_SIZE) {
165                     return ObjectInputFilter.Status.REJECTED;
166                 }
167                 // Arrays are allowed depending on the component type
168                 clazz = clazz.getComponentType();
169             }
170             if (clazz.isPrimitive()) {
171                 // Arrays of primitives are allowed
172                 return ObjectInputFilter.Status.ALLOWED;
173             }
174             return (clazz == UID.class ||
175                     clazz == VMID.class ||
<a name="12" id="anc12"></a><span class="line-modified">176                     clazz == Lease.class ||</span>
<span class="line-added">177                     (Throwable.class.isAssignableFrom(clazz) &amp;&amp;</span>
<span class="line-added">178                             (Object.class.getModule() == clazz.getModule() ||</span>
<span class="line-added">179                                     RemoteException.class.getModule() == clazz.getModule())) ||</span>
<span class="line-added">180                     clazz == StackTraceElement.class ||</span>
<span class="line-added">181                     clazz == ArrayList.class ||     // for suppressed exceptions, if any</span>
<span class="line-added">182                     clazz == Object.class ||</span>
<span class="line-added">183                     clazz.getName().equals(&quot;java.util.Collections$EmptyList&quot;))</span>
184                     ? ObjectInputFilter.Status.ALLOWED
185                     : ObjectInputFilter.Status.REJECTED;
186         }
187         // Not a class, not size limited
188         return ObjectInputFilter.Status.UNDECIDED;
189     }
190 
191 }
<a name="13" id="anc13"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="13" type="hidden" />
</body>
</html>