<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.hotspot.agent/windows/native/libsaproc/sawindbg.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../../solaris/native/libsaproc/saproc.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.httpserver/share/classes/com/sun/net/httpserver/BasicAuthenticator.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/windows/native/libsaproc/sawindbg.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 45,47 ***</span>
  
  #define DEBUG_NO_IMPLEMENTATION
  #include &lt;dbgeng.h&gt;
  #include &lt;dbghelp.h&gt;
  
<span class="line-modified">! // simple template to manage array delete across early (error) returns</span>
  
  template &lt;class T&gt;
  class AutoArrayPtr {
<span class="line-modified">!       T* m_ptr;</span>
<span class="line-modified">!    public:</span>
<span class="line-modified">!       AutoArrayPtr(T* ptr) : m_ptr(ptr) {</span>
<span class="line-modified">!       }</span>
<span class="line-modified">! </span>
<span class="line-modified">!       ~AutoArrayPtr() {</span>
<span class="line-modified">!          delete [] m_ptr;</span>
<span class="line-modified">!       }</span>
<span class="line-modified">! </span>
<span class="line-modified">!       T* asPtr() {</span>
<span class="line-modified">!          return m_ptr;</span>
<span class="line-modified">!       }</span>
  };
  
  class AutoJavaString {
<span class="line-modified">!       JNIEnv* m_env;</span>
<span class="line-modified">!       jstring m_str;</span>
<span class="line-modified">!       const char* m_buf;</span>
<span class="line-modified">! </span>
<span class="line-modified">!    public:</span>
<span class="line-modified">!       AutoJavaString(JNIEnv* env, jstring str, const char* buf)</span>
<span class="line-modified">!         : m_env(env), m_str(str), m_buf(buf) {</span>
<span class="line-modified">!       }</span>
<span class="line-modified">! </span>
<span class="line-modified">!       ~AutoJavaString() {</span>
<span class="line-modified">!          m_env-&gt;ReleaseStringUTFChars(m_str, m_buf);</span>
<span class="line-modified">!       }</span>
<span class="line-modified">! </span>
<span class="line-modified">!       operator const char* () {</span>
<span class="line-modified">!          return m_buf;</span>
<span class="line-modified">!       }</span>
  };
  
  // field and method IDs we want here
  
  static jfieldID imagePath_ID                    = 0;
  static jfieldID symbolPath_ID                   = 0;
  static jfieldID ptrIDebugClient_ID              = 0;
<span class="line-new-header">--- 45,105 ---</span>
  
  #define DEBUG_NO_IMPLEMENTATION
  #include &lt;dbgeng.h&gt;
  #include &lt;dbghelp.h&gt;
  
<span class="line-modified">! </span>
<span class="line-added">+ // Wrappers to simplify cleanup on errors.</span>
<span class="line-added">+ namespace {</span>
  
  template &lt;class T&gt;
  class AutoArrayPtr {
<span class="line-modified">!   T* m_ptr;</span>
<span class="line-modified">! public:</span>
<span class="line-modified">!   AutoArrayPtr(T* ptr) : m_ptr(ptr) {</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-modified">!   ~AutoArrayPtr() {</span>
<span class="line-modified">!     delete [] m_ptr;</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-modified">!   operator T* () const {</span>
<span class="line-modified">!     return m_ptr;</span>
<span class="line-modified">!   }</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ // Manage COM &#39;auto&#39; pointers to avoid multiple Release</span>
<span class="line-added">+ // calls at every early (exception) returns.</span>
<span class="line-added">+ </span>
<span class="line-added">+ template &lt;class T&gt;</span>
<span class="line-added">+ class AutoCOMPtr {</span>
<span class="line-added">+   T* m_ptr;</span>
<span class="line-added">+ </span>
<span class="line-added">+ public:</span>
<span class="line-added">+   AutoCOMPtr(T* ptr) : m_ptr(ptr) {</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   ~AutoCOMPtr() {</span>
<span class="line-added">+     if (m_ptr) {</span>
<span class="line-added">+       m_ptr-&gt;Release();</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   T* operator-&gt;() const {</span>
<span class="line-added">+     return m_ptr;</span>
<span class="line-added">+   }</span>
  };
  
  class AutoJavaString {
<span class="line-modified">!   JNIEnv* m_env;</span>
<span class="line-modified">!   jstring m_str;</span>
<span class="line-modified">!   const char* m_buf;</span>
<span class="line-modified">! </span>
<span class="line-modified">! public:</span>
<span class="line-modified">!   // check env-&gt;ExceptionOccurred() after ctor</span>
<span class="line-modified">!   AutoJavaString(JNIEnv* env, jstring str)</span>
<span class="line-modified">!     : m_env(env), m_str(str), m_buf(env-&gt;GetStringUTFChars(str, nullptr)) {</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-modified">!   ~AutoJavaString() {</span>
<span class="line-modified">!     if (m_buf) {</span>
<span class="line-modified">!       m_env-&gt;ReleaseStringUTFChars(m_str, m_buf);</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-added">+   operator const char* () const {</span>
<span class="line-added">+     return m_buf;</span>
<span class="line-added">+   }</span>
  };
  
<span class="line-added">+ class AutoJavaByteArray {</span>
<span class="line-added">+   JNIEnv* env;</span>
<span class="line-added">+   jbyteArray byteArray;</span>
<span class="line-added">+   jbyte* bytePtr;</span>
<span class="line-added">+   jint releaseMode;</span>
<span class="line-added">+ </span>
<span class="line-added">+ public:</span>
<span class="line-added">+   // check env-&gt;ExceptionOccurred() after ctor</span>
<span class="line-added">+   AutoJavaByteArray(JNIEnv* env, jbyteArray byteArray, jint releaseMode = JNI_ABORT)</span>
<span class="line-added">+     : env(env), byteArray(byteArray), releaseMode(releaseMode),</span>
<span class="line-added">+       bytePtr(env-&gt;GetByteArrayElements(byteArray, nullptr)) {</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   ~AutoJavaByteArray() {</span>
<span class="line-added">+     if (bytePtr) {</span>
<span class="line-added">+       env-&gt;ReleaseByteArrayElements(byteArray, bytePtr, releaseMode);</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   void setReleaseMode(jint mode) {</span>
<span class="line-added">+     releaseMode = mode;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   operator jbyte* () const {</span>
<span class="line-added">+     return bytePtr;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ };</span>
<span class="line-added">+ </span>
<span class="line-added">+ } // unnamed namespace</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
  // field and method IDs we want here
  
  static jfieldID imagePath_ID                    = 0;
  static jfieldID symbolPath_ID                   = 0;
  static jfieldID ptrIDebugClient_ID              = 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 99,32 ***</span>
  static jmethodID addLoadObject_ID               = 0;
  static jmethodID addThread_ID                   = 0;
  static jmethodID createClosestSymbol_ID         = 0;
  static jmethodID setThreadIntegerRegisterSet_ID = 0;
  
<span class="line-modified">! #define CHECK_EXCEPTION_(value) if(env-&gt;ExceptionOccurred()) { return value; }</span>
<span class="line-modified">! #define CHECK_EXCEPTION if(env-&gt;ExceptionOccurred()) { return;}</span>
  
  #define THROW_NEW_DEBUGGER_EXCEPTION_(str, value) { \
                            throwNewDebuggerException(env, str); return value; }
  
<span class="line-modified">! #define THROW_NEW_DEBUGGER_EXCEPTION(str) { throwNewDebuggerException(env, str); \</span>
<span class="line-modified">!  return;}</span>
  
  static void throwNewDebuggerException(JNIEnv* env, const char* errMsg) {
    jclass clazz = env-&gt;FindClass(&quot;sun/jvm/hotspot/debugger/DebuggerException&quot;);
    CHECK_EXCEPTION;
    env-&gt;ThrowNew(clazz, errMsg);
  }
  
  /*
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    initIDs
   * Signature: ()V
   */
  JNIEXPORT void JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_initIDs
<span class="line-modified">!   (JNIEnv *env, jclass clazz) {</span>
    imagePath_ID = env-&gt;GetStaticFieldID(clazz, &quot;imagePath&quot;, &quot;Ljava/lang/String;&quot;);
    CHECK_EXCEPTION;
  
    symbolPath_ID = env-&gt;GetStaticFieldID(clazz, &quot;symbolPath&quot;, &quot;Ljava/lang/String;&quot;);
    CHECK_EXCEPTION;
<span class="line-new-header">--- 157,48 ---</span>
  static jmethodID addLoadObject_ID               = 0;
  static jmethodID addThread_ID                   = 0;
  static jmethodID createClosestSymbol_ID         = 0;
  static jmethodID setThreadIntegerRegisterSet_ID = 0;
  
<span class="line-modified">! #define CHECK_EXCEPTION_(value) if (env-&gt;ExceptionOccurred()) { return value; }</span>
<span class="line-modified">! #define CHECK_EXCEPTION if (env-&gt;ExceptionOccurred()) { return; }</span>
  
  #define THROW_NEW_DEBUGGER_EXCEPTION_(str, value) { \
                            throwNewDebuggerException(env, str); return value; }
  
<span class="line-modified">! #define THROW_NEW_DEBUGGER_EXCEPTION(str) { \</span>
<span class="line-modified">!                           throwNewDebuggerException(env, str); return; }</span>
  
  static void throwNewDebuggerException(JNIEnv* env, const char* errMsg) {
    jclass clazz = env-&gt;FindClass(&quot;sun/jvm/hotspot/debugger/DebuggerException&quot;);
    CHECK_EXCEPTION;
    env-&gt;ThrowNew(clazz, errMsg);
  }
  
<span class="line-added">+ // Verifies COM call result is S_OK, throws DebuggerException and exits otherwise.</span>
<span class="line-added">+ // Note: other success results (like S_FALSE) are considered errors.</span>
<span class="line-added">+ #define COM_VERIFY_OK_(v, str, retValue) \</span>
<span class="line-added">+   do { \</span>
<span class="line-added">+     const HRESULT hr = (v); \</span>
<span class="line-added">+     if (hr != S_OK) { \</span>
<span class="line-added">+       AutoArrayPtr&lt;char&gt; errmsg(new char[strlen(str) + 32]); \</span>
<span class="line-added">+       if (errmsg == nullptr) { \</span>
<span class="line-added">+         THROW_NEW_DEBUGGER_EXCEPTION_(str, retValue); \</span>
<span class="line-added">+       } else { \</span>
<span class="line-added">+         sprintf(errmsg, &quot;%s (hr: 0x%08X)&quot;, str, hr); \</span>
<span class="line-added">+         THROW_NEW_DEBUGGER_EXCEPTION_(errmsg, retValue); \</span>
<span class="line-added">+       } \</span>
<span class="line-added">+     } \</span>
<span class="line-added">+   } while (false)</span>
<span class="line-added">+ </span>
  /*
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    initIDs
   * Signature: ()V
   */
  JNIEXPORT void JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_initIDs
<span class="line-modified">!       (JNIEnv *env, jclass clazz) {</span>
    imagePath_ID = env-&gt;GetStaticFieldID(clazz, &quot;imagePath&quot;, &quot;Ljava/lang/String;&quot;);
    CHECK_EXCEPTION;
  
    symbolPath_ID = env-&gt;GetStaticFieldID(clazz, &quot;symbolPath&quot;, &quot;Ljava/lang/String;&quot;);
    CHECK_EXCEPTION;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 136,248 ***</span>
    CHECK_EXCEPTION;
  
    ptrIDebugDataSpaces_ID = env-&gt;GetFieldID(clazz, &quot;ptrIDebugDataSpaces&quot;, &quot;J&quot;);
    CHECK_EXCEPTION;
  
<span class="line-modified">!   ptrIDebugOutputCallbacks_ID = env-&gt;GetFieldID(clazz,</span>
<span class="line-removed">-                                             &quot;ptrIDebugOutputCallbacks&quot;, &quot;J&quot;);</span>
    CHECK_EXCEPTION;
  
    ptrIDebugAdvanced_ID = env-&gt;GetFieldID(clazz, &quot;ptrIDebugAdvanced&quot;, &quot;J&quot;);
    CHECK_EXCEPTION;
  
<span class="line-modified">!   ptrIDebugSymbols_ID = env-&gt;GetFieldID(clazz,</span>
<span class="line-removed">-                                          &quot;ptrIDebugSymbols&quot;, &quot;J&quot;);</span>
    CHECK_EXCEPTION;
  
<span class="line-modified">!   ptrIDebugSystemObjects_ID = env-&gt;GetFieldID(clazz,</span>
<span class="line-removed">-                                          &quot;ptrIDebugSystemObjects&quot;, &quot;J&quot;);</span>
    CHECK_EXCEPTION;
  
<span class="line-modified">!   addLoadObject_ID = env-&gt;GetMethodID(clazz, &quot;addLoadObject&quot;,</span>
<span class="line-removed">-                                          &quot;(Ljava/lang/String;JJ)V&quot;);</span>
    CHECK_EXCEPTION;
  
    addThread_ID = env-&gt;GetMethodID(clazz, &quot;addThread&quot;, &quot;(J)V&quot;);
    CHECK_EXCEPTION;
  
    createClosestSymbol_ID = env-&gt;GetMethodID(clazz, &quot;createClosestSymbol&quot;,
<span class="line-modified">!     &quot;(Ljava/lang/String;J)Lsun/jvm/hotspot/debugger/cdbg/ClosestSymbol;&quot;);</span>
    CHECK_EXCEPTION;
  
    setThreadIntegerRegisterSet_ID = env-&gt;GetMethodID(clazz,
                                           &quot;setThreadIntegerRegisterSet&quot;, &quot;(J[J)V&quot;);
    CHECK_EXCEPTION;
<span class="line-removed">- </span>
  }
  
  // class for IDebugOutputCallbacks
  
  class SAOutputCallbacks : public IDebugOutputCallbacks {
<span class="line-modified">!    LONG  m_refCount;</span>
<span class="line-modified">!    char* m_msgBuffer;</span>
<span class="line-modified">! </span>
<span class="line-modified">!    public:</span>
<span class="line-modified">!       SAOutputCallbacks() : m_refCount(0), m_msgBuffer(0) {</span>
<span class="line-modified">!       }</span>
<span class="line-modified">! </span>
<span class="line-modified">!       ~SAOutputCallbacks() {</span>
<span class="line-modified">!          clearBuffer();</span>
<span class="line-modified">!       }</span>
<span class="line-modified">! </span>
<span class="line-modified">!       const char* getBuffer() const {</span>
<span class="line-modified">!          return m_msgBuffer;</span>
<span class="line-modified">!       }</span>
<span class="line-modified">! </span>
<span class="line-modified">!       void clearBuffer() {</span>
<span class="line-modified">!          if (m_msgBuffer) {</span>
<span class="line-modified">!             free(m_msgBuffer);</span>
<span class="line-modified">!             m_msgBuffer = 0;</span>
<span class="line-modified">!          }</span>
<span class="line-modified">!       }</span>
<span class="line-modified">! </span>
<span class="line-modified">!       STDMETHOD_(ULONG, AddRef)(THIS);</span>
<span class="line-modified">!       STDMETHOD_(ULONG, Release)(THIS);</span>
<span class="line-modified">!       STDMETHOD(QueryInterface)(THIS_</span>
<span class="line-modified">!                                 IN REFIID interfaceId,</span>
<span class="line-modified">!                                 OUT PVOID* ppInterface);</span>
<span class="line-modified">!       STDMETHOD(Output)(THIS_</span>
<span class="line-modified">!                         IN ULONG mask,</span>
<span class="line-modified">!                         IN PCSTR msg);</span>
  };
  
  STDMETHODIMP_(ULONG) SAOutputCallbacks::AddRef(THIS) {
<span class="line-modified">!    InterlockedIncrement(&amp;m_refCount);</span>
<span class="line-removed">-    return m_refCount;</span>
  }
  
  STDMETHODIMP_(ULONG) SAOutputCallbacks::Release(THIS) {
<span class="line-modified">!    LONG retVal;</span>
<span class="line-modified">!    InterlockedDecrement(&amp;m_refCount);</span>
<span class="line-modified">!    retVal = m_refCount;</span>
<span class="line-modified">!    if (retVal == 0) {</span>
<span class="line-modified">!       delete this;</span>
<span class="line-removed">-    }</span>
<span class="line-removed">-    return retVal;</span>
  }
  
  STDMETHODIMP SAOutputCallbacks::QueryInterface(THIS_
                                            IN REFIID interfaceId,
                                            OUT PVOID* ppInterface) {
<span class="line-modified">!    *ppInterface = 0;</span>
<span class="line-modified">!    HRESULT res = E_NOINTERFACE;</span>
<span class="line-modified">!    if (TRUE == IsEqualIID(interfaceId, __uuidof(IUnknown)) ||</span>
<span class="line-modified">!        TRUE == IsEqualIID(interfaceId, __uuidof(IDebugOutputCallbacks))) {</span>
<span class="line-modified">!       *ppInterface = (IDebugOutputCallbacks*) this;</span>
<span class="line-modified">!       AddRef();</span>
<span class="line-modified">!       res = S_OK;</span>
<span class="line-modified">!    }</span>
<span class="line-modified">!    return res;</span>
  }
  
  STDMETHODIMP SAOutputCallbacks::Output(THIS_
                                         IN ULONG mask,
                                         IN PCSTR msg) {
<span class="line-modified">!    int len = (int) (strlen(msg) + 1);</span>
<span class="line-modified">!    if (m_msgBuffer == 0) {</span>
<span class="line-modified">!       m_msgBuffer = (char*) malloc(len);</span>
<span class="line-modified">!       if (m_msgBuffer == 0) {</span>
<span class="line-modified">!          fprintf(stderr, &quot;out of memory debugger output!\n&quot;);</span>
<span class="line-modified">!          return S_FALSE;</span>
<span class="line-modified">!       }</span>
<span class="line-modified">!       strcpy(m_msgBuffer, msg);</span>
<span class="line-modified">!    } else {</span>
<span class="line-modified">!       m_msgBuffer = (char*) realloc(m_msgBuffer, len + strlen(m_msgBuffer));</span>
<span class="line-modified">!       if (m_msgBuffer == 0) {</span>
<span class="line-modified">!          fprintf(stderr, &quot;out of memory debugger output!\n&quot;);</span>
<span class="line-modified">!          return S_FALSE;</span>
<span class="line-modified">!       }</span>
<span class="line-modified">!       strcat(m_msgBuffer, msg);</span>
<span class="line-modified">!    }</span>
<span class="line-modified">!    return S_OK;</span>
  }
  
  static bool getWindbgInterfaces(JNIEnv* env, jobject obj) {
    // get windbg interfaces ..
  
    IDebugClient* ptrIDebugClient = 0;
<span class="line-modified">!   if (DebugCreate(__uuidof(IDebugClient), (PVOID*) &amp;ptrIDebugClient) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to create IDebugClient object!&quot;, false);</span>
<span class="line-removed">-   }</span>
    env-&gt;SetLongField(obj, ptrIDebugClient_ID, (jlong) ptrIDebugClient);
  
    IDebugControl* ptrIDebugControl = 0;
<span class="line-modified">!   if (ptrIDebugClient-&gt;QueryInterface(__uuidof(IDebugControl), (PVOID*) &amp;ptrIDebugControl)</span>
<span class="line-modified">!      != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to get IDebugControl&quot;, false);</span>
<span class="line-removed">-   }</span>
    env-&gt;SetLongField(obj, ptrIDebugControl_ID, (jlong) ptrIDebugControl);
  
    IDebugDataSpaces* ptrIDebugDataSpaces = 0;
<span class="line-modified">!   if (ptrIDebugClient-&gt;QueryInterface(__uuidof(IDebugDataSpaces), (PVOID*) &amp;ptrIDebugDataSpaces)</span>
<span class="line-modified">!      != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to get IDebugDataSpaces object!&quot;, false);</span>
<span class="line-removed">-   }</span>
    env-&gt;SetLongField(obj, ptrIDebugDataSpaces_ID, (jlong) ptrIDebugDataSpaces);
  
    SAOutputCallbacks* ptrIDebugOutputCallbacks = new SAOutputCallbacks();
<span class="line-removed">-   ptrIDebugOutputCallbacks-&gt;AddRef();</span>
    env-&gt;SetLongField(obj, ptrIDebugOutputCallbacks_ID, (jlong) ptrIDebugOutputCallbacks);
    CHECK_EXCEPTION_(false);
  
    IDebugAdvanced* ptrIDebugAdvanced = 0;
<span class="line-modified">!   if (ptrIDebugClient-&gt;QueryInterface(__uuidof(IDebugAdvanced), (PVOID*) &amp;ptrIDebugAdvanced)</span>
<span class="line-modified">!      != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to get IDebugAdvanced object!&quot;, false);</span>
<span class="line-removed">-   }</span>
    env-&gt;SetLongField(obj, ptrIDebugAdvanced_ID, (jlong) ptrIDebugAdvanced);
  
    IDebugSymbols* ptrIDebugSymbols = 0;
<span class="line-modified">!   if (ptrIDebugClient-&gt;QueryInterface(__uuidof(IDebugSymbols), (PVOID*) &amp;ptrIDebugSymbols)</span>
<span class="line-modified">!      != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to get IDebugSymbols object!&quot;, false);</span>
<span class="line-removed">-   }</span>
    env-&gt;SetLongField(obj, ptrIDebugSymbols_ID, (jlong) ptrIDebugSymbols);
  
    IDebugSystemObjects* ptrIDebugSystemObjects = 0;
<span class="line-modified">!   if (ptrIDebugClient-&gt;QueryInterface(__uuidof(IDebugSystemObjects), (PVOID*) &amp;ptrIDebugSystemObjects)</span>
<span class="line-modified">!      != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to get IDebugSystemObjects object!&quot;, false);</span>
<span class="line-removed">-   }</span>
    env-&gt;SetLongField(obj, ptrIDebugSystemObjects_ID, (jlong) ptrIDebugSystemObjects);
  
    return true;
  }
  
  static bool setImageAndSymbolPath(JNIEnv* env, jobject obj) {
<span class="line-removed">-   jboolean isCopy;</span>
    jclass clazz = env-&gt;GetObjectClass(obj);
    CHECK_EXCEPTION_(false);
    jstring path;
<span class="line-removed">-   const char* buf;</span>
  
    path = (jstring) env-&gt;GetStaticObjectField(clazz, imagePath_ID);
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   if (path == NULL) {</span>
       THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to get imagePath field ID!&quot;, false);
    }
<span class="line-modified">!   buf = env-&gt;GetStringUTFChars(path, &amp;isCopy);</span>
    CHECK_EXCEPTION_(false);
<span class="line-removed">-   AutoJavaString imagePath(env, path, buf);</span>
  
    path = (jstring) env-&gt;GetStaticObjectField(clazz, symbolPath_ID);
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   if (path == NULL) {</span>
       THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to get symbolPath field ID!&quot;, false);
    }
<span class="line-modified">!   buf = env-&gt;GetStringUTFChars(path, &amp;isCopy);</span>
    CHECK_EXCEPTION_(false);
<span class="line-removed">-   AutoJavaString symbolPath(env, path, buf);</span>
  
<span class="line-modified">!   IDebugSymbols* ptrIDebugSymbols = (IDebugSymbols*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                       ptrIDebugSymbols_ID);</span>
    CHECK_EXCEPTION_(false);
  
    ptrIDebugSymbols-&gt;SetImagePath(imagePath);
    ptrIDebugSymbols-&gt;SetSymbolPath(symbolPath);
    return true;
  }
  
  static bool openDumpFile(JNIEnv* env, jobject obj, jstring coreFileName) {
    // open the dump file
<span class="line-modified">!   jboolean isCopy;</span>
<span class="line-removed">-   const char* buf = env-&gt;GetStringUTFChars(coreFileName, &amp;isCopy);</span>
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   AutoJavaString coreFile(env, coreFileName, buf);</span>
<span class="line-removed">-   if (setImageAndSymbolPath(env, obj) == false) {</span>
       return false;
    }
  
<span class="line-modified">!   IDebugClient* ptrIDebugClient = (IDebugClient*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                       ptrIDebugClient_ID);</span>
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   if (ptrIDebugClient-&gt;OpenDumpFile(coreFile) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: OpenDumpFile failed!&quot;, false);</span>
<span class="line-removed">-   }</span>
  
<span class="line-modified">!   IDebugControl* ptrIDebugControl = (IDebugControl*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                      ptrIDebugControl_ID);</span>
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   if (ptrIDebugControl-&gt;WaitForEvent(DEBUG_WAIT_DEFAULT, INFINITE) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: WaitForEvent failed!&quot;, false);</span>
<span class="line-removed">-   }</span>
  
    return true;
  }
  
  
  static bool attachToProcess(JNIEnv* env, jobject obj, jint pid) {
<span class="line-modified">!   if (setImageAndSymbolPath(env, obj) == false) {</span>
       return false;
    }
<span class="line-modified">!   IDebugClient* ptrIDebugClient = (IDebugClient*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                       ptrIDebugClient_ID);</span>
    CHECK_EXCEPTION_(false);
  
    /***********************************************************************************
  
       We are attaching to a process in &#39;read-only&#39; mode. i.e., we do not want to
<span class="line-new-header">--- 210,221 ---</span>
    CHECK_EXCEPTION;
  
    ptrIDebugDataSpaces_ID = env-&gt;GetFieldID(clazz, &quot;ptrIDebugDataSpaces&quot;, &quot;J&quot;);
    CHECK_EXCEPTION;
  
<span class="line-modified">!   ptrIDebugOutputCallbacks_ID = env-&gt;GetFieldID(clazz, &quot;ptrIDebugOutputCallbacks&quot;, &quot;J&quot;);</span>
    CHECK_EXCEPTION;
  
    ptrIDebugAdvanced_ID = env-&gt;GetFieldID(clazz, &quot;ptrIDebugAdvanced&quot;, &quot;J&quot;);
    CHECK_EXCEPTION;
  
<span class="line-modified">!   ptrIDebugSymbols_ID = env-&gt;GetFieldID(clazz, &quot;ptrIDebugSymbols&quot;, &quot;J&quot;);</span>
    CHECK_EXCEPTION;
  
<span class="line-modified">!   ptrIDebugSystemObjects_ID = env-&gt;GetFieldID(clazz, &quot;ptrIDebugSystemObjects&quot;, &quot;J&quot;);</span>
    CHECK_EXCEPTION;
  
<span class="line-modified">!   addLoadObject_ID = env-&gt;GetMethodID(clazz, &quot;addLoadObject&quot;, &quot;(Ljava/lang/String;JJ)V&quot;);</span>
    CHECK_EXCEPTION;
  
    addThread_ID = env-&gt;GetMethodID(clazz, &quot;addThread&quot;, &quot;(J)V&quot;);
    CHECK_EXCEPTION;
  
    createClosestSymbol_ID = env-&gt;GetMethodID(clazz, &quot;createClosestSymbol&quot;,
<span class="line-modified">!                             &quot;(Ljava/lang/String;J)Lsun/jvm/hotspot/debugger/cdbg/ClosestSymbol;&quot;);</span>
    CHECK_EXCEPTION;
  
    setThreadIntegerRegisterSet_ID = env-&gt;GetMethodID(clazz,
                                           &quot;setThreadIntegerRegisterSet&quot;, &quot;(J[J)V&quot;);
    CHECK_EXCEPTION;
  }
  
  // class for IDebugOutputCallbacks
  
  class SAOutputCallbacks : public IDebugOutputCallbacks {
<span class="line-modified">!   LONG  m_refCount;</span>
<span class="line-modified">!   char* m_msgBuffer;</span>
<span class="line-modified">! </span>
<span class="line-modified">! public:</span>
<span class="line-modified">!   SAOutputCallbacks() : m_refCount(1), m_msgBuffer(nullptr) {</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-modified">!   ~SAOutputCallbacks() {</span>
<span class="line-modified">!     clearBuffer();</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-modified">!   const char* getBuffer() const {</span>
<span class="line-modified">!     return m_msgBuffer;</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-modified">!   void clearBuffer() {</span>
<span class="line-modified">!     if (m_msgBuffer) {</span>
<span class="line-modified">!       free(m_msgBuffer);</span>
<span class="line-modified">!       m_msgBuffer = 0;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-modified">!   STDMETHOD_(ULONG, AddRef)(THIS);</span>
<span class="line-modified">!   STDMETHOD_(ULONG, Release)(THIS);</span>
<span class="line-modified">!   STDMETHOD(QueryInterface)(THIS_</span>
<span class="line-modified">!                             IN REFIID interfaceId,</span>
<span class="line-modified">!                             OUT PVOID* ppInterface);</span>
<span class="line-modified">!   STDMETHOD(Output)(THIS_</span>
<span class="line-modified">!                     IN ULONG mask,</span>
<span class="line-modified">!                     IN PCSTR msg);</span>
  };
  
  STDMETHODIMP_(ULONG) SAOutputCallbacks::AddRef(THIS) {
<span class="line-modified">!   return InterlockedIncrement(&amp;m_refCount);</span>
  }
  
  STDMETHODIMP_(ULONG) SAOutputCallbacks::Release(THIS) {
<span class="line-modified">!   LONG retVal = InterlockedDecrement(&amp;m_refCount);</span>
<span class="line-modified">!   if (retVal == 0) {</span>
<span class="line-modified">!     delete this;</span>
<span class="line-modified">!   }</span>
<span class="line-modified">!   return retVal;</span>
  }
  
  STDMETHODIMP SAOutputCallbacks::QueryInterface(THIS_
                                            IN REFIID interfaceId,
                                            OUT PVOID* ppInterface) {
<span class="line-modified">!   *ppInterface = nullptr;</span>
<span class="line-modified">!   if (IsEqualIID(interfaceId, __uuidof(IUnknown)) ||</span>
<span class="line-modified">!       IsEqualIID(interfaceId, __uuidof(IDebugOutputCallbacks))) {</span>
<span class="line-modified">!     *ppInterface = static_cast&lt;IDebugOutputCallbacks*&gt;(this);</span>
<span class="line-modified">!   } else {</span>
<span class="line-modified">!     return E_NOINTERFACE;</span>
<span class="line-modified">!   }</span>
<span class="line-modified">!   AddRef();</span>
<span class="line-modified">!   return S_OK;</span>
  }
  
  STDMETHODIMP SAOutputCallbacks::Output(THIS_
                                         IN ULONG mask,
                                         IN PCSTR msg) {
<span class="line-modified">!   size_t len = strlen(msg) + 1;</span>
<span class="line-modified">!   if (m_msgBuffer == 0) {</span>
<span class="line-modified">!     m_msgBuffer = (char*) malloc(len);</span>
<span class="line-modified">!     if (m_msgBuffer == 0) {</span>
<span class="line-modified">!       fprintf(stderr, &quot;out of memory debugger output!\n&quot;);</span>
<span class="line-modified">!       return S_FALSE;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     strcpy(m_msgBuffer, msg);</span>
<span class="line-modified">!   } else {</span>
<span class="line-modified">!     m_msgBuffer = (char*) realloc(m_msgBuffer, len + strlen(m_msgBuffer));</span>
<span class="line-modified">!     if (m_msgBuffer == 0) {</span>
<span class="line-modified">!       fprintf(stderr, &quot;out of memory debugger output!\n&quot;);</span>
<span class="line-modified">!       return S_FALSE;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     strcat(m_msgBuffer, msg);</span>
<span class="line-modified">!   }</span>
<span class="line-modified">!   return S_OK;</span>
  }
  
  static bool getWindbgInterfaces(JNIEnv* env, jobject obj) {
    // get windbg interfaces ..
  
    IDebugClient* ptrIDebugClient = 0;
<span class="line-modified">!   COM_VERIFY_OK_(DebugCreate(__uuidof(IDebugClient), (PVOID*) &amp;ptrIDebugClient),</span>
<span class="line-modified">!                  &quot;Windbg Error: not able to create IDebugClient object!&quot;, false);</span>
    env-&gt;SetLongField(obj, ptrIDebugClient_ID, (jlong) ptrIDebugClient);
  
    IDebugControl* ptrIDebugControl = 0;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugClient-&gt;QueryInterface(</span>
<span class="line-modified">!                     __uuidof(IDebugControl), (PVOID*) &amp;ptrIDebugControl),</span>
<span class="line-modified">!                  &quot;Windbg Error: not able to get IDebugControl&quot;, false);</span>
    env-&gt;SetLongField(obj, ptrIDebugControl_ID, (jlong) ptrIDebugControl);
  
    IDebugDataSpaces* ptrIDebugDataSpaces = 0;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugClient-&gt;QueryInterface(</span>
<span class="line-modified">!                     __uuidof(IDebugDataSpaces), (PVOID*) &amp;ptrIDebugDataSpaces),</span>
<span class="line-modified">!                  &quot;Windbg Error: not able to get IDebugDataSpaces object!&quot;, false);</span>
    env-&gt;SetLongField(obj, ptrIDebugDataSpaces_ID, (jlong) ptrIDebugDataSpaces);
  
    SAOutputCallbacks* ptrIDebugOutputCallbacks = new SAOutputCallbacks();
    env-&gt;SetLongField(obj, ptrIDebugOutputCallbacks_ID, (jlong) ptrIDebugOutputCallbacks);
    CHECK_EXCEPTION_(false);
  
    IDebugAdvanced* ptrIDebugAdvanced = 0;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugClient-&gt;QueryInterface(</span>
<span class="line-modified">!                     __uuidof(IDebugAdvanced), (PVOID*) &amp;ptrIDebugAdvanced),</span>
<span class="line-modified">!                  &quot;Windbg Error: not able to get IDebugAdvanced object!&quot;, false);</span>
    env-&gt;SetLongField(obj, ptrIDebugAdvanced_ID, (jlong) ptrIDebugAdvanced);
  
    IDebugSymbols* ptrIDebugSymbols = 0;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugClient-&gt;QueryInterface(</span>
<span class="line-modified">!                     __uuidof(IDebugSymbols), (PVOID*) &amp;ptrIDebugSymbols),</span>
<span class="line-modified">!                  &quot;Windbg Error: not able to get IDebugSymbols object!&quot;, false);</span>
    env-&gt;SetLongField(obj, ptrIDebugSymbols_ID, (jlong) ptrIDebugSymbols);
  
    IDebugSystemObjects* ptrIDebugSystemObjects = 0;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugClient-&gt;QueryInterface(</span>
<span class="line-modified">!                     __uuidof(IDebugSystemObjects), (PVOID*) &amp;ptrIDebugSystemObjects),</span>
<span class="line-modified">!                  &quot;Windbg Error: not able to get IDebugSystemObjects object!&quot;, false);</span>
    env-&gt;SetLongField(obj, ptrIDebugSystemObjects_ID, (jlong) ptrIDebugSystemObjects);
  
    return true;
  }
  
  static bool setImageAndSymbolPath(JNIEnv* env, jobject obj) {
    jclass clazz = env-&gt;GetObjectClass(obj);
    CHECK_EXCEPTION_(false);
    jstring path;
  
    path = (jstring) env-&gt;GetStaticObjectField(clazz, imagePath_ID);
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   if (path == nullptr) {</span>
       THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to get imagePath field ID!&quot;, false);
    }
<span class="line-modified">!   AutoJavaString imagePath(env, path);</span>
    CHECK_EXCEPTION_(false);
  
    path = (jstring) env-&gt;GetStaticObjectField(clazz, symbolPath_ID);
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   if (path == nullptr) {</span>
       THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: not able to get symbolPath field ID!&quot;, false);
    }
<span class="line-modified">!   AutoJavaString symbolPath(env, path);</span>
    CHECK_EXCEPTION_(false);
  
<span class="line-modified">!   IDebugSymbols* ptrIDebugSymbols = (IDebugSymbols*)env-&gt;GetLongField(obj, ptrIDebugSymbols_ID);</span>
    CHECK_EXCEPTION_(false);
  
    ptrIDebugSymbols-&gt;SetImagePath(imagePath);
    ptrIDebugSymbols-&gt;SetSymbolPath(symbolPath);
    return true;
  }
  
  static bool openDumpFile(JNIEnv* env, jobject obj, jstring coreFileName) {
    // open the dump file
<span class="line-modified">!   AutoJavaString coreFile(env, coreFileName);</span>
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   if (!setImageAndSymbolPath(env, obj)) {</span>
       return false;
    }
  
<span class="line-modified">!   IDebugClient* ptrIDebugClient = (IDebugClient*)env-&gt;GetLongField(obj, ptrIDebugClient_ID);</span>
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugClient-&gt;OpenDumpFile(coreFile),</span>
<span class="line-modified">!                  &quot;Windbg Error: OpenDumpFile failed!&quot;, false);</span>
  
<span class="line-modified">!   IDebugControl* ptrIDebugControl = (IDebugControl*)env-&gt;GetLongField(obj, ptrIDebugControl_ID);</span>
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugControl-&gt;WaitForEvent(DEBUG_WAIT_DEFAULT, INFINITE),</span>
<span class="line-modified">!                  &quot;Windbg Error: WaitForEvent failed!&quot;, false);</span>
  
    return true;
  }
  
  
  static bool attachToProcess(JNIEnv* env, jobject obj, jint pid) {
<span class="line-modified">!   if (!setImageAndSymbolPath(env, obj)) {</span>
       return false;
    }
<span class="line-modified">!   IDebugClient* ptrIDebugClient = (IDebugClient*)env-&gt;GetLongField(obj, ptrIDebugClient_ID);</span>
    CHECK_EXCEPTION_(false);
  
    /***********************************************************************************
  
       We are attaching to a process in &#39;read-only&#39; mode. i.e., we do not want to
</pre>
<hr />
<pre>
<span class="line-old-header">*** 393,57 ***</span>
       not need a tool like ServiceInstaller from http://www.kcmultimedia.com/smaster.
  
    ***********************************************************************************/
  
  
<span class="line-modified">!   if (ptrIDebugClient-&gt;AttachProcess(0, pid, DEBUG_ATTACH_NONINVASIVE) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: AttachProcess failed!&quot;, false);</span>
<span class="line-removed">-   }</span>
  
    IDebugControl* ptrIDebugControl = (IDebugControl*) env-&gt;GetLongField(obj,
                                                       ptrIDebugControl_ID);
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   if (ptrIDebugControl-&gt;WaitForEvent(DEBUG_WAIT_DEFAULT, INFINITE) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: WaitForEvent failed!&quot;, false);</span>
<span class="line-removed">-   }</span>
  
    return true;
  }
  
  
  static bool addLoadObjects(JNIEnv* env, jobject obj) {
    IDebugSymbols* ptrIDebugSymbols = (IDebugSymbols*) env-&gt;GetLongField(obj,
                                                        ptrIDebugSymbols_ID);
    CHECK_EXCEPTION_(false);
    ULONG loaded = 0, unloaded = 0;
<span class="line-modified">!   if (ptrIDebugSymbols-&gt;GetNumberModules(&amp;loaded, &amp;unloaded) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: GetNumberModules failed!&quot;, false);</span>
<span class="line-removed">-   }</span>
  
    AutoArrayPtr&lt;DEBUG_MODULE_PARAMETERS&gt; params(new DEBUG_MODULE_PARAMETERS[loaded]);
  
<span class="line-modified">!   if (params.asPtr() == 0) {</span>
        THROW_NEW_DEBUGGER_EXCEPTION_(&quot;out of memory to allocate debug module params!&quot;, false);
    }
  
<span class="line-modified">!   if (ptrIDebugSymbols-&gt;GetModuleParameters(loaded, 0, NULL, params.asPtr()) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: GetModuleParameters failed!&quot;, false);</span>
<span class="line-removed">-   }</span>
  
    for (int u = 0; u &lt; (int)loaded; u++) {
<span class="line-modified">!      TCHAR imageName[MAX_PATH];</span>
<span class="line-modified">!      if (ptrIDebugSymbols-&gt;GetModuleNames(DEBUG_ANY_ID, params.asPtr()[u].Base,</span>
<span class="line-modified">!                                       imageName, MAX_PATH, NULL, NULL,</span>
<span class="line-modified">!                                       0, NULL, NULL, 0, NULL) != S_OK) {</span>
<span class="line-modified">!         THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: GetModuleNames failed!&quot;, false);</span>
<span class="line-removed">-      }</span>
  
<span class="line-modified">!      jstring strName = env-&gt;NewStringUTF(imageName);</span>
<span class="line-modified">!      CHECK_EXCEPTION_(false);</span>
<span class="line-modified">!      env-&gt;CallVoidMethod(obj, addLoadObject_ID, strName, (jlong) params.asPtr()[u].Size,</span>
<span class="line-modified">!                                (jlong) params.asPtr()[u].Base);</span>
<span class="line-modified">!      CHECK_EXCEPTION_(false);</span>
    }
  
    return true;
  }
  
<span class="line-new-header">--- 440,52 ---</span>
       not need a tool like ServiceInstaller from http://www.kcmultimedia.com/smaster.
  
    ***********************************************************************************/
  
  
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugClient-&gt;AttachProcess(0, pid, DEBUG_ATTACH_NONINVASIVE),</span>
<span class="line-modified">!                  &quot;Windbg Error: AttachProcess failed!&quot;, false);</span>
  
    IDebugControl* ptrIDebugControl = (IDebugControl*) env-&gt;GetLongField(obj,
                                                       ptrIDebugControl_ID);
    CHECK_EXCEPTION_(false);
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugControl-&gt;WaitForEvent(DEBUG_WAIT_DEFAULT, INFINITE),</span>
<span class="line-modified">!                  &quot;Windbg Error: WaitForEvent failed!&quot;, false);</span>
  
    return true;
  }
  
  
  static bool addLoadObjects(JNIEnv* env, jobject obj) {
    IDebugSymbols* ptrIDebugSymbols = (IDebugSymbols*) env-&gt;GetLongField(obj,
                                                        ptrIDebugSymbols_ID);
    CHECK_EXCEPTION_(false);
    ULONG loaded = 0, unloaded = 0;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugSymbols-&gt;GetNumberModules(&amp;loaded, &amp;unloaded),</span>
<span class="line-modified">!                  &quot;Windbg Error: GetNumberModules failed!&quot;, false);</span>
  
    AutoArrayPtr&lt;DEBUG_MODULE_PARAMETERS&gt; params(new DEBUG_MODULE_PARAMETERS[loaded]);
  
<span class="line-modified">!   if (params == nullptr) {</span>
        THROW_NEW_DEBUGGER_EXCEPTION_(&quot;out of memory to allocate debug module params!&quot;, false);
    }
  
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugSymbols-&gt;GetModuleParameters(loaded, nullptr, 0, params),</span>
<span class="line-modified">!                  &quot;Windbg Error: GetModuleParameters failed!&quot;, false);</span>
  
    for (int u = 0; u &lt; (int)loaded; u++) {
<span class="line-modified">!     TCHAR imageName[MAX_PATH];</span>
<span class="line-modified">!     COM_VERIFY_OK_(ptrIDebugSymbols-&gt;GetModuleNames(DEBUG_ANY_ID, params[u].Base,</span>
<span class="line-modified">!                                                     imageName, MAX_PATH, nullptr, nullptr,</span>
<span class="line-modified">!                                                     0, nullptr, nullptr, 0, nullptr),</span>
<span class="line-modified">!                    &quot;Windbg Error: GetModuleNames failed!&quot;, false);</span>
  
<span class="line-modified">!     jstring strName = env-&gt;NewStringUTF(imageName);</span>
<span class="line-modified">!     CHECK_EXCEPTION_(false);</span>
<span class="line-modified">!     env-&gt;CallVoidMethod(obj, addLoadObject_ID, strName, (jlong) params[u].Size,</span>
<span class="line-modified">!                         (jlong) params[u].Base);</span>
<span class="line-modified">!     CHECK_EXCEPTION_(false);</span>
    }
  
    return true;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 451,138 ***</span>
    IDebugSystemObjects* ptrIDebugSystemObjects = (IDebugSystemObjects*) env-&gt;GetLongField(obj,
                                                        ptrIDebugSystemObjects_ID);
    CHECK_EXCEPTION_(false);
  
    ULONG numThreads = 0;
<span class="line-modified">!   if (ptrIDebugSystemObjects-&gt;GetNumberThreads(&amp;numThreads) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: GetNumberThreads failed!&quot;, false);</span>
<span class="line-removed">-   }</span>
  
<span class="line-modified">!   AutoArrayPtr&lt;ULONG&gt; ptrSysThreadIds = new ULONG[numThreads];</span>
  
<span class="line-modified">!   if (ptrSysThreadIds.asPtr() == 0) {</span>
       THROW_NEW_DEBUGGER_EXCEPTION_(&quot;out of memory to allocate thread ids!&quot;, false);
    }
  
<span class="line-modified">!   AutoArrayPtr&lt;ULONG&gt; ptrThreadIds = new ULONG[numThreads];</span>
  
<span class="line-modified">!   if (ptrThreadIds.asPtr() == 0) {</span>
       THROW_NEW_DEBUGGER_EXCEPTION_(&quot;out of memory to allocate thread ids!&quot;, false);
    }
  
<span class="line-modified">!   if (ptrIDebugSystemObjects-&gt;GetThreadIdsByIndex(0, numThreads,</span>
<span class="line-modified">!                                       ptrThreadIds.asPtr(), ptrSysThreadIds.asPtr()) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: GetThreadIdsByIndex failed!&quot;, false);</span>
<span class="line-removed">-   }</span>
  
  
    IDebugAdvanced* ptrIDebugAdvanced = (IDebugAdvanced*) env-&gt;GetLongField(obj,
                                                        ptrIDebugAdvanced_ID);
    CHECK_EXCEPTION_(false);
  
    // for each thread, get register context and save it.
    for (ULONG t = 0; t &lt; numThreads; t++) {
<span class="line-modified">!      if (ptrIDebugSystemObjects-&gt;SetCurrentThreadId(ptrThreadIds.asPtr()[t]) != S_OK) {</span>
<span class="line-modified">!         THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: SetCurrentThread failed!&quot;, false);</span>
<span class="line-removed">-      }</span>
  
<span class="line-modified">!      jlongArray regs = env-&gt;NewLongArray(NPRGREG);</span>
<span class="line-modified">!      CHECK_EXCEPTION_(false);</span>
  
<span class="line-modified">!      jboolean isCopy = JNI_FALSE;</span>
<span class="line-modified">!      jlong* ptrRegs = env-&gt;GetLongArrayElements(regs, &amp;isCopy);</span>
<span class="line-removed">-      CHECK_EXCEPTION_(false);</span>
  
<span class="line-modified">!      // copy register values from the CONTEXT struct</span>
<span class="line-modified">!      CONTEXT context;</span>
<span class="line-modified">!      memset(&amp;context, 0, sizeof(CONTEXT));</span>
  
  #undef REG_INDEX
  #ifdef _M_IX86
<span class="line-modified">!      #define REG_INDEX(x) sun_jvm_hotspot_debugger_x86_X86ThreadContext_##x</span>
<span class="line-modified">! </span>
<span class="line-modified">!      context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span>
<span class="line-modified">!      ptrIDebugAdvanced-&gt;GetThreadContext(&amp;context, sizeof(CONTEXT));</span>
<span class="line-modified">! </span>
<span class="line-modified">!      ptrRegs[REG_INDEX(GS)]  = context.SegGs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(FS)]  = context.SegFs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(ES)]  = context.SegEs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(DS)]  = context.SegDs;</span>
<span class="line-modified">! </span>
<span class="line-modified">!      ptrRegs[REG_INDEX(EDI)] = context.Edi;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(ESI)] = context.Esi;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(EBX)] = context.Ebx;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(EDX)] = context.Edx;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(ECX)] = context.Ecx;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(EAX)] = context.Eax;</span>
<span class="line-modified">! </span>
<span class="line-modified">!      ptrRegs[REG_INDEX(FP)] = context.Ebp;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(PC)] = context.Eip;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(CS)]  = context.SegCs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(EFL)] = context.EFlags;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(SP)] = context.Esp;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(SS)]  = context.SegSs;</span>
<span class="line-modified">! </span>
<span class="line-modified">!      ptrRegs[REG_INDEX(DR0)] = context.Dr0;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(DR1)] = context.Dr1;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(DR2)] = context.Dr2;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(DR3)] = context.Dr3;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(DR6)] = context.Dr6;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(DR7)] = context.Dr7;</span>
  
  #elif _M_AMD64
<span class="line-modified">!      #define REG_INDEX(x) sun_jvm_hotspot_debugger_amd64_AMD64ThreadContext_##x</span>
<span class="line-modified">! </span>
<span class="line-modified">!      context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span>
<span class="line-modified">!      ptrIDebugAdvanced-&gt;GetThreadContext(&amp;context, sizeof(CONTEXT));</span>
<span class="line-modified">! </span>
<span class="line-modified">!      // Segment Registers and processor flags</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(CS)]  = context.SegCs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(DS)]  = context.SegDs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(ES)]  = context.SegEs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(FS)]  = context.SegFs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(GS)]  = context.SegGs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(SS)]  = context.SegSs;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RFL)] = context.EFlags;</span>
<span class="line-modified">! </span>
<span class="line-modified">!      // Integer registers</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RDI)] = context.Rdi;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RSI)] = context.Rsi;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RAX)] = context.Rax;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RCX)] = context.Rcx;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RDX)] = context.Rdx;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RBX)] = context.Rbx;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RBP)] = context.Rbp;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RSP)] = context.Rsp;</span>
<span class="line-modified">! </span>
<span class="line-modified">!      ptrRegs[REG_INDEX(R8)]  = context.R8;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(R9)]  = context.R9;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(R10)] = context.R10;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(R11)] = context.R11;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(R12)] = context.R12;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(R13)] = context.R13;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(R14)] = context.R14;</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(R15)] = context.R15;</span>
<span class="line-modified">! </span>
<span class="line-modified">!      // Program counter</span>
<span class="line-modified">!      ptrRegs[REG_INDEX(RIP)] = context.Rip;</span>
  #endif
  
<span class="line-modified">!      env-&gt;ReleaseLongArrayElements(regs, ptrRegs, JNI_COMMIT);</span>
<span class="line-modified">!      CHECK_EXCEPTION_(false);</span>
  
<span class="line-modified">!      env-&gt;CallVoidMethod(obj, setThreadIntegerRegisterSet_ID,</span>
<span class="line-modified">!                         (jlong) ptrThreadIds.asPtr()[t], regs);</span>
<span class="line-removed">-      CHECK_EXCEPTION_(false);</span>
  
<span class="line-modified">!      ULONG sysId;</span>
<span class="line-modified">!      if (ptrIDebugSystemObjects-&gt;GetCurrentThreadSystemId(&amp;sysId) != S_OK) {</span>
<span class="line-modified">!         THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: GetCurrentThreadSystemId failed!&quot;, false);</span>
<span class="line-removed">-      }</span>
  
<span class="line-modified">!      env-&gt;CallVoidMethod(obj, addThread_ID, (jlong) sysId);</span>
<span class="line-modified">!      CHECK_EXCEPTION_(false);</span>
    }
  
    return true;
  }
  
<span class="line-new-header">--- 493,132 ---</span>
    IDebugSystemObjects* ptrIDebugSystemObjects = (IDebugSystemObjects*) env-&gt;GetLongField(obj,
                                                        ptrIDebugSystemObjects_ID);
    CHECK_EXCEPTION_(false);
  
    ULONG numThreads = 0;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugSystemObjects-&gt;GetNumberThreads(&amp;numThreads),</span>
<span class="line-modified">!                  &quot;Windbg Error: GetNumberThreads failed!&quot;, false);</span>
  
<span class="line-modified">!   AutoArrayPtr&lt;ULONG&gt; ptrSysThreadIds(new ULONG[numThreads]);</span>
  
<span class="line-modified">!   if (ptrSysThreadIds == nullptr) {</span>
       THROW_NEW_DEBUGGER_EXCEPTION_(&quot;out of memory to allocate thread ids!&quot;, false);
    }
  
<span class="line-modified">!   AutoArrayPtr&lt;ULONG&gt; ptrThreadIds(new ULONG[numThreads]);</span>
  
<span class="line-modified">!   if (ptrThreadIds == nullptr) {</span>
       THROW_NEW_DEBUGGER_EXCEPTION_(&quot;out of memory to allocate thread ids!&quot;, false);
    }
  
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugSystemObjects-&gt;GetThreadIdsByIndex(0, numThreads,</span>
<span class="line-modified">!                                       ptrThreadIds, ptrSysThreadIds),</span>
<span class="line-modified">!                  &quot;Windbg Error: GetThreadIdsByIndex failed!&quot;, false);</span>
  
  
    IDebugAdvanced* ptrIDebugAdvanced = (IDebugAdvanced*) env-&gt;GetLongField(obj,
                                                        ptrIDebugAdvanced_ID);
    CHECK_EXCEPTION_(false);
  
    // for each thread, get register context and save it.
    for (ULONG t = 0; t &lt; numThreads; t++) {
<span class="line-modified">!     COM_VERIFY_OK_(ptrIDebugSystemObjects-&gt;SetCurrentThreadId(ptrThreadIds[t]),</span>
<span class="line-modified">!                    &quot;Windbg Error: SetCurrentThread failed!&quot;, false);</span>
  
<span class="line-modified">!     jlongArray regs = env-&gt;NewLongArray(NPRGREG);</span>
<span class="line-modified">!     CHECK_EXCEPTION_(false);</span>
  
<span class="line-modified">!     jlong* ptrRegs = env-&gt;GetLongArrayElements(regs, nullptr);</span>
<span class="line-modified">!     CHECK_EXCEPTION_(false);</span>
  
<span class="line-modified">!     // copy register values from the CONTEXT struct</span>
<span class="line-modified">!     CONTEXT context;</span>
<span class="line-modified">!     memset(&amp;context, 0, sizeof(CONTEXT));</span>
  
  #undef REG_INDEX
  #ifdef _M_IX86
<span class="line-modified">!     #define REG_INDEX(x) sun_jvm_hotspot_debugger_x86_X86ThreadContext_##x</span>
<span class="line-modified">! </span>
<span class="line-modified">!     context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span>
<span class="line-modified">!     ptrIDebugAdvanced-&gt;GetThreadContext(&amp;context, sizeof(CONTEXT));</span>
<span class="line-modified">! </span>
<span class="line-modified">!     ptrRegs[REG_INDEX(GS)]  = context.SegGs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(FS)]  = context.SegFs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(ES)]  = context.SegEs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(DS)]  = context.SegDs;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     ptrRegs[REG_INDEX(EDI)] = context.Edi;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(ESI)] = context.Esi;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(EBX)] = context.Ebx;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(EDX)] = context.Edx;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(ECX)] = context.Ecx;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(EAX)] = context.Eax;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     ptrRegs[REG_INDEX(FP)] = context.Ebp;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(PC)] = context.Eip;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(CS)]  = context.SegCs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(EFL)] = context.EFlags;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(SP)] = context.Esp;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(SS)]  = context.SegSs;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     ptrRegs[REG_INDEX(DR0)] = context.Dr0;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(DR1)] = context.Dr1;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(DR2)] = context.Dr2;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(DR3)] = context.Dr3;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(DR6)] = context.Dr6;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(DR7)] = context.Dr7;</span>
  
  #elif _M_AMD64
<span class="line-modified">!     #define REG_INDEX(x) sun_jvm_hotspot_debugger_amd64_AMD64ThreadContext_##x</span>
<span class="line-modified">! </span>
<span class="line-modified">!     context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS;</span>
<span class="line-modified">!     ptrIDebugAdvanced-&gt;GetThreadContext(&amp;context, sizeof(CONTEXT));</span>
<span class="line-modified">! </span>
<span class="line-modified">!     // Segment Registers and processor flags</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(CS)]  = context.SegCs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(DS)]  = context.SegDs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(ES)]  = context.SegEs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(FS)]  = context.SegFs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(GS)]  = context.SegGs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(SS)]  = context.SegSs;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RFL)] = context.EFlags;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     // Integer registers</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RDI)] = context.Rdi;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RSI)] = context.Rsi;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RAX)] = context.Rax;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RCX)] = context.Rcx;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RDX)] = context.Rdx;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RBX)] = context.Rbx;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RBP)] = context.Rbp;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RSP)] = context.Rsp;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     ptrRegs[REG_INDEX(R8)]  = context.R8;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(R9)]  = context.R9;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(R10)] = context.R10;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(R11)] = context.R11;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(R12)] = context.R12;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(R13)] = context.R13;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(R14)] = context.R14;</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(R15)] = context.R15;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     // Program counter</span>
<span class="line-modified">!     ptrRegs[REG_INDEX(RIP)] = context.Rip;</span>
  #endif
  
<span class="line-modified">!     env-&gt;ReleaseLongArrayElements(regs, ptrRegs, JNI_COMMIT);</span>
<span class="line-modified">!     CHECK_EXCEPTION_(false);</span>
  
<span class="line-modified">!     env-&gt;CallVoidMethod(obj, setThreadIntegerRegisterSet_ID, (jlong)ptrThreadIds[t], regs);</span>
<span class="line-modified">!     CHECK_EXCEPTION_(false);</span>
  
<span class="line-modified">!     ULONG sysId;</span>
<span class="line-modified">!     COM_VERIFY_OK_(ptrIDebugSystemObjects-&gt;GetCurrentThreadSystemId(&amp;sysId),</span>
<span class="line-modified">!                    &quot;Windbg Error: GetCurrentThreadSystemId failed!&quot;, false);</span>
  
<span class="line-modified">!     env-&gt;CallVoidMethod(obj, addThread_ID, (jlong) sysId);</span>
<span class="line-modified">!     CHECK_EXCEPTION_(false);</span>
    }
  
    return true;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 592,23 ***</span>
   * Signature: (Ljava/lang/String;Ljava/lang/String;)V
   */
  JNIEXPORT void JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_attach0__Ljava_lang_String_2Ljava_lang_String_2
    (JNIEnv *env, jobject obj, jstring execName, jstring coreFileName) {
  
<span class="line-modified">!   if (getWindbgInterfaces(env, obj) == false) {</span>
       return;
    }
  
<span class="line-modified">!   if (openDumpFile(env, obj, coreFileName) == false) {</span>
       return;
    }
  
<span class="line-modified">!   if (addLoadObjects(env, obj) == false) {</span>
       return;
    }
  
<span class="line-modified">!   if (addThreads(env, obj) == false) {</span>
       return;
    }
  }
  
  /*
<span class="line-new-header">--- 628,23 ---</span>
   * Signature: (Ljava/lang/String;Ljava/lang/String;)V
   */
  JNIEXPORT void JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_attach0__Ljava_lang_String_2Ljava_lang_String_2
    (JNIEnv *env, jobject obj, jstring execName, jstring coreFileName) {
  
<span class="line-modified">!   if (!getWindbgInterfaces(env, obj)) {</span>
       return;
    }
  
<span class="line-modified">!   if (!openDumpFile(env, obj, coreFileName)) {</span>
       return;
    }
  
<span class="line-modified">!   if (!addLoadObjects(env, obj)) {</span>
       return;
    }
  
<span class="line-modified">!   if (!addThreads(env, obj)) {</span>
       return;
    }
  }
  
  /*
</pre>
<hr />
<pre>
<span class="line-old-header">*** 617,91 ***</span>
   * Signature: (I)V
   */
  JNIEXPORT void JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_attach0__I
    (JNIEnv *env, jobject obj, jint pid) {
  
<span class="line-modified">!   if (getWindbgInterfaces(env, obj) == false) {</span>
       return;
    }
  
<span class="line-modified">!   if (attachToProcess(env, obj, pid) == false) {</span>
       return;
    }
  
<span class="line-modified">!   if (addLoadObjects(env, obj) == false) {</span>
       return;
    }
  
<span class="line-modified">!   if (addThreads(env, obj) == false) {</span>
       return;
    }
  }
  
  
<span class="line-modified">! static bool releaseWindbgInterfaces(JNIEnv* env, jobject obj) {</span>
<span class="line-modified">!   IDebugDataSpaces* ptrIDebugDataSpaces = (IDebugDataSpaces*) env-&gt;GetLongField(obj,</span>
<span class="line-modified">!                                                       ptrIDebugDataSpaces_ID);</span>
<span class="line-modified">!   CHECK_EXCEPTION_(false);</span>
<span class="line-modified">!   if (ptrIDebugDataSpaces != 0) {</span>
<span class="line-modified">!      ptrIDebugDataSpaces-&gt;Release();</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-removed">-   IDebugOutputCallbacks* ptrIDebugOutputCallbacks = (IDebugOutputCallbacks*)</span>
<span class="line-removed">-                           env-&gt;GetLongField(obj, ptrIDebugOutputCallbacks_ID);</span>
<span class="line-removed">-   CHECK_EXCEPTION_(false);</span>
<span class="line-removed">-   if (ptrIDebugOutputCallbacks != 0) {</span>
<span class="line-removed">-      ptrIDebugOutputCallbacks-&gt;Release();</span>
<span class="line-removed">-   }</span>
  
<span class="line-modified">!   IDebugAdvanced* ptrIDebugAdvanced = (IDebugAdvanced*) env-&gt;GetLongField(obj,</span>
<span class="line-modified">!                                                       ptrIDebugAdvanced_ID);</span>
<span class="line-modified">!   CHECK_EXCEPTION_(false);</span>
<span class="line-modified">! </span>
<span class="line-modified">!   if (ptrIDebugAdvanced != 0) {</span>
<span class="line-modified">!      ptrIDebugAdvanced-&gt;Release();</span>
<span class="line-modified">!   }</span>
<span class="line-modified">! </span>
<span class="line-removed">-   IDebugSymbols* ptrIDebugSymbols = (IDebugSymbols*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                       ptrIDebugSymbols_ID);</span>
<span class="line-removed">-   CHECK_EXCEPTION_(false);</span>
<span class="line-removed">-   if (ptrIDebugSymbols != 0) {</span>
<span class="line-removed">-      ptrIDebugSymbols-&gt;Release();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   IDebugSystemObjects* ptrIDebugSystemObjects = (IDebugSystemObjects*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                       ptrIDebugSystemObjects_ID);</span>
<span class="line-removed">-   CHECK_EXCEPTION_(false);</span>
<span class="line-removed">-   if (ptrIDebugSystemObjects != 0) {</span>
<span class="line-removed">-      ptrIDebugSystemObjects-&gt;Release();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   IDebugControl* ptrIDebugControl = (IDebugControl*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                      ptrIDebugControl_ID);</span>
<span class="line-removed">-   CHECK_EXCEPTION_(false);</span>
<span class="line-removed">-   if (ptrIDebugControl != 0) {</span>
<span class="line-removed">-      ptrIDebugControl-&gt;Release();</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   IDebugClient* ptrIDebugClient = (IDebugClient*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                       ptrIDebugClient_ID);</span>
<span class="line-removed">-   CHECK_EXCEPTION_(false);</span>
<span class="line-removed">-   if (ptrIDebugClient != 0) {</span>
<span class="line-removed">-      ptrIDebugClient-&gt;Release();</span>
<span class="line-removed">-   }</span>
  
    return true;
  }
  
  /*
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    detach0
   * Signature: ()V
   */
  JNIEXPORT void JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_detach0
<span class="line-modified">!   (JNIEnv *env, jobject obj) {</span>
<span class="line-modified">!   IDebugClient* ptrIDebugClient = (IDebugClient*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                       ptrIDebugClient_ID);</span>
    CHECK_EXCEPTION;
    ptrIDebugClient-&gt;DetachProcesses();
    releaseWindbgInterfaces(env, obj);
  }
  
<span class="line-new-header">--- 653,57 ---</span>
   * Signature: (I)V
   */
  JNIEXPORT void JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_attach0__I
    (JNIEnv *env, jobject obj, jint pid) {
  
<span class="line-modified">!   if (!getWindbgInterfaces(env, obj)) {</span>
       return;
    }
  
<span class="line-modified">!   if (!attachToProcess(env, obj, pid)) {</span>
       return;
    }
  
<span class="line-modified">!   if (!addLoadObjects(env, obj)) {</span>
       return;
    }
  
<span class="line-modified">!   if (!addThreads(env, obj)) {</span>
       return;
    }
  }
  
  
<span class="line-modified">! #define RELEASE(fieldID) \</span>
<span class="line-modified">!   do { \</span>
<span class="line-modified">!     IUnknown* ptr = (IUnknown*)env-&gt;GetLongField(obj, fieldID); \</span>
<span class="line-modified">!     CHECK_EXCEPTION_(false); \</span>
<span class="line-modified">!     if (ptr) { \</span>
<span class="line-modified">!       ptr-&gt;Release(); \</span>
<span class="line-modified">!     } \</span>
<span class="line-modified">!   } while (false)</span>
  
<span class="line-modified">! static bool releaseWindbgInterfaces(JNIEnv* env, jobject obj) {</span>
<span class="line-modified">!   RELEASE(ptrIDebugDataSpaces_ID);</span>
<span class="line-modified">!   RELEASE(ptrIDebugOutputCallbacks_ID);</span>
<span class="line-modified">!   RELEASE(ptrIDebugAdvanced_ID);</span>
<span class="line-modified">!   RELEASE(ptrIDebugSymbols_ID);</span>
<span class="line-modified">!   RELEASE(ptrIDebugSystemObjects_ID);</span>
<span class="line-modified">!   RELEASE(ptrIDebugControl_ID);</span>
<span class="line-modified">!   RELEASE(ptrIDebugClient_ID);</span>
  
    return true;
  }
  
  /*
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    detach0
   * Signature: ()V
   */
  JNIEXPORT void JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_detach0
<span class="line-modified">!     (JNIEnv *env, jobject obj) {</span>
<span class="line-modified">!   IDebugClient* ptrIDebugClient = (IDebugClient*) env-&gt;GetLongField(obj, ptrIDebugClient_ID);</span>
    CHECK_EXCEPTION;
    ptrIDebugClient-&gt;DetachProcesses();
    releaseWindbgInterfaces(env, obj);
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 710,121 ***</span>
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    readBytesFromProcess0
   * Signature: (JJ)[B
   */
  JNIEXPORT jbyteArray JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_readBytesFromProcess0
<span class="line-modified">!   (JNIEnv *env, jobject obj, jlong address, jlong numBytes) {</span>
<span class="line-modified">!   jbyteArray byteArray = env-&gt;NewByteArray((long) numBytes);</span>
    CHECK_EXCEPTION_(0);
  
<span class="line-modified">!   jboolean isCopy = JNI_FALSE;</span>
<span class="line-removed">-   jbyte* bytePtr = env-&gt;GetByteArrayElements(byteArray, &amp;isCopy);</span>
    CHECK_EXCEPTION_(0);
  
    IDebugDataSpaces* ptrIDebugDataSpaces = (IDebugDataSpaces*) env-&gt;GetLongField(obj,
                                                         ptrIDebugDataSpaces_ID);
<span class="line-modified">!   if (env-&gt;ExceptionOccurred()) {</span>
<span class="line-removed">-      env-&gt;ReleaseByteArrayElements(byteArray, bytePtr, JNI_ABORT);</span>
<span class="line-removed">-      return 0;</span>
<span class="line-removed">-   }</span>
  
    ULONG bytesRead;
<span class="line-modified">!   if (ptrIDebugDataSpaces-&gt;ReadVirtual((ULONG64) address, (PVOID) bytePtr,</span>
<span class="line-modified">!                                   (ULONG)numBytes, &amp;bytesRead) != S_OK) {</span>
<span class="line-modified">!      env-&gt;ReleaseByteArrayElements(byteArray, bytePtr, JNI_ABORT);</span>
<span class="line-removed">-      throwNewDebuggerException(env, &quot;Windbg Error: ReadVirtual failed!&quot;);</span>
<span class="line-removed">-      return 0;</span>
<span class="line-removed">-   }</span>
  
    if (bytesRead != numBytes) {
<span class="line-removed">-      env-&gt;ReleaseByteArrayElements(byteArray, bytePtr, JNI_ABORT);</span>
       return 0;
    }
<span class="line-removed">-   env-&gt;ReleaseByteArrayElements(byteArray, bytePtr, 0);</span>
  
<span class="line-modified">!   CHECK_EXCEPTION_(0);</span>
  
    return byteArray;
  }
  
  /*
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    getThreadIdFromSysId0
   * Signature: (J)J
   */
  JNIEXPORT jlong JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_getThreadIdFromSysId0
<span class="line-modified">!   (JNIEnv *env, jobject obj, jlong sysId) {</span>
    IDebugSystemObjects* ptrIDebugSystemObjects = (IDebugSystemObjects*) env-&gt;GetLongField(obj,
                                                      ptrIDebugSystemObjects_ID);
    CHECK_EXCEPTION_(0);
  
    ULONG id = 0;
<span class="line-modified">!   if (ptrIDebugSystemObjects-&gt;GetThreadIdBySystemId((ULONG)sysId, &amp;id) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: GetThreadIdBySystemId failed!&quot;, 0);</span>
<span class="line-removed">-   }</span>
  
    return (jlong) id;
  }
  
<span class="line-removed">- // manage COM &#39;auto&#39; pointers (to avoid multiple Release</span>
<span class="line-removed">- // calls at every early (exception) returns). Similar to AutoArrayPtr.</span>
<span class="line-removed">- </span>
<span class="line-removed">- template &lt;class T&gt;</span>
<span class="line-removed">- class AutoCOMPtr {</span>
<span class="line-removed">-       T* m_ptr;</span>
<span class="line-removed">- </span>
<span class="line-removed">-    public:</span>
<span class="line-removed">-       AutoCOMPtr(T* ptr) : m_ptr(ptr) {</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       ~AutoCOMPtr() {</span>
<span class="line-removed">-          if (m_ptr) {</span>
<span class="line-removed">-             m_ptr-&gt;Release();</span>
<span class="line-removed">-          }</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       T* operator-&gt;() {</span>
<span class="line-removed">-          return m_ptr;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- };</span>
<span class="line-removed">- </span>
  /*
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    consoleExecuteCommand0
   * Signature: (Ljava/lang/String;)Ljava/lang/String;
   */
  JNIEXPORT jstring JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_consoleExecuteCommand0
<span class="line-modified">!   (JNIEnv *env, jobject obj, jstring cmd) {</span>
<span class="line-modified">!   jboolean isCopy = JNI_FALSE;</span>
<span class="line-removed">-   const char* buf = env-&gt;GetStringUTFChars(cmd, &amp;isCopy);</span>
    CHECK_EXCEPTION_(0);
<span class="line-removed">-   AutoJavaString command(env, cmd, buf);</span>
  
    IDebugClient* ptrIDebugClient = (IDebugClient*) env-&gt;GetLongField(obj, ptrIDebugClient_ID);
    CHECK_EXCEPTION_(0);
  
    IDebugClient*  tmpClientPtr = 0;
<span class="line-modified">!   if (ptrIDebugClient-&gt;CreateClient(&amp;tmpClientPtr) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: CreateClient failed!&quot;, 0);</span>
<span class="line-removed">-   }</span>
    AutoCOMPtr&lt;IDebugClient&gt; tmpClient(tmpClientPtr);
  
    IDebugControl* tmpControlPtr = 0;
<span class="line-modified">!   if (tmpClient-&gt;QueryInterface(__uuidof(IDebugControl), (PVOID*) &amp;tmpControlPtr) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: QueryInterface (IDebugControl) failed&quot;, 0);</span>
<span class="line-removed">-   }</span>
    AutoCOMPtr&lt;IDebugControl&gt; tmpControl(tmpControlPtr);
  
    SAOutputCallbacks* saOutputCallbacks = (SAOutputCallbacks*) env-&gt;GetLongField(obj,
                                                                     ptrIDebugOutputCallbacks_ID);
    CHECK_EXCEPTION_(0);
  
    saOutputCallbacks-&gt;clearBuffer();
  
<span class="line-modified">!   if (tmpClient-&gt;SetOutputCallbacks(saOutputCallbacks) != S_OK) {</span>
<span class="line-modified">!      THROW_NEW_DEBUGGER_EXCEPTION_(&quot;Windbg Error: SetOutputCallbacks failed!&quot;, 0);</span>
<span class="line-removed">-   }</span>
  
    tmpControl-&gt;Execute(DEBUG_OUTPUT_VERBOSE, command, DEBUG_EXECUTE_DEFAULT);
  
    const char* output = saOutputCallbacks-&gt;getBuffer();
    if (output == 0) {
<span class="line-new-header">--- 712,84 ---</span>
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    readBytesFromProcess0
   * Signature: (JJ)[B
   */
  JNIEXPORT jbyteArray JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_readBytesFromProcess0
<span class="line-modified">!     (JNIEnv *env, jobject obj, jlong address, jlong numBytes) {</span>
<span class="line-modified">!   jbyteArray byteArray = env-&gt;NewByteArray((jsize)numBytes);</span>
    CHECK_EXCEPTION_(0);
  
<span class="line-modified">!   AutoJavaByteArray arrayBytes(env, byteArray);</span>
    CHECK_EXCEPTION_(0);
  
    IDebugDataSpaces* ptrIDebugDataSpaces = (IDebugDataSpaces*) env-&gt;GetLongField(obj,
                                                         ptrIDebugDataSpaces_ID);
<span class="line-modified">!   CHECK_EXCEPTION_(0);</span>
  
    ULONG bytesRead;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugDataSpaces-&gt;ReadVirtual((ULONG64)address, arrayBytes,</span>
<span class="line-modified">!                                                   (ULONG)numBytes, &amp;bytesRead),</span>
<span class="line-modified">!                  &quot;Windbg Error: ReadVirtual failed!&quot;, 0);</span>
  
    if (bytesRead != numBytes) {
       return 0;
    }
  
<span class="line-modified">!   arrayBytes.setReleaseMode(0);</span>
  
    return byteArray;
  }
  
  /*
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    getThreadIdFromSysId0
   * Signature: (J)J
   */
  JNIEXPORT jlong JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_getThreadIdFromSysId0
<span class="line-modified">!     (JNIEnv *env, jobject obj, jlong sysId) {</span>
    IDebugSystemObjects* ptrIDebugSystemObjects = (IDebugSystemObjects*) env-&gt;GetLongField(obj,
                                                      ptrIDebugSystemObjects_ID);
    CHECK_EXCEPTION_(0);
  
    ULONG id = 0;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugSystemObjects-&gt;GetThreadIdBySystemId((ULONG)sysId, &amp;id),</span>
<span class="line-modified">!                  &quot;Windbg Error: GetThreadIdBySystemId failed!&quot;, 0);</span>
  
    return (jlong) id;
  }
  
  /*
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    consoleExecuteCommand0
   * Signature: (Ljava/lang/String;)Ljava/lang/String;
   */
  JNIEXPORT jstring JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_consoleExecuteCommand0
<span class="line-modified">!     (JNIEnv *env, jobject obj, jstring cmd) {</span>
<span class="line-modified">!   AutoJavaString command(env, cmd);</span>
    CHECK_EXCEPTION_(0);
  
    IDebugClient* ptrIDebugClient = (IDebugClient*) env-&gt;GetLongField(obj, ptrIDebugClient_ID);
    CHECK_EXCEPTION_(0);
  
    IDebugClient*  tmpClientPtr = 0;
<span class="line-modified">!   COM_VERIFY_OK_(ptrIDebugClient-&gt;CreateClient(&amp;tmpClientPtr),</span>
<span class="line-modified">!                  &quot;Windbg Error: CreateClient failed!&quot;, 0);</span>
    AutoCOMPtr&lt;IDebugClient&gt; tmpClient(tmpClientPtr);
  
    IDebugControl* tmpControlPtr = 0;
<span class="line-modified">!   COM_VERIFY_OK_(tmpClient-&gt;QueryInterface(__uuidof(IDebugControl), (PVOID*) &amp;tmpControlPtr),</span>
<span class="line-modified">!                  &quot;Windbg Error: QueryInterface (IDebugControl) failed&quot;, 0);</span>
    AutoCOMPtr&lt;IDebugControl&gt; tmpControl(tmpControlPtr);
  
    SAOutputCallbacks* saOutputCallbacks = (SAOutputCallbacks*) env-&gt;GetLongField(obj,
                                                                     ptrIDebugOutputCallbacks_ID);
    CHECK_EXCEPTION_(0);
  
    saOutputCallbacks-&gt;clearBuffer();
  
<span class="line-modified">!   COM_VERIFY_OK_(tmpClient-&gt;SetOutputCallbacks(saOutputCallbacks),</span>
<span class="line-modified">!                  &quot;Windbg Error: SetOutputCallbacks failed!&quot;, 0);</span>
  
    tmpControl-&gt;Execute(DEBUG_OUTPUT_VERBOSE, command, DEBUG_EXECUTE_DEFAULT);
  
    const char* output = saOutputCallbacks-&gt;getBuffer();
    if (output == 0) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 841,19 ***</span>
   * Method:    lookupByName0
   * Signature: (Ljava/lang/String;Ljava/lang/String;)J
   */
  
  JNIEXPORT jlong JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_lookupByName0
<span class="line-modified">! (JNIEnv *env, jobject obj, jstring objName, jstring sym) {</span>
<span class="line-modified">!   IDebugSymbols* ptrIDebugSymbols = (IDebugSymbols*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                       ptrIDebugSymbols_ID);</span>
    CHECK_EXCEPTION_(0);
  
<span class="line-modified">!   jboolean isCopy;</span>
<span class="line-removed">-   const char* buf = env-&gt;GetStringUTFChars(sym, &amp;isCopy);</span>
    CHECK_EXCEPTION_(0);
<span class="line-removed">-   AutoJavaString name(env, sym, buf);</span>
  
    ULONG64 offset = 0L;
    if (strstr(name, &quot;::&quot;) != 0) {
      ptrIDebugSymbols-&gt;AddSymbolOptions(SYMOPT_UNDNAME);
    } else {
<span class="line-new-header">--- 806,16 ---</span>
   * Method:    lookupByName0
   * Signature: (Ljava/lang/String;Ljava/lang/String;)J
   */
  
  JNIEXPORT jlong JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_lookupByName0
<span class="line-modified">!     (JNIEnv *env, jobject obj, jstring objName, jstring sym) {</span>
<span class="line-modified">!   IDebugSymbols* ptrIDebugSymbols = (IDebugSymbols*)env-&gt;GetLongField(obj, ptrIDebugSymbols_ID);</span>
    CHECK_EXCEPTION_(0);
  
<span class="line-modified">!   AutoJavaString name(env, sym);</span>
    CHECK_EXCEPTION_(0);
  
    ULONG64 offset = 0L;
    if (strstr(name, &quot;::&quot;) != 0) {
      ptrIDebugSymbols-&gt;AddSymbolOptions(SYMOPT_UNDNAME);
    } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 870,21 ***</span>
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    lookupByAddress0
   * Signature: (J)Lsun/jvm/hotspot/debugger/cdbg/ClosestSymbol;
   */
  JNIEXPORT jobject JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_lookupByAddress0
<span class="line-modified">! (JNIEnv *env, jobject obj, jlong address) {</span>
<span class="line-modified">!   IDebugSymbols* ptrIDebugSymbols = (IDebugSymbols*) env-&gt;GetLongField(obj,</span>
<span class="line-removed">-                                                       ptrIDebugSymbols_ID);</span>
    CHECK_EXCEPTION_(0);
  
    ULONG64 disp = 0L;
    char buf[SYMBOL_BUFSIZE];
    memset(buf, 0, sizeof(buf));
  
<span class="line-modified">!   if (ptrIDebugSymbols-&gt;GetNameByOffset(address, buf, sizeof(buf),0,&amp;disp)</span>
<span class="line-removed">-       != S_OK) {</span>
      return 0;
    }
  
    jstring sym = env-&gt;NewStringUTF(buf);
    CHECK_EXCEPTION_(0);
<span class="line-new-header">--- 832,19 ---</span>
   * Class:     sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal
   * Method:    lookupByAddress0
   * Signature: (J)Lsun/jvm/hotspot/debugger/cdbg/ClosestSymbol;
   */
  JNIEXPORT jobject JNICALL Java_sun_jvm_hotspot_debugger_windbg_WindbgDebuggerLocal_lookupByAddress0
<span class="line-modified">!     (JNIEnv *env, jobject obj, jlong address) {</span>
<span class="line-modified">!   IDebugSymbols* ptrIDebugSymbols = (IDebugSymbols*) env-&gt;GetLongField(obj, ptrIDebugSymbols_ID);</span>
    CHECK_EXCEPTION_(0);
  
    ULONG64 disp = 0L;
    char buf[SYMBOL_BUFSIZE];
    memset(buf, 0, sizeof(buf));
  
<span class="line-modified">!   if (ptrIDebugSymbols-&gt;GetNameByOffset(address, buf, sizeof(buf), 0, &amp;disp) != S_OK) {</span>
      return 0;
    }
  
    jstring sym = env-&gt;NewStringUTF(buf);
    CHECK_EXCEPTION_(0);
</pre>
<center><a href="../../../solaris/native/libsaproc/saproc.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../../jdk.httpserver/share/classes/com/sun/net/httpserver/BasicAuthenticator.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>