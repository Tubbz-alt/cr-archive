<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.hotspot.agent/linux/native/libsaproc/ps_core.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="proc_service.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="symtab.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/linux/native/libsaproc/ps_core.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -29,340 +29,18 @@</span>
  #include &lt;stdlib.h&gt;
  #include &lt;stddef.h&gt;
  #include &lt;elf.h&gt;
  #include &lt;link.h&gt;
  #include &quot;libproc_impl.h&quot;
<span class="udiff-line-added">+ #include &quot;ps_core_common.h&quot;</span>
  #include &quot;proc_service.h&quot;
  #include &quot;salibelf.h&quot;
<span class="udiff-line-removed">- #include &quot;cds.h&quot;</span>
  
  // This file has the libproc implementation to read core files.
  // For live processes, refer to ps_proc.c. Portions of this is adapted
  // /modelled after Solaris libproc.so (in particular Pcore.c)
  
<span class="udiff-line-removed">- //----------------------------------------------------------------------</span>
<span class="udiff-line-removed">- // ps_prochandle cleanup helper functions</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // close all file descriptors</span>
<span class="udiff-line-removed">- static void close_files(struct ps_prochandle* ph) {</span>
<span class="udiff-line-removed">-   lib_info* lib = NULL;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // close core file descriptor</span>
<span class="udiff-line-removed">-   if (ph-&gt;core-&gt;core_fd &gt;= 0)</span>
<span class="udiff-line-removed">-     close(ph-&gt;core-&gt;core_fd);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // close exec file descriptor</span>
<span class="udiff-line-removed">-   if (ph-&gt;core-&gt;exec_fd &gt;= 0)</span>
<span class="udiff-line-removed">-     close(ph-&gt;core-&gt;exec_fd);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // close interp file descriptor</span>
<span class="udiff-line-removed">-   if (ph-&gt;core-&gt;interp_fd &gt;= 0)</span>
<span class="udiff-line-removed">-     close(ph-&gt;core-&gt;interp_fd);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // close class share archive file</span>
<span class="udiff-line-removed">-   if (ph-&gt;core-&gt;classes_jsa_fd &gt;= 0)</span>
<span class="udiff-line-removed">-     close(ph-&gt;core-&gt;classes_jsa_fd);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // close all library file descriptors</span>
<span class="udiff-line-removed">-   lib = ph-&gt;libs;</span>
<span class="udiff-line-removed">-   while (lib) {</span>
<span class="udiff-line-removed">-     int fd = lib-&gt;fd;</span>
<span class="udiff-line-removed">-     if (fd &gt;= 0 &amp;&amp; fd != ph-&gt;core-&gt;exec_fd) {</span>
<span class="udiff-line-removed">-       close(fd);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     lib = lib-&gt;next;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // clean all map_info stuff</span>
<span class="udiff-line-removed">- static void destroy_map_info(struct ps_prochandle* ph) {</span>
<span class="udiff-line-removed">-   map_info* map = ph-&gt;core-&gt;maps;</span>
<span class="udiff-line-removed">-   while (map) {</span>
<span class="udiff-line-removed">-     map_info* next = map-&gt;next;</span>
<span class="udiff-line-removed">-     free(map);</span>
<span class="udiff-line-removed">-     map = next;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (ph-&gt;core-&gt;map_array) {</span>
<span class="udiff-line-removed">-     free(ph-&gt;core-&gt;map_array);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Part of the class sharing workaround</span>
<span class="udiff-line-removed">-   map = ph-&gt;core-&gt;class_share_maps;</span>
<span class="udiff-line-removed">-   while (map) {</span>
<span class="udiff-line-removed">-     map_info* next = map-&gt;next;</span>
<span class="udiff-line-removed">-     free(map);</span>
<span class="udiff-line-removed">-     map = next;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // ps_prochandle operations</span>
<span class="udiff-line-removed">- static void core_release(struct ps_prochandle* ph) {</span>
<span class="udiff-line-removed">-   if (ph-&gt;core) {</span>
<span class="udiff-line-removed">-     close_files(ph);</span>
<span class="udiff-line-removed">-     destroy_map_info(ph);</span>
<span class="udiff-line-removed">-     free(ph-&gt;core);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static map_info* allocate_init_map(int fd, off_t offset, uintptr_t vaddr, size_t memsz) {</span>
<span class="udiff-line-removed">-   map_info* map;</span>
<span class="udiff-line-removed">-   if ( (map = (map_info*) calloc(1, sizeof(map_info))) == NULL) {</span>
<span class="udiff-line-removed">-     print_debug(&quot;can&#39;t allocate memory for map_info\n&quot;);</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // initialize map</span>
<span class="udiff-line-removed">-   map-&gt;fd     = fd;</span>
<span class="udiff-line-removed">-   map-&gt;offset = offset;</span>
<span class="udiff-line-removed">-   map-&gt;vaddr  = vaddr;</span>
<span class="udiff-line-removed">-   map-&gt;memsz  = memsz;</span>
<span class="udiff-line-removed">-   return map;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // add map info with given fd, offset, vaddr and memsz</span>
<span class="udiff-line-removed">- static map_info* add_map_info(struct ps_prochandle* ph, int fd, off_t offset,</span>
<span class="udiff-line-removed">-                              uintptr_t vaddr, size_t memsz) {</span>
<span class="udiff-line-removed">-   map_info* map;</span>
<span class="udiff-line-removed">-   if ((map = allocate_init_map(fd, offset, vaddr, memsz)) == NULL) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // add this to map list</span>
<span class="udiff-line-removed">-   map-&gt;next  = ph-&gt;core-&gt;maps;</span>
<span class="udiff-line-removed">-   ph-&gt;core-&gt;maps   = map;</span>
<span class="udiff-line-removed">-   ph-&gt;core-&gt;num_maps++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   return map;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // Part of the class sharing workaround</span>
<span class="udiff-line-removed">- static map_info* add_class_share_map_info(struct ps_prochandle* ph, off_t offset,</span>
<span class="udiff-line-removed">-                              uintptr_t vaddr, size_t memsz) {</span>
<span class="udiff-line-removed">-   map_info* map;</span>
<span class="udiff-line-removed">-   if ((map = allocate_init_map(ph-&gt;core-&gt;classes_jsa_fd,</span>
<span class="udiff-line-removed">-                                offset, vaddr, memsz)) == NULL) {</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   map-&gt;next = ph-&gt;core-&gt;class_share_maps;</span>
<span class="udiff-line-removed">-   ph-&gt;core-&gt;class_share_maps = map;</span>
<span class="udiff-line-removed">-   return map;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // Return the map_info for the given virtual address.  We keep a sorted</span>
<span class="udiff-line-removed">- // array of pointers in ph-&gt;map_array, so we can binary search.</span>
<span class="udiff-line-removed">- static map_info* core_lookup(struct ps_prochandle *ph, uintptr_t addr) {</span>
<span class="udiff-line-removed">-   int mid, lo = 0, hi = ph-&gt;core-&gt;num_maps - 1;</span>
<span class="udiff-line-removed">-   map_info *mp;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   while (hi - lo &gt; 1) {</span>
<span class="udiff-line-removed">-     mid = (lo + hi) / 2;</span>
<span class="udiff-line-removed">-     if (addr &gt;= ph-&gt;core-&gt;map_array[mid]-&gt;vaddr) {</span>
<span class="udiff-line-removed">-       lo = mid;</span>
<span class="udiff-line-removed">-     } else {</span>
<span class="udiff-line-removed">-       hi = mid;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (addr &lt; ph-&gt;core-&gt;map_array[hi]-&gt;vaddr) {</span>
<span class="udiff-line-removed">-     mp = ph-&gt;core-&gt;map_array[lo];</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     mp = ph-&gt;core-&gt;map_array[hi];</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (addr &gt;= mp-&gt;vaddr &amp;&amp; addr &lt; mp-&gt;vaddr + mp-&gt;memsz) {</span>
<span class="udiff-line-removed">-     return (mp);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Part of the class sharing workaround</span>
<span class="udiff-line-removed">-   // Unfortunately, we have no way of detecting -Xshare state.</span>
<span class="udiff-line-removed">-   // Check out the share maps atlast, if we don&#39;t find anywhere.</span>
<span class="udiff-line-removed">-   // This is done this way so to avoid reading share pages</span>
<span class="udiff-line-removed">-   // ahead of other normal maps. For eg. with -Xshare:off we don&#39;t</span>
<span class="udiff-line-removed">-   // want to prefer class sharing data to data from core.</span>
<span class="udiff-line-removed">-   mp = ph-&gt;core-&gt;class_share_maps;</span>
<span class="udiff-line-removed">-   if (mp) {</span>
<span class="udiff-line-removed">-     print_debug(&quot;can&#39;t locate map_info at 0x%lx, trying class share maps\n&quot;, addr);</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   while (mp) {</span>
<span class="udiff-line-removed">-     if (addr &gt;= mp-&gt;vaddr &amp;&amp; addr &lt; mp-&gt;vaddr + mp-&gt;memsz) {</span>
<span class="udiff-line-removed">-       print_debug(&quot;located map_info at 0x%lx from class share maps\n&quot;, addr);</span>
<span class="udiff-line-removed">-       return (mp);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     mp = mp-&gt;next;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   print_debug(&quot;can&#39;t locate map_info at 0x%lx\n&quot;, addr);</span>
<span class="udiff-line-removed">-   return (NULL);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- //---------------------------------------------------------------</span>
<span class="udiff-line-removed">- // Part of the class sharing workaround:</span>
<span class="udiff-line-removed">- //</span>
<span class="udiff-line-removed">- // With class sharing, pages are mapped from classes.jsa file.</span>
<span class="udiff-line-removed">- // The read-only class sharing pages are mapped as MAP_SHARED,</span>
<span class="udiff-line-removed">- // PROT_READ pages. These pages are not dumped into core dump.</span>
<span class="udiff-line-removed">- // With this workaround, these pages are read from classes.jsa.</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static bool read_jboolean(struct ps_prochandle* ph, uintptr_t addr, jboolean* pvalue) {</span>
<span class="udiff-line-removed">-   jboolean i;</span>
<span class="udiff-line-removed">-   if (ps_pdread(ph, (psaddr_t) addr, &amp;i, sizeof(i)) == PS_OK) {</span>
<span class="udiff-line-removed">-     *pvalue = i;</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static bool read_pointer(struct ps_prochandle* ph, uintptr_t addr, uintptr_t* pvalue) {</span>
<span class="udiff-line-removed">-   uintptr_t uip;</span>
<span class="udiff-line-removed">-   if (ps_pdread(ph, (psaddr_t) addr, (char *)&amp;uip, sizeof(uip)) == PS_OK) {</span>
<span class="udiff-line-removed">-     *pvalue = uip;</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">-   } else {</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- // used to read strings from debuggee</span>
<span class="udiff-line-removed">- static bool read_string(struct ps_prochandle* ph, uintptr_t addr, char* buf, size_t size) {</span>
<span class="udiff-line-removed">-   size_t i = 0;</span>
<span class="udiff-line-removed">-   char  c = &#39; &#39;;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   while (c != &#39;\0&#39;) {</span>
<span class="udiff-line-removed">-     if (ps_pdread(ph, (psaddr_t) addr, &amp;c, sizeof(char)) != PS_OK) {</span>
<span class="udiff-line-removed">-       return false;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     if (i &lt; size - 1) {</span>
<span class="udiff-line-removed">-       buf[i] = c;</span>
<span class="udiff-line-removed">-     } else {</span>
<span class="udiff-line-removed">-       // smaller buffer</span>
<span class="udiff-line-removed">-       return false;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     i++; addr++;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   buf[i] = &#39;\0&#39;;</span>
<span class="udiff-line-removed">-   return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #define USE_SHARED_SPACES_SYM &quot;UseSharedSpaces&quot;</span>
<span class="udiff-line-removed">- // mangled name of Arguments::SharedArchivePath</span>
<span class="udiff-line-removed">- #define SHARED_ARCHIVE_PATH_SYM &quot;_ZN9Arguments17SharedArchivePathE&quot;</span>
<span class="udiff-line-removed">- #define LIBJVM_NAME &quot;/libjvm.so&quot;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static bool init_classsharing_workaround(struct ps_prochandle* ph) {</span>
<span class="udiff-line-removed">-   lib_info* lib = ph-&gt;libs;</span>
<span class="udiff-line-removed">-   while (lib != NULL) {</span>
<span class="udiff-line-removed">-     // we are iterating over shared objects from the core dump. look for</span>
<span class="udiff-line-removed">-     // libjvm.so.</span>
<span class="udiff-line-removed">-     const char *jvm_name = 0;</span>
<span class="udiff-line-removed">-     if ((jvm_name = strstr(lib-&gt;name, LIBJVM_NAME)) != 0) {</span>
<span class="udiff-line-removed">-       char classes_jsa[PATH_MAX];</span>
<span class="udiff-line-removed">-       CDSFileMapHeaderBase header;</span>
<span class="udiff-line-removed">-       int fd = -1;</span>
<span class="udiff-line-removed">-       int m = 0;</span>
<span class="udiff-line-removed">-       size_t n = 0;</span>
<span class="udiff-line-removed">-       uintptr_t base = 0, useSharedSpacesAddr = 0;</span>
<span class="udiff-line-removed">-       uintptr_t sharedArchivePathAddrAddr = 0, sharedArchivePathAddr = 0;</span>
<span class="udiff-line-removed">-       jboolean useSharedSpaces = 0;</span>
<span class="udiff-line-removed">-       map_info* mi = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       memset(classes_jsa, 0, sizeof(classes_jsa));</span>
<span class="udiff-line-removed">-       jvm_name = lib-&gt;name;</span>
<span class="udiff-line-removed">-       useSharedSpacesAddr = lookup_symbol(ph, jvm_name, USE_SHARED_SPACES_SYM);</span>
<span class="udiff-line-removed">-       if (useSharedSpacesAddr == 0) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;can&#39;t lookup &#39;UseSharedSpaces&#39; flag\n&quot;);</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       // Hotspot vm types are not exported to build this library. So</span>
<span class="udiff-line-removed">-       // using equivalent type jboolean to read the value of</span>
<span class="udiff-line-removed">-       // UseSharedSpaces which is same as hotspot type &quot;bool&quot;.</span>
<span class="udiff-line-removed">-       if (read_jboolean(ph, useSharedSpacesAddr, &amp;useSharedSpaces) != true) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;can&#39;t read the value of &#39;UseSharedSpaces&#39; flag\n&quot;);</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if ((int)useSharedSpaces == 0) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;UseSharedSpaces is false, assuming -Xshare:off!\n&quot;);</span>
<span class="udiff-line-removed">-         return true;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       sharedArchivePathAddrAddr = lookup_symbol(ph, jvm_name, SHARED_ARCHIVE_PATH_SYM);</span>
<span class="udiff-line-removed">-       if (sharedArchivePathAddrAddr == 0) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;can&#39;t lookup shared archive path symbol\n&quot;);</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (read_pointer(ph, sharedArchivePathAddrAddr, &amp;sharedArchivePathAddr) != true) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;can&#39;t read shared archive path pointer\n&quot;);</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (read_string(ph, sharedArchivePathAddr, classes_jsa, sizeof(classes_jsa)) != true) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;can&#39;t read shared archive path value\n&quot;);</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       print_debug(&quot;looking for %s\n&quot;, classes_jsa);</span>
<span class="udiff-line-removed">-       // open the class sharing archive file</span>
<span class="udiff-line-removed">-       fd = pathmap_open(classes_jsa);</span>
<span class="udiff-line-removed">-       if (fd &lt; 0) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;can&#39;t open %s!\n&quot;, classes_jsa);</span>
<span class="udiff-line-removed">-         ph-&gt;core-&gt;classes_jsa_fd = -1;</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-       } else {</span>
<span class="udiff-line-removed">-         print_debug(&quot;opened %s\n&quot;, classes_jsa);</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       // read CDSFileMapHeaderBase from the file</span>
<span class="udiff-line-removed">-       memset(&amp;header, 0, sizeof(CDSFileMapHeaderBase));</span>
<span class="udiff-line-removed">-       if ((n = read(fd, &amp;header, sizeof(CDSFileMapHeaderBase)))</span>
<span class="udiff-line-removed">-            != sizeof(CDSFileMapHeaderBase)) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;can&#39;t read shared archive file map header from %s\n&quot;, classes_jsa);</span>
<span class="udiff-line-removed">-         close(fd);</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       // check file magic</span>
<span class="udiff-line-removed">-       if (header._magic != CDS_ARCHIVE_MAGIC) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;%s has bad shared archive file magic number 0x%x, expecting 0x%x\n&quot;,</span>
<span class="udiff-line-removed">-                     classes_jsa, header._magic, CDS_ARCHIVE_MAGIC);</span>
<span class="udiff-line-removed">-         close(fd);</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       // check version</span>
<span class="udiff-line-removed">-       if (header._version != CURRENT_CDS_ARCHIVE_VERSION) {</span>
<span class="udiff-line-removed">-         print_debug(&quot;%s has wrong shared archive file version %d, expecting %d\n&quot;,</span>
<span class="udiff-line-removed">-                      classes_jsa, header._version, CURRENT_CDS_ARCHIVE_VERSION);</span>
<span class="udiff-line-removed">-         close(fd);</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       ph-&gt;core-&gt;classes_jsa_fd = fd;</span>
<span class="udiff-line-removed">-       // add read-only maps from classes.jsa to the list of maps</span>
<span class="udiff-line-removed">-       for (m = 0; m &lt; NUM_CDS_REGIONS; m++) {</span>
<span class="udiff-line-removed">-         if (header._space[m]._read_only) {</span>
<span class="udiff-line-removed">-           base = (uintptr_t) header._space[m]._addr._base;</span>
<span class="udiff-line-removed">-           // no need to worry about the fractional pages at-the-end.</span>
<span class="udiff-line-removed">-           // possible fractional pages are handled by core_read_data.</span>
<span class="udiff-line-removed">-           add_class_share_map_info(ph, (off_t) header._space[m]._file_offset,</span>
<span class="udiff-line-removed">-                                    base, (size_t) header._space[m]._used);</span>
<span class="udiff-line-removed">-           print_debug(&quot;added a share archive map at 0x%lx\n&quot;, base);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-       }</span>
<span class="udiff-line-removed">-       return true;</span>
<span class="udiff-line-removed">-    }</span>
<span class="udiff-line-removed">-    lib = lib-&gt;next;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-removed">-   return true;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  
  //---------------------------------------------------------------------------
  // functions to handle map_info
  
  // Order mappings based on virtual address.  We use this function as the
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -837,12 +515,58 @@</span>
  
  #define FIRST_LINK_MAP_OFFSET offsetof(struct r_debug,  r_map)
  #define LD_BASE_OFFSET        offsetof(struct r_debug,  r_ldbase)
  #define LINK_MAP_ADDR_OFFSET  offsetof(struct link_map, l_addr)
  #define LINK_MAP_NAME_OFFSET  offsetof(struct link_map, l_name)
<span class="udiff-line-added">+ #define LINK_MAP_LD_OFFSET    offsetof(struct link_map, l_ld)</span>
  #define LINK_MAP_NEXT_OFFSET  offsetof(struct link_map, l_next)
  
<span class="udiff-line-added">+ #define INVALID_LOAD_ADDRESS -1L</span>
<span class="udiff-line-added">+ #define ZERO_LOAD_ADDRESS 0x0L</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ // Calculate the load address of shared library</span>
<span class="udiff-line-added">+ // on prelink-enabled environment.</span>
<span class="udiff-line-added">+ //</span>
<span class="udiff-line-added">+ // In case of GDB, it would be calculated by offset of link_map.l_ld</span>
<span class="udiff-line-added">+ // and the address of .dynamic section.</span>
<span class="udiff-line-added">+ // See GDB implementation: lm_addr_check @ solib-svr4.c</span>
<span class="udiff-line-added">+ static uintptr_t calc_prelinked_load_address(struct ps_prochandle* ph, int lib_fd, ELF_EHDR* elf_ehdr, uintptr_t link_map_addr) {</span>
<span class="udiff-line-added">+   ELF_PHDR *phbuf;</span>
<span class="udiff-line-added">+   uintptr_t lib_ld;</span>
<span class="udiff-line-added">+   uintptr_t lib_dyn_addr = 0L;</span>
<span class="udiff-line-added">+   uintptr_t load_addr;</span>
<span class="udiff-line-added">+   int i;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   phbuf = read_program_header_table(lib_fd, elf_ehdr);</span>
<span class="udiff-line-added">+   if (phbuf == NULL) {</span>
<span class="udiff-line-added">+     print_debug(&quot;can&#39;t read program header of shared object\n&quot;);</span>
<span class="udiff-line-added">+     return INVALID_LOAD_ADDRESS;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // Get the address of .dynamic section from shared library.</span>
<span class="udiff-line-added">+   for (i = 0; i &lt; elf_ehdr-&gt;e_phnum; i++) {</span>
<span class="udiff-line-added">+     if (phbuf[i].p_type == PT_DYNAMIC) {</span>
<span class="udiff-line-added">+       lib_dyn_addr = phbuf[i].p_vaddr;</span>
<span class="udiff-line-added">+       break;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   free(phbuf);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (ps_pdread(ph, (psaddr_t)link_map_addr + LINK_MAP_LD_OFFSET,</span>
<span class="udiff-line-added">+                &amp;lib_ld, sizeof(uintptr_t)) != PS_OK) {</span>
<span class="udiff-line-added">+     print_debug(&quot;can&#39;t read address of dynamic section in shared object\n&quot;);</span>
<span class="udiff-line-added">+     return INVALID_LOAD_ADDRESS;</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // Return the load address which is calculated by the address of .dynamic</span>
<span class="udiff-line-added">+   // and link_map.l_ld .</span>
<span class="udiff-line-added">+   load_addr = lib_ld - lib_dyn_addr;</span>
<span class="udiff-line-added">+   print_debug(&quot;lib_ld = 0x%lx, lib_dyn_addr = 0x%lx -&gt; lib_base_diff = 0x%lx\n&quot;, lib_ld, lib_dyn_addr, load_addr);</span>
<span class="udiff-line-added">+   return load_addr;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  // read shared library info from runtime linker&#39;s data structures.
  // This work is done by librtlb_db in Solaris
  static bool read_shared_lib_info(struct ps_prochandle* ph) {
    uintptr_t addr = ph-&gt;core-&gt;dynamic_addr;
    uintptr_t debug_base;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -940,10 +664,18 @@</span>
           if (lib_fd &lt; 0) {
              print_debug(&quot;can&#39;t open shared object %s\n&quot;, lib_name);
              // continue with other libraries...
           } else {
              if (read_elf_header(lib_fd, &amp;elf_ehdr)) {
<span class="udiff-line-added">+                if (lib_base_diff == ZERO_LOAD_ADDRESS ) {</span>
<span class="udiff-line-added">+                  lib_base_diff = calc_prelinked_load_address(ph, lib_fd, &amp;elf_ehdr, link_map_addr);</span>
<span class="udiff-line-added">+                  if (lib_base_diff == INVALID_LOAD_ADDRESS) {</span>
<span class="udiff-line-added">+                    close(lib_fd);</span>
<span class="udiff-line-added">+                    return false;</span>
<span class="udiff-line-added">+                  }</span>
<span class="udiff-line-added">+                }</span>
<span class="udiff-line-added">+ </span>
                 lib_base = lib_base_diff + find_base_address(lib_fd, &amp;elf_ehdr);
                 print_debug(&quot;reading library %s @ 0x%lx [ 0x%lx ]\n&quot;,
                             lib_name, lib_base, lib_base_diff);
                 // while adding library mappings we need to use &quot;base difference&quot;.
                 if (! read_lib_segments(ph, lib_fd, &amp;elf_ehdr, lib_base_diff)) {
</pre>
<center><a href="proc_service.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="symtab.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>