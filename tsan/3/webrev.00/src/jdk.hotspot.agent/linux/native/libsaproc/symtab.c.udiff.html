<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.hotspot.agent/linux/native/libsaproc/symtab.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ps_core.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../macosx/native/libsaproc/MacosxDebuggerLocal.m.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/linux/native/libsaproc/symtab.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2014, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -208,10 +208,13 @@</span>
    char *debug_pathname = malloc(strlen(debug_filename)
                                  + strlen(name)
                                  + strlen(&quot;.debug/&quot;)
                                  + strlen(debug_file_directory)
                                  + 2);
<span class="udiff-line-added">+   if (debug_pathname == NULL) {</span>
<span class="udiff-line-added">+     return -1;</span>
<span class="udiff-line-added">+   }</span>
    strcpy(debug_pathname, name);
    char *last_slash = strrchr(debug_pathname, &#39;/&#39;);
    if (last_slash == NULL) {
      free(debug_pathname);
      return -1;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -277,10 +280,13 @@</span>
  {
    char *filename, *s;
  
    filename = malloc(strlen (debug_file_directory) + (sizeof &quot;/.build-id/&quot; - 1) + 1
                      + 2 * size + (sizeof &quot;.debug&quot; - 1) + 1);
<span class="udiff-line-added">+   if (filename == NULL) {</span>
<span class="udiff-line-added">+     return NULL;</span>
<span class="udiff-line-added">+   }</span>
    s = filename + sprintf (filename, &quot;%s/.build-id/&quot;, debug_file_directory);
    if (size &gt; 0)
      {
        size--;
        s += sprintf (s, &quot;%02x&quot;, *data++);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -303,11 +309,13 @@</span>
  
    unsigned char *bytes
      = (unsigned char*)(note+1) + note-&gt;n_namesz;
    char *filename
      = (build_id_to_debug_filename (note-&gt;n_descsz, bytes));
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+   if (filename == NULL) {</span>
<span class="udiff-line-added">+     return NULL;</span>
<span class="udiff-line-added">+   }</span>
    fd = pathmap_open(filename);
    if (fd &gt;= 0) {
      symtab = build_symtab_internal(fd, NULL, /* try_debuginfo */ false);
      close(fd);
    }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -415,24 +423,34 @@</span>
        // than the maximum number of elements that the caller expects
        // to store in the table.&quot;
        htab_sz = n*1.25;
  
        symtab-&gt;hash_table = (struct hsearch_data*) calloc(1, sizeof(struct hsearch_data));
<span class="udiff-line-added">+       if (symtab-&gt;hash_table == NULL) {</span>
<span class="udiff-line-added">+         goto bad;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+ </span>
        rslt = hcreate_r(n, symtab-&gt;hash_table);
        // guarantee(rslt, &quot;unexpected failure: hcreate_r&quot;);
  
        // shdr-&gt;sh_link points to the section that contains the actual strings
        // for symbol names. the st_name field in ELF_SYM is just the
        // string table index. we make a copy of the string table so the
        // strings will not be destroyed by elf_end.
        size = scn_cache[shdr-&gt;sh_link].c_shdr-&gt;sh_size;
        symtab-&gt;strs = (char *)malloc(size);
<span class="udiff-line-added">+       if (symtab-&gt;strs == NULL) {</span>
<span class="udiff-line-added">+         goto bad;</span>
<span class="udiff-line-added">+       }</span>
        memcpy(symtab-&gt;strs, scn_cache[shdr-&gt;sh_link].c_data, size);
  
        // allocate memory for storing symbol offset and size;
        symtab-&gt;num_symbols = n;
        symtab-&gt;symbols = (struct elf_symbol *)calloc(n , sizeof(struct elf_symbol));
<span class="udiff-line-added">+       if (symtab-&gt;symbols == NULL) {</span>
<span class="udiff-line-added">+         goto bad;</span>
<span class="udiff-line-added">+       }</span>
  
        // copy symbols info our symtab and enter them info the hash table
        for (j = 0; j &lt; n; j++, syms++) {
          ENTRY item, *ret;
          uintptr_t sym_value;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -510,10 +528,15 @@</span>
          destroy_symtab(prev_symtab);
      } else {
        symtab = prev_symtab;
      }
    }
<span class="udiff-line-added">+   goto quit;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ bad:</span>
<span class="udiff-line-added">+   destroy_symtab(symtab);</span>
<span class="udiff-line-added">+   symtab = NULL;</span>
  
  quit:
    if (shbuf) free(shbuf);
    if (phbuf) free(phbuf);
    if (scn_cache) {
</pre>
<center><a href="ps_core.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../macosx/native/libsaproc/MacosxDebuggerLocal.m.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>