<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.hotspot.agent/macosx/native/libsaproc/ps_core.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="MacosxDebuggerLocal.m.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="symtab.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/macosx/native/libsaproc/ps_core.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 27,346 ***</span>
  #include &lt;fcntl.h&gt;
  #include &lt;string.h&gt;
  #include &lt;stdlib.h&gt;
  #include &lt;stddef.h&gt;
  #include &quot;libproc_impl.h&quot;
<span class="line-modified">! #include &quot;cds.h&quot;</span>
  
  #ifdef __APPLE__
  #include &quot;sun_jvm_hotspot_debugger_amd64_AMD64ThreadContext.h&quot;
  #endif
  
  // This file has the libproc implementation to read core files.
  // For live processes, refer to ps_proc.c. Portions of this is adapted
  // /modelled after Solaris libproc.so (in particular Pcore.c)
  
<span class="line-removed">- //----------------------------------------------------------------------</span>
<span class="line-removed">- // ps_prochandle cleanup helper functions</span>
<span class="line-removed">- </span>
<span class="line-removed">- // close all file descriptors</span>
<span class="line-removed">- static void close_files(struct ps_prochandle* ph) {</span>
<span class="line-removed">-   lib_info* lib = NULL;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // close core file descriptor</span>
<span class="line-removed">-   if (ph-&gt;core-&gt;core_fd &gt;= 0)</span>
<span class="line-removed">-     close(ph-&gt;core-&gt;core_fd);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // close exec file descriptor</span>
<span class="line-removed">-   if (ph-&gt;core-&gt;exec_fd &gt;= 0)</span>
<span class="line-removed">-     close(ph-&gt;core-&gt;exec_fd);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // close interp file descriptor</span>
<span class="line-removed">-   if (ph-&gt;core-&gt;interp_fd &gt;= 0)</span>
<span class="line-removed">-     close(ph-&gt;core-&gt;interp_fd);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // close class share archive file</span>
<span class="line-removed">-   if (ph-&gt;core-&gt;classes_jsa_fd &gt;= 0)</span>
<span class="line-removed">-     close(ph-&gt;core-&gt;classes_jsa_fd);</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // close all library file descriptors</span>
<span class="line-removed">-   lib = ph-&gt;libs;</span>
<span class="line-removed">-   while (lib) {</span>
<span class="line-removed">-     int fd = lib-&gt;fd;</span>
<span class="line-removed">-     if (fd &gt;= 0 &amp;&amp; fd != ph-&gt;core-&gt;exec_fd) {</span>
<span class="line-removed">-       close(fd);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     lib = lib-&gt;next;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- // clean all map_info stuff</span>
<span class="line-removed">- static void destroy_map_info(struct ps_prochandle* ph) {</span>
<span class="line-removed">-   map_info* map = ph-&gt;core-&gt;maps;</span>
<span class="line-removed">-   while (map) {</span>
<span class="line-removed">-     map_info* next = map-&gt;next;</span>
<span class="line-removed">-     free(map);</span>
<span class="line-removed">-     map = next;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   if (ph-&gt;core-&gt;map_array) {</span>
<span class="line-removed">-     free(ph-&gt;core-&gt;map_array);</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Part of the class sharing workaround</span>
<span class="line-removed">-   map = ph-&gt;core-&gt;class_share_maps;</span>
<span class="line-removed">-   while (map) {</span>
<span class="line-removed">-     map_info* next = map-&gt;next;</span>
<span class="line-removed">-     free(map);</span>
<span class="line-removed">-     map = next;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- // ps_prochandle operations</span>
<span class="line-removed">- static void core_release(struct ps_prochandle* ph) {</span>
<span class="line-removed">-   if (ph-&gt;core) {</span>
<span class="line-removed">-     close_files(ph);</span>
<span class="line-removed">-     destroy_map_info(ph);</span>
<span class="line-removed">-     free(ph-&gt;core);</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static map_info* allocate_init_map(int fd, off_t offset, uintptr_t vaddr, size_t memsz) {</span>
<span class="line-removed">-   map_info* map;</span>
<span class="line-removed">-   if ( (map = (map_info*) calloc(1, sizeof(map_info))) == NULL) {</span>
<span class="line-removed">-     print_debug(&quot;can&#39;t allocate memory for map_info\n&quot;);</span>
<span class="line-removed">-     return NULL;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // initialize map</span>
<span class="line-removed">-   map-&gt;fd     = fd;</span>
<span class="line-removed">-   map-&gt;offset = offset;</span>
<span class="line-removed">-   map-&gt;vaddr  = vaddr;</span>
<span class="line-removed">-   map-&gt;memsz  = memsz;</span>
<span class="line-removed">-   return map;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- // add map info with given fd, offset, vaddr and memsz</span>
<span class="line-removed">- static map_info* add_map_info(struct ps_prochandle* ph, int fd, off_t offset,</span>
<span class="line-removed">-                              uintptr_t vaddr, size_t memsz) {</span>
<span class="line-removed">-   map_info* map;</span>
<span class="line-removed">-   if ((map = allocate_init_map(fd, offset, vaddr, memsz)) == NULL) {</span>
<span class="line-removed">-     return NULL;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   // add this to map list</span>
<span class="line-removed">-   map-&gt;next  = ph-&gt;core-&gt;maps;</span>
<span class="line-removed">-   ph-&gt;core-&gt;maps   = map;</span>
<span class="line-removed">-   ph-&gt;core-&gt;num_maps++;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   return map;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- // Part of the class sharing workaround</span>
<span class="line-removed">- static map_info* add_class_share_map_info(struct ps_prochandle* ph, off_t offset,</span>
<span class="line-removed">-                              uintptr_t vaddr, size_t memsz) {</span>
<span class="line-removed">-   map_info* map;</span>
<span class="line-removed">-   if ((map = allocate_init_map(ph-&gt;core-&gt;classes_jsa_fd,</span>
<span class="line-removed">-                                offset, vaddr, memsz)) == NULL) {</span>
<span class="line-removed">-     return NULL;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   map-&gt;next = ph-&gt;core-&gt;class_share_maps;</span>
<span class="line-removed">-   ph-&gt;core-&gt;class_share_maps = map;</span>
<span class="line-removed">-   return map;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- // Return the map_info for the given virtual address.  We keep a sorted</span>
<span class="line-removed">- // array of pointers in ph-&gt;map_array, so we can binary search.</span>
<span class="line-removed">- static map_info* core_lookup(struct ps_prochandle *ph, uintptr_t addr) {</span>
<span class="line-removed">-   int mid, lo = 0, hi = ph-&gt;core-&gt;num_maps - 1;</span>
<span class="line-removed">-   map_info *mp;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   while (hi - lo &gt; 1) {</span>
<span class="line-removed">-     mid = (lo + hi) / 2;</span>
<span class="line-removed">-     if (addr &gt;= ph-&gt;core-&gt;map_array[mid]-&gt;vaddr) {</span>
<span class="line-removed">-       lo = mid;</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-       hi = mid;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   if (addr &lt; ph-&gt;core-&gt;map_array[hi]-&gt;vaddr) {</span>
<span class="line-removed">-     mp = ph-&gt;core-&gt;map_array[lo];</span>
<span class="line-removed">-   } else {</span>
<span class="line-removed">-     mp = ph-&gt;core-&gt;map_array[hi];</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   if (addr &gt;= mp-&gt;vaddr &amp;&amp; addr &lt; mp-&gt;vaddr + mp-&gt;memsz) {</span>
<span class="line-removed">-     return (mp);</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-   // Part of the class sharing workaround</span>
<span class="line-removed">-   // Unfortunately, we have no way of detecting -Xshare state.</span>
<span class="line-removed">-   // Check out the share maps atlast, if we don&#39;t find anywhere.</span>
<span class="line-removed">-   // This is done this way so to avoid reading share pages</span>
<span class="line-removed">-   // ahead of other normal maps. For eg. with -Xshare:off we don&#39;t</span>
<span class="line-removed">-   // want to prefer class sharing data to data from core.</span>
<span class="line-removed">-   mp = ph-&gt;core-&gt;class_share_maps;</span>
<span class="line-removed">-   if (mp) {</span>
<span class="line-removed">-     print_debug(&quot;can&#39;t locate map_info at 0x%lx, trying class share maps\n&quot;, addr);</span>
<span class="line-removed">-   }</span>
<span class="line-removed">-   while (mp) {</span>
<span class="line-removed">-     if (addr &gt;= mp-&gt;vaddr &amp;&amp; addr &lt; mp-&gt;vaddr + mp-&gt;memsz) {</span>
<span class="line-removed">-       print_debug(&quot;located map_info at 0x%lx from class share maps\n&quot;, addr);</span>
<span class="line-removed">-       return (mp);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     mp = mp-&gt;next;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- </span>
<span class="line-removed">-   print_debug(&quot;can&#39;t locate map_info at 0x%lx\n&quot;, addr);</span>
<span class="line-removed">-   return (NULL);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- //---------------------------------------------------------------</span>
<span class="line-removed">- // Part of the class sharing workaround:</span>
<span class="line-removed">- //</span>
<span class="line-removed">- // With class sharing, pages are mapped from classes.jsa file.</span>
<span class="line-removed">- // The read-only class sharing pages are mapped as MAP_SHARED,</span>
<span class="line-removed">- // PROT_READ pages. These pages are not dumped into core dump.</span>
<span class="line-removed">- // With this workaround, these pages are read from classes.jsa.</span>
<span class="line-removed">- </span>
<span class="line-removed">- static bool read_jboolean(struct ps_prochandle* ph, uintptr_t addr, jboolean* pvalue) {</span>
<span class="line-removed">-   jboolean i;</span>
<span class="line-removed">-   if (ps_pread(ph, (psaddr_t) addr, &amp;i, sizeof(i)) == PS_OK) {</span>
<span class="line-removed">-     *pvalue = i;</span>
<span class="line-removed">-     return true;</span>
<span class="line-removed">-   } else {</span>
<span class="line-removed">-     return false;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static bool read_pointer(struct ps_prochandle* ph, uintptr_t addr, uintptr_t* pvalue) {</span>
<span class="line-removed">-   uintptr_t uip;</span>
<span class="line-removed">-   if (ps_pread(ph, (psaddr_t) addr, (char *)&amp;uip, sizeof(uip)) == PS_OK) {</span>
<span class="line-removed">-     *pvalue = uip;</span>
<span class="line-removed">-     return true;</span>
<span class="line-removed">-   } else {</span>
<span class="line-removed">-     return false;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- // used to read strings from debuggee</span>
<span class="line-removed">- static bool read_string(struct ps_prochandle* ph, uintptr_t addr, char* buf, size_t size) {</span>
<span class="line-removed">-   size_t i = 0;</span>
<span class="line-removed">-   char  c = &#39; &#39;;</span>
<span class="line-removed">- </span>
<span class="line-removed">-   while (c != &#39;\0&#39;) {</span>
<span class="line-removed">-     if (ps_pread(ph, (psaddr_t) addr, &amp;c, sizeof(char)) != PS_OK) {</span>
<span class="line-removed">-       return false;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     if (i &lt; size - 1) {</span>
<span class="line-removed">-       buf[i] = c;</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-       // smaller buffer</span>
<span class="line-removed">-       return false;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     i++; addr++;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">-   buf[i] = &#39;\0&#39;;</span>
<span class="line-removed">-   return true;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- // mangled name of Arguments::SharedArchivePath</span>
<span class="line-removed">- #define SHARED_ARCHIVE_PATH_SYM &quot;__ZN9Arguments17SharedArchivePathE&quot;</span>
<span class="line-removed">- </span>
<span class="line-removed">- #ifdef __APPLE__</span>
<span class="line-removed">- #define USE_SHARED_SPACES_SYM &quot;_UseSharedSpaces&quot;</span>
<span class="line-removed">- #define LIBJVM_NAME &quot;/libjvm.dylib&quot;</span>
<span class="line-removed">- #else</span>
<span class="line-removed">- #define USE_SHARED_SPACES_SYM &quot;UseSharedSpaces&quot;</span>
<span class="line-removed">- #define LIBJVM_NAME &quot;/libjvm.so&quot;</span>
<span class="line-removed">- #endif // __APPLE_</span>
<span class="line-removed">- </span>
<span class="line-removed">- static bool init_classsharing_workaround(struct ps_prochandle* ph) {</span>
<span class="line-removed">-   int m;</span>
<span class="line-removed">-   size_t n;</span>
<span class="line-removed">-   lib_info* lib = ph-&gt;libs;</span>
<span class="line-removed">-   while (lib != NULL) {</span>
<span class="line-removed">-     // we are iterating over shared objects from the core dump. look for</span>
<span class="line-removed">-     // libjvm.so.</span>
<span class="line-removed">-     const char *jvm_name = 0;</span>
<span class="line-removed">-     if ((jvm_name = strstr(lib-&gt;name, LIBJVM_NAME)) != 0) {</span>
<span class="line-removed">-       char classes_jsa[PATH_MAX];</span>
<span class="line-removed">-       CDSFileMapHeaderBase header;</span>
<span class="line-removed">-       int fd = -1;</span>
<span class="line-removed">-       uintptr_t base = 0, useSharedSpacesAddr = 0;</span>
<span class="line-removed">-       uintptr_t sharedArchivePathAddrAddr = 0, sharedArchivePathAddr = 0;</span>
<span class="line-removed">-       jboolean useSharedSpaces = 0;</span>
<span class="line-removed">- </span>
<span class="line-removed">-       memset(classes_jsa, 0, sizeof(classes_jsa));</span>
<span class="line-removed">-       jvm_name = lib-&gt;name;</span>
<span class="line-removed">-       useSharedSpacesAddr = lookup_symbol(ph, jvm_name, USE_SHARED_SPACES_SYM);</span>
<span class="line-removed">-       if (useSharedSpacesAddr == 0) {</span>
<span class="line-removed">-         print_debug(&quot;can&#39;t lookup &#39;UseSharedSpaces&#39; flag\n&quot;);</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       // Hotspot vm types are not exported to build this library. So</span>
<span class="line-removed">-       // using equivalent type jboolean to read the value of</span>
<span class="line-removed">-       // UseSharedSpaces which is same as hotspot type &quot;bool&quot;.</span>
<span class="line-removed">-       if (read_jboolean(ph, useSharedSpacesAddr, &amp;useSharedSpaces) != true) {</span>
<span class="line-removed">-         print_debug(&quot;can&#39;t read the value of &#39;UseSharedSpaces&#39; flag\n&quot;);</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       if ((int)useSharedSpaces == 0) {</span>
<span class="line-removed">-         print_debug(&quot;UseSharedSpaces is false, assuming -Xshare:off!\n&quot;);</span>
<span class="line-removed">-         return true;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       sharedArchivePathAddrAddr = lookup_symbol(ph, jvm_name, SHARED_ARCHIVE_PATH_SYM);</span>
<span class="line-removed">-       if (sharedArchivePathAddrAddr == 0) {</span>
<span class="line-removed">-         print_debug(&quot;can&#39;t lookup shared archive path symbol\n&quot;);</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       if (read_pointer(ph, sharedArchivePathAddrAddr, &amp;sharedArchivePathAddr) != true) {</span>
<span class="line-removed">-         print_debug(&quot;can&#39;t read shared archive path pointer\n&quot;);</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       if (read_string(ph, sharedArchivePathAddr, classes_jsa, sizeof(classes_jsa)) != true) {</span>
<span class="line-removed">-         print_debug(&quot;can&#39;t read shared archive path value\n&quot;);</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       print_debug(&quot;looking for %s\n&quot;, classes_jsa);</span>
<span class="line-removed">-       // open the class sharing archive file</span>
<span class="line-removed">-       fd = pathmap_open(classes_jsa);</span>
<span class="line-removed">-       if (fd &lt; 0) {</span>
<span class="line-removed">-         print_debug(&quot;can&#39;t open %s!\n&quot;, classes_jsa);</span>
<span class="line-removed">-         ph-&gt;core-&gt;classes_jsa_fd = -1;</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       } else {</span>
<span class="line-removed">-         print_debug(&quot;opened %s\n&quot;, classes_jsa);</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       // read CDSFileMapHeaderBase from the file</span>
<span class="line-removed">-       memset(&amp;header, 0, sizeof(CDSFileMapHeaderBase));</span>
<span class="line-removed">-       if ((n = read(fd, &amp;header, sizeof(CDSFileMapHeaderBase)))</span>
<span class="line-removed">-            != sizeof(CDSFileMapHeaderBase)) {</span>
<span class="line-removed">-         print_debug(&quot;can&#39;t read shared archive file map header from %s\n&quot;, classes_jsa);</span>
<span class="line-removed">-         close(fd);</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       // check file magic</span>
<span class="line-removed">-       if (header._magic != CDS_ARCHIVE_MAGIC) {</span>
<span class="line-removed">-         print_debug(&quot;%s has bad shared archive file magic number 0x%x, expecting 0x%x\n&quot;,</span>
<span class="line-removed">-                     classes_jsa, header._magic, CDS_ARCHIVE_MAGIC);</span>
<span class="line-removed">-         close(fd);</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       // check version</span>
<span class="line-removed">-       if (header._version != CURRENT_CDS_ARCHIVE_VERSION) {</span>
<span class="line-removed">-         print_debug(&quot;%s has wrong shared archive file version %d, expecting %d\n&quot;,</span>
<span class="line-removed">-                      classes_jsa, header._version, CURRENT_CDS_ARCHIVE_VERSION);</span>
<span class="line-removed">-         close(fd);</span>
<span class="line-removed">-         return false;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">- </span>
<span class="line-removed">-       ph-&gt;core-&gt;classes_jsa_fd = fd;</span>
<span class="line-removed">-       // add read-only maps from classes.jsa to the list of maps</span>
<span class="line-removed">-       for (m = 0; m &lt; NUM_CDS_REGIONS; m++) {</span>
<span class="line-removed">-         if (header._space[m]._read_only) {</span>
<span class="line-removed">-           base = (uintptr_t) header._space[m]._addr._base;</span>
<span class="line-removed">-           // no need to worry about the fractional pages at-the-end.</span>
<span class="line-removed">-           // possible fractional pages are handled by core_read_data.</span>
<span class="line-removed">-           add_class_share_map_info(ph, (off_t) header._space[m]._file_offset,</span>
<span class="line-removed">-                                    base, (size_t) header._space[m]._used);</span>
<span class="line-removed">-           print_debug(&quot;added a share archive map at 0x%lx\n&quot;, base);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-       return true;</span>
<span class="line-removed">-    }</span>
<span class="line-removed">-    lib = lib-&gt;next;</span>
<span class="line-removed">-   }</span>
<span class="line-removed">-   return true;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  //---------------------------------------------------------------------------
  // functions to handle map_info
  
  // Order mappings based on virtual address.  We use this function as the
  // callback for sorting the array of map_info pointers.
<span class="line-new-header">--- 27,20 ---</span>
  #include &lt;fcntl.h&gt;
  #include &lt;string.h&gt;
  #include &lt;stdlib.h&gt;
  #include &lt;stddef.h&gt;
  #include &quot;libproc_impl.h&quot;
<span class="line-modified">! #include &quot;ps_core_common.h&quot;</span>
  
  #ifdef __APPLE__
  #include &quot;sun_jvm_hotspot_debugger_amd64_AMD64ThreadContext.h&quot;
  #endif
  
  // This file has the libproc implementation to read core files.
  // For live processes, refer to ps_proc.c. Portions of this is adapted
  // /modelled after Solaris libproc.so (in particular Pcore.c)
  
  //---------------------------------------------------------------------------
  // functions to handle map_info
  
  // Order mappings based on virtual address.  We use this function as the
  // callback for sorting the array of map_info pointers.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 688,19 ***</span>
      char* java_home = getenv(&quot;JAVA_HOME&quot;);
      if (java_home != NULL) {
        strcpy(filepath, java_home);
      } else {
        char* dyldpath = getenv(&quot;DYLD_LIBRARY_PATH&quot;);
<span class="line-modified">!       char* dypath = strtok(dyldpath, &quot;:&quot;);</span>
        while (dypath != NULL) {
          strcpy(filepath, dypath);
          strcat(filepath, filename);
          if (exists(filepath)) {
             strcpy(rpath, filepath);
             return true;
          }
<span class="line-modified">!         dypath = strtok(dyldpath, &quot;:&quot;);</span>
        }
        // not found
        return false;
      }
    }
<span class="line-new-header">--- 362,20 ---</span>
      char* java_home = getenv(&quot;JAVA_HOME&quot;);
      if (java_home != NULL) {
        strcpy(filepath, java_home);
      } else {
        char* dyldpath = getenv(&quot;DYLD_LIBRARY_PATH&quot;);
<span class="line-modified">!       char* save_ptr;</span>
<span class="line-added">+       char* dypath = strtok_r(dyldpath, &quot;:&quot;, &amp;save_ptr);</span>
        while (dypath != NULL) {
          strcpy(filepath, dypath);
          strcat(filepath, filename);
          if (exists(filepath)) {
             strcpy(rpath, filepath);
             return true;
          }
<span class="line-modified">!         dypath = strtok_r(NULL, &quot;:&quot;, &amp;save_ptr);</span>
        }
        // not found
        return false;
      }
    }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 959,11 ***</span>
     // copy regs
     memcpy(&amp;newthr-&gt;regs, &amp;prstat-&gt;pr_reg, sizeof(struct reg));
  
     if (is_debug()) {
        print_debug(&quot;integer regset\n&quot;);
<span class="line-modified">! #ifdef i386</span>
        // print the regset
        print_debug(&quot;\teax = 0x%x\n&quot;, newthr-&gt;regs.r_eax);
        print_debug(&quot;\tebx = 0x%x\n&quot;, newthr-&gt;regs.r_ebx);
        print_debug(&quot;\tecx = 0x%x\n&quot;, newthr-&gt;regs.r_ecx);
        print_debug(&quot;\tedx = 0x%x\n&quot;, newthr-&gt;regs.r_edx);
<span class="line-new-header">--- 634,11 ---</span>
     // copy regs
     memcpy(&amp;newthr-&gt;regs, &amp;prstat-&gt;pr_reg, sizeof(struct reg));
  
     if (is_debug()) {
        print_debug(&quot;integer regset\n&quot;);
<span class="line-modified">! #if defined(i586) || defined(i386)</span>
        // print the regset
        print_debug(&quot;\teax = 0x%x\n&quot;, newthr-&gt;regs.r_eax);
        print_debug(&quot;\tebx = 0x%x\n&quot;, newthr-&gt;regs.r_ebx);
        print_debug(&quot;\tecx = 0x%x\n&quot;, newthr-&gt;regs.r_ecx);
        print_debug(&quot;\tedx = 0x%x\n&quot;, newthr-&gt;regs.r_edx);
</pre>
<center><a href="MacosxDebuggerLocal.m.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="symtab.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>