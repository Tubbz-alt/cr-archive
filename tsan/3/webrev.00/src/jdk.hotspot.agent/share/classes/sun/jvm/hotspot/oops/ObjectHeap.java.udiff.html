<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/oops/ObjectHeap.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Mark.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../runtime/ClassConstants.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/oops/ObjectHeap.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -30,11 +30,10 @@</span>
  package sun.jvm.hotspot.oops;
  
  import java.util.*;
  
  import sun.jvm.hotspot.debugger.*;
<span class="udiff-line-removed">- import sun.jvm.hotspot.gc.cms.*;</span>
  import sun.jvm.hotspot.gc.shared.*;
  import sun.jvm.hotspot.gc.epsilon.*;
  import sun.jvm.hotspot.gc.g1.*;
  import sun.jvm.hotspot.gc.shenandoah.*;
  import sun.jvm.hotspot.gc.parallel.*;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -232,20 +231,15 @@</span>
        Address top    = (Address) liveRegions.get(i+1);
        totalSize += top.minus(bottom);
      }
      visitor.prologue(totalSize);
  
<span class="udiff-line-removed">-     CompactibleFreeListSpace cmsSpaceOld = null;</span>
      CollectedHeap heap = VM.getVM().getUniverse().heap();
  
      if (heap instanceof GenCollectedHeap) {
        GenCollectedHeap genHeap = (GenCollectedHeap) heap;
        Generation genOld = genHeap.getGen(1);
<span class="udiff-line-removed">-       if (genOld instanceof ConcurrentMarkSweepGeneration) {</span>
<span class="udiff-line-removed">-           ConcurrentMarkSweepGeneration concGen = (ConcurrentMarkSweepGeneration)genOld;</span>
<span class="udiff-line-removed">-           cmsSpaceOld = concGen.cmsSpace();</span>
<span class="udiff-line-removed">-       }</span>
      }
  
      for (int i = 0; i &lt; liveRegions.size(); i += 2) {
        Address bottom = (Address) liveRegions.get(i);
        Address top    = (Address) liveRegions.get(i+1);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -253,46 +247,30 @@</span>
        try {
          // Traverses the space from bottom to top
          OopHandle handle = bottom.addOffsetToAsOopHandle(0);
  
          while (handle.lessThan(top)) {
<span class="udiff-line-modified-removed">-         Oop obj = null;</span>
<span class="udiff-line-modified-added">+           Oop obj = null;</span>
  
            try {
              obj = newOop(handle);
            } catch (UnknownOopException exp) {
              if (DEBUG) {
                throw new RuntimeException(&quot; UnknownOopException  &quot; + exp);
              }
            }
            if (obj == null) {
<span class="udiff-line-modified-removed">-              //Find the object size using Printezis bits and skip over</span>
<span class="udiff-line-removed">-              long size = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-              if ( (cmsSpaceOld != null) &amp;&amp; cmsSpaceOld.contains(handle) ){</span>
<span class="udiff-line-removed">-                  size = cmsSpaceOld.collector().blockSizeUsingPrintezisBits(handle);</span>
<span class="udiff-line-removed">-              }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-              if (size &lt;= 0) {</span>
<span class="udiff-line-removed">-                 //Either Printezis bits not set or handle is not in cms space.</span>
<span class="udiff-line-removed">-                 throw new UnknownOopException();</span>
<span class="udiff-line-removed">-              }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-              handle = handle.addOffsetToAsOopHandle(CompactibleFreeListSpace.adjustObjectSizeInBytes(size));</span>
<span class="udiff-line-removed">-              continue;</span>
<span class="udiff-line-modified-added">+               throw new UnknownOopException();</span>
            }
            if (of == null || of.canInclude(obj)) {
                    if (visitor.doObj(obj)) {
                           // doObj() returns true to abort this loop.
                            break;
                    }
            }
<span class="udiff-line-modified-removed">-           if ( (cmsSpaceOld != null) &amp;&amp; cmsSpaceOld.contains(handle)) {</span>
<span class="udiff-line-modified-removed">-               handle = handle.addOffsetToAsOopHandle(CompactibleFreeListSpace.adjustObjectSizeInBytes(obj.getObjectSize()) );</span>
<span class="udiff-line-removed">-           } else {</span>
<span class="udiff-line-removed">-               handle = handle.addOffsetToAsOopHandle(obj.getObjectSize());</span>
<span class="udiff-line-removed">-           }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+           handle = handle.addOffsetToAsOopHandle(obj.getObjectSize());</span>
          }
        }
        catch (AddressException e) {
          // This is okay at the top of these regions
            }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -353,11 +331,13 @@</span>
      // FIXME: consider adding fewer boundaries to live region list.
      // Theoretically only need to stop at TLAB&#39;s top and resume at its
      // end.
  
      if (VM.getVM().getUseTLAB()) {
<span class="udiff-line-modified-removed">-       for (JavaThread thread = VM.getVM().getThreads().first(); thread != null; thread = thread.next()) {</span>
<span class="udiff-line-modified-added">+       Threads threads = VM.getVM().getThreads();</span>
<span class="udiff-line-added">+       for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="udiff-line-added">+         JavaThread thread = threads.getJavaThreadAt(i);</span>
          ThreadLocalAllocBuffer tlab = thread.tlab();
          if (tlab.start() != null) {
            if ((tlab.top() == null) || (tlab.end() == null)) {
              System.err.print(&quot;Warning: skipping invalid TLAB for thread &quot;);
              thread.printThreadIDOn(System.err);
</pre>
<center><a href="Mark.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../runtime/ClassConstants.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>