<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/gc/shenandoah/ShenandoahHeapRegion.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ShenandoahHeap.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../z/ZHeap.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/gc/shenandoah/ShenandoahHeapRegion.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2018, Red Hat, Inc. All rights reserved.</span>

  3  *
  4  * This code is free software; you can redistribute it and/or modify it
  5  * under the terms of the GNU General Public License version 2 only, as
  6  * published by the Free Software Foundation.
  7  *
  8  * This code is distributed in the hope that it will be useful, but WITHOUT
  9  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 10  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 11  * version 2 for more details (a copy is included in the LICENSE file that
 12  * accompanied this code).
 13  *
 14  * You should have received a copy of the GNU General Public License version
 15  * 2 along with this work; if not, write to the Free Software Foundation,
 16  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 17  *
 18  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 19  * or visit www.oracle.com if you need additional information or have any
 20  * questions.
 21  *
 22  */
 23 
 24 package sun.jvm.hotspot.gc.shenandoah;
 25 

 26 import sun.jvm.hotspot.gc.shared.ContiguousSpace;
<span class="line-modified"> 27 import sun.jvm.hotspot.types.CIntegerField;</span>





 28 import sun.jvm.hotspot.runtime.VM;
<span class="line-removed"> 29 import sun.jvm.hotspot.types.Type;</span>
<span class="line-removed"> 30 import sun.jvm.hotspot.types.TypeDataBase;</span>
 31 import sun.jvm.hotspot.debugger.Address;

 32 


 33 import java.util.Observable;
 34 import java.util.Observer;
 35 
 36 
<span class="line-modified"> 37 public class ShenandoahHeapRegion extends ContiguousSpace {</span>
<span class="line-modified"> 38     private static CIntegerField RegionSizeBytes;</span>

















 39     static {
 40         VM.registerVMInitializedObserver(new Observer() {
 41             public void update(Observable o, Object data) {
 42                 initialize(VM.getVM().getTypeDataBase());
 43             }
 44         });
 45     }
 46 
 47     static private synchronized void initialize(TypeDataBase db) {
 48         Type type = db.lookupType(&quot;ShenandoahHeapRegion&quot;);
<span class="line-modified"> 49         RegionSizeBytes = type.getCIntegerField(&quot;RegionSizeBytes&quot;);</span>















 50     }
 51 
<span class="line-modified"> 52     public static long regionSizeBytes() { return RegionSizeBytes.getValue(); }</span>






 53 
 54     public ShenandoahHeapRegion(Address addr) {
 55         super(addr);
 56     }























































































































 57 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2019, Red Hat, Inc. All rights reserved.</span>
<span class="line-added">  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 package sun.jvm.hotspot.gc.shenandoah;
 26 
<span class="line-added"> 27 import sun.jvm.hotspot.debugger.OopHandle;</span>
 28 import sun.jvm.hotspot.gc.shared.ContiguousSpace;
<span class="line-modified"> 29 import sun.jvm.hotspot.gc.shared.LiveRegionsProvider;</span>
<span class="line-added"> 30 import sun.jvm.hotspot.memory.MemRegion;</span>
<span class="line-added"> 31 import sun.jvm.hotspot.oops.Mark;</span>
<span class="line-added"> 32 import sun.jvm.hotspot.oops.Oop;</span>
<span class="line-added"> 33 import sun.jvm.hotspot.oops.UnknownOopException;</span>
<span class="line-added"> 34 import sun.jvm.hotspot.types.*;</span>
 35 import sun.jvm.hotspot.runtime.VM;


 36 import sun.jvm.hotspot.debugger.Address;
<span class="line-added"> 37 import sun.jvm.hotspot.utilities.AddressOps;</span>
 38 
<span class="line-added"> 39 import java.util.ArrayList;</span>
<span class="line-added"> 40 import java.util.List;</span>
 41 import java.util.Observable;
 42 import java.util.Observer;
 43 
 44 
<span class="line-modified"> 45 public class ShenandoahHeapRegion extends ContiguousSpace implements LiveRegionsProvider {</span>
<span class="line-modified"> 46     private static int EmptyUncommitted;</span>
<span class="line-added"> 47     private static int EmptyCommitted;</span>
<span class="line-added"> 48     private static int Regular;</span>
<span class="line-added"> 49     private static int HumongousStart;</span>
<span class="line-added"> 50     private static int HumongousCont;</span>
<span class="line-added"> 51     private static int PinnedHumongousStart;</span>
<span class="line-added"> 52     private static int CSet;</span>
<span class="line-added"> 53     private static int Pinned;</span>
<span class="line-added"> 54     private static int PinnedCSet;</span>
<span class="line-added"> 55     private static int Trash;</span>
<span class="line-added"> 56 </span>
<span class="line-added"> 57     private static CIntegerField RegionSizeBytesField;</span>
<span class="line-added"> 58     private static Field         RegionStateField;</span>
<span class="line-added"> 59     private static CIntegerField RegionNumberField;</span>
<span class="line-added"> 60     private static CIntegerField RegionSizeBytesShiftField;</span>
<span class="line-added"> 61 </span>
<span class="line-added"> 62     private ShenandoahHeap heap;</span>
<span class="line-added"> 63 </span>
 64     static {
 65         VM.registerVMInitializedObserver(new Observer() {
 66             public void update(Observable o, Object data) {
 67                 initialize(VM.getVM().getTypeDataBase());
 68             }
 69         });
 70     }
 71 
 72     static private synchronized void initialize(TypeDataBase db) {
 73         Type type = db.lookupType(&quot;ShenandoahHeapRegion&quot;);
<span class="line-modified"> 74         RegionSizeBytesField = type.getCIntegerField(&quot;RegionSizeBytes&quot;);</span>
<span class="line-added"> 75         RegionStateField = type.getField(&quot;_state&quot;);</span>
<span class="line-added"> 76         RegionNumberField = type.getCIntegerField(&quot;_region_number&quot;);</span>
<span class="line-added"> 77 </span>
<span class="line-added"> 78         RegionSizeBytesShiftField = type.getCIntegerField(&quot;RegionSizeBytesShift&quot;);</span>
<span class="line-added"> 79 </span>
<span class="line-added"> 80         EmptyUncommitted     = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_empty_uncommitted&quot;).intValue();</span>
<span class="line-added"> 81         EmptyCommitted       = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_empty_committed&quot;).intValue();</span>
<span class="line-added"> 82         Regular              = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_regular&quot;).intValue();</span>
<span class="line-added"> 83         HumongousStart       = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_humongous_start&quot;).intValue();</span>
<span class="line-added"> 84         HumongousCont        = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_humongous_cont&quot;).intValue();</span>
<span class="line-added"> 85         PinnedHumongousStart = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_pinned_humongous_start&quot;).intValue();</span>
<span class="line-added"> 86         CSet                 = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_cset&quot;).intValue();</span>
<span class="line-added"> 87         Pinned               = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_pinned&quot;).intValue();</span>
<span class="line-added"> 88         PinnedCSet           = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_pinned_cset&quot;).intValue();</span>
<span class="line-added"> 89         Trash                = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_trash&quot;).intValue();</span>
 90     }
 91 
<span class="line-modified"> 92     public static long regionSizeBytes() {</span>
<span class="line-added"> 93         return RegionSizeBytesField.getValue();</span>
<span class="line-added"> 94     }</span>
<span class="line-added"> 95 </span>
<span class="line-added"> 96     public static int  regionSizeBytesShift() {</span>
<span class="line-added"> 97         return RegionSizeBytesShiftField.getJInt();</span>
<span class="line-added"> 98     }</span>
 99 
100     public ShenandoahHeapRegion(Address addr) {
101         super(addr);
102     }
<span class="line-added">103 </span>
<span class="line-added">104     public void setHeap(ShenandoahHeap heap) {</span>
<span class="line-added">105         this.heap = heap;</span>
<span class="line-added">106     }</span>
<span class="line-added">107 </span>
<span class="line-added">108     @Override</span>
<span class="line-added">109     public int hashCode() {</span>
<span class="line-added">110         return (int)regionNumber();</span>
<span class="line-added">111     }</span>
<span class="line-added">112 </span>
<span class="line-added">113     @Override</span>
<span class="line-added">114     public boolean equals(Object other) {</span>
<span class="line-added">115         if (other instanceof ShenandoahHeapRegion) {</span>
<span class="line-added">116             ShenandoahHeapRegion otherRegion = (ShenandoahHeapRegion)other;</span>
<span class="line-added">117             return otherRegion.regionNumber() == regionNumber();</span>
<span class="line-added">118         }</span>
<span class="line-added">119         return false;</span>
<span class="line-added">120     }</span>
<span class="line-added">121 </span>
<span class="line-added">122     public List&lt;MemRegion&gt; getLiveRegions() {</span>
<span class="line-added">123         List&lt;MemRegion&gt; res = new ArrayList&lt;&gt;();</span>
<span class="line-added">124         int state = regionState();</span>
<span class="line-added">125         if (state == EmptyUncommitted || state == EmptyCommitted || state == Trash) {</span>
<span class="line-added">126             // No live data</span>
<span class="line-added">127         } else if (state == HumongousCont) {</span>
<span class="line-added">128             // Handled by HumongousStart</span>
<span class="line-added">129         } else if (state == HumongousStart || state == PinnedHumongousStart) {</span>
<span class="line-added">130             handleHumongousRegion(res);</span>
<span class="line-added">131         } else if (state == Regular || state == Pinned) {</span>
<span class="line-added">132             handleRegularRegion(res);</span>
<span class="line-added">133         } else if (state == CSet || state == PinnedCSet) {</span>
<span class="line-added">134             // CSet</span>
<span class="line-added">135             handleCSetRegion(res);</span>
<span class="line-added">136         } else {</span>
<span class="line-added">137             throw new RuntimeException(&quot;Unknown region state: &quot; + state);</span>
<span class="line-added">138         }</span>
<span class="line-added">139         return res;</span>
<span class="line-added">140     }</span>
<span class="line-added">141 </span>
<span class="line-added">142     /*</span>
<span class="line-added">143      * Note: RegionState is an enum on JVM side. Seems that there is not</span>
<span class="line-added">144      *       a standard way to read enum value. We read it as an integer</span>
<span class="line-added">145      *       from the field&#39;s offset.</span>
<span class="line-added">146      */</span>
<span class="line-added">147     private int regionState() {</span>
<span class="line-added">148         long offset = RegionStateField.getOffset();</span>
<span class="line-added">149         return addr.getJIntAt(offset);</span>
<span class="line-added">150     }</span>
<span class="line-added">151 </span>
<span class="line-added">152     private void handleHumongousRegion(List&lt;MemRegion&gt; res) {</span>
<span class="line-added">153         long index = regionNumber();</span>
<span class="line-added">154         Address topAddr = top();</span>
<span class="line-added">155         ShenandoahHeapRegion region = heap.getRegion(++ index);</span>
<span class="line-added">156         while (region.regionState() == HumongousCont) {</span>
<span class="line-added">157             topAddr = region.top();</span>
<span class="line-added">158             region = heap.getRegion(++ index);</span>
<span class="line-added">159         }</span>
<span class="line-added">160         res.add(new MemRegion(bottom(), topAddr));</span>
<span class="line-added">161     }</span>
<span class="line-added">162 </span>
<span class="line-added">163     private void handleRegularRegion(List&lt;MemRegion&gt; res) {</span>
<span class="line-added">164         res.add(new MemRegion(bottom(), top()));</span>
<span class="line-added">165     }</span>
<span class="line-added">166 </span>
<span class="line-added">167     // Filter out forwarded objects, they should be counted in other regions</span>
<span class="line-added">168     private void handleCSetRegion(List&lt;MemRegion&gt; res) {</span>
<span class="line-added">169         Address end = top();</span>
<span class="line-added">170         Address start = bottom();</span>
<span class="line-added">171 </span>
<span class="line-added">172         Address regionStart = null;</span>
<span class="line-added">173         Address regionEnd = null;</span>
<span class="line-added">174         while (AddressOps.lessThan(start, end)) {</span>
<span class="line-added">175             long size = getObjectSize(start);</span>
<span class="line-added">176             if (hasForwardee(start)) {</span>
<span class="line-added">177                 // has to-space object, skip this one</span>
<span class="line-added">178                 if (regionEnd != null) {</span>
<span class="line-added">179                     MemRegion mr = new MemRegion(regionStart, regionEnd);</span>
<span class="line-added">180                     res.add(mr);</span>
<span class="line-added">181                     regionStart = null;</span>
<span class="line-added">182                     regionEnd = null;</span>
<span class="line-added">183                 }</span>
<span class="line-added">184             } else {</span>
<span class="line-added">185                 if (regionStart == null) {</span>
<span class="line-added">186                     regionStart = start;</span>
<span class="line-added">187                 } else {</span>
<span class="line-added">188                     regionEnd = start.addOffsetTo(size);</span>
<span class="line-added">189                 }</span>
<span class="line-added">190             }</span>
<span class="line-added">191             start = start.addOffsetTo(size);</span>
<span class="line-added">192         }</span>
<span class="line-added">193 </span>
<span class="line-added">194         if (regionStart != null) {</span>
<span class="line-added">195             MemRegion mr = new MemRegion(regionStart, top());</span>
<span class="line-added">196             res.add(mr);</span>
<span class="line-added">197         }</span>
<span class="line-added">198     }</span>
<span class="line-added">199 </span>
<span class="line-added">200     public long regionNumber() {</span>
<span class="line-added">201         return RegionNumberField.getValue(addr);</span>
<span class="line-added">202     }</span>
<span class="line-added">203 </span>
<span class="line-added">204     private boolean hasForwardee(Address rawPtr) {</span>
<span class="line-added">205         // Forwarding pointer is stored in mark word when it is flagged &quot;marked&quot;</span>
<span class="line-added">206         Mark mark = new Mark(rawPtr);</span>
<span class="line-added">207         return mark.isMarked();</span>
<span class="line-added">208     }</span>
<span class="line-added">209 </span>
<span class="line-added">210     private long getObjectSize(Address rawPtr) {</span>
<span class="line-added">211         OopHandle handle = rawPtr.addOffsetToAsOopHandle(0);</span>
<span class="line-added">212         Oop obj = null;</span>
<span class="line-added">213 </span>
<span class="line-added">214         try {</span>
<span class="line-added">215             // Best effort, may fail</span>
<span class="line-added">216             obj = VM.getVM().getObjectHeap().newOop(handle);</span>
<span class="line-added">217         } catch (UnknownOopException exp) {</span>
<span class="line-added">218             throw new RuntimeException(&quot; UnknownOopException  &quot; + exp);</span>
<span class="line-added">219         }</span>
<span class="line-added">220         return obj.getObjectSize();</span>
<span class="line-added">221     }</span>
222 }
</pre>
</td>
</tr>
</table>
<center><a href="ShenandoahHeap.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../z/ZHeap.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>