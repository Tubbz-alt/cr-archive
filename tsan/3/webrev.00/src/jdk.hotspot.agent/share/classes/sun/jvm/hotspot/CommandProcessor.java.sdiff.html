<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/CommandProcessor.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../module-info.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HotSpotTypeDataBase.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/CommandProcessor.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 519                     // only nmethod, Method, MethodData and InstanceKlass needed to
 520                     // dump replay data
 521 
 522                     CodeBlob cb = VM.getVM().getCodeCache().findBlob(a);
 523                     if (cb != null &amp;&amp; (cb instanceof NMethod)) {
 524                         ((NMethod)cb).dumpReplayData(out);
 525                         return;
 526                     }
 527                     // assume it is Metadata
 528                     Metadata meta = Metadata.instantiateWrapperFor(a);
 529                     if (meta != null) {
 530                         meta.dumpReplayData(out);
 531                     } else {
 532                         usage();
 533                         return;
 534                     }
 535                 }
 536                 // Not an address
 537                 boolean all = name.equals(&quot;-a&quot;);
 538                 Threads threads = VM.getVM().getThreads();
<span class="line-modified"> 539                 for (JavaThread thread = threads.first(); thread != null; thread = thread.next()) {</span>

 540                     ByteArrayOutputStream bos = new ByteArrayOutputStream();
 541                     thread.printThreadIDOn(new PrintStream(bos));
 542                     if (all || bos.toString().equals(name)) {
 543                         if (thread instanceof CompilerThread) {
 544                             CompilerThread ct = (CompilerThread)thread;
 545                             ciEnv env = ct.env();
 546                             if (env != null) {
 547                                env.dumpReplayData(out);
 548                             }
 549                         }
 550                     }
 551                 }
 552             }
 553         },
 554         new Command(&quot;buildreplayjars&quot;, &quot;buildreplayjars [ all | app | boot ]  | [ prefix ]&quot;, false) {
 555             // This is used to dump jar files of all the classes
 556             // loaded in the core.  Everything with null classloader
 557             // will go in boot.jar and everything else will go in
 558             // app.jar. boot.jar usually not needed, unless changed by jvmti.
 559             public void doit(Tokens t) {
</pre>
<hr />
<pre>
 881                                         Method m = methods.at(i);
 882                                         HTMLGenerator gen = new HTMLGenerator(false);
 883                                         out.println(gen.genHTML(m));
 884                                     }
 885                                 }
 886                             }
 887                         }
 888                         );
 889                 }
 890             }
 891         },
 892         new Command(&quot;dumpideal&quot;, &quot;dumpideal { -a | id }&quot;, false) {
 893             // Do a full dump of the nodes reachabile from root in each compiler thread.
 894             public void doit(Tokens t) {
 895                 if (t.countTokens() != 1) {
 896                     usage();
 897                 } else {
 898                     String name = t.nextToken();
 899                     boolean all = name.equals(&quot;-a&quot;);
 900                     Threads threads = VM.getVM().getThreads();
<span class="line-modified"> 901                     for (JavaThread thread = threads.first(); thread != null; thread = thread.next()) {</span>

 902                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
 903                         thread.printThreadIDOn(new PrintStream(bos));
 904                         if (all || bos.toString().equals(name)) {
 905                           if (thread instanceof CompilerThread) {
 906                             CompilerThread ct = (CompilerThread)thread;
 907                             out.println(ct);
 908                             ciEnv env = ct.env();
 909                             if (env != null) {
 910                               Compile c = env.compilerData();
 911                               c.root().dump(9999, out);
 912                             } else {
 913                               out.println(&quot;  not compiling&quot;);
 914                             }
 915                           }
 916                         }
 917                     }
 918                 }
 919             }
 920         },
 921         new Command(&quot;dumpcfg&quot;, &quot;dumpcfg { -a | id }&quot;, false) {
 922             // Dump the PhaseCFG for every compiler thread that has one live.
 923             public void doit(Tokens t) {
 924                 if (t.countTokens() != 1) {
 925                     usage();
 926                 } else {
 927                     String name = t.nextToken();
 928                     boolean all = name.equals(&quot;-a&quot;);
 929                     Threads threads = VM.getVM().getThreads();
<span class="line-modified"> 930                     for (JavaThread thread = threads.first(); thread != null; thread = thread.next()) {</span>

 931                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
 932                         thread.printThreadIDOn(new PrintStream(bos));
 933                         if (all || bos.toString().equals(name)) {
 934                           if (thread instanceof CompilerThread) {
 935                             CompilerThread ct = (CompilerThread)thread;
 936                             out.println(ct);
 937                             ciEnv env = ct.env();
 938                             if (env != null) {
 939                               Compile c = env.compilerData();
 940                               c.cfg().dump(out);
 941                             }
 942                           }
 943                         }
 944                     }
 945                 }
 946             }
 947         },
 948         new Command(&quot;dumpilt&quot;, &quot;dumpilt { -a | id }&quot;, false) {
 949             // dumps the InlineTree of a C2 compile
 950             public void doit(Tokens t) {
 951                 if (t.countTokens() != 1) {
 952                     usage();
 953                 } else {
 954                     String name = t.nextToken();
 955                     boolean all = name.equals(&quot;-a&quot;);
 956                     Threads threads = VM.getVM().getThreads();
<span class="line-modified"> 957                     for (JavaThread thread = threads.first(); thread != null; thread = thread.next()) {</span>

 958                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
 959                         thread.printThreadIDOn(new PrintStream(bos));
 960                         if (all || bos.toString().equals(name)) {
 961                             if (thread instanceof CompilerThread) {
 962                                 CompilerThread ct = (CompilerThread)thread;
 963                                 ciEnv env = ct.env();
 964                                 if (env != null) {
 965                                     Compile c = env.compilerData();
 966                                     InlineTree ilt = c.ilt();
 967                                     if (ilt != null) {
 968                                         ilt.print(out);
 969                                     }
 970                                 }
 971                             }
 972                         }
 973                     }
 974                 }
 975             }
 976         },
 977         new Command(&quot;vmstructsdump&quot;, &quot;vmstructsdump&quot;, false) {
</pre>
<hr />
<pre>
1420                     if (verboseExceptions) {
1421                         e.printStackTrace(out);
1422                     }
1423                 } finally {
1424                     in = savedInput;
1425                 }
1426 
1427             }
1428         },
1429         new Command(&quot;search&quot;, &quot;search [ heap | perm | rawheap | codecache | threads ] value&quot;, false) {
1430             public void doit(Tokens t) {
1431                 if (t.countTokens() != 2) {
1432                     usage();
1433                     return;
1434                 }
1435                 String type = t.nextToken();
1436                 final Address value = VM.getVM().getDebugger().parseAddress(t.nextToken());
1437                 final long stride = VM.getVM().getAddressSize();
1438                 if (type.equals(&quot;threads&quot;)) {
1439                     Threads threads = VM.getVM().getThreads();
<span class="line-modified">1440                     for (JavaThread thread = threads.first(); thread != null; thread = thread.next()) {</span>

1441                         Address base = thread.getStackBase();
1442                         Address end = thread.getLastJavaSP();
1443                         if (end == null) continue;
1444                         if (end.lessThan(base)) {
1445                             Address tmp = base;
1446                             base = end;
1447                             end = tmp;
1448                         }
1449                         //out.println(&quot;Searching &quot; + base + &quot; &quot; + end);
1450                         while (base != null &amp;&amp; base.lessThan(end)) {
1451                             Address val = base.getAddressAt(0);
1452                             if (AddressOps.equal(val, value)) {
1453                                 ByteArrayOutputStream bos = new ByteArrayOutputStream();
1454                                 thread.printThreadIDOn(new PrintStream(bos));
1455                                 out.println(&quot;found on the stack of thread &quot; + bos.toString() + &quot; at &quot; + base);
1456                             }
1457                             base = base.addOffsetTo(stride);
1458                         }
1459                     }
1460                 } else if (type.equals(&quot;rawheap&quot;)) {
</pre>
<hr />
<pre>
1544                             public void visit(CodeBlob blob) {
1545                                 fout.println(gen.genHTML(blob.contentBegin()));
1546                             }
1547                             public void epilogue() {
1548                             }
1549 
1550 
1551                         };
1552                     VM.getVM().getCodeCache().iterate(v);
1553                 }
1554             }
1555         },
1556         new Command(&quot;where&quot;, &quot;where { -a | id }&quot;, false) {
1557             public void doit(Tokens t) {
1558                 if (t.countTokens() != 1) {
1559                     usage();
1560                 } else {
1561                     String name = t.nextToken();
1562                     Threads threads = VM.getVM().getThreads();
1563                     boolean all = name.equals(&quot;-a&quot;);
<span class="line-modified">1564                     for (JavaThread thread = threads.first(); thread != null; thread = thread.next()) {</span>

1565                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
1566                         thread.printThreadIDOn(new PrintStream(bos));
1567                         if (all || bos.toString().equals(name)) {
1568                             out.println(&quot;Thread &quot; + bos.toString() + &quot; Address: &quot; + thread.getAddress());
1569                             HTMLGenerator gen = new HTMLGenerator(false);
1570                             try {
1571                                 out.println(gen.genHTMLForJavaStackTrace(thread));
1572                             } catch (Exception e) {
1573                                 err.println(&quot;Error: &quot; + e);
1574                                 if (verboseExceptions) {
1575                                     e.printStackTrace(err);
1576                                 }
1577                             }
1578                             if (!all) return;
1579                         }
1580                     }
1581                     if (!all) out.println(&quot;Couldn&#39;t find thread &quot; + name);
1582                 }
1583             }
1584         },
1585         new Command(&quot;thread&quot;, &quot;thread { -a | id }&quot;, false) {
1586             public void doit(Tokens t) {
1587                 if (t.countTokens() != 1) {
1588                     usage();
1589                 } else {
1590                     String name = t.nextToken();
1591                     Threads threads = VM.getVM().getThreads();
1592                     boolean all = name.equals(&quot;-a&quot;);
<span class="line-modified">1593                     for (JavaThread thread = threads.first(); thread != null; thread = thread.next()) {</span>

1594                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
1595                         thread.printThreadIDOn(new PrintStream(bos));
1596                         if (all || bos.toString().equals(name)) {
1597                             out.println(&quot;Thread &quot; + bos.toString() + &quot; Address &quot; + thread.getAddress());
1598                             thread.printInfoOn(out);
1599                             out.println(&quot; &quot;);
1600                             if (!all) return;
1601                         }
1602                     }
1603                     if (!all) {
1604                         out.println(&quot;Couldn&#39;t find thread &quot; + name);
1605                     }
1606                 }
1607             }
1608         },
1609 
1610         new Command(&quot;threads&quot;, false) {
1611             public void doit(Tokens t) {
1612                 if (t.countTokens() != 0) {
1613                     usage();
1614                 } else {
1615                     Threads threads = VM.getVM().getThreads();
<span class="line-modified">1616                     for (JavaThread thread = threads.first(); thread != null; thread = thread.next()) {</span>

1617                         thread.printThreadIDOn(out);
1618                         out.println(&quot; &quot; + thread.getThreadName());
1619                         thread.printInfoOn(out);
1620                         out.println(&quot;\n...&quot;);
1621                     }
1622                 }
1623             }
1624         },
1625 
1626         new Command(&quot;livenmethods&quot;, false) {
1627             public void doit(Tokens t) {
1628                 if (t.countTokens() != 0) {
1629                     usage();
1630                 } else {
1631                     ArrayList nmethods = new ArrayList();
1632                     Threads threads = VM.getVM().getThreads();
1633                     HTMLGenerator gen = new HTMLGenerator(false);
<span class="line-modified">1634                     for (JavaThread thread = threads.first(); thread != null; thread = thread.next()) {</span>

1635                         try {
1636                             for (JavaVFrame vf = thread.getLastJavaVFrameDbg(); vf != null; vf = vf.javaSender()) {
1637                                 if (vf instanceof CompiledVFrame) {
1638                                     NMethod c = ((CompiledVFrame)vf).getCode();
1639                                     if (!nmethods.contains(c)) {
1640                                         nmethods.add(c);
1641                                         out.println(gen.genHTML(c));
1642                                     }
1643                                 }
1644                             }
1645                         } catch (Exception e) {
1646                             e.printStackTrace();
1647                         }
1648                     }
1649                 }
1650             }
1651         },
1652         new Command(&quot;g1regiondetails&quot;, false) {
1653             public void doit(Tokens t) {
1654                 if (t.countTokens() != 0) {
</pre>
<hr />
<pre>
1705     }
1706 
1707     public void printPrompt() {
1708         out.print(&quot;hsdb&gt; &quot;);
1709     }
1710 
1711     private DebuggerInterface debugger;
1712     private HotSpotAgent agent;
1713     private JSJavaScriptEngine jsengine;
1714     private BufferedReader in;
1715     private PrintStream out;
1716     private PrintStream err;
1717 
1718     // called before debuggee attach
1719     private void preAttach() {
1720         // nothing for now..
1721     }
1722 
1723     // called after debuggee attach
1724     private void postAttach() {


1725         // create JavaScript engine and start it
1726         try {
1727             jsengine = new JSJavaScriptEngine() {
1728                         private ObjectReader reader = new ObjectReader();
1729                         private JSJavaFactory factory = new JSJavaFactoryImpl();
1730                         public ObjectReader getObjectReader() {
1731                             return reader;
1732                         }
1733                         public JSJavaFactory getJSJavaFactory() {
1734                             return factory;
1735                         }
1736                         protected void quit() {
1737                             debugger.detach();
1738                             quit = true;
1739                         }
1740                         protected BufferedReader getInputReader() {
1741                             return in;
1742                         }
1743                         protected PrintStream getOutputStream() {
1744                             return out;
</pre>
<hr />
<pre>
1748                         }
1749                    };
1750             try {
1751                 jsengine.defineFunction(this,
1752                      this.getClass().getMethod(&quot;registerCommand&quot;,
1753                                 new Class[] {
1754                                      String.class, String.class, String.class
1755                                 }));
1756             } catch (NoSuchMethodException exp) {
1757                   // should not happen, see below...!!
1758                   exp.printStackTrace();
1759             }
1760             jsengine.start();
1761         }
1762         catch (Exception ex) {
1763             System.out.println(&quot;Warning! JS Engine can&#39;t start, some commands will not be available.&quot;);
1764             if (verboseExceptions) {
1765                 ex.printStackTrace(out);
1766             }
1767         }

1768     }
1769 
1770     public void registerCommand(String cmd, String usage, final String func) {
1771         commands.put(cmd, new Command(cmd, usage, false) {
1772                               public void doit(Tokens t) {
1773                                   final int len = t.countTokens();
1774                                   Object[] args = new Object[len];
1775                                   for (int i = 0; i &lt; len; i++) {
1776                                       args[i] = t.nextToken();
1777                                   }
1778                                   jsengine.call(func, args);
1779                               }
1780                           });
1781     }
1782 
1783     public void setOutput(PrintStream o) {
1784         out = o;
1785     }
1786 
1787     public void setErr(PrintStream e) {
</pre>
</td>
<td>
<hr />
<pre>
 519                     // only nmethod, Method, MethodData and InstanceKlass needed to
 520                     // dump replay data
 521 
 522                     CodeBlob cb = VM.getVM().getCodeCache().findBlob(a);
 523                     if (cb != null &amp;&amp; (cb instanceof NMethod)) {
 524                         ((NMethod)cb).dumpReplayData(out);
 525                         return;
 526                     }
 527                     // assume it is Metadata
 528                     Metadata meta = Metadata.instantiateWrapperFor(a);
 529                     if (meta != null) {
 530                         meta.dumpReplayData(out);
 531                     } else {
 532                         usage();
 533                         return;
 534                     }
 535                 }
 536                 // Not an address
 537                 boolean all = name.equals(&quot;-a&quot;);
 538                 Threads threads = VM.getVM().getThreads();
<span class="line-modified"> 539                 for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="line-added"> 540                     JavaThread thread = threads.getJavaThreadAt(i);</span>
 541                     ByteArrayOutputStream bos = new ByteArrayOutputStream();
 542                     thread.printThreadIDOn(new PrintStream(bos));
 543                     if (all || bos.toString().equals(name)) {
 544                         if (thread instanceof CompilerThread) {
 545                             CompilerThread ct = (CompilerThread)thread;
 546                             ciEnv env = ct.env();
 547                             if (env != null) {
 548                                env.dumpReplayData(out);
 549                             }
 550                         }
 551                     }
 552                 }
 553             }
 554         },
 555         new Command(&quot;buildreplayjars&quot;, &quot;buildreplayjars [ all | app | boot ]  | [ prefix ]&quot;, false) {
 556             // This is used to dump jar files of all the classes
 557             // loaded in the core.  Everything with null classloader
 558             // will go in boot.jar and everything else will go in
 559             // app.jar. boot.jar usually not needed, unless changed by jvmti.
 560             public void doit(Tokens t) {
</pre>
<hr />
<pre>
 882                                         Method m = methods.at(i);
 883                                         HTMLGenerator gen = new HTMLGenerator(false);
 884                                         out.println(gen.genHTML(m));
 885                                     }
 886                                 }
 887                             }
 888                         }
 889                         );
 890                 }
 891             }
 892         },
 893         new Command(&quot;dumpideal&quot;, &quot;dumpideal { -a | id }&quot;, false) {
 894             // Do a full dump of the nodes reachabile from root in each compiler thread.
 895             public void doit(Tokens t) {
 896                 if (t.countTokens() != 1) {
 897                     usage();
 898                 } else {
 899                     String name = t.nextToken();
 900                     boolean all = name.equals(&quot;-a&quot;);
 901                     Threads threads = VM.getVM().getThreads();
<span class="line-modified"> 902                     for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="line-added"> 903                         JavaThread thread = threads.getJavaThreadAt(i);</span>
 904                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
 905                         thread.printThreadIDOn(new PrintStream(bos));
 906                         if (all || bos.toString().equals(name)) {
 907                           if (thread instanceof CompilerThread) {
 908                             CompilerThread ct = (CompilerThread)thread;
 909                             out.println(ct);
 910                             ciEnv env = ct.env();
 911                             if (env != null) {
 912                               Compile c = env.compilerData();
 913                               c.root().dump(9999, out);
 914                             } else {
 915                               out.println(&quot;  not compiling&quot;);
 916                             }
 917                           }
 918                         }
 919                     }
 920                 }
 921             }
 922         },
 923         new Command(&quot;dumpcfg&quot;, &quot;dumpcfg { -a | id }&quot;, false) {
 924             // Dump the PhaseCFG for every compiler thread that has one live.
 925             public void doit(Tokens t) {
 926                 if (t.countTokens() != 1) {
 927                     usage();
 928                 } else {
 929                     String name = t.nextToken();
 930                     boolean all = name.equals(&quot;-a&quot;);
 931                     Threads threads = VM.getVM().getThreads();
<span class="line-modified"> 932                     for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="line-added"> 933                         JavaThread thread = threads.getJavaThreadAt(i);</span>
 934                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
 935                         thread.printThreadIDOn(new PrintStream(bos));
 936                         if (all || bos.toString().equals(name)) {
 937                           if (thread instanceof CompilerThread) {
 938                             CompilerThread ct = (CompilerThread)thread;
 939                             out.println(ct);
 940                             ciEnv env = ct.env();
 941                             if (env != null) {
 942                               Compile c = env.compilerData();
 943                               c.cfg().dump(out);
 944                             }
 945                           }
 946                         }
 947                     }
 948                 }
 949             }
 950         },
 951         new Command(&quot;dumpilt&quot;, &quot;dumpilt { -a | id }&quot;, false) {
 952             // dumps the InlineTree of a C2 compile
 953             public void doit(Tokens t) {
 954                 if (t.countTokens() != 1) {
 955                     usage();
 956                 } else {
 957                     String name = t.nextToken();
 958                     boolean all = name.equals(&quot;-a&quot;);
 959                     Threads threads = VM.getVM().getThreads();
<span class="line-modified"> 960                     for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="line-added"> 961                         JavaThread thread = threads.getJavaThreadAt(i);</span>
 962                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
 963                         thread.printThreadIDOn(new PrintStream(bos));
 964                         if (all || bos.toString().equals(name)) {
 965                             if (thread instanceof CompilerThread) {
 966                                 CompilerThread ct = (CompilerThread)thread;
 967                                 ciEnv env = ct.env();
 968                                 if (env != null) {
 969                                     Compile c = env.compilerData();
 970                                     InlineTree ilt = c.ilt();
 971                                     if (ilt != null) {
 972                                         ilt.print(out);
 973                                     }
 974                                 }
 975                             }
 976                         }
 977                     }
 978                 }
 979             }
 980         },
 981         new Command(&quot;vmstructsdump&quot;, &quot;vmstructsdump&quot;, false) {
</pre>
<hr />
<pre>
1424                     if (verboseExceptions) {
1425                         e.printStackTrace(out);
1426                     }
1427                 } finally {
1428                     in = savedInput;
1429                 }
1430 
1431             }
1432         },
1433         new Command(&quot;search&quot;, &quot;search [ heap | perm | rawheap | codecache | threads ] value&quot;, false) {
1434             public void doit(Tokens t) {
1435                 if (t.countTokens() != 2) {
1436                     usage();
1437                     return;
1438                 }
1439                 String type = t.nextToken();
1440                 final Address value = VM.getVM().getDebugger().parseAddress(t.nextToken());
1441                 final long stride = VM.getVM().getAddressSize();
1442                 if (type.equals(&quot;threads&quot;)) {
1443                     Threads threads = VM.getVM().getThreads();
<span class="line-modified">1444                     for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="line-added">1445                         JavaThread thread = threads.getJavaThreadAt(i);</span>
1446                         Address base = thread.getStackBase();
1447                         Address end = thread.getLastJavaSP();
1448                         if (end == null) continue;
1449                         if (end.lessThan(base)) {
1450                             Address tmp = base;
1451                             base = end;
1452                             end = tmp;
1453                         }
1454                         //out.println(&quot;Searching &quot; + base + &quot; &quot; + end);
1455                         while (base != null &amp;&amp; base.lessThan(end)) {
1456                             Address val = base.getAddressAt(0);
1457                             if (AddressOps.equal(val, value)) {
1458                                 ByteArrayOutputStream bos = new ByteArrayOutputStream();
1459                                 thread.printThreadIDOn(new PrintStream(bos));
1460                                 out.println(&quot;found on the stack of thread &quot; + bos.toString() + &quot; at &quot; + base);
1461                             }
1462                             base = base.addOffsetTo(stride);
1463                         }
1464                     }
1465                 } else if (type.equals(&quot;rawheap&quot;)) {
</pre>
<hr />
<pre>
1549                             public void visit(CodeBlob blob) {
1550                                 fout.println(gen.genHTML(blob.contentBegin()));
1551                             }
1552                             public void epilogue() {
1553                             }
1554 
1555 
1556                         };
1557                     VM.getVM().getCodeCache().iterate(v);
1558                 }
1559             }
1560         },
1561         new Command(&quot;where&quot;, &quot;where { -a | id }&quot;, false) {
1562             public void doit(Tokens t) {
1563                 if (t.countTokens() != 1) {
1564                     usage();
1565                 } else {
1566                     String name = t.nextToken();
1567                     Threads threads = VM.getVM().getThreads();
1568                     boolean all = name.equals(&quot;-a&quot;);
<span class="line-modified">1569                     for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="line-added">1570                         JavaThread thread = threads.getJavaThreadAt(i);</span>
1571                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
1572                         thread.printThreadIDOn(new PrintStream(bos));
1573                         if (all || bos.toString().equals(name)) {
1574                             out.println(&quot;Thread &quot; + bos.toString() + &quot; Address: &quot; + thread.getAddress());
1575                             HTMLGenerator gen = new HTMLGenerator(false);
1576                             try {
1577                                 out.println(gen.genHTMLForJavaStackTrace(thread));
1578                             } catch (Exception e) {
1579                                 err.println(&quot;Error: &quot; + e);
1580                                 if (verboseExceptions) {
1581                                     e.printStackTrace(err);
1582                                 }
1583                             }
1584                             if (!all) return;
1585                         }
1586                     }
1587                     if (!all) out.println(&quot;Couldn&#39;t find thread &quot; + name);
1588                 }
1589             }
1590         },
1591         new Command(&quot;thread&quot;, &quot;thread { -a | id }&quot;, false) {
1592             public void doit(Tokens t) {
1593                 if (t.countTokens() != 1) {
1594                     usage();
1595                 } else {
1596                     String name = t.nextToken();
1597                     Threads threads = VM.getVM().getThreads();
1598                     boolean all = name.equals(&quot;-a&quot;);
<span class="line-modified">1599                     for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="line-added">1600                         JavaThread thread = threads.getJavaThreadAt(i);</span>
1601                         ByteArrayOutputStream bos = new ByteArrayOutputStream();
1602                         thread.printThreadIDOn(new PrintStream(bos));
1603                         if (all || bos.toString().equals(name)) {
1604                             out.println(&quot;Thread &quot; + bos.toString() + &quot; Address &quot; + thread.getAddress());
1605                             thread.printInfoOn(out);
1606                             out.println(&quot; &quot;);
1607                             if (!all) return;
1608                         }
1609                     }
1610                     if (!all) {
1611                         out.println(&quot;Couldn&#39;t find thread &quot; + name);
1612                     }
1613                 }
1614             }
1615         },
1616 
1617         new Command(&quot;threads&quot;, false) {
1618             public void doit(Tokens t) {
1619                 if (t.countTokens() != 0) {
1620                     usage();
1621                 } else {
1622                     Threads threads = VM.getVM().getThreads();
<span class="line-modified">1623                     for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="line-added">1624                         JavaThread thread = threads.getJavaThreadAt(i);</span>
1625                         thread.printThreadIDOn(out);
1626                         out.println(&quot; &quot; + thread.getThreadName());
1627                         thread.printInfoOn(out);
1628                         out.println(&quot;\n...&quot;);
1629                     }
1630                 }
1631             }
1632         },
1633 
1634         new Command(&quot;livenmethods&quot;, false) {
1635             public void doit(Tokens t) {
1636                 if (t.countTokens() != 0) {
1637                     usage();
1638                 } else {
1639                     ArrayList nmethods = new ArrayList();
1640                     Threads threads = VM.getVM().getThreads();
1641                     HTMLGenerator gen = new HTMLGenerator(false);
<span class="line-modified">1642                     for (int i = 0; i &lt; threads.getNumberOfThreads(); i++) {</span>
<span class="line-added">1643                         JavaThread thread = threads.getJavaThreadAt(i);</span>
1644                         try {
1645                             for (JavaVFrame vf = thread.getLastJavaVFrameDbg(); vf != null; vf = vf.javaSender()) {
1646                                 if (vf instanceof CompiledVFrame) {
1647                                     NMethod c = ((CompiledVFrame)vf).getCode();
1648                                     if (!nmethods.contains(c)) {
1649                                         nmethods.add(c);
1650                                         out.println(gen.genHTML(c));
1651                                     }
1652                                 }
1653                             }
1654                         } catch (Exception e) {
1655                             e.printStackTrace();
1656                         }
1657                     }
1658                 }
1659             }
1660         },
1661         new Command(&quot;g1regiondetails&quot;, false) {
1662             public void doit(Tokens t) {
1663                 if (t.countTokens() != 0) {
</pre>
<hr />
<pre>
1714     }
1715 
1716     public void printPrompt() {
1717         out.print(&quot;hsdb&gt; &quot;);
1718     }
1719 
1720     private DebuggerInterface debugger;
1721     private HotSpotAgent agent;
1722     private JSJavaScriptEngine jsengine;
1723     private BufferedReader in;
1724     private PrintStream out;
1725     private PrintStream err;
1726 
1727     // called before debuggee attach
1728     private void preAttach() {
1729         // nothing for now..
1730     }
1731 
1732     // called after debuggee attach
1733     private void postAttach() {
<span class="line-added">1734         /*</span>
<span class="line-added">1735          * JavaScript engine no longer works. For now disable it. Eventually we will remove it.</span>
1736         // create JavaScript engine and start it
1737         try {
1738             jsengine = new JSJavaScriptEngine() {
1739                         private ObjectReader reader = new ObjectReader();
1740                         private JSJavaFactory factory = new JSJavaFactoryImpl();
1741                         public ObjectReader getObjectReader() {
1742                             return reader;
1743                         }
1744                         public JSJavaFactory getJSJavaFactory() {
1745                             return factory;
1746                         }
1747                         protected void quit() {
1748                             debugger.detach();
1749                             quit = true;
1750                         }
1751                         protected BufferedReader getInputReader() {
1752                             return in;
1753                         }
1754                         protected PrintStream getOutputStream() {
1755                             return out;
</pre>
<hr />
<pre>
1759                         }
1760                    };
1761             try {
1762                 jsengine.defineFunction(this,
1763                      this.getClass().getMethod(&quot;registerCommand&quot;,
1764                                 new Class[] {
1765                                      String.class, String.class, String.class
1766                                 }));
1767             } catch (NoSuchMethodException exp) {
1768                   // should not happen, see below...!!
1769                   exp.printStackTrace();
1770             }
1771             jsengine.start();
1772         }
1773         catch (Exception ex) {
1774             System.out.println(&quot;Warning! JS Engine can&#39;t start, some commands will not be available.&quot;);
1775             if (verboseExceptions) {
1776                 ex.printStackTrace(out);
1777             }
1778         }
<span class="line-added">1779         */</span>
1780     }
1781 
1782     public void registerCommand(String cmd, String usage, final String func) {
1783         commands.put(cmd, new Command(cmd, usage, false) {
1784                               public void doit(Tokens t) {
1785                                   final int len = t.countTokens();
1786                                   Object[] args = new Object[len];
1787                                   for (int i = 0; i &lt; len; i++) {
1788                                       args[i] = t.nextToken();
1789                                   }
1790                                   jsengine.call(func, args);
1791                               }
1792                           });
1793     }
1794 
1795     public void setOutput(PrintStream o) {
1796         out = o;
1797     }
1798 
1799     public void setErr(PrintStream e) {
</pre>
</td>
</tr>
</table>
<center><a href="../../../module-info.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HotSpotTypeDataBase.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>