<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/gc/shenandoah/ShenandoahHeapRegion.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ShenandoahHeap.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../z/ZHeap.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/gc/shenandoah/ShenandoahHeapRegion.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,8 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2017, 2018, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2017, 2019, Red Hat, Inc. All rights reserved.</span>
<span class="udiff-line-added">+  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span>
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -21,37 +22,201 @@</span>
   *
   */
  
  package sun.jvm.hotspot.gc.shenandoah;
  
<span class="udiff-line-added">+ import sun.jvm.hotspot.debugger.OopHandle;</span>
  import sun.jvm.hotspot.gc.shared.ContiguousSpace;
<span class="udiff-line-modified-removed">- import sun.jvm.hotspot.types.CIntegerField;</span>
<span class="udiff-line-modified-added">+ import sun.jvm.hotspot.gc.shared.LiveRegionsProvider;</span>
<span class="udiff-line-added">+ import sun.jvm.hotspot.memory.MemRegion;</span>
<span class="udiff-line-added">+ import sun.jvm.hotspot.oops.Mark;</span>
<span class="udiff-line-added">+ import sun.jvm.hotspot.oops.Oop;</span>
<span class="udiff-line-added">+ import sun.jvm.hotspot.oops.UnknownOopException;</span>
<span class="udiff-line-added">+ import sun.jvm.hotspot.types.*;</span>
  import sun.jvm.hotspot.runtime.VM;
<span class="udiff-line-removed">- import sun.jvm.hotspot.types.Type;</span>
<span class="udiff-line-removed">- import sun.jvm.hotspot.types.TypeDataBase;</span>
  import sun.jvm.hotspot.debugger.Address;
<span class="udiff-line-added">+ import sun.jvm.hotspot.utilities.AddressOps;</span>
  
<span class="udiff-line-added">+ import java.util.ArrayList;</span>
<span class="udiff-line-added">+ import java.util.List;</span>
  import java.util.Observable;
  import java.util.Observer;
  
  
<span class="udiff-line-modified-removed">- public class ShenandoahHeapRegion extends ContiguousSpace {</span>
<span class="udiff-line-modified-removed">-     private static CIntegerField RegionSizeBytes;</span>
<span class="udiff-line-modified-added">+ public class ShenandoahHeapRegion extends ContiguousSpace implements LiveRegionsProvider {</span>
<span class="udiff-line-modified-added">+     private static int EmptyUncommitted;</span>
<span class="udiff-line-added">+     private static int EmptyCommitted;</span>
<span class="udiff-line-added">+     private static int Regular;</span>
<span class="udiff-line-added">+     private static int HumongousStart;</span>
<span class="udiff-line-added">+     private static int HumongousCont;</span>
<span class="udiff-line-added">+     private static int PinnedHumongousStart;</span>
<span class="udiff-line-added">+     private static int CSet;</span>
<span class="udiff-line-added">+     private static int Pinned;</span>
<span class="udiff-line-added">+     private static int PinnedCSet;</span>
<span class="udiff-line-added">+     private static int Trash;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static CIntegerField RegionSizeBytesField;</span>
<span class="udiff-line-added">+     private static Field         RegionStateField;</span>
<span class="udiff-line-added">+     private static CIntegerField RegionNumberField;</span>
<span class="udiff-line-added">+     private static CIntegerField RegionSizeBytesShiftField;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private ShenandoahHeap heap;</span>
<span class="udiff-line-added">+ </span>
      static {
          VM.registerVMInitializedObserver(new Observer() {
              public void update(Observable o, Object data) {
                  initialize(VM.getVM().getTypeDataBase());
              }
          });
      }
  
      static private synchronized void initialize(TypeDataBase db) {
          Type type = db.lookupType(&quot;ShenandoahHeapRegion&quot;);
<span class="udiff-line-modified-removed">-         RegionSizeBytes = type.getCIntegerField(&quot;RegionSizeBytes&quot;);</span>
<span class="udiff-line-modified-added">+         RegionSizeBytesField = type.getCIntegerField(&quot;RegionSizeBytes&quot;);</span>
<span class="udiff-line-added">+         RegionStateField = type.getField(&quot;_state&quot;);</span>
<span class="udiff-line-added">+         RegionNumberField = type.getCIntegerField(&quot;_region_number&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         RegionSizeBytesShiftField = type.getCIntegerField(&quot;RegionSizeBytesShift&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         EmptyUncommitted     = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_empty_uncommitted&quot;).intValue();</span>
<span class="udiff-line-added">+         EmptyCommitted       = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_empty_committed&quot;).intValue();</span>
<span class="udiff-line-added">+         Regular              = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_regular&quot;).intValue();</span>
<span class="udiff-line-added">+         HumongousStart       = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_humongous_start&quot;).intValue();</span>
<span class="udiff-line-added">+         HumongousCont        = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_humongous_cont&quot;).intValue();</span>
<span class="udiff-line-added">+         PinnedHumongousStart = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_pinned_humongous_start&quot;).intValue();</span>
<span class="udiff-line-added">+         CSet                 = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_cset&quot;).intValue();</span>
<span class="udiff-line-added">+         Pinned               = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_pinned&quot;).intValue();</span>
<span class="udiff-line-added">+         PinnedCSet           = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_pinned_cset&quot;).intValue();</span>
<span class="udiff-line-added">+         Trash                = db.lookupIntConstant(&quot;ShenandoahHeapRegion::_trash&quot;).intValue();</span>
      }
  
<span class="udiff-line-modified-removed">-     public static long regionSizeBytes() { return RegionSizeBytes.getValue(); }</span>
<span class="udiff-line-modified-added">+     public static long regionSizeBytes() {</span>
<span class="udiff-line-added">+         return RegionSizeBytesField.getValue();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static int  regionSizeBytesShift() {</span>
<span class="udiff-line-added">+         return RegionSizeBytesShiftField.getJInt();</span>
<span class="udiff-line-added">+     }</span>
  
      public ShenandoahHeapRegion(Address addr) {
          super(addr);
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public void setHeap(ShenandoahHeap heap) {</span>
<span class="udiff-line-added">+         this.heap = heap;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public int hashCode() {</span>
<span class="udiff-line-added">+         return (int)regionNumber();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public boolean equals(Object other) {</span>
<span class="udiff-line-added">+         if (other instanceof ShenandoahHeapRegion) {</span>
<span class="udiff-line-added">+             ShenandoahHeapRegion otherRegion = (ShenandoahHeapRegion)other;</span>
<span class="udiff-line-added">+             return otherRegion.regionNumber() == regionNumber();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public List&lt;MemRegion&gt; getLiveRegions() {</span>
<span class="udiff-line-added">+         List&lt;MemRegion&gt; res = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-added">+         int state = regionState();</span>
<span class="udiff-line-added">+         if (state == EmptyUncommitted || state == EmptyCommitted || state == Trash) {</span>
<span class="udiff-line-added">+             // No live data</span>
<span class="udiff-line-added">+         } else if (state == HumongousCont) {</span>
<span class="udiff-line-added">+             // Handled by HumongousStart</span>
<span class="udiff-line-added">+         } else if (state == HumongousStart || state == PinnedHumongousStart) {</span>
<span class="udiff-line-added">+             handleHumongousRegion(res);</span>
<span class="udiff-line-added">+         } else if (state == Regular || state == Pinned) {</span>
<span class="udiff-line-added">+             handleRegularRegion(res);</span>
<span class="udiff-line-added">+         } else if (state == CSet || state == PinnedCSet) {</span>
<span class="udiff-line-added">+             // CSet</span>
<span class="udiff-line-added">+             handleCSetRegion(res);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot;Unknown region state: &quot; + state);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return res;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * Note: RegionState is an enum on JVM side. Seems that there is not</span>
<span class="udiff-line-added">+      *       a standard way to read enum value. We read it as an integer</span>
<span class="udiff-line-added">+      *       from the field&#39;s offset.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private int regionState() {</span>
<span class="udiff-line-added">+         long offset = RegionStateField.getOffset();</span>
<span class="udiff-line-added">+         return addr.getJIntAt(offset);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void handleHumongousRegion(List&lt;MemRegion&gt; res) {</span>
<span class="udiff-line-added">+         long index = regionNumber();</span>
<span class="udiff-line-added">+         Address topAddr = top();</span>
<span class="udiff-line-added">+         ShenandoahHeapRegion region = heap.getRegion(++ index);</span>
<span class="udiff-line-added">+         while (region.regionState() == HumongousCont) {</span>
<span class="udiff-line-added">+             topAddr = region.top();</span>
<span class="udiff-line-added">+             region = heap.getRegion(++ index);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         res.add(new MemRegion(bottom(), topAddr));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void handleRegularRegion(List&lt;MemRegion&gt; res) {</span>
<span class="udiff-line-added">+         res.add(new MemRegion(bottom(), top()));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Filter out forwarded objects, they should be counted in other regions</span>
<span class="udiff-line-added">+     private void handleCSetRegion(List&lt;MemRegion&gt; res) {</span>
<span class="udiff-line-added">+         Address end = top();</span>
<span class="udiff-line-added">+         Address start = bottom();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Address regionStart = null;</span>
<span class="udiff-line-added">+         Address regionEnd = null;</span>
<span class="udiff-line-added">+         while (AddressOps.lessThan(start, end)) {</span>
<span class="udiff-line-added">+             long size = getObjectSize(start);</span>
<span class="udiff-line-added">+             if (hasForwardee(start)) {</span>
<span class="udiff-line-added">+                 // has to-space object, skip this one</span>
<span class="udiff-line-added">+                 if (regionEnd != null) {</span>
<span class="udiff-line-added">+                     MemRegion mr = new MemRegion(regionStart, regionEnd);</span>
<span class="udiff-line-added">+                     res.add(mr);</span>
<span class="udiff-line-added">+                     regionStart = null;</span>
<span class="udiff-line-added">+                     regionEnd = null;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 if (regionStart == null) {</span>
<span class="udiff-line-added">+                     regionStart = start;</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     regionEnd = start.addOffsetTo(size);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             start = start.addOffsetTo(size);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (regionStart != null) {</span>
<span class="udiff-line-added">+             MemRegion mr = new MemRegion(regionStart, top());</span>
<span class="udiff-line-added">+             res.add(mr);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public long regionNumber() {</span>
<span class="udiff-line-added">+         return RegionNumberField.getValue(addr);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private boolean hasForwardee(Address rawPtr) {</span>
<span class="udiff-line-added">+         // Forwarding pointer is stored in mark word when it is flagged &quot;marked&quot;</span>
<span class="udiff-line-added">+         Mark mark = new Mark(rawPtr);</span>
<span class="udiff-line-added">+         return mark.isMarked();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private long getObjectSize(Address rawPtr) {</span>
<span class="udiff-line-added">+         OopHandle handle = rawPtr.addOffsetToAsOopHandle(0);</span>
<span class="udiff-line-added">+         Oop obj = null;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             // Best effort, may fail</span>
<span class="udiff-line-added">+             obj = VM.getVM().getObjectHeap().newOop(handle);</span>
<span class="udiff-line-added">+         } catch (UnknownOopException exp) {</span>
<span class="udiff-line-added">+             throw new RuntimeException(&quot; UnknownOopException  &quot; + exp);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return obj.getObjectSize();</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="ShenandoahHeap.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../z/ZHeap.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>