<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/memory/FileMapInfo.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../gc/z/ZPageAllocator.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Universe.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/memory/FileMapInfo.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -30,19 +30,18 @@</span>
  import sun.jvm.hotspot.runtime.VMObject;
  import sun.jvm.hotspot.runtime.VMObjectFactory;
  import sun.jvm.hotspot.types.*;
  
  public class FileMapInfo {
<span class="udiff-line-modified-removed">-   private static FileMapHeader header;</span>
<span class="udiff-line-removed">-   private static Address headerValue;</span>
<span class="udiff-line-modified-added">+   private static FileMapHeader headerObj;</span>
  
<span class="udiff-line-modified-removed">-   // Fields for class FileMapHeader</span>
<span class="udiff-line-modified-removed">-   private static Address mdSpaceValue;</span>
<span class="udiff-line-modified-removed">-   private static Address mdRegionBaseAddress;</span>
<span class="udiff-line-modified-removed">-   private static Address mdRegionEndAddress;</span>
<span class="udiff-line-modified-added">+   // Fields for handling the copied C++ vtables</span>
<span class="udiff-line-modified-added">+   private static Address mcRegionBaseAddress;</span>
<span class="udiff-line-modified-added">+   private static Address mcRegionEndAddress;</span>
<span class="udiff-line-modified-added">+   private static Address vtablesStartAddress;</span>
  
<span class="udiff-line-modified-removed">-   // HashMap created by mapping the vTable addresses in the md region with</span>
<span class="udiff-line-modified-added">+   // HashMap created by mapping the vTable addresses in the mc region with</span>
    // the corresponding metadata type.
    private static Map&lt;Address, Type&gt; vTableTypeMap;
  
    private static Type metadataTypeArray[];
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -52,31 +51,63 @@</span>
            initialize(VM.getVM().getTypeDataBase());
          }
        });
    }
  
<span class="udiff-line-added">+   static Address getStatic_AddressField(Type type, String fieldName) {</span>
<span class="udiff-line-added">+     AddressField field = type.getAddressField(fieldName);</span>
<span class="udiff-line-added">+     return field.getValue();</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   static Address get_AddressField(Type type, Address instance, String fieldName) {</span>
<span class="udiff-line-added">+     AddressField field = type.getAddressField(fieldName);</span>
<span class="udiff-line-added">+     return field.getValue(instance);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   static long get_CIntegerField(Type type, Address instance, String fieldName) {</span>
<span class="udiff-line-added">+     CIntegerField field = type.getCIntegerField(fieldName);</span>
<span class="udiff-line-added">+     return field.getValue(instance);</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   // C equivalent:   return &amp;header-&gt;_space[index];</span>
<span class="udiff-line-added">+   static Address get_CDSFileMapRegion(Type FileMapHeader_type, Address header, int index) {</span>
<span class="udiff-line-added">+     AddressField spaceField = FileMapHeader_type.getAddressField(&quot;_space[0]&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // size_t offset = offsetof(FileMapHeader, _space[0]);</span>
<span class="udiff-line-added">+     // CDSFileMapRegion* space_0 = ((char*)header) + offset; // space_0 = &amp;header-&gt;_space[index];</span>
<span class="udiff-line-added">+     // return ((char*)space_0) + index * sizeof(CDSFileMapRegion);</span>
<span class="udiff-line-added">+     long offset = spaceField.getOffset();</span>
<span class="udiff-line-added">+     Address space_0 = header.addOffsetTo(offset);</span>
<span class="udiff-line-added">+     return space_0.addOffsetTo(index * spaceField.getSize());</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+ </span>
    private static void initialize(TypeDataBase db) {
<span class="udiff-line-modified-removed">-     // FileMapInfo</span>
<span class="udiff-line-modified-removed">-     Type type = db.lookupType(&quot;FileMapInfo&quot;);</span>
<span class="udiff-line-modified-removed">-     AddressField currentInfoField = type.getAddressField(&quot;_current_info&quot;);</span>
<span class="udiff-line-modified-removed">-     long headerFieldOffset = type.getField(&quot;_header&quot;).getOffset();</span>
<span class="udiff-line-modified-removed">-     Address headerAddress = currentInfoField.getValue().addOffsetTo(headerFieldOffset);</span>
<span class="udiff-line-modified-removed">-     headerValue = headerAddress.getAddressAt(0);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     // FileMapHeader</span>
<span class="udiff-line-modified-removed">-     type = db.lookupType(&quot;FileMapHeader&quot;);</span>
<span class="udiff-line-modified-removed">-     AddressField spaceField = type.getAddressField(&quot;_space[0]&quot;);</span>
<span class="udiff-line-modified-removed">-     Address spaceValue = headerValue.addOffsetTo(type.getField(&quot;_space[0]&quot;).getOffset());</span>
<span class="udiff-line-modified-removed">-     mdSpaceValue = spaceValue.addOffsetTo(3 * spaceField.getSize());</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     // SpaceInfo</span>
<span class="udiff-line-modified-removed">-     type = db.lookupType(&quot;CDSFileMapRegion&quot;);</span>
<span class="udiff-line-modified-removed">-     long mdRegionBaseAddressOffset = type.getField(&quot;_addr._base&quot;).getOffset();</span>
<span class="udiff-line-modified-removed">-     mdRegionBaseAddress = (mdSpaceValue.addOffsetTo(mdRegionBaseAddressOffset)).getAddressAt(0);</span>
<span class="udiff-line-modified-removed">-     long mdRegionSizeOffset = type.getField(&quot;_used&quot;).getOffset();</span>
<span class="udiff-line-modified-removed">-     long mdRegionSize = (mdSpaceValue.addOffsetTo(mdRegionSizeOffset)).getAddressAt(0).asLongValue();</span>
<span class="udiff-line-modified-removed">-     mdRegionEndAddress = mdRegionBaseAddress.addOffsetTo(mdRegionSize);</span>
<span class="udiff-line-modified-added">+     Type FileMapInfo_type = db.lookupType(&quot;FileMapInfo&quot;);</span>
<span class="udiff-line-modified-added">+     Type FileMapHeader_type = db.lookupType(&quot;FileMapHeader&quot;);</span>
<span class="udiff-line-modified-added">+     Type CDSFileMapRegion_type = db.lookupType(&quot;CDSFileMapRegion&quot;);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     // FileMapInfo * info = FileMapInfo::_current_info;</span>
<span class="udiff-line-modified-added">+     // FileMapHeader* header = info-&gt;_header</span>
<span class="udiff-line-modified-added">+     Address info = getStatic_AddressField(FileMapInfo_type, &quot;_current_info&quot;);</span>
<span class="udiff-line-modified-added">+     Address header = get_AddressField(FileMapInfo_type, info, &quot;_header&quot;);</span>
<span class="udiff-line-modified-added">+     headerObj = (FileMapHeader) VMObjectFactory.newObject(FileMapInfo.FileMapHeader.class, header);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     // char* mapped_base_address = header-&gt;_mapped_base_address</span>
<span class="udiff-line-modified-added">+     // size_t cloned_vtable_offset = header-&gt;_cloned_vtable_offset</span>
<span class="udiff-line-modified-added">+     // char* vtablesStartAddress = mapped_base_address + cloned_vtable_offset;</span>
<span class="udiff-line-modified-added">+     Address mapped_base_address = get_AddressField(FileMapHeader_type, header, &quot;_mapped_base_address&quot;);</span>
<span class="udiff-line-modified-added">+     long cloned_vtable_offset = get_CIntegerField(FileMapHeader_type, header, &quot;_cloned_vtables_offset&quot;);</span>
<span class="udiff-line-modified-added">+     vtablesStartAddress = mapped_base_address.addOffsetTo(cloned_vtable_offset);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     // CDSFileMapRegion* mc_space = &amp;header-&gt;_space[mc];</span>
<span class="udiff-line-modified-added">+     // char* mcRegionBaseAddress = mc_space-&gt;_mapped_base;</span>
<span class="udiff-line-modified-added">+     // size_t used = mc_space-&gt;_used;</span>
<span class="udiff-line-added">+     // char* mcRegionEndAddress = mcRegionBaseAddress + used;</span>
<span class="udiff-line-added">+     Address mc_space = get_CDSFileMapRegion(FileMapHeader_type, header, 0);</span>
<span class="udiff-line-added">+     mcRegionBaseAddress = get_AddressField(CDSFileMapRegion_type, mc_space, &quot;_mapped_base&quot;);</span>
<span class="udiff-line-added">+     long used = get_CIntegerField(CDSFileMapRegion_type, mc_space, &quot;_used&quot;);</span>
<span class="udiff-line-added">+     mcRegionEndAddress = mcRegionBaseAddress.addOffsetTo(used);</span>
  
      populateMetadataTypeArray(db);
    }
  
    private static void populateMetadataTypeArray(TypeDataBase db) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -91,14 +122,11 @@</span>
      metadataTypeArray[6] = db.lookupType(&quot;ObjArrayKlass&quot;);
      metadataTypeArray[7] = db.lookupType(&quot;TypeArrayKlass&quot;);
    }
  
    public FileMapHeader getHeader() {
<span class="udiff-line-modified-removed">-     if (header == null) {</span>
<span class="udiff-line-removed">-       header = (FileMapHeader) VMObjectFactory.newObject(FileMapInfo.FileMapHeader.class, headerValue);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     return header;</span>
<span class="udiff-line-modified-added">+     return headerObj;</span>
    }
  
    public boolean inCopiedVtableSpace(Address vptrAddress) {
      FileMapHeader fmHeader = getHeader();
      return fmHeader.inCopiedVtableSpace(vptrAddress);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -119,23 +147,23 @@</span>
      public FileMapHeader(Address addr) {
        super(addr);
      }
  
      public boolean inCopiedVtableSpace(Address vptrAddress) {
<span class="udiff-line-modified-removed">-       if (vptrAddress.greaterThan(mdRegionBaseAddress) &amp;&amp;</span>
<span class="udiff-line-modified-removed">-           vptrAddress.lessThanOrEqual(mdRegionEndAddress)) {</span>
<span class="udiff-line-modified-added">+       if (vptrAddress.greaterThan(mcRegionBaseAddress) &amp;&amp;</span>
<span class="udiff-line-modified-added">+           vptrAddress.lessThanOrEqual(mcRegionEndAddress)) {</span>
          return true;
        }
        return false;
      }
  
      public void createVtableTypeMapping() {
        vTableTypeMap = new HashMap&lt;Address, Type&gt;();
        long metadataVTableSize = 0;
        long addressSize = VM.getVM().getAddressSize();
  
<span class="udiff-line-modified-removed">-       Address copiedVtableAddress = mdRegionBaseAddress;</span>
<span class="udiff-line-modified-added">+       Address copiedVtableAddress = vtablesStartAddress;</span>
        for (int i=0; i &lt; metadataTypeArray.length; i++) {
          // The first entry denotes the vtable size.
          metadataVTableSize = copiedVtableAddress.getAddressAt(0).asLongValue();
          vTableTypeMap.put(copiedVtableAddress.addOffsetTo(addressSize), metadataTypeArray[i]);
  
</pre>
<center><a href="../gc/z/ZPageAllocator.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Universe.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>