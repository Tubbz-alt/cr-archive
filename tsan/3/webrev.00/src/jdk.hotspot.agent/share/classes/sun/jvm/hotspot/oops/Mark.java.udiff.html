<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/oops/Mark.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DataLayout.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ObjectHeap.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/oops/Mark.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2001, 2008, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -30,16 +30,10 @@</span>
  import sun.jvm.hotspot.debugger.*;
  import sun.jvm.hotspot.runtime.*;
  import sun.jvm.hotspot.types.*;
  import sun.jvm.hotspot.utilities.*;
  
<span class="udiff-line-removed">- /** Mark is the analogue of the VM&#39;s markOop. In this system it does</span>
<span class="udiff-line-removed">-     not subclass Oop but VMObject. For a mark on the stack, the mark&#39;s</span>
<span class="udiff-line-removed">-     address will be an Address; for a mark in the header of an object,</span>
<span class="udiff-line-removed">-     it will be an OopHandle. It is assumed in a couple of places in</span>
<span class="udiff-line-removed">-     this code that the mark is the first word in an object. */</span>
<span class="udiff-line-removed">- </span>
  public class Mark extends VMObject {
    static {
      VM.registerVMInitializedObserver(new Observer() {
          public void update(Observable o, Object data) {
            initialize(VM.getVM().getTypeDataBase());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -49,43 +43,38 @@</span>
  
    private static synchronized void initialize(TypeDataBase db) throws WrongTypeException {
      Type type  = db.lookupType(&quot;oopDesc&quot;);
      markField  = type.getCIntegerField(&quot;_mark&quot;);
  
<span class="udiff-line-modified-removed">-     ageBits             = db.lookupLongConstant(&quot;markOopDesc::age_bits&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     lockBits            = db.lookupLongConstant(&quot;markOopDesc::lock_bits&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     biasedLockBits      = db.lookupLongConstant(&quot;markOopDesc::biased_lock_bits&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     maxHashBits         = db.lookupLongConstant(&quot;markOopDesc::max_hash_bits&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     hashBits            = db.lookupLongConstant(&quot;markOopDesc::hash_bits&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     lockShift           = db.lookupLongConstant(&quot;markOopDesc::lock_shift&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     biasedLockShift     = db.lookupLongConstant(&quot;markOopDesc::biased_lock_shift&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     ageShift            = db.lookupLongConstant(&quot;markOopDesc::age_shift&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     hashShift           = db.lookupLongConstant(&quot;markOopDesc::hash_shift&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     lockMask            = db.lookupLongConstant(&quot;markOopDesc::lock_mask&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     lockMaskInPlace     = db.lookupLongConstant(&quot;markOopDesc::lock_mask_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     biasedLockMask      = db.lookupLongConstant(&quot;markOopDesc::biased_lock_mask&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     biasedLockMaskInPlace  = db.lookupLongConstant(&quot;markOopDesc::biased_lock_mask_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     biasedLockBitInPlace  = db.lookupLongConstant(&quot;markOopDesc::biased_lock_bit_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     ageMask             = db.lookupLongConstant(&quot;markOopDesc::age_mask&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     ageMaskInPlace      = db.lookupLongConstant(&quot;markOopDesc::age_mask_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     hashMask            = db.lookupLongConstant(&quot;markOopDesc::hash_mask&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     hashMaskInPlace     = db.lookupLongConstant(&quot;markOopDesc::hash_mask_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     biasedLockAlignment  = db.lookupLongConstant(&quot;markOopDesc::biased_lock_alignment&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     lockedValue         = db.lookupLongConstant(&quot;markOopDesc::locked_value&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     unlockedValue       = db.lookupLongConstant(&quot;markOopDesc::unlocked_value&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     monitorValue        = db.lookupLongConstant(&quot;markOopDesc::monitor_value&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     markedValue         = db.lookupLongConstant(&quot;markOopDesc::marked_value&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     biasedLockPattern = db.lookupLongConstant(&quot;markOopDesc::biased_lock_pattern&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     noHash              = db.lookupLongConstant(&quot;markOopDesc::no_hash&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     noHashInPlace       = db.lookupLongConstant(&quot;markOopDesc::no_hash_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     noLockInPlace       = db.lookupLongConstant(&quot;markOopDesc::no_lock_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-removed">-     maxAge              = db.lookupLongConstant(&quot;markOopDesc::max_age&quot;).longValue();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /* Constants in markOop used by CMS. */</span>
<span class="udiff-line-removed">-     cmsShift            = db.lookupLongConstant(&quot;markOopDesc::cms_shift&quot;).longValue();</span>
<span class="udiff-line-removed">-     cmsMask             = db.lookupLongConstant(&quot;markOopDesc::cms_mask&quot;).longValue();</span>
<span class="udiff-line-removed">-     sizeShift           = db.lookupLongConstant(&quot;markOopDesc::size_shift&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     ageBits             = db.lookupLongConstant(&quot;markWord::age_bits&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     lockBits            = db.lookupLongConstant(&quot;markWord::lock_bits&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     biasedLockBits      = db.lookupLongConstant(&quot;markWord::biased_lock_bits&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     maxHashBits         = db.lookupLongConstant(&quot;markWord::max_hash_bits&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     hashBits            = db.lookupLongConstant(&quot;markWord::hash_bits&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     lockShift           = db.lookupLongConstant(&quot;markWord::lock_shift&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     biasedLockShift     = db.lookupLongConstant(&quot;markWord::biased_lock_shift&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     ageShift            = db.lookupLongConstant(&quot;markWord::age_shift&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     hashShift           = db.lookupLongConstant(&quot;markWord::hash_shift&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     lockMask            = db.lookupLongConstant(&quot;markWord::lock_mask&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     lockMaskInPlace     = db.lookupLongConstant(&quot;markWord::lock_mask_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     biasedLockMask      = db.lookupLongConstant(&quot;markWord::biased_lock_mask&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     biasedLockMaskInPlace  = db.lookupLongConstant(&quot;markWord::biased_lock_mask_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     biasedLockBitInPlace  = db.lookupLongConstant(&quot;markWord::biased_lock_bit_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     ageMask             = db.lookupLongConstant(&quot;markWord::age_mask&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     ageMaskInPlace      = db.lookupLongConstant(&quot;markWord::age_mask_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     hashMask            = db.lookupLongConstant(&quot;markWord::hash_mask&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     hashMaskInPlace     = db.lookupLongConstant(&quot;markWord::hash_mask_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     biasedLockAlignment  = db.lookupLongConstant(&quot;markWord::biased_lock_alignment&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     lockedValue         = db.lookupLongConstant(&quot;markWord::locked_value&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     unlockedValue       = db.lookupLongConstant(&quot;markWord::unlocked_value&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     monitorValue        = db.lookupLongConstant(&quot;markWord::monitor_value&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     markedValue         = db.lookupLongConstant(&quot;markWord::marked_value&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     biasedLockPattern = db.lookupLongConstant(&quot;markWord::biased_lock_pattern&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     noHash              = db.lookupLongConstant(&quot;markWord::no_hash&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     noHashInPlace       = db.lookupLongConstant(&quot;markWord::no_hash_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     noLockInPlace       = db.lookupLongConstant(&quot;markWord::no_lock_in_place&quot;).longValue();</span>
<span class="udiff-line-modified-added">+     maxAge              = db.lookupLongConstant(&quot;markWord::max_age&quot;).longValue();</span>
    }
  
    // Field accessors
    private static CIntegerField markField;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,11 +112,11 @@</span>
    private static long noHashInPlace;
    private static long noLockInPlace;
  
    private static long maxAge;
  
<span class="udiff-line-modified-removed">-   /* Constants in markOop used by CMS. */</span>
<span class="udiff-line-modified-added">+   /* Constants in markWord used by CMS. */</span>
    private static long cmsShift;
    private static long cmsMask;
    private static long sizeShift;
  
    public Mark(Address addr) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -173,11 +162,11 @@</span>
    }
    public boolean isMarked() {
      return (Bits.maskBitsLong(value(), lockMaskInPlace) == markedValue);
    }
  
<span class="udiff-line-modified-removed">-   // Special temporary state of the markOop while being inflated.</span>
<span class="udiff-line-modified-added">+   // Special temporary state of the markWord while being inflated.</span>
    // Code that looks at mark outside a lock need to take this into account.
    public boolean isBeingInflated() {
      return (value() == 0);
    }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -186,16 +175,12 @@</span>
       return (!isUnlocked() || !hasNoHash());
    }
  
    // WARNING: The following routines are used EXCLUSIVELY by
    // synchronization functions. They are not really gc safe.
<span class="udiff-line-modified-removed">-   // They must get updated if markOop layout get changed.</span>
<span class="udiff-line-modified-added">+   // They must get updated if markWord layout get changed.</span>
  
<span class="udiff-line-removed">-   // FIXME</span>
<span class="udiff-line-removed">-   //  markOop set_unlocked() const {</span>
<span class="udiff-line-removed">-   //    return markOop(value() | unlocked_value);</span>
<span class="udiff-line-removed">-   //  }</span>
    public boolean hasLocker() {
      return ((value() &amp; lockMaskInPlace) == lockedValue);
    }
    public BasicLock locker() {
      if (Assert.ASSERTS_ENABLED) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -222,64 +207,21 @@</span>
        Assert.that(hasDisplacedMarkHelper(), &quot;check&quot;);
      }
      Address addr = valueAsAddress().andWithMask(~monitorValue);
      return new Mark(addr.getAddressAt(0));
    }
<span class="udiff-line-removed">-   // FIXME</span>
<span class="udiff-line-removed">-   //  void set_displaced_mark_helper(markOop m) const {</span>
<span class="udiff-line-removed">-   //    assert(has_displaced_mark_helper(), &quot;check&quot;);</span>
<span class="udiff-line-removed">-   //    intptr_t ptr = (value() &amp; ~monitor_value);</span>
<span class="udiff-line-removed">-   //    *(markOop*)ptr = m;</span>
<span class="udiff-line-removed">-   //  }</span>
<span class="udiff-line-removed">-   //  markOop copy_set_hash(intptr_t hash) const {</span>
<span class="udiff-line-removed">-   //    intptr_t tmp = value() &amp; (~hash_mask_in_place);</span>
<span class="udiff-line-removed">-   //    tmp |= ((hash &amp; hash_mask) &lt;&lt; hash_shift);</span>
<span class="udiff-line-removed">-   //    return (markOop)tmp;</span>
<span class="udiff-line-removed">-   //  }</span>
<span class="udiff-line-removed">-   // it is only used to be stored into BasicLock as the</span>
<span class="udiff-line-removed">-   // indicator that the lock is using heavyweight monitor</span>
<span class="udiff-line-removed">-   //  static markOop unused_mark() {</span>
<span class="udiff-line-removed">-   //    return (markOop) marked_value;</span>
<span class="udiff-line-removed">-   //  }</span>
<span class="udiff-line-removed">-   //  // the following two functions create the markOop to be</span>
<span class="udiff-line-removed">-   //  // stored into object header, it encodes monitor info</span>
<span class="udiff-line-removed">-   //  static markOop encode(BasicLock* lock) {</span>
<span class="udiff-line-removed">-   //    return (markOop) lock;</span>
<span class="udiff-line-removed">-   //  }</span>
<span class="udiff-line-removed">-   //  static markOop encode(ObjectMonitor* monitor) {</span>
<span class="udiff-line-removed">-   //    intptr_t tmp = (intptr_t) monitor;</span>
<span class="udiff-line-removed">-   //    return (markOop) (tmp | monitor_value);</span>
<span class="udiff-line-removed">-   //  }</span>
<span class="udiff-line-removed">-   // used for alignment-based marking to reuse the busy state to encode pointers</span>
<span class="udiff-line-removed">-   // (see markOop_alignment.hpp)</span>
<span class="udiff-line-removed">-   //  markOop clear_lock_bits() { return markOop(value() &amp; ~lock_mask_in_place); }</span>
<span class="udiff-line-removed">-   //</span>
<span class="udiff-line-removed">-   //  // age operations</span>
<span class="udiff-line-removed">-   //  markOop set_marked()   { return markOop((value() &amp; ~lock_mask_in_place) | marked_value); }</span>
<span class="udiff-line-removed">-   //</span>
    public int age() { return (int) Bits.maskBitsLong(value() &gt;&gt; ageShift, ageMask); }
<span class="udiff-line-removed">-   //  markOop set_age(int v) const {</span>
<span class="udiff-line-removed">-   //    assert((v &amp; ~age_mask) == 0, &quot;shouldn&#39;t overflow age field&quot;);</span>
<span class="udiff-line-removed">-   //    return markOop((value() &amp; ~age_mask_in_place) | (((intptr_t)v &amp; age_mask) &lt;&lt; age_shift));</span>
<span class="udiff-line-removed">-   //  }</span>
<span class="udiff-line-removed">-   //  markOop incr_age()          const { return age() == max_age ? markOop(this) : set_age(age() + 1); }</span>
  
    // hash operations
    public long hash() {
      return Bits.maskBitsLong(value() &gt;&gt; hashShift, hashMask);
    }
  
    public boolean hasNoHash() {
      return hash() == noHash;
    }
  
<span class="udiff-line-removed">-   // FIXME</span>
<span class="udiff-line-removed">-   // Prototype mark for initialization</span>
<span class="udiff-line-removed">-   //  static markOop prototype() {</span>
<span class="udiff-line-removed">-   //    return markOop( no_hash_in_place | no_lock_in_place );</span>
<span class="udiff-line-removed">-   //  }</span>
<span class="udiff-line-removed">- </span>
    // Debugging
    public void printOn(PrintStream tty) {
      if (isLocked()) {
        tty.print(&quot;locked(0x&quot; +
                  Long.toHexString(value()) + &quot;)-&gt;&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -292,18 +234,11 @@</span>
        tty.print(&quot;hash &quot; + Long.toHexString(hash()) + &quot;,&quot;);
        tty.print(&quot;age &quot; + age() + &quot;)&quot;);
      }
    }
  
<span class="udiff-line-modified-removed">-   // FIXME</span>
<span class="udiff-line-removed">-   //  // Prepare address of oop for placement into mark</span>
<span class="udiff-line-removed">-   //  inline static markOop encode_pointer_as_mark(void* p) { return markOop(p)-&gt;set_marked(); }</span>
<span class="udiff-line-removed">-   //</span>
<span class="udiff-line-removed">-   //  // Recover address of oop from encoded form used in mark</span>
<span class="udiff-line-removed">-   //  inline void* decode_pointer() { return clear_lock_bits(); }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   // Copy markOop methods for CMS here.</span>
<span class="udiff-line-modified-added">+   // Copy markWord methods for CMS here.</span>
    public boolean isCmsFreeChunk() {
      return isUnlocked() &amp;&amp;
             (Bits.maskBitsLong(value() &gt;&gt; cmsShift, cmsMask) &amp; 0x1L) == 0x1L;
    }
    public long getSize() { return (long)(value() &gt;&gt; sizeShift); }
</pre>
<center><a href="DataLayout.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ObjectHeap.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>