<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/jdk.hotspot.agent/share/classes/sun/jvm/hotspot/SALauncher.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2015, 2016, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 package sun.jvm.hotspot;
 26 
 27 import java.util.ArrayList;
 28 import java.util.Arrays;
 29 
 30 import sun.jvm.hotspot.tools.JStack;
 31 import sun.jvm.hotspot.tools.JMap;
 32 import sun.jvm.hotspot.tools.JInfo;
 33 import sun.jvm.hotspot.tools.JSnap;
 34 
 35 public class SALauncher {
 36 
 37     private static boolean launcherHelp() {
 38         System.out.println(&quot;    clhsdb       \tcommand line debugger&quot;);
 39         System.out.println(&quot;    debugd       \tdebug server&quot;);
 40         System.out.println(&quot;    hsdb         \tui debugger&quot;);
 41         System.out.println(&quot;    jstack --help\tto get more information&quot;);
 42         System.out.println(&quot;    jmap   --help\tto get more information&quot;);
 43         System.out.println(&quot;    jinfo  --help\tto get more information&quot;);
 44         System.out.println(&quot;    jsnap  --help\tto get more information&quot;);
 45         return false;
 46     }
 47 
 48     private static boolean commonHelp() {
 49         // --pid &lt;pid&gt;
 50         // --exe &lt;exe&gt;
 51         // --core &lt;core&gt;
 52         System.out.println(&quot;    --exe\texecutable image name&quot;);
 53         System.out.println(&quot;    --core\tpath to coredump&quot;);
 54         System.out.println(&quot;    --pid\tpid of process to attach&quot;);
 55         return false;
 56     }
 57 
 58     private static boolean debugdHelp() {
 59         // [options] &lt;pid&gt; [server-id]
 60         // [options] &lt;executable&gt; &lt;core&gt; [server-id]
 61         java.io.PrintStream out = System.out;
 62         out.print(&quot; [option] &lt;pid&gt; [server-id]&quot;);
 63         out.println(&quot;\t\t(to connect to a live java process)&quot;);
 64         out.print(&quot;   or  [option] &lt;executable&gt; &lt;core&gt; [server-id]&quot;);
 65         out.println(&quot;\t\t(to connect to a core file produced by &lt;executable&gt;)&quot;);
 66         out.print(&quot;\t\tserver-id is an optional unique id for this debug server, needed &quot;);
 67         out.println(&quot;\t\tif multiple debug servers are run on the same machine&quot;);
 68         out.println(&quot;where option includes:&quot;);
 69         out.println(&quot;   -h | -help\tto print this help message&quot;);
 70         return false;
 71     }
 72 
 73     private static boolean jinfoHelp() {
 74         // --flags -&gt; -flags
 75         // --sysprops -&gt; -sysprops
 76         System.out.println(&quot;    --flags\tto print VM flags&quot;);
 77         System.out.println(&quot;    --sysprops\tto print Java System properties&quot;);
 78         System.out.println(&quot;    &lt;no option&gt;\tto print both of the above&quot;);
 79         return commonHelp();
 80     }
 81 
 82     private static boolean jmapHelp() {
 83         // --heap -&gt; -heap
 84         // --binaryheap -&gt; -heap:format=b
 85         // --histo -&gt; -histo
 86         // --clstats -&gt; -clstats
 87         // --finalizerinfo -&gt; -finalizerinfo
 88 
 89         System.out.println(&quot;    &lt;no option&gt;\tto print same info as Solaris pmap&quot;);
 90         System.out.println(&quot;    --heap\tto print java heap summary&quot;);
 91         System.out.println(&quot;    --binaryheap\tto dump java heap in hprof binary format&quot;);
 92         System.out.println(&quot;    --dumpfile\tname of the dump file&quot;);
 93         System.out.println(&quot;    --histo\tto print histogram of java object heap&quot;);
 94         System.out.println(&quot;    --clstats\tto print class loader statistics&quot;);
 95         System.out.println(&quot;    --finalizerinfo\tto print information on objects awaiting finalization&quot;);
 96         return commonHelp();
 97     }
 98 
 99     private static boolean jstackHelp() {
100         // --locks -&gt; -l
101         // --mixed -&gt; -m
102         System.out.println(&quot;    --locks\tto print java.util.concurrent locks&quot;);
103         System.out.println(&quot;    --mixed\tto print both java and native frames (mixed mode)&quot;);
104         return commonHelp();
105     }
106 
107     private static boolean jsnapHelp() {
108         System.out.println(&quot;    --all\tto print all performance counters&quot;);
109         return commonHelp();
110     }
111 
112     private static boolean toolHelp(String toolName) {
113         if (toolName.equals(&quot;jstack&quot;)) {
114             return jstackHelp();
115         }
116         if (toolName.equals(&quot;jinfo&quot;)) {
117             return jinfoHelp();
118         }
119         if (toolName.equals(&quot;jmap&quot;)) {
120             return jmapHelp();
121         }
122         if (toolName.equals(&quot;jsnap&quot;)) {
123             return jsnapHelp();
124         }
125         if (toolName.equals(&quot;debugd&quot;)) {
126             return debugdHelp();
127         }
128         if (toolName.equals(&quot;hsdb&quot;) || toolName.equals(&quot;clhsdb&quot;)) {
129             return commonHelp();
130         }
131         return launcherHelp();
132     }
133 
134     private static void buildAttachArgs(ArrayList&lt;String&gt; newArgs, String pid,
135                                   String exe, String core, boolean allowEmpty) {
136         if (!allowEmpty &amp;&amp; (pid == null) &amp;&amp; (exe == null)) {
137             throw new SAGetoptException(&quot;You have to set --pid or --exe.&quot;);
138         }
139 
140         if (pid != null) { // Attach to live process
141             if (exe != null) {
142                 throw new SAGetoptException(&quot;Unnecessary argument: --exe&quot;);
143             } else if (core != null) {
144                 throw new SAGetoptException(&quot;Unnecessary argument: --core&quot;);
145             } else if (!pid.matches(&quot;^\\d+$&quot;)) {
146                 throw new SAGetoptException(&quot;Invalid pid: &quot; + pid);
147             }
148 
149             newArgs.add(pid);
150         } else if (exe != null) {
151             if (exe.length() == 0) {
152                 throw new SAGetoptException(&quot;You have to set --exe.&quot;);
153             }
154 
155             newArgs.add(exe);
156 
157             if ((core == null) || (core.length() == 0)) {
158                 throw new SAGetoptException(&quot;You have to set --core.&quot;);
159             }
160 
161             newArgs.add(core);
162         }
163     }
164 
165     private static void runCLHSDB(String[] oldArgs) {
166         SAGetopt sg = new SAGetopt(oldArgs);
167         String[] longOpts = {&quot;exe=&quot;, &quot;core=&quot;, &quot;pid=&quot;};
168 
169         ArrayList&lt;String&gt; newArgs = new ArrayList();
170         String pid = null;
171         String exe = null;
172         String core = null;
173         String s = null;
174 
175         while((s = sg.next(null, longOpts)) != null) {
176             if (s.equals(&quot;exe&quot;)) {
177                 exe = sg.getOptarg();
178                 continue;
179             }
180             if (s.equals(&quot;core&quot;)) {
181                 core = sg.getOptarg();
182                 continue;
183             }
184             if (s.equals(&quot;pid&quot;)) {
185                 pid = sg.getOptarg();
186                 continue;
187             }
188         }
189 
190         buildAttachArgs(newArgs, pid, exe, core, true);
191         CLHSDB.main(newArgs.toArray(new String[newArgs.size()]));
192     }
193 
194     private static void runHSDB(String[] oldArgs) {
195         SAGetopt sg = new SAGetopt(oldArgs);
196         String[] longOpts = {&quot;exe=&quot;, &quot;core=&quot;, &quot;pid=&quot;};
197 
198         ArrayList&lt;String&gt; newArgs = new ArrayList();
199         String pid = null;
200         String exe = null;
201         String core = null;
202         String s = null;
203 
204         while((s = sg.next(null, longOpts)) != null) {
205             if (s.equals(&quot;exe&quot;)) {
206                 exe = sg.getOptarg();
207                 continue;
208             }
209             if (s.equals(&quot;core&quot;)) {
210                 core = sg.getOptarg();
211                 continue;
212             }
213             if (s.equals(&quot;pid&quot;)) {
214                 pid = sg.getOptarg();
215                 continue;
216             }
217         }
218 
219         buildAttachArgs(newArgs, pid, exe, core, true);
220         HSDB.main(newArgs.toArray(new String[newArgs.size()]));
221     }
222 
223     private static void runJSTACK(String[] oldArgs) {
224         SAGetopt sg = new SAGetopt(oldArgs);
225         String[] longOpts = {&quot;exe=&quot;, &quot;core=&quot;, &quot;pid=&quot;,
226                                  &quot;mixed&quot;, &quot;locks&quot;};
227 
228         ArrayList&lt;String&gt; newArgs = new ArrayList();
229         String pid = null;
230         String exe = null;
231         String core = null;
232         String s = null;
233 
234         while((s = sg.next(null, longOpts)) != null) {
235             if (s.equals(&quot;exe&quot;)) {
236                 exe = sg.getOptarg();
237                 continue;
238             }
239             if (s.equals(&quot;core&quot;)) {
240                 core = sg.getOptarg();
241                 continue;
242             }
243             if (s.equals(&quot;pid&quot;)) {
244                 pid = sg.getOptarg();
245                 continue;
246             }
247             if (s.equals(&quot;mixed&quot;)) {
248                 newArgs.add(&quot;-m&quot;);
249                 continue;
250             }
251             if (s.equals(&quot;locks&quot;)) {
252                 newArgs.add(&quot;-l&quot;);
253                 continue;
254             }
255         }
256 
257         buildAttachArgs(newArgs, pid, exe, core, false);
258         JStack jstack = new JStack(false, false);
259         jstack.runWithArgs(newArgs.toArray(new String[newArgs.size()]));
260     }
261 
262     private static void runJMAP(String[] oldArgs) {
263         SAGetopt sg = new SAGetopt(oldArgs);
264         String[] longOpts = {&quot;exe=&quot;, &quot;core=&quot;, &quot;pid=&quot;,
265               &quot;heap&quot;, &quot;binaryheap&quot;, &quot;dumpfile=&quot;, &quot;histo&quot;, &quot;clstats&quot;, &quot;finalizerinfo&quot;};
266 
267         ArrayList&lt;String&gt; newArgs = new ArrayList();
268         String pid = null;
269         String exe = null;
270         String core = null;
271         String s = null;
272         String dumpfile = null;
273         boolean requestHeapdump = false;
274 
275         while((s = sg.next(null, longOpts)) != null) {
276             if (s.equals(&quot;exe&quot;)) {
277                 exe = sg.getOptarg();
278                 continue;
279             }
280             if (s.equals(&quot;core&quot;)) {
281                 core = sg.getOptarg();
282                 continue;
283             }
284             if (s.equals(&quot;pid&quot;)) {
285                 pid = sg.getOptarg();
286                 continue;
287             }
288             if (s.equals(&quot;heap&quot;)) {
289                 newArgs.add(&quot;-heap&quot;);
290                 continue;
291             }
292             if (s.equals(&quot;binaryheap&quot;)) {
293                 requestHeapdump = true;
294                 continue;
295             }
296             if (s.equals(&quot;dumpfile&quot;)) {
297                 dumpfile = sg.getOptarg();
298                 continue;
299             }
300             if (s.equals(&quot;histo&quot;)) {
301                 newArgs.add(&quot;-histo&quot;);
302                 continue;
303             }
304             if (s.equals(&quot;clstats&quot;)) {
305                 newArgs.add(&quot;-clstats&quot;);
306                 continue;
307             }
308             if (s.equals(&quot;finalizerinfo&quot;)) {
309                 newArgs.add(&quot;-finalizerinfo&quot;);
310                 continue;
311             }
312         }
313 
314         if (!requestHeapdump &amp;&amp; (dumpfile != null)) {
315             throw new IllegalArgumentException(&quot;Unexpected argument dumpfile&quot;);
316         }
317         if (requestHeapdump) {
318             if (dumpfile == null) {
319                 newArgs.add(&quot;-heap:format=b&quot;);
320             } else {
321                 newArgs.add(&quot;-heap:format=b,file=&quot; + dumpfile);
322             }
323         }
324 
325         buildAttachArgs(newArgs, pid, exe, core, false);
326         JMap.main(newArgs.toArray(new String[newArgs.size()]));
327     }
328 
329     private static void runJINFO(String[] oldArgs) {
330         SAGetopt sg = new SAGetopt(oldArgs);
331         String[] longOpts = {&quot;exe=&quot;, &quot;core=&quot;, &quot;pid=&quot;,
332                                      &quot;flags&quot;, &quot;sysprops&quot;};
333 
334         ArrayList&lt;String&gt; newArgs = new ArrayList();
335         String exe = null;
336         String pid = null;
337         String core = null;
338         String s = null;
339 
340         while((s = sg.next(null, longOpts)) != null) {
341             if (s.equals(&quot;exe&quot;)) {
342                 exe = sg.getOptarg();
343                 continue;
344             }
345             if (s.equals(&quot;core&quot;)) {
346                 core = sg.getOptarg();
347                 continue;
348             }
349             if (s.equals(&quot;pid&quot;)) {
350                 pid = sg.getOptarg();
351                 continue;
352             }
353             if (s.equals(&quot;flags&quot;)) {
354                 newArgs.add(&quot;-flags&quot;);
355                 continue;
356             }
357             if (s.equals(&quot;sysprops&quot;)) {
358                 newArgs.add(&quot;-sysprops&quot;);
359                 continue;
360             }
361         }
362 
363         buildAttachArgs(newArgs, pid, exe, core, false);
364         JInfo.main(newArgs.toArray(new String[newArgs.size()]));
365     }
366 
367     private static void runJSNAP(String[] oldArgs) {
368         SAGetopt sg = new SAGetopt(oldArgs);
369         String[] longOpts = {&quot;exe=&quot;, &quot;core=&quot;, &quot;pid=&quot;, &quot;all&quot;};
370 
371         ArrayList&lt;String&gt; newArgs = new ArrayList();
372         String exe = null;
373         String pid = null;
374         String core = null;
375         String s = null;
376 
377         while((s = sg.next(null, longOpts)) != null) {
378             if (s.equals(&quot;exe&quot;)) {
379                 exe = sg.getOptarg();
380                 continue;
381             }
382             if (s.equals(&quot;core&quot;)) {
383                 core = sg.getOptarg();
384                 continue;
385             }
386             if (s.equals(&quot;pid&quot;)) {
387                 pid = sg.getOptarg();
388                 continue;
389             }
390             if (s.equals(&quot;all&quot;)) {
391                 newArgs.add(&quot;-a&quot;);
392                 continue;
393             }
394         }
395 
396         buildAttachArgs(newArgs, pid, exe, core, false);
397         JSnap.main(newArgs.toArray(new String[newArgs.size()]));
398     }
399 
400     private static void runDEBUGD(String[] oldArgs) {
401         if ((oldArgs.length &lt; 1) || (oldArgs.length &gt; 3)) {
402             debugdHelp();
403         }
404 
405         // By default SA agent classes prefer Windows process debugger
406         // to windbg debugger. SA expects special properties to be set
407         // to choose other debuggers. We will set those here before
408         // attaching to SA agent.
409         System.setProperty(&quot;sun.jvm.hotspot.debugger.useWindbgDebugger&quot;, &quot;true&quot;);
410 
411         // delegate to the actual SA debug server.
412         sun.jvm.hotspot.DebugServer.main(oldArgs);
413     }
414 
415     public static void main(String[] args) {
416         // Provide a help
417         if (args.length == 0) {
418             launcherHelp();
419             return;
420         }
421         // No arguments imply help for debugd, jstack, jmap, jinfo but launch clhsdb and hsdb
422         if (args.length == 1 &amp;&amp; !args[0].equals(&quot;clhsdb&quot;) &amp;&amp; !args[0].equals(&quot;hsdb&quot;)) {
423             toolHelp(args[0]);
424             return;
425         }
426 
427         for (String arg : args) {
428             if (arg.equals(&quot;-h&quot;) || arg.equals(&quot;-help&quot;) || arg.equals(&quot;--help&quot;)) {
429                 toolHelp(args[0]);
430                 return;
431             }
432         }
433 
434         String[] oldArgs = Arrays.copyOfRange(args, 1, args.length);
435 
436         try {
437             // Run SA interactive mode
438             if (args[0].equals(&quot;clhsdb&quot;)) {
439                 runCLHSDB(oldArgs);
440                 return;
441             }
442 
443             if (args[0].equals(&quot;hsdb&quot;)) {
444                 runHSDB(oldArgs);
445                 return;
446             }
447 
448             // Run SA tmtools mode
449             if (args[0].equals(&quot;jstack&quot;)) {
450                 runJSTACK(oldArgs);
451                 return;
452             }
453 
454             if (args[0].equals(&quot;jmap&quot;)) {
455                 runJMAP(oldArgs);
456                 return;
457             }
458 
459             if (args[0].equals(&quot;jinfo&quot;)) {
460                 runJINFO(oldArgs);
461                 return;
462             }
463 
464             if (args[0].equals(&quot;jsnap&quot;)) {
465                 runJSNAP(oldArgs);
466                 return;
467             }
468 
469             if (args[0].equals(&quot;debugd&quot;)) {
470                 runDEBUGD(oldArgs);
471                 return;
472             }
473 
474             throw new SAGetoptException(&quot;Unknown tool: &quot; + args[0]);
475         } catch (SAGetoptException e) {
476             System.err.println(e.getMessage());
477             toolHelp(args[0]);
478         }
479     }
480 }
    </pre>
  </body>
</html>