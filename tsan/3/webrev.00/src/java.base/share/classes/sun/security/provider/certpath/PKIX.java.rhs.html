<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/classes/sun/security/provider/certpath/PKIX.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package sun.security.provider.certpath;
 26 
 27 import java.security.InvalidAlgorithmParameterException;
 28 import java.security.PublicKey;
 29 import java.security.Timestamp;
 30 import java.security.cert.*;
 31 import java.security.interfaces.DSAPublicKey;
 32 import java.util.*;
 33 import javax.security.auth.x500.X500Principal;
 34 
 35 import sun.security.util.Debug;
 36 
 37 /**
 38  * Common utility methods and classes used by the PKIX CertPathValidator and
 39  * CertPathBuilder implementation.
 40  */
 41 class PKIX {
 42 
 43     private static final Debug debug = Debug.getInstance(&quot;certpath&quot;);
 44 
 45     private PKIX() { }
 46 
 47     static boolean isDSAPublicKeyWithoutParams(PublicKey publicKey) {
 48         return (publicKey instanceof DSAPublicKey &amp;&amp;
 49                ((DSAPublicKey)publicKey).getParams() == null);
 50     }
 51 
 52     static ValidatorParams checkParams(CertPath cp, CertPathParameters params)
 53         throws InvalidAlgorithmParameterException
 54     {
 55         if (!(params instanceof PKIXParameters)) {
 56             throw new InvalidAlgorithmParameterException(&quot;inappropriate &quot;
 57                 + &quot;params, must be an instance of PKIXParameters&quot;);
 58         }
 59         return new ValidatorParams(cp, (PKIXParameters)params);
 60     }
 61 
 62     static BuilderParams checkBuilderParams(CertPathParameters params)
 63         throws InvalidAlgorithmParameterException
 64     {
 65         if (!(params instanceof PKIXBuilderParameters)) {
 66             throw new InvalidAlgorithmParameterException(&quot;inappropriate &quot;
 67                 + &quot;params, must be an instance of PKIXBuilderParameters&quot;);
 68         }
 69         return new BuilderParams((PKIXBuilderParameters)params);
 70     }
 71 
 72     /**
 73      * PKIXParameters that are shared by the PKIX CertPathValidator
 74      * implementation. Provides additional functionality and avoids
 75      * unnecessary cloning.
 76      */
 77     static class ValidatorParams {
 78         private final PKIXParameters params;
 79         private CertPath certPath;
 80         private List&lt;PKIXCertPathChecker&gt; checkers;
 81         private List&lt;CertStore&gt; stores;
 82         private boolean gotDate;
 83         private Date date;
 84         private Set&lt;String&gt; policies;
 85         private boolean gotConstraints;
 86         private CertSelector constraints;
 87         private Set&lt;TrustAnchor&gt; anchors;
 88         private List&lt;X509Certificate&gt; certs;
 89         private Timestamp timestamp;
 90         private String variant;
 91 
 92         ValidatorParams(CertPath cp, PKIXParameters params)
 93             throws InvalidAlgorithmParameterException
 94         {
 95             this(params);
 96             if (!cp.getType().equals(&quot;X.509&quot;) &amp;&amp; !cp.getType().equals(&quot;X509&quot;)) {
 97                 throw new InvalidAlgorithmParameterException(&quot;inappropriate &quot;
 98                     + &quot;CertPath type specified, must be X.509 or X509&quot;);
 99             }
100             this.certPath = cp;
101         }
102 
103         ValidatorParams(PKIXParameters params)
104             throws InvalidAlgorithmParameterException
105         {
106             if (params instanceof PKIXExtendedParameters) {
107                 timestamp = ((PKIXExtendedParameters) params).getTimestamp();
108                 variant = ((PKIXExtendedParameters) params).getVariant();
109             }
110 
111             this.anchors = params.getTrustAnchors();
112             // Make sure that none of the trust anchors include name constraints
113             // (not supported).
114             for (TrustAnchor anchor : this.anchors) {
115                 if (anchor.getNameConstraints() != null) {
116                     throw new InvalidAlgorithmParameterException
117                         (&quot;name constraints in trust anchor not supported&quot;);
118                 }
119             }
120             this.params = params;
121         }
122 
123         CertPath certPath() {
124             return certPath;
125         }
126         // called by CertPathBuilder after path has been built
127         void setCertPath(CertPath cp) {
128             this.certPath = cp;
129         }
130         List&lt;X509Certificate&gt; certificates() {
131             if (certs == null) {
132                 if (certPath == null) {
133                     certs = Collections.emptyList();
134                 } else {
135                     // Reverse the ordering for validation so that the target
136                     // cert is the last certificate
137                     @SuppressWarnings(&quot;unchecked&quot;)
138                     List&lt;X509Certificate&gt; xc = new ArrayList&lt;&gt;
139                         ((List&lt;X509Certificate&gt;)certPath.getCertificates());
140                     Collections.reverse(xc);
141                     certs = xc;
142                 }
143             }
144             return certs;
145         }
146         List&lt;PKIXCertPathChecker&gt; certPathCheckers() {
147             if (checkers == null)
148                 checkers = params.getCertPathCheckers();
149             return checkers;
150         }
151         List&lt;CertStore&gt; certStores() {
152             if (stores == null)
153                 stores = params.getCertStores();
154             return stores;
155         }
156         Date date() {
157             if (!gotDate) {
158                 date = params.getDate();
159                 if (date == null)
160                     date = new Date();
161                 gotDate = true;
162             }
163             return date;
164         }
165         Set&lt;String&gt; initialPolicies() {
166             if (policies == null)
167                 policies = params.getInitialPolicies();
168             return policies;
169         }
170         CertSelector targetCertConstraints() {
171             if (!gotConstraints) {
172                 constraints = params.getTargetCertConstraints();
173                 gotConstraints = true;
174             }
175             return constraints;
176         }
177         Set&lt;TrustAnchor&gt; trustAnchors() {
178             return anchors;
179         }
180         boolean revocationEnabled() {
181             return params.isRevocationEnabled();
182         }
183         boolean policyMappingInhibited() {
184             return params.isPolicyMappingInhibited();
185         }
186         boolean explicitPolicyRequired() {
187             return params.isExplicitPolicyRequired();
188         }
189         boolean policyQualifiersRejected() {
190             return params.getPolicyQualifiersRejected();
191         }
192         String sigProvider() { return params.getSigProvider(); }
193         boolean anyPolicyInhibited() { return params.isAnyPolicyInhibited(); }
194 
195         // in rare cases we need access to the original params, for example
196         // in order to clone CertPathCheckers before building a new chain
197         PKIXParameters getPKIXParameters() {
198             return params;
199         }
200 
201         Timestamp timestamp() {
202             return timestamp;
203         }
204 
205         String variant() {
206             return variant;
207         }
208     }
209 
210     static class BuilderParams extends ValidatorParams {
211         private PKIXBuilderParameters params;
212         private List&lt;CertStore&gt; stores;
213         private X500Principal targetSubject;
214 
215         BuilderParams(PKIXBuilderParameters params)
216             throws InvalidAlgorithmParameterException
217         {
218             super(params);
219             checkParams(params);
220         }
221         private void checkParams(PKIXBuilderParameters params)
222             throws InvalidAlgorithmParameterException
223         {
224             CertSelector sel = targetCertConstraints();
225             if (!(sel instanceof X509CertSelector)) {
226                 throw new InvalidAlgorithmParameterException(&quot;the &quot;
227                     + &quot;targetCertConstraints parameter must be an &quot;
228                     + &quot;X509CertSelector&quot;);
229             }
230             this.params = params;
231             this.targetSubject = getTargetSubject(
232                 certStores(), (X509CertSelector)targetCertConstraints());
233         }
234         @Override List&lt;CertStore&gt; certStores() {
235             if (stores == null) {
236                 // reorder CertStores so that local CertStores are tried first
237                 stores = new ArrayList&lt;&gt;(params.getCertStores());
238                 Collections.sort(stores, new CertStoreComparator());
239             }
240             return stores;
241         }
242         int maxPathLength() { return params.getMaxPathLength(); }
243         PKIXBuilderParameters params() { return params; }
244         X500Principal targetSubject() { return targetSubject; }
245 
246         /**
247          * Returns the target subject DN from the first X509Certificate that
248          * is fetched that matches the specified X509CertSelector.
249          */
250         private static X500Principal getTargetSubject(List&lt;CertStore&gt; stores,
251                                                       X509CertSelector sel)
252             throws InvalidAlgorithmParameterException
253         {
254             X500Principal subject = sel.getSubject();
255             if (subject != null) {
256                 return subject;
257             }
258             X509Certificate cert = sel.getCertificate();
259             if (cert != null) {
260                 subject = cert.getSubjectX500Principal();
261             }
262             if (subject != null) {
263                 return subject;
264             }
265             for (CertStore store : stores) {
266                 try {
267                     Collection&lt;? extends Certificate&gt; certs =
268                         (Collection&lt;? extends Certificate&gt;)
269                             store.getCertificates(sel);
270                     if (!certs.isEmpty()) {
271                         X509Certificate xc =
272                             (X509Certificate)certs.iterator().next();
273                         return xc.getSubjectX500Principal();
274                     }
275                 } catch (CertStoreException e) {
276                     // ignore but log it
277                     if (debug != null) {
278                         debug.println(&quot;BuilderParams.getTargetSubjectDN: &quot; +
279                             &quot;non-fatal exception retrieving certs: &quot; + e);
280                         e.printStackTrace();
281                     }
282                 }
283             }
284             throw new InvalidAlgorithmParameterException
285                 (&quot;Could not determine unique target subject&quot;);
286         }
287     }
288 
289     /**
290      * A CertStoreException with additional information about the type of
291      * CertStore that generated the exception.
292      */
293     static class CertStoreTypeException extends CertStoreException {
<a name="2" id="anc2"></a><span class="line-added">294         @java.io.Serial</span>
295         private static final long serialVersionUID = 7463352639238322556L;
296 
297         private final String type;
298 
299         CertStoreTypeException(String type, CertStoreException cse) {
300             super(cse.getMessage(), cse.getCause());
301             this.type = type;
302         }
303         String getType() {
304             return type;
305         }
306     }
307 
308     /**
309      * Comparator that orders CertStores so that local CertStores come before
310      * remote CertStores.
311      */
312     private static class CertStoreComparator implements Comparator&lt;CertStore&gt; {
313         @Override
314         public int compare(CertStore store1, CertStore store2) {
315             if (store1.getType().equals(&quot;Collection&quot;) ||
316                 store1.getCertStoreParameters() instanceof
317                 CollectionCertStoreParameters) {
318                 return -1;
319             } else {
320                 return 1;
321             }
322         }
323     }
324 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>