<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.base/share/classes/sun/security/provider/SubjectCodeSource.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 1999, 2013, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.provider;
 27 
 28 import java.net.URL;
 29 import java.util.*;
 30 import java.security.CodeSource;
 31 import java.security.Principal;
 32 import java.security.cert.Certificate;
 33 import java.lang.reflect.Constructor;
 34 
 35 import javax.security.auth.Subject;
 36 import sun.security.provider.PolicyParser.PrincipalEntry;
 37 import sun.security.util.ResourcesMgr;
 38 
 39 /**
 40  * &lt;p&gt; This &lt;code&gt;SubjectCodeSource&lt;/code&gt; class contains
 41  * a &lt;code&gt;URL&lt;/code&gt;, signer certificates, and either a &lt;code&gt;Subject&lt;/code&gt;
 42  * (that represents the &lt;code&gt;Subject&lt;/code&gt; in the current
 43  * &lt;code&gt;AccessControlContext&lt;/code&gt;), or a linked list of Principals
 44  * (that represent a &quot;subject&quot; in a &lt;code&gt;Policy&lt;/code&gt;).
 45  *
 46  */
 47 class SubjectCodeSource extends CodeSource implements java.io.Serializable {
 48 
 49     private static final long serialVersionUID = 6039418085604715275L;
 50 
 51     private Subject subject;
 52     private LinkedList&lt;PrincipalEntry&gt; principals;
 53     private static final Class&lt;?&gt;[] PARAMS = { String.class };
 54     private static final sun.security.util.Debug debug =
 55         sun.security.util.Debug.getInstance(&quot;auth&quot;, &quot;\t[Auth Access]&quot;);
 56     private ClassLoader sysClassLoader;
 57 
 58     /**
 59      * Creates a new &lt;code&gt;SubjectCodeSource&lt;/code&gt;
 60      * with the given &lt;code&gt;Subject&lt;/code&gt;, principals, &lt;code&gt;URL&lt;/code&gt;,
 61      * and signers (Certificates).  The &lt;code&gt;Subject&lt;/code&gt;
 62      * represents the &lt;code&gt;Subject&lt;/code&gt; associated with the current
 63      * &lt;code&gt;AccessControlContext&lt;/code&gt;.
 64      * The Principals are given as a &lt;code&gt;LinkedList&lt;/code&gt;
 65      * of &lt;code&gt;PolicyParser.PrincipalEntry&lt;/code&gt; objects.
 66      * Typically either a &lt;code&gt;Subject&lt;/code&gt; will be provided,
 67      * or a list of &lt;code&gt;principals&lt;/code&gt; will be provided
 68      * (not both).
 69      *
 70      * &lt;p&gt;
 71      *
 72      * @param subject the &lt;code&gt;Subject&lt;/code&gt; associated with this
 73      *                  &lt;code&gt;SubjectCodeSource&lt;/code&gt; &lt;p&gt;
 74      *
 75      * @param url the &lt;code&gt;URL&lt;/code&gt; associated with this
 76      *                  &lt;code&gt;SubjectCodeSource&lt;/code&gt; &lt;p&gt;
 77      *
 78      * @param certs the signers associated with this
 79      *                  &lt;code&gt;SubjectCodeSource&lt;/code&gt; &lt;p&gt;
 80      */
 81     SubjectCodeSource(Subject subject,
 82         LinkedList&lt;PrincipalEntry&gt; principals,
 83         URL url, Certificate[] certs) {
 84 
 85         super(url, certs);
 86         this.subject = subject;
 87         this.principals = (principals == null ?
 88                 new LinkedList&lt;PrincipalEntry&gt;() :
 89                 new LinkedList&lt;PrincipalEntry&gt;(principals));
 90         sysClassLoader = java.security.AccessController.doPrivileged
 91         (new java.security.PrivilegedAction&lt;ClassLoader&gt;() {
 92             public ClassLoader run() {
 93                     return ClassLoader.getSystemClassLoader();
 94             }
 95         });
 96     }
 97 
 98     /**
 99      * Get the Principals associated with this &lt;code&gt;SubjectCodeSource&lt;/code&gt;.
100      * The Principals are retrieved as a &lt;code&gt;LinkedList&lt;/code&gt;
101      * of &lt;code&gt;PolicyParser.PrincipalEntry&lt;/code&gt; objects.
102      *
103      * &lt;p&gt;
104      *
105      * @return the Principals associated with this
106      *          &lt;code&gt;SubjectCodeSource&lt;/code&gt; as a &lt;code&gt;LinkedList&lt;/code&gt;
107      *          of &lt;code&gt;PolicyParser.PrincipalEntry&lt;/code&gt; objects.
108      */
109     LinkedList&lt;PrincipalEntry&gt; getPrincipals() {
110         return principals;
111     }
112 
113     /**
114      * Get the &lt;code&gt;Subject&lt;/code&gt; associated with this
115      * &lt;code&gt;SubjectCodeSource&lt;/code&gt;.  The &lt;code&gt;Subject&lt;/code&gt;
116      * represents the &lt;code&gt;Subject&lt;/code&gt; associated with the
117      * current &lt;code&gt;AccessControlContext&lt;/code&gt;.
118      *
119      * &lt;p&gt;
120      *
121      * @return the &lt;code&gt;Subject&lt;/code&gt; associated with this
122      *          &lt;code&gt;SubjectCodeSource&lt;/code&gt;.
123      */
124     Subject getSubject() {
125         return subject;
126     }
127 
128     /**
129      * Returns true if this &lt;code&gt;SubjectCodeSource&lt;/code&gt; object &quot;implies&quot;
130      * the specified &lt;code&gt;CodeSource&lt;/code&gt;.
131      * More specifically, this method makes the following checks.
132      * If any fail, it returns false.  If they all succeed, it returns true.
133      *
134      * &lt;p&gt;
135      * &lt;ol&gt;
136      * &lt;li&gt; The provided codesource must not be &lt;code&gt;null&lt;/code&gt;.
137      * &lt;li&gt; codesource must be an instance of &lt;code&gt;SubjectCodeSource&lt;/code&gt;.
138      * &lt;li&gt; super.implies(codesource) must return true.
139      * &lt;li&gt; for each principal in this codesource&#39;s principal list:
140      * &lt;ol&gt;
141      * &lt;li&gt;     if the principal is an instanceof
142      *          &lt;code&gt;Principal&lt;/code&gt;, then the principal must
143      *          imply the provided codesource&#39;s &lt;code&gt;Subject&lt;/code&gt;.
144      * &lt;li&gt;     if the principal is not an instanceof
145      *          &lt;code&gt;Principal&lt;/code&gt;, then the provided
146      *          codesource&#39;s &lt;code&gt;Subject&lt;/code&gt; must have an
147      *          associated &lt;code&gt;Principal&lt;/code&gt;, &lt;i&gt;P&lt;/i&gt;, where
148      *          P.getClass().getName equals principal.principalClass,
149      *          and P.getName() equals principal.principalName.
150      * &lt;/ol&gt;
151      * &lt;/ol&gt;
152      *
153      * &lt;p&gt;
154      *
155      * @param codesource the &lt;code&gt;CodeSource&lt;/code&gt; to compare against.
156      *
157      * @return true if this &lt;code&gt;SubjectCodeSource&lt;/code&gt; implies
158      *          the specified &lt;code&gt;CodeSource&lt;/code&gt;.
159      */
160     public boolean implies(CodeSource codesource) {
161 
162         LinkedList&lt;PrincipalEntry&gt; subjectList = null;
163 
164         if (codesource == null ||
165             !(codesource instanceof SubjectCodeSource) ||
166             !(super.implies(codesource))) {
167 
168             if (debug != null)
169                 debug.println(&quot;\tSubjectCodeSource.implies: FAILURE 1&quot;);
170             return false;
171         }
172 
173         SubjectCodeSource that = (SubjectCodeSource)codesource;
174 
175         // if the principal list in the policy &quot;implies&quot;
176         // the Subject associated with the current AccessControlContext,
177         // then return true
178 
179         if (this.principals == null) {
180             if (debug != null)
181                 debug.println(&quot;\tSubjectCodeSource.implies: PASS 1&quot;);
182             return true;
183         }
184 
185         if (that.getSubject() == null ||
186             that.getSubject().getPrincipals().size() == 0) {
187             if (debug != null)
188                 debug.println(&quot;\tSubjectCodeSource.implies: FAILURE 2&quot;);
189             return false;
190         }
191 
192         ListIterator&lt;PrincipalEntry&gt; li = this.principals.listIterator(0);
193         while (li.hasNext()) {
194             PrincipalEntry pppe = li.next();
195             try {
196 
197                 // use new Principal.implies method
198 
199                 Class&lt;?&gt; pClass = Class.forName(pppe.principalClass,
200                                                 true, sysClassLoader);
201                 if (!Principal.class.isAssignableFrom(pClass)) {
202                     // not the right subtype
203                     throw new ClassCastException(pppe.principalClass +
204                                                  &quot; is not a Principal&quot;);
205                 }
206                 Constructor&lt;?&gt; c = pClass.getConstructor(PARAMS);
207                 Principal p = (Principal)c.newInstance(new Object[] {
208                                                        pppe.principalName });
209 
210                 if (!p.implies(that.getSubject())) {
211                     if (debug != null)
212                         debug.println(&quot;\tSubjectCodeSource.implies: FAILURE 3&quot;);
213                     return false;
214                 } else {
215                     if (debug != null)
216                         debug.println(&quot;\tSubjectCodeSource.implies: PASS 2&quot;);
217                     return true;
218                 }
219             } catch (Exception e) {
220 
221                 // simply compare Principals
222 
223                 if (subjectList == null) {
224 
225                     if (that.getSubject() == null) {
226                         if (debug != null)
227                             debug.println(&quot;\tSubjectCodeSource.implies: &quot; +
228                                         &quot;FAILURE 4&quot;);
229                         return false;
230                     }
231                     Iterator&lt;Principal&gt; i =
232                                 that.getSubject().getPrincipals().iterator();
233 
234                     subjectList = new LinkedList&lt;PrincipalEntry&gt;();
235                     while (i.hasNext()) {
236                         Principal p = i.next();
237                         PrincipalEntry spppe = new PrincipalEntry
238                                 (p.getClass().getName(), p.getName());
239                         subjectList.add(spppe);
240                     }
241                 }
242 
243                 if (!subjectListImpliesPrincipalEntry(subjectList, pppe)) {
244                     if (debug != null)
245                         debug.println(&quot;\tSubjectCodeSource.implies: FAILURE 5&quot;);
246                     return false;
247                 }
248             }
249         }
250 
251         if (debug != null)
252             debug.println(&quot;\tSubjectCodeSource.implies: PASS 3&quot;);
253         return true;
254     }
255 
256     /**
257      * This method returns, true, if the provided &lt;i&gt;subjectList&lt;/i&gt;
258      * &quot;contains&quot; the &lt;code&gt;Principal&lt;/code&gt; specified
259      * in the provided &lt;i&gt;pppe&lt;/i&gt; argument.
260      *
261      * Note that the provided &lt;i&gt;pppe&lt;/i&gt; argument may have
262      * wildcards (*) for the &lt;code&gt;Principal&lt;/code&gt; class and name,
263      * which need to be considered.
264      *
265      * &lt;p&gt;
266      *
267      * @param subjectList a list of PolicyParser.PrincipalEntry objects
268      *          that correspond to all the Principals in the Subject currently
269      *          on this thread&#39;s AccessControlContext. &lt;p&gt;
270      *
271      * @param pppe the Principals specified in a grant entry.
272      *
273      * @return true if the provided &lt;i&gt;subjectList&lt;/i&gt; &quot;contains&quot;
274      *          the &lt;code&gt;Principal&lt;/code&gt; specified in the provided
275      *          &lt;i&gt;pppe&lt;/i&gt; argument.
276      */
277     private boolean subjectListImpliesPrincipalEntry(
278                 LinkedList&lt;PrincipalEntry&gt; subjectList, PrincipalEntry pppe) {
279 
280         ListIterator&lt;PrincipalEntry&gt; li = subjectList.listIterator(0);
281         while (li.hasNext()) {
282             PrincipalEntry listPppe = li.next();
283 
284             if (pppe.getPrincipalClass().equals
285                         (PrincipalEntry.WILDCARD_CLASS) ||
286                 pppe.getPrincipalClass().equals(listPppe.getPrincipalClass()))
287             {
288                 if (pppe.getPrincipalName().equals
289                         (PrincipalEntry.WILDCARD_NAME) ||
290                     pppe.getPrincipalName().equals(listPppe.getPrincipalName()))
291                     return true;
292             }
293         }
294         return false;
295     }
296 
297     /**
298      * Tests for equality between the specified object and this
299      * object. Two &lt;code&gt;SubjectCodeSource&lt;/code&gt; objects are considered equal
300      * if their locations are of identical value, if the two sets of
301      * Certificates are of identical values, and if the
302      * Subjects are equal, and if the PolicyParser.PrincipalEntry values
303      * are of identical values.  It is not required that
304      * the Certificates or PolicyParser.PrincipalEntry values
305      * be in the same order.
306      *
307      * &lt;p&gt;
308      *
309      * @param obj the object to test for equality with this object.
310      *
311      * @return true if the objects are considered equal, false otherwise.
312      */
313     public boolean equals(Object obj) {
314 
315         if (obj == this)
316             return true;
317 
318         if (super.equals(obj) == false)
319             return false;
320 
321         if (!(obj instanceof SubjectCodeSource))
322             return false;
323 
324         SubjectCodeSource that = (SubjectCodeSource)obj;
325 
326         // the principal lists must match
327         try {
328             if (this.getSubject() != that.getSubject())
329                 return false;
330         } catch (SecurityException se) {
331             return false;
332         }
333 
334         if ((this.principals == null &amp;&amp; that.principals != null) ||
335             (this.principals != null &amp;&amp; that.principals == null))
336             return false;
337 
338         if (this.principals != null &amp;&amp; that.principals != null) {
339             if (!this.principals.containsAll(that.principals) ||
340                 !that.principals.containsAll(this.principals))
341 
342                 return false;
343         }
344 
345         return true;
346     }
347 
348     /**
349      * Return a hashcode for this &lt;code&gt;SubjectCodeSource&lt;/code&gt;.
350      *
351      * &lt;p&gt;
352      *
353      * @return a hashcode for this &lt;code&gt;SubjectCodeSource&lt;/code&gt;.
354      */
355     public int hashCode() {
356         return super.hashCode();
357     }
358 
359     /**
360      * Return a String representation of this &lt;code&gt;SubjectCodeSource&lt;/code&gt;.
361      *
362      * &lt;p&gt;
363      *
364      * @return a String representation of this &lt;code&gt;SubjectCodeSource&lt;/code&gt;.
365      */
366     public String toString() {
367         String returnMe = super.toString();
368         if (getSubject() != null) {
369             if (debug != null) {
370                 final Subject finalSubject = getSubject();
371                 returnMe = returnMe + &quot;\n&quot; +
372                         java.security.AccessController.doPrivileged
373                                 (new java.security.PrivilegedAction&lt;String&gt;() {
374                                 public String run() {
375                                     return finalSubject.toString();
376                                 }
377                         });
378             } else {
379                 returnMe = returnMe + &quot;\n&quot; + getSubject().toString();
380             }
381         }
382         if (principals != null) {
383             ListIterator&lt;PrincipalEntry&gt; li = principals.listIterator();
384             while (li.hasNext()) {
385                 PrincipalEntry pppe = li.next();
386                 returnMe = returnMe + ResourcesMgr.getAuthResourceString(&quot;NEWLINE&quot;) +
387                         pppe.getPrincipalClass() + &quot; &quot; +
388                         pppe.getPrincipalName();
389             }
390         }
391         return returnMe;
392     }
393 }
    </pre>
  </body>
</html>