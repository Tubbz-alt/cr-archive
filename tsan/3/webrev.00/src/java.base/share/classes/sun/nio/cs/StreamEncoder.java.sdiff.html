<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/nio/cs/StreamEncoder.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="StreamDecoder.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ThreadLocalCoders.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/nio/cs/StreamEncoder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2005, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
<span class="line-removed"> 26 /*</span>
<span class="line-removed"> 27  */</span>
<span class="line-removed"> 28 </span>
 29 package sun.nio.cs;
 30 
<span class="line-modified"> 31 import java.io.*;</span>
<span class="line-modified"> 32 import java.nio.*;</span>
<span class="line-modified"> 33 import java.nio.channels.*;</span>
<span class="line-modified"> 34 import java.nio.charset.*;</span>









 35 
 36 public class StreamEncoder extends Writer
 37 {
 38 
 39     private static final int DEFAULT_BYTE_BUFFER_SIZE = 8192;
 40 
 41     private volatile boolean closed;
 42 
 43     private void ensureOpen() throws IOException {
 44         if (closed)
 45             throw new IOException(&quot;Stream closed&quot;);
 46     }
 47 
 48     // Factories for java.io.OutputStreamWriter
 49     public static StreamEncoder forOutputStreamWriter(OutputStream out,
 50                                                       Object lock,
 51                                                       String charsetName)
 52         throws UnsupportedEncodingException
 53     {
 54         String csn = charsetName;
</pre>
<hr />
<pre>
141             synchronized (lock) {
142                 ensureOpen();
143                 implWrite(cb);
144             }
145         } finally {
146             cb.position(position);
147         }
148     }
149 
150     public void flush() throws IOException {
151         synchronized (lock) {
152             ensureOpen();
153             implFlush();
154         }
155     }
156 
157     public void close() throws IOException {
158         synchronized (lock) {
159             if (closed)
160                 return;
<span class="line-modified">161             implClose();</span>
<span class="line-modified">162             closed = true;</span>



163         }
164     }
165 
166     private boolean isOpen() {
167         return !closed;
168     }
169 
170 
171     // -- Charset-based stream encoder impl --
172 
173     private Charset cs;
174     private CharsetEncoder encoder;
175     private ByteBuffer bb;
176 
177     // Exactly one of these is non-null
178     private final OutputStream out;
179     private WritableByteChannel ch;
180 
181     // Leftover first char in a surrogate pair
182     private boolean haveLeftoverChar = false;
</pre>
<hr />
<pre>
320 
321     void implClose() throws IOException {
322         flushLeftoverChar(null, true);
323         try {
324             for (;;) {
325                 CoderResult cr = encoder.flush(bb);
326                 if (cr.isUnderflow())
327                     break;
328                 if (cr.isOverflow()) {
329                     assert bb.position() &gt; 0;
330                     writeBytes();
331                     continue;
332                 }
333                 cr.throwException();
334             }
335 
336             if (bb.position() &gt; 0)
337                 writeBytes();
338             if (ch != null)
339                 ch.close();
<span class="line-modified">340             else</span>
<span class="line-modified">341                 out.close();</span>





342         } catch (IOException x) {
343             encoder.reset();
344             throw x;
345         }
346     }
347 
348     String encodingName() {
349         return ((cs instanceof HistoricallyNamedCharset)
350             ? ((HistoricallyNamedCharset)cs).historicalName()
351             : cs.name());
352     }
353 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 



 26 package sun.nio.cs;
 27 
<span class="line-modified"> 28 import java.io.FileOutputStream;</span>
<span class="line-modified"> 29 import java.io.IOException;</span>
<span class="line-modified"> 30 import java.io.OutputStream;</span>
<span class="line-modified"> 31 import java.io.UnsupportedEncodingException;</span>
<span class="line-added"> 32 import java.io.Writer;</span>
<span class="line-added"> 33 import java.nio.ByteBuffer;</span>
<span class="line-added"> 34 import java.nio.CharBuffer;</span>
<span class="line-added"> 35 import java.nio.channels.WritableByteChannel;</span>
<span class="line-added"> 36 import java.nio.charset.Charset;</span>
<span class="line-added"> 37 import java.nio.charset.CharsetEncoder;</span>
<span class="line-added"> 38 import java.nio.charset.CoderResult;</span>
<span class="line-added"> 39 import java.nio.charset.CodingErrorAction;</span>
<span class="line-added"> 40 import java.nio.charset.IllegalCharsetNameException;</span>
 41 
 42 public class StreamEncoder extends Writer
 43 {
 44 
 45     private static final int DEFAULT_BYTE_BUFFER_SIZE = 8192;
 46 
 47     private volatile boolean closed;
 48 
 49     private void ensureOpen() throws IOException {
 50         if (closed)
 51             throw new IOException(&quot;Stream closed&quot;);
 52     }
 53 
 54     // Factories for java.io.OutputStreamWriter
 55     public static StreamEncoder forOutputStreamWriter(OutputStream out,
 56                                                       Object lock,
 57                                                       String charsetName)
 58         throws UnsupportedEncodingException
 59     {
 60         String csn = charsetName;
</pre>
<hr />
<pre>
147             synchronized (lock) {
148                 ensureOpen();
149                 implWrite(cb);
150             }
151         } finally {
152             cb.position(position);
153         }
154     }
155 
156     public void flush() throws IOException {
157         synchronized (lock) {
158             ensureOpen();
159             implFlush();
160         }
161     }
162 
163     public void close() throws IOException {
164         synchronized (lock) {
165             if (closed)
166                 return;
<span class="line-modified">167             try {</span>
<span class="line-modified">168                 implClose();</span>
<span class="line-added">169             } finally {</span>
<span class="line-added">170                 closed = true;</span>
<span class="line-added">171             }</span>
172         }
173     }
174 
175     private boolean isOpen() {
176         return !closed;
177     }
178 
179 
180     // -- Charset-based stream encoder impl --
181 
182     private Charset cs;
183     private CharsetEncoder encoder;
184     private ByteBuffer bb;
185 
186     // Exactly one of these is non-null
187     private final OutputStream out;
188     private WritableByteChannel ch;
189 
190     // Leftover first char in a surrogate pair
191     private boolean haveLeftoverChar = false;
</pre>
<hr />
<pre>
329 
330     void implClose() throws IOException {
331         flushLeftoverChar(null, true);
332         try {
333             for (;;) {
334                 CoderResult cr = encoder.flush(bb);
335                 if (cr.isUnderflow())
336                     break;
337                 if (cr.isOverflow()) {
338                     assert bb.position() &gt; 0;
339                     writeBytes();
340                     continue;
341                 }
342                 cr.throwException();
343             }
344 
345             if (bb.position() &gt; 0)
346                 writeBytes();
347             if (ch != null)
348                 ch.close();
<span class="line-modified">349             else {</span>
<span class="line-modified">350                 try {</span>
<span class="line-added">351                     out.flush();</span>
<span class="line-added">352                 } finally {</span>
<span class="line-added">353                     out.close();</span>
<span class="line-added">354                 }</span>
<span class="line-added">355             }</span>
356         } catch (IOException x) {
357             encoder.reset();
358             throw x;
359         }
360     }
361 
362     String encodingName() {
363         return ((cs instanceof HistoricallyNamedCharset)
364             ? ((HistoricallyNamedCharset)cs).historicalName()
365             : cs.name());
366     }
367 }
</pre>
</td>
</tr>
</table>
<center><a href="StreamDecoder.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ThreadLocalCoders.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>