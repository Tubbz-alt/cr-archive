<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/classes/sun/nio/ch/DatagramSocketAdaptor.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2001, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.nio.ch;
 27 
 28 import java.io.IOException;
<a name="2" id="anc2"></a>





 29 import java.net.DatagramPacket;
 30 import java.net.DatagramSocket;
<a name="3" id="anc3"></a><span class="line-removed"> 31 import java.net.DatagramSocketImpl;</span>
 32 import java.net.InetAddress;
 33 import java.net.InetSocketAddress;
 34 import java.net.NetworkInterface;
<a name="4" id="anc4"></a>
 35 import java.net.SocketAddress;
 36 import java.net.SocketException;
 37 import java.net.SocketOption;
<a name="5" id="anc5"></a><span class="line-removed"> 38 import java.net.SocketTimeoutException;</span>
 39 import java.net.StandardSocketOptions;
 40 import java.nio.ByteBuffer;
<a name="6" id="anc6"></a>
 41 import java.nio.channels.ClosedChannelException;
 42 import java.nio.channels.DatagramChannel;
<a name="7" id="anc7"></a><span class="line-modified"> 43 import java.nio.channels.IllegalBlockingModeException;</span>



 44 import java.util.Objects;
<a name="8" id="anc8"></a>

 45 
<a name="9" id="anc9"></a>
 46 
<a name="10" id="anc10"></a><span class="line-modified"> 47 // Make a datagram-socket channel look like a datagram socket.</span>
<span class="line-modified"> 48 //</span>
<span class="line-modified"> 49 // The methods in this class are defined in exactly the same order as in</span>
<span class="line-modified"> 50 // java.net.DatagramSocket so as to simplify tracking future changes to that</span>
<span class="line-modified"> 51 // class.</span>
<span class="line-modified"> 52 //</span>
<span class="line-modified"> 53 </span>

 54 public class DatagramSocketAdaptor
<a name="11" id="anc11"></a><span class="line-modified"> 55     extends DatagramSocket</span>
 56 {
 57     // The channel being adapted
 58     private final DatagramChannelImpl dc;
 59 
 60     // Timeout &quot;option&quot; value for receives
 61     private volatile int timeout;
 62 
<a name="12" id="anc12"></a><span class="line-removed"> 63     // ## super will create a useless impl</span>
 64     private DatagramSocketAdaptor(DatagramChannelImpl dc) throws IOException {
<a name="13" id="anc13"></a><span class="line-modified"> 65         // Invoke the DatagramSocketAdaptor(SocketAddress) constructor,</span>
<span class="line-removed"> 66         // passing a dummy DatagramSocketImpl object to avoid any native</span>
<span class="line-removed"> 67         // resource allocation in super class and invoking our bind method</span>
<span class="line-removed"> 68         // before the dc field is initialized.</span>
<span class="line-removed"> 69         super(dummyDatagramSocket);</span>
 70         this.dc = dc;
 71     }
 72 
<a name="14" id="anc14"></a><span class="line-modified"> 73     public static DatagramSocket create(DatagramChannelImpl dc) {</span>
 74         try {
 75             return new DatagramSocketAdaptor(dc);
<a name="15" id="anc15"></a><span class="line-modified"> 76         } catch (IOException x) {</span>
<span class="line-modified"> 77             throw new Error(x);</span>
 78         }
 79     }
 80 
<a name="16" id="anc16"></a><span class="line-modified"> 81     private void connectInternal(SocketAddress remote)</span>
<span class="line-removed"> 82         throws SocketException</span>
<span class="line-removed"> 83     {</span>
<span class="line-removed"> 84         InetSocketAddress isa = Net.asInetSocketAddress(remote);</span>
<span class="line-removed"> 85         int port = isa.getPort();</span>
<span class="line-removed"> 86         if (port &lt; 0 || port &gt; 0xFFFF)</span>
<span class="line-removed"> 87             throw new IllegalArgumentException(&quot;connect: &quot; + port);</span>
<span class="line-removed"> 88         if (remote == null)</span>
<span class="line-removed"> 89             throw new IllegalArgumentException(&quot;connect: null address&quot;);</span>
 90         try {
<a name="17" id="anc17"></a><span class="line-modified"> 91             dc.connect(remote);</span>
 92         } catch (ClosedChannelException e) {
 93             // ignore
 94         } catch (Exception x) {
 95             Net.translateToSocketException(x);
 96         }
 97     }
 98 
<a name="18" id="anc18"></a>
 99     public void bind(SocketAddress local) throws SocketException {
<a name="19" id="anc19"></a>




100         try {
<a name="20" id="anc20"></a><span class="line-removed">101             if (local == null)</span>
<span class="line-removed">102                 local = new InetSocketAddress(0);</span>
103             dc.bind(local);
104         } catch (Exception x) {
105             Net.translateToSocketException(x);
106         }
107     }
108 
<a name="21" id="anc21"></a>
109     public void connect(InetAddress address, int port) {
<a name="22" id="anc22"></a>

110         try {
111             connectInternal(new InetSocketAddress(address, port));
112         } catch (SocketException x) {
<a name="23" id="anc23"></a><span class="line-modified">113             // Yes, j.n.DatagramSocket really does this</span>
114         }
115     }
116 
<a name="24" id="anc24"></a>
117     public void connect(SocketAddress remote) throws SocketException {
<a name="25" id="anc25"></a><span class="line-modified">118         Objects.requireNonNull(remote, &quot;Address can&#39;t be null&quot;);</span>
<span class="line-modified">119         connectInternal(remote);</span>

120     }
121 
<a name="26" id="anc26"></a>
122     public void disconnect() {
123         try {
124             dc.disconnect();
125         } catch (IOException x) {
<a name="27" id="anc27"></a><span class="line-modified">126             throw new Error(x);</span>
127         }
128     }
129 
<a name="28" id="anc28"></a>
130     public boolean isBound() {
131         return dc.localAddress() != null;
132     }
133 
<a name="29" id="anc29"></a>
134     public boolean isConnected() {
135         return dc.remoteAddress() != null;
136     }
137 
<a name="30" id="anc30"></a>
138     public InetAddress getInetAddress() {
139         InetSocketAddress remote = dc.remoteAddress();
140         return (remote != null) ? remote.getAddress() : null;
141     }
142 
<a name="31" id="anc31"></a>
143     public int getPort() {
144         InetSocketAddress remote = dc.remoteAddress();
145         return (remote != null) ? remote.getPort() : -1;
146     }
147 
<a name="32" id="anc32"></a><span class="line-modified">148     public void send(DatagramPacket p) throws IOException {</span>
<span class="line-modified">149         synchronized (dc.blockingLock()) {</span>
<span class="line-modified">150             if (!dc.isBlocking())</span>
<span class="line-removed">151                 throw new IllegalBlockingModeException();</span>
<span class="line-removed">152             try {</span>
<span class="line-removed">153                 synchronized (p) {</span>
<span class="line-removed">154                     ByteBuffer bb = ByteBuffer.wrap(p.getData(),</span>
<span class="line-removed">155                                                     p.getOffset(),</span>
<span class="line-removed">156                                                     p.getLength());</span>
<span class="line-removed">157                     if (dc.isConnected()) {</span>
<span class="line-removed">158                         if (p.getAddress() == null) {</span>
<span class="line-removed">159                             // Legacy DatagramSocket will send in this case</span>
<span class="line-removed">160                             // and set address and port of the packet</span>
<span class="line-removed">161                             InetSocketAddress isa = dc.remoteAddress();</span>
<span class="line-removed">162                             p.setPort(isa.getPort());</span>
<span class="line-removed">163                             p.setAddress(isa.getAddress());</span>
<span class="line-removed">164                             dc.write(bb);</span>
<span class="line-removed">165                         } else {</span>
<span class="line-removed">166                             // Target address may not match connected address</span>
<span class="line-removed">167                             dc.send(bb, p.getSocketAddress());</span>
<span class="line-removed">168                         }</span>
<span class="line-removed">169                     } else {</span>
<span class="line-removed">170                         // Not connected so address must be valid or throw</span>
<span class="line-removed">171                         dc.send(bb, p.getSocketAddress());</span>
<span class="line-removed">172                     }</span>
<span class="line-removed">173                 }</span>
<span class="line-removed">174             } catch (IOException x) {</span>
<span class="line-removed">175                 Net.translateException(x);</span>
<span class="line-removed">176             }</span>
<span class="line-removed">177         }</span>
178     }
179 
<a name="33" id="anc33"></a><span class="line-modified">180     private SocketAddress receive(ByteBuffer bb) throws IOException {</span>
<span class="line-modified">181         assert Thread.holdsLock(dc.blockingLock()) &amp;&amp; dc.isBlocking();</span>








182 
<a name="34" id="anc34"></a><span class="line-modified">183         long to = this.timeout;</span>
<span class="line-modified">184         if (to == 0) {</span>
<span class="line-modified">185             return dc.receive(bb);</span>
<span class="line-modified">186         } else {</span>
<span class="line-modified">187             for (;;) {</span>
<span class="line-modified">188                 if (!dc.isOpen())</span>
<span class="line-modified">189                     throw new ClosedChannelException();</span>
<span class="line-modified">190                 long st = System.currentTimeMillis();</span>
<span class="line-modified">191                 if (dc.pollRead(to)) {</span>
<span class="line-modified">192                     return dc.receive(bb);</span>
















193                 }
<a name="35" id="anc35"></a><span class="line-modified">194                 to -= System.currentTimeMillis() - st;</span>
<span class="line-modified">195                 if (to &lt;= 0)</span>
<span class="line-modified">196                     throw new SocketTimeoutException();</span>











197             }
198         }
199     }
200 
<a name="36" id="anc36"></a>
201     public void receive(DatagramPacket p) throws IOException {
<a name="37" id="anc37"></a><span class="line-modified">202         synchronized (dc.blockingLock()) {</span>
<span class="line-modified">203             if (!dc.isBlocking())</span>
<span class="line-modified">204                 throw new IllegalBlockingModeException();</span>
<span class="line-modified">205             try {</span>
<span class="line-modified">206                 synchronized (p) {</span>
<span class="line-modified">207                     ByteBuffer bb = ByteBuffer.wrap(p.getData(),</span>
<span class="line-modified">208                                                     p.getOffset(),</span>
<span class="line-modified">209                                                     p.getLength());</span>
<span class="line-modified">210                     SocketAddress sender = receive(bb);</span>
<span class="line-modified">211                     p.setSocketAddress(sender);</span>
<span class="line-modified">212                     p.setLength(bb.position() - p.getOffset());</span>
<span class="line-modified">213                 }</span>
<span class="line-modified">214             } catch (IOException x) {</span>
<span class="line-modified">215                 Net.translateException(x);</span>

216             }
<a name="38" id="anc38"></a>





217         }
218     }
219 
<a name="39" id="anc39"></a>
220     public InetAddress getLocalAddress() {
221         if (isClosed())
222             return null;
223         InetSocketAddress local = dc.localAddress();
224         if (local == null)
225             local = new InetSocketAddress(0);
226         InetAddress result = local.getAddress();
227         SecurityManager sm = System.getSecurityManager();
228         if (sm != null) {
229             try {
230                 sm.checkConnect(result.getHostAddress(), -1);
231             } catch (SecurityException x) {
232                 return new InetSocketAddress(0).getAddress();
233             }
234         }
235         return result;
236     }
237 
<a name="40" id="anc40"></a>
238     public int getLocalPort() {
239         if (isClosed())
240             return -1;
<a name="41" id="anc41"></a><span class="line-modified">241         try {</span>
<span class="line-modified">242             InetSocketAddress local = dc.localAddress();</span>
<span class="line-modified">243             if (local != null) {</span>
<span class="line-removed">244                 return local.getPort();</span>
<span class="line-removed">245             }</span>
<span class="line-removed">246         } catch (Exception x) {</span>
247         }
248         return 0;
249     }
250 
<a name="42" id="anc42"></a>
251     public void setSoTimeout(int timeout) throws SocketException {
<a name="43" id="anc43"></a>



252         this.timeout = timeout;
253     }
254 
<a name="44" id="anc44"></a>
255     public int getSoTimeout() throws SocketException {
<a name="45" id="anc45"></a>

256         return timeout;
257     }
258 
259     private void setBooleanOption(SocketOption&lt;Boolean&gt; name, boolean value)
260         throws SocketException
261     {
262         try {
263             dc.setOption(name, value);
264         } catch (IOException x) {
265             Net.translateToSocketException(x);
266         }
267     }
268 
269     private void setIntOption(SocketOption&lt;Integer&gt; name, int value)
270         throws SocketException
271     {
272         try {
273             dc.setOption(name, value);
274         } catch (IOException x) {
275             Net.translateToSocketException(x);
276         }
277     }
278 
279     private boolean getBooleanOption(SocketOption&lt;Boolean&gt; name) throws SocketException {
280         try {
281             return dc.getOption(name).booleanValue();
282         } catch (IOException x) {
283             Net.translateToSocketException(x);
284             return false;       // keep compiler happy
285         }
286     }
287 
288     private int getIntOption(SocketOption&lt;Integer&gt; name) throws SocketException {
289         try {
290             return dc.getOption(name).intValue();
291         } catch (IOException x) {
292             Net.translateToSocketException(x);
293             return -1;          // keep compiler happy
294         }
295     }
296 
<a name="46" id="anc46"></a>
297     public void setSendBufferSize(int size) throws SocketException {
298         if (size &lt;= 0)
299             throw new IllegalArgumentException(&quot;Invalid send size&quot;);
300         setIntOption(StandardSocketOptions.SO_SNDBUF, size);
301     }
302 
<a name="47" id="anc47"></a>
303     public int getSendBufferSize() throws SocketException {
304         return getIntOption(StandardSocketOptions.SO_SNDBUF);
305     }
306 
<a name="48" id="anc48"></a>
307     public void setReceiveBufferSize(int size) throws SocketException {
308         if (size &lt;= 0)
309             throw new IllegalArgumentException(&quot;Invalid receive size&quot;);
310         setIntOption(StandardSocketOptions.SO_RCVBUF, size);
311     }
312 
<a name="49" id="anc49"></a>
313     public int getReceiveBufferSize() throws SocketException {
314         return getIntOption(StandardSocketOptions.SO_RCVBUF);
315     }
316 
<a name="50" id="anc50"></a>
317     public void setReuseAddress(boolean on) throws SocketException {
318         setBooleanOption(StandardSocketOptions.SO_REUSEADDR, on);
319     }
320 
<a name="51" id="anc51"></a>
321     public boolean getReuseAddress() throws SocketException {
322         return getBooleanOption(StandardSocketOptions.SO_REUSEADDR);
<a name="52" id="anc52"></a><span class="line-removed">323 </span>
324     }
325 
<a name="53" id="anc53"></a>
326     public void setBroadcast(boolean on) throws SocketException {
327         setBooleanOption(StandardSocketOptions.SO_BROADCAST, on);
328     }
329 
<a name="54" id="anc54"></a>
330     public boolean getBroadcast() throws SocketException {
331         return getBooleanOption(StandardSocketOptions.SO_BROADCAST);
332     }
333 
<a name="55" id="anc55"></a>
334     public void setTrafficClass(int tc) throws SocketException {
335         setIntOption(StandardSocketOptions.IP_TOS, tc);
336     }
337 
<a name="56" id="anc56"></a>
338     public int getTrafficClass() throws SocketException {
339         return getIntOption(StandardSocketOptions.IP_TOS);
340     }
341 
<a name="57" id="anc57"></a>
342     public void close() {
343         try {
344             dc.close();
345         } catch (IOException x) {
346             throw new Error(x);
347         }
348     }
349 
<a name="58" id="anc58"></a>
350     public boolean isClosed() {
351         return !dc.isOpen();
352     }
353 
<a name="59" id="anc59"></a>
354     public DatagramChannel getChannel() {
355         return dc;
356     }
357 
<a name="60" id="anc60"></a><span class="line-modified">358    /*</span>
<span class="line-modified">359     * A dummy implementation of DatagramSocketImpl that can be passed to the</span>
<span class="line-modified">360     * DatagramSocket constructor so that no native resources are allocated in</span>
<span class="line-modified">361     * super class.</span>
<span class="line-modified">362     */</span>
<span class="line-removed">363    private static final DatagramSocketImpl dummyDatagramSocket</span>
<span class="line-removed">364        = new DatagramSocketImpl()</span>
<span class="line-removed">365    {</span>
<span class="line-removed">366        protected void create() throws SocketException {}</span>
367 
<a name="61" id="anc61"></a><span class="line-modified">368        protected void bind(int lport, InetAddress laddr) throws SocketException {}</span>



369 
<a name="62" id="anc62"></a><span class="line-modified">370        protected void send(DatagramPacket p) throws IOException {}</span>



371 
<a name="63" id="anc63"></a><span class="line-modified">372        protected int peek(InetAddress i) throws IOException { return 0; }</span>
373 
<a name="64" id="anc64"></a><span class="line-modified">374        protected int peekData(DatagramPacket p) throws IOException { return 0; }</span>

375 
<a name="65" id="anc65"></a><span class="line-modified">376        protected void receive(DatagramPacket p) throws IOException {}</span>



377 
<a name="66" id="anc66"></a><span class="line-modified">378        @Deprecated</span>
<span class="line-modified">379        protected void setTTL(byte ttl) throws IOException {}</span>



380 
<a name="67" id="anc67"></a><span class="line-modified">381        @Deprecated</span>
<span class="line-modified">382        protected byte getTTL() throws IOException { return 0; }</span>







383 
<a name="68" id="anc68"></a><span class="line-modified">384        protected void setTimeToLive(int ttl) throws IOException {}</span>




385 
<a name="69" id="anc69"></a><span class="line-modified">386        protected int getTimeToLive() throws IOException { return 0;}</span>








387 
<a name="70" id="anc70"></a><span class="line-modified">388        protected void join(InetAddress inetaddr) throws IOException {}</span>










389 
<a name="71" id="anc71"></a><span class="line-modified">390        protected void leave(InetAddress inetaddr) throws IOException {}</span>










391 
<a name="72" id="anc72"></a><span class="line-modified">392        protected void joinGroup(SocketAddress mcastaddr,</span>
<span class="line-modified">393                                  NetworkInterface netIf) throws IOException {}</span>

































































































































394 
<a name="73" id="anc73"></a><span class="line-modified">395        protected void leaveGroup(SocketAddress mcastaddr,</span>
<span class="line-modified">396                                  NetworkInterface netIf) throws IOException {}</span>























































































397 
<a name="74" id="anc74"></a><span class="line-modified">398        protected void close() {}</span>








399 
<a name="75" id="anc75"></a><span class="line-modified">400        public Object getOption(int optID) throws SocketException { return null;}</span>


















401 
<a name="76" id="anc76"></a><span class="line-modified">402        public void setOption(int optID, Object value) throws SocketException {}</span>
<span class="line-modified">403    };</span>
<span class="line-modified">404 }</span>




















<a name="77" id="anc77"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="77" type="hidden" />
</body>
</html>