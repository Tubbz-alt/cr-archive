<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/ssl/TrustStoreManager.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="TransportContext.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Utilities.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/TrustStoreManager.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,10 +28,11 @@</span>
  import java.io.*;
  import java.lang.ref.WeakReference;
  import java.security.*;
  import java.security.cert.*;
  import java.util.*;
<span class="udiff-line-added">+ import java.util.concurrent.locks.ReentrantLock;</span>
  import sun.security.action.*;
  import sun.security.validator.TrustStoreUtil;
  
  /**
   * Collection of static utility methods to manage the default trusted KeyStores
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -242,10 +243,12 @@</span>
          //
          // Use weak reference so that the heavy loaded certificates collection
          // objects can be atomically cleared, and reloaded if needed.
          private WeakReference&lt;Set&lt;X509Certificate&gt;&gt; csRef;
  
<span class="udiff-line-added">+         private final ReentrantLock tamLock = new ReentrantLock();</span>
<span class="udiff-line-added">+ </span>
          private TrustAnchorManager() {
              this.descriptor = null;
              this.ksRef = new WeakReference&lt;&gt;(null);
              this.csRef = new WeakReference&lt;&gt;(null);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -253,82 +256,104 @@</span>
          /**
           * Get the default trusted KeyStore with the specified descriptor.
           *
           * @return null if the underlying KeyStore is not available.
           */
<span class="udiff-line-modified-removed">-         synchronized KeyStore getKeyStore(</span>
<span class="udiff-line-modified-added">+         KeyStore getKeyStore(</span>
                  TrustStoreDescriptor descriptor) throws Exception {
  
              TrustStoreDescriptor temporaryDesc = this.descriptor;
              KeyStore ks = ksRef.get();
              if ((ks != null) &amp;&amp; descriptor.equals(temporaryDesc)) {
                  return ks;
              }
  
<span class="udiff-line-modified-removed">-             // Reload a new key store.</span>
<span class="udiff-line-modified-removed">-             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+             tamLock.lock();</span>
<span class="udiff-line-modified-added">+             try {</span>
<span class="udiff-line-modified-added">+                 // double check</span>
<span class="udiff-line-modified-added">+                 ks = ksRef.get();</span>
<span class="udiff-line-added">+                 if ((ks != null) &amp;&amp; descriptor.equals(temporaryDesc)) {</span>
<span class="udiff-line-added">+                     return ks;</span>
<span class="udiff-line-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-             ks = loadKeyStore(descriptor);</span>
<span class="udiff-line-modified-removed">-             this.descriptor = descriptor;</span>
<span class="udiff-line-modified-removed">-             this.ksRef = new WeakReference&lt;&gt;(ks);</span>
<span class="udiff-line-modified-added">+                 // Reload a new key store.</span>
<span class="udiff-line-modified-added">+                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 ks = loadKeyStore(descriptor);</span>
<span class="udiff-line-added">+                 this.descriptor = descriptor;</span>
<span class="udiff-line-added">+                 this.ksRef = new WeakReference&lt;&gt;(ks);</span>
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 tamLock.unlock();</span>
<span class="udiff-line-added">+             }</span>
  
              return ks;
          }
  
          /**
           * Get trusted certificates in the default trusted KeyStore with
           * the specified descriptor.
           *
           * @return empty collection if the underlying KeyStore is not available.
           */
<span class="udiff-line-modified-removed">-         synchronized Set&lt;X509Certificate&gt; getTrustedCerts(</span>
<span class="udiff-line-modified-added">+         Set&lt;X509Certificate&gt; getTrustedCerts(</span>
                  TrustStoreDescriptor descriptor) throws Exception {
  
              KeyStore ks = null;
              TrustStoreDescriptor temporaryDesc = this.descriptor;
              Set&lt;X509Certificate&gt; certs = csRef.get();
<span class="udiff-line-modified-removed">-             if (certs != null) {</span>
<span class="udiff-line-modified-removed">-                 if (descriptor.equals(temporaryDesc)) {</span>
<span class="udiff-line-modified-removed">-                     return certs;</span>
<span class="udiff-line-modified-added">+             if ((certs != null) &amp;&amp; descriptor.equals(temporaryDesc)) {</span>
<span class="udiff-line-modified-added">+                 return certs;</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             tamLock.lock();</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 // double check</span>
<span class="udiff-line-added">+                 temporaryDesc = this.descriptor;</span>
<span class="udiff-line-added">+                 certs = csRef.get();</span>
<span class="udiff-line-added">+                 if (certs != null) {</span>
<span class="udiff-line-added">+                     if (descriptor.equals(temporaryDesc)) {</span>
<span class="udiff-line-added">+                         return certs;</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         // Use the new descriptor.</span>
<span class="udiff-line-added">+                         this.descriptor = descriptor;</span>
<span class="udiff-line-added">+                     }</span>
                  } else {
<span class="udiff-line-modified-removed">-                     // Use the new descriptor.</span>
<span class="udiff-line-modified-removed">-                     this.descriptor = descriptor;</span>
<span class="udiff-line-modified-added">+                     // Try to use the cached store at first.</span>
<span class="udiff-line-modified-added">+                     if (descriptor.equals(temporaryDesc)) {</span>
<span class="udiff-line-added">+                         ks = ksRef.get();</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         // Use the new descriptor.</span>
<span class="udiff-line-added">+                         this.descriptor = descriptor;</span>
<span class="udiff-line-added">+                     }</span>
                  }
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-modified-removed">-                 // Try to use the cached store at first.</span>
<span class="udiff-line-modified-removed">-                 if (descriptor.equals(temporaryDesc)) {</span>
<span class="udiff-line-modified-removed">-                     ks = ksRef.get();</span>
<span class="udiff-line-modified-removed">-                 } else {</span>
<span class="udiff-line-modified-removed">-                     // Use the new descriptor.</span>
<span class="udiff-line-modified-removed">-                     this.descriptor = descriptor;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+                 // Reload the trust store if needed.</span>
<span class="udiff-line-modified-added">+                 if (ks == null) {</span>
<span class="udiff-line-modified-added">+                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="udiff-line-modified-added">+                         SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="udiff-line-modified-added">+                     }</span>
<span class="udiff-line-modified-added">+                     ks = loadKeyStore(descriptor);</span>
<span class="udiff-line-added">+                     this.ksRef = new WeakReference&lt;&gt;(ks);</span>
                  }
<span class="udiff-line-removed">-             }</span>
  
<span class="udiff-line-modified-removed">-             // Reload the trust store if needed.</span>
<span class="udiff-line-removed">-             if (ks == null) {</span>
<span class="udiff-line-modified-added">+                 // Reload trust certs from the key store.</span>
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {
<span class="udiff-line-modified-removed">-                     SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="udiff-line-modified-added">+                     SSLLogger.fine(&quot;Reload trust certs&quot;);</span>
                  }
<span class="udiff-line-removed">-                 ks = loadKeyStore(descriptor);</span>
<span class="udiff-line-removed">-             }</span>
  
<span class="udiff-line-modified-removed">-             // Reload trust certs from the key store.</span>
<span class="udiff-line-modified-removed">-             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SSLLogger.fine(&quot;Reload trust certs&quot;);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+                 certs = loadTrustedCerts(ks);</span>
<span class="udiff-line-modified-added">+                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SSLLogger.fine(&quot;Reloaded &quot; + certs.size() + &quot; trust certs&quot;);</span>
<span class="udiff-line-modified-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-             certs = loadTrustedCerts(ks);</span>
<span class="udiff-line-modified-removed">-             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SSLLogger.fine(&quot;Reloaded &quot; + certs.size() + &quot; trust certs&quot;);</span>
<span class="udiff-line-modified-added">+                 this.csRef = new WeakReference&lt;&gt;(certs);</span>
<span class="udiff-line-modified-added">+             } finally {</span>
<span class="udiff-line-modified-added">+                 tamLock.unlock();</span>
              }
  
<span class="udiff-line-removed">-             // Note that as ks is a local variable, it is not</span>
<span class="udiff-line-removed">-             // necessary to add it to the ksRef weak reference.</span>
<span class="udiff-line-removed">-             this.csRef = new WeakReference&lt;&gt;(certs);</span>
<span class="udiff-line-removed">- </span>
              return certs;
          }
  
          /**
           * Load the KeyStore as described in the specified descriptor.
</pre>
<center><a href="TransportContext.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Utilities.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>