<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/ssl/TransportContext.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SupportedGroupsExtension.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TrustStoreManager.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/TransportContext.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 37,11 ***</span>
  import javax.net.ssl.HandshakeCompletedEvent;
  import javax.net.ssl.HandshakeCompletedListener;
  import javax.net.ssl.SSLEngineResult.HandshakeStatus;
  import javax.net.ssl.SSLException;
  import javax.net.ssl.SSLSocket;
<span class="line-removed">- import sun.security.ssl.SupportedGroupsExtension.NamedGroup;</span>
  
  /**
   * SSL/(D)TLS transportation context.
   */
  class TransportContext implements ConnectionContext {
<span class="line-new-header">--- 37,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 157,18 ***</span>
                  byte type = HandshakeContext.getHandshakeType(this,
                          plaintext);
                  if (handshakeContext == null) {
                      if (type == SSLHandshake.KEY_UPDATE.id ||
                              type == SSLHandshake.NEW_SESSION_TICKET.id) {
<span class="line-modified">!                         if (isNegotiated &amp;&amp;</span>
<span class="line-modified">!                                 protocolVersion.useTLS13PlusSpec()) {</span>
<span class="line-modified">!                             handshakeContext = new PostHandshakeContext(this);</span>
<span class="line-modified">!                         } else {</span>
                              throw fatal(Alert.UNEXPECTED_MESSAGE,
                                      &quot;Unexpected post-handshake message: &quot; +
                                      SSLHandshake.nameOf(type));
                          }
                      } else {
                          handshakeContext = sslConfig.isClientMode ?
                                  new ClientHandshakeContext(sslContext, this) :
                                  new ServerHandshakeContext(sslContext, this);
                          outputRecord.initHandshaker();
<span class="line-new-header">--- 156,23 ---</span>
                  byte type = HandshakeContext.getHandshakeType(this,
                          plaintext);
                  if (handshakeContext == null) {
                      if (type == SSLHandshake.KEY_UPDATE.id ||
                              type == SSLHandshake.NEW_SESSION_TICKET.id) {
<span class="line-modified">!                         if (!isNegotiated) {</span>
<span class="line-modified">!                             throw fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="line-modified">!                                     &quot;Unexpected unnegotiated post-handshake&quot; +</span>
<span class="line-modified">!                                             &quot; message: &quot; +</span>
<span class="line-added">+                                             SSLHandshake.nameOf(type));</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                         if (type == SSLHandshake.KEY_UPDATE.id &amp;&amp;</span>
<span class="line-added">+                                 !protocolVersion.useTLS13PlusSpec()) {</span>
                              throw fatal(Alert.UNEXPECTED_MESSAGE,
                                      &quot;Unexpected post-handshake message: &quot; +
                                      SSLHandshake.nameOf(type));
                          }
<span class="line-added">+                         handshakeContext = new PostHandshakeContext(this);</span>
                      } else {
                          handshakeContext = sslConfig.isClientMode ?
                                  new ClientHandshakeContext(sslContext, this) :
                                  new ServerHandshakeContext(sslContext, this);
                          outputRecord.initHandshaker();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 494,17 ***</span>
                      }
                  }
              }
  
              if (needCloseNotify) {
<span class="line-modified">!                 synchronized (outputRecord) {</span>
                      try {
                          // send a close_notify alert
                          warning(Alert.CLOSE_NOTIFY);
                      } finally {
                          outputRecord.close();
                      }
                  }
              }
          }
      }
  
<span class="line-new-header">--- 498,20 ---</span>
                      }
                  }
              }
  
              if (needCloseNotify) {
<span class="line-modified">!                 outputRecord.recordLock.lock();</span>
<span class="line-added">+                 try {</span>
                      try {
                          // send a close_notify alert
                          warning(Alert.CLOSE_NOTIFY);
                      } finally {
                          outputRecord.close();
                      }
<span class="line-added">+                 } finally {</span>
<span class="line-added">+                     outputRecord.recordLock.unlock();</span>
                  }
              }
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 539,11 ***</span>
              useUserCanceled = true;
          }
  
          // Need a lock here so that the user_canceled alert and the
          // close_notify alert can be delivered together.
<span class="line-modified">!         synchronized (outputRecord) {</span>
              try {
                  // send a user_canceled alert if needed.
                  if (useUserCanceled) {
                      warning(Alert.USER_CANCELED);
                  }
<span class="line-new-header">--- 546,12 ---</span>
              useUserCanceled = true;
          }
  
          // Need a lock here so that the user_canceled alert and the
          // close_notify alert can be delivered together.
<span class="line-modified">!         outputRecord.recordLock.lock();</span>
<span class="line-added">+         try {</span>
              try {
                  // send a user_canceled alert if needed.
                  if (useUserCanceled) {
                      warning(Alert.USER_CANCELED);
                  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 551,10 ***</span>
<span class="line-new-header">--- 559,12 ---</span>
                  // send a close_notify alert
                  warning(Alert.CLOSE_NOTIFY);
              } finally {
                  outputRecord.close();
              }
<span class="line-added">+         } finally {</span>
<span class="line-added">+             outputRecord.recordLock.unlock();</span>
          }
      }
  
      // Note; HandshakeStatus.FINISHED status is retrieved in other places.
      HandshakeStatus getHandshakeStatus() {
</pre>
<center><a href="SupportedGroupsExtension.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TrustStoreManager.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>