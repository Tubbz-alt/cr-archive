<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/ssl/CertStatusExtension.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="BaseSSLSocketImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CertificateMessage.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/CertStatusExtension.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -37,15 +37,11 @@</span>
  import java.util.List;
  import java.util.Locale;
  import javax.net.ssl.SSLProtocolException;
  import sun.security.provider.certpath.OCSPResponse;
  import sun.security.provider.certpath.ResponderId;
<span class="udiff-line-removed">- import static sun.security.ssl.SSLExtension.CH_STATUS_REQUEST;</span>
<span class="udiff-line-removed">- import static sun.security.ssl.SSLExtension.CH_STATUS_REQUEST_V2;</span>
  import sun.security.ssl.SSLExtension.ExtensionConsumer;
<span class="udiff-line-removed">- import static sun.security.ssl.SSLExtension.SH_STATUS_REQUEST;</span>
<span class="udiff-line-removed">- import static sun.security.ssl.SSLExtension.SH_STATUS_REQUEST_V2;</span>
  import sun.security.ssl.SSLExtension.SSLExtensionSpec;
  import sun.security.ssl.SSLHandshake.HandshakeMessage;
  import sun.security.util.DerInputStream;
  import sun.security.util.DerValue;
  import sun.security.util.HexDumpEncoder;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -432,12 +428,13 @@</span>
                      if (isFirst) {
                          isFirst = false;
                      } else {
                          extBuilder.append(&quot;,\n&quot;);
                      }
<span class="udiff-line-modified-removed">-                     extBuilder.append(</span>
<span class="udiff-line-modified-removed">-                             &quot;{\n&quot; + Utilities.indent(ext.toString()) + &quot;}&quot;);</span>
<span class="udiff-line-modified-added">+                     extBuilder.append(&quot;{\n&quot;).</span>
<span class="udiff-line-modified-added">+                             append(Utilities.indent(ext.toString())).</span>
<span class="udiff-line-added">+                             append(&quot;}&quot;);</span>
                  }
  
                  extsStr = extBuilder.toString();
              }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -550,15 +547,15 @@</span>
  
              if (!chc.sslContext.isStaplingEnabled(true)) {
                  return null;
              }
  
<span class="udiff-line-modified-removed">-             if (!chc.sslConfig.isAvailable(CH_STATUS_REQUEST)) {</span>
<span class="udiff-line-modified-added">+             if (!chc.sslConfig.isAvailable(SSLExtension.CH_STATUS_REQUEST)) {</span>
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
                      SSLLogger.fine(
                          &quot;Ignore unavailable extension: &quot; +
<span class="udiff-line-modified-removed">-                         CH_STATUS_REQUEST.name);</span>
<span class="udiff-line-modified-added">+                         SSLExtension.CH_STATUS_REQUEST.name);</span>
                  }
                  return null;
              }
  
              // Produce the extension.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -566,12 +563,12 @@</span>
              // We are using empty OCSPStatusRequest at present. May extend to
              // support specific responder or extensions later.
              byte[] extData = new byte[] {0x01, 0x00, 0x00, 0x00, 0x00};
  
              // Update the context.
<span class="udiff-line-modified-removed">-             chc.handshakeExtensions.put(</span>
<span class="udiff-line-modified-removed">-                     CH_STATUS_REQUEST, CertStatusRequestSpec.DEFAULT);</span>
<span class="udiff-line-modified-added">+             chc.handshakeExtensions.put(SSLExtension.CH_STATUS_REQUEST,</span>
<span class="udiff-line-modified-added">+                     CertStatusRequestSpec.DEFAULT);</span>
  
              return extData;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -591,14 +588,14 @@</span>
              HandshakeMessage message, ByteBuffer buffer) throws IOException {
  
              // The consuming happens in server side only.
              ServerHandshakeContext shc = (ServerHandshakeContext)context;
  
<span class="udiff-line-modified-removed">-             if (!shc.sslConfig.isAvailable(CH_STATUS_REQUEST)) {</span>
<span class="udiff-line-modified-added">+             if (!shc.sslConfig.isAvailable(SSLExtension.CH_STATUS_REQUEST)) {</span>
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
                      SSLLogger.fine(&quot;Ignore unavailable extension: &quot; +
<span class="udiff-line-modified-removed">-                         CH_STATUS_REQUEST.name);</span>
<span class="udiff-line-modified-added">+                         SSLExtension.CH_STATUS_REQUEST.name);</span>
                  }
                  return;     // ignore the extension
              }
  
              // Parse the extension.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -608,11 +605,11 @@</span>
              } catch (IOException ioe) {
                  throw shc.conContext.fatal(Alert.UNEXPECTED_MESSAGE, ioe);
              }
  
              // Update the context.
<span class="udiff-line-modified-removed">-             shc.handshakeExtensions.put(CH_STATUS_REQUEST, spec);</span>
<span class="udiff-line-modified-added">+             shc.handshakeExtensions.put(SSLExtension.CH_STATUS_REQUEST, spec);</span>
              if (!shc.isResumption &amp;&amp;
                      !shc.negotiatedProtocol.useTLS13PlusSpec()) {
                  shc.handshakeProducers.put(SSLHandshake.CERTIFICATE_STATUS.id,
                      SSLHandshake.CERTIFICATE_STATUS);
              }   // Otherwise, the certificate status presents in server cert.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -652,17 +649,16 @@</span>
                  return null;    // Do not produce status_request in ServerHello
              }
  
              // In response to &quot;status_request&quot; extension request only.
              CertStatusRequestSpec spec = (CertStatusRequestSpec)
<span class="udiff-line-modified-removed">-                     shc.handshakeExtensions.get(CH_STATUS_REQUEST);</span>
<span class="udiff-line-modified-added">+                     shc.handshakeExtensions.get(SSLExtension.CH_STATUS_REQUEST);</span>
              if (spec == null) {
                  // Ignore, no status_request extension requested.
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
<span class="udiff-line-modified-removed">-                     SSLLogger.finest(</span>
<span class="udiff-line-modified-removed">-                         &quot;Ignore unavailable extension: &quot; +</span>
<span class="udiff-line-removed">-                         CH_STATUS_REQUEST.name);</span>
<span class="udiff-line-modified-added">+                     SSLLogger.finest(&quot;Ignore unavailable extension: &quot; +</span>
<span class="udiff-line-modified-added">+                         SSLExtension.CH_STATUS_REQUEST.name);</span>
                  }
  
                  return null;        // ignore the extension
              }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -679,12 +675,12 @@</span>
              // The &quot;extension_data&quot; in the extended ServerHello handshake
              // message MUST be empty.
              byte[] extData = new byte[0];
  
              // Update the context.
<span class="udiff-line-modified-removed">-             shc.handshakeExtensions.put(</span>
<span class="udiff-line-modified-removed">-                     SH_STATUS_REQUEST, CertStatusRequestSpec.DEFAULT);</span>
<span class="udiff-line-modified-added">+             shc.handshakeExtensions.put(SSLExtension.SH_STATUS_REQUEST,</span>
<span class="udiff-line-modified-added">+                     CertStatusRequestSpec.DEFAULT);</span>
  
              return extData;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -706,11 +702,11 @@</span>
              // The producing happens in client side only.
              ClientHandshakeContext chc = (ClientHandshakeContext)context;
  
              // In response to &quot;status_request&quot; extension request only.
              CertStatusRequestSpec requestedCsr = (CertStatusRequestSpec)
<span class="udiff-line-modified-removed">-                     chc.handshakeExtensions.get(CH_STATUS_REQUEST);</span>
<span class="udiff-line-modified-added">+                     chc.handshakeExtensions.get(SSLExtension.CH_STATUS_REQUEST);</span>
              if (requestedCsr == null) {
                  throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
                      &quot;Unexpected status_request extension in ServerHello&quot;);
              }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -720,18 +716,20 @@</span>
                    &quot;Invalid status_request extension in ServerHello message: &quot; +
                    &quot;the extension data must be empty&quot;);
              }
  
              // Update the context.
<span class="udiff-line-modified-removed">-             chc.handshakeExtensions.put(</span>
<span class="udiff-line-modified-removed">-                     SH_STATUS_REQUEST, CertStatusRequestSpec.DEFAULT);</span>
<span class="udiff-line-removed">-             chc.handshakeConsumers.put(SSLHandshake.CERTIFICATE_STATUS.id,</span>
<span class="udiff-line-removed">-                     SSLHandshake.CERTIFICATE_STATUS);</span>
<span class="udiff-line-modified-added">+             chc.handshakeExtensions.put(SSLExtension.SH_STATUS_REQUEST,</span>
<span class="udiff-line-modified-added">+                     CertStatusRequestSpec.DEFAULT);</span>
  
              // Since we&#39;ve received a legitimate status_request in the
              // ServerHello, stapling is active if it&#39;s been enabled.
              chc.staplingActive = chc.sslContext.isStaplingEnabled(true);
<span class="udiff-line-added">+             if (chc.staplingActive) {</span>
<span class="udiff-line-added">+                 chc.handshakeConsumers.put(SSLHandshake.CERTIFICATE_STATUS.id,</span>
<span class="udiff-line-added">+                     SSLHandshake.CERTIFICATE_STATUS);</span>
<span class="udiff-line-added">+             }</span>
  
              // No impact on session resumption.
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -905,11 +903,11 @@</span>
  
              if (!chc.sslContext.isStaplingEnabled(true)) {
                  return null;
              }
  
<span class="udiff-line-modified-removed">-             if (!chc.sslConfig.isAvailable(CH_STATUS_REQUEST_V2)) {</span>
<span class="udiff-line-modified-added">+             if (!chc.sslConfig.isAvailable(SSLExtension.CH_STATUS_REQUEST_V2)) {</span>
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
                      SSLLogger.finest(
                          &quot;Ignore unavailable status_request_v2 extension&quot;);
                  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -922,12 +920,12 @@</span>
              // support specific responder or extensions later.
              byte[] extData = new byte[] {
                  0x00, 0x07, 0x02, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00};
  
              // Update the context.
<span class="udiff-line-modified-removed">-             chc.handshakeExtensions.put(</span>
<span class="udiff-line-modified-removed">-                     CH_STATUS_REQUEST_V2, CertStatusRequestV2Spec.DEFAULT);</span>
<span class="udiff-line-modified-added">+             chc.handshakeExtensions.put(SSLExtension.CH_STATUS_REQUEST_V2,</span>
<span class="udiff-line-modified-added">+                     CertStatusRequestV2Spec.DEFAULT);</span>
  
              return extData;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -947,11 +945,11 @@</span>
              HandshakeMessage message, ByteBuffer buffer) throws IOException {
  
              // The consuming happens in server side only.
              ServerHandshakeContext shc = (ServerHandshakeContext)context;
  
<span class="udiff-line-modified-removed">-             if (!shc.sslConfig.isAvailable(CH_STATUS_REQUEST_V2)) {</span>
<span class="udiff-line-modified-added">+             if (!shc.sslConfig.isAvailable(SSLExtension.CH_STATUS_REQUEST_V2)) {</span>
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
                      SSLLogger.finest(
                          &quot;Ignore unavailable status_request_v2 extension&quot;);
                  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -965,11 +963,12 @@</span>
              } catch (IOException ioe) {
                  throw shc.conContext.fatal(Alert.UNEXPECTED_MESSAGE, ioe);
              }
  
              // Update the context.
<span class="udiff-line-modified-removed">-             shc.handshakeExtensions.put(CH_STATUS_REQUEST_V2, spec);</span>
<span class="udiff-line-modified-added">+             shc.handshakeExtensions.put(SSLExtension.CH_STATUS_REQUEST_V2,</span>
<span class="udiff-line-added">+                     spec);</span>
              if (!shc.isResumption) {
                  shc.handshakeProducers.putIfAbsent(
                          SSLHandshake.CERTIFICATE_STATUS.id,
                          SSLHandshake.CERTIFICATE_STATUS);
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1009,11 +1008,11 @@</span>
                  return null;    // Do not produce status_request_v2 in SH
              }
  
              // In response to &quot;status_request_v2&quot; extension request only
              CertStatusRequestV2Spec spec = (CertStatusRequestV2Spec)
<span class="udiff-line-modified-removed">-                     shc.handshakeExtensions.get(CH_STATUS_REQUEST_V2);</span>
<span class="udiff-line-modified-added">+                 shc.handshakeExtensions.get(SSLExtension.CH_STATUS_REQUEST_V2);</span>
              if (spec == null) {
                  // Ignore, no status_request_v2 extension requested.
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
                      SSLLogger.finest(
                          &quot;Ignore unavailable status_request_v2 extension&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1034,12 +1033,12 @@</span>
              // The &quot;extension_data&quot; in the extended ServerHello handshake
              // message MUST be empty.
              byte[] extData = new byte[0];
  
              // Update the context.
<span class="udiff-line-modified-removed">-             shc.handshakeExtensions.put(</span>
<span class="udiff-line-modified-removed">-                     SH_STATUS_REQUEST_V2, CertStatusRequestV2Spec.DEFAULT);</span>
<span class="udiff-line-modified-added">+             shc.handshakeExtensions.put(SSLExtension.SH_STATUS_REQUEST_V2,</span>
<span class="udiff-line-modified-added">+                     CertStatusRequestV2Spec.DEFAULT);</span>
  
              return extData;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1061,11 +1060,11 @@</span>
              // The consumption happens in client side only.
              ClientHandshakeContext chc = (ClientHandshakeContext)context;
  
              // In response to &quot;status_request&quot; extension request only
              CertStatusRequestV2Spec requestedCsr = (CertStatusRequestV2Spec)
<span class="udiff-line-modified-removed">-                     chc.handshakeExtensions.get(CH_STATUS_REQUEST_V2);</span>
<span class="udiff-line-modified-added">+                 chc.handshakeExtensions.get(SSLExtension.CH_STATUS_REQUEST_V2);</span>
              if (requestedCsr == null) {
                  throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
                      &quot;Unexpected status_request_v2 extension in ServerHello&quot;);
              }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1075,18 +1074,22 @@</span>
                    &quot;Invalid status_request_v2 extension in ServerHello: &quot; +
                    &quot;the extension data must be empty&quot;);
              }
  
              // Update the context.
<span class="udiff-line-modified-removed">-             chc.handshakeExtensions.put(</span>
<span class="udiff-line-modified-removed">-                     SH_STATUS_REQUEST_V2, CertStatusRequestV2Spec.DEFAULT);</span>
<span class="udiff-line-removed">-             chc.handshakeConsumers.put(SSLHandshake.CERTIFICATE_STATUS.id,</span>
<span class="udiff-line-removed">-                     SSLHandshake.CERTIFICATE_STATUS);</span>
<span class="udiff-line-modified-added">+             chc.handshakeExtensions.put(SSLExtension.SH_STATUS_REQUEST_V2,</span>
<span class="udiff-line-modified-added">+                     CertStatusRequestV2Spec.DEFAULT);</span>
  
              // Since we&#39;ve received a legitimate status_request in the
<span class="udiff-line-modified-removed">-             // ServerHello, stapling is active if it&#39;s been enabled.</span>
<span class="udiff-line-modified-added">+             // ServerHello, stapling is active if it&#39;s been enabled.  If it</span>
<span class="udiff-line-added">+             // is active, make sure we add the CertificateStatus message</span>
<span class="udiff-line-added">+             // consumer.</span>
              chc.staplingActive = chc.sslContext.isStaplingEnabled(true);
<span class="udiff-line-added">+             if (chc.staplingActive) {</span>
<span class="udiff-line-added">+                 chc.handshakeConsumers.put(SSLHandshake.CERTIFICATE_STATUS.id,</span>
<span class="udiff-line-added">+                     SSLHandshake.CERTIFICATE_STATUS);</span>
<span class="udiff-line-added">+             }</span>
  
              // No impact on session resumption.
          }
      }
  
</pre>
<center><a href="BaseSSLSocketImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="CertificateMessage.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>