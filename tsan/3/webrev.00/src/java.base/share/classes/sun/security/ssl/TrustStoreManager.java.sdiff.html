<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/security/ssl/TrustStoreManager.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="TransportContext.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Utilities.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/TrustStoreManager.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.ssl;
 27 
 28 import java.io.*;
 29 import java.lang.ref.WeakReference;
 30 import java.security.*;
 31 import java.security.cert.*;
 32 import java.util.*;

 33 import sun.security.action.*;
 34 import sun.security.validator.TrustStoreUtil;
 35 
 36 /**
 37  * Collection of static utility methods to manage the default trusted KeyStores
 38  * effectively.
 39  */
 40 final class TrustStoreManager {
 41 
 42     // A singleton service to manage the default trusted KeyStores effectively.
 43     private static final TrustAnchorManager tam = new TrustAnchorManager();
 44 
 45     // Restrict instantiation of this class.
 46     private TrustStoreManager() {
 47         // empty
 48     }
 49 
 50     /**
 51      * Return an unmodifiable set of all trusted X509Certificates contained
 52      * in the default trusted KeyStore.
</pre>
<hr />
<pre>
227      *
228      * This class can be used to provide singleton services to access default
229      * trust KeyStore more effectively.
230      */
231     private static final class TrustAnchorManager {
232         // Last trust store descriptor.
233         private TrustStoreDescriptor descriptor;
234 
235         // The key store used for the trust anchors.
236         //
237         // Use weak reference so that the heavy loaded KeyStore object can
238         // be atomically cleared, and reloaded if needed.
239         private WeakReference&lt;KeyStore&gt; ksRef;
240 
241         // The trusted X.509 certificates in the key store.
242         //
243         // Use weak reference so that the heavy loaded certificates collection
244         // objects can be atomically cleared, and reloaded if needed.
245         private WeakReference&lt;Set&lt;X509Certificate&gt;&gt; csRef;
246 


247         private TrustAnchorManager() {
248             this.descriptor = null;
249             this.ksRef = new WeakReference&lt;&gt;(null);
250             this.csRef = new WeakReference&lt;&gt;(null);
251         }
252 
253         /**
254          * Get the default trusted KeyStore with the specified descriptor.
255          *
256          * @return null if the underlying KeyStore is not available.
257          */
<span class="line-modified">258         synchronized KeyStore getKeyStore(</span>
259                 TrustStoreDescriptor descriptor) throws Exception {
260 
261             TrustStoreDescriptor temporaryDesc = this.descriptor;
262             KeyStore ks = ksRef.get();
263             if ((ks != null) &amp;&amp; descriptor.equals(temporaryDesc)) {
264                 return ks;
265             }
266 
<span class="line-modified">267             // Reload a new key store.</span>
<span class="line-modified">268             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">269                 SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="line-modified">270             }</span>



271 
<span class="line-modified">272             ks = loadKeyStore(descriptor);</span>
<span class="line-modified">273             this.descriptor = descriptor;</span>
<span class="line-modified">274             this.ksRef = new WeakReference&lt;&gt;(ks);</span>








275 
276             return ks;
277         }
278 
279         /**
280          * Get trusted certificates in the default trusted KeyStore with
281          * the specified descriptor.
282          *
283          * @return empty collection if the underlying KeyStore is not available.
284          */
<span class="line-modified">285         synchronized Set&lt;X509Certificate&gt; getTrustedCerts(</span>
286                 TrustStoreDescriptor descriptor) throws Exception {
287 
288             KeyStore ks = null;
289             TrustStoreDescriptor temporaryDesc = this.descriptor;
290             Set&lt;X509Certificate&gt; certs = csRef.get();
<span class="line-modified">291             if (certs != null) {</span>
<span class="line-modified">292                 if (descriptor.equals(temporaryDesc)) {</span>
<span class="line-modified">293                     return certs;</span>













294                 } else {
<span class="line-modified">295                     // Use the new descriptor.</span>
<span class="line-modified">296                     this.descriptor = descriptor;</span>





297                 }
<span class="line-modified">298             } else {</span>
<span class="line-modified">299                 // Try to use the cached store at first.</span>
<span class="line-modified">300                 if (descriptor.equals(temporaryDesc)) {</span>
<span class="line-modified">301                     ks = ksRef.get();</span>
<span class="line-modified">302                 } else {</span>
<span class="line-modified">303                     // Use the new descriptor.</span>
<span class="line-modified">304                     this.descriptor = descriptor;</span>

305                 }
<span class="line-removed">306             }</span>
307 
<span class="line-modified">308             // Reload the trust store if needed.</span>
<span class="line-removed">309             if (ks == null) {</span>
310                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {
<span class="line-modified">311                     SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
312                 }
<span class="line-removed">313                 ks = loadKeyStore(descriptor);</span>
<span class="line-removed">314             }</span>
315 
<span class="line-modified">316             // Reload trust certs from the key store.</span>
<span class="line-modified">317             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">318                 SSLLogger.fine(&quot;Reload trust certs&quot;);</span>
<span class="line-modified">319             }</span>
320 
<span class="line-modified">321             certs = loadTrustedCerts(ks);</span>
<span class="line-modified">322             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">323                 SSLLogger.fine(&quot;Reloaded &quot; + certs.size() + &quot; trust certs&quot;);</span>
324             }
325 
<span class="line-removed">326             // Note that as ks is a local variable, it is not</span>
<span class="line-removed">327             // necessary to add it to the ksRef weak reference.</span>
<span class="line-removed">328             this.csRef = new WeakReference&lt;&gt;(certs);</span>
<span class="line-removed">329 </span>
330             return certs;
331         }
332 
333         /**
334          * Load the KeyStore as described in the specified descriptor.
335          */
336         private static KeyStore loadKeyStore(
337                 TrustStoreDescriptor descriptor) throws Exception {
338             if (!&quot;NONE&quot;.equals(descriptor.storeName) &amp;&amp;
339                     descriptor.storeFile == null) {
340 
341                 // No file available, no KeyStore available.
342                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {
343                     SSLLogger.fine(&quot;No available key store&quot;);
344                 }
345 
346                 return null;
347             }
348 
349             KeyStore ks;
</pre>
</td>
<td>
<hr />
<pre>
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.ssl;
 27 
 28 import java.io.*;
 29 import java.lang.ref.WeakReference;
 30 import java.security.*;
 31 import java.security.cert.*;
 32 import java.util.*;
<span class="line-added"> 33 import java.util.concurrent.locks.ReentrantLock;</span>
 34 import sun.security.action.*;
 35 import sun.security.validator.TrustStoreUtil;
 36 
 37 /**
 38  * Collection of static utility methods to manage the default trusted KeyStores
 39  * effectively.
 40  */
 41 final class TrustStoreManager {
 42 
 43     // A singleton service to manage the default trusted KeyStores effectively.
 44     private static final TrustAnchorManager tam = new TrustAnchorManager();
 45 
 46     // Restrict instantiation of this class.
 47     private TrustStoreManager() {
 48         // empty
 49     }
 50 
 51     /**
 52      * Return an unmodifiable set of all trusted X509Certificates contained
 53      * in the default trusted KeyStore.
</pre>
<hr />
<pre>
228      *
229      * This class can be used to provide singleton services to access default
230      * trust KeyStore more effectively.
231      */
232     private static final class TrustAnchorManager {
233         // Last trust store descriptor.
234         private TrustStoreDescriptor descriptor;
235 
236         // The key store used for the trust anchors.
237         //
238         // Use weak reference so that the heavy loaded KeyStore object can
239         // be atomically cleared, and reloaded if needed.
240         private WeakReference&lt;KeyStore&gt; ksRef;
241 
242         // The trusted X.509 certificates in the key store.
243         //
244         // Use weak reference so that the heavy loaded certificates collection
245         // objects can be atomically cleared, and reloaded if needed.
246         private WeakReference&lt;Set&lt;X509Certificate&gt;&gt; csRef;
247 
<span class="line-added">248         private final ReentrantLock tamLock = new ReentrantLock();</span>
<span class="line-added">249 </span>
250         private TrustAnchorManager() {
251             this.descriptor = null;
252             this.ksRef = new WeakReference&lt;&gt;(null);
253             this.csRef = new WeakReference&lt;&gt;(null);
254         }
255 
256         /**
257          * Get the default trusted KeyStore with the specified descriptor.
258          *
259          * @return null if the underlying KeyStore is not available.
260          */
<span class="line-modified">261         KeyStore getKeyStore(</span>
262                 TrustStoreDescriptor descriptor) throws Exception {
263 
264             TrustStoreDescriptor temporaryDesc = this.descriptor;
265             KeyStore ks = ksRef.get();
266             if ((ks != null) &amp;&amp; descriptor.equals(temporaryDesc)) {
267                 return ks;
268             }
269 
<span class="line-modified">270             tamLock.lock();</span>
<span class="line-modified">271             try {</span>
<span class="line-modified">272                 // double check</span>
<span class="line-modified">273                 ks = ksRef.get();</span>
<span class="line-added">274                 if ((ks != null) &amp;&amp; descriptor.equals(temporaryDesc)) {</span>
<span class="line-added">275                     return ks;</span>
<span class="line-added">276                 }</span>
277 
<span class="line-modified">278                 // Reload a new key store.</span>
<span class="line-modified">279                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">280                     SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="line-added">281                 }</span>
<span class="line-added">282 </span>
<span class="line-added">283                 ks = loadKeyStore(descriptor);</span>
<span class="line-added">284                 this.descriptor = descriptor;</span>
<span class="line-added">285                 this.ksRef = new WeakReference&lt;&gt;(ks);</span>
<span class="line-added">286             } finally {</span>
<span class="line-added">287                 tamLock.unlock();</span>
<span class="line-added">288             }</span>
289 
290             return ks;
291         }
292 
293         /**
294          * Get trusted certificates in the default trusted KeyStore with
295          * the specified descriptor.
296          *
297          * @return empty collection if the underlying KeyStore is not available.
298          */
<span class="line-modified">299         Set&lt;X509Certificate&gt; getTrustedCerts(</span>
300                 TrustStoreDescriptor descriptor) throws Exception {
301 
302             KeyStore ks = null;
303             TrustStoreDescriptor temporaryDesc = this.descriptor;
304             Set&lt;X509Certificate&gt; certs = csRef.get();
<span class="line-modified">305             if ((certs != null) &amp;&amp; descriptor.equals(temporaryDesc)) {</span>
<span class="line-modified">306                 return certs;</span>
<span class="line-modified">307             }</span>
<span class="line-added">308 </span>
<span class="line-added">309             tamLock.lock();</span>
<span class="line-added">310             try {</span>
<span class="line-added">311                 // double check</span>
<span class="line-added">312                 temporaryDesc = this.descriptor;</span>
<span class="line-added">313                 certs = csRef.get();</span>
<span class="line-added">314                 if (certs != null) {</span>
<span class="line-added">315                     if (descriptor.equals(temporaryDesc)) {</span>
<span class="line-added">316                         return certs;</span>
<span class="line-added">317                     } else {</span>
<span class="line-added">318                         // Use the new descriptor.</span>
<span class="line-added">319                         this.descriptor = descriptor;</span>
<span class="line-added">320                     }</span>
321                 } else {
<span class="line-modified">322                     // Try to use the cached store at first.</span>
<span class="line-modified">323                     if (descriptor.equals(temporaryDesc)) {</span>
<span class="line-added">324                         ks = ksRef.get();</span>
<span class="line-added">325                     } else {</span>
<span class="line-added">326                         // Use the new descriptor.</span>
<span class="line-added">327                         this.descriptor = descriptor;</span>
<span class="line-added">328                     }</span>
329                 }
<span class="line-modified">330 </span>
<span class="line-modified">331                 // Reload the trust store if needed.</span>
<span class="line-modified">332                 if (ks == null) {</span>
<span class="line-modified">333                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">334                         SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="line-modified">335                     }</span>
<span class="line-modified">336                     ks = loadKeyStore(descriptor);</span>
<span class="line-added">337                     this.ksRef = new WeakReference&lt;&gt;(ks);</span>
338                 }

339 
<span class="line-modified">340                 // Reload trust certs from the key store.</span>

341                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {
<span class="line-modified">342                     SSLLogger.fine(&quot;Reload trust certs&quot;);</span>
343                 }


344 
<span class="line-modified">345                 certs = loadTrustedCerts(ks);</span>
<span class="line-modified">346                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">347                     SSLLogger.fine(&quot;Reloaded &quot; + certs.size() + &quot; trust certs&quot;);</span>
<span class="line-modified">348                 }</span>
349 
<span class="line-modified">350                 this.csRef = new WeakReference&lt;&gt;(certs);</span>
<span class="line-modified">351             } finally {</span>
<span class="line-modified">352                 tamLock.unlock();</span>
353             }
354 




355             return certs;
356         }
357 
358         /**
359          * Load the KeyStore as described in the specified descriptor.
360          */
361         private static KeyStore loadKeyStore(
362                 TrustStoreDescriptor descriptor) throws Exception {
363             if (!&quot;NONE&quot;.equals(descriptor.storeName) &amp;&amp;
364                     descriptor.storeFile == null) {
365 
366                 // No file available, no KeyStore available.
367                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {
368                     SSLLogger.fine(&quot;No available key store&quot;);
369                 }
370 
371                 return null;
372             }
373 
374             KeyStore ks;
</pre>
</td>
</tr>
</table>
<center><a href="TransportContext.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Utilities.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>