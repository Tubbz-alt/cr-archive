<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.base/share/classes/sun/net/ext/ExtendedSocketOptions.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.net.ext;
 27 
 28 import java.io.FileDescriptor;
 29 import java.net.SocketException;
 30 import java.net.SocketOption;
 31 import java.util.Collections;
 32 import java.util.Set;
 33 import java.util.stream.Collectors;
 34 
 35 /**
 36  * Defines the infrastructure to support extended socket options, beyond those
 37  * defined in {@link java.net.StandardSocketOptions}.
 38  *
 39  * Extended socket options are accessed through the jdk.net API, which is in
 40  * the jdk.net module.
 41  */
 42 public abstract class ExtendedSocketOptions {
 43 
 44     public static final short SOCK_STREAM = 1;
 45     public static final short SOCK_DGRAM = 2;
 46 
 47     private final Set&lt;SocketOption&lt;?&gt;&gt; options;
 48 
 49     /** Tells whether or not the option is supported. */
 50     public final boolean isOptionSupported(SocketOption&lt;?&gt; option) {
 51         return options().contains(option);
 52     }
 53 
 54     /** Return the, possibly empty, set of extended socket options available. */
 55     public final Set&lt;SocketOption&lt;?&gt;&gt; options() { return options; }
 56 
 57     /**
 58      * Returns the (possibly empty) set of extended socket options for
 59      * stream-oriented listening sockets.
 60      */
 61     public static Set&lt;SocketOption&lt;?&gt;&gt; serverSocketOptions() {
 62         return getInstance().options0(SOCK_STREAM, true);
 63     }
 64 
 65     /**
 66      * Returns the (possibly empty) set of extended socket options for
 67      * stream-oriented connecting sockets.
 68      */
 69     public static Set&lt;SocketOption&lt;?&gt;&gt; clientSocketOptions() {
 70         return getInstance().options0(SOCK_STREAM, false);
 71     }
 72 
 73     /**
 74      * Returns the (possibly empty) set of extended socket options for
 75      * datagram-oriented sockets.
 76      */
 77     public static Set&lt;SocketOption&lt;?&gt;&gt; datagramSocketOptions() {
 78         return getInstance().options0(SOCK_DGRAM, false);
 79     }
 80 
 81     private boolean isDatagramOption(SocketOption&lt;?&gt; option) {
 82         return !option.name().startsWith(&quot;TCP_&quot;);
 83     }
 84 
 85     private boolean isStreamOption(SocketOption&lt;?&gt; option, boolean server) {
 86         if (server &amp;&amp; &quot;SO_FLOW_SLA&quot;.equals(option.name())) {
 87             return false;
 88         } else {
 89             return !option.name().startsWith(&quot;UDP_&quot;);
 90         }
 91     }
 92 
 93     private Set&lt;SocketOption&lt;?&gt;&gt; options0(short type, boolean server) {
 94         Set&lt;SocketOption&lt;?&gt;&gt; extOptions;
 95         switch (type) {
 96             case SOCK_DGRAM:
 97                 extOptions = options.stream()
 98                         .filter(option -&gt; isDatagramOption(option))
 99                         .collect(Collectors.toUnmodifiableSet());
100                 break;
101             case SOCK_STREAM:
102                 extOptions = options.stream()
103                         .filter(option -&gt; isStreamOption(option, server))
104                         .collect(Collectors.toUnmodifiableSet());
105                 break;
106             default:
107                 //this will never happen
108                 throw new IllegalArgumentException(&quot;Invalid socket option type&quot;);
109         }
110         return extOptions;
111     }
112 
113     /** Sets the value of a socket option, for the given socket. */
114     public abstract void setOption(FileDescriptor fd, SocketOption&lt;?&gt; option, Object value)
115             throws SocketException;
116 
117     /** Returns the value of a socket option, for the given socket. */
118     public abstract Object getOption(FileDescriptor fd, SocketOption&lt;?&gt; option)
119             throws SocketException;
120 
121     protected ExtendedSocketOptions(Set&lt;SocketOption&lt;?&gt;&gt; options) {
122         this.options = options;
123     }
124 
125     private static volatile ExtendedSocketOptions instance;
126 
127     public static final ExtendedSocketOptions getInstance() { return instance; }
128 
129     /** Registers support for extended socket options. Invoked by the jdk.net module. */
130     public static final void register(ExtendedSocketOptions extOptions) {
131         if (instance != null)
132             throw new InternalError(&quot;Attempting to reregister extended options&quot;);
133 
134         instance = extOptions;
135     }
136 
137     static {
138         try {
139             // If the class is present, it will be initialized which
140             // triggers registration of the extended socket options.
141             Class&lt;?&gt; c = Class.forName(&quot;jdk.net.ExtendedSocketOptions&quot;);
142         } catch (ClassNotFoundException e) {
143             // the jdk.net module is not present =&gt; no extended socket options
144             instance = new NoExtendedSocketOptions();
145         }
146     }
147 
148     static final class NoExtendedSocketOptions extends ExtendedSocketOptions {
149 
150         NoExtendedSocketOptions() {
151             super(Collections.&lt;SocketOption&lt;?&gt;&gt;emptySet());
152         }
153 
154         @Override
155         public void setOption(FileDescriptor fd, SocketOption&lt;?&gt; option, Object value)
156             throws SocketException
157         {
158             throw new UnsupportedOperationException(
159                     &quot;no extended options: &quot; + option.name());
160         }
161 
162         @Override
163         public Object getOption(FileDescriptor fd, SocketOption&lt;?&gt; option)
164             throws SocketException
165         {
166             throw new UnsupportedOperationException(
167                     &quot;no extended options: &quot; + option.name());
168         }
169     }
170 }
    </pre>
  </body>
</html>