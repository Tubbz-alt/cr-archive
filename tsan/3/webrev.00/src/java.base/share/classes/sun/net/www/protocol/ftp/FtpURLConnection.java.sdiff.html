<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/net/www/protocol/ftp/FtpURLConnection.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../http/KeepAliveCache.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Handler.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/net/www/protocol/ftp/FtpURLConnection.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1994, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /**
 27  * FTP stream opener.
 28  */
 29 
 30 package sun.net.www.protocol.ftp;
 31 
 32 import java.io.IOException;
 33 import java.io.InputStream;
 34 import java.io.OutputStream;
 35 import java.io.BufferedInputStream;
 36 import java.io.FilterInputStream;
 37 import java.io.FilterOutputStream;
 38 import java.io.FileNotFoundException;

 39 import java.net.URL;
 40 import java.net.SocketPermission;
 41 import java.net.UnknownHostException;
 42 import java.net.InetSocketAddress;
 43 import java.net.URI;
 44 import java.net.Proxy;
 45 import java.net.ProxySelector;

 46 import java.util.StringTokenizer;
 47 import java.util.Iterator;
 48 import java.security.Permission;
 49 import java.util.Properties;
 50 import sun.net.NetworkClient;

 51 import sun.net.www.MessageHeader;
 52 import sun.net.www.MeteredStream;
 53 import sun.net.www.URLConnection;
 54 import sun.net.www.protocol.http.HttpURLConnection;
 55 import sun.net.ftp.FtpClient;
 56 import sun.net.ftp.FtpProtocolException;
 57 import sun.net.ProgressSource;
 58 import sun.net.ProgressMonitor;
 59 import sun.net.www.ParseUtil;
 60 import sun.security.action.GetPropertyAction;
 61 
 62 
 63 /**
 64  * This class Opens an FTP input (or output) stream given a URL.
 65  * It works as a one shot FTP transfer :
 66  * &lt;UL&gt;
 67  * &lt;LI&gt;Login&lt;/LI&gt;
 68  * &lt;LI&gt;Get (or Put) the file&lt;/LI&gt;
 69  * &lt;LI&gt;Disconnect&lt;/LI&gt;
 70  * &lt;/UL&gt;
</pre>
<hr />
<pre>
140      *  - The Data socket (for the file).
141      *   - The command socket (FtpClient).
142      * Since that&#39;s the only class that needs to see that, it is an inner class.
143      */
144     protected class FtpOutputStream extends FilterOutputStream {
145         FtpClient ftp;
146         FtpOutputStream(FtpClient cl, OutputStream fd) {
147             super(fd);
148             ftp = cl;
149         }
150 
151         @Override
152         public void close() throws IOException {
153             super.close();
154             if (ftp != null) {
155                 ftp.close();
156             }
157         }
158     }
159 















160     /**
161      * Creates an FtpURLConnection from a URL.
162      *
163      * @param   url     The {@code URL} to retrieve or store.
164      */
165     public FtpURLConnection(URL url) {
166         this(url, null);
167     }
168 
169     /**
170      * Same as FtpURLconnection(URL) with a per connection proxy specified
171      */
172     FtpURLConnection(URL url, Proxy p) {
<span class="line-modified">173         super(url);</span>
174         instProxy = p;
175         host = url.getHost();
176         port = url.getPort();
177         String userInfo = url.getUserInfo();
178 
179         if (userInfo != null) { // get the user and password
180             int delimiter = userInfo.indexOf(&#39;:&#39;);
181             if (delimiter == -1) {
182                 user = ParseUtil.decode(userInfo);
183                 password = null;
184             } else {
185                 user = ParseUtil.decode(userInfo.substring(0, delimiter++));
186                 password = ParseUtil.decode(userInfo.substring(delimiter));
187             }
188         }
189     }
190 
191     private void setTimeouts() {
192         if (ftp != null) {
193             if (connectTimeout &gt;= 0) {
</pre>
<hr />
<pre>
208      */
209 
210     public synchronized void connect() throws IOException {
211         if (connected) {
212             return;
213         }
214 
215         Proxy p = null;
216         if (instProxy == null) { // no per connection proxy specified
217             /**
218              * Do we have to use a proxy?
219              */
220             ProxySelector sel = java.security.AccessController.doPrivileged(
221                     new java.security.PrivilegedAction&lt;ProxySelector&gt;() {
222                         public ProxySelector run() {
223                             return ProxySelector.getDefault();
224                         }
225                     });
226             if (sel != null) {
227                 URI uri = sun.net.www.ParseUtil.toURI(url);
<span class="line-modified">228                 Iterator&lt;Proxy&gt; it = sel.select(uri).iterator();</span>






229                 while (it.hasNext()) {
230                     p = it.next();
231                     if (p == null || p == Proxy.NO_PROXY ||
232                         p.type() == Proxy.Type.SOCKS) {
233                         break;
234                     }
235                     if (p.type() != Proxy.Type.HTTP ||
236                             !(p.address() instanceof InetSocketAddress)) {
237                         sel.connectFailed(uri, p.address(), new IOException(&quot;Wrong proxy type&quot;));
238                         continue;
239                     }
240                     // OK, we have an http proxy
241                     InetSocketAddress paddr = (InetSocketAddress) p.address();
242                     try {
243                         http = new HttpURLConnection(url, p);
244                         http.setDoInput(getDoInput());
245                         http.setDoOutput(getDoOutput());
246                         if (connectTimeout &gt;= 0) {
247                             http.setConnectTimeout(connectTimeout);
248                         }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1994, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /**
 27  * FTP stream opener.
 28  */
 29 
 30 package sun.net.www.protocol.ftp;
 31 
 32 import java.io.IOException;
 33 import java.io.InputStream;
 34 import java.io.OutputStream;
 35 import java.io.BufferedInputStream;
 36 import java.io.FilterInputStream;
 37 import java.io.FilterOutputStream;
 38 import java.io.FileNotFoundException;
<span class="line-added"> 39 import java.net.MalformedURLException;</span>
 40 import java.net.URL;
 41 import java.net.SocketPermission;
 42 import java.net.UnknownHostException;
 43 import java.net.InetSocketAddress;
 44 import java.net.URI;
 45 import java.net.Proxy;
 46 import java.net.ProxySelector;
<span class="line-added"> 47 import java.util.List;</span>
 48 import java.util.StringTokenizer;
 49 import java.util.Iterator;
 50 import java.security.Permission;
 51 import java.util.Properties;
 52 import sun.net.NetworkClient;
<span class="line-added"> 53 import sun.net.util.IPAddressUtil;</span>
 54 import sun.net.www.MessageHeader;
 55 import sun.net.www.MeteredStream;
 56 import sun.net.www.URLConnection;
 57 import sun.net.www.protocol.http.HttpURLConnection;
 58 import sun.net.ftp.FtpClient;
 59 import sun.net.ftp.FtpProtocolException;
 60 import sun.net.ProgressSource;
 61 import sun.net.ProgressMonitor;
 62 import sun.net.www.ParseUtil;
 63 import sun.security.action.GetPropertyAction;
 64 
 65 
 66 /**
 67  * This class Opens an FTP input (or output) stream given a URL.
 68  * It works as a one shot FTP transfer :
 69  * &lt;UL&gt;
 70  * &lt;LI&gt;Login&lt;/LI&gt;
 71  * &lt;LI&gt;Get (or Put) the file&lt;/LI&gt;
 72  * &lt;LI&gt;Disconnect&lt;/LI&gt;
 73  * &lt;/UL&gt;
</pre>
<hr />
<pre>
143      *  - The Data socket (for the file).
144      *   - The command socket (FtpClient).
145      * Since that&#39;s the only class that needs to see that, it is an inner class.
146      */
147     protected class FtpOutputStream extends FilterOutputStream {
148         FtpClient ftp;
149         FtpOutputStream(FtpClient cl, OutputStream fd) {
150             super(fd);
151             ftp = cl;
152         }
153 
154         @Override
155         public void close() throws IOException {
156             super.close();
157             if (ftp != null) {
158                 ftp.close();
159             }
160         }
161     }
162 
<span class="line-added">163     static URL checkURL(URL u) throws IllegalArgumentException {</span>
<span class="line-added">164         if (u != null) {</span>
<span class="line-added">165             if (u.toExternalForm().indexOf(&#39;\n&#39;) &gt; -1) {</span>
<span class="line-added">166                 Exception mfue = new MalformedURLException(&quot;Illegal character in URL&quot;);</span>
<span class="line-added">167                 throw new IllegalArgumentException(mfue.getMessage(), mfue);</span>
<span class="line-added">168             }</span>
<span class="line-added">169         }</span>
<span class="line-added">170         String s = IPAddressUtil.checkAuthority(u);</span>
<span class="line-added">171         if (s != null) {</span>
<span class="line-added">172             Exception mfue = new MalformedURLException(s);</span>
<span class="line-added">173             throw new IllegalArgumentException(mfue.getMessage(), mfue);</span>
<span class="line-added">174         }</span>
<span class="line-added">175         return u;</span>
<span class="line-added">176     }</span>
<span class="line-added">177 </span>
178     /**
179      * Creates an FtpURLConnection from a URL.
180      *
181      * @param   url     The {@code URL} to retrieve or store.
182      */
183     public FtpURLConnection(URL url) {
184         this(url, null);
185     }
186 
187     /**
188      * Same as FtpURLconnection(URL) with a per connection proxy specified
189      */
190     FtpURLConnection(URL url, Proxy p) {
<span class="line-modified">191         super(checkURL(url));</span>
192         instProxy = p;
193         host = url.getHost();
194         port = url.getPort();
195         String userInfo = url.getUserInfo();
196 
197         if (userInfo != null) { // get the user and password
198             int delimiter = userInfo.indexOf(&#39;:&#39;);
199             if (delimiter == -1) {
200                 user = ParseUtil.decode(userInfo);
201                 password = null;
202             } else {
203                 user = ParseUtil.decode(userInfo.substring(0, delimiter++));
204                 password = ParseUtil.decode(userInfo.substring(delimiter));
205             }
206         }
207     }
208 
209     private void setTimeouts() {
210         if (ftp != null) {
211             if (connectTimeout &gt;= 0) {
</pre>
<hr />
<pre>
226      */
227 
228     public synchronized void connect() throws IOException {
229         if (connected) {
230             return;
231         }
232 
233         Proxy p = null;
234         if (instProxy == null) { // no per connection proxy specified
235             /**
236              * Do we have to use a proxy?
237              */
238             ProxySelector sel = java.security.AccessController.doPrivileged(
239                     new java.security.PrivilegedAction&lt;ProxySelector&gt;() {
240                         public ProxySelector run() {
241                             return ProxySelector.getDefault();
242                         }
243                     });
244             if (sel != null) {
245                 URI uri = sun.net.www.ParseUtil.toURI(url);
<span class="line-modified">246                 final List&lt;Proxy&gt; proxies;</span>
<span class="line-added">247                 try {</span>
<span class="line-added">248                     proxies = sel.select(uri);</span>
<span class="line-added">249                 } catch (IllegalArgumentException iae) {</span>
<span class="line-added">250                     throw new IOException(&quot;Failed to select a proxy&quot;, iae);</span>
<span class="line-added">251                 }</span>
<span class="line-added">252                 final Iterator&lt;Proxy&gt; it = proxies.iterator();</span>
253                 while (it.hasNext()) {
254                     p = it.next();
255                     if (p == null || p == Proxy.NO_PROXY ||
256                         p.type() == Proxy.Type.SOCKS) {
257                         break;
258                     }
259                     if (p.type() != Proxy.Type.HTTP ||
260                             !(p.address() instanceof InetSocketAddress)) {
261                         sel.connectFailed(uri, p.address(), new IOException(&quot;Wrong proxy type&quot;));
262                         continue;
263                     }
264                     // OK, we have an http proxy
265                     InetSocketAddress paddr = (InetSocketAddress) p.address();
266                     try {
267                         http = new HttpURLConnection(url, p);
268                         http.setDoInput(getDoInput());
269                         http.setDoOutput(getDoOutput());
270                         if (connectTimeout &gt;= 0) {
271                             http.setConnectTimeout(connectTimeout);
272                         }
</pre>
</td>
</tr>
</table>
<center><a href="../../http/KeepAliveCache.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Handler.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>