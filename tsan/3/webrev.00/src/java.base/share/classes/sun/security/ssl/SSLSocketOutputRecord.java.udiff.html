<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/ssl/SSLSocketOutputRecord.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SSLSocketInputRecord.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SSLTransport.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/SSLSocketOutputRecord.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1996, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1996, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -49,127 +49,210 @@</span>
          this.packetSize = SSLRecord.maxRecordSize;
          this.protocolVersion = ProtocolVersion.NONE;
      }
  
      @Override
<span class="udiff-line-modified-removed">-     synchronized void encodeAlert(</span>
<span class="udiff-line-modified-removed">-             byte level, byte description) throws IOException {</span>
<span class="udiff-line-modified-removed">-         if (isClosed()) {</span>
<span class="udiff-line-modified-removed">-             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SSLLogger.warning(&quot;outbound has closed, ignore outbound &quot; +</span>
<span class="udiff-line-modified-removed">-                     &quot;alert message: &quot; + Alert.nameOf(description));</span>
<span class="udiff-line-modified-added">+     void encodeAlert(byte level, byte description) throws IOException {</span>
<span class="udiff-line-modified-added">+         recordLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             if (isClosed()) {</span>
<span class="udiff-line-modified-added">+                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SSLLogger.warning(&quot;outbound has closed, ignore outbound &quot; +</span>
<span class="udiff-line-added">+                         &quot;alert message: &quot; + Alert.nameOf(description));</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 return;</span>
              }
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
  
<span class="udiff-line-modified-removed">-         // use the buf of ByteArrayOutputStream</span>
<span class="udiff-line-modified-removed">-         int position = headerSize + writeCipher.getExplicitNonceSize();</span>
<span class="udiff-line-modified-removed">-         count = position;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         write(level);</span>
<span class="udiff-line-modified-removed">-         write(description);</span>
<span class="udiff-line-modified-removed">-         if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;record&quot;)) {</span>
<span class="udiff-line-modified-removed">-             SSLLogger.fine(&quot;WRITE: &quot; + protocolVersion +</span>
<span class="udiff-line-modified-removed">-                     &quot; &quot; + ContentType.ALERT.name +</span>
<span class="udiff-line-modified-removed">-                     &quot;(&quot; + Alert.nameOf(description) + &quot;)&quot; +</span>
<span class="udiff-line-modified-removed">-                     &quot;, length = &quot; + (count - headerSize));</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+             // use the buf of ByteArrayOutputStream</span>
<span class="udiff-line-modified-added">+             int position = headerSize + writeCipher.getExplicitNonceSize();</span>
<span class="udiff-line-modified-added">+             count = position;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             write(level);</span>
<span class="udiff-line-modified-added">+             write(description);</span>
<span class="udiff-line-modified-added">+             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;record&quot;)) {</span>
<span class="udiff-line-modified-added">+                 SSLLogger.fine(&quot;WRITE: &quot; + protocolVersion +</span>
<span class="udiff-line-modified-added">+                         &quot; &quot; + ContentType.ALERT.name +</span>
<span class="udiff-line-modified-added">+                         &quot;(&quot; + Alert.nameOf(description) + &quot;)&quot; +</span>
<span class="udiff-line-modified-added">+                         &quot;, length = &quot; + (count - headerSize));</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         // Encrypt the fragment and wrap up a record.</span>
<span class="udiff-line-modified-removed">-         encrypt(writeCipher, ContentType.ALERT.id, headerSize);</span>
<span class="udiff-line-modified-added">+             // Encrypt the fragment and wrap up a record.</span>
<span class="udiff-line-modified-added">+             encrypt(writeCipher, ContentType.ALERT.id, headerSize);</span>
  
<span class="udiff-line-modified-removed">-         // deliver this message</span>
<span class="udiff-line-modified-removed">-         deliverStream.write(buf, 0, count);    // may throw IOException</span>
<span class="udiff-line-modified-removed">-         deliverStream.flush();                 // may throw IOException</span>
<span class="udiff-line-modified-added">+             // deliver this message</span>
<span class="udiff-line-modified-added">+             deliverStream.write(buf, 0, count);    // may throw IOException</span>
<span class="udiff-line-modified-added">+             deliverStream.flush();                 // may throw IOException</span>
  
<span class="udiff-line-modified-removed">-         if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {</span>
<span class="udiff-line-modified-removed">-             SSLLogger.fine(&quot;Raw write&quot;,</span>
<span class="udiff-line-modified-removed">-                     (new ByteArrayInputStream(buf, 0, count)));</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {</span>
<span class="udiff-line-modified-added">+                 SSLLogger.fine(&quot;Raw write&quot;,</span>
<span class="udiff-line-modified-added">+                         (new ByteArrayInputStream(buf, 0, count)));</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         // reset the internal buffer</span>
<span class="udiff-line-modified-removed">-         count = 0;</span>
<span class="udiff-line-modified-added">+             // reset the internal buffer</span>
<span class="udiff-line-modified-added">+             count = 0;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             recordLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     synchronized void encodeHandshake(byte[] source,</span>
<span class="udiff-line-modified-added">+     void encodeHandshake(byte[] source,</span>
              int offset, int length) throws IOException {
<span class="udiff-line-modified-removed">-         if (isClosed()) {</span>
<span class="udiff-line-modified-removed">-             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SSLLogger.warning(&quot;outbound has closed, ignore outbound &quot; +</span>
<span class="udiff-line-modified-removed">-                         &quot;handshake message&quot;,</span>
<span class="udiff-line-modified-removed">-                         ByteBuffer.wrap(source, offset, length));</span>
<span class="udiff-line-modified-added">+         recordLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             if (isClosed()) {</span>
<span class="udiff-line-modified-added">+                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SSLLogger.warning(&quot;outbound has closed, ignore outbound &quot; +</span>
<span class="udiff-line-added">+                             &quot;handshake message&quot;,</span>
<span class="udiff-line-added">+                             ByteBuffer.wrap(source, offset, length));</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 return;</span>
              }
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
  
<span class="udiff-line-modified-removed">-         if (firstMessage) {</span>
<span class="udiff-line-modified-removed">-             firstMessage = false;</span>
<span class="udiff-line-modified-added">+             if (firstMessage) {</span>
<span class="udiff-line-modified-added">+                 firstMessage = false;</span>
  
<span class="udiff-line-modified-removed">-             if ((helloVersion == ProtocolVersion.SSL20Hello) &amp;&amp;</span>
<span class="udiff-line-modified-removed">-                 (source[offset] == SSLHandshake.CLIENT_HELLO.id) &amp;&amp;</span>
<span class="udiff-line-modified-added">+                 if ((helloVersion == ProtocolVersion.SSL20Hello) &amp;&amp;</span>
<span class="udiff-line-modified-added">+                     (source[offset] == SSLHandshake.CLIENT_HELLO.id) &amp;&amp;</span>
                                              //  5: recode header size
<span class="udiff-line-modified-removed">-                 (source[offset + 4 + 2 + 32] == 0)) {</span>
<span class="udiff-line-modified-added">+                     (source[offset + 4 + 2 + 32] == 0)) {</span>
                                              // V3 session ID is empty
                                              //  4: handshake header size
                                              //  2: client_version in ClientHello
                                              // 32: random in ClientHello
  
<span class="udiff-line-modified-removed">-                 ByteBuffer v2ClientHello = encodeV2ClientHello(</span>
<span class="udiff-line-modified-removed">-                         source, (offset + 4), (length - 4));</span>
<span class="udiff-line-modified-added">+                     ByteBuffer v2ClientHello = encodeV2ClientHello(</span>
<span class="udiff-line-modified-added">+                             source, (offset + 4), (length - 4));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     // array offset is zero</span>
<span class="udiff-line-added">+                     byte[] record = v2ClientHello.array();</span>
<span class="udiff-line-added">+                     int limit = v2ClientHello.limit();</span>
<span class="udiff-line-added">+                     handshakeHash.deliver(record, 2, (limit - 2));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;record&quot;)) {</span>
<span class="udiff-line-added">+                         SSLLogger.fine(</span>
<span class="udiff-line-added">+                                 &quot;WRITE: SSLv2 ClientHello message&quot; +</span>
<span class="udiff-line-added">+                                 &quot;, length = &quot; + limit);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     // deliver this message</span>
<span class="udiff-line-added">+                     //</span>
<span class="udiff-line-added">+                     // Version 2 ClientHello message should be plaintext.</span>
<span class="udiff-line-added">+                     //</span>
<span class="udiff-line-added">+                     // No max fragment length negotiation.</span>
<span class="udiff-line-added">+                     deliverStream.write(record, 0, limit);</span>
<span class="udiff-line-added">+                     deliverStream.flush();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {</span>
<span class="udiff-line-added">+                         SSLLogger.fine(&quot;Raw write&quot;,</span>
<span class="udiff-line-added">+                                 (new ByteArrayInputStream(record, 0, limit)));</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     return;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             byte handshakeType = source[0];</span>
<span class="udiff-line-added">+             if (handshakeHash.isHashable(handshakeType)) {</span>
<span class="udiff-line-added">+                 handshakeHash.deliver(source, offset, length);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             int fragLimit = getFragLimit();</span>
<span class="udiff-line-added">+             int position = headerSize + writeCipher.getExplicitNonceSize();</span>
<span class="udiff-line-added">+             if (count == 0) {</span>
<span class="udiff-line-added">+                 count = position;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if ((count - position) &lt; (fragLimit - length)) {</span>
<span class="udiff-line-added">+                 write(source, offset, length);</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             for (int limit = (offset + length); offset &lt; limit;) {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 int remains = (limit - offset) + (count - position);</span>
<span class="udiff-line-added">+                 int fragLen = Math.min(fragLimit, remains);</span>
  
<span class="udiff-line-modified-removed">-                 byte[] record = v2ClientHello.array();  // array offset is zero</span>
<span class="udiff-line-modified-removed">-                 int limit = v2ClientHello.limit();</span>
<span class="udiff-line-modified-removed">-                 handshakeHash.deliver(record, 2, (limit - 2));</span>
<span class="udiff-line-modified-added">+                 // use the buf of ByteArrayOutputStream</span>
<span class="udiff-line-modified-added">+                 write(source, offset, fragLen);</span>
<span class="udiff-line-modified-added">+                 if (remains &lt; fragLimit) {</span>
<span class="udiff-line-added">+                     return;</span>
<span class="udiff-line-added">+                 }</span>
  
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;record&quot;)) {
                      SSLLogger.fine(
<span class="udiff-line-modified-removed">-                             &quot;WRITE: SSLv2 ClientHello message&quot; +</span>
<span class="udiff-line-modified-removed">-                             &quot;, length = &quot; + limit);</span>
<span class="udiff-line-modified-added">+                             &quot;WRITE: &quot; + protocolVersion +</span>
<span class="udiff-line-modified-added">+                             &quot; &quot; + ContentType.HANDSHAKE.name +</span>
<span class="udiff-line-added">+                             &quot;, length = &quot; + (count - headerSize));</span>
                  }
  
<span class="udiff-line-added">+                 // Encrypt the fragment and wrap up a record.</span>
<span class="udiff-line-added">+                 encrypt(writeCipher, ContentType.HANDSHAKE.id, headerSize);</span>
<span class="udiff-line-added">+ </span>
                  // deliver this message
<span class="udiff-line-modified-removed">-                 //</span>
<span class="udiff-line-modified-removed">-                 // Version 2 ClientHello message should be plaintext.</span>
<span class="udiff-line-removed">-                 //</span>
<span class="udiff-line-removed">-                 // No max fragment length negotiation.</span>
<span class="udiff-line-removed">-                 deliverStream.write(record, 0, limit);</span>
<span class="udiff-line-removed">-                 deliverStream.flush();</span>
<span class="udiff-line-modified-added">+                 deliverStream.write(buf, 0, count);    // may throw IOException</span>
<span class="udiff-line-modified-added">+                 deliverStream.flush();                 // may throw IOException</span>
  
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {
                      SSLLogger.fine(&quot;Raw write&quot;,
<span class="udiff-line-modified-removed">-                             (new ByteArrayInputStream(record, 0, limit)));</span>
<span class="udiff-line-modified-added">+                             (new ByteArrayInputStream(buf, 0, count)));</span>
                  }
  
<span class="udiff-line-modified-removed">-                 return;</span>
<span class="udiff-line-modified-added">+                 // reset the offset</span>
<span class="udiff-line-added">+                 offset += fragLen;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 // reset the internal buffer</span>
<span class="udiff-line-added">+                 count = position;</span>
              }
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             recordLock.unlock();</span>
          }
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         byte handshakeType = source[0];</span>
<span class="udiff-line-modified-removed">-         if (handshakeHash.isHashable(handshakeType)) {</span>
<span class="udiff-line-modified-removed">-             handshakeHash.deliver(source, offset, length);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     @Override</span>
<span class="udiff-line-modified-added">+     void encodeChangeCipherSpec() throws IOException {</span>
<span class="udiff-line-modified-added">+         recordLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-added">+             if (isClosed()) {</span>
<span class="udiff-line-added">+                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-added">+                     SSLLogger.warning(&quot;outbound has closed, ignore outbound &quot; +</span>
<span class="udiff-line-added">+                         &quot;change_cipher_spec message&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         int fragLimit = getFragLimit();</span>
<span class="udiff-line-modified-removed">-         int position = headerSize + writeCipher.getExplicitNonceSize();</span>
<span class="udiff-line-removed">-         if (count == 0) {</span>
<span class="udiff-line-modified-added">+             // use the buf of ByteArrayOutputStream</span>
<span class="udiff-line-modified-added">+             int position = headerSize + writeCipher.getExplicitNonceSize();</span>
              count = position;
<span class="udiff-line-removed">-         }</span>
  
<span class="udiff-line-modified-removed">-         if ((count - position) &lt; (fragLimit - length)) {</span>
<span class="udiff-line-removed">-             write(source, offset, length);</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+             write((byte)1);         // byte 1: change_cipher_spec(</span>
  
<span class="udiff-line-modified-removed">-         for (int limit = (offset + length); offset &lt; limit;) {</span>
<span class="udiff-line-modified-added">+             // Encrypt the fragment and wrap up a record.</span>
<span class="udiff-line-added">+             encrypt(writeCipher, ContentType.CHANGE_CIPHER_SPEC.id, headerSize);</span>
  
<span class="udiff-line-modified-removed">-             int remains = (limit - offset) + (count - position);</span>
<span class="udiff-line-modified-removed">-             int fragLen = Math.min(fragLimit, remains);</span>
<span class="udiff-line-modified-added">+             // deliver this message</span>
<span class="udiff-line-modified-added">+             deliverStream.write(buf, 0, count);        // may throw IOException</span>
<span class="udiff-line-added">+             // deliverStream.flush();                  // flush in Finished</span>
  
<span class="udiff-line-modified-removed">-             // use the buf of ByteArrayOutputStream</span>
<span class="udiff-line-modified-removed">-             write(source, offset, fragLen);</span>
<span class="udiff-line-modified-removed">-             if (remains &lt; fragLimit) {</span>
<span class="udiff-line-modified-added">+             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {</span>
<span class="udiff-line-modified-added">+                 SSLLogger.fine(&quot;Raw write&quot;,</span>
<span class="udiff-line-modified-added">+                         (new ByteArrayInputStream(buf, 0, count)));</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // reset the internal buffer</span>
<span class="udiff-line-added">+             count = 0;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             recordLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public void flush() throws IOException {</span>
<span class="udiff-line-added">+         recordLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             int position = headerSize + writeCipher.getExplicitNonceSize();</span>
<span class="udiff-line-added">+             if (count &lt;= position) {</span>
                  return;
              }
  
              if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;record&quot;)) {
                  SSLLogger.fine(
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -188,159 +271,106 @@</span>
              if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {
                  SSLLogger.fine(&quot;Raw write&quot;,
                          (new ByteArrayInputStream(buf, 0, count)));
              }
  
<span class="udiff-line-removed">-             // reset the offset</span>
<span class="udiff-line-removed">-             offset += fragLen;</span>
<span class="udiff-line-removed">- </span>
              // reset the internal buffer
<span class="udiff-line-modified-removed">-             count = position;</span>
<span class="udiff-line-modified-added">+             count = 0;      // DON&#39;T use position</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             recordLock.unlock();</span>
          }
      }
  
      @Override
<span class="udiff-line-modified-removed">-     synchronized void encodeChangeCipherSpec() throws IOException {</span>
<span class="udiff-line-modified-removed">-         if (isClosed()) {</span>
<span class="udiff-line-modified-removed">-             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SSLLogger.warning(&quot;outbound has closed, ignore outbound &quot; +</span>
<span class="udiff-line-modified-removed">-                     &quot;change_cipher_spec message&quot;);</span>
<span class="udiff-line-modified-added">+     void deliver(byte[] source, int offset, int length) throws IOException {</span>
<span class="udiff-line-modified-added">+         recordLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             if (isClosed()) {</span>
<span class="udiff-line-modified-added">+                 throw new SocketException(</span>
<span class="udiff-line-added">+                         &quot;Connection or outbound has been closed&quot;);</span>
              }
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // use the buf of ByteArrayOutputStream</span>
<span class="udiff-line-removed">-         int position = headerSize + writeCipher.getExplicitNonceSize();</span>
<span class="udiff-line-removed">-         count = position;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         write((byte)1);         // byte 1: change_cipher_spec(</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Encrypt the fragment and wrap up a record.</span>
<span class="udiff-line-removed">-         encrypt(writeCipher, ContentType.CHANGE_CIPHER_SPEC.id, headerSize);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // deliver this message</span>
<span class="udiff-line-removed">-         deliverStream.write(buf, 0, count);        // may throw IOException</span>
<span class="udiff-line-removed">-         // deliverStream.flush();                  // flush in Finished</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {</span>
<span class="udiff-line-removed">-             SSLLogger.fine(&quot;Raw write&quot;,</span>
<span class="udiff-line-removed">-                     (new ByteArrayInputStream(buf, 0, count)));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // reset the internal buffer</span>
<span class="udiff-line-removed">-         count = 0;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Override</span>
<span class="udiff-line-removed">-     public synchronized void flush() throws IOException {</span>
<span class="udiff-line-removed">-         int position = headerSize + writeCipher.getExplicitNonceSize();</span>
<span class="udiff-line-removed">-         if (count &lt;= position) {</span>
<span class="udiff-line-removed">-             return;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;record&quot;)) {</span>
<span class="udiff-line-removed">-             SSLLogger.fine(</span>
<span class="udiff-line-removed">-                     &quot;WRITE: &quot; + protocolVersion +</span>
<span class="udiff-line-removed">-                     &quot; &quot; + ContentType.HANDSHAKE.name +</span>
<span class="udiff-line-removed">-                     &quot;, length = &quot; + (count - headerSize));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Encrypt the fragment and wrap up a record.</span>
<span class="udiff-line-removed">-         encrypt(writeCipher, ContentType.HANDSHAKE.id, headerSize);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // deliver this message</span>
<span class="udiff-line-removed">-         deliverStream.write(buf, 0, count);    // may throw IOException</span>
<span class="udiff-line-removed">-         deliverStream.flush();                 // may throw IOException</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {</span>
<span class="udiff-line-removed">-             SSLLogger.fine(&quot;Raw write&quot;,</span>
<span class="udiff-line-removed">-                     (new ByteArrayInputStream(buf, 0, count)));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // reset the internal buffer</span>
<span class="udiff-line-removed">-         count = 0;      // DON&#39;T use position</span>
<span class="udiff-line-removed">-     }</span>
  
<span class="udiff-line-modified-removed">-     @Override</span>
<span class="udiff-line-modified-removed">-     synchronized void deliver(</span>
<span class="udiff-line-modified-removed">-             byte[] source, int offset, int length) throws IOException {</span>
<span class="udiff-line-modified-removed">-         if (isClosed()) {</span>
<span class="udiff-line-modified-removed">-             throw new SocketException(&quot;Connection or outbound has been closed&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+             if (writeCipher.authenticator.seqNumOverflow()) {</span>
<span class="udiff-line-modified-added">+                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SSLLogger.fine(</span>
<span class="udiff-line-modified-added">+                         &quot;sequence number extremely close to overflow &quot; +</span>
<span class="udiff-line-modified-added">+                         &quot;(2^64-1 packets). Closing connection.&quot;);</span>
<span class="udiff-line-modified-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-         if (writeCipher.authenticator.seqNumOverflow()) {</span>
<span class="udiff-line-removed">-             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-removed">-                 SSLLogger.fine(</span>
<span class="udiff-line-removed">-                     &quot;sequence number extremely close to overflow &quot; +</span>
<span class="udiff-line-removed">-                     &quot;(2^64-1 packets). Closing connection.&quot;);</span>
<span class="udiff-line-modified-added">+                 throw new SSLHandshakeException(&quot;sequence number overflow&quot;);</span>
              }
  
<span class="udiff-line-modified-removed">-             throw new SSLHandshakeException(&quot;sequence number overflow&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+             boolean isFirstRecordOfThePayload = true;</span>
<span class="udiff-line-modified-added">+             for (int limit = (offset + length); offset &lt; limit;) {</span>
<span class="udiff-line-added">+                 int fragLen;</span>
<span class="udiff-line-added">+                 if (packetSize &gt; 0) {</span>
<span class="udiff-line-added">+                     fragLen = Math.min(maxRecordSize, packetSize);</span>
<span class="udiff-line-added">+                     fragLen = writeCipher.calculateFragmentSize(</span>
<span class="udiff-line-added">+                             fragLen, headerSize);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     fragLen = Math.min(fragLen, Record.maxDataSize);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     fragLen = Record.maxDataSize;</span>
<span class="udiff-line-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-         boolean isFirstRecordOfThePayload = true;</span>
<span class="udiff-line-modified-removed">-         for (int limit = (offset + length); offset &lt; limit;) {</span>
<span class="udiff-line-removed">-             int fragLen;</span>
<span class="udiff-line-removed">-             if (packetSize &gt; 0) {</span>
<span class="udiff-line-removed">-                 fragLen = Math.min(maxRecordSize, packetSize);</span>
<span class="udiff-line-removed">-                 fragLen =</span>
<span class="udiff-line-removed">-                         writeCipher.calculateFragmentSize(fragLen, headerSize);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 fragLen = Math.min(fragLen, Record.maxDataSize);</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 fragLen = Record.maxDataSize;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+                 // Calculate more impact, for example TLS 1.3 padding.</span>
<span class="udiff-line-modified-added">+                 fragLen = calculateFragmentSize(fragLen);</span>
  
<span class="udiff-line-modified-removed">-             if (fragmentSize &gt; 0) {</span>
<span class="udiff-line-modified-removed">-                 fragLen = Math.min(fragLen, fragmentSize);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+                 if (isFirstRecordOfThePayload &amp;&amp; needToSplitPayload()) {</span>
<span class="udiff-line-modified-added">+                     fragLen = 1;</span>
<span class="udiff-line-modified-added">+                     isFirstRecordOfThePayload = false;</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     fragLen = Math.min(fragLen, (limit - offset));</span>
<span class="udiff-line-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-             if (isFirstRecordOfThePayload &amp;&amp; needToSplitPayload()) {</span>
<span class="udiff-line-modified-removed">-                 fragLen = 1;</span>
<span class="udiff-line-modified-removed">-                 isFirstRecordOfThePayload = false;</span>
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-removed">-                 fragLen = Math.min(fragLen, (limit - offset));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+                 // use the buf of ByteArrayOutputStream</span>
<span class="udiff-line-modified-added">+                 int position = headerSize + writeCipher.getExplicitNonceSize();</span>
<span class="udiff-line-modified-added">+                 count = position;</span>
<span class="udiff-line-modified-added">+                 write(source, offset, fragLen);</span>
  
<span class="udiff-line-modified-removed">-             // use the buf of ByteArrayOutputStream</span>
<span class="udiff-line-modified-removed">-             int position = headerSize + writeCipher.getExplicitNonceSize();</span>
<span class="udiff-line-modified-removed">-             count = position;</span>
<span class="udiff-line-modified-removed">-             write(source, offset, fragLen);</span>
<span class="udiff-line-modified-added">+                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;record&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SSLLogger.fine(</span>
<span class="udiff-line-modified-added">+                             &quot;WRITE: &quot; + protocolVersion +</span>
<span class="udiff-line-modified-added">+                             &quot; &quot; + ContentType.APPLICATION_DATA.name +</span>
<span class="udiff-line-added">+                             &quot;, length = &quot; + (count - position));</span>
<span class="udiff-line-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;record&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SSLLogger.fine(</span>
<span class="udiff-line-modified-removed">-                         &quot;WRITE: &quot; + protocolVersion +</span>
<span class="udiff-line-removed">-                         &quot; &quot; + ContentType.APPLICATION_DATA.name +</span>
<span class="udiff-line-removed">-                         &quot;, length = &quot; + (count - position));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+                 // Encrypt the fragment and wrap up a record.</span>
<span class="udiff-line-modified-added">+                 encrypt(writeCipher,</span>
<span class="udiff-line-modified-added">+                         ContentType.APPLICATION_DATA.id, headerSize);</span>
  
<span class="udiff-line-modified-removed">-             // Encrypt the fragment and wrap up a record.</span>
<span class="udiff-line-modified-removed">-             encrypt(writeCipher, ContentType.APPLICATION_DATA.id, headerSize);</span>
<span class="udiff-line-modified-added">+                 // deliver this message</span>
<span class="udiff-line-modified-added">+                 deliverStream.write(buf, 0, count);    // may throw IOException</span>
<span class="udiff-line-added">+                 deliverStream.flush();                 // may throw IOException</span>
  
<span class="udiff-line-modified-removed">-             // deliver this message</span>
<span class="udiff-line-modified-removed">-             deliverStream.write(buf, 0, count);    // may throw IOException</span>
<span class="udiff-line-modified-removed">-             deliverStream.flush();                 // may throw IOException</span>
<span class="udiff-line-modified-added">+                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {</span>
<span class="udiff-line-modified-added">+                     SSLLogger.fine(&quot;Raw write&quot;,</span>
<span class="udiff-line-modified-added">+                             (new ByteArrayInputStream(buf, 0, count)));</span>
<span class="udiff-line-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;packet&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 SSLLogger.fine(&quot;Raw write&quot;,</span>
<span class="udiff-line-removed">-                         (new ByteArrayInputStream(buf, 0, count)));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+                 // reset the internal buffer</span>
<span class="udiff-line-modified-added">+                 count = 0;</span>
  
<span class="udiff-line-modified-removed">-             // reset the internal buffer</span>
<span class="udiff-line-modified-removed">-             count = 0;</span>
<span class="udiff-line-modified-added">+                 if (isFirstAppOutputRecord) {</span>
<span class="udiff-line-modified-added">+                     isFirstAppOutputRecord = false;</span>
<span class="udiff-line-added">+                 }</span>
  
<span class="udiff-line-modified-removed">-             if (isFirstAppOutputRecord) {</span>
<span class="udiff-line-removed">-                 isFirstAppOutputRecord = false;</span>
<span class="udiff-line-modified-added">+                 offset += fragLen;</span>
              }
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             offset += fragLen;</span>
<span class="udiff-line-modified-added">+         } finally {</span>
<span class="udiff-line-modified-added">+             recordLock.unlock();</span>
          }
      }
  
      @Override
<span class="udiff-line-modified-removed">-     synchronized void setDeliverStream(OutputStream outputStream) {</span>
<span class="udiff-line-modified-removed">-         this.deliverStream = outputStream;</span>
<span class="udiff-line-modified-added">+     void setDeliverStream(OutputStream outputStream) {</span>
<span class="udiff-line-modified-added">+         recordLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             this.deliverStream = outputStream;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             recordLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      /*
       * Need to split the payload except the following cases:
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -380,12 +410,11 @@</span>
              fragLimit = Math.min(fragLimit, Record.maxDataSize);
          } else {
              fragLimit = Record.maxDataSize;
          }
  
<span class="udiff-line-modified-removed">-         if (fragmentSize &gt; 0) {</span>
<span class="udiff-line-modified-removed">-             fragLimit = Math.min(fragLimit, fragmentSize);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         // Calculate more impact, for example TLS 1.3 padding.</span>
<span class="udiff-line-modified-added">+         fragLimit = calculateFragmentSize(fragLimit);</span>
  
          return fragLimit;
      }
  }
</pre>
<center><a href="SSLSocketInputRecord.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SSLTransport.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>