<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/security/util/KeyStoreDelegator.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="IOUtils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="LegacyAlgorithmConstraints.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/KeyStoreDelegator.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
200                 KeyStoreSpi tmp = primaryKeyStore.newInstance();
201                 keystore = tmp;
202             } catch (InstantiationException | IllegalAccessException e) {
203                 // can safely ignore
204             }
205             type = primaryType;
206 
207             if (debug != null) {
208                 debug.println(&quot;Creating a new keystore in &quot; + type + &quot; format&quot;);
209             }
210             keystore.engineLoad(stream, password);
211 
212         } else {
213             // First try the primary keystore then try the secondary keystore
214             InputStream bufferedStream = new BufferedInputStream(stream);
215             bufferedStream.mark(Integer.MAX_VALUE);
216 
217             try {
218                 @SuppressWarnings(&quot;deprecation&quot;)
219                 KeyStoreSpi tmp = primaryKeyStore.newInstance();

220                 keystore = tmp;
221                 type = primaryType;
<span class="line-removed">222                 keystore.engineLoad(bufferedStream, password);</span>
223 
224             } catch (Exception e) {
225 
226                 // incorrect password
227                 if (e instanceof IOException &amp;&amp;
228                     e.getCause() instanceof UnrecoverableKeyException) {
229                     throw (IOException)e;
230                 }
231 
232                 try {
233                     // Ignore secondary keystore when no compatibility mode
234                     if (!compatModeEnabled) {
235                         throw e;
236                     }
237 
238                     @SuppressWarnings(&quot;deprecation&quot;)
<span class="line-modified">239                     KeyStoreSpi tmp= secondaryKeyStore.newInstance();</span>


240                     keystore = tmp;
241                     type = secondaryType;
<span class="line-removed">242                     bufferedStream.reset();</span>
<span class="line-removed">243                     keystore.engineLoad(bufferedStream, password);</span>
244 
245                     if (debug != null) {
246                         debug.println(&quot;WARNING: switching from &quot; +
247                           primaryType + &quot; to &quot; + secondaryType +
248                           &quot; keystore file format has altered the &quot; +
249                           &quot;keystore security level&quot;);
250                     }
251 
252                 } catch (InstantiationException |
253                     IllegalAccessException e2) {
254                     // can safely ignore
255 
256                 } catch (IOException |
257                     NoSuchAlgorithmException |
258                     CertificateException e3) {
259 
260                     // incorrect password
261                     if (e3 instanceof IOException &amp;&amp;
262                         e3.getCause() instanceof UnrecoverableKeyException) {
263                         throw (IOException)e3;
264                     }
265                     // rethrow the outer exception
266                     if (e instanceof IOException) {
267                         throw (IOException)e;
268                     } else if (e instanceof CertificateException) {
269                         throw (CertificateException)e;
270                     } else if (e instanceof NoSuchAlgorithmException) {
271                         throw (NoSuchAlgorithmException)e;


272                     }
273                 }
274             }
275 
276             if (debug != null) {
277                 debug.println(&quot;Loaded a keystore in &quot; + type + &quot; format&quot;);
278             }
279         }
280     }
281 
282     /**
283      * Probe the first few bytes of the keystore data stream for a valid
284      * keystore encoding. Only the primary keystore implementation is probed.
285      */
286     @Override
287     public boolean engineProbe(InputStream stream) throws IOException {
288 
289         boolean result = false;
290 
291         try {
</pre>
</td>
<td>
<hr />
<pre>
200                 KeyStoreSpi tmp = primaryKeyStore.newInstance();
201                 keystore = tmp;
202             } catch (InstantiationException | IllegalAccessException e) {
203                 // can safely ignore
204             }
205             type = primaryType;
206 
207             if (debug != null) {
208                 debug.println(&quot;Creating a new keystore in &quot; + type + &quot; format&quot;);
209             }
210             keystore.engineLoad(stream, password);
211 
212         } else {
213             // First try the primary keystore then try the secondary keystore
214             InputStream bufferedStream = new BufferedInputStream(stream);
215             bufferedStream.mark(Integer.MAX_VALUE);
216 
217             try {
218                 @SuppressWarnings(&quot;deprecation&quot;)
219                 KeyStoreSpi tmp = primaryKeyStore.newInstance();
<span class="line-added">220                 tmp.engineLoad(bufferedStream, password);</span>
221                 keystore = tmp;
222                 type = primaryType;

223 
224             } catch (Exception e) {
225 
226                 // incorrect password
227                 if (e instanceof IOException &amp;&amp;
228                     e.getCause() instanceof UnrecoverableKeyException) {
229                     throw (IOException)e;
230                 }
231 
232                 try {
233                     // Ignore secondary keystore when no compatibility mode
234                     if (!compatModeEnabled) {
235                         throw e;
236                     }
237 
238                     @SuppressWarnings(&quot;deprecation&quot;)
<span class="line-modified">239                     KeyStoreSpi tmp = secondaryKeyStore.newInstance();</span>
<span class="line-added">240                     bufferedStream.reset();</span>
<span class="line-added">241                     tmp.engineLoad(bufferedStream, password);</span>
242                     keystore = tmp;
243                     type = secondaryType;


244 
245                     if (debug != null) {
246                         debug.println(&quot;WARNING: switching from &quot; +
247                           primaryType + &quot; to &quot; + secondaryType +
248                           &quot; keystore file format has altered the &quot; +
249                           &quot;keystore security level&quot;);
250                     }
251 
252                 } catch (InstantiationException |
253                     IllegalAccessException e2) {
254                     // can safely ignore
255 
256                 } catch (IOException |
257                     NoSuchAlgorithmException |
258                     CertificateException e3) {
259 
260                     // incorrect password
261                     if (e3 instanceof IOException &amp;&amp;
262                         e3.getCause() instanceof UnrecoverableKeyException) {
263                         throw (IOException)e3;
264                     }
265                     // rethrow the outer exception
266                     if (e instanceof IOException) {
267                         throw (IOException)e;
268                     } else if (e instanceof CertificateException) {
269                         throw (CertificateException)e;
270                     } else if (e instanceof NoSuchAlgorithmException) {
271                         throw (NoSuchAlgorithmException)e;
<span class="line-added">272                     } else if (e instanceof RuntimeException){</span>
<span class="line-added">273                         throw (RuntimeException)e;</span>
274                     }
275                 }
276             }
277 
278             if (debug != null) {
279                 debug.println(&quot;Loaded a keystore in &quot; + type + &quot; format&quot;);
280             }
281         }
282     }
283 
284     /**
285      * Probe the first few bytes of the keystore data stream for a valid
286      * keystore encoding. Only the primary keystore implementation is probed.
287      */
288     @Override
289     public boolean engineProbe(InputStream stream) throws IOException {
290 
291         boolean result = false;
292 
293         try {
</pre>
</td>
</tr>
</table>
<center><a href="IOUtils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="LegacyAlgorithmConstraints.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>