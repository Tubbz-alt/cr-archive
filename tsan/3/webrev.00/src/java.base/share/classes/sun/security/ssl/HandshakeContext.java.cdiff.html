<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/ssl/HandshakeContext.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Finished.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HelloCookieManager.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/HandshakeContext.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 44,13 ***</span>
  import java.util.Queue;
  import javax.crypto.SecretKey;
  import javax.net.ssl.SNIServerName;
  import javax.net.ssl.SSLHandshakeException;
  import javax.security.auth.x500.X500Principal;
<span class="line-modified">! import sun.security.ssl.SupportedGroupsExtension.NamedGroup;</span>
<span class="line-modified">! import sun.security.ssl.SupportedGroupsExtension.NamedGroupType;</span>
<span class="line-removed">- import static sun.security.ssl.SupportedGroupsExtension.NamedGroupType.*;</span>
  import sun.security.ssl.SupportedGroupsExtension.SupportedGroups;
  
  abstract class HandshakeContext implements ConnectionContext {
      // System properties
  
<span class="line-new-header">--- 44,12 ---</span>
  import java.util.Queue;
  import javax.crypto.SecretKey;
  import javax.net.ssl.SNIServerName;
  import javax.net.ssl.SSLHandshakeException;
  import javax.security.auth.x500.X500Principal;
<span class="line-modified">! import sun.security.ssl.NamedGroup.NamedGroupSpec;</span>
<span class="line-modified">! import static sun.security.ssl.NamedGroup.NamedGroupSpec.*;</span>
  import sun.security.ssl.SupportedGroupsExtension.SupportedGroups;
  
  abstract class HandshakeContext implements ConnectionContext {
      // System properties
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 100,10 ***</span>
<span class="line-new-header">--- 99,12 ---</span>
      boolean                                 kickstartMessageDelivered;
  
      // Resumption
      boolean                                 isResumption;
      SSLSessionImpl                          resumingSession;
<span class="line-added">+     // Session is using stateless resumption</span>
<span class="line-added">+     boolean                                 statelessResumption = false;</span>
  
      final Queue&lt;Map.Entry&lt;Byte, ByteBuffer&gt;&gt; delegatedActions;
      volatile boolean                        taskDelegated = false;
      volatile Exception                      delegatedThrown = null;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 280,12 ***</span>
                  // Ignore disabled protocol.
                  continue;
              }
  
              boolean found = false;
<span class="line-modified">!             Map&lt;NamedGroupType, Boolean&gt; cachedStatus =</span>
<span class="line-modified">!                     new EnumMap&lt;&gt;(NamedGroupType.class);</span>
              for (CipherSuite suite : enabledCipherSuites) {
                  if (suite.isAvailable() &amp;&amp; suite.supports(protocol)) {
                      if (isActivatable(suite,
                              algorithmConstraints, cachedStatus)) {
                          protocols.add(protocol);
<span class="line-new-header">--- 281,12 ---</span>
                  // Ignore disabled protocol.
                  continue;
              }
  
              boolean found = false;
<span class="line-modified">!             Map&lt;NamedGroupSpec, Boolean&gt; cachedStatus =</span>
<span class="line-modified">!                     new EnumMap&lt;&gt;(NamedGroupSpec.class);</span>
              for (CipherSuite suite : enabledCipherSuites) {
                  if (suite.isAvailable() &amp;&amp; suite.supports(protocol)) {
                      if (isActivatable(suite,
                              algorithmConstraints, cachedStatus)) {
                          protocols.add(protocol);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 320,12 ***</span>
              List&lt;CipherSuite&gt; enabledCipherSuites,
              AlgorithmConstraints algorithmConstraints) {
  
          List&lt;CipherSuite&gt; suites = new LinkedList&lt;&gt;();
          if (enabledProtocols != null &amp;&amp; !enabledProtocols.isEmpty()) {
<span class="line-modified">!             Map&lt;NamedGroupType, Boolean&gt; cachedStatus =</span>
<span class="line-modified">!                     new EnumMap&lt;&gt;(NamedGroupType.class);</span>
              for (CipherSuite suite : enabledCipherSuites) {
                  if (!suite.isAvailable()) {
                      continue;
                  }
  
<span class="line-new-header">--- 321,12 ---</span>
              List&lt;CipherSuite&gt; enabledCipherSuites,
              AlgorithmConstraints algorithmConstraints) {
  
          List&lt;CipherSuite&gt; suites = new LinkedList&lt;&gt;();
          if (enabledProtocols != null &amp;&amp; !enabledProtocols.isEmpty()) {
<span class="line-modified">!             Map&lt;NamedGroupSpec, Boolean&gt; cachedStatus =</span>
<span class="line-modified">!                     new EnumMap&lt;&gt;(NamedGroupSpec.class);</span>
              for (CipherSuite suite : enabledCipherSuites) {
                  if (!suite.isAvailable()) {
                      continue;
                  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 506,54 ***</span>
          this.conContext.protocolVersion = protocolVersion;
      }
  
      private static boolean isActivatable(CipherSuite suite,
              AlgorithmConstraints algorithmConstraints,
<span class="line-modified">!             Map&lt;NamedGroupType, Boolean&gt; cachedStatus) {</span>
  
          if (algorithmConstraints.permits(
                  EnumSet.of(CryptoPrimitive.KEY_AGREEMENT), suite.name, null)) {
              if (suite.keyExchange == null) {
                  // TLS 1.3, no definition of key exchange in cipher suite.
                  return true;
              }
  
<span class="line-modified">!             boolean available;</span>
<span class="line-modified">!             NamedGroupType groupType = suite.keyExchange.groupType;</span>
<span class="line-modified">!             if (groupType != NAMED_GROUP_NONE) {</span>
<span class="line-modified">!                 Boolean checkedStatus = cachedStatus.get(groupType);</span>
<span class="line-modified">!                 if (checkedStatus == null) {</span>
<span class="line-modified">!                     available = SupportedGroups.isActivatable(</span>
<span class="line-modified">!                             algorithmConstraints, groupType);</span>
<span class="line-modified">!                     cachedStatus.put(groupType, available);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                     if (!available &amp;&amp;</span>
<span class="line-modified">!                             SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;verbose&quot;)) {</span>
<span class="line-modified">!                         SSLLogger.fine(&quot;No activated named group&quot;);</span>
                      }
                  } else {
<span class="line-modified">!                     available = checkedStatus;</span>
                  }
  
<span class="line-modified">!                 if (!available &amp;&amp; SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;verbose&quot;)) {</span>
<span class="line-modified">!                     SSLLogger.fine(</span>
<span class="line-removed">-                         &quot;No active named group, ignore &quot; + suite);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 return available;</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 return true;</span>
              }
          } else if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;verbose&quot;)) {
              SSLLogger.fine(&quot;Ignore disabled cipher suite: &quot; + suite);
          }
  
          return false;
      }
  
      List&lt;SNIServerName&gt; getRequestedServerNames() {
          if (requestedServerNames == null) {
<span class="line-modified">!             return Collections.&lt;SNIServerName&gt;emptyList();</span>
          }
          return requestedServerNames;
      }
  }
  
<span class="line-new-header">--- 507,61 ---</span>
          this.conContext.protocolVersion = protocolVersion;
      }
  
      private static boolean isActivatable(CipherSuite suite,
              AlgorithmConstraints algorithmConstraints,
<span class="line-modified">!             Map&lt;NamedGroupSpec, Boolean&gt; cachedStatus) {</span>
  
          if (algorithmConstraints.permits(
                  EnumSet.of(CryptoPrimitive.KEY_AGREEMENT), suite.name, null)) {
              if (suite.keyExchange == null) {
                  // TLS 1.3, no definition of key exchange in cipher suite.
                  return true;
              }
  
<span class="line-modified">!             // Is at least one of the group types available?</span>
<span class="line-modified">!             boolean groupAvailable, retval = false;</span>
<span class="line-modified">!             NamedGroupSpec[] groupTypes = suite.keyExchange.groupTypes;</span>
<span class="line-modified">!             for (NamedGroupSpec groupType : groupTypes) {</span>
<span class="line-modified">!                 if (groupType != NAMED_GROUP_NONE) {</span>
<span class="line-modified">!                     Boolean checkedStatus = cachedStatus.get(groupType);</span>
<span class="line-modified">!                     if (checkedStatus == null) {</span>
<span class="line-modified">!                         groupAvailable = SupportedGroups.isActivatable(</span>
<span class="line-modified">!                                 algorithmConstraints, groupType);</span>
<span class="line-modified">!                         cachedStatus.put(groupType, groupAvailable);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                         if (!groupAvailable &amp;&amp;</span>
<span class="line-added">+                                 SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;verbose&quot;)) {</span>
<span class="line-added">+                             SSLLogger.fine(</span>
<span class="line-added">+                                     &quot;No activated named group in &quot; + groupType);</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                     } else {</span>
<span class="line-added">+                         groupAvailable = checkedStatus;</span>
                      }
<span class="line-added">+ </span>
<span class="line-added">+                     retval |= groupAvailable;</span>
                  } else {
<span class="line-modified">!                     retval |= true;</span>
                  }
<span class="line-added">+             }</span>
  
<span class="line-modified">!             if (!retval &amp;&amp; SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;verbose&quot;)) {</span>
<span class="line-modified">!                 SSLLogger.fine(&quot;No active named group(s), ignore &quot; + suite);</span>
              }
<span class="line-added">+ </span>
<span class="line-added">+             return retval;</span>
<span class="line-added">+ </span>
          } else if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;verbose&quot;)) {
              SSLLogger.fine(&quot;Ignore disabled cipher suite: &quot; + suite);
          }
  
          return false;
      }
  
      List&lt;SNIServerName&gt; getRequestedServerNames() {
          if (requestedServerNames == null) {
<span class="line-modified">!             return Collections.emptyList();</span>
          }
          return requestedServerNames;
      }
  }
  
</pre>
<center><a href="Finished.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HelloCookieManager.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>