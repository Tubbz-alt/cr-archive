<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/ssl/EphemeralKeyManager.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ECPointFormatsExtension.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Finished.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/EphemeralKeyManager.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,10 ***</span>
<span class="line-new-header">--- 24,11 ---</span>
   */
  
  package sun.security.ssl;
  
  import java.security.*;
<span class="line-added">+ import java.util.concurrent.locks.ReentrantLock;</span>
  
  /**
   * The &quot;KeyManager&quot; for ephemeral RSA keys. Ephemeral DH and ECDH keys
   * are handled by the DHCrypt and ECDHCrypt classes, respectively.
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,10 ***</span>
<span class="line-new-header">--- 47,12 ---</span>
      private final EphemeralKeyPair[] keys = new EphemeralKeyPair[] {
          new EphemeralKeyPair(null),
          new EphemeralKeyPair(null),
      };
  
<span class="line-added">+     private final ReentrantLock cachedKeysLock = new ReentrantLock();</span>
<span class="line-added">+ </span>
      EphemeralKeyManager() {
          // empty
      }
  
      /*
</pre>
<hr />
<pre>
<span class="line-old-header">*** 63,24 ***</span>
          } else {
              length = 1024;
              index = INDEX_RSA1024;
          }
  
<span class="line-modified">!         synchronized (keys) {</span>
<span class="line-modified">!             KeyPair kp = keys[index].getKeyPair();</span>
<span class="line-removed">-             if (kp == null) {</span>
<span class="line-removed">-                 try {</span>
<span class="line-removed">-                     KeyPairGenerator kgen = KeyPairGenerator.getInstance(&quot;RSA&quot;);</span>
<span class="line-removed">-                     kgen.initialize(length, random);</span>
<span class="line-removed">-                     keys[index] = new EphemeralKeyPair(kgen.genKeyPair());</span>
<span class="line-removed">-                     kp = keys[index].getKeyPair();</span>
<span class="line-removed">-                 } catch (Exception e) {</span>
<span class="line-removed">-                     // ignore</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
              return kp;
          }
      }
  
      /**
       * Inner class to handle storage of ephemeral KeyPairs.
       */
<span class="line-new-header">--- 66,36 ---</span>
          } else {
              length = 1024;
              index = INDEX_RSA1024;
          }
  
<span class="line-modified">!         KeyPair kp = keys[index].getKeyPair();</span>
<span class="line-modified">!         if (kp != null) {</span>
              return kp;
          }
<span class="line-added">+ </span>
<span class="line-added">+         cachedKeysLock.lock();</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             // double check</span>
<span class="line-added">+             kp = keys[index].getKeyPair();</span>
<span class="line-added">+             if (kp != null) {</span>
<span class="line-added">+                 return kp;</span>
<span class="line-added">+             }</span>
<span class="line-added">+ </span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 KeyPairGenerator kgen = KeyPairGenerator.getInstance(&quot;RSA&quot;);</span>
<span class="line-added">+                 kgen.initialize(length, random);</span>
<span class="line-added">+                 keys[index] = new EphemeralKeyPair(kgen.genKeyPair());</span>
<span class="line-added">+                 kp = keys[index].getKeyPair();</span>
<span class="line-added">+             } catch (Exception e) {</span>
<span class="line-added">+                 // ignore</span>
<span class="line-added">+             }</span>
<span class="line-added">+         } finally {</span>
<span class="line-added">+             cachedKeysLock.unlock();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         return kp;</span>
      }
  
      /**
       * Inner class to handle storage of ephemeral KeyPairs.
       */
</pre>
<center><a href="ECPointFormatsExtension.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Finished.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>