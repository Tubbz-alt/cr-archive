<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/ssl/SSLContextImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SSLConfiguration.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SSLEngineImpl.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/SSLContextImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,15 +23,16 @@</span>
   * questions.
   */
  
  package sun.security.ssl;
  
<span class="udiff-line-modified-removed">- import java.io.*;</span>
<span class="udiff-line-modified-added">+ import java.io.FileInputStream;</span>
  import java.net.Socket;
  import java.security.*;
  import java.security.cert.*;
  import java.util.*;
<span class="udiff-line-added">+ import java.util.concurrent.locks.ReentrantLock;</span>
  import javax.net.ssl.*;
  import sun.security.action.GetPropertyAction;
  import sun.security.provider.certpath.AlgorithmChecker;
  import sun.security.validator.Validator;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -67,14 +68,19 @@</span>
      private static final Collection&lt;CipherSuite&gt; serverCustomizedCipherSuites =
              getCustomizedCipherSuites(&quot;jdk.tls.server.cipherSuites&quot;);
  
      private volatile StatusResponseManager statusResponseManager;
  
<span class="udiff-line-added">+     private final ReentrantLock contextLock = new ReentrantLock();</span>
<span class="udiff-line-added">+     final HashMap&lt;Integer,</span>
<span class="udiff-line-added">+             SessionTicketExtension.StatelessKey&gt; keyHashMap = new HashMap&lt;&gt;();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
      SSLContextImpl() {
          ephemeralKeyManager = new EphemeralKeyManager();
<span class="udiff-line-modified-removed">-         clientCache = new SSLSessionContextImpl();</span>
<span class="udiff-line-modified-removed">-         serverCache = new SSLSessionContextImpl();</span>
<span class="udiff-line-modified-added">+         clientCache = new SSLSessionContextImpl(false);</span>
<span class="udiff-line-modified-added">+         serverCache = new SSLSessionContextImpl(true);</span>
      }
  
      @Override
      protected void engineInit(KeyManager[] km, TrustManager[] tm,
                                  SecureRandom sr) throws KeyManagementException {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -228,31 +234,37 @@</span>
      }
  
      // Used for DTLS in server mode only.
      HelloCookieManager getHelloCookieManager(ProtocolVersion protocolVersion) {
          if (helloCookieManagerBuilder == null) {
<span class="udiff-line-modified-removed">-             synchronized (this) {</span>
<span class="udiff-line-modified-added">+             contextLock.lock();</span>
<span class="udiff-line-added">+             try {</span>
                  if (helloCookieManagerBuilder == null) {
                      helloCookieManagerBuilder =
                              new HelloCookieManager.Builder(secureRandom);
                  }
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 contextLock.unlock();</span>
              }
          }
  
          return helloCookieManagerBuilder.valueOf(protocolVersion);
      }
  
      StatusResponseManager getStatusResponseManager() {
          if (serverEnableStapling &amp;&amp; statusResponseManager == null) {
<span class="udiff-line-modified-removed">-             synchronized (this) {</span>
<span class="udiff-line-modified-added">+             contextLock.lock();</span>
<span class="udiff-line-added">+             try {</span>
                  if (statusResponseManager == null) {
                      if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,sslctx&quot;)) {
                          SSLLogger.finest(
                                  &quot;Initializing StatusResponseManager&quot;);
                      }
                      statusResponseManager = new StatusResponseManager();
                  }
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 contextLock.unlock();</span>
              }
          }
  
          return statusResponseManager;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -359,20 +371,21 @@</span>
       * the specified protocols.
       */
      private static List&lt;CipherSuite&gt; getApplicableCipherSuites(
              Collection&lt;CipherSuite&gt; allowedCipherSuites,
              List&lt;ProtocolVersion&gt; protocols) {
<span class="udiff-line-modified-removed">-         TreeSet&lt;CipherSuite&gt; suites = new TreeSet&lt;&gt;();</span>
<span class="udiff-line-modified-added">+         LinkedHashSet&lt;CipherSuite&gt; suites = new LinkedHashSet&lt;&gt;();</span>
          if (protocols != null &amp;&amp; (!protocols.isEmpty())) {
              for (CipherSuite suite : allowedCipherSuites) {
                  if (!suite.isAvailable()) {
                      continue;
                  }
  
                  boolean isSupported = false;
                  for (ProtocolVersion protocol : protocols) {
<span class="udiff-line-modified-removed">-                     if (!suite.supports(protocol)) {</span>
<span class="udiff-line-modified-added">+                     if (!suite.supports(protocol) ||</span>
<span class="udiff-line-added">+                             !suite.bulkCipher.isAvailable()) {</span>
                          continue;
                      }
  
                      if (SSLAlgorithmConstraints.DEFAULT.permits(
                              EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -535,13 +548,11 @@</span>
              serverDefaultProtocols = getAvailableProtocols(
                      new ProtocolVersion[] {
                  ProtocolVersion.TLS13,
                  ProtocolVersion.TLS12,
                  ProtocolVersion.TLS11,
<span class="udiff-line-modified-removed">-                 ProtocolVersion.TLS10,</span>
<span class="udiff-line-removed">-                 ProtocolVersion.SSL30,</span>
<span class="udiff-line-removed">-                 ProtocolVersion.SSL20Hello</span>
<span class="udiff-line-modified-added">+                 ProtocolVersion.TLS10</span>
              });
  
              supportedCipherSuites = getApplicableSupportedCipherSuites(
                      supportedProtocols);
              serverDefaultCipherSuites = getApplicableEnabledCipherSuites(
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -580,21 +591,10 @@</span>
  
          @Override
          boolean isDTLS() {
              return false;
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         static ProtocolVersion[] getSupportedProtocols() {</span>
<span class="udiff-line-removed">-             return new ProtocolVersion[]{</span>
<span class="udiff-line-removed">-                     ProtocolVersion.TLS13,</span>
<span class="udiff-line-removed">-                     ProtocolVersion.TLS12,</span>
<span class="udiff-line-removed">-                     ProtocolVersion.TLS11,</span>
<span class="udiff-line-removed">-                     ProtocolVersion.TLS10,</span>
<span class="udiff-line-removed">-                     ProtocolVersion.SSL30,</span>
<span class="udiff-line-removed">-                     ProtocolVersion.SSL20Hello</span>
<span class="udiff-line-removed">-             };</span>
<span class="udiff-line-removed">-         }</span>
      }
  
      /*
       * The SSLContext implementation for SSLv3 and TLS10 algorithm
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -605,12 +605,11 @@</span>
          private static final List&lt;CipherSuite&gt; clientDefaultCipherSuites;
  
          static {
              clientDefaultProtocols = getAvailableProtocols(
                      new ProtocolVersion[] {
<span class="udiff-line-modified-removed">-                 ProtocolVersion.TLS10,</span>
<span class="udiff-line-removed">-                 ProtocolVersion.SSL30</span>
<span class="udiff-line-modified-added">+                 ProtocolVersion.TLS10</span>
              });
  
              clientDefaultCipherSuites = getApplicableEnabledCipherSuites(
                      clientDefaultProtocols, true);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -637,12 +636,11 @@</span>
  
          static {
              clientDefaultProtocols = getAvailableProtocols(
                      new ProtocolVersion[] {
                  ProtocolVersion.TLS11,
<span class="udiff-line-modified-removed">-                 ProtocolVersion.TLS10,</span>
<span class="udiff-line-removed">-                 ProtocolVersion.SSL30</span>
<span class="udiff-line-modified-added">+                 ProtocolVersion.TLS10</span>
              });
  
              clientDefaultCipherSuites = getApplicableEnabledCipherSuites(
                      clientDefaultProtocols, true);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -671,12 +669,11 @@</span>
          static {
              clientDefaultProtocols = getAvailableProtocols(
                      new ProtocolVersion[] {
                  ProtocolVersion.TLS12,
                  ProtocolVersion.TLS11,
<span class="udiff-line-modified-removed">-                 ProtocolVersion.TLS10,</span>
<span class="udiff-line-removed">-                 ProtocolVersion.SSL30</span>
<span class="udiff-line-modified-added">+                 ProtocolVersion.TLS10</span>
              });
  
              clientDefaultCipherSuites = getApplicableEnabledCipherSuites(
                      clientDefaultProtocols, true);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -705,12 +702,11 @@</span>
              clientDefaultProtocols = getAvailableProtocols(
                      new ProtocolVersion[] {
                  ProtocolVersion.TLS13,
                  ProtocolVersion.TLS12,
                  ProtocolVersion.TLS11,
<span class="udiff-line-modified-removed">-                 ProtocolVersion.TLS10,</span>
<span class="udiff-line-removed">-                 ProtocolVersion.SSL30</span>
<span class="udiff-line-modified-added">+                 ProtocolVersion.TLS10</span>
              });
  
              clientDefaultCipherSuites = getApplicableEnabledCipherSuites(
                      clientDefaultProtocols, true);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -843,34 +839,26 @@</span>
              }
  
              // Use the default enabled protocols if no customization
              ProtocolVersion[] candidates;
              if (refactored.isEmpty()) {
<span class="udiff-line-modified-removed">-                 if (client) {</span>
<span class="udiff-line-modified-removed">-                     candidates = getProtocols();</span>
<span class="udiff-line-modified-removed">-                 } else {</span>
<span class="udiff-line-modified-removed">-                     candidates = getSupportedProtocols();</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-added">+                 // Client and server use the same default protocols.</span>
<span class="udiff-line-modified-added">+                 candidates = new ProtocolVersion[] {</span>
<span class="udiff-line-modified-added">+                         ProtocolVersion.TLS13,</span>
<span class="udiff-line-modified-added">+                         ProtocolVersion.TLS12,</span>
<span class="udiff-line-modified-added">+                         ProtocolVersion.TLS11,</span>
<span class="udiff-line-added">+                         ProtocolVersion.TLS10</span>
<span class="udiff-line-added">+                     };</span>
              } else {
                  // Use the customized TLS protocols.
                  candidates =
                      refactored.toArray(new ProtocolVersion[refactored.size()]);
              }
  
              return getAvailableProtocols(candidates);
          }
  
<span class="udiff-line-removed">-         static ProtocolVersion[] getProtocols() {</span>
<span class="udiff-line-removed">-             return new ProtocolVersion[]{</span>
<span class="udiff-line-removed">-                     ProtocolVersion.TLS13,</span>
<span class="udiff-line-removed">-                     ProtocolVersion.TLS12,</span>
<span class="udiff-line-removed">-                     ProtocolVersion.TLS11,</span>
<span class="udiff-line-removed">-                     ProtocolVersion.TLS10,</span>
<span class="udiff-line-removed">-                     ProtocolVersion.SSL30</span>
<span class="udiff-line-removed">-             };</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          protected CustomizedTLSContext() {
              if (reservedException != null) {
                  throw reservedException;
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -892,12 +880,10 @@</span>
  
          @Override
          List&lt;CipherSuite&gt; getServerDefaultCipherSuites() {
              return serverDefaultCipherSuites;
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
      }
  
      /*
       * The SSLContext implementation for default &quot;TLS&quot; algorithm
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1169,11 +1155,10 @@</span>
  
          private static final List&lt;CipherSuite&gt; supportedCipherSuites;
          private static final List&lt;CipherSuite&gt; serverDefaultCipherSuites;
  
          static {
<span class="udiff-line-removed">-             // Both DTLSv1.0 and DTLSv1.2 can be used in FIPS mode.</span>
              supportedProtocols = Arrays.asList(
                  ProtocolVersion.DTLS12,
                  ProtocolVersion.DTLS10
              );
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1466,12 +1451,13 @@</span>
              SSLEngine engine) throws CertificateException {
          tm.checkServerTrusted(chain, authType);
          checkAdditionalTrust(chain, authType, engine, false);
      }
  
<span class="udiff-line-modified-removed">-     private void checkAdditionalTrust(X509Certificate[] chain, String authType,</span>
<span class="udiff-line-modified-removed">-                 Socket socket, boolean isClient) throws CertificateException {</span>
<span class="udiff-line-modified-added">+     private void checkAdditionalTrust(X509Certificate[] chain,</span>
<span class="udiff-line-modified-added">+             String authType, Socket socket,</span>
<span class="udiff-line-added">+             boolean checkClientTrusted) throws CertificateException {</span>
          if (socket != null &amp;&amp; socket.isConnected() &amp;&amp;
                                      socket instanceof SSLSocket) {
  
              SSLSocket sslSocket = (SSLSocket)socket;
              SSLSession session = sslSocket.getHandshakeSession();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1481,13 +1467,12 @@</span>
  
              // check endpoint identity
              String identityAlg = sslSocket.getSSLParameters().
                                          getEndpointIdentificationAlgorithm();
              if (identityAlg != null &amp;&amp; !identityAlg.isEmpty()) {
<span class="udiff-line-modified-removed">-                 String hostname = session.getPeerHost();</span>
<span class="udiff-line-modified-removed">-                 X509TrustManagerImpl.checkIdentity(</span>
<span class="udiff-line-removed">-                                     hostname, chain[0], identityAlg);</span>
<span class="udiff-line-modified-added">+                 X509TrustManagerImpl.checkIdentity(session, chain,</span>
<span class="udiff-line-modified-added">+                                     identityAlg, checkClientTrusted);</span>
              }
  
              // try the best to check the algorithm constraints
              AlgorithmConstraints constraints;
              if (ProtocolVersion.useTLS12PlusSpec(session.getProtocol())) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1505,29 +1490,29 @@</span>
                  }
              } else {
                  constraints = new SSLAlgorithmConstraints(sslSocket, true);
              }
  
<span class="udiff-line-modified-removed">-             checkAlgorithmConstraints(chain, constraints, isClient);</span>
<span class="udiff-line-modified-added">+             checkAlgorithmConstraints(chain, constraints, checkClientTrusted);</span>
          }
      }
  
<span class="udiff-line-modified-removed">-     private void checkAdditionalTrust(X509Certificate[] chain, String authType,</span>
<span class="udiff-line-modified-removed">-             SSLEngine engine, boolean isClient) throws CertificateException {</span>
<span class="udiff-line-modified-added">+     private void checkAdditionalTrust(X509Certificate[] chain,</span>
<span class="udiff-line-modified-added">+             String authType, SSLEngine engine,</span>
<span class="udiff-line-added">+             boolean checkClientTrusted) throws CertificateException {</span>
          if (engine != null) {
              SSLSession session = engine.getHandshakeSession();
              if (session == null) {
                  throw new CertificateException(&quot;No handshake session&quot;);
              }
  
              // check endpoint identity
              String identityAlg = engine.getSSLParameters().
                                          getEndpointIdentificationAlgorithm();
              if (identityAlg != null &amp;&amp; !identityAlg.isEmpty()) {
<span class="udiff-line-modified-removed">-                 String hostname = session.getPeerHost();</span>
<span class="udiff-line-modified-removed">-                 X509TrustManagerImpl.checkIdentity(</span>
<span class="udiff-line-removed">-                                     hostname, chain[0], identityAlg);</span>
<span class="udiff-line-modified-added">+                 X509TrustManagerImpl.checkIdentity(session, chain,</span>
<span class="udiff-line-modified-added">+                                     identityAlg, checkClientTrusted);</span>
              }
  
              // try the best to check the algorithm constraints
              AlgorithmConstraints constraints;
              if (ProtocolVersion.useTLS12PlusSpec(session.getProtocol())) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1545,17 +1530,17 @@</span>
                  }
              } else {
                  constraints = new SSLAlgorithmConstraints(engine, true);
              }
  
<span class="udiff-line-modified-removed">-             checkAlgorithmConstraints(chain, constraints, isClient);</span>
<span class="udiff-line-modified-added">+             checkAlgorithmConstraints(chain, constraints, checkClientTrusted);</span>
          }
      }
  
      private void checkAlgorithmConstraints(X509Certificate[] chain,
              AlgorithmConstraints constraints,
<span class="udiff-line-modified-removed">-             boolean isClient) throws CertificateException {</span>
<span class="udiff-line-modified-added">+             boolean checkClientTrusted) throws CertificateException {</span>
          try {
              // Does the certificate chain end with a trusted certificate?
              int checkedLength = chain.length - 1;
  
              Collection&lt;X509Certificate&gt; trustedCerts = new HashSet&lt;&gt;();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1570,11 +1555,11 @@</span>
  
              // A forward checker, need to check from trust to target
              if (checkedLength &gt;= 0) {
                  AlgorithmChecker checker =
                      new AlgorithmChecker(constraints, null,
<span class="udiff-line-modified-removed">-                             (isClient ? Validator.VAR_TLS_CLIENT :</span>
<span class="udiff-line-modified-added">+                             (checkClientTrusted ? Validator.VAR_TLS_CLIENT :</span>
                                          Validator.VAR_TLS_SERVER));
                  checker.init(false);
                  for (int i = checkedLength; i &gt;= 0; i--) {
                      X509Certificate cert = chain[i];
                      // We don&#39;t care about the unresolved critical extensions.
</pre>
<center><a href="SSLConfiguration.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SSLEngineImpl.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>