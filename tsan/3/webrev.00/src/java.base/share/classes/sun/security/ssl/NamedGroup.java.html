<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.base/share/classes/sun/security/ssl/NamedGroup.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package sun.security.ssl;
 26 
 27 import javax.crypto.spec.DHParameterSpec;
 28 import javax.net.ssl.SSLException;
 29 import java.io.IOException;
 30 import java.security.*;
 31 import java.security.spec.*;
 32 import java.util.Collections;
 33 import java.util.EnumSet;
 34 import java.util.List;
 35 import java.util.Set;
 36 import javax.crypto.KeyAgreement;
 37 import sun.security.ssl.DHKeyExchange.DHEPossession;
 38 import sun.security.ssl.ECDHKeyExchange.ECDHEPossession;
 39 import sun.security.util.CurveDB;
 40 
 41 
 42 /**
 43  * An enum containing all known named groups for use in TLS.
 44  *
 45  * The enum also contains the required properties of each group and the
 46  * required functions (e.g. encoding/decoding).
 47  */
 48 enum NamedGroup {
 49     // Elliptic Curves (RFC 4492)
 50     //
 51     // See sun.security.util.CurveDB for the OIDs
 52     // NIST K-163
 53 
 54     SECT163_K1(0x0001, &quot;sect163k1&quot;,
 55             NamedGroupSpec.NAMED_GROUP_ECDHE,
 56             ProtocolVersion.PROTOCOLS_TO_12,
 57             CurveDB.lookup(&quot;sect163k1&quot;)),
 58     SECT163_R1(0x0002, &quot;sect163r1&quot;,
 59             NamedGroupSpec.NAMED_GROUP_ECDHE,
 60             ProtocolVersion.PROTOCOLS_TO_12,
 61             CurveDB.lookup(&quot;sect163r1&quot;)),
 62 
 63     // NIST B-163
 64     SECT163_R2(0x0003, &quot;sect163r2&quot;,
 65             NamedGroupSpec.NAMED_GROUP_ECDHE,
 66             ProtocolVersion.PROTOCOLS_TO_12,
 67             CurveDB.lookup(&quot;sect163r2&quot;)),
 68     SECT193_R1(0x0004, &quot;sect193r1&quot;,
 69             NamedGroupSpec.NAMED_GROUP_ECDHE,
 70             ProtocolVersion.PROTOCOLS_TO_12,
 71             CurveDB.lookup(&quot;sect193r1&quot;)),
 72     SECT193_R2(0x0005, &quot;sect193r2&quot;,
 73             NamedGroupSpec.NAMED_GROUP_ECDHE,
 74             ProtocolVersion.PROTOCOLS_TO_12,
 75             CurveDB.lookup(&quot;sect193r2&quot;)),
 76 
 77     // NIST K-233
 78     SECT233_K1(0x0006, &quot;sect233k1&quot;,
 79             NamedGroupSpec.NAMED_GROUP_ECDHE,
 80             ProtocolVersion.PROTOCOLS_TO_12,
 81             CurveDB.lookup(&quot;sect233k1&quot;)),
 82 
 83     // NIST B-233
 84     SECT233_R1(0x0007, &quot;sect233r1&quot;,
 85             NamedGroupSpec.NAMED_GROUP_ECDHE,
 86             ProtocolVersion.PROTOCOLS_TO_12,
 87             CurveDB.lookup(&quot;sect233r1&quot;)),
 88     SECT239_K1(0x0008, &quot;sect239k1&quot;,
 89             NamedGroupSpec.NAMED_GROUP_ECDHE,
 90             ProtocolVersion.PROTOCOLS_TO_12,
 91             CurveDB.lookup(&quot;sect239k1&quot;)),
 92 
 93     // NIST K-283
 94     SECT283_K1(0x0009, &quot;sect283k1&quot;,
 95             NamedGroupSpec.NAMED_GROUP_ECDHE,
 96             ProtocolVersion.PROTOCOLS_TO_12,
 97             CurveDB.lookup(&quot;sect283k1&quot;)),
 98 
 99     // NIST B-283
100     SECT283_R1(0x000A, &quot;sect283r1&quot;,
101             NamedGroupSpec.NAMED_GROUP_ECDHE,
102             ProtocolVersion.PROTOCOLS_TO_12,
103             CurveDB.lookup(&quot;sect283r1&quot;)),
104 
105     // NIST K-409
106     SECT409_K1(0x000B, &quot;sect409k1&quot;,
107             NamedGroupSpec.NAMED_GROUP_ECDHE,
108             ProtocolVersion.PROTOCOLS_TO_12,
109             CurveDB.lookup(&quot;sect409k1&quot;)),
110 
111     // NIST B-409
112     SECT409_R1(0x000C, &quot;sect409r1&quot;,
113             NamedGroupSpec.NAMED_GROUP_ECDHE,
114             ProtocolVersion.PROTOCOLS_TO_12,
115             CurveDB.lookup(&quot;sect409r1&quot;)),
116 
117     // NIST K-571
118     SECT571_K1(0x000D, &quot;sect571k1&quot;,
119             NamedGroupSpec.NAMED_GROUP_ECDHE,
120             ProtocolVersion.PROTOCOLS_TO_12,
121             CurveDB.lookup(&quot;sect571k1&quot;)),
122 
123     // NIST B-571
124     SECT571_R1(0x000E, &quot;sect571r1&quot;,
125             NamedGroupSpec.NAMED_GROUP_ECDHE,
126             ProtocolVersion.PROTOCOLS_TO_12,
127             CurveDB.lookup(&quot;sect571r1&quot;)),
128     SECP160_K1(0x000F, &quot;secp160k1&quot;,
129             NamedGroupSpec.NAMED_GROUP_ECDHE,
130             ProtocolVersion.PROTOCOLS_TO_12,
131             CurveDB.lookup(&quot;secp160k1&quot;)),
132     SECP160_R1(0x0010, &quot;secp160r1&quot;,
133             NamedGroupSpec.NAMED_GROUP_ECDHE,
134             ProtocolVersion.PROTOCOLS_TO_12,
135             CurveDB.lookup(&quot;secp160r1&quot;)),
136     SECP160_R2(0x0011, &quot;secp160r2&quot;,
137             NamedGroupSpec.NAMED_GROUP_ECDHE,
138             ProtocolVersion.PROTOCOLS_TO_12,
139             CurveDB.lookup(&quot;secp160r2&quot;)),
140     SECP192_K1(0x0012, &quot;secp192k1&quot;,
141             NamedGroupSpec.NAMED_GROUP_ECDHE,
142             ProtocolVersion.PROTOCOLS_TO_12,
143             CurveDB.lookup(&quot;secp192k1&quot;)),
144 
145     // NIST P-192
146     SECP192_R1(0x0013, &quot;secp192r1&quot;,
147             NamedGroupSpec.NAMED_GROUP_ECDHE,
148             ProtocolVersion.PROTOCOLS_TO_12,
149             CurveDB.lookup(&quot;secp192r1&quot;)),
150     SECP224_K1(0x0014, &quot;secp224k1&quot;,
151             NamedGroupSpec.NAMED_GROUP_ECDHE,
152             ProtocolVersion.PROTOCOLS_TO_12,
153             CurveDB.lookup(&quot;secp224k1&quot;)),
154 
155     // NIST P-224
156     SECP224_R1(0x0015, &quot;secp224r1&quot;,
157             NamedGroupSpec.NAMED_GROUP_ECDHE,
158             ProtocolVersion.PROTOCOLS_TO_12,
159             CurveDB.lookup(&quot;secp224r1&quot;)),
160     SECP256_K1(0x0016, &quot;secp256k1&quot;,
161             NamedGroupSpec.NAMED_GROUP_ECDHE,
162             ProtocolVersion.PROTOCOLS_TO_12,
163             CurveDB.lookup(&quot;secp256k1&quot;)),
164 
165     // NIST P-256
166     SECP256_R1(0x0017, &quot;secp256r1&quot;,
167             NamedGroupSpec.NAMED_GROUP_ECDHE,
168             ProtocolVersion.PROTOCOLS_TO_13,
169             CurveDB.lookup(&quot;secp256r1&quot;)),
170 
171     // NIST P-384
172     SECP384_R1(0x0018, &quot;secp384r1&quot;,
173             NamedGroupSpec.NAMED_GROUP_ECDHE,
174             ProtocolVersion.PROTOCOLS_TO_13,
175             CurveDB.lookup(&quot;secp384r1&quot;)),
176 
177     // NIST P-521
178     SECP521_R1(0x0019, &quot;secp521r1&quot;,
179             NamedGroupSpec.NAMED_GROUP_ECDHE,
180             ProtocolVersion.PROTOCOLS_TO_13,
181             CurveDB.lookup(&quot;secp521r1&quot;)),
182 
183     // x25519 and x448 (RFC 8422/8446)
184     X25519(0x001D, &quot;x25519&quot;,
185             NamedGroupSpec.NAMED_GROUP_XDH,
186             ProtocolVersion.PROTOCOLS_TO_13,
187             NamedParameterSpec.X25519),
188     X448(0x001E, &quot;x448&quot;,
189             NamedGroupSpec.NAMED_GROUP_XDH,
190             ProtocolVersion.PROTOCOLS_TO_13,
191             NamedParameterSpec.X448),
192 
193     // Finite Field Diffie-Hellman Ephemeral Parameters (RFC 7919)
194     FFDHE_2048(0x0100, &quot;ffdhe2048&quot;,
195             NamedGroupSpec.NAMED_GROUP_FFDHE,
196             ProtocolVersion.PROTOCOLS_TO_13,
197             PredefinedDHParameterSpecs.ffdheParams.get(2048)),
198 
199     FFDHE_3072(0x0101, &quot;ffdhe3072&quot;,
200             NamedGroupSpec.NAMED_GROUP_FFDHE,
201             ProtocolVersion.PROTOCOLS_TO_13,
202             PredefinedDHParameterSpecs.ffdheParams.get(3072)),
203     FFDHE_4096(0x0102, &quot;ffdhe4096&quot;,
204             NamedGroupSpec.NAMED_GROUP_FFDHE,
205             ProtocolVersion.PROTOCOLS_TO_13,
206             PredefinedDHParameterSpecs.ffdheParams.get(4096)),
207     FFDHE_6144(0x0103, &quot;ffdhe6144&quot;,
208             NamedGroupSpec.NAMED_GROUP_FFDHE,
209             ProtocolVersion.PROTOCOLS_TO_13,
210             PredefinedDHParameterSpecs.ffdheParams.get(6144)),
211     FFDHE_8192(0x0104, &quot;ffdhe8192&quot;,
212             NamedGroupSpec.NAMED_GROUP_FFDHE,
213             ProtocolVersion.PROTOCOLS_TO_13,
214             PredefinedDHParameterSpecs.ffdheParams.get(8192)),
215 
216     // Elliptic Curves (RFC 4492)
217     //
218     // arbitrary prime and characteristic-2 curves
219     ARBITRARY_PRIME(0xFF01, &quot;arbitrary_explicit_prime_curves&quot;,
220             NamedGroupSpec.NAMED_GROUP_ARBITRARY,
221             ProtocolVersion.PROTOCOLS_TO_12,
222             null),
223     ARBITRARY_CHAR2(0xFF02, &quot;arbitrary_explicit_char2_curves&quot;,
224             NamedGroupSpec.NAMED_GROUP_ARBITRARY,
225             ProtocolVersion.PROTOCOLS_TO_12,
226             null);
227 
228     final int id;               // hash + signature
229     final String name;          // literal name
230     final NamedGroupSpec spec;  // group type
231     final ProtocolVersion[] supportedProtocols;
232     final String algorithm;     // key exchange algorithm
233     final AlgorithmParameterSpec keAlgParamSpec;
234     final AlgorithmParameters keAlgParams;
235     final boolean isAvailable;
236 
237     // performance optimization
238     private static final Set&lt;CryptoPrimitive&gt; KEY_AGREEMENT_PRIMITIVE_SET =
239         Collections.unmodifiableSet(EnumSet.of(CryptoPrimitive.KEY_AGREEMENT));
240 
241     // Constructor used for all NamedGroup types
242     private NamedGroup(int id, String name,
243             NamedGroupSpec namedGroupSpec,
244             ProtocolVersion[] supportedProtocols,
245             AlgorithmParameterSpec keAlgParamSpec) {
246         this.id = id;
247         this.name = name;
248         this.spec = namedGroupSpec;
249         this.algorithm = namedGroupSpec.algorithm;
250         this.supportedProtocols = supportedProtocols;
251         this.keAlgParamSpec = keAlgParamSpec;
252 
253         // Check if it is a supported named group.
254         AlgorithmParameters algParams = null;
255         boolean mediator = (keAlgParamSpec != null);
256 
257         // An EC provider, for example the SunEC provider, may support
258         // AlgorithmParameters but not KeyPairGenerator or KeyAgreement.
259         //
260         // Note: Please be careful if removing this block!
261         if (mediator &amp;&amp; (namedGroupSpec == NamedGroupSpec.NAMED_GROUP_ECDHE)) {
262             mediator = JsseJce.isEcAvailable();
263         }
264 
265         // Check the specific algorithm parameters.
266         if (mediator) {
267             try {
268                 algParams =
269                     AlgorithmParameters.getInstance(namedGroupSpec.algorithm);
270                 algParams.init(keAlgParamSpec);
271             } catch (InvalidParameterSpecException
272                     | NoSuchAlgorithmException exp) {
273                 if (namedGroupSpec != NamedGroupSpec.NAMED_GROUP_XDH) {
274                     mediator = false;
275                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
276                         SSLLogger.warning(
277                             &quot;No AlgorithmParameters for &quot; + name, exp);
278                     }
279                 } else {
280                     // Please remove the following code if the XDH/X25519/X448
281                     // AlgorithmParameters algorithms are supported in JDK.
282                     //
283                     // Note: Please be careful if removing this block!
284                     algParams = null;
285                     try {
286                         KeyAgreement.getInstance(name);
287 
288                         // The following service is also needed.  But for
289                         // performance, check the KeyAgreement impl only.
290                         //
291                         // KeyFactory.getInstance(name);
292                         // KeyPairGenerator.getInstance(name);
293                         // AlgorithmParameters.getInstance(name);
294                     } catch (NoSuchAlgorithmException nsae) {
295                         mediator = false;
296                         if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
297                             SSLLogger.warning(
298                                 &quot;No AlgorithmParameters for &quot; + name, nsae);
299                         }
300                     }
301                 }
302             }
303         }
304 
305         this.isAvailable = mediator;
306         this.keAlgParams = mediator ? algParams : null;
307     }
308 
309     //
310     // The next set of methods search &amp; retrieve NamedGroups.
311     //
312     static NamedGroup valueOf(int id) {
313         for (NamedGroup group : NamedGroup.values()) {
314             if (group.id == id) {
315                 return group;
316             }
317         }
318 
319         return null;
320     }
321 
322     static NamedGroup valueOf(ECParameterSpec params) {
323         for (NamedGroup ng : NamedGroup.values()) {
324             if (ng.spec == NamedGroupSpec.NAMED_GROUP_ECDHE) {
325                 if ((params == ng.keAlgParamSpec) ||
326                         (ng.keAlgParamSpec == CurveDB.lookup(params))) {
327                     return ng;
328                 }
329             }
330         }
331 
332         return null;
333     }
334 
335     static NamedGroup valueOf(DHParameterSpec params) {
336         for (NamedGroup ng : NamedGroup.values()) {
337             if (ng.spec != NamedGroupSpec.NAMED_GROUP_FFDHE) {
338                 continue;
339             }
340 
341             DHParameterSpec ngParams = (DHParameterSpec)ng.keAlgParamSpec;
342             if (ngParams.getP().equals(params.getP())
343                     &amp;&amp; ngParams.getG().equals(params.getG())) {
344                 return ng;
345             }
346         }
347 
348         return null;
349     }
350 
351     static NamedGroup nameOf(String name) {
352         for (NamedGroup group : NamedGroup.values()) {
353             if (group.name.equals(name)) {
354                 return group;
355             }
356         }
357 
358         return null;
359     }
360 
361     static String nameOf(int id) {
362         for (NamedGroup group : NamedGroup.values()) {
363             if (group.id == id) {
364                 return group.name;
365             }
366         }
367 
368         return &quot;UNDEFINED-NAMED-GROUP(&quot; + id + &quot;)&quot;;
369     }
370 
371     // Is the NamedGroup available for the protocols desired?
372     boolean isAvailable(List&lt;ProtocolVersion&gt; protocolVersions) {
373         if (this.isAvailable) {
374             for (ProtocolVersion pv : supportedProtocols) {
375                 if (protocolVersions.contains(pv)) {
376                     return true;
377                 }
378             }
379         }
380 
381         return false;
382     }
383 
384     boolean isAvailable(ProtocolVersion protocolVersion) {
385         if (this.isAvailable) {
386             for (ProtocolVersion pv : supportedProtocols) {
387                 if (protocolVersion == pv) {
388                     return true;
389                 }
390             }
391         }
392 
393         return false;
394     }
395 
396     // Are the NamedGroups available for the ciphersuites desired?
397     boolean isSupported(List&lt;CipherSuite&gt; cipherSuites) {
398         for (CipherSuite cs : cipherSuites) {
399             boolean isMatch = isAvailable(cs.supportedProtocols);
400             if (isMatch &amp;&amp; ((cs.keyExchange == null)
401                     || (NamedGroupSpec.arrayContains(
402                             cs.keyExchange.groupTypes, spec)))) {
403                 return true;
404             }
405         }
406 
407         return false;
408     }
409 
410     boolean isPermitted(AlgorithmConstraints constraints) {
411         return constraints.permits(KEY_AGREEMENT_PRIMITIVE_SET,
412                         this.name, null) &amp;&amp;
413                 constraints.permits(KEY_AGREEMENT_PRIMITIVE_SET,
414                         this.algorithm, this.keAlgParams);
415     }
416 
417     byte[] encodePossessionPublicKey(
418             NamedGroupPossession namedGroupPossession) {
419         return spec.encodePossessionPublicKey(namedGroupPossession);
420     }
421 
422     SSLCredentials decodeCredentials(byte[] encoded,
423             AlgorithmConstraints constraints,
424             ExceptionSupplier onConstraintFail)
425             throws IOException, GeneralSecurityException {
426         return spec.decodeCredentials(
427                 this, encoded, constraints, onConstraintFail);
428     }
429 
430     SSLPossession createPossession(SecureRandom random) {
431         return spec.createPossession(this, random);
432     }
433 
434     SSLKeyDerivation createKeyDerivation(
435             HandshakeContext hc) throws IOException {
436         return spec.createKeyDerivation(hc);
437     }
438 
439     interface ExceptionSupplier {
440         void apply(String s) throws SSLException;
441     }
442 
443     // A list of operations related to named groups.
444     private interface NamedGroupScheme {
445         default void checkConstraints(PublicKey publicKey,
446                 AlgorithmConstraints constraints,
447                 ExceptionSupplier onConstraintFail) throws SSLException {
448             if (!constraints.permits(
449                     EnumSet.of(CryptoPrimitive.KEY_AGREEMENT), publicKey)) {
450                 onConstraintFail.apply(&quot;key share entry does not &quot;
451                         + &quot;comply with algorithm constraints&quot;);
452             }
453         }
454 
455         byte[] encodePossessionPublicKey(
456                 NamedGroupPossession namedGroupPossession);
457 
458         SSLCredentials decodeCredentials(
459                 NamedGroup ng, byte[] encoded,
460                 AlgorithmConstraints constraints,
461                 ExceptionSupplier onConstraintFail
462             ) throws IOException, GeneralSecurityException;
463 
464         SSLPossession createPossession(NamedGroup ng, SecureRandom random);
465 
466         SSLKeyDerivation createKeyDerivation(
467                 HandshakeContext hc) throws IOException;
468     }
469 
470     enum NamedGroupSpec implements NamedGroupScheme {
471         // Elliptic Curve Groups (ECDHE)
472         NAMED_GROUP_ECDHE(&quot;EC&quot;, ECDHEScheme.instance),
473 
474         // Finite Field Groups (DHE)
475         NAMED_GROUP_FFDHE(&quot;DiffieHellman&quot;, FFDHEScheme.instance),
476 
477         // Finite Field Groups (XDH)
478         NAMED_GROUP_XDH(&quot;XDH&quot;, XDHScheme.instance),
479 
480         // arbitrary prime and curves (ECDHE)
481         NAMED_GROUP_ARBITRARY(&quot;EC&quot;, null),
482 
483         // Not predefined named group
484         NAMED_GROUP_NONE(&quot;&quot;, null);
485 
486         private final String algorithm;     // key exchange name
487         private final NamedGroupScheme scheme;  // named group operations
488 
489         private NamedGroupSpec(String algorithm, NamedGroupScheme scheme) {
490             this.algorithm = algorithm;
491             this.scheme = scheme;
492         }
493 
494         boolean isSupported(List&lt;CipherSuite&gt; cipherSuites) {
495             for (CipherSuite cs : cipherSuites) {
496                 if (cs.keyExchange == null ||
497                         arrayContains(cs.keyExchange.groupTypes, this)) {
498                     return true;
499                 }
500             }
501 
502             return false;
503         }
504 
505         static boolean arrayContains(NamedGroupSpec[] namedGroupTypes,
506                 NamedGroupSpec namedGroupType) {
507             for (NamedGroupSpec ng : namedGroupTypes) {
508                 if (ng == namedGroupType) {
509                     return true;
510                 }
511             }
512 
513             return false;
514         }
515 
516         @Override
517         public byte[] encodePossessionPublicKey(
518                 NamedGroupPossession namedGroupPossession) {
519             if (scheme != null) {
520                 return scheme.encodePossessionPublicKey(namedGroupPossession);
521             }
522 
523             return null;
524         }
525 
526         @Override
527         public SSLCredentials decodeCredentials(NamedGroup ng, byte[] encoded,
528                     AlgorithmConstraints constraints,
529                     ExceptionSupplier onConstraintFail
530                 ) throws IOException, GeneralSecurityException {
531             if (scheme != null) {
532                 return scheme.decodeCredentials(
533                         ng, encoded, constraints, onConstraintFail);
534             }
535 
536             return null;
537         }
538 
539         @Override
540         public SSLPossession createPossession(
541                 NamedGroup ng, SecureRandom random) {
542             if (scheme != null) {
543                 return scheme.createPossession(ng, random);
544             }
545 
546             return null;
547         }
548 
549         @Override
550         public SSLKeyDerivation createKeyDerivation(
551                 HandshakeContext hc) throws IOException {
552             if (scheme != null) {
553                 return scheme.createKeyDerivation(hc);
554             }
555 
556             return null;
557         }
558     }
559 
560     private static class FFDHEScheme implements NamedGroupScheme {
561         private static final FFDHEScheme instance = new FFDHEScheme();
562 
563         @Override
564         public byte[] encodePossessionPublicKey(
565                 NamedGroupPossession namedGroupPossession) {
566             return ((DHEPossession)namedGroupPossession).encode();
567         }
568 
569         @Override
570         public SSLCredentials decodeCredentials(NamedGroup ng, byte[] encoded,
571                 AlgorithmConstraints constraints,
572                 ExceptionSupplier onConstraintFail
573             ) throws IOException, GeneralSecurityException {
574 
575             DHKeyExchange.DHECredentials result
576                     = DHKeyExchange.DHECredentials.valueOf(ng, encoded);
577 
578             checkConstraints(result.getPublicKey(), constraints,
579                     onConstraintFail);
580 
581             return result;
582         }
583 
584         @Override
585         public SSLPossession createPossession(
586                 NamedGroup ng, SecureRandom random) {
587             return new DHKeyExchange.DHEPossession(ng, random);
588         }
589 
590         @Override
591         public SSLKeyDerivation createKeyDerivation(
592                 HandshakeContext hc) throws IOException {
593 
594             return DHKeyExchange.kaGenerator.createKeyDerivation(hc);
595         }
596     }
597 
598     private static class ECDHEScheme implements NamedGroupScheme {
599         private static final ECDHEScheme instance = new ECDHEScheme();
600 
601         @Override
602         public byte[] encodePossessionPublicKey(
603                 NamedGroupPossession namedGroupPossession) {
604             return ((ECDHEPossession)namedGroupPossession).encode();
605         }
606 
607         @Override
608         public SSLCredentials decodeCredentials(NamedGroup ng, byte[] encoded,
609                 AlgorithmConstraints constraints,
610                 ExceptionSupplier onConstraintFail
611             ) throws IOException, GeneralSecurityException {
612 
613             ECDHKeyExchange.ECDHECredentials result
614                     = ECDHKeyExchange.ECDHECredentials.valueOf(ng, encoded);
615 
616             checkConstraints(result.getPublicKey(), constraints,
617                     onConstraintFail);
618 
619             return result;
620         }
621 
622         @Override
623         public SSLPossession createPossession(
624                 NamedGroup ng, SecureRandom random) {
625             return new ECDHKeyExchange.ECDHEPossession(ng, random);
626         }
627 
628         @Override
629         public SSLKeyDerivation createKeyDerivation(
630                 HandshakeContext hc) throws IOException {
631             return ECDHKeyExchange.ecdheKAGenerator.createKeyDerivation(hc);
632         }
633     }
634 
635     private static class XDHScheme implements NamedGroupScheme {
636         private static final XDHScheme instance = new XDHScheme();
637 
638         @Override
639         public byte[] encodePossessionPublicKey(NamedGroupPossession poss) {
640             return ((XDHKeyExchange.XDHEPossession)poss).encode();
641         }
642 
643         @Override
644         public SSLCredentials decodeCredentials(NamedGroup ng, byte[] encoded,
645                 AlgorithmConstraints constraints,
646                 ExceptionSupplier onConstraintFail
647             ) throws IOException, GeneralSecurityException {
648 
649             XDHKeyExchange.XDHECredentials result
650                     = XDHKeyExchange.XDHECredentials.valueOf(ng, encoded);
651 
652             checkConstraints(result.getPublicKey(), constraints,
653                     onConstraintFail);
654 
655             return result;
656         }
657 
658         @Override
659         public SSLPossession createPossession(
660                 NamedGroup ng, SecureRandom random) {
661             return new XDHKeyExchange.XDHEPossession(ng, random);
662         }
663 
664         @Override
665         public SSLKeyDerivation createKeyDerivation(
666                 HandshakeContext hc) throws IOException {
667             return XDHKeyExchange.xdheKAGenerator.createKeyDerivation(hc);
668         }
669     }
670 }
    </pre>
  </body>
</html>