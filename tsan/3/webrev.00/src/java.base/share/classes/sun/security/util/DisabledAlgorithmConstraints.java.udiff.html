<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/util/DisabledAlgorithmConstraints.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="DerValue.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DomainName.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/DisabledAlgorithmConstraints.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2010, 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2010, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -25,20 +25,19 @@</span>
  
  package sun.security.util;
  
  import sun.security.validator.Validator;
  
<span class="udiff-line-removed">- import java.io.ByteArrayOutputStream;</span>
<span class="udiff-line-removed">- import java.io.PrintStream;</span>
  import java.security.CryptoPrimitive;
  import java.security.AlgorithmParameters;
  import java.security.Key;
  import java.security.cert.CertPathValidatorException;
  import java.security.cert.CertPathValidatorException.BasicReason;
  import java.security.cert.X509Certificate;
  import java.text.SimpleDateFormat;
  import java.util.ArrayList;
<span class="udiff-line-added">+ import java.util.Arrays;</span>
  import java.util.Calendar;
  import java.util.Date;
  import java.util.HashMap;
  import java.util.HashSet;
  import java.util.List;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -58,23 +57,27 @@</span>
   * for the syntax of the disabled algorithm string.
   */
  public class DisabledAlgorithmConstraints extends AbstractAlgorithmConstraints {
      private static final Debug debug = Debug.getInstance(&quot;certpath&quot;);
  
<span class="udiff-line-modified-removed">-     // the known security property, jdk.certpath.disabledAlgorithms</span>
<span class="udiff-line-modified-added">+     // Disabled algorithm security property for certificate path</span>
      public static final String PROPERTY_CERTPATH_DISABLED_ALGS =
              &quot;jdk.certpath.disabledAlgorithms&quot;;
  
<span class="udiff-line-modified-removed">-     // the known security property, jdk.tls.disabledAlgorithms</span>
<span class="udiff-line-modified-added">+     // Disabled algorithm security property for TLS</span>
      public static final String PROPERTY_TLS_DISABLED_ALGS =
              &quot;jdk.tls.disabledAlgorithms&quot;;
  
<span class="udiff-line-modified-removed">-     // the known security property, jdk.jar.disabledAlgorithms</span>
<span class="udiff-line-modified-added">+     // Disabled algorithm security property for jar</span>
      public static final String PROPERTY_JAR_DISABLED_ALGS =
              &quot;jdk.jar.disabledAlgorithms&quot;;
  
<span class="udiff-line-modified-removed">-     private final String[] disabledAlgorithms;</span>
<span class="udiff-line-modified-added">+     // Property for disabled EC named curves</span>
<span class="udiff-line-added">+     private static final String PROPERTY_DISABLED_EC_CURVES =</span>
<span class="udiff-line-added">+             &quot;jdk.disabled.namedCurves&quot;;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private final List&lt;String&gt; disabledAlgorithms;</span>
      private final Constraints algorithmConstraints;
  
      /**
       * Initialize algorithm constraints with the specified security property.
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -95,20 +98,43 @@</span>
       */
      public DisabledAlgorithmConstraints(String propertyName,
              AlgorithmDecomposer decomposer) {
          super(decomposer);
          disabledAlgorithms = getAlgorithms(propertyName);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Check for alias</span>
<span class="udiff-line-added">+         int ecindex = -1, i = 0;</span>
<span class="udiff-line-added">+         for (String s : disabledAlgorithms) {</span>
<span class="udiff-line-added">+             if (s.regionMatches(true, 0,&quot;include &quot;, 0, 8)) {</span>
<span class="udiff-line-added">+                 if (s.regionMatches(true, 8, PROPERTY_DISABLED_EC_CURVES, 0,</span>
<span class="udiff-line-added">+                         PROPERTY_DISABLED_EC_CURVES.length())) {</span>
<span class="udiff-line-added">+                     ecindex = i;</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             i++;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (ecindex &gt; -1) {</span>
<span class="udiff-line-added">+             disabledAlgorithms.remove(ecindex);</span>
<span class="udiff-line-added">+             disabledAlgorithms.addAll(ecindex,</span>
<span class="udiff-line-added">+                     getAlgorithms(PROPERTY_DISABLED_EC_CURVES));</span>
<span class="udiff-line-added">+         }</span>
          algorithmConstraints = new Constraints(disabledAlgorithms);
      }
  
      /*
       * This only checks if the algorithm has been completely disabled.  If
       * there are keysize or other limit, this method allow the algorithm.
       */
      @Override
      public final boolean permits(Set&lt;CryptoPrimitive&gt; primitives,
              String algorithm, AlgorithmParameters parameters) {
<span class="udiff-line-added">+         if (primitives == null || primitives.isEmpty()) {</span>
<span class="udiff-line-added">+             throw new IllegalArgumentException(&quot;The primitives cannot be null&quot; +</span>
<span class="udiff-line-added">+                     &quot; or empty.&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          if (!checkAlgorithm(disabledAlgorithms, algorithm, decomposer)) {
              return false;
          }
  
          if (parameters != null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -162,10 +188,23 @@</span>
       * Uses new style permit() which throws exceptions.
       */
  
      public final void permits(String algorithm, ConstraintsParameters cp)
              throws CertPathValidatorException {
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Check if named curves in the ConstraintParameters are disabled.</span>
<span class="udiff-line-added">+         if (cp.getNamedCurve() != null) {</span>
<span class="udiff-line-added">+             for (String curve : cp.getNamedCurve()) {</span>
<span class="udiff-line-added">+                 if (!checkAlgorithm(disabledAlgorithms, curve, decomposer)) {</span>
<span class="udiff-line-added">+                     throw new CertPathValidatorException(</span>
<span class="udiff-line-added">+                             &quot;Algorithm constraints check failed on disabled &quot; +</span>
<span class="udiff-line-added">+                                     &quot;algorithm: &quot; + curve,</span>
<span class="udiff-line-added">+                             null, null, -1, BasicReason.ALGORITHM_CONSTRAINED);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          algorithmConstraints.permits(algorithm, cp);
      }
  
      // Check if a string is contained inside the property
      public boolean checkProperty(String param) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -180,11 +219,15 @@</span>
  
      // Check algorithm constraints with key and algorithm
      private boolean checkConstraints(Set&lt;CryptoPrimitive&gt; primitives,
              String algorithm, Key key, AlgorithmParameters parameters) {
  
<span class="udiff-line-modified-removed">-         // check the key parameter, it cannot be null.</span>
<span class="udiff-line-modified-added">+         if (primitives == null || primitives.isEmpty()) {</span>
<span class="udiff-line-added">+             throw new IllegalArgumentException(&quot;The primitives cannot be null&quot; +</span>
<span class="udiff-line-added">+                     &quot; or empty.&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          if (key == null) {
              throw new IllegalArgumentException(&quot;The key cannot be null&quot;);
          }
  
          // check the signature algorithm with parameters
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -197,10 +240,17 @@</span>
          // check the key algorithm
          if (!permits(primitives, key.getAlgorithm(), null)) {
              return false;
          }
  
<span class="udiff-line-added">+         // If this is an elliptic curve, check disabled the named curve.</span>
<span class="udiff-line-added">+         for (String curve : ConstraintsParameters.getNamedCurveFromKey(key)) {</span>
<span class="udiff-line-added">+             if (!permits(primitives, curve, null)) {</span>
<span class="udiff-line-added">+                 return false;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          // check the key constraints
          return algorithmConstraints.permits(key);
      }
  
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -228,11 +278,11 @@</span>
          private static class Holder {
              private static final Pattern DENY_AFTER_PATTERN = Pattern.compile(
                      &quot;denyAfter\\s+(\\d{4})-(\\d{2})-(\\d{2})&quot;);
          }
  
<span class="udiff-line-modified-removed">-         public Constraints(String[] constraintArray) {</span>
<span class="udiff-line-modified-added">+         public Constraints(List&lt;String&gt; constraintArray) {</span>
              for (String constraintEntry : constraintArray) {
                  if (constraintEntry == null || constraintEntry.isEmpty()) {
                      continue;
                  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -255,11 +305,13 @@</span>
                  // Consider the impact of algorithm aliases.
                  for (String alias : AlgorithmDecomposer.getAliases(algorithm)) {
                      constraintsMap.putIfAbsent(alias, constraintList);
                  }
  
<span class="udiff-line-modified-removed">-                 if (space &lt;= 0) {</span>
<span class="udiff-line-modified-added">+                 // If there is no whitespace, it is a algorithm name; however,</span>
<span class="udiff-line-added">+                 // if there is a whitespace, could be a multi-word EC curve too.</span>
<span class="udiff-line-added">+                 if (space &lt;= 0 || CurveDB.lookup(constraintEntry) != null) {</span>
                      constraintList.add(new DisabledConstraint(algorithm));
                      continue;
                  }
  
                  String policy = constraintEntry.substring(space + 1);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -354,11 +406,11 @@</span>
                  return true;
              }
              for (Constraint constraint : list) {
                  if (!constraint.permits(key)) {
                      if (debug != null) {
<span class="udiff-line-modified-removed">-                         debug.println(&quot;keySizeConstraint: failed key &quot; +</span>
<span class="udiff-line-modified-added">+                         debug.println(&quot;Constraints: failed key size&quot; +</span>
                                  &quot;constraint check &quot; + KeyUtil.getKeySize(key));
                      }
                      return false;
                  }
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -373,11 +425,11 @@</span>
              }
  
              for (Constraint constraint : list) {
                  if (!constraint.permits(aps)) {
                      if (debug != null) {
<span class="udiff-line-modified-removed">-                         debug.println(&quot;keySizeConstraint: failed algorithm &quot; +</span>
<span class="udiff-line-modified-added">+                         debug.println(&quot;Constraints: failed algorithm &quot; +</span>
                                  &quot;parameters constraint check &quot; + aps);
                      }
  
                      return false;
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -390,12 +442,11 @@</span>
          public void permits(String algorithm, ConstraintsParameters cp)
                  throws CertPathValidatorException {
              X509Certificate cert = cp.getCertificate();
  
              if (debug != null) {
<span class="udiff-line-modified-removed">-                 debug.println(&quot;Constraints.permits(): &quot; + algorithm +</span>
<span class="udiff-line-removed">-                         &quot; Variant: &quot; + cp.getVariant());</span>
<span class="udiff-line-modified-added">+                 debug.println(&quot;Constraints.permits(): &quot; + cp.toString());</span>
              }
  
              // Get all signature algorithms to check for constraints
              Set&lt;String&gt; algorithms = new HashSet&lt;&gt;();
              if (algorithm != null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -404,12 +455,12 @@</span>
  
              // Attempt to add the public key algorithm if cert provided
              if (cert != null) {
                  algorithms.add(cert.getPublicKey().getAlgorithm());
              }
<span class="udiff-line-modified-removed">-             if (cp.getPublicKey() != null) {</span>
<span class="udiff-line-modified-removed">-                 algorithms.add(cp.getPublicKey().getAlgorithm());</span>
<span class="udiff-line-modified-added">+             if (cp.getKey() != null) {</span>
<span class="udiff-line-modified-added">+                 algorithms.add(cp.getKey().getAlgorithm());</span>
              }
              // Check all applicable constraints
              for (String alg : algorithms) {
                  List&lt;Constraint&gt; list = getConstraints(alg);
                  if (list == null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -544,14 +595,11 @@</span>
           * @param key Public key
           * @return &#39;true&#39; if constraint allows the operation, &#39;false&#39; if
           * the constraint denies the operation.
           */
          boolean next(Key key) {
<span class="udiff-line-modified-removed">-             if (nextConstraint != null &amp;&amp; nextConstraint.permits(key)) {</span>
<span class="udiff-line-removed">-                 return true;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return false;</span>
<span class="udiff-line-modified-added">+             return nextConstraint != null &amp;&amp; nextConstraint.permits(key);</span>
          }
  
          String extendedMsg(ConstraintsParameters cp) {
              return (cp.getCertificate() == null ? &quot;.&quot; :
                      &quot; used with certificate: &quot; +
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -797,12 +845,12 @@</span>
           */
          @Override
          public void permits(ConstraintsParameters cp)
                  throws CertPathValidatorException {
              Key key = null;
<span class="udiff-line-modified-removed">-             if (cp.getPublicKey() != null) {</span>
<span class="udiff-line-modified-removed">-                 key = cp.getPublicKey();</span>
<span class="udiff-line-modified-added">+             if (cp.getKey() != null) {</span>
<span class="udiff-line-modified-added">+                 key = cp.getKey();</span>
              } else if (cp.getCertificate() != null) {
                  key = cp.getCertificate().getPublicKey();
              }
              if (key != null &amp;&amp; !permitsImpl(key)) {
                  if (nextConstraint != null) {
</pre>
<center><a href="DerValue.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DomainName.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>