<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/security/provider/certpath/URICertStore.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SunCertPathBuilderException.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="X509CertPath.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/provider/certpath/URICertStore.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2006, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
106     private X509CRL crl;
107 
108     // time we last checked for an update
109     private long lastChecked;
110 
111     // time server returned as last modified time stamp
112     // or 0 if not available
113     private long lastModified;
114 
115     // the URI of this CertStore
116     private URI uri;
117 
118     // true if URI is ldap
119     private boolean ldap = false;
120     private CertStore ldapCertStore;
121 
122     // Default maximum connect timeout in milliseconds (15 seconds)
123     // allowed when downloading CRLs
124     private static final int DEFAULT_CRL_CONNECT_TIMEOUT = 15000;
125 




126     /**
127      * Integer value indicating the connect timeout, in seconds, to be
128      * used for the CRL download. A timeout of zero is interpreted as
129      * an infinite timeout.
130      */
<span class="line-modified">131     private static final int CRL_CONNECT_TIMEOUT = initializeTimeout();</span>


132 
133     /**
<span class="line-modified">134      * Initialize the timeout length by getting the CRL timeout</span>









135      * system property. If the property has not been set, or if its
<span class="line-modified">136      * value is negative, set the timeout length to the default.</span>
137      */
<span class="line-modified">138     private static int initializeTimeout() {</span>
<span class="line-modified">139         Integer tmp = java.security.AccessController.doPrivileged(</span>
<span class="line-removed">140                 new GetIntegerAction(&quot;com.sun.security.crl.timeout&quot;));</span>
141         if (tmp == null || tmp &lt; 0) {
<span class="line-modified">142             return DEFAULT_CRL_CONNECT_TIMEOUT;</span>



143         }
144         // Convert to milliseconds, as the system property will be
145         // specified in seconds
146         return tmp * 1000;
147     }
148 
149     /**
150      * Creates a URICertStore.
151      *
152      * @param parameters specifying the URI
153      */
154     URICertStore(CertStoreParameters params)
155         throws InvalidAlgorithmParameterException, NoSuchAlgorithmException {
156         super(params);
157         if (!(params instanceof URICertStoreParameters)) {
158             throw new InvalidAlgorithmParameterException
159                 (&quot;params must be instanceof URICertStoreParameters&quot;);
160         }
161         this.uri = ((URICertStoreParameters) params).getURI();
162         // if ldap URI, use an LDAPCertStore to fetch certs and CRLs
</pre>
<hr />
<pre>
347         }
348 
349         // Return the CRLs for this entry. It returns the cached value
350         // if it is still current and fetches the CRLs otherwise.
351         // For the caching details, see the top of this class.
352         long time = System.currentTimeMillis();
353         if (time - lastChecked &lt; CHECK_INTERVAL) {
354             if (debug != null) {
355                 debug.println(&quot;Returning CRL from cache&quot;);
356             }
357             return getMatchingCRLs(crl, selector);
358         }
359         lastChecked = time;
360         try {
361             URLConnection connection = uri.toURL().openConnection();
362             if (lastModified != 0) {
363                 connection.setIfModifiedSince(lastModified);
364             }
365             long oldLastModified = lastModified;
366             connection.setConnectTimeout(CRL_CONNECT_TIMEOUT);

367             try (InputStream in = connection.getInputStream()) {
368                 lastModified = connection.getLastModified();
369                 if (oldLastModified != 0) {
370                     if (oldLastModified == lastModified) {
371                         if (debug != null) {
372                             debug.println(&quot;Not modified, using cached copy&quot;);
373                         }
374                         return getMatchingCRLs(crl, selector);
375                     } else if (connection instanceof HttpURLConnection) {
376                         // some proxy servers omit last modified
377                         HttpURLConnection hconn = (HttpURLConnection)connection;
378                         if (hconn.getResponseCode()
379                                     == HttpURLConnection.HTTP_NOT_MODIFIED) {
380                             if (debug != null) {
381                                 debug.println(&quot;Not modified, using cached copy&quot;);
382                             }
383                             return getMatchingCRLs(crl, selector);
384                         }
385                     }
386                 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2006, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
106     private X509CRL crl;
107 
108     // time we last checked for an update
109     private long lastChecked;
110 
111     // time server returned as last modified time stamp
112     // or 0 if not available
113     private long lastModified;
114 
115     // the URI of this CertStore
116     private URI uri;
117 
118     // true if URI is ldap
119     private boolean ldap = false;
120     private CertStore ldapCertStore;
121 
122     // Default maximum connect timeout in milliseconds (15 seconds)
123     // allowed when downloading CRLs
124     private static final int DEFAULT_CRL_CONNECT_TIMEOUT = 15000;
125 
<span class="line-added">126     // Default maximum read timeout in milliseconds (15 seconds)</span>
<span class="line-added">127     // allowed when downloading CRLs</span>
<span class="line-added">128     private static final int DEFAULT_CRL_READ_TIMEOUT = 15000;</span>
<span class="line-added">129 </span>
130     /**
131      * Integer value indicating the connect timeout, in seconds, to be
132      * used for the CRL download. A timeout of zero is interpreted as
133      * an infinite timeout.
134      */
<span class="line-modified">135     private static final int CRL_CONNECT_TIMEOUT =</span>
<span class="line-added">136         initializeTimeout(&quot;com.sun.security.crl.timeout&quot;,</span>
<span class="line-added">137                           DEFAULT_CRL_CONNECT_TIMEOUT);</span>
138 
139     /**
<span class="line-modified">140      * Integer value indicating the read timeout, in seconds, to be</span>
<span class="line-added">141      * used for the CRL download. A timeout of zero is interpreted as</span>
<span class="line-added">142      * an infinite timeout.</span>
<span class="line-added">143      */</span>
<span class="line-added">144     private static final int CRL_READ_TIMEOUT =</span>
<span class="line-added">145         initializeTimeout(&quot;com.sun.security.crl.readtimeout&quot;,</span>
<span class="line-added">146                           DEFAULT_CRL_READ_TIMEOUT);</span>
<span class="line-added">147 </span>
<span class="line-added">148     /**</span>
<span class="line-added">149      * Initialize the timeout length by getting the specified CRL timeout</span>
150      * system property. If the property has not been set, or if its
<span class="line-modified">151      * value is negative, set the timeout length to the specified default.</span>
152      */
<span class="line-modified">153     private static int initializeTimeout(String prop, int def) {</span>
<span class="line-modified">154         Integer tmp = GetIntegerAction.privilegedGetProperty(prop);</span>

155         if (tmp == null || tmp &lt; 0) {
<span class="line-modified">156             return def;</span>
<span class="line-added">157         }</span>
<span class="line-added">158         if (debug != null) {</span>
<span class="line-added">159             debug.println(prop + &quot; set to &quot; + tmp + &quot; seconds&quot;);</span>
160         }
161         // Convert to milliseconds, as the system property will be
162         // specified in seconds
163         return tmp * 1000;
164     }
165 
166     /**
167      * Creates a URICertStore.
168      *
169      * @param parameters specifying the URI
170      */
171     URICertStore(CertStoreParameters params)
172         throws InvalidAlgorithmParameterException, NoSuchAlgorithmException {
173         super(params);
174         if (!(params instanceof URICertStoreParameters)) {
175             throw new InvalidAlgorithmParameterException
176                 (&quot;params must be instanceof URICertStoreParameters&quot;);
177         }
178         this.uri = ((URICertStoreParameters) params).getURI();
179         // if ldap URI, use an LDAPCertStore to fetch certs and CRLs
</pre>
<hr />
<pre>
364         }
365 
366         // Return the CRLs for this entry. It returns the cached value
367         // if it is still current and fetches the CRLs otherwise.
368         // For the caching details, see the top of this class.
369         long time = System.currentTimeMillis();
370         if (time - lastChecked &lt; CHECK_INTERVAL) {
371             if (debug != null) {
372                 debug.println(&quot;Returning CRL from cache&quot;);
373             }
374             return getMatchingCRLs(crl, selector);
375         }
376         lastChecked = time;
377         try {
378             URLConnection connection = uri.toURL().openConnection();
379             if (lastModified != 0) {
380                 connection.setIfModifiedSince(lastModified);
381             }
382             long oldLastModified = lastModified;
383             connection.setConnectTimeout(CRL_CONNECT_TIMEOUT);
<span class="line-added">384             connection.setReadTimeout(CRL_READ_TIMEOUT);</span>
385             try (InputStream in = connection.getInputStream()) {
386                 lastModified = connection.getLastModified();
387                 if (oldLastModified != 0) {
388                     if (oldLastModified == lastModified) {
389                         if (debug != null) {
390                             debug.println(&quot;Not modified, using cached copy&quot;);
391                         }
392                         return getMatchingCRLs(crl, selector);
393                     } else if (connection instanceof HttpURLConnection) {
394                         // some proxy servers omit last modified
395                         HttpURLConnection hconn = (HttpURLConnection)connection;
396                         if (hconn.getResponseCode()
397                                     == HttpURLConnection.HTTP_NOT_MODIFIED) {
398                             if (debug != null) {
399                                 debug.println(&quot;Not modified, using cached copy&quot;);
400                             }
401                             return getMatchingCRLs(crl, selector);
402                         }
403                     }
404                 }
</pre>
</td>
</tr>
</table>
<center><a href="SunCertPathBuilderException.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="X509CertPath.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>