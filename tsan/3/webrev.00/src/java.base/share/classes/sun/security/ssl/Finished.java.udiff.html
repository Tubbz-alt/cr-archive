<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/ssl/Finished.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="EphemeralKeyManager.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HandshakeContext.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/Finished.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -408,10 +408,14 @@</span>
               */
              if (chc.conContext.secureRenegotiation) {
                  chc.conContext.clientVerifyData = fm.verifyData;
              }
  
<span class="udiff-line-added">+             if (chc.statelessResumption) {</span>
<span class="udiff-line-added">+                 chc.handshakeConsumers.put(</span>
<span class="udiff-line-added">+                         SSLHandshake.NEW_SESSION_TICKET.id, SSLHandshake.NEW_SESSION_TICKET);</span>
<span class="udiff-line-added">+             }</span>
              // update the consumers and producers
              if (!chc.isResumption) {
                  chc.conContext.consumers.put(ContentType.CHANGE_CIPHER_SPEC.id,
                          ChangeCipherSpec.t10Consumer);
                  chc.handshakeConsumers.put(
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -439,10 +443,14 @@</span>
              return null;
          }
  
          private byte[] onProduceFinished(ServerHandshakeContext shc,
                  HandshakeMessage message) throws IOException {
<span class="udiff-line-added">+             if (shc.statelessResumption) {</span>
<span class="udiff-line-added">+                 NewSessionTicket.handshake12Producer.produce(shc, message);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
              // Refresh handshake hash
              shc.handshakeHash.update();
  
              FinishedMessage fm = new FinishedMessage(shc);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -471,11 +479,12 @@</span>
                          ChangeCipherSpec.t10Consumer);
                  shc.handshakeConsumers.put(
                          SSLHandshake.FINISHED.id, SSLHandshake.FINISHED);
                  shc.conContext.inputRecord.expectingFinishFlight();
              } else {
<span class="udiff-line-modified-removed">-                 if (shc.handshakeSession.isRejoinable()) {</span>
<span class="udiff-line-modified-added">+                 if (shc.handshakeSession.isRejoinable() &amp;&amp;</span>
<span class="udiff-line-added">+                         !shc.handshakeSession.isStatelessable(shc)) {</span>
                      ((SSLSessionContextImpl)shc.sslContext.
                          engineGetServerSessionContext()).put(
                              shc.handshakeSession);
                  }
                  shc.conContext.conSession = shc.handshakeSession.finish();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -578,10 +587,20 @@</span>
              }
          }
  
          private void onConsumeFinished(ServerHandshakeContext shc,
                  ByteBuffer message) throws IOException {
<span class="udiff-line-added">+             // Make sure that any expected CertificateVerify message</span>
<span class="udiff-line-added">+             // has been received and processed.</span>
<span class="udiff-line-added">+             if (!shc.isResumption) {</span>
<span class="udiff-line-added">+                 if (shc.handshakeConsumers.containsKey(</span>
<span class="udiff-line-added">+                         SSLHandshake.CERTIFICATE_VERIFY.id)) {</span>
<span class="udiff-line-added">+                     throw shc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="udiff-line-added">+                             &quot;Unexpected Finished handshake message&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
              FinishedMessage fm = new FinishedMessage(shc, message);
              if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
                  SSLLogger.fine(
                          &quot;Consuming client Finished handshake message&quot;, fm);
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -589,11 +608,12 @@</span>
              if (shc.conContext.secureRenegotiation) {
                  shc.conContext.clientVerifyData = fm.verifyData;
              }
  
              if (shc.isResumption) {
<span class="udiff-line-modified-removed">-                 if (shc.handshakeSession.isRejoinable()) {</span>
<span class="udiff-line-modified-added">+                 if (shc.handshakeSession.isRejoinable() &amp;&amp;</span>
<span class="udiff-line-added">+                         !shc.statelessResumption) {</span>
                      ((SSLSessionContextImpl)shc.sslContext.
                          engineGetServerSessionContext()).put(
                              shc.handshakeSession);
                  }
                  shc.conContext.conSession = shc.handshakeSession.finish();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -835,10 +855,12 @@</span>
               */
              if (shc.conContext.secureRenegotiation) {
                  shc.conContext.serverVerifyData = fm.verifyData;
              }
  
<span class="udiff-line-added">+             shc.conContext.conSession = shc.handshakeSession.finish();</span>
<span class="udiff-line-added">+ </span>
              // update the context
              shc.handshakeConsumers.put(
                      SSLHandshake.FINISHED.id, SSLHandshake.FINISHED);
  
              // The handshake message has been delivered.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -869,10 +891,20 @@</span>
              }
          }
  
          private void onConsumeFinished(ClientHandshakeContext chc,
                  ByteBuffer message) throws IOException {
<span class="udiff-line-added">+             // Make sure that any expected CertificateVerify message</span>
<span class="udiff-line-added">+             // has been received and processed.</span>
<span class="udiff-line-added">+             if (!chc.isResumption) {</span>
<span class="udiff-line-added">+                 if (chc.handshakeConsumers.containsKey(</span>
<span class="udiff-line-added">+                         SSLHandshake.CERTIFICATE_VERIFY.id)) {</span>
<span class="udiff-line-added">+                     throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="udiff-line-added">+                             &quot;Unexpected Finished handshake message&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
              FinishedMessage fm = new FinishedMessage(chc, message);
              if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
                  SSLLogger.fine(
                          &quot;Consuming server Finished handshake message&quot;, fm);
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -913,13 +945,13 @@</span>
                          chc.negotiatedProtocol);
              }
  
              // save the session
              if (!chc.isResumption &amp;&amp; chc.handshakeSession.isRejoinable()) {
<span class="udiff-line-modified-removed">-                 SSLSessionContextImpl sessionContext = (SSLSessionContextImpl)</span>
<span class="udiff-line-modified-removed">-                 chc.sslContext.engineGetClientSessionContext();</span>
<span class="udiff-line-modified-removed">-                 sessionContext.put(chc.handshakeSession);</span>
<span class="udiff-line-modified-added">+                 ((SSLSessionContextImpl)chc.sslContext.</span>
<span class="udiff-line-modified-added">+                         engineGetClientSessionContext()).</span>
<span class="udiff-line-modified-added">+                         put(chc.handshakeSession);</span>
              }
  
              // derive salt secret
              try {
                  SecretKey saltSecret = kd.deriveKey(&quot;TlsSaltSecret&quot;, null);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -991,10 +1023,20 @@</span>
              }
          }
  
          private void onConsumeFinished(ServerHandshakeContext shc,
                  ByteBuffer message) throws IOException {
<span class="udiff-line-added">+             // Make sure that any expected CertificateVerify message</span>
<span class="udiff-line-added">+             // has been received and processed.</span>
<span class="udiff-line-added">+             if (!shc.isResumption) {</span>
<span class="udiff-line-added">+                 if (shc.handshakeConsumers.containsKey(</span>
<span class="udiff-line-added">+                         SSLHandshake.CERTIFICATE_VERIFY.id)) {</span>
<span class="udiff-line-added">+                     throw shc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="udiff-line-added">+                             &quot;Unexpected Finished handshake message&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
              FinishedMessage fm = new FinishedMessage(shc, message);
              if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
                  SSLLogger.fine(
                          &quot;Consuming client Finished handshake message&quot;, fm);
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1026,14 +1068,15 @@</span>
                  throw shc.conContext.fatal(Alert.INTERNAL_ERROR,
                          &quot;Not supported key derivation: &quot; +
                          shc.negotiatedProtocol);
              }
  
<span class="udiff-line-modified-removed">-             // save the session</span>
<span class="udiff-line-modified-removed">-             if (!shc.isResumption &amp;&amp; shc.handshakeSession.isRejoinable()) {</span>
<span class="udiff-line-modified-added">+             // Save the session if possible and not stateless</span>
<span class="udiff-line-modified-added">+             if (!shc.statelessResumption &amp;&amp; !shc.isResumption &amp;&amp;</span>
<span class="udiff-line-added">+                     shc.handshakeSession.isRejoinable()) {</span>
                  SSLSessionContextImpl sessionContext = (SSLSessionContextImpl)
<span class="udiff-line-modified-removed">-                 shc.sslContext.engineGetServerSessionContext();</span>
<span class="udiff-line-modified-added">+                         shc.sslContext.engineGetServerSessionContext();</span>
                  sessionContext.put(shc.handshakeSession);
              }
  
              try {
                  // update the application traffic read keys.
</pre>
<center><a href="EphemeralKeyManager.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HandshakeContext.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>