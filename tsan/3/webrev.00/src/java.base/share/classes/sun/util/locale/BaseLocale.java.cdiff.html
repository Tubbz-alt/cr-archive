<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/util/locale/BaseLocale.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../cldr/CLDRTimeZoneNameProviderImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="LocaleSyntaxException.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/util/locale/BaseLocale.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 30,18 ***</span>
   *******************************************************************************
   */
  
  package sun.util.locale;
  
  import java.lang.ref.SoftReference;
  import java.util.StringJoiner;
  
  public final class BaseLocale {
  
<span class="line-modified">!     public static final String SEP = &quot;_&quot;;</span>
  
<span class="line-modified">!     private static final Cache CACHE = new Cache();</span>
  
      private final String language;
      private final String script;
      private final String region;
      private final String variant;
<span class="line-new-header">--- 30,68 ---</span>
   *******************************************************************************
   */
  
  package sun.util.locale;
  
<span class="line-added">+ import jdk.internal.misc.VM;</span>
<span class="line-added">+ import jdk.internal.vm.annotation.Stable;</span>
<span class="line-added">+ </span>
  import java.lang.ref.SoftReference;
  import java.util.StringJoiner;
  
  public final class BaseLocale {
  
<span class="line-modified">!     public static @Stable BaseLocale[] constantBaseLocales;</span>
<span class="line-added">+     public static final byte ENGLISH = 0,</span>
<span class="line-added">+             FRENCH = 1,</span>
<span class="line-added">+             GERMAN = 2,</span>
<span class="line-added">+             ITALIAN = 3,</span>
<span class="line-added">+             JAPANESE = 4,</span>
<span class="line-added">+             KOREAN = 5,</span>
<span class="line-added">+             CHINESE = 6,</span>
<span class="line-added">+             SIMPLIFIED_CHINESE = 7,</span>
<span class="line-added">+             TRADITIONAL_CHINESE = 8,</span>
<span class="line-added">+             FRANCE = 9,</span>
<span class="line-added">+             GERMANY = 10,</span>
<span class="line-added">+             ITALY = 11,</span>
<span class="line-added">+             JAPAN = 12,</span>
<span class="line-added">+             KOREA = 13,</span>
<span class="line-added">+             UK = 14,</span>
<span class="line-added">+             US = 15,</span>
<span class="line-added">+             CANADA = 16,</span>
<span class="line-added">+             CANADA_FRENCH = 17,</span>
<span class="line-added">+             ROOT = 18,</span>
<span class="line-added">+             NUM_CONSTANTS = 19;</span>
<span class="line-added">+     static {</span>
<span class="line-added">+         VM.initializeFromArchive(BaseLocale.class);</span>
<span class="line-added">+         BaseLocale[] baseLocales = constantBaseLocales;</span>
<span class="line-added">+         if (baseLocales == null) {</span>
<span class="line-added">+             baseLocales = new BaseLocale[NUM_CONSTANTS];</span>
<span class="line-added">+             baseLocales[ENGLISH] = createInstance(&quot;en&quot;, &quot;&quot;);</span>
<span class="line-added">+             baseLocales[FRENCH] = createInstance(&quot;fr&quot;, &quot;&quot;);</span>
<span class="line-added">+             baseLocales[GERMAN] = createInstance(&quot;de&quot;, &quot;&quot;);</span>
<span class="line-added">+             baseLocales[ITALIAN] = createInstance(&quot;it&quot;, &quot;&quot;);</span>
<span class="line-added">+             baseLocales[JAPANESE] = createInstance(&quot;ja&quot;, &quot;&quot;);</span>
<span class="line-added">+             baseLocales[KOREAN] = createInstance(&quot;ko&quot;, &quot;&quot;);</span>
<span class="line-added">+             baseLocales[CHINESE] = createInstance(&quot;zh&quot;, &quot;&quot;);</span>
<span class="line-added">+             baseLocales[SIMPLIFIED_CHINESE] = createInstance(&quot;zh&quot;, &quot;CN&quot;);</span>
<span class="line-added">+             baseLocales[TRADITIONAL_CHINESE] = createInstance(&quot;zh&quot;, &quot;TW&quot;);</span>
<span class="line-added">+             baseLocales[FRANCE] = createInstance(&quot;fr&quot;, &quot;FR&quot;);</span>
<span class="line-added">+             baseLocales[GERMANY] = createInstance(&quot;de&quot;, &quot;DE&quot;);</span>
<span class="line-added">+             baseLocales[ITALY] = createInstance(&quot;it&quot;, &quot;IT&quot;);</span>
<span class="line-added">+             baseLocales[JAPAN] = createInstance(&quot;ja&quot;, &quot;JP&quot;);</span>
<span class="line-added">+             baseLocales[KOREA] = createInstance(&quot;ko&quot;, &quot;KR&quot;);</span>
<span class="line-added">+             baseLocales[UK] = createInstance(&quot;en&quot;, &quot;GB&quot;);</span>
<span class="line-added">+             baseLocales[US] = createInstance(&quot;en&quot;, &quot;US&quot;);</span>
<span class="line-added">+             baseLocales[CANADA] = createInstance(&quot;en&quot;, &quot;CA&quot;);</span>
<span class="line-added">+             baseLocales[CANADA_FRENCH] = createInstance(&quot;fr&quot;, &quot;CA&quot;);</span>
<span class="line-added">+             baseLocales[ROOT] = createInstance(&quot;&quot;, &quot;&quot;);</span>
<span class="line-added">+             constantBaseLocales = baseLocales;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     public static final String SEP = &quot;_&quot;;</span>
  
      private final String language;
      private final String script;
      private final String region;
      private final String variant;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 65,32 ***</span>
          }
      }
  
      // Called for creating the Locale.* constants. No argument
      // validation is performed.
<span class="line-modified">!     public static BaseLocale createInstance(String language, String region) {</span>
<span class="line-modified">!         BaseLocale base = new BaseLocale(language, &quot;&quot;, region, &quot;&quot;, false);</span>
<span class="line-removed">-         CACHE.put(new Key(base), base);</span>
<span class="line-removed">-         return base;</span>
      }
  
      public static BaseLocale getInstance(String language, String script,
                                           String region, String variant) {
          // JDK uses deprecated ISO639.1 language codes for he, yi and id
<span class="line-modified">!         if (language != null) {</span>
<span class="line-modified">!             if (LocaleUtils.caseIgnoreMatch(language, &quot;he&quot;)) {</span>
                  language = &quot;iw&quot;;
<span class="line-modified">!             } else if (LocaleUtils.caseIgnoreMatch(language, &quot;yi&quot;)) {</span>
                  language = &quot;ji&quot;;
<span class="line-modified">!             } else if (LocaleUtils.caseIgnoreMatch(language, &quot;id&quot;)) {</span>
                  language = &quot;in&quot;;
              }
          }
  
          Key key = new Key(language, script, region, variant, false);
<span class="line-modified">!         BaseLocale baseLocale = CACHE.get(key);</span>
<span class="line-removed">-         return baseLocale;</span>
      }
  
      public String getLanguage() {
          return language;
      }
<span class="line-new-header">--- 115,57 ---</span>
          }
      }
  
      // Called for creating the Locale.* constants. No argument
      // validation is performed.
<span class="line-modified">!     private static BaseLocale createInstance(String language, String region) {</span>
<span class="line-modified">!         return new BaseLocale(language, &quot;&quot;, region, &quot;&quot;, false);</span>
      }
  
      public static BaseLocale getInstance(String language, String script,
                                           String region, String variant) {
<span class="line-added">+ </span>
<span class="line-added">+         if (script == null) {</span>
<span class="line-added">+             script = &quot;&quot;;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (region == null) {</span>
<span class="line-added">+             region = &quot;&quot;;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (language == null) {</span>
<span class="line-added">+             language = null;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (variant == null) {</span>
<span class="line-added">+             variant = &quot;&quot;;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         // Non-allocating for most uses</span>
<span class="line-added">+         language = LocaleUtils.toLowerString(language);</span>
<span class="line-added">+         region = LocaleUtils.toUpperString(region);</span>
<span class="line-added">+ </span>
<span class="line-added">+         // Check for constant base locales first</span>
<span class="line-added">+         if (script.isEmpty() &amp;&amp; variant.isEmpty()) {</span>
<span class="line-added">+             for (BaseLocale baseLocale : constantBaseLocales) {</span>
<span class="line-added">+                 if (baseLocale.getLanguage().equals(language)</span>
<span class="line-added">+                         &amp;&amp; baseLocale.getRegion().equals(region)) {</span>
<span class="line-added">+                     return baseLocale;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          // JDK uses deprecated ISO639.1 language codes for he, yi and id
<span class="line-modified">!         if (!language.isEmpty()) {</span>
<span class="line-modified">!             if (language.equals(&quot;he&quot;)) {</span>
                  language = &quot;iw&quot;;
<span class="line-modified">!             } else if (language.equals(&quot;yi&quot;)) {</span>
                  language = &quot;ji&quot;;
<span class="line-modified">!             } else if (language.equals(&quot;id&quot;)) {</span>
                  language = &quot;in&quot;;
              }
          }
  
          Key key = new Key(language, script, region, variant, false);
<span class="line-modified">!         return Cache.CACHE.get(key);</span>
      }
  
      public String getLanguage() {
          return language;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 169,50 ***</span>
          private final BaseLocale holder;
  
          private final boolean normalized;
          private final int hash;
  
<span class="line-removed">-         /**</span>
<span class="line-removed">-          * Creates a Key. language and region must be normalized</span>
<span class="line-removed">-          * (intern&#39;ed in the proper case).</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         private Key(BaseLocale locale) {</span>
<span class="line-removed">-             this.holder = locale;</span>
<span class="line-removed">-             this.holderRef = null;</span>
<span class="line-removed">-             this.normalized = true;</span>
<span class="line-removed">-             String language = locale.getLanguage();</span>
<span class="line-removed">-             String region = locale.getRegion();</span>
<span class="line-removed">-             assert LocaleUtils.toLowerString(language).intern() == language</span>
<span class="line-removed">-                     &amp;&amp; LocaleUtils.toUpperString(region).intern() == region</span>
<span class="line-removed">-                     &amp;&amp; locale.getVariant() == &quot;&quot;</span>
<span class="line-removed">-                     &amp;&amp; locale.getScript() == &quot;&quot;;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             int h = language.hashCode();</span>
<span class="line-removed">-             if (region != &quot;&quot;) {</span>
<span class="line-removed">-                 int len = region.length();</span>
<span class="line-removed">-                 for (int i = 0; i &lt; len; i++) {</span>
<span class="line-removed">-                     h = 31 * h + LocaleUtils.toLower(region.charAt(i));</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             hash = h;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
          private Key(String language, String script, String region,
                      String variant, boolean normalize) {
<span class="line-removed">-             if (language == null) {</span>
<span class="line-removed">-                 language = &quot;&quot;;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             if (script == null) {</span>
<span class="line-removed">-                 script = &quot;&quot;;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             if (region == null) {</span>
<span class="line-removed">-                 region = &quot;&quot;;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             if (variant == null) {</span>
<span class="line-removed">-                 variant = &quot;&quot;;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
              BaseLocale locale = new BaseLocale(language, script, region, variant, normalize);
              this.normalized = normalize;
              if (normalized) {
                  this.holderRef = new SoftReference&lt;&gt;(locale);
                  this.holder = null;
<span class="line-new-header">--- 244,12 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 289,10 ***</span>
<span class="line-new-header">--- 326,12 ---</span>
          }
      }
  
      private static class Cache extends LocaleObjectCache&lt;Key, BaseLocale&gt; {
  
<span class="line-added">+         private static final Cache CACHE = new Cache();</span>
<span class="line-added">+ </span>
          public Cache() {
          }
  
          @Override
          protected Key normalizeKey(Key key) {
</pre>
<center><a href="../cldr/CLDRTimeZoneNameProviderImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="LocaleSyntaxException.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>