<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/ssl/TrustStoreManager.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="TransportContext.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Utilities.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/TrustStoreManager.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 28,10 ***</span>
<span class="line-new-header">--- 28,11 ---</span>
  import java.io.*;
  import java.lang.ref.WeakReference;
  import java.security.*;
  import java.security.cert.*;
  import java.util.*;
<span class="line-added">+ import java.util.concurrent.locks.ReentrantLock;</span>
  import sun.security.action.*;
  import sun.security.validator.TrustStoreUtil;
  
  /**
   * Collection of static utility methods to manage the default trusted KeyStores
</pre>
<hr />
<pre>
<span class="line-old-header">*** 242,10 ***</span>
<span class="line-new-header">--- 243,12 ---</span>
          //
          // Use weak reference so that the heavy loaded certificates collection
          // objects can be atomically cleared, and reloaded if needed.
          private WeakReference&lt;Set&lt;X509Certificate&gt;&gt; csRef;
  
<span class="line-added">+         private final ReentrantLock tamLock = new ReentrantLock();</span>
<span class="line-added">+ </span>
          private TrustAnchorManager() {
              this.descriptor = null;
              this.ksRef = new WeakReference&lt;&gt;(null);
              this.csRef = new WeakReference&lt;&gt;(null);
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 253,82 ***</span>
          /**
           * Get the default trusted KeyStore with the specified descriptor.
           *
           * @return null if the underlying KeyStore is not available.
           */
<span class="line-modified">!         synchronized KeyStore getKeyStore(</span>
                  TrustStoreDescriptor descriptor) throws Exception {
  
              TrustStoreDescriptor temporaryDesc = this.descriptor;
              KeyStore ks = ksRef.get();
              if ((ks != null) &amp;&amp; descriptor.equals(temporaryDesc)) {
                  return ks;
              }
  
<span class="line-modified">!             // Reload a new key store.</span>
<span class="line-modified">!             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">!                 SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             ks = loadKeyStore(descriptor);</span>
<span class="line-modified">!             this.descriptor = descriptor;</span>
<span class="line-modified">!             this.ksRef = new WeakReference&lt;&gt;(ks);</span>
  
              return ks;
          }
  
          /**
           * Get trusted certificates in the default trusted KeyStore with
           * the specified descriptor.
           *
           * @return empty collection if the underlying KeyStore is not available.
           */
<span class="line-modified">!         synchronized Set&lt;X509Certificate&gt; getTrustedCerts(</span>
                  TrustStoreDescriptor descriptor) throws Exception {
  
              KeyStore ks = null;
              TrustStoreDescriptor temporaryDesc = this.descriptor;
              Set&lt;X509Certificate&gt; certs = csRef.get();
<span class="line-modified">!             if (certs != null) {</span>
<span class="line-modified">!                 if (descriptor.equals(temporaryDesc)) {</span>
<span class="line-modified">!                     return certs;</span>
                  } else {
<span class="line-modified">!                     // Use the new descriptor.</span>
<span class="line-modified">!                     this.descriptor = descriptor;</span>
                  }
<span class="line-modified">!             } else {</span>
<span class="line-modified">!                 // Try to use the cached store at first.</span>
<span class="line-modified">!                 if (descriptor.equals(temporaryDesc)) {</span>
<span class="line-modified">!                     ks = ksRef.get();</span>
<span class="line-modified">!                 } else {</span>
<span class="line-modified">!                     // Use the new descriptor.</span>
<span class="line-modified">!                     this.descriptor = descriptor;</span>
                  }
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             // Reload the trust store if needed.</span>
<span class="line-removed">-             if (ks == null) {</span>
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {
<span class="line-modified">!                     SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
                  }
<span class="line-removed">-                 ks = loadKeyStore(descriptor);</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             // Reload trust certs from the key store.</span>
<span class="line-modified">!             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">!                 SSLLogger.fine(&quot;Reload trust certs&quot;);</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             certs = loadTrustedCerts(ks);</span>
<span class="line-modified">!             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">!                 SSLLogger.fine(&quot;Reloaded &quot; + certs.size() + &quot; trust certs&quot;);</span>
              }
  
<span class="line-removed">-             // Note that as ks is a local variable, it is not</span>
<span class="line-removed">-             // necessary to add it to the ksRef weak reference.</span>
<span class="line-removed">-             this.csRef = new WeakReference&lt;&gt;(certs);</span>
<span class="line-removed">- </span>
              return certs;
          }
  
          /**
           * Load the KeyStore as described in the specified descriptor.
<span class="line-new-header">--- 256,104 ---</span>
          /**
           * Get the default trusted KeyStore with the specified descriptor.
           *
           * @return null if the underlying KeyStore is not available.
           */
<span class="line-modified">!         KeyStore getKeyStore(</span>
                  TrustStoreDescriptor descriptor) throws Exception {
  
              TrustStoreDescriptor temporaryDesc = this.descriptor;
              KeyStore ks = ksRef.get();
              if ((ks != null) &amp;&amp; descriptor.equals(temporaryDesc)) {
                  return ks;
              }
  
<span class="line-modified">!             tamLock.lock();</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 // double check</span>
<span class="line-modified">!                 ks = ksRef.get();</span>
<span class="line-added">+                 if ((ks != null) &amp;&amp; descriptor.equals(temporaryDesc)) {</span>
<span class="line-added">+                     return ks;</span>
<span class="line-added">+                 }</span>
  
<span class="line-modified">!                 // Reload a new key store.</span>
<span class="line-modified">!                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">!                     SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+ </span>
<span class="line-added">+                 ks = loadKeyStore(descriptor);</span>
<span class="line-added">+                 this.descriptor = descriptor;</span>
<span class="line-added">+                 this.ksRef = new WeakReference&lt;&gt;(ks);</span>
<span class="line-added">+             } finally {</span>
<span class="line-added">+                 tamLock.unlock();</span>
<span class="line-added">+             }</span>
  
              return ks;
          }
  
          /**
           * Get trusted certificates in the default trusted KeyStore with
           * the specified descriptor.
           *
           * @return empty collection if the underlying KeyStore is not available.
           */
<span class="line-modified">!         Set&lt;X509Certificate&gt; getTrustedCerts(</span>
                  TrustStoreDescriptor descriptor) throws Exception {
  
              KeyStore ks = null;
              TrustStoreDescriptor temporaryDesc = this.descriptor;
              Set&lt;X509Certificate&gt; certs = csRef.get();
<span class="line-modified">!             if ((certs != null) &amp;&amp; descriptor.equals(temporaryDesc)) {</span>
<span class="line-modified">!                 return certs;</span>
<span class="line-modified">!             }</span>
<span class="line-added">+ </span>
<span class="line-added">+             tamLock.lock();</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 // double check</span>
<span class="line-added">+                 temporaryDesc = this.descriptor;</span>
<span class="line-added">+                 certs = csRef.get();</span>
<span class="line-added">+                 if (certs != null) {</span>
<span class="line-added">+                     if (descriptor.equals(temporaryDesc)) {</span>
<span class="line-added">+                         return certs;</span>
<span class="line-added">+                     } else {</span>
<span class="line-added">+                         // Use the new descriptor.</span>
<span class="line-added">+                         this.descriptor = descriptor;</span>
<span class="line-added">+                     }</span>
                  } else {
<span class="line-modified">!                     // Try to use the cached store at first.</span>
<span class="line-modified">!                     if (descriptor.equals(temporaryDesc)) {</span>
<span class="line-added">+                         ks = ksRef.get();</span>
<span class="line-added">+                     } else {</span>
<span class="line-added">+                         // Use the new descriptor.</span>
<span class="line-added">+                         this.descriptor = descriptor;</span>
<span class="line-added">+                     }</span>
                  }
<span class="line-modified">! </span>
<span class="line-modified">!                 // Reload the trust store if needed.</span>
<span class="line-modified">!                 if (ks == null) {</span>
<span class="line-modified">!                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">!                         SSLLogger.fine(&quot;Reload the trust store&quot;);</span>
<span class="line-modified">!                     }</span>
<span class="line-modified">!                     ks = loadKeyStore(descriptor);</span>
<span class="line-added">+                     this.ksRef = new WeakReference&lt;&gt;(ks);</span>
                  }
  
<span class="line-modified">!                 // Reload trust certs from the key store.</span>
                  if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {
<span class="line-modified">!                     SSLLogger.fine(&quot;Reload trust certs&quot;);</span>
                  }
  
<span class="line-modified">!                 certs = loadTrustedCerts(ks);</span>
<span class="line-modified">!                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;trustmanager&quot;)) {</span>
<span class="line-modified">!                     SSLLogger.fine(&quot;Reloaded &quot; + certs.size() + &quot; trust certs&quot;);</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 this.csRef = new WeakReference&lt;&gt;(certs);</span>
<span class="line-modified">!             } finally {</span>
<span class="line-modified">!                 tamLock.unlock();</span>
              }
  
              return certs;
          }
  
          /**
           * Load the KeyStore as described in the specified descriptor.
</pre>
<center><a href="TransportContext.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="Utilities.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>