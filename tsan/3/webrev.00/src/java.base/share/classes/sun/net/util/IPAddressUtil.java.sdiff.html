<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/sun/net/util/IPAddressUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../spi/DefaultProxySelector.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../www/ApplicationLaunchException.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/net/util/IPAddressUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.net.util;
 27 
















 28 public class IPAddressUtil {
 29     private static final int INADDR4SZ = 4;
 30     private static final int INADDR16SZ = 16;
 31     private static final int INT16SZ = 2;
 32 
 33     /*
 34      * Converts IPv4 address in its textual presentation form
 35      * into its numeric binary form.
 36      *
 37      * @param src a String representing an IPv4 address in standard format
 38      * @return a byte array representing the IPv4 numeric address
 39      */
 40     @SuppressWarnings(&quot;fallthrough&quot;)
 41     public static byte[] textToNumericFormatV4(String src)
 42     {
 43         byte[] res = new byte[INADDR4SZ];
 44 
 45         long tmpValue = 0;
 46         int currByte = 0;
 47         boolean newOctet = true;
</pre>
<hr />
<pre>
270      * IPv4 mapped IPv6 address.
271      *
272      * @return a &lt;code&gt;boolean&lt;/code&gt; indicating if the InetAddress is
273      * an IPv4 mapped IPv6 address; or false if address is IPv4 address.
274      */
275     private static boolean isIPv4MappedAddress(byte[] addr) {
276         if (addr.length &lt; INADDR16SZ) {
277             return false;
278         }
279         if ((addr[0] == 0x00) &amp;&amp; (addr[1] == 0x00) &amp;&amp;
280             (addr[2] == 0x00) &amp;&amp; (addr[3] == 0x00) &amp;&amp;
281             (addr[4] == 0x00) &amp;&amp; (addr[5] == 0x00) &amp;&amp;
282             (addr[6] == 0x00) &amp;&amp; (addr[7] == 0x00) &amp;&amp;
283             (addr[8] == 0x00) &amp;&amp; (addr[9] == 0x00) &amp;&amp;
284             (addr[10] == (byte)0xff) &amp;&amp;
285             (addr[11] == (byte)0xff))  {
286             return true;
287         }
288         return false;
289     }
























































































































































































































































290 }
</pre>
</td>
<td>
<hr />
<pre>
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.net.util;
 27 
<span class="line-added"> 28 import java.io.IOException;</span>
<span class="line-added"> 29 import java.io.UncheckedIOException;</span>
<span class="line-added"> 30 import java.net.Inet6Address;</span>
<span class="line-added"> 31 import java.net.InetAddress;</span>
<span class="line-added"> 32 import java.net.InetSocketAddress;</span>
<span class="line-added"> 33 import java.net.NetworkInterface;</span>
<span class="line-added"> 34 import java.net.SocketException;</span>
<span class="line-added"> 35 import java.net.URL;</span>
<span class="line-added"> 36 import java.security.AccessController;</span>
<span class="line-added"> 37 import java.security.PrivilegedExceptionAction;</span>
<span class="line-added"> 38 import java.security.PrivilegedActionException;</span>
<span class="line-added"> 39 import java.util.Arrays;</span>
<span class="line-added"> 40 import java.util.List;</span>
<span class="line-added"> 41 import java.util.concurrent.ConcurrentHashMap;</span>
<span class="line-added"> 42 import java.util.stream.Collectors;</span>
<span class="line-added"> 43 </span>
 44 public class IPAddressUtil {
 45     private static final int INADDR4SZ = 4;
 46     private static final int INADDR16SZ = 16;
 47     private static final int INT16SZ = 2;
 48 
 49     /*
 50      * Converts IPv4 address in its textual presentation form
 51      * into its numeric binary form.
 52      *
 53      * @param src a String representing an IPv4 address in standard format
 54      * @return a byte array representing the IPv4 numeric address
 55      */
 56     @SuppressWarnings(&quot;fallthrough&quot;)
 57     public static byte[] textToNumericFormatV4(String src)
 58     {
 59         byte[] res = new byte[INADDR4SZ];
 60 
 61         long tmpValue = 0;
 62         int currByte = 0;
 63         boolean newOctet = true;
</pre>
<hr />
<pre>
286      * IPv4 mapped IPv6 address.
287      *
288      * @return a &lt;code&gt;boolean&lt;/code&gt; indicating if the InetAddress is
289      * an IPv4 mapped IPv6 address; or false if address is IPv4 address.
290      */
291     private static boolean isIPv4MappedAddress(byte[] addr) {
292         if (addr.length &lt; INADDR16SZ) {
293             return false;
294         }
295         if ((addr[0] == 0x00) &amp;&amp; (addr[1] == 0x00) &amp;&amp;
296             (addr[2] == 0x00) &amp;&amp; (addr[3] == 0x00) &amp;&amp;
297             (addr[4] == 0x00) &amp;&amp; (addr[5] == 0x00) &amp;&amp;
298             (addr[6] == 0x00) &amp;&amp; (addr[7] == 0x00) &amp;&amp;
299             (addr[8] == 0x00) &amp;&amp; (addr[9] == 0x00) &amp;&amp;
300             (addr[10] == (byte)0xff) &amp;&amp;
301             (addr[11] == (byte)0xff))  {
302             return true;
303         }
304         return false;
305     }
<span class="line-added">306     /**</span>
<span class="line-added">307      * Mapping from unscoped local Inet(6)Address to the same address</span>
<span class="line-added">308      * including the correct scope-id, determined from NetworkInterface.</span>
<span class="line-added">309      */</span>
<span class="line-added">310     private final static ConcurrentHashMap&lt;InetAddress,InetAddress&gt;</span>
<span class="line-added">311         cache = new ConcurrentHashMap&lt;&gt;();</span>
<span class="line-added">312 </span>
<span class="line-added">313     /**</span>
<span class="line-added">314      * Returns a scoped version of the supplied local, link-local ipv6 address</span>
<span class="line-added">315      * if that scope-id can be determined from local NetworkInterfaces.</span>
<span class="line-added">316      * If the address already has a scope-id or if the address is not local, ipv6</span>
<span class="line-added">317      * or link local, then the original address is returned.</span>
<span class="line-added">318      *</span>
<span class="line-added">319      * @param addr</span>
<span class="line-added">320      * @exception SocketException if the given ipv6 link local address is found</span>
<span class="line-added">321      *            on more than one local interface</span>
<span class="line-added">322      * @return</span>
<span class="line-added">323      */</span>
<span class="line-added">324     public static InetAddress toScopedAddress(InetAddress address)</span>
<span class="line-added">325         throws SocketException {</span>
<span class="line-added">326 </span>
<span class="line-added">327         if (address instanceof Inet6Address &amp;&amp; address.isLinkLocalAddress()</span>
<span class="line-added">328             &amp;&amp; ((Inet6Address) address).getScopeId() == 0) {</span>
<span class="line-added">329 </span>
<span class="line-added">330             InetAddress cached = null;</span>
<span class="line-added">331             try {</span>
<span class="line-added">332                 cached = cache.computeIfAbsent(address, k -&gt; findScopedAddress(k));</span>
<span class="line-added">333             } catch (UncheckedIOException e) {</span>
<span class="line-added">334                 throw (SocketException)e.getCause();</span>
<span class="line-added">335             }</span>
<span class="line-added">336             return cached != null ? cached : address;</span>
<span class="line-added">337         } else {</span>
<span class="line-added">338             return address;</span>
<span class="line-added">339         }</span>
<span class="line-added">340     }</span>
<span class="line-added">341 </span>
<span class="line-added">342     /**</span>
<span class="line-added">343      * Same as above for InetSocketAddress</span>
<span class="line-added">344      */</span>
<span class="line-added">345     public static InetSocketAddress toScopedAddress(InetSocketAddress address)</span>
<span class="line-added">346         throws SocketException {</span>
<span class="line-added">347         InetAddress addr;</span>
<span class="line-added">348         InetAddress orig = address.getAddress();</span>
<span class="line-added">349         if ((addr = toScopedAddress(orig)) == orig) {</span>
<span class="line-added">350             return address;</span>
<span class="line-added">351         } else {</span>
<span class="line-added">352             return new InetSocketAddress(addr, address.getPort());</span>
<span class="line-added">353         }</span>
<span class="line-added">354     }</span>
<span class="line-added">355 </span>
<span class="line-added">356     private static InetAddress findScopedAddress(InetAddress address) {</span>
<span class="line-added">357         PrivilegedExceptionAction&lt;List&lt;InetAddress&gt;&gt; pa = () -&gt; NetworkInterface.networkInterfaces()</span>
<span class="line-added">358                 .flatMap(NetworkInterface::inetAddresses)</span>
<span class="line-added">359                 .filter(a -&gt; (a instanceof Inet6Address)</span>
<span class="line-added">360                         &amp;&amp; address.equals(a)</span>
<span class="line-added">361                         &amp;&amp; ((Inet6Address) a).getScopeId() != 0)</span>
<span class="line-added">362                 .collect(Collectors.toList());</span>
<span class="line-added">363         List&lt;InetAddress&gt; result;</span>
<span class="line-added">364         try {</span>
<span class="line-added">365             result = AccessController.doPrivileged(pa);</span>
<span class="line-added">366             var sz = result.size();</span>
<span class="line-added">367             if (sz == 0)</span>
<span class="line-added">368                 return null;</span>
<span class="line-added">369             if (sz &gt; 1)</span>
<span class="line-added">370                 throw new UncheckedIOException(new SocketException(</span>
<span class="line-added">371                     &quot;Duplicate link local addresses: must specify scope-id&quot;));</span>
<span class="line-added">372             return result.get(0);</span>
<span class="line-added">373         } catch (PrivilegedActionException pae) {</span>
<span class="line-added">374             return null;</span>
<span class="line-added">375         }</span>
<span class="line-added">376     }</span>
<span class="line-added">377 </span>
<span class="line-added">378     // See java.net.URI for more details on how to generate these</span>
<span class="line-added">379     // masks.</span>
<span class="line-added">380     //</span>
<span class="line-added">381     // square brackets</span>
<span class="line-added">382     private static final long L_IPV6_DELIMS = 0x0L; // &quot;[]&quot;</span>
<span class="line-added">383     private static final long H_IPV6_DELIMS = 0x28000000L; // &quot;[]&quot;</span>
<span class="line-added">384     // RFC 3986 gen-delims</span>
<span class="line-added">385     private static final long L_GEN_DELIMS = 0x8400800800000000L; // &quot;:/?#[]@&quot;</span>
<span class="line-added">386     private static final long H_GEN_DELIMS = 0x28000001L; // &quot;:/?#[]@&quot;</span>
<span class="line-added">387     // These gen-delims can appear in authority</span>
<span class="line-added">388     private static final long L_AUTH_DELIMS = 0x400000000000000L; // &quot;@[]:&quot;</span>
<span class="line-added">389     private static final long H_AUTH_DELIMS = 0x28000001L; // &quot;@[]:&quot;</span>
<span class="line-added">390     // colon is allowed in userinfo</span>
<span class="line-added">391     private static final long L_COLON = 0x400000000000000L; // &quot;:&quot;</span>
<span class="line-added">392     private static final long H_COLON = 0x0L; // &quot;:&quot;</span>
<span class="line-added">393     // slash should be encoded in authority</span>
<span class="line-added">394     private static final long L_SLASH = 0x800000000000L; // &quot;/&quot;</span>
<span class="line-added">395     private static final long H_SLASH = 0x0L; // &quot;/&quot;</span>
<span class="line-added">396     // backslash should always be encoded</span>
<span class="line-added">397     private static final long L_BACKSLASH = 0x0L; // &quot;\&quot;</span>
<span class="line-added">398     private static final long H_BACKSLASH = 0x10000000L; // &quot;\&quot;</span>
<span class="line-added">399     // ASCII chars 0-31 + 127 - various controls + CRLF + TAB</span>
<span class="line-added">400     private static final long L_NON_PRINTABLE = 0xffffffffL;</span>
<span class="line-added">401     private static final long H_NON_PRINTABLE = 0x8000000000000000L;</span>
<span class="line-added">402     // All of the above</span>
<span class="line-added">403     private static final long L_EXCLUDE = 0x84008008ffffffffL;</span>
<span class="line-added">404     private static final long H_EXCLUDE = 0x8000000038000001L;</span>
<span class="line-added">405 </span>
<span class="line-added">406     private static final char[] OTHERS = {</span>
<span class="line-added">407             8263,8264,8265,8448,8449,8453,8454,10868,</span>
<span class="line-added">408             65109,65110,65119,65131,65283,65295,65306,65311,65312</span>
<span class="line-added">409     };</span>
<span class="line-added">410 </span>
<span class="line-added">411     // Tell whether the given character is found by the given mask pair</span>
<span class="line-added">412     public static boolean match(char c, long lowMask, long highMask) {</span>
<span class="line-added">413         if (c &lt; 64)</span>
<span class="line-added">414             return ((1L &lt;&lt; c) &amp; lowMask) != 0;</span>
<span class="line-added">415         if (c &lt; 128)</span>
<span class="line-added">416             return ((1L &lt;&lt; (c - 64)) &amp; highMask) != 0;</span>
<span class="line-added">417         return false; // other non ASCII characters are not filtered</span>
<span class="line-added">418     }</span>
<span class="line-added">419 </span>
<span class="line-added">420     // returns -1 if the string doesn&#39;t contain any characters</span>
<span class="line-added">421     // from the mask, the index of the first such character found</span>
<span class="line-added">422     // otherwise.</span>
<span class="line-added">423     public static int scan(String s, long lowMask, long highMask) {</span>
<span class="line-added">424         int i = -1, len;</span>
<span class="line-added">425         if (s == null || (len = s.length()) == 0) return -1;</span>
<span class="line-added">426         boolean match = false;</span>
<span class="line-added">427         while (++i &lt; len &amp;&amp; !(match = match(s.charAt(i), lowMask, highMask)));</span>
<span class="line-added">428         if (match) return i;</span>
<span class="line-added">429         return -1;</span>
<span class="line-added">430     }</span>
<span class="line-added">431 </span>
<span class="line-added">432     public static int scan(String s, long lowMask, long highMask, char[] others) {</span>
<span class="line-added">433         int i = -1, len;</span>
<span class="line-added">434         if (s == null || (len = s.length()) == 0) return -1;</span>
<span class="line-added">435         boolean match = false;</span>
<span class="line-added">436         char c, c0 = others[0];</span>
<span class="line-added">437         while (++i &lt; len &amp;&amp; !(match = match((c=s.charAt(i)), lowMask, highMask))) {</span>
<span class="line-added">438             if (c &gt;= c0 &amp;&amp; (Arrays.binarySearch(others, c) &gt; -1)) {</span>
<span class="line-added">439                 match = true; break;</span>
<span class="line-added">440             }</span>
<span class="line-added">441         }</span>
<span class="line-added">442         if (match) return i;</span>
<span class="line-added">443 </span>
<span class="line-added">444         return -1;</span>
<span class="line-added">445     }</span>
<span class="line-added">446 </span>
<span class="line-added">447     private static String describeChar(char c) {</span>
<span class="line-added">448         if (c &lt; 32 || c == 127) {</span>
<span class="line-added">449             if (c == &#39;\n&#39;) return &quot;LF&quot;;</span>
<span class="line-added">450             if (c == &#39;\r&#39;) return &quot;CR&quot;;</span>
<span class="line-added">451             return &quot;control char (code=&quot; + (int)c + &quot;)&quot;;</span>
<span class="line-added">452         }</span>
<span class="line-added">453         if (c == &#39;\\&#39;) return &quot;&#39;\\&#39;&quot;;</span>
<span class="line-added">454         return &quot;&#39;&quot; + c + &quot;&#39;&quot;;</span>
<span class="line-added">455     }</span>
<span class="line-added">456 </span>
<span class="line-added">457     private static String checkUserInfo(String str) {</span>
<span class="line-added">458         // colon is permitted in user info</span>
<span class="line-added">459         int index = scan(str, L_EXCLUDE &amp; ~L_COLON,</span>
<span class="line-added">460                 H_EXCLUDE &amp; ~H_COLON);</span>
<span class="line-added">461         if (index &gt;= 0) {</span>
<span class="line-added">462             return &quot;Illegal character found in user-info: &quot;</span>
<span class="line-added">463                     + describeChar(str.charAt(index));</span>
<span class="line-added">464         }</span>
<span class="line-added">465         return null;</span>
<span class="line-added">466     }</span>
<span class="line-added">467 </span>
<span class="line-added">468     private static String checkHost(String str) {</span>
<span class="line-added">469         int index;</span>
<span class="line-added">470         if (str.startsWith(&quot;[&quot;) &amp;&amp; str.endsWith(&quot;]&quot;)) {</span>
<span class="line-added">471             str = str.substring(1, str.length() - 1);</span>
<span class="line-added">472             if (isIPv6LiteralAddress(str)) {</span>
<span class="line-added">473                 index = str.indexOf(&#39;%&#39;);</span>
<span class="line-added">474                 if (index &gt;= 0) {</span>
<span class="line-added">475                     index = scan(str = str.substring(index),</span>
<span class="line-added">476                             L_NON_PRINTABLE | L_IPV6_DELIMS,</span>
<span class="line-added">477                             H_NON_PRINTABLE | H_IPV6_DELIMS);</span>
<span class="line-added">478                     if (index &gt;= 0) {</span>
<span class="line-added">479                         return &quot;Illegal character found in IPv6 scoped address: &quot;</span>
<span class="line-added">480                                 + describeChar(str.charAt(index));</span>
<span class="line-added">481                     }</span>
<span class="line-added">482                 }</span>
<span class="line-added">483                 return null;</span>
<span class="line-added">484             }</span>
<span class="line-added">485             return &quot;Unrecognized IPv6 address format&quot;;</span>
<span class="line-added">486         } else {</span>
<span class="line-added">487             index = scan(str, L_EXCLUDE, H_EXCLUDE);</span>
<span class="line-added">488             if (index &gt;= 0) {</span>
<span class="line-added">489                 return &quot;Illegal character found in host: &quot;</span>
<span class="line-added">490                         + describeChar(str.charAt(index));</span>
<span class="line-added">491             }</span>
<span class="line-added">492         }</span>
<span class="line-added">493         return null;</span>
<span class="line-added">494     }</span>
<span class="line-added">495 </span>
<span class="line-added">496     private static String checkAuth(String str) {</span>
<span class="line-added">497         int index = scan(str,</span>
<span class="line-added">498                 L_EXCLUDE &amp; ~L_AUTH_DELIMS,</span>
<span class="line-added">499                 H_EXCLUDE &amp; ~H_AUTH_DELIMS);</span>
<span class="line-added">500         if (index &gt;= 0) {</span>
<span class="line-added">501             return &quot;Illegal character found in authority: &quot;</span>
<span class="line-added">502                     + describeChar(str.charAt(index));</span>
<span class="line-added">503         }</span>
<span class="line-added">504         return null;</span>
<span class="line-added">505     }</span>
<span class="line-added">506 </span>
<span class="line-added">507     // check authority of hierarchical URL. Appropriate for</span>
<span class="line-added">508     // HTTP-like protocol handlers</span>
<span class="line-added">509     public static String checkAuthority(URL url) {</span>
<span class="line-added">510         String s, u, h;</span>
<span class="line-added">511         if (url == null) return null;</span>
<span class="line-added">512         if ((s = checkUserInfo(u = url.getUserInfo())) != null) {</span>
<span class="line-added">513             return s;</span>
<span class="line-added">514         }</span>
<span class="line-added">515         if ((s = checkHost(h = url.getHost())) != null) {</span>
<span class="line-added">516             return s;</span>
<span class="line-added">517         }</span>
<span class="line-added">518         if (h == null &amp;&amp; u == null) {</span>
<span class="line-added">519             return checkAuth(url.getAuthority());</span>
<span class="line-added">520         }</span>
<span class="line-added">521         return null;</span>
<span class="line-added">522     }</span>
<span class="line-added">523 </span>
<span class="line-added">524     // minimal syntax checks - deeper check may be performed</span>
<span class="line-added">525     // by the appropriate protocol handler</span>
<span class="line-added">526     public static String checkExternalForm(URL url) {</span>
<span class="line-added">527         String s;</span>
<span class="line-added">528         if (url == null) return null;</span>
<span class="line-added">529         int index = scan(s = url.getUserInfo(),</span>
<span class="line-added">530                 L_NON_PRINTABLE | L_SLASH,</span>
<span class="line-added">531                 H_NON_PRINTABLE | H_SLASH);</span>
<span class="line-added">532         if (index &gt;= 0) {</span>
<span class="line-added">533             return &quot;Illegal character found in authority: &quot;</span>
<span class="line-added">534                     + describeChar(s.charAt(index));</span>
<span class="line-added">535         }</span>
<span class="line-added">536         if ((s = checkHostString(url.getHost())) != null) {</span>
<span class="line-added">537             return s;</span>
<span class="line-added">538         }</span>
<span class="line-added">539         return null;</span>
<span class="line-added">540     }</span>
<span class="line-added">541 </span>
<span class="line-added">542     public static String checkHostString(String host) {</span>
<span class="line-added">543         if (host == null) return null;</span>
<span class="line-added">544         int index = scan(host,</span>
<span class="line-added">545                 L_NON_PRINTABLE | L_SLASH,</span>
<span class="line-added">546                 H_NON_PRINTABLE | H_SLASH,</span>
<span class="line-added">547                 OTHERS);</span>
<span class="line-added">548         if (index &gt;= 0) {</span>
<span class="line-added">549             return &quot;Illegal character found in host: &quot;</span>
<span class="line-added">550                     + describeChar(host.charAt(index));</span>
<span class="line-added">551         }</span>
<span class="line-added">552         return null;</span>
<span class="line-added">553     }</span>
554 }
</pre>
</td>
</tr>
</table>
<center><a href="../spi/DefaultProxySelector.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../www/ApplicationLaunchException.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>