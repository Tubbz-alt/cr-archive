<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/util/DerInputStream.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="DerIndefLenConverter.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DerOutputStream.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/DerInputStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1996, 2017, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1996, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 25,15 ***</span>
  
  package sun.security.util;
  
  import java.io.InputStream;
  import java.io.IOException;
<span class="line-modified">! import java.io.EOFException;</span>
  import java.util.Date;
  import java.util.Vector;
<span class="line-modified">! import java.math.BigInteger;</span>
<span class="line-modified">! import java.io.DataInputStream;</span>
  
  /**
   * A DER input stream, used for parsing ASN.1 DER-encoded data such as
   * that found in X.509 certificates.  DER is a subset of BER/1, which has
   * the advantage that it allows only a single encoding of primitive data.
<span class="line-new-header">--- 25,16 ---</span>
  
  package sun.security.util;
  
  import java.io.InputStream;
  import java.io.IOException;
<span class="line-modified">! import java.math.BigInteger;</span>
<span class="line-added">+ import java.nio.charset.Charset;</span>
  import java.util.Date;
  import java.util.Vector;
<span class="line-modified">! </span>
<span class="line-modified">! import static java.nio.charset.StandardCharsets.*;</span>
  
  /**
   * A DER input stream, used for parsing ASN.1 DER-encoded data such as
   * that found in X.509 certificates.  DER is a subset of BER/1, which has
   * the advantage that it allows only a single encoding of primitive data.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 128,11 ***</span>
              } else {
                  byte[] inData = new byte[len];
                  System.arraycopy(data, offset, inData, 0, len);
  
                  DerIndefLenConverter derIn = new DerIndefLenConverter();
<span class="line-modified">!                 buffer = new DerInputBuffer(derIn.convert(inData), allowBER);</span>
              }
          } else {
              buffer = new DerInputBuffer(data, offset, len, allowBER);
          }
          buffer.mark(Integer.MAX_VALUE);
<span class="line-new-header">--- 129,16 ---</span>
              } else {
                  byte[] inData = new byte[len];
                  System.arraycopy(data, offset, inData, 0, len);
  
                  DerIndefLenConverter derIn = new DerIndefLenConverter();
<span class="line-modified">!                 byte[] result = derIn.convertBytes(inData);</span>
<span class="line-added">+                 if (result == null) {</span>
<span class="line-added">+                     throw new IOException(&quot;not all indef len BER resolved&quot;);</span>
<span class="line-added">+                 } else {</span>
<span class="line-added">+                     buffer = new DerInputBuffer(result, allowBER);</span>
<span class="line-added">+                 }</span>
              }
          } else {
              buffer = new DerInputBuffer(data, offset, len, allowBER);
          }
          buffer.mark(Integer.MAX_VALUE);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 387,20 ***</span>
          byte lenByte = (byte)buffer.read();
          int len = getLength(lenByte, buffer);
  
          if (len == -1) {
             // indefinite length encoding found
<span class="line-modified">!            int readLen = buffer.available();</span>
<span class="line-modified">!            int offset = 2;     // for tag and length bytes</span>
<span class="line-modified">!            byte[] indefData = new byte[readLen + offset];</span>
<span class="line-removed">-            indefData[0] = tag;</span>
<span class="line-removed">-            indefData[1] = lenByte;</span>
<span class="line-removed">-            DataInputStream dis = new DataInputStream(buffer);</span>
<span class="line-removed">-            dis.readFully(indefData, offset, readLen);</span>
<span class="line-removed">-            dis.close();</span>
<span class="line-removed">-            DerIndefLenConverter derIn = new DerIndefLenConverter();</span>
<span class="line-removed">-            buffer = new DerInputBuffer(derIn.convert(indefData), buffer.allowBER);</span>
  
             if (tag != buffer.read())
                  throw new IOException(&quot;Indefinite length encoding&quot; +
                          &quot; not supported&quot;);
             len = DerInputStream.getDefiniteLength(buffer);
<span class="line-new-header">--- 393,13 ---</span>
          byte lenByte = (byte)buffer.read();
          int len = getLength(lenByte, buffer);
  
          if (len == -1) {
             // indefinite length encoding found
<span class="line-modified">!            buffer = new DerInputBuffer(</span>
<span class="line-modified">!                    DerIndefLenConverter.convertStream(buffer, lenByte, tag),</span>
<span class="line-modified">!                    buffer.allowBER);</span>
  
             if (tag != buffer.read())
                  throw new IOException(&quot;Indefinite length encoding&quot; +
                          &quot; not supported&quot;);
             len = DerInputStream.getDefiniteLength(buffer);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 459,52 ***</span>
  
      /**
       * Read a string that was encoded as a UTF8String DER value.
       */
      public String getUTF8String() throws IOException {
<span class="line-modified">!         return readString(DerValue.tag_UTF8String, &quot;UTF-8&quot;, &quot;UTF8&quot;);</span>
      }
  
      /**
       * Read a string that was encoded as a PrintableString DER value.
       */
      public String getPrintableString() throws IOException {
          return readString(DerValue.tag_PrintableString, &quot;Printable&quot;,
<span class="line-modified">!                           &quot;ASCII&quot;);</span>
      }
  
      /**
       * Read a string that was encoded as a T61String DER value.
       */
      public String getT61String() throws IOException {
          /*
           * Works for common characters between T61 and ASCII.
           */
<span class="line-modified">!         return readString(DerValue.tag_T61String, &quot;T61&quot;, &quot;ISO-8859-1&quot;);</span>
      }
  
      /**
<span class="line-modified">!      * Read a string that was encoded as a IA5tring DER value.</span>
       */
      public String getIA5String() throws IOException {
<span class="line-modified">!         return readString(DerValue.tag_IA5String, &quot;IA5&quot;, &quot;ASCII&quot;);</span>
      }
  
      /**
       * Read a string that was encoded as a BMPString DER value.
       */
      public String getBMPString() throws IOException {
<span class="line-modified">!         return readString(DerValue.tag_BMPString, &quot;BMP&quot;,</span>
<span class="line-removed">-                           &quot;UnicodeBigUnmarked&quot;);</span>
      }
  
      /**
       * Read a string that was encoded as a GeneralString DER value.
       */
      public String getGeneralString() throws IOException {
          return readString(DerValue.tag_GeneralString, &quot;General&quot;,
<span class="line-modified">!                           &quot;ASCII&quot;);</span>
      }
  
      /**
       * Private helper routine to read an encoded string from the input
       * stream.
<span class="line-new-header">--- 458,51 ---</span>
  
      /**
       * Read a string that was encoded as a UTF8String DER value.
       */
      public String getUTF8String() throws IOException {
<span class="line-modified">!         return readString(DerValue.tag_UTF8String, &quot;UTF-8&quot;, UTF_8);</span>
      }
  
      /**
       * Read a string that was encoded as a PrintableString DER value.
       */
      public String getPrintableString() throws IOException {
          return readString(DerValue.tag_PrintableString, &quot;Printable&quot;,
<span class="line-modified">!                           US_ASCII);</span>
      }
  
      /**
       * Read a string that was encoded as a T61String DER value.
       */
      public String getT61String() throws IOException {
          /*
           * Works for common characters between T61 and ASCII.
           */
<span class="line-modified">!         return readString(DerValue.tag_T61String, &quot;T61&quot;, ISO_8859_1);</span>
      }
  
      /**
<span class="line-modified">!      * Read a string that was encoded as a IA5String DER value.</span>
       */
      public String getIA5String() throws IOException {
<span class="line-modified">!         return readString(DerValue.tag_IA5String, &quot;IA5&quot;, US_ASCII);</span>
      }
  
      /**
       * Read a string that was encoded as a BMPString DER value.
       */
      public String getBMPString() throws IOException {
<span class="line-modified">!         return readString(DerValue.tag_BMPString, &quot;BMP&quot;, UTF_16BE);</span>
      }
  
      /**
       * Read a string that was encoded as a GeneralString DER value.
       */
      public String getGeneralString() throws IOException {
          return readString(DerValue.tag_GeneralString, &quot;General&quot;,
<span class="line-modified">!                           US_ASCII);</span>
      }
  
      /**
       * Private helper routine to read an encoded string from the input
       * stream.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 512,11 ***</span>
       * @param stringName a name to display in error messages
       * @param enc the encoder to use to interpret the data. Should
       * correspond to the stringTag above.
       */
      private String readString(byte stringTag, String stringName,
<span class="line-modified">!                               String enc) throws IOException {</span>
  
          if (buffer.read() != stringTag)
              throw new IOException(&quot;DER input not a &quot; +
                                    stringName + &quot; string&quot;);
  
<span class="line-new-header">--- 510,11 ---</span>
       * @param stringName a name to display in error messages
       * @param enc the encoder to use to interpret the data. Should
       * correspond to the stringTag above.
       */
      private String readString(byte stringTag, String stringName,
<span class="line-modified">!                               Charset charset) throws IOException {</span>
  
          if (buffer.read() != stringTag)
              throw new IOException(&quot;DER input not a &quot; +
                                    stringName + &quot; string&quot;);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 524,11 ***</span>
          byte[] retval = new byte[length];
          if ((length != 0) &amp;&amp; (buffer.read(retval) != length))
              throw new IOException(&quot;Short read of DER &quot; +
                                    stringName + &quot; string&quot;);
  
<span class="line-modified">!         return new String(retval, enc);</span>
      }
  
      /**
       * Get a UTC encoded time value from the input stream.
       */
<span class="line-new-header">--- 522,11 ---</span>
          byte[] retval = new byte[length];
          if ((length != 0) &amp;&amp; (buffer.read(retval) != length))
              throw new IOException(&quot;Short read of DER &quot; +
                                    stringName + &quot; string&quot;);
  
<span class="line-modified">!         return new String(retval, charset);</span>
      }
  
      /**
       * Get a UTC encoded time value from the input stream.
       */
</pre>
<center><a href="DerIndefLenConverter.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DerOutputStream.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>