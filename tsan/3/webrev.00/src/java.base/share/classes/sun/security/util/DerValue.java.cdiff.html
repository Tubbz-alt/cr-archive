<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/util/DerValue.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="DerOutputStream.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DisabledAlgorithmConstraints.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/DerValue.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /**
<span class="line-modified">!  * Copyright (c) 1996, 2017, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /**
<span class="line-modified">!  * Copyright (c) 1996, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 25,12 ***</span>
<span class="line-new-header">--- 25,15 ---</span>
  
  package sun.security.util;
  
  import java.io.*;
  import java.math.BigInteger;
<span class="line-added">+ import java.nio.charset.Charset;</span>
  import java.util.Date;
  
<span class="line-added">+ import static java.nio.charset.StandardCharsets.*;</span>
<span class="line-added">+ </span>
  /**
   * Represents a single DER-encoded value.  DER encoding rules are a subset
   * of the &quot;Basic&quot; Encoding Rules (BER), but they only support a single way
   * (&quot;Definite&quot; encoding) to encode any given value.
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 202,11 ***</span>
      }
  
      /**
       * Creates a PrintableString or UTF8string DER value from a string
       */
<span class="line-modified">!     public DerValue(String value) throws IOException {</span>
          boolean isPrintableString = true;
          for (int i = 0; i &lt; value.length(); i++) {
              if (!isPrintableStringChar(value.charAt(i))) {
                  isPrintableString = false;
                  break;
<span class="line-new-header">--- 205,11 ---</span>
      }
  
      /**
       * Creates a PrintableString or UTF8string DER value from a string
       */
<span class="line-modified">!     public DerValue(String value) {</span>
          boolean isPrintableString = true;
          for (int i = 0; i &lt; value.length(); i++) {
              if (!isPrintableStringChar(value.charAt(i))) {
                  isPrintableString = false;
                  break;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 219,11 ***</span>
      /**
       * Creates a string type DER value from a String object
       * @param stringTag the tag for the DER value to create
       * @param value the String object to use for the DER value
       */
<span class="line-modified">!     public DerValue(byte stringTag, String value) throws IOException {</span>
          data = init(stringTag, value);
      }
  
      // Creates a DerValue from a tag and some DER-encoded data w/ additional
      // arg to control whether DER checks are enforced.
<span class="line-new-header">--- 222,11 ---</span>
      /**
       * Creates a string type DER value from a String object
       * @param stringTag the tag for the DER value to create
       * @param value the String object to use for the DER value
       */
<span class="line-modified">!     public DerValue(byte stringTag, String value) {</span>
          data = init(stringTag, value);
      }
  
      // Creates a DerValue from a tag and some DER-encoded data w/ additional
      // arg to control whether DER checks are enforced.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 255,31 ***</span>
          tag = (byte)in.read();
          byte lenByte = (byte)in.read();
          length = DerInputStream.getLength(lenByte, in);
          if (length == -1) {  // indefinite length encoding found
              DerInputBuffer inbuf = in.dup();
<span class="line-modified">!             int readLen = inbuf.available();</span>
<span class="line-modified">!             int offset = 2;     // for tag and length bytes</span>
<span class="line-modified">!             byte[] indefData = new byte[readLen + offset];</span>
<span class="line-removed">-             indefData[0] = tag;</span>
<span class="line-removed">-             indefData[1] = lenByte;</span>
<span class="line-removed">-             DataInputStream dis = new DataInputStream(inbuf);</span>
<span class="line-removed">-             dis.readFully(indefData, offset, readLen);</span>
<span class="line-removed">-             dis.close();</span>
<span class="line-removed">-             DerIndefLenConverter derIn = new DerIndefLenConverter();</span>
<span class="line-removed">-             inbuf = new DerInputBuffer(derIn.convert(indefData), in.allowBER);</span>
              if (tag != inbuf.read())
                  throw new IOException
                          (&quot;Indefinite length encoding not supported&quot;);
              length = DerInputStream.getDefiniteLength(inbuf);
              buffer = inbuf.dup();
              buffer.truncate(length);
              data = new DerInputStream(buffer);
              // indefinite form is encoded by sending a length field with a
              // length of 0. - i.e. [1000|0000].
              // the object is ended by sending two zero bytes.
<span class="line-modified">!             in.skip(length + offset);</span>
          } else {
  
              buffer = in.dup();
              buffer.truncate(length);
              data = new DerInputStream(buffer);
<span class="line-new-header">--- 258,24 ---</span>
          tag = (byte)in.read();
          byte lenByte = (byte)in.read();
          length = DerInputStream.getLength(lenByte, in);
          if (length == -1) {  // indefinite length encoding found
              DerInputBuffer inbuf = in.dup();
<span class="line-modified">!             inbuf = new DerInputBuffer(</span>
<span class="line-modified">!                     DerIndefLenConverter.convertStream(inbuf, lenByte, tag),</span>
<span class="line-modified">!                     in.allowBER);</span>
              if (tag != inbuf.read())
                  throw new IOException
                          (&quot;Indefinite length encoding not supported&quot;);
              length = DerInputStream.getDefiniteLength(inbuf);
              buffer = inbuf.dup();
              buffer.truncate(length);
              data = new DerInputStream(buffer);
              // indefinite form is encoded by sending a length field with a
              // length of 0. - i.e. [1000|0000].
              // the object is ended by sending two zero bytes.
<span class="line-modified">!             in.skip(length + 2);</span>
          } else {
  
              buffer = in.dup();
              buffer.truncate(length);
              data = new DerInputStream(buffer);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 342,38 ***</span>
       */
      public DerValue(InputStream in) throws IOException {
          this(in, true);
      }
  
<span class="line-modified">!     private DerInputStream init(byte stringTag, String value)</span>
<span class="line-modified">!         throws IOException {</span>
<span class="line-removed">-         String enc = null;</span>
  
          tag = stringTag;
  
          switch (stringTag) {
          case tag_PrintableString:
          case tag_IA5String:
          case tag_GeneralString:
<span class="line-modified">!             enc = &quot;ASCII&quot;;</span>
              break;
          case tag_T61String:
<span class="line-modified">!             enc = &quot;ISO-8859-1&quot;;</span>
              break;
          case tag_BMPString:
<span class="line-modified">!             enc = &quot;UnicodeBigUnmarked&quot;;</span>
              break;
          case tag_UTF8String:
<span class="line-modified">!             enc = &quot;UTF8&quot;;</span>
              break;
              // TBD: Need encoder for UniversalString before it can
              // be handled.
          default:
              throw new IllegalArgumentException(&quot;Unsupported DER string type&quot;);
          }
  
<span class="line-modified">!         byte[] buf = value.getBytes(enc);</span>
          length = buf.length;
          buffer = new DerInputBuffer(buf, true);
          DerInputStream result = new DerInputStream(buffer);
          result.mark(Integer.MAX_VALUE);
          return result;
<span class="line-new-header">--- 338,37 ---</span>
       */
      public DerValue(InputStream in) throws IOException {
          this(in, true);
      }
  
<span class="line-modified">!     private DerInputStream init(byte stringTag, String value) {</span>
<span class="line-modified">!         final Charset charset;</span>
  
          tag = stringTag;
  
          switch (stringTag) {
          case tag_PrintableString:
          case tag_IA5String:
          case tag_GeneralString:
<span class="line-modified">!             charset = US_ASCII;</span>
              break;
          case tag_T61String:
<span class="line-modified">!             charset = ISO_8859_1;</span>
              break;
          case tag_BMPString:
<span class="line-modified">!             charset = UTF_16BE;</span>
              break;
          case tag_UTF8String:
<span class="line-modified">!             charset = UTF_8;</span>
              break;
              // TBD: Need encoder for UniversalString before it can
              // be handled.
          default:
              throw new IllegalArgumentException(&quot;Unsupported DER string type&quot;);
          }
  
<span class="line-modified">!         byte[] buf = value.getBytes(charset);</span>
          length = buf.length;
          buffer = new DerInputBuffer(buf, true);
          DerInputStream result = new DerInputStream(buffer);
          result.mark(Integer.MAX_VALUE);
          return result;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 387,30 ***</span>
  
          tag = (byte)in.read();
          byte lenByte = (byte)in.read();
          length = DerInputStream.getLength(lenByte, in);
          if (length == -1) { // indefinite length encoding found
<span class="line-modified">!             int readLen = in.available();</span>
<span class="line-modified">!             int offset = 2;     // for tag and length bytes</span>
<span class="line-removed">-             byte[] indefData = new byte[readLen + offset];</span>
<span class="line-removed">-             indefData[0] = tag;</span>
<span class="line-removed">-             indefData[1] = lenByte;</span>
<span class="line-removed">-             DataInputStream dis = new DataInputStream(in);</span>
<span class="line-removed">-             dis.readFully(indefData, offset, readLen);</span>
<span class="line-removed">-             dis.close();</span>
<span class="line-removed">-             DerIndefLenConverter derIn = new DerIndefLenConverter();</span>
<span class="line-removed">-             in = new ByteArrayInputStream(derIn.convert(indefData));</span>
              if (tag != in.read())
                  throw new IOException
                          (&quot;Indefinite length encoding not supported&quot;);
              length = DerInputStream.getDefiniteLength(in);
          }
  
          if (fullyBuffered &amp;&amp; in.available() != length)
              throw new IOException(&quot;extra data given to DerValue constructor&quot;);
  
<span class="line-modified">!         byte[] bytes = IOUtils.readFully(in, length, true);</span>
  
          buffer = new DerInputBuffer(bytes, allowBER);
          return new DerInputStream(buffer);
      }
  
<span class="line-new-header">--- 382,22 ---</span>
  
          tag = (byte)in.read();
          byte lenByte = (byte)in.read();
          length = DerInputStream.getLength(lenByte, in);
          if (length == -1) { // indefinite length encoding found
<span class="line-modified">!             in = new ByteArrayInputStream(</span>
<span class="line-modified">!                     DerIndefLenConverter.convertStream(in, lenByte, tag));</span>
              if (tag != in.read())
                  throw new IOException
                          (&quot;Indefinite length encoding not supported&quot;);
              length = DerInputStream.getDefiniteLength(in);
          }
  
          if (fullyBuffered &amp;&amp; in.available() != length)
              throw new IOException(&quot;extra data given to DerValue constructor&quot;);
  
<span class="line-modified">!         byte[] bytes = IOUtils.readExactlyNBytes(in, length);</span>
  
          buffer = new DerInputBuffer(bytes, allowBER);
          return new DerInputStream(buffer);
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 678,11 ***</span>
      throws IOException {
          if (tag != tag_PrintableString)
              throw new IOException(
                  &quot;DerValue.getPrintableString, not a string &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), &quot;ASCII&quot;);</span>
      }
  
      /**
       * Returns an ASN.1 T61 (Teletype) STRING value
       *
<span class="line-new-header">--- 665,11 ---</span>
      throws IOException {
          if (tag != tag_PrintableString)
              throw new IOException(
                  &quot;DerValue.getPrintableString, not a string &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), US_ASCII);</span>
      }
  
      /**
       * Returns an ASN.1 T61 (Teletype) STRING value
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 691,11 ***</span>
      public String getT61String() throws IOException {
          if (tag != tag_T61String)
              throw new IOException(
                  &quot;DerValue.getT61String, not T61 &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), &quot;ISO-8859-1&quot;);</span>
      }
  
      /**
       * Returns an ASN.1 IA5 (ASCII) STRING value
       *
<span class="line-new-header">--- 678,11 ---</span>
      public String getT61String() throws IOException {
          if (tag != tag_T61String)
              throw new IOException(
                  &quot;DerValue.getT61String, not T61 &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), ISO_8859_1);</span>
      }
  
      /**
       * Returns an ASN.1 IA5 (ASCII) STRING value
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 704,11 ***</span>
      public String getIA5String() throws IOException {
          if (tag != tag_IA5String)
              throw new IOException(
                  &quot;DerValue.getIA5String, not IA5 &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), &quot;ASCII&quot;);</span>
      }
  
      /**
       * Returns the ASN.1 BMP (Unicode) STRING value as a Java string.
       *
<span class="line-new-header">--- 691,11 ---</span>
      public String getIA5String() throws IOException {
          if (tag != tag_IA5String)
              throw new IOException(
                  &quot;DerValue.getIA5String, not IA5 &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), US_ASCII);</span>
      }
  
      /**
       * Returns the ASN.1 BMP (Unicode) STRING value as a Java string.
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 720,11 ***</span>
              throw new IOException(
                  &quot;DerValue.getBMPString, not BMP &quot; + tag);
  
          // BMPString is the same as Unicode in big endian, unmarked
          // format.
<span class="line-modified">!         return new String(getDataBytes(), &quot;UnicodeBigUnmarked&quot;);</span>
      }
  
      /**
       * Returns the ASN.1 UTF-8 STRING value as a Java String.
       *
<span class="line-new-header">--- 707,11 ---</span>
              throw new IOException(
                  &quot;DerValue.getBMPString, not BMP &quot; + tag);
  
          // BMPString is the same as Unicode in big endian, unmarked
          // format.
<span class="line-modified">!         return new String(getDataBytes(), UTF_16BE);</span>
      }
  
      /**
       * Returns the ASN.1 UTF-8 STRING value as a Java String.
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 734,11 ***</span>
      public String getUTF8String() throws IOException {
          if (tag != tag_UTF8String)
              throw new IOException(
                  &quot;DerValue.getUTF8String, not UTF-8 &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), &quot;UTF8&quot;);</span>
      }
  
      /**
       * Returns the ASN.1 GENERAL STRING value as a Java String.
       *
<span class="line-new-header">--- 721,11 ---</span>
      public String getUTF8String() throws IOException {
          if (tag != tag_UTF8String)
              throw new IOException(
                  &quot;DerValue.getUTF8String, not UTF-8 &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), UTF_8);</span>
      }
  
      /**
       * Returns the ASN.1 GENERAL STRING value as a Java String.
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 748,11 ***</span>
      public String getGeneralString() throws IOException {
          if (tag != tag_GeneralString)
              throw new IOException(
                  &quot;DerValue.getGeneralString, not GeneralString &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), &quot;ASCII&quot;);</span>
      }
  
      /**
       * Returns a Date if the DerValue is UtcTime.
       *
<span class="line-new-header">--- 735,11 ---</span>
      public String getGeneralString() throws IOException {
          if (tag != tag_GeneralString)
              throw new IOException(
                  &quot;DerValue.getGeneralString, not GeneralString &quot; + tag);
  
<span class="line-modified">!         return new String(getDataBytes(), US_ASCII);</span>
      }
  
      /**
       * Returns a Date if the DerValue is UtcTime.
       *
</pre>
<center><a href="DerOutputStream.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DisabledAlgorithmConstraints.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>