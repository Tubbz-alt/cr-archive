<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/net/util/IPAddressUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../spi/DefaultProxySelector.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../www/ApplicationLaunchException.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/net/util/IPAddressUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 23,10 ***</span>
<span class="line-new-header">--- 23,26 ---</span>
   * questions.
   */
  
  package sun.net.util;
  
<span class="line-added">+ import java.io.IOException;</span>
<span class="line-added">+ import java.io.UncheckedIOException;</span>
<span class="line-added">+ import java.net.Inet6Address;</span>
<span class="line-added">+ import java.net.InetAddress;</span>
<span class="line-added">+ import java.net.InetSocketAddress;</span>
<span class="line-added">+ import java.net.NetworkInterface;</span>
<span class="line-added">+ import java.net.SocketException;</span>
<span class="line-added">+ import java.net.URL;</span>
<span class="line-added">+ import java.security.AccessController;</span>
<span class="line-added">+ import java.security.PrivilegedExceptionAction;</span>
<span class="line-added">+ import java.security.PrivilegedActionException;</span>
<span class="line-added">+ import java.util.Arrays;</span>
<span class="line-added">+ import java.util.List;</span>
<span class="line-added">+ import java.util.concurrent.ConcurrentHashMap;</span>
<span class="line-added">+ import java.util.stream.Collectors;</span>
<span class="line-added">+ </span>
  public class IPAddressUtil {
      private static final int INADDR4SZ = 4;
      private static final int INADDR16SZ = 16;
      private static final int INT16SZ = 2;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 285,6 ***</span>
<span class="line-new-header">--- 301,254 ---</span>
              (addr[11] == (byte)0xff))  {
              return true;
          }
          return false;
      }
<span class="line-added">+     /**</span>
<span class="line-added">+      * Mapping from unscoped local Inet(6)Address to the same address</span>
<span class="line-added">+      * including the correct scope-id, determined from NetworkInterface.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     private final static ConcurrentHashMap&lt;InetAddress,InetAddress&gt;</span>
<span class="line-added">+         cache = new ConcurrentHashMap&lt;&gt;();</span>
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * Returns a scoped version of the supplied local, link-local ipv6 address</span>
<span class="line-added">+      * if that scope-id can be determined from local NetworkInterfaces.</span>
<span class="line-added">+      * If the address already has a scope-id or if the address is not local, ipv6</span>
<span class="line-added">+      * or link local, then the original address is returned.</span>
<span class="line-added">+      *</span>
<span class="line-added">+      * @param addr</span>
<span class="line-added">+      * @exception SocketException if the given ipv6 link local address is found</span>
<span class="line-added">+      *            on more than one local interface</span>
<span class="line-added">+      * @return</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public static InetAddress toScopedAddress(InetAddress address)</span>
<span class="line-added">+         throws SocketException {</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (address instanceof Inet6Address &amp;&amp; address.isLinkLocalAddress()</span>
<span class="line-added">+             &amp;&amp; ((Inet6Address) address).getScopeId() == 0) {</span>
<span class="line-added">+ </span>
<span class="line-added">+             InetAddress cached = null;</span>
<span class="line-added">+             try {</span>
<span class="line-added">+                 cached = cache.computeIfAbsent(address, k -&gt; findScopedAddress(k));</span>
<span class="line-added">+             } catch (UncheckedIOException e) {</span>
<span class="line-added">+                 throw (SocketException)e.getCause();</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return cached != null ? cached : address;</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             return address;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * Same as above for InetSocketAddress</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public static InetSocketAddress toScopedAddress(InetSocketAddress address)</span>
<span class="line-added">+         throws SocketException {</span>
<span class="line-added">+         InetAddress addr;</span>
<span class="line-added">+         InetAddress orig = address.getAddress();</span>
<span class="line-added">+         if ((addr = toScopedAddress(orig)) == orig) {</span>
<span class="line-added">+             return address;</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             return new InetSocketAddress(addr, address.getPort());</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static InetAddress findScopedAddress(InetAddress address) {</span>
<span class="line-added">+         PrivilegedExceptionAction&lt;List&lt;InetAddress&gt;&gt; pa = () -&gt; NetworkInterface.networkInterfaces()</span>
<span class="line-added">+                 .flatMap(NetworkInterface::inetAddresses)</span>
<span class="line-added">+                 .filter(a -&gt; (a instanceof Inet6Address)</span>
<span class="line-added">+                         &amp;&amp; address.equals(a)</span>
<span class="line-added">+                         &amp;&amp; ((Inet6Address) a).getScopeId() != 0)</span>
<span class="line-added">+                 .collect(Collectors.toList());</span>
<span class="line-added">+         List&lt;InetAddress&gt; result;</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             result = AccessController.doPrivileged(pa);</span>
<span class="line-added">+             var sz = result.size();</span>
<span class="line-added">+             if (sz == 0)</span>
<span class="line-added">+                 return null;</span>
<span class="line-added">+             if (sz &gt; 1)</span>
<span class="line-added">+                 throw new UncheckedIOException(new SocketException(</span>
<span class="line-added">+                     &quot;Duplicate link local addresses: must specify scope-id&quot;));</span>
<span class="line-added">+             return result.get(0);</span>
<span class="line-added">+         } catch (PrivilegedActionException pae) {</span>
<span class="line-added">+             return null;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // See java.net.URI for more details on how to generate these</span>
<span class="line-added">+     // masks.</span>
<span class="line-added">+     //</span>
<span class="line-added">+     // square brackets</span>
<span class="line-added">+     private static final long L_IPV6_DELIMS = 0x0L; // &quot;[]&quot;</span>
<span class="line-added">+     private static final long H_IPV6_DELIMS = 0x28000000L; // &quot;[]&quot;</span>
<span class="line-added">+     // RFC 3986 gen-delims</span>
<span class="line-added">+     private static final long L_GEN_DELIMS = 0x8400800800000000L; // &quot;:/?#[]@&quot;</span>
<span class="line-added">+     private static final long H_GEN_DELIMS = 0x28000001L; // &quot;:/?#[]@&quot;</span>
<span class="line-added">+     // These gen-delims can appear in authority</span>
<span class="line-added">+     private static final long L_AUTH_DELIMS = 0x400000000000000L; // &quot;@[]:&quot;</span>
<span class="line-added">+     private static final long H_AUTH_DELIMS = 0x28000001L; // &quot;@[]:&quot;</span>
<span class="line-added">+     // colon is allowed in userinfo</span>
<span class="line-added">+     private static final long L_COLON = 0x400000000000000L; // &quot;:&quot;</span>
<span class="line-added">+     private static final long H_COLON = 0x0L; // &quot;:&quot;</span>
<span class="line-added">+     // slash should be encoded in authority</span>
<span class="line-added">+     private static final long L_SLASH = 0x800000000000L; // &quot;/&quot;</span>
<span class="line-added">+     private static final long H_SLASH = 0x0L; // &quot;/&quot;</span>
<span class="line-added">+     // backslash should always be encoded</span>
<span class="line-added">+     private static final long L_BACKSLASH = 0x0L; // &quot;\&quot;</span>
<span class="line-added">+     private static final long H_BACKSLASH = 0x10000000L; // &quot;\&quot;</span>
<span class="line-added">+     // ASCII chars 0-31 + 127 - various controls + CRLF + TAB</span>
<span class="line-added">+     private static final long L_NON_PRINTABLE = 0xffffffffL;</span>
<span class="line-added">+     private static final long H_NON_PRINTABLE = 0x8000000000000000L;</span>
<span class="line-added">+     // All of the above</span>
<span class="line-added">+     private static final long L_EXCLUDE = 0x84008008ffffffffL;</span>
<span class="line-added">+     private static final long H_EXCLUDE = 0x8000000038000001L;</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static final char[] OTHERS = {</span>
<span class="line-added">+             8263,8264,8265,8448,8449,8453,8454,10868,</span>
<span class="line-added">+             65109,65110,65119,65131,65283,65295,65306,65311,65312</span>
<span class="line-added">+     };</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Tell whether the given character is found by the given mask pair</span>
<span class="line-added">+     public static boolean match(char c, long lowMask, long highMask) {</span>
<span class="line-added">+         if (c &lt; 64)</span>
<span class="line-added">+             return ((1L &lt;&lt; c) &amp; lowMask) != 0;</span>
<span class="line-added">+         if (c &lt; 128)</span>
<span class="line-added">+             return ((1L &lt;&lt; (c - 64)) &amp; highMask) != 0;</span>
<span class="line-added">+         return false; // other non ASCII characters are not filtered</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // returns -1 if the string doesn&#39;t contain any characters</span>
<span class="line-added">+     // from the mask, the index of the first such character found</span>
<span class="line-added">+     // otherwise.</span>
<span class="line-added">+     public static int scan(String s, long lowMask, long highMask) {</span>
<span class="line-added">+         int i = -1, len;</span>
<span class="line-added">+         if (s == null || (len = s.length()) == 0) return -1;</span>
<span class="line-added">+         boolean match = false;</span>
<span class="line-added">+         while (++i &lt; len &amp;&amp; !(match = match(s.charAt(i), lowMask, highMask)));</span>
<span class="line-added">+         if (match) return i;</span>
<span class="line-added">+         return -1;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public static int scan(String s, long lowMask, long highMask, char[] others) {</span>
<span class="line-added">+         int i = -1, len;</span>
<span class="line-added">+         if (s == null || (len = s.length()) == 0) return -1;</span>
<span class="line-added">+         boolean match = false;</span>
<span class="line-added">+         char c, c0 = others[0];</span>
<span class="line-added">+         while (++i &lt; len &amp;&amp; !(match = match((c=s.charAt(i)), lowMask, highMask))) {</span>
<span class="line-added">+             if (c &gt;= c0 &amp;&amp; (Arrays.binarySearch(others, c) &gt; -1)) {</span>
<span class="line-added">+                 match = true; break;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (match) return i;</span>
<span class="line-added">+ </span>
<span class="line-added">+         return -1;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static String describeChar(char c) {</span>
<span class="line-added">+         if (c &lt; 32 || c == 127) {</span>
<span class="line-added">+             if (c == &#39;\n&#39;) return &quot;LF&quot;;</span>
<span class="line-added">+             if (c == &#39;\r&#39;) return &quot;CR&quot;;</span>
<span class="line-added">+             return &quot;control char (code=&quot; + (int)c + &quot;)&quot;;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (c == &#39;\\&#39;) return &quot;&#39;\\&#39;&quot;;</span>
<span class="line-added">+         return &quot;&#39;&quot; + c + &quot;&#39;&quot;;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static String checkUserInfo(String str) {</span>
<span class="line-added">+         // colon is permitted in user info</span>
<span class="line-added">+         int index = scan(str, L_EXCLUDE &amp; ~L_COLON,</span>
<span class="line-added">+                 H_EXCLUDE &amp; ~H_COLON);</span>
<span class="line-added">+         if (index &gt;= 0) {</span>
<span class="line-added">+             return &quot;Illegal character found in user-info: &quot;</span>
<span class="line-added">+                     + describeChar(str.charAt(index));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return null;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static String checkHost(String str) {</span>
<span class="line-added">+         int index;</span>
<span class="line-added">+         if (str.startsWith(&quot;[&quot;) &amp;&amp; str.endsWith(&quot;]&quot;)) {</span>
<span class="line-added">+             str = str.substring(1, str.length() - 1);</span>
<span class="line-added">+             if (isIPv6LiteralAddress(str)) {</span>
<span class="line-added">+                 index = str.indexOf(&#39;%&#39;);</span>
<span class="line-added">+                 if (index &gt;= 0) {</span>
<span class="line-added">+                     index = scan(str = str.substring(index),</span>
<span class="line-added">+                             L_NON_PRINTABLE | L_IPV6_DELIMS,</span>
<span class="line-added">+                             H_NON_PRINTABLE | H_IPV6_DELIMS);</span>
<span class="line-added">+                     if (index &gt;= 0) {</span>
<span class="line-added">+                         return &quot;Illegal character found in IPv6 scoped address: &quot;</span>
<span class="line-added">+                                 + describeChar(str.charAt(index));</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 return null;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return &quot;Unrecognized IPv6 address format&quot;;</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             index = scan(str, L_EXCLUDE, H_EXCLUDE);</span>
<span class="line-added">+             if (index &gt;= 0) {</span>
<span class="line-added">+                 return &quot;Illegal character found in host: &quot;</span>
<span class="line-added">+                         + describeChar(str.charAt(index));</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return null;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static String checkAuth(String str) {</span>
<span class="line-added">+         int index = scan(str,</span>
<span class="line-added">+                 L_EXCLUDE &amp; ~L_AUTH_DELIMS,</span>
<span class="line-added">+                 H_EXCLUDE &amp; ~H_AUTH_DELIMS);</span>
<span class="line-added">+         if (index &gt;= 0) {</span>
<span class="line-added">+             return &quot;Illegal character found in authority: &quot;</span>
<span class="line-added">+                     + describeChar(str.charAt(index));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return null;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // check authority of hierarchical URL. Appropriate for</span>
<span class="line-added">+     // HTTP-like protocol handlers</span>
<span class="line-added">+     public static String checkAuthority(URL url) {</span>
<span class="line-added">+         String s, u, h;</span>
<span class="line-added">+         if (url == null) return null;</span>
<span class="line-added">+         if ((s = checkUserInfo(u = url.getUserInfo())) != null) {</span>
<span class="line-added">+             return s;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if ((s = checkHost(h = url.getHost())) != null) {</span>
<span class="line-added">+             return s;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (h == null &amp;&amp; u == null) {</span>
<span class="line-added">+             return checkAuth(url.getAuthority());</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return null;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // minimal syntax checks - deeper check may be performed</span>
<span class="line-added">+     // by the appropriate protocol handler</span>
<span class="line-added">+     public static String checkExternalForm(URL url) {</span>
<span class="line-added">+         String s;</span>
<span class="line-added">+         if (url == null) return null;</span>
<span class="line-added">+         int index = scan(s = url.getUserInfo(),</span>
<span class="line-added">+                 L_NON_PRINTABLE | L_SLASH,</span>
<span class="line-added">+                 H_NON_PRINTABLE | H_SLASH);</span>
<span class="line-added">+         if (index &gt;= 0) {</span>
<span class="line-added">+             return &quot;Illegal character found in authority: &quot;</span>
<span class="line-added">+                     + describeChar(s.charAt(index));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if ((s = checkHostString(url.getHost())) != null) {</span>
<span class="line-added">+             return s;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return null;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public static String checkHostString(String host) {</span>
<span class="line-added">+         if (host == null) return null;</span>
<span class="line-added">+         int index = scan(host,</span>
<span class="line-added">+                 L_NON_PRINTABLE | L_SLASH,</span>
<span class="line-added">+                 H_NON_PRINTABLE | H_SLASH,</span>
<span class="line-added">+                 OTHERS);</span>
<span class="line-added">+         if (index &gt;= 0) {</span>
<span class="line-added">+             return &quot;Illegal character found in host: &quot;</span>
<span class="line-added">+                     + describeChar(host.charAt(index));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return null;</span>
<span class="line-added">+     }</span>
  }
</pre>
<center><a href="../spi/DefaultProxySelector.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../www/ApplicationLaunchException.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>