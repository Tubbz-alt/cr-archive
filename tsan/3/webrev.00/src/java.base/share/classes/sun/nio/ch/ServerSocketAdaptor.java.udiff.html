<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/nio/ch/ServerSocketAdaptor.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SelectorProviderImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ServerSocketChannelImpl.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/nio/ch/ServerSocketAdaptor.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -30,16 +30,21 @@</span>
  import java.net.InetSocketAddress;
  import java.net.ServerSocket;
  import java.net.Socket;
  import java.net.SocketAddress;
  import java.net.SocketException;
<span class="udiff-line-modified-removed">- import java.net.SocketTimeoutException;</span>
<span class="udiff-line-modified-added">+ import java.net.SocketOption;</span>
  import java.net.StandardSocketOptions;
  import java.nio.channels.IllegalBlockingModeException;
<span class="udiff-line-removed">- import java.nio.channels.NotYetBoundException;</span>
  import java.nio.channels.ServerSocketChannel;
  import java.nio.channels.SocketChannel;
<span class="udiff-line-added">+ import java.security.AccessController;</span>
<span class="udiff-line-added">+ import java.security.PrivilegedActionException;</span>
<span class="udiff-line-added">+ import java.security.PrivilegedExceptionAction;</span>
<span class="udiff-line-added">+ import java.util.Set;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import static java.util.concurrent.TimeUnit.MILLISECONDS;</span>
  
  
  // Make a server-socket channel look like a server socket.
  //
  // The methods in this class are defined in exactly the same order as in
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -54,138 +59,146 @@</span>
      private final ServerSocketChannelImpl ssc;
  
      // Timeout &quot;option&quot; value for accepts
      private volatile int timeout;
  
<span class="udiff-line-modified-removed">-     public static ServerSocket create(ServerSocketChannelImpl ssc) {</span>
<span class="udiff-line-modified-added">+     static ServerSocket create(ServerSocketChannelImpl ssc) {</span>
<span class="udiff-line-added">+         PrivilegedExceptionAction&lt;ServerSocket&gt; pa = () -&gt; new ServerSocketAdaptor(ssc);</span>
          try {
<span class="udiff-line-modified-removed">-             return new ServerSocketAdaptor(ssc);</span>
<span class="udiff-line-modified-removed">-         } catch (IOException x) {</span>
<span class="udiff-line-modified-removed">-             throw new Error(x);</span>
<span class="udiff-line-modified-added">+             return AccessController.doPrivileged(pa);</span>
<span class="udiff-line-modified-added">+         } catch (PrivilegedActionException pae) {</span>
<span class="udiff-line-modified-added">+             throw new InternalError(&quot;Should not reach here&quot;, pae);</span>
          }
      }
  
<span class="udiff-line-modified-removed">-     // ## super will create a useless impl</span>
<span class="udiff-line-modified-removed">-     private ServerSocketAdaptor(ServerSocketChannelImpl ssc) throws IOException {</span>
<span class="udiff-line-modified-added">+     private ServerSocketAdaptor(ServerSocketChannelImpl ssc) {</span>
<span class="udiff-line-modified-added">+         super(DummySocketImpl.create());</span>
          this.ssc = ssc;
      }
  
<span class="udiff-line-added">+     @Override</span>
      public void bind(SocketAddress local) throws IOException {
          bind(local, 50);
      }
  
<span class="udiff-line-added">+     @Override</span>
      public void bind(SocketAddress local, int backlog) throws IOException {
          if (local == null)
              local = new InetSocketAddress(0);
          try {
              ssc.bind(local, backlog);
          } catch (Exception x) {
              Net.translateException(x);
          }
      }
  
<span class="udiff-line-added">+     @Override</span>
      public InetAddress getInetAddress() {
          InetSocketAddress local = ssc.localAddress();
          if (local == null) {
              return null;
          } else {
              return Net.getRevealedLocalAddress(local).getAddress();
          }
      }
  
<span class="udiff-line-added">+     @Override</span>
      public int getLocalPort() {
          InetSocketAddress local = ssc.localAddress();
          if (local == null) {
              return -1;
          } else {
              return local.getPort();
          }
      }
  
<span class="udiff-line-added">+     @Override</span>
      public Socket accept() throws IOException {
<span class="udiff-line-modified-removed">-         synchronized (ssc.blockingLock()) {</span>
<span class="udiff-line-modified-removed">-             try {</span>
<span class="udiff-line-modified-removed">-                 if (!ssc.isBound())</span>
<span class="udiff-line-modified-removed">-                     throw new NotYetBoundException();</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                 long to = this.timeout;</span>
<span class="udiff-line-modified-removed">-                 if (to == 0) {</span>
<span class="udiff-line-modified-removed">-                     // for compatibility reasons: accept connection if available</span>
<span class="udiff-line-modified-removed">-                     // when configured non-blocking</span>
<span class="udiff-line-modified-removed">-                     SocketChannel sc = ssc.accept();</span>
<span class="udiff-line-modified-removed">-                     if (sc == null &amp;&amp; !ssc.isBlocking())</span>
<span class="udiff-line-removed">-                         throw new IllegalBlockingModeException();</span>
<span class="udiff-line-removed">-                     return sc.socket();</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 if (!ssc.isBlocking())</span>
<span class="udiff-line-modified-added">+         SocketChannel sc = null;</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             int timeout = this.timeout;</span>
<span class="udiff-line-modified-added">+             if (timeout &gt; 0) {</span>
<span class="udiff-line-modified-added">+                 long nanos = MILLISECONDS.toNanos(timeout);</span>
<span class="udiff-line-modified-added">+                 sc = ssc.blockingAccept(nanos);</span>
<span class="udiff-line-modified-added">+             } else {</span>
<span class="udiff-line-modified-added">+                 // accept connection if possible when non-blocking (to preserve</span>
<span class="udiff-line-modified-added">+                 // long standing behavior)</span>
<span class="udiff-line-modified-added">+                 sc = ssc.accept();</span>
<span class="udiff-line-modified-added">+                 if (sc == null) {</span>
                      throw new IllegalBlockingModeException();
<span class="udiff-line-removed">-                 for (;;) {</span>
<span class="udiff-line-removed">-                     long st = System.currentTimeMillis();</span>
<span class="udiff-line-removed">-                     if (ssc.pollAccept(to))</span>
<span class="udiff-line-removed">-                         return ssc.accept().socket();</span>
<span class="udiff-line-removed">-                     to -= System.currentTimeMillis() - st;</span>
<span class="udiff-line-removed">-                     if (to &lt;= 0)</span>
<span class="udiff-line-removed">-                         throw new SocketTimeoutException();</span>
                  }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             } catch (Exception x) {</span>
<span class="udiff-line-removed">-                 Net.translateException(x);</span>
<span class="udiff-line-removed">-                 assert false;</span>
<span class="udiff-line-removed">-                 return null;            // Never happens</span>
              }
<span class="udiff-line-added">+         } catch (Exception e) {</span>
<span class="udiff-line-added">+             Net.translateException(e);</span>
          }
<span class="udiff-line-added">+         return sc.socket();</span>
      }
  
<span class="udiff-line-added">+     @Override</span>
      public void close() throws IOException {
          ssc.close();
      }
  
<span class="udiff-line-added">+     @Override</span>
      public ServerSocketChannel getChannel() {
          return ssc;
      }
  
<span class="udiff-line-added">+     @Override</span>
      public boolean isBound() {
          return ssc.isBound();
      }
  
<span class="udiff-line-added">+     @Override</span>
      public boolean isClosed() {
          return !ssc.isOpen();
      }
  
<span class="udiff-line-added">+     @Override</span>
      public void setSoTimeout(int timeout) throws SocketException {
<span class="udiff-line-added">+         if (!ssc.isOpen())</span>
<span class="udiff-line-added">+             throw new SocketException(&quot;Socket is closed&quot;);</span>
<span class="udiff-line-added">+         if (timeout &lt; 0)</span>
<span class="udiff-line-added">+             throw new IllegalArgumentException(&quot;timeout &lt; 0&quot;);</span>
          this.timeout = timeout;
      }
  
<span class="udiff-line-added">+     @Override</span>
      public int getSoTimeout() throws SocketException {
<span class="udiff-line-added">+         if (!ssc.isOpen())</span>
<span class="udiff-line-added">+             throw new SocketException(&quot;Socket is closed&quot;);</span>
          return timeout;
      }
  
<span class="udiff-line-added">+     @Override</span>
      public void setReuseAddress(boolean on) throws SocketException {
          try {
              ssc.setOption(StandardSocketOptions.SO_REUSEADDR, on);
          } catch (IOException x) {
              Net.translateToSocketException(x);
          }
      }
  
<span class="udiff-line-added">+     @Override</span>
      public boolean getReuseAddress() throws SocketException {
          try {
              return ssc.getOption(StandardSocketOptions.SO_REUSEADDR).booleanValue();
          } catch (IOException x) {
              Net.translateToSocketException(x);
              return false;       // Never happens
          }
      }
  
<span class="udiff-line-added">+     @Override</span>
      public String toString() {
          if (!isBound())
              return &quot;ServerSocket[unbound]&quot;;
          return &quot;ServerSocket[addr=&quot; + getInetAddress() +
                 &quot;,localport=&quot; + getLocalPort()  + &quot;]&quot;;
      }
  
<span class="udiff-line-added">+     @Override</span>
      public void setReceiveBufferSize(int size) throws SocketException {
          // size 0 valid for ServerSocketChannel, invalid for ServerSocket
          if (size &lt;= 0)
              throw new IllegalArgumentException(&quot;size cannot be 0 or negative&quot;);
          try {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -193,14 +206,31 @@</span>
          } catch (IOException x) {
              Net.translateToSocketException(x);
          }
      }
  
<span class="udiff-line-added">+     @Override</span>
      public int getReceiveBufferSize() throws SocketException {
          try {
              return ssc.getOption(StandardSocketOptions.SO_RCVBUF).intValue();
          } catch (IOException x) {
              Net.translateToSocketException(x);
              return -1;          // Never happens
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public &lt;T&gt; ServerSocket setOption(SocketOption&lt;T&gt; name, T value) throws IOException {</span>
<span class="udiff-line-added">+         ssc.setOption(name, value);</span>
<span class="udiff-line-added">+         return this;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public &lt;T&gt; T getOption(SocketOption&lt;T&gt; name) throws IOException {</span>
<span class="udiff-line-added">+         return ssc.getOption(name);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public Set&lt;SocketOption&lt;?&gt;&gt; supportedOptions() {</span>
<span class="udiff-line-added">+         return ssc.supportedOptions();</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="SelectorProviderImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ServerSocketChannelImpl.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>