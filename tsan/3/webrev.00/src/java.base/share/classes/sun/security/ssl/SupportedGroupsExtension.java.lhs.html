<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/classes/sun/security/ssl/SupportedGroupsExtension.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.security.ssl;
  27 
  28 import java.io.IOException;
  29 import java.nio.ByteBuffer;
  30 import java.security.AlgorithmConstraints;
<a name="1" id="anc1"></a><span class="line-removed">  31 import java.security.AlgorithmParameters;</span>
<span class="line-removed">  32 import java.security.CryptoPrimitive;</span>
<span class="line-removed">  33 import java.security.NoSuchAlgorithmException;</span>
<span class="line-removed">  34 import java.security.spec.AlgorithmParameterSpec;</span>
<span class="line-removed">  35 import java.security.spec.ECGenParameterSpec;</span>
<span class="line-removed">  36 import java.security.spec.ECParameterSpec;</span>
<span class="line-removed">  37 import java.security.spec.InvalidParameterSpecException;</span>
  38 import java.text.MessageFormat;
  39 import java.util.ArrayList;
  40 import java.util.Collections;
<a name="2" id="anc2"></a><span class="line-removed">  41 import java.util.EnumSet;</span>
<span class="line-removed">  42 import java.util.HashMap;</span>
  43 import java.util.LinkedList;
  44 import java.util.List;
  45 import java.util.Locale;
<a name="3" id="anc3"></a><span class="line-removed">  46 import java.util.Map;</span>
<span class="line-removed">  47 import javax.crypto.spec.DHParameterSpec;</span>
  48 import javax.net.ssl.SSLProtocolException;
  49 import sun.security.action.GetPropertyAction;
<a name="4" id="anc4"></a>
  50 import static sun.security.ssl.SSLExtension.CH_SUPPORTED_GROUPS;
  51 import static sun.security.ssl.SSLExtension.EE_SUPPORTED_GROUPS;
  52 import sun.security.ssl.SSLExtension.ExtensionConsumer;
  53 import sun.security.ssl.SSLExtension.SSLExtensionSpec;
  54 import sun.security.ssl.SSLHandshake.HandshakeMessage;
<a name="5" id="anc5"></a><span class="line-modified">  55 import sun.security.util.ECUtil;</span>
  56 
  57 /**
  58  * Pack of the &quot;supported_groups&quot; extensions [RFC 4492/7919].
  59  */
  60 final class SupportedGroupsExtension {
  61     static final HandshakeProducer chNetworkProducer =
  62             new CHSupportedGroupsProducer();
  63     static final ExtensionConsumer chOnLoadConsumer =
  64             new CHSupportedGroupsConsumer();
  65     static final SSLStringizer sgsStringizer =
  66             new SupportedGroupsStringizer();
  67 
  68     static final HandshakeProducer eeNetworkProducer =
  69             new EESupportedGroupsProducer();
  70     static final ExtensionConsumer eeOnLoadConsumer =
  71             new EESupportedGroupsConsumer();
  72 
  73     /**
  74      * The &quot;supported_groups&quot; extension.
  75      */
  76     static final class SupportedGroupsSpec implements SSLExtensionSpec {
  77         final int[] namedGroupsIds;
  78 
  79         private SupportedGroupsSpec(int[] namedGroupsIds) {
  80             this.namedGroupsIds = namedGroupsIds;
  81         }
  82 
  83         private SupportedGroupsSpec(List&lt;NamedGroup&gt; namedGroups) {
  84             this.namedGroupsIds = new int[namedGroups.size()];
  85             int i = 0;
  86             for (NamedGroup ng : namedGroups) {
  87                 namedGroupsIds[i++] = ng.id;
  88             }
  89         }
  90 
  91         private SupportedGroupsSpec(ByteBuffer m) throws IOException  {
  92             if (m.remaining() &lt; 2) {      // 2: the length of the list
  93                 throw new SSLProtocolException(
  94                     &quot;Invalid supported_groups extension: insufficient data&quot;);
  95             }
  96 
  97             byte[] ngs = Record.getBytes16(m);
  98             if (m.hasRemaining()) {
  99                 throw new SSLProtocolException(
 100                     &quot;Invalid supported_groups extension: unknown extra data&quot;);
 101             }
 102 
 103             if ((ngs == null) || (ngs.length == 0) || (ngs.length % 2 != 0)) {
 104                 throw new SSLProtocolException(
 105                     &quot;Invalid supported_groups extension: incomplete data&quot;);
 106             }
 107 
 108             int[] ids = new int[ngs.length / 2];
 109             for (int i = 0, j = 0; i &lt; ngs.length;) {
 110                 ids[j++] = ((ngs[i++] &amp; 0xFF) &lt;&lt; 8) | (ngs[i++] &amp; 0xFF);
 111             }
 112 
 113             this.namedGroupsIds = ids;
 114         }
 115 
 116         @Override
 117         public String toString() {
 118             MessageFormat messageFormat = new MessageFormat(
 119                 &quot;\&quot;versions\&quot;: &#39;[&#39;{0}&#39;]&#39;&quot;, Locale.ENGLISH);
 120 
 121             if (namedGroupsIds == null || namedGroupsIds.length == 0) {
 122                 Object[] messageFields = {
 123                         &quot;&lt;no supported named group specified&gt;&quot;
 124                     };
 125                 return messageFormat.format(messageFields);
 126             } else {
 127                 StringBuilder builder = new StringBuilder(512);
 128                 boolean isFirst = true;
 129                 for (int ngid : namedGroupsIds) {
 130                     if (isFirst) {
 131                         isFirst = false;
 132                     } else {
 133                         builder.append(&quot;, &quot;);
 134                     }
 135 
 136                     builder.append(NamedGroup.nameOf(ngid));
 137                 }
 138 
 139                 Object[] messageFields = {
 140                         builder.toString()
 141                     };
 142 
 143                 return messageFormat.format(messageFields);
 144             }
 145         }
 146     }
 147 
 148     private static final
 149             class SupportedGroupsStringizer implements SSLStringizer {
 150         @Override
 151         public String toString(ByteBuffer buffer) {
 152             try {
 153                 return (new SupportedGroupsSpec(buffer)).toString();
 154             } catch (IOException ioe) {
 155                 // For debug logging only, so please swallow exceptions.
 156                 return ioe.getMessage();
 157             }
 158         }
 159     }
 160 
<a name="6" id="anc6"></a><span class="line-removed"> 161     static enum NamedGroupType {</span>
<span class="line-removed"> 162         NAMED_GROUP_ECDHE     (&quot;EC&quot;),</span>
<span class="line-removed"> 163         NAMED_GROUP_FFDHE     (&quot;DiffieHellman&quot;),</span>
<span class="line-removed"> 164         NAMED_GROUP_X25519    (&quot;x25519&quot;),</span>
<span class="line-removed"> 165         NAMED_GROUP_X448      (&quot;x448&quot;),</span>
<span class="line-removed"> 166         NAMED_GROUP_ARBITRARY (&quot;EC&quot;),</span>
<span class="line-removed"> 167         NAMED_GROUP_NONE      (&quot;&quot;);</span>
<span class="line-removed"> 168 </span>
<span class="line-removed"> 169         private final String algorithm;</span>
<span class="line-removed"> 170 </span>
<span class="line-removed"> 171         private NamedGroupType(String algorithm) {</span>
<span class="line-removed"> 172             this.algorithm = algorithm;</span>
<span class="line-removed"> 173         }</span>
<span class="line-removed"> 174 </span>
<span class="line-removed"> 175         boolean isSupported(List&lt;CipherSuite&gt; cipherSuites) {</span>
<span class="line-removed"> 176             for (CipherSuite cs : cipherSuites) {</span>
<span class="line-removed"> 177                 if (cs.keyExchange == null ||</span>
<span class="line-removed"> 178                         cs.keyExchange.groupType == this) {</span>
<span class="line-removed"> 179                     return true;</span>
<span class="line-removed"> 180                 }</span>
<span class="line-removed"> 181             }</span>
<span class="line-removed"> 182 </span>
<span class="line-removed"> 183             return false;</span>
<span class="line-removed"> 184         }</span>
<span class="line-removed"> 185     }</span>
<span class="line-removed"> 186 </span>
<span class="line-removed"> 187     static enum NamedGroup {</span>
<span class="line-removed"> 188         // Elliptic Curves (RFC 4492)</span>
<span class="line-removed"> 189         //</span>
<span class="line-removed"> 190         // See sun.security.util.CurveDB for the OIDs</span>
<span class="line-removed"> 191         // NIST K-163</span>
<span class="line-removed"> 192         SECT163_K1  (0x0001, &quot;sect163k1&quot;, &quot;1.3.132.0.1&quot;,</span>
<span class="line-removed"> 193                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 194                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 195         SECT163_R1  (0x0002, &quot;sect163r1&quot;, &quot;1.3.132.0.2&quot;,</span>
<span class="line-removed"> 196                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 197                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 198 </span>
<span class="line-removed"> 199         // NIST B-163</span>
<span class="line-removed"> 200         SECT163_R2  (0x0003, &quot;sect163r2&quot;, &quot;1.3.132.0.15&quot;,</span>
<span class="line-removed"> 201                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 202                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 203         SECT193_R1  (0x0004, &quot;sect193r1&quot;, &quot;1.3.132.0.24&quot;,</span>
<span class="line-removed"> 204                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 205                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 206         SECT193_R2  (0x0005, &quot;sect193r2&quot;, &quot;1.3.132.0.25&quot;,</span>
<span class="line-removed"> 207                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 208                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 209 </span>
<span class="line-removed"> 210         // NIST K-233</span>
<span class="line-removed"> 211         SECT233_K1  (0x0006, &quot;sect233k1&quot;, &quot;1.3.132.0.26&quot;,</span>
<span class="line-removed"> 212                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 213                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 214 </span>
<span class="line-removed"> 215         // NIST B-233</span>
<span class="line-removed"> 216         SECT233_R1  (0x0007, &quot;sect233r1&quot;, &quot;1.3.132.0.27&quot;,</span>
<span class="line-removed"> 217                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 218                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 219         SECT239_K1  (0x0008, &quot;sect239k1&quot;, &quot;1.3.132.0.3&quot;,</span>
<span class="line-removed"> 220                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 221                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 222 </span>
<span class="line-removed"> 223         // NIST K-283</span>
<span class="line-removed"> 224         SECT283_K1  (0x0009, &quot;sect283k1&quot;, &quot;1.3.132.0.16&quot;,</span>
<span class="line-removed"> 225                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 226                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 227 </span>
<span class="line-removed"> 228         // NIST B-283</span>
<span class="line-removed"> 229         SECT283_R1  (0x000A, &quot;sect283r1&quot;, &quot;1.3.132.0.17&quot;,</span>
<span class="line-removed"> 230                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 231                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 232 </span>
<span class="line-removed"> 233         // NIST K-409</span>
<span class="line-removed"> 234         SECT409_K1  (0x000B, &quot;sect409k1&quot;, &quot;1.3.132.0.36&quot;,</span>
<span class="line-removed"> 235                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 236                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 237 </span>
<span class="line-removed"> 238         // NIST B-409</span>
<span class="line-removed"> 239         SECT409_R1  (0x000C, &quot;sect409r1&quot;, &quot;1.3.132.0.37&quot;,</span>
<span class="line-removed"> 240                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 241                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 242 </span>
<span class="line-removed"> 243         // NIST K-571</span>
<span class="line-removed"> 244         SECT571_K1  (0x000D, &quot;sect571k1&quot;, &quot;1.3.132.0.38&quot;,</span>
<span class="line-removed"> 245                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 246                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 247 </span>
<span class="line-removed"> 248         // NIST B-571</span>
<span class="line-removed"> 249         SECT571_R1  (0x000E, &quot;sect571r1&quot;, &quot;1.3.132.0.39&quot;,</span>
<span class="line-removed"> 250                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 251                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 252         SECP160_K1  (0x000F, &quot;secp160k1&quot;, &quot;1.3.132.0.9&quot;,</span>
<span class="line-removed"> 253                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 254                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 255         SECP160_R1  (0x0010, &quot;secp160r1&quot;, &quot;1.3.132.0.8&quot;,</span>
<span class="line-removed"> 256                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 257                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 258         SECP160_R2  (0x0011, &quot;secp160r2&quot;, &quot;1.3.132.0.30&quot;,</span>
<span class="line-removed"> 259                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 260                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 261         SECP192_K1  (0x0012, &quot;secp192k1&quot;, &quot;1.3.132.0.31&quot;,</span>
<span class="line-removed"> 262                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 263                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 264 </span>
<span class="line-removed"> 265         // NIST P-192</span>
<span class="line-removed"> 266         SECP192_R1  (0x0013, &quot;secp192r1&quot;, &quot;1.2.840.10045.3.1.1&quot;,</span>
<span class="line-removed"> 267                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 268                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 269         SECP224_K1  (0x0014, &quot;secp224k1&quot;, &quot;1.3.132.0.32&quot;,</span>
<span class="line-removed"> 270                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 271                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 272         // NIST P-224</span>
<span class="line-removed"> 273         SECP224_R1  (0x0015, &quot;secp224r1&quot;, &quot;1.3.132.0.33&quot;,</span>
<span class="line-removed"> 274                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 275                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 276         SECP256_K1  (0x0016, &quot;secp256k1&quot;, &quot;1.3.132.0.10&quot;,</span>
<span class="line-removed"> 277                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 278                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 279 </span>
<span class="line-removed"> 280         // NIST P-256</span>
<span class="line-removed"> 281         SECP256_R1  (0x0017, &quot;secp256r1&quot;, &quot;1.2.840.10045.3.1.7&quot;,</span>
<span class="line-removed"> 282                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 283                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 284 </span>
<span class="line-removed"> 285         // NIST P-384</span>
<span class="line-removed"> 286         SECP384_R1  (0x0018, &quot;secp384r1&quot;, &quot;1.3.132.0.34&quot;,</span>
<span class="line-removed"> 287                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 288                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 289 </span>
<span class="line-removed"> 290         // NIST P-521</span>
<span class="line-removed"> 291         SECP521_R1  (0x0019, &quot;secp521r1&quot;, &quot;1.3.132.0.35&quot;,</span>
<span class="line-removed"> 292                             NamedGroupType.NAMED_GROUP_ECDHE,</span>
<span class="line-removed"> 293                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 294 </span>
<span class="line-removed"> 295         // x25519 and x448</span>
<span class="line-removed"> 296         X25519      (0x001D, &quot;x25519&quot;, null,</span>
<span class="line-removed"> 297                             NamedGroupType.NAMED_GROUP_X25519,</span>
<span class="line-removed"> 298                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 299         X448        (0x001E, &quot;x448&quot;, null,</span>
<span class="line-removed"> 300                             NamedGroupType.NAMED_GROUP_X448,</span>
<span class="line-removed"> 301                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 302 </span>
<span class="line-removed"> 303         // Finite Field Diffie-Hellman Ephemeral Parameters (RFC 7919)</span>
<span class="line-removed"> 304         FFDHE_2048  (0x0100, &quot;ffdhe2048&quot;, null,</span>
<span class="line-removed"> 305                             NamedGroupType.NAMED_GROUP_FFDHE,</span>
<span class="line-removed"> 306                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 307         FFDHE_3072  (0x0101, &quot;ffdhe3072&quot;, null,</span>
<span class="line-removed"> 308                             NamedGroupType.NAMED_GROUP_FFDHE,</span>
<span class="line-removed"> 309                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 310         FFDHE_4096  (0x0102, &quot;ffdhe4096&quot;, null,</span>
<span class="line-removed"> 311                             NamedGroupType.NAMED_GROUP_FFDHE,</span>
<span class="line-removed"> 312                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 313         FFDHE_6144  (0x0103, &quot;ffdhe6144&quot;, null,</span>
<span class="line-removed"> 314                             NamedGroupType.NAMED_GROUP_FFDHE,</span>
<span class="line-removed"> 315                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 316         FFDHE_8192  (0x0104, &quot;ffdhe8192&quot;, null,</span>
<span class="line-removed"> 317                             NamedGroupType.NAMED_GROUP_FFDHE,</span>
<span class="line-removed"> 318                             ProtocolVersion.PROTOCOLS_TO_13),</span>
<span class="line-removed"> 319 </span>
<span class="line-removed"> 320         // Elliptic Curves (RFC 4492)</span>
<span class="line-removed"> 321         //</span>
<span class="line-removed"> 322         // arbitrary prime and characteristic-2 curves</span>
<span class="line-removed"> 323         ARBITRARY_PRIME  (0xFF01, &quot;arbitrary_explicit_prime_curves&quot;, null,</span>
<span class="line-removed"> 324                             NamedGroupType.NAMED_GROUP_ARBITRARY,</span>
<span class="line-removed"> 325                             ProtocolVersion.PROTOCOLS_TO_12),</span>
<span class="line-removed"> 326         ARBITRARY_CHAR2  (0xFF02, &quot;arbitrary_explicit_char2_curves&quot;, null,</span>
<span class="line-removed"> 327                             NamedGroupType.NAMED_GROUP_ARBITRARY,</span>
<span class="line-removed"> 328                             ProtocolVersion.PROTOCOLS_TO_12);</span>
<span class="line-removed"> 329 </span>
<span class="line-removed"> 330         final int id;               // hash + signature</span>
<span class="line-removed"> 331         final NamedGroupType type;  // group type</span>
<span class="line-removed"> 332         final String name;          // literal name</span>
<span class="line-removed"> 333         final String oid;           // object identifier of the named group</span>
<span class="line-removed"> 334         final String algorithm;     // signature algorithm</span>
<span class="line-removed"> 335         final ProtocolVersion[] supportedProtocols;</span>
<span class="line-removed"> 336 </span>
<span class="line-removed"> 337         private NamedGroup(int id, String name, String oid,</span>
<span class="line-removed"> 338                 NamedGroupType namedGroupType,</span>
<span class="line-removed"> 339                 ProtocolVersion[] supportedProtocols) {</span>
<span class="line-removed"> 340             this.id = id;</span>
<span class="line-removed"> 341             this.type = namedGroupType;</span>
<span class="line-removed"> 342             this.name = name;</span>
<span class="line-removed"> 343             this.oid = oid;</span>
<span class="line-removed"> 344             this.algorithm = namedGroupType.algorithm;</span>
<span class="line-removed"> 345             this.supportedProtocols = supportedProtocols;</span>
<span class="line-removed"> 346         }</span>
<span class="line-removed"> 347 </span>
<span class="line-removed"> 348         static NamedGroup valueOf(int id) {</span>
<span class="line-removed"> 349             for (NamedGroup group : NamedGroup.values()) {</span>
<span class="line-removed"> 350                 if (group.id == id) {</span>
<span class="line-removed"> 351                     return group;</span>
<span class="line-removed"> 352                 }</span>
<span class="line-removed"> 353             }</span>
<span class="line-removed"> 354 </span>
<span class="line-removed"> 355             return null;</span>
<span class="line-removed"> 356         }</span>
<span class="line-removed"> 357 </span>
<span class="line-removed"> 358         static NamedGroup valueOf(ECParameterSpec params) {</span>
<span class="line-removed"> 359             String oid = ECUtil.getCurveName(null, params);</span>
<span class="line-removed"> 360             if ((oid != null) &amp;&amp; (!oid.isEmpty())) {</span>
<span class="line-removed"> 361                 for (NamedGroup group : NamedGroup.values()) {</span>
<span class="line-removed"> 362                     if ((group.type == NamedGroupType.NAMED_GROUP_ECDHE) &amp;&amp;</span>
<span class="line-removed"> 363                             oid.equals(group.oid)) {</span>
<span class="line-removed"> 364                         return group;</span>
<span class="line-removed"> 365                     }</span>
<span class="line-removed"> 366                 }</span>
<span class="line-removed"> 367             }</span>
<span class="line-removed"> 368 </span>
<span class="line-removed"> 369             return null;</span>
<span class="line-removed"> 370         }</span>
<span class="line-removed"> 371 </span>
<span class="line-removed"> 372         static NamedGroup valueOf(DHParameterSpec params) {</span>
<span class="line-removed"> 373             for (Map.Entry&lt;NamedGroup, AlgorithmParameters&gt; me :</span>
<span class="line-removed"> 374                     SupportedGroups.namedGroupParams.entrySet()) {</span>
<span class="line-removed"> 375                 NamedGroup ng = me.getKey();</span>
<span class="line-removed"> 376                 if (ng.type != NamedGroupType.NAMED_GROUP_FFDHE) {</span>
<span class="line-removed"> 377                     continue;</span>
<span class="line-removed"> 378                 }</span>
<span class="line-removed"> 379 </span>
<span class="line-removed"> 380                 DHParameterSpec ngParams = null;</span>
<span class="line-removed"> 381                 AlgorithmParameters aps = me.getValue();</span>
<span class="line-removed"> 382                 try {</span>
<span class="line-removed"> 383                     ngParams = aps.getParameterSpec(DHParameterSpec.class);</span>
<span class="line-removed"> 384                 } catch (InvalidParameterSpecException ipse) {</span>
<span class="line-removed"> 385                     // should be unlikely</span>
<span class="line-removed"> 386                 }</span>
<span class="line-removed"> 387 </span>
<span class="line-removed"> 388                 if (ngParams == null) {</span>
<span class="line-removed"> 389                     continue;</span>
<span class="line-removed"> 390                 }</span>
<span class="line-removed"> 391 </span>
<span class="line-removed"> 392                 if (ngParams.getP().equals(params.getP()) &amp;&amp;</span>
<span class="line-removed"> 393                         ngParams.getG().equals(params.getG())) {</span>
<span class="line-removed"> 394                     return ng;</span>
<span class="line-removed"> 395                 }</span>
<span class="line-removed"> 396             }</span>
<span class="line-removed"> 397 </span>
<span class="line-removed"> 398             return null;</span>
<span class="line-removed"> 399         }</span>
<span class="line-removed"> 400 </span>
<span class="line-removed"> 401         static NamedGroup nameOf(String name) {</span>
<span class="line-removed"> 402             for (NamedGroup group : NamedGroup.values()) {</span>
<span class="line-removed"> 403                 if (group.name.equals(name)) {</span>
<span class="line-removed"> 404                     return group;</span>
<span class="line-removed"> 405                 }</span>
<span class="line-removed"> 406             }</span>
<span class="line-removed"> 407 </span>
<span class="line-removed"> 408             return null;</span>
<span class="line-removed"> 409         }</span>
<span class="line-removed"> 410 </span>
<span class="line-removed"> 411         static String nameOf(int id) {</span>
<span class="line-removed"> 412             for (NamedGroup group : NamedGroup.values()) {</span>
<span class="line-removed"> 413                 if (group.id == id) {</span>
<span class="line-removed"> 414                     return group.name;</span>
<span class="line-removed"> 415                 }</span>
<span class="line-removed"> 416             }</span>
<span class="line-removed"> 417 </span>
<span class="line-removed"> 418             return &quot;UNDEFINED-NAMED-GROUP(&quot; + id + &quot;)&quot;;</span>
<span class="line-removed"> 419         }</span>
<span class="line-removed"> 420 </span>
<span class="line-removed"> 421         boolean isAvailable(List&lt;ProtocolVersion&gt; protocolVersions) {</span>
<span class="line-removed"> 422             for (ProtocolVersion pv : supportedProtocols) {</span>
<span class="line-removed"> 423                 if (protocolVersions.contains(pv)) {</span>
<span class="line-removed"> 424                     return true;</span>
<span class="line-removed"> 425                 }</span>
<span class="line-removed"> 426             }</span>
<span class="line-removed"> 427             return false;</span>
<span class="line-removed"> 428         }</span>
<span class="line-removed"> 429 </span>
<span class="line-removed"> 430         boolean isAvailable(ProtocolVersion protocolVersion) {</span>
<span class="line-removed"> 431             for (ProtocolVersion pv : supportedProtocols) {</span>
<span class="line-removed"> 432                 if (protocolVersion == pv) {</span>
<span class="line-removed"> 433                     return true;</span>
<span class="line-removed"> 434                 }</span>
<span class="line-removed"> 435             }</span>
<span class="line-removed"> 436             return false;</span>
<span class="line-removed"> 437         }</span>
<span class="line-removed"> 438 </span>
<span class="line-removed"> 439         boolean isSupported(List&lt;CipherSuite&gt; cipherSuites) {</span>
<span class="line-removed"> 440             for (CipherSuite cs : cipherSuites) {</span>
<span class="line-removed"> 441                 boolean isMatch = isAvailable(cs.supportedProtocols);</span>
<span class="line-removed"> 442                 if (isMatch &amp;&amp; (cs.keyExchange == null ||</span>
<span class="line-removed"> 443                         cs.keyExchange.groupType == type)) {</span>
<span class="line-removed"> 444                     return true;</span>
<span class="line-removed"> 445                 }</span>
<span class="line-removed"> 446             }</span>
<span class="line-removed"> 447             return false;</span>
<span class="line-removed"> 448         }</span>
<span class="line-removed"> 449 </span>
<span class="line-removed"> 450         // lazy loading of parameters</span>
<span class="line-removed"> 451         AlgorithmParameters getParameters() {</span>
<span class="line-removed"> 452             return SupportedGroups.namedGroupParams.get(this);</span>
<span class="line-removed"> 453         }</span>
<span class="line-removed"> 454 </span>
<span class="line-removed"> 455         AlgorithmParameterSpec getParameterSpec() {</span>
<span class="line-removed"> 456             if (this.type == NamedGroupType.NAMED_GROUP_ECDHE) {</span>
<span class="line-removed"> 457                 return SupportedGroups.getECGenParamSpec(this);</span>
<span class="line-removed"> 458             } else if (this.type == NamedGroupType.NAMED_GROUP_FFDHE) {</span>
<span class="line-removed"> 459                 return SupportedGroups.getDHParameterSpec(this);</span>
<span class="line-removed"> 460             }</span>
<span class="line-removed"> 461 </span>
<span class="line-removed"> 462             return null;</span>
<span class="line-removed"> 463         }</span>
<span class="line-removed"> 464     }</span>
<span class="line-removed"> 465 </span>
 466     static class SupportedGroups {
 467         // To switch off the supported_groups extension for DHE cipher suite.
 468         static final boolean enableFFDHE =
 469                 Utilities.getBooleanProperty(&quot;jsse.enableFFDHE&quot;, true);
 470 
<a name="7" id="anc7"></a><span class="line-removed"> 471         // cache to speed up the parameters construction</span>
<span class="line-removed"> 472         static final Map&lt;NamedGroup,</span>
<span class="line-removed"> 473                     AlgorithmParameters&gt; namedGroupParams = new HashMap&lt;&gt;();</span>
<span class="line-removed"> 474 </span>
 475         // the supported named groups
 476         static final NamedGroup[] supportedNamedGroups;
 477 
 478         static {
 479             // The value of the System Property defines a list of enabled named
 480             // groups in preference order, separated with comma.  For example:
 481             //
 482             //      jdk.tls.namedGroups=&quot;secp521r1, secp256r1, ffdhe2048&quot;
 483             //
 484             // If the System Property is not defined or the value is empty, the
 485             // default groups and preferences will be used.
 486             String property = GetPropertyAction
 487                     .privilegedGetProperty(&quot;jdk.tls.namedGroups&quot;);
 488             if (property != null &amp;&amp; !property.isEmpty()) {
 489                 // remove double quote marks from beginning/end of the property
 490                 if (property.length() &gt; 1 &amp;&amp; property.charAt(0) == &#39;&quot;&#39; &amp;&amp;
 491                         property.charAt(property.length() - 1) == &#39;&quot;&#39;) {
 492                     property = property.substring(1, property.length() - 1);
 493                 }
 494             }
 495 
 496             ArrayList&lt;NamedGroup&gt; groupList;
 497             if (property != null &amp;&amp; !property.isEmpty()) {
 498                 String[] groups = property.split(&quot;,&quot;);
 499                 groupList = new ArrayList&lt;&gt;(groups.length);
 500                 for (String group : groups) {
 501                     group = group.trim();
 502                     if (!group.isEmpty()) {
 503                         NamedGroup namedGroup = NamedGroup.nameOf(group);
 504                         if (namedGroup != null) {
<a name="8" id="anc8"></a><span class="line-modified"> 505                             if (isAvailableGroup(namedGroup)) {</span>
 506                                 groupList.add(namedGroup);
 507                             }
 508                         }   // ignore unknown groups
 509                     }
 510                 }
 511 
 512                 if (groupList.isEmpty()) {
 513                     throw new IllegalArgumentException(
 514                             &quot;System property jdk.tls.namedGroups(&quot; +
 515                             property + &quot;) contains no supported named groups&quot;);
 516                 }
 517             } else {        // default groups
 518                 NamedGroup[] groups = new NamedGroup[] {
<a name="9" id="anc9"></a><span class="line-modified"> 519                         // NIST curves first</span>




 520                         NamedGroup.SECP256_R1,
 521                         NamedGroup.SECP384_R1,
 522                         NamedGroup.SECP521_R1,
<a name="10" id="anc10"></a><span class="line-removed"> 523                         NamedGroup.SECT283_K1,</span>
<span class="line-removed"> 524                         NamedGroup.SECT283_R1,</span>
<span class="line-removed"> 525                         NamedGroup.SECT409_K1,</span>
<span class="line-removed"> 526                         NamedGroup.SECT409_R1,</span>
<span class="line-removed"> 527                         NamedGroup.SECT571_K1,</span>
<span class="line-removed"> 528                         NamedGroup.SECT571_R1,</span>
 529 
<a name="11" id="anc11"></a><span class="line-modified"> 530                         // non-NIST curves</span>
<span class="line-modified"> 531                         NamedGroup.SECP256_K1,</span>
 532 
<a name="12" id="anc12"></a><span class="line-modified"> 533                         // FFDHE 2048</span>
 534                         NamedGroup.FFDHE_2048,
 535                         NamedGroup.FFDHE_3072,
 536                         NamedGroup.FFDHE_4096,
 537                         NamedGroup.FFDHE_6144,
 538                         NamedGroup.FFDHE_8192,
 539                     };
 540 
 541                 groupList = new ArrayList&lt;&gt;(groups.length);
 542                 for (NamedGroup group : groups) {
<a name="13" id="anc13"></a><span class="line-modified"> 543                     if (isAvailableGroup(group)) {</span>
 544                         groupList.add(group);
 545                     }
 546                 }
 547 
 548                 if (groupList.isEmpty() &amp;&amp;
 549                         SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {
 550                     SSLLogger.warning(&quot;No default named groups&quot;);
 551                 }
 552             }
 553 
 554             supportedNamedGroups = new NamedGroup[groupList.size()];
 555             int i = 0;
 556             for (NamedGroup namedGroup : groupList) {
 557                 supportedNamedGroups[i++] = namedGroup;
 558             }
 559         }
 560 
<a name="14" id="anc14"></a><span class="line-removed"> 561         // check whether the group is supported by the underlying providers</span>
<span class="line-removed"> 562         private static boolean isAvailableGroup(NamedGroup namedGroup) {</span>
<span class="line-removed"> 563             AlgorithmParameters params = null;</span>
<span class="line-removed"> 564             AlgorithmParameterSpec spec = null;</span>
<span class="line-removed"> 565             if (namedGroup.type == NamedGroupType.NAMED_GROUP_ECDHE) {</span>
<span class="line-removed"> 566                 if (namedGroup.oid != null) {</span>
<span class="line-removed"> 567                     try {</span>
<span class="line-removed"> 568                         params = AlgorithmParameters.getInstance(&quot;EC&quot;);</span>
<span class="line-removed"> 569                         spec = new ECGenParameterSpec(namedGroup.oid);</span>
<span class="line-removed"> 570                     } catch (NoSuchAlgorithmException e) {</span>
<span class="line-removed"> 571                         return false;</span>
<span class="line-removed"> 572                     }</span>
<span class="line-removed"> 573                 }</span>
<span class="line-removed"> 574             } else if (namedGroup.type == NamedGroupType.NAMED_GROUP_FFDHE) {</span>
<span class="line-removed"> 575                 try {</span>
<span class="line-removed"> 576                     params = AlgorithmParameters.getInstance(&quot;DiffieHellman&quot;);</span>
<span class="line-removed"> 577                     spec = getFFDHEDHParameterSpec(namedGroup);</span>
<span class="line-removed"> 578                 } catch (NoSuchAlgorithmException e) {</span>
<span class="line-removed"> 579                     return false;</span>
<span class="line-removed"> 580                 }</span>
<span class="line-removed"> 581             }   // Otherwise, unsupported.</span>
<span class="line-removed"> 582 </span>
<span class="line-removed"> 583             if ((params != null) &amp;&amp; (spec != null)) {</span>
<span class="line-removed"> 584                 try {</span>
<span class="line-removed"> 585                     params.init(spec);</span>
<span class="line-removed"> 586                 } catch (InvalidParameterSpecException e) {</span>
<span class="line-removed"> 587                     return false;</span>
<span class="line-removed"> 588                 }</span>
<span class="line-removed"> 589 </span>
<span class="line-removed"> 590                 // cache the parameters</span>
<span class="line-removed"> 591                 namedGroupParams.put(namedGroup, params);</span>
<span class="line-removed"> 592 </span>
<span class="line-removed"> 593                 return true;</span>
<span class="line-removed"> 594             }</span>
<span class="line-removed"> 595 </span>
<span class="line-removed"> 596             return false;</span>
<span class="line-removed"> 597         }</span>
<span class="line-removed"> 598 </span>
<span class="line-removed"> 599         private static DHParameterSpec getFFDHEDHParameterSpec(</span>
<span class="line-removed"> 600                 NamedGroup namedGroup) {</span>
<span class="line-removed"> 601             DHParameterSpec spec = null;</span>
<span class="line-removed"> 602             switch (namedGroup) {</span>
<span class="line-removed"> 603                 case FFDHE_2048:</span>
<span class="line-removed"> 604                     spec = PredefinedDHParameterSpecs.ffdheParams.get(2048);</span>
<span class="line-removed"> 605                     break;</span>
<span class="line-removed"> 606                 case FFDHE_3072:</span>
<span class="line-removed"> 607                     spec = PredefinedDHParameterSpecs.ffdheParams.get(3072);</span>
<span class="line-removed"> 608                     break;</span>
<span class="line-removed"> 609                 case FFDHE_4096:</span>
<span class="line-removed"> 610                     spec = PredefinedDHParameterSpecs.ffdheParams.get(4096);</span>
<span class="line-removed"> 611                     break;</span>
<span class="line-removed"> 612                 case FFDHE_6144:</span>
<span class="line-removed"> 613                     spec = PredefinedDHParameterSpecs.ffdheParams.get(6144);</span>
<span class="line-removed"> 614                     break;</span>
<span class="line-removed"> 615                 case FFDHE_8192:</span>
<span class="line-removed"> 616                     spec = PredefinedDHParameterSpecs.ffdheParams.get(8192);</span>
<span class="line-removed"> 617             }</span>
<span class="line-removed"> 618 </span>
<span class="line-removed"> 619             return spec;</span>
<span class="line-removed"> 620         }</span>
<span class="line-removed"> 621 </span>
<span class="line-removed"> 622         private static DHParameterSpec getPredefinedDHParameterSpec(</span>
<span class="line-removed"> 623                 NamedGroup namedGroup) {</span>
<span class="line-removed"> 624             DHParameterSpec spec = null;</span>
<span class="line-removed"> 625             switch (namedGroup) {</span>
<span class="line-removed"> 626                 case FFDHE_2048:</span>
<span class="line-removed"> 627                     spec = PredefinedDHParameterSpecs.definedParams.get(2048);</span>
<span class="line-removed"> 628                     break;</span>
<span class="line-removed"> 629                 case FFDHE_3072:</span>
<span class="line-removed"> 630                     spec = PredefinedDHParameterSpecs.definedParams.get(3072);</span>
<span class="line-removed"> 631                     break;</span>
<span class="line-removed"> 632                 case FFDHE_4096:</span>
<span class="line-removed"> 633                     spec = PredefinedDHParameterSpecs.definedParams.get(4096);</span>
<span class="line-removed"> 634                     break;</span>
<span class="line-removed"> 635                 case FFDHE_6144:</span>
<span class="line-removed"> 636                     spec = PredefinedDHParameterSpecs.definedParams.get(6144);</span>
<span class="line-removed"> 637                     break;</span>
<span class="line-removed"> 638                 case FFDHE_8192:</span>
<span class="line-removed"> 639                     spec = PredefinedDHParameterSpecs.definedParams.get(8192);</span>
<span class="line-removed"> 640             }</span>
<span class="line-removed"> 641 </span>
<span class="line-removed"> 642             return spec;</span>
<span class="line-removed"> 643         }</span>
<span class="line-removed"> 644 </span>
<span class="line-removed"> 645         static ECGenParameterSpec getECGenParamSpec(NamedGroup namedGroup) {</span>
<span class="line-removed"> 646             if (namedGroup.type != NamedGroupType.NAMED_GROUP_ECDHE) {</span>
<span class="line-removed"> 647                 throw new RuntimeException(</span>
<span class="line-removed"> 648                         &quot;Not a named EC group: &quot; + namedGroup);</span>
<span class="line-removed"> 649             }</span>
<span class="line-removed"> 650 </span>
<span class="line-removed"> 651             AlgorithmParameters params = namedGroupParams.get(namedGroup);</span>
<span class="line-removed"> 652             if (params == null) {</span>
<span class="line-removed"> 653                 throw new RuntimeException(</span>
<span class="line-removed"> 654                         &quot;Not a supported EC named group: &quot; + namedGroup);</span>
<span class="line-removed"> 655             }</span>
<span class="line-removed"> 656 </span>
<span class="line-removed"> 657             try {</span>
<span class="line-removed"> 658                 return params.getParameterSpec(ECGenParameterSpec.class);</span>
<span class="line-removed"> 659             } catch (InvalidParameterSpecException ipse) {</span>
<span class="line-removed"> 660                 // should be unlikely</span>
<span class="line-removed"> 661                 return new ECGenParameterSpec(namedGroup.oid);</span>
<span class="line-removed"> 662             }</span>
<span class="line-removed"> 663         }</span>
<span class="line-removed"> 664 </span>
<span class="line-removed"> 665         static DHParameterSpec getDHParameterSpec(NamedGroup namedGroup) {</span>
<span class="line-removed"> 666             if (namedGroup.type != NamedGroupType.NAMED_GROUP_FFDHE) {</span>
<span class="line-removed"> 667                 throw new RuntimeException(</span>
<span class="line-removed"> 668                         &quot;Not a named DH group: &quot; + namedGroup);</span>
<span class="line-removed"> 669             }</span>
<span class="line-removed"> 670 </span>
<span class="line-removed"> 671             AlgorithmParameters params = namedGroupParams.get(namedGroup);</span>
<span class="line-removed"> 672             if (params == null) {</span>
<span class="line-removed"> 673                 throw new RuntimeException(</span>
<span class="line-removed"> 674                         &quot;Not a supported DH named group: &quot; + namedGroup);</span>
<span class="line-removed"> 675             }</span>
<span class="line-removed"> 676 </span>
<span class="line-removed"> 677             try {</span>
<span class="line-removed"> 678                 return params.getParameterSpec(DHParameterSpec.class);</span>
<span class="line-removed"> 679             } catch (InvalidParameterSpecException ipse) {</span>
<span class="line-removed"> 680                 // should be unlikely</span>
<span class="line-removed"> 681                 return getPredefinedDHParameterSpec(namedGroup);</span>
<span class="line-removed"> 682             }</span>
<span class="line-removed"> 683         }</span>
<span class="line-removed"> 684 </span>
 685         // Is there any supported group permitted by the constraints?
 686         static boolean isActivatable(
<a name="15" id="anc15"></a><span class="line-modified"> 687                 AlgorithmConstraints constraints, NamedGroupType type) {</span>
 688 
 689             boolean hasFFDHEGroups = false;
 690             for (NamedGroup namedGroup : supportedNamedGroups) {
<a name="16" id="anc16"></a><span class="line-modified"> 691                 if (namedGroup.type == type) {</span>
<span class="line-modified"> 692                     if (constraints.permits(</span>
<span class="line-removed"> 693                             EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="line-removed"> 694                             namedGroup.algorithm,</span>
<span class="line-removed"> 695                             namedGroupParams.get(namedGroup))) {</span>
<span class="line-removed"> 696 </span>
 697                         return true;
 698                     }
 699 
 700                     if (!hasFFDHEGroups &amp;&amp;
<a name="17" id="anc17"></a><span class="line-modified"> 701                             (type == NamedGroupType.NAMED_GROUP_FFDHE)) {</span>
 702                         hasFFDHEGroups = true;
 703                     }
 704                 }
 705             }
 706 
 707             // For compatibility, if no FFDHE groups are defined, the non-FFDHE
 708             // compatible mode (using DHE cipher suite without FFDHE extension)
 709             // is allowed.
 710             //
 711             // Note that the constraints checking on DHE parameters will be
 712             // performed during key exchanging in a handshake.
<a name="18" id="anc18"></a><span class="line-modified"> 713             return !hasFFDHEGroups &amp;&amp; type == NamedGroupType.NAMED_GROUP_FFDHE;</span>
 714         }
 715 
 716         // Is the named group permitted by the constraints?
 717         static boolean isActivatable(
 718                 AlgorithmConstraints constraints, NamedGroup namedGroup) {
<a name="19" id="anc19"></a><span class="line-modified"> 719             if (!isSupported(namedGroup)) {</span>
 720                 return false;
 721             }
 722 
<a name="20" id="anc20"></a><span class="line-modified"> 723             return constraints.permits(</span>
<span class="line-removed"> 724                             EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="line-removed"> 725                             namedGroup.algorithm,</span>
<span class="line-removed"> 726                             namedGroupParams.get(namedGroup));</span>
 727         }
 728 
 729         // Is the named group supported?
 730         static boolean isSupported(NamedGroup namedGroup) {
 731             for (NamedGroup group : supportedNamedGroups) {
 732                 if (namedGroup.id == group.id) {
 733                     return true;
 734                 }
 735             }
 736 
 737             return false;
 738         }
 739 
 740         static NamedGroup getPreferredGroup(
 741                 ProtocolVersion negotiatedProtocol,
<a name="21" id="anc21"></a><span class="line-modified"> 742                 AlgorithmConstraints constraints, NamedGroupType type,</span>
 743                 List&lt;NamedGroup&gt; requestedNamedGroups) {
 744             for (NamedGroup namedGroup : requestedNamedGroups) {
<a name="22" id="anc22"></a><span class="line-modified"> 745                 if ((namedGroup.type == type) &amp;&amp;</span>
 746                         namedGroup.isAvailable(negotiatedProtocol) &amp;&amp;
 747                         isSupported(namedGroup) &amp;&amp;
<a name="23" id="anc23"></a><span class="line-modified"> 748                         constraints.permits(</span>
<span class="line-removed"> 749                                 EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="line-removed"> 750                                 namedGroup.algorithm,</span>
<span class="line-removed"> 751                                 namedGroupParams.get(namedGroup))) {</span>
 752                     return namedGroup;
 753                 }
 754             }
 755 
 756             return null;
 757         }
 758 
 759         static NamedGroup getPreferredGroup(
 760                 ProtocolVersion negotiatedProtocol,
<a name="24" id="anc24"></a><span class="line-modified"> 761                 AlgorithmConstraints constraints, NamedGroupType type) {</span>
 762             for (NamedGroup namedGroup : supportedNamedGroups) {
<a name="25" id="anc25"></a><span class="line-modified"> 763                 if ((namedGroup.type == type) &amp;&amp;</span>
 764                         namedGroup.isAvailable(negotiatedProtocol) &amp;&amp;
<a name="26" id="anc26"></a><span class="line-modified"> 765                         constraints.permits(</span>
<span class="line-removed"> 766                                 EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="line-removed"> 767                                 namedGroup.algorithm,</span>
<span class="line-removed"> 768                                 namedGroupParams.get(namedGroup))) {</span>
 769                     return namedGroup;
 770                 }
 771             }
 772 
 773             return null;
 774         }
 775     }
 776 
 777     /**
 778      * Network data producer of a &quot;supported_groups&quot; extension in
 779      * the ClientHello handshake message.
 780      */
 781     private static final class CHSupportedGroupsProducer
 782             extends SupportedGroups implements HandshakeProducer {
 783         // Prevent instantiation of this class.
 784         private CHSupportedGroupsProducer() {
 785             // blank
 786         }
 787 
 788         @Override
 789         public byte[] produce(ConnectionContext context,
 790                 HandshakeMessage message) throws IOException {
 791             // The producing happens in client side only.
 792             ClientHandshakeContext chc = (ClientHandshakeContext)context;
 793 
 794             // Is it a supported and enabled extension?
 795             if (!chc.sslConfig.isAvailable(CH_SUPPORTED_GROUPS)) {
 796                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
 797                     SSLLogger.fine(
 798                         &quot;Ignore unavailable supported_groups extension&quot;);
 799                 }
 800                 return null;
 801             }
 802 
 803             // Produce the extension.
 804             ArrayList&lt;NamedGroup&gt; namedGroups =
 805                 new ArrayList&lt;&gt;(SupportedGroups.supportedNamedGroups.length);
 806             for (NamedGroup ng : SupportedGroups.supportedNamedGroups) {
 807                 if ((!SupportedGroups.enableFFDHE) &amp;&amp;
<a name="27" id="anc27"></a><span class="line-modified"> 808                     (ng.type == NamedGroupType.NAMED_GROUP_FFDHE)) {</span>
 809                     continue;
 810                 }
 811 
 812                 if (ng.isAvailable(chc.activeProtocols) &amp;&amp;
 813                         ng.isSupported(chc.activeCipherSuites) &amp;&amp;
<a name="28" id="anc28"></a><span class="line-modified"> 814                         chc.algorithmConstraints.permits(</span>
<span class="line-removed"> 815                             EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="line-removed"> 816                             ng.algorithm, namedGroupParams.get(ng))) {</span>
 817                     namedGroups.add(ng);
 818                 } else if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
 819                     SSLLogger.fine(
 820                         &quot;Ignore inactive or disabled named group: &quot; + ng.name);
 821                 }
 822             }
 823 
 824             if (namedGroups.isEmpty()) {
 825                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
 826                     SSLLogger.warning(&quot;no available named group&quot;);
 827                 }
 828 
 829                 return null;
 830             }
 831 
 832             int vectorLen = namedGroups.size() &lt;&lt; 1;
 833             byte[] extData = new byte[vectorLen + 2];
 834             ByteBuffer m = ByteBuffer.wrap(extData);
 835             Record.putInt16(m, vectorLen);
 836             for (NamedGroup namedGroup : namedGroups) {
 837                     Record.putInt16(m, namedGroup.id);
 838             }
 839 
 840             // Update the context.
 841             chc.clientRequestedNamedGroups =
 842                     Collections.&lt;NamedGroup&gt;unmodifiableList(namedGroups);
 843             chc.handshakeExtensions.put(CH_SUPPORTED_GROUPS,
 844                     new SupportedGroupsSpec(namedGroups));
 845 
 846             return extData;
 847         }
 848     }
 849 
 850     /**
 851      * Network data producer of a &quot;supported_groups&quot; extension in
 852      * the ClientHello handshake message.
 853      */
 854     private static final
 855             class CHSupportedGroupsConsumer implements ExtensionConsumer {
 856         // Prevent instantiation of this class.
 857         private CHSupportedGroupsConsumer() {
 858             // blank
 859         }
 860 
 861         @Override
 862         public void consume(ConnectionContext context,
 863             HandshakeMessage message, ByteBuffer buffer) throws IOException {
 864             // The consuming happens in server side only.
 865             ServerHandshakeContext shc = (ServerHandshakeContext)context;
 866 
 867             // Is it a supported and enabled extension?
 868             if (!shc.sslConfig.isAvailable(CH_SUPPORTED_GROUPS)) {
 869                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
 870                     SSLLogger.fine(
 871                         &quot;Ignore unavailable supported_groups extension&quot;);
 872                 }
 873                 return;     // ignore the extension
 874             }
 875 
 876             // Parse the extension.
 877             SupportedGroupsSpec spec;
 878             try {
 879                 spec = new SupportedGroupsSpec(buffer);
 880             } catch (IOException ioe) {
 881                 throw shc.conContext.fatal(Alert.UNEXPECTED_MESSAGE, ioe);
 882             }
 883 
 884             // Update the context.
 885             List&lt;NamedGroup&gt; knownNamedGroups = new LinkedList&lt;&gt;();
 886             for (int id : spec.namedGroupsIds) {
 887                 NamedGroup ng = NamedGroup.valueOf(id);
 888                 if (ng != null) {
 889                     knownNamedGroups.add(ng);
 890                 }
 891             }
 892 
 893             shc.clientRequestedNamedGroups = knownNamedGroups;
 894             shc.handshakeExtensions.put(CH_SUPPORTED_GROUPS, spec);
 895 
 896             // No impact on session resumption.
 897         }
 898     }
 899 
 900     /**
 901      * Network data producer of a &quot;supported_groups&quot; extension in
 902      * the EncryptedExtensions handshake message.
 903      */
 904     private static final class EESupportedGroupsProducer
 905             extends SupportedGroups implements HandshakeProducer {
 906 
 907         // Prevent instantiation of this class.
 908         private EESupportedGroupsProducer() {
 909             // blank
 910         }
 911 
 912         @Override
 913         public byte[] produce(ConnectionContext context,
 914                 HandshakeMessage message) throws IOException {
 915             // The producing happens in server side only.
 916             ServerHandshakeContext shc = (ServerHandshakeContext)context;
 917 
 918             // Is it a supported and enabled extension?
 919             if (!shc.sslConfig.isAvailable(EE_SUPPORTED_GROUPS)) {
 920                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
 921                     SSLLogger.fine(
 922                         &quot;Ignore unavailable supported_groups extension&quot;);
 923                 }
 924                 return null;
 925             }
 926 
 927             // Produce the extension.
 928             //
 929             // Contains all groups the server supports, regardless of whether
 930             // they are currently supported by the client.
 931             ArrayList&lt;NamedGroup&gt; namedGroups = new ArrayList&lt;&gt;(
 932                     SupportedGroups.supportedNamedGroups.length);
 933             for (NamedGroup ng : SupportedGroups.supportedNamedGroups) {
 934                 if ((!SupportedGroups.enableFFDHE) &amp;&amp;
<a name="29" id="anc29"></a><span class="line-modified"> 935                     (ng.type == NamedGroupType.NAMED_GROUP_FFDHE)) {</span>
 936                     continue;
 937                 }
 938 
 939                 if (ng.isAvailable(shc.activeProtocols) &amp;&amp;
 940                         ng.isSupported(shc.activeCipherSuites) &amp;&amp;
<a name="30" id="anc30"></a><span class="line-modified"> 941                         shc.algorithmConstraints.permits(</span>
<span class="line-removed"> 942                             EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="line-removed"> 943                             ng.algorithm, namedGroupParams.get(ng))) {</span>
 944                     namedGroups.add(ng);
 945                 } else if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
 946                     SSLLogger.fine(
 947                         &quot;Ignore inactive or disabled named group: &quot; + ng.name);
 948                 }
 949             }
 950 
 951             if (namedGroups.isEmpty()) {
 952                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
 953                     SSLLogger.warning(&quot;no available named group&quot;);
 954                 }
 955 
 956                 return null;
 957             }
 958 
 959             int vectorLen = namedGroups.size() &lt;&lt; 1;
 960             byte[] extData = new byte[vectorLen + 2];
 961             ByteBuffer m = ByteBuffer.wrap(extData);
 962             Record.putInt16(m, vectorLen);
 963             for (NamedGroup namedGroup : namedGroups) {
 964                     Record.putInt16(m, namedGroup.id);
 965             }
 966 
 967             // Update the context.
 968             shc.conContext.serverRequestedNamedGroups =
 969                     Collections.&lt;NamedGroup&gt;unmodifiableList(namedGroups);
 970             SupportedGroupsSpec spec = new SupportedGroupsSpec(namedGroups);
 971             shc.handshakeExtensions.put(EE_SUPPORTED_GROUPS, spec);
 972 
 973             return extData;
 974         }
 975     }
 976 
 977     private static final
 978             class EESupportedGroupsConsumer implements ExtensionConsumer {
 979         // Prevent instantiation of this class.
 980         private EESupportedGroupsConsumer() {
 981             // blank
 982         }
 983 
 984         @Override
 985         public void consume(ConnectionContext context,
 986             HandshakeMessage message, ByteBuffer buffer) throws IOException {
 987             // The consuming happens in client side only.
 988             ClientHandshakeContext chc = (ClientHandshakeContext)context;
 989 
 990             // Is it a supported and enabled extension?
 991             if (!chc.sslConfig.isAvailable(EE_SUPPORTED_GROUPS)) {
 992                 if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl,handshake&quot;)) {
 993                     SSLLogger.fine(
 994                         &quot;Ignore unavailable supported_groups extension&quot;);
 995                 }
 996                 return;     // ignore the extension
 997             }
 998 
 999             // Parse the extension.
1000             SupportedGroupsSpec spec;
1001             try {
1002                 spec = new SupportedGroupsSpec(buffer);
1003             } catch (IOException ioe) {
1004                 throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE, ioe);
1005             }
1006 
1007             // Update the context.
1008             List&lt;NamedGroup&gt; knownNamedGroups =
1009                     new ArrayList&lt;&gt;(spec.namedGroupsIds.length);
1010             for (int id : spec.namedGroupsIds) {
1011                 NamedGroup ng = NamedGroup.valueOf(id);
1012                 if (ng != null) {
1013                     knownNamedGroups.add(ng);
1014                 }
1015             }
1016 
1017             chc.conContext.serverRequestedNamedGroups = knownNamedGroups;
1018             chc.handshakeExtensions.put(EE_SUPPORTED_GROUPS, spec);
1019 
1020             // No impact on session resumption.
1021         }
1022     }
1023 }
<a name="31" id="anc31"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="31" type="hidden" />
</body>
</html>