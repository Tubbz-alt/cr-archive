<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/ssl/HelloCookieManager.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="HandshakeContext.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="InputRecord.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/HelloCookieManager.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -28,10 +28,11 @@</span>
  import java.io.IOException;
  import java.security.MessageDigest;
  import java.security.NoSuchAlgorithmException;
  import java.security.SecureRandom;
  import java.util.Arrays;
<span class="udiff-line-added">+ import java.util.concurrent.locks.ReentrantLock;</span>
  import static sun.security.ssl.ClientHello.ClientHelloMessage;
  
  /**
   *  (D)TLS handshake cookie manager
   */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -43,10 +44,12 @@</span>
  
          private volatile D10HelloCookieManager d10HelloCookieManager;
          private volatile D13HelloCookieManager d13HelloCookieManager;
          private volatile T13HelloCookieManager t13HelloCookieManager;
  
<span class="udiff-line-added">+         private final ReentrantLock managerLock = new ReentrantLock();</span>
<span class="udiff-line-added">+ </span>
          Builder(SecureRandom secureRandom) {
              this.secureRandom = secureRandom;
          }
  
          HelloCookieManager valueOf(ProtocolVersion protocolVersion) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -54,43 +57,52 @@</span>
                  if (protocolVersion.useTLS13PlusSpec()) {
                      if (d13HelloCookieManager != null) {
                          return d13HelloCookieManager;
                      }
  
<span class="udiff-line-modified-removed">-                     synchronized (this) {</span>
<span class="udiff-line-modified-added">+                     managerLock.lock();</span>
<span class="udiff-line-added">+                     try {</span>
                          if (d13HelloCookieManager == null) {
                              d13HelloCookieManager =
                                      new D13HelloCookieManager(secureRandom);
                          }
<span class="udiff-line-added">+                     } finally {</span>
<span class="udiff-line-added">+                         managerLock.unlock();</span>
                      }
  
                      return d13HelloCookieManager;
                  } else {
                      if (d10HelloCookieManager != null) {
                          return d10HelloCookieManager;
                      }
  
<span class="udiff-line-modified-removed">-                     synchronized (this) {</span>
<span class="udiff-line-modified-added">+                     managerLock.lock();</span>
<span class="udiff-line-added">+                     try {</span>
                          if (d10HelloCookieManager == null) {
                              d10HelloCookieManager =
                                      new D10HelloCookieManager(secureRandom);
                          }
<span class="udiff-line-added">+                     } finally {</span>
<span class="udiff-line-added">+                         managerLock.unlock();</span>
                      }
  
                      return d10HelloCookieManager;
                  }
              } else {
                  if (protocolVersion.useTLS13PlusSpec()) {
                      if (t13HelloCookieManager != null) {
                          return t13HelloCookieManager;
                      }
  
<span class="udiff-line-modified-removed">-                     synchronized (this) {</span>
<span class="udiff-line-modified-added">+                     managerLock.lock();</span>
<span class="udiff-line-added">+                     try {</span>
                          if (t13HelloCookieManager == null) {
                              t13HelloCookieManager =
                                      new T13HelloCookieManager(secureRandom);
                          }
<span class="udiff-line-added">+                     } finally {</span>
<span class="udiff-line-added">+                         managerLock.unlock();</span>
                      }
  
                      return t13HelloCookieManager;
                  }
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -112,10 +124,12 @@</span>
          final SecureRandom secureRandom;
          private int         cookieVersion;  // allow to wrap, version + sequence
          private byte[]      cookieSecret;
          private byte[]      legacySecret;
  
<span class="udiff-line-added">+         private final ReentrantLock d10ManagerLock = new ReentrantLock();</span>
<span class="udiff-line-added">+ </span>
          D10HelloCookieManager(SecureRandom secureRandom) {
              this.secureRandom = secureRandom;
  
              this.cookieVersion = secureRandom.nextInt();
              this.cookieSecret = new byte[32];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -129,21 +143,24 @@</span>
          byte[] createCookie(ServerHandshakeContext context,
                  ClientHelloMessage clientHello) throws IOException {
              int version;
              byte[] secret;
  
<span class="udiff-line-modified-removed">-             synchronized (this) {</span>
<span class="udiff-line-modified-added">+             d10ManagerLock.lock();</span>
<span class="udiff-line-added">+             try {</span>
                  version = cookieVersion;
                  secret = cookieSecret;
  
                  // the cookie secret usage limit is 2^24
                  if ((cookieVersion &amp; 0xFFFFFF) == 0) {  // reset the secret
                      System.arraycopy(cookieSecret, 0, legacySecret, 0, 32);
                      secureRandom.nextBytes(cookieSecret);
                  }
  
                  cookieVersion++;
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 d10ManagerLock.unlock();</span>
              }
  
              MessageDigest md;
              try {
                  md = MessageDigest.getInstance(&quot;SHA-256&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,16 +183,19 @@</span>
              if ((cookie == null) || (cookie.length != 32)) {
                  return false;
              }
  
              byte[] secret;
<span class="udiff-line-modified-removed">-             synchronized (this) {</span>
<span class="udiff-line-modified-added">+             d10ManagerLock.lock();</span>
<span class="udiff-line-added">+             try {</span>
                  if (((cookieVersion &gt;&gt; 24) &amp; 0xFF) == cookie[0]) {
                      secret = cookieSecret;
                  } else {
                      secret = legacySecret;  // including out of window cookies
                  }
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 d10ManagerLock.unlock();</span>
              }
  
              MessageDigest md;
              try {
                  md = MessageDigest.getInstance(&quot;SHA-256&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -216,10 +236,12 @@</span>
          final SecureRandom secureRandom;
          private int             cookieVersion;      // version + sequence
          private final byte[]    cookieSecret;
          private final byte[]    legacySecret;
  
<span class="udiff-line-added">+         private final ReentrantLock t13ManagerLock = new ReentrantLock();</span>
<span class="udiff-line-added">+ </span>
          T13HelloCookieManager(SecureRandom secureRandom) {
              this.secureRandom = secureRandom;
              this.cookieVersion = secureRandom.nextInt();
              this.cookieSecret = new byte[64];
              this.legacySecret = new byte[64];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -232,21 +254,24 @@</span>
          byte[] createCookie(ServerHandshakeContext context,
                  ClientHelloMessage clientHello) throws IOException {
              int version;
              byte[] secret;
  
<span class="udiff-line-modified-removed">-             synchronized (this) {</span>
<span class="udiff-line-modified-added">+             t13ManagerLock.lock();</span>
<span class="udiff-line-added">+             try {</span>
                  version = cookieVersion;
                  secret = cookieSecret;
  
                  // the cookie secret usage limit is 2^24
                  if ((cookieVersion &amp; 0xFFFFFF) == 0) {  // reset the secret
                      System.arraycopy(cookieSecret, 0, legacySecret, 0, 64);
                      secureRandom.nextBytes(cookieSecret);
                  }
  
                  cookieVersion++;        // allow wrapped version number
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 t13ManagerLock.unlock();</span>
              }
  
              MessageDigest md;
              try {
                  md = MessageDigest.getInstance(
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -311,16 +336,19 @@</span>
                      Arrays.copyOfRange(cookie, 3, 3 + hashLen);
              byte[] prevClientHelloHash =
                      Arrays.copyOfRange(cookie, 3 + hashLen, cookie.length);
  
              byte[] secret;
<span class="udiff-line-modified-removed">-             synchronized (this) {</span>
<span class="udiff-line-modified-added">+             t13ManagerLock.lock();</span>
<span class="udiff-line-added">+             try {</span>
                  if ((byte)((cookieVersion &gt;&gt; 24) &amp; 0xFF) == cookie[2]) {
                      secret = cookieSecret;
                  } else {
                      secret = legacySecret;  // including out of window cookies
                  }
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 t13ManagerLock.unlock();</span>
              }
  
              MessageDigest md;
              try {
                  md = MessageDigest.getInstance(cs.hashAlg.name);
</pre>
<center><a href="HandshakeContext.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="InputRecord.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>