<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/ssl/SSLEngineImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SSLContextImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SSLEngineInputRecord.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/SSLEngineImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -31,10 +31,11 @@</span>
  import java.security.AccessController;
  import java.security.PrivilegedActionException;
  import java.security.PrivilegedExceptionAction;
  import java.util.List;
  import java.util.Map;
<span class="udiff-line-added">+ import java.util.concurrent.locks.ReentrantLock;</span>
  import java.util.function.BiFunction;
  import javax.net.ssl.SSLEngine;
  import javax.net.ssl.SSLEngineResult;
  import javax.net.ssl.SSLEngineResult.HandshakeStatus;
  import javax.net.ssl.SSLEngineResult.Status;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -52,10 +53,11 @@</span>
   * @author Brad Wetmore
   */
  final class SSLEngineImpl extends SSLEngine implements SSLTransport {
      private final SSLContextImpl        sslContext;
      final TransportContext              conContext;
<span class="udiff-line-added">+     private final ReentrantLock         engineLock = new ReentrantLock();</span>
  
      /**
       * Constructor for an SSLEngine from SSLContext, without
       * host/port hints.
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -91,61 +93,72 @@</span>
                              conContext.sslConfig.serverNames, host);
          }
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void beginHandshake() throws SSLException {</span>
<span class="udiff-line-modified-removed">-         if (conContext.isUnsureMode) {</span>
<span class="udiff-line-removed">-             throw new IllegalStateException(</span>
<span class="udiff-line-removed">-                     &quot;Client/Server mode has not yet been set.&quot;);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+     public void beginHandshake() throws SSLException {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
          try {
<span class="udiff-line-modified-removed">-             conContext.kickstart();</span>
<span class="udiff-line-modified-removed">-         } catch (IOException ioe) {</span>
<span class="udiff-line-modified-removed">-             throw conContext.fatal(Alert.HANDSHAKE_FAILURE,</span>
<span class="udiff-line-modified-removed">-                 &quot;Couldn&#39;t kickstart handshaking&quot;, ioe);</span>
<span class="udiff-line-modified-removed">-         } catch (Exception ex) {     // including RuntimeException</span>
<span class="udiff-line-modified-removed">-             throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-removed">-                 &quot;Fail to begin handshake&quot;, ex);</span>
<span class="udiff-line-modified-added">+             if (conContext.isUnsureMode) {</span>
<span class="udiff-line-modified-added">+                 throw new IllegalStateException(</span>
<span class="udiff-line-modified-added">+                         &quot;Client/Server mode has not yet been set.&quot;);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             try {</span>
<span class="udiff-line-modified-added">+                 conContext.kickstart();</span>
<span class="udiff-line-added">+             } catch (IOException ioe) {</span>
<span class="udiff-line-added">+                 throw conContext.fatal(Alert.HANDSHAKE_FAILURE,</span>
<span class="udiff-line-added">+                     &quot;Couldn&#39;t kickstart handshaking&quot;, ioe);</span>
<span class="udiff-line-added">+             } catch (Exception ex) {     // including RuntimeException</span>
<span class="udiff-line-added">+                 throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-added">+                     &quot;Fail to begin handshake&quot;, ex);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
          }
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized SSLEngineResult wrap(ByteBuffer[] appData,</span>
<span class="udiff-line-modified-added">+     public SSLEngineResult wrap(ByteBuffer[] appData,</span>
              int offset, int length, ByteBuffer netData) throws SSLException {
          return wrap(appData, offset, length, new ByteBuffer[]{ netData }, 0, 1);
      }
  
      // @Override
<span class="udiff-line-modified-removed">-     public synchronized SSLEngineResult wrap(</span>
<span class="udiff-line-modified-added">+     public SSLEngineResult wrap(</span>
          ByteBuffer[] srcs, int srcsOffset, int srcsLength,
          ByteBuffer[] dsts, int dstsOffset, int dstsLength) throws SSLException {
  
<span class="udiff-line-modified-removed">-         if (conContext.isUnsureMode) {</span>
<span class="udiff-line-modified-removed">-             throw new IllegalStateException(</span>
<span class="udiff-line-modified-removed">-                     &quot;Client/Server mode has not yet been set.&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             if (conContext.isUnsureMode) {</span>
<span class="udiff-line-modified-added">+                 throw new IllegalStateException(</span>
<span class="udiff-line-added">+                         &quot;Client/Server mode has not yet been set.&quot;);</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         // See if the handshaker needs to report back some SSLException.</span>
<span class="udiff-line-modified-removed">-         checkTaskThrown();</span>
<span class="udiff-line-modified-added">+             // See if the handshaker needs to report back some SSLException.</span>
<span class="udiff-line-modified-added">+             checkTaskThrown();</span>
  
<span class="udiff-line-modified-removed">-         // check parameters</span>
<span class="udiff-line-modified-removed">-         checkParams(srcs, srcsOffset, srcsLength, dsts, dstsOffset, dstsLength);</span>
<span class="udiff-line-modified-added">+             // check parameters</span>
<span class="udiff-line-modified-added">+             checkParams(srcs, srcsOffset, srcsLength,</span>
<span class="udiff-line-added">+                     dsts, dstsOffset, dstsLength);</span>
  
<span class="udiff-line-modified-removed">-         try {</span>
<span class="udiff-line-modified-removed">-             return writeRecord(</span>
<span class="udiff-line-modified-removed">-                 srcs, srcsOffset, srcsLength, dsts, dstsOffset, dstsLength);</span>
<span class="udiff-line-modified-removed">-         } catch (SSLProtocolException spe) {</span>
<span class="udiff-line-modified-removed">-             // may be an unexpected handshake message</span>
<span class="udiff-line-modified-removed">-             throw conContext.fatal(Alert.UNEXPECTED_MESSAGE, spe);</span>
<span class="udiff-line-modified-removed">-         } catch (IOException ioe) {</span>
<span class="udiff-line-modified-removed">-             throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-removed">-                 &quot;problem wrapping app data&quot;, ioe);</span>
<span class="udiff-line-modified-removed">-         } catch (Exception ex) {     // including RuntimeException</span>
<span class="udiff-line-modified-removed">-             throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-removed">-                 &quot;Fail to wrap application data&quot;, ex);</span>
<span class="udiff-line-modified-added">+             try {</span>
<span class="udiff-line-modified-added">+                 return writeRecord(</span>
<span class="udiff-line-modified-added">+                     srcs, srcsOffset, srcsLength, dsts, dstsOffset, dstsLength);</span>
<span class="udiff-line-modified-added">+             } catch (SSLProtocolException spe) {</span>
<span class="udiff-line-modified-added">+                 // may be an unexpected handshake message</span>
<span class="udiff-line-modified-added">+                 throw conContext.fatal(Alert.UNEXPECTED_MESSAGE, spe);</span>
<span class="udiff-line-modified-added">+             } catch (IOException ioe) {</span>
<span class="udiff-line-modified-added">+                 throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-added">+                     &quot;problem wrapping app data&quot;, ioe);</span>
<span class="udiff-line-modified-added">+             } catch (Exception ex) {     // including RuntimeException</span>
<span class="udiff-line-modified-added">+                 throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-added">+                     &quot;Fail to wrap application data&quot;, ex);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
          }
      }
  
      private SSLEngineResult writeRecord(
          ByteBuffer[] srcs, int srcsOffset, int srcsLength,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -329,10 +342,16 @@</span>
          if (conContext.outputRecord.seqNumIsHuge() ||
                  conContext.outputRecord.writeCipher.atKeyLimit()) {
              hsStatus = tryKeyUpdate(hsStatus);
          }
  
<span class="udiff-line-added">+         // Check if NewSessionTicket PostHandshake message needs to be sent</span>
<span class="udiff-line-added">+         if (conContext.conSession.updateNST &amp;&amp;</span>
<span class="udiff-line-added">+                 !conContext.sslConfig.isClientMode) {</span>
<span class="udiff-line-added">+             hsStatus = tryNewSessionTicket(hsStatus);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          // update context status
          ciphertext.handshakeStatus = hsStatus;
  
          return ciphertext;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -382,10 +401,33 @@</span>
          }
  
          return currentHandshakeStatus;
      }
  
<span class="udiff-line-added">+     // Try to generate a PostHandshake NewSessionTicket message.  This is</span>
<span class="udiff-line-added">+     // TLS 1.3 only.</span>
<span class="udiff-line-added">+     private HandshakeStatus tryNewSessionTicket(</span>
<span class="udiff-line-added">+             HandshakeStatus currentHandshakeStatus) throws IOException {</span>
<span class="udiff-line-added">+         // Don&#39;t bother to kickstart if handshaking is in progress, or if the</span>
<span class="udiff-line-added">+         // connection is not duplex-open.</span>
<span class="udiff-line-added">+         if ((conContext.handshakeContext == null) &amp;&amp;</span>
<span class="udiff-line-added">+                 conContext.protocolVersion.useTLS13PlusSpec() &amp;&amp;</span>
<span class="udiff-line-added">+                 !conContext.isOutboundClosed() &amp;&amp;</span>
<span class="udiff-line-added">+                 !conContext.isInboundClosed() &amp;&amp;</span>
<span class="udiff-line-added">+                 !conContext.isBroken) {</span>
<span class="udiff-line-added">+             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-added">+                 SSLLogger.finest(&quot;trigger NST&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             conContext.conSession.updateNST = false;</span>
<span class="udiff-line-added">+             NewSessionTicket.kickstartProducer.produce(</span>
<span class="udiff-line-added">+                     new PostHandshakeContext(conContext));</span>
<span class="udiff-line-added">+             return conContext.getHandshakeStatus();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return currentHandshakeStatus;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private static void checkParams(
              ByteBuffer[] srcs, int srcsOffset, int srcsLength,
              ByteBuffer[] dsts, int dstsOffset, int dstsLength) {
  
          if ((srcs == null) || (dsts == null)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -426,51 +468,57 @@</span>
              }
          }
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized SSLEngineResult unwrap(ByteBuffer src,</span>
<span class="udiff-line-modified-added">+     public SSLEngineResult unwrap(ByteBuffer src,</span>
              ByteBuffer[] dsts, int offset, int length) throws SSLException {
          return unwrap(
                  new ByteBuffer[]{src}, 0, 1, dsts, offset, length);
      }
  
      // @Override
<span class="udiff-line-modified-removed">-     public synchronized SSLEngineResult unwrap(</span>
<span class="udiff-line-modified-added">+     public SSLEngineResult unwrap(</span>
          ByteBuffer[] srcs, int srcsOffset, int srcsLength,
          ByteBuffer[] dsts, int dstsOffset, int dstsLength) throws SSLException {
  
<span class="udiff-line-modified-removed">-         if (conContext.isUnsureMode) {</span>
<span class="udiff-line-modified-removed">-             throw new IllegalStateException(</span>
<span class="udiff-line-modified-removed">-                     &quot;Client/Server mode has not yet been set.&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             if (conContext.isUnsureMode) {</span>
<span class="udiff-line-modified-added">+                 throw new IllegalStateException(</span>
<span class="udiff-line-added">+                         &quot;Client/Server mode has not yet been set.&quot;);</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         // See if the handshaker needs to report back some SSLException.</span>
<span class="udiff-line-modified-removed">-         checkTaskThrown();</span>
<span class="udiff-line-modified-added">+             // See if the handshaker needs to report back some SSLException.</span>
<span class="udiff-line-modified-added">+             checkTaskThrown();</span>
  
<span class="udiff-line-modified-removed">-         // check parameters</span>
<span class="udiff-line-modified-removed">-         checkParams(srcs, srcsOffset, srcsLength, dsts, dstsOffset, dstsLength);</span>
<span class="udiff-line-modified-added">+             // check parameters</span>
<span class="udiff-line-modified-added">+             checkParams(srcs, srcsOffset, srcsLength,</span>
<span class="udiff-line-added">+                     dsts, dstsOffset, dstsLength);</span>
  
<span class="udiff-line-modified-removed">-         try {</span>
<span class="udiff-line-modified-removed">-             return readRecord(</span>
<span class="udiff-line-modified-removed">-                 srcs, srcsOffset, srcsLength, dsts, dstsOffset, dstsLength);</span>
<span class="udiff-line-modified-removed">-         } catch (SSLProtocolException spe) {</span>
<span class="udiff-line-modified-removed">-             // may be an unexpected handshake message</span>
<span class="udiff-line-modified-removed">-             throw conContext.fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="udiff-line-modified-removed">-                     spe.getMessage(), spe);</span>
<span class="udiff-line-modified-removed">-         } catch (IOException ioe) {</span>
<span class="udiff-line-modified-removed">-             /*</span>
<span class="udiff-line-modified-removed">-              * Don&#39;t reset position so it looks like we didn&#39;t</span>
<span class="udiff-line-modified-removed">-              * consume anything.  We did consume something, and it</span>
<span class="udiff-line-modified-removed">-              * got us into this situation, so report that much back.</span>
<span class="udiff-line-modified-removed">-              * Our days of consuming are now over anyway.</span>
<span class="udiff-line-modified-removed">-              */</span>
<span class="udiff-line-modified-removed">-             throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-removed">-                     &quot;problem unwrapping net record&quot;, ioe);</span>
<span class="udiff-line-modified-removed">-         } catch (Exception ex) {     // including RuntimeException</span>
<span class="udiff-line-modified-removed">-             throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-removed">-                 &quot;Fail to unwrap network record&quot;, ex);</span>
<span class="udiff-line-modified-added">+             try {</span>
<span class="udiff-line-modified-added">+                 return readRecord(</span>
<span class="udiff-line-modified-added">+                     srcs, srcsOffset, srcsLength, dsts, dstsOffset, dstsLength);</span>
<span class="udiff-line-modified-added">+             } catch (SSLProtocolException spe) {</span>
<span class="udiff-line-modified-added">+                 // may be an unexpected handshake message</span>
<span class="udiff-line-modified-added">+                 throw conContext.fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="udiff-line-modified-added">+                         spe.getMessage(), spe);</span>
<span class="udiff-line-modified-added">+             } catch (IOException ioe) {</span>
<span class="udiff-line-modified-added">+                 /*</span>
<span class="udiff-line-modified-added">+                  * Don&#39;t reset position so it looks like we didn&#39;t</span>
<span class="udiff-line-modified-added">+                  * consume anything.  We did consume something, and it</span>
<span class="udiff-line-modified-added">+                  * got us into this situation, so report that much back.</span>
<span class="udiff-line-modified-added">+                  * Our days of consuming are now over anyway.</span>
<span class="udiff-line-modified-added">+                  */</span>
<span class="udiff-line-modified-added">+                 throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-added">+                         &quot;problem unwrapping net record&quot;, ioe);</span>
<span class="udiff-line-modified-added">+             } catch (Exception ex) {     // including RuntimeException</span>
<span class="udiff-line-modified-added">+                 throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-added">+                     &quot;Fail to unwrap network record&quot;, ex);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
          }
      }
  
      private SSLEngineResult readRecord(
          ByteBuffer[] srcs, int srcsOffset, int srcsLength,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -701,203 +749,334 @@</span>
  
          return pt;
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized Runnable getDelegatedTask() {</span>
<span class="udiff-line-modified-removed">-         if (conContext.handshakeContext != null &amp;&amp; // PRE or POST handshake</span>
<span class="udiff-line-modified-removed">-                 !conContext.handshakeContext.taskDelegated &amp;&amp;</span>
<span class="udiff-line-modified-removed">-                 !conContext.handshakeContext.delegatedActions.isEmpty()) {</span>
<span class="udiff-line-modified-removed">-             conContext.handshakeContext.taskDelegated = true;</span>
<span class="udiff-line-modified-removed">-             return new DelegatedTask(this);</span>
<span class="udiff-line-modified-added">+     public Runnable getDelegatedTask() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             if (conContext.handshakeContext != null &amp;&amp; // PRE or POST handshake</span>
<span class="udiff-line-modified-added">+                     !conContext.handshakeContext.taskDelegated &amp;&amp;</span>
<span class="udiff-line-modified-added">+                     !conContext.handshakeContext.delegatedActions.isEmpty()) {</span>
<span class="udiff-line-added">+                 conContext.handshakeContext.taskDelegated = true;</span>
<span class="udiff-line-added">+                 return new DelegatedTask(this);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
          }
  
          return null;
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void closeInbound() throws SSLException {</span>
<span class="udiff-line-modified-removed">-         if (isInboundDone()) {</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     public void closeInbound() throws SSLException {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             if (isInboundDone()) {</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-removed">-             SSLLogger.finest(&quot;Closing inbound of SSLEngine&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-added">+                 SSLLogger.finest(&quot;Closing inbound of SSLEngine&quot;);</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         // Is it ready to close inbound?</span>
<span class="udiff-line-modified-removed">-         //</span>
<span class="udiff-line-modified-removed">-         // No need to throw exception if the initial handshake is not started.</span>
<span class="udiff-line-modified-removed">-         if (!conContext.isInputCloseNotified &amp;&amp;</span>
<span class="udiff-line-modified-removed">-             (conContext.isNegotiated || conContext.handshakeContext != null)) {</span>
<span class="udiff-line-modified-added">+             // Is it ready to close inbound?</span>
<span class="udiff-line-modified-added">+             //</span>
<span class="udiff-line-modified-added">+             // No exception if the initial handshake is not started.</span>
<span class="udiff-line-modified-added">+             if (!conContext.isInputCloseNotified &amp;&amp;</span>
<span class="udiff-line-modified-added">+                 (conContext.isNegotiated ||</span>
<span class="udiff-line-added">+                     conContext.handshakeContext != null)) {</span>
  
<span class="udiff-line-modified-removed">-             throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-removed">-                     &quot;closing inbound before receiving peer&#39;s close_notify&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+                 throw conContext.fatal(Alert.INTERNAL_ERROR,</span>
<span class="udiff-line-modified-added">+                         &quot;closing inbound before receiving peer&#39;s close_notify&quot;);</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         conContext.closeInbound();</span>
<span class="udiff-line-modified-added">+             conContext.closeInbound();</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized boolean isInboundDone() {</span>
<span class="udiff-line-modified-removed">-         return conContext.isInboundClosed();</span>
<span class="udiff-line-modified-added">+     public boolean isInboundDone() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.isInboundClosed();</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void closeOutbound() {</span>
<span class="udiff-line-modified-removed">-         if (conContext.isOutboundClosed()) {</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     public void closeOutbound() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             if (conContext.isOutboundClosed()) {</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-removed">-             SSLLogger.finest(&quot;Closing outbound of SSLEngine&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+             if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-modified-added">+                 SSLLogger.finest(&quot;Closing outbound of SSLEngine&quot;);</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         conContext.closeOutbound();</span>
<span class="udiff-line-modified-added">+             conContext.closeOutbound();</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized boolean isOutboundDone() {</span>
<span class="udiff-line-modified-removed">-         return conContext.isOutboundDone();</span>
<span class="udiff-line-modified-added">+     public boolean isOutboundDone() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.isOutboundDone();</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
      public String[] getSupportedCipherSuites() {
          return CipherSuite.namesOf(sslContext.getSupportedCipherSuites());
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized String[] getEnabledCipherSuites() {</span>
<span class="udiff-line-modified-removed">-         return CipherSuite.namesOf(conContext.sslConfig.enabledCipherSuites);</span>
<span class="udiff-line-modified-added">+     public String[] getEnabledCipherSuites() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return CipherSuite.namesOf(conContext.sslConfig.enabledCipherSuites);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void setEnabledCipherSuites(String[] suites) {</span>
<span class="udiff-line-modified-removed">-         conContext.sslConfig.enabledCipherSuites =</span>
<span class="udiff-line-modified-removed">-                 CipherSuite.validValuesOf(suites);</span>
<span class="udiff-line-modified-added">+     public void setEnabledCipherSuites(String[] suites) {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-added">+             conContext.sslConfig.enabledCipherSuites =</span>
<span class="udiff-line-added">+                     CipherSuite.validValuesOf(suites);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
      public String[] getSupportedProtocols() {
          return ProtocolVersion.toStringArray(
                  sslContext.getSupportedProtocolVersions());
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized String[] getEnabledProtocols() {</span>
<span class="udiff-line-modified-removed">-         return ProtocolVersion.toStringArray(</span>
<span class="udiff-line-modified-removed">-                 conContext.sslConfig.enabledProtocols);</span>
<span class="udiff-line-modified-added">+     public String[] getEnabledProtocols() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-added">+             return ProtocolVersion.toStringArray(</span>
<span class="udiff-line-added">+                     conContext.sslConfig.enabledProtocols);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void setEnabledProtocols(String[] protocols) {</span>
<span class="udiff-line-modified-removed">-         if (protocols == null) {</span>
<span class="udiff-line-modified-removed">-             throw new IllegalArgumentException(&quot;Protocols cannot be null&quot;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     public void setEnabledProtocols(String[] protocols) {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             if (protocols == null) {</span>
<span class="udiff-line-added">+                 throw new IllegalArgumentException(&quot;Protocols cannot be null&quot;);</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         conContext.sslConfig.enabledProtocols =</span>
<span class="udiff-line-modified-removed">-                 ProtocolVersion.namesOf(protocols);</span>
<span class="udiff-line-modified-added">+             conContext.sslConfig.enabledProtocols =</span>
<span class="udiff-line-modified-added">+                     ProtocolVersion.namesOf(protocols);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized SSLSession getSession() {</span>
<span class="udiff-line-modified-removed">-         return conContext.conSession;</span>
<span class="udiff-line-modified-added">+     public SSLSession getSession() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.conSession;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized SSLSession getHandshakeSession() {</span>
<span class="udiff-line-modified-removed">-         return conContext.handshakeContext == null ?</span>
<span class="udiff-line-modified-removed">-                 null : conContext.handshakeContext.handshakeSession;</span>
<span class="udiff-line-modified-added">+     public SSLSession getHandshakeSession() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.handshakeContext == null ?</span>
<span class="udiff-line-added">+                     null : conContext.handshakeContext.handshakeSession;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized SSLEngineResult.HandshakeStatus getHandshakeStatus() {</span>
<span class="udiff-line-modified-removed">-         return conContext.getHandshakeStatus();</span>
<span class="udiff-line-modified-added">+     public SSLEngineResult.HandshakeStatus getHandshakeStatus() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.getHandshakeStatus();</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void setUseClientMode(boolean mode) {</span>
<span class="udiff-line-modified-removed">-         conContext.setUseClientMode(mode);</span>
<span class="udiff-line-modified-added">+     public void setUseClientMode(boolean mode) {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             conContext.setUseClientMode(mode);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized boolean getUseClientMode() {</span>
<span class="udiff-line-modified-removed">-         return conContext.sslConfig.isClientMode;</span>
<span class="udiff-line-modified-added">+     public boolean getUseClientMode() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.sslConfig.isClientMode;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void setNeedClientAuth(boolean need) {</span>
<span class="udiff-line-modified-removed">-         conContext.sslConfig.clientAuthType =</span>
<span class="udiff-line-modified-removed">-                 (need ? ClientAuthType.CLIENT_AUTH_REQUIRED :</span>
<span class="udiff-line-modified-removed">-                         ClientAuthType.CLIENT_AUTH_NONE);</span>
<span class="udiff-line-modified-added">+     public void setNeedClientAuth(boolean need) {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             conContext.sslConfig.clientAuthType =</span>
<span class="udiff-line-added">+                     (need ? ClientAuthType.CLIENT_AUTH_REQUIRED :</span>
<span class="udiff-line-added">+                             ClientAuthType.CLIENT_AUTH_NONE);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized boolean getNeedClientAuth() {</span>
<span class="udiff-line-modified-removed">-         return (conContext.sslConfig.clientAuthType ==</span>
<span class="udiff-line-modified-removed">-                         ClientAuthType.CLIENT_AUTH_REQUIRED);</span>
<span class="udiff-line-modified-added">+     public boolean getNeedClientAuth() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-added">+             return (conContext.sslConfig.clientAuthType ==</span>
<span class="udiff-line-added">+                             ClientAuthType.CLIENT_AUTH_REQUIRED);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void setWantClientAuth(boolean want) {</span>
<span class="udiff-line-modified-removed">-         conContext.sslConfig.clientAuthType =</span>
<span class="udiff-line-modified-removed">-                 (want ? ClientAuthType.CLIENT_AUTH_REQUESTED :</span>
<span class="udiff-line-modified-removed">-                         ClientAuthType.CLIENT_AUTH_NONE);</span>
<span class="udiff-line-modified-added">+     public void setWantClientAuth(boolean want) {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             conContext.sslConfig.clientAuthType =</span>
<span class="udiff-line-added">+                     (want ? ClientAuthType.CLIENT_AUTH_REQUESTED :</span>
<span class="udiff-line-added">+                             ClientAuthType.CLIENT_AUTH_NONE);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized boolean getWantClientAuth() {</span>
<span class="udiff-line-modified-removed">-         return (conContext.sslConfig.clientAuthType ==</span>
<span class="udiff-line-modified-removed">-                         ClientAuthType.CLIENT_AUTH_REQUESTED);</span>
<span class="udiff-line-modified-added">+     public boolean getWantClientAuth() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-added">+             return (conContext.sslConfig.clientAuthType ==</span>
<span class="udiff-line-added">+                             ClientAuthType.CLIENT_AUTH_REQUESTED);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void setEnableSessionCreation(boolean flag) {</span>
<span class="udiff-line-modified-removed">-         conContext.sslConfig.enableSessionCreation = flag;</span>
<span class="udiff-line-modified-added">+     public void setEnableSessionCreation(boolean flag) {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             conContext.sslConfig.enableSessionCreation = flag;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized boolean getEnableSessionCreation() {</span>
<span class="udiff-line-modified-removed">-         return conContext.sslConfig.enableSessionCreation;</span>
<span class="udiff-line-modified-added">+     public boolean getEnableSessionCreation() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.sslConfig.enableSessionCreation;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized SSLParameters getSSLParameters() {</span>
<span class="udiff-line-modified-removed">-         return conContext.sslConfig.getSSLParameters();</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     public SSLParameters getSSLParameters() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.sslConfig.getSSLParameters();</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+    }</span>
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void setSSLParameters(SSLParameters params) {</span>
<span class="udiff-line-modified-removed">-         conContext.sslConfig.setSSLParameters(params);</span>
<span class="udiff-line-modified-added">+     public void setSSLParameters(SSLParameters params) {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             conContext.sslConfig.setSSLParameters(params);</span>
  
<span class="udiff-line-modified-removed">-         if (conContext.sslConfig.maximumPacketSize != 0) {</span>
<span class="udiff-line-modified-removed">-             conContext.outputRecord.changePacketSize(</span>
<span class="udiff-line-modified-removed">-                     conContext.sslConfig.maximumPacketSize);</span>
<span class="udiff-line-modified-added">+             if (conContext.sslConfig.maximumPacketSize != 0) {</span>
<span class="udiff-line-modified-added">+                 conContext.outputRecord.changePacketSize(</span>
<span class="udiff-line-modified-added">+                         conContext.sslConfig.maximumPacketSize);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
          }
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+    }</span>
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized String getApplicationProtocol() {</span>
<span class="udiff-line-modified-removed">-         return conContext.applicationProtocol;</span>
<span class="udiff-line-modified-added">+     public String getApplicationProtocol() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.applicationProtocol;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized String getHandshakeApplicationProtocol() {</span>
<span class="udiff-line-modified-removed">-         return conContext.handshakeContext == null ?</span>
<span class="udiff-line-modified-removed">-                 null : conContext.handshakeContext.applicationProtocol;</span>
<span class="udiff-line-modified-added">+     public String getHandshakeApplicationProtocol() {</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.handshakeContext == null ?</span>
<span class="udiff-line-added">+                     null : conContext.handshakeContext.applicationProtocol;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized void setHandshakeApplicationProtocolSelector(</span>
<span class="udiff-line-modified-added">+     public void setHandshakeApplicationProtocolSelector(</span>
              BiFunction&lt;SSLEngine, List&lt;String&gt;, String&gt; selector) {
<span class="udiff-line-modified-removed">-         conContext.sslConfig.engineAPSelector = selector;</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             conContext.sslConfig.engineAPSelector = selector;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public synchronized BiFunction&lt;SSLEngine, List&lt;String&gt;, String&gt;</span>
<span class="udiff-line-modified-added">+     public BiFunction&lt;SSLEngine, List&lt;String&gt;, String&gt;</span>
              getHandshakeApplicationProtocolSelector() {
<span class="udiff-line-modified-removed">-         return conContext.sslConfig.engineAPSelector;</span>
<span class="udiff-line-modified-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return conContext.sslConfig.engineAPSelector;</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
      public boolean useDelegatedTask() {
          return true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -907,42 +1086,46 @@</span>
       * Depending on whether the error was just a warning and the
       * handshaker wasn&#39;t closed, or fatal and the handshaker is now
       * null, report back the Exception that happened in the delegated
       * task(s).
       */
<span class="udiff-line-modified-removed">-     private synchronized void checkTaskThrown() throws SSLException {</span>
<span class="udiff-line-modified-added">+     private void checkTaskThrown() throws SSLException {</span>
  
          Exception exc = null;
<span class="udiff-line-added">+         engineLock.lock();</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             // First check the handshake context.</span>
<span class="udiff-line-added">+             HandshakeContext hc = conContext.handshakeContext;</span>
<span class="udiff-line-added">+             if ((hc != null) &amp;&amp; (hc.delegatedThrown != null)) {</span>
<span class="udiff-line-added">+                 exc = hc.delegatedThrown;</span>
<span class="udiff-line-added">+                 hc.delegatedThrown = null;</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         // First check the handshake context.</span>
<span class="udiff-line-modified-removed">-         HandshakeContext hc = conContext.handshakeContext;</span>
<span class="udiff-line-modified-removed">-         if ((hc != null) &amp;&amp; (hc.delegatedThrown != null)) {</span>
<span class="udiff-line-modified-removed">-             exc = hc.delegatedThrown;</span>
<span class="udiff-line-modified-removed">-             hc.delegatedThrown = null;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         /*</span>
<span class="udiff-line-modified-removed">-          * hc.delegatedThrown and conContext.delegatedThrown are most likely</span>
<span class="udiff-line-modified-removed">-          * the same, but it&#39;s possible we could have had a non-fatal</span>
<span class="udiff-line-modified-removed">-          * exception and thus the new HandshakeContext is still valid</span>
<span class="udiff-line-modified-removed">-          * (alert warning).  If so, then we may have a secondary exception</span>
<span class="udiff-line-modified-removed">-          * waiting to be reported from the TransportContext, so we will</span>
<span class="udiff-line-modified-removed">-          * need to clear that on a successive call.  Otherwise, clear it now.</span>
<span class="udiff-line-modified-removed">-          */</span>
<span class="udiff-line-modified-removed">-         if (conContext.delegatedThrown != null) {</span>
<span class="udiff-line-modified-removed">-             if (exc != null) {</span>
<span class="udiff-line-modified-removed">-                 // hc object comparison</span>
<span class="udiff-line-modified-removed">-                 if (conContext.delegatedThrown == exc) {</span>
<span class="udiff-line-removed">-                     // clear if/only if both are the same</span>
<span class="udiff-line-modified-added">+             /*</span>
<span class="udiff-line-modified-added">+              * hc.delegatedThrown and conContext.delegatedThrown are most</span>
<span class="udiff-line-modified-added">+              * likely the same, but it&#39;s possible we could have had a non-fatal</span>
<span class="udiff-line-modified-added">+              * exception and thus the new HandshakeContext is still valid</span>
<span class="udiff-line-modified-added">+              * (alert warning).  If so, then we may have a secondary exception</span>
<span class="udiff-line-modified-added">+              * waiting to be reported from the TransportContext, so we will</span>
<span class="udiff-line-modified-added">+              * need to clear that on a successive call. Otherwise, clear it now.</span>
<span class="udiff-line-modified-added">+              */</span>
<span class="udiff-line-modified-added">+             if (conContext.delegatedThrown != null) {</span>
<span class="udiff-line-modified-added">+                 if (exc != null) {</span>
<span class="udiff-line-modified-added">+                     // hc object comparison</span>
<span class="udiff-line-modified-added">+                     if (conContext.delegatedThrown == exc) {</span>
<span class="udiff-line-modified-added">+                         // clear if/only if both are the same</span>
<span class="udiff-line-modified-added">+                         conContext.delegatedThrown = null;</span>
<span class="udiff-line-modified-added">+                     } // otherwise report the hc delegatedThrown</span>
<span class="udiff-line-modified-added">+                 } else {</span>
<span class="udiff-line-modified-added">+                     // Nothing waiting in HandshakeContext, but one is in the</span>
<span class="udiff-line-modified-added">+                     // TransportContext.</span>
<span class="udiff-line-modified-added">+                     exc = conContext.delegatedThrown;</span>
                      conContext.delegatedThrown = null;
<span class="udiff-line-modified-removed">-                 } // otherwise report the hc delegatedThrown</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 // Nothing waiting in HandshakeContext, but one is in the</span>
<span class="udiff-line-removed">-                 // TransportContext.</span>
<span class="udiff-line-removed">-                 exc = conContext.delegatedThrown;</span>
<span class="udiff-line-removed">-                 conContext.delegatedThrown = null;</span>
<span class="udiff-line-modified-added">+                 }</span>
              }
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             engineLock.unlock();</span>
          }
  
          // Anything to report?
          if (exc == null) {
              return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -996,11 +1179,12 @@</span>
              this.engine = engineInstance;
          }
  
          @Override
          public void run() {
<span class="udiff-line-modified-removed">-             synchronized (engine) {</span>
<span class="udiff-line-modified-added">+             engine.engineLock.lock();</span>
<span class="udiff-line-added">+             try {</span>
                  HandshakeContext hc = engine.conContext.handshakeContext;
                  if (hc == null || hc.delegatedActions.isEmpty()) {
                      return;
                  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1053,10 +1237,12 @@</span>
                  // handshaking has completed.
                  hc = engine.conContext.handshakeContext;
                  if (hc != null) {
                      hc.taskDelegated = false;
                  }
<span class="udiff-line-added">+             } finally {</span>
<span class="udiff-line-added">+                 engine.engineLock.unlock();</span>
              }
          }
  
          private static class DelegatedAction
                  implements PrivilegedExceptionAction&lt;Void&gt; {
</pre>
<center><a href="SSLContextImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SSLEngineInputRecord.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>