<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/classes/sun/nio/ch/SocketAdaptor.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.nio.ch;
 27 
 28 import java.io.IOException;
 29 import java.io.InputStream;
 30 import java.io.OutputStream;
 31 import java.net.InetAddress;
 32 import java.net.InetSocketAddress;
 33 import java.net.Socket;
 34 import java.net.SocketAddress;
 35 import java.net.SocketException;
<a name="2" id="anc2"></a>
 36 import java.net.SocketOption;
<a name="3" id="anc3"></a>
 37 import java.net.StandardSocketOptions;
<a name="4" id="anc4"></a>



 38 import java.nio.channels.SocketChannel;
 39 import java.security.AccessController;
<a name="5" id="anc5"></a><span class="line-added"> 40 import java.security.PrivilegedActionException;</span>
 41 import java.security.PrivilegedExceptionAction;
<a name="6" id="anc6"></a><span class="line-modified"> 42 import java.util.Set;</span>
<span class="line-added"> 43 </span>
<span class="line-added"> 44 import static java.util.concurrent.TimeUnit.MILLISECONDS;</span>
 45 
 46 // Make a socket channel look like a socket.
 47 //
 48 // The methods in this class are defined in exactly the same order as in
 49 // java.net.Socket so as to simplify tracking future changes to that class.
 50 //
 51 
 52 class SocketAdaptor
 53     extends Socket
 54 {
 55     // The channel being adapted
 56     private final SocketChannelImpl sc;
 57 
 58     // Timeout &quot;option&quot; value for reads
 59     private volatile int timeout;
 60 
 61     private SocketAdaptor(SocketChannelImpl sc) throws SocketException {
<a name="7" id="anc7"></a><span class="line-modified"> 62         super(DummySocketImpl.create());</span>
 63         this.sc = sc;
 64     }
 65 
<a name="8" id="anc8"></a><span class="line-modified"> 66     static Socket create(SocketChannelImpl sc) {</span>
<span class="line-added"> 67         PrivilegedExceptionAction&lt;Socket&gt; pa = () -&gt; new SocketAdaptor(sc);</span>
 68         try {
<a name="9" id="anc9"></a><span class="line-modified"> 69             return AccessController.doPrivileged(pa);</span>
<span class="line-modified"> 70         } catch (PrivilegedActionException pae) {</span>
<span class="line-modified"> 71             throw new InternalError(&quot;Should not reach here&quot;, pae);</span>
 72         }
 73     }
 74 
<a name="10" id="anc10"></a><span class="line-modified"> 75     @Override</span>





 76     public void connect(SocketAddress remote) throws IOException {
 77         connect(remote, 0);
 78     }
 79 
<a name="11" id="anc11"></a><span class="line-added"> 80     @Override</span>
 81     public void connect(SocketAddress remote, int timeout) throws IOException {
 82         if (remote == null)
 83             throw new IllegalArgumentException(&quot;connect: The address can&#39;t be null&quot;);
 84         if (timeout &lt; 0)
 85             throw new IllegalArgumentException(&quot;connect: timeout can&#39;t be negative&quot;);
<a name="12" id="anc12"></a><span class="line-modified"> 86         try {</span>
<span class="line-modified"> 87             if (timeout &gt; 0) {</span>
<span class="line-modified"> 88                 long nanos = MILLISECONDS.toNanos(timeout);</span>
<span class="line-modified"> 89                 sc.blockingConnect(remote, nanos);</span>
<span class="line-modified"> 90             } else {</span>
<span class="line-modified"> 91                 sc.blockingConnect(remote, Long.MAX_VALUE);</span>






































 92             }
<a name="13" id="anc13"></a><span class="line-added"> 93         } catch (Exception e) {</span>
<span class="line-added"> 94             Net.translateException(e, true);</span>
 95         }
<a name="14" id="anc14"></a>
 96     }
 97 
<a name="15" id="anc15"></a><span class="line-added"> 98     @Override</span>
 99     public void bind(SocketAddress local) throws IOException {
100         try {
101             sc.bind(local);
102         } catch (Exception x) {
103             Net.translateException(x);
104         }
105     }
106 
<a name="16" id="anc16"></a><span class="line-added">107     @Override</span>
108     public InetAddress getInetAddress() {
109         InetSocketAddress remote = sc.remoteAddress();
110         if (remote == null) {
111             return null;
112         } else {
113             return remote.getAddress();
114         }
115     }
116 
<a name="17" id="anc17"></a><span class="line-added">117     @Override</span>
118     public InetAddress getLocalAddress() {
119         if (sc.isOpen()) {
120             InetSocketAddress local = sc.localAddress();
121             if (local != null) {
122                 return Net.getRevealedLocalAddress(local).getAddress();
123             }
124         }
125         return new InetSocketAddress(0).getAddress();
126     }
127 
<a name="18" id="anc18"></a><span class="line-added">128     @Override</span>
129     public int getPort() {
130         InetSocketAddress remote = sc.remoteAddress();
131         if (remote == null) {
132             return 0;
133         } else {
134             return remote.getPort();
135         }
136     }
137 
<a name="19" id="anc19"></a><span class="line-added">138     @Override</span>
139     public int getLocalPort() {
140         InetSocketAddress local = sc.localAddress();
141         if (local == null) {
142             return -1;
143         } else {
144             return local.getPort();
145         }
146     }
147 
<a name="20" id="anc20"></a><span class="line-modified">148     @Override</span>
<span class="line-modified">149     public SocketAddress getRemoteSocketAddress() {</span>
<span class="line-modified">150         return sc.remoteAddress();</span>
<span class="line-modified">151     }</span>


152 
<a name="21" id="anc21"></a><span class="line-modified">153     @Override</span>
<span class="line-modified">154     public SocketAddress getLocalSocketAddress() {</span>
<span class="line-modified">155         InetSocketAddress local = sc.localAddress();</span>
<span class="line-modified">156         if (local != null) {</span>
<span class="line-modified">157             return Net.getRevealedLocalAddress(local);</span>
<span class="line-modified">158         } else {</span>
<span class="line-modified">159             return null;</span>


















160         }
161     }
162 
<a name="22" id="anc22"></a><span class="line-modified">163     @Override</span>
<span class="line-added">164     public SocketChannel getChannel() {</span>
<span class="line-added">165         return sc;</span>
<span class="line-added">166     }</span>
167 
<a name="23" id="anc23"></a><span class="line-added">168     @Override</span>
169     public InputStream getInputStream() throws IOException {
170         if (!sc.isOpen())
171             throw new SocketException(&quot;Socket is closed&quot;);
172         if (!sc.isConnected())
173             throw new SocketException(&quot;Socket is not connected&quot;);
174         if (!sc.isInputOpen())
175             throw new SocketException(&quot;Socket input is shutdown&quot;);
<a name="24" id="anc24"></a><span class="line-modified">176         return new InputStream() {</span>
<span class="line-modified">177             @Override</span>
<span class="line-modified">178             public int read() throws IOException {</span>
<span class="line-modified">179                 byte[] a = new byte[1];</span>
<span class="line-modified">180                 int n = read(a, 0, 1);</span>
<span class="line-modified">181                 return (n &gt; 0) ? (a[0] &amp; 0xff) : -1;</span>




182             }
<a name="25" id="anc25"></a><span class="line-modified">183             @Override</span>
<span class="line-modified">184             public int read(byte[] b, int off, int len) throws IOException {</span>
<span class="line-added">185                 int timeout = SocketAdaptor.this.timeout;</span>
<span class="line-added">186                 if (timeout &gt; 0) {</span>
<span class="line-added">187                     long nanos = MILLISECONDS.toNanos(timeout);</span>
<span class="line-added">188                     return sc.blockingRead(b, off, len, nanos);</span>
<span class="line-added">189                 } else {</span>
<span class="line-added">190                     return sc.blockingRead(b, off, len, 0);</span>
<span class="line-added">191                 }</span>
<span class="line-added">192             }</span>
<span class="line-added">193             @Override</span>
<span class="line-added">194             public int available() throws IOException {</span>
<span class="line-added">195                 return sc.available();</span>
<span class="line-added">196             }</span>
<span class="line-added">197             @Override</span>
<span class="line-added">198             public void close() throws IOException {</span>
<span class="line-added">199                 sc.close();</span>
<span class="line-added">200             }</span>
<span class="line-added">201         };</span>
202     }
203 
<a name="26" id="anc26"></a><span class="line-added">204     @Override</span>
205     public OutputStream getOutputStream() throws IOException {
206         if (!sc.isOpen())
207             throw new SocketException(&quot;Socket is closed&quot;);
208         if (!sc.isConnected())
209             throw new SocketException(&quot;Socket is not connected&quot;);
210         if (!sc.isOutputOpen())
211             throw new SocketException(&quot;Socket output is shutdown&quot;);
<a name="27" id="anc27"></a><span class="line-modified">212         return new OutputStream() {</span>
<span class="line-modified">213             @Override</span>
<span class="line-modified">214             public void write(int b) throws IOException {</span>
<span class="line-modified">215                 byte[] a = new byte[]{(byte) b};</span>
<span class="line-modified">216                 write(a, 0, 1);</span>
<span class="line-modified">217             }</span>
<span class="line-modified">218             @Override</span>
<span class="line-modified">219             public void write(byte[] b, int off, int len) throws IOException {</span>
<span class="line-modified">220                 sc.blockingWriteFully(b, off, len);</span>
<span class="line-modified">221             }</span>
<span class="line-modified">222             @Override</span>
<span class="line-modified">223             public void close() throws IOException {</span>
<span class="line-added">224                 sc.close();</span>
<span class="line-added">225             }</span>
<span class="line-added">226         };</span>
227     }
228 
229     private void setBooleanOption(SocketOption&lt;Boolean&gt; name, boolean value)
230         throws SocketException
231     {
232         try {
233             sc.setOption(name, value);
234         } catch (IOException x) {
235             Net.translateToSocketException(x);
236         }
237     }
238 
239     private void setIntOption(SocketOption&lt;Integer&gt; name, int value)
240         throws SocketException
241     {
242         try {
243             sc.setOption(name, value);
244         } catch (IOException x) {
245             Net.translateToSocketException(x);
246         }
247     }
248 
249     private boolean getBooleanOption(SocketOption&lt;Boolean&gt; name) throws SocketException {
250         try {
251             return sc.getOption(name).booleanValue();
252         } catch (IOException x) {
253             Net.translateToSocketException(x);
254             return false;       // keep compiler happy
255         }
256     }
257 
258     private int getIntOption(SocketOption&lt;Integer&gt; name) throws SocketException {
259         try {
260             return sc.getOption(name).intValue();
261         } catch (IOException x) {
262             Net.translateToSocketException(x);
263             return -1;          // keep compiler happy
264         }
265     }
266 
<a name="28" id="anc28"></a><span class="line-added">267     @Override</span>
268     public void setTcpNoDelay(boolean on) throws SocketException {
269         setBooleanOption(StandardSocketOptions.TCP_NODELAY, on);
270     }
271 
<a name="29" id="anc29"></a><span class="line-added">272     @Override</span>
273     public boolean getTcpNoDelay() throws SocketException {
274         return getBooleanOption(StandardSocketOptions.TCP_NODELAY);
275     }
276 
<a name="30" id="anc30"></a><span class="line-added">277     @Override</span>
278     public void setSoLinger(boolean on, int linger) throws SocketException {
279         if (!on)
280             linger = -1;
281         setIntOption(StandardSocketOptions.SO_LINGER, linger);
282     }
283 
<a name="31" id="anc31"></a><span class="line-added">284     @Override</span>
285     public int getSoLinger() throws SocketException {
286         return getIntOption(StandardSocketOptions.SO_LINGER);
287     }
288 
<a name="32" id="anc32"></a><span class="line-added">289     @Override</span>
290     public void sendUrgentData(int data) throws IOException {
291         int n = sc.sendOutOfBandData((byte) data);
292         if (n == 0)
293             throw new IOException(&quot;Socket buffer full&quot;);
294     }
295 
<a name="33" id="anc33"></a><span class="line-added">296     @Override</span>
297     public void setOOBInline(boolean on) throws SocketException {
298         setBooleanOption(ExtendedSocketOption.SO_OOBINLINE, on);
299     }
300 
<a name="34" id="anc34"></a><span class="line-added">301     @Override</span>
302     public boolean getOOBInline() throws SocketException {
303         return getBooleanOption(ExtendedSocketOption.SO_OOBINLINE);
304     }
305 
<a name="35" id="anc35"></a><span class="line-added">306     @Override</span>
307     public void setSoTimeout(int timeout) throws SocketException {
<a name="36" id="anc36"></a><span class="line-added">308         if (!sc.isOpen())</span>
<span class="line-added">309             throw new SocketException(&quot;Socket is closed&quot;);</span>
310         if (timeout &lt; 0)
<a name="37" id="anc37"></a><span class="line-modified">311             throw new IllegalArgumentException(&quot;timeout &lt; 0&quot;);</span>
312         this.timeout = timeout;
313     }
314 
<a name="38" id="anc38"></a><span class="line-added">315     @Override</span>
316     public int getSoTimeout() throws SocketException {
<a name="39" id="anc39"></a><span class="line-added">317         if (!sc.isOpen())</span>
<span class="line-added">318             throw new SocketException(&quot;Socket is closed&quot;);</span>
319         return timeout;
320     }
321 
<a name="40" id="anc40"></a><span class="line-added">322     @Override</span>
323     public void setSendBufferSize(int size) throws SocketException {
324         // size 0 valid for SocketChannel, invalid for Socket
325         if (size &lt;= 0)
326             throw new IllegalArgumentException(&quot;Invalid send size&quot;);
327         setIntOption(StandardSocketOptions.SO_SNDBUF, size);
328     }
329 
<a name="41" id="anc41"></a><span class="line-added">330     @Override</span>
331     public int getSendBufferSize() throws SocketException {
332         return getIntOption(StandardSocketOptions.SO_SNDBUF);
333     }
334 
<a name="42" id="anc42"></a><span class="line-added">335     @Override</span>
336     public void setReceiveBufferSize(int size) throws SocketException {
337         // size 0 valid for SocketChannel, invalid for Socket
338         if (size &lt;= 0)
339             throw new IllegalArgumentException(&quot;Invalid receive size&quot;);
340         setIntOption(StandardSocketOptions.SO_RCVBUF, size);
341     }
342 
<a name="43" id="anc43"></a><span class="line-added">343     @Override</span>
344     public int getReceiveBufferSize() throws SocketException {
345         return getIntOption(StandardSocketOptions.SO_RCVBUF);
346     }
347 
<a name="44" id="anc44"></a><span class="line-added">348     @Override</span>
349     public void setKeepAlive(boolean on) throws SocketException {
350         setBooleanOption(StandardSocketOptions.SO_KEEPALIVE, on);
351     }
352 
<a name="45" id="anc45"></a><span class="line-added">353     @Override</span>
354     public boolean getKeepAlive() throws SocketException {
355         return getBooleanOption(StandardSocketOptions.SO_KEEPALIVE);
356     }
357 
<a name="46" id="anc46"></a><span class="line-added">358     @Override</span>
359     public void setTrafficClass(int tc) throws SocketException {
360         setIntOption(StandardSocketOptions.IP_TOS, tc);
361     }
362 
<a name="47" id="anc47"></a><span class="line-added">363     @Override</span>
364     public int getTrafficClass() throws SocketException {
365         return getIntOption(StandardSocketOptions.IP_TOS);
366     }
367 
<a name="48" id="anc48"></a><span class="line-added">368     @Override</span>
369     public void setReuseAddress(boolean on) throws SocketException {
370         setBooleanOption(StandardSocketOptions.SO_REUSEADDR, on);
371     }
372 
<a name="49" id="anc49"></a><span class="line-added">373     @Override</span>
374     public boolean getReuseAddress() throws SocketException {
375         return getBooleanOption(StandardSocketOptions.SO_REUSEADDR);
376     }
377 
<a name="50" id="anc50"></a><span class="line-added">378     @Override</span>
379     public void close() throws IOException {
380         sc.close();
381     }
382 
<a name="51" id="anc51"></a><span class="line-added">383     @Override</span>
384     public void shutdownInput() throws IOException {
385         try {
386             sc.shutdownInput();
387         } catch (Exception x) {
388             Net.translateException(x);
389         }
390     }
391 
<a name="52" id="anc52"></a><span class="line-added">392     @Override</span>
393     public void shutdownOutput() throws IOException {
394         try {
395             sc.shutdownOutput();
396         } catch (Exception x) {
397             Net.translateException(x);
398         }
399     }
400 
<a name="53" id="anc53"></a><span class="line-added">401     @Override</span>
402     public String toString() {
403         if (sc.isConnected())
404             return &quot;Socket[addr=&quot; + getInetAddress() +
405                 &quot;,port=&quot; + getPort() +
406                 &quot;,localport=&quot; + getLocalPort() + &quot;]&quot;;
407         return &quot;Socket[unconnected]&quot;;
408     }
409 
<a name="54" id="anc54"></a><span class="line-added">410     @Override</span>
411     public boolean isConnected() {
412         return sc.isConnected();
413     }
414 
<a name="55" id="anc55"></a><span class="line-added">415     @Override</span>
416     public boolean isBound() {
417         return sc.localAddress() != null;
418     }
419 
<a name="56" id="anc56"></a><span class="line-added">420     @Override</span>
421     public boolean isClosed() {
422         return !sc.isOpen();
423     }
424 
<a name="57" id="anc57"></a><span class="line-added">425     @Override</span>
426     public boolean isInputShutdown() {
427         return !sc.isInputOpen();
428     }
429 
<a name="58" id="anc58"></a><span class="line-added">430     @Override</span>
431     public boolean isOutputShutdown() {
432         return !sc.isOutputOpen();
433     }
<a name="59" id="anc59"></a><span class="line-added">434 </span>
<span class="line-added">435     @Override</span>
<span class="line-added">436     public &lt;T&gt; Socket setOption(SocketOption&lt;T&gt; name, T value) throws IOException {</span>
<span class="line-added">437         sc.setOption(name, value);</span>
<span class="line-added">438         return this;</span>
<span class="line-added">439     }</span>
<span class="line-added">440 </span>
<span class="line-added">441     @Override</span>
<span class="line-added">442     public &lt;T&gt; T getOption(SocketOption&lt;T&gt; name) throws IOException {</span>
<span class="line-added">443         return sc.getOption(name);</span>
<span class="line-added">444     }</span>
<span class="line-added">445 </span>
<span class="line-added">446     @Override</span>
<span class="line-added">447     public Set&lt;SocketOption&lt;?&gt;&gt; supportedOptions() {</span>
<span class="line-added">448         return sc.supportedOptions();</span>
<span class="line-added">449     }</span>
450 }
<a name="60" id="anc60"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="60" type="hidden" />
</body>
</html>