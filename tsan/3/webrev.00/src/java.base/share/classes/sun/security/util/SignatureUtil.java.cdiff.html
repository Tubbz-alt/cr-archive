<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/sun/security/util/SignatureUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SignatureFileVerifier.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../validator/PKIXValidator.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/SignatureUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 26,80 ***</span>
  package sun.security.util;
  
  import java.io.IOException;
  import java.security.*;
  import java.security.spec.*;
  import sun.security.rsa.RSAUtil;
  
  /**
   * Utility class for Signature related operations. Currently used by various
   * internal PKI classes such as sun.security.x509.X509CertImpl,
   * sun.security.pkcs.SignerInfo, for setting signature parameters.
   *
   * @since   11
   */
  public class SignatureUtil {
  
      // Utility method of creating an AlgorithmParameters object with
      // the specified algorithm name and encoding
      private static AlgorithmParameters createAlgorithmParameters(String algName,
              byte[] paramBytes) throws ProviderException {
  
          try {
              AlgorithmParameters result =
                  AlgorithmParameters.getInstance(algName);
              result.init(paramBytes);
              return result;
          } catch (NoSuchAlgorithmException | IOException e) {
              throw new ProviderException(e);
          }
      }
  
<span class="line-modified">!     private static AlgorithmParameterSpec getParamSpec(String sigName,</span>
              AlgorithmParameters params)
<span class="line-modified">!             throws InvalidAlgorithmParameterException, ProviderException {</span>
  
<span class="line-modified">!         if (params == null) return null;</span>
  
<span class="line-modified">!         if (sigName.toUpperCase().indexOf(&quot;RSA&quot;) == -1) {</span>
<span class="line-modified">!             throw new ProviderException</span>
<span class="line-modified">!                  (&quot;Unrecognized algorithm for signature parameters &quot; +</span>
<span class="line-modified">!                   sigName);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         // AlgorithmParameters.getAlgorithm() may returns oid if it&#39;s</span>
<span class="line-modified">!         // created during DER decoding. Convert to use the standard name</span>
<span class="line-modified">!         // before passing it to RSAUtil</span>
<span class="line-modified">!         String alg = params.getAlgorithm();</span>
<span class="line-modified">!         if (alg.equalsIgnoreCase(sigName) || alg.indexOf(&quot;.&quot;) != -1) {</span>
<span class="line-modified">!             try {</span>
<span class="line-modified">!                 params = createAlgorithmParameters(sigName,</span>
<span class="line-removed">-                     params.getEncoded());</span>
<span class="line-removed">-             } catch (IOException e) {</span>
<span class="line-removed">-                 throw new ProviderException(e);</span>
              }
          }
<span class="line-modified">!         return RSAUtil.getParamSpec(params);</span>
      }
  
<span class="line-modified">!     // Special method for setting the specified parameter bytes into the</span>
<span class="line-modified">!     // specified Signature object as signature parameters.</span>
<span class="line-modified">!     public static void specialSetParameter(Signature sig, byte[] paramBytes)</span>
<span class="line-modified">!             throws InvalidAlgorithmParameterException, ProviderException {</span>
          if (paramBytes != null) {
<span class="line-modified">!             String sigName = sig.getAlgorithm();</span>
<span class="line-modified">!             AlgorithmParameters params =</span>
<span class="line-modified">!                 createAlgorithmParameters(sigName, paramBytes);</span>
<span class="line-modified">!             specialSetParameter(sig, params);</span>
          }
      }
  
<span class="line-modified">!     // Special method for setting the specified AlgorithmParameter object</span>
<span class="line-modified">!     // into the specified Signature object as signature parameters.</span>
<span class="line-modified">!     public static void specialSetParameter(Signature sig,</span>
<span class="line-modified">!             AlgorithmParameters params)</span>
<span class="line-modified">!             throws InvalidAlgorithmParameterException, ProviderException {</span>
<span class="line-modified">!         if (params != null) {</span>
<span class="line-modified">!             String sigName = sig.getAlgorithm();</span>
<span class="line-modified">!             sig.setParameter(getParamSpec(sigName, params));</span>
<span class="line-modified">!         }</span>
      }
  }
<span class="line-new-header">--- 26,146 ---</span>
  package sun.security.util;
  
  import java.io.IOException;
  import java.security.*;
  import java.security.spec.*;
<span class="line-added">+ import java.util.Locale;</span>
  import sun.security.rsa.RSAUtil;
<span class="line-added">+ import jdk.internal.access.SharedSecrets;</span>
  
  /**
   * Utility class for Signature related operations. Currently used by various
   * internal PKI classes such as sun.security.x509.X509CertImpl,
   * sun.security.pkcs.SignerInfo, for setting signature parameters.
   *
   * @since   11
   */
  public class SignatureUtil {
  
<span class="line-added">+     private static String checkName(String algName) throws ProviderException {</span>
<span class="line-added">+         if (algName.indexOf(&quot;.&quot;) == -1) {</span>
<span class="line-added">+             return algName;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         // convert oid to String</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             return Signature.getInstance(algName).getAlgorithm();</span>
<span class="line-added">+         } catch (Exception e) {</span>
<span class="line-added">+             throw new ProviderException(&quot;Error mapping algorithm name&quot;, e);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      // Utility method of creating an AlgorithmParameters object with
      // the specified algorithm name and encoding
      private static AlgorithmParameters createAlgorithmParameters(String algName,
              byte[] paramBytes) throws ProviderException {
  
          try {
<span class="line-added">+             algName = checkName(algName);</span>
              AlgorithmParameters result =
                  AlgorithmParameters.getInstance(algName);
              result.init(paramBytes);
              return result;
          } catch (NoSuchAlgorithmException | IOException e) {
              throw new ProviderException(e);
          }
      }
  
<span class="line-modified">!     // Utility method for converting the specified AlgorithmParameters object</span>
<span class="line-added">+     // into an AlgorithmParameterSpec object.</span>
<span class="line-added">+     public static AlgorithmParameterSpec getParamSpec(String sigName,</span>
              AlgorithmParameters params)
<span class="line-modified">!             throws ProviderException {</span>
  
<span class="line-modified">!         sigName = checkName(sigName).toUpperCase(Locale.ENGLISH);</span>
<span class="line-added">+         AlgorithmParameterSpec paramSpec = null;</span>
<span class="line-added">+         if (params != null) {</span>
<span class="line-added">+             // AlgorithmParameters.getAlgorithm() may returns oid if it&#39;s</span>
<span class="line-added">+             // created during DER decoding. Convert to use the standard name</span>
<span class="line-added">+             // before passing it to RSAUtil</span>
<span class="line-added">+             if (params.getAlgorithm().indexOf(&quot;.&quot;) != -1) {</span>
<span class="line-added">+                 try {</span>
<span class="line-added">+                     params = createAlgorithmParameters(sigName,</span>
<span class="line-added">+                         params.getEncoded());</span>
<span class="line-added">+                 } catch (IOException e) {</span>
<span class="line-added">+                     throw new ProviderException(e);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
  
<span class="line-modified">!             if (sigName.indexOf(&quot;RSA&quot;) != -1) {</span>
<span class="line-modified">!                 paramSpec = RSAUtil.getParamSpec(params);</span>
<span class="line-modified">!             } else if (sigName.indexOf(&quot;ECDSA&quot;) != -1) {</span>
<span class="line-modified">!                 try {</span>
<span class="line-modified">!                     paramSpec = params.getParameterSpec(ECParameterSpec.class);</span>
<span class="line-modified">!                 } catch (Exception e) {</span>
<span class="line-modified">!                     throw new ProviderException(&quot;Error handling EC parameters&quot;, e);</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!             } else {</span>
<span class="line-modified">!                 throw new ProviderException</span>
<span class="line-modified">!                     (&quot;Unrecognized algorithm for signature parameters &quot; +</span>
<span class="line-modified">!                      sigName);</span>
              }
          }
<span class="line-modified">!         return paramSpec;</span>
      }
  
<span class="line-modified">!     // Utility method for converting the specified parameter bytes into an</span>
<span class="line-modified">!     // AlgorithmParameterSpec object.</span>
<span class="line-modified">!     public static AlgorithmParameterSpec getParamSpec(String sigName,</span>
<span class="line-modified">!             byte[] paramBytes)</span>
<span class="line-added">+             throws ProviderException {</span>
<span class="line-added">+         sigName = checkName(sigName).toUpperCase(Locale.ENGLISH);</span>
<span class="line-added">+         AlgorithmParameterSpec paramSpec = null;</span>
<span class="line-added">+ </span>
          if (paramBytes != null) {
<span class="line-modified">!             if (sigName.indexOf(&quot;RSA&quot;) != -1) {</span>
<span class="line-modified">!                 AlgorithmParameters params =</span>
<span class="line-modified">!                     createAlgorithmParameters(sigName, paramBytes);</span>
<span class="line-modified">!                 paramSpec = RSAUtil.getParamSpec(params);</span>
<span class="line-added">+             } else if (sigName.indexOf(&quot;ECDSA&quot;) != -1) {</span>
<span class="line-added">+                 try {</span>
<span class="line-added">+                     Provider p = Signature.getInstance(sigName).getProvider();</span>
<span class="line-added">+                     paramSpec = ECUtil.getECParameterSpec(p, paramBytes);</span>
<span class="line-added">+                 } catch (Exception e) {</span>
<span class="line-added">+                     throw new ProviderException(&quot;Error handling EC parameters&quot;, e);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 // ECUtil discards exception and returns null, so we need to check</span>
<span class="line-added">+                 // the returned value</span>
<span class="line-added">+                 if (paramSpec == null) {</span>
<span class="line-added">+                     throw new ProviderException(&quot;Error handling EC parameters&quot;);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 throw new ProviderException</span>
<span class="line-added">+                      (&quot;Unrecognized algorithm for signature parameters &quot; +</span>
<span class="line-added">+                       sigName);</span>
<span class="line-added">+             }</span>
          }
<span class="line-added">+         return paramSpec;</span>
      }
  
<span class="line-modified">!     // Utility method for initializing the specified Signature object</span>
<span class="line-modified">!     // for verification with the specified key and params (may be null)</span>
<span class="line-modified">!     public static void initVerifyWithParam(Signature s, PublicKey key,</span>
<span class="line-modified">!             AlgorithmParameterSpec params)</span>
<span class="line-modified">!             throws ProviderException, InvalidAlgorithmParameterException,</span>
<span class="line-modified">!             InvalidKeyException {</span>
<span class="line-modified">!         SharedSecrets.getJavaSecuritySignatureAccess().initVerify(s, key, params);</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-added">+     // Utility method for initializing the specified Signature object</span>
<span class="line-added">+     // for verification with the specified Certificate and params (may be null)</span>
<span class="line-added">+     public static void initVerifyWithParam(Signature s,</span>
<span class="line-added">+             java.security.cert.Certificate cert,</span>
<span class="line-added">+             AlgorithmParameterSpec params)</span>
<span class="line-added">+             throws ProviderException, InvalidAlgorithmParameterException,</span>
<span class="line-added">+             InvalidKeyException {</span>
<span class="line-added">+         SharedSecrets.getJavaSecuritySignatureAccess().initVerify(s, cert, params);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Utility method for initializing the specified Signature object</span>
<span class="line-added">+     // for signing with the specified key and params (may be null)</span>
<span class="line-added">+     public static void initSignWithParam(Signature s, PrivateKey key,</span>
<span class="line-added">+             AlgorithmParameterSpec params, SecureRandom sr)</span>
<span class="line-added">+             throws ProviderException, InvalidAlgorithmParameterException,</span>
<span class="line-added">+             InvalidKeyException {</span>
<span class="line-added">+         SharedSecrets.getJavaSecuritySignatureAccess().initSign(s, key, params, sr);</span>
      }
  }
</pre>
<center><a href="SignatureFileVerifier.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../validator/PKIXValidator.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>