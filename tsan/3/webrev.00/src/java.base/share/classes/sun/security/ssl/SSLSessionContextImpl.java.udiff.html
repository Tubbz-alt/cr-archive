<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/ssl/SSLSessionContextImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SSLServerSocketImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SSLSessionImpl.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/SSLSessionContextImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1999, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -31,33 +31,64 @@</span>
  import java.util.Locale;
  import javax.net.ssl.SSLSession;
  import javax.net.ssl.SSLSessionContext;
  
  import sun.security.action.GetIntegerAction;
<span class="udiff-line-added">+ import sun.security.action.GetPropertyAction;</span>
  import sun.security.util.Cache;
  
  
<span class="udiff-line-added">+ /**</span>
<span class="udiff-line-added">+  * @systemProperty jdk.tls.server.enableSessionTicketExtension} determines if the</span>
<span class="udiff-line-added">+  * server will provide stateless session tickets, if the client supports it,</span>
<span class="udiff-line-added">+  * as described in RFC 5077 and RFC 8446.  a stateless session ticket</span>
<span class="udiff-line-added">+  * contains the encrypted server&#39;s state which saves server resources.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * {@systemProperty jdk.tls.client.enableSessionTicketExtension} determines if the</span>
<span class="udiff-line-added">+  * client will send an extension in the ClientHello in the pre-TLS 1.3.</span>
<span class="udiff-line-added">+  * This extension allows the client to accept the server&#39;s session state for</span>
<span class="udiff-line-added">+  * Server Side stateless resumption (RFC 5077).  Setting the property to</span>
<span class="udiff-line-added">+  * &quot;true&quot; turns this on, by default it is false.  For TLS 1.3, the system</span>
<span class="udiff-line-added">+  * property is not needed as this support is part of the spec.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * {@systemProperty jdk.tls.server.sessionTicketTimeout} determines how long</span>
<span class="udiff-line-added">+  * a session in the server cache or the stateless resumption tickets are</span>
<span class="udiff-line-added">+  * available for use.  The value set by the property can be modified by</span>
<span class="udiff-line-added">+  * {@code SSLSessionContext.setSessionTimeout()} during runtime.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ </span>
  final class SSLSessionContextImpl implements SSLSessionContext {
      private final static int DEFAULT_MAX_CACHE_SIZE = 20480;
<span class="udiff-line-added">+     // Default lifetime of a session. 24 hours</span>
<span class="udiff-line-added">+     final static int DEFAULT_SESSION_TIMEOUT = 86400;</span>
  
      private final Cache&lt;SessionId, SSLSessionImpl&gt; sessionCache;
                                          // session cache, session id as key
      private final Cache&lt;String, SSLSessionImpl&gt; sessionHostPortCache;
                                          // session cache, &quot;host:port&quot; as key
      private int cacheLimit;             // the max cache size
      private int timeout;                // timeout in seconds
  
<span class="udiff-line-added">+     // Default setting for stateless session resumption support (RFC 5077)</span>
<span class="udiff-line-added">+     private boolean statelessSession = true;</span>
<span class="udiff-line-added">+ </span>
      // package private
<span class="udiff-line-modified-removed">-     SSLSessionContextImpl() {</span>
<span class="udiff-line-modified-removed">-         cacheLimit = getDefaultCacheLimit();    // default cache size</span>
<span class="udiff-line-modified-removed">-         timeout = 86400;                        // default, 24 hours</span>
<span class="udiff-line-modified-added">+     SSLSessionContextImpl(boolean server) {</span>
<span class="udiff-line-modified-added">+         timeout = DEFAULT_SESSION_TIMEOUT;</span>
<span class="udiff-line-modified-added">+         cacheLimit = getDefaults(server);    // default cache size</span>
  
          // use soft reference
          sessionCache = Cache.newSoftMemoryCache(cacheLimit, timeout);
          sessionHostPortCache = Cache.newSoftMemoryCache(cacheLimit, timeout);
      }
  
<span class="udiff-line-added">+     // Stateless sessions when available, but there is a cache</span>
<span class="udiff-line-added">+     boolean statelessEnabled() {</span>
<span class="udiff-line-added">+         return statelessSession;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Returns the &lt;code&gt;SSLSession&lt;/code&gt; bound to the specified session id.
       */
      @Override
      public SSLSession getSession(byte[] sessionId) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -161,12 +192,11 @@</span>
  
          return null;
      }
  
      private static String getKey(String hostname, int port) {
<span class="udiff-line-modified-removed">-         return (hostname + &quot;:&quot; +</span>
<span class="udiff-line-removed">-             String.valueOf(port)).toLowerCase(Locale.ENGLISH);</span>
<span class="udiff-line-modified-added">+         return (hostname + &quot;:&quot; + port).toLowerCase(Locale.ENGLISH);</span>
      }
  
      // cache a SSLSession
      //
      // In SunJSSE implementation, a session is created while getting a
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -195,12 +225,56 @@</span>
              sessionHostPortCache.remove(
                      getKey(s.getPeerHost(), s.getPeerPort()));
          }
      }
  
<span class="udiff-line-modified-removed">-     private static int getDefaultCacheLimit() {</span>
<span class="udiff-line-modified-added">+     private int getDefaults(boolean server) {</span>
          try {
<span class="udiff-line-added">+             String st;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Property for Session Cache state</span>
<span class="udiff-line-added">+             if (server) {</span>
<span class="udiff-line-added">+                 st = GetPropertyAction.privilegedGetProperty(</span>
<span class="udiff-line-added">+                         &quot;jdk.tls.server.enableSessionTicketExtension&quot;, &quot;true&quot;);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 st = GetPropertyAction.privilegedGetProperty(</span>
<span class="udiff-line-added">+                         &quot;jdk.tls.client.enableSessionTicketExtension&quot;, &quot;true&quot;);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (st.compareToIgnoreCase(&quot;false&quot;) == 0) {</span>
<span class="udiff-line-added">+                 statelessSession = false;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Property for Session Ticket Timeout.  The value can be changed</span>
<span class="udiff-line-added">+             // by SSLSessionContext.setSessionTimeout(int)</span>
<span class="udiff-line-added">+             String s = GetPropertyAction.privilegedGetProperty(</span>
<span class="udiff-line-added">+                     &quot;jdk.tls.server.sessionTicketTimeout&quot;);</span>
<span class="udiff-line-added">+             if (s != null) {</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     int t = Integer.parseInt(s);</span>
<span class="udiff-line-added">+                     if (t &lt; 0 ||</span>
<span class="udiff-line-added">+                             t &gt; NewSessionTicket.MAX_TICKET_LIFETIME) {</span>
<span class="udiff-line-added">+                         timeout = DEFAULT_SESSION_TIMEOUT;</span>
<span class="udiff-line-added">+                         if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-added">+                             SSLLogger.warning(&quot;Invalid timeout given &quot; +</span>
<span class="udiff-line-added">+                                     &quot;jdk.tls.server.sessionTicketTimeout: &quot; + t +</span>
<span class="udiff-line-added">+                                     &quot;.  Set to default value &quot; + timeout);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         timeout = t;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 } catch (NumberFormatException e) {</span>
<span class="udiff-line-added">+                     setSessionTimeout(DEFAULT_SESSION_TIMEOUT);</span>
<span class="udiff-line-added">+                     if (SSLLogger.isOn &amp;&amp; SSLLogger.isOn(&quot;ssl&quot;)) {</span>
<span class="udiff-line-added">+                         SSLLogger.warning(&quot;Invalid timeout for &quot; +</span>
<span class="udiff-line-added">+                                 &quot;jdk.tls.server.sessionTicketTimeout: &quot; + s +</span>
<span class="udiff-line-added">+                                 &quot;.  Set to default value &quot; + timeout);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
              int defaultCacheLimit = GetIntegerAction.privilegedGetProperty(
                      &quot;javax.net.ssl.sessionCacheSize&quot;, DEFAULT_MAX_CACHE_SIZE);
  
              if (defaultCacheLimit &gt;= 0) {
                  return defaultCacheLimit;
</pre>
<center><a href="SSLServerSocketImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SSLSessionImpl.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>