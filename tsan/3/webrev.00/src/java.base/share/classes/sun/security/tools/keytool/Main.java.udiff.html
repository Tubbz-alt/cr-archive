<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/tools/keytool/Main.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CertAndKeyGen.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Resources.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/tools/keytool/Main.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -35,10 +35,11 @@</span>
  import java.security.KeyStoreException;
  import java.security.MessageDigest;
  import java.security.Key;
  import java.security.PublicKey;
  import java.security.PrivateKey;
<span class="udiff-line-added">+ import java.security.SecureRandom;</span>
  import java.security.Signature;
  import java.security.Timestamp;
  import java.security.UnrecoverableEntryException;
  import java.security.UnrecoverableKeyException;
  import java.security.Principal;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -55,10 +56,11 @@</span>
  import java.security.spec.AlgorithmParameterSpec;
  import java.security.spec.ECParameterSpec;
  import java.text.Collator;
  import java.text.MessageFormat;
  import java.util.*;
<span class="udiff-line-added">+ import java.util.function.BiFunction;</span>
  import java.util.jar.JarEntry;
  import java.util.jar.JarFile;
  import java.math.BigInteger;
  import java.net.URI;
  import java.net.URL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -81,10 +83,11 @@</span>
  import sun.security.provider.X509Factory;
  import sun.security.provider.certpath.ssl.SSLServerCertStore;
  import sun.security.util.Password;
  import sun.security.util.SecurityProperties;
  import sun.security.util.SecurityProviderConstants;
<span class="udiff-line-added">+ import sun.security.util.SignatureUtil;</span>
  import javax.crypto.KeyGenerator;
  import javax.crypto.SecretKey;
  import javax.crypto.SecretKeyFactory;
  import javax.crypto.spec.PBEKeySpec;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -172,10 +175,12 @@</span>
      private char[] srcstorePass = null;
      private String srcstoretype = null;
      private Set&lt;char[]&gt; passwords = new HashSet&lt;&gt;();
      private String startDate = null;
  
<span class="udiff-line-added">+     private boolean tlsInfo = false;</span>
<span class="udiff-line-added">+ </span>
      private List&lt;String&gt; ids = new ArrayList&lt;&gt;();   // used in GENCRL
      private List&lt;String&gt; v3ext = new ArrayList&lt;&gt;();
  
      // In-place importkeystore is special.
      // A backup is needed, and no need to prompt for deststorepass.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -257,10 +262,12 @@</span>
          PRINTCRL(&quot;Prints.the.content.of.a.CRL.file&quot;,
              FILEIN, V),
          STOREPASSWD(&quot;Changes.the.store.password.of.a.keystore&quot;,
              NEW, KEYSTORE, CACERTS, STOREPASS, STORETYPE, PROVIDERNAME,
              ADDPROVIDER, PROVIDERCLASS, PROVIDERPATH, V),
<span class="udiff-line-added">+         SHOWINFO(&quot;showinfo.command.help&quot;,</span>
<span class="udiff-line-added">+             TLS, V),</span>
  
          // Undocumented start here, KEYCLONE is used a marker in -help;
  
          KEYCLONE(&quot;Clones.a.key.entry&quot;,
              ALIAS, DESTALIAS, KEYPASS, NEW, STORETYPE,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -362,10 +369,11 @@</span>
          SSLSERVER(&quot;sslserver&quot;, &quot;&lt;server[:port]&gt;&quot;, &quot;SSL.server.host.and.port&quot;),
          JARFILE(&quot;jarfile&quot;, &quot;&lt;file&gt;&quot;, &quot;signed.jar.file&quot;),
          STARTDATE(&quot;startdate&quot;, &quot;&lt;date&gt;&quot;, &quot;certificate.validity.start.date.time&quot;),
          STOREPASS(&quot;storepass&quot;, &quot;&lt;arg&gt;&quot;, &quot;keystore.password&quot;),
          STORETYPE(&quot;storetype&quot;, &quot;&lt;type&gt;&quot;, &quot;keystore.type&quot;),
<span class="udiff-line-added">+         TLS(&quot;tls&quot;, null, &quot;tls.option.help&quot;),</span>
          TRUSTCACERTS(&quot;trustcacerts&quot;, null, &quot;trust.certificates.from.cacerts&quot;),
          V(&quot;v&quot;, null, &quot;verbose.output&quot;),
          VALIDITY(&quot;validity&quot;, &quot;&lt;days&gt;&quot;, &quot;validity.number.of.days&quot;);
  
          final String name, arg, description;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -675,10 +683,12 @@</span>
              } else if (collator.compare(flags, &quot;-protected&quot;) == 0 ||
                      collator.compare(flags, &quot;-destprotected&quot;) == 0) {
                  protectedPath = true;
              } else if (collator.compare(flags, &quot;-srcprotected&quot;) == 0) {
                  srcprotectedPath = true;
<span class="udiff-line-added">+             } else if (collator.compare(flags, &quot;-tls&quot;) == 0) {</span>
<span class="udiff-line-added">+                 tlsInfo = true;</span>
              } else  {
                  System.err.println(rb.getString(&quot;Illegal.option.&quot;) + flags);
                  tinyHelp();
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -702,11 +712,11 @@</span>
  
          return args;
      }
  
      boolean isKeyStoreRelated(Command cmd) {
<span class="udiff-line-modified-removed">-         return cmd != PRINTCERT &amp;&amp; cmd != PRINTCERTREQ;</span>
<span class="udiff-line-modified-added">+         return cmd != PRINTCERT &amp;&amp; cmd != PRINTCERTREQ &amp;&amp; cmd != SHOWINFO;</span>
      }
  
      /**
       * Execute the commands.
       */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -871,12 +881,11 @@</span>
          }
  
          // Check if keystore exists.
          // If no keystore has been specified at the command line, try to use
          // the default, which is located in $HOME/.keystore.
<span class="udiff-line-modified-removed">-         // If the command is &quot;genkey&quot;, &quot;identitydb&quot;, &quot;import&quot;, or &quot;printcert&quot;,</span>
<span class="udiff-line-removed">-         // it is OK not to have a keystore.</span>
<span class="udiff-line-modified-added">+         // No need to check if isKeyStoreRelated(command) is false.</span>
  
          // DO NOT open the existing keystore if this is an in-place import.
          // The keystore should be created as brand new.
          if (isKeyStoreRelated(command) &amp;&amp; !nullStream &amp;&amp; !inplaceImport) {
              try {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -886,10 +895,13 @@</span>
                      throw new Exception(rb.getString
                              (&quot;Keystore.file.exists.but.is.empty.&quot;) + ksfname);
                  }
                  ksStream = new FileInputStream(ksfile);
              } catch (FileNotFoundException e) {
<span class="udiff-line-added">+                 // These commands do not need the keystore to be existing.</span>
<span class="udiff-line-added">+                 // Either it will create a new one or the keystore is</span>
<span class="udiff-line-added">+                 // optional (i.e. PRINTCRL).</span>
                  if (command != GENKEYPAIR &amp;&amp;
                          command != GENSECKEY &amp;&amp;
                          command != IDENTITYDB &amp;&amp;
                          command != IMPORTCERT &amp;&amp;
                          command != IMPORTPASS &amp;&amp;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1137,21 +1149,19 @@</span>
                  Object[] source = {filename};
                  System.err.println(form.format(source));
              }
          } else if (command == GENKEYPAIR) {
              if (keyAlgName == null) {
<span class="udiff-line-modified-removed">-                 keyAlgName = &quot;DSA&quot;;</span>
<span class="udiff-line-modified-removed">-                 weakWarnings.add(String.format(rb.getString(</span>
<span class="udiff-line-removed">-                         &quot;keyalg.option.1.missing.warning&quot;), keyAlgName));</span>
<span class="udiff-line-modified-added">+                 throw new Exception(rb.getString(</span>
<span class="udiff-line-modified-added">+                         &quot;keyalg.option.missing.error&quot;));</span>
              }
              doGenKeyPair(alias, dname, keyAlgName, keysize, groupName, sigAlgName);
              kssave = true;
          } else if (command == GENSECKEY) {
              if (keyAlgName == null) {
<span class="udiff-line-modified-removed">-                 keyAlgName = &quot;DES&quot;;</span>
<span class="udiff-line-modified-removed">-                 weakWarnings.add(String.format(rb.getString(</span>
<span class="udiff-line-removed">-                         &quot;keyalg.option.1.missing.warning&quot;), keyAlgName));</span>
<span class="udiff-line-modified-added">+                 throw new Exception(rb.getString(</span>
<span class="udiff-line-modified-added">+                         &quot;keyalg.option.missing.error&quot;));</span>
              }
              doGenSecretKey(alias, keyAlgName, keysize);
              kssave = true;
          } else if (command == IMPORTPASS) {
              if (keyAlgName == null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1308,10 +1318,12 @@</span>
              } else {
                  doPrintCertReq(System.in, out);
              }
          } else if (command == PRINTCRL) {
              doPrintCRL(filename, out);
<span class="udiff-line-added">+         } else if (command == SHOWINFO) {</span>
<span class="udiff-line-added">+             doShowInfo();</span>
          }
  
          // If we need to save the keystore, do so.
          if (kssave) {
              if (verbose) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1427,19 +1439,20 @@</span>
                  (PrivateKey)recoverKey(alias, storePass, keyPass).fst;
          if (sigAlgName == null) {
              sigAlgName = getCompatibleSigAlgName(privateKey);
          }
          Signature signature = Signature.getInstance(sigAlgName);
<span class="udiff-line-removed">-         signature.initSign(privateKey);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         X509CertInfo info = new X509CertInfo();</span>
          AlgorithmParameterSpec params = AlgorithmId
                  .getDefaultAlgorithmParameterSpec(sigAlgName, privateKey);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         SignatureUtil.initSignWithParam(signature, privateKey, params, null);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         X509CertInfo info = new X509CertInfo();</span>
          AlgorithmId algID = AlgorithmId.getWithParameterSpec(sigAlgName, params);
          info.set(X509CertInfo.VALIDITY, interval);
<span class="udiff-line-modified-removed">-         info.set(X509CertInfo.SERIAL_NUMBER, new CertificateSerialNumber(</span>
<span class="udiff-line-modified-removed">-                     new java.util.Random().nextInt() &amp; 0x7fffffff));</span>
<span class="udiff-line-modified-added">+         info.set(X509CertInfo.SERIAL_NUMBER,</span>
<span class="udiff-line-modified-added">+                 CertificateSerialNumber.newRandom64bit(new SecureRandom()));</span>
          info.set(X509CertInfo.VERSION,
                      new CertificateVersion(CertificateVersion.V3));
          info.set(X509CertInfo.ALGORITHM_ID,
                      new CertificateAlgorithmId(algID));
          info.set(X509CertInfo.ISSUER, issuer);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1585,16 +1598,13 @@</span>
          if (sigAlgName == null) {
              sigAlgName = getCompatibleSigAlgName(privKey);
          }
  
          Signature signature = Signature.getInstance(sigAlgName);
<span class="udiff-line-removed">-         signature.initSign(privKey);</span>
          AlgorithmParameterSpec params = AlgorithmId
                  .getDefaultAlgorithmParameterSpec(sigAlgName, privKey);
<span class="udiff-line-modified-removed">-         if (params != null) {</span>
<span class="udiff-line-removed">-             signature.setParameter(params);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         SignatureUtil.initSignWithParam(signature, privKey, params, null);</span>
  
          X500Name subject = dname == null?
                  new X500Name(((X509Certificate)cert).getSubjectDN().toString()):
                  new X500Name(dname);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2405,13 +2415,13 @@</span>
                          (&quot;Your.keystore.contains.keyStore.size.entries&quot;));
          Object[] source = {keyStore.size()};
          out.println(form.format(source));
          out.println();
  
<span class="udiff-line-modified-removed">-         for (Enumeration&lt;String&gt; e = keyStore.aliases();</span>
<span class="udiff-line-modified-removed">-                                         e.hasMoreElements(); ) {</span>
<span class="udiff-line-modified-removed">-             String alias = e.nextElement();</span>
<span class="udiff-line-modified-added">+         List&lt;String&gt; aliases = Collections.list(keyStore.aliases());</span>
<span class="udiff-line-modified-added">+         aliases.sort(String::compareTo);</span>
<span class="udiff-line-modified-added">+         for (String alias : aliases) {</span>
              doPrintEntry(&quot;&lt;&quot; + alias + &quot;&gt;&quot;, alias, out);
              if (verbose || rfc) {
                  out.println(rb.getString(&quot;NEWLINE&quot;));
                  out.println(rb.getString
                          (&quot;STAR&quot;));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2704,10 +2714,18 @@</span>
              }
              checkWeak(oneInMany(rb.getString(&quot;the.certificate&quot;), i, certs.length), x509Cert);
          }
      }
  
<span class="udiff-line-added">+     private void doShowInfo() throws Exception {</span>
<span class="udiff-line-added">+         if (tlsInfo) {</span>
<span class="udiff-line-added">+             ShowInfo.tls(verbose);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             System.out.println(rb.getString(&quot;showinfo.no.option&quot;));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private Collection&lt;? extends Certificate&gt; generateCertificates(InputStream in)
              throws CertificateException, IOException {
          byte[] data = in.readAllBytes();
          try {
              return CertificateFactory.getInstance(&quot;X.509&quot;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2945,12 +2963,12 @@</span>
          CertificateValidity interval = new CertificateValidity(firstDate,
                                                                 lastDate);
          certInfo.set(X509CertInfo.VALIDITY, interval);
  
          // Make new serial number
<span class="udiff-line-modified-removed">-         certInfo.set(X509CertInfo.SERIAL_NUMBER, new CertificateSerialNumber(</span>
<span class="udiff-line-modified-removed">-                     new java.util.Random().nextInt() &amp; 0x7fffffff));</span>
<span class="udiff-line-modified-added">+         certInfo.set(X509CertInfo.SERIAL_NUMBER,</span>
<span class="udiff-line-modified-added">+                 CertificateSerialNumber.newRandom64bit(new SecureRandom()));</span>
  
          // Set owner and issuer fields
          X500Name owner;
          if (dname == null) {
              // Get the owner name from the certificate
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3557,10 +3575,15 @@</span>
                                         char[] keyPass)
          throws Exception
      {
          Key key = null;
  
<span class="udiff-line-added">+         if (KeyStoreUtil.isWindowsKeyStore(storetype)) {</span>
<span class="udiff-line-added">+             key = keyStore.getKey(alias, null);</span>
<span class="udiff-line-added">+             return Pair.of(key, null);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          if (keyStore.containsAlias(alias) == false) {
              MessageFormat form = new MessageFormat
                  (rb.getString(&quot;Alias.alias.does.not.exist&quot;));
              Object[] source = {alias};
              throw new Exception(form.format(source));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4083,47 +4106,66 @@</span>
          }
          return c.getTime();
      }
  
      /**
<span class="udiff-line-modified-removed">-      * Match a command (may be abbreviated) with a command set.</span>
<span class="udiff-line-modified-removed">-      * @param s the command provided</span>
<span class="udiff-line-modified-added">+      * Match a command with a command set. The match can be exact, or</span>
<span class="udiff-line-modified-added">+      * partial, or case-insensitive.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param s the command provided by user</span>
       * @param list the legal command set. If there is a null, commands after it
<span class="udiff-line-modified-removed">-      * are regarded experimental, which means they are supported but their</span>
<span class="udiff-line-modified-removed">-      * existence should not be revealed to user.</span>
<span class="udiff-line-modified-added">+      *      are regarded experimental, which means they are supported but their</span>
<span class="udiff-line-modified-added">+      *      existence should not be revealed to user.</span>
       * @return the position of a single match, or -1 if none matched
       * @throws Exception if s is ambiguous
       */
      private static int oneOf(String s, String... list) throws Exception {
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // First, if there is an exact match, returns it.</span>
<span class="udiff-line-added">+         int res = oneOfMatch((a,b) -&gt; a.equals(b), s, list);</span>
<span class="udiff-line-added">+         if (res &gt;= 0) {</span>
<span class="udiff-line-added">+             return res;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Second, if there is one single camelCase or prefix match, returns it.</span>
<span class="udiff-line-added">+         // This regex substitution removes all lowercase letters not at the</span>
<span class="udiff-line-added">+         // beginning, so &quot;keyCertSign&quot; becomes &quot;kCS&quot;.</span>
<span class="udiff-line-added">+         res = oneOfMatch((a,b) -&gt; a.equals(b.replaceAll(&quot;(?&lt;!^)[a-z]&quot;, &quot;&quot;))</span>
<span class="udiff-line-added">+                 || b.startsWith(a), s, list);</span>
<span class="udiff-line-added">+         if (res &gt;= 0) {</span>
<span class="udiff-line-added">+             return res;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Finally, retry the 2nd step ignoring case</span>
<span class="udiff-line-added">+         return oneOfMatch((a,b) -&gt; a.equalsIgnoreCase(b.replaceAll(&quot;(?&lt;!^)[a-z]&quot;, &quot;&quot;))</span>
<span class="udiff-line-added">+                 || b.toUpperCase(Locale.ROOT).startsWith(a.toUpperCase(Locale.ROOT)),</span>
<span class="udiff-line-added">+                 s, list);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Match a command with a command set.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param matcher a BiFunction which returns {@code true} if the 1st</span>
<span class="udiff-line-added">+      *               argument (user input) matches the 2nd one (full command)</span>
<span class="udiff-line-added">+      * @param s the command provided by user</span>
<span class="udiff-line-added">+      * @param list the legal command set</span>
<span class="udiff-line-added">+      * @return the position of a single match, or -1 if none matched</span>
<span class="udiff-line-added">+      * @throws Exception if s is ambiguous</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static int oneOfMatch(BiFunction&lt;String,String,Boolean&gt; matcher,</span>
<span class="udiff-line-added">+             String s, String... list) throws Exception {</span>
          int[] match = new int[list.length];
          int nmatch = 0;
          int experiment = Integer.MAX_VALUE;
          for (int i = 0; i&lt;list.length; i++) {
              String one = list[i];
              if (one == null) {
                  experiment = i;
                  continue;
              }
<span class="udiff-line-modified-removed">-             if (one.toLowerCase(Locale.ENGLISH)</span>
<span class="udiff-line-removed">-                     .startsWith(s.toLowerCase(Locale.ENGLISH))) {</span>
<span class="udiff-line-modified-added">+             if (matcher.apply(s, one)) {</span>
                  match[nmatch++] = i;
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 StringBuilder sb = new StringBuilder();</span>
<span class="udiff-line-removed">-                 boolean first = true;</span>
<span class="udiff-line-removed">-                 for (char c: one.toCharArray()) {</span>
<span class="udiff-line-removed">-                     if (first) {</span>
<span class="udiff-line-removed">-                         sb.append(c);</span>
<span class="udiff-line-removed">-                         first = false;</span>
<span class="udiff-line-removed">-                     } else {</span>
<span class="udiff-line-removed">-                         if (!Character.isLowerCase(c)) {</span>
<span class="udiff-line-removed">-                             sb.append(c);</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (sb.toString().equalsIgnoreCase(s)) {</span>
<span class="udiff-line-removed">-                     match[nmatch++] = i;</span>
<span class="udiff-line-removed">-                 }</span>
              }
          }
          if (nmatch == 0) {
              return -1;
          } else if (nmatch == 1) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4133,11 +4175,11 @@</span>
              if (match[1] &gt; experiment) {
                  return match[0];
              }
              StringBuilder sb = new StringBuilder();
              MessageFormat form = new MessageFormat(rb.getString
<span class="udiff-line-modified-removed">-                 (&quot;command.{0}.is.ambiguous.&quot;));</span>
<span class="udiff-line-modified-added">+                     (&quot;command.{0}.is.ambiguous.&quot;));</span>
              Object[] source = {s};
              sb.append(form.format(source));
              sb.append(&quot;\n    &quot;);
              for (int i=0; i&lt;nmatch &amp;&amp; match[i]&lt;experiment; i++) {
                  sb.append(&#39; &#39;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4610,11 +4652,11 @@</span>
          if (key != null &amp;&amp; !DISABLED_CHECK.permits(SIG_PRIMITIVE_SET, key)) {
              weakWarnings.add(String.format(
                      rb.getString(&quot;whose.key.risk&quot;),
                      label,
                      String.format(rb.getString(&quot;key.bit&quot;),
<span class="udiff-line-modified-removed">-                             KeyUtil.getKeySize(key), key.getAlgorithm())));</span>
<span class="udiff-line-modified-added">+                             KeyUtil.getKeySize(key), fullDisplayAlgName(key))));</span>
          }
      }
  
      private void checkWeak(String label, Certificate[] certs)
              throws KeyStoreException {
</pre>
<center><a href="CertAndKeyGen.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Resources.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>