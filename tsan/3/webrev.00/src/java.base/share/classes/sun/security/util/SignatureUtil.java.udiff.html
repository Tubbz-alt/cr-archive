<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/util/SignatureUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SignatureFileVerifier.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../validator/PKIXValidator.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/util/SignatureUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -26,80 +26,146 @@</span>
  package sun.security.util;
  
  import java.io.IOException;
  import java.security.*;
  import java.security.spec.*;
<span class="udiff-line-added">+ import java.util.Locale;</span>
  import sun.security.rsa.RSAUtil;
<span class="udiff-line-added">+ import jdk.internal.access.SharedSecrets;</span>
  
  /**
   * Utility class for Signature related operations. Currently used by various
   * internal PKI classes such as sun.security.x509.X509CertImpl,
   * sun.security.pkcs.SignerInfo, for setting signature parameters.
   *
   * @since   11
   */
  public class SignatureUtil {
  
<span class="udiff-line-added">+     private static String checkName(String algName) throws ProviderException {</span>
<span class="udiff-line-added">+         if (algName.indexOf(&quot;.&quot;) == -1) {</span>
<span class="udiff-line-added">+             return algName;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         // convert oid to String</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             return Signature.getInstance(algName).getAlgorithm();</span>
<span class="udiff-line-added">+         } catch (Exception e) {</span>
<span class="udiff-line-added">+             throw new ProviderException(&quot;Error mapping algorithm name&quot;, e);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      // Utility method of creating an AlgorithmParameters object with
      // the specified algorithm name and encoding
      private static AlgorithmParameters createAlgorithmParameters(String algName,
              byte[] paramBytes) throws ProviderException {
  
          try {
<span class="udiff-line-added">+             algName = checkName(algName);</span>
              AlgorithmParameters result =
                  AlgorithmParameters.getInstance(algName);
              result.init(paramBytes);
              return result;
          } catch (NoSuchAlgorithmException | IOException e) {
              throw new ProviderException(e);
          }
      }
  
<span class="udiff-line-modified-removed">-     private static AlgorithmParameterSpec getParamSpec(String sigName,</span>
<span class="udiff-line-modified-added">+     // Utility method for converting the specified AlgorithmParameters object</span>
<span class="udiff-line-added">+     // into an AlgorithmParameterSpec object.</span>
<span class="udiff-line-added">+     public static AlgorithmParameterSpec getParamSpec(String sigName,</span>
              AlgorithmParameters params)
<span class="udiff-line-modified-removed">-             throws InvalidAlgorithmParameterException, ProviderException {</span>
<span class="udiff-line-modified-added">+             throws ProviderException {</span>
  
<span class="udiff-line-modified-removed">-         if (params == null) return null;</span>
<span class="udiff-line-modified-added">+         sigName = checkName(sigName).toUpperCase(Locale.ENGLISH);</span>
<span class="udiff-line-added">+         AlgorithmParameterSpec paramSpec = null;</span>
<span class="udiff-line-added">+         if (params != null) {</span>
<span class="udiff-line-added">+             // AlgorithmParameters.getAlgorithm() may returns oid if it&#39;s</span>
<span class="udiff-line-added">+             // created during DER decoding. Convert to use the standard name</span>
<span class="udiff-line-added">+             // before passing it to RSAUtil</span>
<span class="udiff-line-added">+             if (params.getAlgorithm().indexOf(&quot;.&quot;) != -1) {</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     params = createAlgorithmParameters(sigName,</span>
<span class="udiff-line-added">+                         params.getEncoded());</span>
<span class="udiff-line-added">+                 } catch (IOException e) {</span>
<span class="udiff-line-added">+                     throw new ProviderException(e);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         if (sigName.toUpperCase().indexOf(&quot;RSA&quot;) == -1) {</span>
<span class="udiff-line-modified-removed">-             throw new ProviderException</span>
<span class="udiff-line-modified-removed">-                  (&quot;Unrecognized algorithm for signature parameters &quot; +</span>
<span class="udiff-line-modified-removed">-                   sigName);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         // AlgorithmParameters.getAlgorithm() may returns oid if it&#39;s</span>
<span class="udiff-line-modified-removed">-         // created during DER decoding. Convert to use the standard name</span>
<span class="udiff-line-modified-removed">-         // before passing it to RSAUtil</span>
<span class="udiff-line-modified-removed">-         String alg = params.getAlgorithm();</span>
<span class="udiff-line-modified-removed">-         if (alg.equalsIgnoreCase(sigName) || alg.indexOf(&quot;.&quot;) != -1) {</span>
<span class="udiff-line-modified-removed">-             try {</span>
<span class="udiff-line-modified-removed">-                 params = createAlgorithmParameters(sigName,</span>
<span class="udiff-line-removed">-                     params.getEncoded());</span>
<span class="udiff-line-removed">-             } catch (IOException e) {</span>
<span class="udiff-line-removed">-                 throw new ProviderException(e);</span>
<span class="udiff-line-modified-added">+             if (sigName.indexOf(&quot;RSA&quot;) != -1) {</span>
<span class="udiff-line-modified-added">+                 paramSpec = RSAUtil.getParamSpec(params);</span>
<span class="udiff-line-modified-added">+             } else if (sigName.indexOf(&quot;ECDSA&quot;) != -1) {</span>
<span class="udiff-line-modified-added">+                 try {</span>
<span class="udiff-line-modified-added">+                     paramSpec = params.getParameterSpec(ECParameterSpec.class);</span>
<span class="udiff-line-modified-added">+                 } catch (Exception e) {</span>
<span class="udiff-line-modified-added">+                     throw new ProviderException(&quot;Error handling EC parameters&quot;, e);</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-modified-added">+             } else {</span>
<span class="udiff-line-modified-added">+                 throw new ProviderException</span>
<span class="udiff-line-modified-added">+                     (&quot;Unrecognized algorithm for signature parameters &quot; +</span>
<span class="udiff-line-modified-added">+                      sigName);</span>
              }
          }
<span class="udiff-line-modified-removed">-         return RSAUtil.getParamSpec(params);</span>
<span class="udiff-line-modified-added">+         return paramSpec;</span>
      }
  
<span class="udiff-line-modified-removed">-     // Special method for setting the specified parameter bytes into the</span>
<span class="udiff-line-modified-removed">-     // specified Signature object as signature parameters.</span>
<span class="udiff-line-modified-removed">-     public static void specialSetParameter(Signature sig, byte[] paramBytes)</span>
<span class="udiff-line-modified-removed">-             throws InvalidAlgorithmParameterException, ProviderException {</span>
<span class="udiff-line-modified-added">+     // Utility method for converting the specified parameter bytes into an</span>
<span class="udiff-line-modified-added">+     // AlgorithmParameterSpec object.</span>
<span class="udiff-line-modified-added">+     public static AlgorithmParameterSpec getParamSpec(String sigName,</span>
<span class="udiff-line-modified-added">+             byte[] paramBytes)</span>
<span class="udiff-line-added">+             throws ProviderException {</span>
<span class="udiff-line-added">+         sigName = checkName(sigName).toUpperCase(Locale.ENGLISH);</span>
<span class="udiff-line-added">+         AlgorithmParameterSpec paramSpec = null;</span>
<span class="udiff-line-added">+ </span>
          if (paramBytes != null) {
<span class="udiff-line-modified-removed">-             String sigName = sig.getAlgorithm();</span>
<span class="udiff-line-modified-removed">-             AlgorithmParameters params =</span>
<span class="udiff-line-modified-removed">-                 createAlgorithmParameters(sigName, paramBytes);</span>
<span class="udiff-line-modified-removed">-             specialSetParameter(sig, params);</span>
<span class="udiff-line-modified-added">+             if (sigName.indexOf(&quot;RSA&quot;) != -1) {</span>
<span class="udiff-line-modified-added">+                 AlgorithmParameters params =</span>
<span class="udiff-line-modified-added">+                     createAlgorithmParameters(sigName, paramBytes);</span>
<span class="udiff-line-modified-added">+                 paramSpec = RSAUtil.getParamSpec(params);</span>
<span class="udiff-line-added">+             } else if (sigName.indexOf(&quot;ECDSA&quot;) != -1) {</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     Provider p = Signature.getInstance(sigName).getProvider();</span>
<span class="udiff-line-added">+                     paramSpec = ECUtil.getECParameterSpec(p, paramBytes);</span>
<span class="udiff-line-added">+                 } catch (Exception e) {</span>
<span class="udiff-line-added">+                     throw new ProviderException(&quot;Error handling EC parameters&quot;, e);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 // ECUtil discards exception and returns null, so we need to check</span>
<span class="udiff-line-added">+                 // the returned value</span>
<span class="udiff-line-added">+                 if (paramSpec == null) {</span>
<span class="udiff-line-added">+                     throw new ProviderException(&quot;Error handling EC parameters&quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 throw new ProviderException</span>
<span class="udiff-line-added">+                      (&quot;Unrecognized algorithm for signature parameters &quot; +</span>
<span class="udiff-line-added">+                       sigName);</span>
<span class="udiff-line-added">+             }</span>
          }
<span class="udiff-line-added">+         return paramSpec;</span>
      }
  
<span class="udiff-line-modified-removed">-     // Special method for setting the specified AlgorithmParameter object</span>
<span class="udiff-line-modified-removed">-     // into the specified Signature object as signature parameters.</span>
<span class="udiff-line-modified-removed">-     public static void specialSetParameter(Signature sig,</span>
<span class="udiff-line-modified-removed">-             AlgorithmParameters params)</span>
<span class="udiff-line-modified-removed">-             throws InvalidAlgorithmParameterException, ProviderException {</span>
<span class="udiff-line-modified-removed">-         if (params != null) {</span>
<span class="udiff-line-modified-removed">-             String sigName = sig.getAlgorithm();</span>
<span class="udiff-line-modified-removed">-             sig.setParameter(getParamSpec(sigName, params));</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     // Utility method for initializing the specified Signature object</span>
<span class="udiff-line-modified-added">+     // for verification with the specified key and params (may be null)</span>
<span class="udiff-line-modified-added">+     public static void initVerifyWithParam(Signature s, PublicKey key,</span>
<span class="udiff-line-modified-added">+             AlgorithmParameterSpec params)</span>
<span class="udiff-line-modified-added">+             throws ProviderException, InvalidAlgorithmParameterException,</span>
<span class="udiff-line-modified-added">+             InvalidKeyException {</span>
<span class="udiff-line-modified-added">+         SharedSecrets.getJavaSecuritySignatureAccess().initVerify(s, key, params);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     // Utility method for initializing the specified Signature object</span>
<span class="udiff-line-added">+     // for verification with the specified Certificate and params (may be null)</span>
<span class="udiff-line-added">+     public static void initVerifyWithParam(Signature s,</span>
<span class="udiff-line-added">+             java.security.cert.Certificate cert,</span>
<span class="udiff-line-added">+             AlgorithmParameterSpec params)</span>
<span class="udiff-line-added">+             throws ProviderException, InvalidAlgorithmParameterException,</span>
<span class="udiff-line-added">+             InvalidKeyException {</span>
<span class="udiff-line-added">+         SharedSecrets.getJavaSecuritySignatureAccess().initVerify(s, cert, params);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Utility method for initializing the specified Signature object</span>
<span class="udiff-line-added">+     // for signing with the specified key and params (may be null)</span>
<span class="udiff-line-added">+     public static void initSignWithParam(Signature s, PrivateKey key,</span>
<span class="udiff-line-added">+             AlgorithmParameterSpec params, SecureRandom sr)</span>
<span class="udiff-line-added">+             throws ProviderException, InvalidAlgorithmParameterException,</span>
<span class="udiff-line-added">+             InvalidKeyException {</span>
<span class="udiff-line-added">+         SharedSecrets.getJavaSecuritySignatureAccess().initSign(s, key, params, sr);</span>
      }
  }
</pre>
<center><a href="SignatureFileVerifier.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../validator/PKIXValidator.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>