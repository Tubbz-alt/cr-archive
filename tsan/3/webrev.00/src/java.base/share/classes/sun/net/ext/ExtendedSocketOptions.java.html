<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.base/share/classes/sun/net/ext/ExtendedSocketOptions.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.net.ext;
 27 
 28 import java.io.FileDescriptor;
 29 import java.net.SocketException;
 30 import java.net.SocketOption;
 31 import java.util.Collections;
 32 import java.util.HashSet;
 33 import java.util.Set;
 34 
 35 /**
 36  * Defines the infrastructure to support extended socket options, beyond those
 37  * defined in {@link java.net.StandardSocketOptions}.
 38  *
 39  * Extended socket options are accessed through the jdk.net API, which is in
 40  * the jdk.net module.
 41  */
 42 public abstract class ExtendedSocketOptions {
 43 
 44     public static final short SOCK_STREAM = 1;
 45     public static final short SOCK_DGRAM = 2;
 46 
 47     private final Set&lt;SocketOption&lt;?&gt;&gt; options;
 48     private final Set&lt;SocketOption&lt;?&gt;&gt; datagramOptions;
 49     private final Set&lt;SocketOption&lt;?&gt;&gt; clientStreamOptions;
 50     private final Set&lt;SocketOption&lt;?&gt;&gt; serverStreamOptions;
 51 
 52     /** Tells whether or not the option is supported. */
 53     public final boolean isOptionSupported(SocketOption&lt;?&gt; option) {
 54         return options().contains(option);
 55     }
 56 
 57     /** Return the, possibly empty, set of extended socket options available. */
 58     public final Set&lt;SocketOption&lt;?&gt;&gt; options() { return options; }
 59 
 60     /**
 61      * Returns the (possibly empty) set of extended socket options for
 62      * stream-oriented listening sockets.
 63      */
 64     public static Set&lt;SocketOption&lt;?&gt;&gt; serverSocketOptions() {
 65         return getInstance().options0(SOCK_STREAM, true);
 66     }
 67 
 68     /**
 69      * Returns the (possibly empty) set of extended socket options for
 70      * stream-oriented connecting sockets.
 71      */
 72     public static Set&lt;SocketOption&lt;?&gt;&gt; clientSocketOptions() {
 73         return getInstance().options0(SOCK_STREAM, false);
 74     }
 75 
 76     /**
 77      * Returns the (possibly empty) set of extended socket options for
 78      * datagram-oriented sockets.
 79      */
 80     public static Set&lt;SocketOption&lt;?&gt;&gt; datagramSocketOptions() {
 81         return getInstance().options0(SOCK_DGRAM, false);
 82     }
 83 
 84     private static boolean isDatagramOption(SocketOption&lt;?&gt; option) {
 85         return !option.name().startsWith(&quot;TCP_&quot;);
 86     }
 87 
 88     private static boolean isStreamOption(SocketOption&lt;?&gt; option, boolean server) {
 89         if (server &amp;&amp; &quot;SO_FLOW_SLA&quot;.equals(option.name())) {
 90             return false;
 91         } else {
 92             return !option.name().startsWith(&quot;UDP_&quot;);
 93         }
 94     }
 95 
 96     private Set&lt;SocketOption&lt;?&gt;&gt; options0(short type, boolean server) {
 97         switch (type) {
 98             case SOCK_DGRAM:
 99                 return datagramOptions;
100             case SOCK_STREAM:
101                 if (server) {
102                     return serverStreamOptions;
103                 } else {
104                     return clientStreamOptions;
105                 }
106             default:
107                 //this will never happen
108                 throw new IllegalArgumentException(&quot;Invalid socket option type&quot;);
109         }
110     }
111 
112     /** Sets the value of a socket option, for the given socket. */
113     public abstract void setOption(FileDescriptor fd, SocketOption&lt;?&gt; option, Object value)
114             throws SocketException;
115 
116     /** Returns the value of a socket option, for the given socket. */
117     public abstract Object getOption(FileDescriptor fd, SocketOption&lt;?&gt; option)
118             throws SocketException;
119 
120     protected ExtendedSocketOptions(Set&lt;SocketOption&lt;?&gt;&gt; options) {
121         this.options = options;
122         var datagramOptions = new HashSet&lt;SocketOption&lt;?&gt;&gt;();
123         var serverStreamOptions = new HashSet&lt;SocketOption&lt;?&gt;&gt;();
124         var clientStreamOptions = new HashSet&lt;SocketOption&lt;?&gt;&gt;();
125         for (var option : options) {
126             if (isDatagramOption(option)) {
127                 datagramOptions.add(option);
128             }
129             if (isStreamOption(option, true)) {
130                 serverStreamOptions.add(option);
131             }
132             if (isStreamOption(option, false)) {
133                 clientStreamOptions.add(option);
134             }
135         }
136         this.datagramOptions = Set.copyOf(datagramOptions);
137         this.serverStreamOptions = Set.copyOf(serverStreamOptions);
138         this.clientStreamOptions = Set.copyOf(clientStreamOptions);
139     }
140 
141     private static volatile ExtendedSocketOptions instance;
142 
143     public static final ExtendedSocketOptions getInstance() { return instance; }
144 
145     /** Registers support for extended socket options. Invoked by the jdk.net module. */
146     public static final void register(ExtendedSocketOptions extOptions) {
147         if (instance != null)
148             throw new InternalError(&quot;Attempting to reregister extended options&quot;);
149 
150         instance = extOptions;
151     }
152 
153     static {
154         try {
155             // If the class is present, it will be initialized which
156             // triggers registration of the extended socket options.
157             Class&lt;?&gt; c = Class.forName(&quot;jdk.net.ExtendedSocketOptions&quot;);
158         } catch (ClassNotFoundException e) {
159             // the jdk.net module is not present =&gt; no extended socket options
160             instance = new NoExtendedSocketOptions();
161         }
162     }
163 
164     static final class NoExtendedSocketOptions extends ExtendedSocketOptions {
165 
166         NoExtendedSocketOptions() {
167             super(Collections.&lt;SocketOption&lt;?&gt;&gt;emptySet());
168         }
169 
170         @Override
171         public void setOption(FileDescriptor fd, SocketOption&lt;?&gt; option, Object value)
172             throws SocketException
173         {
174             throw new UnsupportedOperationException(
175                     &quot;no extended options: &quot; + option.name());
176         }
177 
178         @Override
179         public Object getOption(FileDescriptor fd, SocketOption&lt;?&gt; option)
180             throws SocketException
181         {
182             throw new UnsupportedOperationException(
183                     &quot;no extended options: &quot; + option.name());
184         }
185     }
186 }
    </pre>
  </body>
</html>