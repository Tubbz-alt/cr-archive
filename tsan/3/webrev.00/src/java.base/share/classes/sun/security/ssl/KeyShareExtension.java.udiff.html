<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/sun/security/ssl/KeyShareExtension.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="InputRecord.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="NewSessionTicket.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/sun/security/ssl/KeyShareExtension.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -25,31 +25,23 @@</span>
  
  package sun.security.ssl;
  
  import java.io.IOException;
  import java.nio.ByteBuffer;
<span class="udiff-line-removed">- import java.security.CryptoPrimitive;</span>
  import java.security.GeneralSecurityException;
  import java.text.MessageFormat;
  import java.util.Arrays;
  import java.util.Collections;
<span class="udiff-line-removed">- import java.util.EnumSet;</span>
  import java.util.LinkedList;
  import java.util.List;
  import java.util.Locale;
  import java.util.Map;
  import javax.net.ssl.SSLProtocolException;
<span class="udiff-line-removed">- import sun.security.ssl.DHKeyExchange.DHECredentials;</span>
<span class="udiff-line-removed">- import sun.security.ssl.DHKeyExchange.DHEPossession;</span>
<span class="udiff-line-removed">- import sun.security.ssl.ECDHKeyExchange.ECDHECredentials;</span>
<span class="udiff-line-removed">- import sun.security.ssl.ECDHKeyExchange.ECDHEPossession;</span>
  import sun.security.ssl.KeyShareExtension.CHKeyShareSpec;
  import sun.security.ssl.SSLExtension.ExtensionConsumer;
  import sun.security.ssl.SSLExtension.SSLExtensionSpec;
  import sun.security.ssl.SSLHandshake.HandshakeMessage;
<span class="udiff-line-removed">- import sun.security.ssl.SupportedGroupsExtension.NamedGroup;</span>
<span class="udiff-line-removed">- import sun.security.ssl.SupportedGroupsExtension.NamedGroupType;</span>
  import sun.security.ssl.SupportedGroupsExtension.SupportedGroups;
  import sun.security.util.HexDumpEncoder;
  
  /**
   * Pack of the &quot;key_share&quot; extensions.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -262,12 +254,11 @@</span>
  
                  SSLPossession[] poses = ke.createPossessions(chc);
                  for (SSLPossession pos : poses) {
                      // update the context
                      chc.handshakePossessions.add(pos);
<span class="udiff-line-modified-removed">-                     if (!(pos instanceof ECDHEPossession) &amp;&amp;</span>
<span class="udiff-line-removed">-                             !(pos instanceof DHEPossession)) {</span>
<span class="udiff-line-modified-added">+                     if (!(pos instanceof NamedGroupPossession)) {</span>
                          // May need more possesion types in the future.
                          continue;
                      }
  
                      keyShares.add(new KeyShareEntry(ng.id, pos.encode()));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -351,50 +342,22 @@</span>
                                  NamedGroup.nameOf(entry.namedGroupId));
                      }
                      continue;
                  }
  
<span class="udiff-line-modified-removed">-                 if (ng.type == NamedGroupType.NAMED_GROUP_ECDHE) {</span>
<span class="udiff-line-modified-removed">-                     try {</span>
<span class="udiff-line-modified-removed">-                         ECDHECredentials ecdhec =</span>
<span class="udiff-line-modified-removed">-                             ECDHECredentials.valueOf(ng, entry.keyExchange);</span>
<span class="udiff-line-modified-removed">-                         if (ecdhec != null) {</span>
<span class="udiff-line-modified-removed">-                             if (!shc.algorithmConstraints.permits(</span>
<span class="udiff-line-modified-removed">-                                     EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="udiff-line-removed">-                                     ecdhec.popPublicKey)) {</span>
<span class="udiff-line-removed">-                                 SSLLogger.warning(</span>
<span class="udiff-line-removed">-                                         &quot;ECDHE key share entry does not &quot; +</span>
<span class="udiff-line-removed">-                                         &quot;comply to algorithm constraints&quot;);</span>
<span class="udiff-line-removed">-                             } else {</span>
<span class="udiff-line-removed">-                                 credentials.add(ecdhec);</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     } catch (IOException | GeneralSecurityException ex) {</span>
<span class="udiff-line-removed">-                         SSLLogger.warning(</span>
<span class="udiff-line-removed">-                                 &quot;Cannot decode named group: &quot; +</span>
<span class="udiff-line-removed">-                                 NamedGroup.nameOf(entry.namedGroupId));</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 } else if (ng.type == NamedGroupType.NAMED_GROUP_FFDHE) {</span>
<span class="udiff-line-removed">-                     try {</span>
<span class="udiff-line-removed">-                         DHECredentials dhec =</span>
<span class="udiff-line-removed">-                                 DHECredentials.valueOf(ng, entry.keyExchange);</span>
<span class="udiff-line-removed">-                         if (dhec != null) {</span>
<span class="udiff-line-removed">-                             if (!shc.algorithmConstraints.permits(</span>
<span class="udiff-line-removed">-                                     EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="udiff-line-removed">-                                     dhec.popPublicKey)) {</span>
<span class="udiff-line-removed">-                                 SSLLogger.warning(</span>
<span class="udiff-line-removed">-                                         &quot;DHE key share entry does not &quot; +</span>
<span class="udiff-line-removed">-                                         &quot;comply to algorithm constraints&quot;);</span>
<span class="udiff-line-removed">-                             } else {</span>
<span class="udiff-line-removed">-                                 credentials.add(dhec);</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     } catch (IOException | GeneralSecurityException ex) {</span>
<span class="udiff-line-removed">-                         SSLLogger.warning(</span>
<span class="udiff-line-removed">-                                 &quot;Cannot decode named group: &quot; +</span>
<span class="udiff-line-removed">-                                 NamedGroup.nameOf(entry.namedGroupId));</span>
<span class="udiff-line-modified-added">+                 try {</span>
<span class="udiff-line-modified-added">+                     SSLCredentials kaCred =</span>
<span class="udiff-line-modified-added">+                         ng.decodeCredentials(entry.keyExchange,</span>
<span class="udiff-line-modified-added">+                         shc.algorithmConstraints,</span>
<span class="udiff-line-modified-added">+                         s -&gt; SSLLogger.warning(s));</span>
<span class="udiff-line-modified-added">+                     if (kaCred != null) {</span>
<span class="udiff-line-modified-added">+                         credentials.add(kaCred);</span>
                      }
<span class="udiff-line-added">+                 } catch (GeneralSecurityException ex) {</span>
<span class="udiff-line-added">+                     SSLLogger.warning(</span>
<span class="udiff-line-added">+                         &quot;Cannot decode named group: &quot; +</span>
<span class="udiff-line-added">+                         NamedGroup.nameOf(entry.namedGroupId));</span>
                  }
              }
  
              if (!credentials.isEmpty()) {
                  shc.handshakeCredentials.addAll(credentials);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -524,14 +487,13 @@</span>
              }
  
              KeyShareEntry keyShare = null;
              for (SSLCredentials cd : shc.handshakeCredentials) {
                  NamedGroup ng = null;
<span class="udiff-line-modified-removed">-                 if (cd instanceof ECDHECredentials) {</span>
<span class="udiff-line-modified-removed">-                     ng = ((ECDHECredentials)cd).namedGroup;</span>
<span class="udiff-line-modified-removed">-                 } else if (cd instanceof DHECredentials) {</span>
<span class="udiff-line-removed">-                     ng = ((DHECredentials)cd).namedGroup;</span>
<span class="udiff-line-modified-added">+                 if (cd instanceof NamedGroupCredentials) {</span>
<span class="udiff-line-modified-added">+                     NamedGroupCredentials creds = (NamedGroupCredentials)cd;</span>
<span class="udiff-line-modified-added">+                     ng = creds.getNamedGroup();</span>
                  }
  
                  if (ng == null) {
                      continue;
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -545,12 +507,11 @@</span>
                      continue;
                  }
  
                  SSLPossession[] poses = ke.createPossessions(shc);
                  for (SSLPossession pos : poses) {
<span class="udiff-line-modified-removed">-                     if (!(pos instanceof ECDHEPossession) &amp;&amp;</span>
<span class="udiff-line-removed">-                             !(pos instanceof DHEPossession)) {</span>
<span class="udiff-line-modified-added">+                     if (!(pos instanceof NamedGroupPossession)) {</span>
                          // May need more possesion types in the future.
                          continue;
                      }
  
                      // update the context
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -565,11 +526,11 @@</span>
                              ke.getHandshakeProducers(shc)) {
                          shc.handshakeProducers.put(
                                  me.getKey(), me.getValue());
                      }
  
<span class="udiff-line-modified-removed">-                     // We have got one! Don&#39;t forgor to break.</span>
<span class="udiff-line-modified-added">+                     // We have got one! Don&#39;t forget to break.</span>
                      break;
                  }
              }
  
              if (keyShare == null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -641,53 +602,20 @@</span>
                  throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
                          &quot;No key exchange for named group &quot; + ng.name);
              }
  
              SSLCredentials credentials = null;
<span class="udiff-line-modified-removed">-             if (ng.type == NamedGroupType.NAMED_GROUP_ECDHE) {</span>
<span class="udiff-line-modified-removed">-                 try {</span>
<span class="udiff-line-modified-removed">-                     ECDHECredentials ecdhec =</span>
<span class="udiff-line-modified-removed">-                             ECDHECredentials.valueOf(ng, keyShare.keyExchange);</span>
<span class="udiff-line-modified-removed">-                     if (ecdhec != null) {</span>
<span class="udiff-line-modified-removed">-                         if (!chc.algorithmConstraints.permits(</span>
<span class="udiff-line-removed">-                                 EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="udiff-line-removed">-                                 ecdhec.popPublicKey)) {</span>
<span class="udiff-line-removed">-                             throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="udiff-line-removed">-                                     &quot;ECDHE key share entry does not &quot; +</span>
<span class="udiff-line-removed">-                                     &quot;comply to algorithm constraints&quot;);</span>
<span class="udiff-line-removed">-                         } else {</span>
<span class="udiff-line-removed">-                             credentials = ecdhec;</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 } catch (IOException | GeneralSecurityException ex) {</span>
<span class="udiff-line-removed">-                     throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="udiff-line-removed">-                             &quot;Cannot decode named group: &quot; +</span>
<span class="udiff-line-removed">-                             NamedGroup.nameOf(keyShare.namedGroupId));</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             } else if (ng.type == NamedGroupType.NAMED_GROUP_FFDHE) {</span>
<span class="udiff-line-removed">-                 try {</span>
<span class="udiff-line-removed">-                     DHECredentials dhec =</span>
<span class="udiff-line-removed">-                             DHECredentials.valueOf(ng, keyShare.keyExchange);</span>
<span class="udiff-line-removed">-                     if (dhec != null) {</span>
<span class="udiff-line-removed">-                         if (!chc.algorithmConstraints.permits(</span>
<span class="udiff-line-removed">-                                 EnumSet.of(CryptoPrimitive.KEY_AGREEMENT),</span>
<span class="udiff-line-removed">-                                 dhec.popPublicKey)) {</span>
<span class="udiff-line-removed">-                             throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="udiff-line-removed">-                                     &quot;DHE key share entry does not &quot; +</span>
<span class="udiff-line-removed">-                                     &quot;comply to algorithm constraints&quot;);</span>
<span class="udiff-line-removed">-                         } else {</span>
<span class="udiff-line-removed">-                             credentials = dhec;</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 } catch (IOException | GeneralSecurityException ex) {</span>
<span class="udiff-line-removed">-                     throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,</span>
<span class="udiff-line-removed">-                             &quot;Cannot decode named group: &quot; +</span>
<span class="udiff-line-removed">-                             NamedGroup.nameOf(keyShare.namedGroupId));</span>
<span class="udiff-line-modified-added">+             try {</span>
<span class="udiff-line-modified-added">+                 SSLCredentials kaCred = ng.decodeCredentials(</span>
<span class="udiff-line-modified-added">+                     keyShare.keyExchange, chc.algorithmConstraints,</span>
<span class="udiff-line-modified-added">+                     s -&gt; chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE, s));</span>
<span class="udiff-line-modified-added">+                 if (kaCred != null) {</span>
<span class="udiff-line-modified-added">+                     credentials = kaCred;</span>
                  }
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-modified-added">+             } catch (GeneralSecurityException ex) {</span>
                  throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
<span class="udiff-line-modified-removed">-                         &quot;Unsupported named group: &quot; +</span>
<span class="udiff-line-modified-added">+                         &quot;Cannot decode named group: &quot; +</span>
                          NamedGroup.nameOf(keyShare.namedGroupId));
              }
  
              if (credentials == null) {
                  throw chc.conContext.fatal(Alert.UNEXPECTED_MESSAGE,
</pre>
<center><a href="InputRecord.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="NewSessionTicket.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>