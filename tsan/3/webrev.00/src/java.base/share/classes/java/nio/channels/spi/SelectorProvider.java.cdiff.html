<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/java/nio/channels/spi/SelectorProvider.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AsynchronousChannelProvider.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../charset/Charset-X-Coder.java.template.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/nio/channels/spi/SelectorProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 24,19 ***</span>
   */
  
  package java.nio.channels.spi;
  
  import java.io.IOException;
  import java.net.ProtocolFamily;
<span class="line-modified">! import java.nio.channels.*;</span>
  import java.security.AccessController;
  import java.security.PrivilegedAction;
  import java.util.Iterator;
  import java.util.ServiceLoader;
  import java.util.ServiceConfigurationError;
<span class="line-removed">- import sun.security.action.GetPropertyAction;</span>
<span class="line-removed">- </span>
  
  /**
   * Service-provider class for selectors and selectable channels.
   *
   * &lt;p&gt; A selector provider is a concrete subclass of this class that has a
<span class="line-new-header">--- 24,22 ---</span>
   */
  
  package java.nio.channels.spi;
  
  import java.io.IOException;
<span class="line-added">+ import java.lang.reflect.InvocationTargetException;</span>
  import java.net.ProtocolFamily;
<span class="line-modified">! import java.nio.channels.Channel;</span>
<span class="line-added">+ import java.nio.channels.DatagramChannel;</span>
<span class="line-added">+ import java.nio.channels.Pipe;</span>
<span class="line-added">+ import java.nio.channels.ServerSocketChannel;</span>
<span class="line-added">+ import java.nio.channels.SocketChannel;</span>
  import java.security.AccessController;
  import java.security.PrivilegedAction;
  import java.util.Iterator;
  import java.util.ServiceLoader;
  import java.util.ServiceConfigurationError;
  
  /**
   * Service-provider class for selectors and selectable channels.
   *
   * &lt;p&gt; A selector provider is a concrete subclass of this class that has a
</pre>
<hr />
<pre>
<span class="line-old-header">*** 66,13 ***</span>
   * @since 1.4
   */
  
  public abstract class SelectorProvider {
  
<span class="line-removed">-     private static final Object lock = new Object();</span>
<span class="line-removed">-     private static SelectorProvider provider = null;</span>
<span class="line-removed">- </span>
      private static Void checkPermission() {
          SecurityManager sm = System.getSecurityManager();
          if (sm != null)
              sm.checkPermission(new RuntimePermission(&quot;selectorProvider&quot;));
          return null;
<span class="line-new-header">--- 69,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 88,49 ***</span>
       */
      protected SelectorProvider() {
          this(checkPermission());
      }
  
<span class="line-modified">!     private static boolean loadProviderFromProperty() {</span>
<span class="line-modified">!         String cn = System.getProperty(&quot;java.nio.channels.spi.SelectorProvider&quot;);</span>
<span class="line-removed">-         if (cn == null)</span>
<span class="line-removed">-             return false;</span>
<span class="line-removed">-         try {</span>
<span class="line-removed">-             @SuppressWarnings(&quot;deprecation&quot;)</span>
<span class="line-removed">-             Object tmp = Class.forName(cn, true,</span>
<span class="line-removed">-                                        ClassLoader.getSystemClassLoader()).newInstance();</span>
<span class="line-removed">-             provider = (SelectorProvider)tmp;</span>
<span class="line-removed">-             return true;</span>
<span class="line-removed">-         } catch (ClassNotFoundException x) {</span>
<span class="line-removed">-             throw new ServiceConfigurationError(null, x);</span>
<span class="line-removed">-         } catch (IllegalAccessException x) {</span>
<span class="line-removed">-             throw new ServiceConfigurationError(null, x);</span>
<span class="line-removed">-         } catch (InstantiationException x) {</span>
<span class="line-removed">-             throw new ServiceConfigurationError(null, x);</span>
<span class="line-removed">-         } catch (SecurityException x) {</span>
<span class="line-removed">-             throw new ServiceConfigurationError(null, x);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
  
<span class="line-modified">!     private static boolean loadProviderAsService() {</span>
  
<span class="line-modified">!         ServiceLoader&lt;SelectorProvider&gt; sl =</span>
<span class="line-modified">!             ServiceLoader.load(SelectorProvider.class,</span>
<span class="line-modified">!                                ClassLoader.getSystemClassLoader());</span>
<span class="line-modified">!         Iterator&lt;SelectorProvider&gt; i = sl.iterator();</span>
<span class="line-removed">-         for (;;) {</span>
              try {
<span class="line-modified">!                 if (!i.hasNext())</span>
<span class="line-modified">!                     return false;</span>
<span class="line-modified">!                 provider = i.next();</span>
<span class="line-modified">!                 return true;</span>
<span class="line-modified">!             } catch (ServiceConfigurationError sce) {</span>
<span class="line-modified">!                 if (sce.getCause() instanceof SecurityException) {</span>
<span class="line-modified">!                     // Ignore the security exception, try the next provider</span>
<span class="line-modified">!                     continue;</span>
                  }
<span class="line-removed">-                 throw sce;</span>
              }
          }
      }
  
      /**
<span class="line-new-header">--- 88,57 ---</span>
       */
      protected SelectorProvider() {
          this(checkPermission());
      }
  
<span class="line-modified">!     private static class Holder {</span>
<span class="line-modified">!         static final SelectorProvider INSTANCE = provider();</span>
  
<span class="line-modified">!         static SelectorProvider provider() {</span>
<span class="line-added">+             PrivilegedAction&lt;SelectorProvider&gt; pa = () -&gt; {</span>
<span class="line-added">+                 SelectorProvider sp;</span>
<span class="line-added">+                 if ((sp = loadProviderFromProperty()) != null)</span>
<span class="line-added">+                     return sp;</span>
<span class="line-added">+                 if ((sp = loadProviderAsService()) != null)</span>
<span class="line-added">+                     return sp;</span>
<span class="line-added">+                 return sun.nio.ch.DefaultSelectorProvider.get();</span>
<span class="line-added">+             };</span>
<span class="line-added">+             return AccessController.doPrivileged(pa);</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         private static SelectorProvider loadProviderFromProperty() {</span>
<span class="line-modified">!             String cn = System.getProperty(&quot;java.nio.channels.spi.SelectorProvider&quot;);</span>
<span class="line-modified">!             if (cn == null)</span>
<span class="line-modified">!                 return null;</span>
              try {
<span class="line-modified">!                 Class&lt;?&gt; clazz = Class.forName(cn, true, ClassLoader.getSystemClassLoader());</span>
<span class="line-modified">!                 return (SelectorProvider) clazz.getConstructor().newInstance();</span>
<span class="line-modified">!             } catch (ClassNotFoundException |</span>
<span class="line-modified">!                     NoSuchMethodException |</span>
<span class="line-modified">!                     IllegalAccessException |</span>
<span class="line-modified">!                     InvocationTargetException |</span>
<span class="line-modified">!                     InstantiationException |</span>
<span class="line-modified">!                     SecurityException x) {</span>
<span class="line-added">+                 throw new ServiceConfigurationError(null, x);</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         private static SelectorProvider loadProviderAsService() {</span>
<span class="line-added">+             ServiceLoader&lt;SelectorProvider&gt; sl =</span>
<span class="line-added">+                 ServiceLoader.load(SelectorProvider.class,</span>
<span class="line-added">+                                    ClassLoader.getSystemClassLoader());</span>
<span class="line-added">+             Iterator&lt;SelectorProvider&gt; i = sl.iterator();</span>
<span class="line-added">+             for (;;) {</span>
<span class="line-added">+                 try {</span>
<span class="line-added">+                     return i.hasNext() ? i.next() : null;</span>
<span class="line-added">+                 } catch (ServiceConfigurationError sce) {</span>
<span class="line-added">+                     if (sce.getCause() instanceof SecurityException) {</span>
<span class="line-added">+                         // Ignore the security exception, try the next provider</span>
<span class="line-added">+                         continue;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     throw sce;</span>
                  }
              }
          }
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 141,14 ***</span>
       * object as follows: &lt;/p&gt;
       *
       * &lt;ol&gt;
       *
       *   &lt;li&gt;&lt;p&gt; If the system property
<span class="line-modified">!      *   {@code java.nio.channels.spi.SelectorProvider} is defined then it is</span>
<span class="line-modified">!      *   taken to be the fully-qualified name of a concrete provider class.</span>
<span class="line-modified">!      *   The class is loaded and instantiated; if this process fails then an</span>
<span class="line-modified">!      *   unspecified error is thrown.  &lt;/p&gt;&lt;/li&gt;</span>
       *
       *   &lt;li&gt;&lt;p&gt; If a provider class has been installed in a jar file that is
       *   visible to the system class loader, and that jar file contains a
       *   provider-configuration file named
       *   {@code java.nio.channels.spi.SelectorProvider} in the resource
<span class="line-new-header">--- 149,14 ---</span>
       * object as follows: &lt;/p&gt;
       *
       * &lt;ol&gt;
       *
       *   &lt;li&gt;&lt;p&gt; If the system property
<span class="line-modified">!      *   {@systemProperty java.nio.channels.spi.SelectorProvider} is defined</span>
<span class="line-modified">!      *   then it is taken to be the fully-qualified name of a concrete provider</span>
<span class="line-modified">!      *   class. The class is loaded and instantiated; if this process fails then</span>
<span class="line-modified">!      *   an unspecified error is thrown.  &lt;/p&gt;&lt;/li&gt;</span>
       *
       *   &lt;li&gt;&lt;p&gt; If a provider class has been installed in a jar file that is
       *   visible to the system class loader, and that jar file contains a
       *   provider-configuration file named
       *   {@code java.nio.channels.spi.SelectorProvider} in the resource
</pre>
<hr />
<pre>
<span class="line-old-header">*** 167,25 ***</span>
       * returned by the first invocation.  &lt;/p&gt;
       *
       * @return  The system-wide default selector provider
       */
      public static SelectorProvider provider() {
<span class="line-modified">!         synchronized (lock) {</span>
<span class="line-removed">-             if (provider != null)</span>
<span class="line-removed">-                 return provider;</span>
<span class="line-removed">-             return AccessController.doPrivileged(</span>
<span class="line-removed">-                 new PrivilegedAction&lt;&gt;() {</span>
<span class="line-removed">-                     public SelectorProvider run() {</span>
<span class="line-removed">-                             if (loadProviderFromProperty())</span>
<span class="line-removed">-                                 return provider;</span>
<span class="line-removed">-                             if (loadProviderAsService())</span>
<span class="line-removed">-                                 return provider;</span>
<span class="line-removed">-                             provider = sun.nio.ch.DefaultSelectorProvider.create();</span>
<span class="line-removed">-                             return provider;</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     });</span>
<span class="line-removed">-         }</span>
      }
  
      /**
       * Opens a datagram channel.
       *
<span class="line-new-header">--- 175,11 ---</span>
       * returned by the first invocation.  &lt;/p&gt;
       *
       * @return  The system-wide default selector provider
       */
      public static SelectorProvider provider() {
<span class="line-modified">!         return Holder.INSTANCE;</span>
      }
  
      /**
       * Opens a datagram channel.
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 315,10 ***</span>
       *          If a security manager has been installed and it denies
       *          {@link RuntimePermission}{@code (&quot;inheritedChannel&quot;)}
       *
       * @since 1.5
       */
<span class="line-modified">!    public Channel inheritedChannel() throws IOException {</span>
          return null;
<span class="line-modified">!    }</span>
  
  }
<span class="line-new-header">--- 309,10 ---</span>
       *          If a security manager has been installed and it denies
       *          {@link RuntimePermission}{@code (&quot;inheritedChannel&quot;)}
       *
       * @since 1.5
       */
<span class="line-modified">!     public Channel inheritedChannel() throws IOException {</span>
          return null;
<span class="line-modified">!     }</span>
  
  }
</pre>
<center><a href="AsynchronousChannelProvider.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../charset/Charset-X-Coder.java.template.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>