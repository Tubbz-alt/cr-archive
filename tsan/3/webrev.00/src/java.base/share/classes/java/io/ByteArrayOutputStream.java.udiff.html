<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/java/io/ByteArrayOutputStream.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="BufferedWriter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="CharArrayReader.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/io/ByteArrayOutputStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1994, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1994, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,10 +27,12 @@</span>
  
  import java.nio.charset.Charset;
  import java.util.Arrays;
  import java.util.Objects;
  
<span class="udiff-line-added">+ import jdk.internal.util.ArraysSupport;</span>
<span class="udiff-line-added">+ </span>
  /**
   * This class implements an output stream in which the data is
   * written into a byte array. The buffer automatically grows as data
   * is written to it.
   * The data can be retrieved using {@code toByteArray()} and
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -82,52 +84,24 @@</span>
      /**
       * Increases the capacity if necessary to ensure that it can hold
       * at least the number of elements specified by the minimum
       * capacity argument.
       *
<span class="udiff-line-modified-removed">-      * @param  minCapacity the desired minimum capacity</span>
<span class="udiff-line-modified-removed">-      * @throws OutOfMemoryError if {@code minCapacity &lt; 0}.  This is</span>
<span class="udiff-line-modified-removed">-      * interpreted as a request for the unsatisfiably large capacity</span>
<span class="udiff-line-modified-added">+      * @param  minCapacity the desired minimum capacity.</span>
<span class="udiff-line-modified-added">+      * @throws OutOfMemoryError if {@code minCapacity &lt; 0} and</span>
<span class="udiff-line-modified-added">+      * {@code minCapacity - buf.length &gt; 0}.  This is interpreted as a</span>
<span class="udiff-line-added">+      * request for the unsatisfiably large capacity.</span>
       * {@code (long) Integer.MAX_VALUE + (minCapacity - Integer.MAX_VALUE)}.
       */
      private void ensureCapacity(int minCapacity) {
<span class="udiff-line-removed">-         // overflow-conscious code</span>
<span class="udiff-line-removed">-         if (minCapacity - buf.length &gt; 0)</span>
<span class="udiff-line-removed">-             grow(minCapacity);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * The maximum size of array to allocate.</span>
<span class="udiff-line-removed">-      * Some VMs reserve some header words in an array.</span>
<span class="udiff-line-removed">-      * Attempts to allocate larger arrays may result in</span>
<span class="udiff-line-removed">-      * OutOfMemoryError: Requested array size exceeds VM limit</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Increases the capacity to ensure that it can hold at least the</span>
<span class="udiff-line-removed">-      * number of elements specified by the minimum capacity argument.</span>
<span class="udiff-line-removed">-      *</span>
<span class="udiff-line-removed">-      * @param minCapacity the desired minimum capacity</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     private void grow(int minCapacity) {</span>
          // overflow-conscious code
          int oldCapacity = buf.length;
<span class="udiff-line-modified-removed">-         int newCapacity = oldCapacity &lt;&lt; 1;</span>
<span class="udiff-line-modified-removed">-         if (newCapacity - minCapacity &lt; 0)</span>
<span class="udiff-line-modified-removed">-             newCapacity = minCapacity;</span>
<span class="udiff-line-modified-removed">-         if (newCapacity - MAX_ARRAY_SIZE &gt; 0)</span>
<span class="udiff-line-modified-removed">-             newCapacity = hugeCapacity(minCapacity);</span>
<span class="udiff-line-removed">-         buf = Arrays.copyOf(buf, newCapacity);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static int hugeCapacity(int minCapacity) {</span>
<span class="udiff-line-removed">-         if (minCapacity &lt; 0) // overflow</span>
<span class="udiff-line-removed">-             throw new OutOfMemoryError();</span>
<span class="udiff-line-removed">-         return (minCapacity &gt; MAX_ARRAY_SIZE) ?</span>
<span class="udiff-line-removed">-             Integer.MAX_VALUE :</span>
<span class="udiff-line-removed">-             MAX_ARRAY_SIZE;</span>
<span class="udiff-line-modified-added">+         int minGrowth = minCapacity - oldCapacity;</span>
<span class="udiff-line-modified-added">+         if (minGrowth &gt; 0) {</span>
<span class="udiff-line-modified-added">+             buf = Arrays.copyOf(buf, ArraysSupport.newLength(oldCapacity,</span>
<span class="udiff-line-modified-added">+                     minGrowth, oldCapacity /* preferred growth */));</span>
<span class="udiff-line-modified-added">+         }</span>
      }
  
      /**
       * Writes the specified byte to this {@code ByteArrayOutputStream}.
       *
</pre>
<center><a href="BufferedWriter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="CharArrayReader.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>