<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/java/util/zip/ZipFile.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ZipException.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ZipInputStream.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/util/zip/ZipFile.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1995, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1995, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -32,11 +32,10 @@</span>
  import java.io.File;
  import java.io.RandomAccessFile;
  import java.io.UncheckedIOException;
  import java.lang.ref.Cleaner.Cleanable;
  import java.nio.charset.Charset;
<span class="udiff-line-removed">- import java.nio.charset.StandardCharsets;</span>
  import java.nio.file.InvalidPathException;
  import java.nio.file.attribute.BasicFileAttributes;
  import java.nio.file.Files;
  import java.util.ArrayDeque;
  import java.util.ArrayList;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -63,10 +62,11 @@</span>
  import jdk.internal.access.SharedSecrets;
  import jdk.internal.misc.VM;
  import jdk.internal.perf.PerfCounter;
  import jdk.internal.ref.CleanerFactory;
  import jdk.internal.vm.annotation.Stable;
<span class="udiff-line-added">+ import sun.nio.cs.UTF_8;</span>
  
  import static java.util.zip.ZipConstants64.*;
  import static java.util.zip.ZipUtils.*;
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -85,12 +85,11 @@</span>
   * {@code finalize} method.
   *
   * @author      David Connelly
   * @since 1.1
   */
<span class="udiff-line-modified-removed">- public</span>
<span class="udiff-line-removed">- class ZipFile implements ZipConstants, Closeable {</span>
<span class="udiff-line-modified-added">+ public class ZipFile implements ZipConstants, Closeable {</span>
  
      private final String name;     // zip file name
      private volatile boolean closeRequested;
      private final @Stable ZipCoder zc;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -164,11 +163,11 @@</span>
       * @throws IllegalArgumentException if the {@code mode} argument is invalid
       * @see SecurityManager#checkRead(java.lang.String)
       * @since 1.3
       */
      public ZipFile(File file, int mode) throws IOException {
<span class="udiff-line-modified-removed">-         this(file, mode, StandardCharsets.UTF_8);</span>
<span class="udiff-line-modified-added">+         this(file, mode, UTF_8.INSTANCE);</span>
      }
  
      /**
       * Opens a ZIP file for reading given the specified File object.
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -671,11 +670,11 @@</span>
          e.size = CENLEN(cen, pos);
          e.csize = CENSIZ(cen, pos);
          e.method = CENHOW(cen, pos);
          if (elen != 0) {
              int start = pos + CENHDR + nlen;
<span class="udiff-line-modified-removed">-             e.setExtra0(Arrays.copyOfRange(cen, start, start + elen), true);</span>
<span class="udiff-line-modified-added">+             e.setExtra0(Arrays.copyOfRange(cen, start, start + elen), true, false);</span>
          }
          if (clen != 0) {
              int start = pos + CENHDR + nlen + elen;
              if (!zc.isUTF8() &amp;&amp; (flag &amp; USE_UTF8) != 0) {
                  e.comment = zc.toStringUTF8(cen, start, clen);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -865,10 +864,11 @@</span>
       * (possibly compressed) zip file entry.
       */
      private class ZipFileInputStream extends InputStream {
          private volatile boolean closeRequested;
          private   long pos;     // current position within entry data
<span class="udiff-line-added">+         private   long startingPos; // Start position for the entry data</span>
          protected long rem;     // number of remaining bytes within entry
          protected long size;    // uncompressed size of this entry
  
          ZipFileInputStream(byte[] cen, int cenpos) {
              rem = CENSIZ(cen, cenpos);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -936,10 +936,11 @@</span>
                  }
                  if (LOCSIG(loc) != LOCSIG) {
                      throw new ZipException(&quot;ZipFile invalid LOC header (bad signature)&quot;);
                  }
                  pos += LOCHDR + LOCNAM(loc) + LOCEXT(loc);
<span class="udiff-line-added">+                 startingPos = pos; // Save starting position for the entry</span>
              }
              return pos;
          }
  
          public int read(byte b[], int off, int len) throws IOException {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -977,12 +978,23 @@</span>
          }
  
          public long skip(long n) throws IOException {
              synchronized (ZipFile.this) {
                  initDataOffset();
<span class="udiff-line-modified-removed">-                 if (n &gt; rem) {</span>
<span class="udiff-line-modified-removed">-                     n = rem;</span>
<span class="udiff-line-modified-added">+                 long newPos = pos + n;</span>
<span class="udiff-line-modified-added">+                 if (n &gt; 0) {</span>
<span class="udiff-line-added">+                     // If we overflowed adding the skip value or are moving</span>
<span class="udiff-line-added">+                     // past EOF, set the skip value to number of bytes remaining</span>
<span class="udiff-line-added">+                     // to reach EOF</span>
<span class="udiff-line-added">+                     if (newPos &lt; 0 || n &gt; rem) {</span>
<span class="udiff-line-added">+                         n = rem;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 } else if (newPos &lt; startingPos) {</span>
<span class="udiff-line-added">+                     // Tried to position before BOF so set position to the</span>
<span class="udiff-line-added">+                     // BOF and return the number of bytes we moved backwards</span>
<span class="udiff-line-added">+                     // to reach BOF</span>
<span class="udiff-line-added">+                     n = startingPos - pos;</span>
                  }
                  pos += n;
                  rem -= n;
              }
              if (rem == 0) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1028,11 +1040,11 @@</span>
              String[] names = new String[zsrc.metanames.length];
              byte[] cen = zsrc.cen;
              for (int i = 0; i &lt; names.length; i++) {
                  int pos = zsrc.metanames[i];
                  names[i] = new String(cen, pos + CENHDR, CENNAM(cen, pos),
<span class="udiff-line-modified-removed">-                                       StandardCharsets.UTF_8);</span>
<span class="udiff-line-modified-added">+                                       UTF_8.INSTANCE);</span>
              }
              return names;
          }
      }
  
</pre>
<center><a href="ZipException.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ZipInputStream.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>