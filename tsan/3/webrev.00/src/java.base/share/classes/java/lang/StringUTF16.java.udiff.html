<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/java/lang/StringUTF16.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="StringLatin1.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SuppressWarnings.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/lang/StringUTF16.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -31,10 +31,11 @@</span>
  import java.util.function.Consumer;
  import java.util.function.IntConsumer;
  import java.util.stream.Stream;
  import java.util.stream.StreamSupport;
  import jdk.internal.HotSpotIntrinsicCandidate;
<span class="udiff-line-added">+ import jdk.internal.util.ArraysSupport;</span>
  import jdk.internal.vm.annotation.ForceInline;
  import jdk.internal.vm.annotation.DontInline;
  
  import static java.lang.String.UTF16;
  import static java.lang.String.LATIN1;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -486,11 +487,11 @@</span>
          if (Character.isValidCodePoint(ch)) {
              final char hi = Character.highSurrogate(ch);
              final char lo = Character.lowSurrogate(ch);
              checkBoundsBeginEnd(fromIndex, max, value);
              for (int i = fromIndex; i &lt; max - 1; i++) {
<span class="udiff-line-modified-removed">-                 if (getChar(value, i) == hi &amp;&amp; getChar(value, i + 1 ) == lo) {</span>
<span class="udiff-line-modified-added">+                 if (getChar(value, i) == hi &amp;&amp; getChar(value, i + 1) == lo) {</span>
                      return i;
                  }
              }
          }
          return -1;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -572,33 +573,149 @@</span>
              if (getChar(value, i) == oldChar) {
                  break;
              }
          }
          if (i &lt; len) {
<span class="udiff-line-modified-removed">-             byte buf[] = new byte[value.length];</span>
<span class="udiff-line-modified-added">+             byte[] buf = new byte[value.length];</span>
              for (int j = 0; j &lt; i; j++) {
                  putChar(buf, j, getChar(value, j)); // TBD:arraycopy?
              }
              while (i &lt; len) {
                  char c = getChar(value, i);
                  putChar(buf, i, c == oldChar ? newChar : c);
                  i++;
<span class="udiff-line-modified-removed">-            }</span>
<span class="udiff-line-modified-removed">-            // Check if we should try to compress to latin1</span>
<span class="udiff-line-modified-removed">-            if (String.COMPACT_STRINGS &amp;&amp;</span>
<span class="udiff-line-modified-removed">-                !StringLatin1.canEncode(oldChar) &amp;&amp;</span>
<span class="udiff-line-modified-removed">-                StringLatin1.canEncode(newChar)) {</span>
<span class="udiff-line-modified-removed">-                byte[] val = compress(buf, 0, len);</span>
<span class="udiff-line-modified-removed">-                if (val != null) {</span>
<span class="udiff-line-modified-removed">-                    return new String(val, LATIN1);</span>
<span class="udiff-line-modified-removed">-                }</span>
<span class="udiff-line-modified-removed">-            }</span>
<span class="udiff-line-modified-removed">-            return new String(buf, UTF16);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+             // Check if we should try to compress to latin1</span>
<span class="udiff-line-modified-added">+             if (String.COMPACT_STRINGS &amp;&amp;</span>
<span class="udiff-line-modified-added">+                 !StringLatin1.canEncode(oldChar) &amp;&amp;</span>
<span class="udiff-line-modified-added">+                 StringLatin1.canEncode(newChar)) {</span>
<span class="udiff-line-modified-added">+                 byte[] val = compress(buf, 0, len);</span>
<span class="udiff-line-modified-added">+                 if (val != null) {</span>
<span class="udiff-line-modified-added">+                     return new String(val, LATIN1);</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+             return new String(buf, UTF16);</span>
          }
          return null;
      }
  
<span class="udiff-line-added">+     public static String replace(byte[] value, int valLen, boolean valLat1,</span>
<span class="udiff-line-added">+                                  byte[] targ, int targLen, boolean targLat1,</span>
<span class="udiff-line-added">+                                  byte[] repl, int replLen, boolean replLat1)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         assert targLen &gt; 0;</span>
<span class="udiff-line-added">+         assert !valLat1 || !targLat1 || !replLat1;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         //  Possible combinations of the arguments/result encodings:</span>
<span class="udiff-line-added">+         //  +---+--------+--------+--------+-----------------------+</span>
<span class="udiff-line-added">+         //  | # | VALUE  | TARGET | REPL   | RESULT                |</span>
<span class="udiff-line-added">+         //  +===+========+========+========+=======================+</span>
<span class="udiff-line-added">+         //  | 1 | Latin1 | Latin1 |  UTF16 | null or UTF16         |</span>
<span class="udiff-line-added">+         //  +---+--------+--------+--------+-----------------------+</span>
<span class="udiff-line-added">+         //  | 2 | Latin1 |  UTF16 | Latin1 | null                  |</span>
<span class="udiff-line-added">+         //  +---+--------+--------+--------+-----------------------+</span>
<span class="udiff-line-added">+         //  | 3 | Latin1 |  UTF16 |  UTF16 | null                  |</span>
<span class="udiff-line-added">+         //  +---+--------+--------+--------+-----------------------+</span>
<span class="udiff-line-added">+         //  | 4 |  UTF16 | Latin1 | Latin1 | null or UTF16         |</span>
<span class="udiff-line-added">+         //  +---+--------+--------+--------+-----------------------+</span>
<span class="udiff-line-added">+         //  | 5 |  UTF16 | Latin1 |  UTF16 | null or UTF16         |</span>
<span class="udiff-line-added">+         //  +---+--------+--------+--------+-----------------------+</span>
<span class="udiff-line-added">+         //  | 6 |  UTF16 |  UTF16 | Latin1 | null, Latin1 or UTF16 |</span>
<span class="udiff-line-added">+         //  +---+--------+--------+--------+-----------------------+</span>
<span class="udiff-line-added">+         //  | 7 |  UTF16 |  UTF16 |  UTF16 | null or UTF16         |</span>
<span class="udiff-line-added">+         //  +---+--------+--------+--------+-----------------------+</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (String.COMPACT_STRINGS &amp;&amp; valLat1 &amp;&amp; !targLat1) {</span>
<span class="udiff-line-added">+             // combinations 2 or 3</span>
<span class="udiff-line-added">+             return null; // for string to return this;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         int i = (String.COMPACT_STRINGS &amp;&amp; valLat1)</span>
<span class="udiff-line-added">+                         ? StringLatin1.indexOf(value, targ) :</span>
<span class="udiff-line-added">+                 (String.COMPACT_STRINGS &amp;&amp; targLat1)</span>
<span class="udiff-line-added">+                         ? indexOfLatin1(value, targ)</span>
<span class="udiff-line-added">+                         : indexOf(value, targ);</span>
<span class="udiff-line-added">+         if (i &lt; 0) {</span>
<span class="udiff-line-added">+             return null; // for string to return this;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // find and store indices of substrings to replace</span>
<span class="udiff-line-added">+         int j, p = 0;</span>
<span class="udiff-line-added">+         int[] pos = new int[16];</span>
<span class="udiff-line-added">+         pos[0] = i;</span>
<span class="udiff-line-added">+         i += targLen;</span>
<span class="udiff-line-added">+         while ((j = ((String.COMPACT_STRINGS &amp;&amp; valLat1)</span>
<span class="udiff-line-added">+                             ? StringLatin1.indexOf(value, valLen, targ, targLen, i) :</span>
<span class="udiff-line-added">+                      (String.COMPACT_STRINGS &amp;&amp; targLat1)</span>
<span class="udiff-line-added">+                             ? indexOfLatin1(value, valLen, targ, targLen, i)</span>
<span class="udiff-line-added">+                             : indexOf(value, valLen, targ, targLen, i))) &gt; 0)</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+             if (++p == pos.length) {</span>
<span class="udiff-line-added">+                 pos = Arrays.copyOf(pos, ArraysSupport.newLength(p, 1, p &gt;&gt; 1));</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             pos[p] = j;</span>
<span class="udiff-line-added">+             i = j + targLen;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         int resultLen;</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             resultLen = Math.addExact(valLen,</span>
<span class="udiff-line-added">+                     Math.multiplyExact(++p, replLen - targLen));</span>
<span class="udiff-line-added">+         } catch (ArithmeticException ignored) {</span>
<span class="udiff-line-added">+             throw new OutOfMemoryError();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (resultLen == 0) {</span>
<span class="udiff-line-added">+             return &quot;&quot;;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         byte[] result = newBytesFor(resultLen);</span>
<span class="udiff-line-added">+         int posFrom = 0, posTo = 0;</span>
<span class="udiff-line-added">+         for (int q = 0; q &lt; p; ++q) {</span>
<span class="udiff-line-added">+             int nextPos = pos[q];</span>
<span class="udiff-line-added">+             if (String.COMPACT_STRINGS &amp;&amp; valLat1) {</span>
<span class="udiff-line-added">+                 while (posFrom &lt; nextPos) {</span>
<span class="udiff-line-added">+                     char c = (char)(value[posFrom++] &amp; 0xff);</span>
<span class="udiff-line-added">+                     putChar(result, posTo++, c);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 while (posFrom &lt; nextPos) {</span>
<span class="udiff-line-added">+                     putChar(result, posTo++, getChar(value, posFrom++));</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             posFrom += targLen;</span>
<span class="udiff-line-added">+             if (String.COMPACT_STRINGS &amp;&amp; replLat1) {</span>
<span class="udiff-line-added">+                 for (int k = 0; k &lt; replLen; ++k) {</span>
<span class="udiff-line-added">+                     char c = (char)(repl[k] &amp; 0xff);</span>
<span class="udiff-line-added">+                     putChar(result, posTo++, c);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 for (int k = 0; k &lt; replLen; ++k) {</span>
<span class="udiff-line-added">+                     putChar(result, posTo++, getChar(repl, k));</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (String.COMPACT_STRINGS &amp;&amp; valLat1) {</span>
<span class="udiff-line-added">+             while (posFrom &lt; valLen) {</span>
<span class="udiff-line-added">+                 char c = (char)(value[posFrom++] &amp; 0xff);</span>
<span class="udiff-line-added">+                 putChar(result, posTo++, c);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             while (posFrom &lt; valLen) {</span>
<span class="udiff-line-added">+                 putChar(result, posTo++, getChar(value, posFrom++));</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (String.COMPACT_STRINGS &amp;&amp; replLat1 &amp;&amp; !targLat1) {</span>
<span class="udiff-line-added">+             // combination 6</span>
<span class="udiff-line-added">+             byte[] lat1Result = compress(result, 0, resultLen);</span>
<span class="udiff-line-added">+             if (lat1Result != null) {</span>
<span class="udiff-line-added">+                 return new String(lat1Result, LATIN1);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return new String(result, UTF16);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public static boolean regionMatchesCI(byte[] value, int toffset,
                                            byte[] other, int ooffset, int len) {
          int last = toffset + len;
          assert toffset &gt;= 0 &amp;&amp; ooffset &gt;= 0;
          assert ooffset + len &lt;= length(other);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1000,80 +1117,14 @@</span>
          }
  
          static LinesSpliterator spliterator(byte[] value) {
              return new LinesSpliterator(value, 0, value.length &gt;&gt;&gt; 1);
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         static LinesSpliterator spliterator(byte[] value, int leading, int trailing) {</span>
<span class="udiff-line-removed">-             int length = value.length &gt;&gt;&gt; 1;</span>
<span class="udiff-line-removed">-             int left = 0;</span>
<span class="udiff-line-removed">-             int index;</span>
<span class="udiff-line-removed">-             for (int l = 0; l &lt; leading; l++) {</span>
<span class="udiff-line-removed">-                 index = skipBlankForward(value, left, length);</span>
<span class="udiff-line-removed">-                 if (index == left) {</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 left = index;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             int right = length;</span>
<span class="udiff-line-removed">-             for (int t = 0; t &lt; trailing; t++) {</span>
<span class="udiff-line-removed">-                 index = skipBlankBackward(value, left, right);</span>
<span class="udiff-line-removed">-                 if (index == right) {</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 right = index;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return new LinesSpliterator(value, left, right - left);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         private static int skipBlankForward(byte[] value, int start, int length) {</span>
<span class="udiff-line-removed">-             int index = start;</span>
<span class="udiff-line-removed">-             while (index &lt; length) {</span>
<span class="udiff-line-removed">-                 char ch = getChar(value, index++);</span>
<span class="udiff-line-removed">-                 if (ch == &#39;\n&#39;) {</span>
<span class="udiff-line-removed">-                     return index;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (ch == &#39;\r&#39;) {</span>
<span class="udiff-line-removed">-                     if (index &lt; length &amp;&amp; getChar(value, index) == &#39;\n&#39;) {</span>
<span class="udiff-line-removed">-                         return index + 1;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     return index;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (ch != &#39; &#39; &amp;&amp; ch != &#39;\t&#39; &amp;&amp; !Character.isWhitespace(ch)) {</span>
<span class="udiff-line-removed">-                     return start;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return length;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         private static int skipBlankBackward(byte[] value, int start, int fence) {</span>
<span class="udiff-line-removed">-             int index = fence;</span>
<span class="udiff-line-removed">-             if (start &lt; index &amp;&amp; getChar(value, index - 1) == &#39;\n&#39;) {</span>
<span class="udiff-line-removed">-                 index--;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (start &lt; index &amp;&amp; getChar(value, index - 1) == &#39;\r&#39;) {</span>
<span class="udiff-line-removed">-                 index--;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             while (start &lt; index) {</span>
<span class="udiff-line-removed">-                 char ch = getChar(value, --index);</span>
<span class="udiff-line-removed">-                 if (ch == &#39;\r&#39; || ch == &#39;\n&#39;) {</span>
<span class="udiff-line-removed">-                     return index + 1;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (ch != &#39; &#39; &amp;&amp; ch != &#39;\t&#39; &amp;&amp; !Character.isWhitespace(ch)) {</span>
<span class="udiff-line-removed">-                     return fence;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return start;</span>
<span class="udiff-line-removed">-         }</span>
      }
  
<span class="udiff-line-modified-removed">-     static Stream&lt;String&gt; lines(byte[] value, int leading, int trailing) {</span>
<span class="udiff-line-modified-removed">-         if (leading == 0 &amp;&amp; trailing == 0) {</span>
<span class="udiff-line-removed">-             return StreamSupport.stream(LinesSpliterator.spliterator(value), false);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             return StreamSupport.stream(LinesSpliterator.spliterator(value, leading, trailing), false);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     static Stream&lt;String&gt; lines(byte[] value) {</span>
<span class="udiff-line-modified-added">+         return StreamSupport.stream(LinesSpliterator.spliterator(value), false);</span>
      }
  
      private static void putChars(byte[] val, int index, char[] str, int off, int end) {
          while (off &lt; end) {
              putChar(val, index++, str[off++]);
</pre>
<center><a href="StringLatin1.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SuppressWarnings.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>