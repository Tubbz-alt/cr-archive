<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/classes/java/net/HttpConnectSocketImpl.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2010, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package java.net;
 27 
 28 import java.io.IOException;
 29 import java.lang.reflect.Field;
 30 import java.lang.reflect.Method;
 31 import java.util.HashMap;
 32 import java.util.Map;
 33 import java.util.Set;
 34 
 35 /**
 36  * Basic SocketImpl that relies on the internal HTTP protocol handler
<a name="2" id="anc2"></a><span class="line-modified"> 37  * implementation to perform the HTTP tunneling and authentication. Once</span>
<span class="line-modified"> 38  * connected, all socket operations delegate to a platform SocketImpl.</span>

 39  *
 40  * @since 1.8
 41  */
 42 
<a name="3" id="anc3"></a><span class="line-modified"> 43 /*package*/ class HttpConnectSocketImpl extends DelegatingSocketImpl {</span>
 44 
 45     private static final String httpURLClazzStr =
 46                                   &quot;sun.net.www.protocol.http.HttpURLConnection&quot;;
 47     private static final String netClientClazzStr = &quot;sun.net.NetworkClient&quot;;
 48     private static final String doTunnelingStr = &quot;doTunneling&quot;;
 49     private static final Field httpField;
 50     private static final Field serverSocketField;
 51     private static final Method doTunneling;
 52 
 53     private final String server;
<a name="4" id="anc4"></a><span class="line-added"> 54     private final Socket socket;</span>
 55     private InetSocketAddress external_address;
 56     private HashMap&lt;Integer, Object&gt; optionsMap = new HashMap&lt;&gt;();
 57 
 58     static  {
 59         try {
 60             Class&lt;?&gt; httpClazz = Class.forName(httpURLClazzStr, true, null);
 61             httpField = httpClazz.getDeclaredField(&quot;http&quot;);
 62             doTunneling = httpClazz.getDeclaredMethod(doTunnelingStr);
 63             Class&lt;?&gt; netClientClazz = Class.forName(netClientClazzStr, true, null);
 64             serverSocketField = netClientClazz.getDeclaredField(&quot;serverSocket&quot;);
 65 
 66             java.security.AccessController.doPrivileged(
 67                 new java.security.PrivilegedAction&lt;&gt;() {
 68                     public Void run() {
 69                         httpField.setAccessible(true);
 70                         serverSocketField.setAccessible(true);
 71                         return null;
 72                 }
 73             });
 74         } catch (ReflectiveOperationException x) {
 75             throw new InternalError(&quot;Should not reach here&quot;, x);
 76         }
 77     }
 78 
<a name="5" id="anc5"></a><span class="line-modified"> 79     HttpConnectSocketImpl(Proxy proxy, SocketImpl delegate, Socket socket) {</span>
<span class="line-modified"> 80         super(delegate);</span>
<span class="line-modified"> 81         this.socket = socket;</span>



 82         SocketAddress a = proxy.address();
 83         if ( !(a instanceof InetSocketAddress) )
 84             throw new IllegalArgumentException(&quot;Unsupported address type&quot;);
 85 
 86         InetSocketAddress ad = (InetSocketAddress) a;
 87         server = ad.getHostString();
 88         port = ad.getPort();
 89     }
 90 
<a name="6" id="anc6"></a><span class="line-added"> 91     @Override</span>
<span class="line-added"> 92     protected void connect(String host, int port) throws IOException {</span>
<span class="line-added"> 93         connect(new InetSocketAddress(host, port), 0);</span>
<span class="line-added"> 94     }</span>
<span class="line-added"> 95 </span>
<span class="line-added"> 96     @Override</span>
<span class="line-added"> 97     protected void connect(InetAddress address, int port) throws IOException {</span>
<span class="line-added"> 98         connect(new InetSocketAddress(address, port), 0);</span>
<span class="line-added"> 99     }</span>
<span class="line-added">100 </span>
101     @Override
102     protected void connect(SocketAddress endpoint, int timeout)
103         throws IOException
104     {
105         if (endpoint == null || !(endpoint instanceof InetSocketAddress))
106             throw new IllegalArgumentException(&quot;Unsupported address type&quot;);
107         final InetSocketAddress epoint = (InetSocketAddress)endpoint;
<a name="7" id="anc7"></a><span class="line-modified">108         String destHost = epoint.isUnresolved() ? epoint.getHostName()</span>
<span class="line-modified">109                                                 : epoint.getAddress().getHostAddress();</span>
110         final int destPort = epoint.getPort();
111 
112         SecurityManager security = System.getSecurityManager();
113         if (security != null)
114             security.checkConnect(destHost, destPort);
115 
<a name="8" id="anc8"></a><span class="line-added">116         if (destHost.contains(&quot;:&quot;))</span>
<span class="line-added">117             destHost = &quot;[&quot; + destHost + &quot;]&quot;;</span>
<span class="line-added">118 </span>
119         // Connect to the HTTP proxy server
120         String urlString = &quot;http://&quot; + destHost + &quot;:&quot; + destPort;
121         Socket httpSocket = privilegedDoTunnel(urlString, timeout);
122 
123         // Success!
124         external_address = epoint;
125 
126         // close the original socket impl and release its descriptor
127         close();
128 
129         // update the Sockets impl to the impl from the http Socket
<a name="9" id="anc9"></a><span class="line-modified">130         SocketImpl si = httpSocket.impl;</span>
<span class="line-modified">131         socket.setImpl(si);</span>
132 
133         // best effort is made to try and reset options previously set
134         Set&lt;Map.Entry&lt;Integer,Object&gt;&gt; options = optionsMap.entrySet();
135         try {
136             for(Map.Entry&lt;Integer,Object&gt; entry : options) {
<a name="10" id="anc10"></a><span class="line-modified">137                 si.setOption(entry.getKey(), entry.getValue());</span>
138             }
139         } catch (IOException x) {  /* gulp! */  }
140     }
141 
<a name="11" id="anc11"></a><span class="line-added">142 </span>
<span class="line-added">143     @Override</span>
<span class="line-added">144     protected void listen(int backlog) {</span>
<span class="line-added">145         throw new InternalError(&quot;should not get here&quot;);</span>
<span class="line-added">146     }</span>
<span class="line-added">147 </span>
<span class="line-added">148     @Override</span>
<span class="line-added">149     protected void accept(SocketImpl s) {</span>
<span class="line-added">150         throw new InternalError(&quot;should not get here&quot;);</span>
<span class="line-added">151     }</span>
<span class="line-added">152 </span>
<span class="line-added">153     @Override</span>
<span class="line-added">154     void reset() {</span>
<span class="line-added">155         throw new InternalError(&quot;should not get here&quot;);</span>
<span class="line-added">156     }</span>
<span class="line-added">157 </span>
158     @Override
159     public void setOption(int opt, Object val) throws SocketException {
<a name="12" id="anc12"></a><span class="line-modified">160         delegate.setOption(opt, val);</span>
161 
162         if (external_address != null)
163             return;  // we&#39;re connected, just return
164 
165         // store options so that they can be re-applied to the impl after connect
166         optionsMap.put(opt, val);
167     }
168 
169     private Socket privilegedDoTunnel(final String urlString,
170                                       final int timeout)
171         throws IOException
172     {
173         try {
174             return java.security.AccessController.doPrivileged(
175                 new java.security.PrivilegedExceptionAction&lt;&gt;() {
176                     public Socket run() throws IOException {
177                         return doTunnel(urlString, timeout);
178                 }
179             });
180         } catch (java.security.PrivilegedActionException pae) {
181             throw (IOException) pae.getException();
182         }
183     }
184 
185     private Socket doTunnel(String urlString, int connectTimeout)
186         throws IOException
187     {
188         Proxy proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress(server, port));
189         URL destURL = new URL(urlString);
190         HttpURLConnection conn = (HttpURLConnection) destURL.openConnection(proxy);
191         conn.setConnectTimeout(connectTimeout);
<a name="13" id="anc13"></a><span class="line-modified">192         int timeout = (int) getOption(SocketOptions.SO_TIMEOUT);</span>
<span class="line-added">193         if (timeout &gt; 0) {</span>
<span class="line-added">194             conn.setReadTimeout(timeout);</span>
<span class="line-added">195         }</span>
196         conn.connect();
197         doTunneling(conn);
198         try {
199             Object httpClient = httpField.get(conn);
200             return (Socket) serverSocketField.get(httpClient);
201         } catch (IllegalAccessException x) {
202             throw new InternalError(&quot;Should not reach here&quot;, x);
203         }
204     }
205 
<a name="14" id="anc14"></a><span class="line-modified">206     private void doTunneling(HttpURLConnection conn) throws IOException {</span>
207         try {
208             doTunneling.invoke(conn);
209         } catch (ReflectiveOperationException x) {
<a name="15" id="anc15"></a><span class="line-added">210             Throwable cause = x.getCause();</span>
<span class="line-added">211             if (cause instanceof IOException) {</span>
<span class="line-added">212                 throw (IOException) cause;</span>
<span class="line-added">213             }</span>
214             throw new InternalError(&quot;Should not reach here&quot;, x);
215         }
216     }
217 
218     @Override
219     protected InetAddress getInetAddress() {
220         if (external_address != null)
221             return external_address.getAddress();
222         else
<a name="16" id="anc16"></a><span class="line-modified">223             return delegate.getInetAddress();</span>
224     }
225 
226     @Override
227     protected int getPort() {
228         if (external_address != null)
229             return external_address.getPort();
230         else
<a name="17" id="anc17"></a><span class="line-modified">231             return delegate.getPort();</span>
232     }
233 }
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>