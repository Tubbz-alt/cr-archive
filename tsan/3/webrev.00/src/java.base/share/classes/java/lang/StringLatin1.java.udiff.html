<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/java/lang/StringLatin1.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="StringIndexOutOfBoundsException.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="StringUTF16.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/lang/StringLatin1.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -33,10 +33,11 @@</span>
  import java.util.function.IntConsumer;
  import java.util.stream.IntStream;
  import java.util.stream.Stream;
  import java.util.stream.StreamSupport;
  import jdk.internal.HotSpotIntrinsicCandidate;
<span class="udiff-line-added">+ import jdk.internal.util.ArraysSupport;</span>
  
  import static java.lang.String.LATIN1;
  import static java.lang.String.UTF16;
  import static java.lang.String.checkOffset;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -174,11 +175,11 @@</span>
          int lim = Math.min(len1, len2);
          for (int k = 0; k &lt; lim; k++) {
              char c1 = getChar(value, k);
              char c2 = StringUTF16.getChar(other, k);
              if (c1 != c2) {
<span class="udiff-line-modified-removed">-                 c1 = Character.toUpperCase(c1);</span>
<span class="udiff-line-modified-added">+                 c1 = (char) CharacterDataLatin1.instance.toUpperCase(c1);</span>
                  c2 = Character.toUpperCase(c2);
                  if (c1 != c2) {
                      c1 = Character.toLowerCase(c1);
                      c2 = Character.toLowerCase(c2);
                      if (c1 != c2) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -302,11 +303,11 @@</span>
                      break;
                  }
              }
              if (i &lt; len) {
                  if (canEncode(newChar)) {
<span class="udiff-line-modified-removed">-                     byte buf[] = new byte[len];</span>
<span class="udiff-line-modified-added">+                     byte[] buf = StringConcatHelper.newArray(len);</span>
                      for (int j = 0; j &lt; i; j++) {    // TBD arraycopy?
                          buf[j] = value[j];
                      }
                      while (i &lt; len) {
                          byte c = value[i];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -328,22 +329,72 @@</span>
              }
          }
          return null; // for string to return this;
      }
  
<span class="udiff-line-added">+     public static String replace(byte[] value, int valLen, byte[] targ,</span>
<span class="udiff-line-added">+                                  int targLen, byte[] repl, int replLen)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         assert targLen &gt; 0;</span>
<span class="udiff-line-added">+         int i, j, p = 0;</span>
<span class="udiff-line-added">+         if (valLen == 0 || (i = indexOf(value, valLen, targ, targLen, 0)) &lt; 0) {</span>
<span class="udiff-line-added">+             return null; // for string to return this;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // find and store indices of substrings to replace</span>
<span class="udiff-line-added">+         int[] pos = new int[16];</span>
<span class="udiff-line-added">+         pos[0] = i;</span>
<span class="udiff-line-added">+         i += targLen;</span>
<span class="udiff-line-added">+         while ((j = indexOf(value, valLen, targ, targLen, i)) &gt; 0) {</span>
<span class="udiff-line-added">+             if (++p == pos.length) {</span>
<span class="udiff-line-added">+                 pos = Arrays.copyOf(pos, ArraysSupport.newLength(p, 1, p &gt;&gt; 1));</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             pos[p] = j;</span>
<span class="udiff-line-added">+             i = j + targLen;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         int resultLen;</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             resultLen = Math.addExact(valLen,</span>
<span class="udiff-line-added">+                     Math.multiplyExact(++p, replLen - targLen));</span>
<span class="udiff-line-added">+         } catch (ArithmeticException ignored) {</span>
<span class="udiff-line-added">+             throw new OutOfMemoryError();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (resultLen == 0) {</span>
<span class="udiff-line-added">+             return &quot;&quot;;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         byte[] result = StringConcatHelper.newArray(resultLen);</span>
<span class="udiff-line-added">+         int posFrom = 0, posTo = 0;</span>
<span class="udiff-line-added">+         for (int q = 0; q &lt; p; ++q) {</span>
<span class="udiff-line-added">+             int nextPos = pos[q];</span>
<span class="udiff-line-added">+             while (posFrom &lt; nextPos) {</span>
<span class="udiff-line-added">+                 result[posTo++] = value[posFrom++];</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             posFrom += targLen;</span>
<span class="udiff-line-added">+             for (int k = 0; k &lt; replLen; ++k) {</span>
<span class="udiff-line-added">+                 result[posTo++] = repl[k];</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         while (posFrom &lt; valLen) {</span>
<span class="udiff-line-added">+             result[posTo++] = value[posFrom++];</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return new String(result, LATIN1);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      // case insensitive
      public static boolean regionMatchesCI(byte[] value, int toffset,
                                            byte[] other, int ooffset, int len) {
          int last = toffset + len;
          while (toffset &lt; last) {
              char c1 = (char)(value[toffset++] &amp; 0xff);
              char c2 = (char)(other[ooffset++] &amp; 0xff);
              if (c1 == c2) {
                  continue;
              }
<span class="udiff-line-modified-removed">-             char u1 = Character.toUpperCase(c1);</span>
<span class="udiff-line-modified-removed">-             char u2 = Character.toUpperCase(c2);</span>
<span class="udiff-line-modified-added">+             int u1 = CharacterDataLatin1.instance.toUpperCase(c1);</span>
<span class="udiff-line-modified-added">+             int u2 = CharacterDataLatin1.instance.toUpperCase(c2);</span>
              if (u1 == u2) {
                  continue;
              }
              if (Character.toLowerCase(u1) == Character.toLowerCase(u2)) {
                  continue;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -360,11 +411,11 @@</span>
              char c1 = (char)(value[toffset++] &amp; 0xff);
              char c2 = StringUTF16.getChar(other, ooffset++);
              if (c1 == c2) {
                  continue;
              }
<span class="udiff-line-modified-removed">-             char u1 = Character.toUpperCase(c1);</span>
<span class="udiff-line-modified-added">+             char u1 = (char) CharacterDataLatin1.instance.toUpperCase(c1);</span>
              char u2 = Character.toUpperCase(c2);
              if (u1 == u2) {
                  continue;
              }
              if (Character.toLowerCase(u1) == Character.toLowerCase(u2)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -382,11 +433,11 @@</span>
          int first;
          final int len = value.length;
          // Now check if there are any characters that need to be changed, or are surrogate
          for (first = 0 ; first &lt; len; first++) {
              int cp = value[first] &amp; 0xff;
<span class="udiff-line-modified-removed">-             if (cp != Character.toLowerCase(cp)) {  // no need to check Character.ERROR</span>
<span class="udiff-line-modified-added">+             if (cp != CharacterDataLatin1.instance.toLowerCase(cp)) {  // no need to check Character.ERROR</span>
                  break;
              }
          }
          if (first == len)
              return str;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -397,11 +448,11 @@</span>
          byte[] result = new byte[len];
          System.arraycopy(value, 0, result, 0, first);  // Just copy the first few
                                                         // lowerCase characters.
          for (int i = first; i &lt; len; i++) {
              int cp = value[i] &amp; 0xff;
<span class="udiff-line-modified-removed">-             cp = Character.toLowerCase(cp);</span>
<span class="udiff-line-modified-added">+             cp = CharacterDataLatin1.instance.toLowerCase(cp);</span>
              if (!canEncode(cp)) {                      // not a latin1 character
                  return toLowerCaseEx(str, value, first, locale, false);
              }
              result[i] = (byte)cp;
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -421,11 +472,11 @@</span>
              int lowerChar;
              char[] lowerCharArray;
              if (localeDependent) {
                  lowerChar = ConditionalSpecialCasing.toLowerCaseEx(str, i, locale);
              } else {
<span class="udiff-line-modified-removed">-                 lowerChar = Character.toLowerCase(srcChar);</span>
<span class="udiff-line-modified-added">+                 lowerChar = CharacterDataLatin1.instance.toLowerCase(srcChar);</span>
              }
              if (Character.isBmpCodePoint(lowerChar)) {    // Character.ERROR is not a bmp
                  StringUTF16.putChar(result, resultOffset++, lowerChar);
              } else {
                  if (lowerChar == Character.ERROR) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -456,11 +507,11 @@</span>
          final int len = value.length;
  
          // Now check if there are any characters that need to be changed, or are surrogate
          for (first = 0 ; first &lt; len; first++ ) {
              int cp = value[first] &amp; 0xff;
<span class="udiff-line-modified-removed">-             if (cp != Character.toUpperCaseEx(cp)) {   // no need to check Character.ERROR</span>
<span class="udiff-line-modified-added">+             if (cp != CharacterDataLatin1.instance.toUpperCaseEx(cp)) {   // no need to check Character.ERROR</span>
                  break;
              }
          }
          if (first == len) {
              return str;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -472,11 +523,11 @@</span>
          byte[] result = new byte[len];
          System.arraycopy(value, 0, result, 0, first);  // Just copy the first few
                                                         // upperCase characters.
          for (int i = first; i &lt; len; i++) {
              int cp = value[i] &amp; 0xff;
<span class="udiff-line-modified-removed">-             cp = Character.toUpperCaseEx(cp);</span>
<span class="udiff-line-modified-added">+             cp = CharacterDataLatin1.instance.toUpperCaseEx(cp);</span>
              if (!canEncode(cp)) {                      // not a latin1 character
                  return toUpperCaseEx(str, value, first, locale, false);
              }
              result[i] = (byte)cp;
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -496,21 +547,21 @@</span>
              int upperChar;
              char[] upperCharArray;
              if (localeDependent) {
                  upperChar = ConditionalSpecialCasing.toUpperCaseEx(str, i, locale);
              } else {
<span class="udiff-line-modified-removed">-                 upperChar = Character.toUpperCaseEx(srcChar);</span>
<span class="udiff-line-modified-added">+                 upperChar = CharacterDataLatin1.instance.toUpperCaseEx(srcChar);</span>
              }
              if (Character.isBmpCodePoint(upperChar)) {
                  StringUTF16.putChar(result, resultOffset++, upperChar);
              } else {
                  if (upperChar == Character.ERROR) {
                      if (localeDependent) {
                          upperCharArray =
                              ConditionalSpecialCasing.toUpperCaseCharArray(str, i, locale);
                      } else {
<span class="udiff-line-modified-removed">-                         upperCharArray = Character.toUpperCaseCharArray(srcChar);</span>
<span class="udiff-line-modified-added">+                         upperCharArray = CharacterDataLatin1.instance.toUpperCaseCharArray(srcChar);</span>
                      }
                  } else {
                      upperCharArray = Character.toChars(upperChar);
                  }
                  /* Grow result if needed */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -544,11 +595,11 @@</span>
      public static int indexOfNonWhitespace(byte[] value) {
          int length = value.length;
          int left = 0;
          while (left &lt; length) {
              char ch = getChar(value, left);
<span class="udiff-line-modified-removed">-             if (ch != &#39; &#39; &amp;&amp; ch != &#39;\t&#39; &amp;&amp; !Character.isWhitespace(ch)) {</span>
<span class="udiff-line-modified-added">+             if (ch != &#39; &#39; &amp;&amp; ch != &#39;\t&#39; &amp;&amp; !CharacterDataLatin1.instance.isWhitespace(ch)) {</span>
                  break;
              }
              left++;
          }
          return left;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -557,11 +608,11 @@</span>
      public static int lastIndexOfNonWhitespace(byte[] value) {
          int length = value.length;
          int right = length;
          while (0 &lt; right) {
              char ch = getChar(value, right - 1);
<span class="udiff-line-modified-removed">-             if (ch != &#39; &#39; &amp;&amp; ch != &#39;\t&#39; &amp;&amp; !Character.isWhitespace(ch)) {</span>
<span class="udiff-line-modified-added">+             if (ch != &#39; &#39; &amp;&amp; ch != &#39;\t&#39; &amp;&amp; !CharacterDataLatin1.instance.isWhitespace(ch)) {</span>
                  break;
              }
              right--;
          }
          return right;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -679,80 +730,14 @@</span>
          }
  
          static LinesSpliterator spliterator(byte[] value) {
              return new LinesSpliterator(value, 0, value.length);
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         static LinesSpliterator spliterator(byte[] value, int leading, int trailing) {</span>
<span class="udiff-line-removed">-             int length = value.length;</span>
<span class="udiff-line-removed">-             int left = 0;</span>
<span class="udiff-line-removed">-             int index;</span>
<span class="udiff-line-removed">-             for (int l = 0; l &lt; leading; l++) {</span>
<span class="udiff-line-removed">-                 index = skipBlankForward(value, left, length);</span>
<span class="udiff-line-removed">-                 if (index == left) {</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 left = index;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             int right = length;</span>
<span class="udiff-line-removed">-             for (int t = 0; t &lt; trailing; t++) {</span>
<span class="udiff-line-removed">-                 index = skipBlankBackward(value, left, right);</span>
<span class="udiff-line-removed">-                 if (index == right) {</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 right = index;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return new LinesSpliterator(value, left, right - left);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         private static int skipBlankForward(byte[] value, int start, int length) {</span>
<span class="udiff-line-removed">-             int index = start;</span>
<span class="udiff-line-removed">-             while (index &lt; length) {</span>
<span class="udiff-line-removed">-                 char ch = getChar(value, index++);</span>
<span class="udiff-line-removed">-                 if (ch == &#39;\n&#39;) {</span>
<span class="udiff-line-removed">-                     return index;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (ch == &#39;\r&#39;) {</span>
<span class="udiff-line-removed">-                     if (index &lt; length &amp;&amp; getChar(value, index) == &#39;\n&#39;) {</span>
<span class="udiff-line-removed">-                         return index + 1;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     return index;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (ch != &#39; &#39; &amp;&amp; ch != &#39;\t&#39; &amp;&amp; !Character.isWhitespace(ch)) {</span>
<span class="udiff-line-removed">-                     return start;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return length;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         private static int skipBlankBackward(byte[] value, int start, int fence) {</span>
<span class="udiff-line-removed">-             int index = fence;</span>
<span class="udiff-line-removed">-             if (start &lt; index &amp;&amp; getChar(value, index - 1) == &#39;\n&#39;) {</span>
<span class="udiff-line-removed">-                 index--;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (start &lt; index &amp;&amp; getChar(value, index - 1) == &#39;\r&#39;) {</span>
<span class="udiff-line-removed">-                 index--;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             while (start &lt; index) {</span>
<span class="udiff-line-removed">-                 char ch = getChar(value, --index);</span>
<span class="udiff-line-removed">-                 if (ch == &#39;\r&#39; || ch == &#39;\n&#39;) {</span>
<span class="udiff-line-removed">-                     return index + 1;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (ch != &#39; &#39; &amp;&amp; ch != &#39;\t&#39; &amp;&amp; !Character.isWhitespace(ch)) {</span>
<span class="udiff-line-removed">-                     return fence;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return start;</span>
<span class="udiff-line-removed">-         }</span>
      }
  
<span class="udiff-line-modified-removed">-     static Stream&lt;String&gt; lines(byte[] value, int leading, int trailing) {</span>
<span class="udiff-line-modified-removed">-         if (leading == 0 &amp;&amp; trailing == 0) {</span>
<span class="udiff-line-removed">-             return StreamSupport.stream(LinesSpliterator.spliterator(value), false);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             return StreamSupport.stream(LinesSpliterator.spliterator(value, leading, trailing), false);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     static Stream&lt;String&gt; lines(byte[] value) {</span>
<span class="udiff-line-modified-added">+         return StreamSupport.stream(LinesSpliterator.spliterator(value), false);</span>
      }
  
      public static void putChar(byte[] val, int index, int c) {
          //assert (canEncode(c));
          val[index] = (byte)(c);
</pre>
<center><a href="StringIndexOutOfBoundsException.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="StringUTF16.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>