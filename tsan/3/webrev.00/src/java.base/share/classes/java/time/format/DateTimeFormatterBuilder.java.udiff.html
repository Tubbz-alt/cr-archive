<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/java/time/format/DateTimeFormatterBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="DateTimeFormatter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DateTimeParseException.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/time/format/DateTimeFormatterBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,11 +83,10 @@</span>
  import java.time.LocalDateTime;
  import java.time.LocalTime;
  import java.time.ZoneId;
  import java.time.ZoneOffset;
  import java.time.chrono.ChronoLocalDate;
<span class="udiff-line-removed">- import java.time.chrono.ChronoLocalDateTime;</span>
  import java.time.chrono.Chronology;
  import java.time.chrono.Era;
  import java.time.chrono.IsoChronology;
  import java.time.format.DateTimeTextProvider.LocaleStore;
  import java.time.temporal.ChronoField;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -120,11 +119,10 @@</span>
  import java.util.concurrent.ConcurrentMap;
  
  import sun.text.spi.JavaTimeDateTimePatternProvider;
  import sun.util.locale.provider.CalendarDataUtility;
  import sun.util.locale.provider.LocaleProviderAdapter;
<span class="udiff-line-removed">- import sun.util.locale.provider.LocaleResources;</span>
  import sun.util.locale.provider.TimeZoneNameUtility;
  
  /**
   * Builder to create date-time formatters.
   * &lt;p&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -306,11 +304,11 @@</span>
  
      //-----------------------------------------------------------------------
      /**
       * Changes the parse style to be strict for the remainder of the formatter.
       * &lt;p&gt;
<span class="udiff-line-modified-removed">-      * Parsing can be strict or lenient - by default its strict.</span>
<span class="udiff-line-modified-added">+      * Parsing can be strict or lenient - by default it is strict.</span>
       * This controls the degree of flexibility in matching the text and sign styles.
       * &lt;p&gt;
       * When used, this method changes the parsing to be strict from this point onwards.
       * As strict is the default, this is normally only needed after calling {@link #parseLenient()}.
       * The change will remain in force until the end of the formatter that is eventually
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -325,11 +323,11 @@</span>
  
      /**
       * Changes the parse style to be lenient for the remainder of the formatter.
       * Note that case sensitivity is set separately to this method.
       * &lt;p&gt;
<span class="udiff-line-modified-removed">-      * Parsing can be strict or lenient - by default its strict.</span>
<span class="udiff-line-modified-added">+      * Parsing can be strict or lenient - by default it is strict.</span>
       * This controls the degree of flexibility in matching the text and sign styles.
       * Applications calling this method should typically also call {@link #parseCaseInsensitive()}.
       * &lt;p&gt;
       * When used, this method changes the parsing to be lenient from this point onwards.
       * The change will remain in force until the end of the formatter that is eventually
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3200,11 +3198,11 @@</span>
              int pos = position;
              while (pos &lt; maxEndPos) {
                  char ch = text.charAt(pos++);
                  int digit = context.getDecimalStyle().convertToDigit(ch);
                  if (digit &lt; 0) {
<span class="udiff-line-modified-removed">-                     if (pos &lt; minEndPos) {</span>
<span class="udiff-line-modified-added">+                     if (pos &lt;= minEndPos) {</span>
                          return ~position;  // need at least min width digits
                      }
                      pos--;
                      break;
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3869,11 +3867,15 @@</span>
          public boolean format(DateTimePrintContext context, StringBuilder buf) {
              Long offsetSecs = context.getValue(OFFSET_SECONDS);
              if (offsetSecs == null) {
                  return false;
              }
<span class="udiff-line-modified-removed">-             String gmtText = &quot;GMT&quot;;  // TODO: get localized version of &#39;GMT&#39;</span>
<span class="udiff-line-modified-added">+             String key = &quot;timezone.gmtZeroFormat&quot;;</span>
<span class="udiff-line-added">+             String gmtText = DateTimeTextProvider.getLocalizedResource(key, context.getLocale());</span>
<span class="udiff-line-added">+             if (gmtText == null) {</span>
<span class="udiff-line-added">+                 gmtText = &quot;GMT&quot;;  // Default to &quot;GMT&quot;</span>
<span class="udiff-line-added">+             }</span>
              buf.append(gmtText);
              int totalSecs = Math.toIntExact(offsetSecs);
              if (totalSecs != 0) {
                  int absHours = Math.abs((totalSecs / 3600) % 100);  // anything larger than 99 silently dropped
                  int absMinutes = Math.abs((totalSecs / 60) % 60);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3915,11 +3917,15 @@</span>
  
          @Override
          public int parse(DateTimeParseContext context, CharSequence text, int position) {
              int pos = position;
              int end = text.length();
<span class="udiff-line-modified-removed">-             String gmtText = &quot;GMT&quot;;  // TODO: get localized version of &#39;GMT&#39;</span>
<span class="udiff-line-modified-added">+             String key = &quot;timezone.gmtZeroFormat&quot;;</span>
<span class="udiff-line-added">+             String gmtText = DateTimeTextProvider.getLocalizedResource(key, context.getLocale());</span>
<span class="udiff-line-added">+             if (gmtText == null) {</span>
<span class="udiff-line-added">+                 gmtText = &quot;GMT&quot;;  // Default to &quot;GMT&quot;</span>
<span class="udiff-line-added">+             }</span>
              if (!context.subSequenceEquals(text, pos, gmtText, 0, gmtText.length())) {
                      return ~position;
                  }
              pos += gmtText.length();
              // parse normal plus/minus offset
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4115,11 +4121,12 @@</span>
              if (textStyle == TextStyle.NARROW) {
                  return super.getTree(context);
              }
              Locale locale = context.getLocale();
              boolean isCaseSensitive = context.isCaseSensitive();
<span class="udiff-line-modified-removed">-             Set&lt;String&gt; regionIds = ZoneRulesProvider.getAvailableZoneIds();</span>
<span class="udiff-line-modified-added">+             Set&lt;String&gt; regionIds = new HashSet&lt;&gt;(ZoneRulesProvider.getAvailableZoneIds());</span>
<span class="udiff-line-added">+             Set&lt;String&gt; nonRegionIds = new HashSet&lt;&gt;(64);</span>
              int regionIdsSize = regionIds.size();
  
              Map&lt;Locale, Entry&lt;Integer, SoftReference&lt;PrefixTree&gt;&gt;&gt; cached =
                  isCaseSensitive ? cachedTree : cachedTreeCI;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4131,26 +4138,42 @@</span>
                  (tree = entry.getValue().get()) == null)) {
                  tree = PrefixTree.newTree(context);
                  zoneStrings = TimeZoneNameUtility.getZoneStrings(locale);
                  for (String[] names : zoneStrings) {
                      String zid = names[0];
<span class="udiff-line-modified-removed">-                     if (!regionIds.contains(zid)) {</span>
<span class="udiff-line-modified-added">+                     if (!regionIds.remove(zid)) {</span>
<span class="udiff-line-added">+                         nonRegionIds.add(zid);</span>
                          continue;
                      }
                      tree.add(zid, zid);    // don&#39;t convert zid -&gt; metazone
                      zid = ZoneName.toZid(zid, locale);
                      int i = textStyle == TextStyle.FULL ? 1 : 2;
                      for (; i &lt; names.length; i += 2) {
                          tree.add(names[i], zid);
                      }
                  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 // add names for provider&#39;s custom ids</span>
<span class="udiff-line-added">+                 final PrefixTree t = tree;</span>
<span class="udiff-line-added">+                 regionIds.stream()</span>
<span class="udiff-line-added">+                     .filter(zid -&gt; !zid.startsWith(&quot;Etc&quot;) &amp;&amp; !zid.startsWith(&quot;GMT&quot;))</span>
<span class="udiff-line-added">+                     .forEach(cid -&gt; {</span>
<span class="udiff-line-added">+                         String[] cidNames = TimeZoneNameUtility.retrieveDisplayNames(cid, locale);</span>
<span class="udiff-line-added">+                         int i = textStyle == TextStyle.FULL ? 1 : 2;</span>
<span class="udiff-line-added">+                         for (; i &lt; cidNames.length; i += 2) {</span>
<span class="udiff-line-added">+                             if (cidNames[i] != null &amp;&amp; !cidNames[i].isEmpty()) {</span>
<span class="udiff-line-added">+                                 t.add(cidNames[i], cid);</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     });</span>
<span class="udiff-line-added">+ </span>
                  // if we have a set of preferred zones, need a copy and
                  // add the preferred zones again to overwrite
                  if (preferredZones != null) {
                      for (String[] names : zoneStrings) {
                          String zid = names[0];
<span class="udiff-line-modified-removed">-                         if (!preferredZones.contains(zid) || !regionIds.contains(zid)) {</span>
<span class="udiff-line-modified-added">+                         if (!preferredZones.contains(zid) || nonRegionIds.contains(zid)) {</span>
                              continue;
                          }
                          int i = textStyle == TextStyle.FULL ? 1 : 2;
                          for (; i &lt; names.length; i += 2) {
                              tree.add(names[i], zid);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4235,13 +4258,19 @@</span>
                  return parseOffsetBased(context, text, position, position, OffsetIdPrinterParser.INSTANCE_ID_Z);
              } else if (length &gt;= position + 2) {
                  char nextNextChar = text.charAt(position + 1);
                  if (context.charEquals(nextChar, &#39;U&#39;) &amp;&amp; context.charEquals(nextNextChar, &#39;T&#39;)) {
                      if (length &gt;= position + 3 &amp;&amp; context.charEquals(text.charAt(position + 2), &#39;C&#39;)) {
<span class="udiff-line-modified-removed">-                         return parseOffsetBased(context, text, position, position + 3, OffsetIdPrinterParser.INSTANCE_ID_ZERO);</span>
<span class="udiff-line-modified-added">+                         // There are localized zone texts that start with &quot;UTC&quot;, e.g.</span>
<span class="udiff-line-added">+                         // &quot;UTC\u221210:00&quot; (MINUS SIGN instead of HYPHEN-MINUS) in French.</span>
<span class="udiff-line-added">+                         // Exclude those ZoneText cases.</span>
<span class="udiff-line-added">+                         if (!(this instanceof ZoneTextPrinterParser)) {</span>
<span class="udiff-line-added">+                             return parseOffsetBased(context, text, position, position + 3, OffsetIdPrinterParser.INSTANCE_ID_ZERO);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         return parseOffsetBased(context, text, position, position + 2, OffsetIdPrinterParser.INSTANCE_ID_ZERO);</span>
                      }
<span class="udiff-line-removed">-                     return parseOffsetBased(context, text, position, position + 2, OffsetIdPrinterParser.INSTANCE_ID_ZERO);</span>
                  } else if (context.charEquals(nextChar, &#39;G&#39;) &amp;&amp; length &gt;= position + 3 &amp;&amp;
                          context.charEquals(nextNextChar, &#39;M&#39;) &amp;&amp; context.charEquals(text.charAt(position + 2), &#39;T&#39;)) {
                      if (length &gt;= position + 4 &amp;&amp; context.charEquals(text.charAt(position + 3), &#39;0&#39;)) {
                          context.setParsed(ZoneId.of(&quot;GMT0&quot;));
                          return position + 4;
</pre>
<center><a href="DateTimeFormatter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="DateTimeParseException.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>