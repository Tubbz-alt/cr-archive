<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/io/ObjectInputFilter.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="ObjectInput.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ObjectInputStream.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/io/ObjectInputFilter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package java.io;
 27 
 28 import java.security.AccessController;
 29 import java.security.PrivilegedAction;
 30 import java.security.Security;
 31 import java.util.ArrayList;
 32 import java.util.List;
 33 import java.util.Objects;
 34 import java.util.Optional;
 35 import java.util.function.Function;
 36 
 37 import jdk.internal.access.SharedSecrets;

 38 
 39 /**
 40  * Filter classes, array lengths, and graph metrics during deserialization.
 41  *
 42  * &lt;p&gt;&lt;strong&gt;Warning: Deserialization of untrusted data is inherently dangerous
 43  * and should be avoided. Untrusted data should be carefully validated according to the
 44  * &quot;Serialization and Deserialization&quot; section of the
 45  * {@extLink secure_coding_guidelines_javase Secure Coding Guidelines for Java SE}.
 46  * {@extLink serialization_filter_guide Serialization Filtering} describes best
 47  * practices for defensive use of serial filters.
 48  * &lt;/strong&gt;&lt;/p&gt;
 49  *
 50  * If set on an {@link ObjectInputStream}, the {@link #checkInput checkInput(FilterInfo)}
 51  * method is called to validate classes, the length of each array,
 52  * the number of objects being read from the stream, the depth of the graph,
 53  * and the total number of bytes read from the stream.
 54  * &lt;p&gt;
 55  * A filter can be set via {@link ObjectInputStream#setObjectInputFilter setObjectInputFilter}
 56  * for an individual ObjectInputStream.
 57  * A filter can be set via {@link Config#setSerialFilter(ObjectInputFilter) Config.setSerialFilter}
</pre>
<hr />
<pre>
188         /**
189          * The status is allowed.
190          */
191         ALLOWED,
192         /**
193          * The status is rejected.
194          */
195         REJECTED;
196     }
197 
198     /**
199      * A utility class to set and get the system-wide filter or create a filter
200      * from a pattern string. If a system-wide filter is set, it will be
201      * used for each {@link ObjectInputStream} that does not set its own filter.
202      * &lt;p&gt;
203      * When setting the filter, it should be stateless and idempotent,
204      * reporting the same result when passed the same arguments.
205      * &lt;p&gt;
206      * The filter is configured during the initialization of the {@code ObjectInputFilter.Config}
207      * class. For example, by calling {@link #getSerialFilter() Config.getSerialFilter}.
<span class="line-modified">208      * If the system property {@code jdk.serialFilter} is defined, it is used</span>
<span class="line-modified">209      * to configure the filter.</span>
<span class="line-modified">210      * If the system property is not defined, and the {@link java.security.Security}</span>
<span class="line-modified">211      * property {@code jdk.serialFilter} is defined then it is used to configure the filter.</span>
<span class="line-modified">212      * Otherwise, the filter is not configured during initialization.</span>



213      * The syntax for each property is the same as for the
214      * {@link #createFilter(String) createFilter} method.
<span class="line-removed">215      * If a filter is not configured, it can be set with</span>
<span class="line-removed">216      * {@link #setSerialFilter(ObjectInputFilter) Config.setSerialFilter}.</span>
217      *
218      * @since 9
219      */
220     final class Config {
221         /* No instances. */
222         private Config() {}
223 
224         /**
225          * Lock object for system-wide filter.
226          */
227         private final static Object serialFilterLock = new Object();
228 
229         /**
230          * Debug: Logger
231          */
232         private final static System.Logger configLog;
233 
234         /**
235          * Logger for debugging.
236          */
</pre>
<hr />
<pre>
239                 configLog.log(level, msg, args);
240             }
241         }
242 
243         /**
244          * The name for the system-wide deserialization filter.
245          * Used as a system property and a java.security.Security property.
246          */
247         private final static String SERIAL_FILTER_PROPNAME = &quot;jdk.serialFilter&quot;;
248 
249         /**
250          * The system-wide filter; may be null.
251          * Lookup the filter in java.security.Security or
252          * the system property.
253          */
254         private final static ObjectInputFilter configuredFilter;
255 
256         static {
257             configuredFilter = AccessController
258                     .doPrivileged((PrivilegedAction&lt;ObjectInputFilter&gt;) () -&gt; {
<span class="line-modified">259                         String props = System.getProperty(SERIAL_FILTER_PROPNAME);</span>
260                         if (props == null) {
261                             props = Security.getProperty(SERIAL_FILTER_PROPNAME);
262                         }
263                         if (props != null) {
264                             System.Logger log =
265                                     System.getLogger(&quot;java.io.serialization&quot;);
266                             log.log(System.Logger.Level.INFO,
267                                     &quot;Creating serialization filter from {0}&quot;, props);
268                             try {
269                                 return createFilter(props);
270                             } catch (RuntimeException re) {
271                                 log.log(System.Logger.Level.ERROR,
272                                         &quot;Error configuring filter: {0}&quot;, re);
273                             }
274                         }
275                         return null;
276                     });
277             configLog = (configuredFilter != null) ? System.getLogger(&quot;java.io.serialization&quot;) : null;
278 
279             // Setup shared secrets for RegistryImpl to use.
280             SharedSecrets.setJavaObjectInputFilterAccess(Config::createFilter2);
281         }
282 
283         /**
284          * Current configured filter.
285          */
<span class="line-modified">286         private static ObjectInputFilter serialFilter = configuredFilter;</span>
287 
288         /**
289          * Returns the system-wide serialization filter or {@code null} if not configured.
290          *
291          * @return the system-wide serialization filter or {@code null} if not configured
292          */
293         public static ObjectInputFilter getSerialFilter() {
<span class="line-modified">294             synchronized (serialFilterLock) {</span>
<span class="line-removed">295                 return serialFilter;</span>
<span class="line-removed">296             }</span>
297         }
298 
299         /**
300          * Set the system-wide filter if it has not already been configured or set.
301          *
302          * @param filter the serialization filter to set as the system-wide filter; not null
303          * @throws SecurityException if there is security manager and the
304          *       {@code SerializablePermission(&quot;serialFilter&quot;)} is not granted
305          * @throws IllegalStateException if the filter has already been set {@code non-null}
306          */
307         public static void setSerialFilter(ObjectInputFilter filter) {
308             Objects.requireNonNull(filter, &quot;filter&quot;);
309             SecurityManager sm = System.getSecurityManager();
310             if (sm != null) {
311                 sm.checkPermission(ObjectStreamConstants.SERIAL_FILTER_PERMISSION);
312             }
313             synchronized (serialFilterLock) {
314                 if (serialFilter != null) {
315                     throw new IllegalStateException(&quot;Serial filter can only be set once&quot;);
316                 }
</pre>
</td>
<td>
<hr />
<pre>
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package java.io;
 27 
 28 import java.security.AccessController;
 29 import java.security.PrivilegedAction;
 30 import java.security.Security;
 31 import java.util.ArrayList;
 32 import java.util.List;
 33 import java.util.Objects;
 34 import java.util.Optional;
 35 import java.util.function.Function;
 36 
 37 import jdk.internal.access.SharedSecrets;
<span class="line-added"> 38 import jdk.internal.util.StaticProperty;</span>
 39 
 40 /**
 41  * Filter classes, array lengths, and graph metrics during deserialization.
 42  *
 43  * &lt;p&gt;&lt;strong&gt;Warning: Deserialization of untrusted data is inherently dangerous
 44  * and should be avoided. Untrusted data should be carefully validated according to the
 45  * &quot;Serialization and Deserialization&quot; section of the
 46  * {@extLink secure_coding_guidelines_javase Secure Coding Guidelines for Java SE}.
 47  * {@extLink serialization_filter_guide Serialization Filtering} describes best
 48  * practices for defensive use of serial filters.
 49  * &lt;/strong&gt;&lt;/p&gt;
 50  *
 51  * If set on an {@link ObjectInputStream}, the {@link #checkInput checkInput(FilterInfo)}
 52  * method is called to validate classes, the length of each array,
 53  * the number of objects being read from the stream, the depth of the graph,
 54  * and the total number of bytes read from the stream.
 55  * &lt;p&gt;
 56  * A filter can be set via {@link ObjectInputStream#setObjectInputFilter setObjectInputFilter}
 57  * for an individual ObjectInputStream.
 58  * A filter can be set via {@link Config#setSerialFilter(ObjectInputFilter) Config.setSerialFilter}
</pre>
<hr />
<pre>
189         /**
190          * The status is allowed.
191          */
192         ALLOWED,
193         /**
194          * The status is rejected.
195          */
196         REJECTED;
197     }
198 
199     /**
200      * A utility class to set and get the system-wide filter or create a filter
201      * from a pattern string. If a system-wide filter is set, it will be
202      * used for each {@link ObjectInputStream} that does not set its own filter.
203      * &lt;p&gt;
204      * When setting the filter, it should be stateless and idempotent,
205      * reporting the same result when passed the same arguments.
206      * &lt;p&gt;
207      * The filter is configured during the initialization of the {@code ObjectInputFilter.Config}
208      * class. For example, by calling {@link #getSerialFilter() Config.getSerialFilter}.
<span class="line-modified">209      * If the Java virtual machine is started with the system property</span>
<span class="line-modified">210      * {@systemProperty jdk.serialFilter}, its value is used to configure the filter.</span>
<span class="line-modified">211      * If the system property is not defined, and the {@link java.security.Security} property</span>
<span class="line-modified">212      * {@code jdk.serialFilter} is defined then it is used to configure the filter.</span>
<span class="line-modified">213      * Otherwise, the filter is not configured during initialization and</span>
<span class="line-added">214      * can be set with {@link #setSerialFilter(ObjectInputFilter) Config.setSerialFilter}.</span>
<span class="line-added">215      * Setting the {@code jdk.serialFilter} with {@link System#setProperty(String, String)</span>
<span class="line-added">216      * System.setProperty} &lt;em&gt;does not set the filter&lt;/em&gt;.</span>
217      * The syntax for each property is the same as for the
218      * {@link #createFilter(String) createFilter} method.


219      *
220      * @since 9
221      */
222     final class Config {
223         /* No instances. */
224         private Config() {}
225 
226         /**
227          * Lock object for system-wide filter.
228          */
229         private final static Object serialFilterLock = new Object();
230 
231         /**
232          * Debug: Logger
233          */
234         private final static System.Logger configLog;
235 
236         /**
237          * Logger for debugging.
238          */
</pre>
<hr />
<pre>
241                 configLog.log(level, msg, args);
242             }
243         }
244 
245         /**
246          * The name for the system-wide deserialization filter.
247          * Used as a system property and a java.security.Security property.
248          */
249         private final static String SERIAL_FILTER_PROPNAME = &quot;jdk.serialFilter&quot;;
250 
251         /**
252          * The system-wide filter; may be null.
253          * Lookup the filter in java.security.Security or
254          * the system property.
255          */
256         private final static ObjectInputFilter configuredFilter;
257 
258         static {
259             configuredFilter = AccessController
260                     .doPrivileged((PrivilegedAction&lt;ObjectInputFilter&gt;) () -&gt; {
<span class="line-modified">261                         String props = StaticProperty.jdkSerialFilter();</span>
262                         if (props == null) {
263                             props = Security.getProperty(SERIAL_FILTER_PROPNAME);
264                         }
265                         if (props != null) {
266                             System.Logger log =
267                                     System.getLogger(&quot;java.io.serialization&quot;);
268                             log.log(System.Logger.Level.INFO,
269                                     &quot;Creating serialization filter from {0}&quot;, props);
270                             try {
271                                 return createFilter(props);
272                             } catch (RuntimeException re) {
273                                 log.log(System.Logger.Level.ERROR,
274                                         &quot;Error configuring filter: {0}&quot;, re);
275                             }
276                         }
277                         return null;
278                     });
279             configLog = (configuredFilter != null) ? System.getLogger(&quot;java.io.serialization&quot;) : null;
280 
281             // Setup shared secrets for RegistryImpl to use.
282             SharedSecrets.setJavaObjectInputFilterAccess(Config::createFilter2);
283         }
284 
285         /**
286          * Current configured filter.
287          */
<span class="line-modified">288         private static volatile ObjectInputFilter serialFilter = configuredFilter;</span>
289 
290         /**
291          * Returns the system-wide serialization filter or {@code null} if not configured.
292          *
293          * @return the system-wide serialization filter or {@code null} if not configured
294          */
295         public static ObjectInputFilter getSerialFilter() {
<span class="line-modified">296             return serialFilter;</span>


297         }
298 
299         /**
300          * Set the system-wide filter if it has not already been configured or set.
301          *
302          * @param filter the serialization filter to set as the system-wide filter; not null
303          * @throws SecurityException if there is security manager and the
304          *       {@code SerializablePermission(&quot;serialFilter&quot;)} is not granted
305          * @throws IllegalStateException if the filter has already been set {@code non-null}
306          */
307         public static void setSerialFilter(ObjectInputFilter filter) {
308             Objects.requireNonNull(filter, &quot;filter&quot;);
309             SecurityManager sm = System.getSecurityManager();
310             if (sm != null) {
311                 sm.checkPermission(ObjectStreamConstants.SERIAL_FILTER_PERMISSION);
312             }
313             synchronized (serialFilterLock) {
314                 if (serialFilter != null) {
315                     throw new IllegalStateException(&quot;Serial filter can only be set once&quot;);
316                 }
</pre>
</td>
</tr>
</table>
<center><a href="ObjectInput.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="ObjectInputStream.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>