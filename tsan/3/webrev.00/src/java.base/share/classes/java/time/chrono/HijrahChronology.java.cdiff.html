<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/java/time/chrono/HijrahChronology.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Chronology.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HijrahDate.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/time/chrono/HijrahChronology.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 58,14 ***</span>
<span class="line-new-header">--- 58,19 ---</span>
  package java.time.chrono;
  
  import static java.time.temporal.ChronoField.EPOCH_DAY;
  
  import java.io.FilePermission;
<span class="line-added">+ import java.io.IOException;</span>
  import java.io.InputStream;
  import java.io.InvalidObjectException;
  import java.io.ObjectInputStream;
  import java.io.Serializable;
<span class="line-added">+ import java.io.UncheckedIOException;</span>
<span class="line-added">+ import java.nio.file.Files;</span>
<span class="line-added">+ import java.nio.file.Path;</span>
<span class="line-added">+ import java.nio.file.StandardOpenOption;</span>
  import java.security.AccessController;
  import java.security.PrivilegedAction;
  import java.time.Clock;
  import java.time.DateTimeException;
  import java.time.Instant;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 187,10 ***</span>
<span class="line-new-header">--- 192,15 ---</span>
   * The month lengths must be between 29-32 inclusive.
   * &lt;/td&gt;
   * &lt;/tr&gt;
   * &lt;/tbody&gt;
   * &lt;/table&gt;
<span class="line-added">+  * &lt;p&gt;</span>
<span class="line-added">+  * Additional variants may be added by providing configuration properties files in</span>
<span class="line-added">+  * {@code &lt;JAVA_HOME&gt;/conf/chronology} directory. The properties</span>
<span class="line-added">+  * files should follow the naming convention of</span>
<span class="line-added">+  * {@code hijrah-config-&lt;chronology id&gt;_&lt;calendar type&gt;.properties}.</span>
   *
   * @since 1.8
   */
  public final class HijrahChronology extends AbstractChronology implements Serializable {
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 203,10 ***</span>
<span class="line-new-header">--- 213,11 ---</span>
       */
      private final transient String calendarType;
      /**
       * Serialization version.
       */
<span class="line-added">+     @java.io.Serial</span>
      private static final long serialVersionUID = 3127340209035924785L;
      /**
       * Singleton instance of the Islamic Umm Al-Qura calendar of Saudi Arabia.
       * Other Hijrah chronology variants may be available from
       * {@link Chronology#getAvailableChronologies}.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 275,10 ***</span>
<span class="line-new-header">--- 286,15 ---</span>
      static {
          INSTANCE = new HijrahChronology(&quot;Hijrah-umalqura&quot;, &quot;islamic-umalqura&quot;);
          // Register it by its aliases
          AbstractChronology.registerChrono(INSTANCE, &quot;Hijrah&quot;);
          AbstractChronology.registerChrono(INSTANCE, &quot;islamic&quot;);
<span class="line-added">+ </span>
<span class="line-added">+         // custom config chronologies</span>
<span class="line-added">+         CONF_PATH = Path.of(AccessController.doPrivileged((PrivilegedAction&lt;String&gt;)</span>
<span class="line-added">+                 () -&gt; System.getProperty(&quot;java.home&quot;)), &quot;conf&quot;, &quot;chronology&quot;);</span>
<span class="line-added">+         registerCustomChrono();</span>
      }
  
      /**
       * Create a HijrahChronology for the named variant and type.
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 797,31 ***</span>
      //-----------------------------------------------------------------------
      private static final String KEY_ID = &quot;id&quot;;
      private static final String KEY_TYPE = &quot;type&quot;;
      private static final String KEY_VERSION = &quot;version&quot;;
      private static final String KEY_ISO_START = &quot;iso-start&quot;;
  
      /**
       * Return the configuration properties from the resource.
       * &lt;p&gt;
       * The location of the variant configuration resource is:
       * &lt;pre&gt;
<span class="line-modified">!      *   &quot;/java/time/chrono/hijrah-config-&quot; + calendarType + &quot;.properties&quot;</span>
       * &lt;/pre&gt;
       *
       * @param calendarType the calendarType of the calendar variant
       * @return a Properties containing the properties read from the resource.
       * @throws Exception if access to the property resource fails
       */
<span class="line-modified">!     private Properties readConfigProperties(final String calendarType) throws Exception {</span>
<span class="line-modified">!         String resourceName = RESOURCE_PREFIX + calendarType + RESOURCE_SUFFIX;</span>
<span class="line-modified">!         PrivilegedAction&lt;InputStream&gt; getResourceAction =  () -&gt; HijrahChronology.class.getResourceAsStream(resourceName);</span>
          FilePermission perm1 = new FilePermission(&quot;&lt;&lt;ALL FILES&gt;&gt;&quot;, &quot;read&quot;);
          RuntimePermission perm2 = new RuntimePermission(&quot;accessSystemModules&quot;);
          try (InputStream is = AccessController.doPrivileged(getResourceAction, null, perm1, perm2)) {
              if (is == null) {
<span class="line-modified">!                 throw new RuntimeException(&quot;Hijrah calendar resource not found: /java/time/chrono/&quot; + resourceName);</span>
              }
              Properties props = new Properties();
              props.load(is);
              return props;
          }
<span class="line-new-header">--- 813,44 ---</span>
      //-----------------------------------------------------------------------
      private static final String KEY_ID = &quot;id&quot;;
      private static final String KEY_TYPE = &quot;type&quot;;
      private static final String KEY_VERSION = &quot;version&quot;;
      private static final String KEY_ISO_START = &quot;iso-start&quot;;
<span class="line-added">+     private static final Path CONF_PATH;</span>
  
      /**
       * Return the configuration properties from the resource.
       * &lt;p&gt;
       * The location of the variant configuration resource is:
       * &lt;pre&gt;
<span class="line-modified">!      *   &quot;/java/time/chrono/&quot; (for &quot;islamic-umalqura&quot; type), or</span>
<span class="line-added">+      *   &quot;&lt;JAVA_HOME&gt;/conf/chronology/&quot; +</span>
<span class="line-added">+      *   &quot;hijrah-config-&quot; + chronologyId + &quot;_&quot; + calendarType + &quot;.properties&quot;</span>
       * &lt;/pre&gt;
       *
<span class="line-added">+      * @param chronologyId the chronology ID of the calendar variant</span>
       * @param calendarType the calendarType of the calendar variant
       * @return a Properties containing the properties read from the resource.
       * @throws Exception if access to the property resource fails
       */
<span class="line-modified">!     private static Properties readConfigProperties(final String chronologyId, final String calendarType) throws Exception {</span>
<span class="line-modified">!         String resourceName = RESOURCE_PREFIX + chronologyId + &quot;_&quot; + calendarType + RESOURCE_SUFFIX;</span>
<span class="line-modified">!         PrivilegedAction&lt;InputStream&gt; getResourceAction =  calendarType.equals(&quot;islamic-umalqura&quot;) ?</span>
<span class="line-added">+             () -&gt; HijrahChronology.class.getResourceAsStream(resourceName) :</span>
<span class="line-added">+             () -&gt; {</span>
<span class="line-added">+                 try {</span>
<span class="line-added">+                     return Files.newInputStream(CONF_PATH.resolve(resourceName),</span>
<span class="line-added">+                             StandardOpenOption.READ);</span>
<span class="line-added">+                 } catch (IOException e) {</span>
<span class="line-added">+                     throw new UncheckedIOException(e);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             };</span>
          FilePermission perm1 = new FilePermission(&quot;&lt;&lt;ALL FILES&gt;&gt;&quot;, &quot;read&quot;);
          RuntimePermission perm2 = new RuntimePermission(&quot;accessSystemModules&quot;);
          try (InputStream is = AccessController.doPrivileged(getResourceAction, null, perm1, perm2)) {
              if (is == null) {
<span class="line-modified">!                 throw new RuntimeException(&quot;Hijrah calendar resource not found: &quot; + resourceName);</span>
              }
              Properties props = new Properties();
              props.load(is);
              return props;
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 838,11 ***</span>
       * @throws DateTimeException if initialization of the calendar data from the
       *     resource fails
       */
      private void loadCalendarData() {
          try {
<span class="line-modified">!             Properties props = readConfigProperties(calendarType);</span>
  
              Map&lt;Integer, int[]&gt; years = new HashMap&lt;&gt;();
              int minYear = Integer.MAX_VALUE;
              int maxYear = Integer.MIN_VALUE;
              String id = null;
<span class="line-new-header">--- 867,11 ---</span>
       * @throws DateTimeException if initialization of the calendar data from the
       *     resource fails
       */
      private void loadCalendarData() {
          try {
<span class="line-modified">!             Properties props = readConfigProperties(typeId, calendarType);</span>
  
              Map&lt;Integer, int[]&gt; years = new HashMap&lt;&gt;();
              int minYear = Integer.MAX_VALUE;
              int maxYear = Integer.MIN_VALUE;
              String id = null;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1006,10 ***</span>
<span class="line-new-header">--- 1035,48 ---</span>
          } catch (NumberFormatException ex) {
              throw new IllegalArgumentException(&quot;date must be yyyy-MM-dd&quot;, ex);
          }
      }
  
<span class="line-added">+     /**</span>
<span class="line-added">+      * Look for Hijrah chronology variant properties files in</span>
<span class="line-added">+      * &lt;JAVA_HOME&gt;/conf/chronology directory. Then register its chronology, if any.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     private static void registerCustomChrono() {</span>
<span class="line-added">+         AccessController.doPrivileged(</span>
<span class="line-added">+             (PrivilegedAction&lt;Void&gt;)() -&gt; {</span>
<span class="line-added">+                 if (Files.isDirectory(CONF_PATH)) {</span>
<span class="line-added">+                     try {</span>
<span class="line-added">+                         Files.list(CONF_PATH)</span>
<span class="line-added">+                             .map(p -&gt; p.getFileName().toString())</span>
<span class="line-added">+                             .filter(fn -&gt; fn.matches(&quot;hijrah-config-[^\\.]+\\.properties&quot;))</span>
<span class="line-added">+                             .map(fn -&gt; fn.replaceAll(&quot;(hijrah-config-|\\.properties)&quot;, &quot;&quot;))</span>
<span class="line-added">+                             .forEach(idtype -&gt; {</span>
<span class="line-added">+                                 int delimiterPos = idtype.indexOf(&#39;_&#39;);</span>
<span class="line-added">+                                 // &#39;_&#39; should be somewhere in the middle of idtype</span>
<span class="line-added">+                                 if (delimiterPos &gt; 1 &amp;&amp; delimiterPos &lt; idtype.length() - 1) {</span>
<span class="line-added">+                                     AbstractChronology.registerChrono(</span>
<span class="line-added">+                                         new HijrahChronology(</span>
<span class="line-added">+                                                 idtype.substring(0, delimiterPos),</span>
<span class="line-added">+                                                 idtype.substring(delimiterPos + 1)));</span>
<span class="line-added">+                                 } else {</span>
<span class="line-added">+                                     PlatformLogger.getLogger(&quot;java.time.chrono&quot;)</span>
<span class="line-added">+                                             .warning(&quot;Hijrah custom config init failed.&quot; +</span>
<span class="line-added">+                                                     &quot;&#39;&lt;id&gt;_&lt;type&gt;&#39; name convention not followed: &quot; + idtype);</span>
<span class="line-added">+                                 }</span>
<span class="line-added">+                             });</span>
<span class="line-added">+                     } catch (IOException e) {</span>
<span class="line-added">+                         PlatformLogger.getLogger(&quot;java.time.chrono&quot;)</span>
<span class="line-added">+                                 .warning(&quot;Hijrah custom config init failed.&quot;, e);</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 return null;</span>
<span class="line-added">+             },</span>
<span class="line-added">+             null,</span>
<span class="line-added">+             new FilePermission(&quot;&lt;&lt;ALL FILES&gt;&gt;&quot;, &quot;read&quot;));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      //-----------------------------------------------------------------------
      /**
       * Writes the Chronology using a
       * &lt;a href=&quot;{@docRoot}/serialized-form.html#java.time.chrono.Ser&quot;&gt;dedicated serialized form&lt;/a&gt;.
       * @serialData
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1019,19 ***</span>
<span class="line-new-header">--- 1086,21 ---</span>
       * &lt;/pre&gt;
       *
       * @return the instance of {@code Ser}, not null
       */
      @Override
<span class="line-added">+     @java.io.Serial</span>
      Object writeReplace() {
          return super.writeReplace();
      }
  
      /**
       * Defend against malicious streams.
       *
       * @param s the stream to read
       * @throws InvalidObjectException always
       */
<span class="line-added">+     @java.io.Serial</span>
      private void readObject(ObjectInputStream s) throws InvalidObjectException {
          throw new InvalidObjectException(&quot;Deserialization via serialization delegate&quot;);
      }
  }
</pre>
<center><a href="Chronology.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HijrahDate.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>