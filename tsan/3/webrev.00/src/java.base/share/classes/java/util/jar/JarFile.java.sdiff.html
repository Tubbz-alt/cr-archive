<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/util/jar/JarFile.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="JarException.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="JarInputStream.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/util/jar/JarFile.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 128  * {@code jdk.util.jar.enableMultiRelease} can be assigned one of the three
 129  * {@code String} values &lt;em&gt;true&lt;/em&gt;, &lt;em&gt;false&lt;/em&gt;, or &lt;em&gt;force&lt;/em&gt;.  The
 130  * value &lt;em&gt;true&lt;/em&gt;, the default value, enables multi-release jar file
 131  * processing.  The value &lt;em&gt;false&lt;/em&gt; disables multi-release jar processing,
 132  * ignoring the &quot;Multi-Release&quot; manifest attribute, and the versioned
 133  * directories in a multi-release jar file if they exist.  Furthermore,
 134  * the method {@link JarFile#isMultiRelease()} returns &lt;em&gt;false&lt;/em&gt;. The value
 135  * &lt;em&gt;force&lt;/em&gt; causes the {@code JarFile} to be initialized to runtime
 136  * versioning after construction.  It effectively does the same as this code:
 137  * {@code (new JarFile(File, boolean, int, JarFile.runtimeVersion())}.
 138  * &lt;/li&gt;
 139  * &lt;/ul&gt;
 140  * &lt;/div&gt;
 141  *
 142  * @author  David Connelly
 143  * @see     Manifest
 144  * @see     java.util.zip.ZipFile
 145  * @see     java.util.jar.JarEntry
 146  * @since   1.2
 147  */
<span class="line-modified"> 148 public</span>
<span class="line-modified"> 149 class JarFile extends ZipFile {</span>
<span class="line-modified"> 150     private final static Runtime.Version BASE_VERSION;</span>
<span class="line-modified"> 151     private final static int BASE_VERSION_FEATURE;</span>
<span class="line-modified"> 152     private final static Runtime.Version RUNTIME_VERSION;</span>
<span class="line-modified"> 153     private final static boolean MULTI_RELEASE_ENABLED;</span>
<span class="line-modified"> 154     private final static boolean MULTI_RELEASE_FORCED;</span>

 155     private SoftReference&lt;Manifest&gt; manRef;
 156     private JarEntry manEntry;
 157     private JarVerifier jv;
 158     private boolean jvInitialized;
 159     private boolean verify;
 160     private final Runtime.Version version;  // current version
<span class="line-modified"> 161     private final int versionFeature;         // version.feature()</span>
 162     private boolean isMultiRelease;         // is jar multi-release?
 163 
 164     // indicates if Class-Path attribute present
 165     private boolean hasClassPathAttribute;
 166     // true if manifest checked for special attributes
 167     private volatile boolean hasCheckedSpecialAttributes;
 168 
 169     private static final JavaUtilZipFileAccess JUZFA;
 170 
 171     static {
 172         // Set up JavaUtilJarAccess in SharedSecrets
 173         SharedSecrets.setJavaUtilJarAccess(new JavaUtilJarAccessImpl());
 174         // Get JavaUtilZipFileAccess from SharedSecrets
 175         JUZFA = SharedSecrets.getJavaUtilZipFileAccess();
 176         // multi-release jar file versions &gt;= 9
 177         BASE_VERSION = Runtime.Version.parse(Integer.toString(8));
 178         BASE_VERSION_FEATURE = BASE_VERSION.feature();
 179         String jarVersion = GetPropertyAction.privilegedGetProperty(&quot;jdk.util.jar.version&quot;);
 180         int runtimeVersion = Runtime.version().feature();
 181         if (jarVersion != null) {
</pre>
<hr />
<pre>
1015                         byte[] lbuf = new byte[512];
1016                         Attributes attr = new Attributes();
1017                         attr.read(new Manifest.FastInputStream(
1018                             new ByteArrayInputStream(b)), lbuf);
1019                         isMultiRelease = Boolean.parseBoolean(
1020                             attr.getValue(Attributes.Name.MULTI_RELEASE));
1021                     }
1022                 }
1023             }
1024             hasCheckedSpecialAttributes = true;
1025         }
1026     }
1027 
1028     synchronized void ensureInitialization() {
1029         try {
1030             maybeInstantiateVerifier();
1031         } catch (IOException e) {
1032             throw new RuntimeException(e);
1033         }
1034         if (jv != null &amp;&amp; !jvInitialized) {
<span class="line-modified">1035             initializeVerifier();</span>
<span class="line-modified">1036             jvInitialized = true;</span>





1037         }
1038     }
1039 





1040     /*
1041      * Returns a versioned {@code JarFileEntry} for the given entry,
1042      * if there is one. Otherwise returns the original entry. This
1043      * is invoked by the {@code entries2} for verifier.
1044      */
1045     JarEntry newEntry(JarEntry je) {
1046         if (isMultiRelease()) {
1047             return getVersionedEntry(je.getName(), je);
1048         }
1049         return je;
1050     }
1051 
1052     /*
1053      * Returns a versioned {@code JarFileEntry} for the given entry
1054      * name, if there is one. Otherwise returns a {@code JarFileEntry}
1055      * with the given name. It is invoked from JarVerifier&#39;s entries2
1056      * for {@code singers}.
1057      */
1058     JarEntry newEntry(String name) {
1059         if (isMultiRelease()) {
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 128  * {@code jdk.util.jar.enableMultiRelease} can be assigned one of the three
 129  * {@code String} values &lt;em&gt;true&lt;/em&gt;, &lt;em&gt;false&lt;/em&gt;, or &lt;em&gt;force&lt;/em&gt;.  The
 130  * value &lt;em&gt;true&lt;/em&gt;, the default value, enables multi-release jar file
 131  * processing.  The value &lt;em&gt;false&lt;/em&gt; disables multi-release jar processing,
 132  * ignoring the &quot;Multi-Release&quot; manifest attribute, and the versioned
 133  * directories in a multi-release jar file if they exist.  Furthermore,
 134  * the method {@link JarFile#isMultiRelease()} returns &lt;em&gt;false&lt;/em&gt;. The value
 135  * &lt;em&gt;force&lt;/em&gt; causes the {@code JarFile} to be initialized to runtime
 136  * versioning after construction.  It effectively does the same as this code:
 137  * {@code (new JarFile(File, boolean, int, JarFile.runtimeVersion())}.
 138  * &lt;/li&gt;
 139  * &lt;/ul&gt;
 140  * &lt;/div&gt;
 141  *
 142  * @author  David Connelly
 143  * @see     Manifest
 144  * @see     java.util.zip.ZipFile
 145  * @see     java.util.jar.JarEntry
 146  * @since   1.2
 147  */
<span class="line-modified"> 148 public class JarFile extends ZipFile {</span>
<span class="line-modified"> 149     private static final Runtime.Version BASE_VERSION;</span>
<span class="line-modified"> 150     private static final int BASE_VERSION_FEATURE;</span>
<span class="line-modified"> 151     private static final Runtime.Version RUNTIME_VERSION;</span>
<span class="line-modified"> 152     private static final boolean MULTI_RELEASE_ENABLED;</span>
<span class="line-modified"> 153     private static final boolean MULTI_RELEASE_FORCED;</span>
<span class="line-modified"> 154     private static final ThreadLocal&lt;Boolean&gt; isInitializing = new ThreadLocal&lt;&gt;();</span>
<span class="line-added"> 155 </span>
 156     private SoftReference&lt;Manifest&gt; manRef;
 157     private JarEntry manEntry;
 158     private JarVerifier jv;
 159     private boolean jvInitialized;
 160     private boolean verify;
 161     private final Runtime.Version version;  // current version
<span class="line-modified"> 162     private final int versionFeature;       // version.feature()</span>
 163     private boolean isMultiRelease;         // is jar multi-release?
 164 
 165     // indicates if Class-Path attribute present
 166     private boolean hasClassPathAttribute;
 167     // true if manifest checked for special attributes
 168     private volatile boolean hasCheckedSpecialAttributes;
 169 
 170     private static final JavaUtilZipFileAccess JUZFA;
 171 
 172     static {
 173         // Set up JavaUtilJarAccess in SharedSecrets
 174         SharedSecrets.setJavaUtilJarAccess(new JavaUtilJarAccessImpl());
 175         // Get JavaUtilZipFileAccess from SharedSecrets
 176         JUZFA = SharedSecrets.getJavaUtilZipFileAccess();
 177         // multi-release jar file versions &gt;= 9
 178         BASE_VERSION = Runtime.Version.parse(Integer.toString(8));
 179         BASE_VERSION_FEATURE = BASE_VERSION.feature();
 180         String jarVersion = GetPropertyAction.privilegedGetProperty(&quot;jdk.util.jar.version&quot;);
 181         int runtimeVersion = Runtime.version().feature();
 182         if (jarVersion != null) {
</pre>
<hr />
<pre>
1016                         byte[] lbuf = new byte[512];
1017                         Attributes attr = new Attributes();
1018                         attr.read(new Manifest.FastInputStream(
1019                             new ByteArrayInputStream(b)), lbuf);
1020                         isMultiRelease = Boolean.parseBoolean(
1021                             attr.getValue(Attributes.Name.MULTI_RELEASE));
1022                     }
1023                 }
1024             }
1025             hasCheckedSpecialAttributes = true;
1026         }
1027     }
1028 
1029     synchronized void ensureInitialization() {
1030         try {
1031             maybeInstantiateVerifier();
1032         } catch (IOException e) {
1033             throw new RuntimeException(e);
1034         }
1035         if (jv != null &amp;&amp; !jvInitialized) {
<span class="line-modified">1036             isInitializing.set(Boolean.TRUE);</span>
<span class="line-modified">1037             try {</span>
<span class="line-added">1038                 initializeVerifier();</span>
<span class="line-added">1039                 jvInitialized = true;</span>
<span class="line-added">1040             } finally {</span>
<span class="line-added">1041                 isInitializing.set(Boolean.FALSE);</span>
<span class="line-added">1042             }</span>
1043         }
1044     }
1045 
<span class="line-added">1046     static boolean isInitializing() {</span>
<span class="line-added">1047         Boolean value = isInitializing.get();</span>
<span class="line-added">1048         return (value == null) ? false : value;</span>
<span class="line-added">1049     }</span>
<span class="line-added">1050 </span>
1051     /*
1052      * Returns a versioned {@code JarFileEntry} for the given entry,
1053      * if there is one. Otherwise returns the original entry. This
1054      * is invoked by the {@code entries2} for verifier.
1055      */
1056     JarEntry newEntry(JarEntry je) {
1057         if (isMultiRelease()) {
1058             return getVersionedEntry(je.getName(), je);
1059         }
1060         return je;
1061     }
1062 
1063     /*
1064      * Returns a versioned {@code JarFileEntry} for the given entry
1065      * name, if there is one. Otherwise returns a {@code JarFileEntry}
1066      * with the given name. It is invoked from JarVerifier&#39;s entries2
1067      * for {@code singers}.
1068      */
1069     JarEntry newEntry(String name) {
1070         if (isMultiRelease()) {
</pre>
</td>
</tr>
</table>
<center><a href="JarException.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="JarInputStream.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>