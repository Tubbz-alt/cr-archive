<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/java/nio/Heap-X-Buffer.java.template</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="Direct-X-Buffer.java.template.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="MappedByteBuffer.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/nio/Heap-X-Buffer.java.template</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -26,10 +26,11 @@</span>
  #warn This file is preprocessed before being compiled
  
  package java.nio;
  
  import java.util.Objects;
<span class="udiff-line-added">+ import jdk.internal.access.foreign.MemorySegmentProxy;</span>
  
  /**
  #if[rw]
   * A read/write Heap$Type$Buffer.
  #else[rw]
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -56,51 +57,51 @@</span>
      protected final $type$[] hb;
      protected final int offset;
  #end[rw]
      */
  
<span class="udiff-line-modified-removed">-     Heap$Type$Buffer$RW$(int cap, int lim) {            // package-private</span>
<span class="udiff-line-modified-added">+     Heap$Type$Buffer$RW$(int cap, int lim, MemorySegmentProxy segment) {            // package-private</span>
  #if[rw]
<span class="udiff-line-modified-removed">-         super(-1, 0, lim, cap, new $type$[cap], 0);</span>
<span class="udiff-line-modified-added">+         super(-1, 0, lim, cap, new $type$[cap], 0, segment);</span>
          /*
          hb = new $type$[cap];
          offset = 0;
          */
          this.address = ARRAY_BASE_OFFSET;
  #else[rw]
<span class="udiff-line-modified-removed">-         super(cap, lim);</span>
<span class="udiff-line-modified-added">+         super(cap, lim, segment);</span>
          this.isReadOnly = true;
  #end[rw]
      }
  
<span class="udiff-line-modified-removed">-     Heap$Type$Buffer$RW$($type$[] buf, int off, int len) { // package-private</span>
<span class="udiff-line-modified-added">+     Heap$Type$Buffer$RW$($type$[] buf, int off, int len, MemorySegmentProxy segment) { // package-private</span>
  #if[rw]
<span class="udiff-line-modified-removed">-         super(-1, off, off + len, buf.length, buf, 0);</span>
<span class="udiff-line-modified-added">+         super(-1, off, off + len, buf.length, buf, 0, segment);</span>
          /*
          hb = buf;
          offset = 0;
          */
          this.address = ARRAY_BASE_OFFSET;
  #else[rw]
<span class="udiff-line-modified-removed">-         super(buf, off, len);</span>
<span class="udiff-line-modified-added">+         super(buf, off, len, segment);</span>
          this.isReadOnly = true;
  #end[rw]
      }
  
      protected Heap$Type$Buffer$RW$($type$[] buf,
                                     int mark, int pos, int lim, int cap,
<span class="udiff-line-modified-removed">-                                    int off)</span>
<span class="udiff-line-modified-added">+                                    int off, MemorySegmentProxy segment)</span>
      {
  #if[rw]
<span class="udiff-line-modified-removed">-         super(mark, pos, lim, cap, buf, off);</span>
<span class="udiff-line-modified-added">+         super(mark, pos, lim, cap, buf, off, segment);</span>
          /*
          hb = buf;
          offset = off;
          */
          this.address = ARRAY_BASE_OFFSET + off * ARRAY_INDEX_SCALE;
  #else[rw]
<span class="udiff-line-modified-removed">-         super(buf, mark, pos, lim, cap, off);</span>
<span class="udiff-line-modified-added">+         super(buf, mark, pos, lim, cap, off, segment);</span>
          this.isReadOnly = true;
  #end[rw]
      }
  
      public $Type$Buffer slice() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -108,41 +109,41 @@</span>
          return new Heap$Type$Buffer$RW$(hb,
                                          -1,
                                          0,
                                          rem,
                                          rem,
<span class="udiff-line-modified-removed">-                                         this.position() + offset);</span>
<span class="udiff-line-modified-added">+                                         this.position() + offset, segment);</span>
      }
  
      @Override
      public $Type$Buffer slice(int index, int length) {
          Objects.checkFromIndexSize(index, length, limit());
          return new Heap$Type$Buffer$RW$(hb,
                                          -1,
                                          0,
                                          length,
                                          length,
<span class="udiff-line-modified-removed">-                                         index + offset);</span>
<span class="udiff-line-modified-added">+                                         index + offset, segment);</span>
      }
  
      public $Type$Buffer duplicate() {
          return new Heap$Type$Buffer$RW$(hb,
                                          this.markValue(),
                                          this.position(),
                                          this.limit(),
                                          this.capacity(),
<span class="udiff-line-modified-removed">-                                         offset);</span>
<span class="udiff-line-modified-added">+                                         offset, segment);</span>
      }
  
      public $Type$Buffer asReadOnlyBuffer() {
  #if[rw]
          return new Heap$Type$BufferR(hb,
                                       this.markValue(),
                                       this.position(),
                                       this.limit(),
                                       this.capacity(),
<span class="udiff-line-modified-removed">-                                      offset);</span>
<span class="udiff-line-modified-added">+                                      offset, segment);</span>
  #else[rw]
          return duplicate();
  #end[rw]
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -157,34 +158,38 @@</span>
          return address + i;
      }
  #end[byte]
  
      public $type$ get() {
<span class="udiff-line-added">+         checkSegment();</span>
          return hb[ix(nextGetIndex())];
      }
  
      public $type$ get(int i) {
<span class="udiff-line-added">+         checkSegment();</span>
          return hb[ix(checkIndex(i))];
      }
  
  #if[streamableType]
      $type$ getUnchecked(int i) {
<span class="udiff-line-modified-removed">- 	return hb[ix(i)];</span>
<span class="udiff-line-modified-added">+     return hb[ix(i)];</span>
      }
  #end[streamableType]
  
      public $Type$Buffer get($type$[] dst, int offset, int length) {
<span class="udiff-line-modified-removed">-         checkBounds(offset, length, dst.length);</span>
<span class="udiff-line-modified-added">+         checkSegment();</span>
<span class="udiff-line-added">+         Objects.checkFromIndexSize(offset, length, dst.length);</span>
          int pos = position();
          if (length &gt; limit() - pos)
              throw new BufferUnderflowException();
          System.arraycopy(hb, ix(pos), dst, offset, length);
          position(pos + length);
          return this;
      }
  
      public $Type$Buffer get(int index, $type$[] dst, int offset, int length) {
<span class="udiff-line-added">+         checkSegment();</span>
          Objects.checkFromIndexSize(index, length, limit());
          Objects.checkFromIndexSize(offset, length, dst.length);
          System.arraycopy(hb, ix(index), dst, offset, length);
          return this;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -199,29 +204,32 @@</span>
          return {#if[rw]?false:true};
      }
  
      public $Type$Buffer put($type$ x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          hb[ix(nextPutIndex())] = x;
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
      }
  
      public $Type$Buffer put(int i, $type$ x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          hb[ix(checkIndex(i))] = x;
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
      }
  
      public $Type$Buffer put($type$[] src, int offset, int length) {
  #if[rw]
<span class="udiff-line-modified-removed">-         checkBounds(offset, length, src.length);</span>
<span class="udiff-line-modified-added">+         checkSegment();</span>
<span class="udiff-line-added">+         Objects.checkFromIndexSize(offset, length, src.length);</span>
          int pos = position();
          if (length &gt; limit() - pos)
              throw new BufferOverflowException();
          System.arraycopy(src, offset, hb, ix(pos), length);
          position(pos + length);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -231,10 +239,11 @@</span>
  #end[rw]
      }
  
      public $Type$Buffer put($Type$Buffer src) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          if (src instanceof Heap$Type$Buffer) {
              if (src == this)
                  throw createSameBufferException();
              Heap$Type$Buffer sb = (Heap$Type$Buffer)src;
              int pos = position();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -262,10 +271,11 @@</span>
  #end[rw]
      }
  
      public $Type$Buffer put(int index, $type$[] src, int offset, int length) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          Objects.checkFromIndexSize(index, length, limit());
          Objects.checkFromIndexSize(offset, length, src.length);
          System.arraycopy(src, offset, hb, ix(index), length);
          return this;
  #else[rw]
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -274,12 +284,13 @@</span>
      }
  
  #if[char]
  
      public $Type$Buffer put(String src, int start, int end) {
<span class="udiff-line-added">+         checkSegment();</span>
          int length = end - start;
<span class="udiff-line-modified-removed">-         checkBounds(start, length, src.length());</span>
<span class="udiff-line-modified-added">+         Objects.checkFromIndexSize(start, length, src.length());</span>
          if (isReadOnly())
              throw new ReadOnlyBufferException();
          int pos = position();
          int lim = limit();
          int rem = (pos &lt;= lim) ? lim - pos : 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -325,10 +336,11 @@</span>
      // char
  
  #if[rw]
  
      public char getChar() {
<span class="udiff-line-added">+         checkSegment();</span>
          return UNSAFE.getCharUnaligned(hb, byteOffset(nextGetIndex(2)), bigEndian);
      }
  
      public char getChar(int i) {
          return UNSAFE.getCharUnaligned(hb, byteOffset(checkIndex(i, 2)), bigEndian);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -336,19 +348,21 @@</span>
  
  #end[rw]
  
      public $Type$Buffer putChar(char x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          UNSAFE.putCharUnaligned(hb, byteOffset(nextPutIndex(2)), x, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
      }
  
      public $Type$Buffer putChar(int i, char x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          UNSAFE.putCharUnaligned(hb, byteOffset(checkIndex(i, 2)), x, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -362,45 +376,49 @@</span>
                  ? (CharBuffer)(new ByteBufferAsCharBuffer$RW$B(this,
                                                                 -1,
                                                                 0,
                                                                 size,
                                                                 size,
<span class="udiff-line-modified-removed">-                                                                addr))</span>
<span class="udiff-line-modified-added">+                                                                addr, segment))</span>
                  : (CharBuffer)(new ByteBufferAsCharBuffer$RW$L(this,
                                                                 -1,
                                                                 0,
                                                                 size,
                                                                 size,
<span class="udiff-line-modified-removed">-                                                                addr)));</span>
<span class="udiff-line-modified-added">+                                                                addr, segment)));</span>
      }
  
  
      // short
  
  #if[rw]
  
      public short getShort() {
<span class="udiff-line-added">+         checkSegment();</span>
          return UNSAFE.getShortUnaligned(hb, byteOffset(nextGetIndex(2)), bigEndian);
      }
  
      public short getShort(int i) {
<span class="udiff-line-added">+         checkSegment();</span>
          return UNSAFE.getShortUnaligned(hb, byteOffset(checkIndex(i, 2)), bigEndian);
      }
  
  #end[rw]
  
      public $Type$Buffer putShort(short x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          UNSAFE.putShortUnaligned(hb, byteOffset(nextPutIndex(2)), x, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
      }
  
      public $Type$Buffer putShort(int i, short x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          UNSAFE.putShortUnaligned(hb, byteOffset(checkIndex(i, 2)), x, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -414,45 +432,49 @@</span>
                  ? (ShortBuffer)(new ByteBufferAsShortBuffer$RW$B(this,
                                                                   -1,
                                                                   0,
                                                                   size,
                                                                   size,
<span class="udiff-line-modified-removed">-                                                                  addr))</span>
<span class="udiff-line-modified-added">+                                                                  addr, segment))</span>
                  : (ShortBuffer)(new ByteBufferAsShortBuffer$RW$L(this,
                                                                   -1,
                                                                   0,
                                                                   size,
                                                                   size,
<span class="udiff-line-modified-removed">-                                                                  addr)));</span>
<span class="udiff-line-modified-added">+                                                                  addr, segment)));</span>
      }
  
  
      // int
  
  #if[rw]
  
      public int getInt() {
<span class="udiff-line-added">+         checkSegment();</span>
          return UNSAFE.getIntUnaligned(hb, byteOffset(nextGetIndex(4)), bigEndian);
      }
  
      public int getInt(int i) {
<span class="udiff-line-added">+         checkSegment();</span>
          return UNSAFE.getIntUnaligned(hb, byteOffset(checkIndex(i, 4)), bigEndian);
      }
  
  #end[rw]
  
      public $Type$Buffer putInt(int x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          UNSAFE.putIntUnaligned(hb, byteOffset(nextPutIndex(4)), x, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
      }
  
      public $Type$Buffer putInt(int i, int x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          UNSAFE.putIntUnaligned(hb, byteOffset(checkIndex(i, 4)), x, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -466,45 +488,49 @@</span>
                  ? (IntBuffer)(new ByteBufferAsIntBuffer$RW$B(this,
                                                               -1,
                                                               0,
                                                               size,
                                                               size,
<span class="udiff-line-modified-removed">-                                                              addr))</span>
<span class="udiff-line-modified-added">+                                                              addr, segment))</span>
                  : (IntBuffer)(new ByteBufferAsIntBuffer$RW$L(this,
                                                               -1,
                                                               0,
                                                               size,
                                                               size,
<span class="udiff-line-modified-removed">-                                                              addr)));</span>
<span class="udiff-line-modified-added">+                                                              addr, segment)));</span>
      }
  
  
      // long
  
  #if[rw]
  
      public long getLong() {
<span class="udiff-line-added">+         checkSegment();</span>
          return UNSAFE.getLongUnaligned(hb, byteOffset(nextGetIndex(8)), bigEndian);
      }
  
      public long getLong(int i) {
<span class="udiff-line-added">+         checkSegment();</span>
          return UNSAFE.getLongUnaligned(hb, byteOffset(checkIndex(i, 8)), bigEndian);
      }
  
  #end[rw]
  
      public $Type$Buffer putLong(long x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          UNSAFE.putLongUnaligned(hb, byteOffset(nextPutIndex(8)), x, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
      }
  
      public $Type$Buffer putLong(int i, long x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          UNSAFE.putLongUnaligned(hb, byteOffset(checkIndex(i, 8)), x, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -518,48 +544,52 @@</span>
                  ? (LongBuffer)(new ByteBufferAsLongBuffer$RW$B(this,
                                                                 -1,
                                                                 0,
                                                                 size,
                                                                 size,
<span class="udiff-line-modified-removed">-                                                                addr))</span>
<span class="udiff-line-modified-added">+                                                                addr, segment))</span>
                  : (LongBuffer)(new ByteBufferAsLongBuffer$RW$L(this,
                                                                 -1,
                                                                 0,
                                                                 size,
                                                                 size,
<span class="udiff-line-modified-removed">-                                                                addr)));</span>
<span class="udiff-line-modified-added">+                                                                addr, segment)));</span>
      }
  
  
      // float
  
  #if[rw]
  
      public float getFloat() {
<span class="udiff-line-added">+         checkSegment();</span>
          int x = UNSAFE.getIntUnaligned(hb, byteOffset(nextGetIndex(4)), bigEndian);
          return Float.intBitsToFloat(x);
      }
  
      public float getFloat(int i) {
<span class="udiff-line-added">+         checkSegment();</span>
          int x = UNSAFE.getIntUnaligned(hb, byteOffset(checkIndex(i, 4)), bigEndian);
          return Float.intBitsToFloat(x);
      }
  
  #end[rw]
  
      public $Type$Buffer putFloat(float x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          int y = Float.floatToRawIntBits(x);
          UNSAFE.putIntUnaligned(hb, byteOffset(nextPutIndex(4)), y, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
      }
  
      public $Type$Buffer putFloat(int i, float x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          int y = Float.floatToRawIntBits(x);
          UNSAFE.putIntUnaligned(hb, byteOffset(checkIndex(i, 4)), y, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -574,48 +604,52 @@</span>
                  ? (FloatBuffer)(new ByteBufferAsFloatBuffer$RW$B(this,
                                                                   -1,
                                                                   0,
                                                                   size,
                                                                   size,
<span class="udiff-line-modified-removed">-                                                                  addr))</span>
<span class="udiff-line-modified-added">+                                                                  addr, segment))</span>
                  : (FloatBuffer)(new ByteBufferAsFloatBuffer$RW$L(this,
                                                                   -1,
                                                                   0,
                                                                   size,
                                                                   size,
<span class="udiff-line-modified-removed">-                                                                  addr)));</span>
<span class="udiff-line-modified-added">+                                                                  addr, segment)));</span>
      }
  
  
      // double
  
  #if[rw]
  
      public double getDouble() {
<span class="udiff-line-added">+         checkSegment();</span>
          long x = UNSAFE.getLongUnaligned(hb, byteOffset(nextGetIndex(8)), bigEndian);
          return Double.longBitsToDouble(x);
      }
  
      public double getDouble(int i) {
<span class="udiff-line-added">+         checkSegment();</span>
          long x = UNSAFE.getLongUnaligned(hb, byteOffset(checkIndex(i, 8)), bigEndian);
          return Double.longBitsToDouble(x);
      }
  
  #end[rw]
  
      public $Type$Buffer putDouble(double x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          long y = Double.doubleToRawLongBits(x);
          UNSAFE.putLongUnaligned(hb, byteOffset(nextPutIndex(8)), y, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
  #end[rw]
      }
  
      public $Type$Buffer putDouble(int i, double x) {
  #if[rw]
<span class="udiff-line-added">+         checkSegment();</span>
          long y = Double.doubleToRawLongBits(x);
          UNSAFE.putLongUnaligned(hb, byteOffset(checkIndex(i, 8)), y, bigEndian);
          return this;
  #else[rw]
          throw new ReadOnlyBufferException();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -630,17 +664,17 @@</span>
                  ? (DoubleBuffer)(new ByteBufferAsDoubleBuffer$RW$B(this,
                                                                     -1,
                                                                     0,
                                                                     size,
                                                                     size,
<span class="udiff-line-modified-removed">-                                                                    addr))</span>
<span class="udiff-line-modified-added">+                                                                    addr, segment))</span>
                  : (DoubleBuffer)(new ByteBufferAsDoubleBuffer$RW$L(this,
                                                                     -1,
                                                                     0,
                                                                     size,
                                                                     size,
<span class="udiff-line-modified-removed">-                                                                    addr)));</span>
<span class="udiff-line-modified-added">+                                                                    addr, segment)));</span>
      }
  
  
  #end[byte]
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -657,21 +691,18 @@</span>
  
  
      // --- Methods to support CharSequence ---
  
      public CharBuffer subSequence(int start, int end) {
<span class="udiff-line-removed">-         if ((start &lt; 0)</span>
<span class="udiff-line-removed">-             || (end &gt; length())</span>
<span class="udiff-line-removed">-             || (start &gt; end))</span>
<span class="udiff-line-removed">-             throw new IndexOutOfBoundsException();</span>
          int pos = position();
<span class="udiff-line-added">+         Objects.checkFromToIndex(start, end, limit() - pos);</span>
          return new HeapCharBuffer$RW$(hb,
                                        -1,
                                        pos + start,
                                        pos + end,
                                        capacity(),
<span class="udiff-line-modified-removed">-                                       offset);</span>
<span class="udiff-line-modified-added">+                                       offset, segment);</span>
      }
  
  #end[char]
  
  
</pre>
<center><a href="Direct-X-Buffer.java.template.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="MappedByteBuffer.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>