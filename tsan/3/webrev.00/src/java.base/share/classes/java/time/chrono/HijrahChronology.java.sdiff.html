<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/time/chrono/HijrahChronology.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Chronology.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HijrahDate.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/time/chrono/HijrahChronology.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  43  *    without specific prior written permission.
  44  *
  45  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  46  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  47  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
  48  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
  49  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
  50  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  51  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
  52  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
  53  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
  54  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
  55  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  56  */
  57 
  58 package java.time.chrono;
  59 
  60 import static java.time.temporal.ChronoField.EPOCH_DAY;
  61 
  62 import java.io.FilePermission;

  63 import java.io.InputStream;
  64 import java.io.InvalidObjectException;
  65 import java.io.ObjectInputStream;
  66 import java.io.Serializable;




  67 import java.security.AccessController;
  68 import java.security.PrivilegedAction;
  69 import java.time.Clock;
  70 import java.time.DateTimeException;
  71 import java.time.Instant;
  72 import java.time.LocalDate;
  73 import java.time.ZoneId;
  74 import java.time.format.ResolverStyle;
  75 import java.time.temporal.ChronoField;
  76 import java.time.temporal.TemporalAccessor;
  77 import java.time.temporal.TemporalField;
  78 import java.time.temporal.ValueRange;
  79 import java.util.Arrays;
  80 import java.util.HashMap;
  81 import java.util.List;
  82 import java.util.Map;
  83 import java.util.Properties;
  84 
  85 import sun.util.logging.PlatformLogger;
  86 
</pre>
<hr />
<pre>
 172  * &lt;th scope=&quot;row&quot;&gt;version&lt;/th&gt;
 173  * &lt;td&gt;Version, for example: &quot;1.8.0_1&quot;&lt;/td&gt;
 174  * &lt;td&gt;The version of the Hijrah variant data&lt;/td&gt;
 175  * &lt;/tr&gt;
 176  * &lt;tr&gt;
 177  * &lt;th scope=&quot;row&quot;&gt;iso-start&lt;/th&gt;
 178  * &lt;td&gt;ISO start date, formatted as {@code yyyy-MM-dd}, for example: &quot;1900-04-30&quot;&lt;/td&gt;
 179  * &lt;td&gt;The ISO date of the first day of the minimum Hijrah year.&lt;/td&gt;
 180  * &lt;/tr&gt;
 181  * &lt;tr&gt;
 182  * &lt;th scope=&quot;row&quot;&gt;yyyy - a numeric 4 digit year, for example &quot;1434&quot;&lt;/th&gt;
 183  * &lt;td&gt;The value is a sequence of 12 month lengths,
 184  * for example: &quot;29 30 29 30 29 30 30 30 29 30 29 29&quot;&lt;/td&gt;
 185  * &lt;td&gt;The lengths of the 12 months of the year separated by whitespace.
 186  * A numeric year property must be present for every year without any gaps.
 187  * The month lengths must be between 29-32 inclusive.
 188  * &lt;/td&gt;
 189  * &lt;/tr&gt;
 190  * &lt;/tbody&gt;
 191  * &lt;/table&gt;





 192  *
 193  * @since 1.8
 194  */
 195 public final class HijrahChronology extends AbstractChronology implements Serializable {
 196 
 197     /**
 198      * The Hijrah Calendar id.
 199      */
 200     private final transient String typeId;
 201     /**
 202      * The Hijrah calendarType.
 203      */
 204     private final transient String calendarType;
 205     /**
 206      * Serialization version.
 207      */

 208     private static final long serialVersionUID = 3127340209035924785L;
 209     /**
 210      * Singleton instance of the Islamic Umm Al-Qura calendar of Saudi Arabia.
 211      * Other Hijrah chronology variants may be available from
 212      * {@link Chronology#getAvailableChronologies}.
 213      */
 214     public static final HijrahChronology INSTANCE;
 215     /**
 216      * Flag to indicate the initialization of configuration data is complete.
 217      * @see #checkCalendarInit()
 218      */
 219     private transient volatile boolean initComplete;
 220     /**
 221      * Array of epoch days indexed by Hijrah Epoch month.
 222      * Computed by {@link #loadCalendarData}.
 223      */
 224     private transient int[] hijrahEpochMonthStartDays;
 225     /**
 226      * The minimum epoch day of this Hijrah calendar.
 227      * Computed by {@link #loadCalendarData}.
</pre>
<hr />
<pre>
 260 
 261     /**
 262      * Prefix of resource names for Hijrah calendar variants.
 263      */
 264     private static final String RESOURCE_PREFIX = &quot;hijrah-config-&quot;;
 265 
 266     /**
 267      * Suffix of resource names for Hijrah calendar variants.
 268      */
 269     private static final String RESOURCE_SUFFIX = &quot;.properties&quot;;
 270 
 271     /**
 272      * Static initialization of the built-in calendars.
 273      * The data is not loaded until it is used.
 274      */
 275     static {
 276         INSTANCE = new HijrahChronology(&quot;Hijrah-umalqura&quot;, &quot;islamic-umalqura&quot;);
 277         // Register it by its aliases
 278         AbstractChronology.registerChrono(INSTANCE, &quot;Hijrah&quot;);
 279         AbstractChronology.registerChrono(INSTANCE, &quot;islamic&quot;);





 280     }
 281 
 282     /**
 283      * Create a HijrahChronology for the named variant and type.
 284      *
 285      * @param id the id of the calendar
 286      * @param calType the typeId of the calendar
 287      * @throws IllegalArgumentException if the id or typeId is empty
 288      */
 289     private HijrahChronology(String id, String calType) {
 290         if (id.isEmpty()) {
 291             throw new IllegalArgumentException(&quot;calendar id is empty&quot;);
 292         }
 293         if (calType.isEmpty()) {
 294             throw new IllegalArgumentException(&quot;calendar typeId is empty&quot;);
 295         }
 296         this.typeId = id;
 297         this.calendarType = calType;
 298     }
 299 
</pre>
<hr />
<pre>
 782     }
 783 
 784     /**
 785      * Returns the length of the epochMonth. It is computed from the start of
 786      * the following month minus the start of the requested month.
 787      *
 788      * @param epochMonth the epochMonth; assumed to be within range
 789      * @return the length in days of the epochMonth
 790      */
 791     private int epochMonthLength(int epochMonth) {
 792         // The very last entry in the epochMonth table is not the start of a month
 793         return hijrahEpochMonthStartDays[epochMonth + 1]
 794                 - hijrahEpochMonthStartDays[epochMonth];
 795     }
 796 
 797     //-----------------------------------------------------------------------
 798     private static final String KEY_ID = &quot;id&quot;;
 799     private static final String KEY_TYPE = &quot;type&quot;;
 800     private static final String KEY_VERSION = &quot;version&quot;;
 801     private static final String KEY_ISO_START = &quot;iso-start&quot;;

 802 
 803     /**
 804      * Return the configuration properties from the resource.
 805      * &lt;p&gt;
 806      * The location of the variant configuration resource is:
 807      * &lt;pre&gt;
<span class="line-modified"> 808      *   &quot;/java/time/chrono/hijrah-config-&quot; + calendarType + &quot;.properties&quot;</span>


 809      * &lt;/pre&gt;
 810      *

 811      * @param calendarType the calendarType of the calendar variant
 812      * @return a Properties containing the properties read from the resource.
 813      * @throws Exception if access to the property resource fails
 814      */
<span class="line-modified"> 815     private Properties readConfigProperties(final String calendarType) throws Exception {</span>
<span class="line-modified"> 816         String resourceName = RESOURCE_PREFIX + calendarType + RESOURCE_SUFFIX;</span>
<span class="line-modified"> 817         PrivilegedAction&lt;InputStream&gt; getResourceAction =  () -&gt; HijrahChronology.class.getResourceAsStream(resourceName);</span>









 818         FilePermission perm1 = new FilePermission(&quot;&lt;&lt;ALL FILES&gt;&gt;&quot;, &quot;read&quot;);
 819         RuntimePermission perm2 = new RuntimePermission(&quot;accessSystemModules&quot;);
 820         try (InputStream is = AccessController.doPrivileged(getResourceAction, null, perm1, perm2)) {
 821             if (is == null) {
<span class="line-modified"> 822                 throw new RuntimeException(&quot;Hijrah calendar resource not found: /java/time/chrono/&quot; + resourceName);</span>
 823             }
 824             Properties props = new Properties();
 825             props.load(is);
 826             return props;
 827         }
 828     }
 829 
 830     /**
 831      * Loads and processes the Hijrah calendar properties file for this calendarType.
 832      * The starting Hijrah date and the corresponding ISO date are
 833      * extracted and used to calculate the epochDate offset.
 834      * The version number is identified and ignored.
 835      * Everything else is the data for a year with containing the length of each
 836      * of 12 months.
 837      *
 838      * @throws DateTimeException if initialization of the calendar data from the
 839      *     resource fails
 840      */
 841     private void loadCalendarData() {
 842         try {
<span class="line-modified"> 843             Properties props = readConfigProperties(calendarType);</span>
 844 
 845             Map&lt;Integer, int[]&gt; years = new HashMap&lt;&gt;();
 846             int minYear = Integer.MAX_VALUE;
 847             int maxYear = Integer.MIN_VALUE;
 848             String id = null;
 849             String type = null;
 850             String version = null;
 851             int isoStart = 0;
 852             for (Map.Entry&lt;Object, Object&gt; entry : props.entrySet()) {
 853                 String key = (String) entry.getKey();
 854                 switch (key) {
 855                     case KEY_ID:
 856                         id = (String)entry.getValue();
 857                         break;
 858                     case KEY_TYPE:
 859                         type = (String)entry.getValue();
 860                         break;
 861                     case KEY_VERSION:
 862                         version = (String)entry.getValue();
 863                         break;
</pre>
<hr />
<pre>
 991      * @param string the input string
 992      * @return the 3 element array with year, month, day
 993      */
 994     private int[] parseYMD(String string) {
 995         // yyyy-MM-dd
 996         string = string.trim();
 997         try {
 998             if (string.charAt(4) != &#39;-&#39; || string.charAt(7) != &#39;-&#39;) {
 999                 throw new IllegalArgumentException(&quot;date must be yyyy-MM-dd&quot;);
1000             }
1001             int[] ymd = new int[3];
1002             ymd[0] = Integer.parseInt(string, 0, 4, 10);
1003             ymd[1] = Integer.parseInt(string, 5, 7, 10);
1004             ymd[2] = Integer.parseInt(string, 8, 10, 10);
1005             return ymd;
1006         } catch (NumberFormatException ex) {
1007             throw new IllegalArgumentException(&quot;date must be yyyy-MM-dd&quot;, ex);
1008         }
1009     }
1010 






































1011     //-----------------------------------------------------------------------
1012     /**
1013      * Writes the Chronology using a
1014      * &lt;a href=&quot;{@docRoot}/serialized-form.html#java.time.chrono.Ser&quot;&gt;dedicated serialized form&lt;/a&gt;.
1015      * @serialData
1016      * &lt;pre&gt;
1017      *  out.writeByte(1);     // identifies a Chronology
1018      *  out.writeUTF(getId());
1019      * &lt;/pre&gt;
1020      *
1021      * @return the instance of {@code Ser}, not null
1022      */
1023     @Override

1024     Object writeReplace() {
1025         return super.writeReplace();
1026     }
1027 
1028     /**
1029      * Defend against malicious streams.
1030      *
1031      * @param s the stream to read
1032      * @throws InvalidObjectException always
1033      */

1034     private void readObject(ObjectInputStream s) throws InvalidObjectException {
1035         throw new InvalidObjectException(&quot;Deserialization via serialization delegate&quot;);
1036     }
1037 }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  43  *    without specific prior written permission.
  44  *
  45  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  46  * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  47  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
  48  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
  49  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
  50  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  51  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
  52  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
  53  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
  54  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
  55  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  56  */
  57 
  58 package java.time.chrono;
  59 
  60 import static java.time.temporal.ChronoField.EPOCH_DAY;
  61 
  62 import java.io.FilePermission;
<span class="line-added">  63 import java.io.IOException;</span>
  64 import java.io.InputStream;
  65 import java.io.InvalidObjectException;
  66 import java.io.ObjectInputStream;
  67 import java.io.Serializable;
<span class="line-added">  68 import java.io.UncheckedIOException;</span>
<span class="line-added">  69 import java.nio.file.Files;</span>
<span class="line-added">  70 import java.nio.file.Path;</span>
<span class="line-added">  71 import java.nio.file.StandardOpenOption;</span>
  72 import java.security.AccessController;
  73 import java.security.PrivilegedAction;
  74 import java.time.Clock;
  75 import java.time.DateTimeException;
  76 import java.time.Instant;
  77 import java.time.LocalDate;
  78 import java.time.ZoneId;
  79 import java.time.format.ResolverStyle;
  80 import java.time.temporal.ChronoField;
  81 import java.time.temporal.TemporalAccessor;
  82 import java.time.temporal.TemporalField;
  83 import java.time.temporal.ValueRange;
  84 import java.util.Arrays;
  85 import java.util.HashMap;
  86 import java.util.List;
  87 import java.util.Map;
  88 import java.util.Properties;
  89 
  90 import sun.util.logging.PlatformLogger;
  91 
</pre>
<hr />
<pre>
 177  * &lt;th scope=&quot;row&quot;&gt;version&lt;/th&gt;
 178  * &lt;td&gt;Version, for example: &quot;1.8.0_1&quot;&lt;/td&gt;
 179  * &lt;td&gt;The version of the Hijrah variant data&lt;/td&gt;
 180  * &lt;/tr&gt;
 181  * &lt;tr&gt;
 182  * &lt;th scope=&quot;row&quot;&gt;iso-start&lt;/th&gt;
 183  * &lt;td&gt;ISO start date, formatted as {@code yyyy-MM-dd}, for example: &quot;1900-04-30&quot;&lt;/td&gt;
 184  * &lt;td&gt;The ISO date of the first day of the minimum Hijrah year.&lt;/td&gt;
 185  * &lt;/tr&gt;
 186  * &lt;tr&gt;
 187  * &lt;th scope=&quot;row&quot;&gt;yyyy - a numeric 4 digit year, for example &quot;1434&quot;&lt;/th&gt;
 188  * &lt;td&gt;The value is a sequence of 12 month lengths,
 189  * for example: &quot;29 30 29 30 29 30 30 30 29 30 29 29&quot;&lt;/td&gt;
 190  * &lt;td&gt;The lengths of the 12 months of the year separated by whitespace.
 191  * A numeric year property must be present for every year without any gaps.
 192  * The month lengths must be between 29-32 inclusive.
 193  * &lt;/td&gt;
 194  * &lt;/tr&gt;
 195  * &lt;/tbody&gt;
 196  * &lt;/table&gt;
<span class="line-added"> 197  * &lt;p&gt;</span>
<span class="line-added"> 198  * Additional variants may be added by providing configuration properties files in</span>
<span class="line-added"> 199  * {@code &lt;JAVA_HOME&gt;/conf/chronology} directory. The properties</span>
<span class="line-added"> 200  * files should follow the naming convention of</span>
<span class="line-added"> 201  * {@code hijrah-config-&lt;chronology id&gt;_&lt;calendar type&gt;.properties}.</span>
 202  *
 203  * @since 1.8
 204  */
 205 public final class HijrahChronology extends AbstractChronology implements Serializable {
 206 
 207     /**
 208      * The Hijrah Calendar id.
 209      */
 210     private final transient String typeId;
 211     /**
 212      * The Hijrah calendarType.
 213      */
 214     private final transient String calendarType;
 215     /**
 216      * Serialization version.
 217      */
<span class="line-added"> 218     @java.io.Serial</span>
 219     private static final long serialVersionUID = 3127340209035924785L;
 220     /**
 221      * Singleton instance of the Islamic Umm Al-Qura calendar of Saudi Arabia.
 222      * Other Hijrah chronology variants may be available from
 223      * {@link Chronology#getAvailableChronologies}.
 224      */
 225     public static final HijrahChronology INSTANCE;
 226     /**
 227      * Flag to indicate the initialization of configuration data is complete.
 228      * @see #checkCalendarInit()
 229      */
 230     private transient volatile boolean initComplete;
 231     /**
 232      * Array of epoch days indexed by Hijrah Epoch month.
 233      * Computed by {@link #loadCalendarData}.
 234      */
 235     private transient int[] hijrahEpochMonthStartDays;
 236     /**
 237      * The minimum epoch day of this Hijrah calendar.
 238      * Computed by {@link #loadCalendarData}.
</pre>
<hr />
<pre>
 271 
 272     /**
 273      * Prefix of resource names for Hijrah calendar variants.
 274      */
 275     private static final String RESOURCE_PREFIX = &quot;hijrah-config-&quot;;
 276 
 277     /**
 278      * Suffix of resource names for Hijrah calendar variants.
 279      */
 280     private static final String RESOURCE_SUFFIX = &quot;.properties&quot;;
 281 
 282     /**
 283      * Static initialization of the built-in calendars.
 284      * The data is not loaded until it is used.
 285      */
 286     static {
 287         INSTANCE = new HijrahChronology(&quot;Hijrah-umalqura&quot;, &quot;islamic-umalqura&quot;);
 288         // Register it by its aliases
 289         AbstractChronology.registerChrono(INSTANCE, &quot;Hijrah&quot;);
 290         AbstractChronology.registerChrono(INSTANCE, &quot;islamic&quot;);
<span class="line-added"> 291 </span>
<span class="line-added"> 292         // custom config chronologies</span>
<span class="line-added"> 293         CONF_PATH = Path.of(AccessController.doPrivileged((PrivilegedAction&lt;String&gt;)</span>
<span class="line-added"> 294                 () -&gt; System.getProperty(&quot;java.home&quot;)), &quot;conf&quot;, &quot;chronology&quot;);</span>
<span class="line-added"> 295         registerCustomChrono();</span>
 296     }
 297 
 298     /**
 299      * Create a HijrahChronology for the named variant and type.
 300      *
 301      * @param id the id of the calendar
 302      * @param calType the typeId of the calendar
 303      * @throws IllegalArgumentException if the id or typeId is empty
 304      */
 305     private HijrahChronology(String id, String calType) {
 306         if (id.isEmpty()) {
 307             throw new IllegalArgumentException(&quot;calendar id is empty&quot;);
 308         }
 309         if (calType.isEmpty()) {
 310             throw new IllegalArgumentException(&quot;calendar typeId is empty&quot;);
 311         }
 312         this.typeId = id;
 313         this.calendarType = calType;
 314     }
 315 
</pre>
<hr />
<pre>
 798     }
 799 
 800     /**
 801      * Returns the length of the epochMonth. It is computed from the start of
 802      * the following month minus the start of the requested month.
 803      *
 804      * @param epochMonth the epochMonth; assumed to be within range
 805      * @return the length in days of the epochMonth
 806      */
 807     private int epochMonthLength(int epochMonth) {
 808         // The very last entry in the epochMonth table is not the start of a month
 809         return hijrahEpochMonthStartDays[epochMonth + 1]
 810                 - hijrahEpochMonthStartDays[epochMonth];
 811     }
 812 
 813     //-----------------------------------------------------------------------
 814     private static final String KEY_ID = &quot;id&quot;;
 815     private static final String KEY_TYPE = &quot;type&quot;;
 816     private static final String KEY_VERSION = &quot;version&quot;;
 817     private static final String KEY_ISO_START = &quot;iso-start&quot;;
<span class="line-added"> 818     private static final Path CONF_PATH;</span>
 819 
 820     /**
 821      * Return the configuration properties from the resource.
 822      * &lt;p&gt;
 823      * The location of the variant configuration resource is:
 824      * &lt;pre&gt;
<span class="line-modified"> 825      *   &quot;/java/time/chrono/&quot; (for &quot;islamic-umalqura&quot; type), or</span>
<span class="line-added"> 826      *   &quot;&lt;JAVA_HOME&gt;/conf/chronology/&quot; +</span>
<span class="line-added"> 827      *   &quot;hijrah-config-&quot; + chronologyId + &quot;_&quot; + calendarType + &quot;.properties&quot;</span>
 828      * &lt;/pre&gt;
 829      *
<span class="line-added"> 830      * @param chronologyId the chronology ID of the calendar variant</span>
 831      * @param calendarType the calendarType of the calendar variant
 832      * @return a Properties containing the properties read from the resource.
 833      * @throws Exception if access to the property resource fails
 834      */
<span class="line-modified"> 835     private static Properties readConfigProperties(final String chronologyId, final String calendarType) throws Exception {</span>
<span class="line-modified"> 836         String resourceName = RESOURCE_PREFIX + chronologyId + &quot;_&quot; + calendarType + RESOURCE_SUFFIX;</span>
<span class="line-modified"> 837         PrivilegedAction&lt;InputStream&gt; getResourceAction =  calendarType.equals(&quot;islamic-umalqura&quot;) ?</span>
<span class="line-added"> 838             () -&gt; HijrahChronology.class.getResourceAsStream(resourceName) :</span>
<span class="line-added"> 839             () -&gt; {</span>
<span class="line-added"> 840                 try {</span>
<span class="line-added"> 841                     return Files.newInputStream(CONF_PATH.resolve(resourceName),</span>
<span class="line-added"> 842                             StandardOpenOption.READ);</span>
<span class="line-added"> 843                 } catch (IOException e) {</span>
<span class="line-added"> 844                     throw new UncheckedIOException(e);</span>
<span class="line-added"> 845                 }</span>
<span class="line-added"> 846             };</span>
 847         FilePermission perm1 = new FilePermission(&quot;&lt;&lt;ALL FILES&gt;&gt;&quot;, &quot;read&quot;);
 848         RuntimePermission perm2 = new RuntimePermission(&quot;accessSystemModules&quot;);
 849         try (InputStream is = AccessController.doPrivileged(getResourceAction, null, perm1, perm2)) {
 850             if (is == null) {
<span class="line-modified"> 851                 throw new RuntimeException(&quot;Hijrah calendar resource not found: &quot; + resourceName);</span>
 852             }
 853             Properties props = new Properties();
 854             props.load(is);
 855             return props;
 856         }
 857     }
 858 
 859     /**
 860      * Loads and processes the Hijrah calendar properties file for this calendarType.
 861      * The starting Hijrah date and the corresponding ISO date are
 862      * extracted and used to calculate the epochDate offset.
 863      * The version number is identified and ignored.
 864      * Everything else is the data for a year with containing the length of each
 865      * of 12 months.
 866      *
 867      * @throws DateTimeException if initialization of the calendar data from the
 868      *     resource fails
 869      */
 870     private void loadCalendarData() {
 871         try {
<span class="line-modified"> 872             Properties props = readConfigProperties(typeId, calendarType);</span>
 873 
 874             Map&lt;Integer, int[]&gt; years = new HashMap&lt;&gt;();
 875             int minYear = Integer.MAX_VALUE;
 876             int maxYear = Integer.MIN_VALUE;
 877             String id = null;
 878             String type = null;
 879             String version = null;
 880             int isoStart = 0;
 881             for (Map.Entry&lt;Object, Object&gt; entry : props.entrySet()) {
 882                 String key = (String) entry.getKey();
 883                 switch (key) {
 884                     case KEY_ID:
 885                         id = (String)entry.getValue();
 886                         break;
 887                     case KEY_TYPE:
 888                         type = (String)entry.getValue();
 889                         break;
 890                     case KEY_VERSION:
 891                         version = (String)entry.getValue();
 892                         break;
</pre>
<hr />
<pre>
1020      * @param string the input string
1021      * @return the 3 element array with year, month, day
1022      */
1023     private int[] parseYMD(String string) {
1024         // yyyy-MM-dd
1025         string = string.trim();
1026         try {
1027             if (string.charAt(4) != &#39;-&#39; || string.charAt(7) != &#39;-&#39;) {
1028                 throw new IllegalArgumentException(&quot;date must be yyyy-MM-dd&quot;);
1029             }
1030             int[] ymd = new int[3];
1031             ymd[0] = Integer.parseInt(string, 0, 4, 10);
1032             ymd[1] = Integer.parseInt(string, 5, 7, 10);
1033             ymd[2] = Integer.parseInt(string, 8, 10, 10);
1034             return ymd;
1035         } catch (NumberFormatException ex) {
1036             throw new IllegalArgumentException(&quot;date must be yyyy-MM-dd&quot;, ex);
1037         }
1038     }
1039 
<span class="line-added">1040     /**</span>
<span class="line-added">1041      * Look for Hijrah chronology variant properties files in</span>
<span class="line-added">1042      * &lt;JAVA_HOME&gt;/conf/chronology directory. Then register its chronology, if any.</span>
<span class="line-added">1043      */</span>
<span class="line-added">1044     private static void registerCustomChrono() {</span>
<span class="line-added">1045         AccessController.doPrivileged(</span>
<span class="line-added">1046             (PrivilegedAction&lt;Void&gt;)() -&gt; {</span>
<span class="line-added">1047                 if (Files.isDirectory(CONF_PATH)) {</span>
<span class="line-added">1048                     try {</span>
<span class="line-added">1049                         Files.list(CONF_PATH)</span>
<span class="line-added">1050                             .map(p -&gt; p.getFileName().toString())</span>
<span class="line-added">1051                             .filter(fn -&gt; fn.matches(&quot;hijrah-config-[^\\.]+\\.properties&quot;))</span>
<span class="line-added">1052                             .map(fn -&gt; fn.replaceAll(&quot;(hijrah-config-|\\.properties)&quot;, &quot;&quot;))</span>
<span class="line-added">1053                             .forEach(idtype -&gt; {</span>
<span class="line-added">1054                                 int delimiterPos = idtype.indexOf(&#39;_&#39;);</span>
<span class="line-added">1055                                 // &#39;_&#39; should be somewhere in the middle of idtype</span>
<span class="line-added">1056                                 if (delimiterPos &gt; 1 &amp;&amp; delimiterPos &lt; idtype.length() - 1) {</span>
<span class="line-added">1057                                     AbstractChronology.registerChrono(</span>
<span class="line-added">1058                                         new HijrahChronology(</span>
<span class="line-added">1059                                                 idtype.substring(0, delimiterPos),</span>
<span class="line-added">1060                                                 idtype.substring(delimiterPos + 1)));</span>
<span class="line-added">1061                                 } else {</span>
<span class="line-added">1062                                     PlatformLogger.getLogger(&quot;java.time.chrono&quot;)</span>
<span class="line-added">1063                                             .warning(&quot;Hijrah custom config init failed.&quot; +</span>
<span class="line-added">1064                                                     &quot;&#39;&lt;id&gt;_&lt;type&gt;&#39; name convention not followed: &quot; + idtype);</span>
<span class="line-added">1065                                 }</span>
<span class="line-added">1066                             });</span>
<span class="line-added">1067                     } catch (IOException e) {</span>
<span class="line-added">1068                         PlatformLogger.getLogger(&quot;java.time.chrono&quot;)</span>
<span class="line-added">1069                                 .warning(&quot;Hijrah custom config init failed.&quot;, e);</span>
<span class="line-added">1070                     }</span>
<span class="line-added">1071                 }</span>
<span class="line-added">1072                 return null;</span>
<span class="line-added">1073             },</span>
<span class="line-added">1074             null,</span>
<span class="line-added">1075             new FilePermission(&quot;&lt;&lt;ALL FILES&gt;&gt;&quot;, &quot;read&quot;));</span>
<span class="line-added">1076     }</span>
<span class="line-added">1077 </span>
1078     //-----------------------------------------------------------------------
1079     /**
1080      * Writes the Chronology using a
1081      * &lt;a href=&quot;{@docRoot}/serialized-form.html#java.time.chrono.Ser&quot;&gt;dedicated serialized form&lt;/a&gt;.
1082      * @serialData
1083      * &lt;pre&gt;
1084      *  out.writeByte(1);     // identifies a Chronology
1085      *  out.writeUTF(getId());
1086      * &lt;/pre&gt;
1087      *
1088      * @return the instance of {@code Ser}, not null
1089      */
1090     @Override
<span class="line-added">1091     @java.io.Serial</span>
1092     Object writeReplace() {
1093         return super.writeReplace();
1094     }
1095 
1096     /**
1097      * Defend against malicious streams.
1098      *
1099      * @param s the stream to read
1100      * @throws InvalidObjectException always
1101      */
<span class="line-added">1102     @java.io.Serial</span>
1103     private void readObject(ObjectInputStream s) throws InvalidObjectException {
1104         throw new InvalidObjectException(&quot;Deserialization via serialization delegate&quot;);
1105     }
1106 }
</pre>
</td>
</tr>
</table>
<center><a href="Chronology.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="HijrahDate.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>