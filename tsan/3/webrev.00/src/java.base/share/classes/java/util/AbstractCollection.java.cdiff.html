<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/java/util/AbstractCollection.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../time/zone/ZoneRules.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="AbstractMap.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/util/AbstractCollection.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,10 ***</span>
<span class="line-new-header">--- 23,12 ---</span>
   * questions.
   */
  
  package java.util;
  
<span class="line-added">+ import jdk.internal.util.ArraysSupport;</span>
<span class="line-added">+ </span>
  /**
   * This class provides a skeletal implementation of the {@code Collection}
   * interface, to minimize the effort required to implement this interface. &lt;p&gt;
   *
   * To implement an unmodifiable collection, the programmer needs only to
</pre>
<hr />
<pre>
<span class="line-old-header">*** 201,18 ***</span>
          }
          // more elements than expected
          return it.hasNext() ? finishToArray(r, it) : r;
      }
  
<span class="line-removed">-     /**</span>
<span class="line-removed">-      * The maximum size of array to allocate.</span>
<span class="line-removed">-      * Some VMs reserve some header words in an array.</span>
<span class="line-removed">-      * Attempts to allocate larger arrays may result in</span>
<span class="line-removed">-      * OutOfMemoryError: Requested array size exceeds VM limit</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;</span>
<span class="line-removed">- </span>
      /**
       * Reallocates the array being used within toArray when the iterator
       * returned more elements than expected, and finishes filling it from
       * the iterator.
       *
<span class="line-new-header">--- 203,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 221,33 ***</span>
       * @return array containing the elements in the given array, plus any
       *         further elements returned by the iterator, trimmed to size
       */
      @SuppressWarnings(&quot;unchecked&quot;)
      private static &lt;T&gt; T[] finishToArray(T[] r, Iterator&lt;?&gt; it) {
<span class="line-modified">!         int i = r.length;</span>
          while (it.hasNext()) {
<span class="line-modified">!             int cap = r.length;</span>
<span class="line-modified">!             if (i == cap) {</span>
<span class="line-modified">!                 int newCap = cap + (cap &gt;&gt; 1) + 1;</span>
<span class="line-modified">!                 // overflow-conscious code</span>
<span class="line-modified">!                 if (newCap - MAX_ARRAY_SIZE &gt; 0)</span>
<span class="line-removed">-                     newCap = hugeCapacity(cap + 1);</span>
<span class="line-removed">-                 r = Arrays.copyOf(r, newCap);</span>
              }
              r[i++] = (T)it.next();
          }
          // trim if overallocated
<span class="line-modified">!         return (i == r.length) ? r : Arrays.copyOf(r, i);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static int hugeCapacity(int minCapacity) {</span>
<span class="line-removed">-         if (minCapacity &lt; 0) // overflow</span>
<span class="line-removed">-             throw new OutOfMemoryError</span>
<span class="line-removed">-                 (&quot;Required array size too large&quot;);</span>
<span class="line-removed">-         return (minCapacity &gt; MAX_ARRAY_SIZE) ?</span>
<span class="line-removed">-             Integer.MAX_VALUE :</span>
<span class="line-removed">-             MAX_ARRAY_SIZE;</span>
      }
  
      // Modification Operations
  
      /**
<span class="line-new-header">--- 215,23 ---</span>
       * @return array containing the elements in the given array, plus any
       *         further elements returned by the iterator, trimmed to size
       */
      @SuppressWarnings(&quot;unchecked&quot;)
      private static &lt;T&gt; T[] finishToArray(T[] r, Iterator&lt;?&gt; it) {
<span class="line-modified">!         int len = r.length;</span>
<span class="line-added">+         int i = len;</span>
          while (it.hasNext()) {
<span class="line-modified">!             if (i == len) {</span>
<span class="line-modified">!                 len = ArraysSupport.newLength(len,</span>
<span class="line-modified">!                         1,             /* minimum growth */</span>
<span class="line-modified">!                         (len &gt;&gt; 1) + 1 /* preferred growth */);</span>
<span class="line-modified">!                 r = Arrays.copyOf(r, len);</span>
              }
              r[i++] = (T)it.next();
          }
          // trim if overallocated
<span class="line-modified">!         return (i == len) ? r : Arrays.copyOf(r, i);</span>
      }
  
      // Modification Operations
  
      /**
</pre>
<center><a href="../time/zone/ZoneRules.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="AbstractMap.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>