<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/util/ArrayPrefixHelpers.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="ArrayList.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="Arrays.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/util/ArrayPrefixHelpers.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 86      *
 87      * To better exploit locality and reduce overhead, the compute
 88      * method loops starting with the current task, moving if possible
 89      * to one of its subtasks rather than forking.
 90      *
 91      * As usual for this sort of utility, there are 4 versions, that
 92      * are simple copy/paste/adapt variants of each other.  (The
 93      * double and int versions differ from long version solely by
 94      * replacing &quot;long&quot; (with case-matching)).
 95      */
 96 
 97     // see above
 98     static final int CUMULATE = 1;
 99     static final int SUMMED   = 2;
100     static final int FINISHED = 4;
101 
102     /** The smallest subtask array partition size to use as threshold */
103     static final int MIN_PARTITION = 16;
104 
105     static final class CumulateTask&lt;T&gt; extends CountedCompleter&lt;Void&gt; {

106         final T[] array;

107         final BinaryOperator&lt;T&gt; function;
108         CumulateTask&lt;T&gt; left, right;
<span class="line-modified">109         T in, out;</span>



110         final int lo, hi, origin, fence, threshold;
111 
112         /** Root task constructor */
113         public CumulateTask(CumulateTask&lt;T&gt; parent,
114                             BinaryOperator&lt;T&gt; function,
115                             T[] array, int lo, int hi) {
116             super(parent);
117             this.function = function; this.array = array;
118             this.lo = this.origin = lo; this.hi = this.fence = hi;
119             int p;
120             this.threshold =
121                 (p = (hi - lo) / (ForkJoinPool.getCommonPoolParallelism() &lt;&lt; 3))
122                 &lt;= MIN_PARTITION ? MIN_PARTITION : p;
123         }
124 
125         /** Subtask constructor */
126         CumulateTask(CumulateTask&lt;T&gt; parent, BinaryOperator&lt;T&gt; function,
127                      T[] array, int origin, int fence, int threshold,
128                      int lo, int hi) {
129             super(parent);
</pre>
<hr />
<pre>
234                                 T lout = lt.out;
235                                 par.out = (rt.hi == fnc ? lout :
236                                            fn.apply(lout, rt.out));
237                             }
238                             int refork = (((b &amp; CUMULATE) == 0 &amp;&amp;
239                                            par.lo == org) ? CUMULATE : 0);
240                             if ((nextState = b|state|refork) == b ||
241                                 par.compareAndSetPendingCount(b, nextState)) {
242                                 state = SUMMED;               // drop finished
243                                 t = par;
244                                 if (refork != 0)
245                                     par.fork();
246                             }
247                         }
248                         else if (par.compareAndSetPendingCount(b, b|state))
249                             break outer;                      // sib not ready
250                     }
251                 }
252             }
253         }

254         private static final long serialVersionUID = 5293554502939613543L;
255     }
256 
257     static final class LongCumulateTask extends CountedCompleter&lt;Void&gt; {
258         final long[] array;

259         final LongBinaryOperator function;
260         LongCumulateTask left, right;
261         long in, out;
262         final int lo, hi, origin, fence, threshold;
263 
264         /** Root task constructor */
265         public LongCumulateTask(LongCumulateTask parent,
266                                 LongBinaryOperator function,
267                                 long[] array, int lo, int hi) {
268             super(parent);
269             this.function = function; this.array = array;
270             this.lo = this.origin = lo; this.hi = this.fence = hi;
271             int p;
272             this.threshold =
273                 (p = (hi - lo) / (ForkJoinPool.getCommonPoolParallelism() &lt;&lt; 3))
274                 &lt;= MIN_PARTITION ? MIN_PARTITION : p;
275         }
276 
277         /** Subtask constructor */
278         LongCumulateTask(LongCumulateTask parent, LongBinaryOperator function,
</pre>
<hr />
<pre>
384                                 long lout = lt.out;
385                                 par.out = (rt.hi == fnc ? lout :
386                                            fn.applyAsLong(lout, rt.out));
387                             }
388                             int refork = (((b &amp; CUMULATE) == 0 &amp;&amp;
389                                            par.lo == org) ? CUMULATE : 0);
390                             if ((nextState = b|state|refork) == b ||
391                                 par.compareAndSetPendingCount(b, nextState)) {
392                                 state = SUMMED;               // drop finished
393                                 t = par;
394                                 if (refork != 0)
395                                     par.fork();
396                             }
397                         }
398                         else if (par.compareAndSetPendingCount(b, b|state))
399                             break outer;                      // sib not ready
400                     }
401                 }
402             }
403         }

404         private static final long serialVersionUID = -5074099945909284273L;
405     }
406 
407     static final class DoubleCumulateTask extends CountedCompleter&lt;Void&gt; {
408         final double[] array;

409         final DoubleBinaryOperator function;
410         DoubleCumulateTask left, right;
411         double in, out;
412         final int lo, hi, origin, fence, threshold;
413 
414         /** Root task constructor */
415         public DoubleCumulateTask(DoubleCumulateTask parent,
416                                   DoubleBinaryOperator function,
417                                   double[] array, int lo, int hi) {
418             super(parent);
419             this.function = function; this.array = array;
420             this.lo = this.origin = lo; this.hi = this.fence = hi;
421             int p;
422             this.threshold =
423                 (p = (hi - lo) / (ForkJoinPool.getCommonPoolParallelism() &lt;&lt; 3))
424                 &lt;= MIN_PARTITION ? MIN_PARTITION : p;
425         }
426 
427         /** Subtask constructor */
428         DoubleCumulateTask(DoubleCumulateTask parent, DoubleBinaryOperator function,
</pre>
<hr />
<pre>
534                                 double lout = lt.out;
535                                 par.out = (rt.hi == fnc ? lout :
536                                            fn.applyAsDouble(lout, rt.out));
537                             }
538                             int refork = (((b &amp; CUMULATE) == 0 &amp;&amp;
539                                            par.lo == org) ? CUMULATE : 0);
540                             if ((nextState = b|state|refork) == b ||
541                                 par.compareAndSetPendingCount(b, nextState)) {
542                                 state = SUMMED;               // drop finished
543                                 t = par;
544                                 if (refork != 0)
545                                     par.fork();
546                             }
547                         }
548                         else if (par.compareAndSetPendingCount(b, b|state))
549                             break outer;                      // sib not ready
550                     }
551                 }
552             }
553         }

554         private static final long serialVersionUID = -586947823794232033L;
555     }
556 
557     static final class IntCumulateTask extends CountedCompleter&lt;Void&gt; {
558         final int[] array;

559         final IntBinaryOperator function;
560         IntCumulateTask left, right;
561         int in, out;
562         final int lo, hi, origin, fence, threshold;
563 
564         /** Root task constructor */
565         public IntCumulateTask(IntCumulateTask parent,
566                                IntBinaryOperator function,
567                                int[] array, int lo, int hi) {
568             super(parent);
569             this.function = function; this.array = array;
570             this.lo = this.origin = lo; this.hi = this.fence = hi;
571             int p;
572             this.threshold =
573                 (p = (hi - lo) / (ForkJoinPool.getCommonPoolParallelism() &lt;&lt; 3))
574                 &lt;= MIN_PARTITION ? MIN_PARTITION : p;
575         }
576 
577         /** Subtask constructor */
578         IntCumulateTask(IntCumulateTask parent, IntBinaryOperator function,
</pre>
<hr />
<pre>
684                                 int lout = lt.out;
685                                 par.out = (rt.hi == fnc ? lout :
686                                            fn.applyAsInt(lout, rt.out));
687                             }
688                             int refork = (((b &amp; CUMULATE) == 0 &amp;&amp;
689                                            par.lo == org) ? CUMULATE : 0);
690                             if ((nextState = b|state|refork) == b ||
691                                 par.compareAndSetPendingCount(b, nextState)) {
692                                 state = SUMMED;               // drop finished
693                                 t = par;
694                                 if (refork != 0)
695                                     par.fork();
696                             }
697                         }
698                         else if (par.compareAndSetPendingCount(b, b|state))
699                             break outer;                      // sib not ready
700                     }
701                 }
702             }
703         }

704         private static final long serialVersionUID = 3731755594596840961L;
705     }
706 }
</pre>
</td>
<td>
<hr />
<pre>
 86      *
 87      * To better exploit locality and reduce overhead, the compute
 88      * method loops starting with the current task, moving if possible
 89      * to one of its subtasks rather than forking.
 90      *
 91      * As usual for this sort of utility, there are 4 versions, that
 92      * are simple copy/paste/adapt variants of each other.  (The
 93      * double and int versions differ from long version solely by
 94      * replacing &quot;long&quot; (with case-matching)).
 95      */
 96 
 97     // see above
 98     static final int CUMULATE = 1;
 99     static final int SUMMED   = 2;
100     static final int FINISHED = 4;
101 
102     /** The smallest subtask array partition size to use as threshold */
103     static final int MIN_PARTITION = 16;
104 
105     static final class CumulateTask&lt;T&gt; extends CountedCompleter&lt;Void&gt; {
<span class="line-added">106         @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
107         final T[] array;
<span class="line-added">108         @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
109         final BinaryOperator&lt;T&gt; function;
110         CumulateTask&lt;T&gt; left, right;
<span class="line-modified">111         @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
<span class="line-added">112         T in;</span>
<span class="line-added">113         @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
<span class="line-added">114         T out;</span>
115         final int lo, hi, origin, fence, threshold;
116 
117         /** Root task constructor */
118         public CumulateTask(CumulateTask&lt;T&gt; parent,
119                             BinaryOperator&lt;T&gt; function,
120                             T[] array, int lo, int hi) {
121             super(parent);
122             this.function = function; this.array = array;
123             this.lo = this.origin = lo; this.hi = this.fence = hi;
124             int p;
125             this.threshold =
126                 (p = (hi - lo) / (ForkJoinPool.getCommonPoolParallelism() &lt;&lt; 3))
127                 &lt;= MIN_PARTITION ? MIN_PARTITION : p;
128         }
129 
130         /** Subtask constructor */
131         CumulateTask(CumulateTask&lt;T&gt; parent, BinaryOperator&lt;T&gt; function,
132                      T[] array, int origin, int fence, int threshold,
133                      int lo, int hi) {
134             super(parent);
</pre>
<hr />
<pre>
239                                 T lout = lt.out;
240                                 par.out = (rt.hi == fnc ? lout :
241                                            fn.apply(lout, rt.out));
242                             }
243                             int refork = (((b &amp; CUMULATE) == 0 &amp;&amp;
244                                            par.lo == org) ? CUMULATE : 0);
245                             if ((nextState = b|state|refork) == b ||
246                                 par.compareAndSetPendingCount(b, nextState)) {
247                                 state = SUMMED;               // drop finished
248                                 t = par;
249                                 if (refork != 0)
250                                     par.fork();
251                             }
252                         }
253                         else if (par.compareAndSetPendingCount(b, b|state))
254                             break outer;                      // sib not ready
255                     }
256                 }
257             }
258         }
<span class="line-added">259         @java.io.Serial</span>
260         private static final long serialVersionUID = 5293554502939613543L;
261     }
262 
263     static final class LongCumulateTask extends CountedCompleter&lt;Void&gt; {
264         final long[] array;
<span class="line-added">265         @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
266         final LongBinaryOperator function;
267         LongCumulateTask left, right;
268         long in, out;
269         final int lo, hi, origin, fence, threshold;
270 
271         /** Root task constructor */
272         public LongCumulateTask(LongCumulateTask parent,
273                                 LongBinaryOperator function,
274                                 long[] array, int lo, int hi) {
275             super(parent);
276             this.function = function; this.array = array;
277             this.lo = this.origin = lo; this.hi = this.fence = hi;
278             int p;
279             this.threshold =
280                 (p = (hi - lo) / (ForkJoinPool.getCommonPoolParallelism() &lt;&lt; 3))
281                 &lt;= MIN_PARTITION ? MIN_PARTITION : p;
282         }
283 
284         /** Subtask constructor */
285         LongCumulateTask(LongCumulateTask parent, LongBinaryOperator function,
</pre>
<hr />
<pre>
391                                 long lout = lt.out;
392                                 par.out = (rt.hi == fnc ? lout :
393                                            fn.applyAsLong(lout, rt.out));
394                             }
395                             int refork = (((b &amp; CUMULATE) == 0 &amp;&amp;
396                                            par.lo == org) ? CUMULATE : 0);
397                             if ((nextState = b|state|refork) == b ||
398                                 par.compareAndSetPendingCount(b, nextState)) {
399                                 state = SUMMED;               // drop finished
400                                 t = par;
401                                 if (refork != 0)
402                                     par.fork();
403                             }
404                         }
405                         else if (par.compareAndSetPendingCount(b, b|state))
406                             break outer;                      // sib not ready
407                     }
408                 }
409             }
410         }
<span class="line-added">411         @java.io.Serial</span>
412         private static final long serialVersionUID = -5074099945909284273L;
413     }
414 
415     static final class DoubleCumulateTask extends CountedCompleter&lt;Void&gt; {
416         final double[] array;
<span class="line-added">417         @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
418         final DoubleBinaryOperator function;
419         DoubleCumulateTask left, right;
420         double in, out;
421         final int lo, hi, origin, fence, threshold;
422 
423         /** Root task constructor */
424         public DoubleCumulateTask(DoubleCumulateTask parent,
425                                   DoubleBinaryOperator function,
426                                   double[] array, int lo, int hi) {
427             super(parent);
428             this.function = function; this.array = array;
429             this.lo = this.origin = lo; this.hi = this.fence = hi;
430             int p;
431             this.threshold =
432                 (p = (hi - lo) / (ForkJoinPool.getCommonPoolParallelism() &lt;&lt; 3))
433                 &lt;= MIN_PARTITION ? MIN_PARTITION : p;
434         }
435 
436         /** Subtask constructor */
437         DoubleCumulateTask(DoubleCumulateTask parent, DoubleBinaryOperator function,
</pre>
<hr />
<pre>
543                                 double lout = lt.out;
544                                 par.out = (rt.hi == fnc ? lout :
545                                            fn.applyAsDouble(lout, rt.out));
546                             }
547                             int refork = (((b &amp; CUMULATE) == 0 &amp;&amp;
548                                            par.lo == org) ? CUMULATE : 0);
549                             if ((nextState = b|state|refork) == b ||
550                                 par.compareAndSetPendingCount(b, nextState)) {
551                                 state = SUMMED;               // drop finished
552                                 t = par;
553                                 if (refork != 0)
554                                     par.fork();
555                             }
556                         }
557                         else if (par.compareAndSetPendingCount(b, b|state))
558                             break outer;                      // sib not ready
559                     }
560                 }
561             }
562         }
<span class="line-added">563         @java.io.Serial</span>
564         private static final long serialVersionUID = -586947823794232033L;
565     }
566 
567     static final class IntCumulateTask extends CountedCompleter&lt;Void&gt; {
568         final int[] array;
<span class="line-added">569         @SuppressWarnings(&quot;serial&quot;) // Not statically typed as Serializable</span>
570         final IntBinaryOperator function;
571         IntCumulateTask left, right;
572         int in, out;
573         final int lo, hi, origin, fence, threshold;
574 
575         /** Root task constructor */
576         public IntCumulateTask(IntCumulateTask parent,
577                                IntBinaryOperator function,
578                                int[] array, int lo, int hi) {
579             super(parent);
580             this.function = function; this.array = array;
581             this.lo = this.origin = lo; this.hi = this.fence = hi;
582             int p;
583             this.threshold =
584                 (p = (hi - lo) / (ForkJoinPool.getCommonPoolParallelism() &lt;&lt; 3))
585                 &lt;= MIN_PARTITION ? MIN_PARTITION : p;
586         }
587 
588         /** Subtask constructor */
589         IntCumulateTask(IntCumulateTask parent, IntBinaryOperator function,
</pre>
<hr />
<pre>
695                                 int lout = lt.out;
696                                 par.out = (rt.hi == fnc ? lout :
697                                            fn.applyAsInt(lout, rt.out));
698                             }
699                             int refork = (((b &amp; CUMULATE) == 0 &amp;&amp;
700                                            par.lo == org) ? CUMULATE : 0);
701                             if ((nextState = b|state|refork) == b ||
702                                 par.compareAndSetPendingCount(b, nextState)) {
703                                 state = SUMMED;               // drop finished
704                                 t = par;
705                                 if (refork != 0)
706                                     par.fork();
707                             }
708                         }
709                         else if (par.compareAndSetPendingCount(b, b|state))
710                             break outer;                      // sib not ready
711                     }
712                 }
713             }
714         }
<span class="line-added">715         @java.io.Serial</span>
716         private static final long serialVersionUID = 3731755594596840961L;
717     }
718 }
</pre>
</td>
</tr>
</table>
<center><a href="ArrayList.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="Arrays.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>