<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/java/time/zone/ZoneRules.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ZoneOffsetTransitionRule.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../util/AbstractCollection.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/time/zone/ZoneRules.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -67,11 +67,10 @@</span>
  import java.io.InvalidObjectException;
  import java.io.ObjectInputStream;
  import java.io.Serializable;
  import java.time.Duration;
  import java.time.Instant;
<span class="udiff-line-removed">- import java.time.LocalDate;</span>
  import java.time.LocalDateTime;
  import java.time.ZoneId;
  import java.time.ZoneOffset;
  import java.time.Year;
  import java.util.ArrayList;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -160,10 +159,20 @@</span>
          new ZoneOffsetTransitionRule[0];
      /**
       * The zero-length ldt array.
       */
      private static final LocalDateTime[] EMPTY_LDT_ARRAY = new LocalDateTime[0];
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * The number of days in a 400 year cycle.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static final int DAYS_PER_CYCLE = 146097;</span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * The number of days from year zero to year 1970.</span>
<span class="udiff-line-added">+      * There are five 400 year cycles from year zero to 2000.</span>
<span class="udiff-line-added">+      * There are 7 leap years from 1970 to 2000.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static final long DAYS_0000_TO_1970 = (DAYS_PER_CYCLE * 5L) - (30L * 365L + 7L);</span>
  
      /**
       * Obtains an instance of a ZoneRules.
       *
       * @param baseStandardOffset  the standard offset to use before legal rules were set, not null
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -919,14 +928,38 @@</span>
          }
          return new ZoneOffsetTransition(savingsInstantTransitions[index - 1], wallOffsets[index - 1], wallOffsets[index]);
      }
  
      private int findYear(long epochSecond, ZoneOffset offset) {
<span class="udiff-line-removed">-         // inline for performance</span>
          long localSecond = epochSecond + offset.getTotalSeconds();
<span class="udiff-line-modified-removed">-         long localEpochDay = Math.floorDiv(localSecond, 86400);</span>
<span class="udiff-line-modified-removed">-         return LocalDate.ofEpochDay(localEpochDay).getYear();</span>
<span class="udiff-line-modified-added">+         long zeroDay = Math.floorDiv(localSecond, 86400) + DAYS_0000_TO_1970;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         // find the march-based year</span>
<span class="udiff-line-added">+         zeroDay -= 60;  // adjust to 0000-03-01 so leap day is at end of four year cycle</span>
<span class="udiff-line-added">+         long adjust = 0;</span>
<span class="udiff-line-added">+         if (zeroDay &lt; 0) {</span>
<span class="udiff-line-added">+             // adjust negative years to positive for calculation</span>
<span class="udiff-line-added">+             long adjustCycles = (zeroDay + 1) / DAYS_PER_CYCLE - 1;</span>
<span class="udiff-line-added">+             adjust = adjustCycles * 400;</span>
<span class="udiff-line-added">+             zeroDay += -adjustCycles * DAYS_PER_CYCLE;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         long yearEst = (400 * zeroDay + 591) / DAYS_PER_CYCLE;</span>
<span class="udiff-line-added">+         long doyEst = zeroDay - (365 * yearEst + yearEst / 4 - yearEst / 100 + yearEst / 400);</span>
<span class="udiff-line-added">+         if (doyEst &lt; 0) {</span>
<span class="udiff-line-added">+             // fix estimate</span>
<span class="udiff-line-added">+             yearEst--;</span>
<span class="udiff-line-added">+             doyEst = zeroDay - (365 * yearEst + yearEst / 4 - yearEst / 100 + yearEst / 400);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         yearEst += adjust;  // reset any negative year</span>
<span class="udiff-line-added">+         int marchDoy0 = (int) doyEst;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // convert march-based values back to january-based</span>
<span class="udiff-line-added">+         int marchMonth0 = (marchDoy0 * 5 + 2) / 153;</span>
<span class="udiff-line-added">+         yearEst += marchMonth0 / 10;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Cap to the max value</span>
<span class="udiff-line-added">+         return (int)Math.min(yearEst, Year.MAX_VALUE);</span>
      }
  
      /**
       * Gets the complete list of fully defined transitions.
       * &lt;p&gt;
</pre>
<center><a href="ZoneOffsetTransitionRule.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../util/AbstractCollection.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>