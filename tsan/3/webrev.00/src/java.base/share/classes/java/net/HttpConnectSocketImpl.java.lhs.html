<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/classes/java/net/HttpConnectSocketImpl.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2010, 2013, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package java.net;
 27 
 28 import java.io.IOException;
 29 import java.lang.reflect.Field;
 30 import java.lang.reflect.Method;
 31 import java.util.HashMap;
 32 import java.util.Map;
 33 import java.util.Set;
 34 
 35 /**
 36  * Basic SocketImpl that relies on the internal HTTP protocol handler
<a name="2" id="anc2"></a><span class="line-modified"> 37  * implementation to perform the HTTP tunneling and authentication. The</span>
<span class="line-modified"> 38  * sockets impl is swapped out and replaced with the socket from the HTTP</span>
<span class="line-removed"> 39  * handler after the tunnel is successfully setup.</span>
 40  *
 41  * @since 1.8
 42  */
 43 
<a name="3" id="anc3"></a><span class="line-modified"> 44 /*package*/ class HttpConnectSocketImpl extends PlainSocketImpl {</span>
 45 
 46     private static final String httpURLClazzStr =
 47                                   &quot;sun.net.www.protocol.http.HttpURLConnection&quot;;
 48     private static final String netClientClazzStr = &quot;sun.net.NetworkClient&quot;;
 49     private static final String doTunnelingStr = &quot;doTunneling&quot;;
 50     private static final Field httpField;
 51     private static final Field serverSocketField;
 52     private static final Method doTunneling;
 53 
 54     private final String server;
<a name="4" id="anc4"></a>
 55     private InetSocketAddress external_address;
 56     private HashMap&lt;Integer, Object&gt; optionsMap = new HashMap&lt;&gt;();
 57 
 58     static  {
 59         try {
 60             Class&lt;?&gt; httpClazz = Class.forName(httpURLClazzStr, true, null);
 61             httpField = httpClazz.getDeclaredField(&quot;http&quot;);
 62             doTunneling = httpClazz.getDeclaredMethod(doTunnelingStr);
 63             Class&lt;?&gt; netClientClazz = Class.forName(netClientClazzStr, true, null);
 64             serverSocketField = netClientClazz.getDeclaredField(&quot;serverSocket&quot;);
 65 
 66             java.security.AccessController.doPrivileged(
 67                 new java.security.PrivilegedAction&lt;&gt;() {
 68                     public Void run() {
 69                         httpField.setAccessible(true);
 70                         serverSocketField.setAccessible(true);
 71                         return null;
 72                 }
 73             });
 74         } catch (ReflectiveOperationException x) {
 75             throw new InternalError(&quot;Should not reach here&quot;, x);
 76         }
 77     }
 78 
<a name="5" id="anc5"></a><span class="line-modified"> 79     HttpConnectSocketImpl(String server, int port) {</span>
<span class="line-modified"> 80         this.server = server;</span>
<span class="line-modified"> 81         this.port = port;</span>
<span class="line-removed"> 82     }</span>
<span class="line-removed"> 83 </span>
<span class="line-removed"> 84     HttpConnectSocketImpl(Proxy proxy) {</span>
 85         SocketAddress a = proxy.address();
 86         if ( !(a instanceof InetSocketAddress) )
 87             throw new IllegalArgumentException(&quot;Unsupported address type&quot;);
 88 
 89         InetSocketAddress ad = (InetSocketAddress) a;
 90         server = ad.getHostString();
 91         port = ad.getPort();
 92     }
 93 
<a name="6" id="anc6"></a>









 94     @Override
 95     protected void connect(SocketAddress endpoint, int timeout)
 96         throws IOException
 97     {
 98         if (endpoint == null || !(endpoint instanceof InetSocketAddress))
 99             throw new IllegalArgumentException(&quot;Unsupported address type&quot;);
100         final InetSocketAddress epoint = (InetSocketAddress)endpoint;
<a name="7" id="anc7"></a><span class="line-modified">101         final String destHost = epoint.isUnresolved() ? epoint.getHostName()</span>
<span class="line-modified">102                                                       : epoint.getAddress().getHostAddress();</span>
103         final int destPort = epoint.getPort();
104 
105         SecurityManager security = System.getSecurityManager();
106         if (security != null)
107             security.checkConnect(destHost, destPort);
108 
<a name="8" id="anc8"></a>


109         // Connect to the HTTP proxy server
110         String urlString = &quot;http://&quot; + destHost + &quot;:&quot; + destPort;
111         Socket httpSocket = privilegedDoTunnel(urlString, timeout);
112 
113         // Success!
114         external_address = epoint;
115 
116         // close the original socket impl and release its descriptor
117         close();
118 
119         // update the Sockets impl to the impl from the http Socket
<a name="9" id="anc9"></a><span class="line-modified">120         AbstractPlainSocketImpl psi = (AbstractPlainSocketImpl) httpSocket.impl;</span>
<span class="line-modified">121         this.getSocket().impl = psi;</span>
122 
123         // best effort is made to try and reset options previously set
124         Set&lt;Map.Entry&lt;Integer,Object&gt;&gt; options = optionsMap.entrySet();
125         try {
126             for(Map.Entry&lt;Integer,Object&gt; entry : options) {
<a name="10" id="anc10"></a><span class="line-modified">127                 psi.setOption(entry.getKey(), entry.getValue());</span>
128             }
129         } catch (IOException x) {  /* gulp! */  }
130     }
131 
<a name="11" id="anc11"></a>















132     @Override
133     public void setOption(int opt, Object val) throws SocketException {
<a name="12" id="anc12"></a><span class="line-modified">134         super.setOption(opt, val);</span>
135 
136         if (external_address != null)
137             return;  // we&#39;re connected, just return
138 
139         // store options so that they can be re-applied to the impl after connect
140         optionsMap.put(opt, val);
141     }
142 
143     private Socket privilegedDoTunnel(final String urlString,
144                                       final int timeout)
145         throws IOException
146     {
147         try {
148             return java.security.AccessController.doPrivileged(
149                 new java.security.PrivilegedExceptionAction&lt;&gt;() {
150                     public Socket run() throws IOException {
151                         return doTunnel(urlString, timeout);
152                 }
153             });
154         } catch (java.security.PrivilegedActionException pae) {
155             throw (IOException) pae.getException();
156         }
157     }
158 
159     private Socket doTunnel(String urlString, int connectTimeout)
160         throws IOException
161     {
162         Proxy proxy = new Proxy(Proxy.Type.HTTP, new InetSocketAddress(server, port));
163         URL destURL = new URL(urlString);
164         HttpURLConnection conn = (HttpURLConnection) destURL.openConnection(proxy);
165         conn.setConnectTimeout(connectTimeout);
<a name="13" id="anc13"></a><span class="line-modified">166         conn.setReadTimeout(this.timeout);</span>



167         conn.connect();
168         doTunneling(conn);
169         try {
170             Object httpClient = httpField.get(conn);
171             return (Socket) serverSocketField.get(httpClient);
172         } catch (IllegalAccessException x) {
173             throw new InternalError(&quot;Should not reach here&quot;, x);
174         }
175     }
176 
<a name="14" id="anc14"></a><span class="line-modified">177     private void doTunneling(HttpURLConnection conn) {</span>
178         try {
179             doTunneling.invoke(conn);
180         } catch (ReflectiveOperationException x) {
<a name="15" id="anc15"></a>



181             throw new InternalError(&quot;Should not reach here&quot;, x);
182         }
183     }
184 
185     @Override
186     protected InetAddress getInetAddress() {
187         if (external_address != null)
188             return external_address.getAddress();
189         else
<a name="16" id="anc16"></a><span class="line-modified">190             return super.getInetAddress();</span>
191     }
192 
193     @Override
194     protected int getPort() {
195         if (external_address != null)
196             return external_address.getPort();
197         else
<a name="17" id="anc17"></a><span class="line-modified">198             return super.getPort();</span>
199     }
200 }
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>