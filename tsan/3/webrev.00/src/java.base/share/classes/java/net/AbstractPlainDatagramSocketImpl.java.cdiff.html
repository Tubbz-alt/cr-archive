<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/java/net/AbstractPlainDatagramSocketImpl.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../math/MathContext.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="AbstractPlainSocketImpl.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/net/AbstractPlainDatagramSocketImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1996, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1996, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 26,13 ***</span>
<span class="line-new-header">--- 26,16 ---</span>
  
  import java.io.FileDescriptor;
  import java.io.IOException;
  import java.util.Collections;
  import java.util.HashSet;
<span class="line-added">+ import java.util.Objects;</span>
  import java.util.Set;
  
  import sun.net.ResourceManager;
<span class="line-added">+ import sun.net.ext.ExtendedSocketOptions;</span>
<span class="line-added">+ import sun.net.util.IPAddressUtil;</span>
  import sun.security.action.GetPropertyAction;
  
  /**
   * Abstract datagram and multicast socket implementation base class.
   * Note: This is not a public class, so that applets cannot call
</pre>
<hr />
<pre>
<span class="line-old-header">*** 49,10 ***</span>
<span class="line-new-header">--- 52,11 ---</span>
      int timeout = 0;
      boolean connected = false;
      private int trafficClass = 0;
      protected InetAddress connectedAddress = null;
      private int connectedPort = -1;
<span class="line-added">+     private final boolean isMulticast;</span>
  
      private static final String os =
              GetPropertyAction.privilegedGetProperty(&quot;os.name&quot;);
  
      /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 62,17 ***</span>
  
      /**
       * Load net library into runtime.
       */
      static {
<span class="line-modified">!         java.security.AccessController.doPrivileged(</span>
<span class="line-removed">-             new java.security.PrivilegedAction&lt;&gt;() {</span>
<span class="line-removed">-                 public Void run() {</span>
<span class="line-removed">-                     System.loadLibrary(&quot;net&quot;);</span>
<span class="line-removed">-                     return null;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             });</span>
      }
  
      private static volatile boolean checkedReusePort;
      private static volatile boolean isReusePortAvailable;
  
<span class="line-new-header">--- 66,11 ---</span>
  
      /**
       * Load net library into runtime.
       */
      static {
<span class="line-modified">!         jdk.internal.loader.BootLoader.loadLibrary(&quot;net&quot;);</span>
      }
  
      private static volatile boolean checkedReusePort;
      private static volatile boolean isReusePortAvailable;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 85,39 ***</span>
              checkedReusePort = true;
          }
          return isReusePortAvailable;
      }
  
<span class="line-modified">!     /**</span>
<span class="line-modified">!      * Returns a set of SocketOptions supported by this impl and by this impl&#39;s</span>
<span class="line-removed">-      * socket (Socket or ServerSocket)</span>
<span class="line-removed">-      *</span>
<span class="line-removed">-      * @return a Set of SocketOptions</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     @Override</span>
<span class="line-removed">-     protected Set&lt;SocketOption&lt;?&gt;&gt; supportedOptions() {</span>
<span class="line-removed">-         Set&lt;SocketOption&lt;?&gt;&gt; options;</span>
<span class="line-removed">-         if (isReusePortAvailable()) {</span>
<span class="line-removed">-             options = new HashSet&lt;&gt;();</span>
<span class="line-removed">-             options.addAll(super.supportedOptions());</span>
<span class="line-removed">-             options.add(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="line-removed">-             options = Collections.unmodifiableSet(options);</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             options = super.supportedOptions();</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return options;</span>
      }
  
      /**
       * Creates a datagram socket
       */
      protected synchronized void create() throws SocketException {
          ResourceManager.beforeUdpCreate();
          fd = new FileDescriptor();
          try {
              datagramSocketCreate();
<span class="line-modified">!             SocketCleanable.register(fd);</span>
          } catch (SocketException ioe) {
              ResourceManager.afterUdpClose();
              fd = null;
              throw ioe;
          }
<span class="line-new-header">--- 83,23 ---</span>
              checkedReusePort = true;
          }
          return isReusePortAvailable;
      }
  
<span class="line-modified">!     AbstractPlainDatagramSocketImpl(boolean isMulticast) {</span>
<span class="line-modified">!         this.isMulticast = isMulticast;</span>
      }
  
      /**
       * Creates a datagram socket
       */
      protected synchronized void create() throws SocketException {
          ResourceManager.beforeUdpCreate();
          fd = new FileDescriptor();
          try {
              datagramSocketCreate();
<span class="line-modified">!             SocketCleanable.register(fd, false);</span>
          } catch (SocketException ioe) {
              ResourceManager.afterUdpClose();
              fd = null;
              throw ioe;
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 126,10 ***</span>
<span class="line-new-header">--- 108,13 ---</span>
      /**
       * Binds a datagram socket to a local port.
       */
      protected synchronized void bind(int lport, InetAddress laddr)
          throws SocketException {
<span class="line-added">+         if (laddr.isLinkLocalAddress()) {</span>
<span class="line-added">+             laddr = IPAddressUtil.toScopedAddress(laddr);</span>
<span class="line-added">+         }</span>
          bind0(lport, laddr);
      }
  
      protected abstract void bind0(int lport, InetAddress laddr)
          throws SocketException;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 137,20 ***</span>
      /**
       * Sends a datagram packet. The packet contains the data and the
       * destination address to send the packet to.
       * @param p the packet to be sent.
       */
<span class="line-modified">!     protected abstract void send(DatagramPacket p) throws IOException;</span>
  
      /**
       * Connects a datagram socket to a remote destination. This associates the remote
       * address with the local socket so that datagrams may only be sent to this destination
       * and received from this destination.
       * @param address the remote InetAddress to connect to
       * @param port the remote port number
       */
      protected void connect(InetAddress address, int port) throws SocketException {
          connect0(address, port);
          connectedAddress = address;
          connectedPort = port;
          connected = true;
      }
<span class="line-new-header">--- 122,35 ---</span>
      /**
       * Sends a datagram packet. The packet contains the data and the
       * destination address to send the packet to.
       * @param p the packet to be sent.
       */
<span class="line-modified">!     protected void send(DatagramPacket p) throws IOException {</span>
<span class="line-added">+         InetAddress orig = p.getAddress();</span>
<span class="line-added">+         if (orig.isLinkLocalAddress()) {</span>
<span class="line-added">+             InetAddress scoped = IPAddressUtil.toScopedAddress(orig);</span>
<span class="line-added">+             if (orig != scoped) {</span>
<span class="line-added">+                 p = new DatagramPacket(p.getData(), p.getOffset(),</span>
<span class="line-added">+                                        p.getLength(), scoped, p.getPort());</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         send0(p);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     protected abstract void send0(DatagramPacket p) throws IOException;</span>
  
      /**
       * Connects a datagram socket to a remote destination. This associates the remote
       * address with the local socket so that datagrams may only be sent to this destination
       * and received from this destination.
       * @param address the remote InetAddress to connect to
       * @param port the remote port number
       */
      protected void connect(InetAddress address, int port) throws SocketException {
<span class="line-added">+         if (address.isLinkLocalAddress()) {</span>
<span class="line-added">+             address = IPAddressUtil.toScopedAddress(address);</span>
<span class="line-added">+         }</span>
          connect0(address, port);
          connectedAddress = address;
          connectedPort = port;
          connected = true;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 398,10 ***</span>
<span class="line-new-header">--- 398,122 ---</span>
          }
  
          return result;
      }
  
<span class="line-added">+     static final ExtendedSocketOptions extendedOptions =</span>
<span class="line-added">+             ExtendedSocketOptions.getInstance();</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static final Set&lt;SocketOption&lt;?&gt;&gt; datagramSocketOptions = datagramSocketOptions();</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static Set&lt;SocketOption&lt;?&gt;&gt; datagramSocketOptions() {</span>
<span class="line-added">+         HashSet&lt;SocketOption&lt;?&gt;&gt; options = new HashSet&lt;&gt;();</span>
<span class="line-added">+         options.add(StandardSocketOptions.SO_SNDBUF);</span>
<span class="line-added">+         options.add(StandardSocketOptions.SO_RCVBUF);</span>
<span class="line-added">+         options.add(StandardSocketOptions.SO_REUSEADDR);</span>
<span class="line-added">+         options.add(StandardSocketOptions.SO_BROADCAST);</span>
<span class="line-added">+         options.add(StandardSocketOptions.IP_TOS);</span>
<span class="line-added">+         options.add(StandardSocketOptions.IP_MULTICAST_IF);</span>
<span class="line-added">+         options.add(StandardSocketOptions.IP_MULTICAST_TTL);</span>
<span class="line-added">+         options.add(StandardSocketOptions.IP_MULTICAST_LOOP);</span>
<span class="line-added">+         if (isReusePortAvailable())</span>
<span class="line-added">+             options.add(StandardSocketOptions.SO_REUSEPORT);</span>
<span class="line-added">+         options.addAll(ExtendedSocketOptions.datagramSocketOptions());</span>
<span class="line-added">+         return Collections.unmodifiableSet(options);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Override</span>
<span class="line-added">+     protected Set&lt;SocketOption&lt;?&gt;&gt; supportedOptions() {</span>
<span class="line-added">+             return datagramSocketOptions;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Override</span>
<span class="line-added">+     protected &lt;T&gt; void setOption(SocketOption&lt;T&gt; name, T value) throws IOException {</span>
<span class="line-added">+         Objects.requireNonNull(name);</span>
<span class="line-added">+         if (!supportedOptions().contains(name))</span>
<span class="line-added">+             throw new UnsupportedOperationException(&quot;&#39;&quot; + name + &quot;&#39; not supported&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (!name.type().isInstance(value))</span>
<span class="line-added">+             throw new IllegalArgumentException(&quot;Invalid value &#39;&quot; + value + &quot;&#39;&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (isClosed())</span>
<span class="line-added">+             throw new SocketException(&quot;Socket closed&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (name == StandardSocketOptions.SO_SNDBUF) {</span>
<span class="line-added">+             if (((Integer)value).intValue() &lt; 0)</span>
<span class="line-added">+                 throw new IllegalArgumentException(&quot;Invalid send buffer size:&quot; + value);</span>
<span class="line-added">+             setOption(SocketOptions.SO_SNDBUF, value);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.SO_RCVBUF) {</span>
<span class="line-added">+             if (((Integer)value).intValue() &lt; 0)</span>
<span class="line-added">+                 throw new IllegalArgumentException(&quot;Invalid recv buffer size:&quot; + value);</span>
<span class="line-added">+             setOption(SocketOptions.SO_RCVBUF, value);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.SO_REUSEADDR) {</span>
<span class="line-added">+             setOption(SocketOptions.SO_REUSEADDR, value);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.SO_REUSEPORT) {</span>
<span class="line-added">+             setOption(SocketOptions.SO_REUSEPORT, value);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.SO_BROADCAST) {</span>
<span class="line-added">+             setOption(SocketOptions.SO_BROADCAST, value);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.IP_TOS) {</span>
<span class="line-added">+             int i = ((Integer)value).intValue();</span>
<span class="line-added">+             if (i &lt; 0 || i &gt; 255)</span>
<span class="line-added">+                 throw new IllegalArgumentException(&quot;Invalid IP_TOS value: &quot; + value);</span>
<span class="line-added">+             setOption(SocketOptions.IP_TOS, value);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.IP_MULTICAST_IF ) {</span>
<span class="line-added">+             setOption(SocketOptions.IP_MULTICAST_IF2, value);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.IP_MULTICAST_TTL) {</span>
<span class="line-added">+             int i = ((Integer)value).intValue();</span>
<span class="line-added">+             if (i &lt; 0 || i &gt; 255)</span>
<span class="line-added">+                 throw new IllegalArgumentException(&quot;Invalid TTL/hop value: &quot; + value);</span>
<span class="line-added">+             setTimeToLive((Integer)value);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.IP_MULTICAST_LOOP) {</span>
<span class="line-added">+             boolean enable = (boolean) value;</span>
<span class="line-added">+             // Legacy setOption expects true to mean &#39;disabled&#39;</span>
<span class="line-added">+             setOption(SocketOptions.IP_MULTICAST_LOOP, !enable);</span>
<span class="line-added">+         } else if (extendedOptions.isOptionSupported(name)) {</span>
<span class="line-added">+             extendedOptions.setOption(fd, name, value);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             throw new AssertionError(&quot;unknown option :&quot; + name);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Override</span>
<span class="line-added">+     @SuppressWarnings(&quot;unchecked&quot;)</span>
<span class="line-added">+     protected &lt;T&gt; T getOption(SocketOption&lt;T&gt; name) throws IOException {</span>
<span class="line-added">+         Objects.requireNonNull(name);</span>
<span class="line-added">+         if (!supportedOptions().contains(name))</span>
<span class="line-added">+             throw new UnsupportedOperationException(&quot;&#39;&quot; + name + &quot;&#39; not supported&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (isClosed())</span>
<span class="line-added">+             throw new SocketException(&quot;Socket closed&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (name == StandardSocketOptions.SO_SNDBUF) {</span>
<span class="line-added">+             return (T) getOption(SocketOptions.SO_SNDBUF);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.SO_RCVBUF) {</span>
<span class="line-added">+             return (T) getOption(SocketOptions.SO_RCVBUF);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.SO_REUSEADDR) {</span>
<span class="line-added">+             return (T) getOption(SocketOptions.SO_REUSEADDR);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.SO_REUSEPORT) {</span>
<span class="line-added">+             return (T) getOption(SocketOptions.SO_REUSEPORT);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.SO_BROADCAST) {</span>
<span class="line-added">+             return (T) getOption(SocketOptions.SO_BROADCAST);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.IP_TOS) {</span>
<span class="line-added">+             return (T) getOption(SocketOptions.IP_TOS);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.IP_MULTICAST_IF) {</span>
<span class="line-added">+             return (T) getOption(SocketOptions.IP_MULTICAST_IF2);</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.IP_MULTICAST_TTL) {</span>
<span class="line-added">+             return (T) ((Integer) getTimeToLive());</span>
<span class="line-added">+         } else if (name == StandardSocketOptions.IP_MULTICAST_LOOP) {</span>
<span class="line-added">+             boolean disabled = (boolean) getOption(SocketOptions.IP_MULTICAST_LOOP);</span>
<span class="line-added">+             // Legacy getOption returns true when disabled</span>
<span class="line-added">+             return (T) Boolean.valueOf(!disabled);</span>
<span class="line-added">+         } else if (extendedOptions.isOptionSupported(name)) {</span>
<span class="line-added">+             return (T) extendedOptions.getOption(fd, name);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             throw new AssertionError(&quot;unknown option: &quot; + name);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      protected abstract void datagramSocketCreate() throws SocketException;
      protected abstract void datagramSocketClose();
      protected abstract void socketSetOption(int opt, Object val)
          throws SocketException;
      protected abstract Object socketGetOption(int opt) throws SocketException;
</pre>
<center><a href="../math/MathContext.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="AbstractPlainSocketImpl.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>