<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/java/util/concurrent/CompletableFuture.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ArrayBlockingQueue.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ConcurrentHashMap.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/java/util/concurrent/CompletableFuture.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 606         if (result != null &amp;&amp; stack != null) {
 607             if (mode &lt; 0)
 608                 return this;
 609             else
 610                 postComplete();
 611         }
 612         return null;
 613     }
 614 
 615     @SuppressWarnings(&quot;serial&quot;)
 616     static final class UniApply&lt;T,V&gt; extends UniCompletion&lt;T,V&gt; {
 617         Function&lt;? super T,? extends V&gt; fn;
 618         UniApply(Executor executor, CompletableFuture&lt;V&gt; dep,
 619                  CompletableFuture&lt;T&gt; src,
 620                  Function&lt;? super T,? extends V&gt; fn) {
 621             super(executor, dep, src); this.fn = fn;
 622         }
 623         final CompletableFuture&lt;V&gt; tryFire(int mode) {
 624             CompletableFuture&lt;V&gt; d; CompletableFuture&lt;T&gt; a;
 625             Object r; Throwable x; Function&lt;? super T,? extends V&gt; f;
<span class="line-modified"> 626             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified"> 627                 || (a = src) == null || (r = a.result) == null)</span>
 628                 return null;
 629             tryComplete: if (d.result == null) {
 630                 if (r instanceof AltResult) {
 631                     if ((x = ((AltResult)r).ex) != null) {
 632                         d.completeThrowable(x, r);
 633                         break tryComplete;
 634                     }
 635                     r = null;
 636                 }
 637                 try {
 638                     if (mode &lt;= 0 &amp;&amp; !claim())
 639                         return null;
 640                     else {
 641                         @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
 642                         d.completeValue(f.apply(t));
 643                     }
 644                 } catch (Throwable ex) {
 645                     d.completeThrowable(ex);
 646                 }
 647             }
<span class="line-modified"> 648             dep = null; src = null; fn = null;</span>
 649             return d.postFire(a, mode);
 650         }
 651     }
 652 
 653     private &lt;V&gt; CompletableFuture&lt;V&gt; uniApplyStage(
 654         Executor e, Function&lt;? super T,? extends V&gt; f) {
 655         if (f == null) throw new NullPointerException();
 656         Object r;
 657         if ((r = result) != null)
 658             return uniApplyNow(r, e, f);
 659         CompletableFuture&lt;V&gt; d = newIncompleteFuture();
 660         unipush(new UniApply&lt;T,V&gt;(e, d, this, f));
 661         return d;
 662     }
 663 
 664     private &lt;V&gt; CompletableFuture&lt;V&gt; uniApplyNow(
 665         Object r, Executor e, Function&lt;? super T,? extends V&gt; f) {
 666         Throwable x;
 667         CompletableFuture&lt;V&gt; d = newIncompleteFuture();
 668         if (r instanceof AltResult) {
</pre>
<hr />
<pre>
 678             } else {
 679                 @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
 680                 d.result = d.encodeValue(f.apply(t));
 681             }
 682         } catch (Throwable ex) {
 683             d.result = encodeThrowable(ex);
 684         }
 685         return d;
 686     }
 687 
 688     @SuppressWarnings(&quot;serial&quot;)
 689     static final class UniAccept&lt;T&gt; extends UniCompletion&lt;T,Void&gt; {
 690         Consumer&lt;? super T&gt; fn;
 691         UniAccept(Executor executor, CompletableFuture&lt;Void&gt; dep,
 692                   CompletableFuture&lt;T&gt; src, Consumer&lt;? super T&gt; fn) {
 693             super(executor, dep, src); this.fn = fn;
 694         }
 695         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
 696             CompletableFuture&lt;Void&gt; d; CompletableFuture&lt;T&gt; a;
 697             Object r; Throwable x; Consumer&lt;? super T&gt; f;
<span class="line-modified"> 698             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified"> 699                 || (a = src) == null || (r = a.result) == null)</span>
 700                 return null;
 701             tryComplete: if (d.result == null) {
 702                 if (r instanceof AltResult) {
 703                     if ((x = ((AltResult)r).ex) != null) {
 704                         d.completeThrowable(x, r);
 705                         break tryComplete;
 706                     }
 707                     r = null;
 708                 }
 709                 try {
 710                     if (mode &lt;= 0 &amp;&amp; !claim())
 711                         return null;
 712                     else {
 713                         @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
 714                         f.accept(t);
 715                         d.completeNull();
 716                     }
 717                 } catch (Throwable ex) {
 718                     d.completeThrowable(ex);
 719                 }
 720             }
<span class="line-modified"> 721             dep = null; src = null; fn = null;</span>
 722             return d.postFire(a, mode);
 723         }
 724     }
 725 
 726     private CompletableFuture&lt;Void&gt; uniAcceptStage(Executor e,
 727                                                    Consumer&lt;? super T&gt; f) {
 728         if (f == null) throw new NullPointerException();
 729         Object r;
 730         if ((r = result) != null)
 731             return uniAcceptNow(r, e, f);
 732         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
 733         unipush(new UniAccept&lt;T&gt;(e, d, this, f));
 734         return d;
 735     }
 736 
 737     private CompletableFuture&lt;Void&gt; uniAcceptNow(
 738         Object r, Executor e, Consumer&lt;? super T&gt; f) {
 739         Throwable x;
 740         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
 741         if (r instanceof AltResult) {
</pre>
<hr />
<pre>
 752                 @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
 753                 f.accept(t);
 754                 d.result = NIL;
 755             }
 756         } catch (Throwable ex) {
 757             d.result = encodeThrowable(ex);
 758         }
 759         return d;
 760     }
 761 
 762     @SuppressWarnings(&quot;serial&quot;)
 763     static final class UniRun&lt;T&gt; extends UniCompletion&lt;T,Void&gt; {
 764         Runnable fn;
 765         UniRun(Executor executor, CompletableFuture&lt;Void&gt; dep,
 766                CompletableFuture&lt;T&gt; src, Runnable fn) {
 767             super(executor, dep, src); this.fn = fn;
 768         }
 769         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
 770             CompletableFuture&lt;Void&gt; d; CompletableFuture&lt;T&gt; a;
 771             Object r; Throwable x; Runnable f;
<span class="line-modified"> 772             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified"> 773                 || (a = src) == null || (r = a.result) == null)</span>
 774                 return null;
 775             if (d.result == null) {
 776                 if (r instanceof AltResult &amp;&amp; (x = ((AltResult)r).ex) != null)
 777                     d.completeThrowable(x, r);
 778                 else
 779                     try {
 780                         if (mode &lt;= 0 &amp;&amp; !claim())
 781                             return null;
 782                         else {
 783                             f.run();
 784                             d.completeNull();
 785                         }
 786                     } catch (Throwable ex) {
 787                         d.completeThrowable(ex);
 788                     }
 789             }
<span class="line-modified"> 790             dep = null; src = null; fn = null;</span>
 791             return d.postFire(a, mode);
 792         }
 793     }
 794 
 795     private CompletableFuture&lt;Void&gt; uniRunStage(Executor e, Runnable f) {
 796         if (f == null) throw new NullPointerException();
 797         Object r;
 798         if ((r = result) != null)
 799             return uniRunNow(r, e, f);
 800         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
 801         unipush(new UniRun&lt;T&gt;(e, d, this, f));
 802         return d;
 803     }
 804 
 805     private CompletableFuture&lt;Void&gt; uniRunNow(Object r, Executor e, Runnable f) {
 806         Throwable x;
 807         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
 808         if (r instanceof AltResult &amp;&amp; (x = ((AltResult)r).ex) != null)
 809             d.result = encodeThrowable(x, r);
 810         else
</pre>
<hr />
<pre>
 815                     f.run();
 816                     d.result = NIL;
 817                 }
 818             } catch (Throwable ex) {
 819                 d.result = encodeThrowable(ex);
 820             }
 821         return d;
 822     }
 823 
 824     @SuppressWarnings(&quot;serial&quot;)
 825     static final class UniWhenComplete&lt;T&gt; extends UniCompletion&lt;T,T&gt; {
 826         BiConsumer&lt;? super T, ? super Throwable&gt; fn;
 827         UniWhenComplete(Executor executor, CompletableFuture&lt;T&gt; dep,
 828                         CompletableFuture&lt;T&gt; src,
 829                         BiConsumer&lt;? super T, ? super Throwable&gt; fn) {
 830             super(executor, dep, src); this.fn = fn;
 831         }
 832         final CompletableFuture&lt;T&gt; tryFire(int mode) {
 833             CompletableFuture&lt;T&gt; d; CompletableFuture&lt;T&gt; a;
 834             Object r; BiConsumer&lt;? super T, ? super Throwable&gt; f;
<span class="line-modified"> 835             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified"> 836                 || (a = src) == null || (r = a.result) == null</span>
 837                 || !d.uniWhenComplete(r, f, mode &gt; 0 ? null : this))
 838                 return null;
<span class="line-modified"> 839             dep = null; src = null; fn = null;</span>
 840             return d.postFire(a, mode);
 841         }
 842     }
 843 
 844     final boolean uniWhenComplete(Object r,
 845                                   BiConsumer&lt;? super T,? super Throwable&gt; f,
 846                                   UniWhenComplete&lt;T&gt; c) {
 847         T t; Throwable x = null;
 848         if (result == null) {
 849             try {
 850                 if (c != null &amp;&amp; !c.claim())
 851                     return false;
 852                 if (r instanceof AltResult) {
 853                     x = ((AltResult)r).ex;
 854                     t = null;
 855                 } else {
 856                     @SuppressWarnings(&quot;unchecked&quot;) T tr = (T) r;
 857                     t = tr;
 858                 }
 859                 f.accept(t, x);
</pre>
<hr />
<pre>
 885             try {
 886                 e.execute(new UniWhenComplete&lt;T&gt;(null, d, this, f));
 887             } catch (Throwable ex) {
 888                 d.result = encodeThrowable(ex);
 889             }
 890         }
 891         return d;
 892     }
 893 
 894     @SuppressWarnings(&quot;serial&quot;)
 895     static final class UniHandle&lt;T,V&gt; extends UniCompletion&lt;T,V&gt; {
 896         BiFunction&lt;? super T, Throwable, ? extends V&gt; fn;
 897         UniHandle(Executor executor, CompletableFuture&lt;V&gt; dep,
 898                   CompletableFuture&lt;T&gt; src,
 899                   BiFunction&lt;? super T, Throwable, ? extends V&gt; fn) {
 900             super(executor, dep, src); this.fn = fn;
 901         }
 902         final CompletableFuture&lt;V&gt; tryFire(int mode) {
 903             CompletableFuture&lt;V&gt; d; CompletableFuture&lt;T&gt; a;
 904             Object r; BiFunction&lt;? super T, Throwable, ? extends V&gt; f;
<span class="line-modified"> 905             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified"> 906                 || (a = src) == null || (r = a.result) == null</span>
 907                 || !d.uniHandle(r, f, mode &gt; 0 ? null : this))
 908                 return null;
<span class="line-modified"> 909             dep = null; src = null; fn = null;</span>
 910             return d.postFire(a, mode);
 911         }
 912     }
 913 
 914     final &lt;S&gt; boolean uniHandle(Object r,
 915                                 BiFunction&lt;? super S, Throwable, ? extends T&gt; f,
 916                                 UniHandle&lt;S,T&gt; c) {
 917         S s; Throwable x;
 918         if (result == null) {
 919             try {
 920                 if (c != null &amp;&amp; !c.claim())
 921                     return false;
 922                 if (r instanceof AltResult) {
 923                     x = ((AltResult)r).ex;
 924                     s = null;
 925                 } else {
 926                     x = null;
 927                     @SuppressWarnings(&quot;unchecked&quot;) S ss = (S) r;
 928                     s = ss;
 929                 }
</pre>
<hr />
<pre>
 948             try {
 949                 e.execute(new UniHandle&lt;T,V&gt;(null, d, this, f));
 950             } catch (Throwable ex) {
 951                 d.result = encodeThrowable(ex);
 952             }
 953         }
 954         return d;
 955     }
 956 
 957     @SuppressWarnings(&quot;serial&quot;)
 958     static final class UniExceptionally&lt;T&gt; extends UniCompletion&lt;T,T&gt; {
 959         Function&lt;? super Throwable, ? extends T&gt; fn;
 960         UniExceptionally(Executor executor,
 961                          CompletableFuture&lt;T&gt; dep, CompletableFuture&lt;T&gt; src,
 962                          Function&lt;? super Throwable, ? extends T&gt; fn) {
 963             super(executor, dep, src); this.fn = fn;
 964         }
 965         final CompletableFuture&lt;T&gt; tryFire(int mode) {
 966             CompletableFuture&lt;T&gt; d; CompletableFuture&lt;T&gt; a;
 967             Object r; Function&lt;? super Throwable, ? extends T&gt; f;
<span class="line-modified"> 968             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified"> 969                 || (a = src) == null || (r = a.result) == null</span>
 970                 || !d.uniExceptionally(r, f, mode &gt; 0 ? null : this))
 971                 return null;
<span class="line-modified"> 972             dep = null; src = null; fn = null;</span>
 973             return d.postFire(a, mode);
 974         }
 975     }
 976 
 977     final boolean uniExceptionally(Object r,
 978                                    Function&lt;? super Throwable, ? extends T&gt; f,
 979                                    UniExceptionally&lt;T&gt; c) {
 980         Throwable x;
 981         if (result == null) {
 982             try {
 983                 if (c != null &amp;&amp; !c.claim())
 984                     return false;
 985                 if (r instanceof AltResult &amp;&amp; (x = ((AltResult)r).ex) != null)
 986                     completeValue(f.apply(x));
 987                 else
 988                     internalComplete(r);
 989             } catch (Throwable ex) {
 990                 completeThrowable(ex);
 991             }
 992         }
</pre>
<hr />
<pre>
1007                 e.execute(new UniExceptionally&lt;T&gt;(null, d, this, f));
1008             } catch (Throwable ex) {
1009                 d.result = encodeThrowable(ex);
1010             }
1011         }
1012         return d;
1013     }
1014 
1015     @SuppressWarnings(&quot;serial&quot;)
1016     static final class UniComposeExceptionally&lt;T&gt; extends UniCompletion&lt;T,T&gt; {
1017         Function&lt;Throwable, ? extends CompletionStage&lt;T&gt;&gt; fn;
1018         UniComposeExceptionally(Executor executor, CompletableFuture&lt;T&gt; dep,
1019                                 CompletableFuture&lt;T&gt; src,
1020                                 Function&lt;Throwable, ? extends CompletionStage&lt;T&gt;&gt; fn) {
1021             super(executor, dep, src); this.fn = fn;
1022         }
1023         final CompletableFuture&lt;T&gt; tryFire(int mode) {
1024             CompletableFuture&lt;T&gt; d; CompletableFuture&lt;T&gt; a;
1025             Function&lt;Throwable, ? extends CompletionStage&lt;T&gt;&gt; f;
1026             Object r; Throwable x;
<span class="line-modified">1027             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified">1028                 || (a = src) == null || (r = a.result) == null)</span>
1029                 return null;
1030             if (d.result == null) {
1031                 if ((r instanceof AltResult) &amp;&amp;
1032                     (x = ((AltResult)r).ex) != null) {
1033                     try {
1034                         if (mode &lt;= 0 &amp;&amp; !claim())
1035                             return null;
1036                         CompletableFuture&lt;T&gt; g = f.apply(x).toCompletableFuture();
1037                         if ((r = g.result) != null)
1038                             d.completeRelay(r);
1039                         else {
1040                             g.unipush(new UniRelay&lt;T,T&gt;(d, g));
1041                             if (d.result == null)
1042                                 return null;
1043                         }
1044                     } catch (Throwable ex) {
1045                         d.completeThrowable(ex);
1046                     }
1047                 }
1048                 else
1049                     d.internalComplete(r);
1050             }
<span class="line-modified">1051             dep = null; src = null; fn = null;</span>
1052             return d.postFire(a, mode);
1053         }
1054     }
1055 
1056     private CompletableFuture&lt;T&gt; uniComposeExceptionallyStage(
1057         Executor e, Function&lt;Throwable, ? extends CompletionStage&lt;T&gt;&gt; f) {
1058         if (f == null) throw new NullPointerException();
1059         CompletableFuture&lt;T&gt; d = newIncompleteFuture();
1060         Object r, s; Throwable x;
1061         if ((r = result) == null)
1062             unipush(new UniComposeExceptionally&lt;T&gt;(e, d, this, f));
1063         else if (!(r instanceof AltResult) || (x = ((AltResult)r).ex) == null)
1064             d.internalComplete(r);
1065         else
1066             try {
1067                 if (e != null)
1068                     e.execute(new UniComposeExceptionally&lt;T&gt;(null, d, this, f));
1069                 else {
1070                     CompletableFuture&lt;T&gt; g = f.apply(x).toCompletableFuture();
1071                     if ((s = g.result) != null)
1072                         d.result = encodeRelay(s);
1073                     else
1074                         g.unipush(new UniRelay&lt;T,T&gt;(d, g));
1075                 }
1076             } catch (Throwable ex) {
1077                 d.result = encodeThrowable(ex);
1078             }
1079         return d;
1080     }
1081 
1082     @SuppressWarnings(&quot;serial&quot;)
1083     static final class UniRelay&lt;U, T extends U&gt; extends UniCompletion&lt;T,U&gt; {
1084         UniRelay(CompletableFuture&lt;U&gt; dep, CompletableFuture&lt;T&gt; src) {
1085             super(null, dep, src);
1086         }
1087         final CompletableFuture&lt;U&gt; tryFire(int mode) {
1088             CompletableFuture&lt;U&gt; d; CompletableFuture&lt;T&gt; a; Object r;
<span class="line-modified">1089             if ((d = dep) == null</span>
<span class="line-modified">1090                 || (a = src) == null || (r = a.result) == null)</span>
1091                 return null;
1092             if (d.result == null)
1093                 d.completeRelay(r);
1094             src = null; dep = null;
1095             return d.postFire(a, mode);
1096         }
1097     }
1098 
1099     private static &lt;U, T extends U&gt; CompletableFuture&lt;U&gt; uniCopyStage(
1100         CompletableFuture&lt;T&gt; src) {
1101         Object r;
1102         CompletableFuture&lt;U&gt; d = src.newIncompleteFuture();
1103         if ((r = src.result) != null)
1104             d.result = encodeRelay(r);
1105         else
1106             src.unipush(new UniRelay&lt;U,T&gt;(d, src));
1107         return d;
1108     }
1109 
1110     private MinimalStage&lt;T&gt; uniAsMinimalStage() {
1111         Object r;
1112         if ((r = result) != null)
1113             return new MinimalStage&lt;T&gt;(encodeRelay(r));
1114         MinimalStage&lt;T&gt; d = new MinimalStage&lt;T&gt;();
1115         unipush(new UniRelay&lt;T,T&gt;(d, this));
1116         return d;
1117     }
1118 
1119     @SuppressWarnings(&quot;serial&quot;)
1120     static final class UniCompose&lt;T,V&gt; extends UniCompletion&lt;T,V&gt; {
1121         Function&lt;? super T, ? extends CompletionStage&lt;V&gt;&gt; fn;
1122         UniCompose(Executor executor, CompletableFuture&lt;V&gt; dep,
1123                    CompletableFuture&lt;T&gt; src,
1124                    Function&lt;? super T, ? extends CompletionStage&lt;V&gt;&gt; fn) {
1125             super(executor, dep, src); this.fn = fn;
1126         }
1127         final CompletableFuture&lt;V&gt; tryFire(int mode) {
1128             CompletableFuture&lt;V&gt; d; CompletableFuture&lt;T&gt; a;
1129             Function&lt;? super T, ? extends CompletionStage&lt;V&gt;&gt; f;
1130             Object r; Throwable x;
<span class="line-modified">1131             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified">1132                 || (a = src) == null || (r = a.result) == null)</span>
1133                 return null;
1134             tryComplete: if (d.result == null) {
1135                 if (r instanceof AltResult) {
1136                     if ((x = ((AltResult)r).ex) != null) {
1137                         d.completeThrowable(x, r);
1138                         break tryComplete;
1139                     }
1140                     r = null;
1141                 }
1142                 try {
1143                     if (mode &lt;= 0 &amp;&amp; !claim())
1144                         return null;
1145                     @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
1146                     CompletableFuture&lt;V&gt; g = f.apply(t).toCompletableFuture();
1147                     if ((r = g.result) != null)
1148                         d.completeRelay(r);
1149                     else {
1150                         g.unipush(new UniRelay&lt;V,V&gt;(d, g));
1151                         if (d.result == null)
1152                             return null;
1153                     }
1154                 } catch (Throwable ex) {
1155                     d.completeThrowable(ex);
1156                 }
1157             }
<span class="line-modified">1158             dep = null; src = null; fn = null;</span>
1159             return d.postFire(a, mode);
1160         }
1161     }
1162 
1163     private &lt;V&gt; CompletableFuture&lt;V&gt; uniComposeStage(
1164         Executor e, Function&lt;? super T, ? extends CompletionStage&lt;V&gt;&gt; f) {
1165         if (f == null) throw new NullPointerException();
1166         CompletableFuture&lt;V&gt; d = newIncompleteFuture();
1167         Object r, s; Throwable x;
1168         if ((r = result) == null)
1169             unipush(new UniCompose&lt;T,V&gt;(e, d, this, f));
1170         else {
1171             if (r instanceof AltResult) {
1172                 if ((x = ((AltResult)r).ex) != null) {
1173                     d.result = encodeThrowable(x, r);
1174                     return d;
1175                 }
1176                 r = null;
1177             }
1178             try {
</pre>
<hr />
<pre>
1253                 b.cleanStack();
1254             if (mode &gt;= 0 &amp;&amp; (r != null || b.result != null))
1255                 b.postComplete();
1256         }
1257         return postFire(a, mode);
1258     }
1259 
1260     @SuppressWarnings(&quot;serial&quot;)
1261     static final class BiApply&lt;T,U,V&gt; extends BiCompletion&lt;T,U,V&gt; {
1262         BiFunction&lt;? super T,? super U,? extends V&gt; fn;
1263         BiApply(Executor executor, CompletableFuture&lt;V&gt; dep,
1264                 CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1265                 BiFunction&lt;? super T,? super U,? extends V&gt; fn) {
1266             super(executor, dep, src, snd); this.fn = fn;
1267         }
1268         final CompletableFuture&lt;V&gt; tryFire(int mode) {
1269             CompletableFuture&lt;V&gt; d;
1270             CompletableFuture&lt;T&gt; a;
1271             CompletableFuture&lt;U&gt; b;
1272             Object r, s; BiFunction&lt;? super T,? super U,? extends V&gt; f;
<span class="line-modified">1273             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-removed">1274                 || (a = src) == null || (r = a.result) == null</span>
1275                 || (b = snd) == null || (s = b.result) == null

1276                 || !d.biApply(r, s, f, mode &gt; 0 ? null : this))
1277                 return null;
<span class="line-modified">1278             dep = null; src = null; snd = null; fn = null;</span>
1279             return d.postFire(a, b, mode);
1280         }
1281     }
1282 
1283     final &lt;R,S&gt; boolean biApply(Object r, Object s,
1284                                 BiFunction&lt;? super R,? super S,? extends T&gt; f,
1285                                 BiApply&lt;R,S,T&gt; c) {
1286         Throwable x;
1287         tryComplete: if (result == null) {
1288             if (r instanceof AltResult) {
1289                 if ((x = ((AltResult)r).ex) != null) {
1290                     completeThrowable(x, r);
1291                     break tryComplete;
1292                 }
1293                 r = null;
1294             }
1295             if (s instanceof AltResult) {
1296                 if ((x = ((AltResult)s).ex) != null) {
1297                     completeThrowable(x, s);
1298                     break tryComplete;
</pre>
<hr />
<pre>
1328                 e.execute(new BiApply&lt;T,U,V&gt;(null, d, this, b, f));
1329             } catch (Throwable ex) {
1330                 d.result = encodeThrowable(ex);
1331             }
1332         return d;
1333     }
1334 
1335     @SuppressWarnings(&quot;serial&quot;)
1336     static final class BiAccept&lt;T,U&gt; extends BiCompletion&lt;T,U,Void&gt; {
1337         BiConsumer&lt;? super T,? super U&gt; fn;
1338         BiAccept(Executor executor, CompletableFuture&lt;Void&gt; dep,
1339                  CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1340                  BiConsumer&lt;? super T,? super U&gt; fn) {
1341             super(executor, dep, src, snd); this.fn = fn;
1342         }
1343         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
1344             CompletableFuture&lt;Void&gt; d;
1345             CompletableFuture&lt;T&gt; a;
1346             CompletableFuture&lt;U&gt; b;
1347             Object r, s; BiConsumer&lt;? super T,? super U&gt; f;
<span class="line-modified">1348             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-removed">1349                 || (a = src) == null || (r = a.result) == null</span>
1350                 || (b = snd) == null || (s = b.result) == null

1351                 || !d.biAccept(r, s, f, mode &gt; 0 ? null : this))
1352                 return null;
<span class="line-modified">1353             dep = null; src = null; snd = null; fn = null;</span>
1354             return d.postFire(a, b, mode);
1355         }
1356     }
1357 
1358     final &lt;R,S&gt; boolean biAccept(Object r, Object s,
1359                                  BiConsumer&lt;? super R,? super S&gt; f,
1360                                  BiAccept&lt;R,S&gt; c) {
1361         Throwable x;
1362         tryComplete: if (result == null) {
1363             if (r instanceof AltResult) {
1364                 if ((x = ((AltResult)r).ex) != null) {
1365                     completeThrowable(x, r);
1366                     break tryComplete;
1367                 }
1368                 r = null;
1369             }
1370             if (s instanceof AltResult) {
1371                 if ((x = ((AltResult)s).ex) != null) {
1372                     completeThrowable(x, s);
1373                     break tryComplete;
</pre>
<hr />
<pre>
1404                 e.execute(new BiAccept&lt;T,U&gt;(null, d, this, b, f));
1405             } catch (Throwable ex) {
1406                 d.result = encodeThrowable(ex);
1407             }
1408         return d;
1409     }
1410 
1411     @SuppressWarnings(&quot;serial&quot;)
1412     static final class BiRun&lt;T,U&gt; extends BiCompletion&lt;T,U,Void&gt; {
1413         Runnable fn;
1414         BiRun(Executor executor, CompletableFuture&lt;Void&gt; dep,
1415               CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1416               Runnable fn) {
1417             super(executor, dep, src, snd); this.fn = fn;
1418         }
1419         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
1420             CompletableFuture&lt;Void&gt; d;
1421             CompletableFuture&lt;T&gt; a;
1422             CompletableFuture&lt;U&gt; b;
1423             Object r, s; Runnable f;
<span class="line-modified">1424             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-removed">1425                 || (a = src) == null || (r = a.result) == null</span>
1426                 || (b = snd) == null || (s = b.result) == null

1427                 || !d.biRun(r, s, f, mode &gt; 0 ? null : this))
1428                 return null;
<span class="line-modified">1429             dep = null; src = null; snd = null; fn = null;</span>
1430             return d.postFire(a, b, mode);
1431         }
1432     }
1433 
1434     final boolean biRun(Object r, Object s, Runnable f, BiRun&lt;?,?&gt; c) {
1435         Throwable x; Object z;
1436         if (result == null) {
1437             if ((r instanceof AltResult
1438                  &amp;&amp; (x = ((AltResult)(z = r)).ex) != null) ||
1439                 (s instanceof AltResult
1440                  &amp;&amp; (x = ((AltResult)(z = s)).ex) != null))
1441                 completeThrowable(x, z);
1442             else
1443                 try {
1444                     if (c != null &amp;&amp; !c.claim())
1445                         return false;
1446                     f.run();
1447                     completeNull();
1448                 } catch (Throwable ex) {
1449                     completeThrowable(ex);
</pre>
<hr />
<pre>
1465         else
1466             try {
1467                 e.execute(new BiRun&lt;&gt;(null, d, this, b, f));
1468             } catch (Throwable ex) {
1469                 d.result = encodeThrowable(ex);
1470             }
1471         return d;
1472     }
1473 
1474     @SuppressWarnings(&quot;serial&quot;)
1475     static final class BiRelay&lt;T,U&gt; extends BiCompletion&lt;T,U,Void&gt; { // for And
1476         BiRelay(CompletableFuture&lt;Void&gt; dep,
1477                 CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd) {
1478             super(null, dep, src, snd);
1479         }
1480         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
1481             CompletableFuture&lt;Void&gt; d;
1482             CompletableFuture&lt;T&gt; a;
1483             CompletableFuture&lt;U&gt; b;
1484             Object r, s, z; Throwable x;
<span class="line-modified">1485             if ((d = dep) == null</span>
<span class="line-modified">1486                 || (a = src) == null || (r = a.result) == null</span>
<span class="line-modified">1487                 || (b = snd) == null || (s = b.result) == null)</span>
1488                 return null;
1489             if (d.result == null) {
1490                 if ((r instanceof AltResult
1491                      &amp;&amp; (x = ((AltResult)(z = r)).ex) != null) ||
1492                     (s instanceof AltResult
1493                      &amp;&amp; (x = ((AltResult)(z = s)).ex) != null))
1494                     d.completeThrowable(x, z);
1495                 else
1496                     d.completeNull();
1497             }
1498             src = null; snd = null; dep = null;
1499             return d.postFire(a, b, mode);
1500         }
1501     }
1502 
1503     /** Recursively constructs a tree of completions. */
1504     static CompletableFuture&lt;Void&gt; andTree(CompletableFuture&lt;?&gt;[] cfs,
1505                                            int lo, int hi) {
1506         CompletableFuture&lt;Void&gt; d = new CompletableFuture&lt;Void&gt;();
1507         if (lo &gt; hi) // empty
</pre>
<hr />
<pre>
1540                     NEXT.set(c, null);
1541                     break;
1542                 }
1543             }
1544             if (result != null)
1545                 c.tryFire(SYNC);
1546             else
1547                 b.unipush(new CoCompletion(c));
1548         }
1549     }
1550 
1551     @SuppressWarnings(&quot;serial&quot;)
1552     static final class OrApply&lt;T,U extends T,V&gt; extends BiCompletion&lt;T,U,V&gt; {
1553         Function&lt;? super T,? extends V&gt; fn;
1554         OrApply(Executor executor, CompletableFuture&lt;V&gt; dep,
1555                 CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1556                 Function&lt;? super T,? extends V&gt; fn) {
1557             super(executor, dep, src, snd); this.fn = fn;
1558         }
1559         final CompletableFuture&lt;V&gt; tryFire(int mode) {
<span class="line-modified">1560             CompletableFuture&lt;V&gt; d;</span>
<span class="line-removed">1561             CompletableFuture&lt;T&gt; a;</span>
<span class="line-removed">1562             CompletableFuture&lt;U&gt; b;</span>
1563             Object r; Throwable x; Function&lt;? super T,? extends V&gt; f;
<span class="line-modified">1564             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified">1565                 || (a = src) == null || (b = snd) == null</span>
<span class="line-modified">1566                 || ((r = a.result) == null &amp;&amp; (r = b.result) == null))</span>
1567                 return null;
1568             tryComplete: if (d.result == null) {
1569                 try {
1570                     if (mode &lt;= 0 &amp;&amp; !claim())
1571                         return null;
1572                     if (r instanceof AltResult) {
1573                         if ((x = ((AltResult)r).ex) != null) {
1574                             d.completeThrowable(x, r);
1575                             break tryComplete;
1576                         }
1577                         r = null;
1578                     }
1579                     @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
1580                     d.completeValue(f.apply(t));
1581                 } catch (Throwable ex) {
1582                     d.completeThrowable(ex);
1583                 }
1584             }
<span class="line-modified">1585             dep = null; src = null; snd = null; fn = null;</span>
1586             return d.postFire(a, b, mode);
1587         }
1588     }
1589 
1590     private &lt;U extends T,V&gt; CompletableFuture&lt;V&gt; orApplyStage(
1591         Executor e, CompletionStage&lt;U&gt; o, Function&lt;? super T, ? extends V&gt; f) {
1592         CompletableFuture&lt;U&gt; b;
1593         if (f == null || (b = o.toCompletableFuture()) == null)
1594             throw new NullPointerException();
1595 
1596         Object r; CompletableFuture&lt;? extends T&gt; z;
1597         if ((r = (z = this).result) != null ||
1598             (r = (z = b).result) != null)
1599             return z.uniApplyNow(r, e, f);
1600 
1601         CompletableFuture&lt;V&gt; d = newIncompleteFuture();
1602         orpush(b, new OrApply&lt;T,U,V&gt;(e, d, this, b, f));
1603         return d;
1604     }
1605 
1606     @SuppressWarnings(&quot;serial&quot;)
1607     static final class OrAccept&lt;T,U extends T&gt; extends BiCompletion&lt;T,U,Void&gt; {
1608         Consumer&lt;? super T&gt; fn;
1609         OrAccept(Executor executor, CompletableFuture&lt;Void&gt; dep,
1610                  CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1611                  Consumer&lt;? super T&gt; fn) {
1612             super(executor, dep, src, snd); this.fn = fn;
1613         }
1614         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
<span class="line-modified">1615             CompletableFuture&lt;Void&gt; d;</span>
<span class="line-removed">1616             CompletableFuture&lt;T&gt; a;</span>
<span class="line-removed">1617             CompletableFuture&lt;U&gt; b;</span>
1618             Object r; Throwable x; Consumer&lt;? super T&gt; f;
<span class="line-modified">1619             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified">1620                 || (a = src) == null || (b = snd) == null</span>
<span class="line-modified">1621                 || ((r = a.result) == null &amp;&amp; (r = b.result) == null))</span>
1622                 return null;
1623             tryComplete: if (d.result == null) {
1624                 try {
1625                     if (mode &lt;= 0 &amp;&amp; !claim())
1626                         return null;
1627                     if (r instanceof AltResult) {
1628                         if ((x = ((AltResult)r).ex) != null) {
1629                             d.completeThrowable(x, r);
1630                             break tryComplete;
1631                         }
1632                         r = null;
1633                     }
1634                     @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
1635                     f.accept(t);
1636                     d.completeNull();
1637                 } catch (Throwable ex) {
1638                     d.completeThrowable(ex);
1639                 }
1640             }
<span class="line-modified">1641             dep = null; src = null; snd = null; fn = null;</span>
1642             return d.postFire(a, b, mode);
1643         }
1644     }
1645 
1646     private &lt;U extends T&gt; CompletableFuture&lt;Void&gt; orAcceptStage(
1647         Executor e, CompletionStage&lt;U&gt; o, Consumer&lt;? super T&gt; f) {
1648         CompletableFuture&lt;U&gt; b;
1649         if (f == null || (b = o.toCompletableFuture()) == null)
1650             throw new NullPointerException();
1651 
1652         Object r; CompletableFuture&lt;? extends T&gt; z;
1653         if ((r = (z = this).result) != null ||
1654             (r = (z = b).result) != null)
1655             return z.uniAcceptNow(r, e, f);
1656 
1657         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
1658         orpush(b, new OrAccept&lt;T,U&gt;(e, d, this, b, f));
1659         return d;
1660     }
1661 
1662     @SuppressWarnings(&quot;serial&quot;)
1663     static final class OrRun&lt;T,U&gt; extends BiCompletion&lt;T,U,Void&gt; {
1664         Runnable fn;
1665         OrRun(Executor executor, CompletableFuture&lt;Void&gt; dep,
1666               CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1667               Runnable fn) {
1668             super(executor, dep, src, snd); this.fn = fn;
1669         }
1670         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
<span class="line-modified">1671             CompletableFuture&lt;Void&gt; d;</span>
<span class="line-removed">1672             CompletableFuture&lt;T&gt; a;</span>
<span class="line-removed">1673             CompletableFuture&lt;U&gt; b;</span>
1674             Object r; Throwable x; Runnable f;
<span class="line-modified">1675             if ((d = dep) == null || (f = fn) == null</span>
<span class="line-modified">1676                 || (a = src) == null || (b = snd) == null</span>
<span class="line-modified">1677                 || ((r = a.result) == null &amp;&amp; (r = b.result) == null))</span>
1678                 return null;
1679             if (d.result == null) {
1680                 try {
1681                     if (mode &lt;= 0 &amp;&amp; !claim())
1682                         return null;
1683                     else if (r instanceof AltResult
1684                         &amp;&amp; (x = ((AltResult)r).ex) != null)
1685                         d.completeThrowable(x, r);
1686                     else {
1687                         f.run();
1688                         d.completeNull();
1689                     }
1690                 } catch (Throwable ex) {
1691                     d.completeThrowable(ex);
1692                 }
1693             }
<span class="line-modified">1694             dep = null; src = null; snd = null; fn = null;</span>
1695             return d.postFire(a, b, mode);
1696         }
1697     }
1698 
1699     private CompletableFuture&lt;Void&gt; orRunStage(Executor e, CompletionStage&lt;?&gt; o,
1700                                                Runnable f) {
1701         CompletableFuture&lt;?&gt; b;
1702         if (f == null || (b = o.toCompletableFuture()) == null)
1703             throw new NullPointerException();
1704 
1705         Object r; CompletableFuture&lt;?&gt; z;
1706         if ((r = (z = this).result) != null ||
1707             (r = (z = b).result) != null)
1708             return z.uniRunNow(r, e, f);
1709 
1710         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
1711         orpush(b, new OrRun&lt;&gt;(e, d, this, b, f));
1712         return d;
1713     }
1714 
1715     /** Completion for an anyOf input future. */
1716     @SuppressWarnings(&quot;serial&quot;)
1717     static class AnyOf extends Completion {
1718         CompletableFuture&lt;Object&gt; dep; CompletableFuture&lt;?&gt; src;
1719         CompletableFuture&lt;?&gt;[] srcs;
1720         AnyOf(CompletableFuture&lt;Object&gt; dep, CompletableFuture&lt;?&gt; src,
1721               CompletableFuture&lt;?&gt;[] srcs) {
1722             this.dep = dep; this.src = src; this.srcs = srcs;
1723         }
1724         final CompletableFuture&lt;Object&gt; tryFire(int mode) {
1725             // assert mode != ASYNC;
1726             CompletableFuture&lt;Object&gt; d; CompletableFuture&lt;?&gt; a;
1727             CompletableFuture&lt;?&gt;[] as;
1728             Object r;
<span class="line-modified">1729             if ((d = dep) == null</span>
<span class="line-modified">1730                 || (a = src) == null || (r = a.result) == null</span>
<span class="line-removed">1731                 || (as = srcs) == null)</span>
1732                 return null;
<span class="line-modified">1733             dep = null; src = null; srcs = null;</span>
1734             if (d.completeRelay(r)) {
1735                 for (CompletableFuture&lt;?&gt; b : as)
1736                     if (b != a)
1737                         b.cleanStack();
1738                 if (mode &lt; 0)
1739                     return d;
1740                 else
1741                     d.postComplete();
1742             }
1743             return null;
1744         }
1745         final boolean isLive() {
1746             CompletableFuture&lt;Object&gt; d;
1747             return (d = dep) != null &amp;&amp; d.result == null;
1748         }
1749     }
1750 
1751     /* ------------- Zero-input Async forms -------------- */
1752 
1753     @SuppressWarnings(&quot;serial&quot;)
</pre>
</td>
<td>
<hr />
<pre>
 606         if (result != null &amp;&amp; stack != null) {
 607             if (mode &lt; 0)
 608                 return this;
 609             else
 610                 postComplete();
 611         }
 612         return null;
 613     }
 614 
 615     @SuppressWarnings(&quot;serial&quot;)
 616     static final class UniApply&lt;T,V&gt; extends UniCompletion&lt;T,V&gt; {
 617         Function&lt;? super T,? extends V&gt; fn;
 618         UniApply(Executor executor, CompletableFuture&lt;V&gt; dep,
 619                  CompletableFuture&lt;T&gt; src,
 620                  Function&lt;? super T,? extends V&gt; fn) {
 621             super(executor, dep, src); this.fn = fn;
 622         }
 623         final CompletableFuture&lt;V&gt; tryFire(int mode) {
 624             CompletableFuture&lt;V&gt; d; CompletableFuture&lt;T&gt; a;
 625             Object r; Throwable x; Function&lt;? super T,? extends V&gt; f;
<span class="line-modified"> 626             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified"> 627                 || (d = dep) == null || (f = fn) == null)</span>
 628                 return null;
 629             tryComplete: if (d.result == null) {
 630                 if (r instanceof AltResult) {
 631                     if ((x = ((AltResult)r).ex) != null) {
 632                         d.completeThrowable(x, r);
 633                         break tryComplete;
 634                     }
 635                     r = null;
 636                 }
 637                 try {
 638                     if (mode &lt;= 0 &amp;&amp; !claim())
 639                         return null;
 640                     else {
 641                         @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
 642                         d.completeValue(f.apply(t));
 643                     }
 644                 } catch (Throwable ex) {
 645                     d.completeThrowable(ex);
 646                 }
 647             }
<span class="line-modified"> 648             src = null; dep = null; fn = null;</span>
 649             return d.postFire(a, mode);
 650         }
 651     }
 652 
 653     private &lt;V&gt; CompletableFuture&lt;V&gt; uniApplyStage(
 654         Executor e, Function&lt;? super T,? extends V&gt; f) {
 655         if (f == null) throw new NullPointerException();
 656         Object r;
 657         if ((r = result) != null)
 658             return uniApplyNow(r, e, f);
 659         CompletableFuture&lt;V&gt; d = newIncompleteFuture();
 660         unipush(new UniApply&lt;T,V&gt;(e, d, this, f));
 661         return d;
 662     }
 663 
 664     private &lt;V&gt; CompletableFuture&lt;V&gt; uniApplyNow(
 665         Object r, Executor e, Function&lt;? super T,? extends V&gt; f) {
 666         Throwable x;
 667         CompletableFuture&lt;V&gt; d = newIncompleteFuture();
 668         if (r instanceof AltResult) {
</pre>
<hr />
<pre>
 678             } else {
 679                 @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
 680                 d.result = d.encodeValue(f.apply(t));
 681             }
 682         } catch (Throwable ex) {
 683             d.result = encodeThrowable(ex);
 684         }
 685         return d;
 686     }
 687 
 688     @SuppressWarnings(&quot;serial&quot;)
 689     static final class UniAccept&lt;T&gt; extends UniCompletion&lt;T,Void&gt; {
 690         Consumer&lt;? super T&gt; fn;
 691         UniAccept(Executor executor, CompletableFuture&lt;Void&gt; dep,
 692                   CompletableFuture&lt;T&gt; src, Consumer&lt;? super T&gt; fn) {
 693             super(executor, dep, src); this.fn = fn;
 694         }
 695         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
 696             CompletableFuture&lt;Void&gt; d; CompletableFuture&lt;T&gt; a;
 697             Object r; Throwable x; Consumer&lt;? super T&gt; f;
<span class="line-modified"> 698             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified"> 699                 || (d = dep) == null || (f = fn) == null)</span>
 700                 return null;
 701             tryComplete: if (d.result == null) {
 702                 if (r instanceof AltResult) {
 703                     if ((x = ((AltResult)r).ex) != null) {
 704                         d.completeThrowable(x, r);
 705                         break tryComplete;
 706                     }
 707                     r = null;
 708                 }
 709                 try {
 710                     if (mode &lt;= 0 &amp;&amp; !claim())
 711                         return null;
 712                     else {
 713                         @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
 714                         f.accept(t);
 715                         d.completeNull();
 716                     }
 717                 } catch (Throwable ex) {
 718                     d.completeThrowable(ex);
 719                 }
 720             }
<span class="line-modified"> 721             src = null; dep = null; fn = null;</span>
 722             return d.postFire(a, mode);
 723         }
 724     }
 725 
 726     private CompletableFuture&lt;Void&gt; uniAcceptStage(Executor e,
 727                                                    Consumer&lt;? super T&gt; f) {
 728         if (f == null) throw new NullPointerException();
 729         Object r;
 730         if ((r = result) != null)
 731             return uniAcceptNow(r, e, f);
 732         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
 733         unipush(new UniAccept&lt;T&gt;(e, d, this, f));
 734         return d;
 735     }
 736 
 737     private CompletableFuture&lt;Void&gt; uniAcceptNow(
 738         Object r, Executor e, Consumer&lt;? super T&gt; f) {
 739         Throwable x;
 740         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
 741         if (r instanceof AltResult) {
</pre>
<hr />
<pre>
 752                 @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
 753                 f.accept(t);
 754                 d.result = NIL;
 755             }
 756         } catch (Throwable ex) {
 757             d.result = encodeThrowable(ex);
 758         }
 759         return d;
 760     }
 761 
 762     @SuppressWarnings(&quot;serial&quot;)
 763     static final class UniRun&lt;T&gt; extends UniCompletion&lt;T,Void&gt; {
 764         Runnable fn;
 765         UniRun(Executor executor, CompletableFuture&lt;Void&gt; dep,
 766                CompletableFuture&lt;T&gt; src, Runnable fn) {
 767             super(executor, dep, src); this.fn = fn;
 768         }
 769         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
 770             CompletableFuture&lt;Void&gt; d; CompletableFuture&lt;T&gt; a;
 771             Object r; Throwable x; Runnable f;
<span class="line-modified"> 772             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified"> 773                 || (d = dep) == null || (f = fn) == null)</span>
 774                 return null;
 775             if (d.result == null) {
 776                 if (r instanceof AltResult &amp;&amp; (x = ((AltResult)r).ex) != null)
 777                     d.completeThrowable(x, r);
 778                 else
 779                     try {
 780                         if (mode &lt;= 0 &amp;&amp; !claim())
 781                             return null;
 782                         else {
 783                             f.run();
 784                             d.completeNull();
 785                         }
 786                     } catch (Throwable ex) {
 787                         d.completeThrowable(ex);
 788                     }
 789             }
<span class="line-modified"> 790             src = null; dep = null; fn = null;</span>
 791             return d.postFire(a, mode);
 792         }
 793     }
 794 
 795     private CompletableFuture&lt;Void&gt; uniRunStage(Executor e, Runnable f) {
 796         if (f == null) throw new NullPointerException();
 797         Object r;
 798         if ((r = result) != null)
 799             return uniRunNow(r, e, f);
 800         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
 801         unipush(new UniRun&lt;T&gt;(e, d, this, f));
 802         return d;
 803     }
 804 
 805     private CompletableFuture&lt;Void&gt; uniRunNow(Object r, Executor e, Runnable f) {
 806         Throwable x;
 807         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
 808         if (r instanceof AltResult &amp;&amp; (x = ((AltResult)r).ex) != null)
 809             d.result = encodeThrowable(x, r);
 810         else
</pre>
<hr />
<pre>
 815                     f.run();
 816                     d.result = NIL;
 817                 }
 818             } catch (Throwable ex) {
 819                 d.result = encodeThrowable(ex);
 820             }
 821         return d;
 822     }
 823 
 824     @SuppressWarnings(&quot;serial&quot;)
 825     static final class UniWhenComplete&lt;T&gt; extends UniCompletion&lt;T,T&gt; {
 826         BiConsumer&lt;? super T, ? super Throwable&gt; fn;
 827         UniWhenComplete(Executor executor, CompletableFuture&lt;T&gt; dep,
 828                         CompletableFuture&lt;T&gt; src,
 829                         BiConsumer&lt;? super T, ? super Throwable&gt; fn) {
 830             super(executor, dep, src); this.fn = fn;
 831         }
 832         final CompletableFuture&lt;T&gt; tryFire(int mode) {
 833             CompletableFuture&lt;T&gt; d; CompletableFuture&lt;T&gt; a;
 834             Object r; BiConsumer&lt;? super T, ? super Throwable&gt; f;
<span class="line-modified"> 835             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified"> 836                 || (d = dep) == null || (f = fn) == null</span>
 837                 || !d.uniWhenComplete(r, f, mode &gt; 0 ? null : this))
 838                 return null;
<span class="line-modified"> 839             src = null; dep = null; fn = null;</span>
 840             return d.postFire(a, mode);
 841         }
 842     }
 843 
 844     final boolean uniWhenComplete(Object r,
 845                                   BiConsumer&lt;? super T,? super Throwable&gt; f,
 846                                   UniWhenComplete&lt;T&gt; c) {
 847         T t; Throwable x = null;
 848         if (result == null) {
 849             try {
 850                 if (c != null &amp;&amp; !c.claim())
 851                     return false;
 852                 if (r instanceof AltResult) {
 853                     x = ((AltResult)r).ex;
 854                     t = null;
 855                 } else {
 856                     @SuppressWarnings(&quot;unchecked&quot;) T tr = (T) r;
 857                     t = tr;
 858                 }
 859                 f.accept(t, x);
</pre>
<hr />
<pre>
 885             try {
 886                 e.execute(new UniWhenComplete&lt;T&gt;(null, d, this, f));
 887             } catch (Throwable ex) {
 888                 d.result = encodeThrowable(ex);
 889             }
 890         }
 891         return d;
 892     }
 893 
 894     @SuppressWarnings(&quot;serial&quot;)
 895     static final class UniHandle&lt;T,V&gt; extends UniCompletion&lt;T,V&gt; {
 896         BiFunction&lt;? super T, Throwable, ? extends V&gt; fn;
 897         UniHandle(Executor executor, CompletableFuture&lt;V&gt; dep,
 898                   CompletableFuture&lt;T&gt; src,
 899                   BiFunction&lt;? super T, Throwable, ? extends V&gt; fn) {
 900             super(executor, dep, src); this.fn = fn;
 901         }
 902         final CompletableFuture&lt;V&gt; tryFire(int mode) {
 903             CompletableFuture&lt;V&gt; d; CompletableFuture&lt;T&gt; a;
 904             Object r; BiFunction&lt;? super T, Throwable, ? extends V&gt; f;
<span class="line-modified"> 905             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified"> 906                 || (d = dep) == null || (f = fn) == null</span>
 907                 || !d.uniHandle(r, f, mode &gt; 0 ? null : this))
 908                 return null;
<span class="line-modified"> 909             src = null; dep = null; fn = null;</span>
 910             return d.postFire(a, mode);
 911         }
 912     }
 913 
 914     final &lt;S&gt; boolean uniHandle(Object r,
 915                                 BiFunction&lt;? super S, Throwable, ? extends T&gt; f,
 916                                 UniHandle&lt;S,T&gt; c) {
 917         S s; Throwable x;
 918         if (result == null) {
 919             try {
 920                 if (c != null &amp;&amp; !c.claim())
 921                     return false;
 922                 if (r instanceof AltResult) {
 923                     x = ((AltResult)r).ex;
 924                     s = null;
 925                 } else {
 926                     x = null;
 927                     @SuppressWarnings(&quot;unchecked&quot;) S ss = (S) r;
 928                     s = ss;
 929                 }
</pre>
<hr />
<pre>
 948             try {
 949                 e.execute(new UniHandle&lt;T,V&gt;(null, d, this, f));
 950             } catch (Throwable ex) {
 951                 d.result = encodeThrowable(ex);
 952             }
 953         }
 954         return d;
 955     }
 956 
 957     @SuppressWarnings(&quot;serial&quot;)
 958     static final class UniExceptionally&lt;T&gt; extends UniCompletion&lt;T,T&gt; {
 959         Function&lt;? super Throwable, ? extends T&gt; fn;
 960         UniExceptionally(Executor executor,
 961                          CompletableFuture&lt;T&gt; dep, CompletableFuture&lt;T&gt; src,
 962                          Function&lt;? super Throwable, ? extends T&gt; fn) {
 963             super(executor, dep, src); this.fn = fn;
 964         }
 965         final CompletableFuture&lt;T&gt; tryFire(int mode) {
 966             CompletableFuture&lt;T&gt; d; CompletableFuture&lt;T&gt; a;
 967             Object r; Function&lt;? super Throwable, ? extends T&gt; f;
<span class="line-modified"> 968             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified"> 969                 || (d = dep) == null || (f = fn) == null</span>
 970                 || !d.uniExceptionally(r, f, mode &gt; 0 ? null : this))
 971                 return null;
<span class="line-modified"> 972             src = null; dep = null; fn = null;</span>
 973             return d.postFire(a, mode);
 974         }
 975     }
 976 
 977     final boolean uniExceptionally(Object r,
 978                                    Function&lt;? super Throwable, ? extends T&gt; f,
 979                                    UniExceptionally&lt;T&gt; c) {
 980         Throwable x;
 981         if (result == null) {
 982             try {
 983                 if (c != null &amp;&amp; !c.claim())
 984                     return false;
 985                 if (r instanceof AltResult &amp;&amp; (x = ((AltResult)r).ex) != null)
 986                     completeValue(f.apply(x));
 987                 else
 988                     internalComplete(r);
 989             } catch (Throwable ex) {
 990                 completeThrowable(ex);
 991             }
 992         }
</pre>
<hr />
<pre>
1007                 e.execute(new UniExceptionally&lt;T&gt;(null, d, this, f));
1008             } catch (Throwable ex) {
1009                 d.result = encodeThrowable(ex);
1010             }
1011         }
1012         return d;
1013     }
1014 
1015     @SuppressWarnings(&quot;serial&quot;)
1016     static final class UniComposeExceptionally&lt;T&gt; extends UniCompletion&lt;T,T&gt; {
1017         Function&lt;Throwable, ? extends CompletionStage&lt;T&gt;&gt; fn;
1018         UniComposeExceptionally(Executor executor, CompletableFuture&lt;T&gt; dep,
1019                                 CompletableFuture&lt;T&gt; src,
1020                                 Function&lt;Throwable, ? extends CompletionStage&lt;T&gt;&gt; fn) {
1021             super(executor, dep, src); this.fn = fn;
1022         }
1023         final CompletableFuture&lt;T&gt; tryFire(int mode) {
1024             CompletableFuture&lt;T&gt; d; CompletableFuture&lt;T&gt; a;
1025             Function&lt;Throwable, ? extends CompletionStage&lt;T&gt;&gt; f;
1026             Object r; Throwable x;
<span class="line-modified">1027             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified">1028                 || (d = dep) == null || (f = fn) == null)</span>
1029                 return null;
1030             if (d.result == null) {
1031                 if ((r instanceof AltResult) &amp;&amp;
1032                     (x = ((AltResult)r).ex) != null) {
1033                     try {
1034                         if (mode &lt;= 0 &amp;&amp; !claim())
1035                             return null;
1036                         CompletableFuture&lt;T&gt; g = f.apply(x).toCompletableFuture();
1037                         if ((r = g.result) != null)
1038                             d.completeRelay(r);
1039                         else {
1040                             g.unipush(new UniRelay&lt;T,T&gt;(d, g));
1041                             if (d.result == null)
1042                                 return null;
1043                         }
1044                     } catch (Throwable ex) {
1045                         d.completeThrowable(ex);
1046                     }
1047                 }
1048                 else
1049                     d.internalComplete(r);
1050             }
<span class="line-modified">1051             src = null; dep = null; fn = null;</span>
1052             return d.postFire(a, mode);
1053         }
1054     }
1055 
1056     private CompletableFuture&lt;T&gt; uniComposeExceptionallyStage(
1057         Executor e, Function&lt;Throwable, ? extends CompletionStage&lt;T&gt;&gt; f) {
1058         if (f == null) throw new NullPointerException();
1059         CompletableFuture&lt;T&gt; d = newIncompleteFuture();
1060         Object r, s; Throwable x;
1061         if ((r = result) == null)
1062             unipush(new UniComposeExceptionally&lt;T&gt;(e, d, this, f));
1063         else if (!(r instanceof AltResult) || (x = ((AltResult)r).ex) == null)
1064             d.internalComplete(r);
1065         else
1066             try {
1067                 if (e != null)
1068                     e.execute(new UniComposeExceptionally&lt;T&gt;(null, d, this, f));
1069                 else {
1070                     CompletableFuture&lt;T&gt; g = f.apply(x).toCompletableFuture();
1071                     if ((s = g.result) != null)
1072                         d.result = encodeRelay(s);
1073                     else
1074                         g.unipush(new UniRelay&lt;T,T&gt;(d, g));
1075                 }
1076             } catch (Throwable ex) {
1077                 d.result = encodeThrowable(ex);
1078             }
1079         return d;
1080     }
1081 
1082     @SuppressWarnings(&quot;serial&quot;)
1083     static final class UniRelay&lt;U, T extends U&gt; extends UniCompletion&lt;T,U&gt; {
1084         UniRelay(CompletableFuture&lt;U&gt; dep, CompletableFuture&lt;T&gt; src) {
1085             super(null, dep, src);
1086         }
1087         final CompletableFuture&lt;U&gt; tryFire(int mode) {
1088             CompletableFuture&lt;U&gt; d; CompletableFuture&lt;T&gt; a; Object r;
<span class="line-modified">1089             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified">1090                 || (d = dep) == null)</span>
1091                 return null;
1092             if (d.result == null)
1093                 d.completeRelay(r);
1094             src = null; dep = null;
1095             return d.postFire(a, mode);
1096         }
1097     }
1098 
1099     private static &lt;U, T extends U&gt; CompletableFuture&lt;U&gt; uniCopyStage(
1100         CompletableFuture&lt;T&gt; src) {
1101         Object r;
1102         CompletableFuture&lt;U&gt; d = src.newIncompleteFuture();
1103         if ((r = src.result) != null)
1104             d.result = encodeRelay(r);
1105         else
1106             src.unipush(new UniRelay&lt;U,T&gt;(d, src));
1107         return d;
1108     }
1109 
1110     private MinimalStage&lt;T&gt; uniAsMinimalStage() {
1111         Object r;
1112         if ((r = result) != null)
1113             return new MinimalStage&lt;T&gt;(encodeRelay(r));
1114         MinimalStage&lt;T&gt; d = new MinimalStage&lt;T&gt;();
1115         unipush(new UniRelay&lt;T,T&gt;(d, this));
1116         return d;
1117     }
1118 
1119     @SuppressWarnings(&quot;serial&quot;)
1120     static final class UniCompose&lt;T,V&gt; extends UniCompletion&lt;T,V&gt; {
1121         Function&lt;? super T, ? extends CompletionStage&lt;V&gt;&gt; fn;
1122         UniCompose(Executor executor, CompletableFuture&lt;V&gt; dep,
1123                    CompletableFuture&lt;T&gt; src,
1124                    Function&lt;? super T, ? extends CompletionStage&lt;V&gt;&gt; fn) {
1125             super(executor, dep, src); this.fn = fn;
1126         }
1127         final CompletableFuture&lt;V&gt; tryFire(int mode) {
1128             CompletableFuture&lt;V&gt; d; CompletableFuture&lt;T&gt; a;
1129             Function&lt;? super T, ? extends CompletionStage&lt;V&gt;&gt; f;
1130             Object r; Throwable x;
<span class="line-modified">1131             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified">1132                 || (d = dep) == null || (f = fn) == null)</span>
1133                 return null;
1134             tryComplete: if (d.result == null) {
1135                 if (r instanceof AltResult) {
1136                     if ((x = ((AltResult)r).ex) != null) {
1137                         d.completeThrowable(x, r);
1138                         break tryComplete;
1139                     }
1140                     r = null;
1141                 }
1142                 try {
1143                     if (mode &lt;= 0 &amp;&amp; !claim())
1144                         return null;
1145                     @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
1146                     CompletableFuture&lt;V&gt; g = f.apply(t).toCompletableFuture();
1147                     if ((r = g.result) != null)
1148                         d.completeRelay(r);
1149                     else {
1150                         g.unipush(new UniRelay&lt;V,V&gt;(d, g));
1151                         if (d.result == null)
1152                             return null;
1153                     }
1154                 } catch (Throwable ex) {
1155                     d.completeThrowable(ex);
1156                 }
1157             }
<span class="line-modified">1158             src = null; dep = null; fn = null;</span>
1159             return d.postFire(a, mode);
1160         }
1161     }
1162 
1163     private &lt;V&gt; CompletableFuture&lt;V&gt; uniComposeStage(
1164         Executor e, Function&lt;? super T, ? extends CompletionStage&lt;V&gt;&gt; f) {
1165         if (f == null) throw new NullPointerException();
1166         CompletableFuture&lt;V&gt; d = newIncompleteFuture();
1167         Object r, s; Throwable x;
1168         if ((r = result) == null)
1169             unipush(new UniCompose&lt;T,V&gt;(e, d, this, f));
1170         else {
1171             if (r instanceof AltResult) {
1172                 if ((x = ((AltResult)r).ex) != null) {
1173                     d.result = encodeThrowable(x, r);
1174                     return d;
1175                 }
1176                 r = null;
1177             }
1178             try {
</pre>
<hr />
<pre>
1253                 b.cleanStack();
1254             if (mode &gt;= 0 &amp;&amp; (r != null || b.result != null))
1255                 b.postComplete();
1256         }
1257         return postFire(a, mode);
1258     }
1259 
1260     @SuppressWarnings(&quot;serial&quot;)
1261     static final class BiApply&lt;T,U,V&gt; extends BiCompletion&lt;T,U,V&gt; {
1262         BiFunction&lt;? super T,? super U,? extends V&gt; fn;
1263         BiApply(Executor executor, CompletableFuture&lt;V&gt; dep,
1264                 CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1265                 BiFunction&lt;? super T,? super U,? extends V&gt; fn) {
1266             super(executor, dep, src, snd); this.fn = fn;
1267         }
1268         final CompletableFuture&lt;V&gt; tryFire(int mode) {
1269             CompletableFuture&lt;V&gt; d;
1270             CompletableFuture&lt;T&gt; a;
1271             CompletableFuture&lt;U&gt; b;
1272             Object r, s; BiFunction&lt;? super T,? super U,? extends V&gt; f;
<span class="line-modified">1273             if (   (a = src) == null || (r = a.result) == null</span>

1274                 || (b = snd) == null || (s = b.result) == null
<span class="line-added">1275                 || (d = dep) == null || (f = fn) == null</span>
1276                 || !d.biApply(r, s, f, mode &gt; 0 ? null : this))
1277                 return null;
<span class="line-modified">1278             src = null; snd = null; dep = null; fn = null;</span>
1279             return d.postFire(a, b, mode);
1280         }
1281     }
1282 
1283     final &lt;R,S&gt; boolean biApply(Object r, Object s,
1284                                 BiFunction&lt;? super R,? super S,? extends T&gt; f,
1285                                 BiApply&lt;R,S,T&gt; c) {
1286         Throwable x;
1287         tryComplete: if (result == null) {
1288             if (r instanceof AltResult) {
1289                 if ((x = ((AltResult)r).ex) != null) {
1290                     completeThrowable(x, r);
1291                     break tryComplete;
1292                 }
1293                 r = null;
1294             }
1295             if (s instanceof AltResult) {
1296                 if ((x = ((AltResult)s).ex) != null) {
1297                     completeThrowable(x, s);
1298                     break tryComplete;
</pre>
<hr />
<pre>
1328                 e.execute(new BiApply&lt;T,U,V&gt;(null, d, this, b, f));
1329             } catch (Throwable ex) {
1330                 d.result = encodeThrowable(ex);
1331             }
1332         return d;
1333     }
1334 
1335     @SuppressWarnings(&quot;serial&quot;)
1336     static final class BiAccept&lt;T,U&gt; extends BiCompletion&lt;T,U,Void&gt; {
1337         BiConsumer&lt;? super T,? super U&gt; fn;
1338         BiAccept(Executor executor, CompletableFuture&lt;Void&gt; dep,
1339                  CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1340                  BiConsumer&lt;? super T,? super U&gt; fn) {
1341             super(executor, dep, src, snd); this.fn = fn;
1342         }
1343         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
1344             CompletableFuture&lt;Void&gt; d;
1345             CompletableFuture&lt;T&gt; a;
1346             CompletableFuture&lt;U&gt; b;
1347             Object r, s; BiConsumer&lt;? super T,? super U&gt; f;
<span class="line-modified">1348             if (   (a = src) == null || (r = a.result) == null</span>

1349                 || (b = snd) == null || (s = b.result) == null
<span class="line-added">1350                 || (d = dep) == null || (f = fn) == null</span>
1351                 || !d.biAccept(r, s, f, mode &gt; 0 ? null : this))
1352                 return null;
<span class="line-modified">1353             src = null; snd = null; dep = null; fn = null;</span>
1354             return d.postFire(a, b, mode);
1355         }
1356     }
1357 
1358     final &lt;R,S&gt; boolean biAccept(Object r, Object s,
1359                                  BiConsumer&lt;? super R,? super S&gt; f,
1360                                  BiAccept&lt;R,S&gt; c) {
1361         Throwable x;
1362         tryComplete: if (result == null) {
1363             if (r instanceof AltResult) {
1364                 if ((x = ((AltResult)r).ex) != null) {
1365                     completeThrowable(x, r);
1366                     break tryComplete;
1367                 }
1368                 r = null;
1369             }
1370             if (s instanceof AltResult) {
1371                 if ((x = ((AltResult)s).ex) != null) {
1372                     completeThrowable(x, s);
1373                     break tryComplete;
</pre>
<hr />
<pre>
1404                 e.execute(new BiAccept&lt;T,U&gt;(null, d, this, b, f));
1405             } catch (Throwable ex) {
1406                 d.result = encodeThrowable(ex);
1407             }
1408         return d;
1409     }
1410 
1411     @SuppressWarnings(&quot;serial&quot;)
1412     static final class BiRun&lt;T,U&gt; extends BiCompletion&lt;T,U,Void&gt; {
1413         Runnable fn;
1414         BiRun(Executor executor, CompletableFuture&lt;Void&gt; dep,
1415               CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1416               Runnable fn) {
1417             super(executor, dep, src, snd); this.fn = fn;
1418         }
1419         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
1420             CompletableFuture&lt;Void&gt; d;
1421             CompletableFuture&lt;T&gt; a;
1422             CompletableFuture&lt;U&gt; b;
1423             Object r, s; Runnable f;
<span class="line-modified">1424             if (   (a = src) == null || (r = a.result) == null</span>

1425                 || (b = snd) == null || (s = b.result) == null
<span class="line-added">1426                 || (d = dep) == null || (f = fn) == null</span>
1427                 || !d.biRun(r, s, f, mode &gt; 0 ? null : this))
1428                 return null;
<span class="line-modified">1429             src = null; snd = null; dep = null; fn = null;</span>
1430             return d.postFire(a, b, mode);
1431         }
1432     }
1433 
1434     final boolean biRun(Object r, Object s, Runnable f, BiRun&lt;?,?&gt; c) {
1435         Throwable x; Object z;
1436         if (result == null) {
1437             if ((r instanceof AltResult
1438                  &amp;&amp; (x = ((AltResult)(z = r)).ex) != null) ||
1439                 (s instanceof AltResult
1440                  &amp;&amp; (x = ((AltResult)(z = s)).ex) != null))
1441                 completeThrowable(x, z);
1442             else
1443                 try {
1444                     if (c != null &amp;&amp; !c.claim())
1445                         return false;
1446                     f.run();
1447                     completeNull();
1448                 } catch (Throwable ex) {
1449                     completeThrowable(ex);
</pre>
<hr />
<pre>
1465         else
1466             try {
1467                 e.execute(new BiRun&lt;&gt;(null, d, this, b, f));
1468             } catch (Throwable ex) {
1469                 d.result = encodeThrowable(ex);
1470             }
1471         return d;
1472     }
1473 
1474     @SuppressWarnings(&quot;serial&quot;)
1475     static final class BiRelay&lt;T,U&gt; extends BiCompletion&lt;T,U,Void&gt; { // for And
1476         BiRelay(CompletableFuture&lt;Void&gt; dep,
1477                 CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd) {
1478             super(null, dep, src, snd);
1479         }
1480         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
1481             CompletableFuture&lt;Void&gt; d;
1482             CompletableFuture&lt;T&gt; a;
1483             CompletableFuture&lt;U&gt; b;
1484             Object r, s, z; Throwable x;
<span class="line-modified">1485             if (   (a = src) == null || (r = a.result) == null</span>
<span class="line-modified">1486                 || (b = snd) == null || (s = b.result) == null</span>
<span class="line-modified">1487                 || (d = dep) == null)</span>
1488                 return null;
1489             if (d.result == null) {
1490                 if ((r instanceof AltResult
1491                      &amp;&amp; (x = ((AltResult)(z = r)).ex) != null) ||
1492                     (s instanceof AltResult
1493                      &amp;&amp; (x = ((AltResult)(z = s)).ex) != null))
1494                     d.completeThrowable(x, z);
1495                 else
1496                     d.completeNull();
1497             }
1498             src = null; snd = null; dep = null;
1499             return d.postFire(a, b, mode);
1500         }
1501     }
1502 
1503     /** Recursively constructs a tree of completions. */
1504     static CompletableFuture&lt;Void&gt; andTree(CompletableFuture&lt;?&gt;[] cfs,
1505                                            int lo, int hi) {
1506         CompletableFuture&lt;Void&gt; d = new CompletableFuture&lt;Void&gt;();
1507         if (lo &gt; hi) // empty
</pre>
<hr />
<pre>
1540                     NEXT.set(c, null);
1541                     break;
1542                 }
1543             }
1544             if (result != null)
1545                 c.tryFire(SYNC);
1546             else
1547                 b.unipush(new CoCompletion(c));
1548         }
1549     }
1550 
1551     @SuppressWarnings(&quot;serial&quot;)
1552     static final class OrApply&lt;T,U extends T,V&gt; extends BiCompletion&lt;T,U,V&gt; {
1553         Function&lt;? super T,? extends V&gt; fn;
1554         OrApply(Executor executor, CompletableFuture&lt;V&gt; dep,
1555                 CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1556                 Function&lt;? super T,? extends V&gt; fn) {
1557             super(executor, dep, src, snd); this.fn = fn;
1558         }
1559         final CompletableFuture&lt;V&gt; tryFire(int mode) {
<span class="line-modified">1560             CompletableFuture&lt;V&gt; d; CompletableFuture&lt;? extends T&gt; a, b;</span>


1561             Object r; Throwable x; Function&lt;? super T,? extends V&gt; f;
<span class="line-modified">1562             if ((a = src) == null || (b = snd) == null</span>
<span class="line-modified">1563                 || ((r = a.result) == null &amp;&amp; (r = b.result) == null)</span>
<span class="line-modified">1564                 || (d = dep) == null || (f = fn) == null)</span>
1565                 return null;
1566             tryComplete: if (d.result == null) {
1567                 try {
1568                     if (mode &lt;= 0 &amp;&amp; !claim())
1569                         return null;
1570                     if (r instanceof AltResult) {
1571                         if ((x = ((AltResult)r).ex) != null) {
1572                             d.completeThrowable(x, r);
1573                             break tryComplete;
1574                         }
1575                         r = null;
1576                     }
1577                     @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
1578                     d.completeValue(f.apply(t));
1579                 } catch (Throwable ex) {
1580                     d.completeThrowable(ex);
1581                 }
1582             }
<span class="line-modified">1583             src = null; snd = null; dep = null; fn = null;</span>
1584             return d.postFire(a, b, mode);
1585         }
1586     }
1587 
1588     private &lt;U extends T,V&gt; CompletableFuture&lt;V&gt; orApplyStage(
1589         Executor e, CompletionStage&lt;U&gt; o, Function&lt;? super T, ? extends V&gt; f) {
1590         CompletableFuture&lt;U&gt; b;
1591         if (f == null || (b = o.toCompletableFuture()) == null)
1592             throw new NullPointerException();
1593 
1594         Object r; CompletableFuture&lt;? extends T&gt; z;
1595         if ((r = (z = this).result) != null ||
1596             (r = (z = b).result) != null)
1597             return z.uniApplyNow(r, e, f);
1598 
1599         CompletableFuture&lt;V&gt; d = newIncompleteFuture();
1600         orpush(b, new OrApply&lt;T,U,V&gt;(e, d, this, b, f));
1601         return d;
1602     }
1603 
1604     @SuppressWarnings(&quot;serial&quot;)
1605     static final class OrAccept&lt;T,U extends T&gt; extends BiCompletion&lt;T,U,Void&gt; {
1606         Consumer&lt;? super T&gt; fn;
1607         OrAccept(Executor executor, CompletableFuture&lt;Void&gt; dep,
1608                  CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1609                  Consumer&lt;? super T&gt; fn) {
1610             super(executor, dep, src, snd); this.fn = fn;
1611         }
1612         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
<span class="line-modified">1613             CompletableFuture&lt;Void&gt; d; CompletableFuture&lt;? extends T&gt; a, b;</span>


1614             Object r; Throwable x; Consumer&lt;? super T&gt; f;
<span class="line-modified">1615             if ((a = src) == null || (b = snd) == null</span>
<span class="line-modified">1616                 || ((r = a.result) == null &amp;&amp; (r = b.result) == null)</span>
<span class="line-modified">1617                 || (d = dep) == null || (f = fn) == null)</span>
1618                 return null;
1619             tryComplete: if (d.result == null) {
1620                 try {
1621                     if (mode &lt;= 0 &amp;&amp; !claim())
1622                         return null;
1623                     if (r instanceof AltResult) {
1624                         if ((x = ((AltResult)r).ex) != null) {
1625                             d.completeThrowable(x, r);
1626                             break tryComplete;
1627                         }
1628                         r = null;
1629                     }
1630                     @SuppressWarnings(&quot;unchecked&quot;) T t = (T) r;
1631                     f.accept(t);
1632                     d.completeNull();
1633                 } catch (Throwable ex) {
1634                     d.completeThrowable(ex);
1635                 }
1636             }
<span class="line-modified">1637             src = null; snd = null; dep = null; fn = null;</span>
1638             return d.postFire(a, b, mode);
1639         }
1640     }
1641 
1642     private &lt;U extends T&gt; CompletableFuture&lt;Void&gt; orAcceptStage(
1643         Executor e, CompletionStage&lt;U&gt; o, Consumer&lt;? super T&gt; f) {
1644         CompletableFuture&lt;U&gt; b;
1645         if (f == null || (b = o.toCompletableFuture()) == null)
1646             throw new NullPointerException();
1647 
1648         Object r; CompletableFuture&lt;? extends T&gt; z;
1649         if ((r = (z = this).result) != null ||
1650             (r = (z = b).result) != null)
1651             return z.uniAcceptNow(r, e, f);
1652 
1653         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
1654         orpush(b, new OrAccept&lt;T,U&gt;(e, d, this, b, f));
1655         return d;
1656     }
1657 
1658     @SuppressWarnings(&quot;serial&quot;)
1659     static final class OrRun&lt;T,U&gt; extends BiCompletion&lt;T,U,Void&gt; {
1660         Runnable fn;
1661         OrRun(Executor executor, CompletableFuture&lt;Void&gt; dep,
1662               CompletableFuture&lt;T&gt; src, CompletableFuture&lt;U&gt; snd,
1663               Runnable fn) {
1664             super(executor, dep, src, snd); this.fn = fn;
1665         }
1666         final CompletableFuture&lt;Void&gt; tryFire(int mode) {
<span class="line-modified">1667             CompletableFuture&lt;Void&gt; d; CompletableFuture&lt;?&gt; a, b;</span>


1668             Object r; Throwable x; Runnable f;
<span class="line-modified">1669             if ((a = src) == null || (b = snd) == null</span>
<span class="line-modified">1670                 || ((r = a.result) == null &amp;&amp; (r = b.result) == null)</span>
<span class="line-modified">1671                 || (d = dep) == null || (f = fn) == null)</span>
1672                 return null;
1673             if (d.result == null) {
1674                 try {
1675                     if (mode &lt;= 0 &amp;&amp; !claim())
1676                         return null;
1677                     else if (r instanceof AltResult
1678                         &amp;&amp; (x = ((AltResult)r).ex) != null)
1679                         d.completeThrowable(x, r);
1680                     else {
1681                         f.run();
1682                         d.completeNull();
1683                     }
1684                 } catch (Throwable ex) {
1685                     d.completeThrowable(ex);
1686                 }
1687             }
<span class="line-modified">1688             src = null; snd = null; dep = null; fn = null;</span>
1689             return d.postFire(a, b, mode);
1690         }
1691     }
1692 
1693     private CompletableFuture&lt;Void&gt; orRunStage(Executor e, CompletionStage&lt;?&gt; o,
1694                                                Runnable f) {
1695         CompletableFuture&lt;?&gt; b;
1696         if (f == null || (b = o.toCompletableFuture()) == null)
1697             throw new NullPointerException();
1698 
1699         Object r; CompletableFuture&lt;?&gt; z;
1700         if ((r = (z = this).result) != null ||
1701             (r = (z = b).result) != null)
1702             return z.uniRunNow(r, e, f);
1703 
1704         CompletableFuture&lt;Void&gt; d = newIncompleteFuture();
1705         orpush(b, new OrRun&lt;&gt;(e, d, this, b, f));
1706         return d;
1707     }
1708 
1709     /** Completion for an anyOf input future. */
1710     @SuppressWarnings(&quot;serial&quot;)
1711     static class AnyOf extends Completion {
1712         CompletableFuture&lt;Object&gt; dep; CompletableFuture&lt;?&gt; src;
1713         CompletableFuture&lt;?&gt;[] srcs;
1714         AnyOf(CompletableFuture&lt;Object&gt; dep, CompletableFuture&lt;?&gt; src,
1715               CompletableFuture&lt;?&gt;[] srcs) {
1716             this.dep = dep; this.src = src; this.srcs = srcs;
1717         }
1718         final CompletableFuture&lt;Object&gt; tryFire(int mode) {
1719             // assert mode != ASYNC;
1720             CompletableFuture&lt;Object&gt; d; CompletableFuture&lt;?&gt; a;
1721             CompletableFuture&lt;?&gt;[] as;
1722             Object r;
<span class="line-modified">1723             if ((a = src) == null || (r = a.result) == null</span>
<span class="line-modified">1724                 || (d = dep) == null || (as = srcs) == null)</span>

1725                 return null;
<span class="line-modified">1726             src = null; dep = null; srcs = null;</span>
1727             if (d.completeRelay(r)) {
1728                 for (CompletableFuture&lt;?&gt; b : as)
1729                     if (b != a)
1730                         b.cleanStack();
1731                 if (mode &lt; 0)
1732                     return d;
1733                 else
1734                     d.postComplete();
1735             }
1736             return null;
1737         }
1738         final boolean isLive() {
1739             CompletableFuture&lt;Object&gt; d;
1740             return (d = dep) != null &amp;&amp; d.result == null;
1741         }
1742     }
1743 
1744     /* ------------- Zero-input Async forms -------------- */
1745 
1746     @SuppressWarnings(&quot;serial&quot;)
</pre>
</td>
</tr>
</table>
<center><a href="ArrayBlockingQueue.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ConcurrentHashMap.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>