<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.base/share/classes/jdk/internal/util/SystemProps.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package jdk.internal.util;
 26 
 27 
 28 import java.lang.annotation.Native;
 29 import java.util.HashMap;
 30 import java.util.Map;
 31 
 32 /**
 33  * System Property initialization for internal use only
 34  * Retrieves the platform, JVM, and command line properties,
 35  * applies initial defaults and returns the Properties instance
 36  * that becomes the System.getProperties instance.
 37  */
 38 public final class SystemProps {
 39 
 40     // no instances
 41     private SystemProps() {}
 42 
 43     /**
 44      * Create and initialize the system properties from the native properties
 45      * and command line properties.
 46      * Note:  Build-defined properties such as versions and vendor information
 47      * are initialized by VersionProps.java-template.
 48      *
 49      * @return a Properties instance initialized with all of the properties
 50      */
 51     public static Map&lt;String, String&gt; initProperties() {
 52 
 53         // Initially, cmdProperties only includes -D and props from the VM
 54         Raw raw = new Raw();
 55         HashMap&lt;String, String&gt; props = raw.cmdProperties();
 56 
 57         String javaHome = props.get(&quot;java.home&quot;);
 58         assert javaHome != null : &quot;java.home not set&quot;;
 59 
 60         putIfAbsent(props, &quot;user.home&quot;, raw.propDefault(Raw._user_home_NDX));
 61         putIfAbsent(props, &quot;user.dir&quot;, raw.propDefault(Raw._user_dir_NDX));
 62         putIfAbsent(props, &quot;user.name&quot;, raw.propDefault(Raw._user_name_NDX));
 63 
 64         // Platform defined encoding cannot be overridden on the command line
 65         put(props, &quot;sun.jnu.encoding&quot;, raw.propDefault(Raw._sun_jnu_encoding_NDX));
 66 
 67         // Add properties that have not been overridden on the cmdline
 68         putIfAbsent(props, &quot;file.encoding&quot;,
 69                 ((raw.propDefault(Raw._file_encoding_NDX) == null)
 70                         ? raw.propDefault(Raw._sun_jnu_encoding_NDX)
 71                         : raw.propDefault(Raw._file_encoding_NDX)));
 72 
 73         // Use platform values if not overridden by a commandline -Dkey=value
 74         // In no particular order
 75         putIfAbsent(props, &quot;os.name&quot;, raw.propDefault(Raw._os_name_NDX));
 76         putIfAbsent(props, &quot;os.arch&quot;, raw.propDefault(Raw._os_arch_NDX));
 77         putIfAbsent(props, &quot;os.version&quot;, raw.propDefault(Raw._os_version_NDX));
 78         putIfAbsent(props, &quot;line.separator&quot;, raw.propDefault(Raw._line_separator_NDX));
 79         putIfAbsent(props, &quot;file.separator&quot;, raw.propDefault(Raw._file_separator_NDX));
 80         putIfAbsent(props, &quot;path.separator&quot;, raw.propDefault(Raw._path_separator_NDX));
 81         putIfAbsent(props, &quot;java.io.tmpdir&quot;, raw.propDefault(Raw._java_io_tmpdir_NDX));
 82         putIfAbsent(props, &quot;http.proxyHost&quot;, raw.propDefault(Raw._http_proxyHost_NDX));
 83         putIfAbsent(props, &quot;http.proxyPort&quot;, raw.propDefault(Raw._http_proxyPort_NDX));
 84         putIfAbsent(props, &quot;https.proxyHost&quot;, raw.propDefault(Raw._https_proxyHost_NDX));
 85         putIfAbsent(props, &quot;https.proxyPort&quot;, raw.propDefault(Raw._https_proxyPort_NDX));
 86         putIfAbsent(props, &quot;ftp.proxyHost&quot;, raw.propDefault(Raw._ftp_proxyHost_NDX));
 87         putIfAbsent(props, &quot;ftp.proxyPort&quot;, raw.propDefault(Raw._ftp_proxyPort_NDX));
 88         putIfAbsent(props, &quot;socksProxyHost&quot;, raw.propDefault(Raw._socksProxyHost_NDX));
 89         putIfAbsent(props, &quot;socksProxyPort&quot;, raw.propDefault(Raw._socksProxyPort_NDX));
 90         putIfAbsent(props, &quot;http.nonProxyHosts&quot;, raw.propDefault(Raw._http_nonProxyHosts_NDX));
 91         putIfAbsent(props, &quot;ftp.nonProxyHosts&quot;, raw.propDefault(Raw._ftp_nonProxyHosts_NDX));
 92         putIfAbsent(props, &quot;socksNonProxyHosts&quot;, raw.propDefault(Raw._socksNonProxyHosts_NDX));
 93         putIfAbsent(props, &quot;sun.arch.abi&quot;, raw.propDefault(Raw._sun_arch_abi_NDX));
 94         putIfAbsent(props, &quot;sun.arch.data.model&quot;, raw.propDefault(Raw._sun_arch_data_model_NDX));
 95         putIfAbsent(props, &quot;sun.os.patch.level&quot;, raw.propDefault(Raw._sun_os_patch_level_NDX));
 96         putIfAbsent(props, &quot;sun.stdout.encoding&quot;, raw.propDefault(Raw._sun_stdout_encoding_NDX));
 97         putIfAbsent(props, &quot;sun.stderr.encoding&quot;, raw.propDefault(Raw._sun_stderr_encoding_NDX));
 98         putIfAbsent(props, &quot;sun.io.unicode.encoding&quot;, raw.propDefault(Raw._sun_io_unicode_encoding_NDX));
 99         putIfAbsent(props, &quot;sun.cpu.isalist&quot;, raw.propDefault(Raw._sun_cpu_isalist_NDX));
100         putIfAbsent(props, &quot;sun.cpu.endian&quot;, raw.propDefault(Raw._sun_cpu_endian_NDX));
101 
102         /* Construct i18n related options */
103         fillI18nProps(props,&quot;user.language&quot;, raw.propDefault(Raw._display_language_NDX),
104                 raw.propDefault(Raw._format_language_NDX));
105         fillI18nProps(props,&quot;user.script&quot;,   raw.propDefault(Raw._display_script_NDX),
106                 raw.propDefault(Raw._format_script_NDX));
107         fillI18nProps(props,&quot;user.country&quot;,  raw.propDefault(Raw._display_country_NDX),
108                 raw.propDefault(Raw._format_country_NDX));
109         fillI18nProps(props,&quot;user.variant&quot;,  raw.propDefault(Raw._display_variant_NDX),
110                 raw.propDefault(Raw._format_variant_NDX));
111 
112         return props;
113     }
114 
115     /**
116      * Puts the property if it is non-null
117      * @param props the Properties
118      * @param key the key
119      * @param value the value
120      */
121     private static void put(HashMap&lt;String, String&gt; props, String key, String value) {
122         if (value != null) {
123             props.put(key, value);
124         }
125     }
126 
127     /**
128      * Puts the property if it is non-null and is not already in the Properties.
129      * @param props the Properties
130      * @param key the key
131      * @param value the value
132      */
133     private static void putIfAbsent(HashMap&lt;String, String&gt; props, String key, String value) {
134         if (value != null) {
135             props.putIfAbsent(key, value);
136         }
137     }
138 
139     /**
140      * For internationalization options, compute the values for
141      * display and format properties
142      * MUST NOT override command line defined values.
143      *
144      * @param base the base property name
145      * @param display the display value for the base
146      * @param format the format value for the base
147      */
148     private static void fillI18nProps(HashMap&lt;String, String&gt; cmdProps,
149                                       String base,
150                                       String display,
151                                       String format) {
152         // Do not override command line setting
153         String baseValue = cmdProps.get(base);
154         if (baseValue != null) {
155             return;     // Do not override value from the command line
156         }
157 
158         // Not overridden on the command line; define the properties if there are platform defined values
159         if (display != null) {
160             cmdProps.put(base, display);
161             baseValue = display;
162         }
163 
164         /* user.xxx.display property */
165         String disp = base.concat(&quot;.display&quot;);
166         String dispValue = cmdProps.get(disp);
167         if (dispValue == null &amp;&amp; display != null &amp;&amp; !display.equals(baseValue)) {
168             // Create the property only if different from the base property
169             cmdProps.put(disp, display);
170         }
171 
172         /* user.xxx.format property */
173         String fmt = base.concat(&quot;.format&quot;);
174         String fmtValue = cmdProps.get(fmt);
175         if (fmtValue == null &amp;&amp; format != null &amp;&amp; !format.equals(baseValue)) {
176             // Create the property only if different than the base property
177             cmdProps.put(fmt, format);
178         }
179     }
180 
181     /**
182      * Read the raw properties from native System.c.
183      */
184     public static class Raw {
185         // Array indices written by native vmProperties()
186         // The order is arbitrary (but alphabetic for convenience)
187         @Native private static final int _display_country_NDX = 0;
188         @Native private static final int _display_language_NDX = 1 + _display_country_NDX;
189         @Native private static final int _display_script_NDX = 1 + _display_language_NDX;
190         @Native private static final int _display_variant_NDX = 1 + _display_script_NDX;
191         @Native private static final int _file_encoding_NDX = 1 + _display_variant_NDX;
192         @Native private static final int _file_separator_NDX = 1 + _file_encoding_NDX;
193         @Native private static final int _format_country_NDX = 1 + _file_separator_NDX;
194         @Native private static final int _format_language_NDX = 1 + _format_country_NDX;
195         @Native private static final int _format_script_NDX = 1 + _format_language_NDX;
196         @Native private static final int _format_variant_NDX = 1 + _format_script_NDX;
197         @Native private static final int _ftp_nonProxyHosts_NDX = 1 + _format_variant_NDX;
198         @Native private static final int _ftp_proxyHost_NDX = 1 + _ftp_nonProxyHosts_NDX;
199         @Native private static final int _ftp_proxyPort_NDX = 1 + _ftp_proxyHost_NDX;
200         @Native private static final int _http_nonProxyHosts_NDX = 1 + _ftp_proxyPort_NDX;
201         @Native private static final int _http_proxyHost_NDX = 1 + _http_nonProxyHosts_NDX;
202         @Native private static final int _http_proxyPort_NDX = 1 + _http_proxyHost_NDX;
203         @Native private static final int _https_proxyHost_NDX = 1 + _http_proxyPort_NDX;
204         @Native private static final int _https_proxyPort_NDX = 1 + _https_proxyHost_NDX;
205         @Native private static final int _java_io_tmpdir_NDX = 1 + _https_proxyPort_NDX;
206         @Native private static final int _line_separator_NDX = 1 + _java_io_tmpdir_NDX;
207         @Native private static final int _os_arch_NDX = 1 + _line_separator_NDX;
208         @Native private static final int _os_name_NDX = 1 + _os_arch_NDX;
209         @Native private static final int _os_version_NDX = 1 + _os_name_NDX;
210         @Native private static final int _path_separator_NDX = 1 + _os_version_NDX;
211         @Native private static final int _socksNonProxyHosts_NDX = 1 + _path_separator_NDX;
212         @Native private static final int _socksProxyHost_NDX = 1 + _socksNonProxyHosts_NDX;
213         @Native private static final int _socksProxyPort_NDX = 1 + _socksProxyHost_NDX;
214         @Native private static final int _sun_arch_abi_NDX = 1 + _socksProxyPort_NDX;
215         @Native private static final int _sun_arch_data_model_NDX = 1 + _sun_arch_abi_NDX;
216         @Native private static final int _sun_cpu_endian_NDX = 1 + _sun_arch_data_model_NDX;
217         @Native private static final int _sun_cpu_isalist_NDX = 1 + _sun_cpu_endian_NDX;
218         @Native private static final int _sun_io_unicode_encoding_NDX = 1 + _sun_cpu_isalist_NDX;
219         @Native private static final int _sun_jnu_encoding_NDX = 1 + _sun_io_unicode_encoding_NDX;
220         @Native private static final int _sun_os_patch_level_NDX = 1 + _sun_jnu_encoding_NDX;
221         @Native private static final int _sun_stderr_encoding_NDX = 1 + _sun_os_patch_level_NDX;
222         @Native private static final int _sun_stdout_encoding_NDX = 1 + _sun_stderr_encoding_NDX;
223         @Native private static final int _user_dir_NDX = 1 + _sun_stdout_encoding_NDX;
224         @Native private static final int _user_home_NDX = 1 + _user_dir_NDX;
225         @Native private static final int _user_name_NDX = 1 + _user_home_NDX;
226         @Native private static final int FIXED_LENGTH = 1 + _user_name_NDX;
227 
228         // Array of Strings returned from the VM and Command line properties
229         // The array is not used after initialization is complete.
230         private final String[] platformProps;
231 
232         private Raw() {
233             platformProps = platformProperties();
234         }
235 
236         /**
237          * Return the value for a well known default from native.
238          * @param index the index of the known property
239          * @return the value
240          */
241         String propDefault(int index) {
242             return platformProps[index];
243         }
244 
245         /**
246          * Return a Properties instance of the command line and VM options
247          * defined by name and value.
248          * The Properties instance is sized to include the fixed properties.
249          *
250          * @return return a Properties instance of the command line and VM options
251          */
252         private HashMap&lt;String, String&gt; cmdProperties() {
253             String[] vmProps = vmProperties();
254             // While optimal initialCapacity here would be the exact number of properties
255             // divided by LOAD_FACTOR, a large portion of the properties in Raw are
256             // usually not set, so for typical cases the chosen capacity avoids resizing
257             var cmdProps = new HashMap&lt;String, String&gt;((vmProps.length / 2) + Raw.FIXED_LENGTH);
258             for (int i = 0; i &lt; vmProps.length;) {
259                 String k = vmProps[i++];
260                 if (k != null) {
261                     String v = vmProps[i++];
262                     cmdProps.put(k, v != null ? v : &quot;&quot;);
263                 } else {
264                     // no more key/value pairs
265                     break;
266                 }
267             }
268             return cmdProps;
269         }
270 
271         /**
272          * Returns the available VM and Command Line Properties.
273          * The VM supplies some key/value pairs and processes the command line
274          * to extract key/value pairs from the {@code &quot;-Dkey=value&quot;} arguments.
275          *
276          * @return an array of strings, with alternating key and value strings.
277          *      Either keys or values may be null, the array may not be full.
278          *      The first null key indicates there are no more key, value pairs.
279          */
280         private static native String[] vmProperties();
281 
282         /**
283          * Returns the platform specific property values identified
284          * by {@code &quot;_xxx_NDX&quot;} indexes.
285          * The indexes are strictly private, to be shared only with the native code.
286          *
287          * @return a array of strings, the properties are indexed by the {@code _xxx_NDX}
288          * indexes.  The values are Strings and may be null.
289          */
290         private static native String[] platformProperties();
291     }
292 }
    </pre>
  </body>
</html>