<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/jdk/internal/module/ModuleLoaderMap.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ModuleInfoWriter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ModulePath.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/jdk/internal/module/ModuleLoaderMap.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -26,87 +26,114 @@</span>
  package jdk.internal.module;
  
  import java.lang.module.Configuration;
  import java.lang.module.ResolvedModule;
  import java.util.HashMap;
<span class="udiff-line-removed">- import java.util.HashSet;</span>
  import java.util.Map;
  import java.util.Set;
  import java.util.function.Function;
  
  import jdk.internal.loader.ClassLoaders;
  
<span class="udiff-line-removed">- </span>
  /**
   * Supports the mapping of modules to class loaders. The set of modules mapped
   * to the boot and platform class loaders is generated at build time from
   * this source file.
   */
  public final class ModuleLoaderMap {
  
      /**
       * Maps the system modules to the built-in class loaders.
       */
<span class="udiff-line-modified-removed">-     public static final class Mapper implements Function&lt;String, ClassLoader&gt; {</span>
<span class="udiff-line-modified-removed">-         private final Map&lt;String, ClassLoader&gt; map;</span>
<span class="udiff-line-modified-added">+     private static final class Mapper implements Function&lt;String, ClassLoader&gt; {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         private static final ClassLoader PLATFORM_CLASSLOADER =</span>
<span class="udiff-line-added">+                 ClassLoaders.platformClassLoader();</span>
<span class="udiff-line-added">+         private static final ClassLoader APP_CLASSLOADER =</span>
<span class="udiff-line-added">+                 ClassLoaders.appClassLoader();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private static final Integer PLATFORM_LOADER_INDEX = 1;</span>
<span class="udiff-line-added">+         private static final Integer APP_LOADER_INDEX      = 2;</span>
  
<span class="udiff-line-modified-removed">-         Mapper(Map&lt;String, ClassLoader&gt; map) {</span>
<span class="udiff-line-modified-removed">-             this.map = map; // defensive copy not needed</span>
<span class="udiff-line-modified-added">+         /**</span>
<span class="udiff-line-modified-added">+          * Map from module to a class loader index. The index is resolved to the</span>
<span class="udiff-line-added">+          * actual class loader in {@code apply}.</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         private final Map&lt;String, Integer&gt; map;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         /**</span>
<span class="udiff-line-added">+          * Creates a Mapper to map module names in the given Configuration to</span>
<span class="udiff-line-added">+          * built-in classloaders.</span>
<span class="udiff-line-added">+          *</span>
<span class="udiff-line-added">+          * As a proxy for the actual classloader, we store an easily archiveable</span>
<span class="udiff-line-added">+          * index value in the internal map. The index is stored as a boxed value</span>
<span class="udiff-line-added">+          * so that we can cheaply do identity comparisons during bootstrap.</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         Mapper(Configuration cf) {</span>
<span class="udiff-line-added">+             var map = new HashMap&lt;String, Integer&gt;();</span>
<span class="udiff-line-added">+             for (ResolvedModule resolvedModule : cf.modules()) {</span>
<span class="udiff-line-added">+                 String mn = resolvedModule.name();</span>
<span class="udiff-line-added">+                 if (!Modules.bootModules.contains(mn)) {</span>
<span class="udiff-line-added">+                     if (Modules.platformModules.contains(mn)) {</span>
<span class="udiff-line-added">+                         map.put(mn, PLATFORM_LOADER_INDEX);</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         map.put(mn, APP_LOADER_INDEX);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             this.map = map;</span>
          }
  
          @Override
          public ClassLoader apply(String name) {
<span class="udiff-line-modified-removed">-             return map.get(name);</span>
<span class="udiff-line-modified-added">+             Integer loader = map.get(name);</span>
<span class="udiff-line-added">+             if (loader == APP_LOADER_INDEX) {</span>
<span class="udiff-line-added">+                 return APP_CLASSLOADER;</span>
<span class="udiff-line-added">+             } else if (loader == PLATFORM_LOADER_INDEX) {</span>
<span class="udiff-line-added">+                 return PLATFORM_CLASSLOADER;</span>
<span class="udiff-line-added">+             } else { // BOOT_LOADER_INDEX</span>
<span class="udiff-line-added">+                 return null;</span>
<span class="udiff-line-added">+             }</span>
          }
      }
  
      /**
       * Returns the names of the modules defined to the boot loader.
       */
      public static Set&lt;String&gt; bootModules() {
<span class="udiff-line-modified-removed">-         // The list of boot modules generated at build time.</span>
<span class="udiff-line-removed">-         String[] BOOT_MODULES = new String[] { &quot;@@BOOT_MODULE_NAMES@@&quot; };</span>
<span class="udiff-line-removed">-         Set&lt;String&gt; bootModules = new HashSet&lt;&gt;(BOOT_MODULES.length);</span>
<span class="udiff-line-removed">-         for (String mn : BOOT_MODULES) {</span>
<span class="udiff-line-removed">-             bootModules.add(mn);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return bootModules;</span>
<span class="udiff-line-modified-added">+         return Modules.bootModules;</span>
      }
  
      /**
       * Returns the names of the modules defined to the platform loader.
       */
      public static Set&lt;String&gt; platformModules() {
<span class="udiff-line-modified-removed">-         // The list of platform modules generated at build time.</span>
<span class="udiff-line-modified-removed">-         String[] PLATFORM_MODULES = new String[] { &quot;@@PLATFORM_MODULE_NAMES@@&quot; };</span>
<span class="udiff-line-modified-removed">-         Set&lt;String&gt; platformModules = new HashSet&lt;&gt;(PLATFORM_MODULES.length);</span>
<span class="udiff-line-modified-removed">-         for (String mn : PLATFORM_MODULES) {</span>
<span class="udiff-line-modified-removed">-             platformModules.add(mn);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         return platformModules;</span>
<span class="udiff-line-modified-added">+         return Modules.platformModules;</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     private static class Modules {</span>
<span class="udiff-line-modified-added">+         // list of boot modules is generated at build time.</span>
<span class="udiff-line-modified-added">+         private static final Set&lt;String&gt; bootModules =</span>
<span class="udiff-line-modified-added">+                 Set.of(new String[] { &quot;@@BOOT_MODULE_NAMES@@&quot; });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // list of platform modules is generated at build time.</span>
<span class="udiff-line-added">+         private static final Set&lt;String&gt; platformModules =</span>
<span class="udiff-line-added">+                 Set.of(new String[] { &quot;@@PLATFORM_MODULE_NAMES@@&quot; });</span>
      }
  
      /**
<span class="udiff-line-modified-removed">-      * Returns the function to map modules in the given configuration to the</span>
<span class="udiff-line-modified-added">+      * Returns a function to map modules in the given configuration to the</span>
       * built-in class loaders.
       */
      static Function&lt;String, ClassLoader&gt; mappingFunction(Configuration cf) {
<span class="udiff-line-modified-removed">-         Set&lt;String&gt; bootModules = bootModules();</span>
<span class="udiff-line-modified-removed">-         Set&lt;String&gt; platformModules = platformModules();</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         ClassLoader platformClassLoader = ClassLoaders.platformClassLoader();</span>
<span class="udiff-line-modified-removed">-         ClassLoader appClassLoader = ClassLoaders.appClassLoader();</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         Map&lt;String, ClassLoader&gt; map = new HashMap&lt;&gt;();</span>
<span class="udiff-line-modified-removed">-         for (ResolvedModule resolvedModule : cf.modules()) {</span>
<span class="udiff-line-modified-removed">-             String mn = resolvedModule.name();</span>
<span class="udiff-line-modified-removed">-             if (!bootModules.contains(mn)) {</span>
<span class="udiff-line-removed">-                 if (platformModules.contains(mn)) {</span>
<span class="udiff-line-removed">-                     map.put(mn, platformClassLoader);</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     map.put(mn, appClassLoader);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return new Mapper(map);</span>
<span class="udiff-line-modified-added">+         return new Mapper(cf);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     /**</span>
<span class="udiff-line-modified-added">+      * When defining modules for a configuration, we only allow defining modules</span>
<span class="udiff-line-modified-added">+      * to the boot or platform classloader if the ClassLoader mapping function</span>
<span class="udiff-line-modified-added">+      * originate from here.</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+     public static boolean isBuiltinMapper(Function&lt;String, ClassLoader&gt; clf) {</span>
<span class="udiff-line-modified-added">+         return clf instanceof Mapper;</span>
      }
  }
</pre>
<center><a href="ModuleInfoWriter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ModulePath.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>