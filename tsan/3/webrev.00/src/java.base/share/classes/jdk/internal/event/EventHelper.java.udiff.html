<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/jdk/internal/event/EventHelper.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../access/SharedSecrets.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../jrtfs/JrtFileSystemProvider.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/jdk/internal/event/EventHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,10 +23,15 @@</span>
   * questions.
   */
  
  package jdk.internal.event;
  
<span class="udiff-line-added">+ import jdk.internal.access.JavaUtilJarAccess;</span>
<span class="udiff-line-added">+ import jdk.internal.access.SharedSecrets;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import java.lang.invoke.MethodHandles;</span>
<span class="udiff-line-added">+ import java.lang.invoke.VarHandle;</span>
  import java.time.Duration;
  import java.time.Instant;
  import java.util.Date;
  import java.util.stream.Collectors;
  import java.util.stream.IntStream;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -35,46 +40,57 @@</span>
   * A helper class to have events logged to a JDK Event Logger.
   */
  
  public final class EventHelper {
  
<span class="udiff-line-added">+     private static final JavaUtilJarAccess JUJA = SharedSecrets.javaUtilJarAccess();</span>
<span class="udiff-line-added">+     private static volatile boolean loggingSecurity;</span>
<span class="udiff-line-added">+     private static volatile System.Logger securityLogger;</span>
<span class="udiff-line-added">+     private static final VarHandle LOGGER_HANDLE;</span>
<span class="udiff-line-added">+     static {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             LOGGER_HANDLE =</span>
<span class="udiff-line-added">+                     MethodHandles.lookup().findStaticVarHandle(</span>
<span class="udiff-line-added">+                             EventHelper.class, &quot;securityLogger&quot;, System.Logger.class);</span>
<span class="udiff-line-added">+         } catch (ReflectiveOperationException e) {</span>
<span class="udiff-line-added">+             throw new Error(e);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
      private static final System.Logger.Level LOG_LEVEL = System.Logger.Level.DEBUG;
  
      // helper class used for logging security related events for now
      private static final String SECURITY_LOGGER_NAME = &quot;jdk.event.security&quot;;
<span class="udiff-line-modified-removed">-     private static final System.Logger SECURITY_LOGGER =</span>
<span class="udiff-line-removed">-             System.getLogger(SECURITY_LOGGER_NAME);</span>
<span class="udiff-line-removed">-     private static final boolean LOGGING_SECURITY =</span>
<span class="udiff-line-removed">-             SECURITY_LOGGER.isLoggable(LOG_LEVEL);</span>
<span class="udiff-line-modified-added">+ </span>
  
      public static void logTLSHandshakeEvent(Instant start,
                                              String peerHost,
                                              int peerPort,
                                              String cipherSuite,
                                              String protocolVersion,
                                              long peerCertId) {
<span class="udiff-line-added">+         assert securityLogger != null;</span>
          String prepend = getDurationString(start);
<span class="udiff-line-modified-removed">-         SECURITY_LOGGER.log(LOG_LEVEL, prepend +</span>
<span class="udiff-line-modified-added">+         securityLogger.log(LOG_LEVEL, prepend +</span>
          &quot; TLSHandshake: {0}:{1,number,#}, {2}, {3}, {4,number,#}&quot;,
          peerHost, peerPort, protocolVersion, cipherSuite, peerCertId);
      }
  
      public static void logSecurityPropertyEvent(String key,
                                                  String value) {
  
<span class="udiff-line-modified-removed">-         if (isLoggingSecurity()) {</span>
<span class="udiff-line-modified-removed">-             SECURITY_LOGGER.log(LOG_LEVEL,</span>
<span class="udiff-line-modified-removed">-                 &quot;SecurityPropertyModification: key:{0}, value:{1}&quot;, key, value);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         assert securityLogger != null;</span>
<span class="udiff-line-modified-added">+         securityLogger.log(LOG_LEVEL,</span>
<span class="udiff-line-modified-added">+             &quot;SecurityPropertyModification: key:{0}, value:{1}&quot;, key, value);</span>
      }
  
      public static void logX509ValidationEvent(int anchorCertId,
                                           int[] certIds) {
<span class="udiff-line-added">+         assert securityLogger != null;</span>
          String codes = IntStream.of(certIds)
                  .mapToObj(Integer::toString)
                  .collect(Collectors.joining(&quot;, &quot;));
<span class="udiff-line-modified-removed">-         SECURITY_LOGGER.log(LOG_LEVEL,</span>
<span class="udiff-line-modified-added">+         securityLogger.log(LOG_LEVEL,</span>
                  &quot;ValidationChain: {0,number,#}, {1}&quot;, anchorCertId, codes);
      }
  
      public static void logX509CertificateEvent(String algId,
                                                 String serialNum,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,11 +99,12 @@</span>
                                                 String keyType,
                                                 int length,
                                                 long certId,
                                                 long beginDate,
                                                 long endDate) {
<span class="udiff-line-modified-removed">-         SECURITY_LOGGER.log(LOG_LEVEL, &quot;X509Certificate: Alg:{0}, Serial:{1}&quot; +</span>
<span class="udiff-line-modified-added">+         assert securityLogger != null;</span>
<span class="udiff-line-added">+         securityLogger.log(LOG_LEVEL, &quot;X509Certificate: Alg:{0}, Serial:{1}&quot; +</span>
              &quot;, Subject:{2}, Issuer:{3}, Key type:{4}, Length:{5,number,#}&quot; +
              &quot;, Cert Id:{6,number,#}, Valid from:{7}, Valid until:{8}&quot;,
              algId, serialNum, subject, issuer, keyType, length,
              certId, new Date(beginDate), new Date(endDate));
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -122,8 +139,16 @@</span>
       * is read once at class initialization.
       *
       * @return boolean indicating whether an event should be logged
       */
      public static boolean isLoggingSecurity() {
<span class="udiff-line-modified-removed">-         return LOGGING_SECURITY;</span>
<span class="udiff-line-modified-added">+         // Avoid a bootstrap issue where the commitEvent attempts to</span>
<span class="udiff-line-added">+         // trigger early loading of System Logger but where</span>
<span class="udiff-line-added">+         // the verification process still has JarFiles locked</span>
<span class="udiff-line-added">+         if (securityLogger == null &amp;&amp; !JUJA.isInitializing()) {</span>
<span class="udiff-line-added">+             LOGGER_HANDLE.compareAndSet( null, System.getLogger(SECURITY_LOGGER_NAME));</span>
<span class="udiff-line-added">+             loggingSecurity = securityLogger.isLoggable(LOG_LEVEL);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return loggingSecurity;</span>
      }
<span class="udiff-line-added">+ </span>
  }
</pre>
<center><a href="../access/SharedSecrets.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../jrtfs/JrtFileSystemProvider.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>