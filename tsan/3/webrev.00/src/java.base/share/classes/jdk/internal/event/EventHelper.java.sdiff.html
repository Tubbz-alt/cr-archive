<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/jdk/internal/event/EventHelper.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../access/SharedSecrets.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../jrtfs/JrtFileSystemProvider.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/jdk/internal/event/EventHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.internal.event;
 27 





 28 import java.time.Duration;
 29 import java.time.Instant;
 30 import java.util.Date;
 31 import java.util.stream.Collectors;
 32 import java.util.stream.IntStream;
 33 
 34 /**
 35  * A helper class to have events logged to a JDK Event Logger.
 36  */
 37 
 38 public final class EventHelper {
 39 













 40     private static final System.Logger.Level LOG_LEVEL = System.Logger.Level.DEBUG;
 41 
 42     // helper class used for logging security related events for now
 43     private static final String SECURITY_LOGGER_NAME = &quot;jdk.event.security&quot;;
<span class="line-modified"> 44     private static final System.Logger SECURITY_LOGGER =</span>
<span class="line-removed"> 45             System.getLogger(SECURITY_LOGGER_NAME);</span>
<span class="line-removed"> 46     private static final boolean LOGGING_SECURITY =</span>
<span class="line-removed"> 47             SECURITY_LOGGER.isLoggable(LOG_LEVEL);</span>
 48 
 49     public static void logTLSHandshakeEvent(Instant start,
 50                                             String peerHost,
 51                                             int peerPort,
 52                                             String cipherSuite,
 53                                             String protocolVersion,
 54                                             long peerCertId) {

 55         String prepend = getDurationString(start);
<span class="line-modified"> 56         SECURITY_LOGGER.log(LOG_LEVEL, prepend +</span>
 57         &quot; TLSHandshake: {0}:{1,number,#}, {2}, {3}, {4,number,#}&quot;,
 58         peerHost, peerPort, protocolVersion, cipherSuite, peerCertId);
 59     }
 60 
 61     public static void logSecurityPropertyEvent(String key,
 62                                                 String value) {
 63 
<span class="line-modified"> 64         if (isLoggingSecurity()) {</span>
<span class="line-modified"> 65             SECURITY_LOGGER.log(LOG_LEVEL,</span>
<span class="line-modified"> 66                 &quot;SecurityPropertyModification: key:{0}, value:{1}&quot;, key, value);</span>
<span class="line-removed"> 67         }</span>
 68     }
 69 
 70     public static void logX509ValidationEvent(int anchorCertId,
 71                                          int[] certIds) {

 72         String codes = IntStream.of(certIds)
 73                 .mapToObj(Integer::toString)
 74                 .collect(Collectors.joining(&quot;, &quot;));
<span class="line-modified"> 75         SECURITY_LOGGER.log(LOG_LEVEL,</span>
 76                 &quot;ValidationChain: {0,number,#}, {1}&quot;, anchorCertId, codes);
 77     }
 78 
 79     public static void logX509CertificateEvent(String algId,
 80                                                String serialNum,
 81                                                String subject,
 82                                                String issuer,
 83                                                String keyType,
 84                                                int length,
 85                                                long certId,
 86                                                long beginDate,
 87                                                long endDate) {
<span class="line-modified"> 88         SECURITY_LOGGER.log(LOG_LEVEL, &quot;X509Certificate: Alg:{0}, Serial:{1}&quot; +</span>

 89             &quot;, Subject:{2}, Issuer:{3}, Key type:{4}, Length:{5,number,#}&quot; +
 90             &quot;, Cert Id:{6,number,#}, Valid from:{7}, Valid until:{8}&quot;,
 91             algId, serialNum, subject, issuer, keyType, length,
 92             certId, new Date(beginDate), new Date(endDate));
 93     }
 94 
 95     /**
 96      * Method to calculate a duration timestamp for events which measure
 97      * the start and end times of certain operations.
 98      * @param start Instant indicating when event started recording
 99      * @return A string representing duraction from start time to
100      * time of this method call. Empty string is start is null.
101      */
102     private static String getDurationString(Instant start) {
103         if (start != null) {
104             if (start.equals(Instant.MIN)) {
105                 return &quot;N/A&quot;;
106             }
107             Duration duration = Duration.between(start, Instant.now());
108             long micros = duration.toNanos() / 1_000;
109             if (micros &lt; 1_000_000) {
110                 return &quot;duration = &quot; + (micros / 1_000.0) + &quot; ms:&quot;;
111             } else {
112                 return &quot;duration = &quot; + ((micros / 1_000) / 1_000.0) + &quot; s:&quot;;
113             }
114         } else {
115             return &quot;&quot;;
116         }
117     }
118 
119     /**
120      * Helper to determine if security events are being logged
121      * at a preconfigured logging level. The configuration value
122      * is read once at class initialization.
123      *
124      * @return boolean indicating whether an event should be logged
125      */
126     public static boolean isLoggingSecurity() {
<span class="line-modified">127         return LOGGING_SECURITY;</span>







128     }

129 }
</pre>
</td>
<td>
<hr />
<pre>
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.internal.event;
 27 
<span class="line-added"> 28 import jdk.internal.access.JavaUtilJarAccess;</span>
<span class="line-added"> 29 import jdk.internal.access.SharedSecrets;</span>
<span class="line-added"> 30 </span>
<span class="line-added"> 31 import java.lang.invoke.MethodHandles;</span>
<span class="line-added"> 32 import java.lang.invoke.VarHandle;</span>
 33 import java.time.Duration;
 34 import java.time.Instant;
 35 import java.util.Date;
 36 import java.util.stream.Collectors;
 37 import java.util.stream.IntStream;
 38 
 39 /**
 40  * A helper class to have events logged to a JDK Event Logger.
 41  */
 42 
 43 public final class EventHelper {
 44 
<span class="line-added"> 45     private static final JavaUtilJarAccess JUJA = SharedSecrets.javaUtilJarAccess();</span>
<span class="line-added"> 46     private static volatile boolean loggingSecurity;</span>
<span class="line-added"> 47     private static volatile System.Logger securityLogger;</span>
<span class="line-added"> 48     private static final VarHandle LOGGER_HANDLE;</span>
<span class="line-added"> 49     static {</span>
<span class="line-added"> 50         try {</span>
<span class="line-added"> 51             LOGGER_HANDLE =</span>
<span class="line-added"> 52                     MethodHandles.lookup().findStaticVarHandle(</span>
<span class="line-added"> 53                             EventHelper.class, &quot;securityLogger&quot;, System.Logger.class);</span>
<span class="line-added"> 54         } catch (ReflectiveOperationException e) {</span>
<span class="line-added"> 55             throw new Error(e);</span>
<span class="line-added"> 56         }</span>
<span class="line-added"> 57     }</span>
 58     private static final System.Logger.Level LOG_LEVEL = System.Logger.Level.DEBUG;
 59 
 60     // helper class used for logging security related events for now
 61     private static final String SECURITY_LOGGER_NAME = &quot;jdk.event.security&quot;;
<span class="line-modified"> 62 </span>



 63 
 64     public static void logTLSHandshakeEvent(Instant start,
 65                                             String peerHost,
 66                                             int peerPort,
 67                                             String cipherSuite,
 68                                             String protocolVersion,
 69                                             long peerCertId) {
<span class="line-added"> 70         assert securityLogger != null;</span>
 71         String prepend = getDurationString(start);
<span class="line-modified"> 72         securityLogger.log(LOG_LEVEL, prepend +</span>
 73         &quot; TLSHandshake: {0}:{1,number,#}, {2}, {3}, {4,number,#}&quot;,
 74         peerHost, peerPort, protocolVersion, cipherSuite, peerCertId);
 75     }
 76 
 77     public static void logSecurityPropertyEvent(String key,
 78                                                 String value) {
 79 
<span class="line-modified"> 80         assert securityLogger != null;</span>
<span class="line-modified"> 81         securityLogger.log(LOG_LEVEL,</span>
<span class="line-modified"> 82             &quot;SecurityPropertyModification: key:{0}, value:{1}&quot;, key, value);</span>

 83     }
 84 
 85     public static void logX509ValidationEvent(int anchorCertId,
 86                                          int[] certIds) {
<span class="line-added"> 87         assert securityLogger != null;</span>
 88         String codes = IntStream.of(certIds)
 89                 .mapToObj(Integer::toString)
 90                 .collect(Collectors.joining(&quot;, &quot;));
<span class="line-modified"> 91         securityLogger.log(LOG_LEVEL,</span>
 92                 &quot;ValidationChain: {0,number,#}, {1}&quot;, anchorCertId, codes);
 93     }
 94 
 95     public static void logX509CertificateEvent(String algId,
 96                                                String serialNum,
 97                                                String subject,
 98                                                String issuer,
 99                                                String keyType,
100                                                int length,
101                                                long certId,
102                                                long beginDate,
103                                                long endDate) {
<span class="line-modified">104         assert securityLogger != null;</span>
<span class="line-added">105         securityLogger.log(LOG_LEVEL, &quot;X509Certificate: Alg:{0}, Serial:{1}&quot; +</span>
106             &quot;, Subject:{2}, Issuer:{3}, Key type:{4}, Length:{5,number,#}&quot; +
107             &quot;, Cert Id:{6,number,#}, Valid from:{7}, Valid until:{8}&quot;,
108             algId, serialNum, subject, issuer, keyType, length,
109             certId, new Date(beginDate), new Date(endDate));
110     }
111 
112     /**
113      * Method to calculate a duration timestamp for events which measure
114      * the start and end times of certain operations.
115      * @param start Instant indicating when event started recording
116      * @return A string representing duraction from start time to
117      * time of this method call. Empty string is start is null.
118      */
119     private static String getDurationString(Instant start) {
120         if (start != null) {
121             if (start.equals(Instant.MIN)) {
122                 return &quot;N/A&quot;;
123             }
124             Duration duration = Duration.between(start, Instant.now());
125             long micros = duration.toNanos() / 1_000;
126             if (micros &lt; 1_000_000) {
127                 return &quot;duration = &quot; + (micros / 1_000.0) + &quot; ms:&quot;;
128             } else {
129                 return &quot;duration = &quot; + ((micros / 1_000) / 1_000.0) + &quot; s:&quot;;
130             }
131         } else {
132             return &quot;&quot;;
133         }
134     }
135 
136     /**
137      * Helper to determine if security events are being logged
138      * at a preconfigured logging level. The configuration value
139      * is read once at class initialization.
140      *
141      * @return boolean indicating whether an event should be logged
142      */
143     public static boolean isLoggingSecurity() {
<span class="line-modified">144         // Avoid a bootstrap issue where the commitEvent attempts to</span>
<span class="line-added">145         // trigger early loading of System Logger but where</span>
<span class="line-added">146         // the verification process still has JarFiles locked</span>
<span class="line-added">147         if (securityLogger == null &amp;&amp; !JUJA.isInitializing()) {</span>
<span class="line-added">148             LOGGER_HANDLE.compareAndSet( null, System.getLogger(SECURITY_LOGGER_NAME));</span>
<span class="line-added">149             loggingSecurity = securityLogger.isLoggable(LOG_LEVEL);</span>
<span class="line-added">150         }</span>
<span class="line-added">151         return loggingSecurity;</span>
152     }
<span class="line-added">153 </span>
154 }
</pre>
</td>
</tr>
</table>
<center><a href="../access/SharedSecrets.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../jrtfs/JrtFileSystemProvider.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>