<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/jdk/internal/util/ArraysSupport.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../reflect/ReflectionFactory.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="StaticProperty.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/jdk/internal/util/ArraysSupport.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 26,11 ***</span>
  
  import jdk.internal.HotSpotIntrinsicCandidate;
  import jdk.internal.misc.Unsafe;
  
  /**
<span class="line-modified">!  * Utility methods to find a mismatch between two primitive arrays.</span>
   *
   * &lt;p&gt;Array equality and lexicographical comparison can be built on top of
   * array mismatch functionality.
   *
   * &lt;p&gt;The mismatch method implementation, {@link #vectorizedMismatch}, leverages
<span class="line-new-header">--- 26,13 ---</span>
  
  import jdk.internal.HotSpotIntrinsicCandidate;
  import jdk.internal.misc.Unsafe;
  
  /**
<span class="line-modified">!  * Utility methods to work with arrays.  This includes a set of methods</span>
<span class="line-added">+  * to find a mismatch between two primitive arrays.  Also included is</span>
<span class="line-added">+  * a method to calculate the new length of an array to be reallocated.</span>
   *
   * &lt;p&gt;Array equality and lexicographical comparison can be built on top of
   * array mismatch functionality.
   *
   * &lt;p&gt;The mismatch method implementation, {@link #vectorizedMismatch}, leverages
</pre>
<hr />
<pre>
<span class="line-old-header">*** 569,6 ***</span>
<span class="line-new-header">--- 571,56 ---</span>
              }
          }
  
          return -1;
      }
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * The maximum length of array to allocate (unless necessary).</span>
<span class="line-added">+      * Some VMs reserve some header words in an array.</span>
<span class="line-added">+      * Attempts to allocate larger arrays may result in</span>
<span class="line-added">+      * {@code OutOfMemoryError: Requested array size exceeds VM limit}</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public static final int MAX_ARRAY_LENGTH = Integer.MAX_VALUE - 8;</span>
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * Calculates a new array length given an array&#39;s current length, a preferred</span>
<span class="line-added">+      * growth value, and a minimum growth value.  If the preferred growth value</span>
<span class="line-added">+      * is less than the minimum growth value, the minimum growth value is used in</span>
<span class="line-added">+      * its place.  If the sum of the current length and the preferred growth</span>
<span class="line-added">+      * value does not exceed {@link #MAX_ARRAY_LENGTH}, that sum is returned.</span>
<span class="line-added">+      * If the sum of the current length and the minimum growth value does not</span>
<span class="line-added">+      * exceed {@code MAX_ARRAY_LENGTH}, then {@code MAX_ARRAY_LENGTH} is returned.</span>
<span class="line-added">+      * If the sum does not overflow an int, then {@code Integer.MAX_VALUE} is</span>
<span class="line-added">+      * returned.  Otherwise, {@code OutOfMemoryError} is thrown.</span>
<span class="line-added">+      *</span>
<span class="line-added">+      * @param oldLength   current length of the array (must be non negative)</span>
<span class="line-added">+      * @param minGrowth   minimum required growth of the array length (must be</span>
<span class="line-added">+      *                    positive)</span>
<span class="line-added">+      * @param prefGrowth  preferred growth of the array length (ignored, if less</span>
<span class="line-added">+      *                    then {@code minGrowth})</span>
<span class="line-added">+      * @return the new length of the array</span>
<span class="line-added">+      * @throws OutOfMemoryError if increasing {@code oldLength} by</span>
<span class="line-added">+      *                    {@code minGrowth} overflows.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public static int newLength(int oldLength, int minGrowth, int prefGrowth) {</span>
<span class="line-added">+         // assert oldLength &gt;= 0</span>
<span class="line-added">+         // assert minGrowth &gt; 0</span>
<span class="line-added">+ </span>
<span class="line-added">+         int newLength = Math.max(minGrowth, prefGrowth) + oldLength;</span>
<span class="line-added">+         if (newLength - MAX_ARRAY_LENGTH &lt;= 0) {</span>
<span class="line-added">+             return newLength;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return hugeLength(oldLength, minGrowth);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static int hugeLength(int oldLength, int minGrowth) {</span>
<span class="line-added">+         int minLength = oldLength + minGrowth;</span>
<span class="line-added">+         if (minLength &lt; 0) { // overflow</span>
<span class="line-added">+             throw new OutOfMemoryError(&quot;Required array length too large&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (minLength &lt;= MAX_ARRAY_LENGTH) {</span>
<span class="line-added">+             return MAX_ARRAY_LENGTH;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return Integer.MAX_VALUE;</span>
<span class="line-added">+     }</span>
  }
</pre>
<center><a href="../reflect/ReflectionFactory.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="StaticProperty.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>