<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/classes/jdk/internal/util/SystemProps.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package jdk.internal.util;
 26 
 27 
 28 import java.lang.annotation.Native;
 29 import java.util.HashMap;
 30 import java.util.Map;
 31 
 32 /**
 33  * System Property initialization for internal use only
 34  * Retrieves the platform, JVM, and command line properties,
 35  * applies initial defaults and returns the Properties instance
 36  * that becomes the System.getProperties instance.
 37  */
 38 public final class SystemProps {
 39 
 40     // no instances
 41     private SystemProps() {}
 42 
 43     /**
 44      * Create and initialize the system properties from the native properties
 45      * and command line properties.
 46      * Note:  Build-defined properties such as versions and vendor information
 47      * are initialized by VersionProps.java-template.
 48      *
 49      * @return a Properties instance initialized with all of the properties
 50      */
 51     public static Map&lt;String, String&gt; initProperties() {
 52 
 53         // Initially, cmdProperties only includes -D and props from the VM
 54         Raw raw = new Raw();
 55         HashMap&lt;String, String&gt; props = raw.cmdProperties();
 56 
 57         String javaHome = props.get(&quot;java.home&quot;);
 58         assert javaHome != null : &quot;java.home not set&quot;;
 59 
 60         putIfAbsent(props, &quot;user.home&quot;, raw.propDefault(Raw._user_home_NDX));
 61         putIfAbsent(props, &quot;user.dir&quot;, raw.propDefault(Raw._user_dir_NDX));
 62         putIfAbsent(props, &quot;user.name&quot;, raw.propDefault(Raw._user_name_NDX));
 63 
 64         // Platform defined encoding cannot be overridden on the command line
 65         put(props, &quot;sun.jnu.encoding&quot;, raw.propDefault(Raw._sun_jnu_encoding_NDX));
 66 
 67         // Add properties that have not been overridden on the cmdline
 68         putIfAbsent(props, &quot;file.encoding&quot;,
 69                 ((raw.propDefault(Raw._file_encoding_NDX) == null)
 70                         ? raw.propDefault(Raw._sun_jnu_encoding_NDX)
 71                         : raw.propDefault(Raw._file_encoding_NDX)));
 72 
 73         // Use platform values if not overridden by a commandline -Dkey=value
 74         // In no particular order
 75         putIfAbsent(props, &quot;os.name&quot;, raw.propDefault(Raw._os_name_NDX));
 76         putIfAbsent(props, &quot;os.arch&quot;, raw.propDefault(Raw._os_arch_NDX));
 77         putIfAbsent(props, &quot;os.version&quot;, raw.propDefault(Raw._os_version_NDX));
 78         putIfAbsent(props, &quot;line.separator&quot;, raw.propDefault(Raw._line_separator_NDX));
 79         putIfAbsent(props, &quot;file.separator&quot;, raw.propDefault(Raw._file_separator_NDX));
 80         putIfAbsent(props, &quot;path.separator&quot;, raw.propDefault(Raw._path_separator_NDX));
 81         putIfAbsent(props, &quot;java.io.tmpdir&quot;, raw.propDefault(Raw._java_io_tmpdir_NDX));
 82         putIfAbsent(props, &quot;http.proxyHost&quot;, raw.propDefault(Raw._http_proxyHost_NDX));
 83         putIfAbsent(props, &quot;http.proxyPort&quot;, raw.propDefault(Raw._http_proxyPort_NDX));
 84         putIfAbsent(props, &quot;https.proxyHost&quot;, raw.propDefault(Raw._https_proxyHost_NDX));
 85         putIfAbsent(props, &quot;https.proxyPort&quot;, raw.propDefault(Raw._https_proxyPort_NDX));
 86         putIfAbsent(props, &quot;ftp.proxyHost&quot;, raw.propDefault(Raw._ftp_proxyHost_NDX));
 87         putIfAbsent(props, &quot;ftp.proxyPort&quot;, raw.propDefault(Raw._ftp_proxyPort_NDX));
 88         putIfAbsent(props, &quot;socksProxyHost&quot;, raw.propDefault(Raw._socksProxyHost_NDX));
 89         putIfAbsent(props, &quot;socksProxyPort&quot;, raw.propDefault(Raw._socksProxyPort_NDX));
 90         putIfAbsent(props, &quot;http.nonProxyHosts&quot;, raw.propDefault(Raw._http_nonProxyHosts_NDX));
 91         putIfAbsent(props, &quot;ftp.nonProxyHosts&quot;, raw.propDefault(Raw._ftp_nonProxyHosts_NDX));
 92         putIfAbsent(props, &quot;socksNonProxyHosts&quot;, raw.propDefault(Raw._socksNonProxyHosts_NDX));
<a name="1" id="anc1"></a><span class="line-removed"> 93         putIfAbsent(props, &quot;awt.toolkit&quot;, raw.propDefault(Raw._awt_toolkit_NDX));</span>
<span class="line-removed"> 94         putIfAbsent(props, &quot;java.awt.headless&quot;, raw.propDefault(Raw._java_awt_headless_NDX));</span>
<span class="line-removed"> 95         putIfAbsent(props, &quot;java.awt.graphicsenv&quot;, raw.propDefault(Raw._java_awt_graphicsenv_NDX));</span>
<span class="line-removed"> 96         putIfAbsent(props, &quot;sun.desktop&quot;, raw.propDefault(Raw._sun_desktop_NDX));</span>
 97         putIfAbsent(props, &quot;sun.arch.abi&quot;, raw.propDefault(Raw._sun_arch_abi_NDX));
 98         putIfAbsent(props, &quot;sun.arch.data.model&quot;, raw.propDefault(Raw._sun_arch_data_model_NDX));
 99         putIfAbsent(props, &quot;sun.os.patch.level&quot;, raw.propDefault(Raw._sun_os_patch_level_NDX));
100         putIfAbsent(props, &quot;sun.stdout.encoding&quot;, raw.propDefault(Raw._sun_stdout_encoding_NDX));
101         putIfAbsent(props, &quot;sun.stderr.encoding&quot;, raw.propDefault(Raw._sun_stderr_encoding_NDX));
102         putIfAbsent(props, &quot;sun.io.unicode.encoding&quot;, raw.propDefault(Raw._sun_io_unicode_encoding_NDX));
103         putIfAbsent(props, &quot;sun.cpu.isalist&quot;, raw.propDefault(Raw._sun_cpu_isalist_NDX));
104         putIfAbsent(props, &quot;sun.cpu.endian&quot;, raw.propDefault(Raw._sun_cpu_endian_NDX));
105 
106         /* Construct i18n related options */
107         fillI18nProps(props,&quot;user.language&quot;, raw.propDefault(Raw._display_language_NDX),
108                 raw.propDefault(Raw._format_language_NDX));
109         fillI18nProps(props,&quot;user.script&quot;,   raw.propDefault(Raw._display_script_NDX),
110                 raw.propDefault(Raw._format_script_NDX));
111         fillI18nProps(props,&quot;user.country&quot;,  raw.propDefault(Raw._display_country_NDX),
112                 raw.propDefault(Raw._format_country_NDX));
113         fillI18nProps(props,&quot;user.variant&quot;,  raw.propDefault(Raw._display_variant_NDX),
114                 raw.propDefault(Raw._format_variant_NDX));
115 
116         return props;
117     }
118 
119     /**
120      * Puts the property if it is non-null
121      * @param props the Properties
122      * @param key the key
123      * @param value the value
124      */
125     private static void put(HashMap&lt;String, String&gt; props, String key, String value) {
126         if (value != null) {
127             props.put(key, value);
128         }
129     }
130 
131     /**
132      * Puts the property if it is non-null and is not already in the Properties.
133      * @param props the Properties
134      * @param key the key
135      * @param value the value
136      */
137     private static void putIfAbsent(HashMap&lt;String, String&gt; props, String key, String value) {
138         if (value != null) {
139             props.putIfAbsent(key, value);
140         }
141     }
142 
143     /**
144      * For internationalization options, compute the values for
145      * display and format properties
146      * MUST NOT override command line defined values.
147      *
148      * @param base the base property name
149      * @param display the display value for the base
150      * @param format the format value for the base
151      */
152     private static void fillI18nProps(HashMap&lt;String, String&gt; cmdProps,
153                                       String base,
154                                       String display,
155                                       String format) {
156         // Do not override command line setting
157         String baseValue = cmdProps.get(base);
158         if (baseValue != null) {
159             return;     // Do not override value from the command line
160         }
161 
162         // Not overridden on the command line; define the properties if there are platform defined values
163         if (display != null) {
164             cmdProps.put(base, display);
165             baseValue = display;
166         }
167 
168         /* user.xxx.display property */
169         String disp = base.concat(&quot;.display&quot;);
170         String dispValue = cmdProps.get(disp);
171         if (dispValue == null &amp;&amp; display != null &amp;&amp; !display.equals(baseValue)) {
172             // Create the property only if different from the base property
173             cmdProps.put(disp, display);
174         }
175 
176         /* user.xxx.format property */
177         String fmt = base.concat(&quot;.format&quot;);
178         String fmtValue = cmdProps.get(fmt);
179         if (fmtValue == null &amp;&amp; format != null &amp;&amp; !format.equals(baseValue)) {
180             // Create the property only if different than the base property
181             cmdProps.put(fmt, format);
182         }
183     }
184 
185     /**
186      * Read the raw properties from native System.c.
187      */
188     public static class Raw {
189         // Array indices written by native vmProperties()
190         // The order is arbitrary (but alphabetic for convenience)
<a name="2" id="anc2"></a><span class="line-modified">191         @Native private static final int _awt_toolkit_NDX = 0;</span>
<span class="line-removed">192         @Native private static final int _display_country_NDX = 1 + _awt_toolkit_NDX;</span>
193         @Native private static final int _display_language_NDX = 1 + _display_country_NDX;
194         @Native private static final int _display_script_NDX = 1 + _display_language_NDX;
195         @Native private static final int _display_variant_NDX = 1 + _display_script_NDX;
196         @Native private static final int _file_encoding_NDX = 1 + _display_variant_NDX;
197         @Native private static final int _file_separator_NDX = 1 + _file_encoding_NDX;
198         @Native private static final int _format_country_NDX = 1 + _file_separator_NDX;
199         @Native private static final int _format_language_NDX = 1 + _format_country_NDX;
200         @Native private static final int _format_script_NDX = 1 + _format_language_NDX;
201         @Native private static final int _format_variant_NDX = 1 + _format_script_NDX;
202         @Native private static final int _ftp_nonProxyHosts_NDX = 1 + _format_variant_NDX;
203         @Native private static final int _ftp_proxyHost_NDX = 1 + _ftp_nonProxyHosts_NDX;
204         @Native private static final int _ftp_proxyPort_NDX = 1 + _ftp_proxyHost_NDX;
205         @Native private static final int _http_nonProxyHosts_NDX = 1 + _ftp_proxyPort_NDX;
206         @Native private static final int _http_proxyHost_NDX = 1 + _http_nonProxyHosts_NDX;
207         @Native private static final int _http_proxyPort_NDX = 1 + _http_proxyHost_NDX;
208         @Native private static final int _https_proxyHost_NDX = 1 + _http_proxyPort_NDX;
209         @Native private static final int _https_proxyPort_NDX = 1 + _https_proxyHost_NDX;
<a name="3" id="anc3"></a><span class="line-modified">210         @Native private static final int _java_awt_graphicsenv_NDX = 1 + _https_proxyPort_NDX;</span>
<span class="line-removed">211         @Native private static final int _java_awt_headless_NDX = 1 + _java_awt_graphicsenv_NDX;</span>
<span class="line-removed">212         @Native private static final int _java_io_tmpdir_NDX = 1 + _java_awt_headless_NDX;</span>
213         @Native private static final int _line_separator_NDX = 1 + _java_io_tmpdir_NDX;
214         @Native private static final int _os_arch_NDX = 1 + _line_separator_NDX;
215         @Native private static final int _os_name_NDX = 1 + _os_arch_NDX;
216         @Native private static final int _os_version_NDX = 1 + _os_name_NDX;
217         @Native private static final int _path_separator_NDX = 1 + _os_version_NDX;
218         @Native private static final int _socksNonProxyHosts_NDX = 1 + _path_separator_NDX;
219         @Native private static final int _socksProxyHost_NDX = 1 + _socksNonProxyHosts_NDX;
220         @Native private static final int _socksProxyPort_NDX = 1 + _socksProxyHost_NDX;
221         @Native private static final int _sun_arch_abi_NDX = 1 + _socksProxyPort_NDX;
222         @Native private static final int _sun_arch_data_model_NDX = 1 + _sun_arch_abi_NDX;
223         @Native private static final int _sun_cpu_endian_NDX = 1 + _sun_arch_data_model_NDX;
224         @Native private static final int _sun_cpu_isalist_NDX = 1 + _sun_cpu_endian_NDX;
<a name="4" id="anc4"></a><span class="line-modified">225         @Native private static final int _sun_desktop_NDX = 1 + _sun_cpu_isalist_NDX;</span>
<span class="line-removed">226         @Native private static final int _sun_io_unicode_encoding_NDX = 1 + _sun_desktop_NDX;</span>
227         @Native private static final int _sun_jnu_encoding_NDX = 1 + _sun_io_unicode_encoding_NDX;
228         @Native private static final int _sun_os_patch_level_NDX = 1 + _sun_jnu_encoding_NDX;
229         @Native private static final int _sun_stderr_encoding_NDX = 1 + _sun_os_patch_level_NDX;
230         @Native private static final int _sun_stdout_encoding_NDX = 1 + _sun_stderr_encoding_NDX;
231         @Native private static final int _user_dir_NDX = 1 + _sun_stdout_encoding_NDX;
232         @Native private static final int _user_home_NDX = 1 + _user_dir_NDX;
233         @Native private static final int _user_name_NDX = 1 + _user_home_NDX;
234         @Native private static final int FIXED_LENGTH = 1 + _user_name_NDX;
235 
236         // Array of Strings returned from the VM and Command line properties
237         // The array is not used after initialization is complete.
238         private final String[] platformProps;
239 
240         private Raw() {
241             platformProps = platformProperties();
242         }
243 
244         /**
245          * Return the value for a well known default from native.
246          * @param index the index of the known property
247          * @return the value
248          */
249         String propDefault(int index) {
250             return platformProps[index];
251         }
252 
253         /**
254          * Return a Properties instance of the command line and VM options
255          * defined by name and value.
256          * The Properties instance is sized to include the fixed properties.
257          *
258          * @return return a Properties instance of the command line and VM options
259          */
260         private HashMap&lt;String, String&gt; cmdProperties() {
261             String[] vmProps = vmProperties();
262             // While optimal initialCapacity here would be the exact number of properties
263             // divided by LOAD_FACTOR, a large portion of the properties in Raw are
264             // usually not set, so for typical cases the chosen capacity avoids resizing
265             var cmdProps = new HashMap&lt;String, String&gt;((vmProps.length / 2) + Raw.FIXED_LENGTH);
266             for (int i = 0; i &lt; vmProps.length;) {
267                 String k = vmProps[i++];
268                 if (k != null) {
269                     String v = vmProps[i++];
270                     cmdProps.put(k, v != null ? v : &quot;&quot;);
271                 } else {
272                     // no more key/value pairs
273                     break;
274                 }
275             }
276             return cmdProps;
277         }
278 
279         /**
280          * Returns the available VM and Command Line Properties.
281          * The VM supplies some key/value pairs and processes the command line
282          * to extract key/value pairs from the {@code &quot;-Dkey=value&quot;} arguments.
283          *
284          * @return an array of strings, with alternating key and value strings.
285          *      Either keys or values may be null, the array may not be full.
286          *      The first null key indicates there are no more key, value pairs.
287          */
288         private static native String[] vmProperties();
289 
290         /**
291          * Returns the platform specific property values identified
292          * by {@code &quot;_xxx_NDX&quot;} indexes.
293          * The indexes are strictly private, to be shared only with the native code.
294          *
295          * @return a array of strings, the properties are indexed by the {@code _xxx_NDX}
296          * indexes.  The values are Strings and may be null.
297          */
298         private static native String[] platformProperties();
299     }
300 }
<a name="5" id="anc5"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="5" type="hidden" />
</body>
</html>