<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/share/classes/jdk/internal/module/ModuleInfoWriter.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="ModuleInfo.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ModuleLoaderMap.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/jdk/internal/module/ModuleInfoWriter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 32,10 ***</span>
<span class="line-new-header">--- 32,11 ---</span>
  import java.util.stream.Stream;
  
  import jdk.internal.org.objectweb.asm.ClassWriter;
  import jdk.internal.org.objectweb.asm.ModuleVisitor;
  import jdk.internal.org.objectweb.asm.Opcodes;
<span class="line-added">+ import jdk.internal.org.objectweb.asm.commons.ModuleResolutionAttribute;</span>
  import jdk.internal.org.objectweb.asm.commons.ModuleTargetAttribute;
  import static jdk.internal.org.objectweb.asm.Opcodes.*;
  
  /**
   * Utility class to write a ModuleDescriptor as a module-info.class.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 76,11 ***</span>
  
      /**
       * Writes the given module descriptor to a module-info.class file,
       * returning it in a byte array.
       */
<span class="line-modified">!     private static byte[] toModuleInfo(ModuleDescriptor md, ModuleTarget target) {</span>
          ClassWriter cw = new ClassWriter(0);
          cw.visit(Opcodes.V10, ACC_MODULE, &quot;module-info&quot;, null, null, null);
  
          int moduleFlags = md.modifiers().stream()
                  .map(MODULE_MODS_TO_FLAGS::get)
<span class="line-new-header">--- 77,13 ---</span>
  
      /**
       * Writes the given module descriptor to a module-info.class file,
       * returning it in a byte array.
       */
<span class="line-modified">!     private static byte[] toModuleInfo(ModuleDescriptor md,</span>
<span class="line-added">+                                        ModuleResolution mres,</span>
<span class="line-added">+                                        ModuleTarget target) {</span>
          ClassWriter cw = new ClassWriter(0);
          cw.visit(Opcodes.V10, ACC_MODULE, &quot;module-info&quot;, null, null, null);
  
          int moduleFlags = md.modifiers().stream()
                  .map(MODULE_MODS_TO_FLAGS::get)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 145,10 ***</span>
<span class="line-new-header">--- 148,15 ---</span>
              .map(mc -&gt; mc.replace(&#39;.&#39;, &#39;/&#39;))
              .ifPresent(mv::visitMainClass);
  
          mv.visitEnd();
  
<span class="line-added">+         // write ModuleResolution attribute if specified</span>
<span class="line-added">+         if (mres != null) {</span>
<span class="line-added">+             cw.visitAttribute(new ModuleResolutionAttribute(mres.value()));</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          // write ModuleTarget attribute if there is a target platform
          if (target != null &amp;&amp; target.targetPlatform().length() &gt; 0) {
              cw.visitAttribute(new ModuleTargetAttribute(target.targetPlatform()));
          }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 159,32 ***</span>
      /**
       * Writes a module descriptor to the given output stream as a
       * module-info.class.
       */
      public static void write(ModuleDescriptor descriptor,
                               ModuleTarget target,
                               OutputStream out)
          throws IOException
      {
<span class="line-modified">!         byte[] bytes = toModuleInfo(descriptor, target);</span>
          out.write(bytes);
      }
  
      /**
       * Writes a module descriptor to the given output stream as a
       * module-info.class.
       */
      public static void write(ModuleDescriptor descriptor, OutputStream out)
          throws IOException
      {
<span class="line-modified">!         write(descriptor, null, out);</span>
      }
  
      /**
       * Returns a {@code ByteBuffer} containing the given module descriptor
       * in module-info.class format.
       */
      public static ByteBuffer toByteBuffer(ModuleDescriptor descriptor) {
<span class="line-modified">!         byte[] bytes = toModuleInfo(descriptor, null);</span>
          return ByteBuffer.wrap(bytes);
      }
  }
<span class="line-new-header">--- 167,57 ---</span>
      /**
       * Writes a module descriptor to the given output stream as a
       * module-info.class.
       */
      public static void write(ModuleDescriptor descriptor,
<span class="line-added">+                              ModuleResolution mres,</span>
                               ModuleTarget target,
                               OutputStream out)
          throws IOException
      {
<span class="line-modified">!         byte[] bytes = toModuleInfo(descriptor, mres, target);</span>
          out.write(bytes);
      }
  
<span class="line-added">+     /**</span>
<span class="line-added">+      * Writes a module descriptor to the given output stream as a</span>
<span class="line-added">+      * module-info.class.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public static void write(ModuleDescriptor descriptor,</span>
<span class="line-added">+                              ModuleResolution mres,</span>
<span class="line-added">+                              OutputStream out)</span>
<span class="line-added">+         throws IOException</span>
<span class="line-added">+     {</span>
<span class="line-added">+         write(descriptor, mres, null, out);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * Writes a module descriptor to the given output stream as a</span>
<span class="line-added">+      * module-info.class.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     public static void write(ModuleDescriptor descriptor,</span>
<span class="line-added">+                              ModuleTarget target,</span>
<span class="line-added">+                              OutputStream out)</span>
<span class="line-added">+         throws IOException</span>
<span class="line-added">+     {</span>
<span class="line-added">+         write(descriptor, null, target, out);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /**
       * Writes a module descriptor to the given output stream as a
       * module-info.class.
       */
      public static void write(ModuleDescriptor descriptor, OutputStream out)
          throws IOException
      {
<span class="line-modified">!         write(descriptor, null, null, out);</span>
      }
  
      /**
       * Returns a {@code ByteBuffer} containing the given module descriptor
       * in module-info.class format.
       */
      public static ByteBuffer toByteBuffer(ModuleDescriptor descriptor) {
<span class="line-modified">!         byte[] bytes = toModuleInfo(descriptor, null, null);</span>
          return ByteBuffer.wrap(bytes);
      }
  }
</pre>
<center><a href="ModuleInfo.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ModuleLoaderMap.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>