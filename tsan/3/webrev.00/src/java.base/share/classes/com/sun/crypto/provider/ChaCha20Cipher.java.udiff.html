<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/com/sun/crypto/provider/ChaCha20Cipher.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../macosx/native/libosxsecurity/KeystoreImpl.m.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CipherCore.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/com/sun/crypto/provider/ChaCha20Cipher.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -31,16 +31,15 @@</span>
  import java.lang.invoke.VarHandle;
  import java.nio.ByteBuffer;
  import java.nio.ByteOrder;
  import java.security.*;
  import java.security.spec.AlgorithmParameterSpec;
<span class="udiff-line-removed">- import java.util.Arrays;</span>
  import java.util.Objects;
<span class="udiff-line-added">+ import javax.crypto.*;</span>
  import javax.crypto.spec.ChaCha20ParameterSpec;
  import javax.crypto.spec.IvParameterSpec;
  import javax.crypto.spec.SecretKeySpec;
<span class="udiff-line-removed">- import javax.crypto.*;</span>
  import sun.security.util.DerValue;
  
  /**
   * Implementation of the ChaCha20 cipher, as described in RFC 7539.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -132,12 +131,11 @@</span>
                      ByteOrder.nativeOrder());
  
      /**
       * Default constructor.
       */
<span class="udiff-line-modified-removed">-     protected ChaCha20Cipher() {</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     protected ChaCha20Cipher() { }</span>
  
      /**
       * Set the mode of operation.  Since this is a stream cipher, there
       * is no mode of operation in the block-cipher sense of things.  The
       * protected {@code mode} field will only accept a value of {@code None}
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -183,33 +181,25 @@</span>
      protected int engineGetBlockSize() {
          return 0;
      }
  
      /**
<span class="udiff-line-modified-removed">-      * Get the output size based on an input length.  In simple stream-cipher</span>
<span class="udiff-line-modified-added">+      * Get the output size required to hold the result of the next update or</span>
<span class="udiff-line-added">+      * doFinal operation.  In simple stream-cipher</span>
       * mode, the output size will equal the input size.  For ChaCha20-Poly1305
       * for encryption the output size will be the sum of the input length
<span class="udiff-line-modified-removed">-      * and tag length.  For decryption, the output size will be the input</span>
<span class="udiff-line-modified-removed">-      * length less the tag length or zero, whichever is larger.</span>
<span class="udiff-line-modified-added">+      * and tag length.  For decryption, the output size will be  the input</span>
<span class="udiff-line-modified-added">+      * length plus any previously unprocessed data minus the tag</span>
<span class="udiff-line-added">+      * length, minimum zero.</span>
       *
       * @param inputLen the length in bytes of the input
       *
       * @return the output length in bytes.
       */
      @Override
      protected int engineGetOutputSize(int inputLen) {
<span class="udiff-line-modified-removed">-         int outLen = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (mode == MODE_NONE) {</span>
<span class="udiff-line-removed">-             outLen = inputLen;</span>
<span class="udiff-line-removed">-         } else if (mode == MODE_AEAD) {</span>
<span class="udiff-line-removed">-             outLen = (direction == Cipher.ENCRYPT_MODE) ?</span>
<span class="udiff-line-removed">-                     Math.addExact(inputLen, TAG_LENGTH) :</span>
<span class="udiff-line-removed">-                     Integer.max(inputLen - TAG_LENGTH, 0);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return outLen;</span>
<span class="udiff-line-modified-added">+         return engine.getOutputSize(inputLen, true);</span>
      }
  
      /**
       * Get the nonce value used.
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -235,17 +225,14 @@</span>
      @Override
      protected AlgorithmParameters engineGetParameters() {
          AlgorithmParameters params = null;
          if (mode == MODE_AEAD) {
              try {
<span class="udiff-line-modified-removed">-                 // Force the 12-byte nonce into a DER-encoded OCTET_STRING</span>
<span class="udiff-line-removed">-                 byte[] derNonce = new byte[nonce.length + 2];</span>
<span class="udiff-line-removed">-                 derNonce[0] = 0x04;                 // OCTET_STRING tag</span>
<span class="udiff-line-removed">-                 derNonce[1] = (byte)nonce.length;   // 12-byte length;</span>
<span class="udiff-line-removed">-                 System.arraycopy(nonce, 0, derNonce, 2, nonce.length);</span>
<span class="udiff-line-modified-added">+                 // Place the 12-byte nonce into a DER-encoded OCTET_STRING</span>
                  params = AlgorithmParameters.getInstance(&quot;ChaCha20-Poly1305&quot;);
<span class="udiff-line-modified-removed">-                 params.init(derNonce);</span>
<span class="udiff-line-modified-added">+                 params.init((new DerValue(</span>
<span class="udiff-line-added">+                         DerValue.tag_OctetString, nonce).toByteArray()));</span>
              } catch (NoSuchAlgorithmException | IOException exc) {
                  throw new RuntimeException(exc);
              }
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -636,11 +623,11 @@</span>
       * @return the resulting plaintext or ciphertext bytes (depending on
       *      the operation type)
       */
      @Override
      protected byte[] engineUpdate(byte[] in, int inOfs, int inLen) {
<span class="udiff-line-modified-removed">-         byte[] out = new byte[inLen];</span>
<span class="udiff-line-modified-added">+         byte[] out = new byte[engine.getOutputSize(inLen, false)];</span>
          try {
              engine.doUpdate(in, inOfs, inLen, out, 0);
          } catch (ShortBufferException | KeyException exc) {
              throw new RuntimeException(exc);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -694,11 +681,11 @@</span>
       *      does not match the calculated tag.
       */
      @Override
      protected byte[] engineDoFinal(byte[] in, int inOfs, int inLen)
              throws AEADBadTagException {
<span class="udiff-line-modified-removed">-         byte[] output = new byte[engineGetOutputSize(inLen)];</span>
<span class="udiff-line-modified-added">+         byte[] output = new byte[engine.getOutputSize(inLen, true)];</span>
          try {
              engine.doFinal(in, inOfs, inLen, output, 0);
          } catch (ShortBufferException | KeyException exc) {
              throw new RuntimeException(exc);
          } finally {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1155,10 +1142,21 @@</span>
  
      /**
       * Interface for the underlying processing engines for ChaCha20
       */
      interface ChaChaEngine {
<span class="udiff-line-added">+         /**</span>
<span class="udiff-line-added">+          * Size an output buffer based on the input and where applicable</span>
<span class="udiff-line-added">+          * the current state of the engine in a multipart operation.</span>
<span class="udiff-line-added">+          *</span>
<span class="udiff-line-added">+          * @param inLength the input length.</span>
<span class="udiff-line-added">+          * @param isFinal true if this is invoked from a doFinal call.</span>
<span class="udiff-line-added">+          *</span>
<span class="udiff-line-added">+          * @return the recommended size for the output buffer.</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         int getOutputSize(int inLength, boolean isFinal);</span>
<span class="udiff-line-added">+ </span>
          /**
           * Perform a multi-part update for ChaCha20.
           *
           * @param in the input data.
           * @param inOff the offset into the input.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1198,10 +1196,16 @@</span>
  
      private final class EngineStreamOnly implements ChaChaEngine {
  
          private EngineStreamOnly () { }
  
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public int getOutputSize(int inLength, boolean isFinal) {</span>
<span class="udiff-line-added">+             // The isFinal parameter is not relevant in this kind of engine</span>
<span class="udiff-line-added">+             return inLength;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          @Override
          public int doUpdate(byte[] in, int inOff, int inLen, byte[] out,
                  int outOff) throws ShortBufferException, KeyException {
              if (initialized) {
                 try {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1232,10 +1236,15 @@</span>
          }
      }
  
      private final class EngineAEADEnc implements ChaChaEngine {
  
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public int getOutputSize(int inLength, boolean isFinal) {</span>
<span class="udiff-line-added">+             return (isFinal ? Math.addExact(inLength, TAG_LENGTH) : inLength);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          private EngineAEADEnc() throws InvalidKeyException {
              initAuthenticator();
              counter = 1;
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1292,10 +1301,22 @@</span>
      private final class EngineAEADDec implements ChaChaEngine {
  
          private final ByteArrayOutputStream cipherBuf;
          private final byte[] tag;
  
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public int getOutputSize(int inLen, boolean isFinal) {</span>
<span class="udiff-line-added">+             // If we are performing a decrypt-update we should always return</span>
<span class="udiff-line-added">+             // zero length since we cannot return any data until the tag has</span>
<span class="udiff-line-added">+             // been consumed and verified.  CipherSpi.engineGetOutputSize will</span>
<span class="udiff-line-added">+             // always set isFinal to true to get the required output buffer</span>
<span class="udiff-line-added">+             // size.</span>
<span class="udiff-line-added">+             return (isFinal ?</span>
<span class="udiff-line-added">+                     Integer.max(Math.addExact((inLen - TAG_LENGTH),</span>
<span class="udiff-line-added">+                             cipherBuf.size()), 0) : 0);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          private EngineAEADDec() throws InvalidKeyException {
              initAuthenticator();
              counter = 1;
              cipherBuf = new ByteArrayOutputStream(CIPHERBUF_BASE);
              tag = new byte[TAG_LENGTH];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1361,12 +1382,15 @@</span>
              }
  
              // Calculate and compare the tag.  Only do the decryption
              // if and only if the tag matches.
              authFinalizeData(ctPlusTag, 0, ctLen, tag, 0);
<span class="udiff-line-modified-removed">-             if (Arrays.compare(ctPlusTag, ctLen, ctPlusTagLen,</span>
<span class="udiff-line-modified-removed">-                     tag, 0, tag.length) != 0) {</span>
<span class="udiff-line-modified-added">+             long tagCompare = ((long)asLongView.get(ctPlusTag, ctLen) ^</span>
<span class="udiff-line-modified-added">+                     (long)asLongView.get(tag, 0)) |</span>
<span class="udiff-line-added">+                     ((long)asLongView.get(ctPlusTag, ctLen + Long.BYTES) ^</span>
<span class="udiff-line-added">+                     (long)asLongView.get(tag, Long.BYTES));</span>
<span class="udiff-line-added">+             if (tagCompare != 0) {</span>
                  throw new AEADBadTagException(&quot;Tag mismatch&quot;);
              }
              chaCha20Transform(ctPlusTag, 0, ctLen, out, outOff);
              aadDone = false;
  
</pre>
<center><a href="../../../../../../macosx/native/libosxsecurity/KeystoreImpl.m.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="CipherCore.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>