<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/com/sun/crypto/provider/PBKDF2KeyImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="PBEWithMD5AndTripleDESCipher.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="RSACipher.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/com/sun/crypto/provider/PBKDF2KeyImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2005, 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,11 +27,10 @@</span>
  
  import java.io.ObjectStreamException;
  import java.lang.ref.Reference;
  import java.nio.ByteBuffer;
  import java.nio.CharBuffer;
<span class="udiff-line-removed">- import java.nio.charset.Charset;</span>
  import java.util.Arrays;
  import java.util.Locale;
  import java.security.MessageDigest;
  import java.security.KeyRep;
  import java.security.GeneralSecurityException;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -39,10 +38,12 @@</span>
  import java.security.spec.InvalidKeySpecException;
  import javax.crypto.Mac;
  import javax.crypto.SecretKey;
  import javax.crypto.spec.PBEKeySpec;
  
<span class="udiff-line-added">+ import static java.nio.charset.StandardCharsets.UTF_8;</span>
<span class="udiff-line-added">+ </span>
  import jdk.internal.ref.CleanerFactory;
  
  /**
   * This class represents a PBE key derived using PBKDF2 defined
   * in PKCS#5 v2.0. meaning that
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -53,23 +54,23 @@</span>
   * @author Valerie Peng
   *
   */
  final class PBKDF2KeyImpl implements javax.crypto.interfaces.PBEKey {
  
<span class="udiff-line-added">+     @java.io.Serial</span>
      static final long serialVersionUID = -2234868909660948157L;
  
      private char[] passwd;
      private byte[] salt;
      private int iterCount;
      private byte[] key;
  
      private Mac prf;
  
      private static byte[] getPasswordBytes(char[] passwd) {
<span class="udiff-line-removed">-         Charset utf8 = Charset.forName(&quot;UTF-8&quot;);</span>
          CharBuffer cb = CharBuffer.wrap(passwd);
<span class="udiff-line-modified-removed">-         ByteBuffer bb = utf8.encode(cb);</span>
<span class="udiff-line-modified-added">+         ByteBuffer bb = UTF_8.encode(cb);</span>
  
          int len = bb.limit();
          byte[] passwdBytes = new byte[len];
          bb.get(passwdBytes, 0, len);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -111,16 +112,11 @@</span>
              if (keyLength == 0) {
                  throw new InvalidKeySpecException(&quot;Key length not found&quot;);
              } else if (keyLength &lt; 0) {
                  throw new InvalidKeySpecException(&quot;Key length is negative&quot;);
              }
<span class="udiff-line-modified-removed">-             this.prf = Mac.getInstance(prfAlgo);</span>
<span class="udiff-line-removed">-             // SunPKCS11 requires a non-empty PBE password</span>
<span class="udiff-line-removed">-             if (passwdBytes.length == 0 &amp;&amp;</span>
<span class="udiff-line-removed">-                     this.prf.getProvider().getName().startsWith(&quot;SunPKCS11&quot;)) {</span>
<span class="udiff-line-removed">-                 this.prf = Mac.getInstance(prfAlgo, SunJCE.getInstance());</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+             this.prf = Mac.getInstance(prfAlgo, SunJCE.getInstance());</span>
              this.key = deriveKey(prf, passwdBytes, salt, iterCount, keyLength);
          } catch (NoSuchAlgorithmException nsae) {
              // not gonna happen; re-throw just in case
              InvalidKeySpecException ike = new InvalidKeySpecException();
              ike.initCause(nsae);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -149,10 +145,11 @@</span>
              int intR = keyLength - (intL - 1)*hlen; // residue
              byte[] ui = new byte[hlen];
              byte[] ti = new byte[hlen];
              // SecretKeySpec cannot be used, since password can be empty here.
              SecretKey macKey = new SecretKey() {
<span class="udiff-line-added">+                 @java.io.Serial</span>
                  private static final long serialVersionUID = 7874493593505141603L;
                  @Override
                  public String getAlgorithm() {
                      return prf.getAlgorithm();
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -205,11 +202,11 @@</span>
                  } else {
                      System.arraycopy(ti, 0, key, (i-1)*hlen, hlen);
                  }
              }
          } catch (GeneralSecurityException gse) {
<span class="udiff-line-modified-removed">-             throw new RuntimeException(&quot;Error deriving PBKDF2 keys&quot;);</span>
<span class="udiff-line-modified-added">+             throw new RuntimeException(&quot;Error deriving PBKDF2 keys&quot;, gse);</span>
          }
          return key;
      }
  
      public byte[] getEncoded() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -281,10 +278,11 @@</span>
       * @return the standard KeyRep object to be serialized
       *
       * @throws ObjectStreamException if a new object representing
       * this PBE key could not be created
       */
<span class="udiff-line-added">+     @java.io.Serial</span>
      private Object writeReplace() throws ObjectStreamException {
              return new KeyRep(KeyRep.Type.SECRET, getAlgorithm(),
                                getFormat(), getEncoded());
      }
  }
</pre>
<center><a href="PBEWithMD5AndTripleDESCipher.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="RSACipher.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>