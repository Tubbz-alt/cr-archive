<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/com/sun/crypto/provider/KeyProtector.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JceKeyStore.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="OAEPParameters.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/com/sun/crypto/provider/KeyProtector.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 31 import java.security.Provider;
 32 import java.security.KeyFactory;
 33 import java.security.MessageDigest;
 34 import java.security.GeneralSecurityException;
 35 import java.security.NoSuchAlgorithmException;
 36 import java.security.UnrecoverableKeyException;
 37 import java.security.AlgorithmParameters;
 38 import java.security.spec.InvalidParameterSpecException;
 39 import java.security.spec.PKCS8EncodedKeySpec;
 40 import java.util.Arrays;
 41 
 42 import javax.crypto.Cipher;
 43 import javax.crypto.CipherSpi;
 44 import javax.crypto.SecretKey;
 45 import javax.crypto.SealedObject;
 46 import javax.crypto.spec.*;
 47 import javax.security.auth.DestroyFailedException;
 48 
 49 import sun.security.x509.AlgorithmId;
 50 import sun.security.util.ObjectIdentifier;

 51 
 52 /**
 53  * This class implements a protection mechanism for private keys. In JCE, we
 54  * use a stronger protection mechanism than in the JDK, because we can use
 55  * the &lt;code&gt;Cipher&lt;/code&gt; class.
 56  * Private keys are protected using the JCE mechanism, and are recovered using
 57  * either the JDK or JCE mechanism, depending on how the key has been
 58  * protected. This allows us to parse Sun&#39;s keystore implementation that ships
 59  * with JDK 1.2.
 60  *
 61  * @author Jan Luehe
 62  *
 63  *
 64  * @see JceKeyStore
 65  */
 66 
 67 final class KeyProtector {
 68 
 69     // defined by SunSoft (SKI project)
 70     private static final String PBE_WITH_MD5_AND_DES3_CBC_OID
 71             = &quot;1.3.6.1.4.1.42.2.19.1&quot;;
 72 
 73     // JavaSoft proprietary key-protection algorithm (used to protect private
 74     // keys in the keystore implementation that comes with JDK 1.2)
 75     private static final String KEY_PROTECTOR_OID = &quot;1.3.6.1.4.1.42.2.17.1.1&quot;;
 76 
 77     private static final int MAX_ITERATION_COUNT = 5000000;
<span class="line-modified"> 78     private static final int ITERATION_COUNT = 200000;</span>

 79     private static final int SALT_LEN = 20; // the salt length
 80     private static final int DIGEST_LEN = 20;

 81 
 82     // the password used for protecting/recovering keys passed through this
 83     // key protector
 84     private char[] password;
 85 























 86     KeyProtector(char[] password) {
 87         if (password == null) {
 88            throw new IllegalArgumentException(&quot;password can&#39;t be null&quot;);
 89         }
 90         this.password = password;
 91     }
 92 
 93     /**
 94      * Protects the given cleartext private key, using the password provided at
 95      * construction time.
 96      */
 97     byte[] protect(PrivateKey key)
 98         throws Exception
 99     {
100         // create a random salt (8 bytes)
101         byte[] salt = new byte[8];
102         SunJCE.getRandom().nextBytes(salt);
103 
104         // create PBE parameters from salt and iteration count
105         PBEParameterSpec pbeSpec = new PBEParameterSpec(salt, ITERATION_COUNT);
</pre>
</td>
<td>
<hr />
<pre>
 31 import java.security.Provider;
 32 import java.security.KeyFactory;
 33 import java.security.MessageDigest;
 34 import java.security.GeneralSecurityException;
 35 import java.security.NoSuchAlgorithmException;
 36 import java.security.UnrecoverableKeyException;
 37 import java.security.AlgorithmParameters;
 38 import java.security.spec.InvalidParameterSpecException;
 39 import java.security.spec.PKCS8EncodedKeySpec;
 40 import java.util.Arrays;
 41 
 42 import javax.crypto.Cipher;
 43 import javax.crypto.CipherSpi;
 44 import javax.crypto.SecretKey;
 45 import javax.crypto.SealedObject;
 46 import javax.crypto.spec.*;
 47 import javax.security.auth.DestroyFailedException;
 48 
 49 import sun.security.x509.AlgorithmId;
 50 import sun.security.util.ObjectIdentifier;
<span class="line-added"> 51 import sun.security.util.SecurityProperties;</span>
 52 
 53 /**
 54  * This class implements a protection mechanism for private keys. In JCE, we
 55  * use a stronger protection mechanism than in the JDK, because we can use
 56  * the &lt;code&gt;Cipher&lt;/code&gt; class.
 57  * Private keys are protected using the JCE mechanism, and are recovered using
 58  * either the JDK or JCE mechanism, depending on how the key has been
 59  * protected. This allows us to parse Sun&#39;s keystore implementation that ships
 60  * with JDK 1.2.
 61  *
 62  * @author Jan Luehe
 63  *
 64  *
 65  * @see JceKeyStore
 66  */
 67 
 68 final class KeyProtector {
 69 
 70     // defined by SunSoft (SKI project)
 71     private static final String PBE_WITH_MD5_AND_DES3_CBC_OID
 72             = &quot;1.3.6.1.4.1.42.2.19.1&quot;;
 73 
 74     // JavaSoft proprietary key-protection algorithm (used to protect private
 75     // keys in the keystore implementation that comes with JDK 1.2)
 76     private static final String KEY_PROTECTOR_OID = &quot;1.3.6.1.4.1.42.2.17.1.1&quot;;
 77 
 78     private static final int MAX_ITERATION_COUNT = 5000000;
<span class="line-modified"> 79     private static final int MIN_ITERATION_COUNT = 10000;</span>
<span class="line-added"> 80     private static final int DEFAULT_ITERATION_COUNT = 200000;</span>
 81     private static final int SALT_LEN = 20; // the salt length
 82     private static final int DIGEST_LEN = 20;
<span class="line-added"> 83     private static final int ITERATION_COUNT;</span>
 84 
 85     // the password used for protecting/recovering keys passed through this
 86     // key protector
 87     private char[] password;
 88 
<span class="line-added"> 89     /**</span>
<span class="line-added"> 90      * {@systemProperty jdk.jceks.iterationCount} property indicating the</span>
<span class="line-added"> 91      * number of iterations for password-based encryption (PBE) in JCEKS</span>
<span class="line-added"> 92      * keystores. Values in the range 10000 to 5000000 are considered valid.</span>
<span class="line-added"> 93      * If the value is out of this range, or is not a number, or is</span>
<span class="line-added"> 94      * unspecified; a default of 200000 is used.</span>
<span class="line-added"> 95      */</span>
<span class="line-added"> 96     static {</span>
<span class="line-added"> 97         int iterationCount = DEFAULT_ITERATION_COUNT;</span>
<span class="line-added"> 98         String ic = SecurityProperties.privilegedGetOverridable(</span>
<span class="line-added"> 99                 &quot;jdk.jceks.iterationCount&quot;);</span>
<span class="line-added">100         if (ic != null &amp;&amp; !ic.isEmpty()) {</span>
<span class="line-added">101             try {</span>
<span class="line-added">102                 iterationCount = Integer.parseInt(ic);</span>
<span class="line-added">103                 if (iterationCount &lt; MIN_ITERATION_COUNT ||</span>
<span class="line-added">104                         iterationCount &gt; MAX_ITERATION_COUNT) {</span>
<span class="line-added">105                     iterationCount = DEFAULT_ITERATION_COUNT;</span>
<span class="line-added">106                 }</span>
<span class="line-added">107             } catch (NumberFormatException e) {}</span>
<span class="line-added">108         }</span>
<span class="line-added">109         ITERATION_COUNT = iterationCount;</span>
<span class="line-added">110     }</span>
<span class="line-added">111 </span>
112     KeyProtector(char[] password) {
113         if (password == null) {
114            throw new IllegalArgumentException(&quot;password can&#39;t be null&quot;);
115         }
116         this.password = password;
117     }
118 
119     /**
120      * Protects the given cleartext private key, using the password provided at
121      * construction time.
122      */
123     byte[] protect(PrivateKey key)
124         throws Exception
125     {
126         // create a random salt (8 bytes)
127         byte[] salt = new byte[8];
128         SunJCE.getRandom().nextBytes(salt);
129 
130         // create PBE parameters from salt and iteration count
131         PBEParameterSpec pbeSpec = new PBEParameterSpec(salt, ITERATION_COUNT);
</pre>
</td>
</tr>
</table>
<center><a href="JceKeyStore.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="OAEPParameters.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>