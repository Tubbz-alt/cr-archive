<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/javax/net/ssl/SSLSocketFactory.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SSLSessionContext.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TrustManagerFactory.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/javax/net/ssl/SSLSocketFactory.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 25 
 26 
 27 package javax.net.ssl;
 28 
 29 import java.net.*;
 30 import javax.net.SocketFactory;
 31 import java.io.IOException;
 32 import java.io.InputStream;
 33 import java.security.*;
 34 import java.util.Locale;
 35 
 36 import sun.security.action.GetPropertyAction;
 37 
 38 /**
 39  * &lt;code&gt;SSLSocketFactory&lt;/code&gt;s create &lt;code&gt;SSLSocket&lt;/code&gt;s.
 40  *
 41  * @since 1.4
 42  * @see SSLSocket
 43  * @author David Brownell
 44  */
<span class="line-modified"> 45 public abstract class SSLSocketFactory extends SocketFactory</span>
<span class="line-removed"> 46 {</span>
<span class="line-removed"> 47     private static SSLSocketFactory theFactory;</span>
<span class="line-removed"> 48 </span>
<span class="line-removed"> 49     private static boolean propertyChecked;</span>
<span class="line-removed"> 50 </span>
 51     static final boolean DEBUG;
 52 
 53     static {
<span class="line-modified"> 54         String s = GetPropertyAction.privilegedGetProperty(&quot;javax.net.debug&quot;, &quot;&quot;)</span>
<span class="line-modified"> 55                 .toLowerCase(Locale.ENGLISH);</span>
<span class="line-removed"> 56 </span>
 57         DEBUG = s.contains(&quot;all&quot;) || s.contains(&quot;ssl&quot;);
 58     }
 59 
<span class="line-removed"> 60     private static void log(String msg) {</span>
<span class="line-removed"> 61         if (DEBUG) {</span>
<span class="line-removed"> 62             System.out.println(msg);</span>
<span class="line-removed"> 63         }</span>
<span class="line-removed"> 64     }</span>
<span class="line-removed"> 65 </span>
 66     /**
 67      * Constructor is used only by subclasses.
 68      */
 69     public SSLSocketFactory() {

 70     }
 71 
 72     /**
 73      * Returns the default SSL socket factory.
 74      *
 75      * &lt;p&gt;The first time this method is called, the security property
 76      * &quot;ssl.SocketFactory.provider&quot; is examined. If it is non-null, a class by
 77      * that name is loaded and instantiated. If that is successful and the
 78      * object is an instance of SSLSocketFactory, it is made the default SSL
 79      * socket factory.
 80      *
 81      * &lt;p&gt;Otherwise, this method returns
 82      * &lt;code&gt;SSLContext.getDefault().getSocketFactory()&lt;/code&gt;. If that
 83      * call fails, an inoperative factory is returned.
 84      *
 85      * @return the default &lt;code&gt;SocketFactory&lt;/code&gt;
 86      * @see SSLContext#getDefault
 87      */
<span class="line-modified"> 88     public static synchronized SocketFactory getDefault() {</span>
<span class="line-modified"> 89         if (theFactory != null) {</span>
<span class="line-modified"> 90             return theFactory;</span>
<span class="line-removed"> 91         }</span>
<span class="line-removed"> 92 </span>
<span class="line-removed"> 93         if (propertyChecked == false) {</span>
<span class="line-removed"> 94             propertyChecked = true;</span>
<span class="line-removed"> 95             String clsName = getSecurityProperty(&quot;ssl.SocketFactory.provider&quot;);</span>
<span class="line-removed"> 96             if (clsName != null) {</span>
<span class="line-removed"> 97                 log(&quot;setting up default SSLSocketFactory&quot;);</span>
<span class="line-removed"> 98                 try {</span>
<span class="line-removed"> 99                     Class&lt;?&gt; cls = null;</span>
<span class="line-removed">100                     try {</span>
<span class="line-removed">101                         cls = Class.forName(clsName);</span>
<span class="line-removed">102                     } catch (ClassNotFoundException e) {</span>
<span class="line-removed">103                         ClassLoader cl = ClassLoader.getSystemClassLoader();</span>
<span class="line-removed">104                         if (cl != null) {</span>
<span class="line-removed">105                             cls = cl.loadClass(clsName);</span>
<span class="line-removed">106                         }</span>
<span class="line-removed">107                     }</span>
<span class="line-removed">108                     log(&quot;class &quot; + clsName + &quot; is loaded&quot;);</span>
<span class="line-removed">109                     @SuppressWarnings(&quot;deprecation&quot;)</span>
<span class="line-removed">110                     SSLSocketFactory fac = (SSLSocketFactory)cls.newInstance();</span>
<span class="line-removed">111                     log(&quot;instantiated an instance of class &quot; + clsName);</span>
<span class="line-removed">112                     theFactory = fac;</span>
<span class="line-removed">113                     return fac;</span>
<span class="line-removed">114                 } catch (Exception e) {</span>
<span class="line-removed">115                     log(&quot;SSLSocketFactory instantiation failed: &quot; + e.toString());</span>
<span class="line-removed">116                     theFactory = new DefaultSSLSocketFactory(e);</span>
<span class="line-removed">117                     return theFactory;</span>
<span class="line-removed">118                 }</span>
<span class="line-removed">119             }</span>
120         }
121 
122         try {
123             return SSLContext.getDefault().getSocketFactory();
124         } catch (NoSuchAlgorithmException | UnsupportedOperationException e) {
125             return new DefaultSSLSocketFactory(e);
126         }
127     }
128 
129     static String getSecurityProperty(final String name) {
130         return AccessController.doPrivileged(new PrivilegedAction&lt;&gt;() {
131             @Override
132             public String run() {
133                 String s = java.security.Security.getProperty(name);
134                 if (s != null) {
135                     s = s.trim();
136                     if (s.isEmpty()) {
137                         s = null;
138                     }
139                 }
</pre>
<hr />
<pre>
229      *         the consumed inbound network data that has already been
230      *         removed from the existing {@link Socket}
231      *         {@link InputStream}.  This parameter may be
232      *         {@code null} if no data has been removed.
233      * @param  autoClose close the underlying socket when this socket is closed.
234      *
235      * @return the {@link Socket} compliant with the socket options
236      *         established for this factory
237      *
238      * @throws IOException if an I/O error occurs when creating the socket
239      * @throws UnsupportedOperationException if the underlying provider
240      *         does not implement the operation
241      * @throws NullPointerException if {@code s} is {@code null}
242      *
243      * @since 1.8
244      */
245     public Socket createSocket(Socket s, InputStream consumed,
246             boolean autoClose) throws IOException {
247         throw new UnsupportedOperationException();
248     }











































249 }
250 
251 
252 // file private
253 class DefaultSSLSocketFactory extends SSLSocketFactory
254 {
255     private Exception reason;
256 
257     DefaultSSLSocketFactory(Exception reason) {
258         this.reason = reason;
259     }
260 
261     private Socket throwException() throws SocketException {
262         throw (SocketException)
263             new SocketException(reason.toString()).initCause(reason);
264     }
265 
266     @Override
267     public Socket createSocket()
268     throws IOException
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 25 
 26 
 27 package javax.net.ssl;
 28 
 29 import java.net.*;
 30 import javax.net.SocketFactory;
 31 import java.io.IOException;
 32 import java.io.InputStream;
 33 import java.security.*;
 34 import java.util.Locale;
 35 
 36 import sun.security.action.GetPropertyAction;
 37 
 38 /**
 39  * &lt;code&gt;SSLSocketFactory&lt;/code&gt;s create &lt;code&gt;SSLSocket&lt;/code&gt;s.
 40  *
 41  * @since 1.4
 42  * @see SSLSocket
 43  * @author David Brownell
 44  */
<span class="line-modified"> 45 public abstract class SSLSocketFactory extends SocketFactory {</span>





 46     static final boolean DEBUG;
 47 
 48     static {
<span class="line-modified"> 49         String s = GetPropertyAction.privilegedGetProperty(</span>
<span class="line-modified"> 50                 &quot;javax.net.debug&quot;, &quot;&quot;).toLowerCase(Locale.ENGLISH);</span>

 51         DEBUG = s.contains(&quot;all&quot;) || s.contains(&quot;ssl&quot;);
 52     }
 53 






 54     /**
 55      * Constructor is used only by subclasses.
 56      */
 57     public SSLSocketFactory() {
<span class="line-added"> 58         // blank</span>
 59     }
 60 
 61     /**
 62      * Returns the default SSL socket factory.
 63      *
 64      * &lt;p&gt;The first time this method is called, the security property
 65      * &quot;ssl.SocketFactory.provider&quot; is examined. If it is non-null, a class by
 66      * that name is loaded and instantiated. If that is successful and the
 67      * object is an instance of SSLSocketFactory, it is made the default SSL
 68      * socket factory.
 69      *
 70      * &lt;p&gt;Otherwise, this method returns
 71      * &lt;code&gt;SSLContext.getDefault().getSocketFactory()&lt;/code&gt;. If that
 72      * call fails, an inoperative factory is returned.
 73      *
 74      * @return the default &lt;code&gt;SocketFactory&lt;/code&gt;
 75      * @see SSLContext#getDefault
 76      */
<span class="line-modified"> 77     public static SocketFactory getDefault() {</span>
<span class="line-modified"> 78         if (DefaultFactoryHolder.defaultFactory != null) {</span>
<span class="line-modified"> 79             return DefaultFactoryHolder.defaultFactory;</span>





























 80         }
 81 
 82         try {
 83             return SSLContext.getDefault().getSocketFactory();
 84         } catch (NoSuchAlgorithmException | UnsupportedOperationException e) {
 85             return new DefaultSSLSocketFactory(e);
 86         }
 87     }
 88 
 89     static String getSecurityProperty(final String name) {
 90         return AccessController.doPrivileged(new PrivilegedAction&lt;&gt;() {
 91             @Override
 92             public String run() {
 93                 String s = java.security.Security.getProperty(name);
 94                 if (s != null) {
 95                     s = s.trim();
 96                     if (s.isEmpty()) {
 97                         s = null;
 98                     }
 99                 }
</pre>
<hr />
<pre>
189      *         the consumed inbound network data that has already been
190      *         removed from the existing {@link Socket}
191      *         {@link InputStream}.  This parameter may be
192      *         {@code null} if no data has been removed.
193      * @param  autoClose close the underlying socket when this socket is closed.
194      *
195      * @return the {@link Socket} compliant with the socket options
196      *         established for this factory
197      *
198      * @throws IOException if an I/O error occurs when creating the socket
199      * @throws UnsupportedOperationException if the underlying provider
200      *         does not implement the operation
201      * @throws NullPointerException if {@code s} is {@code null}
202      *
203      * @since 1.8
204      */
205     public Socket createSocket(Socket s, InputStream consumed,
206             boolean autoClose) throws IOException {
207         throw new UnsupportedOperationException();
208     }
<span class="line-added">209 </span>
<span class="line-added">210     // lazy initialization holder class idiom for static default factory</span>
<span class="line-added">211     //</span>
<span class="line-added">212     // See Effective Java Second Edition: Item 71.</span>
<span class="line-added">213     private static final class DefaultFactoryHolder {</span>
<span class="line-added">214         private static final SSLSocketFactory defaultFactory;</span>
<span class="line-added">215 </span>
<span class="line-added">216         static {</span>
<span class="line-added">217             SSLSocketFactory mediator = null;</span>
<span class="line-added">218             String clsName = getSecurityProperty(&quot;ssl.SocketFactory.provider&quot;);</span>
<span class="line-added">219             if (clsName != null) {</span>
<span class="line-added">220                 log(&quot;setting up default SSLSocketFactory&quot;);</span>
<span class="line-added">221                 try {</span>
<span class="line-added">222                     Class&lt;?&gt; cls = null;</span>
<span class="line-added">223                     try {</span>
<span class="line-added">224                         cls = Class.forName(clsName);</span>
<span class="line-added">225                     } catch (ClassNotFoundException e) {</span>
<span class="line-added">226                         ClassLoader cl = ClassLoader.getSystemClassLoader();</span>
<span class="line-added">227                         if (cl != null) {</span>
<span class="line-added">228                             cls = cl.loadClass(clsName);</span>
<span class="line-added">229                         }</span>
<span class="line-added">230                     }</span>
<span class="line-added">231                     log(&quot;class &quot; + clsName + &quot; is loaded&quot;);</span>
<span class="line-added">232 </span>
<span class="line-added">233                     mediator = (SSLSocketFactory)cls</span>
<span class="line-added">234                             .getDeclaredConstructor().newInstance();</span>
<span class="line-added">235 </span>
<span class="line-added">236                     log(&quot;instantiated an instance of class &quot; + clsName);</span>
<span class="line-added">237                 } catch (Exception e) {</span>
<span class="line-added">238                     log(&quot;SSLSocketFactory instantiation failed: &quot; + e);</span>
<span class="line-added">239                     mediator = new DefaultSSLSocketFactory(e);</span>
<span class="line-added">240                 }</span>
<span class="line-added">241             }</span>
<span class="line-added">242 </span>
<span class="line-added">243             defaultFactory = mediator;</span>
<span class="line-added">244         }</span>
<span class="line-added">245 </span>
<span class="line-added">246         private static void log(String msg) {</span>
<span class="line-added">247             if (DEBUG) {</span>
<span class="line-added">248                 System.out.println(msg);</span>
<span class="line-added">249             }</span>
<span class="line-added">250         }</span>
<span class="line-added">251     }</span>
252 }
253 
254 
255 // file private
256 class DefaultSSLSocketFactory extends SSLSocketFactory
257 {
258     private Exception reason;
259 
260     DefaultSSLSocketFactory(Exception reason) {
261         this.reason = reason;
262     }
263 
264     private Socket throwException() throws SocketException {
265         throw (SocketException)
266             new SocketException(reason.toString()).initCause(reason);
267     }
268 
269     @Override
270     public Socket createSocket()
271     throws IOException
</pre>
</td>
</tr>
</table>
<center><a href="SSLSessionContext.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TrustManagerFactory.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>