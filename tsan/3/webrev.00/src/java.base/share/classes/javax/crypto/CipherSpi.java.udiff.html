<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/share/classes/javax/crypto/CipherSpi.java</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="Cipher.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="CryptoAllPermission.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/javax/crypto/CipherSpi.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -759,82 +759,91 @@</span>
          if (output.remaining() &lt; outLenNeeded) {
              throw new ShortBufferException(&quot;Need at least &quot; + outLenNeeded
                  + &quot; bytes of space in output buffer&quot;);
          }
  
<span class="udiff-line-added">+         // detecting input and output buffer overlap may be tricky</span>
<span class="udiff-line-added">+         // we can only write directly into output buffer when we</span>
<span class="udiff-line-added">+         // are 100% sure it&#39;s safe to do so</span>
<span class="udiff-line-added">+ </span>
          boolean a1 = input.hasArray();
          boolean a2 = output.hasArray();
          int total = 0;
<span class="udiff-line-removed">-         byte[] inArray, outArray;</span>
<span class="udiff-line-removed">-         if (a2) { // output has an accessible byte[]</span>
<span class="udiff-line-removed">-             outArray = output.array();</span>
<span class="udiff-line-removed">-             int outPos = output.position();</span>
<span class="udiff-line-removed">-             int outOfs = output.arrayOffset() + outPos;</span>
  
<span class="udiff-line-modified-removed">-             if (a1) { // input also has an accessible byte[]</span>
<span class="udiff-line-modified-removed">-                 inArray = input.array();</span>
<span class="udiff-line-modified-removed">-                 int inOfs = input.arrayOffset() + inPos;</span>
<span class="udiff-line-modified-added">+         if (a1) { // input has an accessible byte[]</span>
<span class="udiff-line-modified-added">+             byte[] inArray = input.array();</span>
<span class="udiff-line-modified-added">+             int inOfs = input.arrayOffset() + inPos;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (a2) { // output has an accessible byte[]</span>
<span class="udiff-line-added">+                 byte[] outArray = output.array();</span>
<span class="udiff-line-added">+                 int outPos = output.position();</span>
<span class="udiff-line-added">+                 int outOfs = output.arrayOffset() + outPos;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 // check array address and offsets and use temp output buffer</span>
<span class="udiff-line-added">+                 // if output offset is larger than input offset and</span>
<span class="udiff-line-added">+                 // falls within the range of input data</span>
<span class="udiff-line-added">+                 boolean useTempOut = false;</span>
<span class="udiff-line-added">+                 if (inArray == outArray &amp;&amp;</span>
<span class="udiff-line-added">+                     ((inOfs &lt; outOfs) &amp;&amp; (outOfs &lt; inOfs + inLen))) {</span>
<span class="udiff-line-added">+                     useTempOut = true;</span>
<span class="udiff-line-added">+                     outArray = new byte[outLenNeeded];</span>
<span class="udiff-line-added">+                     outOfs = 0;</span>
<span class="udiff-line-added">+                 }</span>
                  if (isUpdate) {
                      total = engineUpdate(inArray, inOfs, inLen, outArray, outOfs);
                  } else {
                      total = engineDoFinal(inArray, inOfs, inLen, outArray, outOfs);
                  }
<span class="udiff-line-added">+                 if (useTempOut) {</span>
<span class="udiff-line-added">+                     output.put(outArray, outOfs, total);</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     // adjust output position manually</span>
<span class="udiff-line-added">+                     output.position(outPos + total);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 // adjust input position manually</span>
                  input.position(inLimit);
<span class="udiff-line-modified-removed">-             } else { // input does not have accessible byte[]</span>
<span class="udiff-line-modified-removed">-                 inArray = new byte[getTempArraySize(inLen)];</span>
<span class="udiff-line-removed">-                 do {</span>
<span class="udiff-line-removed">-                     int chunk = Math.min(inLen, inArray.length);</span>
<span class="udiff-line-removed">-                     if (chunk &gt; 0) {</span>
<span class="udiff-line-removed">-                         input.get(inArray, 0, chunk);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     int n;</span>
<span class="udiff-line-removed">-                     if (isUpdate || (inLen &gt; chunk)) {</span>
<span class="udiff-line-removed">-                         n = engineUpdate(inArray, 0, chunk, outArray, outOfs);</span>
<span class="udiff-line-removed">-                     } else {</span>
<span class="udiff-line-removed">-                         n = engineDoFinal(inArray, 0, chunk, outArray, outOfs);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     total += n;</span>
<span class="udiff-line-removed">-                     outOfs += n;</span>
<span class="udiff-line-removed">-                     inLen -= chunk;</span>
<span class="udiff-line-removed">-                 } while (inLen &gt; 0);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             output.position(outPos + total);</span>
<span class="udiff-line-removed">-         } else { // output does not have an accessible byte[]</span>
<span class="udiff-line-removed">-             if (a1) { // but input has an accessible byte[]</span>
<span class="udiff-line-removed">-                 inArray = input.array();</span>
<span class="udiff-line-removed">-                 int inOfs = input.arrayOffset() + inPos;</span>
<span class="udiff-line-modified-added">+             } else { // output does not have an accessible byte[]</span>
<span class="udiff-line-modified-added">+                 byte[] outArray = null;</span>
                  if (isUpdate) {
                      outArray = engineUpdate(inArray, inOfs, inLen);
                  } else {
                      outArray = engineDoFinal(inArray, inOfs, inLen);
                  }
<span class="udiff-line-removed">-                 input.position(inLimit);</span>
                  if (outArray != null &amp;&amp; outArray.length != 0) {
                      output.put(outArray);
                      total = outArray.length;
                  }
<span class="udiff-line-modified-removed">-             } else { // input also does not have an accessible byte[]</span>
<span class="udiff-line-modified-removed">-                 inArray = new byte[getTempArraySize(inLen)];</span>
<span class="udiff-line-modified-removed">-                 do {</span>
<span class="udiff-line-modified-removed">-                     int chunk = Math.min(inLen, inArray.length);</span>
<span class="udiff-line-modified-removed">-                     if (chunk &gt; 0) {</span>
<span class="udiff-line-modified-removed">-                         input.get(inArray, 0, chunk);</span>
<span class="udiff-line-modified-removed">-                     }</span>
<span class="udiff-line-modified-removed">-                     int n;</span>
<span class="udiff-line-modified-removed">-                     if (isUpdate || (inLen &gt; chunk)) {</span>
<span class="udiff-line-modified-removed">-                         outArray = engineUpdate(inArray, 0, chunk);</span>
<span class="udiff-line-modified-removed">-                     } else {</span>
<span class="udiff-line-modified-removed">-                         outArray = engineDoFinal(inArray, 0, chunk);</span>
<span class="udiff-line-modified-removed">-                     }</span>
<span class="udiff-line-modified-removed">-                     if (outArray != null &amp;&amp; outArray.length != 0) {</span>
<span class="udiff-line-modified-removed">-                         output.put(outArray);</span>
<span class="udiff-line-modified-removed">-                         total += outArray.length;</span>
<span class="udiff-line-modified-removed">-                     }</span>
<span class="udiff-line-modified-removed">-                     inLen -= chunk;</span>
<span class="udiff-line-modified-removed">-                 } while (inLen &gt; 0);</span>
<span class="udiff-line-modified-added">+                 // adjust input position manually</span>
<span class="udiff-line-modified-added">+                 input.position(inLimit);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+         } else { // input does not have an accessible byte[]</span>
<span class="udiff-line-modified-added">+             // have to assume the worst, since we have no way of determine</span>
<span class="udiff-line-modified-added">+             // if input and output overlaps or not</span>
<span class="udiff-line-modified-added">+             byte[] tempOut = new byte[outLenNeeded];</span>
<span class="udiff-line-modified-added">+             int outOfs = 0;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             byte[] tempIn = new byte[getTempArraySize(inLen)];</span>
<span class="udiff-line-modified-added">+             do {</span>
<span class="udiff-line-modified-added">+                 int chunk = Math.min(inLen, tempIn.length);</span>
<span class="udiff-line-modified-added">+                 if (chunk &gt; 0) {</span>
<span class="udiff-line-modified-added">+                     input.get(tempIn, 0, chunk);</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-modified-added">+                 int n;</span>
<span class="udiff-line-modified-added">+                 if (isUpdate || (inLen &gt; chunk)) {</span>
<span class="udiff-line-modified-added">+                     n = engineUpdate(tempIn, 0, chunk, tempOut, outOfs);</span>
<span class="udiff-line-modified-added">+                 } else {</span>
<span class="udiff-line-added">+                     n = engineDoFinal(tempIn, 0, chunk, tempOut, outOfs);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 outOfs += n;</span>
<span class="udiff-line-added">+                 total += n;</span>
<span class="udiff-line-added">+                 inLen -= chunk;</span>
<span class="udiff-line-added">+             } while (inLen &gt; 0);</span>
<span class="udiff-line-added">+             if (total &gt; 0) {</span>
<span class="udiff-line-added">+                 output.put(tempOut, 0, total);</span>
              }
          }
<span class="udiff-line-added">+ </span>
          return total;
      }
  
      /**
       * Wrap a key.
</pre>
<center><a href="Cipher.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="CryptoAllPermission.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>