<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/share/classes/javax/crypto/JceSecurity.java.template</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="IllegalBlockSizeException.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="KeyGenerator.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/share/classes/javax/crypto/JceSecurity.java.template</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 33  * @@JCE_DEFAULT_POLICY@ [sic] with &quot;limited&quot; or &quot;unlimited&quot; which is
 34  * determined by the $(UNLIMTED_CRYPTO) make variable.  This variable is
 35  * set by top-level configure script, using either
 36  * --disable-unlimited-crypto or --enable-unlimited-crypto [default].
 37  *
 38  * Since this file is a generated source, incremental changes to
 39  * this file require regenerating the source.  Compilation options:
 40  *
 41  *     (fewer dependencies/&quot;faster&quot; ones first)
 42  *
 43  * 1.  make JDK_FILTER=javax/crypto java.base-gensrc-only java.base-java-only
 44  * 2.  make java.base-gensrc-only java.base-java-only
 45  * 3.  make java.base-gensrc-only java.base-only
 46  * 4.  make java.base-only
 47  * 5.  make
 48  */
 49 
 50 package javax.crypto;
 51 
 52 import java.util.*;

 53 import java.io.*;
 54 import java.net.URL;
 55 import java.nio.file.*;
 56 import java.security.*;
 57 
 58 import java.security.Provider.Service;
 59 
 60 import jdk.internal.util.StaticProperty;
 61 
 62 import sun.security.jca.*;
 63 import sun.security.jca.GetInstance.Instance;
 64 import sun.security.util.Debug;
 65 
 66 /**
 67  * This class instantiates implementations of JCE engine classes from
 68  * providers registered with the java.security.Security object.
 69  *
 70  * @author Jan Luehe
 71  * @author Sharon Liu
 72  * @since 1.4
 73  */
 74 
 75 final class JceSecurity {
 76 
 77 
 78     private static final Debug debug = Debug.getInstance(&quot;jca&quot;);
 79 
 80     static final SecureRandom RANDOM = new SecureRandom();
 81 
 82     // The defaultPolicy and exemptPolicy will be set up
 83     // in the static initializer.
 84     private static CryptoPermissions defaultPolicy = null;
 85     private static CryptoPermissions exemptPolicy = null;
 86 
<span class="line-modified"> 87     // Map&lt;Provider,?&gt; of the providers we already have verified</span>
<span class="line-modified"> 88     // value == PROVIDER_VERIFIED is successfully verified</span>
<span class="line-modified"> 89     // value is failure cause Exception in error case</span>
<span class="line-modified"> 90     private static final Map&lt;Provider, Object&gt; verificationResults =</span>
<span class="line-modified"> 91             new IdentityHashMap&lt;&gt;();</span>
 92 
 93     // Map&lt;Provider,?&gt; of the providers currently being verified
 94     private static final Map&lt;Provider, Object&gt; verifyingProviders =
 95             new IdentityHashMap&lt;&gt;();
 96 
 97     private static final boolean isRestricted;
 98 
 99     /*
100      * Don&#39;t let anyone instantiate this.
101      */
102     private JceSecurity() {
103     }
104 
105     static {
106         try {
107             AccessController.doPrivileged(
108                 new PrivilegedExceptionAction&lt;&gt; () {
109                     @Override
110                     public Void run() throws Exception {
111                         setupJurisdictionPolicies();
</pre>
<hr />
<pre>
182     /**
183      * Verify if the JAR at URL codeBase is a signed provider JAR file.
184      *
185      * @throws Exception on error
186      */
187     static void verifyProvider(URL codeBase, Provider p) throws Exception {
188         // Verify the provider JAR file and all
189         // supporting JAR files if there are any.
190         ProviderVerifier pv = new ProviderVerifier(codeBase, p, false);
191         pv.verify();
192     }
193 
194     private static final Object PROVIDER_VERIFIED = Boolean.TRUE;
195 
196     /*
197      * Verify that the provider JAR files are signed properly, which
198      * means the signer&#39;s certificate can be traced back to a
199      * JCE trusted CA.
200      * Return null if ok, failure Exception if verification failed.
201      */
<span class="line-modified">202     static synchronized Exception getVerificationResult(Provider p) {</span>
<span class="line-modified">203         Object o = verificationResults.get(p);</span>
<span class="line-modified">204         if (o == PROVIDER_VERIFIED) {</span>
<span class="line-modified">205             return null;</span>
<span class="line-modified">206         } else if (o != null) {</span>
<span class="line-modified">207             return (Exception)o;</span>
<span class="line-modified">208         }</span>
<span class="line-modified">209         if (verifyingProviders.get(p) != null) {</span>
<span class="line-modified">210             // this method is static synchronized, must be recursion</span>
<span class="line-modified">211             // return failure now but do not save the result</span>
<span class="line-modified">212             return new NoSuchProviderException(&quot;Recursion during verification&quot;);</span>
<span class="line-modified">213         }</span>
<span class="line-modified">214         try {</span>
<span class="line-modified">215             verifyingProviders.put(p, Boolean.FALSE);</span>
<span class="line-modified">216             URL providerURL = getCodeBase(p.getClass());</span>
<span class="line-modified">217             verifyProvider(providerURL, p);</span>
<span class="line-modified">218             // Verified ok, cache result</span>
<span class="line-modified">219             verificationResults.put(p, PROVIDER_VERIFIED);</span>
<span class="line-modified">220             return null;</span>
<span class="line-modified">221         } catch (Exception e) {</span>
<span class="line-modified">222             verificationResults.put(p, e);</span>
<span class="line-modified">223             return e;</span>
<span class="line-modified">224         } finally {</span>
<span class="line-modified">225             verifyingProviders.remove(p);</span>







226         }

227     }
228 
229     // return whether this provider is properly signed and can be used by JCE
230     static boolean canUseProvider(Provider p) {
231         return getVerificationResult(p) == null;
232     }
233 
234     // dummy object to represent null
235     private static final URL NULL_URL;
236 
237     static {
238         try {
239             NULL_URL = new URL(&quot;http://null.oracle.com/&quot;);
240         } catch (Exception e) {
241             throw new RuntimeException(e);
242         }
243     }
244 
245     // reference to a Map we use as a cache for codebases
246     private static final Map&lt;Class&lt;?&gt;, URL&gt; codeBaseCacheRef =
</pre>
<hr />
<pre>
374                 cryptoPolicyProperty);
375         }
376 
377         // If there was an empty exempt policy file, ignore it.
378         if ((exemptPolicy != null) &amp;&amp; exemptPolicy.isEmpty()) {
379             exemptPolicy = null;
380         }
381     }
382 
383     static CryptoPermissions getDefaultPolicy() {
384         return defaultPolicy;
385     }
386 
387     static CryptoPermissions getExemptPolicy() {
388         return exemptPolicy;
389     }
390 
391     static boolean isRestricted() {
392         return isRestricted;
393     }

























394 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 33  * @@JCE_DEFAULT_POLICY@ [sic] with &quot;limited&quot; or &quot;unlimited&quot; which is
 34  * determined by the $(UNLIMTED_CRYPTO) make variable.  This variable is
 35  * set by top-level configure script, using either
 36  * --disable-unlimited-crypto or --enable-unlimited-crypto [default].
 37  *
 38  * Since this file is a generated source, incremental changes to
 39  * this file require regenerating the source.  Compilation options:
 40  *
 41  *     (fewer dependencies/&quot;faster&quot; ones first)
 42  *
 43  * 1.  make JDK_FILTER=javax/crypto java.base-gensrc-only java.base-java-only
 44  * 2.  make java.base-gensrc-only java.base-java-only
 45  * 3.  make java.base-gensrc-only java.base-only
 46  * 4.  make java.base-only
 47  * 5.  make
 48  */
 49 
 50 package javax.crypto;
 51 
 52 import java.util.*;
<span class="line-added"> 53 import java.util.concurrent.ConcurrentHashMap;</span>
 54 import java.io.*;
 55 import java.net.URL;
 56 import java.nio.file.*;
 57 import java.security.*;
 58 
 59 import java.security.Provider.Service;
 60 
 61 import jdk.internal.util.StaticProperty;
 62 
 63 import sun.security.jca.*;
 64 import sun.security.jca.GetInstance.Instance;
 65 import sun.security.util.Debug;
 66 
 67 /**
 68  * This class instantiates implementations of JCE engine classes from
 69  * providers registered with the java.security.Security object.
 70  *
 71  * @author Jan Luehe
 72  * @author Sharon Liu
 73  * @since 1.4
 74  */
 75 
 76 final class JceSecurity {
 77 
 78 
 79     private static final Debug debug = Debug.getInstance(&quot;jca&quot;);
 80 
 81     static final SecureRandom RANDOM = new SecureRandom();
 82 
 83     // The defaultPolicy and exemptPolicy will be set up
 84     // in the static initializer.
 85     private static CryptoPermissions defaultPolicy = null;
 86     private static CryptoPermissions exemptPolicy = null;
 87 
<span class="line-modified"> 88     // Map of the providers we already have verified.</span>
<span class="line-modified"> 89     // If verified ok, value == PROVIDER_VERIFIED, otherwise</span>
<span class="line-modified"> 90     // the cause of verification failure is stored as value.</span>
<span class="line-modified"> 91     private static final Map&lt;IdentityWrapper, Object&gt;</span>
<span class="line-modified"> 92         verificationResults = new ConcurrentHashMap&lt;&gt;();</span>
 93 
 94     // Map&lt;Provider,?&gt; of the providers currently being verified
 95     private static final Map&lt;Provider, Object&gt; verifyingProviders =
 96             new IdentityHashMap&lt;&gt;();
 97 
 98     private static final boolean isRestricted;
 99 
100     /*
101      * Don&#39;t let anyone instantiate this.
102      */
103     private JceSecurity() {
104     }
105 
106     static {
107         try {
108             AccessController.doPrivileged(
109                 new PrivilegedExceptionAction&lt;&gt; () {
110                     @Override
111                     public Void run() throws Exception {
112                         setupJurisdictionPolicies();
</pre>
<hr />
<pre>
183     /**
184      * Verify if the JAR at URL codeBase is a signed provider JAR file.
185      *
186      * @throws Exception on error
187      */
188     static void verifyProvider(URL codeBase, Provider p) throws Exception {
189         // Verify the provider JAR file and all
190         // supporting JAR files if there are any.
191         ProviderVerifier pv = new ProviderVerifier(codeBase, p, false);
192         pv.verify();
193     }
194 
195     private static final Object PROVIDER_VERIFIED = Boolean.TRUE;
196 
197     /*
198      * Verify that the provider JAR files are signed properly, which
199      * means the signer&#39;s certificate can be traced back to a
200      * JCE trusted CA.
201      * Return null if ok, failure Exception if verification failed.
202      */
<span class="line-modified">203     static Exception getVerificationResult(Provider p) {</span>
<span class="line-modified">204         IdentityWrapper pKey = new IdentityWrapper(p);</span>
<span class="line-modified">205         Object o = verificationResults.get(pKey);</span>
<span class="line-modified">206         // no mapping found</span>
<span class="line-modified">207         if (o == null) {</span>
<span class="line-modified">208             synchronized (JceSecurity.class) {</span>
<span class="line-modified">209                 // check cache again in case the result is now available</span>
<span class="line-modified">210                 o = verificationResults.get(pKey);</span>
<span class="line-modified">211                 if (o == null) {</span>
<span class="line-modified">212                     if (verifyingProviders.get(p) != null) {</span>
<span class="line-modified">213                         // recursion; return failure now</span>
<span class="line-modified">214                         return new NoSuchProviderException</span>
<span class="line-modified">215                                 (&quot;Recursion during verification&quot;);</span>
<span class="line-modified">216                     }</span>
<span class="line-modified">217                     try {</span>
<span class="line-modified">218                         verifyingProviders.put(p, Boolean.FALSE);</span>
<span class="line-modified">219                         URL providerURL = getCodeBase(p.getClass());</span>
<span class="line-modified">220                         verifyProvider(providerURL, p);</span>
<span class="line-modified">221                         o = PROVIDER_VERIFIED;</span>
<span class="line-modified">222                     } catch (Exception e) {</span>
<span class="line-modified">223                         o = e;</span>
<span class="line-modified">224                     } finally {</span>
<span class="line-modified">225                         verifyingProviders.remove(p);</span>
<span class="line-modified">226                     }</span>
<span class="line-added">227                     verificationResults.put(pKey, o);</span>
<span class="line-added">228                     if (debug != null) {</span>
<span class="line-added">229                         debug.println(&quot;Provider &quot; + p.getName() +</span>
<span class="line-added">230                                 &quot; verification result: &quot; + o);</span>
<span class="line-added">231                     }</span>
<span class="line-added">232                 }</span>
<span class="line-added">233             }</span>
234         }
<span class="line-added">235         return (o == PROVIDER_VERIFIED? null : (Exception) o);</span>
236     }
237 
238     // return whether this provider is properly signed and can be used by JCE
239     static boolean canUseProvider(Provider p) {
240         return getVerificationResult(p) == null;
241     }
242 
243     // dummy object to represent null
244     private static final URL NULL_URL;
245 
246     static {
247         try {
248             NULL_URL = new URL(&quot;http://null.oracle.com/&quot;);
249         } catch (Exception e) {
250             throw new RuntimeException(e);
251         }
252     }
253 
254     // reference to a Map we use as a cache for codebases
255     private static final Map&lt;Class&lt;?&gt;, URL&gt; codeBaseCacheRef =
</pre>
<hr />
<pre>
383                 cryptoPolicyProperty);
384         }
385 
386         // If there was an empty exempt policy file, ignore it.
387         if ((exemptPolicy != null) &amp;&amp; exemptPolicy.isEmpty()) {
388             exemptPolicy = null;
389         }
390     }
391 
392     static CryptoPermissions getDefaultPolicy() {
393         return defaultPolicy;
394     }
395 
396     static CryptoPermissions getExemptPolicy() {
397         return exemptPolicy;
398     }
399 
400     static boolean isRestricted() {
401         return isRestricted;
402     }
<span class="line-added">403 </span>
<span class="line-added">404     private static final class IdentityWrapper {</span>
<span class="line-added">405 </span>
<span class="line-added">406         final Provider obj;</span>
<span class="line-added">407 </span>
<span class="line-added">408         IdentityWrapper(Provider obj) {</span>
<span class="line-added">409             this.obj = obj;</span>
<span class="line-added">410         }</span>
<span class="line-added">411 </span>
<span class="line-added">412         @Override</span>
<span class="line-added">413         public boolean equals(Object o) {</span>
<span class="line-added">414             if (this == o) {</span>
<span class="line-added">415                 return true;</span>
<span class="line-added">416             }</span>
<span class="line-added">417             if (!(o instanceof IdentityWrapper)) {</span>
<span class="line-added">418                 return false;</span>
<span class="line-added">419             }</span>
<span class="line-added">420             return this.obj == ((IdentityWrapper)o).obj;</span>
<span class="line-added">421         }</span>
<span class="line-added">422 </span>
<span class="line-added">423         @Override</span>
<span class="line-added">424         public int hashCode() {</span>
<span class="line-added">425             return System.identityHashCode(obj);</span>
<span class="line-added">426         }</span>
<span class="line-added">427     }</span>
428 }
</pre>
</td>
</tr>
</table>
<center><a href="IllegalBlockSizeException.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="KeyGenerator.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>