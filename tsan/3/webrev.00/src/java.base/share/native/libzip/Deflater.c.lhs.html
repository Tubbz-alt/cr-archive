<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/native/libzip/Deflater.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 /*
 27  * Native method support for java.util.zip.Deflater
 28  */
 29 
 30 #include &lt;stdio.h&gt;
 31 #include &lt;stdlib.h&gt;
 32 #include &quot;jlong.h&quot;
 33 #include &quot;jni.h&quot;
 34 #include &quot;jni_util.h&quot;
 35 #include &lt;zlib.h&gt;
 36 
 37 #include &quot;java_util_zip_Deflater.h&quot;
 38 
 39 #define DEF_MEM_LEVEL 8
 40 
 41 JNIEXPORT jlong JNICALL
 42 Java_java_util_zip_Deflater_init(JNIEnv *env, jclass cls, jint level,
 43                                  jint strategy, jboolean nowrap)
 44 {
 45     z_stream *strm = calloc(1, sizeof(z_stream));
 46 
 47     if (strm == 0) {
 48         JNU_ThrowOutOfMemoryError(env, 0);
 49         return jlong_zero;
 50     } else {
 51         const char *msg;
 52         int ret = deflateInit2(strm, level, Z_DEFLATED,
 53                                nowrap ? -MAX_WBITS : MAX_WBITS,
 54                                DEF_MEM_LEVEL, strategy);
 55         switch (ret) {
 56           case Z_OK:
 57             return ptr_to_jlong(strm);
 58           case Z_MEM_ERROR:
 59             free(strm);
 60             JNU_ThrowOutOfMemoryError(env, 0);
 61             return jlong_zero;
 62           case Z_STREAM_ERROR:
 63             free(strm);
 64             JNU_ThrowIllegalArgumentException(env, 0);
 65             return jlong_zero;
 66           default:
 67             msg = ((strm-&gt;msg != NULL) ? strm-&gt;msg :
 68                    (ret == Z_VERSION_ERROR) ?
 69                    &quot;zlib returned Z_VERSION_ERROR: &quot;
 70                    &quot;compile time and runtime zlib implementations differ&quot; :
 71                    &quot;unknown error initializing zlib library&quot;);
 72             free(strm);
 73             JNU_ThrowInternalError(env, msg);
 74             return jlong_zero;
 75         }
 76     }
 77 }
 78 
<a name="2" id="anc2"></a><span class="line-modified"> 79 static void doSetDictionary(JNIEnv *env, jlong addr, jbyte *buf, jint len)</span>
 80 {
<a name="3" id="anc3"></a><span class="line-removed"> 81     int res = deflateSetDictionary(jlong_to_ptr(addr), (Bytef *) buf, len);</span>
 82     switch (res) {
 83     case Z_OK:
 84         break;
 85     case Z_STREAM_ERROR:
 86         JNU_ThrowIllegalArgumentException(env, 0);
 87         break;
 88     default:
 89         JNU_ThrowInternalError(env, ((z_stream *)jlong_to_ptr(addr))-&gt;msg);
 90         break;
 91     }
 92 }
 93 
 94 JNIEXPORT void JNICALL
 95 Java_java_util_zip_Deflater_setDictionary(JNIEnv *env, jclass cls, jlong addr,
 96                                           jbyteArray b, jint off, jint len)
 97 {
<a name="4" id="anc4"></a><span class="line-modified"> 98     jbyte *buf = (*env)-&gt;GetPrimitiveArrayCritical(env, b, 0);</span>

 99     if (buf == NULL) /* out of memory */
100         return;
<a name="5" id="anc5"></a><span class="line-modified">101     doSetDictionary(env, addr, buf + off, len);</span>
102     (*env)-&gt;ReleasePrimitiveArrayCritical(env, b, buf, 0);
<a name="6" id="anc6"></a>
103 }
104 
105 JNIEXPORT void JNICALL
106 Java_java_util_zip_Deflater_setDictionaryBuffer(JNIEnv *env, jclass cls, jlong addr,
107                                           jlong bufferAddr, jint len)
108 {
<a name="7" id="anc7"></a><span class="line-modified">109     jbyte *buf = jlong_to_ptr(bufferAddr);</span>
<span class="line-modified">110     doSetDictionary(env, addr, buf, len);</span>


111 }
112 
<a name="8" id="anc8"></a><span class="line-modified">113 static jlong doDeflate(JNIEnv *env, jobject this, jlong addr,</span>
114                        jbyte *input, jint inputLen,
115                        jbyte *output, jint outputLen,
116                        jint flush, jint params)
117 {
118     z_stream *strm = jlong_to_ptr(addr);
<a name="9" id="anc9"></a><span class="line-removed">119     jint inputUsed = 0, outputUsed = 0;</span>
<span class="line-removed">120     int finished = 0;</span>
121     int setParams = params &amp; 1;
<a name="10" id="anc10"></a>
122 
123     strm-&gt;next_in  = (Bytef *) input;
124     strm-&gt;next_out = (Bytef *) output;
125     strm-&gt;avail_in  = inputLen;
126     strm-&gt;avail_out = outputLen;
127 
128     if (setParams) {
129         int strategy = (params &gt;&gt; 1) &amp; 3;
130         int level = params &gt;&gt; 3;
<a name="11" id="anc11"></a><span class="line-modified">131         int res = deflateParams(strm, level, strategy);</span>

















132         switch (res) {
133         case Z_OK:
134             setParams = 0;
135             /* fall through */
136         case Z_BUF_ERROR:
137             inputUsed = inputLen - strm-&gt;avail_in;
138             outputUsed = outputLen - strm-&gt;avail_out;
139             break;
140         default:
141             JNU_ThrowInternalError(env, strm-&gt;msg);
142             return 0;
143         }
144     } else {
<a name="12" id="anc12"></a><span class="line-removed">145         int res = deflate(strm, flush);</span>
146         switch (res) {
147         case Z_STREAM_END:
148             finished = 1;
149             /* fall through */
150         case Z_OK:
151         case Z_BUF_ERROR:
152             inputUsed = inputLen - strm-&gt;avail_in;
153             outputUsed = outputLen - strm-&gt;avail_out;
154             break;
155         default:
156             JNU_ThrowInternalError(env, strm-&gt;msg);
157             return 0;
158         }
159     }
160     return ((jlong)inputUsed) | (((jlong)outputUsed) &lt;&lt; 31) | (((jlong)finished) &lt;&lt; 62) | (((jlong)setParams) &lt;&lt; 63);
161 }
162 
163 JNIEXPORT jlong JNICALL
164 Java_java_util_zip_Deflater_deflateBytesBytes(JNIEnv *env, jobject this, jlong addr,
165                                          jbyteArray inputArray, jint inputOff, jint inputLen,
166                                          jbyteArray outputArray, jint outputOff, jint outputLen,
167                                          jint flush, jint params)
168 {
169     jbyte *input = (*env)-&gt;GetPrimitiveArrayCritical(env, inputArray, 0);
170     jbyte *output;
171     jlong retVal;
<a name="13" id="anc13"></a>

172     if (input == NULL) {
173         if (inputLen != 0 &amp;&amp; (*env)-&gt;ExceptionOccurred(env) == NULL)
174             JNU_ThrowOutOfMemoryError(env, 0);
175         return 0L;
176     }
177     output = (*env)-&gt;GetPrimitiveArrayCritical(env, outputArray, 0);
178     if (output == NULL) {
179         (*env)-&gt;ReleasePrimitiveArrayCritical(env, inputArray, input, 0);
180         if (outputLen != 0 &amp;&amp; (*env)-&gt;ExceptionOccurred(env) == NULL)
181             JNU_ThrowOutOfMemoryError(env, 0);
182         return 0L;
183     }
184 
<a name="14" id="anc14"></a><span class="line-modified">185     retVal = doDeflate(env, this, addr,</span>
<span class="line-modified">186             input + inputOff, inputLen,</span>
<span class="line-removed">187             output + outputOff, outputLen,</span>
<span class="line-removed">188             flush, params);</span>
189 
190     (*env)-&gt;ReleasePrimitiveArrayCritical(env, outputArray, output, 0);
191     (*env)-&gt;ReleasePrimitiveArrayCritical(env, inputArray, input, 0);
192 
<a name="15" id="anc15"></a>
193     return retVal;
194 }
195 
196 
197 JNIEXPORT jlong JNICALL
198 Java_java_util_zip_Deflater_deflateBytesBuffer(JNIEnv *env, jobject this, jlong addr,
199                                          jbyteArray inputArray, jint inputOff, jint inputLen,
200                                          jlong outputBuffer, jint outputLen,
201                                          jint flush, jint params)
202 {
203     jbyte *input = (*env)-&gt;GetPrimitiveArrayCritical(env, inputArray, 0);
204     jbyte *output;
205     jlong retVal;
<a name="16" id="anc16"></a>
206     if (input == NULL) {
207         if (inputLen != 0 &amp;&amp; (*env)-&gt;ExceptionOccurred(env) == NULL)
208             JNU_ThrowOutOfMemoryError(env, 0);
209         return 0L;
210     }
211     output = jlong_to_ptr(outputBuffer);
212 
<a name="17" id="anc17"></a><span class="line-modified">213     retVal = doDeflate(env, this, addr,</span>
<span class="line-modified">214             input + inputOff, inputLen,</span>
<span class="line-removed">215             output, outputLen,</span>
<span class="line-removed">216             flush, params);</span>
217 
218     (*env)-&gt;ReleasePrimitiveArrayCritical(env, inputArray, input, 0);
219 
<a name="18" id="anc18"></a>
220     return retVal;
221 }
222 
223 JNIEXPORT jlong JNICALL
224 Java_java_util_zip_Deflater_deflateBufferBytes(JNIEnv *env, jobject this, jlong addr,
225                                          jlong inputBuffer, jint inputLen,
226                                          jbyteArray outputArray, jint outputOff, jint outputLen,
227                                          jint flush, jint params)
228 {
229     jbyte *input = jlong_to_ptr(inputBuffer);
230     jbyte *output = (*env)-&gt;GetPrimitiveArrayCritical(env, outputArray, 0);
231     jlong retVal;
<a name="19" id="anc19"></a>
232     if (output == NULL) {
233         if (outputLen != 0 &amp;&amp; (*env)-&gt;ExceptionOccurred(env) == NULL)
234             JNU_ThrowOutOfMemoryError(env, 0);
235         return 0L;
236     }
237 
<a name="20" id="anc20"></a><span class="line-modified">238     retVal = doDeflate(env, this, addr,</span>
<span class="line-modified">239             input, inputLen,</span>
<span class="line-modified">240             output + outputOff, outputLen,</span>
<span class="line-removed">241             flush, params);</span>
<span class="line-removed">242 </span>
<span class="line-removed">243     (*env)-&gt;ReleasePrimitiveArrayCritical(env, outputArray, input, 0);</span>
244 
<a name="21" id="anc21"></a>
245     return retVal;
246 }
247 
248 JNIEXPORT jlong JNICALL
249 Java_java_util_zip_Deflater_deflateBufferBuffer(JNIEnv *env, jobject this, jlong addr,
250                                          jlong inputBuffer, jint inputLen,
251                                          jlong outputBuffer, jint outputLen,
252                                          jint flush, jint params)
253 {
254     jbyte *input = jlong_to_ptr(inputBuffer);
255     jbyte *output = jlong_to_ptr(outputBuffer);
<a name="22" id="anc22"></a>

256 
<a name="23" id="anc23"></a><span class="line-modified">257     return doDeflate(env, this, addr,</span>
<span class="line-modified">258             input, inputLen,</span>
<span class="line-modified">259             output, outputLen,</span>
<span class="line-removed">260             flush, params);</span>
261 }
262 
263 JNIEXPORT jint JNICALL
264 Java_java_util_zip_Deflater_getAdler(JNIEnv *env, jclass cls, jlong addr)
265 {
266     return ((z_stream *)jlong_to_ptr(addr))-&gt;adler;
267 }
268 
269 JNIEXPORT void JNICALL
270 Java_java_util_zip_Deflater_reset(JNIEnv *env, jclass cls, jlong addr)
271 {
272     if (deflateReset((z_stream *)jlong_to_ptr(addr)) != Z_OK) {
273         JNU_ThrowInternalError(env, 0);
274     }
275 }
276 
277 JNIEXPORT void JNICALL
278 Java_java_util_zip_Deflater_end(JNIEnv *env, jclass cls, jlong addr)
279 {
280     if (deflateEnd((z_stream *)jlong_to_ptr(addr)) == Z_STREAM_ERROR) {
281         JNU_ThrowInternalError(env, 0);
282     } else {
283         free((z_stream *)jlong_to_ptr(addr));
284     }
285 }
<a name="24" id="anc24"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="24" type="hidden" />
</body>
</html>