<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/unix/native/libjava/TimeZone_md.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ProcessImpl_md.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="UnixFileSystem_md.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libjava/TimeZone_md.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1999, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -40,10 +40,12 @@</span>
  #endif
  
  #include &quot;jvm.h&quot;
  #include &quot;TimeZone_md.h&quot;
  
<span class="udiff-line-added">+ static char *isFileIdentical(char* buf, size_t size, char *pathname);</span>
<span class="udiff-line-added">+ </span>
  #define SKIP_SPACE(p)   while (*p == &#39; &#39; || *p == &#39;\t&#39;) p++;
  
  #define RESTARTABLE(_cmd, _result) do { \
    do { \
      _result = _cmd; \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -70,10 +72,12 @@</span>
  static const char *SYS_INIT_FILE = &quot;/etc/default/init&quot;;
  static const char *ZONEINFO_DIR = &quot;/usr/share/lib/zoneinfo&quot;;
  static const char *DEFAULT_ZONEINFO_FILE = &quot;/usr/share/lib/zoneinfo/localtime&quot;;
  #endif /* defined(__linux__) || defined(_ALLBSD_SOURCE) */
  
<span class="udiff-line-added">+ static const char popularZones[][4] = {&quot;UTC&quot;, &quot;GMT&quot;};</span>
<span class="udiff-line-added">+ </span>
  #if defined(_AIX)
  static const char *ETC_ENVIRONMENT_FILE = &quot;/etc/environment&quot;;
  #endif
  
  #if defined(__linux__) || defined(MACOSX) || defined(__solaris__)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -119,18 +123,31 @@</span>
   */
  static char *
  findZoneinfoFile(char *buf, size_t size, const char *dir)
  {
      DIR *dirp = NULL;
<span class="udiff-line-removed">-     struct stat64 statbuf;</span>
      struct dirent *dp = NULL;
      char *pathname = NULL;
<span class="udiff-line-removed">-     int fd = -1;</span>
<span class="udiff-line-removed">-     char *dbuf = NULL;</span>
      char *tz = NULL;
      int res;
  
<span class="udiff-line-added">+     if (strcmp(dir, ZONEINFO_DIR) == 0) {</span>
<span class="udiff-line-added">+         /* fast path for 1st iteration */</span>
<span class="udiff-line-added">+         for (unsigned int i = 0; i &lt; sizeof (popularZones) / sizeof (popularZones[0]); i++) {</span>
<span class="udiff-line-added">+             pathname = getPathName(dir, popularZones[i]);</span>
<span class="udiff-line-added">+             if (pathname == NULL) {</span>
<span class="udiff-line-added">+                 continue;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             tz = isFileIdentical(buf, size, pathname);</span>
<span class="udiff-line-added">+             free((void *) pathname);</span>
<span class="udiff-line-added">+             pathname = NULL;</span>
<span class="udiff-line-added">+             if (tz != NULL) {</span>
<span class="udiff-line-added">+                 return tz;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      dirp = opendir(dir);
      if (dirp == NULL) {
          return NULL;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -160,62 +177,71 @@</span>
  
          pathname = getPathName(dir, dp-&gt;d_name);
          if (pathname == NULL) {
              break;
          }
<span class="udiff-line-removed">-         RESTARTABLE(stat64(pathname, &amp;statbuf), res);</span>
<span class="udiff-line-removed">-         if (res == -1) {</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-         }</span>
  
<span class="udiff-line-modified-removed">-         if (S_ISDIR(statbuf.st_mode)) {</span>
<span class="udiff-line-removed">-             tz = findZoneinfoFile(buf, size, pathname);</span>
<span class="udiff-line-removed">-             if (tz != NULL) {</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } else if (S_ISREG(statbuf.st_mode) &amp;&amp; (size_t)statbuf.st_size == size) {</span>
<span class="udiff-line-removed">-             dbuf = (char *) malloc(size);</span>
<span class="udiff-line-removed">-             if (dbuf == NULL) {</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             RESTARTABLE(open(pathname, O_RDONLY), fd);</span>
<span class="udiff-line-removed">-             if (fd == -1) {</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             RESTARTABLE(read(fd, dbuf, size), res);</span>
<span class="udiff-line-removed">-             if (res != (ssize_t) size) {</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (memcmp(buf, dbuf, size) == 0) {</span>
<span class="udiff-line-removed">-                 tz = getZoneName(pathname);</span>
<span class="udiff-line-removed">-                 if (tz != NULL) {</span>
<span class="udiff-line-removed">-                     tz = strdup(tz);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             free((void *) dbuf);</span>
<span class="udiff-line-removed">-             dbuf = NULL;</span>
<span class="udiff-line-removed">-             (void) close(fd);</span>
<span class="udiff-line-removed">-             fd = -1;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         tz = isFileIdentical(buf, size, pathname);</span>
          free((void *) pathname);
          pathname = NULL;
<span class="udiff-line-added">+         if (tz != NULL) {</span>
<span class="udiff-line-added">+            break;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      if (dirp != NULL) {
          (void) closedir(dirp);
      }
<span class="udiff-line-modified-removed">-     if (pathname != NULL) {</span>
<span class="udiff-line-modified-removed">-         free((void *) pathname);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-     if (fd != -1) {</span>
<span class="udiff-line-modified-removed">-         (void) close(fd);</span>
<span class="udiff-line-modified-added">+     return tz;</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ /*</span>
<span class="udiff-line-modified-added">+  * Checks if the file pointed to by pathname matches</span>
<span class="udiff-line-added">+  * the data contents in buf.</span>
<span class="udiff-line-added">+  * Returns a representation of the timezone file name</span>
<span class="udiff-line-added">+  * if file match is found, otherwise NULL.</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ static char *</span>
<span class="udiff-line-added">+ isFileIdentical(char *buf, size_t size, char *pathname)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     char *possibleMatch = NULL;</span>
<span class="udiff-line-added">+     struct stat64 statbuf;</span>
<span class="udiff-line-added">+     char *dbuf = NULL;</span>
<span class="udiff-line-added">+     int fd = -1;</span>
<span class="udiff-line-added">+     int res;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     RESTARTABLE(stat64(pathname, &amp;statbuf), res);</span>
<span class="udiff-line-added">+     if (res == -1) {</span>
<span class="udiff-line-added">+         return NULL;</span>
      }
<span class="udiff-line-modified-removed">-     if (dbuf != NULL) {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     if (S_ISDIR(statbuf.st_mode)) {</span>
<span class="udiff-line-added">+         possibleMatch  = findZoneinfoFile(buf, size, pathname);</span>
<span class="udiff-line-added">+     } else if (S_ISREG(statbuf.st_mode) &amp;&amp; (size_t)statbuf.st_size == size) {</span>
<span class="udiff-line-added">+         dbuf = (char *) malloc(size);</span>
<span class="udiff-line-added">+         if (dbuf == NULL) {</span>
<span class="udiff-line-added">+             return NULL;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         RESTARTABLE(open(pathname, O_RDONLY), fd);</span>
<span class="udiff-line-added">+         if (fd == -1) {</span>
<span class="udiff-line-added">+             goto freedata;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         RESTARTABLE(read(fd, dbuf, size), res);</span>
<span class="udiff-line-added">+         if (res != (ssize_t) size) {</span>
<span class="udiff-line-added">+             goto freedata;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (memcmp(buf, dbuf, size) == 0) {</span>
<span class="udiff-line-added">+             possibleMatch = getZoneName(pathname);</span>
<span class="udiff-line-added">+             if (possibleMatch != NULL) {</span>
<span class="udiff-line-added">+                 possibleMatch = strdup(possibleMatch);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         freedata:</span>
          free((void *) dbuf);
<span class="udiff-line-added">+         (void) close(fd);</span>
      }
<span class="udiff-line-modified-removed">-     return tz;</span>
<span class="udiff-line-modified-added">+     return possibleMatch;</span>
  }
  
  #if defined(__linux__) || defined(MACOSX)
  
  /*
</pre>
<center><a href="ProcessImpl_md.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="UnixFileSystem_md.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>