<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/unix/native/libjava/UnixFileSystem_md.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TimeZone_md.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="canonicalize_md.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libjava/UnixFileSystem_md.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1998, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -43,10 +43,11 @@</span>
  #include &lt;dirent.h&gt;
  
  #include &quot;jni.h&quot;
  #include &quot;jni_util.h&quot;
  #include &quot;jlong.h&quot;
<span class="udiff-line-added">+ #include &quot;jdk_util.h&quot;</span>
  #include &quot;io_util.h&quot;
  #include &quot;io_util_md.h&quot;
  #include &quot;java_io_FileSystem.h&quot;
  #include &quot;java_io_UnixFileSystem.h&quot;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -89,21 +90,19 @@</span>
                                    &quot;path&quot;, &quot;Ljava/lang/String;&quot;);
  }
  
  /* -- Path operations -- */
  
<span class="udiff-line-removed">- extern int canonicalize(char *path, const char *out, int len);</span>
<span class="udiff-line-removed">- </span>
  JNIEXPORT jstring JNICALL
  Java_java_io_UnixFileSystem_canonicalize0(JNIEnv *env, jobject this,
                                            jstring pathname)
  {
      jstring rv = NULL;
  
      WITH_PLATFORM_STRING(env, pathname, path) {
          char canonicalPath[PATH_MAX];
<span class="udiff-line-modified-removed">-         if (canonicalize((char *)path,</span>
<span class="udiff-line-modified-added">+         if (JDK_Canonicalize((char *)path,</span>
                           canonicalPath, PATH_MAX) &lt; 0) {
              JNU_ThrowIOExceptionWithLastError(env, &quot;Bad pathname&quot;);
          } else {
  #ifdef MACOSX
              rv = newStringPlatform(env, canonicalPath);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,11 +165,13 @@</span>
          mode = X_OK;
          break;
      default: assert(0);
      }
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
<span class="udiff-line-modified-removed">-         if (access(path, mode) == 0) {</span>
<span class="udiff-line-modified-added">+         int res;</span>
<span class="udiff-line-added">+         RESTARTABLE(access(path, mode), res);</span>
<span class="udiff-line-added">+         if (res == 0) {</span>
              rv = JNI_TRUE;
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -186,10 +187,11 @@</span>
      jboolean rv = JNI_FALSE;
  
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
          int amode = 0;
          int mode;
<span class="udiff-line-added">+         int res;</span>
          switch (access) {
          case java_io_FileSystem_ACCESS_READ:
              if (owneronly)
                  amode = S_IRUSR;
              else
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -213,11 +215,12 @@</span>
          if (statMode(path, &amp;mode)) {
              if (enable)
                  mode |= amode;
              else
                  mode &amp;= ~amode;
<span class="udiff-line-modified-removed">-             if (chmod(path, mode) &gt;= 0) {</span>
<span class="udiff-line-modified-added">+             RESTARTABLE(chmod(path, mode), res);</span>
<span class="udiff-line-added">+             if (res == 0) {</span>
                  rv = JNI_TRUE;
              }
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -278,14 +281,14 @@</span>
          /* The root directory always exists */
          if (strcmp (path, &quot;/&quot;)) {
              fd = handleOpen(path, O_RDWR | O_CREAT | O_EXCL, 0666);
              if (fd &lt; 0) {
                  if (errno != EEXIST)
<span class="udiff-line-modified-removed">-                     JNU_ThrowIOExceptionWithLastError(env, path);</span>
<span class="udiff-line-modified-added">+                     JNU_ThrowIOExceptionWithLastError(env, &quot;Could not open file&quot;);</span>
              } else {
                  if (close(fd) == -1)
<span class="udiff-line-modified-removed">-                     JNU_ThrowIOExceptionWithLastError(env, path);</span>
<span class="udiff-line-modified-added">+                     JNU_ThrowIOExceptionWithLastError(env, &quot;Could not close file&quot;);</span>
                  rv = JNI_TRUE;
              }
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -353,17 +356,19 @@</span>
          (*env)-&gt;DeleteLocalRef(env, name);
      }
      closedir(dir);
  
      /* Copy the final results into an appropriately-sized array */
<span class="udiff-line-modified-removed">-     old = rv;</span>
<span class="udiff-line-modified-removed">-     rv = (*env)-&gt;NewObjectArray(env, len, str_class, NULL);</span>
<span class="udiff-line-modified-removed">-     if (rv == NULL) {</span>
<span class="udiff-line-modified-removed">-         return NULL;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-     if (JNU_CopyObjectArray(env, rv, old, len) &lt; 0) {</span>
<span class="udiff-line-modified-removed">-         return NULL;</span>
<span class="udiff-line-modified-added">+     if (len &lt; maxlen) {</span>
<span class="udiff-line-modified-added">+         old = rv;</span>
<span class="udiff-line-modified-added">+         rv = (*env)-&gt;NewObjectArray(env, len, str_class, NULL);</span>
<span class="udiff-line-modified-added">+         if (rv == NULL) {</span>
<span class="udiff-line-modified-added">+             return NULL;</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         if (JNU_CopyObjectArray(env, rv, old, len) &lt; 0) {</span>
<span class="udiff-line-added">+             return NULL;</span>
<span class="udiff-line-added">+         }</span>
      }
      return rv;
  
   error:
      closedir(dir);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -444,12 +449,14 @@</span>
  {
      jboolean rv = JNI_FALSE;
  
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
          int mode;
<span class="udiff-line-added">+         int res;</span>
          if (statMode(path, &amp;mode)) {
<span class="udiff-line-modified-removed">-             if (chmod(path, mode &amp; ~(S_IWUSR | S_IWGRP | S_IWOTH)) &gt;= 0) {</span>
<span class="udiff-line-modified-added">+             RESTARTABLE(chmod(path, mode &amp; ~(S_IWUSR | S_IWGRP | S_IWOTH)), res);</span>
<span class="udiff-line-added">+             if (res == 0) {</span>
                  rv = JNI_TRUE;
              }
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -464,10 +471,11 @@</span>
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
  #ifdef MACOSX
          struct statfs fsstat;
  #else
          struct statvfs64 fsstat;
<span class="udiff-line-added">+         int res;</span>
  #endif
          memset(&amp;fsstat, 0, sizeof(fsstat));
  #ifdef MACOSX
          if (statfs(path, &amp;fsstat) == 0) {
              switch(t) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -486,11 +494,12 @@</span>
                  default:
                      assert(0);
              }
          }
  #else
<span class="udiff-line-modified-removed">-         if (statvfs64(path, &amp;fsstat) == 0) {</span>
<span class="udiff-line-modified-added">+         RESTARTABLE(statvfs64(path, &amp;fsstat), res);</span>
<span class="udiff-line-added">+         if (res == 0) {</span>
              switch(t) {
              case java_io_FileSystem_SPACE_TOTAL:
                  rv = jlong_mul(long_to_jlong(fsstat.f_frsize),
                                 long_to_jlong(fsstat.f_blocks));
                  break;
</pre>
<center><a href="TimeZone_md.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="canonicalize_md.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>