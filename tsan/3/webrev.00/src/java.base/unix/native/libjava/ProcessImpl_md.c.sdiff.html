<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/unix/native/libjava/ProcessImpl_md.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../classes/sun/nio/fs/UnixNativeDispatcher.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TimeZone_md.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libjava/ProcessImpl_md.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
337         if (ret != EINVAL)
338             detail = tmpbuf;
339     }
340     /* ASCII Decimal representation uses 2.4 times as many bits as binary. */
341     fmtsize = sizeof(IOE_FORMAT) + strlen(detail) + 3 * sizeof(errnum);
342     errmsg = NEW(char, fmtsize);
343     if (errmsg == NULL)
344         return;
345 
346     snprintf(errmsg, fmtsize, IOE_FORMAT, errnum, detail);
347     s = JNU_NewStringPlatform(env, errmsg);
348     if (s != NULL) {
349         jobject x = JNU_NewObjectByName(env, &quot;java/io/IOException&quot;,
350                                         &quot;(Ljava/lang/String;)V&quot;, s);
351         if (x != NULL)
352             (*env)-&gt;Throw(env, x);
353     }
354     free(errmsg);
355 }
356 





















357 #ifdef DEBUG_PROCESS
358 /* Debugging process code is difficult; where to write debug output? */
359 static void
360 debugPrint(char *format, ...)
361 {
362     FILE *tty = fopen(&quot;/dev/tty&quot;, &quot;w&quot;);
363     va_list ap;
364     va_start(ap, format);
365     vfprintf(tty, format, ap);
366     va_end(ap);
367     fclose(tty);
368 }
369 #endif /* DEBUG_PROCESS */
370 
371 static void
372 copyPipe(int from[2], int to[2])
373 {
374     to[0] = from[0];
375     to[1] = from[1];
376 }
</pre>
<hr />
<pre>
638         (fds[1] == -1 &amp;&amp; pipe(out) &lt; 0) ||
639         (fds[2] == -1 &amp;&amp; pipe(err) &lt; 0) ||
640         (pipe(childenv) &lt; 0) ||
641         (pipe(fail) &lt; 0)) {
642         throwIOException(env, errno, &quot;Bad file descriptor&quot;);
643         goto Catch;
644     }
645     c-&gt;fds[0] = fds[0];
646     c-&gt;fds[1] = fds[1];
647     c-&gt;fds[2] = fds[2];
648 
649     copyPipe(in,   c-&gt;in);
650     copyPipe(out,  c-&gt;out);
651     copyPipe(err,  c-&gt;err);
652     copyPipe(fail, c-&gt;fail);
653     copyPipe(childenv, c-&gt;childenv);
654 
655     c-&gt;redirectErrorStream = redirectErrorStream;
656     c-&gt;mode = mode;
657 












658     resultPid = startChild(env, process, c, phelperpath);
659     assert(resultPid != 0);
660 
661     if (resultPid &lt; 0) {
662         switch (c-&gt;mode) {
663           case MODE_VFORK:
664             throwIOException(env, errno, &quot;vfork failed&quot;);
665             break;
666           case MODE_FORK:
667             throwIOException(env, errno, &quot;fork failed&quot;);
668             break;
669           case MODE_POSIX_SPAWN:
670             throwIOException(env, errno, &quot;posix_spawn failed&quot;);
671             break;
672         }
673         goto Catch;
674     }
675     close(fail[1]); fail[1] = -1; /* See: WhyCantJohnnyExec  (childproc.c)  */
676 



























677     switch (readFully(fail[0], &amp;errnum, sizeof(errnum))) {
678     case 0: break; /* Exec succeeded */
679     case sizeof(errnum):
680         waitpid(resultPid, NULL, 0);
681         throwIOException(env, errnum, &quot;Exec failed&quot;);
682         goto Catch;
683     default:
684         throwIOException(env, errno, &quot;Read failed&quot;);
685         goto Catch;
686     }
687 
688     fds[0] = (in [1] != -1) ? in [1] : -1;
689     fds[1] = (out[0] != -1) ? out[0] : -1;
690     fds[2] = (err[0] != -1) ? err[0] : -1;
691 
692  Finally:
693     /* Always clean up the child&#39;s side of the pipes */
694     closeSafely(in [0]);
695     closeSafely(out[1]);
696     closeSafely(err[1]);
</pre>
</td>
<td>
<hr />
<pre>
337         if (ret != EINVAL)
338             detail = tmpbuf;
339     }
340     /* ASCII Decimal representation uses 2.4 times as many bits as binary. */
341     fmtsize = sizeof(IOE_FORMAT) + strlen(detail) + 3 * sizeof(errnum);
342     errmsg = NEW(char, fmtsize);
343     if (errmsg == NULL)
344         return;
345 
346     snprintf(errmsg, fmtsize, IOE_FORMAT, errnum, detail);
347     s = JNU_NewStringPlatform(env, errmsg);
348     if (s != NULL) {
349         jobject x = JNU_NewObjectByName(env, &quot;java/io/IOException&quot;,
350                                         &quot;(Ljava/lang/String;)V&quot;, s);
351         if (x != NULL)
352             (*env)-&gt;Throw(env, x);
353     }
354     free(errmsg);
355 }
356 
<span class="line-added">357 /**</span>
<span class="line-added">358  * Throws an IOException with a message composed from the result of waitpid status.</span>
<span class="line-added">359  */</span>
<span class="line-added">360 static void throwExitCause(JNIEnv *env, int pid, int status) {</span>
<span class="line-added">361     char ebuf[128];</span>
<span class="line-added">362     if (WIFEXITED(status)) {</span>
<span class="line-added">363         snprintf(ebuf, sizeof ebuf,</span>
<span class="line-added">364             &quot;Failed to exec spawn helper: pid: %d, exit value: %d&quot;,</span>
<span class="line-added">365             pid, WEXITSTATUS(status));</span>
<span class="line-added">366     } else if (WIFSIGNALED(status)) {</span>
<span class="line-added">367         snprintf(ebuf, sizeof ebuf,</span>
<span class="line-added">368             &quot;Failed to exec spawn helper: pid: %d, signal: %d&quot;,</span>
<span class="line-added">369             pid, WTERMSIG(status));</span>
<span class="line-added">370     } else {</span>
<span class="line-added">371         snprintf(ebuf, sizeof ebuf,</span>
<span class="line-added">372             &quot;Failed to exec spawn helper: pid: %d, status: 0x%08x&quot;,</span>
<span class="line-added">373             pid, status);</span>
<span class="line-added">374     }</span>
<span class="line-added">375     throwIOException(env, 0, ebuf);</span>
<span class="line-added">376 }</span>
<span class="line-added">377 </span>
378 #ifdef DEBUG_PROCESS
379 /* Debugging process code is difficult; where to write debug output? */
380 static void
381 debugPrint(char *format, ...)
382 {
383     FILE *tty = fopen(&quot;/dev/tty&quot;, &quot;w&quot;);
384     va_list ap;
385     va_start(ap, format);
386     vfprintf(tty, format, ap);
387     va_end(ap);
388     fclose(tty);
389 }
390 #endif /* DEBUG_PROCESS */
391 
392 static void
393 copyPipe(int from[2], int to[2])
394 {
395     to[0] = from[0];
396     to[1] = from[1];
397 }
</pre>
<hr />
<pre>
659         (fds[1] == -1 &amp;&amp; pipe(out) &lt; 0) ||
660         (fds[2] == -1 &amp;&amp; pipe(err) &lt; 0) ||
661         (pipe(childenv) &lt; 0) ||
662         (pipe(fail) &lt; 0)) {
663         throwIOException(env, errno, &quot;Bad file descriptor&quot;);
664         goto Catch;
665     }
666     c-&gt;fds[0] = fds[0];
667     c-&gt;fds[1] = fds[1];
668     c-&gt;fds[2] = fds[2];
669 
670     copyPipe(in,   c-&gt;in);
671     copyPipe(out,  c-&gt;out);
672     copyPipe(err,  c-&gt;err);
673     copyPipe(fail, c-&gt;fail);
674     copyPipe(childenv, c-&gt;childenv);
675 
676     c-&gt;redirectErrorStream = redirectErrorStream;
677     c-&gt;mode = mode;
678 
<span class="line-added">679     /* In posix_spawn mode, require the child process to signal aliveness</span>
<span class="line-added">680      * right after it comes up. This is because there are implementations of</span>
<span class="line-added">681      * posix_spawn() which do not report failed exec()s back to the caller</span>
<span class="line-added">682      * (e.g. glibc, see JDK-8223777). In those cases, the fork() will have</span>
<span class="line-added">683      * worked and successfully started the child process, but the exec() will</span>
<span class="line-added">684      * have failed. There is no way for us to distinguish this from a target</span>
<span class="line-added">685      * binary just exiting right after start.</span>
<span class="line-added">686      *</span>
<span class="line-added">687      * Note that we could do this additional handshake in all modes but for</span>
<span class="line-added">688      * prudence only do it when it is needed (in posix_spawn mode). */</span>
<span class="line-added">689     c-&gt;sendAlivePing = (mode == MODE_POSIX_SPAWN) ? 1 : 0;</span>
<span class="line-added">690 </span>
691     resultPid = startChild(env, process, c, phelperpath);
692     assert(resultPid != 0);
693 
694     if (resultPid &lt; 0) {
695         switch (c-&gt;mode) {
696           case MODE_VFORK:
697             throwIOException(env, errno, &quot;vfork failed&quot;);
698             break;
699           case MODE_FORK:
700             throwIOException(env, errno, &quot;fork failed&quot;);
701             break;
702           case MODE_POSIX_SPAWN:
703             throwIOException(env, errno, &quot;posix_spawn failed&quot;);
704             break;
705         }
706         goto Catch;
707     }
708     close(fail[1]); fail[1] = -1; /* See: WhyCantJohnnyExec  (childproc.c)  */
709 
<span class="line-added">710     /* If we expect the child to ping aliveness, wait for it. */</span>
<span class="line-added">711     if (c-&gt;sendAlivePing) {</span>
<span class="line-added">712         switch(readFully(fail[0], &amp;errnum, sizeof(errnum))) {</span>
<span class="line-added">713         case 0: /* First exec failed; */</span>
<span class="line-added">714             {</span>
<span class="line-added">715                 int tmpStatus = 0;</span>
<span class="line-added">716                 int p = waitpid(resultPid, &amp;tmpStatus, 0);</span>
<span class="line-added">717                 throwExitCause(env, p, tmpStatus);</span>
<span class="line-added">718                 goto Catch;</span>
<span class="line-added">719             }</span>
<span class="line-added">720         case sizeof(errnum):</span>
<span class="line-added">721             assert(errnum == CHILD_IS_ALIVE);</span>
<span class="line-added">722             if (errnum != CHILD_IS_ALIVE) {</span>
<span class="line-added">723                 /* Should never happen since the first thing the spawn</span>
<span class="line-added">724                  * helper should do is to send an alive ping to the parent,</span>
<span class="line-added">725                  * before doing any subsequent work. */</span>
<span class="line-added">726                 throwIOException(env, 0, &quot;Bad code from spawn helper &quot;</span>
<span class="line-added">727                                          &quot;(Failed to exec spawn helper)&quot;);</span>
<span class="line-added">728                 goto Catch;</span>
<span class="line-added">729             }</span>
<span class="line-added">730             break;</span>
<span class="line-added">731         default:</span>
<span class="line-added">732             throwIOException(env, errno, &quot;Read failed&quot;);</span>
<span class="line-added">733             goto Catch;</span>
<span class="line-added">734         }</span>
<span class="line-added">735     }</span>
<span class="line-added">736 </span>
737     switch (readFully(fail[0], &amp;errnum, sizeof(errnum))) {
738     case 0: break; /* Exec succeeded */
739     case sizeof(errnum):
740         waitpid(resultPid, NULL, 0);
741         throwIOException(env, errnum, &quot;Exec failed&quot;);
742         goto Catch;
743     default:
744         throwIOException(env, errno, &quot;Read failed&quot;);
745         goto Catch;
746     }
747 
748     fds[0] = (in [1] != -1) ? in [1] : -1;
749     fds[1] = (out[0] != -1) ? out[0] : -1;
750     fds[2] = (err[0] != -1) ? err[0] : -1;
751 
752  Finally:
753     /* Always clean up the child&#39;s side of the pipes */
754     closeSafely(in [0]);
755     closeSafely(out[1]);
756     closeSafely(err[1]);
</pre>
</td>
</tr>
</table>
<center><a href="../../classes/sun/nio/fs/UnixNativeDispatcher.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TimeZone_md.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>