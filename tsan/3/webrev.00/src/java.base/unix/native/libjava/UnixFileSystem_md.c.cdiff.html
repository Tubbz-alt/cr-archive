<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/unix/native/libjava/UnixFileSystem_md.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TimeZone_md.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="canonicalize_md.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libjava/UnixFileSystem_md.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1998, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 43,10 ***</span>
<span class="line-new-header">--- 43,11 ---</span>
  #include &lt;dirent.h&gt;
  
  #include &quot;jni.h&quot;
  #include &quot;jni_util.h&quot;
  #include &quot;jlong.h&quot;
<span class="line-added">+ #include &quot;jdk_util.h&quot;</span>
  #include &quot;io_util.h&quot;
  #include &quot;io_util_md.h&quot;
  #include &quot;java_io_FileSystem.h&quot;
  #include &quot;java_io_UnixFileSystem.h&quot;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 89,21 ***</span>
                                    &quot;path&quot;, &quot;Ljava/lang/String;&quot;);
  }
  
  /* -- Path operations -- */
  
<span class="line-removed">- extern int canonicalize(char *path, const char *out, int len);</span>
<span class="line-removed">- </span>
  JNIEXPORT jstring JNICALL
  Java_java_io_UnixFileSystem_canonicalize0(JNIEnv *env, jobject this,
                                            jstring pathname)
  {
      jstring rv = NULL;
  
      WITH_PLATFORM_STRING(env, pathname, path) {
          char canonicalPath[PATH_MAX];
<span class="line-modified">!         if (canonicalize((char *)path,</span>
                           canonicalPath, PATH_MAX) &lt; 0) {
              JNU_ThrowIOExceptionWithLastError(env, &quot;Bad pathname&quot;);
          } else {
  #ifdef MACOSX
              rv = newStringPlatform(env, canonicalPath);
<span class="line-new-header">--- 90,19 ---</span>
                                    &quot;path&quot;, &quot;Ljava/lang/String;&quot;);
  }
  
  /* -- Path operations -- */
  
  JNIEXPORT jstring JNICALL
  Java_java_io_UnixFileSystem_canonicalize0(JNIEnv *env, jobject this,
                                            jstring pathname)
  {
      jstring rv = NULL;
  
      WITH_PLATFORM_STRING(env, pathname, path) {
          char canonicalPath[PATH_MAX];
<span class="line-modified">!         if (JDK_Canonicalize((char *)path,</span>
                           canonicalPath, PATH_MAX) &lt; 0) {
              JNU_ThrowIOExceptionWithLastError(env, &quot;Bad pathname&quot;);
          } else {
  #ifdef MACOSX
              rv = newStringPlatform(env, canonicalPath);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 166,11 ***</span>
          mode = X_OK;
          break;
      default: assert(0);
      }
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
<span class="line-modified">!         if (access(path, mode) == 0) {</span>
              rv = JNI_TRUE;
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
  }
<span class="line-new-header">--- 165,13 ---</span>
          mode = X_OK;
          break;
      default: assert(0);
      }
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
<span class="line-modified">!         int res;</span>
<span class="line-added">+         RESTARTABLE(access(path, mode), res);</span>
<span class="line-added">+         if (res == 0) {</span>
              rv = JNI_TRUE;
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 186,10 ***</span>
<span class="line-new-header">--- 187,11 ---</span>
      jboolean rv = JNI_FALSE;
  
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
          int amode = 0;
          int mode;
<span class="line-added">+         int res;</span>
          switch (access) {
          case java_io_FileSystem_ACCESS_READ:
              if (owneronly)
                  amode = S_IRUSR;
              else
</pre>
<hr />
<pre>
<span class="line-old-header">*** 213,11 ***</span>
          if (statMode(path, &amp;mode)) {
              if (enable)
                  mode |= amode;
              else
                  mode &amp;= ~amode;
<span class="line-modified">!             if (chmod(path, mode) &gt;= 0) {</span>
                  rv = JNI_TRUE;
              }
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
<span class="line-new-header">--- 215,12 ---</span>
          if (statMode(path, &amp;mode)) {
              if (enable)
                  mode |= amode;
              else
                  mode &amp;= ~amode;
<span class="line-modified">!             RESTARTABLE(chmod(path, mode), res);</span>
<span class="line-added">+             if (res == 0) {</span>
                  rv = JNI_TRUE;
              }
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 278,14 ***</span>
          /* The root directory always exists */
          if (strcmp (path, &quot;/&quot;)) {
              fd = handleOpen(path, O_RDWR | O_CREAT | O_EXCL, 0666);
              if (fd &lt; 0) {
                  if (errno != EEXIST)
<span class="line-modified">!                     JNU_ThrowIOExceptionWithLastError(env, path);</span>
              } else {
                  if (close(fd) == -1)
<span class="line-modified">!                     JNU_ThrowIOExceptionWithLastError(env, path);</span>
                  rv = JNI_TRUE;
              }
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
<span class="line-new-header">--- 281,14 ---</span>
          /* The root directory always exists */
          if (strcmp (path, &quot;/&quot;)) {
              fd = handleOpen(path, O_RDWR | O_CREAT | O_EXCL, 0666);
              if (fd &lt; 0) {
                  if (errno != EEXIST)
<span class="line-modified">!                     JNU_ThrowIOExceptionWithLastError(env, &quot;Could not open file&quot;);</span>
              } else {
                  if (close(fd) == -1)
<span class="line-modified">!                     JNU_ThrowIOExceptionWithLastError(env, &quot;Could not close file&quot;);</span>
                  rv = JNI_TRUE;
              }
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 353,17 ***</span>
          (*env)-&gt;DeleteLocalRef(env, name);
      }
      closedir(dir);
  
      /* Copy the final results into an appropriately-sized array */
<span class="line-modified">!     old = rv;</span>
<span class="line-modified">!     rv = (*env)-&gt;NewObjectArray(env, len, str_class, NULL);</span>
<span class="line-modified">!     if (rv == NULL) {</span>
<span class="line-modified">!         return NULL;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     if (JNU_CopyObjectArray(env, rv, old, len) &lt; 0) {</span>
<span class="line-modified">!         return NULL;</span>
      }
      return rv;
  
   error:
      closedir(dir);
<span class="line-new-header">--- 356,19 ---</span>
          (*env)-&gt;DeleteLocalRef(env, name);
      }
      closedir(dir);
  
      /* Copy the final results into an appropriately-sized array */
<span class="line-modified">!     if (len &lt; maxlen) {</span>
<span class="line-modified">!         old = rv;</span>
<span class="line-modified">!         rv = (*env)-&gt;NewObjectArray(env, len, str_class, NULL);</span>
<span class="line-modified">!         if (rv == NULL) {</span>
<span class="line-modified">!             return NULL;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         if (JNU_CopyObjectArray(env, rv, old, len) &lt; 0) {</span>
<span class="line-added">+             return NULL;</span>
<span class="line-added">+         }</span>
      }
      return rv;
  
   error:
      closedir(dir);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 444,12 ***</span>
  {
      jboolean rv = JNI_FALSE;
  
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
          int mode;
          if (statMode(path, &amp;mode)) {
<span class="line-modified">!             if (chmod(path, mode &amp; ~(S_IWUSR | S_IWGRP | S_IWOTH)) &gt;= 0) {</span>
                  rv = JNI_TRUE;
              }
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
<span class="line-new-header">--- 449,14 ---</span>
  {
      jboolean rv = JNI_FALSE;
  
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
          int mode;
<span class="line-added">+         int res;</span>
          if (statMode(path, &amp;mode)) {
<span class="line-modified">!             RESTARTABLE(chmod(path, mode &amp; ~(S_IWUSR | S_IWGRP | S_IWOTH)), res);</span>
<span class="line-added">+             if (res == 0) {</span>
                  rv = JNI_TRUE;
              }
          }
      } END_PLATFORM_STRING(env, path);
      return rv;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 464,10 ***</span>
<span class="line-new-header">--- 471,11 ---</span>
      WITH_FIELD_PLATFORM_STRING(env, file, ids.path, path) {
  #ifdef MACOSX
          struct statfs fsstat;
  #else
          struct statvfs64 fsstat;
<span class="line-added">+         int res;</span>
  #endif
          memset(&amp;fsstat, 0, sizeof(fsstat));
  #ifdef MACOSX
          if (statfs(path, &amp;fsstat) == 0) {
              switch(t) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 486,11 ***</span>
                  default:
                      assert(0);
              }
          }
  #else
<span class="line-modified">!         if (statvfs64(path, &amp;fsstat) == 0) {</span>
              switch(t) {
              case java_io_FileSystem_SPACE_TOTAL:
                  rv = jlong_mul(long_to_jlong(fsstat.f_frsize),
                                 long_to_jlong(fsstat.f_blocks));
                  break;
<span class="line-new-header">--- 494,12 ---</span>
                  default:
                      assert(0);
              }
          }
  #else
<span class="line-modified">!         RESTARTABLE(statvfs64(path, &amp;fsstat), res);</span>
<span class="line-added">+         if (res == 0) {</span>
              switch(t) {
              case java_io_FileSystem_SPACE_TOTAL:
                  rv = jlong_mul(long_to_jlong(fsstat.f_frsize),
                                 long_to_jlong(fsstat.f_blocks));
                  break;
</pre>
<center><a href="TimeZone_md.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="canonicalize_md.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>