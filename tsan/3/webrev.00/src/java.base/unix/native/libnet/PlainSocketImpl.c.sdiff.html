<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/unix/native/libnet/PlainSocketImpl.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="PlainDatagramSocketImpl.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="net_util_md.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libnet/PlainSocketImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  26 
  27 #include &quot;jvm.h&quot;
  28 #include &quot;net_util.h&quot;
  29 
  30 #include &quot;java_net_SocketOptions.h&quot;
  31 #include &quot;java_net_PlainSocketImpl.h&quot;
  32 
  33 /************************************************************************
  34  * PlainSocketImpl
  35  */
  36 
  37 static jfieldID IO_fd_fdID;
  38 
  39 jfieldID psi_fdID;
  40 jfieldID psi_addressID;
  41 jfieldID psi_ipaddressID;
  42 jfieldID psi_portID;
  43 jfieldID psi_localportID;
  44 jfieldID psi_timeoutID;
  45 jfieldID psi_trafficClassID;
<span class="line-removed">  46 jfieldID psi_serverSocketID;</span>
  47 jfieldID psi_fdLockID;
  48 jfieldID psi_closePendingID;
  49 
<span class="line-removed">  50 extern void setDefaultScopeID(JNIEnv *env, struct sockaddr *him);</span>
<span class="line-removed">  51 </span>
  52 /*
  53  * file descriptor used for dup2
  54  */
  55 static int marker_fd = -1;
  56 
  57 
  58 #define SET_NONBLOCKING(fd) {           \
  59         int flags = fcntl(fd, F_GETFL); \
  60         flags |= O_NONBLOCK;            \
  61         fcntl(fd, F_SETFL, flags);      \
  62 }
  63 
  64 #define SET_BLOCKING(fd) {              \
  65         int flags = fcntl(fd, F_GETFL); \
  66         flags &amp;= ~O_NONBLOCK;           \
  67         fcntl(fd, F_SETFL, flags);      \
  68 }
  69 
  70 /*
  71  * Create the marker file descriptor by establishing a loopback connection
</pre>
<hr />
<pre>
 111  * Class:     java_net_PlainSocketImpl
 112  * Method:    initProto
 113  * Signature: ()V
 114  */
 115 JNIEXPORT void JNICALL
 116 Java_java_net_PlainSocketImpl_initProto(JNIEnv *env, jclass cls) {
 117     psi_fdID = (*env)-&gt;GetFieldID(env, cls , &quot;fd&quot;,
 118                                   &quot;Ljava/io/FileDescriptor;&quot;);
 119     CHECK_NULL(psi_fdID);
 120     psi_addressID = (*env)-&gt;GetFieldID(env, cls, &quot;address&quot;,
 121                                           &quot;Ljava/net/InetAddress;&quot;);
 122     CHECK_NULL(psi_addressID);
 123     psi_portID = (*env)-&gt;GetFieldID(env, cls, &quot;port&quot;, &quot;I&quot;);
 124     CHECK_NULL(psi_portID);
 125     psi_localportID = (*env)-&gt;GetFieldID(env, cls, &quot;localport&quot;, &quot;I&quot;);
 126     CHECK_NULL(psi_localportID);
 127     psi_timeoutID = (*env)-&gt;GetFieldID(env, cls, &quot;timeout&quot;, &quot;I&quot;);
 128     CHECK_NULL(psi_timeoutID);
 129     psi_trafficClassID = (*env)-&gt;GetFieldID(env, cls, &quot;trafficClass&quot;, &quot;I&quot;);
 130     CHECK_NULL(psi_trafficClassID);
<span class="line-removed"> 131     psi_serverSocketID = (*env)-&gt;GetFieldID(env, cls, &quot;serverSocket&quot;,</span>
<span class="line-removed"> 132                         &quot;Ljava/net/ServerSocket;&quot;);</span>
<span class="line-removed"> 133     CHECK_NULL(psi_serverSocketID);</span>
 134     psi_fdLockID = (*env)-&gt;GetFieldID(env, cls, &quot;fdLock&quot;,
 135                                       &quot;Ljava/lang/Object;&quot;);
 136     CHECK_NULL(psi_fdLockID);
 137     psi_closePendingID = (*env)-&gt;GetFieldID(env, cls, &quot;closePending&quot;, &quot;Z&quot;);
 138     CHECK_NULL(psi_closePendingID);
 139     IO_fd_fdID = NET_GetFileDescriptorID(env);
 140     CHECK_NULL(IO_fd_fdID);
 141 
 142     initInetAddressIDs(env);
 143     JNU_CHECK_EXCEPTION(env);
 144 
 145     /* Create the marker fd used for dup2 */
 146     marker_fd = getMarkerFD();
 147 }
 148 
 149 /* a global reference to the java.net.SocketException class. In
 150  * socketCreate, we ensure that this is initialized. This is to
 151  * prevent the problem where socketCreate runs out of file
 152  * descriptors, and is then unable to load the exception class.
 153  */
 154 static jclass socketExceptionCls;
 155 
 156 /*
 157  * Class:     java_net_PlainSocketImpl
 158  * Method:    socketCreate
<span class="line-modified"> 159  * Signature: (Z)V */</span>
 160 JNIEXPORT void JNICALL
 161 Java_java_net_PlainSocketImpl_socketCreate(JNIEnv *env, jobject this,
<span class="line-modified"> 162                                            jboolean stream) {</span>
 163     jobject fdObj, ssObj;
 164     int fd;
 165     int type = (stream ? SOCK_STREAM : SOCK_DGRAM);
 166     int domain = ipv6_available() ? AF_INET6 : AF_INET;
 167 
 168     if (socketExceptionCls == NULL) {
 169         jclass c = (*env)-&gt;FindClass(env, &quot;java/net/SocketException&quot;);
 170         CHECK_NULL(c);
 171         socketExceptionCls = (jclass)(*env)-&gt;NewGlobalRef(env, c);
 172         CHECK_NULL(socketExceptionCls);
 173     }
 174     fdObj = (*env)-&gt;GetObjectField(env, this, psi_fdID);
 175 
 176     if (fdObj == NULL) {
 177         (*env)-&gt;ThrowNew(env, socketExceptionCls, &quot;null fd object&quot;);
 178         return;
 179     }
 180 
 181     if ((fd = socket(domain, type, 0)) == -1) {
 182         /* note: if you run out of fds, you may not be able to load
 183          * the exception class, and get a NoClassDefFoundError
 184          * instead.
 185          */
 186         NET_ThrowNew(env, errno, &quot;can&#39;t create socket&quot;);
 187         return;
 188     }
 189 
<span class="line-modified"> 190     /* Disable IPV6_V6ONLY to ensure dual-socket support */</span>
<span class="line-modified"> 191     if (domain == AF_INET6) {</span>


 192         int arg = 0;
 193         if (setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (char*)&amp;arg,
 194                        sizeof(int)) &lt; 0) {
 195             NET_ThrowNew(env, errno, &quot;cannot set IPPROTO_IPV6&quot;);
 196             close(fd);
 197             return;
 198         }
 199     }
 200 
 201     /*
 202      * If this is a server socket then enable SO_REUSEADDR
 203      * automatically and set to non blocking.
 204      */
<span class="line-modified"> 205     ssObj = (*env)-&gt;GetObjectField(env, this, psi_serverSocketID);</span>
<span class="line-removed"> 206     if (ssObj != NULL) {</span>
 207         int arg = 1;
 208         SET_NONBLOCKING(fd);
 209         if (NET_SetSockOpt(fd, SOL_SOCKET, SO_REUSEADDR, (char*)&amp;arg,
 210                        sizeof(arg)) &lt; 0) {
 211             NET_ThrowNew(env, errno, &quot;cannot set SO_REUSEADDR&quot;);
 212             close(fd);
 213             return;
 214         }
 215     }
 216 
 217     (*env)-&gt;SetIntField(env, fdObj, IO_fd_fdID, fd);
 218 }
 219 
 220 /*
 221  * inetAddress is the address object passed to the socket connect
 222  * call.
 223  *
 224  * Class:     java_net_PlainSocketImpl
 225  * Method:    socketConnect
 226  * Signature: (Ljava/net/InetAddress;I)V
</pre>
<hr />
<pre>
 247     SOCKETADDRESS sa;
 248     /* The result of the connection */
 249     int connect_rv = -1;
 250 
 251     if (IS_NULL(fdObj)) {
 252         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Socket closed&quot;);
 253         return;
 254     } else {
 255         fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID);
 256     }
 257     if (IS_NULL(iaObj)) {
 258         JNU_ThrowNullPointerException(env, &quot;inet address argument null.&quot;);
 259         return;
 260     }
 261 
 262     /* connect */
 263     if (NET_InetAddressToSockaddr(env, iaObj, port, &amp;sa, &amp;len,
 264                                   JNI_TRUE) != 0) {
 265         return;
 266     }
<span class="line-removed"> 267     setDefaultScopeID(env, &amp;sa.sa);</span>
 268 
 269     if (trafficClass != 0 &amp;&amp; ipv6_available()) {
 270         NET_SetTrafficClass(&amp;sa, trafficClass);
 271     }
 272 
 273     if (timeout &lt;= 0) {
 274         connect_rv = NET_Connect(fd, &amp;sa.sa, len);
 275 #ifdef __solaris__
 276         if (connect_rv == -1 &amp;&amp; errno == EINPROGRESS ) {
 277 
 278             /* This can happen if a blocking connect is interrupted by a signal.
 279              * See 6343810.
 280              */
 281             while (1) {
 282                 struct pollfd pfd;
 283                 pfd.fd = fd;
 284                 pfd.events = POLLOUT;
 285 
 286                 connect_rv = NET_Poll(&amp;pfd, 1, -1);
 287 
</pre>
<hr />
<pre>
 495     int len = 0;
 496     SOCKETADDRESS sa;
 497 
 498     if (IS_NULL(fdObj)) {
 499         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
 500                         &quot;Socket closed&quot;);
 501         return;
 502     } else {
 503         fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID);
 504     }
 505     if (IS_NULL(iaObj)) {
 506         JNU_ThrowNullPointerException(env, &quot;iaObj is null.&quot;);
 507         return;
 508     }
 509 
 510     /* bind */
 511     if (NET_InetAddressToSockaddr(env, iaObj, localport, &amp;sa,
 512                                   &amp;len, JNI_TRUE) != 0) {
 513         return;
 514     }
<span class="line-removed"> 515     setDefaultScopeID(env, &amp;sa.sa);</span>
 516 
 517     if (NET_Bind(fd, &amp;sa, len) &lt; 0) {
 518         if (errno == EADDRINUSE || errno == EADDRNOTAVAIL ||
 519             errno == EPERM || errno == EACCES) {
 520             NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;BindException&quot;,
 521                            &quot;Bind failed&quot;);
 522         } else {
 523             JNU_ThrowByNameWithMessageAndLastError
 524                 (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Bind failed&quot;);
 525         }
 526         return;
 527     }
 528 
 529     /* set the address */
 530     (*env)-&gt;SetObjectField(env, this, psi_addressID, iaObj);
 531 
 532     /* initialize the local port */
 533     if (localport == 0) {
 534         socklen_t slen = sizeof(SOCKETADDRESS);
 535         /* Now that we&#39;re a connected socket, let&#39;s extract the port number
</pre>
</td>
<td>
<hr />
<pre>
  26 
  27 #include &quot;jvm.h&quot;
  28 #include &quot;net_util.h&quot;
  29 
  30 #include &quot;java_net_SocketOptions.h&quot;
  31 #include &quot;java_net_PlainSocketImpl.h&quot;
  32 
  33 /************************************************************************
  34  * PlainSocketImpl
  35  */
  36 
  37 static jfieldID IO_fd_fdID;
  38 
  39 jfieldID psi_fdID;
  40 jfieldID psi_addressID;
  41 jfieldID psi_ipaddressID;
  42 jfieldID psi_portID;
  43 jfieldID psi_localportID;
  44 jfieldID psi_timeoutID;
  45 jfieldID psi_trafficClassID;

  46 jfieldID psi_fdLockID;
  47 jfieldID psi_closePendingID;
  48 


  49 /*
  50  * file descriptor used for dup2
  51  */
  52 static int marker_fd = -1;
  53 
  54 
  55 #define SET_NONBLOCKING(fd) {           \
  56         int flags = fcntl(fd, F_GETFL); \
  57         flags |= O_NONBLOCK;            \
  58         fcntl(fd, F_SETFL, flags);      \
  59 }
  60 
  61 #define SET_BLOCKING(fd) {              \
  62         int flags = fcntl(fd, F_GETFL); \
  63         flags &amp;= ~O_NONBLOCK;           \
  64         fcntl(fd, F_SETFL, flags);      \
  65 }
  66 
  67 /*
  68  * Create the marker file descriptor by establishing a loopback connection
</pre>
<hr />
<pre>
 108  * Class:     java_net_PlainSocketImpl
 109  * Method:    initProto
 110  * Signature: ()V
 111  */
 112 JNIEXPORT void JNICALL
 113 Java_java_net_PlainSocketImpl_initProto(JNIEnv *env, jclass cls) {
 114     psi_fdID = (*env)-&gt;GetFieldID(env, cls , &quot;fd&quot;,
 115                                   &quot;Ljava/io/FileDescriptor;&quot;);
 116     CHECK_NULL(psi_fdID);
 117     psi_addressID = (*env)-&gt;GetFieldID(env, cls, &quot;address&quot;,
 118                                           &quot;Ljava/net/InetAddress;&quot;);
 119     CHECK_NULL(psi_addressID);
 120     psi_portID = (*env)-&gt;GetFieldID(env, cls, &quot;port&quot;, &quot;I&quot;);
 121     CHECK_NULL(psi_portID);
 122     psi_localportID = (*env)-&gt;GetFieldID(env, cls, &quot;localport&quot;, &quot;I&quot;);
 123     CHECK_NULL(psi_localportID);
 124     psi_timeoutID = (*env)-&gt;GetFieldID(env, cls, &quot;timeout&quot;, &quot;I&quot;);
 125     CHECK_NULL(psi_timeoutID);
 126     psi_trafficClassID = (*env)-&gt;GetFieldID(env, cls, &quot;trafficClass&quot;, &quot;I&quot;);
 127     CHECK_NULL(psi_trafficClassID);



 128     psi_fdLockID = (*env)-&gt;GetFieldID(env, cls, &quot;fdLock&quot;,
 129                                       &quot;Ljava/lang/Object;&quot;);
 130     CHECK_NULL(psi_fdLockID);
 131     psi_closePendingID = (*env)-&gt;GetFieldID(env, cls, &quot;closePending&quot;, &quot;Z&quot;);
 132     CHECK_NULL(psi_closePendingID);
 133     IO_fd_fdID = NET_GetFileDescriptorID(env);
 134     CHECK_NULL(IO_fd_fdID);
 135 
 136     initInetAddressIDs(env);
 137     JNU_CHECK_EXCEPTION(env);
 138 
 139     /* Create the marker fd used for dup2 */
 140     marker_fd = getMarkerFD();
 141 }
 142 
 143 /* a global reference to the java.net.SocketException class. In
 144  * socketCreate, we ensure that this is initialized. This is to
 145  * prevent the problem where socketCreate runs out of file
 146  * descriptors, and is then unable to load the exception class.
 147  */
 148 static jclass socketExceptionCls;
 149 
 150 /*
 151  * Class:     java_net_PlainSocketImpl
 152  * Method:    socketCreate
<span class="line-modified"> 153  * Signature: (ZZ)V */</span>
 154 JNIEXPORT void JNICALL
 155 Java_java_net_PlainSocketImpl_socketCreate(JNIEnv *env, jobject this,
<span class="line-modified"> 156                                            jboolean stream, jboolean isServer) {</span>
 157     jobject fdObj, ssObj;
 158     int fd;
 159     int type = (stream ? SOCK_STREAM : SOCK_DGRAM);
 160     int domain = ipv6_available() ? AF_INET6 : AF_INET;
 161 
 162     if (socketExceptionCls == NULL) {
 163         jclass c = (*env)-&gt;FindClass(env, &quot;java/net/SocketException&quot;);
 164         CHECK_NULL(c);
 165         socketExceptionCls = (jclass)(*env)-&gt;NewGlobalRef(env, c);
 166         CHECK_NULL(socketExceptionCls);
 167     }
 168     fdObj = (*env)-&gt;GetObjectField(env, this, psi_fdID);
 169 
 170     if (fdObj == NULL) {
 171         (*env)-&gt;ThrowNew(env, socketExceptionCls, &quot;null fd object&quot;);
 172         return;
 173     }
 174 
 175     if ((fd = socket(domain, type, 0)) == -1) {
 176         /* note: if you run out of fds, you may not be able to load
 177          * the exception class, and get a NoClassDefFoundError
 178          * instead.
 179          */
 180         NET_ThrowNew(env, errno, &quot;can&#39;t create socket&quot;);
 181         return;
 182     }
 183 
<span class="line-modified"> 184     /*</span>
<span class="line-modified"> 185      * If IPv4 is available, disable IPV6_V6ONLY to ensure dual-socket support.</span>
<span class="line-added"> 186      */</span>
<span class="line-added"> 187     if (domain == AF_INET6 &amp;&amp; ipv4_available()) {</span>
 188         int arg = 0;
 189         if (setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (char*)&amp;arg,
 190                        sizeof(int)) &lt; 0) {
 191             NET_ThrowNew(env, errno, &quot;cannot set IPPROTO_IPV6&quot;);
 192             close(fd);
 193             return;
 194         }
 195     }
 196 
 197     /*
 198      * If this is a server socket then enable SO_REUSEADDR
 199      * automatically and set to non blocking.
 200      */
<span class="line-modified"> 201     if (isServer) {</span>

 202         int arg = 1;
 203         SET_NONBLOCKING(fd);
 204         if (NET_SetSockOpt(fd, SOL_SOCKET, SO_REUSEADDR, (char*)&amp;arg,
 205                        sizeof(arg)) &lt; 0) {
 206             NET_ThrowNew(env, errno, &quot;cannot set SO_REUSEADDR&quot;);
 207             close(fd);
 208             return;
 209         }
 210     }
 211 
 212     (*env)-&gt;SetIntField(env, fdObj, IO_fd_fdID, fd);
 213 }
 214 
 215 /*
 216  * inetAddress is the address object passed to the socket connect
 217  * call.
 218  *
 219  * Class:     java_net_PlainSocketImpl
 220  * Method:    socketConnect
 221  * Signature: (Ljava/net/InetAddress;I)V
</pre>
<hr />
<pre>
 242     SOCKETADDRESS sa;
 243     /* The result of the connection */
 244     int connect_rv = -1;
 245 
 246     if (IS_NULL(fdObj)) {
 247         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Socket closed&quot;);
 248         return;
 249     } else {
 250         fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID);
 251     }
 252     if (IS_NULL(iaObj)) {
 253         JNU_ThrowNullPointerException(env, &quot;inet address argument null.&quot;);
 254         return;
 255     }
 256 
 257     /* connect */
 258     if (NET_InetAddressToSockaddr(env, iaObj, port, &amp;sa, &amp;len,
 259                                   JNI_TRUE) != 0) {
 260         return;
 261     }

 262 
 263     if (trafficClass != 0 &amp;&amp; ipv6_available()) {
 264         NET_SetTrafficClass(&amp;sa, trafficClass);
 265     }
 266 
 267     if (timeout &lt;= 0) {
 268         connect_rv = NET_Connect(fd, &amp;sa.sa, len);
 269 #ifdef __solaris__
 270         if (connect_rv == -1 &amp;&amp; errno == EINPROGRESS ) {
 271 
 272             /* This can happen if a blocking connect is interrupted by a signal.
 273              * See 6343810.
 274              */
 275             while (1) {
 276                 struct pollfd pfd;
 277                 pfd.fd = fd;
 278                 pfd.events = POLLOUT;
 279 
 280                 connect_rv = NET_Poll(&amp;pfd, 1, -1);
 281 
</pre>
<hr />
<pre>
 489     int len = 0;
 490     SOCKETADDRESS sa;
 491 
 492     if (IS_NULL(fdObj)) {
 493         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
 494                         &quot;Socket closed&quot;);
 495         return;
 496     } else {
 497         fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID);
 498     }
 499     if (IS_NULL(iaObj)) {
 500         JNU_ThrowNullPointerException(env, &quot;iaObj is null.&quot;);
 501         return;
 502     }
 503 
 504     /* bind */
 505     if (NET_InetAddressToSockaddr(env, iaObj, localport, &amp;sa,
 506                                   &amp;len, JNI_TRUE) != 0) {
 507         return;
 508     }

 509 
 510     if (NET_Bind(fd, &amp;sa, len) &lt; 0) {
 511         if (errno == EADDRINUSE || errno == EADDRNOTAVAIL ||
 512             errno == EPERM || errno == EACCES) {
 513             NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;BindException&quot;,
 514                            &quot;Bind failed&quot;);
 515         } else {
 516             JNU_ThrowByNameWithMessageAndLastError
 517                 (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Bind failed&quot;);
 518         }
 519         return;
 520     }
 521 
 522     /* set the address */
 523     (*env)-&gt;SetObjectField(env, this, psi_addressID, iaObj);
 524 
 525     /* initialize the local port */
 526     if (localport == 0) {
 527         socklen_t slen = sizeof(SOCKETADDRESS);
 528         /* Now that we&#39;re a connected socket, let&#39;s extract the port number
</pre>
</td>
</tr>
</table>
<center><a href="PlainDatagramSocketImpl.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="net_util_md.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>