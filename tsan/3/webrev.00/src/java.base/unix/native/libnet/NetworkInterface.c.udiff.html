<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/unix/native/libnet/NetworkInterface.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="Inet6AddressImpl.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="PlainDatagramSocketImpl.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libnet/NetworkInterface.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -32,10 +32,11 @@</span>
  
  #if defined(_AIX)
  #include &lt;netinet/in6_var.h&gt;
  #include &lt;sys/ndd_var.h&gt;
  #include &lt;sys/kinfo.h&gt;
<span class="udiff-line-added">+ #include &lt;strings.h&gt;</span>
  #endif
  
  #if defined(__solaris__)
  #include &lt;stropts.h&gt;
  #include &lt;sys/dlpi.h&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -236,10 +237,11 @@</span>
          return NULL;
      }
  
      ifs = enumInterfaces(env);
      if (ifs == NULL) {
<span class="udiff-line-added">+         (*env)-&gt;ReleaseStringUTFChars(env, name, name_utf);</span>
          return NULL;
      }
  
      // search the list of interfaces based on name,
      // if it is virtual sub interface search with parent first.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -318,37 +320,13 @@</span>
      freeif(ifs);
  
      return obj;
  }
  
<span class="udiff-line-modified-removed">- /*</span>
<span class="udiff-line-modified-removed">-  * Class:     java_net_NetworkInterface</span>
<span class="udiff-line-modified-removed">-  * Method:    getByInetAddress0</span>
<span class="udiff-line-removed">-  * Signature: (Ljava/net/InetAddress;)Ljava/net/NetworkInterface;</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- JNIEXPORT jobject JNICALL Java_java_net_NetworkInterface_getByInetAddress0</span>
<span class="udiff-line-removed">-   (JNIEnv *env, jclass cls, jobject iaObj)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     netif *ifs, *curr;</span>
<span class="udiff-line-removed">-     jobject obj = NULL;</span>
<span class="udiff-line-removed">-     jboolean match = JNI_FALSE;</span>
<span class="udiff-line-removed">-     int family = getInetAddress_family(env, iaObj);</span>
<span class="udiff-line-removed">-     JNU_CHECK_EXCEPTION_RETURN(env, NULL);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (family == java_net_InetAddress_IPv4) {</span>
<span class="udiff-line-removed">-         family = AF_INET;</span>
<span class="udiff-line-removed">-     } else if (family == java_net_InetAddress_IPv6) {</span>
<span class="udiff-line-removed">-         family = AF_INET6;</span>
<span class="udiff-line-removed">-     } else {</span>
<span class="udiff-line-removed">-         return NULL; // Invalid family</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     ifs = enumInterfaces(env);</span>
<span class="udiff-line-removed">-     if (ifs == NULL) {</span>
<span class="udiff-line-removed">-         return NULL;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     curr = ifs;</span>
<span class="udiff-line-modified-added">+ // Return the interface in ifs that iaObj is bound to, if any - otherwise NULL</span>
<span class="udiff-line-modified-added">+ static netif* find_bound_interface(JNIEnv *env, netif* ifs, jobject iaObj, int family) {</span>
<span class="udiff-line-modified-added">+     netif* curr = ifs;</span>
      while (curr != NULL) {
          netaddr *addrP = curr-&gt;addr;
  
          // iterate through each address on the interface
          while (addrP != NULL) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -357,15 +335,14 @@</span>
                  if (family == AF_INET) {
                      int address1 = htonl(
                          ((struct sockaddr_in *)addrP-&gt;addr)-&gt;sin_addr.s_addr);
                      int address2 = getInetAddress_addr(env, iaObj);
                      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="udiff-line-modified-removed">-                         goto cleanup;</span>
<span class="udiff-line-modified-added">+                         return NULL;</span>
                      }
                      if (address1 == address2) {
<span class="udiff-line-modified-removed">-                         match = JNI_TRUE;</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-modified-added">+                         return curr;</span>
                      }
                  } else if (family == AF_INET6) {
                      jbyte *bytes = (jbyte *)&amp;(
                          ((struct sockaddr_in6*)addrP-&gt;addr)-&gt;sin6_addr);
                      jbyte caddr[16];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -381,34 +358,121 @@</span>
                              break;
                          }
                          i++;
                      }
                      if (i &gt;= 16) {
<span class="udiff-line-modified-removed">-                         match = JNI_TRUE;</span>
<span class="udiff-line-removed">-                         break;</span>
<span class="udiff-line-modified-added">+                         return curr;</span>
                      }
                  }
              }
  
<span class="udiff-line-removed">-             if (match) {</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
              addrP = addrP-&gt;next;
          }
<span class="udiff-line-added">+         curr = curr-&gt;next;</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         if (match) {</span>
<span class="udiff-line-modified-removed">-             break;</span>
<span class="udiff-line-modified-added">+     return NULL;</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /*</span>
<span class="udiff-line-added">+  * Class:     java_net_NetworkInterface</span>
<span class="udiff-line-added">+  * Method:    boundInetAddress0</span>
<span class="udiff-line-added">+  * Signature: (Ljava/net/InetAddress;)boundInetAddress;</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ JNIEXPORT jboolean JNICALL Java_java_net_NetworkInterface_boundInetAddress0</span>
<span class="udiff-line-added">+     (JNIEnv *env, jclass cls, jobject iaObj)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     netif *ifs = NULL;</span>
<span class="udiff-line-added">+     jboolean bound = JNI_FALSE;</span>
<span class="udiff-line-added">+     int sock;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     int family = getInetAddress_family(env, iaObj);</span>
<span class="udiff-line-added">+     JNU_CHECK_EXCEPTION_RETURN(env, JNI_FALSE);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (family == java_net_InetAddress_IPv4) {</span>
<span class="udiff-line-added">+         family = AF_INET;</span>
<span class="udiff-line-added">+     } else if (family == java_net_InetAddress_IPv6) {</span>
<span class="udiff-line-added">+         family = AF_INET6;</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+         return JNI_FALSE; // Invalid family</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (family == AF_INET) {</span>
<span class="udiff-line-added">+         sock = openSocket(env, AF_INET);</span>
<span class="udiff-line-added">+         if (sock &lt; 0 &amp;&amp; (*env)-&gt;ExceptionOccurred(env)) {</span>
<span class="udiff-line-added">+             return JNI_FALSE;</span>
          }
<span class="udiff-line-modified-removed">-         curr = curr-&gt;next;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         // enumerate IPv4 addresses</span>
<span class="udiff-line-added">+         if (sock &gt;= 0) {</span>
<span class="udiff-line-added">+             ifs = enumIPv4Interfaces(env, sock, ifs);</span>
<span class="udiff-line-added">+             close(sock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if ((*env)-&gt;ExceptionOccurred(env)) {</span>
<span class="udiff-line-added">+                 goto cleanup;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (find_bound_interface(env, ifs, iaObj, family) != NULL)</span>
<span class="udiff-line-added">+             bound = JNI_TRUE;</span>
<span class="udiff-line-added">+     } else if (ipv6_available()) {</span>
<span class="udiff-line-added">+         // If IPv6 is available then enumerate IPv6 addresses.</span>
<span class="udiff-line-added">+         // User can disable ipv6 explicitly by -Djava.net.preferIPv4Stack=true,</span>
<span class="udiff-line-added">+         // so we have to call ipv6_available()</span>
<span class="udiff-line-added">+         sock = openSocket(env, AF_INET6);</span>
<span class="udiff-line-added">+         if (sock &lt; 0) {</span>
<span class="udiff-line-added">+             return JNI_FALSE;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         ifs = enumIPv6Interfaces(env, sock, ifs);</span>
<span class="udiff-line-added">+         close(sock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if ((*env)-&gt;ExceptionOccurred(env)) {</span>
<span class="udiff-line-added">+             goto cleanup;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (find_bound_interface(env, ifs, iaObj, family) != NULL)</span>
<span class="udiff-line-added">+             bound = JNI_TRUE;</span>
      }
  
<span class="udiff-line-added">+ cleanup:</span>
<span class="udiff-line-added">+     freeif(ifs);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return bound;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /*</span>
<span class="udiff-line-added">+  * Class:     java_net_NetworkInterface</span>
<span class="udiff-line-added">+  * Method:    getByInetAddress0</span>
<span class="udiff-line-added">+  * Signature: (Ljava/net/InetAddress;)Ljava/net/NetworkInterface;</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ JNIEXPORT jobject JNICALL Java_java_net_NetworkInterface_getByInetAddress0</span>
<span class="udiff-line-added">+   (JNIEnv *env, jclass cls, jobject iaObj)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     netif *ifs, *curr;</span>
<span class="udiff-line-added">+     jobject obj = NULL;</span>
<span class="udiff-line-added">+     int family = getInetAddress_family(env, iaObj);</span>
<span class="udiff-line-added">+     JNU_CHECK_EXCEPTION_RETURN(env, NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (family == java_net_InetAddress_IPv4) {</span>
<span class="udiff-line-added">+         family = AF_INET;</span>
<span class="udiff-line-added">+     } else if (family == java_net_InetAddress_IPv6) {</span>
<span class="udiff-line-added">+         family = AF_INET6;</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+         return NULL; // Invalid family</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     ifs = enumInterfaces(env);</span>
<span class="udiff-line-added">+     if (ifs == NULL) {</span>
<span class="udiff-line-added">+         return NULL;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     curr = find_bound_interface(env, ifs, iaObj, family);</span>
<span class="udiff-line-added">+ </span>
      // if found create a NetworkInterface
<span class="udiff-line-modified-removed">-     if (match) {</span>
<span class="udiff-line-modified-added">+     if (curr != NULL) {</span>
          obj = createNetworkInterface(env, curr);
      }
  
<span class="udiff-line-removed">- cleanup:</span>
      // release the interface list
      freeif(ifs);
  
      return obj;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -805,21 +869,23 @@</span>
  static netif *enumInterfaces(JNIEnv *env) {
      netif *ifs = NULL;
      int sock;
  
      sock = openSocket(env, AF_INET);
<span class="udiff-line-modified-removed">-     if (sock &lt; 0) {</span>
<span class="udiff-line-modified-added">+     if (sock &lt; 0 &amp;&amp; (*env)-&gt;ExceptionOccurred(env)) {</span>
          return NULL;
      }
  
      // enumerate IPv4 addresses
<span class="udiff-line-modified-removed">-     ifs = enumIPv4Interfaces(env, sock, NULL);</span>
<span class="udiff-line-modified-removed">-     close(sock);</span>
<span class="udiff-line-modified-added">+     if (sock &gt;= 0) {</span>
<span class="udiff-line-modified-added">+         ifs = enumIPv4Interfaces(env, sock, ifs);</span>
<span class="udiff-line-added">+         close(sock);</span>
  
<span class="udiff-line-modified-removed">-     // return partial list if an exception occurs in the middle of process ???</span>
<span class="udiff-line-modified-removed">-     if (ifs == NULL &amp;&amp; (*env)-&gt;ExceptionOccurred(env)) {</span>
<span class="udiff-line-modified-removed">-         return NULL;</span>
<span class="udiff-line-modified-added">+         if ((*env)-&gt;ExceptionOccurred(env)) {</span>
<span class="udiff-line-modified-added">+             freeif(ifs);</span>
<span class="udiff-line-modified-added">+             return NULL;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      // If IPv6 is available then enumerate IPv6 addresses.
      // User can disable ipv6 explicitly by -Djava.net.preferIPv4Stack=true,
      // so we have to call ipv6_available()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1074,13 +1140,13 @@</span>
   */
  static int openSocket(JNIEnv *env, int proto) {
      int sock;
  
      if ((sock = socket(proto, SOCK_DGRAM, 0)) &lt; 0) {
<span class="udiff-line-modified-removed">-         // If EPROTONOSUPPORT is returned it means we don&#39;t have</span>
<span class="udiff-line-modified-removed">-         // support for this proto so don&#39;t throw an exception.</span>
<span class="udiff-line-modified-removed">-         if (errno != EPROTONOSUPPORT) {</span>
<span class="udiff-line-modified-added">+         // If we lack support for this address family or protocol,</span>
<span class="udiff-line-modified-added">+         // don&#39;t throw an exception.</span>
<span class="udiff-line-modified-added">+         if (errno != EPROTONOSUPPORT &amp;&amp; errno != EAFNOSUPPORT) {</span>
              JNU_ThrowByNameWithMessageAndLastError
                  (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Socket creation failed&quot;);
          }
          return -1;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1097,11 +1163,11 @@</span>
   */
  static int openSocketWithFallback(JNIEnv *env, const char *ifname) {
      int sock;
  
      if ((sock = socket(AF_INET, SOCK_DGRAM, 0)) &lt; 0) {
<span class="udiff-line-modified-removed">-         if (errno == EPROTONOSUPPORT) {</span>
<span class="udiff-line-modified-added">+         if (errno == EPROTONOSUPPORT || errno == EAFNOSUPPORT) {</span>
              if ((sock = socket(AF_INET6, SOCK_DGRAM, 0)) &lt; 0) {
                  JNU_ThrowByNameWithMessageAndLastError
                      (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;IPV6 Socket creation failed&quot;);
                  return -1;
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1326,19 +1392,23 @@</span>
  #endif /* __linux__ */
  
  /** AIX **/
  #if defined(_AIX)
  
<span class="udiff-line-added">+ /* seems getkerninfo is guarded by _KERNEL in the system headers */</span>
<span class="udiff-line-added">+ /* see net/proto_uipc.h */</span>
<span class="udiff-line-added">+ int getkerninfo(int, char *, int *, int32long64_t);</span>
<span class="udiff-line-added">+ </span>
  /*
   * Opens a socket for further ioctl calls. Tries AF_INET socket first and
   * if it fails return AF_INET6 socket.
   */
  static int openSocketWithFallback(JNIEnv *env, const char *ifname) {
      int sock;
  
      if ((sock = socket(AF_INET, SOCK_DGRAM, 0)) &lt; 0) {
<span class="udiff-line-modified-removed">-         if (errno == EPROTONOSUPPORT) {</span>
<span class="udiff-line-modified-added">+         if (errno == EPROTONOSUPPORT || errno == EAFNOSUPPORT) {</span>
              if ((sock = socket(AF_INET6, SOCK_DGRAM, 0)) &lt; 0) {
                  JNU_ThrowByNameWithMessageAndLastError
                      (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;IPV6 Socket creation failed&quot;);
                  return -1;
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1545,11 +1615,11 @@</span>
          JNU_ThrowOutOfMemoryError(env,
              &quot;Network interface getMacAddress native buffer allocation failed&quot;);
          return -1;
      }
  
<span class="udiff-line-modified-removed">-     if (getkerninfo(KINFO_NDD, nddp, &amp;size, 0) &lt; 0) {</span>
<span class="udiff-line-modified-added">+     if (getkerninfo(KINFO_NDD, (char*) nddp, &amp;size, 0) &lt; 0) {</span>
          perror(&quot;getkerninfo 2&quot;);
          free(nddp);
          return -1;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1612,11 +1682,11 @@</span>
  static int openSocketWithFallback(JNIEnv *env, const char *ifname) {
      int sock, alreadyV6 = 0;
      struct lifreq if2;
  
      if ((sock = socket(AF_INET, SOCK_DGRAM, 0)) &lt; 0) {
<span class="udiff-line-modified-removed">-         if (errno == EPROTONOSUPPORT) {</span>
<span class="udiff-line-modified-added">+         if (errno == EPROTONOSUPPORT || errno == EAFNOSUPPORT) {</span>
              if ((sock = socket(AF_INET6, SOCK_DGRAM, 0)) &lt; 0) {
                  JNU_ThrowByNameWithMessageAndLastError
                      (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;IPV6 Socket creation failed&quot;);
                  return -1;
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1963,11 +2033,11 @@</span>
   */
  static int openSocketWithFallback(JNIEnv *env, const char *ifname) {
      int sock;
  
      if ((sock = socket(AF_INET, SOCK_DGRAM, 0)) &lt; 0) {
<span class="udiff-line-modified-removed">-         if (errno == EPROTONOSUPPORT) {</span>
<span class="udiff-line-modified-added">+         if (errno == EPROTONOSUPPORT || errno == EAFNOSUPPORT) {</span>
              if ((sock = socket(AF_INET6, SOCK_DGRAM, 0)) &lt; 0) {
                  JNU_ThrowByNameWithMessageAndLastError
                      (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;IPV6 Socket creation failed&quot;);
                  return -1;
              }
</pre>
<center><a href="Inet6AddressImpl.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="PlainDatagramSocketImpl.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>