<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/unix/native/libnet/PlainSocketImpl.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="PlainDatagramSocketImpl.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="net_util_md.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libnet/PlainSocketImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 41,16 ***</span>
  jfieldID psi_ipaddressID;
  jfieldID psi_portID;
  jfieldID psi_localportID;
  jfieldID psi_timeoutID;
  jfieldID psi_trafficClassID;
<span class="line-removed">- jfieldID psi_serverSocketID;</span>
  jfieldID psi_fdLockID;
  jfieldID psi_closePendingID;
  
<span class="line-removed">- extern void setDefaultScopeID(JNIEnv *env, struct sockaddr *him);</span>
<span class="line-removed">- </span>
  /*
   * file descriptor used for dup2
   */
  static int marker_fd = -1;
  
<span class="line-new-header">--- 41,13 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 126,13 ***</span>
      CHECK_NULL(psi_localportID);
      psi_timeoutID = (*env)-&gt;GetFieldID(env, cls, &quot;timeout&quot;, &quot;I&quot;);
      CHECK_NULL(psi_timeoutID);
      psi_trafficClassID = (*env)-&gt;GetFieldID(env, cls, &quot;trafficClass&quot;, &quot;I&quot;);
      CHECK_NULL(psi_trafficClassID);
<span class="line-removed">-     psi_serverSocketID = (*env)-&gt;GetFieldID(env, cls, &quot;serverSocket&quot;,</span>
<span class="line-removed">-                         &quot;Ljava/net/ServerSocket;&quot;);</span>
<span class="line-removed">-     CHECK_NULL(psi_serverSocketID);</span>
      psi_fdLockID = (*env)-&gt;GetFieldID(env, cls, &quot;fdLock&quot;,
                                        &quot;Ljava/lang/Object;&quot;);
      CHECK_NULL(psi_fdLockID);
      psi_closePendingID = (*env)-&gt;GetFieldID(env, cls, &quot;closePending&quot;, &quot;Z&quot;);
      CHECK_NULL(psi_closePendingID);
<span class="line-new-header">--- 123,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 154,14 ***</span>
  static jclass socketExceptionCls;
  
  /*
   * Class:     java_net_PlainSocketImpl
   * Method:    socketCreate
<span class="line-modified">!  * Signature: (Z)V */</span>
  JNIEXPORT void JNICALL
  Java_java_net_PlainSocketImpl_socketCreate(JNIEnv *env, jobject this,
<span class="line-modified">!                                            jboolean stream) {</span>
      jobject fdObj, ssObj;
      int fd;
      int type = (stream ? SOCK_STREAM : SOCK_DGRAM);
      int domain = ipv6_available() ? AF_INET6 : AF_INET;
  
<span class="line-new-header">--- 148,14 ---</span>
  static jclass socketExceptionCls;
  
  /*
   * Class:     java_net_PlainSocketImpl
   * Method:    socketCreate
<span class="line-modified">!  * Signature: (ZZ)V */</span>
  JNIEXPORT void JNICALL
  Java_java_net_PlainSocketImpl_socketCreate(JNIEnv *env, jobject this,
<span class="line-modified">!                                            jboolean stream, jboolean isServer) {</span>
      jobject fdObj, ssObj;
      int fd;
      int type = (stream ? SOCK_STREAM : SOCK_DGRAM);
      int domain = ipv6_available() ? AF_INET6 : AF_INET;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 185,12 ***</span>
           */
          NET_ThrowNew(env, errno, &quot;can&#39;t create socket&quot;);
          return;
      }
  
<span class="line-modified">!     /* Disable IPV6_V6ONLY to ensure dual-socket support */</span>
<span class="line-modified">!     if (domain == AF_INET6) {</span>
          int arg = 0;
          if (setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (char*)&amp;arg,
                         sizeof(int)) &lt; 0) {
              NET_ThrowNew(env, errno, &quot;cannot set IPPROTO_IPV6&quot;);
              close(fd);
<span class="line-new-header">--- 179,14 ---</span>
           */
          NET_ThrowNew(env, errno, &quot;can&#39;t create socket&quot;);
          return;
      }
  
<span class="line-modified">!     /*</span>
<span class="line-modified">!      * If IPv4 is available, disable IPV6_V6ONLY to ensure dual-socket support.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     if (domain == AF_INET6 &amp;&amp; ipv4_available()) {</span>
          int arg = 0;
          if (setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (char*)&amp;arg,
                         sizeof(int)) &lt; 0) {
              NET_ThrowNew(env, errno, &quot;cannot set IPPROTO_IPV6&quot;);
              close(fd);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 200,12 ***</span>
  
      /*
       * If this is a server socket then enable SO_REUSEADDR
       * automatically and set to non blocking.
       */
<span class="line-modified">!     ssObj = (*env)-&gt;GetObjectField(env, this, psi_serverSocketID);</span>
<span class="line-removed">-     if (ssObj != NULL) {</span>
          int arg = 1;
          SET_NONBLOCKING(fd);
          if (NET_SetSockOpt(fd, SOL_SOCKET, SO_REUSEADDR, (char*)&amp;arg,
                         sizeof(arg)) &lt; 0) {
              NET_ThrowNew(env, errno, &quot;cannot set SO_REUSEADDR&quot;);
<span class="line-new-header">--- 196,11 ---</span>
  
      /*
       * If this is a server socket then enable SO_REUSEADDR
       * automatically and set to non blocking.
       */
<span class="line-modified">!     if (isServer) {</span>
          int arg = 1;
          SET_NONBLOCKING(fd);
          if (NET_SetSockOpt(fd, SOL_SOCKET, SO_REUSEADDR, (char*)&amp;arg,
                         sizeof(arg)) &lt; 0) {
              NET_ThrowNew(env, errno, &quot;cannot set SO_REUSEADDR&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 262,11 ***</span>
      /* connect */
      if (NET_InetAddressToSockaddr(env, iaObj, port, &amp;sa, &amp;len,
                                    JNI_TRUE) != 0) {
          return;
      }
<span class="line-removed">-     setDefaultScopeID(env, &amp;sa.sa);</span>
  
      if (trafficClass != 0 &amp;&amp; ipv6_available()) {
          NET_SetTrafficClass(&amp;sa, trafficClass);
      }
  
<span class="line-new-header">--- 257,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 510,11 ***</span>
      /* bind */
      if (NET_InetAddressToSockaddr(env, iaObj, localport, &amp;sa,
                                    &amp;len, JNI_TRUE) != 0) {
          return;
      }
<span class="line-removed">-     setDefaultScopeID(env, &amp;sa.sa);</span>
  
      if (NET_Bind(fd, &amp;sa, len) &lt; 0) {
          if (errno == EADDRINUSE || errno == EADDRNOTAVAIL ||
              errno == EPERM || errno == EACCES) {
              NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;BindException&quot;,
<span class="line-new-header">--- 504,10 ---</span>
</pre>
<center><a href="PlainDatagramSocketImpl.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="net_util_md.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>