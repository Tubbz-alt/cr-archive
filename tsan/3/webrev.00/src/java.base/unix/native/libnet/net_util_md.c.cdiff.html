<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/unix/native/libnet/net_util_md.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="PlainSocketImpl.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="net_util_md.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libnet/net_util_md.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 71,54 ***</span>
  #endif
  #if defined(__solaris__) &amp;&amp; !defined(UDP_EXCLBIND)
  #define UDP_EXCLBIND            0x0101
  #endif
  
<span class="line-removed">- void setDefaultScopeID(JNIEnv *env, struct sockaddr *him)</span>
<span class="line-removed">- {</span>
<span class="line-removed">- #ifdef MACOSX</span>
<span class="line-removed">-     static jclass ni_class = NULL;</span>
<span class="line-removed">-     static jfieldID ni_defaultIndexID;</span>
<span class="line-removed">-     if (ni_class == NULL) {</span>
<span class="line-removed">-         jclass c = (*env)-&gt;FindClass(env, &quot;java/net/NetworkInterface&quot;);</span>
<span class="line-removed">-         CHECK_NULL(c);</span>
<span class="line-removed">-         c = (*env)-&gt;NewGlobalRef(env, c);</span>
<span class="line-removed">-         CHECK_NULL(c);</span>
<span class="line-removed">-         ni_defaultIndexID = (*env)-&gt;GetStaticFieldID(env, c, &quot;defaultIndex&quot;, &quot;I&quot;);</span>
<span class="line-removed">-         CHECK_NULL(ni_defaultIndexID);</span>
<span class="line-removed">-         ni_class = c;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     int defaultIndex;</span>
<span class="line-removed">-     struct sockaddr_in6 *sin6 = (struct sockaddr_in6 *)him;</span>
<span class="line-removed">-     if (sin6-&gt;sin6_family == AF_INET6 &amp;&amp; (sin6-&gt;sin6_scope_id == 0) &amp;&amp;</span>
<span class="line-removed">-         (IN6_IS_ADDR_LINKLOCAL(&amp;sin6-&gt;sin6_addr) ||</span>
<span class="line-removed">-          IN6_IS_ADDR_MULTICAST(&amp;sin6-&gt;sin6_addr))) {</span>
<span class="line-removed">-         defaultIndex = (*env)-&gt;GetStaticIntField(env, ni_class,</span>
<span class="line-removed">-                                                  ni_defaultIndexID);</span>
<span class="line-removed">-         sin6-&gt;sin6_scope_id = defaultIndex;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- int getDefaultScopeID(JNIEnv *env) {</span>
<span class="line-removed">-     int defaultIndex = 0;</span>
<span class="line-removed">-     static jclass ni_class = NULL;</span>
<span class="line-removed">-     static jfieldID ni_defaultIndexID;</span>
<span class="line-removed">-     if (ni_class == NULL) {</span>
<span class="line-removed">-         jclass c = (*env)-&gt;FindClass(env, &quot;java/net/NetworkInterface&quot;);</span>
<span class="line-removed">-         CHECK_NULL_RETURN(c, 0);</span>
<span class="line-removed">-         c = (*env)-&gt;NewGlobalRef(env, c);</span>
<span class="line-removed">-         CHECK_NULL_RETURN(c, 0);</span>
<span class="line-removed">-         ni_defaultIndexID = (*env)-&gt;GetStaticFieldID(env, c, &quot;defaultIndex&quot;, &quot;I&quot;);</span>
<span class="line-removed">-         CHECK_NULL_RETURN(ni_defaultIndexID, 0);</span>
<span class="line-removed">-         ni_class = c;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     defaultIndex = (*env)-&gt;GetStaticIntField(env, ni_class,</span>
<span class="line-removed">-                                              ni_defaultIndexID);</span>
<span class="line-removed">-     return defaultIndex;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  #define RESTARTABLE(_cmd, _result) do { \
      do { \
          _result = _cmd; \
      } while((_result == -1) &amp;&amp; (errno == EINTR)); \
  } while(0)
<span class="line-new-header">--- 71,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 215,30 ***</span>
  
      return limit;
  }
  #endif
  
<span class="line-removed">- #ifdef __linux__</span>
<span class="line-removed">- static int vinit = 0;</span>
<span class="line-removed">- static int kernelV24 = 0;</span>
<span class="line-removed">- static int vinit24 = 0;</span>
<span class="line-removed">- </span>
<span class="line-removed">- int kernelIsV24 () {</span>
<span class="line-removed">-     if (!vinit24) {</span>
<span class="line-removed">-         struct utsname sysinfo;</span>
<span class="line-removed">-         if (uname(&amp;sysinfo) == 0) {</span>
<span class="line-removed">-             sysinfo.release[3] = &#39;\0&#39;;</span>
<span class="line-removed">-             if (strcmp(sysinfo.release, &quot;2.4&quot;) == 0) {</span>
<span class="line-removed">-                 kernelV24 = JNI_TRUE;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         vinit24 = 1;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     return kernelV24;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
  void
  NET_ThrowByNameWithLastError(JNIEnv *env, const char *name,
                     const char *defaultDetail) {
      JNU_ThrowByNameWithMessageAndLastError(env, name, defaultDetail);
  }
<span class="line-new-header">--- 171,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 276,10 ***</span>
<span class="line-new-header">--- 212,20 ---</span>
      jclass cls = (*env)-&gt;FindClass(env, &quot;java/io/FileDescriptor&quot;);
      CHECK_NULL_RETURN(cls, NULL);
      return (*env)-&gt;GetFieldID(env, cls, &quot;fd&quot;, &quot;I&quot;);
  }
  
<span class="line-added">+ jint  IPv4_supported()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     int fd = socket(AF_INET, SOCK_STREAM, 0) ;</span>
<span class="line-added">+     if (fd &lt; 0) {</span>
<span class="line-added">+         return JNI_FALSE;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     close(fd);</span>
<span class="line-added">+     return JNI_TRUE;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  #if defined(DONT_ENABLE_IPV6)
  jint  IPv6_supported()
  {
      return JNI_FALSE;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 440,289 ***</span>
          }
          free(buf);
      }
  }
  
<span class="line-modified">! #if defined(__linux__)</span>
<span class="line-removed">- </span>
<span class="line-removed">- /* following code creates a list of addresses from the kernel</span>
<span class="line-removed">-  * routing table that are routed via the loopback address.</span>
<span class="line-removed">-  * We check all destination addresses against this table</span>
<span class="line-removed">-  * and override the scope_id field to use the relevant value for &quot;lo&quot;</span>
<span class="line-removed">-  * in order to work-around the Linux bug that prevents packets destined</span>
<span class="line-removed">-  * for certain local addresses from being sent via a physical interface.</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- </span>
<span class="line-removed">- struct loopback_route {</span>
<span class="line-removed">-     struct in6_addr addr; /* destination address */</span>
<span class="line-removed">-     int plen; /* prefix length */</span>
<span class="line-removed">- };</span>
<span class="line-removed">- </span>
<span class="line-removed">- static struct loopback_route *loRoutes = 0;</span>
<span class="line-removed">- static int nRoutes = 0; /* number of routes */</span>
<span class="line-removed">- static int loRoutes_size = 16; /* initial size */</span>
<span class="line-removed">- static int lo_scope_id = 0;</span>
<span class="line-removed">- </span>
<span class="line-removed">- static void initLoopbackRoutes();</span>
<span class="line-removed">- </span>
<span class="line-removed">- void printAddr (struct in6_addr *addr) {</span>
<span class="line-removed">-     int i;</span>
<span class="line-removed">-     for (i=0; i&lt;16; i++) {</span>
<span class="line-removed">-         printf (&quot;%02x&quot;, addr-&gt;s6_addr[i]);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     printf (&quot;\n&quot;);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- static jboolean needsLoopbackRoute (struct in6_addr* dest_addr) {</span>
<span class="line-removed">-     int byte_count;</span>
<span class="line-removed">-     int extra_bits, i;</span>
<span class="line-removed">-     struct loopback_route *ptr;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (loRoutes == 0) {</span>
<span class="line-removed">-         initLoopbackRoutes();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     for (ptr = loRoutes, i=0; i&lt;nRoutes; i++, ptr++) {</span>
<span class="line-removed">-         struct in6_addr *target_addr=&amp;ptr-&gt;addr;</span>
<span class="line-removed">-         int dest_plen = ptr-&gt;plen;</span>
<span class="line-removed">-         byte_count = dest_plen &gt;&gt; 3;</span>
<span class="line-removed">-         extra_bits = dest_plen &amp; 0x3;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (byte_count &gt; 0) {</span>
<span class="line-removed">-             if (memcmp(target_addr, dest_addr, byte_count)) {</span>
<span class="line-removed">-                 continue;  /* no match */</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (extra_bits &gt; 0) {</span>
<span class="line-removed">-             unsigned char c1 = ((unsigned char *)target_addr)[byte_count];</span>
<span class="line-removed">-             unsigned char c2 = ((unsigned char *)&amp;dest_addr)[byte_count];</span>
<span class="line-removed">-             unsigned char mask = 0xff &lt;&lt; (8 - extra_bits);</span>
<span class="line-removed">-             if ((c1 &amp; mask) != (c2 &amp; mask)) {</span>
<span class="line-removed">-                 continue;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return JNI_TRUE;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     return JNI_FALSE;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">- static void initLoopbackRoutes() {</span>
<span class="line-removed">-     FILE *f;</span>
<span class="line-removed">-     char srcp[8][5];</span>
<span class="line-removed">-     char hopp[8][5];</span>
<span class="line-removed">-     int dest_plen, src_plen, use, refcnt, metric;</span>
<span class="line-removed">-     unsigned long flags;</span>
<span class="line-removed">-     char dest_str[40];</span>
<span class="line-removed">-     struct in6_addr dest_addr;</span>
<span class="line-removed">-     char device[16];</span>
<span class="line-removed">-     struct loopback_route *loRoutesTemp;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (loRoutes != 0) {</span>
<span class="line-removed">-         free (loRoutes);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     loRoutes = calloc (loRoutes_size, sizeof(struct loopback_route));</span>
<span class="line-removed">-     if (loRoutes == 0) {</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * Scan /proc/net/ipv6_route looking for a matching</span>
<span class="line-removed">-      * route.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     if ((f = fopen(&quot;/proc/net/ipv6_route&quot;, &quot;r&quot;)) == NULL) {</span>
<span class="line-removed">-         return ;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     while (fscanf(f, &quot;%4s%4s%4s%4s%4s%4s%4s%4s %02x &quot;</span>
<span class="line-removed">-                      &quot;%4s%4s%4s%4s%4s%4s%4s%4s %02x &quot;</span>
<span class="line-removed">-                      &quot;%4s%4s%4s%4s%4s%4s%4s%4s &quot;</span>
<span class="line-removed">-                      &quot;%08x %08x %08x %08lx %8s&quot;,</span>
<span class="line-removed">-                      dest_str, &amp;dest_str[5], &amp;dest_str[10], &amp;dest_str[15],</span>
<span class="line-removed">-                      &amp;dest_str[20], &amp;dest_str[25], &amp;dest_str[30], &amp;dest_str[35],</span>
<span class="line-removed">-                      &amp;dest_plen,</span>
<span class="line-removed">-                      srcp[0], srcp[1], srcp[2], srcp[3],</span>
<span class="line-removed">-                      srcp[4], srcp[5], srcp[6], srcp[7],</span>
<span class="line-removed">-                      &amp;src_plen,</span>
<span class="line-removed">-                      hopp[0], hopp[1], hopp[2], hopp[3],</span>
<span class="line-removed">-                      hopp[4], hopp[5], hopp[6], hopp[7],</span>
<span class="line-removed">-                      &amp;metric, &amp;use, &amp;refcnt, &amp;flags, device) == 31) {</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * Some routes should be ignored</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         if ( (dest_plen &lt; 0 || dest_plen &gt; 128)  ||</span>
<span class="line-removed">-              (src_plen != 0) ||</span>
<span class="line-removed">-              (flags &amp; (RTF_POLICY | RTF_FLOW)) ||</span>
<span class="line-removed">-              ((flags &amp; RTF_REJECT) &amp;&amp; dest_plen == 0) ) {</span>
<span class="line-removed">-             continue;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * Convert the destination address</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         dest_str[4] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[9] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[14] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[19] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[24] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[29] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[34] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[39] = &#39;\0&#39;;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (inet_pton(AF_INET6, dest_str, &amp;dest_addr) &lt; 0) {</span>
<span class="line-removed">-             /* not an Ipv6 address */</span>
<span class="line-removed">-             continue;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         if (strcmp(device, &quot;lo&quot;) != 0) {</span>
<span class="line-removed">-             /* Not a loopback route */</span>
<span class="line-removed">-             continue;</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             if (nRoutes == loRoutes_size) {</span>
<span class="line-removed">-                 loRoutesTemp = realloc (loRoutes, loRoutes_size *</span>
<span class="line-removed">-                                         sizeof (struct loopback_route) * 2);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 if (loRoutesTemp == 0) {</span>
<span class="line-removed">-                     free(loRoutes);</span>
<span class="line-removed">-                     loRoutes = NULL;</span>
<span class="line-removed">-                     nRoutes = 0;</span>
<span class="line-removed">-                     fclose (f);</span>
<span class="line-removed">-                     return;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 loRoutes=loRoutesTemp;</span>
<span class="line-removed">-                 loRoutes_size *= 2;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             memcpy (&amp;loRoutes[nRoutes].addr,&amp;dest_addr,sizeof(struct in6_addr));</span>
<span class="line-removed">-             loRoutes[nRoutes].plen = dest_plen;</span>
<span class="line-removed">-             nRoutes ++;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     fclose (f);</span>
<span class="line-removed">-     {</span>
<span class="line-removed">-         /* now find the scope_id for &quot;lo&quot; */</span>
<span class="line-removed">- </span>
<span class="line-removed">-         char devname[21];</span>
<span class="line-removed">-         char addr6p[8][5];</span>
<span class="line-removed">-         int plen, scope, dad_status, if_idx;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if ((f = fopen(&quot;/proc/net/if_inet6&quot;, &quot;r&quot;)) != NULL) {</span>
<span class="line-removed">-             while (fscanf(f, &quot;%4s%4s%4s%4s%4s%4s%4s%4s %08x %02x %02x %02x %20s\n&quot;,</span>
<span class="line-removed">-                       addr6p[0], addr6p[1], addr6p[2], addr6p[3],</span>
<span class="line-removed">-                       addr6p[4], addr6p[5], addr6p[6], addr6p[7],</span>
<span class="line-removed">-                   &amp;if_idx, &amp;plen, &amp;scope, &amp;dad_status, devname) == 13) {</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 if (strcmp(devname, &quot;lo&quot;) == 0) {</span>
<span class="line-removed">-                     /*</span>
<span class="line-removed">-                      * Found - so just return the index</span>
<span class="line-removed">-                      */</span>
<span class="line-removed">-                     fclose(f);</span>
<span class="line-removed">-                     lo_scope_id = if_idx;</span>
<span class="line-removed">-                     return;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             fclose(f);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- /*</span>
<span class="line-removed">-  * Following is used for binding to local addresses. Equivalent</span>
<span class="line-removed">-  * to code above, for bind().</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- </span>
<span class="line-removed">- struct localinterface {</span>
<span class="line-removed">-     int index;</span>
<span class="line-removed">-     char localaddr [16];</span>
<span class="line-removed">- };</span>
<span class="line-removed">- </span>
<span class="line-removed">- static struct localinterface *localifs = 0;</span>
<span class="line-removed">- static int localifsSize = 0;    /* size of array */</span>
<span class="line-removed">- static int nifs = 0;            /* number of entries used in array */</span>
<span class="line-removed">- </span>
<span class="line-removed">- /* not thread safe: make sure called once from one thread */</span>
<span class="line-removed">- </span>
<span class="line-removed">- static void initLocalIfs () {</span>
<span class="line-removed">-     FILE *f;</span>
<span class="line-removed">-     unsigned char staddr [16];</span>
<span class="line-removed">-     char ifname [33];</span>
<span class="line-removed">-     struct localinterface *lif=0;</span>
<span class="line-removed">-     struct localinterface *localifsTemp;</span>
<span class="line-removed">-     int index, x1, x2, x3;</span>
<span class="line-removed">-     unsigned int u0,u1,u2,u3,u4,u5,u6,u7,u8,u9,ua,ub,uc,ud,ue,uf;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if ((f = fopen(&quot;/proc/net/if_inet6&quot;, &quot;r&quot;)) == NULL) {</span>
<span class="line-removed">-         return ;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     while (fscanf (f, &quot;%2x%2x%2x%2x%2x%2x%2x%2x%2x%2x%2x%2x%2x%2x%2x%2x &quot;</span>
<span class="line-removed">-                 &quot;%d %x %x %x %32s&quot;,&amp;u0,&amp;u1,&amp;u2,&amp;u3,&amp;u4,&amp;u5,&amp;u6,&amp;u7,</span>
<span class="line-removed">-                 &amp;u8,&amp;u9,&amp;ua,&amp;ub,&amp;uc,&amp;ud,&amp;ue,&amp;uf,</span>
<span class="line-removed">-                 &amp;index, &amp;x1, &amp;x2, &amp;x3, ifname) == 21) {</span>
<span class="line-removed">-         staddr[0] = (unsigned char)u0;</span>
<span class="line-removed">-         staddr[1] = (unsigned char)u1;</span>
<span class="line-removed">-         staddr[2] = (unsigned char)u2;</span>
<span class="line-removed">-         staddr[3] = (unsigned char)u3;</span>
<span class="line-removed">-         staddr[4] = (unsigned char)u4;</span>
<span class="line-removed">-         staddr[5] = (unsigned char)u5;</span>
<span class="line-removed">-         staddr[6] = (unsigned char)u6;</span>
<span class="line-removed">-         staddr[7] = (unsigned char)u7;</span>
<span class="line-removed">-         staddr[8] = (unsigned char)u8;</span>
<span class="line-removed">-         staddr[9] = (unsigned char)u9;</span>
<span class="line-removed">-         staddr[10] = (unsigned char)ua;</span>
<span class="line-removed">-         staddr[11] = (unsigned char)ub;</span>
<span class="line-removed">-         staddr[12] = (unsigned char)uc;</span>
<span class="line-removed">-         staddr[13] = (unsigned char)ud;</span>
<span class="line-removed">-         staddr[14] = (unsigned char)ue;</span>
<span class="line-removed">-         staddr[15] = (unsigned char)uf;</span>
<span class="line-removed">-         nifs ++;</span>
<span class="line-removed">-         if (nifs &gt; localifsSize) {</span>
<span class="line-removed">-             localifsTemp = (struct localinterface *) realloc(</span>
<span class="line-removed">-                         localifs, sizeof (struct localinterface)* (localifsSize+5));</span>
<span class="line-removed">-             if (localifsTemp == 0) {</span>
<span class="line-removed">-                 free(localifs);</span>
<span class="line-removed">-                 localifs = 0;</span>
<span class="line-removed">-                 localifsSize = 0;</span>
<span class="line-removed">-                 nifs = 0;</span>
<span class="line-removed">-                 fclose(f);</span>
<span class="line-removed">-                 return;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             localifs = localifsTemp;</span>
<span class="line-removed">-             lif = localifs + localifsSize;</span>
<span class="line-removed">-             localifsSize += 5;</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             lif ++;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         memcpy (lif-&gt;localaddr, staddr, 16);</span>
<span class="line-removed">-         lif-&gt;index = index;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     fclose (f);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- /* return the scope_id (interface index) of the</span>
<span class="line-removed">-  * interface corresponding to the given address</span>
<span class="line-removed">-  * returns 0 if no match found</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- </span>
<span class="line-removed">- static int getLocalScopeID (char *addr) {</span>
<span class="line-removed">-     struct localinterface *lif;</span>
<span class="line-removed">-     int i;</span>
<span class="line-removed">-     if (localifs == 0) {</span>
<span class="line-removed">-         initLocalIfs();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     for (i=0, lif=localifs; i&lt;nifs; i++, lif++) {</span>
<span class="line-removed">-         if (memcmp (addr, lif-&gt;localaddr, 16) == 0) {</span>
<span class="line-removed">-             return lif-&gt;index;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     return 0;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- void platformInit () {</span>
<span class="line-removed">-     initLoopbackRoutes();</span>
<span class="line-removed">-     initLocalIfs();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #elif defined(_AIX)</span>
  
  /* Initialize stubs for blocking I/O workarounds (see src/solaris/native/java/net/linux_close.c) */
  extern void aix_close_init();
  
  void platformInit () {
<span class="line-new-header">--- 386,11 ---</span>
          }
          free(buf);
      }
  }
  
<span class="line-modified">! #if defined(_AIX)</span>
  
  /* Initialize stubs for blocking I/O workarounds (see src/solaris/native/java/net/linux_close.c) */
  extern void aix_close_init();
  
  void platformInit () {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 804,75 ***</span>
          sa-&gt;sa6.sin6_family = AF_INET6;
          if (len != NULL) {
              *len = sizeof(struct sockaddr_in6);
          }
  
<span class="line-removed">- #ifdef __linux__</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * On Linux if we are connecting to a link-local address</span>
<span class="line-removed">-          * we need to specify the interface in the scope_id (2.4 kernel only)</span>
<span class="line-removed">-          *</span>
<span class="line-removed">-          * If the scope was cached then we use the cached value. If not cached but</span>
<span class="line-removed">-          * specified in the Inet6Address we use that, but we first check if the</span>
<span class="line-removed">-          * address needs to be routed via the loopback interface. In this case,</span>
<span class="line-removed">-          * we override the specified value with that of the loopback interface.</span>
<span class="line-removed">-          * If no cached value exists and no value was specified by user, then</span>
<span class="line-removed">-          * we try to determine a value from the routing table. In all these</span>
<span class="line-removed">-          * cases the used value is cached for further use.</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         if (IN6_IS_ADDR_LINKLOCAL(&amp;sa-&gt;sa6.sin6_addr)) {</span>
<span class="line-removed">-             unsigned int cached_scope_id = 0, scope_id = 0;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             if (ia6_cachedscopeidID) {</span>
<span class="line-removed">-                 cached_scope_id = (int)(*env)-&gt;GetIntField(env, iaObj, ia6_cachedscopeidID);</span>
<span class="line-removed">-                 /* if cached value exists then use it. Otherwise, check</span>
<span class="line-removed">-                  * if scope is set in the address.</span>
<span class="line-removed">-                  */</span>
<span class="line-removed">-                 if (!cached_scope_id) {</span>
<span class="line-removed">-                     if (ia6_scopeidID) {</span>
<span class="line-removed">-                         scope_id = getInet6Address_scopeid(env, iaObj);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     if (scope_id != 0) {</span>
<span class="line-removed">-                         /* check user-specified value for loopback case</span>
<span class="line-removed">-                          * that needs to be overridden</span>
<span class="line-removed">-                          */</span>
<span class="line-removed">-                         if (kernelIsV24() &amp;&amp; needsLoopbackRoute(&amp;sa-&gt;sa6.sin6_addr)) {</span>
<span class="line-removed">-                             cached_scope_id = lo_scope_id;</span>
<span class="line-removed">-                             (*env)-&gt;SetIntField(env, iaObj, ia6_cachedscopeidID, cached_scope_id);</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     } else {</span>
<span class="line-removed">-                         /*</span>
<span class="line-removed">-                          * Otherwise consult the IPv6 routing tables to</span>
<span class="line-removed">-                          * try determine the appropriate interface.</span>
<span class="line-removed">-                          */</span>
<span class="line-removed">-                         if (kernelIsV24()) {</span>
<span class="line-removed">-                             cached_scope_id = getDefaultIPv6Interface(&amp;sa-&gt;sa6.sin6_addr);</span>
<span class="line-removed">-                         } else {</span>
<span class="line-removed">-                             cached_scope_id = getLocalScopeID((char *)&amp;(sa-&gt;sa6.sin6_addr));</span>
<span class="line-removed">-                             if (cached_scope_id == 0) {</span>
<span class="line-removed">-                                 cached_scope_id = getDefaultIPv6Interface(&amp;sa-&gt;sa6.sin6_addr);</span>
<span class="line-removed">-                             }</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                         (*env)-&gt;SetIntField(env, iaObj, ia6_cachedscopeidID, cached_scope_id);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * If we have a scope_id use the extended form</span>
<span class="line-removed">-              * of sockaddr_in6.</span>
<span class="line-removed">-              */</span>
<span class="line-removed">-             sa-&gt;sa6.sin6_scope_id = cached_scope_id == 0 ? scope_id : cached_scope_id;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- #else</span>
          /* handle scope_id */
          if (family != java_net_InetAddress_IPv4) {
              if (ia6_scopeidID) {
                  sa-&gt;sa6.sin6_scope_id = getInet6Address_scopeid(env, iaObj);
              }
          }
<span class="line-removed">- #endif</span>
      } else {
          jint address;
          if (family != java_net_InetAddress_IPv4) {
              JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Protocol family unavailable&quot;);
              return -1;
<span class="line-new-header">--- 472,16 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1002,162 ***</span>
  
      /* not found */
      return -1;
  }
  
<span class="line-removed">- /*</span>
<span class="line-removed">-  * Determine the default interface for an IPv6 address.</span>
<span class="line-removed">-  *</span>
<span class="line-removed">-  * 1. Scans /proc/net/ipv6_route for a matching route</span>
<span class="line-removed">-  *    (eg: fe80::/10 or a route for the specific address).</span>
<span class="line-removed">-  *    This will tell us the interface to use (eg: &quot;eth0&quot;).</span>
<span class="line-removed">-  *</span>
<span class="line-removed">-  * 2. Lookup /proc/net/if_inet6 to map the interface</span>
<span class="line-removed">-  *    name to an interface index.</span>
<span class="line-removed">-  *</span>
<span class="line-removed">-  * Returns :-</span>
<span class="line-removed">-  *      -1 if error</span>
<span class="line-removed">-  *       0 if no matching interface</span>
<span class="line-removed">-  *      &gt;1 interface index to use for the link-local address.</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- #if defined(__linux__)</span>
<span class="line-removed">- int getDefaultIPv6Interface(struct in6_addr *target_addr) {</span>
<span class="line-removed">-     FILE *f;</span>
<span class="line-removed">-     char srcp[8][5];</span>
<span class="line-removed">-     char hopp[8][5];</span>
<span class="line-removed">-     int dest_plen, src_plen, use, refcnt, metric;</span>
<span class="line-removed">-     unsigned long flags;</span>
<span class="line-removed">-     char dest_str[40];</span>
<span class="line-removed">-     struct in6_addr dest_addr;</span>
<span class="line-removed">-     char device[16];</span>
<span class="line-removed">-     jboolean match = JNI_FALSE;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * Scan /proc/net/ipv6_route looking for a matching</span>
<span class="line-removed">-      * route.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     if ((f = fopen(&quot;/proc/net/ipv6_route&quot;, &quot;r&quot;)) == NULL) {</span>
<span class="line-removed">-         return -1;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     while (fscanf(f, &quot;%4s%4s%4s%4s%4s%4s%4s%4s %02x &quot;</span>
<span class="line-removed">-                      &quot;%4s%4s%4s%4s%4s%4s%4s%4s %02x &quot;</span>
<span class="line-removed">-                      &quot;%4s%4s%4s%4s%4s%4s%4s%4s &quot;</span>
<span class="line-removed">-                      &quot;%08x %08x %08x %08lx %8s&quot;,</span>
<span class="line-removed">-                      dest_str, &amp;dest_str[5], &amp;dest_str[10], &amp;dest_str[15],</span>
<span class="line-removed">-                      &amp;dest_str[20], &amp;dest_str[25], &amp;dest_str[30], &amp;dest_str[35],</span>
<span class="line-removed">-                      &amp;dest_plen,</span>
<span class="line-removed">-                      srcp[0], srcp[1], srcp[2], srcp[3],</span>
<span class="line-removed">-                      srcp[4], srcp[5], srcp[6], srcp[7],</span>
<span class="line-removed">-                      &amp;src_plen,</span>
<span class="line-removed">-                      hopp[0], hopp[1], hopp[2], hopp[3],</span>
<span class="line-removed">-                      hopp[4], hopp[5], hopp[6], hopp[7],</span>
<span class="line-removed">-                      &amp;metric, &amp;use, &amp;refcnt, &amp;flags, device) == 31) {</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * Some routes should be ignored</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         if ( (dest_plen &lt; 0 || dest_plen &gt; 128)  ||</span>
<span class="line-removed">-              (src_plen != 0) ||</span>
<span class="line-removed">-              (flags &amp; (RTF_POLICY | RTF_FLOW)) ||</span>
<span class="line-removed">-              ((flags &amp; RTF_REJECT) &amp;&amp; dest_plen == 0) ) {</span>
<span class="line-removed">-             continue;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * Convert the destination address</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         dest_str[4] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[9] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[14] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[19] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[24] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[29] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[34] = &#39;:&#39;;</span>
<span class="line-removed">-         dest_str[39] = &#39;\0&#39;;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (inet_pton(AF_INET6, dest_str, &amp;dest_addr) &lt; 0) {</span>
<span class="line-removed">-             /* not an Ipv6 address */</span>
<span class="line-removed">-             continue;</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * The prefix len (dest_plen) indicates the number of bits we</span>
<span class="line-removed">-              * need to match on.</span>
<span class="line-removed">-              *</span>
<span class="line-removed">-              * dest_plen / 8    =&gt; number of bytes to match</span>
<span class="line-removed">-              * dest_plen % 8    =&gt; number of additional bits to match</span>
<span class="line-removed">-              *</span>
<span class="line-removed">-              * eg: fe80::/10 =&gt; match 1 byte + 2 additional bits in the</span>
<span class="line-removed">-              *                  next byte.</span>
<span class="line-removed">-              */</span>
<span class="line-removed">-             int byte_count = dest_plen &gt;&gt; 3;</span>
<span class="line-removed">-             int extra_bits = dest_plen &amp; 0x3;</span>
<span class="line-removed">- </span>
<span class="line-removed">-             if (byte_count &gt; 0) {</span>
<span class="line-removed">-                 if (memcmp(target_addr, &amp;dest_addr, byte_count)) {</span>
<span class="line-removed">-                     continue;  /* no match */</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             if (extra_bits &gt; 0) {</span>
<span class="line-removed">-                 unsigned char c1 = ((unsigned char *)target_addr)[byte_count];</span>
<span class="line-removed">-                 unsigned char c2 = ((unsigned char *)&amp;dest_addr)[byte_count];</span>
<span class="line-removed">-                 unsigned char mask = 0xff &lt;&lt; (8 - extra_bits);</span>
<span class="line-removed">-                 if ((c1 &amp; mask) != (c2 &amp; mask)) {</span>
<span class="line-removed">-                     continue;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- </span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * We have a match</span>
<span class="line-removed">-              */</span>
<span class="line-removed">-             match = JNI_TRUE;</span>
<span class="line-removed">-             break;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     fclose(f);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * If there&#39;s a match then we lookup the interface</span>
<span class="line-removed">-      * index.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     if (match) {</span>
<span class="line-removed">-         char devname[21];</span>
<span class="line-removed">-         char addr6p[8][5];</span>
<span class="line-removed">-         int plen, scope, dad_status, if_idx;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if ((f = fopen(&quot;/proc/net/if_inet6&quot;, &quot;r&quot;)) != NULL) {</span>
<span class="line-removed">-             while (fscanf(f, &quot;%4s%4s%4s%4s%4s%4s%4s%4s %08x %02x %02x %02x %20s\n&quot;,</span>
<span class="line-removed">-                       addr6p[0], addr6p[1], addr6p[2], addr6p[3],</span>
<span class="line-removed">-                       addr6p[4], addr6p[5], addr6p[6], addr6p[7],</span>
<span class="line-removed">-                   &amp;if_idx, &amp;plen, &amp;scope, &amp;dad_status, devname) == 13) {</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 if (strcmp(devname, device) == 0) {</span>
<span class="line-removed">-                     /*</span>
<span class="line-removed">-                      * Found - so just return the index</span>
<span class="line-removed">-                      */</span>
<span class="line-removed">-                     fclose(f);</span>
<span class="line-removed">-                     return if_idx;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             fclose(f);</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * Couldn&#39;t open /proc/net/if_inet6</span>
<span class="line-removed">-              */</span>
<span class="line-removed">-             return -1;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * If we get here it means we didn&#39;t there wasn&#39;t any</span>
<span class="line-removed">-      * route or we couldn&#39;t get the index of the interface.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     return 0;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
  /*
   * Wrapper for getsockopt system routine - does any necessary
   * pre/post processing to deal with OS specific oddities :-
   *
   * On Linux the SO_SNDBUF/SO_RCVBUF values must be post-processed
<span class="line-new-header">--- 611,10 ---</span>
</pre>
<center><a href="PlainSocketImpl.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="net_util_md.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>