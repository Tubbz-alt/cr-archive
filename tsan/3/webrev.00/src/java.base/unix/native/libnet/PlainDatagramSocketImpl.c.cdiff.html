<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/unix/native/libnet/PlainDatagramSocketImpl.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="NetworkInterface.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="PlainSocketImpl.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libnet/PlainDatagramSocketImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 77,14 ***</span>
  static jfieldID pdsi_localPortID;
  static jfieldID pdsi_connected;
  static jfieldID pdsi_connectedAddress;
  static jfieldID pdsi_connectedPort;
  
<span class="line-removed">- extern void setDefaultScopeID(JNIEnv *env, struct sockaddr *him);</span>
<span class="line-removed">- extern int getDefaultScopeID(JNIEnv *env);</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
  /*
   * Returns a java.lang.Integer based on &#39;i&#39;
   */
  static jobject createInteger(JNIEnv *env, int i) {
      static jclass i_class;
<span class="line-new-header">--- 77,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 198,11 ***</span>
      /* bind */
      if (NET_InetAddressToSockaddr(env, iaObj, localport, &amp;sa, &amp;len,
                                    JNI_TRUE) != 0) {
        return;
      }
<span class="line-removed">-     setDefaultScopeID(env, &amp;sa.sa);</span>
  
      if (NET_Bind(fd, &amp;sa, len) &lt; 0)  {
          if (errno == EADDRINUSE || errno == EADDRNOTAVAIL ||
              errno == EPERM || errno == EACCES) {
              NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;BindException&quot;,
<span class="line-new-header">--- 194,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 264,12 ***</span>
      if (NET_InetAddressToSockaddr(env, address, port, &amp;rmtaddr, &amp;len,
                                    JNI_TRUE) != 0) {
        return;
      }
  
<span class="line-removed">-     setDefaultScopeID(env, &amp;rmtaddr.sa);</span>
<span class="line-removed">- </span>
      if (NET_Connect(fd, &amp;rmtaddr.sa, len) == -1) {
          NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;ConnectException&quot;,
                          &quot;Connect failed&quot;);
      }
  }
<span class="line-new-header">--- 259,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 332,15 ***</span>
  #endif
  }
  
  /*
   * Class:     java_net_PlainDatagramSocketImpl
<span class="line-modified">!  * Method:    send</span>
   * Signature: (Ljava/net/DatagramPacket;)V
   */
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_java_net_PlainDatagramSocketImpl_send(JNIEnv *env, jobject this,</span>
                                             jobject packet) {
  
      char BUF[MAX_BUFFER_LEN];
      char *fullPacket = NULL;
      int ret, mallocedPacket = JNI_FALSE;
<span class="line-new-header">--- 325,15 ---</span>
  #endif
  }
  
  /*
   * Class:     java_net_PlainDatagramSocketImpl
<span class="line-modified">!  * Method:    send0</span>
   * Signature: (Ljava/net/DatagramPacket;)V
   */
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_java_net_PlainDatagramSocketImpl_send0(JNIEnv *env, jobject this,</span>
                                             jobject packet) {
  
      char BUF[MAX_BUFFER_LEN];
      char *fullPacket = NULL;
      int ret, mallocedPacket = JNI_FALSE;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 391,11 ***</span>
                                        &amp;len, JNI_TRUE) != 0) {
              return;
          }
          rmtaddrP = &amp;rmtaddr.sa;
      }
<span class="line-removed">-     setDefaultScopeID(env, &amp;rmtaddr.sa);</span>
  
      if (packetBufferLen &gt; MAX_BUFFER_LEN) {
          /* When JNI-ifying the JDK&#39;s IO routines, we turned
           * reads and writes of byte arrays of size greater
           * than 2048 bytes into several operations of size 2048.
<span class="line-new-header">--- 384,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 913,12 ***</span>
          JNU_ThrowByNameWithMessageAndLastError
              (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Error creating socket&quot;);
          return;
      }
  
<span class="line-modified">!     /* Disable IPV6_V6ONLY to ensure dual-socket support */</span>
<span class="line-modified">!     if (domain == AF_INET6) {</span>
          arg = 0;
          if (setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (char*)&amp;arg,
                         sizeof(int)) &lt; 0) {
              NET_ThrowNew(env, errno, &quot;cannot set IPPROTO_IPV6&quot;);
              close(fd);
<span class="line-new-header">--- 905,14 ---</span>
          JNU_ThrowByNameWithMessageAndLastError
              (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Error creating socket&quot;);
          return;
      }
  
<span class="line-modified">!     /*</span>
<span class="line-modified">!      * If IPv4 is available, disable IPV6_V6ONLY to ensure dual-socket support.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     if (domain == AF_INET6 &amp;&amp; ipv4_available()) {</span>
          arg = 0;
          if (setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (char*)&amp;arg,
                         sizeof(int)) &lt; 0) {
              NET_ThrowNew(env, errno, &quot;cannot set IPPROTO_IPV6&quot;);
              close(fd);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1494,32 ***</span>
              CHECK_NULL_RETURN(ni_nameID, NULL);
              ni_class = (*env)-&gt;NewGlobalRef(env, c);
              CHECK_NULL_RETURN(ni_class, NULL);
          }
          ni = Java_java_net_NetworkInterface_getByInetAddress0(env, ni_class, addr);
          if (ni) {
              return ni;
          }
<span class="line-modified">! </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * The address doesn&#39;t appear to be bound at any known</span>
<span class="line-removed">-          * NetworkInterface. Therefore we construct a NetworkInterface</span>
<span class="line-removed">-          * with this address.</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         ni = (*env)-&gt;NewObject(env, ni_class, ni_ctrID, 0);</span>
<span class="line-removed">-         CHECK_NULL_RETURN(ni, NULL);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         (*env)-&gt;SetIntField(env, ni, ni_indexID, -1);</span>
<span class="line-removed">-         addrArray = (*env)-&gt;NewObjectArray(env, 1, inet4_class, NULL);</span>
<span class="line-removed">-         CHECK_NULL_RETURN(addrArray, NULL);</span>
<span class="line-removed">-         (*env)-&gt;SetObjectArrayElement(env, addrArray, 0, addr);</span>
<span class="line-removed">-         (*env)-&gt;SetObjectField(env, ni, ni_addrsID, addrArray);</span>
<span class="line-removed">-         ni_name = (*env)-&gt;NewStringUTF(env, &quot;&quot;);</span>
<span class="line-removed">-         if (ni_name != NULL) {</span>
<span class="line-removed">-             (*env)-&gt;SetObjectField(env, ni, ni_nameID, ni_name);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return ni;</span>
      }
  
  
      /*
       * IPv6 implementation
<span class="line-new-header">--- 1488,15 ---</span>
              CHECK_NULL_RETURN(ni_nameID, NULL);
              ni_class = (*env)-&gt;NewGlobalRef(env, c);
              CHECK_NULL_RETURN(ni_class, NULL);
          }
          ni = Java_java_net_NetworkInterface_getByInetAddress0(env, ni_class, addr);
<span class="line-added">+         JNU_CHECK_EXCEPTION_RETURN(env, NULL);</span>
          if (ni) {
              return ni;
          }
<span class="line-modified">!         return NULL;</span>
      }
  
  
      /*
       * IPv6 implementation
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1622,23 ***</span>
          addr = (*env)-&gt;CallStaticObjectMethod(env, ia_class, ia_anyLocalAddressID,
                                                NULL);
          if (opt == java_net_SocketOptions_IP_MULTICAST_IF) {
              return addr;
          }
<span class="line-removed">- </span>
<span class="line-removed">-         ni = (*env)-&gt;NewObject(env, ni_class, ni_ctrID, 0);</span>
<span class="line-removed">-         CHECK_NULL_RETURN(ni, NULL);</span>
<span class="line-removed">-         (*env)-&gt;SetIntField(env, ni, ni_indexID, -1);</span>
<span class="line-removed">-         addrArray = (*env)-&gt;NewObjectArray(env, 1, ia_class, NULL);</span>
<span class="line-removed">-         CHECK_NULL_RETURN(addrArray, NULL);</span>
<span class="line-removed">-         (*env)-&gt;SetObjectArrayElement(env, addrArray, 0, addr);</span>
<span class="line-removed">-         (*env)-&gt;SetObjectField(env, ni, ni_addrsID, addrArray);</span>
<span class="line-removed">-         ni_name = (*env)-&gt;NewStringUTF(env, &quot;&quot;);</span>
<span class="line-removed">-         if (ni_name != NULL) {</span>
<span class="line-removed">-             (*env)-&gt;SetObjectField(env, ni, ni_nameID, ni_name);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return ni;</span>
      }
      return NULL;
  }
  
  
<span class="line-new-header">--- 1599,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2140,30 ***</span>
              if (getsockopt(fd, IPPROTO_IPV6, IPV6_MULTICAST_IF,
                             (char*)&amp;index, &amp;len) &lt; 0) {
                  NET_ThrowCurrent(env, &quot;getsockopt IPV6_MULTICAST_IF failed&quot;);
                  return;
              }
<span class="line-removed">- </span>
<span class="line-removed">- #ifdef __linux__</span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * On 2.4.8+ if we join a group with the interface set to 0</span>
<span class="line-removed">-              * then the kernel records the interface it decides. This causes</span>
<span class="line-removed">-              * subsequent leave groups to fail as there is no match. Thus we</span>
<span class="line-removed">-              * pick the interface if there is a matching route.</span>
<span class="line-removed">-              */</span>
<span class="line-removed">-             if (index == 0) {</span>
<span class="line-removed">-                 int rt_index = getDefaultIPv6Interface(&amp;(mname6.ipv6mr_multiaddr));</span>
<span class="line-removed">-                 if (rt_index &gt; 0) {</span>
<span class="line-removed">-                     index = rt_index;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- #ifdef MACOSX</span>
<span class="line-removed">-             if (family == AF_INET6 &amp;&amp; index == 0) {</span>
<span class="line-removed">-                 index = getDefaultScopeID(env);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- #endif</span>
              mname6.ipv6mr_interface = index;
          } else {
              jint idx = (*env)-&gt;GetIntField(env, niObj, ni_indexID);
              mname6.ipv6mr_interface = idx;
          }
<span class="line-new-header">--- 2104,10 ---</span>
</pre>
<center><a href="NetworkInterface.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="PlainSocketImpl.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>