<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/unix/native/libnet/PlainDatagramSocketImpl.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="NetworkInterface.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="PlainSocketImpl.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libnet/PlainDatagramSocketImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  62 #define IPTOS_TOS_MASK 0x1e
  63 #endif
  64 #ifndef IPTOS_PREC_MASK
  65 #define IPTOS_PREC_MASK 0xe0
  66 #endif
  67 
  68 /************************************************************************
  69  * PlainDatagramSocketImpl
  70  */
  71 
  72 static jfieldID IO_fd_fdID;
  73 
  74 static jfieldID pdsi_fdID;
  75 static jfieldID pdsi_timeoutID;
  76 static jfieldID pdsi_trafficClassID;
  77 static jfieldID pdsi_localPortID;
  78 static jfieldID pdsi_connected;
  79 static jfieldID pdsi_connectedAddress;
  80 static jfieldID pdsi_connectedPort;
  81 
<span class="line-removed">  82 extern void setDefaultScopeID(JNIEnv *env, struct sockaddr *him);</span>
<span class="line-removed">  83 extern int getDefaultScopeID(JNIEnv *env);</span>
<span class="line-removed">  84 </span>
<span class="line-removed">  85 </span>
  86 /*
  87  * Returns a java.lang.Integer based on &#39;i&#39;
  88  */
  89 static jobject createInteger(JNIEnv *env, int i) {
  90     static jclass i_class;
  91     static jmethodID i_ctrID;
  92 
  93     if (i_class == NULL) {
  94         jclass c = (*env)-&gt;FindClass(env, &quot;java/lang/Integer&quot;);
  95         CHECK_NULL_RETURN(c, NULL);
  96         i_ctrID = (*env)-&gt;GetMethodID(env, c, &quot;&lt;init&gt;&quot;, &quot;(I)V&quot;);
  97         CHECK_NULL_RETURN(i_ctrID, NULL);
  98         i_class = (*env)-&gt;NewGlobalRef(env, c);
  99         CHECK_NULL_RETURN(i_class, NULL);
 100     }
 101 
 102     return (*env)-&gt;NewObject(env, i_class, i_ctrID, i);
 103 }
 104 
 105 /*
</pre>
<hr />
<pre>
 183     socklen_t slen = sizeof(SOCKETADDRESS);
 184 
 185     if (IS_NULL(fdObj)) {
 186         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
 187                         &quot;Socket closed&quot;);
 188         return;
 189     } else {
 190         fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID);
 191     }
 192 
 193     if (IS_NULL(iaObj)) {
 194         JNU_ThrowNullPointerException(env, &quot;iaObj is null.&quot;);
 195         return;
 196     }
 197 
 198     /* bind */
 199     if (NET_InetAddressToSockaddr(env, iaObj, localport, &amp;sa, &amp;len,
 200                                   JNI_TRUE) != 0) {
 201       return;
 202     }
<span class="line-removed"> 203     setDefaultScopeID(env, &amp;sa.sa);</span>
 204 
 205     if (NET_Bind(fd, &amp;sa, len) &lt; 0)  {
 206         if (errno == EADDRINUSE || errno == EADDRNOTAVAIL ||
 207             errno == EPERM || errno == EACCES) {
 208             NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;BindException&quot;,
 209                             &quot;Bind failed&quot;);
 210         } else {
 211             JNU_ThrowByNameWithMessageAndLastError
 212                 (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Bind failed&quot;);
 213         }
 214         return;
 215     }
 216 
 217     /* initialize the local port */
 218     if (localport == 0) {
 219         /* Now that we&#39;re a connected socket, let&#39;s extract the port number
 220          * that the system chose for us and store it in the Socket object.
 221          */
 222         if (getsockname(fd, &amp;sa.sa, &amp;slen) == -1) {
 223             JNU_ThrowByNameWithMessageAndLastError
</pre>
<hr />
<pre>
 249     SOCKETADDRESS rmtaddr;
 250     int len = 0;
 251 
 252     if (IS_NULL(fdObj)) {
 253         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
 254                         &quot;Socket closed&quot;);
 255         return;
 256     }
 257     fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID);
 258 
 259     if (IS_NULL(address)) {
 260         JNU_ThrowNullPointerException(env, &quot;address&quot;);
 261         return;
 262     }
 263 
 264     if (NET_InetAddressToSockaddr(env, address, port, &amp;rmtaddr, &amp;len,
 265                                   JNI_TRUE) != 0) {
 266       return;
 267     }
 268 
<span class="line-removed"> 269     setDefaultScopeID(env, &amp;rmtaddr.sa);</span>
<span class="line-removed"> 270 </span>
 271     if (NET_Connect(fd, &amp;rmtaddr.sa, len) == -1) {
 272         NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;ConnectException&quot;,
 273                         &quot;Connect failed&quot;);
 274     }
 275 }
 276 
 277 /*
 278  * Class:     java_net_PlainDatagramSocketImpl
 279  * Method:    disconnect0
 280  * Signature: ()V
 281  */
 282 JNIEXPORT void JNICALL
 283 Java_java_net_PlainDatagramSocketImpl_disconnect0(JNIEnv *env, jobject this, jint family) {
 284     /* The object&#39;s field */
 285     jobject fdObj = (*env)-&gt;GetObjectField(env, this, pdsi_fdID);
 286     /* The fdObj&#39;fd */
 287     jint fd;
 288 
 289 #if defined(__linux__) || defined(_ALLBSD_SOURCE)
 290     SOCKETADDRESS addr;
</pre>
<hr />
<pre>
 317     localPort = NET_GetPortFromSockaddr(&amp;addr);
 318     if (localPort == 0) {
 319         localPort = (*env)-&gt;GetIntField(env, this, pdsi_localPortID);
 320         if (addr.sa.sa_family == AF_INET6) {
 321             addr.sa6.sin6_port = htons(localPort);
 322         } else {
 323             addr.sa4.sin_port = htons(localPort);
 324         }
 325 
 326         NET_Bind(fd, &amp;addr, len);
 327     }
 328 
 329 #endif
 330 #else
 331     NET_Connect(fd, 0, 0);
 332 #endif
 333 }
 334 
 335 /*
 336  * Class:     java_net_PlainDatagramSocketImpl
<span class="line-modified"> 337  * Method:    send</span>
 338  * Signature: (Ljava/net/DatagramPacket;)V
 339  */
 340 JNIEXPORT void JNICALL
<span class="line-modified"> 341 Java_java_net_PlainDatagramSocketImpl_send(JNIEnv *env, jobject this,</span>
 342                                            jobject packet) {
 343 
 344     char BUF[MAX_BUFFER_LEN];
 345     char *fullPacket = NULL;
 346     int ret, mallocedPacket = JNI_FALSE;
 347     /* The object&#39;s field */
 348     jobject fdObj = (*env)-&gt;GetObjectField(env, this, pdsi_fdID);
 349     jint trafficClass = (*env)-&gt;GetIntField(env, this, pdsi_trafficClassID);
 350 
 351     jbyteArray packetBuffer;
 352     jobject packetAddress;
 353     jint packetBufferOffset, packetBufferLen, packetPort;
 354     jboolean connected;
 355 
 356     /* The fdObj&#39;fd */
 357     jint fd;
 358 
 359     SOCKETADDRESS rmtaddr;
 360     struct sockaddr *rmtaddrP = 0;
 361     int len = 0;
</pre>
<hr />
<pre>
 376 
 377     packetBuffer = (*env)-&gt;GetObjectField(env, packet, dp_bufID);
 378     packetAddress = (*env)-&gt;GetObjectField(env, packet, dp_addressID);
 379     if (IS_NULL(packetBuffer) || IS_NULL(packetAddress)) {
 380         JNU_ThrowNullPointerException(env, &quot;null buffer || null address&quot;);
 381         return;
 382     }
 383 
 384     packetBufferOffset = (*env)-&gt;GetIntField(env, packet, dp_offsetID);
 385     packetBufferLen = (*env)-&gt;GetIntField(env, packet, dp_lengthID);
 386 
 387     // arg to NET_Sendto() null, if connected
 388     if (!connected) {
 389         packetPort = (*env)-&gt;GetIntField(env, packet, dp_portID);
 390         if (NET_InetAddressToSockaddr(env, packetAddress, packetPort, &amp;rmtaddr,
 391                                       &amp;len, JNI_TRUE) != 0) {
 392             return;
 393         }
 394         rmtaddrP = &amp;rmtaddr.sa;
 395     }
<span class="line-removed"> 396     setDefaultScopeID(env, &amp;rmtaddr.sa);</span>
 397 
 398     if (packetBufferLen &gt; MAX_BUFFER_LEN) {
 399         /* When JNI-ifying the JDK&#39;s IO routines, we turned
 400          * reads and writes of byte arrays of size greater
 401          * than 2048 bytes into several operations of size 2048.
 402          * This saves a malloc()/memcpy()/free() for big
 403          * buffers.  This is OK for file IO and TCP, but that
 404          * strategy violates the semantics of a datagram protocol.
 405          * (one big send) != (several smaller sends).  So here
 406          * we *must* allocate the buffer.  Note it needn&#39;t be bigger
 407          * than 65,536 (0xFFFF), the max size of an IP packet.
 408          * Anything bigger should be truncated anyway.
 409          *
 410          * We may want to use a smarter allocation scheme at some
 411          * point.
 412          */
 413         if (packetBufferLen &gt; MAX_PACKET_LEN) {
 414             packetBufferLen = MAX_PACKET_LEN;
 415         }
 416         fullPacket = (char *)malloc(packetBufferLen);
</pre>
<hr />
<pre>
 898 JNIEXPORT void JNICALL
 899 Java_java_net_PlainDatagramSocketImpl_datagramSocketCreate(JNIEnv *env,
 900                                                            jobject this) {
 901     jobject fdObj = (*env)-&gt;GetObjectField(env, this, pdsi_fdID);
 902     int arg, fd, t = 1;
 903     char tmpbuf[1024];
 904     int domain = ipv6_available() ? AF_INET6 : AF_INET;
 905 
 906     if (IS_NULL(fdObj)) {
 907         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
 908                         &quot;Socket closed&quot;);
 909         return;
 910     }
 911 
 912     if ((fd = socket(domain, SOCK_DGRAM, 0)) == -1) {
 913         JNU_ThrowByNameWithMessageAndLastError
 914             (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Error creating socket&quot;);
 915         return;
 916     }
 917 
<span class="line-modified"> 918     /* Disable IPV6_V6ONLY to ensure dual-socket support */</span>
<span class="line-modified"> 919     if (domain == AF_INET6) {</span>


 920         arg = 0;
 921         if (setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (char*)&amp;arg,
 922                        sizeof(int)) &lt; 0) {
 923             NET_ThrowNew(env, errno, &quot;cannot set IPPROTO_IPV6&quot;);
 924             close(fd);
 925             return;
 926         }
 927     }
 928 
 929 #ifdef __APPLE__
 930     arg = 65507;
 931     if (setsockopt(fd, SOL_SOCKET, SO_SNDBUF,
 932                    (char *)&amp;arg, sizeof(arg)) &lt; 0) {
 933         getErrorString(errno, tmpbuf, sizeof(tmpbuf));
 934         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;, tmpbuf);
 935         close(fd);
 936         return;
 937     }
 938     if (setsockopt(fd, SOL_SOCKET, SO_RCVBUF,
 939                    (char *)&amp;arg, sizeof(arg)) &lt; 0) {
</pre>
<hr />
<pre>
1479         /*
1480          * For IP_MULTICAST_IF2 we get the NetworkInterface for
1481          * this address and return it
1482          */
1483         if (ni_class == NULL) {
1484             jclass c = (*env)-&gt;FindClass(env, &quot;java/net/NetworkInterface&quot;);
1485             CHECK_NULL_RETURN(c, NULL);
1486             ni_ctrID = (*env)-&gt;GetMethodID(env, c, &quot;&lt;init&gt;&quot;, &quot;()V&quot;);
1487             CHECK_NULL_RETURN(ni_ctrID, NULL);
1488             ni_indexID = (*env)-&gt;GetFieldID(env, c, &quot;index&quot;, &quot;I&quot;);
1489             CHECK_NULL_RETURN(ni_indexID, NULL);
1490             ni_addrsID = (*env)-&gt;GetFieldID(env, c, &quot;addrs&quot;,
1491                                             &quot;[Ljava/net/InetAddress;&quot;);
1492             CHECK_NULL_RETURN(ni_addrsID, NULL);
1493             ni_nameID = (*env)-&gt;GetFieldID(env, c,&quot;name&quot;, &quot;Ljava/lang/String;&quot;);
1494             CHECK_NULL_RETURN(ni_nameID, NULL);
1495             ni_class = (*env)-&gt;NewGlobalRef(env, c);
1496             CHECK_NULL_RETURN(ni_class, NULL);
1497         }
1498         ni = Java_java_net_NetworkInterface_getByInetAddress0(env, ni_class, addr);

1499         if (ni) {
1500             return ni;
1501         }
<span class="line-modified">1502 </span>
<span class="line-removed">1503         /*</span>
<span class="line-removed">1504          * The address doesn&#39;t appear to be bound at any known</span>
<span class="line-removed">1505          * NetworkInterface. Therefore we construct a NetworkInterface</span>
<span class="line-removed">1506          * with this address.</span>
<span class="line-removed">1507          */</span>
<span class="line-removed">1508         ni = (*env)-&gt;NewObject(env, ni_class, ni_ctrID, 0);</span>
<span class="line-removed">1509         CHECK_NULL_RETURN(ni, NULL);</span>
<span class="line-removed">1510 </span>
<span class="line-removed">1511         (*env)-&gt;SetIntField(env, ni, ni_indexID, -1);</span>
<span class="line-removed">1512         addrArray = (*env)-&gt;NewObjectArray(env, 1, inet4_class, NULL);</span>
<span class="line-removed">1513         CHECK_NULL_RETURN(addrArray, NULL);</span>
<span class="line-removed">1514         (*env)-&gt;SetObjectArrayElement(env, addrArray, 0, addr);</span>
<span class="line-removed">1515         (*env)-&gt;SetObjectField(env, ni, ni_addrsID, addrArray);</span>
<span class="line-removed">1516         ni_name = (*env)-&gt;NewStringUTF(env, &quot;&quot;);</span>
<span class="line-removed">1517         if (ni_name != NULL) {</span>
<span class="line-removed">1518             (*env)-&gt;SetObjectField(env, ni, ni_nameID, ni_name);</span>
<span class="line-removed">1519         }</span>
<span class="line-removed">1520         return ni;</span>
1521     }
1522 
1523 
1524     /*
1525      * IPv6 implementation
1526      */
1527     if ((opt == java_net_SocketOptions_IP_MULTICAST_IF) ||
1528         (opt == java_net_SocketOptions_IP_MULTICAST_IF2)) {
1529 
1530         static jclass ni_class;
1531         static jmethodID ni_ctrID;
1532         static jfieldID ni_indexID;
1533         static jfieldID ni_addrsID;
1534         static jclass ia_class;
1535         static jfieldID ni_nameID;
1536         static jmethodID ia_anyLocalAddressID;
1537 
1538         int index = 0;
1539         socklen_t len = sizeof(index);
1540 
</pre>
<hr />
<pre>
1607             if ((*env)-&gt;GetArrayLength(env, addrArray) &lt; 1) {
1608                 JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
1609                     &quot;IPV6_MULTICAST_IF returned interface without IP bindings&quot;);
1610                 return NULL;
1611             }
1612 
1613             addr = (*env)-&gt;GetObjectArrayElement(env, addrArray, 0);
1614             return addr;
1615         }
1616 
1617         /*
1618          * Multicast to any address - return anyLocalAddress
1619          * or a NetworkInterface with addrs[0] set to anyLocalAddress
1620          */
1621 
1622         addr = (*env)-&gt;CallStaticObjectMethod(env, ia_class, ia_anyLocalAddressID,
1623                                               NULL);
1624         if (opt == java_net_SocketOptions_IP_MULTICAST_IF) {
1625             return addr;
1626         }
<span class="line-removed">1627 </span>
<span class="line-removed">1628         ni = (*env)-&gt;NewObject(env, ni_class, ni_ctrID, 0);</span>
<span class="line-removed">1629         CHECK_NULL_RETURN(ni, NULL);</span>
<span class="line-removed">1630         (*env)-&gt;SetIntField(env, ni, ni_indexID, -1);</span>
<span class="line-removed">1631         addrArray = (*env)-&gt;NewObjectArray(env, 1, ia_class, NULL);</span>
<span class="line-removed">1632         CHECK_NULL_RETURN(addrArray, NULL);</span>
<span class="line-removed">1633         (*env)-&gt;SetObjectArrayElement(env, addrArray, 0, addr);</span>
<span class="line-removed">1634         (*env)-&gt;SetObjectField(env, ni, ni_addrsID, addrArray);</span>
<span class="line-removed">1635         ni_name = (*env)-&gt;NewStringUTF(env, &quot;&quot;);</span>
<span class="line-removed">1636         if (ni_name != NULL) {</span>
<span class="line-removed">1637             (*env)-&gt;SetObjectField(env, ni, ni_nameID, ni_name);</span>
<span class="line-removed">1638         }</span>
<span class="line-removed">1639         return ni;</span>
1640     }
1641     return NULL;
1642 }
1643 
1644 
1645 
1646 /*
1647  * Returns relevant info as a jint.
1648  *
1649  * Class:     java_net_PlainDatagramSocketImpl
1650  * Method:    socketGetOption
1651  * Signature: (I)Ljava/lang/Object;
1652  */
1653 JNIEXPORT jobject JNICALL
1654 Java_java_net_PlainDatagramSocketImpl_socketGetOption
1655   (JNIEnv *env, jobject this, jint opt)
1656 {
1657     int fd;
1658     int level, optname, optlen;
1659     union {
</pre>
<hr />
<pre>
2125             caddr[11] = 0xff;
2126 
2127             caddr[12] = ((address &gt;&gt; 24) &amp; 0xff);
2128             caddr[13] = ((address &gt;&gt; 16) &amp; 0xff);
2129             caddr[14] = ((address &gt;&gt; 8) &amp; 0xff);
2130             caddr[15] = (address &amp; 0xff);
2131         } else {
2132             getInet6Address_ipaddress(env, iaObj, (char*)caddr);
2133         }
2134 
2135         memcpy((void *)&amp;(mname6.ipv6mr_multiaddr), caddr, sizeof(struct in6_addr));
2136         if (IS_NULL(niObj)) {
2137             int index;
2138             socklen_t len = sizeof(index);
2139 
2140             if (getsockopt(fd, IPPROTO_IPV6, IPV6_MULTICAST_IF,
2141                            (char*)&amp;index, &amp;len) &lt; 0) {
2142                 NET_ThrowCurrent(env, &quot;getsockopt IPV6_MULTICAST_IF failed&quot;);
2143                 return;
2144             }
<span class="line-removed">2145 </span>
<span class="line-removed">2146 #ifdef __linux__</span>
<span class="line-removed">2147             /*</span>
<span class="line-removed">2148              * On 2.4.8+ if we join a group with the interface set to 0</span>
<span class="line-removed">2149              * then the kernel records the interface it decides. This causes</span>
<span class="line-removed">2150              * subsequent leave groups to fail as there is no match. Thus we</span>
<span class="line-removed">2151              * pick the interface if there is a matching route.</span>
<span class="line-removed">2152              */</span>
<span class="line-removed">2153             if (index == 0) {</span>
<span class="line-removed">2154                 int rt_index = getDefaultIPv6Interface(&amp;(mname6.ipv6mr_multiaddr));</span>
<span class="line-removed">2155                 if (rt_index &gt; 0) {</span>
<span class="line-removed">2156                     index = rt_index;</span>
<span class="line-removed">2157                 }</span>
<span class="line-removed">2158             }</span>
<span class="line-removed">2159 #endif</span>
<span class="line-removed">2160 #ifdef MACOSX</span>
<span class="line-removed">2161             if (family == AF_INET6 &amp;&amp; index == 0) {</span>
<span class="line-removed">2162                 index = getDefaultScopeID(env);</span>
<span class="line-removed">2163             }</span>
<span class="line-removed">2164 #endif</span>
2165             mname6.ipv6mr_interface = index;
2166         } else {
2167             jint idx = (*env)-&gt;GetIntField(env, niObj, ni_indexID);
2168             mname6.ipv6mr_interface = idx;
2169         }
2170 
2171 #if defined(_ALLBSD_SOURCE)
2172 #define ADD_MEMBERSHIP          IPV6_JOIN_GROUP
2173 #define DRP_MEMBERSHIP          IPV6_LEAVE_GROUP
2174 #define S_ADD_MEMBERSHIP        &quot;IPV6_JOIN_GROUP&quot;
2175 #define S_DRP_MEMBERSHIP        &quot;IPV6_LEAVE_GROUP&quot;
2176 #else
2177 #define ADD_MEMBERSHIP          IPV6_ADD_MEMBERSHIP
2178 #define DRP_MEMBERSHIP          IPV6_DROP_MEMBERSHIP
2179 #define S_ADD_MEMBERSHIP        &quot;IPV6_ADD_MEMBERSHIP&quot;
2180 #define S_DRP_MEMBERSHIP        &quot;IPV6_DROP_MEMBERSHIP&quot;
2181 #endif
2182 
2183         /* Join the multicast group */
2184         if (setsockopt(fd, IPPROTO_IPV6, (join ? ADD_MEMBERSHIP : DRP_MEMBERSHIP),
</pre>
</td>
<td>
<hr />
<pre>
  62 #define IPTOS_TOS_MASK 0x1e
  63 #endif
  64 #ifndef IPTOS_PREC_MASK
  65 #define IPTOS_PREC_MASK 0xe0
  66 #endif
  67 
  68 /************************************************************************
  69  * PlainDatagramSocketImpl
  70  */
  71 
  72 static jfieldID IO_fd_fdID;
  73 
  74 static jfieldID pdsi_fdID;
  75 static jfieldID pdsi_timeoutID;
  76 static jfieldID pdsi_trafficClassID;
  77 static jfieldID pdsi_localPortID;
  78 static jfieldID pdsi_connected;
  79 static jfieldID pdsi_connectedAddress;
  80 static jfieldID pdsi_connectedPort;
  81 




  82 /*
  83  * Returns a java.lang.Integer based on &#39;i&#39;
  84  */
  85 static jobject createInteger(JNIEnv *env, int i) {
  86     static jclass i_class;
  87     static jmethodID i_ctrID;
  88 
  89     if (i_class == NULL) {
  90         jclass c = (*env)-&gt;FindClass(env, &quot;java/lang/Integer&quot;);
  91         CHECK_NULL_RETURN(c, NULL);
  92         i_ctrID = (*env)-&gt;GetMethodID(env, c, &quot;&lt;init&gt;&quot;, &quot;(I)V&quot;);
  93         CHECK_NULL_RETURN(i_ctrID, NULL);
  94         i_class = (*env)-&gt;NewGlobalRef(env, c);
  95         CHECK_NULL_RETURN(i_class, NULL);
  96     }
  97 
  98     return (*env)-&gt;NewObject(env, i_class, i_ctrID, i);
  99 }
 100 
 101 /*
</pre>
<hr />
<pre>
 179     socklen_t slen = sizeof(SOCKETADDRESS);
 180 
 181     if (IS_NULL(fdObj)) {
 182         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
 183                         &quot;Socket closed&quot;);
 184         return;
 185     } else {
 186         fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID);
 187     }
 188 
 189     if (IS_NULL(iaObj)) {
 190         JNU_ThrowNullPointerException(env, &quot;iaObj is null.&quot;);
 191         return;
 192     }
 193 
 194     /* bind */
 195     if (NET_InetAddressToSockaddr(env, iaObj, localport, &amp;sa, &amp;len,
 196                                   JNI_TRUE) != 0) {
 197       return;
 198     }

 199 
 200     if (NET_Bind(fd, &amp;sa, len) &lt; 0)  {
 201         if (errno == EADDRINUSE || errno == EADDRNOTAVAIL ||
 202             errno == EPERM || errno == EACCES) {
 203             NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;BindException&quot;,
 204                             &quot;Bind failed&quot;);
 205         } else {
 206             JNU_ThrowByNameWithMessageAndLastError
 207                 (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Bind failed&quot;);
 208         }
 209         return;
 210     }
 211 
 212     /* initialize the local port */
 213     if (localport == 0) {
 214         /* Now that we&#39;re a connected socket, let&#39;s extract the port number
 215          * that the system chose for us and store it in the Socket object.
 216          */
 217         if (getsockname(fd, &amp;sa.sa, &amp;slen) == -1) {
 218             JNU_ThrowByNameWithMessageAndLastError
</pre>
<hr />
<pre>
 244     SOCKETADDRESS rmtaddr;
 245     int len = 0;
 246 
 247     if (IS_NULL(fdObj)) {
 248         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
 249                         &quot;Socket closed&quot;);
 250         return;
 251     }
 252     fd = (*env)-&gt;GetIntField(env, fdObj, IO_fd_fdID);
 253 
 254     if (IS_NULL(address)) {
 255         JNU_ThrowNullPointerException(env, &quot;address&quot;);
 256         return;
 257     }
 258 
 259     if (NET_InetAddressToSockaddr(env, address, port, &amp;rmtaddr, &amp;len,
 260                                   JNI_TRUE) != 0) {
 261       return;
 262     }
 263 


 264     if (NET_Connect(fd, &amp;rmtaddr.sa, len) == -1) {
 265         NET_ThrowByNameWithLastError(env, JNU_JAVANETPKG &quot;ConnectException&quot;,
 266                         &quot;Connect failed&quot;);
 267     }
 268 }
 269 
 270 /*
 271  * Class:     java_net_PlainDatagramSocketImpl
 272  * Method:    disconnect0
 273  * Signature: ()V
 274  */
 275 JNIEXPORT void JNICALL
 276 Java_java_net_PlainDatagramSocketImpl_disconnect0(JNIEnv *env, jobject this, jint family) {
 277     /* The object&#39;s field */
 278     jobject fdObj = (*env)-&gt;GetObjectField(env, this, pdsi_fdID);
 279     /* The fdObj&#39;fd */
 280     jint fd;
 281 
 282 #if defined(__linux__) || defined(_ALLBSD_SOURCE)
 283     SOCKETADDRESS addr;
</pre>
<hr />
<pre>
 310     localPort = NET_GetPortFromSockaddr(&amp;addr);
 311     if (localPort == 0) {
 312         localPort = (*env)-&gt;GetIntField(env, this, pdsi_localPortID);
 313         if (addr.sa.sa_family == AF_INET6) {
 314             addr.sa6.sin6_port = htons(localPort);
 315         } else {
 316             addr.sa4.sin_port = htons(localPort);
 317         }
 318 
 319         NET_Bind(fd, &amp;addr, len);
 320     }
 321 
 322 #endif
 323 #else
 324     NET_Connect(fd, 0, 0);
 325 #endif
 326 }
 327 
 328 /*
 329  * Class:     java_net_PlainDatagramSocketImpl
<span class="line-modified"> 330  * Method:    send0</span>
 331  * Signature: (Ljava/net/DatagramPacket;)V
 332  */
 333 JNIEXPORT void JNICALL
<span class="line-modified"> 334 Java_java_net_PlainDatagramSocketImpl_send0(JNIEnv *env, jobject this,</span>
 335                                            jobject packet) {
 336 
 337     char BUF[MAX_BUFFER_LEN];
 338     char *fullPacket = NULL;
 339     int ret, mallocedPacket = JNI_FALSE;
 340     /* The object&#39;s field */
 341     jobject fdObj = (*env)-&gt;GetObjectField(env, this, pdsi_fdID);
 342     jint trafficClass = (*env)-&gt;GetIntField(env, this, pdsi_trafficClassID);
 343 
 344     jbyteArray packetBuffer;
 345     jobject packetAddress;
 346     jint packetBufferOffset, packetBufferLen, packetPort;
 347     jboolean connected;
 348 
 349     /* The fdObj&#39;fd */
 350     jint fd;
 351 
 352     SOCKETADDRESS rmtaddr;
 353     struct sockaddr *rmtaddrP = 0;
 354     int len = 0;
</pre>
<hr />
<pre>
 369 
 370     packetBuffer = (*env)-&gt;GetObjectField(env, packet, dp_bufID);
 371     packetAddress = (*env)-&gt;GetObjectField(env, packet, dp_addressID);
 372     if (IS_NULL(packetBuffer) || IS_NULL(packetAddress)) {
 373         JNU_ThrowNullPointerException(env, &quot;null buffer || null address&quot;);
 374         return;
 375     }
 376 
 377     packetBufferOffset = (*env)-&gt;GetIntField(env, packet, dp_offsetID);
 378     packetBufferLen = (*env)-&gt;GetIntField(env, packet, dp_lengthID);
 379 
 380     // arg to NET_Sendto() null, if connected
 381     if (!connected) {
 382         packetPort = (*env)-&gt;GetIntField(env, packet, dp_portID);
 383         if (NET_InetAddressToSockaddr(env, packetAddress, packetPort, &amp;rmtaddr,
 384                                       &amp;len, JNI_TRUE) != 0) {
 385             return;
 386         }
 387         rmtaddrP = &amp;rmtaddr.sa;
 388     }

 389 
 390     if (packetBufferLen &gt; MAX_BUFFER_LEN) {
 391         /* When JNI-ifying the JDK&#39;s IO routines, we turned
 392          * reads and writes of byte arrays of size greater
 393          * than 2048 bytes into several operations of size 2048.
 394          * This saves a malloc()/memcpy()/free() for big
 395          * buffers.  This is OK for file IO and TCP, but that
 396          * strategy violates the semantics of a datagram protocol.
 397          * (one big send) != (several smaller sends).  So here
 398          * we *must* allocate the buffer.  Note it needn&#39;t be bigger
 399          * than 65,536 (0xFFFF), the max size of an IP packet.
 400          * Anything bigger should be truncated anyway.
 401          *
 402          * We may want to use a smarter allocation scheme at some
 403          * point.
 404          */
 405         if (packetBufferLen &gt; MAX_PACKET_LEN) {
 406             packetBufferLen = MAX_PACKET_LEN;
 407         }
 408         fullPacket = (char *)malloc(packetBufferLen);
</pre>
<hr />
<pre>
 890 JNIEXPORT void JNICALL
 891 Java_java_net_PlainDatagramSocketImpl_datagramSocketCreate(JNIEnv *env,
 892                                                            jobject this) {
 893     jobject fdObj = (*env)-&gt;GetObjectField(env, this, pdsi_fdID);
 894     int arg, fd, t = 1;
 895     char tmpbuf[1024];
 896     int domain = ipv6_available() ? AF_INET6 : AF_INET;
 897 
 898     if (IS_NULL(fdObj)) {
 899         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
 900                         &quot;Socket closed&quot;);
 901         return;
 902     }
 903 
 904     if ((fd = socket(domain, SOCK_DGRAM, 0)) == -1) {
 905         JNU_ThrowByNameWithMessageAndLastError
 906             (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Error creating socket&quot;);
 907         return;
 908     }
 909 
<span class="line-modified"> 910     /*</span>
<span class="line-modified"> 911      * If IPv4 is available, disable IPV6_V6ONLY to ensure dual-socket support.</span>
<span class="line-added"> 912      */</span>
<span class="line-added"> 913     if (domain == AF_INET6 &amp;&amp; ipv4_available()) {</span>
 914         arg = 0;
 915         if (setsockopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (char*)&amp;arg,
 916                        sizeof(int)) &lt; 0) {
 917             NET_ThrowNew(env, errno, &quot;cannot set IPPROTO_IPV6&quot;);
 918             close(fd);
 919             return;
 920         }
 921     }
 922 
 923 #ifdef __APPLE__
 924     arg = 65507;
 925     if (setsockopt(fd, SOL_SOCKET, SO_SNDBUF,
 926                    (char *)&amp;arg, sizeof(arg)) &lt; 0) {
 927         getErrorString(errno, tmpbuf, sizeof(tmpbuf));
 928         JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;, tmpbuf);
 929         close(fd);
 930         return;
 931     }
 932     if (setsockopt(fd, SOL_SOCKET, SO_RCVBUF,
 933                    (char *)&amp;arg, sizeof(arg)) &lt; 0) {
</pre>
<hr />
<pre>
1473         /*
1474          * For IP_MULTICAST_IF2 we get the NetworkInterface for
1475          * this address and return it
1476          */
1477         if (ni_class == NULL) {
1478             jclass c = (*env)-&gt;FindClass(env, &quot;java/net/NetworkInterface&quot;);
1479             CHECK_NULL_RETURN(c, NULL);
1480             ni_ctrID = (*env)-&gt;GetMethodID(env, c, &quot;&lt;init&gt;&quot;, &quot;()V&quot;);
1481             CHECK_NULL_RETURN(ni_ctrID, NULL);
1482             ni_indexID = (*env)-&gt;GetFieldID(env, c, &quot;index&quot;, &quot;I&quot;);
1483             CHECK_NULL_RETURN(ni_indexID, NULL);
1484             ni_addrsID = (*env)-&gt;GetFieldID(env, c, &quot;addrs&quot;,
1485                                             &quot;[Ljava/net/InetAddress;&quot;);
1486             CHECK_NULL_RETURN(ni_addrsID, NULL);
1487             ni_nameID = (*env)-&gt;GetFieldID(env, c,&quot;name&quot;, &quot;Ljava/lang/String;&quot;);
1488             CHECK_NULL_RETURN(ni_nameID, NULL);
1489             ni_class = (*env)-&gt;NewGlobalRef(env, c);
1490             CHECK_NULL_RETURN(ni_class, NULL);
1491         }
1492         ni = Java_java_net_NetworkInterface_getByInetAddress0(env, ni_class, addr);
<span class="line-added">1493         JNU_CHECK_EXCEPTION_RETURN(env, NULL);</span>
1494         if (ni) {
1495             return ni;
1496         }
<span class="line-modified">1497         return NULL;</span>


















1498     }
1499 
1500 
1501     /*
1502      * IPv6 implementation
1503      */
1504     if ((opt == java_net_SocketOptions_IP_MULTICAST_IF) ||
1505         (opt == java_net_SocketOptions_IP_MULTICAST_IF2)) {
1506 
1507         static jclass ni_class;
1508         static jmethodID ni_ctrID;
1509         static jfieldID ni_indexID;
1510         static jfieldID ni_addrsID;
1511         static jclass ia_class;
1512         static jfieldID ni_nameID;
1513         static jmethodID ia_anyLocalAddressID;
1514 
1515         int index = 0;
1516         socklen_t len = sizeof(index);
1517 
</pre>
<hr />
<pre>
1584             if ((*env)-&gt;GetArrayLength(env, addrArray) &lt; 1) {
1585                 JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
1586                     &quot;IPV6_MULTICAST_IF returned interface without IP bindings&quot;);
1587                 return NULL;
1588             }
1589 
1590             addr = (*env)-&gt;GetObjectArrayElement(env, addrArray, 0);
1591             return addr;
1592         }
1593 
1594         /*
1595          * Multicast to any address - return anyLocalAddress
1596          * or a NetworkInterface with addrs[0] set to anyLocalAddress
1597          */
1598 
1599         addr = (*env)-&gt;CallStaticObjectMethod(env, ia_class, ia_anyLocalAddressID,
1600                                               NULL);
1601         if (opt == java_net_SocketOptions_IP_MULTICAST_IF) {
1602             return addr;
1603         }













1604     }
1605     return NULL;
1606 }
1607 
1608 
1609 
1610 /*
1611  * Returns relevant info as a jint.
1612  *
1613  * Class:     java_net_PlainDatagramSocketImpl
1614  * Method:    socketGetOption
1615  * Signature: (I)Ljava/lang/Object;
1616  */
1617 JNIEXPORT jobject JNICALL
1618 Java_java_net_PlainDatagramSocketImpl_socketGetOption
1619   (JNIEnv *env, jobject this, jint opt)
1620 {
1621     int fd;
1622     int level, optname, optlen;
1623     union {
</pre>
<hr />
<pre>
2089             caddr[11] = 0xff;
2090 
2091             caddr[12] = ((address &gt;&gt; 24) &amp; 0xff);
2092             caddr[13] = ((address &gt;&gt; 16) &amp; 0xff);
2093             caddr[14] = ((address &gt;&gt; 8) &amp; 0xff);
2094             caddr[15] = (address &amp; 0xff);
2095         } else {
2096             getInet6Address_ipaddress(env, iaObj, (char*)caddr);
2097         }
2098 
2099         memcpy((void *)&amp;(mname6.ipv6mr_multiaddr), caddr, sizeof(struct in6_addr));
2100         if (IS_NULL(niObj)) {
2101             int index;
2102             socklen_t len = sizeof(index);
2103 
2104             if (getsockopt(fd, IPPROTO_IPV6, IPV6_MULTICAST_IF,
2105                            (char*)&amp;index, &amp;len) &lt; 0) {
2106                 NET_ThrowCurrent(env, &quot;getsockopt IPV6_MULTICAST_IF failed&quot;);
2107                 return;
2108             }




















2109             mname6.ipv6mr_interface = index;
2110         } else {
2111             jint idx = (*env)-&gt;GetIntField(env, niObj, ni_indexID);
2112             mname6.ipv6mr_interface = idx;
2113         }
2114 
2115 #if defined(_ALLBSD_SOURCE)
2116 #define ADD_MEMBERSHIP          IPV6_JOIN_GROUP
2117 #define DRP_MEMBERSHIP          IPV6_LEAVE_GROUP
2118 #define S_ADD_MEMBERSHIP        &quot;IPV6_JOIN_GROUP&quot;
2119 #define S_DRP_MEMBERSHIP        &quot;IPV6_LEAVE_GROUP&quot;
2120 #else
2121 #define ADD_MEMBERSHIP          IPV6_ADD_MEMBERSHIP
2122 #define DRP_MEMBERSHIP          IPV6_DROP_MEMBERSHIP
2123 #define S_ADD_MEMBERSHIP        &quot;IPV6_ADD_MEMBERSHIP&quot;
2124 #define S_DRP_MEMBERSHIP        &quot;IPV6_DROP_MEMBERSHIP&quot;
2125 #endif
2126 
2127         /* Join the multicast group */
2128         if (setsockopt(fd, IPPROTO_IPV6, (join ? ADD_MEMBERSHIP : DRP_MEMBERSHIP),
</pre>
</td>
</tr>
</table>
<center><a href="NetworkInterface.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="PlainSocketImpl.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>