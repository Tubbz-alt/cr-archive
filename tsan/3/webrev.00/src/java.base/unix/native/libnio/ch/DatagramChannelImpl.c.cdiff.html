<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/unix/native/libnio/ch/DatagramChannelImpl.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../../libnet/net_util_md.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="DatagramDispatcher.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libnio/ch/DatagramChannelImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 21,15 ***</span>
   * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
<span class="line-removed">- #include &quot;jni.h&quot;</span>
<span class="line-removed">- #include &quot;jni_util.h&quot;</span>
<span class="line-removed">- #include &quot;jvm.h&quot;</span>
<span class="line-removed">- #include &quot;jlong.h&quot;</span>
<span class="line-removed">- </span>
  #include &lt;netdb.h&gt;
  #include &lt;sys/types.h&gt;
  #include &lt;sys/socket.h&gt;
  #include &lt;stdlib.h&gt;
  #include &lt;string.h&gt;
<span class="line-new-header">--- 21,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 37,53 ***</span>
  
  #if defined(__linux__) || defined(_ALLBSD_SOURCE)
  #include &lt;netinet/in.h&gt;
  #endif
  
  #include &quot;net_util.h&quot;
<span class="line-removed">- #include &quot;net_util_md.h&quot;</span>
  #include &quot;nio.h&quot;
  #include &quot;nio_util.h&quot;
  
  #include &quot;sun_nio_ch_DatagramChannelImpl.h&quot;
  
<span class="line-removed">- static jfieldID dci_senderID;   /* sender in sun.nio.ch.DatagramChannelImpl */</span>
<span class="line-removed">- static jfieldID dci_senderAddrID; /* sender InetAddress in sun.nio.ch.DatagramChannelImpl */</span>
<span class="line-removed">- static jfieldID dci_senderPortID; /* sender port in sun.nio.ch.DatagramChannelImpl */</span>
<span class="line-removed">- static jclass isa_class;        /* java.net.InetSocketAddress */</span>
<span class="line-removed">- static jmethodID isa_ctorID;    /*   .InetSocketAddress(InetAddress, int) */</span>
<span class="line-removed">- </span>
<span class="line-removed">- JNIEXPORT void JNICALL</span>
<span class="line-removed">- Java_sun_nio_ch_DatagramChannelImpl_initIDs(JNIEnv *env, jclass clazz)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     clazz = (*env)-&gt;FindClass(env, &quot;java/net/InetSocketAddress&quot;);</span>
<span class="line-removed">-     CHECK_NULL(clazz);</span>
<span class="line-removed">-     isa_class = (*env)-&gt;NewGlobalRef(env, clazz);</span>
<span class="line-removed">-     if (isa_class == NULL) {</span>
<span class="line-removed">-         JNU_ThrowOutOfMemoryError(env, NULL);</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     isa_ctorID = (*env)-&gt;GetMethodID(env, clazz, &quot;&lt;init&gt;&quot;,</span>
<span class="line-removed">-                                      &quot;(Ljava/net/InetAddress;I)V&quot;);</span>
<span class="line-removed">-     CHECK_NULL(isa_ctorID);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     clazz = (*env)-&gt;FindClass(env, &quot;sun/nio/ch/DatagramChannelImpl&quot;);</span>
<span class="line-removed">-     CHECK_NULL(clazz);</span>
<span class="line-removed">-     dci_senderID = (*env)-&gt;GetFieldID(env, clazz, &quot;sender&quot;,</span>
<span class="line-removed">-                                       &quot;Ljava/net/SocketAddress;&quot;);</span>
<span class="line-removed">-     CHECK_NULL(dci_senderID);</span>
<span class="line-removed">-     dci_senderAddrID = (*env)-&gt;GetFieldID(env, clazz,</span>
<span class="line-removed">-                                           &quot;cachedSenderInetAddress&quot;,</span>
<span class="line-removed">-                                           &quot;Ljava/net/InetAddress;&quot;);</span>
<span class="line-removed">-     CHECK_NULL(dci_senderAddrID);</span>
<span class="line-removed">-     dci_senderPortID = (*env)-&gt;GetFieldID(env, clazz,</span>
<span class="line-removed">-                                           &quot;cachedSenderPort&quot;, &quot;I&quot;);</span>
<span class="line-removed">-     CHECK_NULL(dci_senderPortID);</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_sun_nio_ch_DatagramChannelImpl_disconnect0(JNIEnv *env, jobject this,</span>
                                                  jobject fdo, jboolean isIPv6)
  {
      jint fd = fdval(env, fdo);
      int rv;
  
<span class="line-new-header">--- 32,21 ---</span>
  
  #if defined(__linux__) || defined(_ALLBSD_SOURCE)
  #include &lt;netinet/in.h&gt;
  #endif
  
<span class="line-added">+ #include &quot;jni.h&quot;</span>
<span class="line-added">+ #include &quot;jni_util.h&quot;</span>
<span class="line-added">+ #include &quot;jlong.h&quot;</span>
  #include &quot;net_util.h&quot;
  #include &quot;nio.h&quot;
  #include &quot;nio_util.h&quot;
  
  #include &quot;sun_nio_ch_DatagramChannelImpl.h&quot;
  
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_sun_nio_ch_DatagramChannelImpl_disconnect0(JNIEnv *env, jclass clazz,</span>
                                                  jobject fdo, jboolean isIPv6)
  {
      jint fd = fdval(env, fdo);
      int rv;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 120,29 ***</span>
      if (rv &lt; 0)
          handleSocketError(env, errno);
  }
  
  JNIEXPORT jint JNICALL
<span class="line-modified">! Java_sun_nio_ch_DatagramChannelImpl_receive0(JNIEnv *env, jobject this,</span>
<span class="line-modified">!                                              jobject fdo, jlong address,</span>
<span class="line-modified">!                                              jint len, jboolean connected)</span>
  {
      jint fd = fdval(env, fdo);
<span class="line-modified">!     void *buf = (void *)jlong_to_ptr(address);</span>
<span class="line-modified">!     SOCKETADDRESS sa;</span>
      socklen_t sa_len = sizeof(SOCKETADDRESS);
      jboolean retry = JNI_FALSE;
<span class="line-modified">!     jint n = 0;</span>
<span class="line-removed">-     jobject senderAddr;</span>
  
      if (len &gt; MAX_PACKET_LEN) {
          len = MAX_PACKET_LEN;
      }
  
      do {
          retry = JNI_FALSE;
<span class="line-modified">!         n = recvfrom(fd, buf, len, 0, &amp;sa.sa, &amp;sa_len);</span>
          if (n &lt; 0) {
              if (errno == EAGAIN || errno == EWOULDBLOCK) {
                  return IOS_UNAVAILABLE;
              }
              if (errno == EINTR) {
<span class="line-new-header">--- 83,29 ---</span>
      if (rv &lt; 0)
          handleSocketError(env, errno);
  }
  
  JNIEXPORT jint JNICALL
<span class="line-modified">! Java_sun_nio_ch_DatagramChannelImpl_receive0(JNIEnv *env, jclass clazz,</span>
<span class="line-modified">!                                              jobject fdo, jlong bufAddress,</span>
<span class="line-modified">!                                              jint len, jlong senderAddress,</span>
<span class="line-added">+                                              jboolean connected)</span>
  {
      jint fd = fdval(env, fdo);
<span class="line-modified">!     void *buf = (void *)jlong_to_ptr(bufAddress);</span>
<span class="line-modified">!     SOCKETADDRESS *sa = (SOCKETADDRESS *)jlong_to_ptr(senderAddress);</span>
      socklen_t sa_len = sizeof(SOCKETADDRESS);
      jboolean retry = JNI_FALSE;
<span class="line-modified">!     jint n;</span>
  
      if (len &gt; MAX_PACKET_LEN) {
          len = MAX_PACKET_LEN;
      }
  
      do {
          retry = JNI_FALSE;
<span class="line-modified">!         n = recvfrom(fd, buf, len, 0, (struct sockaddr *)sa, &amp;sa_len);</span>
          if (n &lt; 0) {
              if (errno == EAGAIN || errno == EWOULDBLOCK) {
                  return IOS_UNAVAILABLE;
              }
              if (errno == EINTR) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 150,74 ***</span>
              }
              if (errno == ECONNREFUSED) {
                  if (connected == JNI_FALSE) {
                      retry = JNI_TRUE;
                  } else {
<span class="line-modified">!                     JNU_ThrowByName(env, JNU_JAVANETPKG</span>
<span class="line-removed">-                                     &quot;PortUnreachableException&quot;, 0);</span>
                      return IOS_THROWN;
                  }
              } else {
                  return handleSocketError(env, errno);
              }
          }
      } while (retry == JNI_TRUE);
  
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * If the source address and port match the cached address</span>
<span class="line-removed">-      * and port in DatagramChannelImpl then we don&#39;t need to</span>
<span class="line-removed">-      * create InetAddress and InetSocketAddress objects.</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     senderAddr = (*env)-&gt;GetObjectField(env, this, dci_senderAddrID);</span>
<span class="line-removed">-     if (senderAddr != NULL) {</span>
<span class="line-removed">-         if (!NET_SockaddrEqualsInetAddress(env, &amp;sa, senderAddr)) {</span>
<span class="line-removed">-             senderAddr = NULL;</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             jint port = (*env)-&gt;GetIntField(env, this, dci_senderPortID);</span>
<span class="line-removed">-             if (port != NET_GetPortFromSockaddr(&amp;sa)) {</span>
<span class="line-removed">-                 senderAddr = NULL;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     if (senderAddr == NULL) {</span>
<span class="line-removed">-         jobject isa = NULL;</span>
<span class="line-removed">-         int port = 0;</span>
<span class="line-removed">-         jobject ia = NET_SockaddrToInetAddress(env, &amp;sa, &amp;port);</span>
<span class="line-removed">-         if (ia != NULL) {</span>
<span class="line-removed">-             isa = (*env)-&gt;NewObject(env, isa_class, isa_ctorID, ia, port);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         CHECK_NULL_RETURN(isa, IOS_THROWN);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         (*env)-&gt;SetObjectField(env, this, dci_senderAddrID, ia);</span>
<span class="line-removed">-         (*env)-&gt;SetIntField(env, this, dci_senderPortID,</span>
<span class="line-removed">-                             NET_GetPortFromSockaddr(&amp;sa));</span>
<span class="line-removed">-         (*env)-&gt;SetObjectField(env, this, dci_senderID, isa);</span>
<span class="line-removed">-     }</span>
      return n;
  }
  
  JNIEXPORT jint JNICALL
<span class="line-modified">! Java_sun_nio_ch_DatagramChannelImpl_send0(JNIEnv *env, jobject this,</span>
<span class="line-modified">!                                           jboolean preferIPv6, jobject fdo, jlong address,</span>
<span class="line-modified">!                                           jint len, jobject destAddress, jint destPort)</span>
  {
      jint fd = fdval(env, fdo);
<span class="line-modified">!     void *buf = (void *)jlong_to_ptr(address);</span>
<span class="line-modified">!     SOCKETADDRESS sa;</span>
<span class="line-modified">!     int sa_len = 0;</span>
<span class="line-modified">!     jint n = 0;</span>
  
      if (len &gt; MAX_PACKET_LEN) {
          len = MAX_PACKET_LEN;
      }
  
<span class="line-modified">!     if (NET_InetAddressToSockaddr(env, destAddress, destPort, &amp;sa,</span>
<span class="line-removed">-                                   &amp;sa_len, preferIPv6) != 0) {</span>
<span class="line-removed">-       return IOS_THROWN;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     n = sendto(fd, buf, len, 0, &amp;sa.sa, sa_len);</span>
      if (n &lt; 0) {
          if (errno == EAGAIN || errno == EWOULDBLOCK) {
              return IOS_UNAVAILABLE;
          }
          if (errno == EINTR) {
<span class="line-new-header">--- 113,38 ---</span>
              }
              if (errno == ECONNREFUSED) {
                  if (connected == JNI_FALSE) {
                      retry = JNI_TRUE;
                  } else {
<span class="line-modified">!                     JNU_ThrowByName(env, JNU_JAVANETPKG &quot;PortUnreachableException&quot;, 0);</span>
                      return IOS_THROWN;
                  }
              } else {
                  return handleSocketError(env, errno);
              }
          }
      } while (retry == JNI_TRUE);
  
      return n;
  }
  
  JNIEXPORT jint JNICALL
<span class="line-modified">! Java_sun_nio_ch_DatagramChannelImpl_send0(JNIEnv *env, jclass clazz,</span>
<span class="line-modified">!                                           jobject fdo, jlong bufAddress, jint len,</span>
<span class="line-modified">!                                           jlong targetAddress, jint targetAddressLen)</span>
  {
      jint fd = fdval(env, fdo);
<span class="line-modified">!     void *buf = (void *)jlong_to_ptr(bufAddress);</span>
<span class="line-modified">!     SOCKETADDRESS *sa = (SOCKETADDRESS *)jlong_to_ptr(targetAddress);</span>
<span class="line-modified">!     socklen_t sa_len = (socklen_t) targetAddressLen;</span>
<span class="line-modified">!     jint n;</span>
  
      if (len &gt; MAX_PACKET_LEN) {
          len = MAX_PACKET_LEN;
      }
  
<span class="line-modified">!     n = sendto(fd, buf, len, 0, (struct sockaddr *)sa, sa_len);</span>
      if (n &lt; 0) {
          if (errno == EAGAIN || errno == EWOULDBLOCK) {
              return IOS_UNAVAILABLE;
          }
          if (errno == EINTR) {
</pre>
<center><a href="../../libnet/net_util_md.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="DatagramDispatcher.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>