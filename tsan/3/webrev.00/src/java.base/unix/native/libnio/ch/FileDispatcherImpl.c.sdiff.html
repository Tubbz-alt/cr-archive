<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/unix/native/libnio/ch/FileDispatcherImpl.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="FileChannelImpl.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="IOUtil.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/native/libnio/ch/FileDispatcherImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
294     }
295 }
296 
297 JNIEXPORT void JNICALL
298 Java_sun_nio_ch_FileDispatcherImpl_close0(JNIEnv *env, jclass clazz, jobject fdo)
299 {
300     jint fd = fdval(env, fdo);
301     closeFileDescriptor(env, fd);
302 }
303 
304 JNIEXPORT void JNICALL
305 Java_sun_nio_ch_FileDispatcherImpl_preClose0(JNIEnv *env, jclass clazz, jobject fdo)
306 {
307     jint fd = fdval(env, fdo);
308     if (preCloseFD &gt;= 0) {
309         if (dup2(preCloseFD, fd) &lt; 0)
310             JNU_ThrowIOExceptionWithLastError(env, &quot;dup2 failed&quot;);
311     }
312 }
313 








314 JNIEXPORT void JNICALL
315 Java_sun_nio_ch_FileDispatcherImpl_closeIntFD(JNIEnv *env, jclass clazz, jint fd)
316 {
317     closeFileDescriptor(env, fd);
318 }
319 
320 JNIEXPORT jint JNICALL
321 Java_sun_nio_ch_FileDispatcherImpl_setDirect0(JNIEnv *env, jclass clazz,
322                                            jobject fdo)
323 {
324     jint fd = fdval(env, fdo);
325     jint result;
326 #ifdef MACOSX
327     struct statvfs file_stat;
328 #else
329     struct statvfs64 file_stat;
330 #endif
331 
332 #if defined(O_DIRECT) || defined(F_NOCACHE) || defined(DIRECTIO_ON)
333 #ifdef O_DIRECT
334     jint orig_flag;
335     orig_flag = fcntl(fd, F_GETFL);
336     if (orig_flag == -1) {
337         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
338         return -1;
339     }
340     result = fcntl(fd, F_SETFL, orig_flag | O_DIRECT);
341     if (result == -1) {
342         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
343         return result;
344     }
<span class="line-modified">345 #elif F_NOCACHE</span>
346     result = fcntl(fd, F_NOCACHE, 1);
347     if (result == -1) {
348         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
349         return result;
350     }
<span class="line-modified">351 #elif DIRECTIO_ON</span>
352     result = directio(fd, DIRECTIO_ON);
353     if (result == -1) {
354         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
355         return result;
356     }
357 #endif
358 #ifdef MACOSX
359     result = fstatvfs(fd, &amp;file_stat);
360 #else
361     result = fstatvfs64(fd, &amp;file_stat);
362 #endif
363     if(result == -1) {
364         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
365         return result;
366     } else {
367         result = (int)file_stat.f_frsize;
368     }
369 #else
370     result == -1;
371 #endif
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
294     }
295 }
296 
297 JNIEXPORT void JNICALL
298 Java_sun_nio_ch_FileDispatcherImpl_close0(JNIEnv *env, jclass clazz, jobject fdo)
299 {
300     jint fd = fdval(env, fdo);
301     closeFileDescriptor(env, fd);
302 }
303 
304 JNIEXPORT void JNICALL
305 Java_sun_nio_ch_FileDispatcherImpl_preClose0(JNIEnv *env, jclass clazz, jobject fdo)
306 {
307     jint fd = fdval(env, fdo);
308     if (preCloseFD &gt;= 0) {
309         if (dup2(preCloseFD, fd) &lt; 0)
310             JNU_ThrowIOExceptionWithLastError(env, &quot;dup2 failed&quot;);
311     }
312 }
313 
<span class="line-added">314 JNIEXPORT void JNICALL</span>
<span class="line-added">315 Java_sun_nio_ch_FileDispatcherImpl_dup0(JNIEnv *env, jobject this, jobject fdo1, jobject fdo2)</span>
<span class="line-added">316 {</span>
<span class="line-added">317     if (dup2(fdval(env, fdo1), fdval(env, fdo2)) &lt; 0) {</span>
<span class="line-added">318         JNU_ThrowIOExceptionWithLastError(env, &quot;dup2 failed&quot;);</span>
<span class="line-added">319     }</span>
<span class="line-added">320 }</span>
<span class="line-added">321 </span>
322 JNIEXPORT void JNICALL
323 Java_sun_nio_ch_FileDispatcherImpl_closeIntFD(JNIEnv *env, jclass clazz, jint fd)
324 {
325     closeFileDescriptor(env, fd);
326 }
327 
328 JNIEXPORT jint JNICALL
329 Java_sun_nio_ch_FileDispatcherImpl_setDirect0(JNIEnv *env, jclass clazz,
330                                            jobject fdo)
331 {
332     jint fd = fdval(env, fdo);
333     jint result;
334 #ifdef MACOSX
335     struct statvfs file_stat;
336 #else
337     struct statvfs64 file_stat;
338 #endif
339 
340 #if defined(O_DIRECT) || defined(F_NOCACHE) || defined(DIRECTIO_ON)
341 #ifdef O_DIRECT
342     jint orig_flag;
343     orig_flag = fcntl(fd, F_GETFL);
344     if (orig_flag == -1) {
345         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
346         return -1;
347     }
348     result = fcntl(fd, F_SETFL, orig_flag | O_DIRECT);
349     if (result == -1) {
350         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
351         return result;
352     }
<span class="line-modified">353 #elif defined(F_NOCACHE)</span>
354     result = fcntl(fd, F_NOCACHE, 1);
355     if (result == -1) {
356         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
357         return result;
358     }
<span class="line-modified">359 #elif defined(DIRECTIO_ON)</span>
360     result = directio(fd, DIRECTIO_ON);
361     if (result == -1) {
362         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
363         return result;
364     }
365 #endif
366 #ifdef MACOSX
367     result = fstatvfs(fd, &amp;file_stat);
368 #else
369     result = fstatvfs64(fd, &amp;file_stat);
370 #endif
371     if(result == -1) {
372         JNU_ThrowIOExceptionWithLastError(env, &quot;DirectIO setup failed&quot;);
373         return result;
374     } else {
375         result = (int)file_stat.f_frsize;
376     }
377 #else
378     result == -1;
379 #endif
</pre>
</td>
</tr>
</table>
<center><a href="FileChannelImpl.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="IOUtil.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>