<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/unix/classes/sun/nio/fs/UnixNativeDispatcher.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="UnixFileStore.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../native/libjava/ProcessImpl_md.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/classes/sun/nio/fs/UnixNativeDispatcher.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2008, 2015, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2008, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,22 +23,19 @@</span>
   * questions.
   */
  
  package sun.nio.fs;
  
<span class="udiff-line-removed">- import java.security.AccessController;</span>
<span class="udiff-line-removed">- import java.security.PrivilegedAction;</span>
<span class="udiff-line-removed">- </span>
  /**
   * Unix system and library calls.
   */
  
  class UnixNativeDispatcher {
      protected UnixNativeDispatcher() { }
  
      // returns a NativeBuffer containing the given path
<span class="udiff-line-modified-removed">-     private static NativeBuffer copyToNativeBuffer(UnixPath path) {</span>
<span class="udiff-line-modified-added">+     static NativeBuffer copyToNativeBuffer(UnixPath path) {</span>
          byte[] cstr = path.getByteArrayForSysCalls();
          int size = cstr.length + 1;
          NativeBuffer buffer = NativeBuffers.getNativeBufferFromCache(size);
          if (buffer == null) {
              buffer = NativeBuffers.allocNativeBuffer(size);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -119,10 +116,20 @@</span>
      /**
       * fclose(FILE* stream)
       */
      static native void fclose(long stream) throws UnixException;
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * void rewind(FILE* stream);</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     static native void rewind(long stream) throws UnixException;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * ssize_t getline(char **lineptr, size_t *n, FILE *stream);</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     static native int getlinelen(long stream) throws UnixException;</span>
<span class="udiff-line-added">+ </span>
      /**
       * link(const char* existing, const char* new)
       */
      static void link(UnixPath existing, UnixPath newfile) throws UnixException {
          NativeBuffer existingBuffer = copyToNativeBuffer(existing);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -399,11 +406,11 @@</span>
       * fchmod(int fildes, mode_t mode)
       */
      static native void fchmod(int fd, int mode) throws UnixException;
  
      /**
<span class="udiff-line-modified-removed">-      * utimes(conar char* path, const struct timeval times[2])</span>
<span class="udiff-line-modified-added">+      * utimes(const char* path, const struct timeval times[2])</span>
       */
      static void utimes(UnixPath path, long times0, long times1)
          throws UnixException
      {
          NativeBuffer buffer = copyToNativeBuffer(path);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -415,14 +422,35 @@</span>
      }
      private static native void utimes0(long pathAddress, long times0, long times1)
          throws UnixException;
  
      /**
<span class="udiff-line-modified-removed">-      * futimes(int fildes,, const struct timeval times[2])</span>
<span class="udiff-line-modified-added">+      * futimes(int fildes, const struct timeval times[2])</span>
       */
      static native void futimes(int fd, long times0, long times1) throws UnixException;
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * futimens(int fildes, const struct timespec times[2])</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     static native void futimens(int fd, long times0, long times1) throws UnixException;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * lutimes(const char* path, const struct timeval times[2])</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     static void lutimes(UnixPath path, long times0, long times1)</span>
<span class="udiff-line-added">+         throws UnixException</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+         NativeBuffer buffer = copyToNativeBuffer(path);</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             lutimes0(buffer.address(), times0, times1);</span>
<span class="udiff-line-added">+         } finally {</span>
<span class="udiff-line-added">+             buffer.release();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     private static native void lutimes0(long pathAddress, long times0, long times1)</span>
<span class="udiff-line-added">+         throws UnixException;</span>
<span class="udiff-line-added">+ </span>
      /**
       * DIR *opendir(const char* dirname)
       */
      static long opendir(UnixPath path) throws UnixException {
          NativeBuffer buffer = copyToNativeBuffer(path);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -576,13 +604,15 @@</span>
      static native byte[] strerror(int errnum);
  
      /**
       * Capabilities
       */
<span class="udiff-line-modified-removed">-     private static final int SUPPORTS_OPENAT        = 1 &lt;&lt; 1;    // syscalls</span>
<span class="udiff-line-modified-added">+     private static final int SUPPORTS_OPENAT        = 1 &lt;&lt; 1;  // syscalls</span>
      private static final int SUPPORTS_FUTIMES       = 1 &lt;&lt; 2;
<span class="udiff-line-modified-removed">-     private static final int SUPPORTS_BIRTHTIME     = 1 &lt;&lt; 16;   // other features</span>
<span class="udiff-line-modified-added">+     private static final int SUPPORTS_FUTIMENS      = 1 &lt;&lt; 4;</span>
<span class="udiff-line-added">+     private static final int SUPPORTS_LUTIMES       = 1 &lt;&lt; 8;</span>
<span class="udiff-line-added">+     private static final int SUPPORTS_BIRTHTIME     = 1 &lt;&lt; 16; // other features</span>
      private static final int capabilities;
  
      /**
       * Supports openat and other *at calls.
       */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -595,22 +625,32 @@</span>
       */
      static boolean futimesSupported() {
          return (capabilities &amp; SUPPORTS_FUTIMES) != 0;
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Supports futimens</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     static boolean futimensSupported() {</span>
<span class="udiff-line-added">+         return (capabilities &amp; SUPPORTS_FUTIMENS) != 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Supports lutimes</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     static boolean lutimesSupported() {</span>
<span class="udiff-line-added">+         return (capabilities &amp; SUPPORTS_LUTIMES) != 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Supports file birth (creation) time attribute
       */
      static boolean birthtimeSupported() {
          return (capabilities &amp; SUPPORTS_BIRTHTIME) != 0;
      }
  
      private static native int init();
      static {
<span class="udiff-line-modified-removed">-         AccessController.doPrivileged(new PrivilegedAction&lt;&gt;() {</span>
<span class="udiff-line-removed">-             public Void run() {</span>
<span class="udiff-line-removed">-                 System.loadLibrary(&quot;nio&quot;);</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-         }});</span>
<span class="udiff-line-modified-added">+         jdk.internal.loader.BootLoader.loadLibrary(&quot;nio&quot;);</span>
          capabilities = init();
      }
  }
</pre>
<center><a href="UnixFileStore.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../native/libjava/ProcessImpl_md.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>