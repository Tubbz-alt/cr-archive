<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.base/unix/classes/sun/nio/fs/UnixFileAttributeViews.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2008, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.nio.fs;
 27 
 28 import java.nio.file.*;
 29 import java.nio.file.attribute.*;
 30 import java.util.*;
 31 import java.util.concurrent.TimeUnit;
 32 import java.io.IOException;
 33 
 34 import static sun.nio.fs.UnixNativeDispatcher.*;
 35 
 36 class UnixFileAttributeViews {
 37 
 38     static class Basic extends AbstractBasicFileAttributeView {
 39         protected final UnixPath file;
 40         protected final boolean followLinks;
 41 
 42         Basic(UnixPath file, boolean followLinks) {
 43             this.file = file;
 44             this.followLinks = followLinks;
 45         }
 46 
 47         @Override
 48         public BasicFileAttributes readAttributes() throws IOException {
 49             file.checkRead();
 50             try {
 51                  UnixFileAttributes attrs =
 52                      UnixFileAttributes.get(file, followLinks);
 53                  return attrs.asBasicFileAttributes();
 54             } catch (UnixException x) {
 55                 x.rethrowAsIOException(file);
 56                 return null;    // keep compiler happy
 57             }
 58         }
 59 
 60         @Override
 61         public void setTimes(FileTime lastModifiedTime,
 62                              FileTime lastAccessTime,
 63                              FileTime createTime) throws IOException
 64         {
 65             // null =&gt; don&#39;t change
 66             if (lastModifiedTime == null &amp;&amp; lastAccessTime == null) {
 67                 // no effect
 68                 return;
 69             }
 70 
 71             // permission check
 72             file.checkWrite();
 73 
 74             boolean haveFd = false;
 75             boolean useFutimes = false;
 76             boolean useFutimens = false;
 77             boolean useLutimes = false;
 78             int fd = -1;
 79             try {
 80                 if (!followLinks) {
 81                     useLutimes = lutimesSupported() &amp;&amp;
 82                         UnixFileAttributes.get(file, false).isSymbolicLink();
 83                 }
 84                 if (!useLutimes) {
 85                     fd = file.openForAttributeAccess(followLinks);
 86                     if (fd != -1) {
 87                         haveFd = true;
 88                         if (!(useFutimens = futimensSupported())) {
 89                             useFutimes = futimesSupported();
 90                         }
 91                     }
 92                 }
 93             } catch (UnixException x) {
 94                 if (!(x.errno() == UnixConstants.ENXIO ||
 95                      (x.errno() == UnixConstants.ELOOP &amp;&amp; useLutimes))) {
 96                     x.rethrowAsIOException(file);
 97                 }
 98             }
 99 
100             try {
101                 // assert followLinks || !UnixFileAttributes.get(fd).isSymbolicLink();
102 
103                 // if not changing both attributes then need existing attributes
104                 if (lastModifiedTime == null || lastAccessTime == null) {
105                     try {
106                         UnixFileAttributes attrs = haveFd ?
107                             UnixFileAttributes.get(fd) :
108                             UnixFileAttributes.get(file, followLinks);
109                         if (lastModifiedTime == null)
110                             lastModifiedTime = attrs.lastModifiedTime();
111                         if (lastAccessTime == null)
112                             lastAccessTime = attrs.lastAccessTime();
113                     } catch (UnixException x) {
114                         x.rethrowAsIOException(file);
115                     }
116                 }
117 
118                 // update times
119                 TimeUnit timeUnit = useFutimens ?
120                     TimeUnit.NANOSECONDS : TimeUnit.MICROSECONDS;
121                 long modValue = lastModifiedTime.to(timeUnit);
122                 long accessValue= lastAccessTime.to(timeUnit);
123 
124                 boolean retry = false;
125                 try {
126                     if (useFutimens) {
127                         futimens(fd, accessValue, modValue);
128                     } else if (useFutimes) {
129                         futimes(fd, accessValue, modValue);
130                     } else if (useLutimes) {
131                         lutimes(file, accessValue, modValue);
132                     } else {
133                         utimes(file, accessValue, modValue);
134                     }
135                 } catch (UnixException x) {
136                     // if futimes/utimes fails with EINVAL and one/both of the times is
137                     // negative then we adjust the value to the epoch and retry.
138                     if (x.errno() == UnixConstants.EINVAL &amp;&amp;
139                         (modValue &lt; 0L || accessValue &lt; 0L)) {
140                         retry = true;
141                     } else {
142                         x.rethrowAsIOException(file);
143                     }
144                 }
145                 if (retry) {
146                     if (modValue &lt; 0L) modValue = 0L;
147                     if (accessValue &lt; 0L) accessValue= 0L;
148                     try {
149                         if (useFutimens) {
150                             futimens(fd, accessValue, modValue);
151                         } else if (useFutimes) {
152                             futimes(fd, accessValue, modValue);
153                         } else if (useLutimes) {
154                             lutimes(file, accessValue, modValue);
155                         } else {
156                             utimes(file, accessValue, modValue);
157                         }
158                     } catch (UnixException x) {
159                         x.rethrowAsIOException(file);
160                     }
161                 }
162             } finally {
163                 close(fd);
164             }
165         }
166     }
167 
168     private static class Posix extends Basic implements PosixFileAttributeView {
169         private static final String PERMISSIONS_NAME = &quot;permissions&quot;;
170         private static final String OWNER_NAME = &quot;owner&quot;;
171         private static final String GROUP_NAME = &quot;group&quot;;
172 
173         // the names of the posix attributes (includes basic)
174         static final Set&lt;String&gt; posixAttributeNames =
175             Util.newSet(basicAttributeNames, PERMISSIONS_NAME, OWNER_NAME, GROUP_NAME);
176 
177         Posix(UnixPath file, boolean followLinks) {
178             super(file, followLinks);
179         }
180 
181         final void checkReadExtended() {
182             SecurityManager sm = System.getSecurityManager();
183             if (sm != null) {
184                 file.checkRead();
185                 sm.checkPermission(new RuntimePermission(&quot;accessUserInformation&quot;));
186             }
187         }
188 
189         final void checkWriteExtended() {
190             SecurityManager sm = System.getSecurityManager();
191             if (sm != null) {
192                 file.checkWrite();
193                 sm.checkPermission(new RuntimePermission(&quot;accessUserInformation&quot;));
194             }
195         }
196 
197         @Override
198         public String name() {
199             return &quot;posix&quot;;
200         }
201 
202         @Override
203         @SuppressWarnings(&quot;unchecked&quot;)
204         public void setAttribute(String attribute, Object value)
205             throws IOException
206         {
207             if (attribute.equals(PERMISSIONS_NAME)) {
208                 setPermissions((Set&lt;PosixFilePermission&gt;)value);
209                 return;
210             }
211             if (attribute.equals(OWNER_NAME)) {
212                 setOwner((UserPrincipal)value);
213                 return;
214             }
215             if (attribute.equals(GROUP_NAME)) {
216                 setGroup((GroupPrincipal)value);
217                 return;
218             }
219             super.setAttribute(attribute, value);
220         }
221 
222         /**
223          * Invoked by readAttributes or sub-classes to add all matching posix
224          * attributes to the builder
225          */
226         final void addRequestedPosixAttributes(PosixFileAttributes attrs,
227                                                AttributesBuilder builder)
228         {
229             addRequestedBasicAttributes(attrs, builder);
230             if (builder.match(PERMISSIONS_NAME))
231                 builder.add(PERMISSIONS_NAME, attrs.permissions());
232             if (builder.match(OWNER_NAME))
233                  builder.add(OWNER_NAME, attrs.owner());
234             if (builder.match(GROUP_NAME))
235                 builder.add(GROUP_NAME, attrs.group());
236         }
237 
238         @Override
239         public Map&lt;String,Object&gt; readAttributes(String[] requested)
240             throws IOException
241         {
242             AttributesBuilder builder =
243                 AttributesBuilder.create(posixAttributeNames, requested);
244             PosixFileAttributes attrs = readAttributes();
245             addRequestedPosixAttributes(attrs, builder);
246             return builder.unmodifiableMap();
247         }
248 
249         @Override
250         public UnixFileAttributes readAttributes() throws IOException {
251             checkReadExtended();
252             try {
253                  return UnixFileAttributes.get(file, followLinks);
254             } catch (UnixException x) {
255                 x.rethrowAsIOException(file);
256                 return null;    // keep compiler happy
257             }
258         }
259 
260         // chmod
261         final void setMode(int mode) throws IOException {
262             checkWriteExtended();
263             try {
264                 if (followLinks) {
265                     chmod(file, mode);
266                 } else {
267                     int fd = file.openForAttributeAccess(false);
268                     try {
269                         fchmod(fd, mode);
270                     } finally {
271                         close(fd);
272                     }
273                 }
274             } catch (UnixException x) {
275                 x.rethrowAsIOException(file);
276             }
277         }
278 
279         // chown
280         final void setOwners(int uid, int gid) throws IOException {
281             checkWriteExtended();
282             try {
283                 if (followLinks) {
284                     chown(file, uid, gid);
285                 } else {
286                     lchown(file, uid, gid);
287                 }
288             } catch (UnixException x) {
289                 x.rethrowAsIOException(file);
290             }
291         }
292 
293         @Override
294         public void setPermissions(Set&lt;PosixFilePermission&gt; perms)
295             throws IOException
296         {
297             setMode(UnixFileModeAttribute.toUnixMode(perms));
298         }
299 
300         @Override
301         public void setOwner(UserPrincipal owner)
302             throws IOException
303         {
304             if (owner == null)
305                 throw new NullPointerException(&quot;&#39;owner&#39; is null&quot;);
306             if (!(owner instanceof UnixUserPrincipals.User))
307                 throw new ProviderMismatchException();
308             if (owner instanceof UnixUserPrincipals.Group)
309                 throw new IOException(&quot;&#39;owner&#39; parameter can&#39;t be a group&quot;);
310             int uid = ((UnixUserPrincipals.User)owner).uid();
311             setOwners(uid, -1);
312         }
313 
314         @Override
315         public UserPrincipal getOwner() throws IOException {
316             return readAttributes().owner();
317         }
318 
319         @Override
320         public void setGroup(GroupPrincipal group)
321             throws IOException
322         {
323             if (group == null)
324                 throw new NullPointerException(&quot;&#39;owner&#39; is null&quot;);
325             if (!(group instanceof UnixUserPrincipals.Group))
326                 throw new ProviderMismatchException();
327             int gid = ((UnixUserPrincipals.Group)group).gid();
328             setOwners(-1, gid);
329         }
330     }
331 
332     private static class Unix extends Posix {
333         private static final String MODE_NAME = &quot;mode&quot;;
334         private static final String INO_NAME = &quot;ino&quot;;
335         private static final String DEV_NAME = &quot;dev&quot;;
336         private static final String RDEV_NAME = &quot;rdev&quot;;
337         private static final String NLINK_NAME = &quot;nlink&quot;;
338         private static final String UID_NAME = &quot;uid&quot;;
339         private static final String GID_NAME = &quot;gid&quot;;
340         private static final String CTIME_NAME = &quot;ctime&quot;;
341 
342         // the names of the unix attributes (including posix)
343         static final Set&lt;String&gt; unixAttributeNames =
344             Util.newSet(posixAttributeNames,
345                         MODE_NAME, INO_NAME, DEV_NAME, RDEV_NAME,
346                         NLINK_NAME, UID_NAME, GID_NAME, CTIME_NAME);
347 
348         Unix(UnixPath file, boolean followLinks) {
349             super(file, followLinks);
350         }
351 
352         @Override
353         public String name() {
354             return &quot;unix&quot;;
355         }
356 
357         @Override
358         public void setAttribute(String attribute, Object value)
359             throws IOException
360         {
361             if (attribute.equals(MODE_NAME)) {
362                 setMode((Integer)value);
363                 return;
364             }
365             if (attribute.equals(UID_NAME)) {
366                 setOwners((Integer)value, -1);
367                 return;
368             }
369             if (attribute.equals(GID_NAME)) {
370                 setOwners(-1, (Integer)value);
371                 return;
372             }
373             super.setAttribute(attribute, value);
374         }
375 
376         @Override
377         public Map&lt;String,Object&gt; readAttributes(String[] requested)
378             throws IOException
379         {
380             AttributesBuilder builder =
381                 AttributesBuilder.create(unixAttributeNames, requested);
382             UnixFileAttributes attrs = readAttributes();
383             addRequestedPosixAttributes(attrs, builder);
384             if (builder.match(MODE_NAME))
385                 builder.add(MODE_NAME, attrs.mode());
386             if (builder.match(INO_NAME))
387                 builder.add(INO_NAME, attrs.ino());
388             if (builder.match(DEV_NAME))
389                 builder.add(DEV_NAME, attrs.dev());
390             if (builder.match(RDEV_NAME))
391                 builder.add(RDEV_NAME, attrs.rdev());
392             if (builder.match(NLINK_NAME))
393                 builder.add(NLINK_NAME, attrs.nlink());
394             if (builder.match(UID_NAME))
395                 builder.add(UID_NAME, attrs.uid());
396             if (builder.match(GID_NAME))
397                 builder.add(GID_NAME, attrs.gid());
398             if (builder.match(CTIME_NAME))
399                 builder.add(CTIME_NAME, attrs.ctime());
400             return builder.unmodifiableMap();
401         }
402     }
403 
404     static Basic createBasicView(UnixPath file, boolean followLinks) {
405         return new Basic(file, followLinks);
406     }
407 
408     static Posix createPosixView(UnixPath file, boolean followLinks) {
409         return new Posix(file, followLinks);
410     }
411 
412     static Unix createUnixView(UnixPath file, boolean followLinks) {
413         return new Unix(file, followLinks);
414     }
415 
416     static FileOwnerAttributeViewImpl createOwnerView(UnixPath file, boolean followLinks) {
417         return new FileOwnerAttributeViewImpl(createPosixView(file, followLinks));
418     }
419 }
    </pre>
  </body>
</html>