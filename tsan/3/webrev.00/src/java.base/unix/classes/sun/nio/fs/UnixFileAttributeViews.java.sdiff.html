<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/unix/classes/sun/nio/fs/UnixFileAttributeViews.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="UnixCopyFile.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="UnixFileAttributes.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/classes/sun/nio/fs/UnixFileAttributeViews.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2008, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 56                 return null;    // keep compiler happy
 57             }
 58         }
 59 
 60         @Override
 61         public void setTimes(FileTime lastModifiedTime,
 62                              FileTime lastAccessTime,
 63                              FileTime createTime) throws IOException
 64         {
 65             // null =&gt; don&#39;t change
 66             if (lastModifiedTime == null &amp;&amp; lastAccessTime == null) {
 67                 // no effect
 68                 return;
 69             }
 70 
 71             // permission check
 72             file.checkWrite();
 73 
 74             boolean haveFd = false;
 75             boolean useFutimes = false;


 76             int fd = -1;
 77             try {
<span class="line-modified"> 78                 fd = file.openForAttributeAccess(followLinks);</span>
<span class="line-modified"> 79                 if (fd != -1) {</span>
<span class="line-modified"> 80                     haveFd = true;</span>
<span class="line-modified"> 81                     useFutimes = futimesSupported();</span>








 82                 }
 83             } catch (UnixException x) {
<span class="line-modified"> 84                 if (x.errno() != UnixConstants.ENXIO) {</span>

 85                     x.rethrowAsIOException(file);
 86                 }
 87             }
 88 
 89             try {
 90                 // assert followLinks || !UnixFileAttributes.get(fd).isSymbolicLink();
 91 
 92                 // if not changing both attributes then need existing attributes
 93                 if (lastModifiedTime == null || lastAccessTime == null) {
 94                     try {
 95                         UnixFileAttributes attrs = haveFd ?
 96                             UnixFileAttributes.get(fd) :
 97                             UnixFileAttributes.get(file, followLinks);
 98                         if (lastModifiedTime == null)
 99                             lastModifiedTime = attrs.lastModifiedTime();
100                         if (lastAccessTime == null)
101                             lastAccessTime = attrs.lastAccessTime();
102                     } catch (UnixException x) {
103                         x.rethrowAsIOException(file);
104                     }
105                 }
106 
<span class="line-modified">107                 // uptime times</span>
<span class="line-modified">108                 long modValue = lastModifiedTime.to(TimeUnit.MICROSECONDS);</span>
<span class="line-modified">109                 long accessValue= lastAccessTime.to(TimeUnit.MICROSECONDS);</span>


110 
111                 boolean retry = false;
112                 try {
<span class="line-modified">113                     if (useFutimes) {</span>


114                         futimes(fd, accessValue, modValue);


115                     } else {
116                         utimes(file, accessValue, modValue);
117                     }
118                 } catch (UnixException x) {
119                     // if futimes/utimes fails with EINVAL and one/both of the times is
120                     // negative then we adjust the value to the epoch and retry.
121                     if (x.errno() == UnixConstants.EINVAL &amp;&amp;
122                         (modValue &lt; 0L || accessValue &lt; 0L)) {
123                         retry = true;
124                     } else {
125                         x.rethrowAsIOException(file);
126                     }
127                 }
128                 if (retry) {
129                     if (modValue &lt; 0L) modValue = 0L;
130                     if (accessValue &lt; 0L) accessValue= 0L;
131                     try {
<span class="line-modified">132                         if (useFutimes) {</span>


133                             futimes(fd, accessValue, modValue);


134                         } else {
135                             utimes(file, accessValue, modValue);
136                         }
137                     } catch (UnixException x) {
138                         x.rethrowAsIOException(file);
139                     }
140                 }
141             } finally {
142                 close(fd);
143             }
144         }
145     }
146 
147     private static class Posix extends Basic implements PosixFileAttributeView {
148         private static final String PERMISSIONS_NAME = &quot;permissions&quot;;
149         private static final String OWNER_NAME = &quot;owner&quot;;
150         private static final String GROUP_NAME = &quot;group&quot;;
151 
152         // the names of the posix attributes (includes basic)
153         static final Set&lt;String&gt; posixAttributeNames =
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2008, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 56                 return null;    // keep compiler happy
 57             }
 58         }
 59 
 60         @Override
 61         public void setTimes(FileTime lastModifiedTime,
 62                              FileTime lastAccessTime,
 63                              FileTime createTime) throws IOException
 64         {
 65             // null =&gt; don&#39;t change
 66             if (lastModifiedTime == null &amp;&amp; lastAccessTime == null) {
 67                 // no effect
 68                 return;
 69             }
 70 
 71             // permission check
 72             file.checkWrite();
 73 
 74             boolean haveFd = false;
 75             boolean useFutimes = false;
<span class="line-added"> 76             boolean useFutimens = false;</span>
<span class="line-added"> 77             boolean useLutimes = false;</span>
 78             int fd = -1;
 79             try {
<span class="line-modified"> 80                 if (!followLinks) {</span>
<span class="line-modified"> 81                     useLutimes = lutimesSupported() &amp;&amp;</span>
<span class="line-modified"> 82                         UnixFileAttributes.get(file, false).isSymbolicLink();</span>
<span class="line-modified"> 83                 }</span>
<span class="line-added"> 84                 if (!useLutimes) {</span>
<span class="line-added"> 85                     fd = file.openForAttributeAccess(followLinks);</span>
<span class="line-added"> 86                     if (fd != -1) {</span>
<span class="line-added"> 87                         haveFd = true;</span>
<span class="line-added"> 88                         if (!(useFutimens = futimensSupported())) {</span>
<span class="line-added"> 89                             useFutimes = futimesSupported();</span>
<span class="line-added"> 90                         }</span>
<span class="line-added"> 91                     }</span>
 92                 }
 93             } catch (UnixException x) {
<span class="line-modified"> 94                 if (!(x.errno() == UnixConstants.ENXIO ||</span>
<span class="line-added"> 95                      (x.errno() == UnixConstants.ELOOP &amp;&amp; useLutimes))) {</span>
 96                     x.rethrowAsIOException(file);
 97                 }
 98             }
 99 
100             try {
101                 // assert followLinks || !UnixFileAttributes.get(fd).isSymbolicLink();
102 
103                 // if not changing both attributes then need existing attributes
104                 if (lastModifiedTime == null || lastAccessTime == null) {
105                     try {
106                         UnixFileAttributes attrs = haveFd ?
107                             UnixFileAttributes.get(fd) :
108                             UnixFileAttributes.get(file, followLinks);
109                         if (lastModifiedTime == null)
110                             lastModifiedTime = attrs.lastModifiedTime();
111                         if (lastAccessTime == null)
112                             lastAccessTime = attrs.lastAccessTime();
113                     } catch (UnixException x) {
114                         x.rethrowAsIOException(file);
115                     }
116                 }
117 
<span class="line-modified">118                 // update times</span>
<span class="line-modified">119                 TimeUnit timeUnit = useFutimens ?</span>
<span class="line-modified">120                     TimeUnit.NANOSECONDS : TimeUnit.MICROSECONDS;</span>
<span class="line-added">121                 long modValue = lastModifiedTime.to(timeUnit);</span>
<span class="line-added">122                 long accessValue= lastAccessTime.to(timeUnit);</span>
123 
124                 boolean retry = false;
125                 try {
<span class="line-modified">126                     if (useFutimens) {</span>
<span class="line-added">127                         futimens(fd, accessValue, modValue);</span>
<span class="line-added">128                     } else if (useFutimes) {</span>
129                         futimes(fd, accessValue, modValue);
<span class="line-added">130                     } else if (useLutimes) {</span>
<span class="line-added">131                         lutimes(file, accessValue, modValue);</span>
132                     } else {
133                         utimes(file, accessValue, modValue);
134                     }
135                 } catch (UnixException x) {
136                     // if futimes/utimes fails with EINVAL and one/both of the times is
137                     // negative then we adjust the value to the epoch and retry.
138                     if (x.errno() == UnixConstants.EINVAL &amp;&amp;
139                         (modValue &lt; 0L || accessValue &lt; 0L)) {
140                         retry = true;
141                     } else {
142                         x.rethrowAsIOException(file);
143                     }
144                 }
145                 if (retry) {
146                     if (modValue &lt; 0L) modValue = 0L;
147                     if (accessValue &lt; 0L) accessValue= 0L;
148                     try {
<span class="line-modified">149                         if (useFutimens) {</span>
<span class="line-added">150                             futimens(fd, accessValue, modValue);</span>
<span class="line-added">151                         } else if (useFutimes) {</span>
152                             futimes(fd, accessValue, modValue);
<span class="line-added">153                         } else if (useLutimes) {</span>
<span class="line-added">154                             lutimes(file, accessValue, modValue);</span>
155                         } else {
156                             utimes(file, accessValue, modValue);
157                         }
158                     } catch (UnixException x) {
159                         x.rethrowAsIOException(file);
160                     }
161                 }
162             } finally {
163                 close(fd);
164             }
165         }
166     }
167 
168     private static class Posix extends Basic implements PosixFileAttributeView {
169         private static final String PERMISSIONS_NAME = &quot;permissions&quot;;
170         private static final String OWNER_NAME = &quot;owner&quot;;
171         private static final String GROUP_NAME = &quot;group&quot;;
172 
173         // the names of the posix attributes (includes basic)
174         static final Set&lt;String&gt; posixAttributeNames =
</pre>
</td>
</tr>
</table>
<center><a href="UnixCopyFile.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="UnixFileAttributes.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>