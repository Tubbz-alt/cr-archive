<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/unix/classes/sun/nio/ch/SinkChannelImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="InheritedChannel.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SocketDispatcher.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/unix/classes/sun/nio/ch/SinkChannelImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -58,12 +58,11 @@</span>
      // -- The following fields are protected by stateLock
  
      // Channel state
      private static final int ST_INUSE = 0;
      private static final int ST_CLOSING = 1;
<span class="udiff-line-modified-removed">-     private static final int ST_KILLPENDING = 2;</span>
<span class="udiff-line-removed">-     private static final int ST_KILLED = 3;</span>
<span class="udiff-line-modified-added">+     private static final int ST_CLOSED = 2;</span>
      private int state;
  
      // ID of native thread doing write, for signalling
      private long thread;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,82 +82,106 @@</span>
          this.fd = fd;
          this.fdVal = IOUtil.fdVal(fd);
      }
  
      /**
<span class="udiff-line-modified-removed">-      * Invoked by implCloseChannel to close the channel.</span>
<span class="udiff-line-modified-added">+      * Closes the write end of the pipe if there are no write operation in</span>
<span class="udiff-line-added">+      * progress and the channel is not registered with a Selector.</span>
       */
<span class="udiff-line-modified-removed">-     @Override</span>
<span class="udiff-line-modified-removed">-     protected void implCloseSelectableChannel() throws IOException {</span>
<span class="udiff-line-modified-removed">-         assert !isOpen();</span>
<span class="udiff-line-modified-added">+     private boolean tryClose() throws IOException {</span>
<span class="udiff-line-modified-added">+         assert Thread.holdsLock(stateLock) &amp;&amp; state == ST_CLOSING;</span>
<span class="udiff-line-modified-added">+         if (thread == 0 &amp;&amp; !isRegistered()) {</span>
<span class="udiff-line-added">+             state = ST_CLOSED;</span>
<span class="udiff-line-added">+             nd.close(fd);</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         boolean interrupted = false;</span>
<span class="udiff-line-modified-removed">-         boolean blocking;</span>
<span class="udiff-line-modified-added">+     /**</span>
<span class="udiff-line-modified-added">+      * Invokes tryClose to attempt to close the write end of the pipe.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * This method is used for deferred closing by I/O and Selector operations.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private void tryFinishClose() {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             tryClose();</span>
<span class="udiff-line-added">+         } catch (IOException ignore) { }</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         // set state to ST_CLOSING</span>
<span class="udiff-line-modified-added">+     /**</span>
<span class="udiff-line-added">+      * Closes this channel when configured in blocking mode.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * If there is a write operation in progress then the write-end of the pipe</span>
<span class="udiff-line-added">+      * is pre-closed and the writer is signalled, in which case the final close</span>
<span class="udiff-line-added">+      * is deferred until the writer aborts.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private void implCloseBlockingMode() throws IOException {</span>
          synchronized (stateLock) {
              assert state &lt; ST_CLOSING;
              state = ST_CLOSING;
<span class="udiff-line-modified-removed">-             blocking = isBlocking();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // wait for any outstanding write to complete</span>
<span class="udiff-line-removed">-         if (blocking) {</span>
<span class="udiff-line-removed">-             synchronized (stateLock) {</span>
<span class="udiff-line-removed">-                 assert state == ST_CLOSING;</span>
<span class="udiff-line-modified-added">+             if (!tryClose()) {</span>
                  long th = thread;
                  if (th != 0) {
                      nd.preClose(fd);
                      NativeThread.signal(th);
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                     // wait for write operation to end</span>
<span class="udiff-line-removed">-                     while (thread != 0) {</span>
<span class="udiff-line-removed">-                         try {</span>
<span class="udiff-line-removed">-                             stateLock.wait();</span>
<span class="udiff-line-removed">-                         } catch (InterruptedException e) {</span>
<span class="udiff-line-removed">-                             interrupted = true;</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                     }</span>
                  }
              }
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             // non-blocking mode: wait for write to complete</span>
<span class="udiff-line-removed">-             writeLock.lock();</span>
<span class="udiff-line-removed">-             writeLock.unlock();</span>
          }
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         // set state to ST_KILLPENDING</span>
<span class="udiff-line-modified-added">+     /**</span>
<span class="udiff-line-added">+      * Closes this channel when configured in non-blocking mode.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * If the channel is registered with a Selector then the close is deferred</span>
<span class="udiff-line-added">+      * until the channel is flushed from all Selectors.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private void implCloseNonBlockingMode() throws IOException {</span>
          synchronized (stateLock) {
<span class="udiff-line-modified-removed">-             assert state == ST_CLOSING;</span>
<span class="udiff-line-modified-removed">-             state = ST_KILLPENDING;</span>
<span class="udiff-line-modified-added">+             assert state &lt; ST_CLOSING;</span>
<span class="udiff-line-modified-added">+             state = ST_CLOSING;</span>
          }
<span class="udiff-line-added">+         // wait for any write operation to complete before trying to close</span>
<span class="udiff-line-added">+         writeLock.lock();</span>
<span class="udiff-line-added">+         writeLock.unlock();</span>
<span class="udiff-line-added">+         synchronized (stateLock) {</span>
<span class="udiff-line-added">+             if (state == ST_CLOSING) {</span>
<span class="udiff-line-added">+                 tryClose();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-         // close socket if not registered with Selector</span>
<span class="udiff-line-modified-removed">-         if (!isRegistered())</span>
<span class="udiff-line-modified-removed">-             kill();</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         // restore interrupt status</span>
<span class="udiff-line-modified-removed">-         if (interrupted)</span>
<span class="udiff-line-modified-removed">-             Thread.currentThread().interrupt();</span>
<span class="udiff-line-modified-added">+     /**</span>
<span class="udiff-line-modified-added">+      * Invoked by implCloseChannel to close the channel.</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+     @Override</span>
<span class="udiff-line-modified-added">+     protected void implCloseSelectableChannel() throws IOException {</span>
<span class="udiff-line-modified-added">+         assert !isOpen();</span>
<span class="udiff-line-modified-added">+         if (isBlocking()) {</span>
<span class="udiff-line-added">+             implCloseBlockingMode();</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             implCloseNonBlockingMode();</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public void kill() throws IOException {</span>
<span class="udiff-line-modified-added">+     public void kill() {</span>
          synchronized (stateLock) {
<span class="udiff-line-modified-removed">-             assert thread == 0;</span>
<span class="udiff-line-modified-removed">-             if (state == ST_KILLPENDING) {</span>
<span class="udiff-line-removed">-                 state = ST_KILLED;</span>
<span class="udiff-line-removed">-                 nd.close(fd);</span>
<span class="udiff-line-modified-added">+             if (state == ST_CLOSING) {</span>
<span class="udiff-line-modified-added">+                 tryFinishClose();</span>
              }
          }
      }
  
      @Override
      protected void implConfigureBlocking(boolean block) throws IOException {
          writeLock.lock();
          try {
              synchronized (stateLock) {
<span class="udiff-line-added">+                 if (!isOpen())</span>
<span class="udiff-line-added">+                     throw new ClosedChannelException();</span>
                  IOUtil.configureBlocking(fd, block);
              }
          } finally {
              writeLock.unlock();
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,13 +253,12 @@</span>
          throws AsynchronousCloseException
      {
          if (blocking) {
              synchronized (stateLock) {
                  thread = 0;
<span class="udiff-line-removed">-                 // notify any thread waiting in implCloseSelectableChannel</span>
                  if (state == ST_CLOSING) {
<span class="udiff-line-modified-removed">-                     stateLock.notifyAll();</span>
<span class="udiff-line-modified-added">+                     tryFinishClose();</span>
                  }
              }
              // remove hook for Thread.interrupt
              end(completed);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -250,13 +272,17 @@</span>
          try {
              boolean blocking = isBlocking();
              int n = 0;
              try {
                  beginWrite(blocking);
<span class="udiff-line-modified-removed">-                 do {</span>
<span class="udiff-line-modified-removed">-                     n = IOUtil.write(fd, src, -1, nd);</span>
<span class="udiff-line-modified-removed">-                 } while ((n == IOStatus.INTERRUPTED) &amp;&amp; isOpen());</span>
<span class="udiff-line-modified-added">+                 n = IOUtil.write(fd, src, -1, nd);</span>
<span class="udiff-line-modified-added">+                 if (blocking) {</span>
<span class="udiff-line-modified-added">+                     while (IOStatus.okayToRetry(n) &amp;&amp; isOpen()) {</span>
<span class="udiff-line-added">+                         park(Net.POLLOUT);</span>
<span class="udiff-line-added">+                         n = IOUtil.write(fd, src, -1, nd);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
              } finally {
                  endWrite(blocking, n &gt; 0);
                  assert IOStatus.check(n);
              }
              return IOStatus.normalize(n);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -273,13 +299,17 @@</span>
          try {
              boolean blocking = isBlocking();
              long n = 0;
              try {
                  beginWrite(blocking);
<span class="udiff-line-modified-removed">-                 do {</span>
<span class="udiff-line-modified-removed">-                     n = IOUtil.write(fd, srcs, offset, length, nd);</span>
<span class="udiff-line-modified-removed">-                 } while ((n == IOStatus.INTERRUPTED) &amp;&amp; isOpen());</span>
<span class="udiff-line-modified-added">+                 n = IOUtil.write(fd, srcs, offset, length, nd);</span>
<span class="udiff-line-modified-added">+                 if (blocking) {</span>
<span class="udiff-line-modified-added">+                     while (IOStatus.okayToRetry(n) &amp;&amp; isOpen()) {</span>
<span class="udiff-line-added">+                         park(Net.POLLOUT);</span>
<span class="udiff-line-added">+                         n = IOUtil.write(fd, srcs, offset, length, nd);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
              } finally {
                  endWrite(blocking, n &gt; 0);
                  assert IOStatus.check(n);
              }
              return IOStatus.normalize(n);
</pre>
<center><a href="InheritedChannel.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SocketDispatcher.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>