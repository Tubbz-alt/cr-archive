<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/unix/classes/sun/nio/fs/UnixFileStore.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2008, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.nio.fs;
 27 
<a name="2" id="anc2"></a>

 28 import jdk.internal.util.StaticProperty;
 29 
 30 import java.nio.file.*;
 31 import java.nio.file.attribute.*;
 32 import java.nio.channels.*;
 33 import java.util.*;
 34 import java.io.IOException;
 35 import java.security.AccessController;
 36 import java.security.PrivilegedAction;
 37 
 38 /**
 39  * Base implementation of FileStore for Unix/like implementations.
 40  */
 41 
 42 abstract class UnixFileStore
 43     extends FileStore
 44 {
 45     // original path of file that identified file system
 46     private final UnixPath file;
 47 
 48     // device ID
 49     private final long dev;
 50 
 51     // entry in the mount tab
 52     private final UnixMountEntry entry;
 53 
 54     // return the device ID where the given file resides
 55     private static long devFor(UnixPath file) throws IOException {
 56         try {
 57             return UnixFileAttributes.get(file, true).dev();
 58         } catch (UnixException x) {
 59             x.rethrowAsIOException(file);
 60             return 0L;  // keep compiler happy
 61         }
 62     }
 63 
 64     UnixFileStore(UnixPath file) throws IOException {
 65         this.file = file;
 66         this.dev = devFor(file);
 67         this.entry = findMountEntry();
 68     }
 69 
 70     UnixFileStore(UnixFileSystem fs, UnixMountEntry entry) throws IOException {
 71         this.file = new UnixPath(fs, entry.dir());
 72         this.dev = (entry.dev() == 0L) ? devFor(this.file) : entry.dev();
 73         this.entry = entry;
 74     }
 75 
 76     /**
 77      * Find the mount entry for the file store
 78      */
 79     abstract UnixMountEntry findMountEntry() throws IOException;
 80 
 81     UnixPath file() {
 82         return file;
 83     }
 84 
 85     long dev() {
 86         return dev;
 87     }
 88 
 89     UnixMountEntry entry() {
 90         return entry;
 91     }
 92 
 93     @Override
 94     public String name() {
 95         return entry.name();
 96     }
 97 
 98     @Override
 99     public String type() {
100         return entry.fstype();
101     }
102 
103     @Override
104     public boolean isReadOnly() {
105         return entry.isReadOnly();
106     }
107 
108     // uses statvfs to read the file system information
109     private UnixFileStoreAttributes readAttributes() throws IOException {
110         try {
111             return UnixFileStoreAttributes.get(file);
112         } catch (UnixException x) {
113             x.rethrowAsIOException(file);
114             return null;    // keep compile happy
115         }
116     }
117 
118     @Override
119     public long getTotalSpace() throws IOException {
120         UnixFileStoreAttributes attrs = readAttributes();
<a name="3" id="anc3"></a><span class="line-modified">121         return attrs.blockSize() * attrs.totalBlocks();</span>




122     }
123 
124     @Override
125     public long getUsableSpace() throws IOException {
<a name="4" id="anc4"></a><span class="line-modified">126        UnixFileStoreAttributes attrs = readAttributes();</span>
<span class="line-modified">127        return attrs.blockSize() * attrs.availableBlocks();</span>




128     }
129 
130     @Override
<a name="5" id="anc5"></a><span class="line-modified">131     public long getBlockSize() throws IOException {</span>
<span class="line-modified">132        UnixFileStoreAttributes attrs = readAttributes();</span>
<span class="line-modified">133        return attrs.blockSize();</span>




134     }
135 
136     @Override
<a name="6" id="anc6"></a><span class="line-modified">137     public long getUnallocatedSpace() throws IOException {</span>
<span class="line-modified">138         UnixFileStoreAttributes attrs = readAttributes();</span>
<span class="line-modified">139         return attrs.blockSize() * attrs.freeBlocks();</span>
140     }
141 
142     @Override
143     public &lt;V extends FileStoreAttributeView&gt; V getFileStoreAttributeView(Class&lt;V&gt; view)
144     {
145         if (view == null)
146             throw new NullPointerException();
147         return (V) null;
148     }
149 
150     @Override
151     public Object getAttribute(String attribute) throws IOException {
152         if (attribute.equals(&quot;totalSpace&quot;))
153             return getTotalSpace();
154         if (attribute.equals(&quot;usableSpace&quot;))
155             return getUsableSpace();
156         if (attribute.equals(&quot;unallocatedSpace&quot;))
157             return getUnallocatedSpace();
158         throw new UnsupportedOperationException(&quot;&#39;&quot; + attribute + &quot;&#39; not recognized&quot;);
159     }
160 
161     @Override
162     public boolean supportsFileAttributeView(Class&lt;? extends FileAttributeView&gt; type) {
163         if (type == null)
164             throw new NullPointerException();
165         if (type == BasicFileAttributeView.class)
166             return true;
167         if (type == PosixFileAttributeView.class ||
168             type == FileOwnerAttributeView.class)
169         {
170             // lookup fstypes.properties
171             FeatureStatus status = checkIfFeaturePresent(&quot;posix&quot;);
172             // assume supported if UNKNOWN
173             return (status != FeatureStatus.NOT_PRESENT);
174         }
175         return false;
176     }
177 
178     @Override
179     public boolean supportsFileAttributeView(String name) {
180         if (name.equals(&quot;basic&quot;) || name.equals(&quot;unix&quot;))
181             return true;
182         if (name.equals(&quot;posix&quot;))
183             return supportsFileAttributeView(PosixFileAttributeView.class);
184         if (name.equals(&quot;owner&quot;))
185             return supportsFileAttributeView(FileOwnerAttributeView.class);
186         return false;
187     }
188 
189     @Override
190     public boolean equals(Object ob) {
191         if (ob == this)
192             return true;
193         if (!(ob instanceof UnixFileStore))
194             return false;
195         UnixFileStore other = (UnixFileStore)ob;
196         return (this.dev == other.dev) &amp;&amp;
197                Arrays.equals(this.entry.dir(), other.entry.dir()) &amp;&amp;
198                this.entry.name().equals(other.entry.name());
199     }
200 
201     @Override
202     public int hashCode() {
203         return (int)(dev ^ (dev &gt;&gt;&gt; 32)) ^ Arrays.hashCode(entry.dir());
204     }
205 
206     @Override
207     public String toString() {
208         StringBuilder sb = new StringBuilder(Util.toString(entry.dir()));
209         sb.append(&quot; (&quot;);
210         sb.append(entry.name());
211         sb.append(&quot;)&quot;);
212         return sb.toString();
213     }
214 
215     // -- fstypes.properties --
216 
217     private static final Object loadLock = new Object();
218     private static volatile Properties props;
219 
220     enum FeatureStatus {
221         PRESENT,
222         NOT_PRESENT,
223         UNKNOWN;
224     }
225 
226     /**
227      * Returns status to indicate if file system supports a given feature
228      */
229     FeatureStatus checkIfFeaturePresent(String feature) {
230         if (props == null) {
231             synchronized (loadLock) {
232                 if (props == null) {
233                     props = AccessController.doPrivileged(
234                         new PrivilegedAction&lt;&gt;() {
235                             @Override
236                             public Properties run() {
237                                 return loadProperties();
238                             }});
239                 }
240             }
241         }
242 
243         String value = props.getProperty(type());
244         if (value != null) {
245             String[] values = value.split(&quot;\\s&quot;);
246             for (String s: values) {
247                 s = s.trim().toLowerCase();
248                 if (s.equals(feature)) {
249                     return FeatureStatus.PRESENT;
250                 }
251                 if (s.startsWith(&quot;no&quot;)) {
252                     s = s.substring(2);
253                     if (s.equals(feature)) {
254                         return FeatureStatus.NOT_PRESENT;
255                     }
256                 }
257             }
258         }
259         return FeatureStatus.UNKNOWN;
260     }
261 
262     private static Properties loadProperties() {
263         Properties result = new Properties();
264         String fstypes = StaticProperty.javaHome() + &quot;/lib/fstypes.properties&quot;;
265         Path file = Path.of(fstypes);
266         try {
267             try (ReadableByteChannel rbc = Files.newByteChannel(file)) {
<a name="7" id="anc7"></a><span class="line-modified">268                 result.load(Channels.newReader(rbc, &quot;UTF-8&quot;));</span>
269             }
270         } catch (IOException x) {
271         }
272         return result;
273     }
274 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>