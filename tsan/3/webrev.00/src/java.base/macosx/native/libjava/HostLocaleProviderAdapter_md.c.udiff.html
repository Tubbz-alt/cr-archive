<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/macosx/native/libjava/HostLocaleProviderAdapter_md.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../classes/sun/util/locale/provider/HostLocaleProviderAdapterImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="java_props_macosx.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/macosx/native/libjava/HostLocaleProviderAdapter_md.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, 2013, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,15 +28,24 @@</span>
  #include &lt;CoreFoundation/CoreFoundation.h&gt;
  #include &lt;stdio.h&gt;
  
  #define BUFLEN 256
  
<span class="udiff-line-added">+ // java.util.Calendar constants</span>
<span class="udiff-line-added">+ #define CALENDAR_FIELD_ERA              0           // Calendar.ERA</span>
<span class="udiff-line-added">+ #define CALENDAR_FIELD_DAY_OF_WEEK      7           // Calendar.DAY_OF_WEEK</span>
<span class="udiff-line-added">+ #define CALENDAR_FIELD_AM_PM            9           // Calendar.AM_PM</span>
<span class="udiff-line-added">+ #define JAPANESE_MEIJI_INDEX            232</span>
<span class="udiff-line-added">+ </span>
  static CFDateFormatterStyle convertDateFormatterStyle(jint javaStyle);
  static CFNumberFormatterStyle convertNumberFormatterStyle(jint javaStyle);
  static void copyArrayElements(JNIEnv *env, CFArrayRef cfarray, jobjectArray jarray, CFIndex sindex, int dindex, int count);
  static jstring getNumberSymbolString(JNIEnv *env, jstring jlangtag, jstring jdefault, CFStringRef type);
  static jchar getNumberSymbolChar(JNIEnv *env, jstring jlangtag, jchar jdefault, CFStringRef type);
<span class="udiff-line-added">+ jobjectArray getErasImpl(JNIEnv *env, jstring jlangtag, jint style, jobjectArray eras);</span>
<span class="udiff-line-added">+ jobjectArray getWeekdaysImpl(JNIEnv *env, jclass cls, jstring jlangtag, jint style, jobjectArray wdays);</span>
<span class="udiff-line-added">+ jobjectArray getAmPmImpl(JNIEnv *env, jclass cls, jstring jlangtag, jint style, jobjectArray ampms);</span>
  
  // from java_props_macosx.c
  extern char * getMacOSXLocale(int cat);
  extern char * getPosixLocale(int cat);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -129,72 +138,21 @@</span>
   * Method:    getAmPmStrings
   * Signature: (Ljava/lang/String;[Ljava/lang/String;)[Ljava/lang/String;
   */
  JNIEXPORT jobjectArray JNICALL Java_sun_util_locale_provider_HostLocaleProviderAdapterImpl_getAmPmStrings
    (JNIEnv *env, jclass cls, jstring jlangtag, jobjectArray ampms) {
<span class="udiff-line-modified-removed">-     CFLocaleRef cflocale = CFLocaleCopyCurrent();</span>
<span class="udiff-line-removed">-     jstring tmp_string;</span>
<span class="udiff-line-removed">-     if (cflocale != NULL) {</span>
<span class="udiff-line-removed">-         CFDateFormatterRef df = CFDateFormatterCreate(kCFAllocatorDefault,</span>
<span class="udiff-line-removed">-                                                   cflocale,</span>
<span class="udiff-line-removed">-                                                   kCFDateFormatterFullStyle,</span>
<span class="udiff-line-removed">-                                                   kCFDateFormatterFullStyle);</span>
<span class="udiff-line-removed">-         if (df != NULL) {</span>
<span class="udiff-line-removed">-             char buf[BUFLEN];</span>
<span class="udiff-line-removed">-             CFStringRef amStr = CFDateFormatterCopyProperty(df, kCFDateFormatterAMSymbol);</span>
<span class="udiff-line-removed">-             if (amStr != NULL) {</span>
<span class="udiff-line-removed">-                 CFStringGetCString(amStr, buf, BUFLEN, kCFStringEncodingUTF8);</span>
<span class="udiff-line-removed">-                 CFRelease(amStr);</span>
<span class="udiff-line-removed">-                 tmp_string = (*env)-&gt;NewStringUTF(env, buf);</span>
<span class="udiff-line-removed">-                 if (tmp_string != NULL) {</span>
<span class="udiff-line-removed">-                     (*env)-&gt;SetObjectArrayElement(env, ampms, 0, tmp_string);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (!(*env)-&gt;ExceptionCheck(env)){</span>
<span class="udiff-line-removed">-                 CFStringRef pmStr = CFDateFormatterCopyProperty(df, kCFDateFormatterPMSymbol);</span>
<span class="udiff-line-removed">-                 if (pmStr != NULL) {</span>
<span class="udiff-line-removed">-                     CFStringGetCString(pmStr, buf, BUFLEN, kCFStringEncodingUTF8);</span>
<span class="udiff-line-removed">-                     CFRelease(pmStr);</span>
<span class="udiff-line-removed">-                     tmp_string = (*env)-&gt;NewStringUTF(env, buf);</span>
<span class="udiff-line-removed">-                     if (tmp_string != NULL) {</span>
<span class="udiff-line-removed">-                         (*env)-&gt;SetObjectArrayElement(env, ampms, 1, tmp_string);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             CFRelease(df);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         CFRelease(cflocale);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return ampms;</span>
<span class="udiff-line-modified-added">+       return getAmPmImpl(env, cls, jlangtag, 0, ampms);</span>
  }
  
  /*
   * Class:     sun_util_locale_provider_HostLocaleProviderAdapterImpl
   * Method:    getEras
   * Signature: (Ljava/lang/String;[Ljava/lang/String;)[Ljava/lang/String;
   */
  JNIEXPORT jobjectArray JNICALL Java_sun_util_locale_provider_HostLocaleProviderAdapterImpl_getEras
    (JNIEnv *env, jclass cls, jstring jlangtag, jobjectArray eras) {
<span class="udiff-line-modified-removed">-     CFLocaleRef cflocale = CFLocaleCopyCurrent();</span>
<span class="udiff-line-removed">-     if (cflocale != NULL) {</span>
<span class="udiff-line-removed">-         CFDateFormatterRef df = CFDateFormatterCreate(kCFAllocatorDefault,</span>
<span class="udiff-line-removed">-                                                   cflocale,</span>
<span class="udiff-line-removed">-                                                   kCFDateFormatterFullStyle,</span>
<span class="udiff-line-removed">-                                                   kCFDateFormatterFullStyle);</span>
<span class="udiff-line-removed">-         if (df != NULL) {</span>
<span class="udiff-line-removed">-             CFArrayRef cferas = CFDateFormatterCopyProperty(df, kCFDateFormatterEraSymbols);</span>
<span class="udiff-line-removed">-             if (cferas != NULL) {</span>
<span class="udiff-line-removed">-                 copyArrayElements(env, cferas, eras, 0, 0, CFArrayGetCount(cferas));</span>
<span class="udiff-line-removed">-                 CFRelease(cferas);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             CFRelease(df);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         CFRelease(cflocale);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return eras;</span>
<span class="udiff-line-modified-added">+     return getErasImpl(env, jlangtag, 0, eras);</span>
  }
  
  /*
   * Class:     sun_util_locale_provider_HostLocaleProviderAdapterImpl
   * Method:    getMonths
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -253,29 +211,12 @@</span>
   * Class:     sun_util_locale_provider_HostLocaleProviderAdapterImpl
   * Method:    getWeekdays
   * Signature: (Ljava/lang/String;[Ljava/lang/String;)[Ljava/lang/String;
   */
  JNIEXPORT jobjectArray JNICALL Java_sun_util_locale_provider_HostLocaleProviderAdapterImpl_getWeekdays
<span class="udiff-line-modified-removed">-   (JNIEnv *env, jclass cls, jstring jlangtag, jobjectArray wdays) {</span>
<span class="udiff-line-modified-removed">-     CFLocaleRef cflocale = CFLocaleCopyCurrent();</span>
<span class="udiff-line-removed">-     if (cflocale != NULL) {</span>
<span class="udiff-line-removed">-         CFDateFormatterRef df = CFDateFormatterCreate(kCFAllocatorDefault,</span>
<span class="udiff-line-removed">-                                                   cflocale,</span>
<span class="udiff-line-removed">-                                                   kCFDateFormatterFullStyle,</span>
<span class="udiff-line-removed">-                                                   kCFDateFormatterFullStyle);</span>
<span class="udiff-line-removed">-         if (df != NULL) {</span>
<span class="udiff-line-removed">-             CFArrayRef cfwdays = CFDateFormatterCopyProperty(df, kCFDateFormatterWeekdaySymbols);</span>
<span class="udiff-line-removed">-             if (cfwdays != NULL) {</span>
<span class="udiff-line-removed">-                 copyArrayElements(env, cfwdays, wdays, 0, 1, CFArrayGetCount(cfwdays));</span>
<span class="udiff-line-removed">-                 CFRelease(cfwdays);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             CFRelease(df);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         CFRelease(cflocale);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return wdays;</span>
<span class="udiff-line-modified-added">+     (JNIEnv *env, jclass cls, jstring jlangtag, jobjectArray wdays) {</span>
<span class="udiff-line-modified-added">+     return getWeekdaysImpl(env, cls, jlangtag, 0, wdays);</span>
  }
  
  /*
   * Class:     sun_util_locale_provider_HostLocaleProviderAdapterImpl
   * Method:    getShortWeekdays
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -504,10 +445,33 @@</span>
      }
  
      return ret;
  }
  
<span class="udiff-line-added">+ /*</span>
<span class="udiff-line-added">+  * Class:     sun_util_locale_provider_HostLocaleProviderAdapterImpl</span>
<span class="udiff-line-added">+  * Method:    getCalendarDisplayStrings</span>
<span class="udiff-line-added">+  * Signature: (Ljava/lang/String;III)[Ljava/lang/String;</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ JNIEXPORT jobjectArray JNICALL Java_sun_util_locale_provider_HostLocaleProviderAdapterImpl_getCalendarDisplayStrings</span>
<span class="udiff-line-added">+   (JNIEnv *env, jclass cls, jstring jlangtag, jint field, jint style) {</span>
<span class="udiff-line-added">+     switch (field) {</span>
<span class="udiff-line-added">+     case CALENDAR_FIELD_ERA:</span>
<span class="udiff-line-added">+         return getErasImpl(env, jlangtag, style, NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     case CALENDAR_FIELD_DAY_OF_WEEK:</span>
<span class="udiff-line-added">+         return getWeekdaysImpl(env, cls, jlangtag, style, NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     case CALENDAR_FIELD_AM_PM:</span>
<span class="udiff-line-added">+         return getAmPmImpl(env, cls, jlangtag, style, NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     default:</span>
<span class="udiff-line-added">+         // not supported</span>
<span class="udiff-line-added">+         return NULL;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  /*
   * Class:     sun_util_locale_provider_HostLocaleProviderAdapterImpl
   * Method:    getDisplayString
   * Signature: (Ljava/lang/String;ILjava/lang/String;)Ljava/lang/String;
   */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -723,5 +687,106 @@</span>
          CFRelease(cflocale);
      }
  
      return ret;
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ jobjectArray getErasImpl(JNIEnv *env, jstring jlangtag, jint style, jobjectArray eras) {</span>
<span class="udiff-line-added">+     jobjectArray ret = eras;</span>
<span class="udiff-line-added">+     CFLocaleRef cflocale = CFLocaleCopyCurrent();</span>
<span class="udiff-line-added">+     if (cflocale != NULL) {</span>
<span class="udiff-line-added">+         CFDateFormatterRef df = CFDateFormatterCreate(kCFAllocatorDefault,</span>
<span class="udiff-line-added">+                                                   cflocale,</span>
<span class="udiff-line-added">+                                                   convertDateFormatterStyle(style),</span>
<span class="udiff-line-added">+                                                   convertDateFormatterStyle(style));</span>
<span class="udiff-line-added">+         if (df != NULL) {</span>
<span class="udiff-line-added">+             CFArrayRef cferas = CFDateFormatterCopyProperty(df, kCFDateFormatterEraSymbols);</span>
<span class="udiff-line-added">+             if (cferas != NULL) {</span>
<span class="udiff-line-added">+                 int eraCount = CFArrayGetCount(cferas);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (eras == NULL) {</span>
<span class="udiff-line-added">+                     ret = (*env)-&gt;NewObjectArray(env, (jsize)eraCount,</span>
<span class="udiff-line-added">+                         (*env)-&gt;FindClass(env, &quot;java/lang/String&quot;), NULL);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 CFTypeRef cal = CFLocaleGetValue(cflocale, kCFLocaleCalendarIdentifier);</span>
<span class="udiff-line-added">+                 int sindex = cal == kCFJapaneseCalendar ? JAPANESE_MEIJI_INDEX : 0;</span>
<span class="udiff-line-added">+                 int dindex = cal == kCFJapaneseCalendar ? 1 : 0; // 0 is &quot;BeforeMeiji&quot; in JCal</span>
<span class="udiff-line-added">+                 copyArrayElements(env, cferas, ret, sindex, dindex, eraCount - sindex);</span>
<span class="udiff-line-added">+                 CFRelease(cferas);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             CFRelease(df);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         CFRelease(cflocale);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return ret;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ jobjectArray getWeekdaysImpl(JNIEnv *env, jclass cls, jstring jlangtag, jint style, jobjectArray wdays) {</span>
<span class="udiff-line-added">+     jobjectArray ret = wdays;</span>
<span class="udiff-line-added">+     CFLocaleRef cflocale = CFLocaleCopyCurrent();</span>
<span class="udiff-line-added">+     if (cflocale != NULL) {</span>
<span class="udiff-line-added">+         CFDateFormatterRef df = CFDateFormatterCreate(kCFAllocatorDefault,</span>
<span class="udiff-line-added">+                                                   cflocale,</span>
<span class="udiff-line-added">+                                                   convertDateFormatterStyle(style),</span>
<span class="udiff-line-added">+                                                   convertDateFormatterStyle(style));</span>
<span class="udiff-line-added">+         if (df != NULL) {</span>
<span class="udiff-line-added">+             CFArrayRef cfwdays = CFDateFormatterCopyProperty(df, kCFDateFormatterWeekdaySymbols);</span>
<span class="udiff-line-added">+             if (cfwdays != NULL) {</span>
<span class="udiff-line-added">+                 int dayCount = CFArrayGetCount(cfwdays);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (wdays == NULL) {</span>
<span class="udiff-line-added">+                     ret = (*env)-&gt;NewObjectArray(env, dayCount + 1,</span>
<span class="udiff-line-added">+                         (*env)-&gt;FindClass(env, &quot;java/lang/String&quot;), NULL);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 copyArrayElements(env, cfwdays, ret, 0, 1, dayCount);</span>
<span class="udiff-line-added">+                 CFRelease(cfwdays);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             CFRelease(df);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         CFRelease(cflocale);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return ret;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ jobjectArray getAmPmImpl(JNIEnv *env, jclass cls, jstring jlangtag, jint style, jobjectArray ampms) {</span>
<span class="udiff-line-added">+     CFLocaleRef cflocale = CFLocaleCopyCurrent();</span>
<span class="udiff-line-added">+     jstring tmp_string;</span>
<span class="udiff-line-added">+     if (cflocale != NULL) {</span>
<span class="udiff-line-added">+         CFDateFormatterRef df = CFDateFormatterCreate(kCFAllocatorDefault,</span>
<span class="udiff-line-added">+                                                   cflocale,</span>
<span class="udiff-line-added">+                                                   convertDateFormatterStyle(style),</span>
<span class="udiff-line-added">+                                                   convertDateFormatterStyle(style));</span>
<span class="udiff-line-added">+         if (df != NULL) {</span>
<span class="udiff-line-added">+             char buf[BUFLEN];</span>
<span class="udiff-line-added">+             if (ampms == NULL) {</span>
<span class="udiff-line-added">+                 ampms = (*env)-&gt;NewObjectArray(env, 2,</span>
<span class="udiff-line-added">+                     (*env)-&gt;FindClass(env, &quot;java/lang/String&quot;), NULL);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             CFStringRef amStr = CFDateFormatterCopyProperty(df, kCFDateFormatterAMSymbol);</span>
<span class="udiff-line-added">+             if (amStr != NULL) {</span>
<span class="udiff-line-added">+                 CFStringGetCString(amStr, buf, BUFLEN, kCFStringEncodingUTF8);</span>
<span class="udiff-line-added">+                 CFRelease(amStr);</span>
<span class="udiff-line-added">+                 tmp_string = (*env)-&gt;NewStringUTF(env, buf);</span>
<span class="udiff-line-added">+                 if (tmp_string != NULL) {</span>
<span class="udiff-line-added">+                     (*env)-&gt;SetObjectArrayElement(env, ampms, 0, tmp_string);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (!(*env)-&gt;ExceptionCheck(env)){</span>
<span class="udiff-line-added">+                 CFStringRef pmStr = CFDateFormatterCopyProperty(df, kCFDateFormatterPMSymbol);</span>
<span class="udiff-line-added">+                 if (pmStr != NULL) {</span>
<span class="udiff-line-added">+                     CFStringGetCString(pmStr, buf, BUFLEN, kCFStringEncodingUTF8);</span>
<span class="udiff-line-added">+                     CFRelease(pmStr);</span>
<span class="udiff-line-added">+                     tmp_string = (*env)-&gt;NewStringUTF(env, buf);</span>
<span class="udiff-line-added">+                     if (tmp_string != NULL) {</span>
<span class="udiff-line-added">+                         (*env)-&gt;SetObjectArrayElement(env, ampms, 1, tmp_string);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             CFRelease(df);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         CFRelease(cflocale);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return ampms;</span>
<span class="udiff-line-added">+ }</span>
</pre>
<center><a href="../../classes/sun/util/locale/provider/HostLocaleProviderAdapterImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="java_props_macosx.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>