<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/macosx/native/libjava/java_props_macosx.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="HostLocaleProviderAdapter_md.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="java_props_macosx.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/macosx/native/libjava/java_props_macosx.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1998, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &lt;sys/socket.h&gt;
 27 #include &lt;netinet/in.h&gt;
 28 #include &lt;arpa/inet.h&gt;
 29 #include &lt;objc/objc-runtime.h&gt;
 30 
<span class="line-removed"> 31 #include &lt;Security/AuthSession.h&gt;</span>
 32 #include &lt;CoreFoundation/CoreFoundation.h&gt;
 33 #include &lt;SystemConfiguration/SystemConfiguration.h&gt;
 34 #include &lt;Foundation/Foundation.h&gt;
 35 
 36 #include &quot;java_props_macosx.h&quot;
 37 
 38 char *getPosixLocale(int cat) {
 39     char *lc = setlocale(cat, NULL);
 40     if ((lc == NULL) || (strcmp(lc, &quot;C&quot;) == 0)) {
 41         lc = getenv(&quot;LANG&quot;);
 42     }
 43     if (lc == NULL) return NULL;
 44     return strdup(lc);
 45 }
 46 
 47 #define LOCALEIDLENGTH  128
 48 #ifndef kCFCoreFoundationVersionNumber10_11_Max
 49 #define kCFCoreFoundationVersionNumber10_11_Max 1299
 50 #endif
 51 char *getMacOSXLocale(int cat) {
</pre>
<hr />
<pre>
 75             }
 76 
 77             CFStringRef primaryLanguage = (CFStringRef)CFArrayGetValueAtIndex(languages, 0);
 78             if (primaryLanguage == NULL) {
 79                 CFRelease(languages);
 80                 return NULL;
 81             }
 82             if (CFStringGetCString(primaryLanguage, languageString,
 83                                    LOCALEIDLENGTH, CFStringGetSystemEncoding()) == false) {
 84                 CFRelease(languages);
 85                 return NULL;
 86             }
 87             CFRelease(languages);
 88 
 89             // Explicitly supply region, if there is none
 90             char *hyphenPos = strchr(languageString, &#39;-&#39;);
 91             int langStrLen = strlen(languageString);
 92 
 93             if (hyphenPos == NULL || // languageString contains ISO639 only, e.g., &quot;en&quot;
 94                 languageString + langStrLen - hyphenPos == 5) { // ISO639-ScriptCode, e.g., &quot;en-Latn&quot;
<span class="line-modified"> 95                 CFStringGetCString(CFLocaleGetIdentifier(CFLocaleCopyCurrent()),</span>
<span class="line-modified"> 96                                localeString, LOCALEIDLENGTH, CFStringGetSystemEncoding());</span>
<span class="line-modified"> 97                 char *underscorePos = strrchr(localeString, &#39;_&#39;);</span>
<span class="line-modified"> 98                 char *region = NULL;</span>
<span class="line-modified"> 99 </span>
<span class="line-modified">100                 if (underscorePos != NULL) {</span>
<span class="line-modified">101                     region = underscorePos + 1;</span>
<span class="line-modified">102                 }</span>
<span class="line-modified">103 </span>
<span class="line-modified">104                 if (region != NULL) {</span>
<span class="line-modified">105                     strcat(languageString, &quot;-&quot;);</span>
<span class="line-modified">106                     strcat(languageString, region);</span>




107                 }
108             }
109 
110             retVal = languageString;
111         }
112         break;
113 
114     default:
115         {
<span class="line-modified">116             if (!CFStringGetCString(CFLocaleGetIdentifier(CFLocaleCopyCurrent()),</span>
<span class="line-modified">117                                     localeString, LOCALEIDLENGTH, CFStringGetSystemEncoding())) {</span>









118                 return NULL;
119             }
<span class="line-removed">120 </span>
<span class="line-removed">121             retVal = localeString;</span>
122         }
123         break;
124     }
125 
126     if (retVal != NULL) {
127         // convertToPOSIXLocale() does not expect any variant codes, so ignore
128         // &#39;@&#39; and anything following, if present.
129         char* rmAt = strchr(retVal, &#39;@&#39;);
130         if (rmAt != NULL) {
131             *rmAt = &#39;\0&#39;;
132         }
133         return strdup(convertToPOSIXLocale(retVal));
134     }
135 
136     return NULL;
137 }
138 
139 /* Language IDs use the language designators and (optional) region
140  * and script designators of BCP 47.  So possible formats are:
141  *
</pre>
<hr />
<pre>
195                 isdigit(scriptRegion[1]) &amp;&amp;
196                 isdigit(scriptRegion[2]) &amp;&amp;
197                 isdigit(scriptRegion[3])) ||
198             // &#39;@&#39; followed by a 4 character script code (already validated above)
199                 (length == 5));
200     }
201 
202     return src;
203 }
204 
205 char *setupMacOSXLocale(int cat) {
206     char * ret = getMacOSXLocale(cat);
207 
208     if (ret == NULL) {
209         return getPosixLocale(cat);
210     } else {
211         return ret;
212     }
213 }
214 
<span class="line-removed">215 int isInAquaSession() {</span>
<span class="line-removed">216     // environment variable to bypass the aqua session check</span>
<span class="line-removed">217     char *ev = getenv(&quot;AWT_FORCE_HEADFUL&quot;);</span>
<span class="line-removed">218     if (ev &amp;&amp; (strncasecmp(ev, &quot;true&quot;, 4) == 0)) {</span>
<span class="line-removed">219         // if &quot;true&quot; then tell the caller we&#39;re in an Aqua session without actually checking</span>
<span class="line-removed">220         return 1;</span>
<span class="line-removed">221     }</span>
<span class="line-removed">222     // Is the WindowServer available?</span>
<span class="line-removed">223     SecuritySessionId session_id;</span>
<span class="line-removed">224     SessionAttributeBits session_info;</span>
<span class="line-removed">225     OSStatus status = SessionGetInfo(callerSecuritySession, &amp;session_id, &amp;session_info);</span>
<span class="line-removed">226     if (status == noErr) {</span>
<span class="line-removed">227         if (session_info &amp; sessionHasGraphicAccess) {</span>
<span class="line-removed">228             return 1;</span>
<span class="line-removed">229         }</span>
<span class="line-removed">230     }</span>
<span class="line-removed">231     return 0;</span>
<span class="line-removed">232 }</span>
<span class="line-removed">233 </span>
234 // 10.9 SDK does not include the NSOperatingSystemVersion struct.
235 // For now, create our own
236 typedef struct {
237         NSInteger majorVersion;
238         NSInteger minorVersion;
239         NSInteger patchVersion;
240 } OSVerStruct;
241 
242 void setOSNameAndVersion(java_props_t *sprops) {
243     // Hardcode os_name, and fill in os_version
244     sprops-&gt;os_name = strdup(&quot;Mac OS X&quot;);
245 
246     char* osVersionCStr = NULL;
247     // Mac OS 10.9 includes the [NSProcessInfo operatingSystemVersion] function,
248     // but it&#39;s not in the 10.9 SDK.  So, call it via objc_msgSend_stret.
249     if ([[NSProcessInfo processInfo] respondsToSelector:@selector(operatingSystemVersion)]) {
250         OSVerStruct (*procInfoFn)(id rec, SEL sel) = (OSVerStruct(*)(id, SEL))objc_msgSend_stret;
251         OSVerStruct osVer = procInfoFn([NSProcessInfo processInfo],
252                                        @selector(operatingSystemVersion));
253         NSString *nsVerStr;
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &lt;sys/socket.h&gt;
 27 #include &lt;netinet/in.h&gt;
 28 #include &lt;arpa/inet.h&gt;
 29 #include &lt;objc/objc-runtime.h&gt;
 30 

 31 #include &lt;CoreFoundation/CoreFoundation.h&gt;
 32 #include &lt;SystemConfiguration/SystemConfiguration.h&gt;
 33 #include &lt;Foundation/Foundation.h&gt;
 34 
 35 #include &quot;java_props_macosx.h&quot;
 36 
 37 char *getPosixLocale(int cat) {
 38     char *lc = setlocale(cat, NULL);
 39     if ((lc == NULL) || (strcmp(lc, &quot;C&quot;) == 0)) {
 40         lc = getenv(&quot;LANG&quot;);
 41     }
 42     if (lc == NULL) return NULL;
 43     return strdup(lc);
 44 }
 45 
 46 #define LOCALEIDLENGTH  128
 47 #ifndef kCFCoreFoundationVersionNumber10_11_Max
 48 #define kCFCoreFoundationVersionNumber10_11_Max 1299
 49 #endif
 50 char *getMacOSXLocale(int cat) {
</pre>
<hr />
<pre>
 74             }
 75 
 76             CFStringRef primaryLanguage = (CFStringRef)CFArrayGetValueAtIndex(languages, 0);
 77             if (primaryLanguage == NULL) {
 78                 CFRelease(languages);
 79                 return NULL;
 80             }
 81             if (CFStringGetCString(primaryLanguage, languageString,
 82                                    LOCALEIDLENGTH, CFStringGetSystemEncoding()) == false) {
 83                 CFRelease(languages);
 84                 return NULL;
 85             }
 86             CFRelease(languages);
 87 
 88             // Explicitly supply region, if there is none
 89             char *hyphenPos = strchr(languageString, &#39;-&#39;);
 90             int langStrLen = strlen(languageString);
 91 
 92             if (hyphenPos == NULL || // languageString contains ISO639 only, e.g., &quot;en&quot;
 93                 languageString + langStrLen - hyphenPos == 5) { // ISO639-ScriptCode, e.g., &quot;en-Latn&quot;
<span class="line-modified"> 94                 CFLocaleRef cflocale = CFLocaleCopyCurrent();</span>
<span class="line-modified"> 95                 if (cflocale != NULL) {</span>
<span class="line-modified"> 96                     CFStringGetCString(CFLocaleGetIdentifier(cflocale),</span>
<span class="line-modified"> 97                                    localeString, LOCALEIDLENGTH, CFStringGetSystemEncoding());</span>
<span class="line-modified"> 98                     char *underscorePos = strrchr(localeString, &#39;_&#39;);</span>
<span class="line-modified"> 99                     char *region = NULL;</span>
<span class="line-modified">100 </span>
<span class="line-modified">101                     if (underscorePos != NULL) {</span>
<span class="line-modified">102                         region = underscorePos + 1;</span>
<span class="line-modified">103                     }</span>
<span class="line-modified">104 </span>
<span class="line-modified">105                     if (region != NULL) {</span>
<span class="line-added">106                         strcat(languageString, &quot;-&quot;);</span>
<span class="line-added">107                         strcat(languageString, region);</span>
<span class="line-added">108                     }</span>
<span class="line-added">109                     CFRelease(cflocale);</span>
110                 }
111             }
112 
113             retVal = languageString;
114         }
115         break;
116 
117     default:
118         {
<span class="line-modified">119             CFLocaleRef cflocale = CFLocaleCopyCurrent();</span>
<span class="line-modified">120             if (cflocale != NULL) {</span>
<span class="line-added">121                 if (!CFStringGetCString(CFLocaleGetIdentifier(cflocale),</span>
<span class="line-added">122                                         localeString, LOCALEIDLENGTH, CFStringGetSystemEncoding())) {</span>
<span class="line-added">123                     CFRelease(cflocale);</span>
<span class="line-added">124                     return NULL;</span>
<span class="line-added">125                 }</span>
<span class="line-added">126 </span>
<span class="line-added">127                 retVal = localeString;</span>
<span class="line-added">128                 CFRelease(cflocale);</span>
<span class="line-added">129             } else {</span>
130                 return NULL;
131             }


132         }
133         break;
134     }
135 
136     if (retVal != NULL) {
137         // convertToPOSIXLocale() does not expect any variant codes, so ignore
138         // &#39;@&#39; and anything following, if present.
139         char* rmAt = strchr(retVal, &#39;@&#39;);
140         if (rmAt != NULL) {
141             *rmAt = &#39;\0&#39;;
142         }
143         return strdup(convertToPOSIXLocale(retVal));
144     }
145 
146     return NULL;
147 }
148 
149 /* Language IDs use the language designators and (optional) region
150  * and script designators of BCP 47.  So possible formats are:
151  *
</pre>
<hr />
<pre>
205                 isdigit(scriptRegion[1]) &amp;&amp;
206                 isdigit(scriptRegion[2]) &amp;&amp;
207                 isdigit(scriptRegion[3])) ||
208             // &#39;@&#39; followed by a 4 character script code (already validated above)
209                 (length == 5));
210     }
211 
212     return src;
213 }
214 
215 char *setupMacOSXLocale(int cat) {
216     char * ret = getMacOSXLocale(cat);
217 
218     if (ret == NULL) {
219         return getPosixLocale(cat);
220     } else {
221         return ret;
222     }
223 }
224 



















225 // 10.9 SDK does not include the NSOperatingSystemVersion struct.
226 // For now, create our own
227 typedef struct {
228         NSInteger majorVersion;
229         NSInteger minorVersion;
230         NSInteger patchVersion;
231 } OSVerStruct;
232 
233 void setOSNameAndVersion(java_props_t *sprops) {
234     // Hardcode os_name, and fill in os_version
235     sprops-&gt;os_name = strdup(&quot;Mac OS X&quot;);
236 
237     char* osVersionCStr = NULL;
238     // Mac OS 10.9 includes the [NSProcessInfo operatingSystemVersion] function,
239     // but it&#39;s not in the 10.9 SDK.  So, call it via objc_msgSend_stret.
240     if ([[NSProcessInfo processInfo] respondsToSelector:@selector(operatingSystemVersion)]) {
241         OSVerStruct (*procInfoFn)(id rec, SEL sel) = (OSVerStruct(*)(id, SEL))objc_msgSend_stret;
242         OSVerStruct osVer = procInfoFn([NSProcessInfo processInfo],
243                                        @selector(operatingSystemVersion));
244         NSString *nsVerStr;
</pre>
</td>
</tr>
</table>
<center><a href="HostLocaleProviderAdapter_md.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="java_props_macosx.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>