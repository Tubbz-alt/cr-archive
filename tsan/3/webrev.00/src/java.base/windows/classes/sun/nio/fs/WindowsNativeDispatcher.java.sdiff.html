<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/windows/classes/sun/nio/fs/WindowsNativeDispatcher.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="WindowsFileStore.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../util/locale/provider/HostLocaleProviderAdapterImpl.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/windows/classes/sun/nio/fs/WindowsNativeDispatcher.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2008, 2017, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.nio.fs;
  27 
<span class="line-removed">  28 import java.security.AccessController;</span>
<span class="line-removed">  29 import java.security.PrivilegedAction;</span>
  30 import jdk.internal.misc.Unsafe;
  31 


  32 /**
  33  * Win32 and library calls.
  34  */
  35 
  36 class WindowsNativeDispatcher {
  37     private WindowsNativeDispatcher() { }
  38 
  39     /**
  40      * HANDLE CreateEvent(
  41      *   LPSECURITY_ATTRIBUTES lpEventAttributes,
  42      *   BOOL bManualReset,
  43      *   BOOL bInitialState,
  44      *   PCTSTR lpName
  45      * );
  46      */
  47     static native long CreateEvent(boolean bManualReset, boolean bInitialState)
  48         throws WindowsException;
  49 
  50     /**
  51      * HANDLE CreateFile(
</pre>
<hr />
<pre>
 903 
 904     /**
 905      */
 906     static long LookupPrivilegeValue(String name) throws WindowsException {
 907         NativeBuffer buffer = asNativeBuffer(name);
 908         try {
 909             return LookupPrivilegeValue0(buffer.address());
 910         } finally {
 911             buffer.release();
 912         }
 913     }
 914     private static native long LookupPrivilegeValue0(long lpName)
 915         throws WindowsException;
 916 
 917     /**
 918      * CreateSymbolicLink(
 919      *   LPCWSTR lpSymlinkFileName,
 920      *   LPCWSTR lpTargetFileName,
 921      *   DWORD dwFlags
 922      * )






 923      */
 924     static void CreateSymbolicLink(String link, String target, int flags)
 925         throws WindowsException
 926     {
 927         NativeBuffer linkBuffer = asNativeBuffer(link);
 928         NativeBuffer targetBuffer = asNativeBuffer(target);
 929         try {
 930             CreateSymbolicLink0(linkBuffer.address(), targetBuffer.address(),
 931                                 flags);













 932         } finally {
 933             targetBuffer.release();
 934             linkBuffer.release();
 935         }
 936     }
 937     private static native void CreateSymbolicLink0(long linkAddress,
 938         long targetAddress, int flags) throws WindowsException;
 939 
 940     /**
 941      * CreateHardLink(
 942      *    LPCTSTR lpFileName,
 943      *    LPCTSTR lpExistingFileName,
 944      *    LPSECURITY_ATTRIBUTES lpSecurityAttributes
 945      * )
 946      */
 947     static void CreateHardLink(String newFile, String existingFile)
 948         throws WindowsException
 949     {
 950         NativeBuffer newFileBuffer = asNativeBuffer(newFile);
 951         NativeBuffer existingFileBuffer = asNativeBuffer(existingFile);
</pre>
<hr />
<pre>
1115         } else {
1116             // buffer already contains the string contents
1117             if (buffer.owner() == s)
1118                 return buffer;
1119         }
1120 
1121         // copy into buffer and zero terminate
1122         char[] chars = s.toCharArray();
1123         unsafe.copyMemory(chars, Unsafe.ARRAY_CHAR_BASE_OFFSET, null,
1124             buffer.address(), (long)stringLengthInBytes);
1125         unsafe.putChar(buffer.address() + stringLengthInBytes, (char)0);
1126         buffer.setOwner(s);
1127         return buffer;
1128     }
1129 
1130     // -- native library initialization --
1131 
1132     private static native void initIDs();
1133 
1134     static {
<span class="line-modified">1135         AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span>
<span class="line-modified">1136             public Void run() {</span>
<span class="line-modified">1137                 // nio.dll has dependency on net.dll</span>
<span class="line-removed">1138                 System.loadLibrary(&quot;net&quot;);</span>
<span class="line-removed">1139                 System.loadLibrary(&quot;nio&quot;);</span>
<span class="line-removed">1140                 return null;</span>
<span class="line-removed">1141         }});</span>
1142         initIDs();
1143     }
1144 
1145 }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2008, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package sun.nio.fs;
  27 


  28 import jdk.internal.misc.Unsafe;
  29 
<span class="line-added">  30 import static sun.nio.fs.WindowsConstants.*;</span>
<span class="line-added">  31 </span>
  32 /**
  33  * Win32 and library calls.
  34  */
  35 
  36 class WindowsNativeDispatcher {
  37     private WindowsNativeDispatcher() { }
  38 
  39     /**
  40      * HANDLE CreateEvent(
  41      *   LPSECURITY_ATTRIBUTES lpEventAttributes,
  42      *   BOOL bManualReset,
  43      *   BOOL bInitialState,
  44      *   PCTSTR lpName
  45      * );
  46      */
  47     static native long CreateEvent(boolean bManualReset, boolean bInitialState)
  48         throws WindowsException;
  49 
  50     /**
  51      * HANDLE CreateFile(
</pre>
<hr />
<pre>
 903 
 904     /**
 905      */
 906     static long LookupPrivilegeValue(String name) throws WindowsException {
 907         NativeBuffer buffer = asNativeBuffer(name);
 908         try {
 909             return LookupPrivilegeValue0(buffer.address());
 910         } finally {
 911             buffer.release();
 912         }
 913     }
 914     private static native long LookupPrivilegeValue0(long lpName)
 915         throws WindowsException;
 916 
 917     /**
 918      * CreateSymbolicLink(
 919      *   LPCWSTR lpSymlinkFileName,
 920      *   LPCWSTR lpTargetFileName,
 921      *   DWORD dwFlags
 922      * )
<span class="line-added"> 923      *</span>
<span class="line-added"> 924      * Creates a symbolic link, conditionally retrying with the addition of</span>
<span class="line-added"> 925      * the flag SYMBOLIC_LINK_FLAG_ALLOW_UNPRIVILEGED_CREATE if the initial</span>
<span class="line-added"> 926      * attempt fails with ERROR_PRIVILEGE_NOT_HELD. If the retry fails, throw</span>
<span class="line-added"> 927      * the original exception due to ERROR_PRIVILEGE_NOT_HELD. The retry will</span>
<span class="line-added"> 928      * succeed only on Windows build 14972 or later if Developer Mode is on.</span>
 929      */
 930     static void CreateSymbolicLink(String link, String target, int flags)
 931         throws WindowsException
 932     {
 933         NativeBuffer linkBuffer = asNativeBuffer(link);
 934         NativeBuffer targetBuffer = asNativeBuffer(target);
 935         try {
 936             CreateSymbolicLink0(linkBuffer.address(), targetBuffer.address(),
 937                                 flags);
<span class="line-added"> 938         } catch (WindowsException x) {</span>
<span class="line-added"> 939             if (x.lastError() == ERROR_PRIVILEGE_NOT_HELD) {</span>
<span class="line-added"> 940                 flags |= SYMBOLIC_LINK_FLAG_ALLOW_UNPRIVILEGED_CREATE;</span>
<span class="line-added"> 941                 try {</span>
<span class="line-added"> 942                     CreateSymbolicLink0(linkBuffer.address(),</span>
<span class="line-added"> 943                                         targetBuffer.address(), flags);</span>
<span class="line-added"> 944                     return;</span>
<span class="line-added"> 945                 } catch (WindowsException ignored) {</span>
<span class="line-added"> 946                     // Will fail with ERROR_INVALID_PARAMETER for Windows</span>
<span class="line-added"> 947                     // builds older than 14972.</span>
<span class="line-added"> 948                 }</span>
<span class="line-added"> 949             }</span>
<span class="line-added"> 950             throw x;</span>
 951         } finally {
 952             targetBuffer.release();
 953             linkBuffer.release();
 954         }
 955     }
 956     private static native void CreateSymbolicLink0(long linkAddress,
 957         long targetAddress, int flags) throws WindowsException;
 958 
 959     /**
 960      * CreateHardLink(
 961      *    LPCTSTR lpFileName,
 962      *    LPCTSTR lpExistingFileName,
 963      *    LPSECURITY_ATTRIBUTES lpSecurityAttributes
 964      * )
 965      */
 966     static void CreateHardLink(String newFile, String existingFile)
 967         throws WindowsException
 968     {
 969         NativeBuffer newFileBuffer = asNativeBuffer(newFile);
 970         NativeBuffer existingFileBuffer = asNativeBuffer(existingFile);
</pre>
<hr />
<pre>
1134         } else {
1135             // buffer already contains the string contents
1136             if (buffer.owner() == s)
1137                 return buffer;
1138         }
1139 
1140         // copy into buffer and zero terminate
1141         char[] chars = s.toCharArray();
1142         unsafe.copyMemory(chars, Unsafe.ARRAY_CHAR_BASE_OFFSET, null,
1143             buffer.address(), (long)stringLengthInBytes);
1144         unsafe.putChar(buffer.address() + stringLengthInBytes, (char)0);
1145         buffer.setOwner(s);
1146         return buffer;
1147     }
1148 
1149     // -- native library initialization --
1150 
1151     private static native void initIDs();
1152 
1153     static {
<span class="line-modified">1154         // nio.dll has dependency on net.dll</span>
<span class="line-modified">1155         jdk.internal.loader.BootLoader.loadLibrary(&quot;net&quot;);</span>
<span class="line-modified">1156         jdk.internal.loader.BootLoader.loadLibrary(&quot;nio&quot;);</span>




1157         initIDs();
1158     }
1159 
1160 }
</pre>
</td>
</tr>
</table>
<center><a href="WindowsFileStore.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../util/locale/provider/HostLocaleProviderAdapterImpl.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>