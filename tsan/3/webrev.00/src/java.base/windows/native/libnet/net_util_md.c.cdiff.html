<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/windows/native/libnet/net_util_md.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TwoStacksPlainDatagramSocketImpl.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../libnio/ch/DatagramChannelImpl.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/windows/native/libnet/net_util_md.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 212,10 ***</span>
<span class="line-new-header">--- 212,16 ---</span>
      jclass cls = (*env)-&gt;FindClass(env, &quot;java/io/FileDescriptor&quot;);
      CHECK_NULL_RETURN(cls, NULL);
      return (*env)-&gt;GetFieldID(env, cls, &quot;fd&quot;, &quot;I&quot;);
  }
  
<span class="line-added">+ jint  IPv4_supported()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     /* TODO: properly check for IPv4 support on Windows */</span>
<span class="line-added">+     return JNI_TRUE;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  jint  IPv6_supported()
  {
      SOCKET s = socket(AF_INET6, SOCK_STREAM, 0) ;
      if (s == INVALID_SOCKET) {
          return JNI_FALSE;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 744,41 ***</span>
          CLOSE_SOCKETS_AND_RETURN;
      }
      return 0;
  }
  
<span class="line-removed">- /*</span>
<span class="line-removed">-  * Determine the default interface for an IPv6 address.</span>
<span class="line-removed">-  *</span>
<span class="line-removed">-  * Returns :-</span>
<span class="line-removed">-  *      0 if error</span>
<span class="line-removed">-  *      &gt; 0 interface index to use</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- jint getDefaultIPv6Interface(JNIEnv *env, struct sockaddr_in6 *target_addr)</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     int ret;</span>
<span class="line-removed">-     DWORD b;</span>
<span class="line-removed">-     struct sockaddr_in6 route;</span>
<span class="line-removed">-     SOCKET fd = socket(AF_INET6, SOCK_STREAM, 0);</span>
<span class="line-removed">-     if (fd == INVALID_SOCKET) {</span>
<span class="line-removed">-         return 0;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     ret = WSAIoctl(fd, SIO_ROUTING_INTERFACE_QUERY,</span>
<span class="line-removed">-                    (void *)target_addr, sizeof(struct sockaddr_in6),</span>
<span class="line-removed">-                    (void *)&amp;route, sizeof(struct sockaddr_in6),</span>
<span class="line-removed">-                    &amp;b, 0, 0);</span>
<span class="line-removed">-     if (ret == SOCKET_ERROR) {</span>
<span class="line-removed">-         // error</span>
<span class="line-removed">-         closesocket(fd);</span>
<span class="line-removed">-         return 0;</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         closesocket(fd);</span>
<span class="line-removed">-         return route.sin6_scope_id;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  /**
   * Enables SIO_LOOPBACK_FAST_PATH
   */
  JNIEXPORT jint JNICALL
  NET_EnableFastTcpLoopback(int fd) {
<span class="line-new-header">--- 750,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 812,11 ***</span>
          !(family == java_net_InetAddress_IPv4 &amp;&amp;
            v4MappedAddress == JNI_FALSE))
      {
          jbyte caddr[16];
          jint address;
<span class="line-modified">!         unsigned int scopeid = 0, cached_scope_id = 0;</span>
  
          if (family == java_net_InetAddress_IPv4) {
              // convert to IPv4-mapped address
              memset((char *)caddr, 0, 16);
              address = getInetAddress_addr(env, iaObj);
<span class="line-new-header">--- 787,11 ---</span>
          !(family == java_net_InetAddress_IPv4 &amp;&amp;
            v4MappedAddress == JNI_FALSE))
      {
          jbyte caddr[16];
          jint address;
<span class="line-modified">!         unsigned int scopeid = 0;</span>
  
          if (family == java_net_InetAddress_IPv4) {
              // convert to IPv4-mapped address
              memset((char *)caddr, 0, 16);
              address = getInetAddress_addr(env, iaObj);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 834,23 ***</span>
                  caddr[15] = (address &amp; 0xff);
              }
          } else {
              getInet6Address_ipaddress(env, iaObj, (char *)caddr);
              scopeid = getInet6Address_scopeid(env, iaObj);
<span class="line-removed">-             cached_scope_id = (unsigned int)(*env)-&gt;GetIntField(env, iaObj, ia6_cachedscopeidID);</span>
          }
          sa-&gt;sa6.sin6_port = (u_short)htons((u_short)port);
          memcpy((void *)&amp;sa-&gt;sa6.sin6_addr, caddr, sizeof(struct in6_addr));
          sa-&gt;sa6.sin6_family = AF_INET6;
<span class="line-modified">!         if ((family == java_net_InetAddress_IPv6) &amp;&amp;</span>
<span class="line-removed">-             IN6_IS_ADDR_LINKLOCAL(&amp;sa-&gt;sa6.sin6_addr) &amp;&amp;</span>
<span class="line-removed">-             (!scopeid &amp;&amp; !cached_scope_id))</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-             cached_scope_id = getDefaultIPv6Interface(env, &amp;sa-&gt;sa6);</span>
<span class="line-removed">-             (*env)-&gt;SetIntField(env, iaObj, ia6_cachedscopeidID, cached_scope_id);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         sa-&gt;sa6.sin6_scope_id = scopeid == 0 ? cached_scope_id : scopeid;</span>
          if (len != NULL) {
              *len = sizeof(struct sockaddr_in6);
          }
      } else {
          jint address;
<span class="line-new-header">--- 809,15 ---</span>
                  caddr[15] = (address &amp; 0xff);
              }
          } else {
              getInet6Address_ipaddress(env, iaObj, (char *)caddr);
              scopeid = getInet6Address_scopeid(env, iaObj);
          }
          sa-&gt;sa6.sin6_port = (u_short)htons((u_short)port);
          memcpy((void *)&amp;sa-&gt;sa6.sin6_addr, caddr, sizeof(struct in6_addr));
          sa-&gt;sa6.sin6_family = AF_INET6;
<span class="line-modified">!         sa-&gt;sa6.sin6_scope_id = scopeid;</span>
          if (len != NULL) {
              *len = sizeof(struct sockaddr_in6);
          }
      } else {
          jint address;
</pre>
<center><a href="TwoStacksPlainDatagramSocketImpl.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../libnio/ch/DatagramChannelImpl.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>