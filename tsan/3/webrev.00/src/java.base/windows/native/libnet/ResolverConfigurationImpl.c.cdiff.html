<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/windows/native/libnet/ResolverConfigurationImpl.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="NetworkInterface_winXP.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TwoStacksPlainDatagramSocketImpl.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/windows/native/libnet/ResolverConfigurationImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2013, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2002, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 22,21 ***</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  #include &lt;stdlib.h&gt;
<span class="line-removed">- #include &lt;windows.h&gt;</span>
  #include &lt;stdio.h&gt;
  #include &lt;stddef.h&gt;
<span class="line-removed">- #include &lt;iprtrmib.h&gt;</span>
  #include &lt;time.h&gt;
  #include &lt;assert.h&gt;
<span class="line-removed">- #include &lt;iphlpapi.h&gt;</span>
  
  #include &quot;jni_util.h&quot;
  
<span class="line-modified">! #define MAX_STR_LEN         256</span>
  
  #define STS_NO_CONFIG       0x0             /* no configuration found */
  #define STS_SL_FOUND        0x1             /* search list found */
  #define STS_NS_FOUND        0x2             /* name servers found */
  #define STS_ERROR           -1              /* error return  lodConfig failed memory allccation failure*/
<span class="line-new-header">--- 22,19 ---</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  
  #include &lt;stdlib.h&gt;
  #include &lt;stdio.h&gt;
  #include &lt;stddef.h&gt;
  #include &lt;time.h&gt;
  #include &lt;assert.h&gt;
  
<span class="line-added">+ #include &quot;net_util.h&quot;</span>
  #include &quot;jni_util.h&quot;
  
<span class="line-modified">! #define MAX_STR_LEN         1024</span>
  
  #define STS_NO_CONFIG       0x0             /* no configuration found */
  #define STS_SL_FOUND        0x1             /* search list found */
  #define STS_NS_FOUND        0x2             /* name servers found */
  #define STS_ERROR           -1              /* error return  lodConfig failed memory allccation failure*/
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,57 ***</span>
  
  /* JNI ids */
  static jfieldID searchlistID;
  static jfieldID nameserversID;
  
  /*
<span class="line-modified">!  * Utility routine to append s2 to s1 with a space delimiter.</span>
<span class="line-modified">!  *  strappend(s1=&quot;abc&quot;, &quot;def&quot;)  =&gt; &quot;abc def&quot;</span>
   *  strappend(s1=&quot;&quot;, &quot;def&quot;)     =&gt; &quot;def
   */
  void strappend(char *s1, char *s2) {
      size_t len;
  
      if (s2[0] == &#39;\0&#39;)                      /* nothing to append */
          return;
  
      len = strlen(s1)+1;
<span class="line-modified">!     if (s1[0] != 0)                         /* needs space character */</span>
          len++;
      if (len + strlen(s2) &gt; MAX_STR_LEN)     /* insufficient space */
          return;
  
      if (s1[0] != 0) {
<span class="line-modified">!         strcat(s1, &quot; &quot;);</span>
      }
      strcat(s1, s2);
  }
  
  /*
<span class="line-modified">!  * Windows 2000/XP</span>
<span class="line-modified">!  *</span>
<span class="line-removed">-  * Use registry approach based on settings described in Appendix C</span>
<span class="line-removed">-  * of &quot;Microsoft Windows 2000 TCP/IP Implementation Details&quot;.</span>
<span class="line-removed">-  *</span>
<span class="line-removed">-  * DNS suffix list is obtained from SearchList registry setting. If</span>
<span class="line-removed">-  * this is not specified we compile suffix list based on the</span>
<span class="line-removed">-  * per-connection domain suffix.</span>
<span class="line-removed">-  *</span>
<span class="line-removed">-  * DNS name servers and domain settings are on a per-connection</span>
<span class="line-removed">-  * basic. We therefore enumerate the network adapters to get the</span>
<span class="line-removed">-  * names of each adapter and then query the corresponding registry</span>
<span class="line-removed">-  * settings to obtain NameServer/DhcpNameServer and Domain/DhcpDomain.</span>
   */
<span class="line-modified">! static int loadConfig(char *sl, char *ns) {</span>
<span class="line-modified">!     IP_ADAPTER_INFO *adapterP;</span>
<span class="line-modified">!     ULONG size;</span>
<span class="line-modified">!     DWORD ret;</span>
      DWORD dwLen;
      ULONG ulType;
      char result[MAX_STR_LEN];
      HANDLE hKey;
<span class="line-modified">!     int gotSearchList = 0;</span>
  
      /*
       * First see if there is a global suffix list specified.
       */
      ret = RegOpenKeyEx(HKEY_LOCAL_MACHINE,
<span class="line-new-header">--- 44,50 ---</span>
  
  /* JNI ids */
  static jfieldID searchlistID;
  static jfieldID nameserversID;
  
<span class="line-added">+ extern int getAdapters(JNIEnv *env, int flags, IP_ADAPTER_ADDRESSES **adapters);</span>
<span class="line-added">+ </span>
  /*
<span class="line-modified">!  * Utility routine to append s2 to s1 with a comma delimiter.</span>
<span class="line-modified">!  *  strappend(s1=&quot;abc&quot;, &quot;def&quot;)  =&gt; &quot;abc,def&quot;</span>
   *  strappend(s1=&quot;&quot;, &quot;def&quot;)     =&gt; &quot;def
   */
  void strappend(char *s1, char *s2) {
      size_t len;
  
      if (s2[0] == &#39;\0&#39;)                      /* nothing to append */
          return;
  
      len = strlen(s1)+1;
<span class="line-modified">!     if (s1[0] != 0)                         /* needs comma character */</span>
          len++;
      if (len + strlen(s2) &gt; MAX_STR_LEN)     /* insufficient space */
          return;
  
      if (s1[0] != 0) {
<span class="line-modified">!         strcat(s1, &quot;,&quot;);</span>
      }
      strcat(s1, s2);
  }
  
  /*
<span class="line-modified">!  * Use DNS server addresses returned by GetAdaptersAddresses for currently</span>
<span class="line-modified">!  * active interfaces.</span>
   */
<span class="line-modified">! static int loadConfig(JNIEnv *env, char *sl, char *ns) {</span>
<span class="line-modified">!     IP_ADAPTER_ADDRESSES *adapters, *adapter;</span>
<span class="line-modified">!     IP_ADAPTER_DNS_SERVER_ADDRESS *dnsServer;</span>
<span class="line-modified">!     WCHAR *suffix;</span>
<span class="line-added">+     DWORD ret, flags;</span>
      DWORD dwLen;
      ULONG ulType;
      char result[MAX_STR_LEN];
      HANDLE hKey;
<span class="line-modified">!     SOCKADDR *sockAddr;</span>
<span class="line-added">+     struct sockaddr_in6 *sockAddrIpv6;</span>
  
      /*
       * First see if there is a global suffix list specified.
       */
      ret = RegOpenKeyEx(HKEY_LOCAL_MACHINE,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 110,132 ***</span>
                               (LPBYTE)&amp;result, &amp;dwLen);
          if (ret == ERROR_SUCCESS) {
              assert(ulType == REG_SZ);
              if (strlen(result) &gt; 0) {
                  strappend(sl, result);
<span class="line-removed">-                 gotSearchList = 1;</span>
              }
          }
          RegCloseKey(hKey);
      }
  
<span class="line-removed">-     /*</span>
<span class="line-removed">-      * Ask the IP Helper library to enumerate the adapters</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     size = sizeof(IP_ADAPTER_INFO);</span>
<span class="line-removed">-     adapterP = (IP_ADAPTER_INFO *)malloc(size);</span>
<span class="line-removed">-     if (adapterP == NULL) {</span>
<span class="line-removed">-         return STS_ERROR;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">-     ret = GetAdaptersInfo(adapterP, &amp;size);</span>
<span class="line-removed">-     if (ret == ERROR_BUFFER_OVERFLOW) {</span>
<span class="line-removed">-         IP_ADAPTER_INFO *newAdapterP = (IP_ADAPTER_INFO *)realloc(adapterP, size);</span>
<span class="line-removed">-         if (newAdapterP == NULL) {</span>
<span class="line-removed">-             free(adapterP);</span>
<span class="line-removed">-             return STS_ERROR;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         adapterP = newAdapterP;</span>
  
<span class="line-modified">!         ret = GetAdaptersInfo(adapterP, &amp;size);</span>
      }
  
<span class="line-modified">!     /*</span>
<span class="line-modified">!      * Iterate through the list of adapters as registry settings are</span>
<span class="line-modified">!      * keyed on the adapter name (GUID).</span>
<span class="line-modified">!      */</span>
<span class="line-modified">!     if (ret == ERROR_SUCCESS) {</span>
<span class="line-modified">!         IP_ADAPTER_INFO *curr = adapterP;</span>
<span class="line-modified">!         while (curr != NULL) {</span>
<span class="line-modified">!             char key[MAX_STR_LEN];</span>
<span class="line-modified">! </span>
<span class="line-modified">!             sprintf(key,</span>
<span class="line-modified">!                 &quot;SYSTEM\\CurrentControlSet\\Services\\Tcpip\\Parameters\\Interfaces\\%s&quot;,</span>
<span class="line-modified">!                 curr-&gt;AdapterName);</span>
<span class="line-modified">! </span>
<span class="line-modified">!             ret = RegOpenKeyEx(HKEY_LOCAL_MACHINE,</span>
<span class="line-modified">!                                key,</span>
<span class="line-removed">-                                0,</span>
<span class="line-removed">-                                KEY_READ,</span>
<span class="line-removed">-                                (PHKEY)&amp;hKey);</span>
<span class="line-removed">-             if (ret == ERROR_SUCCESS) {</span>
<span class="line-removed">-                 DWORD enableDhcp = 0;</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 /*</span>
<span class="line-removed">-                  * Is DHCP enabled on this interface</span>
<span class="line-removed">-                  */</span>
<span class="line-removed">-                 dwLen = sizeof(enableDhcp);</span>
<span class="line-removed">-                 ret = RegQueryValueEx(hKey, &quot;EnableDhcp&quot;, NULL, &amp;ulType,</span>
<span class="line-removed">-                                      (LPBYTE)&amp;enableDhcp, &amp;dwLen);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 /*</span>
<span class="line-removed">-                  * If we don&#39;t have the suffix list when get the Domain</span>
<span class="line-removed">-                  * or DhcpDomain. If DHCP is enabled then Domain overides</span>
<span class="line-removed">-                  * DhcpDomain</span>
<span class="line-removed">-                  */</span>
<span class="line-removed">-                 if (!gotSearchList) {</span>
<span class="line-removed">-                     result[0] = &#39;\0&#39;;</span>
<span class="line-removed">-                     dwLen = sizeof(result);</span>
<span class="line-removed">-                     ret = RegQueryValueEx(hKey, &quot;Domain&quot;, NULL, &amp;ulType,</span>
<span class="line-removed">-                                          (LPBYTE)&amp;result, &amp;dwLen);</span>
<span class="line-removed">-                     if (((ret != ERROR_SUCCESS) || (strlen(result) == 0)) &amp;&amp;</span>
<span class="line-removed">-                         enableDhcp) {</span>
<span class="line-removed">-                         dwLen = sizeof(result);</span>
<span class="line-removed">-                         ret = RegQueryValueEx(hKey, &quot;DhcpDomain&quot;, NULL, &amp;ulType,</span>
<span class="line-removed">-                                               (LPBYTE)&amp;result, &amp;dwLen);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     if (ret == ERROR_SUCCESS) {</span>
<span class="line-removed">-                         assert(ulType == REG_SZ);</span>
<span class="line-removed">-                         strappend(sl, result);</span>
                      }
                  }
  
<span class="line-removed">-                 /*</span>
<span class="line-removed">-                  * Get DNS servers based on NameServer or DhcpNameServer</span>
<span class="line-removed">-                  * registry setting. If NameServer is set then it overrides</span>
<span class="line-removed">-                  * DhcpNameServer (even if DHCP is enabled).</span>
<span class="line-removed">-                  */</span>
<span class="line-removed">-                 result[0] = &#39;\0&#39;;</span>
                  dwLen = sizeof(result);
<span class="line-modified">!                 ret = RegQueryValueEx(hKey, &quot;NameServer&quot;, NULL, &amp;ulType,</span>
<span class="line-modified">!                                      (LPBYTE)&amp;result, &amp;dwLen);</span>
<span class="line-modified">!                 if (((ret != ERROR_SUCCESS) || (strlen(result) == 0)) &amp;&amp;</span>
<span class="line-modified">!                     enableDhcp) {</span>
<span class="line-removed">-                     dwLen = sizeof(result);</span>
<span class="line-removed">-                     ret = RegQueryValueEx(hKey, &quot;DhcpNameServer&quot;, NULL, &amp;ulType,</span>
<span class="line-removed">-                                           (LPBYTE)&amp;result, &amp;dwLen);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 if (ret == ERROR_SUCCESS) {</span>
<span class="line-removed">-                     assert(ulType == REG_SZ);</span>
                      strappend(ns, result);
                  }
  
<span class="line-modified">!                 /*</span>
<span class="line-removed">-                  * Finished with this registry key</span>
<span class="line-removed">-                  */</span>
<span class="line-removed">-                 RegCloseKey(hKey);</span>
              }
  
<span class="line-modified">!             /*</span>
<span class="line-modified">!              * Onto the next adapeter</span>
<span class="line-modified">!              */</span>
<span class="line-modified">!             curr = curr-&gt;Next;</span>
          }
<span class="line-removed">-     }</span>
  
<span class="line-modified">!     /*</span>
<span class="line-removed">-      * Free the adpater structure</span>
<span class="line-removed">-      */</span>
<span class="line-removed">-     if (adapterP) {</span>
<span class="line-removed">-         free(adapterP);</span>
      }
  
      return STS_SL_FOUND &amp; STS_NS_FOUND;
  }
  
  
  /*
<span class="line-modified">!  * Initialize JNI field IDs.</span>
   */
  JNIEXPORT void JNICALL
  Java_sun_net_dns_ResolverConfigurationImpl_init0(JNIEnv *env, jclass cls)
  {
      searchlistID = (*env)-&gt;GetStaticFieldID(env, cls, &quot;os_searchlist&quot;,
<span class="line-new-header">--- 101,78 ---</span>
                               (LPBYTE)&amp;result, &amp;dwLen);
          if (ret == ERROR_SUCCESS) {
              assert(ulType == REG_SZ);
              if (strlen(result) &gt; 0) {
                  strappend(sl, result);
              }
          }
          RegCloseKey(hKey);
      }
  
  
<span class="line-modified">!     // We only need DNS server addresses so skip everything else.</span>
<span class="line-added">+     flags = GAA_FLAG_SKIP_UNICAST;</span>
<span class="line-added">+     flags |= GAA_FLAG_SKIP_ANYCAST;</span>
<span class="line-added">+     flags |= GAA_FLAG_SKIP_MULTICAST;</span>
<span class="line-added">+     flags |= GAA_FLAG_SKIP_FRIENDLY_NAME;</span>
<span class="line-added">+     ret = getAdapters(env, flags, &amp;adapters);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (ret != ERROR_SUCCESS) {</span>
<span class="line-added">+         return STS_ERROR;</span>
      }
  
<span class="line-modified">!     adapter = adapters;</span>
<span class="line-modified">!     while (adapter != NULL) {</span>
<span class="line-modified">!         // Only load config from enabled adapters.</span>
<span class="line-modified">!         if (adapter-&gt;OperStatus == IfOperStatusUp) {</span>
<span class="line-modified">!             dnsServer = adapter-&gt;FirstDnsServerAddress;</span>
<span class="line-modified">!             while (dnsServer != NULL) {</span>
<span class="line-modified">!                 sockAddr = dnsServer-&gt;Address.lpSockaddr;</span>
<span class="line-modified">!                 if (sockAddr-&gt;sa_family == AF_INET6) {</span>
<span class="line-modified">!                     sockAddrIpv6 = (struct sockaddr_in6 *)sockAddr;</span>
<span class="line-modified">!                     if (sockAddrIpv6-&gt;sin6_scope_id != 0) {</span>
<span class="line-modified">!                         // An address with a scope is either link-local or</span>
<span class="line-modified">!                         // site-local, which aren&#39;t valid for DNS queries so</span>
<span class="line-modified">!                         // we can skip them.</span>
<span class="line-modified">!                         dnsServer = dnsServer-&gt;Next;</span>
<span class="line-modified">!                         continue;</span>
                      }
                  }
  
                  dwLen = sizeof(result);
<span class="line-modified">!                 ret = WSAAddressToStringA(sockAddr,</span>
<span class="line-modified">!                           dnsServer-&gt;Address.iSockaddrLength, NULL,</span>
<span class="line-modified">!                           result, &amp;dwLen);</span>
<span class="line-modified">!                 if (ret == 0) {</span>
                      strappend(ns, result);
                  }
  
<span class="line-modified">!                 dnsServer = dnsServer-&gt;Next;</span>
              }
  
<span class="line-modified">!             // Add connection-specific search domains in addition to global one.</span>
<span class="line-modified">!             suffix = adapter-&gt;DnsSuffix;</span>
<span class="line-modified">!             if (suffix != NULL) {</span>
<span class="line-modified">!                 ret = WideCharToMultiByte(CP_UTF8, 0, suffix, -1,</span>
<span class="line-added">+                     result, sizeof(result), NULL, NULL);</span>
<span class="line-added">+                 if (ret != 0) {</span>
<span class="line-added">+                     strappend(sl, result);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
          }
  
<span class="line-modified">!         adapter = adapter-&gt;Next;</span>
      }
  
<span class="line-added">+     free(adapters);</span>
<span class="line-added">+ </span>
      return STS_SL_FOUND &amp; STS_NS_FOUND;
  }
  
  
  /*
<span class="line-modified">!  * Initialize JNI field IDs and classes.</span>
   */
  JNIEXPORT void JNICALL
  Java_sun_net_dns_ResolverConfigurationImpl_init0(JNIEnv *env, jclass cls)
  {
      searchlistID = (*env)-&gt;GetStaticFieldID(env, cls, &quot;os_searchlist&quot;,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 258,11 ***</span>
      jstring obj;
  
      searchlist[0] = &#39;\0&#39;;
      nameservers[0] = &#39;\0&#39;;
  
<span class="line-modified">!     if (loadConfig(searchlist, nameservers) != STS_ERROR) {</span>
  
          /*
           * Populate static fields in sun.net.DefaultResolverConfiguration
           */
          obj = (*env)-&gt;NewStringUTF(env, searchlist);
<span class="line-new-header">--- 195,11 ---</span>
      jstring obj;
  
      searchlist[0] = &#39;\0&#39;;
      nameservers[0] = &#39;\0&#39;;
  
<span class="line-modified">!     if (loadConfig(env, searchlist, nameservers) != STS_ERROR) {</span>
  
          /*
           * Populate static fields in sun.net.DefaultResolverConfiguration
           */
          obj = (*env)-&gt;NewStringUTF(env, searchlist);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 270,12 ***</span>
          (*env)-&gt;SetStaticObjectField(env, cls, searchlistID, obj);
  
          obj = (*env)-&gt;NewStringUTF(env, nameservers);
          CHECK_NULL(obj);
          (*env)-&gt;SetStaticObjectField(env, cls, nameserversID, obj);
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         JNU_ThrowOutOfMemoryError(env, &quot;native memory allocation failed&quot;);</span>
      }
  }
  
  
  /*
<span class="line-new-header">--- 207,10 ---</span>
</pre>
<center><a href="NetworkInterface_winXP.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TwoStacksPlainDatagramSocketImpl.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>