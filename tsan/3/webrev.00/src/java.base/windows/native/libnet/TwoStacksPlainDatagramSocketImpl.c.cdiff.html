<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/windows/native/libnet/TwoStacksPlainDatagramSocketImpl.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="ResolverConfigurationImpl.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="net_util_md.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/windows/native/libnet/TwoStacksPlainDatagramSocketImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 413,15 ***</span>
      WSAIoctl(fd, SIO_UDP_CONNRESET, &amp;t, sizeof(t), &amp;x1, sizeof(x1), &amp;x2, 0, 0);
  }
  
  /*
   * Class:     java_net_TwoStacksPlainDatagramSocketImpl
<span class="line-modified">!  * Method:    send</span>
   * Signature: (Ljava/net/DatagramPacket;)V
   */
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_java_net_TwoStacksPlainDatagramSocketImpl_send</span>
    (JNIEnv *env, jobject this, jobject packet)
  {
      char BUF[MAX_BUFFER_LEN];
      char *fullPacket;
      jobject fdObj;
<span class="line-new-header">--- 413,15 ---</span>
      WSAIoctl(fd, SIO_UDP_CONNRESET, &amp;t, sizeof(t), &amp;x1, sizeof(x1), &amp;x2, 0, 0);
  }
  
  /*
   * Class:     java_net_TwoStacksPlainDatagramSocketImpl
<span class="line-modified">!  * Method:    send0</span>
   * Signature: (Ljava/net/DatagramPacket;)V
   */
  JNIEXPORT void JNICALL
<span class="line-modified">! Java_java_net_TwoStacksPlainDatagramSocketImpl_send0</span>
    (JNIEnv *env, jobject this, jobject packet)
  {
      char BUF[MAX_BUFFER_LEN];
      char *fullPacket;
      jobject fdObj;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1453,11 ***</span>
           * On IPv4 system use IP_MULTICAST_IF socket option
           * On IPv6 system get the NetworkInterface that this IP
           * address is bound to and use the IPV6_MULTICAST_IF
           * option instead of IP_MULTICAST_IF
           */
<span class="line-modified">!         if (ipv6_supported) {</span>
              static jclass ni_class = NULL;
              if (ni_class == NULL) {
                  jclass c = (*env)-&gt;FindClass(env, &quot;java/net/NetworkInterface&quot;);
                  CHECK_NULL(c);
                  ni_class = (*env)-&gt;NewGlobalRef(env, c);
<span class="line-new-header">--- 1453,11 ---</span>
           * On IPv4 system use IP_MULTICAST_IF socket option
           * On IPv6 system get the NetworkInterface that this IP
           * address is bound to and use the IPV6_MULTICAST_IF
           * option instead of IP_MULTICAST_IF
           */
<span class="line-modified">!         if (ipv6_supported &amp;&amp; fd1 &gt;= 0) {</span>
              static jclass ni_class = NULL;
              if (ni_class == NULL) {
                  jclass c = (*env)-&gt;FindClass(env, &quot;java/net/NetworkInterface&quot;);
                  CHECK_NULL(c);
                  ni_class = (*env)-&gt;NewGlobalRef(env, c);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1494,11 ***</span>
           * On IPv6 system get the index of the interface and use the
           * IPV6_MULTICAST_IF socket option
           * On IPv4 system extract addr[0] and use the IP_MULTICAST_IF
           * option. For IPv6 both must be done.
           */
<span class="line-modified">!         if (ipv6_supported) {</span>
              static jfieldID ni_indexID = NULL;
              struct in_addr in;
              int index;
  
              if (ni_indexID == NULL) {
<span class="line-new-header">--- 1494,11 ---</span>
           * On IPv6 system get the index of the interface and use the
           * IPV6_MULTICAST_IF socket option
           * On IPv4 system extract addr[0] and use the IP_MULTICAST_IF
           * option. For IPv6 both must be done.
           */
<span class="line-modified">!         if (ipv6_supported &amp;&amp; fd1 &gt;= 0) {</span>
              static jfieldID ni_indexID = NULL;
              struct in_addr in;
              int index;
  
              if (ni_indexID == NULL) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1506,11 ***</span>
                  CHECK_NULL(c);
                  ni_indexID = (*env)-&gt;GetFieldID(env, c, &quot;index&quot;, &quot;I&quot;);
                  CHECK_NULL(ni_indexID);
              }
              index = (*env)-&gt;GetIntField(env, value, ni_indexID);
<span class="line-removed">- </span>
              if (isAdapterIpv6Enabled(env, index) != 0) {
                  if (setsockopt(fd1, IPPROTO_IPV6, IPV6_MULTICAST_IF,
                                 (const char*)&amp;index, sizeof(index)) &lt; 0) {
                      if (errno == EINVAL &amp;&amp; index &gt; 0) {
                          JNU_ThrowByName(env, JNU_JAVANETPKG &quot;SocketException&quot;,
<span class="line-new-header">--- 1506,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1521,20 ***</span>
                              (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Error setting socket option&quot;);
                      }
                      return;
                  }
              }
<span class="line-modified">!             /* If there are any IPv4 addresses on this interface then</span>
<span class="line-modified">!              * repeat the operation on the IPv4 fd */</span>
  
<span class="line-modified">!             if (getInet4AddrFromIf(env, value, &amp;in) &lt; 0) {</span>
<span class="line-modified">!                 return;</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             if (setsockopt(fd, IPPROTO_IP, IP_MULTICAST_IF,</span>
<span class="line-modified">!                                (const char*)&amp;in, sizeof(in)) &lt; 0) {</span>
<span class="line-modified">!                 JNU_ThrowByNameWithMessageAndLastError</span>
<span class="line-modified">!                     (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Error setting socket option&quot;);</span>
              }
              return;
          } else {
              struct in_addr in;
  
<span class="line-new-header">--- 1520,22 ---</span>
                              (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Error setting socket option&quot;);
                      }
                      return;
                  }
              }
<span class="line-modified">!             if (fd &gt;= 0) {</span>
<span class="line-modified">!                 /* If there are any IPv4 addresses on this interface then</span>
<span class="line-added">+                  * repeat the operation on the IPv4 fd */</span>
  
<span class="line-modified">!                 if (getInet4AddrFromIf(env, value, &amp;in) &lt; 0) {</span>
<span class="line-modified">!                     return;</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 if (setsockopt(fd, IPPROTO_IP, IP_MULTICAST_IF,</span>
<span class="line-modified">!                                    (const char*)&amp;in, sizeof(in)) &lt; 0) {</span>
<span class="line-modified">!                     JNU_ThrowByNameWithMessageAndLastError</span>
<span class="line-modified">!                         (env, JNU_JAVANETPKG &quot;SocketException&quot;, &quot;Error setting socket option&quot;);</span>
<span class="line-added">+                 }</span>
              }
              return;
          } else {
              struct in_addr in;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1689,11 ***</span>
  
          static jclass ni_class; static jmethodID ni_ctrID;
          static jfieldID ni_indexID;
          static jfieldID ni_addrsID;
  
<span class="line-removed">-         jobjectArray addrArray;</span>
          jobject addr;
          jobject ni;
  
          struct in_addr in;
          struct in_addr *inP = &amp;in;
<span class="line-new-header">--- 1690,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1747,23 ***</span>
          }
          ni = Java_java_net_NetworkInterface_getByInetAddress0(env, ni_class, addr);
          if (ni) {
              return ni;
          }
<span class="line-modified">!         if (ipv4Mode) {</span>
<span class="line-removed">-             ni = (*env)-&gt;NewObject(env, ni_class, ni_ctrID, 0);</span>
<span class="line-removed">-             CHECK_NULL_RETURN(ni, NULL);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             (*env)-&gt;SetIntField(env, ni, ni_indexID, -1);</span>
<span class="line-removed">-             addrArray = (*env)-&gt;NewObjectArray(env, 1, inet4_class, NULL);</span>
<span class="line-removed">-             CHECK_NULL_RETURN(addrArray, NULL);</span>
<span class="line-removed">-             (*env)-&gt;SetObjectArrayElement(env, addrArray, 0, addr);</span>
<span class="line-removed">-             (*env)-&gt;SetObjectField(env, ni, ni_addrsID, addrArray);</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             ni = NULL;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return ni;</span>
  }
  
  /*
   * Return the multicast interface:
   *
<span class="line-new-header">--- 1747,11 ---</span>
          }
          ni = Java_java_net_NetworkInterface_getByInetAddress0(env, ni_class, addr);
          if (ni) {
              return ni;
          }
<span class="line-modified">!         return NULL;</span>
  }
  
  /*
   * Return the multicast interface:
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1888,38 ***</span>
                  return NULL;
              }
  
              addr = (*env)-&gt;GetObjectArrayElement(env, addrArray, 0);
              return addr;
<span class="line-modified">!         } else if (index == 0) { // index == 0 typically means IPv6 not configured on the interfaces</span>
              // falling back to treat interface as configured for IPv4
              jobject netObject = NULL;
              netObject = getIPv4NetworkInterface(env, this, fd, opt, 0);
              if (netObject != NULL) {
                  return netObject;
              }
          }
<span class="line-removed">- </span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * Multicast to any address - return anyLocalAddress</span>
<span class="line-removed">-          * or a NetworkInterface with addrs[0] set to anyLocalAddress</span>
<span class="line-removed">-          */</span>
<span class="line-removed">- </span>
<span class="line-removed">-         addr = (*env)-&gt;CallStaticObjectMethod(env, ia_class, ia_anyLocalAddressID,</span>
<span class="line-removed">-                                               NULL);</span>
<span class="line-removed">-         if (opt == java_net_SocketOptions_IP_MULTICAST_IF) {</span>
<span class="line-removed">-             return addr;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ni = (*env)-&gt;NewObject(env, ni_class, ni_ctrID, 0);</span>
<span class="line-removed">-         CHECK_NULL_RETURN(ni, NULL);</span>
<span class="line-removed">-         (*env)-&gt;SetIntField(env, ni, ni_indexID, -1);</span>
<span class="line-removed">-         addrArray = (*env)-&gt;NewObjectArray(env, 1, ia_class, NULL);</span>
<span class="line-removed">-         CHECK_NULL_RETURN(addrArray, NULL);</span>
<span class="line-removed">-         (*env)-&gt;SetObjectArrayElement(env, addrArray, 0, addr);</span>
<span class="line-removed">-         (*env)-&gt;SetObjectField(env, ni, ni_addrsID, addrArray);</span>
<span class="line-removed">-         return ni;</span>
      }
      return NULL;
  }
  
  
<span class="line-new-header">--- 1876,18 ---</span>
                  return NULL;
              }
  
              addr = (*env)-&gt;GetObjectArrayElement(env, addrArray, 0);
              return addr;
<span class="line-modified">!         } else if (index == 0 &amp;&amp; fd &gt;= 0) {</span>
              // falling back to treat interface as configured for IPv4
              jobject netObject = NULL;
              netObject = getIPv4NetworkInterface(env, this, fd, opt, 0);
              if (netObject != NULL) {
                  return netObject;
              }
          }
      }
      return NULL;
  }
  
  
</pre>
<center><a href="ResolverConfigurationImpl.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="net_util_md.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>