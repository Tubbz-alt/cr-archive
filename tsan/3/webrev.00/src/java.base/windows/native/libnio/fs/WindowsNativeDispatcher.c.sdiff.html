<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.base/windows/native/libnio/fs/WindowsNativeDispatcher.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="../ch/nio_util.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../../java.compiler/share/classes/javax/annotation/processing/AbstractProcessor.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/windows/native/libnio/fs/WindowsNativeDispatcher.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2008, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 160     }
 161     return ptr_to_jlong(hEvent);
 162 }
 163 
 164 JNIEXPORT jstring JNICALL
 165 Java_sun_nio_fs_WindowsNativeDispatcher_FormatMessage(JNIEnv* env, jclass this, jint errorCode) {
 166     WCHAR message[255];
 167 
 168     DWORD len = FormatMessageW(FORMAT_MESSAGE_FROM_SYSTEM,
 169                                NULL,
 170                                (DWORD)errorCode,
 171                                0,
 172                                &amp;message[0],
 173                                255,
 174                                NULL);
 175 
 176 
 177     if (len == 0) {
 178         return NULL;
 179     } else {








 180         return (*env)-&gt;NewString(env, (const jchar *)message, (jsize)wcslen(message));
 181     }
 182 }
 183 
 184 JNIEXPORT void JNICALL
 185 Java_sun_nio_fs_WindowsNativeDispatcher_LocalFree(JNIEnv* env, jclass this, jlong address)
 186 {
 187     HLOCAL hMem = (HLOCAL)jlong_to_ptr(address);
 188     LocalFree(hMem);
 189 }
 190 
 191 JNIEXPORT jlong JNICALL
 192 Java_sun_nio_fs_WindowsNativeDispatcher_CreateFile0(JNIEnv* env, jclass this,
 193     jlong address, jint dwDesiredAccess, jint dwShareMode, jlong sdAddress,
 194     jint dwCreationDisposition, jint dwFlagsAndAttributes)
 195 {
 196     HANDLE handle;
 197     LPCWSTR lpFileName = jlong_to_ptr(address);
 198 
 199     SECURITY_ATTRIBUTES securityAttributes;
</pre>
<hr />
<pre>
1046 
1047     if (pLuid == NULL) {
1048         JNU_ThrowInternalError(env, &quot;Unable to allocate LUID structure&quot;);
1049     } else {
1050         if (LookupPrivilegeValueW(NULL, lpName, pLuid) == 0) {
1051             LocalFree(pLuid);
1052             throwWindowsException(env, GetLastError());
1053             return (jlong)0;
1054         }
1055     }
1056     return ptr_to_jlong(pLuid);
1057 }
1058 
1059 JNIEXPORT void JNICALL
1060 Java_sun_nio_fs_WindowsNativeDispatcher_CreateSymbolicLink0(JNIEnv* env,
1061     jclass this, jlong linkAddress, jlong targetAddress, jint flags)
1062 {
1063     LPCWSTR link = jlong_to_ptr(linkAddress);
1064     LPCWSTR target = jlong_to_ptr(targetAddress);
1065 
<span class="line-removed">1066     /* On Windows 64-bit this appears to succeed even when there is insufficient privileges */</span>
1067     if (CreateSymbolicLinkW(link, target, (DWORD)flags) == 0)
1068         throwWindowsException(env, GetLastError());
1069 }
1070 
1071 JNIEXPORT void JNICALL
1072 Java_sun_nio_fs_WindowsNativeDispatcher_CreateHardLink0(JNIEnv* env,
1073     jclass this, jlong newFileAddress, jlong existingFileAddress)
1074 {
1075     LPCWSTR newFile = jlong_to_ptr(newFileAddress);
1076     LPCWSTR existingFile = jlong_to_ptr(existingFileAddress);
1077 
1078     if (CreateHardLinkW(newFile, existingFile, NULL) == 0)
1079         throwWindowsException(env, GetLastError());
1080 }
1081 
1082 JNIEXPORT jstring JNICALL
1083 Java_sun_nio_fs_WindowsNativeDispatcher_GetFullPathName0(JNIEnv *env,
1084                                                          jclass clz,
1085                                                          jlong pathAddress)
1086 {
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2008, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 160     }
 161     return ptr_to_jlong(hEvent);
 162 }
 163 
 164 JNIEXPORT jstring JNICALL
 165 Java_sun_nio_fs_WindowsNativeDispatcher_FormatMessage(JNIEnv* env, jclass this, jint errorCode) {
 166     WCHAR message[255];
 167 
 168     DWORD len = FormatMessageW(FORMAT_MESSAGE_FROM_SYSTEM,
 169                                NULL,
 170                                (DWORD)errorCode,
 171                                0,
 172                                &amp;message[0],
 173                                255,
 174                                NULL);
 175 
 176 
 177     if (len == 0) {
 178         return NULL;
 179     } else {
<span class="line-added"> 180         if (len &gt; 3) {</span>
<span class="line-added"> 181             // Drop final &#39;.&#39;, CR, LF</span>
<span class="line-added"> 182             if (message[len - 1] == L&#39;\n&#39;) len--;</span>
<span class="line-added"> 183             if (message[len - 1] == L&#39;\r&#39;) len--;</span>
<span class="line-added"> 184             if (message[len - 1] == L&#39;.&#39;) len--;</span>
<span class="line-added"> 185             message[len] = L&#39;\0&#39;;</span>
<span class="line-added"> 186         }</span>
<span class="line-added"> 187 </span>
 188         return (*env)-&gt;NewString(env, (const jchar *)message, (jsize)wcslen(message));
 189     }
 190 }
 191 
 192 JNIEXPORT void JNICALL
 193 Java_sun_nio_fs_WindowsNativeDispatcher_LocalFree(JNIEnv* env, jclass this, jlong address)
 194 {
 195     HLOCAL hMem = (HLOCAL)jlong_to_ptr(address);
 196     LocalFree(hMem);
 197 }
 198 
 199 JNIEXPORT jlong JNICALL
 200 Java_sun_nio_fs_WindowsNativeDispatcher_CreateFile0(JNIEnv* env, jclass this,
 201     jlong address, jint dwDesiredAccess, jint dwShareMode, jlong sdAddress,
 202     jint dwCreationDisposition, jint dwFlagsAndAttributes)
 203 {
 204     HANDLE handle;
 205     LPCWSTR lpFileName = jlong_to_ptr(address);
 206 
 207     SECURITY_ATTRIBUTES securityAttributes;
</pre>
<hr />
<pre>
1054 
1055     if (pLuid == NULL) {
1056         JNU_ThrowInternalError(env, &quot;Unable to allocate LUID structure&quot;);
1057     } else {
1058         if (LookupPrivilegeValueW(NULL, lpName, pLuid) == 0) {
1059             LocalFree(pLuid);
1060             throwWindowsException(env, GetLastError());
1061             return (jlong)0;
1062         }
1063     }
1064     return ptr_to_jlong(pLuid);
1065 }
1066 
1067 JNIEXPORT void JNICALL
1068 Java_sun_nio_fs_WindowsNativeDispatcher_CreateSymbolicLink0(JNIEnv* env,
1069     jclass this, jlong linkAddress, jlong targetAddress, jint flags)
1070 {
1071     LPCWSTR link = jlong_to_ptr(linkAddress);
1072     LPCWSTR target = jlong_to_ptr(targetAddress);
1073 

1074     if (CreateSymbolicLinkW(link, target, (DWORD)flags) == 0)
1075         throwWindowsException(env, GetLastError());
1076 }
1077 
1078 JNIEXPORT void JNICALL
1079 Java_sun_nio_fs_WindowsNativeDispatcher_CreateHardLink0(JNIEnv* env,
1080     jclass this, jlong newFileAddress, jlong existingFileAddress)
1081 {
1082     LPCWSTR newFile = jlong_to_ptr(newFileAddress);
1083     LPCWSTR existingFile = jlong_to_ptr(existingFileAddress);
1084 
1085     if (CreateHardLinkW(newFile, existingFile, NULL) == 0)
1086         throwWindowsException(env, GetLastError());
1087 }
1088 
1089 JNIEXPORT jstring JNICALL
1090 Java_sun_nio_fs_WindowsNativeDispatcher_GetFullPathName0(JNIEnv *env,
1091                                                          jclass clz,
1092                                                          jlong pathAddress)
1093 {
</pre>
</td>
</tr>
</table>
<center><a href="../ch/nio_util.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="../../../../../java.compiler/share/classes/javax/annotation/processing/AbstractProcessor.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>