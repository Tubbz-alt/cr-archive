<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.base/windows/native/libnio/ch/ServerSocketChannelImpl.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2000, 2010, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 #include &lt;windows.h&gt;
 27 #include &lt;winsock2.h&gt;
 28 #include &lt;ctype.h&gt;
 29 #include &lt;stdio.h&gt;
 30 #include &lt;stdlib.h&gt;
 31 #include &lt;malloc.h&gt;
 32 #include &lt;sys/types.h&gt;
 33 
 34 #include &quot;jni.h&quot;
 35 #include &quot;jni_util.h&quot;
 36 #include &quot;jvm.h&quot;
 37 #include &quot;jlong.h&quot;
 38 
 39 #include &quot;nio.h&quot;
 40 #include &quot;nio_util.h&quot;
 41 #include &quot;net_util.h&quot;
 42 
 43 #include &quot;sun_nio_ch_ServerSocketChannelImpl.h&quot;
 44 
 45 
 46 static jfieldID fd_fdID;        /* java.io.FileDescriptor.fd */
 47 static jclass isa_class;        /* java.net.InetSocketAddress */
 48 static jmethodID isa_ctorID;    /* InetSocketAddress(InetAddress, int) */
 49 
 50 
 51 /**************************************************************
 52  * static method to store field IDs in initializers
 53  */
 54 
 55 JNIEXPORT void JNICALL
 56 Java_sun_nio_ch_ServerSocketChannelImpl_initIDs(JNIEnv *env, jclass cls)
 57 {
 58     cls = (*env)-&gt;FindClass(env, &quot;java/io/FileDescriptor&quot;);
 59     CHECK_NULL(cls);
 60     fd_fdID = (*env)-&gt;GetFieldID(env, cls, &quot;fd&quot;, &quot;I&quot;);
 61     CHECK_NULL(fd_fdID);
 62 
 63     cls = (*env)-&gt;FindClass(env, &quot;java/net/InetSocketAddress&quot;);
 64     CHECK_NULL(cls);
 65     isa_class = (*env)-&gt;NewGlobalRef(env, cls);
 66     if (isa_class == NULL) {
 67         JNU_ThrowOutOfMemoryError(env, NULL);
 68         return;
 69     }
 70     isa_ctorID = (*env)-&gt;GetMethodID(env, cls, &quot;&lt;init&gt;&quot;,
 71                                      &quot;(Ljava/net/InetAddress;I)V&quot;);
 72     CHECK_NULL(isa_ctorID);
 73 }
 74 
 75 JNIEXPORT void JNICALL
 76 Java_sun_nio_ch_ServerSocketChannelImpl_listen(JNIEnv *env, jclass cl,
 77                                                jobject fdo, jint backlog)
 78 {
 79     if (listen(fdval(env,fdo), backlog) == SOCKET_ERROR) {
 80         NET_ThrowNew(env, WSAGetLastError(), &quot;listen&quot;);
 81     }
 82 }
 83 
 84 JNIEXPORT jint JNICALL
 85 Java_sun_nio_ch_ServerSocketChannelImpl_accept0(JNIEnv *env, jobject this,
 86                                                 jobject ssfdo, jobject newfdo,
 87                                                 jobjectArray isaa)
 88 {
 89     jint ssfd = (*env)-&gt;GetIntField(env, ssfdo, fd_fdID);
 90     jint newfd;
 91     SOCKETADDRESS sa;
 92     jobject remote_ia;
 93     int remote_port;
 94     jobject isa;
 95     int addrlen = sizeof(sa);
 96 
 97     memset((char *)&amp;sa, 0, sizeof(sa));
 98     newfd = (jint)accept(ssfd, &amp;sa.sa, &amp;addrlen);
 99     if (newfd == INVALID_SOCKET) {
100         int theErr = (jint)WSAGetLastError();
101         if (theErr == WSAEWOULDBLOCK) {
102             return IOS_UNAVAILABLE;
103         }
104         JNU_ThrowIOExceptionWithLastError(env, &quot;Accept failed&quot;);
105         return IOS_THROWN;
106     }
107 
108     SetHandleInformation((HANDLE)(UINT_PTR)newfd, HANDLE_FLAG_INHERIT, 0);
109     (*env)-&gt;SetIntField(env, newfdo, fd_fdID, newfd);
110     remote_ia = NET_SockaddrToInetAddress(env, &amp;sa, (int *)&amp;remote_port);
111     CHECK_NULL_RETURN(remote_ia, IOS_THROWN);
112 
113     isa = (*env)-&gt;NewObject(env, isa_class, isa_ctorID, remote_ia, remote_port);
114     CHECK_NULL_RETURN(isa, IOS_THROWN);
115     (*env)-&gt;SetObjectArrayElement(env, isaa, 0, isa);
116     return 1;
117 }
    </pre>
  </body>
</html>