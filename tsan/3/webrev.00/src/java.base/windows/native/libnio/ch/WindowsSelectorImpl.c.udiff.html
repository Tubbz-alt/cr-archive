<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.base/windows/native/libnio/ch/WindowsSelectorImpl.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="WindowsAsynchronousFileChannelImpl.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="nio_util.h.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/windows/native/libnio/ch/WindowsSelectorImpl.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -37,10 +37,11 @@</span>
  #include &lt;winsock2.h&gt;
  
  #include &quot;jvm.h&quot;
  #include &quot;jni.h&quot;
  #include &quot;jni_util.h&quot;
<span class="udiff-line-added">+ #include &quot;nio.h&quot;</span>
  #include &quot;sun_nio_ch_WindowsSelectorImpl.h&quot;
  #include &quot;sun_nio_ch_PollArrayWrapper.h&quot;
  
  #include &quot;nio_util.h&quot; /* Needed for POLL* constants (includes &quot;winsock2.h&quot;) */
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -54,16 +55,18 @@</span>
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_WindowsSelectorImpl_00024SubSelector_poll0(JNIEnv *env, jobject this,
                                     jlong pollAddress, jint numfds,
                                     jintArray returnReadFds, jintArray returnWriteFds,
<span class="udiff-line-modified-removed">-                                    jintArray returnExceptFds, jlong timeout)</span>
<span class="udiff-line-modified-added">+                                    jintArray returnExceptFds, jlong timeout, jlong fdsBuffer)</span>
  {
      DWORD result = 0;
      pollfd *fds = (pollfd *) pollAddress;
      int i;
<span class="udiff-line-modified-removed">-     FD_SET readfds, writefds, exceptfds;</span>
<span class="udiff-line-modified-added">+     FD_SET *readfds = (FD_SET *) jlong_to_ptr(fdsBuffer);</span>
<span class="udiff-line-added">+     FD_SET *writefds = (FD_SET *) jlong_to_ptr(fdsBuffer + sizeof(FD_SET));</span>
<span class="udiff-line-added">+     FD_SET *exceptfds = (FD_SET *) jlong_to_ptr(fdsBuffer + sizeof(FD_SET) * 2);</span>
      struct timeval timevalue, *tv;
      static struct timeval zerotime = {0, 0};
      int read_count = 0, write_count = 0, except_count = 0;
  
  #ifdef _WIN64
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -91,107 +94,65 @@</span>
      }
  
      /* Set FD_SET structures required for select */
      for (i = 0; i &lt; numfds; i++) {
          if (fds[i].events &amp; POLLIN) {
<span class="udiff-line-modified-removed">-            readfds.fd_array[read_count] = fds[i].fd;</span>
<span class="udiff-line-modified-added">+            readfds-&gt;fd_array[read_count] = fds[i].fd;</span>
             read_count++;
          }
          if (fds[i].events &amp; (POLLOUT | POLLCONN))
          {
<span class="udiff-line-modified-removed">-            writefds.fd_array[write_count] = fds[i].fd;</span>
<span class="udiff-line-modified-added">+            writefds-&gt;fd_array[write_count] = fds[i].fd;</span>
             write_count++;
          }
<span class="udiff-line-modified-removed">-         exceptfds.fd_array[except_count] = fds[i].fd;</span>
<span class="udiff-line-modified-added">+         exceptfds-&gt;fd_array[except_count] = fds[i].fd;</span>
          except_count++;
      }
  
<span class="udiff-line-modified-removed">-     readfds.fd_count = read_count;</span>
<span class="udiff-line-modified-removed">-     writefds.fd_count = write_count;</span>
<span class="udiff-line-modified-removed">-     exceptfds.fd_count = except_count;</span>
<span class="udiff-line-modified-added">+     readfds-&gt;fd_count = read_count;</span>
<span class="udiff-line-modified-added">+     writefds-&gt;fd_count = write_count;</span>
<span class="udiff-line-modified-added">+     exceptfds-&gt;fd_count = except_count;</span>
  
      /* Call select */
<span class="udiff-line-modified-removed">-     if ((result = select(0 , &amp;readfds, &amp;writefds, &amp;exceptfds, tv))</span>
<span class="udiff-line-modified-added">+     if ((result = select(0 , readfds, writefds, exceptfds, tv))</span>
                                                               == SOCKET_ERROR) {
<span class="udiff-line-modified-removed">-         /* Bad error - this should not happen frequently */</span>
<span class="udiff-line-modified-removed">-         /* Iterate over sockets and call select() on each separately */</span>
<span class="udiff-line-removed">-         FD_SET errreadfds, errwritefds, errexceptfds;</span>
<span class="udiff-line-removed">-         readfds.fd_count = 0;</span>
<span class="udiff-line-removed">-         writefds.fd_count = 0;</span>
<span class="udiff-line-removed">-         exceptfds.fd_count = 0;</span>
<span class="udiff-line-removed">-         for (i = 0; i &lt; numfds; i++) {</span>
<span class="udiff-line-removed">-             /* prepare select structures for the i-th socket */</span>
<span class="udiff-line-removed">-             errreadfds.fd_count = 0;</span>
<span class="udiff-line-removed">-             errwritefds.fd_count = 0;</span>
<span class="udiff-line-removed">-             if (fds[i].events &amp; POLLIN) {</span>
<span class="udiff-line-removed">-                errreadfds.fd_array[0] = fds[i].fd;</span>
<span class="udiff-line-removed">-                errreadfds.fd_count = 1;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (fds[i].events &amp; (POLLOUT | POLLCONN))</span>
<span class="udiff-line-removed">-             {</span>
<span class="udiff-line-removed">-                 errwritefds.fd_array[0] = fds[i].fd;</span>
<span class="udiff-line-removed">-                 errwritefds.fd_count = 1;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             errexceptfds.fd_array[0] = fds[i].fd;</span>
<span class="udiff-line-removed">-             errexceptfds.fd_count = 1;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             /* call select on the i-th socket */</span>
<span class="udiff-line-removed">-             if (select(0, &amp;errreadfds, &amp;errwritefds, &amp;errexceptfds, &amp;zerotime)</span>
<span class="udiff-line-removed">-                                                              == SOCKET_ERROR) {</span>
<span class="udiff-line-removed">-                 /* This socket causes an error. Add it to exceptfds set */</span>
<span class="udiff-line-removed">-                 exceptfds.fd_array[exceptfds.fd_count] = fds[i].fd;</span>
<span class="udiff-line-removed">-                 exceptfds.fd_count++;</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 /* This socket does not cause an error. Process result */</span>
<span class="udiff-line-removed">-                 if (errreadfds.fd_count == 1) {</span>
<span class="udiff-line-removed">-                     readfds.fd_array[readfds.fd_count] = fds[i].fd;</span>
<span class="udiff-line-removed">-                     readfds.fd_count++;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (errwritefds.fd_count == 1) {</span>
<span class="udiff-line-removed">-                     writefds.fd_array[writefds.fd_count] = fds[i].fd;</span>
<span class="udiff-line-removed">-                     writefds.fd_count++;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (errexceptfds.fd_count == 1) {</span>
<span class="udiff-line-removed">-                     exceptfds.fd_array[exceptfds.fd_count] = fds[i].fd;</span>
<span class="udiff-line-removed">-                     exceptfds.fd_count++;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         JNU_ThrowIOExceptionWithLastError(env, &quot;Select failed&quot;);</span>
<span class="udiff-line-modified-added">+         return IOS_THROWN;</span>
      }
  
      /* Return selected sockets. */
      /* Each Java array consists of sockets count followed by sockets list */
  
  #ifdef _WIN64
<span class="udiff-line-modified-removed">-     resultbuf[0] = readfds.fd_count;</span>
<span class="udiff-line-modified-removed">-     for (i = 0; i &lt; (int)readfds.fd_count; i++) {</span>
<span class="udiff-line-modified-removed">-         resultbuf[i + 1] = (int)readfds.fd_array[i];</span>
<span class="udiff-line-modified-added">+     resultbuf[0] = readfds-&gt;fd_count;</span>
<span class="udiff-line-modified-added">+     for (i = 0; i &lt; (int)readfds-&gt;fd_count; i++) {</span>
<span class="udiff-line-modified-added">+         resultbuf[i + 1] = (int)readfds-&gt;fd_array[i];</span>
      }
      (*env)-&gt;SetIntArrayRegion(env, returnReadFds, 0,
<span class="udiff-line-modified-removed">-                               readfds.fd_count + 1, resultbuf);</span>
<span class="udiff-line-modified-added">+                               readfds-&gt;fd_count + 1, resultbuf);</span>
  
<span class="udiff-line-modified-removed">-     resultbuf[0] = writefds.fd_count;</span>
<span class="udiff-line-modified-removed">-     for (i = 0; i &lt; (int)writefds.fd_count; i++) {</span>
<span class="udiff-line-modified-removed">-         resultbuf[i + 1] = (int)writefds.fd_array[i];</span>
<span class="udiff-line-modified-added">+     resultbuf[0] = writefds-&gt;fd_count;</span>
<span class="udiff-line-modified-added">+     for (i = 0; i &lt; (int)writefds-&gt;fd_count; i++) {</span>
<span class="udiff-line-modified-added">+         resultbuf[i + 1] = (int)writefds-&gt;fd_array[i];</span>
      }
      (*env)-&gt;SetIntArrayRegion(env, returnWriteFds, 0,
<span class="udiff-line-modified-removed">-                               writefds.fd_count + 1, resultbuf);</span>
<span class="udiff-line-modified-added">+                               writefds-&gt;fd_count + 1, resultbuf);</span>
  
<span class="udiff-line-modified-removed">-     resultbuf[0] = exceptfds.fd_count;</span>
<span class="udiff-line-modified-removed">-     for (i = 0; i &lt; (int)exceptfds.fd_count; i++) {</span>
<span class="udiff-line-modified-removed">-         resultbuf[i + 1] = (int)exceptfds.fd_array[i];</span>
<span class="udiff-line-modified-added">+     resultbuf[0] = exceptfds-&gt;fd_count;</span>
<span class="udiff-line-modified-added">+     for (i = 0; i &lt; (int)exceptfds-&gt;fd_count; i++) {</span>
<span class="udiff-line-modified-added">+         resultbuf[i + 1] = (int)exceptfds-&gt;fd_array[i];</span>
      }
      (*env)-&gt;SetIntArrayRegion(env, returnExceptFds, 0,
<span class="udiff-line-modified-removed">-                               exceptfds.fd_count + 1, resultbuf);</span>
<span class="udiff-line-modified-added">+                               exceptfds-&gt;fd_count + 1, resultbuf);</span>
  #else
      (*env)-&gt;SetIntArrayRegion(env, returnReadFds, 0,
<span class="udiff-line-modified-removed">-                               readfds.fd_count + 1, (jint *)&amp;readfds);</span>
<span class="udiff-line-modified-added">+                               readfds-&gt;fd_count + 1, (jint *)readfds);</span>
  
      (*env)-&gt;SetIntArrayRegion(env, returnWriteFds, 0,
<span class="udiff-line-modified-removed">-                               writefds.fd_count + 1, (jint *)&amp;writefds);</span>
<span class="udiff-line-modified-added">+                               writefds-&gt;fd_count + 1, (jint *)writefds);</span>
      (*env)-&gt;SetIntArrayRegion(env, returnExceptFds, 0,
<span class="udiff-line-modified-removed">-                               exceptfds.fd_count + 1, (jint *)&amp;exceptfds);</span>
<span class="udiff-line-modified-added">+                               exceptfds-&gt;fd_count + 1, (jint *)exceptfds);</span>
  #endif
      return 0;
  }
  
  JNIEXPORT void JNICALL
</pre>
<center><a href="WindowsAsynchronousFileChannelImpl.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="nio_util.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>