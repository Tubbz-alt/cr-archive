<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.base/windows/native/libnio/ch/Net.c</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="Iocp.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SocketDispatcher.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.base/windows/native/libnio/ch/Net.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 23,15 ***</span>
   * questions.
   */
  
  #include &lt;windows.h&gt;
  #include &lt;winsock2.h&gt;
  #include &quot;jni.h&quot;
  #include &quot;jni_util.h&quot;
  #include &quot;jvm.h&quot;
  #include &quot;jlong.h&quot;
<span class="line-removed">- </span>
  #include &quot;nio.h&quot;
  #include &quot;nio_util.h&quot;
  #include &quot;net_util.h&quot;
  
  #include &quot;sun_nio_ch_Net.h&quot;
<span class="line-new-header">--- 23,15 ---</span>
   * questions.
   */
  
  #include &lt;windows.h&gt;
  #include &lt;winsock2.h&gt;
<span class="line-added">+ </span>
  #include &quot;jni.h&quot;
  #include &quot;jni_util.h&quot;
  #include &quot;jvm.h&quot;
  #include &quot;jlong.h&quot;
  #include &quot;nio.h&quot;
  #include &quot;nio_util.h&quot;
  #include &quot;net_util.h&quot;
  
  #include &quot;sun_nio_ch_Net.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 81,14 ***</span>
  {
      NET_ThrowNew(env, errorValue, NULL);
      return IOS_THROWN;
  }
  
  JNIEXPORT void JNICALL
  Java_sun_nio_ch_Net_initIDs(JNIEnv *env, jclass clazz)
  {
<span class="line-modified">!     initInetAddressIDs(env);</span>
  }
  
  JNIEXPORT jboolean JNICALL
  Java_sun_nio_ch_Net_isIPv6Available0(JNIEnv* env, jclass cl)
  {
<span class="line-new-header">--- 81,27 ---</span>
  {
      NET_ThrowNew(env, errorValue, NULL);
      return IOS_THROWN;
  }
  
<span class="line-added">+ static jclass isa_class;        /* java.net.InetSocketAddress */</span>
<span class="line-added">+ static jmethodID isa_ctorID;    /* InetSocketAddress(InetAddress, int) */</span>
<span class="line-added">+ </span>
  JNIEXPORT void JNICALL
  Java_sun_nio_ch_Net_initIDs(JNIEnv *env, jclass clazz)
  {
<span class="line-modified">!      jclass cls = (*env)-&gt;FindClass(env, &quot;java/net/InetSocketAddress&quot;);</span>
<span class="line-added">+      CHECK_NULL(cls);</span>
<span class="line-added">+      isa_class = (*env)-&gt;NewGlobalRef(env, cls);</span>
<span class="line-added">+      if (isa_class == NULL) {</span>
<span class="line-added">+          JNU_ThrowOutOfMemoryError(env, NULL);</span>
<span class="line-added">+          return;</span>
<span class="line-added">+      }</span>
<span class="line-added">+      isa_ctorID = (*env)-&gt;GetMethodID(env, cls, &quot;&lt;init&gt;&quot;, &quot;(Ljava/net/InetAddress;I)V&quot;);</span>
<span class="line-added">+      CHECK_NULL(isa_ctorID);</span>
<span class="line-added">+ </span>
<span class="line-added">+      initInetAddressIDs(env);</span>
  }
  
  JNIEXPORT jboolean JNICALL
  Java_sun_nio_ch_Net_isIPv6Available0(JNIEnv* env, jclass cl)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 108,20 ***</span>
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_isExclusiveBindAvailable(JNIEnv *env, jclass clazz) {
      return 1;
  }
  
  
  JNIEXPORT jboolean JNICALL
  Java_sun_nio_ch_Net_canIPv6SocketJoinIPv4Group0(JNIEnv* env, jclass cl)
  {
<span class="line-modified">!     return JNI_FALSE;</span>
  }
  
  JNIEXPORT jboolean JNICALL
  Java_sun_nio_ch_Net_canJoin6WithIPv4Group0(JNIEnv* env, jclass cl)
  {
      return JNI_FALSE;
  }
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_socket0(JNIEnv *env, jclass cl, jboolean preferIPv6,
<span class="line-new-header">--- 121,35 ---</span>
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_isExclusiveBindAvailable(JNIEnv *env, jclass clazz) {
      return 1;
  }
  
<span class="line-added">+ JNIEXPORT jboolean JNICALL</span>
<span class="line-added">+ Java_sun_nio_ch_Net_shouldSetBothIPv4AndIPv6Options0(JNIEnv* env, jclass cl)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     /* Set both IPv4 and IPv6 socket options when setting multicast options */</span>
<span class="line-added">+     return JNI_TRUE;</span>
<span class="line-added">+ }</span>
  
  JNIEXPORT jboolean JNICALL
  Java_sun_nio_ch_Net_canIPv6SocketJoinIPv4Group0(JNIEnv* env, jclass cl)
  {
<span class="line-modified">!     /* IPv6 sockets can join IPv4 multicast groups */</span>
<span class="line-added">+     return JNI_TRUE;</span>
  }
  
  JNIEXPORT jboolean JNICALL
  Java_sun_nio_ch_Net_canJoin6WithIPv4Group0(JNIEnv* env, jclass cl)
  {
<span class="line-added">+     /* IPV6_ADD_MEMBERSHIP cannot be used to join IPv4 multicast groups */</span>
<span class="line-added">+     return JNI_FALSE;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ JNIEXPORT jboolean JNICALL</span>
<span class="line-added">+ Java_sun_nio_ch_Net_canUseIPv6OptionsWithIPv4LocalAddress0(JNIEnv* env, jclass cl)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     /* IPV6_XXX socket options cannot be used on IPv6 sockets bound to IPv4 address */</span>
      return JNI_FALSE;
  }
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_socket0(JNIEnv *env, jclass cl, jboolean preferIPv6,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 190,11 ***</span>
      if (listen(fdval(env,fdo), backlog) == SOCKET_ERROR) {
          NET_ThrowNew(env, WSAGetLastError(), &quot;listen&quot;);
      }
  }
  
<span class="line-removed">- </span>
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_connect0(JNIEnv *env, jclass clazz, jboolean preferIPv6, jobject fdo,
                               jobject iao, jint port)
  {
      SOCKETADDRESS sa;
<span class="line-new-header">--- 218,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 223,17 ***</span>
          }
      }
      return 1;
  }
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_localPort(JNIEnv *env, jclass clazz, jobject fdo)
  {
      SOCKETADDRESS sa;
      int sa_len = sizeof(sa);
  
<span class="line-modified">!     if (getsockname(fdval(env, fdo), &amp;sa.sa, &amp;sa_len) &lt; 0) {</span>
          int error = WSAGetLastError();
          if (error == WSAEINVAL) {
              return 0;
          }
          NET_ThrowNew(env, error, &quot;getsockname&quot;);
<span class="line-new-header">--- 250,53 ---</span>
          }
      }
      return 1;
  }
  
<span class="line-added">+ JNIEXPORT jint JNICALL</span>
<span class="line-added">+ Java_sun_nio_ch_Net_accept(JNIEnv *env, jclass clazz, jobject fdo, jobject newfdo,</span>
<span class="line-added">+                            jobjectArray isaa)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     jint fd = fdval(env,fdo);</span>
<span class="line-added">+     jint newfd;</span>
<span class="line-added">+     SOCKETADDRESS sa;</span>
<span class="line-added">+     int addrlen = sizeof(sa);</span>
<span class="line-added">+     jobject remote_ia;</span>
<span class="line-added">+     jint remote_port = 0;</span>
<span class="line-added">+     jobject isa;</span>
<span class="line-added">+ </span>
<span class="line-added">+     memset((char *)&amp;sa, 0, sizeof(sa));</span>
<span class="line-added">+     newfd = (jint) accept(fd, &amp;sa.sa, &amp;addrlen);</span>
<span class="line-added">+     if (newfd == INVALID_SOCKET) {</span>
<span class="line-added">+         int theErr = (jint)WSAGetLastError();</span>
<span class="line-added">+         if (theErr == WSAEWOULDBLOCK) {</span>
<span class="line-added">+             return IOS_UNAVAILABLE;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         JNU_ThrowIOExceptionWithLastError(env, &quot;Accept failed&quot;);</span>
<span class="line-added">+         return IOS_THROWN;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     SetHandleInformation((HANDLE)(UINT_PTR)newfd, HANDLE_FLAG_INHERIT, 0);</span>
<span class="line-added">+     setfdval(env, newfdo, newfd);</span>
<span class="line-added">+ </span>
<span class="line-added">+     remote_ia = NET_SockaddrToInetAddress(env, &amp;sa, (int *)&amp;remote_port);</span>
<span class="line-added">+     CHECK_NULL_RETURN(remote_ia, IOS_THROWN);</span>
<span class="line-added">+ </span>
<span class="line-added">+     isa = (*env)-&gt;NewObject(env, isa_class, isa_ctorID, remote_ia, remote_port);</span>
<span class="line-added">+     CHECK_NULL_RETURN(isa, IOS_THROWN);</span>
<span class="line-added">+     (*env)-&gt;SetObjectArrayElement(env, isaa, 0, isa);</span>
<span class="line-added">+ </span>
<span class="line-added">+     return 1;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_localPort(JNIEnv *env, jclass clazz, jobject fdo)
  {
      SOCKETADDRESS sa;
      int sa_len = sizeof(sa);
  
<span class="line-modified">!     if (getsockname(fdval(env, fdo), &amp;sa.sa, &amp;sa_len) == SOCKET_ERROR) {</span>
          int error = WSAGetLastError();
          if (error == WSAEINVAL) {
              return 0;
          }
          NET_ThrowNew(env, error, &quot;getsockname&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 247,11 ***</span>
  {
      SOCKETADDRESS sa;
      int sa_len = sizeof(sa);
      int port;
  
<span class="line-modified">!     if (getsockname(fdval(env, fdo), &amp;sa.sa, &amp;sa_len) &lt; 0) {</span>
          NET_ThrowNew(env, WSAGetLastError(), &quot;getsockname&quot;);
          return NULL;
      }
      return NET_SockaddrToInetAddress(env, &amp;sa, &amp;port);
  }
<span class="line-new-header">--- 310,11 ---</span>
  {
      SOCKETADDRESS sa;
      int sa_len = sizeof(sa);
      int port;
  
<span class="line-modified">!     if (getsockname(fdval(env, fdo), &amp;sa.sa, &amp;sa_len) == SOCKET_ERROR) {</span>
          NET_ThrowNew(env, WSAGetLastError(), &quot;getsockname&quot;);
          return NULL;
      }
      return NET_SockaddrToInetAddress(env, &amp;sa, &amp;port);
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 260,11 ***</span>
  Java_sun_nio_ch_Net_remotePort(JNIEnv *env, jclass clazz, jobject fdo)
  {
      SOCKETADDRESS sa;
      int sa_len = sizeof(sa);
  
<span class="line-modified">!     if (getpeername(fdval(env, fdo), &amp;sa.sa, &amp;sa_len) &lt; 0) {</span>
          int error = WSAGetLastError();
          if (error == WSAEINVAL) {
              return 0;
          }
          NET_ThrowNew(env, error, &quot;getsockname&quot;);
<span class="line-new-header">--- 323,11 ---</span>
  Java_sun_nio_ch_Net_remotePort(JNIEnv *env, jclass clazz, jobject fdo)
  {
      SOCKETADDRESS sa;
      int sa_len = sizeof(sa);
  
<span class="line-modified">!     if (getpeername(fdval(env, fdo), &amp;sa.sa, &amp;sa_len) == SOCKET_ERROR) {</span>
          int error = WSAGetLastError();
          if (error == WSAEINVAL) {
              return 0;
          }
          NET_ThrowNew(env, error, &quot;getsockname&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 278,11 ***</span>
  {
      SOCKETADDRESS sa;
      int sa_len = sizeof(sa);
      int port;
  
<span class="line-modified">!     if (getpeername(fdval(env, fdo), &amp;sa.sa, &amp;sa_len) &lt; 0) {</span>
          NET_ThrowNew(env, WSAGetLastError(), &quot;getsockname&quot;);
          return NULL;
      }
      return NET_SockaddrToInetAddress(env, &amp;sa, &amp;port);
  }
<span class="line-new-header">--- 341,11 ---</span>
  {
      SOCKETADDRESS sa;
      int sa_len = sizeof(sa);
      int port;
  
<span class="line-modified">!     if (getpeername(fdval(env, fdo), &amp;sa.sa, &amp;sa_len) == SOCKET_ERROR) {</span>
          NET_ThrowNew(env, WSAGetLastError(), &quot;getsockname&quot;);
          return NULL;
      }
      return NET_SockaddrToInetAddress(env, &amp;sa, &amp;port);
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 316,11 ***</span>
      if (mayNeedConversion) {
          n = NET_GetSockOpt(fdval(env, fdo), level, opt, arg, &amp;arglen);
      } else {
          n = getsockopt(fdval(env, fdo), level, opt, arg, &amp;arglen);
      }
<span class="line-modified">!     if (n &lt; 0) {</span>
          handleSocketError(env, WSAGetLastError());
          return IOS_THROWN;
      }
  
      if (level == SOL_SOCKET &amp;&amp; opt == SO_LINGER)
<span class="line-new-header">--- 379,11 ---</span>
      if (mayNeedConversion) {
          n = NET_GetSockOpt(fdval(env, fdo), level, opt, arg, &amp;arglen);
      } else {
          n = getsockopt(fdval(env, fdo), level, opt, arg, &amp;arglen);
      }
<span class="line-modified">!     if (n == SOCKET_ERROR) {</span>
          handleSocketError(env, WSAGetLastError());
          return IOS_THROWN;
      }
  
      if (level == SOL_SOCKET &amp;&amp; opt == SO_LINGER)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 360,11 ***</span>
      if (mayNeedConversion) {
          n = NET_SetSockOpt(fdval(env, fdo), level, opt, parg, arglen);
      } else {
          n = setsockopt(fdval(env, fdo), level, opt, parg, arglen);
      }
<span class="line-modified">!     if (n &lt; 0)</span>
          handleSocketError(env, WSAGetLastError());
  }
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_joinOrDrop4(JNIEnv *env, jobject this, jboolean join, jobject fdo,
<span class="line-new-header">--- 423,11 ---</span>
      if (mayNeedConversion) {
          n = NET_SetSockOpt(fdval(env, fdo), level, opt, parg, arglen);
      } else {
          n = setsockopt(fdval(env, fdo), level, opt, parg, arglen);
      }
<span class="line-modified">!     if (n == SOCKET_ERROR)</span>
          handleSocketError(env, WSAGetLastError());
  }
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_joinOrDrop4(JNIEnv *env, jobject this, jboolean join, jobject fdo,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 389,11 ***</span>
          optval = (void*)&amp;mreq_source;
          optlen = sizeof(mreq_source);
      }
  
      n = setsockopt(fdval(env,fdo), IPPROTO_IP, opt, optval, optlen);
<span class="line-modified">!     if (n &lt; 0) {</span>
          if (join &amp;&amp; (WSAGetLastError() == WSAENOPROTOOPT))
              return IOS_UNAVAILABLE;
          handleSocketError(env, WSAGetLastError());
      }
      return 0;
<span class="line-new-header">--- 452,11 ---</span>
          optval = (void*)&amp;mreq_source;
          optlen = sizeof(mreq_source);
      }
  
      n = setsockopt(fdval(env,fdo), IPPROTO_IP, opt, optval, optlen);
<span class="line-modified">!     if (n == SOCKET_ERROR) {</span>
          if (join &amp;&amp; (WSAGetLastError() == WSAENOPROTOOPT))
              return IOS_UNAVAILABLE;
          handleSocketError(env, WSAGetLastError());
      }
      return 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 411,11 ***</span>
      mreq_source.imr_sourceaddr.s_addr = htonl(source);
      mreq_source.imr_interface.s_addr = htonl(interf);
  
      n = setsockopt(fdval(env,fdo), IPPROTO_IP, opt,
                     (void*)&amp;mreq_source, sizeof(mreq_source));
<span class="line-modified">!     if (n &lt; 0) {</span>
          if (block &amp;&amp; (WSAGetLastError() == WSAENOPROTOOPT))
              return IOS_UNAVAILABLE;
          handleSocketError(env, WSAGetLastError());
      }
      return 0;
<span class="line-new-header">--- 474,11 ---</span>
      mreq_source.imr_sourceaddr.s_addr = htonl(source);
      mreq_source.imr_interface.s_addr = htonl(interf);
  
      n = setsockopt(fdval(env,fdo), IPPROTO_IP, opt,
                     (void*)&amp;mreq_source, sizeof(mreq_source));
<span class="line-modified">!     if (n == SOCKET_ERROR) {</span>
          if (block &amp;&amp; (WSAGetLastError() == WSAENOPROTOOPT))
              return IOS_UNAVAILABLE;
          handleSocketError(env, WSAGetLastError());
      }
      return 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 466,24 ***</span>
      } else {
          int opt = (join) ? MCAST_JOIN_SOURCE_GROUP : MCAST_LEAVE_SOURCE_GROUP;
          n = setGroupSourceReqOption(env, fdo, opt, group, index, source);
      }
  
<span class="line-modified">!     if (n &lt; 0) {</span>
<span class="line-modified">!         handleSocketError(env, errno);</span>
      }
      return 0;
  }
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_blockOrUnblock6(JNIEnv *env, jobject this, jboolean block, jobject fdo,
                                      jbyteArray group, jint index, jbyteArray source)
  {
      int opt = (block) ? MCAST_BLOCK_SOURCE : MCAST_UNBLOCK_SOURCE;
      int n = setGroupSourceReqOption(env, fdo, opt, group, index, source);
<span class="line-modified">!     if (n &lt; 0) {</span>
<span class="line-modified">!         handleSocketError(env, errno);</span>
      }
      return 0;
  }
  
  JNIEXPORT void JNICALL
<span class="line-new-header">--- 529,24 ---</span>
      } else {
          int opt = (join) ? MCAST_JOIN_SOURCE_GROUP : MCAST_LEAVE_SOURCE_GROUP;
          n = setGroupSourceReqOption(env, fdo, opt, group, index, source);
      }
  
<span class="line-modified">!     if (n == SOCKET_ERROR) {</span>
<span class="line-modified">!         handleSocketError(env, WSAGetLastError());</span>
      }
      return 0;
  }
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_blockOrUnblock6(JNIEnv *env, jobject this, jboolean block, jobject fdo,
                                      jbyteArray group, jint index, jbyteArray source)
  {
      int opt = (block) ? MCAST_BLOCK_SOURCE : MCAST_UNBLOCK_SOURCE;
      int n = setGroupSourceReqOption(env, fdo, opt, group, index, source);
<span class="line-modified">!     if (n == SOCKET_ERROR) {</span>
<span class="line-modified">!         handleSocketError(env, WSAGetLastError());</span>
      }
      return 0;
  }
  
  JNIEXPORT void JNICALL
</pre>
<hr />
<pre>
<span class="line-old-header">*** 495,11 ***</span>
  
      in.s_addr = htonl(interf);
  
      n = setsockopt(fdval(env, fdo), IPPROTO_IP, IP_MULTICAST_IF,
                     (void*)&amp;(in.s_addr), arglen);
<span class="line-modified">!     if (n &lt; 0) {</span>
          handleSocketError(env, WSAGetLastError());
      }
  }
  
  JNIEXPORT jint JNICALL
<span class="line-new-header">--- 558,11 ---</span>
  
      in.s_addr = htonl(interf);
  
      n = setsockopt(fdval(env, fdo), IPPROTO_IP, IP_MULTICAST_IF,
                     (void*)&amp;(in.s_addr), arglen);
<span class="line-modified">!     if (n == SOCKET_ERROR) {</span>
          handleSocketError(env, WSAGetLastError());
      }
  }
  
  JNIEXPORT jint JNICALL
</pre>
<hr />
<pre>
<span class="line-old-header">*** 508,41 ***</span>
      struct in_addr in;
      int arglen = sizeof(struct in_addr);
      int n;
  
      n = getsockopt(fdval(env, fdo), IPPROTO_IP, IP_MULTICAST_IF, (void*)&amp;in, &amp;arglen);
<span class="line-modified">!     if (n &lt; 0) {</span>
          handleSocketError(env, WSAGetLastError());
          return IOS_THROWN;
      }
      return ntohl(in.s_addr);
  }
  
  JNIEXPORT void JNICALL
  Java_sun_nio_ch_Net_setInterface6(JNIEnv* env, jobject this, jobject fdo, jint index)
  {
<span class="line-modified">!     int value = (jint)index;</span>
      int arglen = sizeof(value);
      int n;
  
      n = setsockopt(fdval(env, fdo), IPPROTO_IPV6, IPV6_MULTICAST_IF,
                     (void*)&amp;(index), arglen);
<span class="line-modified">!     if (n &lt; 0) {</span>
<span class="line-modified">!         handleSocketError(env, errno);</span>
      }
  }
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_getInterface6(JNIEnv* env, jobject this, jobject fdo)
  {
<span class="line-modified">!     int index;</span>
      int arglen = sizeof(index);
      int n;
  
      n = getsockopt(fdval(env, fdo), IPPROTO_IPV6, IPV6_MULTICAST_IF, (void*)&amp;index, &amp;arglen);
<span class="line-modified">!     if (n &lt; 0) {</span>
<span class="line-modified">!         handleSocketError(env, errno);</span>
          return -1;
      }
      return (jint)index;
  }
  
<span class="line-new-header">--- 571,41 ---</span>
      struct in_addr in;
      int arglen = sizeof(struct in_addr);
      int n;
  
      n = getsockopt(fdval(env, fdo), IPPROTO_IP, IP_MULTICAST_IF, (void*)&amp;in, &amp;arglen);
<span class="line-modified">!     if (n == SOCKET_ERROR) {</span>
          handleSocketError(env, WSAGetLastError());
          return IOS_THROWN;
      }
      return ntohl(in.s_addr);
  }
  
  JNIEXPORT void JNICALL
  Java_sun_nio_ch_Net_setInterface6(JNIEnv* env, jobject this, jobject fdo, jint index)
  {
<span class="line-modified">!     DWORD value = (jint)index;</span>
      int arglen = sizeof(value);
      int n;
  
      n = setsockopt(fdval(env, fdo), IPPROTO_IPV6, IPV6_MULTICAST_IF,
                     (void*)&amp;(index), arglen);
<span class="line-modified">!     if (n == SOCKET_ERROR) {</span>
<span class="line-modified">!         handleSocketError(env, WSAGetLastError());</span>
      }
  }
  
  JNIEXPORT jint JNICALL
  Java_sun_nio_ch_Net_getInterface6(JNIEnv* env, jobject this, jobject fdo)
  {
<span class="line-modified">!     DWORD index;</span>
      int arglen = sizeof(index);
      int n;
  
      n = getsockopt(fdval(env, fdo), IPPROTO_IPV6, IPV6_MULTICAST_IF, (void*)&amp;index, &amp;arglen);
<span class="line-modified">!     if (n == SOCKET_ERROR) {</span>
<span class="line-modified">!         handleSocketError(env, WSAGetLastError());</span>
          return -1;
      }
      return (jint)index;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 570,17 ***</span>
  Java_sun_nio_ch_Net_poll(JNIEnv* env, jclass this, jobject fdo, jint events, jlong timeout)
  {
      int rv;
      int revents = 0;
      struct timeval t;
<span class="line-removed">-     int lastError = 0;</span>
      fd_set rd, wr, ex;
      jint fd = fdval(env, fdo);
  
<span class="line-removed">-     t.tv_sec = (long)(timeout / 1000);</span>
<span class="line-removed">-     t.tv_usec = (timeout % 1000) * 1000;</span>
<span class="line-removed">- </span>
      FD_ZERO(&amp;rd);
      FD_ZERO(&amp;wr);
      FD_ZERO(&amp;ex);
      if (events &amp; POLLIN) {
          FD_SET(fd, &amp;rd);
<span class="line-new-header">--- 633,13 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 589,15 ***</span>
          events &amp; POLLCONN) {
          FD_SET(fd, &amp;wr);
      }
      FD_SET(fd, &amp;ex);
  
<span class="line-modified">!     rv = select(fd+1, &amp;rd, &amp;wr, &amp;ex, &amp;t);</span>
  
      /* save last winsock error */
      if (rv == SOCKET_ERROR) {
<span class="line-modified">!         handleSocketError(env, lastError);</span>
          return IOS_THROWN;
      } else if (rv &gt;= 0) {
          rv = 0;
          if (FD_ISSET(fd, &amp;rd)) {
              rv |= POLLIN;
<span class="line-new-header">--- 648,20 ---</span>
          events &amp; POLLCONN) {
          FD_SET(fd, &amp;wr);
      }
      FD_SET(fd, &amp;ex);
  
<span class="line-modified">!     if (timeout &gt;= 0) {</span>
<span class="line-added">+         t.tv_sec = (long)(timeout / 1000);</span>
<span class="line-added">+         t.tv_usec = (timeout % 1000) * 1000;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     rv = select(fd+1, &amp;rd, &amp;wr, &amp;ex, (timeout &gt;= 0) ? &amp;t : NULL);</span>
  
      /* save last winsock error */
      if (rv == SOCKET_ERROR) {
<span class="line-modified">!         handleSocketError(env, WSAGetLastError());</span>
          return IOS_THROWN;
      } else if (rv &gt;= 0) {
          rv = 0;
          if (FD_ISSET(fd, &amp;rd)) {
              rv |= POLLIN;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 610,11 ***</span>
          }
      }
      return rv;
  }
  
<span class="line-modified">! JNIEXPORT jint JNICALL</span>
  Java_sun_nio_ch_Net_pollConnect(JNIEnv* env, jclass this, jobject fdo, jlong timeout)
  {
      int optError = 0;
      int result;
      int n = sizeof(int);
<span class="line-new-header">--- 674,11 ---</span>
          }
      }
      return rv;
  }
  
<span class="line-modified">! JNIEXPORT jboolean JNICALL</span>
  Java_sun_nio_ch_Net_pollConnect(JNIEnv* env, jclass this, jobject fdo, jlong timeout)
  {
      int optError = 0;
      int result;
      int n = sizeof(int);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 634,36 ***</span>
  
      result = select(fd+1, 0, &amp;wr, &amp;ex, (timeout &gt;= 0) ? &amp;t : NULL);
  
      if (result == SOCKET_ERROR) {
          handleSocketError(env, WSAGetLastError());
<span class="line-modified">!         return IOS_THROWN;</span>
      } else if (result == 0) {
<span class="line-modified">!         return 0;</span>
      } else {
          // connection established if writable and no error to check
          if (FD_ISSET(fd, &amp;wr) &amp;&amp; !FD_ISSET(fd, &amp;ex)) {
<span class="line-modified">!             return 1;</span>
          }
          result = getsockopt((SOCKET)fd,
                              SOL_SOCKET,
                              SO_ERROR,
                              (char *)&amp;optError,
                              &amp;n);
          if (result == SOCKET_ERROR) {
              int lastError = WSAGetLastError();
<span class="line-modified">!             if (lastError == WSAEINPROGRESS) {</span>
<span class="line-modified">!                 return IOS_UNAVAILABLE;</span>
              }
<span class="line-modified">!             NET_ThrowNew(env, lastError, &quot;getsockopt&quot;);</span>
<span class="line-removed">-             return IOS_THROWN;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         if (optError != NO_ERROR) {</span>
              handleSocketError(env, optError);
<span class="line-removed">-             return IOS_THROWN;</span>
          }
<span class="line-modified">!         return 0;</span>
      }
  }
  
  JNIEXPORT jshort JNICALL
  Java_sun_nio_ch_Net_pollinValue(JNIEnv *env, jclass this)
<span class="line-new-header">--- 698,32 ---</span>
  
      result = select(fd+1, 0, &amp;wr, &amp;ex, (timeout &gt;= 0) ? &amp;t : NULL);
  
      if (result == SOCKET_ERROR) {
          handleSocketError(env, WSAGetLastError());
<span class="line-modified">!         return JNI_FALSE;</span>
      } else if (result == 0) {
<span class="line-modified">!         return JNI_FALSE;</span>
      } else {
          // connection established if writable and no error to check
          if (FD_ISSET(fd, &amp;wr) &amp;&amp; !FD_ISSET(fd, &amp;ex)) {
<span class="line-modified">!             return JNI_TRUE;</span>
          }
          result = getsockopt((SOCKET)fd,
                              SOL_SOCKET,
                              SO_ERROR,
                              (char *)&amp;optError,
                              &amp;n);
          if (result == SOCKET_ERROR) {
              int lastError = WSAGetLastError();
<span class="line-modified">!             if (lastError != WSAEINPROGRESS) {</span>
<span class="line-modified">!                 NET_ThrowNew(env, lastError, &quot;getsockopt&quot;);</span>
              }
<span class="line-modified">!         } else if (optError != NO_ERROR) {</span>
              handleSocketError(env, optError);
          }
<span class="line-modified">!         return JNI_FALSE;</span>
      }
  }
  
  JNIEXPORT jshort JNICALL
  Java_sun_nio_ch_Net_pollinValue(JNIEnv *env, jclass this)
</pre>
<center><a href="Iocp.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="SocketDispatcher.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>