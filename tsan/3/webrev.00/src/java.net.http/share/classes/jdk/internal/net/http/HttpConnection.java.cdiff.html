<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.net.http/share/classes/jdk/internal/net/http/HttpConnection.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Http2ClientImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HttpRequestImpl.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.net.http/share/classes/jdk/internal/net/http/HttpConnection.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 283,10 ***</span>
<span class="line-new-header">--- 283,20 ---</span>
              // assert request.proxy() == null &amp;&amp; !request.isConnect();
              return Utils.NO_PROXY_HEADERS_FILTER;
          }
      }
  
<span class="line-added">+     BiPredicate&lt;String,String&gt; contextRestricted(HttpRequestImpl request, HttpClient client) {</span>
<span class="line-added">+         if (!isTunnel() &amp;&amp; request.isConnect()) {</span>
<span class="line-added">+             // establishing a proxy tunnel</span>
<span class="line-added">+             assert request.proxy() == null;</span>
<span class="line-added">+             return Utils.PROXY_TUNNEL_RESTRICTED(client);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             return Utils.CONTEXT_RESTRICTED(client);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      // Composes a new immutable HttpHeaders that combines the
      // user and system header but only keeps those headers that
      // start with &quot;proxy-&quot;
      private static HttpHeaders proxyTunnelHeaders(HttpRequestImpl request) {
          Map&lt;String, List&lt;String&gt;&gt; combined = new TreeMap&lt;&gt;(String.CASE_INSENSITIVE_ORDER);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 315,30 ***</span>
      }
  
      void closeOrReturnToCache(HttpHeaders hdrs) {
          if (hdrs == null) {
              // the connection was closed by server, eof
              close();
              return;
          }
<span class="line-removed">-         if (!isOpen()) {</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
          HttpClientImpl client = client();
          if (client == null) {
              close();
              return;
          }
          ConnectionPool pool = client.connectionPool();
          boolean keepAlive = hdrs.firstValue(&quot;Connection&quot;)
                  .map((s) -&gt; !s.equalsIgnoreCase(&quot;close&quot;))
                  .orElse(true);
  
<span class="line-modified">!         if (keepAlive) {</span>
              Log.logTrace(&quot;Returning connection to the pool: {0}&quot;, this);
              pool.returnToPool(this);
          } else {
              close();
          }
      }
  
      /* Tells whether or not this connection is a tunnel through a proxy */
<span class="line-new-header">--- 325,31 ---</span>
      }
  
      void closeOrReturnToCache(HttpHeaders hdrs) {
          if (hdrs == null) {
              // the connection was closed by server, eof
<span class="line-added">+             Log.logTrace(&quot;Cannot return connection to pool: closing {0}&quot;, this);</span>
              close();
              return;
          }
          HttpClientImpl client = client();
          if (client == null) {
<span class="line-added">+             Log.logTrace(&quot;Client released: closing {0}&quot;, this);</span>
              close();
              return;
          }
          ConnectionPool pool = client.connectionPool();
          boolean keepAlive = hdrs.firstValue(&quot;Connection&quot;)
                  .map((s) -&gt; !s.equalsIgnoreCase(&quot;close&quot;))
                  .orElse(true);
  
<span class="line-modified">!         if (keepAlive &amp;&amp; isOpen()) {</span>
              Log.logTrace(&quot;Returning connection to the pool: {0}&quot;, this);
              pool.returnToPool(this);
          } else {
<span class="line-added">+             Log.logTrace(&quot;Closing connection (keepAlive={0}, isOpen={1}): {2}&quot;,</span>
<span class="line-added">+                     keepAlive, isOpen(), this);</span>
              close();
          }
      }
  
      /* Tells whether or not this connection is a tunnel through a proxy */
</pre>
<center><a href="Http2ClientImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HttpRequestImpl.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>