<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.net.http/share/classes/jdk/internal/net/http/AuthenticationFilter.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../java/net/http/HttpResponse.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ConnectionPool.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.net.http/share/classes/jdk/internal/net/http/AuthenticationFilter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 41,10 ***</span>
<span class="line-new-header">--- 41,11 ---</span>
  import jdk.internal.net.http.common.Log;
  import jdk.internal.net.http.common.Utils;
  import static java.net.Authenticator.RequestorType.PROXY;
  import static java.net.Authenticator.RequestorType.SERVER;
  import static java.nio.charset.StandardCharsets.ISO_8859_1;
<span class="line-added">+ import static java.nio.charset.StandardCharsets.UTF_8;</span>
  
  /**
   * Implementation of Http Basic authentication.
   */
  class AuthenticationFilter implements HeaderFilter {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 153,34 ***</span>
          if (exchange.proxyauth == null) {
              URI proxyURI = getProxyURI(r);
              if (proxyURI != null) {
                  CacheEntry ca = cache.get(proxyURI, true);
                  if (ca != null) {
<span class="line-modified">!                     exchange.proxyauth = new AuthInfo(true, ca.scheme, null, ca);</span>
<span class="line-modified">!                     addBasicCredentials(r, true, ca.value);</span>
                  }
              }
          }
  
          // Server
          if (exchange.serverauth == null) {
              CacheEntry ca = cache.get(r.uri(), false);
              if (ca != null) {
<span class="line-modified">!                 exchange.serverauth = new AuthInfo(true, ca.scheme, null, ca);</span>
<span class="line-modified">!                 addBasicCredentials(r, false, ca.value);</span>
              }
          }
      }
  
      // TODO: refactor into per auth scheme class
      private static void addBasicCredentials(HttpRequestImpl r,
                                              boolean proxy,
<span class="line-modified">!                                             PasswordAuthentication pw) {</span>
          String hdrname = proxy ? &quot;Proxy-Authorization&quot; : &quot;Authorization&quot;;
          StringBuilder sb = new StringBuilder(128);
          sb.append(pw.getUserName()).append(&#39;:&#39;).append(pw.getPassword());
<span class="line-modified">!         String s = encoder.encodeToString(sb.toString().getBytes(ISO_8859_1));</span>
          String value = &quot;Basic &quot; + s;
          if (proxy) {
              if (r.isConnect()) {
                  if (!Utils.PROXY_TUNNEL_FILTER.test(hdrname, value)) {
                      Log.logError(&quot;{0} disabled&quot;, hdrname);
<span class="line-new-header">--- 154,36 ---</span>
          if (exchange.proxyauth == null) {
              URI proxyURI = getProxyURI(r);
              if (proxyURI != null) {
                  CacheEntry ca = cache.get(proxyURI, true);
                  if (ca != null) {
<span class="line-modified">!                     exchange.proxyauth = new AuthInfo(true, ca.scheme, null, ca, ca.isUTF8);</span>
<span class="line-modified">!                     addBasicCredentials(r, true, ca.value, ca.isUTF8);</span>
                  }
              }
          }
  
          // Server
          if (exchange.serverauth == null) {
              CacheEntry ca = cache.get(r.uri(), false);
              if (ca != null) {
<span class="line-modified">!                 exchange.serverauth = new AuthInfo(true, ca.scheme, null, ca, ca.isUTF8);</span>
<span class="line-modified">!                 addBasicCredentials(r, false, ca.value, ca.isUTF8);</span>
              }
          }
      }
  
      // TODO: refactor into per auth scheme class
      private static void addBasicCredentials(HttpRequestImpl r,
                                              boolean proxy,
<span class="line-modified">!                                             PasswordAuthentication pw,</span>
<span class="line-added">+                                             boolean isUTF8) {</span>
          String hdrname = proxy ? &quot;Proxy-Authorization&quot; : &quot;Authorization&quot;;
          StringBuilder sb = new StringBuilder(128);
          sb.append(pw.getUserName()).append(&#39;:&#39;).append(pw.getPassword());
<span class="line-modified">!         var charset = isUTF8 ? UTF_8 : ISO_8859_1;</span>
<span class="line-added">+         String s = encoder.encodeToString(sb.toString().getBytes(charset));</span>
          String value = &quot;Basic &quot; + s;
          if (proxy) {
              if (r.isConnect()) {
                  if (!Utils.PROXY_TUNNEL_FILTER.test(hdrname, value)) {
                      Log.logError(&quot;{0} disabled&quot;, hdrname);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 201,76 ***</span>
          final boolean fromcache;
          final String scheme;
          int retries;
          PasswordAuthentication credentials; // used in request
          CacheEntry cacheEntry; // if used
  
          AuthInfo(boolean fromcache,
                   String scheme,
<span class="line-modified">!                  PasswordAuthentication credentials) {</span>
              this.fromcache = fromcache;
              this.scheme = scheme;
              this.credentials = credentials;
              this.retries = 1;
          }
  
          AuthInfo(boolean fromcache,
                   String scheme,
                   PasswordAuthentication credentials,
<span class="line-modified">!                  CacheEntry ca) {</span>
<span class="line-modified">!             this(fromcache, scheme, credentials);</span>
              assert credentials == null || (ca != null &amp;&amp; ca.value == null);
              cacheEntry = ca;
          }
  
<span class="line-modified">!         AuthInfo retryWithCredentials(PasswordAuthentication pw) {</span>
              // If the info was already in the cache we need to create a new
              // instance with fromCache==false so that it&#39;s put back in the
              // cache if authentication succeeds
<span class="line-modified">!             AuthInfo res = fromcache ? new AuthInfo(false, scheme, pw) : this;</span>
              res.credentials = Objects.requireNonNull(pw);
              res.retries = retries;
              return res;
          }
<span class="line-removed">- </span>
      }
  
      @Override
      public HttpRequestImpl response(Response r) throws IOException {
          Cache cache = getCache(exchange);
          int status = r.statusCode();
          HttpHeaders hdrs = r.headers();
          HttpRequestImpl req = r.request();
  
<span class="line-modified">!         if (status != UNAUTHORIZED &amp;&amp; status != PROXY_UNAUTHORIZED) {</span>
<span class="line-removed">-             // check if any authentication succeeded for first time</span>
<span class="line-removed">-             if (exchange.serverauth != null &amp;&amp; !exchange.serverauth.fromcache) {</span>
<span class="line-removed">-                 AuthInfo au = exchange.serverauth;</span>
<span class="line-removed">-                 cache.store(au.scheme, req.uri(), false, au.credentials);</span>
<span class="line-removed">-             }</span>
              if (exchange.proxyauth != null &amp;&amp; !exchange.proxyauth.fromcache) {
                  AuthInfo au = exchange.proxyauth;
                  URI proxyURI = getProxyURI(req);
                  if (proxyURI != null) {
<span class="line-modified">!                     cache.store(au.scheme, proxyURI, true, au.credentials);</span>
                  }
              }
<span class="line-modified">!             return null;</span>
          }
  
          boolean proxy = status == PROXY_UNAUTHORIZED;
          String authname = proxy ? &quot;Proxy-Authenticate&quot; : &quot;WWW-Authenticate&quot;;
          List&lt;String&gt; authvals = hdrs.allValues(authname);
          if (authvals.isEmpty() &amp;&amp; exchange.client().authenticator().isPresent()) {
              throw new IOException(authname + &quot; header missing for response code &quot; + status);
          }
          String authval = null;
          for (String aval : authvals) {
              HeaderParser parser = new HeaderParser(aval);
              String scheme = parser.findKey(0);
              if (scheme.equalsIgnoreCase(&quot;Basic&quot;)) {
                  authval = aval;
                  break;
              }
          }
          if (authval == null) {
              return null;
<span class="line-new-header">--- 204,83 ---</span>
          final boolean fromcache;
          final String scheme;
          int retries;
          PasswordAuthentication credentials; // used in request
          CacheEntry cacheEntry; // if used
<span class="line-added">+         final boolean isUTF8; //</span>
  
          AuthInfo(boolean fromcache,
                   String scheme,
<span class="line-modified">!                  PasswordAuthentication credentials, boolean isUTF8) {</span>
              this.fromcache = fromcache;
              this.scheme = scheme;
              this.credentials = credentials;
              this.retries = 1;
<span class="line-added">+             this.isUTF8 = isUTF8;</span>
          }
  
          AuthInfo(boolean fromcache,
                   String scheme,
                   PasswordAuthentication credentials,
<span class="line-modified">!                  CacheEntry ca, boolean isUTF8) {</span>
<span class="line-modified">!             this(fromcache, scheme, credentials, isUTF8);</span>
              assert credentials == null || (ca != null &amp;&amp; ca.value == null);
              cacheEntry = ca;
          }
  
<span class="line-modified">!         AuthInfo retryWithCredentials(PasswordAuthentication pw, boolean isUTF8) {</span>
              // If the info was already in the cache we need to create a new
              // instance with fromCache==false so that it&#39;s put back in the
              // cache if authentication succeeds
<span class="line-modified">!             AuthInfo res = fromcache ? new AuthInfo(false, scheme, pw, isUTF8) : this;</span>
              res.credentials = Objects.requireNonNull(pw);
              res.retries = retries;
              return res;
          }
      }
  
      @Override
      public HttpRequestImpl response(Response r) throws IOException {
          Cache cache = getCache(exchange);
          int status = r.statusCode();
          HttpHeaders hdrs = r.headers();
          HttpRequestImpl req = r.request();
  
<span class="line-modified">!         if (status != PROXY_UNAUTHORIZED) {</span>
              if (exchange.proxyauth != null &amp;&amp; !exchange.proxyauth.fromcache) {
                  AuthInfo au = exchange.proxyauth;
                  URI proxyURI = getProxyURI(req);
                  if (proxyURI != null) {
<span class="line-modified">!                     exchange.proxyauth = null;</span>
<span class="line-added">+                     cache.store(au.scheme, proxyURI, true, au.credentials, au.isUTF8);</span>
                  }
              }
<span class="line-modified">!             if (status != UNAUTHORIZED) {</span>
<span class="line-added">+                 // check if any authentication succeeded for first time</span>
<span class="line-added">+                 if (exchange.serverauth != null &amp;&amp; !exchange.serverauth.fromcache) {</span>
<span class="line-added">+                     AuthInfo au = exchange.serverauth;</span>
<span class="line-added">+                     cache.store(au.scheme, req.uri(), false, au.credentials, au.isUTF8);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 return null;</span>
<span class="line-added">+             }</span>
          }
  
          boolean proxy = status == PROXY_UNAUTHORIZED;
          String authname = proxy ? &quot;Proxy-Authenticate&quot; : &quot;WWW-Authenticate&quot;;
          List&lt;String&gt; authvals = hdrs.allValues(authname);
          if (authvals.isEmpty() &amp;&amp; exchange.client().authenticator().isPresent()) {
              throw new IOException(authname + &quot; header missing for response code &quot; + status);
          }
          String authval = null;
<span class="line-added">+         boolean isUTF8 = false;</span>
          for (String aval : authvals) {
              HeaderParser parser = new HeaderParser(aval);
              String scheme = parser.findKey(0);
              if (scheme.equalsIgnoreCase(&quot;Basic&quot;)) {
                  authval = aval;
<span class="line-added">+                 var charset = parser.findValue(&quot;charset&quot;);</span>
<span class="line-added">+                 isUTF8 = (charset != null &amp;&amp; charset.equalsIgnoreCase(&quot;UTF-8&quot;));</span>
                  break;
              }
          }
          if (authval == null) {
              return null;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 300,18 ***</span>
              PasswordAuthentication pw = getCredentials(authval, proxy, req);
              if (pw == null) {
                  throw new IOException(&quot;No credentials provided&quot;);
              }
              // No authentication in request. Get credentials from user
<span class="line-modified">!             au = new AuthInfo(false, &quot;Basic&quot;, pw);</span>
              if (proxy) {
                  exchange.proxyauth = au;
              } else {
                  exchange.serverauth = au;
              }
              req = HttpRequestImpl.newInstanceForAuthentication(req);
<span class="line-modified">!             addBasicCredentials(req, proxy, pw);</span>
              return req;
          } else if (au.retries &gt; retry_limit) {
              throw new IOException(&quot;too many authentication attempts. Limit: &quot; +
                      Integer.toString(retry_limit));
          } else {
<span class="line-new-header">--- 310,18 ---</span>
              PasswordAuthentication pw = getCredentials(authval, proxy, req);
              if (pw == null) {
                  throw new IOException(&quot;No credentials provided&quot;);
              }
              // No authentication in request. Get credentials from user
<span class="line-modified">!             au = new AuthInfo(false, &quot;Basic&quot;, pw, isUTF8);</span>
              if (proxy) {
                  exchange.proxyauth = au;
              } else {
                  exchange.serverauth = au;
              }
              req = HttpRequestImpl.newInstanceForAuthentication(req);
<span class="line-modified">!             addBasicCredentials(req, proxy, pw, isUTF8);</span>
              return req;
          } else if (au.retries &gt; retry_limit) {
              throw new IOException(&quot;too many authentication attempts. Limit: &quot; +
                      Integer.toString(retry_limit));
          } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 326,18 ***</span>
              // try again
              PasswordAuthentication pw = getCredentials(authval, proxy, req);
              if (pw == null) {
                  throw new IOException(&quot;No credentials provided&quot;);
              }
<span class="line-modified">!             au = au.retryWithCredentials(pw);</span>
              if (proxy) {
                  exchange.proxyauth = au;
              } else {
                  exchange.serverauth = au;
              }
              req = HttpRequestImpl.newInstanceForAuthentication(req);
<span class="line-modified">!             addBasicCredentials(req, proxy, au.credentials);</span>
              au.retries++;
              return req;
          }
      }
  
<span class="line-new-header">--- 336,18 ---</span>
              // try again
              PasswordAuthentication pw = getCredentials(authval, proxy, req);
              if (pw == null) {
                  throw new IOException(&quot;No credentials provided&quot;);
              }
<span class="line-modified">!             au = au.retryWithCredentials(pw, isUTF8);</span>
              if (proxy) {
                  exchange.proxyauth = au;
              } else {
                  exchange.serverauth = au;
              }
              req = HttpRequestImpl.newInstanceForAuthentication(req);
<span class="line-modified">!             addBasicCredentials(req, proxy, au.credentials, isUTF8);</span>
              au.retries++;
              return req;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 370,14 ***</span>
                  }
              }
              return null;
          }
  
          synchronized void remove(String authscheme, URI domain, boolean proxy) {
<span class="line-modified">!             for (CacheEntry entry : entries) {</span>
<span class="line-modified">!                 if (entry.equalsKey(domain, proxy)) {</span>
<span class="line-modified">!                     entries.remove(entry);</span>
                  }
              }
          }
  
          synchronized void remove(CacheEntry entry) {
<span class="line-new-header">--- 380,22 ---</span>
                  }
              }
              return null;
          }
  
<span class="line-added">+         private static boolean equalsIgnoreCase(String s1, String s2) {</span>
<span class="line-added">+             return s1 == s2 || (s1 != null &amp;&amp; s1.equalsIgnoreCase(s2));</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          synchronized void remove(String authscheme, URI domain, boolean proxy) {
<span class="line-modified">!             var iterator = entries.iterator();</span>
<span class="line-modified">!             while (iterator.hasNext()) {</span>
<span class="line-modified">!                 var entry = iterator.next();</span>
<span class="line-added">+                 if (equalsIgnoreCase(entry.scheme, authscheme)) {</span>
<span class="line-added">+                     if (entry.equalsKey(domain, proxy)) {</span>
<span class="line-added">+                         iterator.remove();</span>
<span class="line-added">+                     }</span>
                  }
              }
          }
  
          synchronized void remove(CacheEntry entry) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 385,13 ***</span>
          }
  
          synchronized void store(String authscheme,
                                  URI domain,
                                  boolean proxy,
<span class="line-modified">!                                 PasswordAuthentication value) {</span>
              remove(authscheme, domain, proxy);
<span class="line-modified">!             entries.add(new CacheEntry(authscheme, domain, proxy, value));</span>
          }
      }
  
      static URI normalize(URI uri, boolean isPrimaryKey) {
          String path = uri.getPath();
<span class="line-new-header">--- 403,13 ---</span>
          }
  
          synchronized void store(String authscheme,
                                  URI domain,
                                  boolean proxy,
<span class="line-modified">!                                 PasswordAuthentication value, boolean isUTF8) {</span>
              remove(authscheme, domain, proxy);
<span class="line-modified">!             entries.add(new CacheEntry(authscheme, domain, proxy, value, isUTF8));</span>
          }
      }
  
      static URI normalize(URI uri, boolean isPrimaryKey) {
          String path = uri.getPath();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 415,19 ***</span>
      static final class CacheEntry {
          final String root;
          final String scheme;
          final boolean proxy;
          final PasswordAuthentication value;
  
          CacheEntry(String authscheme,
                     URI uri,
                     boolean proxy,
<span class="line-modified">!                    PasswordAuthentication value) {</span>
              this.scheme = authscheme;
              this.root = normalize(uri, true).toString(); // remove extraneous components
              this.proxy = proxy;
              this.value = value;
          }
  
          public PasswordAuthentication value() {
              return value;
          }
<span class="line-new-header">--- 433,21 ---</span>
      static final class CacheEntry {
          final String root;
          final String scheme;
          final boolean proxy;
          final PasswordAuthentication value;
<span class="line-added">+         final boolean isUTF8;</span>
  
          CacheEntry(String authscheme,
                     URI uri,
                     boolean proxy,
<span class="line-modified">!                    PasswordAuthentication value, boolean isUTF8) {</span>
              this.scheme = authscheme;
              this.root = normalize(uri, true).toString(); // remove extraneous components
              this.proxy = proxy;
              this.value = value;
<span class="line-added">+             this.isUTF8 = isUTF8;</span>
          }
  
          public PasswordAuthentication value() {
              return value;
          }
</pre>
<center><a href="../../../../java/net/http/HttpResponse.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ConnectionPool.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>