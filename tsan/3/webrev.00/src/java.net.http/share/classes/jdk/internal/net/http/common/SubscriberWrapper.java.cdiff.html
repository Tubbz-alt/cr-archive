<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.net.http/share/classes/jdk/internal/net/http/common/SubscriberWrapper.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="SSLFlowDelegate.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Utils.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.net.http/share/classes/jdk/internal/net/http/common/SubscriberWrapper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,13 ***</span>
   */
  
  package jdk.internal.net.http.common;
  
  import java.io.Closeable;
<span class="line-removed">- import java.lang.System.Logger.Level;</span>
  import java.nio.ByteBuffer;
<span class="line-removed">- import java.util.ArrayList;</span>
  import java.util.List;
  import java.util.Objects;
  import java.util.concurrent.CompletableFuture;
  import java.util.concurrent.ConcurrentLinkedQueue;
  import java.util.concurrent.Flow;
<span class="line-new-header">--- 24,11 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 316,15 ***</span>
                      debug.log(&quot;DownstreamPusher: Pushing %d bytes downstream&quot;,
                                Utils.remaining(b));
                  downstreamSubscriber.onNext(b);
                  datasent = true;
              }
<span class="line-modified">!             if (datasent) upstreamWindowUpdate();</span>
              checkCompletion();
          }
      }
  
      void upstreamWindowUpdate() {
          long downstreamQueueSize = outputQ.size();
          long upstreamWindowSize = upstreamWindow.get();
          long n = upstreamWindowUpdate(upstreamWindowSize, downstreamQueueSize);
          if (debug.on())
<span class="line-new-header">--- 314,37 ---</span>
                      debug.log(&quot;DownstreamPusher: Pushing %d bytes downstream&quot;,
                                Utils.remaining(b));
                  downstreamSubscriber.onNext(b);
                  datasent = true;
              }
<span class="line-modified">! </span>
<span class="line-added">+             // If we have sent some decrypted data downstream,</span>
<span class="line-added">+             // or if:</span>
<span class="line-added">+             //    - there&#39;s nothing more available to send downstream</span>
<span class="line-added">+             //    - and we still have some demand from downstream</span>
<span class="line-added">+             //    - and upstream is not completed yet</span>
<span class="line-added">+             //    - and our demand from upstream has reached 0,</span>
<span class="line-added">+             // then check whether we should request more data from</span>
<span class="line-added">+             // upstream</span>
<span class="line-added">+             if (datasent || outputQ.isEmpty()</span>
<span class="line-added">+                     &amp;&amp; !downstreamSubscription.demand.isFulfilled()</span>
<span class="line-added">+                     &amp;&amp; !upstreamCompleted</span>
<span class="line-added">+                     &amp;&amp; upstreamWindow.get() == 0) {</span>
<span class="line-added">+                 upstreamWindowUpdate();</span>
<span class="line-added">+             }</span>
              checkCompletion();
          }
      }
  
<span class="line-added">+     final int outputQueueSize() {</span>
<span class="line-added">+         return outputQ.size();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     final boolean hasNoOutputData() {</span>
<span class="line-added">+         return outputQ.isEmpty();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      void upstreamWindowUpdate() {
          long downstreamQueueSize = outputQ.size();
          long upstreamWindowSize = upstreamWindow.get();
          long n = upstreamWindowUpdate(upstreamWindowSize, downstreamQueueSize);
          if (debug.on())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 339,11 ***</span>
      public void onSubscribe(Flow.Subscription subscription) {
          if (upstreamSubscription != null) {
              throw new IllegalStateException(&quot;Single shot publisher&quot;);
          }
          this.upstreamSubscription = subscription;
<span class="line-modified">!         upstreamRequest(upstreamWindowUpdate(0, 0));</span>
          if (debug.on())
              debug.log(&quot;calling downstreamSubscriber::onSubscribe on %s&quot;,
                        downstreamSubscriber);
          downstreamSubscriber.onSubscribe(downstreamSubscription);
          onSubscribe();
<span class="line-new-header">--- 359,11 ---</span>
      public void onSubscribe(Flow.Subscription subscription) {
          if (upstreamSubscription != null) {
              throw new IllegalStateException(&quot;Single shot publisher&quot;);
          }
          this.upstreamSubscription = subscription;
<span class="line-modified">!         upstreamRequest(initialUpstreamDemand());</span>
          if (debug.on())
              debug.log(&quot;calling downstreamSubscriber::onSubscribe on %s&quot;,
                        downstreamSubscriber);
          downstreamSubscriber.onSubscribe(downstreamSubscription);
          onSubscribe();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 354,19 ***</span>
          if (debug.on()) debug.log(&quot;onNext&quot;);
          long prev = upstreamWindow.getAndDecrement();
          if (prev &lt;= 0)
              throw new IllegalStateException(&quot;invalid onNext call&quot;);
          incomingCaller(item, false);
<span class="line-removed">-         upstreamWindowUpdate();</span>
      }
  
      private void upstreamRequest(long n) {
          if (debug.on()) debug.log(&quot;requesting %d&quot;, n);
          upstreamWindow.getAndAdd(n);
          upstreamSubscription.request(n);
      }
  
      protected void requestMore() {
          if (upstreamWindow.get() == 0) {
              upstreamRequest(1);
          }
      }
<span class="line-new-header">--- 374,28 ---</span>
          if (debug.on()) debug.log(&quot;onNext&quot;);
          long prev = upstreamWindow.getAndDecrement();
          if (prev &lt;= 0)
              throw new IllegalStateException(&quot;invalid onNext call&quot;);
          incomingCaller(item, false);
      }
  
      private void upstreamRequest(long n) {
          if (debug.on()) debug.log(&quot;requesting %d&quot;, n);
          upstreamWindow.getAndAdd(n);
          upstreamSubscription.request(n);
      }
  
<span class="line-added">+     /**</span>
<span class="line-added">+      * Initial demand that should be requested</span>
<span class="line-added">+      * from upstream when we get the upstream subscription</span>
<span class="line-added">+      * from {@link #onSubscribe(Flow.Subscription)}.</span>
<span class="line-added">+      * @return The initial demand to request from upstream.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     protected long initialUpstreamDemand() {</span>
<span class="line-added">+         return 1;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      protected void requestMore() {
          if (upstreamWindow.get() == 0) {
              upstreamRequest(1);
          }
      }
</pre>
<center><a href="SSLFlowDelegate.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Utils.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>