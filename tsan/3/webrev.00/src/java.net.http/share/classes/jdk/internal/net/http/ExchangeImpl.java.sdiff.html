<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.net.http/share/classes/jdk/internal/net/http/ExchangeImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ConnectionPool.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Http1HeaderParser.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.net.http/share/classes/jdk/internal/net/http/ExchangeImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.internal.net.http;
 27 
 28 import java.io.IOException;
<span class="line-removed"> 29 import java.util.concurrent.CompletableFuture;</span>
<span class="line-removed"> 30 import java.util.concurrent.Executor;</span>
<span class="line-removed"> 31 import java.util.function.Function;</span>
 32 import java.net.http.HttpClient;
 33 import java.net.http.HttpResponse;



 34 import jdk.internal.net.http.common.Logger;
 35 import jdk.internal.net.http.common.MinimalFuture;
 36 import jdk.internal.net.http.common.Utils;

 37 import static java.net.http.HttpClient.Version.HTTP_1_1;
 38 
 39 /**
 40  * Splits request so that headers and body can be sent separately with optional
 41  * (multiple) responses in between (e.g. 100 Continue). Also request and
 42  * response always sent/received in different calls.
 43  *
 44  * Synchronous and asynchronous versions of each method are provided.
 45  *
 46  * Separate implementations of this class exist for HTTP/1.1 and HTTP/2
 47  *      Http1Exchange   (HTTP/1.1)
 48  *      Stream          (HTTP/2)
 49  *
 50  * These implementation classes are where work is allocated to threads.
 51  */
 52 abstract class ExchangeImpl&lt;T&gt; {
 53 
 54     private static final Logger debug =
 55             Utils.getDebugLogger(&quot;ExchangeImpl&quot;::toString, Utils.DEBUG);
 56 
</pre>
<hr />
<pre>
 75      */
 76     abstract HttpConnection connection();
 77 
 78     /**
 79      * Initiates a new exchange and assigns it to a connection if one exists
 80      * already. connection usually null.
 81      */
 82     static &lt;U&gt; CompletableFuture&lt;? extends ExchangeImpl&lt;U&gt;&gt;
 83     get(Exchange&lt;U&gt; exchange, HttpConnection connection)
 84     {
 85         if (exchange.version() == HTTP_1_1) {
 86             if (debug.on())
 87                 debug.log(&quot;get: HTTP/1.1: new Http1Exchange&quot;);
 88             return createHttp1Exchange(exchange, connection);
 89         } else {
 90             Http2ClientImpl c2 = exchange.client().client2(); // #### improve
 91             HttpRequestImpl request = exchange.request();
 92             CompletableFuture&lt;Http2Connection&gt; c2f = c2.getConnectionFor(request, exchange);
 93             if (debug.on())
 94                 debug.log(&quot;get: Trying to get HTTP/2 connection&quot;);
<span class="line-modified"> 95             return c2f.handle((h2c, t) -&gt; createExchangeImpl(h2c, t, exchange, connection))</span>
<span class="line-modified"> 96                     .thenCompose(Function.identity());</span>


 97         }
 98     }
 99 
100     private static &lt;U&gt; CompletableFuture&lt;? extends ExchangeImpl&lt;U&gt;&gt;
101     createExchangeImpl(Http2Connection c,
102                        Throwable t,
103                        Exchange&lt;U&gt; exchange,
104                        HttpConnection connection)
105     {
106         if (debug.on())
107             debug.log(&quot;handling HTTP/2 connection creation result&quot;);
108         boolean secure = exchange.request().secure();
109         if (t != null) {
110             if (debug.on())
111                 debug.log(&quot;handling HTTP/2 connection creation failed: %s&quot;,
112                                  (Object)t);
113             t = Utils.getCompletionCause(t);
114             if (t instanceof Http2Connection.ALPNException) {
115                 Http2Connection.ALPNException ee = (Http2Connection.ALPNException)t;
116                 AbstractAsyncSSLConnection as = ee.getConnection();
</pre>
</td>
<td>
<hr />
<pre>
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.internal.net.http;
 27 
 28 import java.io.IOException;



 29 import java.net.http.HttpClient;
 30 import java.net.http.HttpResponse;
<span class="line-added"> 31 import java.util.concurrent.CompletableFuture;</span>
<span class="line-added"> 32 import java.util.concurrent.Executor;</span>
<span class="line-added"> 33 </span>
 34 import jdk.internal.net.http.common.Logger;
 35 import jdk.internal.net.http.common.MinimalFuture;
 36 import jdk.internal.net.http.common.Utils;
<span class="line-added"> 37 </span>
 38 import static java.net.http.HttpClient.Version.HTTP_1_1;
 39 
 40 /**
 41  * Splits request so that headers and body can be sent separately with optional
 42  * (multiple) responses in between (e.g. 100 Continue). Also request and
 43  * response always sent/received in different calls.
 44  *
 45  * Synchronous and asynchronous versions of each method are provided.
 46  *
 47  * Separate implementations of this class exist for HTTP/1.1 and HTTP/2
 48  *      Http1Exchange   (HTTP/1.1)
 49  *      Stream          (HTTP/2)
 50  *
 51  * These implementation classes are where work is allocated to threads.
 52  */
 53 abstract class ExchangeImpl&lt;T&gt; {
 54 
 55     private static final Logger debug =
 56             Utils.getDebugLogger(&quot;ExchangeImpl&quot;::toString, Utils.DEBUG);
 57 
</pre>
<hr />
<pre>
 76      */
 77     abstract HttpConnection connection();
 78 
 79     /**
 80      * Initiates a new exchange and assigns it to a connection if one exists
 81      * already. connection usually null.
 82      */
 83     static &lt;U&gt; CompletableFuture&lt;? extends ExchangeImpl&lt;U&gt;&gt;
 84     get(Exchange&lt;U&gt; exchange, HttpConnection connection)
 85     {
 86         if (exchange.version() == HTTP_1_1) {
 87             if (debug.on())
 88                 debug.log(&quot;get: HTTP/1.1: new Http1Exchange&quot;);
 89             return createHttp1Exchange(exchange, connection);
 90         } else {
 91             Http2ClientImpl c2 = exchange.client().client2(); // #### improve
 92             HttpRequestImpl request = exchange.request();
 93             CompletableFuture&lt;Http2Connection&gt; c2f = c2.getConnectionFor(request, exchange);
 94             if (debug.on())
 95                 debug.log(&quot;get: Trying to get HTTP/2 connection&quot;);
<span class="line-modified"> 96             // local variable required here; see JDK-8223553</span>
<span class="line-modified"> 97             CompletableFuture&lt;CompletableFuture&lt;? extends ExchangeImpl&lt;U&gt;&gt;&gt; fxi =</span>
<span class="line-added"> 98                 c2f.handle((h2c, t) -&gt; createExchangeImpl(h2c, t, exchange, connection));</span>
<span class="line-added"> 99             return fxi.thenCompose(x-&gt;x);</span>
100         }
101     }
102 
103     private static &lt;U&gt; CompletableFuture&lt;? extends ExchangeImpl&lt;U&gt;&gt;
104     createExchangeImpl(Http2Connection c,
105                        Throwable t,
106                        Exchange&lt;U&gt; exchange,
107                        HttpConnection connection)
108     {
109         if (debug.on())
110             debug.log(&quot;handling HTTP/2 connection creation result&quot;);
111         boolean secure = exchange.request().secure();
112         if (t != null) {
113             if (debug.on())
114                 debug.log(&quot;handling HTTP/2 connection creation failed: %s&quot;,
115                                  (Object)t);
116             t = Utils.getCompletionCause(t);
117             if (t instanceof Http2Connection.ALPNException) {
118                 Http2Connection.ALPNException ee = (Http2Connection.ALPNException)t;
119                 AbstractAsyncSSLConnection as = ee.getConnection();
</pre>
</td>
</tr>
</table>
<center><a href="ConnectionPool.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Http1HeaderParser.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>