<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.net.http/share/classes/jdk/internal/net/http/common/SSLFlowDelegate.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Log.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="SubscriberWrapper.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.net.http/share/classes/jdk/internal/net/http/common/SSLFlowDelegate.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -316,18 +316,23 @@</span>
              readBuf = newb;
          }
  
          @Override
          protected long upstreamWindowUpdate(long currentWindow, long downstreamQsize) {
<span class="udiff-line-modified-removed">-             if (readBuf.remaining() &gt; TARGET_BUFSIZE) {</span>
<span class="udiff-line-modified-removed">-                 if (debugr.on())</span>
<span class="udiff-line-modified-removed">-                     debugr.log(&quot;readBuf has more than TARGET_BUFSIZE: %d&quot;,</span>
<span class="udiff-line-modified-removed">-                             readBuf.remaining());</span>
<span class="udiff-line-modified-removed">-                 return 0;</span>
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-modified-removed">-                 return super.upstreamWindowUpdate(currentWindow, downstreamQsize);</span>
<span class="udiff-line-modified-added">+             if (needsMoreData()) {</span>
<span class="udiff-line-modified-added">+                 // run the scheduler to see if more data should be requested</span>
<span class="udiff-line-modified-added">+                 if (debugr.on()) {</span>
<span class="udiff-line-modified-added">+                     int remaining = readBuf.remaining();</span>
<span class="udiff-line-modified-added">+                     if (remaining &gt; TARGET_BUFSIZE) {</span>
<span class="udiff-line-modified-added">+                         // just some logging to check how much we have in the read buffer</span>
<span class="udiff-line-modified-added">+                         debugr.log(&quot;readBuf has more than TARGET_BUFSIZE: %d&quot;,</span>
<span class="udiff-line-added">+                                 remaining);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 scheduler.runOrSchedule();</span>
              }
<span class="udiff-line-added">+             return 0; // we will request more from the scheduler loop (processData).</span>
          }
  
          // readBuf is kept ready for reading outside of this method
          private void addToReadBuf(List&lt;ByteBuffer&gt; buffers, boolean complete) {
              assert Utils.remaining(buffers) &gt; 0 || buffers.isEmpty();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -366,10 +371,36 @@</span>
          // Usually this is 0, unless there was a buffer underflow.
          // In this case we need to wait for more bytes than what
          // we had before calling unwrap() again.
          volatile int minBytesRequired;
  
<span class="udiff-line-added">+         // We might need to request more data if:</span>
<span class="udiff-line-added">+         //  - we have a subscription from upstream</span>
<span class="udiff-line-added">+         //  - and we don&#39;t have enough data to decrypt in the read buffer</span>
<span class="udiff-line-added">+         //  - *and* - either we&#39;re handshaking, and more data is required (NEED_UNWRAP),</span>
<span class="udiff-line-added">+         //          - or we have demand from downstream, but we have nothing decrypted</span>
<span class="udiff-line-added">+         //            to forward downstream.</span>
<span class="udiff-line-added">+         boolean needsMoreData() {</span>
<span class="udiff-line-added">+             if (upstreamSubscription != null &amp;&amp; readBuf.remaining() &lt;= minBytesRequired &amp;&amp;</span>
<span class="udiff-line-added">+                     (engine.getHandshakeStatus() == HandshakeStatus.NEED_UNWRAP</span>
<span class="udiff-line-added">+                             || !downstreamSubscription.demand.isFulfilled() &amp;&amp; hasNoOutputData())) {</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // If the readBuf has not enough data, and we either need to</span>
<span class="udiff-line-added">+         // unwrap (handshaking) or we have demand from downstream,</span>
<span class="udiff-line-added">+         // then request more data</span>
<span class="udiff-line-added">+         void requestMoreDataIfNeeded() {</span>
<span class="udiff-line-added">+             if (needsMoreData()) {</span>
<span class="udiff-line-added">+                 // request more will only request more if our</span>
<span class="udiff-line-added">+                 // demand from upstream is fulfilled</span>
<span class="udiff-line-added">+                 requestMore();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          // work function where it all happens
          final void processData() {
              try {
                  if (debugr.on())
                      debugr.log(&quot;processData:&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -432,10 +463,11 @@</span>
                          if (complete &amp;&amp; result.status() == Status.CLOSED) {
                              if (debugr.on()) debugr.log(&quot;Closed: completing&quot;);
                              outgoing(Utils.EMPTY_BB_LIST, true);
                              // complete ALPN if not yet completed
                              setALPN();
<span class="udiff-line-added">+                             requestMoreDataIfNeeded();</span>
                              return;
                          }
                          if (result.handshaking()) {
                              handshaking = true;
                              if (debugr.on()) debugr.log(&quot;handshaking&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -449,12 +481,14 @@</span>
                      } catch (IOException ex) {
                          errorCommon(ex);
                          handleError(ex);
                          return;
                      }
<span class="udiff-line-modified-removed">-                     if (handshaking &amp;&amp; !complete)</span>
<span class="udiff-line-modified-added">+                     if (handshaking &amp;&amp; !complete) {</span>
<span class="udiff-line-added">+                         requestMoreDataIfNeeded();</span>
                          return;
<span class="udiff-line-added">+                     }</span>
                  }
                  if (!complete) {
                      synchronized (readBufferLock) {
                          complete = this.completing &amp;&amp; !readBuf.hasRemaining();
                      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -464,10 +498,12 @@</span>
                      // Complete the alpnCF, if not already complete, regardless of
                      // whether or not the ALPN is available, there will be no more
                      // activity.
                      setALPN();
                      outgoing(Utils.EMPTY_BB_LIST, true);
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     requestMoreDataIfNeeded();</span>
                  }
              } catch (Throwable ex) {
                  errorCommon(ex);
                  handleError(ex);
              }
</pre>
<center><a href="Log.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="SubscriberWrapper.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>