<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.net.http/share/classes/jdk/internal/net/http/ConnectionPool.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AuthenticationFilter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ExchangeImpl.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.net.http/share/classes/jdk/internal/net/http/ConnectionPool.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
121     }
122 
123     final String dbgString() {
124         return dbgTag;
125     }
126 
127     synchronized void start() {
128         assert !stopped : &quot;Already stopped&quot;;
129     }
130 
131     static CacheKey cacheKey(InetSocketAddress destination,
132                              InetSocketAddress proxy)
133     {
134         return new CacheKey(destination, proxy);
135     }
136 
137     synchronized HttpConnection getConnection(boolean secure,
138                                               InetSocketAddress addr,
139                                               InetSocketAddress proxy) {
140         if (stopped) return null;


141         CacheKey key = new CacheKey(addr, proxy);
142         HttpConnection c = secure ? findConnection(key, sslPool)
143                                   : findConnection(key, plainPool);
144         //System.out.println (&quot;getConnection returning: &quot; + c);

145         return c;
146     }
147 
148     /**
149      * Returns the connection to the pool.
150      */
151     void returnToPool(HttpConnection conn) {
152         returnToPool(conn, Instant.now(), KEEP_ALIVE);
153     }
154 
155     // Called also by whitebox tests
156     void returnToPool(HttpConnection conn, Instant now, long keepAlive) {
157 




158         // Don&#39;t call registerCleanupTrigger while holding a lock,
159         // but register it before the connection is added to the pool,
160         // since we don&#39;t want to trigger the cleanup if the connection
161         // is not in the pool.
162         CleanupTrigger cleanup = registerCleanupTrigger(conn);
163 
164         // it&#39;s possible that cleanup may have been called.
165         HttpConnection toClose = null;
166         synchronized(this) {
167             if (cleanup.isDone()) {
168                 return;
169             } else if (stopped) {
170                 conn.close();
171                 return;
172             }
173             if (MAX_POOL_SIZE &gt; 0 &amp;&amp; expiryList.size() &gt;= MAX_POOL_SIZE) {
174                 toClose = expiryList.removeOldest();
175                 if (toClose != null) removeFromPool(toClose);
176             }
177             if (conn instanceof PlainHttpConnection) {
</pre>
<hr />
<pre>
433         java.util.stream.Stream&lt;ExpiryEntry&gt; stream() {
434             return list.stream();
435         }
436 
437         // should only be called while holding a synchronization
438         // lock on the ConnectionPool
439         void clear() {
440             list.clear();
441             mayContainEntries = false;
442         }
443     }
444 
445     // Remove a connection from the pool.
446     // should only be called while holding a synchronization
447     // lock on the ConnectionPool
448     private void removeFromPool(HttpConnection c) {
449         assert Thread.holdsLock(this);
450         if (c instanceof PlainHttpConnection) {
451             removeFromPool(c, plainPool);
452         } else {
<span class="line-modified">453             assert c.isSecure();</span>
454             removeFromPool(c, sslPool);
455         }
456     }
457 
458     // Used by tests
459     synchronized boolean contains(HttpConnection c) {
460         final CacheKey key = c.cacheKey();
461         List&lt;HttpConnection&gt; list;
462         if ((list = plainPool.get(key)) != null) {
463             if (list.contains(c)) return true;
464         }
465         if ((list = sslPool.get(key)) != null) {
466             if (list.contains(c)) return true;
467         }
468         return false;
469     }
470 
471     void cleanup(HttpConnection c, Throwable error) {
472         if (debug.on())
473             debug.log(&quot;%s : ConnectionPool.cleanup(%s)&quot;,
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
121     }
122 
123     final String dbgString() {
124         return dbgTag;
125     }
126 
127     synchronized void start() {
128         assert !stopped : &quot;Already stopped&quot;;
129     }
130 
131     static CacheKey cacheKey(InetSocketAddress destination,
132                              InetSocketAddress proxy)
133     {
134         return new CacheKey(destination, proxy);
135     }
136 
137     synchronized HttpConnection getConnection(boolean secure,
138                                               InetSocketAddress addr,
139                                               InetSocketAddress proxy) {
140         if (stopped) return null;
<span class="line-added">141         // for plain (unsecure) proxy connection the destination address is irrelevant.</span>
<span class="line-added">142         addr = secure || proxy == null ? addr : null;</span>
143         CacheKey key = new CacheKey(addr, proxy);
144         HttpConnection c = secure ? findConnection(key, sslPool)
145                                   : findConnection(key, plainPool);
146         //System.out.println (&quot;getConnection returning: &quot; + c);
<span class="line-added">147         assert c == null || c.isSecure() == secure;</span>
148         return c;
149     }
150 
151     /**
152      * Returns the connection to the pool.
153      */
154     void returnToPool(HttpConnection conn) {
155         returnToPool(conn, Instant.now(), KEEP_ALIVE);
156     }
157 
158     // Called also by whitebox tests
159     void returnToPool(HttpConnection conn, Instant now, long keepAlive) {
160 
<span class="line-added">161         assert (conn instanceof PlainHttpConnection) || conn.isSecure()</span>
<span class="line-added">162             : &quot;Attempting to return unsecure connection to SSL pool: &quot;</span>
<span class="line-added">163                 + conn.getClass();</span>
<span class="line-added">164 </span>
165         // Don&#39;t call registerCleanupTrigger while holding a lock,
166         // but register it before the connection is added to the pool,
167         // since we don&#39;t want to trigger the cleanup if the connection
168         // is not in the pool.
169         CleanupTrigger cleanup = registerCleanupTrigger(conn);
170 
171         // it&#39;s possible that cleanup may have been called.
172         HttpConnection toClose = null;
173         synchronized(this) {
174             if (cleanup.isDone()) {
175                 return;
176             } else if (stopped) {
177                 conn.close();
178                 return;
179             }
180             if (MAX_POOL_SIZE &gt; 0 &amp;&amp; expiryList.size() &gt;= MAX_POOL_SIZE) {
181                 toClose = expiryList.removeOldest();
182                 if (toClose != null) removeFromPool(toClose);
183             }
184             if (conn instanceof PlainHttpConnection) {
</pre>
<hr />
<pre>
440         java.util.stream.Stream&lt;ExpiryEntry&gt; stream() {
441             return list.stream();
442         }
443 
444         // should only be called while holding a synchronization
445         // lock on the ConnectionPool
446         void clear() {
447             list.clear();
448             mayContainEntries = false;
449         }
450     }
451 
452     // Remove a connection from the pool.
453     // should only be called while holding a synchronization
454     // lock on the ConnectionPool
455     private void removeFromPool(HttpConnection c) {
456         assert Thread.holdsLock(this);
457         if (c instanceof PlainHttpConnection) {
458             removeFromPool(c, plainPool);
459         } else {
<span class="line-modified">460             assert c.isSecure() : &quot;connection &quot; + c + &quot; is not secure!&quot;;</span>
461             removeFromPool(c, sslPool);
462         }
463     }
464 
465     // Used by tests
466     synchronized boolean contains(HttpConnection c) {
467         final CacheKey key = c.cacheKey();
468         List&lt;HttpConnection&gt; list;
469         if ((list = plainPool.get(key)) != null) {
470             if (list.contains(c)) return true;
471         }
472         if ((list = sslPool.get(key)) != null) {
473             if (list.contains(c)) return true;
474         }
475         return false;
476     }
477 
478     void cleanup(HttpConnection c, Throwable error) {
479         if (debug.on())
480             debug.log(&quot;%s : ConnectionPool.cleanup(%s)&quot;,
</pre>
</td>
</tr>
</table>
<center><a href="AuthenticationFilter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ExchangeImpl.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>