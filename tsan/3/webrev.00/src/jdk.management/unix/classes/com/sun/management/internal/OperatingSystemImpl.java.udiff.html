<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.management/unix/classes/com/sun/management/internal/OperatingSystemImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../solaris/native/libmanagement_ext/UnixOperatingSystem.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../native/libmanagement_ext/OperatingSystemImpl.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.management/unix/classes/com/sun/management/internal/OperatingSystemImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2003, 2015, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2003, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,77 +23,175 @@</span>
   * questions.
   */
  
  package com.sun.management.internal;
  
<span class="udiff-line-added">+ import jdk.internal.platform.Metrics;</span>
  import sun.management.BaseOperatingSystemImpl;
  import sun.management.VMManagement;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import java.util.concurrent.TimeUnit;</span>
  /**
   * Implementation class for the operating system.
   * Standard and committed hotspot-specific metrics if any.
   *
   * ManagementFactory.getOperatingSystemMXBean() returns an instance
   * of this class.
   */
  class OperatingSystemImpl extends BaseOperatingSystemImpl
      implements com.sun.management.UnixOperatingSystemMXBean {
  
<span class="udiff-line-added">+     private static final int MAX_ATTEMPTS_NUMBER = 10;</span>
<span class="udiff-line-added">+     private final Metrics containerMetrics;</span>
<span class="udiff-line-added">+ </span>
      OperatingSystemImpl(VMManagement vm) {
          super(vm);
<span class="udiff-line-added">+         this.containerMetrics = jdk.internal.platform.Container.metrics();</span>
      }
  
      public long getCommittedVirtualMemorySize() {
          return getCommittedVirtualMemorySize0();
      }
  
      public long getTotalSwapSpaceSize() {
<span class="udiff-line-added">+         if (containerMetrics != null) {</span>
<span class="udiff-line-added">+             long limit = containerMetrics.getMemoryAndSwapLimit();</span>
<span class="udiff-line-added">+             // The memory limit metrics is not available if JVM runs on Linux host (not in a docker container)</span>
<span class="udiff-line-added">+             // or if a docker container was started without specifying a memory limit (without &#39;--memory=&#39;</span>
<span class="udiff-line-added">+             // Docker option). In latter case there is no limit on how much memory the container can use and</span>
<span class="udiff-line-added">+             // it can use as much memory as the host&#39;s OS allows.</span>
<span class="udiff-line-added">+             long memLimit = containerMetrics.getMemoryLimit();</span>
<span class="udiff-line-added">+             if (limit &gt;= 0 &amp;&amp; memLimit &gt;= 0) {</span>
<span class="udiff-line-added">+                 // we see a limit == 0 on some machines where &quot;kernel does not support swap limit capabilities&quot;</span>
<span class="udiff-line-added">+                 return (limit &lt; memLimit) ? 0 : limit - memLimit;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
          return getTotalSwapSpaceSize0();
      }
  
      public long getFreeSwapSpaceSize() {
<span class="udiff-line-added">+         if (containerMetrics != null) {</span>
<span class="udiff-line-added">+             long memSwapLimit = containerMetrics.getMemoryAndSwapLimit();</span>
<span class="udiff-line-added">+             long memLimit = containerMetrics.getMemoryLimit();</span>
<span class="udiff-line-added">+             if (memSwapLimit &gt;= 0 &amp;&amp; memLimit &gt;= 0) {</span>
<span class="udiff-line-added">+                 for (int attempt = 0; attempt &lt; MAX_ATTEMPTS_NUMBER; attempt++) {</span>
<span class="udiff-line-added">+                     long memSwapUsage = containerMetrics.getMemoryAndSwapUsage();</span>
<span class="udiff-line-added">+                     long memUsage = containerMetrics.getMemoryUsage();</span>
<span class="udiff-line-added">+                     if (memSwapUsage &gt; 0 &amp;&amp; memUsage &gt; 0) {</span>
<span class="udiff-line-added">+                         // We read &quot;memory usage&quot; and &quot;memory and swap usage&quot; not atomically,</span>
<span class="udiff-line-added">+                         // and it&#39;s possible to get the negative value when subtracting these two.</span>
<span class="udiff-line-added">+                         // If this happens just retry the loop for a few iterations.</span>
<span class="udiff-line-added">+                         if ((memSwapUsage - memUsage) &gt;= 0) {</span>
<span class="udiff-line-added">+                             return memSwapLimit - memLimit - (memSwapUsage - memUsage);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
          return getFreeSwapSpaceSize0();
      }
  
      public long getProcessCpuTime() {
          return getProcessCpuTime0();
      }
  
<span class="udiff-line-modified-removed">-     public long getFreePhysicalMemorySize() {</span>
<span class="udiff-line-modified-removed">-         return getFreePhysicalMemorySize0();</span>
<span class="udiff-line-modified-added">+     public long getFreeMemorySize() {</span>
<span class="udiff-line-modified-added">+         if (containerMetrics != null) {</span>
<span class="udiff-line-added">+             long usage = containerMetrics.getMemoryUsage();</span>
<span class="udiff-line-added">+             long limit = containerMetrics.getMemoryLimit();</span>
<span class="udiff-line-added">+             if (usage &gt; 0 &amp;&amp; limit &gt;= 0) {</span>
<span class="udiff-line-added">+                 return limit - usage;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return getFreeMemorySize0();</span>
      }
  
<span class="udiff-line-modified-removed">-     public long getTotalPhysicalMemorySize() {</span>
<span class="udiff-line-modified-removed">-         return getTotalPhysicalMemorySize0();</span>
<span class="udiff-line-modified-added">+     public long getTotalMemorySize() {</span>
<span class="udiff-line-modified-added">+         if (containerMetrics != null) {</span>
<span class="udiff-line-added">+             long limit = containerMetrics.getMemoryLimit();</span>
<span class="udiff-line-added">+             if (limit &gt;= 0) {</span>
<span class="udiff-line-added">+                 return limit;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return getTotalMemorySize0();</span>
      }
  
      public long getOpenFileDescriptorCount() {
          return getOpenFileDescriptorCount0();
      }
  
      public long getMaxFileDescriptorCount() {
          return getMaxFileDescriptorCount0();
      }
  
<span class="udiff-line-modified-removed">-     public double getSystemCpuLoad() {</span>
<span class="udiff-line-modified-removed">-         return getSystemCpuLoad0();</span>
<span class="udiff-line-modified-added">+     public double getCpuLoad() {</span>
<span class="udiff-line-modified-added">+         if (containerMetrics != null) {</span>
<span class="udiff-line-added">+             long quota = containerMetrics.getCpuQuota();</span>
<span class="udiff-line-added">+             if (quota &gt; 0) {</span>
<span class="udiff-line-added">+                 long periodLength = containerMetrics.getCpuPeriod();</span>
<span class="udiff-line-added">+                 long numPeriods = containerMetrics.getCpuNumPeriods();</span>
<span class="udiff-line-added">+                 long usageNanos = containerMetrics.getCpuUsage();</span>
<span class="udiff-line-added">+                 if (periodLength &gt; 0 &amp;&amp; numPeriods &gt; 0 &amp;&amp; usageNanos &gt; 0) {</span>
<span class="udiff-line-added">+                     long elapsedNanos = TimeUnit.MICROSECONDS.toNanos(periodLength * numPeriods);</span>
<span class="udiff-line-added">+                     double systemLoad = (double) usageNanos / elapsedNanos;</span>
<span class="udiff-line-added">+                     // Ensure the return value is in the range 0.0 -&gt; 1.0</span>
<span class="udiff-line-added">+                     systemLoad = Math.max(0.0, systemLoad);</span>
<span class="udiff-line-added">+                     systemLoad = Math.min(1.0, systemLoad);</span>
<span class="udiff-line-added">+                     return systemLoad;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 return -1;</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 // If CPU quotas are not active then find the average system load for</span>
<span class="udiff-line-added">+                 // all online CPUs that are allowed to run this container.</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 // If the cpuset is the same as the host&#39;s one there is no need to iterate over each CPU</span>
<span class="udiff-line-added">+                 if (isCpuSetSameAsHostCpuSet()) {</span>
<span class="udiff-line-added">+                     return getCpuLoad0();</span>
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     int[] cpuSet = containerMetrics.getEffectiveCpuSetCpus();</span>
<span class="udiff-line-added">+                     if (cpuSet != null &amp;&amp; cpuSet.length &gt; 0) {</span>
<span class="udiff-line-added">+                         double systemLoad = 0.0;</span>
<span class="udiff-line-added">+                         for (int cpu : cpuSet) {</span>
<span class="udiff-line-added">+                             double cpuLoad = getSingleCpuLoad0(cpu);</span>
<span class="udiff-line-added">+                             if (cpuLoad &lt; 0) {</span>
<span class="udiff-line-added">+                                 return -1;</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                             systemLoad += cpuLoad;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         return systemLoad / cpuSet.length;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     return -1;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return getCpuLoad0();</span>
      }
  
      public double getProcessCpuLoad() {
          return getProcessCpuLoad0();
      }
  
<span class="udiff-line-added">+     private boolean isCpuSetSameAsHostCpuSet() {</span>
<span class="udiff-line-added">+         if (containerMetrics != null &amp;&amp; containerMetrics.getCpuSetCpus() != null) {</span>
<span class="udiff-line-added">+             return containerMetrics.getCpuSetCpus().length == getHostConfiguredCpuCount0();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /* native methods */
      private native long getCommittedVirtualMemorySize0();
<span class="udiff-line-modified-removed">-     private native long getFreePhysicalMemorySize0();</span>
<span class="udiff-line-modified-added">+     private native long getFreeMemorySize0();</span>
      private native long getFreeSwapSpaceSize0();
      private native long getMaxFileDescriptorCount0();
      private native long getOpenFileDescriptorCount0();
      private native long getProcessCpuTime0();
      private native double getProcessCpuLoad0();
<span class="udiff-line-modified-removed">-     private native double getSystemCpuLoad0();</span>
<span class="udiff-line-modified-removed">-     private native long getTotalPhysicalMemorySize0();</span>
<span class="udiff-line-modified-added">+     private native double getCpuLoad0();</span>
<span class="udiff-line-modified-added">+     private native long getTotalMemorySize0();</span>
      private native long getTotalSwapSpaceSize0();
<span class="udiff-line-added">+     private native double getSingleCpuLoad0(int cpuNum);</span>
<span class="udiff-line-added">+     private native int getHostConfiguredCpuCount0();</span>
  
      static {
          initialize0();
      }
  
</pre>
<center><a href="../../../../../../solaris/native/libmanagement_ext/UnixOperatingSystem.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../native/libmanagement_ext/OperatingSystemImpl.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>