<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.xml/share/classes/com/sun/org/apache/xerces/internal/dom/CoreDOMImplementationImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 /*
  5  * Licensed to the Apache Software Foundation (ASF) under one or more
  6  * contributor license agreements.  See the NOTICE file distributed with
  7  * this work for additional information regarding copyright ownership.
  8  * The ASF licenses this file to You under the Apache License, Version 2.0
  9  * (the &quot;License&quot;); you may not use this file except in compliance with
 10  * the License.  You may obtain a copy of the License at
 11  *
 12  *      http://www.apache.org/licenses/LICENSE-2.0
 13  *
 14  * Unless required by applicable law or agreed to in writing, software
 15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 17  * See the License for the specific language governing permissions and
 18  * limitations under the License.
 19  */
 20 package com.sun.org.apache.xerces.internal.dom;
 21 
 22 import com.sun.org.apache.xerces.internal.impl.RevalidationHandler;
<a name="2" id="anc2"></a><span class="line-added"> 23 import com.sun.org.apache.xerces.internal.impl.dtd.XML11DTDProcessor;</span>
<span class="line-added"> 24 import com.sun.org.apache.xerces.internal.impl.dtd.XML11DTDValidator;</span>
<span class="line-added"> 25 import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDLoader;</span>
<span class="line-added"> 26 import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDValidator;</span>
<span class="line-added"> 27 import com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator;</span>
 28 import com.sun.org.apache.xerces.internal.parsers.DOMParserImpl;
 29 import com.sun.org.apache.xerces.internal.parsers.DTDConfiguration;
 30 import com.sun.org.apache.xerces.internal.parsers.XIncludeAwareParserConfiguration;
<a name="3" id="anc3"></a><span class="line-added"> 31 import com.sun.org.apache.xerces.internal.parsers.XML11DTDConfiguration;</span>
 32 import com.sun.org.apache.xerces.internal.util.XMLChar;
 33 import com.sun.org.apache.xerces.internal.xni.grammars.XMLGrammarDescription;
<a name="4" id="anc4"></a><span class="line-added"> 34 import java.lang.ref.SoftReference;</span>
 35 import org.w3c.dom.DOMException;
 36 import org.w3c.dom.DOMImplementation;
 37 import org.w3c.dom.Document;
 38 import org.w3c.dom.DocumentType;
 39 import org.w3c.dom.Element;
 40 import org.w3c.dom.ls.LSParser;
 41 import org.w3c.dom.ls.DOMImplementationLS;
 42 import org.w3c.dom.ls.LSInput;
 43 import org.w3c.dom.ls.LSOutput;
 44 import org.w3c.dom.ls.LSSerializer;
 45 /**
 46  * The DOMImplementation class is description of a particular
 47  * implementation of the Document Object Model. As such its data is
 48  * static, shared by all instances of this implementation.
 49  * &lt;P&gt;
 50  * The DOM API requires that it be a real object rather than static
 51  * methods. However, there&#39;s nothing that says it can&#39;t be a singleton,
 52  * so that&#39;s how I&#39;ve implemented it.
 53  * &lt;P&gt;
 54  * This particular class, along with CoreDocumentImpl, supports the DOM
 55  * Core and Load/Save (Experimental). Optional modules are supported by
 56  * the more complete DOMImplementation class along with DocumentImpl.
 57  *
 58  * @xerces.internal
 59  *
 60  * @since PR-DOM-Level-1-19980818.
<a name="5" id="anc5"></a><span class="line-added"> 61  * @LastModified: Apr 2019</span>
 62  */
<a name="6" id="anc6"></a><span class="line-added"> 63 @SuppressWarnings({&quot;rawtypes&quot;, &quot;unchecked&quot;}) //SoftReference array</span>
 64 public class CoreDOMImplementationImpl
 65         implements DOMImplementation, DOMImplementationLS {
<a name="7" id="anc7"></a>


 66 
<a name="8" id="anc8"></a><span class="line-modified"> 67     //</span>
<span class="line-added"> 68     // Data</span>
<span class="line-added"> 69     //</span>
<span class="line-added"> 70 </span>
<span class="line-added"> 71     // validator pools</span>
 72     private static final int SIZE = 2;
<a name="9" id="anc9"></a>
 73 
<a name="10" id="anc10"></a><span class="line-modified"> 74     private SoftReference schemaValidators[] = new SoftReference[SIZE];</span>
<span class="line-modified"> 75     private SoftReference xml10DTDValidators[] = new SoftReference[SIZE];</span>
<span class="line-modified"> 76     private SoftReference xml11DTDValidators[] = new SoftReference[SIZE];</span>
<span class="line-modified"> 77 </span>
<span class="line-added"> 78     private int freeSchemaValidatorIndex = -1;</span>
<span class="line-added"> 79     private int freeXML10DTDValidatorIndex = -1;</span>
<span class="line-added"> 80     private int freeXML11DTDValidatorIndex = -1;</span>
<span class="line-added"> 81 </span>
<span class="line-added"> 82     private int schemaValidatorsCurrentSize = SIZE;</span>
<span class="line-added"> 83     private int xml10DTDValidatorsCurrentSize = SIZE;</span>
<span class="line-added"> 84     private int xml11DTDValidatorsCurrentSize = SIZE;</span>
<span class="line-added"> 85 </span>
<span class="line-added"> 86     private SoftReference xml10DTDLoaders[] = new SoftReference[SIZE];</span>
<span class="line-added"> 87     private SoftReference xml11DTDLoaders[] = new SoftReference[SIZE];</span>
<span class="line-added"> 88 </span>
<span class="line-added"> 89     private int freeXML10DTDLoaderIndex = -1;</span>
<span class="line-added"> 90     private int freeXML11DTDLoaderIndex = -1;</span>
<span class="line-added"> 91 </span>
<span class="line-added"> 92     private int xml10DTDLoaderCurrentSize = SIZE;</span>
<span class="line-added"> 93     private int xml11DTDLoaderCurrentSize = SIZE;</span>
 94 
 95     // Document and doctype counter.  Used to assign order to documents and
 96     // doctypes without owners, on an demand basis.   Used for
 97     // compareDocumentPosition
 98     private int docAndDoctypeCounter = 0;
 99 
100         // static
101         /** Dom implementation singleton. */
<a name="11" id="anc11"></a><span class="line-modified">102         static final CoreDOMImplementationImpl singleton = new CoreDOMImplementationImpl();</span>
<span class="line-modified">103 </span>
104         //
105         // Public methods
106         //
107         /** NON-DOM: Obtain and return the single shared object */
108         public static DOMImplementation getDOMImplementation() {
109                 return singleton;
110         }
111         //
112         // DOMImplementation methods
113         //
114         /**
115          * Test if the DOM implementation supports a specific &quot;feature&quot; --
116          * currently meaning language and level thereof.
117          *
118          * @param feature The package name of the feature to test.
119          * In Level 1, supported values are &quot;HTML&quot; and &quot;XML&quot; (case-insensitive).
120          * At this writing, com.sun.org.apache.xerces.internal.dom supports only XML.
121          *
122          * @param version The version number of the feature being tested.
123          * This is interpreted as &quot;Version of the DOM API supported for the
124          * specified Feature&quot;, and in Level 1 should be &quot;1.0&quot;
125          *
126          * @return true if this implementation is compatible with the specified
127          * feature and version.
128          */
129         public boolean hasFeature(String feature, String version) {
130 
131             boolean anyVersion = version == null || version.length() == 0;
132 
133             if (feature.startsWith(&quot;+&quot;)) {
134                 feature = feature.substring(1);
135             }
136             return (feature.equalsIgnoreCase(&quot;Core&quot;)
<a name="12" id="anc12"></a><span class="line-modified">137                     &amp;&amp; (anyVersion</span>
<span class="line-modified">138                         || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">139                         || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">140                         || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">141                         || (feature.equalsIgnoreCase(&quot;XML&quot;)</span>
<span class="line-modified">142                     &amp;&amp; (anyVersion</span>
<span class="line-modified">143                         || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">144                         || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">145                         || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">146                         || (feature.equalsIgnoreCase(&quot;XMLVersion&quot;)</span>
<span class="line-modified">147                     &amp;&amp; (anyVersion</span>
<span class="line-modified">148                         || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">149                         || version.equals(&quot;1.1&quot;)))</span>
<span class="line-modified">150                         || (feature.equalsIgnoreCase(&quot;LS&quot;)</span>
<span class="line-modified">151                     &amp;&amp; (anyVersion</span>
<span class="line-added">152                         || version.equals(&quot;3.0&quot;)))</span>
<span class="line-added">153                         || (feature.equalsIgnoreCase(&quot;ElementTraversal&quot;)</span>
<span class="line-added">154                     &amp;&amp; (anyVersion</span>
<span class="line-added">155                         || version.equals(&quot;1.0&quot;)));</span>
156         } // hasFeature(String,String):boolean
157 
158 
159         /**
160          * Introduced in DOM Level 2. &lt;p&gt;
161          *
162          * Creates an empty DocumentType node.
163          *
164          * @param qualifiedName The qualified name of the document type to be created.
165          * @param publicID The document type public identifier.
166          * @param systemID The document type system identifier.
167          * @since WD-DOM-Level-2-19990923
168          */
169         public DocumentType createDocumentType( String qualifiedName,
170                                     String publicID, String systemID) {
171                 // REVISIT: this might allow creation of invalid name for DOCTYPE
172                 //          xmlns prefix.
173                 //          also there is no way for a user to turn off error checking.
174                 checkQName(qualifiedName);
175                 return new DocumentTypeImpl(null, qualifiedName, publicID, systemID);
176         }
177 
178     final void checkQName(String qname){
179         int index = qname.indexOf(&#39;:&#39;);
180         int lastIndex = qname.lastIndexOf(&#39;:&#39;);
181         int length = qname.length();
182 
183         // it is an error for NCName to have more than one &#39;:&#39;
184         // check if it is valid QName [Namespace in XML production 6]
185         if (index == 0 || index == length - 1 || lastIndex != index) {
186             String msg =
187                 DOMMessageFormatter.formatMessage(
188                     DOMMessageFormatter.DOM_DOMAIN,
189                     &quot;NAMESPACE_ERR&quot;,
190                     null);
191             throw new DOMException(DOMException.NAMESPACE_ERR, msg);
192         }
193         int start = 0;
194         // Namespace in XML production [6]
195         if (index &gt; 0) {
196             // check that prefix is NCName
197             if (!XMLChar.isNCNameStart(qname.charAt(start))) {
198                 String msg =
199                     DOMMessageFormatter.formatMessage(
200                         DOMMessageFormatter.DOM_DOMAIN,
201                         &quot;INVALID_CHARACTER_ERR&quot;,
202                         null);
203                 throw new DOMException(DOMException.INVALID_CHARACTER_ERR, msg);
204             }
205             for (int i = 1; i &lt; index; i++) {
206                 if (!XMLChar.isNCName(qname.charAt(i))) {
207                     String msg =
208                         DOMMessageFormatter.formatMessage(
209                             DOMMessageFormatter.DOM_DOMAIN,
210                             &quot;INVALID_CHARACTER_ERR&quot;,
211                             null);
212                     throw new DOMException(
213                         DOMException.INVALID_CHARACTER_ERR,
214                         msg);
215                 }
216             }
217             start = index + 1;
218         }
219 
220         // check local part
221         if (!XMLChar.isNCNameStart(qname.charAt(start))) {
222             // REVISIT: add qname parameter to the message
223             String msg =
224                 DOMMessageFormatter.formatMessage(
225                     DOMMessageFormatter.DOM_DOMAIN,
226                     &quot;INVALID_CHARACTER_ERR&quot;,
227                     null);
228             throw new DOMException(DOMException.INVALID_CHARACTER_ERR, msg);
229         }
230         for (int i = start + 1; i &lt; length; i++) {
231             if (!XMLChar.isNCName(qname.charAt(i))) {
232                 String msg =
233                     DOMMessageFormatter.formatMessage(
234                         DOMMessageFormatter.DOM_DOMAIN,
235                         &quot;INVALID_CHARACTER_ERR&quot;,
236                         null);
237                 throw new DOMException(DOMException.INVALID_CHARACTER_ERR, msg);
238             }
239         }
240     }
241 
242 
243         /**
244          * Introduced in DOM Level 2. &lt;p&gt;
245          *
246          * Creates an XML Document object of the specified type with its document
247          * element.
248          *
249          * @param namespaceURI     The namespace URI of the document
250          *                         element to create, or null.
251          * @param qualifiedName    The qualified name of the document
252          *                         element to create.
253          * @param doctype          The type of document to be created or null.&lt;p&gt;
254          *
255          *                         When doctype is not null, its
256          *                         Node.ownerDocument attribute is set to
257          *                         the document being created.
258          * @return Document        A new Document object.
259          * @throws DOMException    WRONG_DOCUMENT_ERR: Raised if doctype has
260          *                         already been used with a different document.
261          * @since WD-DOM-Level-2-19990923
262          */
263         public Document createDocument(
264                 String namespaceURI,
265                 String qualifiedName,
266                 DocumentType doctype)
267                 throws DOMException {
268                 if (doctype != null &amp;&amp; doctype.getOwnerDocument() != null) {
269                         String msg =
270                                 DOMMessageFormatter.formatMessage(
271                                         DOMMessageFormatter.DOM_DOMAIN,
272                                         &quot;WRONG_DOCUMENT_ERR&quot;,
273                                         null);
274                         throw new DOMException(DOMException.WRONG_DOCUMENT_ERR, msg);
275                 }
<a name="13" id="anc13"></a><span class="line-modified">276                 CoreDocumentImpl doc = createDocument(doctype);</span>
<span class="line-modified">277                 // If namespaceURI and qualifiedName are null return a Document with no document element.</span>
<span class="line-modified">278                 if (qualifiedName != null || namespaceURI != null) {</span>
<span class="line-added">279                     Element e = doc.createElementNS(namespaceURI, qualifiedName);</span>
<span class="line-added">280                     doc.appendChild(e);</span>
<span class="line-added">281                 }</span>
282                 return doc;
283         }
284 
<a name="14" id="anc14"></a><span class="line-added">285         protected CoreDocumentImpl createDocument(DocumentType doctype) {</span>
<span class="line-added">286             return new CoreDocumentImpl(doctype);</span>
<span class="line-added">287         }</span>
<span class="line-added">288 </span>
289         /**
290          * DOM Level 3 WD - Experimental.
291          */
292         public Object getFeature(String feature, String version) {
293             if (singleton.hasFeature(feature, version)) {
<a name="15" id="anc15"></a><span class="line-modified">294                     return singleton;</span>
<span class="line-modified">295                 }</span>
296             return null;
297         }
298 
299         // DOM L3 LS
300 
301         /**
302          * DOM Level 3 LS CR - Experimental.
303      * Create a new &lt;code&gt;LSParser&lt;/code&gt;. The newly constructed parser may
304      * then be configured by means of its &lt;code&gt;DOMConfiguration&lt;/code&gt;
305      * object, and used to parse documents by means of its &lt;code&gt;parse&lt;/code&gt;
306      *  method.
307      * @param mode  The &lt;code&gt;mode&lt;/code&gt; argument is either
308      *   &lt;code&gt;MODE_SYNCHRONOUS&lt;/code&gt; or &lt;code&gt;MODE_ASYNCHRONOUS&lt;/code&gt;, if
309      *   &lt;code&gt;mode&lt;/code&gt; is &lt;code&gt;MODE_SYNCHRONOUS&lt;/code&gt; then the
310      *   &lt;code&gt;LSParser&lt;/code&gt; that is created will operate in synchronous
311      *   mode, if it&#39;s &lt;code&gt;MODE_ASYNCHRONOUS&lt;/code&gt; then the
312      *   &lt;code&gt;LSParser&lt;/code&gt; that is created will operate in asynchronous
313      *   mode.
314      * @param schemaType  An absolute URI representing the type of the schema
315      *   language used during the load of a &lt;code&gt;Document&lt;/code&gt; using the
316      *   newly created &lt;code&gt;LSParser&lt;/code&gt;. Note that no lexical checking
317      *   is done on the absolute URI. In order to create a
318      *   &lt;code&gt;LSParser&lt;/code&gt; for any kind of schema types (i.e. the
319      *   LSParser will be free to use any schema found), use the value
320      *   &lt;code&gt;null&lt;/code&gt;.
321      * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    For W3C XML Schema [&lt;a href=&#39;http://www.w3.org/TR/2001/REC-xmlschema-1-20010502/&#39;&gt;XML Schema Part 1&lt;/a&gt;]
322      *   , applications must use the value
323      *   &lt;code&gt;&quot;http://www.w3.org/2001/XMLSchema&quot;&lt;/code&gt;. For XML DTD [&lt;a href=&#39;http://www.w3.org/TR/2000/REC-xml-20001006&#39;&gt;XML 1.0&lt;/a&gt;],
324      *   applications must use the value
325      *   &lt;code&gt;&quot;http://www.w3.org/TR/REC-xml&quot;&lt;/code&gt;. Other Schema languages
326      *   are outside the scope of the W3C and therefore should recommend an
327      *   absolute URI in order to use this method.
328      * @return  The newly created &lt;code&gt;LSParser&lt;/code&gt; object. This
329      *   &lt;code&gt;LSParser&lt;/code&gt; is either synchronous or asynchronous
330      *   depending on the value of the &lt;code&gt;mode&lt;/code&gt; argument.
331      * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created &lt;code&gt;LSParser&lt;/code&gt;
332      *    does not contain a &lt;code&gt;DOMErrorHandler&lt;/code&gt;, i.e. the value of
333      *   the &quot;&lt;a href=&#39;http://www.w3.org/TR/2003/WD-DOM-Level-3-Core-20030609/core.html#parameter-error-handler&#39;&gt;
334      *   error-handler&lt;/a&gt;&quot; configuration parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations
335      *   may provide a default error handler at creation time. In that case,
336      *   the initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration
337      *   parameter on the new created &lt;code&gt;LSParser&lt;/code&gt; contains a
338      *   reference to the default error handler.
339      * @exception DOMException
340      *    NOT_SUPPORTED_ERR: Raised if the requested mode or schema type is
341      *   not supported.
342          */
<a name="16" id="anc16"></a><span class="line-modified">343     public LSParser createLSParser(short mode, String schemaType)</span>
344                 throws DOMException {
345                 if (mode != DOMImplementationLS.MODE_SYNCHRONOUS || (schemaType !=null &amp;&amp;
346                    !&quot;http://www.w3.org/2001/XMLSchema&quot;.equals(schemaType) &amp;&amp;
347                         !&quot;http://www.w3.org/TR/REC-xml&quot;.equals(schemaType))) {
348                         String msg =
349                                 DOMMessageFormatter.formatMessage(
350                                         DOMMessageFormatter.DOM_DOMAIN,
351                                         &quot;NOT_SUPPORTED_ERR&quot;,
352                                         null);
353                         throw new DOMException(DOMException.NOT_SUPPORTED_ERR, msg);
354                 }
355                 if (schemaType != null
356                         &amp;&amp; schemaType.equals(&quot;http://www.w3.org/TR/REC-xml&quot;)) {
<a name="17" id="anc17"></a><span class="line-modified">357                         return new DOMParserImpl(new XML11DTDConfiguration(),</span>
358                                 schemaType);
359                 }
360                 else {
361                         // create default parser configuration validating against XMLSchemas
362                         return new DOMParserImpl(new XIncludeAwareParserConfiguration(),
363                                 schemaType);
364                 }
365         }
366 
<a name="18" id="anc18"></a><span class="line-modified">367     /**</span>
<span class="line-modified">368      * DOM Level 3 LS CR - Experimental.</span>
<span class="line-modified">369      * Create a new &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">370      * @return The newly created &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">371      * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created</span>
<span class="line-modified">372      * &lt;code&gt;LSSerializer&lt;/code&gt; has no &lt;code&gt;DOMErrorHandler&lt;/code&gt;,</span>
<span class="line-modified">373      * i.e. the value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">374      * parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations may</span>
<span class="line-modified">375      * provide a default error handler at creation time. In that case, the</span>
<span class="line-modified">376      * initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">377      * parameter on the new created &lt;code&gt;LSSerializer&lt;/code&gt; contains a</span>
<span class="line-modified">378      * reference to the default error handler.</span>
<span class="line-modified">379      */</span>
<span class="line-modified">380     public LSSerializer createLSSerializer() {</span>
381             return new com.sun.org.apache.xml.internal.serializer.dom3.LSSerializerImpl();
382         }
383 
384         /**
385          * DOM Level 3 LS CR - Experimental.
386          * Create a new empty input source.
387          * @return  The newly created input object.
388          */
389         public LSInput createLSInput() {
390                 return new DOMInputImpl();
391         }
392 
393         //
394         // Protected methods
395         //
396         /** NON-DOM: retrieve validator. */
<a name="19" id="anc19"></a><span class="line-modified">397         synchronized RevalidationHandler getValidator(String schemaType, String xmlVersion) {</span>

398         if (schemaType == XMLGrammarDescription.XML_SCHEMA) {
399             // create new validator - we should not attempt
400             // to restrict the number of validation handlers being
401             // requested
<a name="20" id="anc20"></a><span class="line-modified">402             while (freeSchemaValidatorIndex &gt;= 0) {</span>
<span class="line-modified">403                 // return first available validator</span>
<span class="line-added">404                 SoftReference ref = schemaValidators[freeSchemaValidatorIndex];</span>
<span class="line-added">405                 RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">406                 if (holder != null &amp;&amp; holder.handler != null) {</span>
<span class="line-added">407                     RevalidationHandler val = holder.handler;</span>
<span class="line-added">408                     holder.handler = null;</span>
<span class="line-added">409                     --freeSchemaValidatorIndex;</span>
<span class="line-added">410                     return val;</span>
<span class="line-added">411                 }</span>
<span class="line-added">412                 schemaValidators[freeSchemaValidatorIndex--] = null;</span>
413             }
<a name="21" id="anc21"></a><span class="line-modified">414             return new XMLSchemaValidator();</span>



415         }
416         else if(schemaType == XMLGrammarDescription.XML_DTD) {
<a name="22" id="anc22"></a><span class="line-modified">417             // return an instance of XML11DTDValidator</span>
<span class="line-modified">418             if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-added">419                 while (freeXML11DTDValidatorIndex &gt;= 0) {</span>
<span class="line-added">420                     // return first available validator</span>
<span class="line-added">421                     SoftReference ref = xml11DTDValidators[freeXML11DTDValidatorIndex];</span>
<span class="line-added">422                     RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">423                     if (holder != null &amp;&amp; holder.handler != null) {</span>
<span class="line-added">424                         RevalidationHandler val = holder.handler;</span>
<span class="line-added">425                         holder.handler = null;</span>
<span class="line-added">426                         --freeXML11DTDValidatorIndex;</span>
<span class="line-added">427                         return val;</span>
<span class="line-added">428                     }</span>
<span class="line-added">429                     xml11DTDValidators[freeXML11DTDValidatorIndex--] = null;</span>
<span class="line-added">430                 }</span>
<span class="line-added">431                 return new XML11DTDValidator();</span>
<span class="line-added">432             }</span>
<span class="line-added">433             // return an instance of XMLDTDValidator</span>
<span class="line-added">434             else {</span>
<span class="line-added">435                 while (freeXML10DTDValidatorIndex &gt;= 0) {</span>
<span class="line-added">436                     // return first available validator</span>
<span class="line-added">437                     SoftReference ref = xml10DTDValidators[freeXML10DTDValidatorIndex];</span>
<span class="line-added">438                     RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">439                     if (holder != null &amp;&amp; holder.handler != null) {</span>
<span class="line-added">440                         RevalidationHandler val = holder.handler;</span>
<span class="line-added">441                         holder.handler = null;</span>
<span class="line-added">442                         --freeXML10DTDValidatorIndex;</span>
<span class="line-added">443                         return val;</span>
<span class="line-added">444                     }</span>
<span class="line-added">445                     xml10DTDValidators[freeXML10DTDValidatorIndex--] = null;</span>
<span class="line-added">446                 }</span>
<span class="line-added">447                 return new XMLDTDValidator();</span>
448             }
<a name="23" id="anc23"></a>



449         }
450         return null;
451         }
452 
453         /** NON-DOM: release validator */
<a name="24" id="anc24"></a><span class="line-modified">454         synchronized void releaseValidator(String schemaType, String xmlVersion,</span>
<span class="line-modified">455                 RevalidationHandler validator) {</span>
<span class="line-modified">456             if (schemaType == XMLGrammarDescription.XML_SCHEMA) {</span>
<span class="line-modified">457                 ++freeSchemaValidatorIndex;</span>
<span class="line-modified">458                 if (schemaValidators.length == freeSchemaValidatorIndex) {</span>
<span class="line-modified">459                     // resize size of the validators</span>
<span class="line-modified">460                     schemaValidatorsCurrentSize += SIZE;</span>
<span class="line-modified">461                     SoftReference newarray[] =  new SoftReference[schemaValidatorsCurrentSize];</span>
<span class="line-modified">462                     System.arraycopy(schemaValidators, 0, newarray, 0, schemaValidators.length);</span>
<span class="line-modified">463                     schemaValidators = newarray;</span>
<span class="line-modified">464                 }</span>
<span class="line-modified">465                 SoftReference ref = schemaValidators[freeSchemaValidatorIndex];</span>
<span class="line-modified">466                 if (ref != null) {</span>
<span class="line-modified">467                     RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-modified">468                     if (holder != null) {</span>
<span class="line-modified">469                         holder.handler = validator;</span>
<span class="line-modified">470                         return;</span>
<span class="line-modified">471                     }</span>
<span class="line-modified">472                 }</span>
<span class="line-modified">473                 schemaValidators[freeSchemaValidatorIndex] = new SoftReference(new RevalidationHandlerHolder(validator));</span>
<span class="line-modified">474             }</span>
<span class="line-modified">475             else if (schemaType == XMLGrammarDescription.XML_DTD) {</span>
<span class="line-modified">476                 // release an instance of XML11DTDValidator</span>
<span class="line-modified">477                 if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-modified">478                     ++freeXML11DTDValidatorIndex;</span>
<span class="line-added">479                     if (xml11DTDValidators.length == freeXML11DTDValidatorIndex) {</span>
<span class="line-added">480                         // resize size of the validators</span>
<span class="line-added">481                         xml11DTDValidatorsCurrentSize += SIZE;</span>
<span class="line-added">482                         SoftReference [] newarray = new SoftReference[xml11DTDValidatorsCurrentSize];</span>
<span class="line-added">483                         System.arraycopy(xml11DTDValidators, 0, newarray, 0, xml11DTDValidators.length);</span>
<span class="line-added">484                         xml11DTDValidators = newarray;</span>
<span class="line-added">485                     }</span>
<span class="line-added">486                     SoftReference ref = xml11DTDValidators[freeXML11DTDValidatorIndex];</span>
<span class="line-added">487                     if (ref != null) {</span>
<span class="line-added">488                         RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">489                         if (holder != null) {</span>
<span class="line-added">490                             holder.handler = validator;</span>
<span class="line-added">491                             return;</span>
<span class="line-added">492                         }</span>
<span class="line-added">493                     }</span>
<span class="line-added">494                     xml11DTDValidators[freeXML11DTDValidatorIndex] = new SoftReference(new RevalidationHandlerHolder(validator));</span>
<span class="line-added">495                 }</span>
<span class="line-added">496                 // release an instance of XMLDTDValidator</span>
<span class="line-added">497                 else {</span>
<span class="line-added">498                     ++freeXML10DTDValidatorIndex;</span>
<span class="line-added">499                     if (xml10DTDValidators.length == freeXML10DTDValidatorIndex) {</span>
<span class="line-added">500                         // resize size of the validators</span>
<span class="line-added">501                         xml10DTDValidatorsCurrentSize += SIZE;</span>
<span class="line-added">502                         SoftReference [] newarray = new SoftReference[xml10DTDValidatorsCurrentSize];</span>
<span class="line-added">503                         System.arraycopy(xml10DTDValidators, 0, newarray, 0, xml10DTDValidators.length);</span>
<span class="line-added">504                         xml10DTDValidators = newarray;</span>
<span class="line-added">505                     }</span>
<span class="line-added">506                     SoftReference ref = xml10DTDValidators[freeXML10DTDValidatorIndex];</span>
<span class="line-added">507                     if (ref != null) {</span>
<span class="line-added">508                         RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">509                         if (holder != null) {</span>
<span class="line-added">510                             holder.handler = validator;</span>
<span class="line-added">511                             return;</span>
<span class="line-added">512                         }</span>
<span class="line-added">513                     }</span>
<span class="line-added">514                     xml10DTDValidators[freeXML10DTDValidatorIndex] = new SoftReference(new RevalidationHandlerHolder(validator));</span>
<span class="line-added">515                 }</span>
<span class="line-added">516             }</span>
517         }
518 
<a name="25" id="anc25"></a><span class="line-modified">519     /** NON-DOM: retrieve DTD loader */</span>
<span class="line-modified">520     synchronized final XMLDTDLoader getDTDLoader(String xmlVersion) {</span>
<span class="line-modified">521         // return an instance of XML11DTDProcessor</span>
<span class="line-modified">522         if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-modified">523             while (freeXML11DTDLoaderIndex &gt;= 0) {</span>
<span class="line-modified">524                 // return first available DTD loader</span>
<span class="line-modified">525                 SoftReference ref = xml11DTDLoaders[freeXML11DTDLoaderIndex];</span>
<span class="line-modified">526                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">527                 if (holder != null &amp;&amp; holder.loader != null) {</span>
<span class="line-added">528                     XMLDTDLoader val = holder.loader;</span>
<span class="line-added">529                     holder.loader = null;</span>
<span class="line-added">530                     --freeXML11DTDLoaderIndex;</span>
<span class="line-added">531                     return val;</span>
<span class="line-added">532                 }</span>
<span class="line-added">533                 xml11DTDLoaders[freeXML11DTDLoaderIndex--] = null;</span>
<span class="line-added">534             }</span>
<span class="line-added">535             return new XML11DTDProcessor();</span>
<span class="line-added">536         }</span>
<span class="line-added">537         // return an instance of XMLDTDLoader</span>
<span class="line-added">538         else {</span>
<span class="line-added">539             while (freeXML10DTDLoaderIndex &gt;= 0) {</span>
<span class="line-added">540                 // return first available DTD loader</span>
<span class="line-added">541                 SoftReference ref = xml10DTDLoaders[freeXML10DTDLoaderIndex];</span>
<span class="line-added">542                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">543                 if (holder != null &amp;&amp; holder.loader != null) {</span>
<span class="line-added">544                     XMLDTDLoader val = holder.loader;</span>
<span class="line-added">545                     holder.loader = null;</span>
<span class="line-added">546                     --freeXML10DTDLoaderIndex;</span>
<span class="line-added">547                     return val;</span>
<span class="line-added">548                 }</span>
<span class="line-added">549                 xml10DTDLoaders[freeXML10DTDLoaderIndex--] = null;</span>
<span class="line-added">550             }</span>
<span class="line-added">551             return new XMLDTDLoader();</span>
<span class="line-added">552         }</span>
<span class="line-added">553     }</span>
<span class="line-added">554 </span>
<span class="line-added">555     /** NON-DOM: release DTD loader */</span>
<span class="line-added">556     synchronized final void releaseDTDLoader(String xmlVersion, XMLDTDLoader loader) {</span>
<span class="line-added">557         // release an instance of XMLDTDLoader</span>
<span class="line-added">558         if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-added">559             ++freeXML11DTDLoaderIndex;</span>
<span class="line-added">560             if (xml11DTDLoaders.length == freeXML11DTDLoaderIndex) {</span>
<span class="line-added">561                 // resize size of the DTD loaders</span>
<span class="line-added">562                 xml11DTDLoaderCurrentSize += SIZE;</span>
<span class="line-added">563                 SoftReference [] newarray = new SoftReference[xml11DTDLoaderCurrentSize];</span>
<span class="line-added">564                 System.arraycopy(xml11DTDLoaders, 0, newarray, 0, xml11DTDLoaders.length);</span>
<span class="line-added">565                 xml11DTDLoaders = newarray;</span>
<span class="line-added">566             }</span>
<span class="line-added">567             SoftReference ref = xml11DTDLoaders[freeXML11DTDLoaderIndex];</span>
<span class="line-added">568             if (ref != null) {</span>
<span class="line-added">569                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">570                 if (holder != null) {</span>
<span class="line-added">571                     holder.loader = loader;</span>
<span class="line-added">572                     return;</span>
<span class="line-added">573                 }</span>
<span class="line-added">574             }</span>
<span class="line-added">575             xml11DTDLoaders[freeXML11DTDLoaderIndex] = new SoftReference(new XMLDTDLoaderHolder(loader));</span>
<span class="line-added">576         }</span>
<span class="line-added">577         // release an instance of XMLDTDLoader</span>
<span class="line-added">578         else {</span>
<span class="line-added">579             ++freeXML10DTDLoaderIndex;</span>
<span class="line-added">580             if (xml10DTDLoaders.length == freeXML10DTDLoaderIndex) {</span>
<span class="line-added">581                 // resize size of the DTD loaders</span>
<span class="line-added">582                 xml10DTDLoaderCurrentSize += SIZE;</span>
<span class="line-added">583                 SoftReference [] newarray = new SoftReference[xml10DTDLoaderCurrentSize];</span>
<span class="line-added">584                 System.arraycopy(xml10DTDLoaders, 0, newarray, 0, xml10DTDLoaders.length);</span>
<span class="line-added">585                 xml10DTDLoaders = newarray;</span>
<span class="line-added">586             }</span>
<span class="line-added">587             SoftReference ref = xml10DTDLoaders[freeXML10DTDLoaderIndex];</span>
<span class="line-added">588             if (ref != null) {</span>
<span class="line-added">589                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">590                 if (holder != null) {</span>
<span class="line-added">591                     holder.loader = loader;</span>
<span class="line-added">592                     return;</span>
<span class="line-added">593                 }</span>
<span class="line-added">594             }</span>
<span class="line-added">595             xml10DTDLoaders[freeXML10DTDLoaderIndex] = new SoftReference(new XMLDTDLoaderHolder(loader));</span>
<span class="line-added">596         }</span>
<span class="line-added">597     }</span>
<span class="line-added">598 </span>
<span class="line-added">599     /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-added">600     protected synchronized int assignDocumentNumber() {</span>
<span class="line-added">601         return ++docAndDoctypeCounter;</span>
<span class="line-added">602     }</span>
<span class="line-added">603 </span>
<span class="line-added">604     /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-added">605     protected synchronized int assignDocTypeNumber() {</span>
<span class="line-added">606         return ++docAndDoctypeCounter;</span>
<span class="line-added">607     }</span>
608 
609     /* DOM Level 3 LS CR - Experimental.
610      *
611      * Create a new empty output destination object where
612      * &lt;code&gt;LSOutput.characterStream&lt;/code&gt;,
613      * &lt;code&gt;LSOutput.byteStream&lt;/code&gt;, &lt;code&gt;LSOutput.systemId&lt;/code&gt;,
614      * &lt;code&gt;LSOutput.encoding&lt;/code&gt; are null.
<a name="26" id="anc26"></a>
615      * @return  The newly created output object.
<a name="27" id="anc27"></a><span class="line-added">616     */</span>
<span class="line-added">617     public LSOutput createLSOutput() {</span>
<span class="line-added">618         return new DOMOutputImpl();</span>
<span class="line-added">619     }</span>
<span class="line-added">620 </span>
<span class="line-added">621     /**</span>
<span class="line-added">622      * A holder for RevalidationHandlers. This allows us to reuse</span>
<span class="line-added">623      * SoftReferences which haven&#39;t yet been cleared by the garbage</span>
<span class="line-added">624      * collector.</span>
625      */
<a name="28" id="anc28"></a><span class="line-modified">626     static final class RevalidationHandlerHolder {</span>
<span class="line-modified">627         RevalidationHandlerHolder(RevalidationHandler handler) {</span>
<span class="line-modified">628             this.handler = handler;</span>
<span class="line-added">629         }</span>
<span class="line-added">630         RevalidationHandler handler;</span>
<span class="line-added">631     }</span>
<span class="line-added">632 </span>
<span class="line-added">633     /**</span>
<span class="line-added">634      * A holder for XMLDTDLoaders. This allows us to reuse SoftReferences</span>
<span class="line-added">635      * which haven&#39;t yet been cleared by the garbage collector.</span>
<span class="line-added">636      */</span>
<span class="line-added">637     static final class XMLDTDLoaderHolder {</span>
<span class="line-added">638         XMLDTDLoaderHolder(XMLDTDLoader loader) {</span>
<span class="line-added">639             this.loader = loader;</span>
<span class="line-added">640         }</span>
<span class="line-added">641         XMLDTDLoader loader;</span>
<span class="line-added">642     }</span>
643 
644 } // class DOMImplementationImpl
<a name="29" id="anc29"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="29" type="hidden" />
</body>
</html>