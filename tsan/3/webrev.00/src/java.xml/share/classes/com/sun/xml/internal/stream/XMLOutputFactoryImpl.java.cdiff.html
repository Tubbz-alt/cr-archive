<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.xml/share/classes/com/sun/xml/internal/stream/XMLOutputFactoryImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StaxXMLInputSource.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="writers/XMLEventWriterImpl.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml/share/classes/com/sun/xml/internal/stream/XMLOutputFactoryImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2005, 2006, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,33 ***</span>
   * questions.
   */
  
  package com.sun.xml.internal.stream;
  
<span class="line-removed">- import java.io.File;</span>
<span class="line-removed">- import java.io.FileWriter;</span>
  import java.io.IOException;
  import java.io.OutputStream;
  import java.io.Writer;
<span class="line-modified">! </span>
<span class="line-modified">! import javax.xml.stream.XMLOutputFactory ;</span>
  import javax.xml.stream.XMLStreamException;
  import javax.xml.transform.Result;
  import javax.xml.transform.dom.DOMResult;
  import javax.xml.transform.stream.StreamResult;
  import javax.xml.transform.stax.StAXResult;
  import com.sun.org.apache.xerces.internal.impl.Constants;
  import com.sun.org.apache.xerces.internal.impl.PropertyManager;
<span class="line-removed">- </span>
  import com.sun.xml.internal.stream.writers.XMLDOMWriterImpl;
  import com.sun.xml.internal.stream.writers.XMLEventWriterImpl;
  import com.sun.xml.internal.stream.writers.XMLStreamWriterImpl;
  
  /**
   * This class provides the implementation of XMLOutputFactory.
   *
<span class="line-modified">!  * @author  Neeraj Bajaj,</span>
   * @author k venugopal
   */
  public class XMLOutputFactoryImpl extends XMLOutputFactory {
  
      //List of supported properties and default values.
<span class="line-new-header">--- 23,31 ---</span>
   * questions.
   */
  
  package com.sun.xml.internal.stream;
  
  import java.io.IOException;
  import java.io.OutputStream;
  import java.io.Writer;
<span class="line-modified">! import javax.xml.stream.XMLEventWriter;</span>
<span class="line-modified">! import javax.xml.stream.XMLOutputFactory;</span>
  import javax.xml.stream.XMLStreamException;
<span class="line-added">+ import javax.xml.stream.XMLStreamWriter;</span>
  import javax.xml.transform.Result;
  import javax.xml.transform.dom.DOMResult;
  import javax.xml.transform.stream.StreamResult;
  import javax.xml.transform.stax.StAXResult;
  import com.sun.org.apache.xerces.internal.impl.Constants;
  import com.sun.org.apache.xerces.internal.impl.PropertyManager;
  import com.sun.xml.internal.stream.writers.XMLDOMWriterImpl;
  import com.sun.xml.internal.stream.writers.XMLEventWriterImpl;
  import com.sun.xml.internal.stream.writers.XMLStreamWriterImpl;
  
  /**
   * This class provides the implementation of XMLOutputFactory.
   *
<span class="line-modified">!  * @author Neeraj Bajaj,</span>
   * @author k venugopal
   */
  public class XMLOutputFactoryImpl extends XMLOutputFactory {
  
      //List of supported properties and default values.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 61,139 ***</span>
      /**
       * TODO: at the current time, XMLStreamWriters are not Thread safe.
       */
      boolean fReuseInstance = false;
  
<span class="line-modified">!     /** Creates a new instance of XMLOutputFactory */</span>
      public XMLOutputFactoryImpl() {
      }
  
<span class="line-modified">!     public javax.xml.stream.XMLEventWriter createXMLEventWriter(java.io.OutputStream outputStream) throws javax.xml.stream.XMLStreamException {</span>
<span class="line-modified">!         return createXMLEventWriter(outputStream,  null);</span>
      }
  
<span class="line-modified">!     public javax.xml.stream.XMLEventWriter createXMLEventWriter(java.io.OutputStream outputStream, String encoding) throws javax.xml.stream.XMLStreamException {</span>
          return new XMLEventWriterImpl(createXMLStreamWriter(outputStream, encoding));
      }
  
<span class="line-modified">!     public javax.xml.stream.XMLEventWriter createXMLEventWriter(javax.xml.transform.Result result) throws javax.xml.stream.XMLStreamException {</span>
  
<span class="line-modified">!         if (result instanceof StAXResult &amp;&amp; ((StAXResult)result).getXMLEventWriter() != null)</span>
<span class="line-modified">!             return ((StAXResult)result).getXMLEventWriter();</span>
  
          return new XMLEventWriterImpl(createXMLStreamWriter(result));
      }
  
<span class="line-modified">!     public javax.xml.stream.XMLEventWriter createXMLEventWriter(java.io.Writer writer) throws javax.xml.stream.XMLStreamException {</span>
          return new XMLEventWriterImpl(createXMLStreamWriter(writer));
      }
  
<span class="line-modified">!     public javax.xml.stream.XMLStreamWriter createXMLStreamWriter(javax.xml.transform.Result result) throws javax.xml.stream.XMLStreamException {</span>
  
          if (result instanceof StreamResult) {
              return createXMLStreamWriter((StreamResult) result, null);
          } else if (result instanceof DOMResult) {
              return new XMLDOMWriterImpl((DOMResult) result);
          } else if (result instanceof StAXResult) {
              if (((StAXResult) result).getXMLStreamWriter() != null) {
                  return ((StAXResult) result).getXMLStreamWriter();
              } else {
<span class="line-modified">!                 throw new java.lang.UnsupportedOperationException(&quot;Result of type &quot; + result + &quot; is not supported&quot;);</span>
              }
          } else {
<span class="line-modified">!             if (result.getSystemId() !=null) {</span>
<span class="line-modified">!                 //this is not correct impl of SAXResult. Keep it for now for compatibility</span>
<span class="line-modified">!                 return createXMLStreamWriter(new StreamResult(result.getSystemId()));</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 throw new java.lang.UnsupportedOperationException(&quot;Result of type &quot; + result + &quot; is not supported. &quot; +</span>
<span class="line-removed">-                         &quot;Supported result types are: DOMResult, StAXResult and StreamResult.&quot;);</span>
<span class="line-removed">-             }</span>
          }
  
      }
  
<span class="line-modified">!     public javax.xml.stream.XMLStreamWriter createXMLStreamWriter(java.io.Writer writer) throws javax.xml.stream.XMLStreamException {</span>
<span class="line-modified">!         return createXMLStreamWriter(toStreamResult(null, writer, null) , null);</span>
      }
  
<span class="line-modified">!     public javax.xml.stream.XMLStreamWriter createXMLStreamWriter(java.io.OutputStream outputStream) throws javax.xml.stream.XMLStreamException {</span>
          return createXMLStreamWriter(outputStream, null);
      }
  
<span class="line-modified">!     public javax.xml.stream.XMLStreamWriter createXMLStreamWriter(java.io.OutputStream outputStream, String encoding) throws javax.xml.stream.XMLStreamException {</span>
<span class="line-modified">!         return createXMLStreamWriter(toStreamResult(outputStream, null, null) , encoding);</span>
      }
  
<span class="line-modified">!     public Object getProperty(String name) throws java.lang.IllegalArgumentException {</span>
<span class="line-modified">!         if(name == null){</span>
              throw new IllegalArgumentException(&quot;Property not supported&quot;);
          }
<span class="line-modified">!         if(fPropertyManager.containsProperty(name))</span>
              return fPropertyManager.getProperty(name);
          throw new IllegalArgumentException(&quot;Property not supported&quot;);
      }
  
      public boolean isPropertySupported(String name) {
<span class="line-modified">!         if(name == null){</span>
<span class="line-modified">!             return false ;</span>
<span class="line-modified">!         }</span>
<span class="line-removed">-         else{</span>
              return fPropertyManager.containsProperty(name);
          }
      }
  
<span class="line-modified">!     public void setProperty(String name, Object value) throws java.lang.IllegalArgumentException {</span>
<span class="line-modified">!         if(name == null || value == null || !fPropertyManager.containsProperty(name) ){</span>
<span class="line-modified">!             throw new IllegalArgumentException(&quot;Property &quot;+name+&quot;is not supported&quot;);</span>
          }
<span class="line-modified">!         if(name == Constants.REUSE_INSTANCE || name.equals(Constants.REUSE_INSTANCE)){</span>
<span class="line-modified">!             fReuseInstance = ((Boolean)value).booleanValue();</span>
<span class="line-modified">!             if(DEBUG)System.out.println(&quot;fReuseInstance is set to &quot; + fReuseInstance);</span>
  
              // TODO: XMLStreamWriters are not Thread safe,
              // don&#39;t let application think it is optimizing
              if (fReuseInstance) {
                  throw new IllegalArgumentException(
                          &quot;Property &quot;
                          + name
                          + &quot; is not supported: XMLStreamWriters are not Thread safe&quot;);
              }
<span class="line-modified">!         }else{//for any other property set the flag</span>
              //REVISIT: Even in this case instance can be reused, by passing PropertyManager
              fPropertyChanged = true;
          }
<span class="line-modified">!         fPropertyManager.setProperty(name,value);</span>
      }
  
<span class="line-modified">!     /** StreamResult object is re-used and the values are set appropriately.</span>
       */
<span class="line-modified">!     StreamResult toStreamResult(OutputStream os, Writer writer, String systemId){</span>
          StreamResult sr = new StreamResult();
          sr.setOutputStream(os);
          sr.setWriter(writer);
          sr.setSystemId(systemId);
          return sr;
      }
  
<span class="line-modified">!     javax.xml.stream.XMLStreamWriter createXMLStreamWriter(javax.xml.transform.stream.StreamResult sr, String encoding) throws javax.xml.stream.XMLStreamException {</span>
          //if factory is configured to reuse the instance &amp; this instance can be reused
          //&amp; the setProperty() hasn&#39;t been called
<span class="line-modified">!         try{</span>
<span class="line-modified">!             if(fReuseInstance &amp;&amp; fStreamWriter != null &amp;&amp; fStreamWriter.canReuse() &amp;&amp; !fPropertyChanged){</span>
                  fStreamWriter.reset();
                  fStreamWriter.setOutput(sr, encoding);
<span class="line-modified">!                 if(DEBUG)System.out.println(&quot;reusing instance, object id : &quot; + fStreamWriter);</span>
                  return fStreamWriter;
              }
<span class="line-modified">!             return fStreamWriter = new XMLStreamWriterImpl(sr, encoding, new PropertyManager(fPropertyManager));</span>
<span class="line-modified">!         }catch(java.io.IOException io){</span>
              throw new XMLStreamException(io);
          }
      }//createXMLStreamWriter(StreamResult,String)
  
      private static final boolean DEBUG = false;
  
<span class="line-modified">!     /** This flag indicates the change of property. If true,</span>
       * &lt;code&gt;PropertyManager&lt;/code&gt; should be passed when creating
<span class="line-modified">!      * &lt;code&gt;XMLStreamWriterImpl&lt;/code&gt; */</span>
<span class="line-modified">!     private boolean fPropertyChanged ;</span>
  }//XMLOutputFactory
<span class="line-new-header">--- 59,162 ---</span>
      /**
       * TODO: at the current time, XMLStreamWriters are not Thread safe.
       */
      boolean fReuseInstance = false;
  
<span class="line-modified">!     /**</span>
<span class="line-added">+      * Creates a new instance of XMLOutputFactory</span>
<span class="line-added">+      */</span>
      public XMLOutputFactoryImpl() {
      }
  
<span class="line-modified">!     public XMLEventWriter createXMLEventWriter(OutputStream outputStream)</span>
<span class="line-modified">!             throws XMLStreamException {</span>
<span class="line-added">+         return createXMLEventWriter(outputStream, null);</span>
      }
  
<span class="line-modified">!     public XMLEventWriter createXMLEventWriter(OutputStream outputStream, String encoding)</span>
<span class="line-added">+             throws XMLStreamException {</span>
          return new XMLEventWriterImpl(createXMLStreamWriter(outputStream, encoding));
      }
  
<span class="line-modified">!     public XMLEventWriter createXMLEventWriter(Result result)</span>
<span class="line-added">+             throws XMLStreamException {</span>
  
<span class="line-modified">!         if (result instanceof StAXResult &amp;&amp; ((StAXResult) result).getXMLEventWriter() != null) {</span>
<span class="line-modified">!             return ((StAXResult) result).getXMLEventWriter();</span>
<span class="line-added">+         }</span>
  
          return new XMLEventWriterImpl(createXMLStreamWriter(result));
      }
  
<span class="line-modified">!     public XMLEventWriter createXMLEventWriter(java.io.Writer writer)</span>
<span class="line-added">+             throws XMLStreamException {</span>
          return new XMLEventWriterImpl(createXMLStreamWriter(writer));
      }
  
<span class="line-modified">!     public XMLStreamWriter createXMLStreamWriter(Result result)</span>
<span class="line-added">+             throws XMLStreamException {</span>
  
          if (result instanceof StreamResult) {
              return createXMLStreamWriter((StreamResult) result, null);
          } else if (result instanceof DOMResult) {
              return new XMLDOMWriterImpl((DOMResult) result);
          } else if (result instanceof StAXResult) {
              if (((StAXResult) result).getXMLStreamWriter() != null) {
                  return ((StAXResult) result).getXMLStreamWriter();
              } else {
<span class="line-modified">!                 throw new UnsupportedOperationException(</span>
<span class="line-added">+                         &quot;Result of type &quot; + result + &quot; is not supported&quot;);</span>
              }
<span class="line-added">+         } else if (result.getSystemId() != null) {</span>
<span class="line-added">+             //this is not correct impl of SAXResult. Keep it for now for compatibility</span>
<span class="line-added">+             return createXMLStreamWriter(new StreamResult(result.getSystemId()));</span>
          } else {
<span class="line-modified">!             throw new UnsupportedOperationException(</span>
<span class="line-modified">!                     &quot;Result of type &quot; + result + &quot; is not supported. Supported result &quot;</span>
<span class="line-modified">!                             + &quot;types are: DOMResult, StAXResult and StreamResult.&quot;);</span>
          }
  
      }
  
<span class="line-modified">!     public XMLStreamWriter createXMLStreamWriter(java.io.Writer writer)</span>
<span class="line-modified">!             throws XMLStreamException {</span>
<span class="line-added">+         return createXMLStreamWriter(toStreamResult(null, writer, null), null);</span>
      }
  
<span class="line-modified">!     public XMLStreamWriter createXMLStreamWriter(OutputStream outputStream)</span>
<span class="line-added">+             throws XMLStreamException {</span>
          return createXMLStreamWriter(outputStream, null);
      }
  
<span class="line-modified">!     public XMLStreamWriter createXMLStreamWriter(OutputStream outputStream, String encoding)</span>
<span class="line-modified">!             throws XMLStreamException {</span>
<span class="line-added">+         return createXMLStreamWriter(toStreamResult(outputStream, null, null), encoding);</span>
      }
  
<span class="line-modified">!     public Object getProperty(String name)</span>
<span class="line-modified">!             throws IllegalArgumentException {</span>
<span class="line-added">+         if (name == null) {</span>
              throw new IllegalArgumentException(&quot;Property not supported&quot;);
          }
<span class="line-modified">!         if (fPropertyManager.containsProperty(name)) {</span>
              return fPropertyManager.getProperty(name);
<span class="line-added">+         }</span>
          throw new IllegalArgumentException(&quot;Property not supported&quot;);
      }
  
      public boolean isPropertySupported(String name) {
<span class="line-modified">!         if (name == null) {</span>
<span class="line-modified">!             return false;</span>
<span class="line-modified">!         } else {</span>
              return fPropertyManager.containsProperty(name);
          }
      }
  
<span class="line-modified">!     public void setProperty(String name, Object value)</span>
<span class="line-modified">!             throws IllegalArgumentException {</span>
<span class="line-modified">!         if (name == null || value == null || !fPropertyManager.containsProperty(name)) {</span>
<span class="line-added">+             throw new IllegalArgumentException(&quot;Property &quot; + name + &quot;is not supported&quot;);</span>
          }
<span class="line-modified">!         if (name == Constants.REUSE_INSTANCE || name.equals(Constants.REUSE_INSTANCE)) {</span>
<span class="line-modified">!             fReuseInstance = (Boolean)value;</span>
<span class="line-modified">!             if (DEBUG) {</span>
<span class="line-added">+                 System.out.println(&quot;fReuseInstance is set to &quot; + fReuseInstance);</span>
<span class="line-added">+             }</span>
  
              // TODO: XMLStreamWriters are not Thread safe,
              // don&#39;t let application think it is optimizing
              if (fReuseInstance) {
                  throw new IllegalArgumentException(
                          &quot;Property &quot;
                          + name
                          + &quot; is not supported: XMLStreamWriters are not Thread safe&quot;);
              }
<span class="line-modified">!         } else {//for any other property set the flag</span>
              //REVISIT: Even in this case instance can be reused, by passing PropertyManager
              fPropertyChanged = true;
          }
<span class="line-modified">!         fPropertyManager.setProperty(name, value);</span>
      }
  
<span class="line-modified">!     /**</span>
<span class="line-added">+      * StreamResult object is re-used and the values are set appropriately.</span>
       */
<span class="line-modified">!     StreamResult toStreamResult(OutputStream os, Writer writer, String systemId) {</span>
          StreamResult sr = new StreamResult();
          sr.setOutputStream(os);
          sr.setWriter(writer);
          sr.setSystemId(systemId);
          return sr;
      }
  
<span class="line-modified">!     XMLStreamWriter createXMLStreamWriter(StreamResult sr, String encoding)</span>
<span class="line-added">+             throws XMLStreamException {</span>
          //if factory is configured to reuse the instance &amp; this instance can be reused
          //&amp; the setProperty() hasn&#39;t been called
<span class="line-modified">!         try {</span>
<span class="line-modified">!             if (fReuseInstance &amp;&amp; fStreamWriter != null &amp;&amp; fStreamWriter.canReuse()</span>
<span class="line-added">+                     &amp;&amp; !fPropertyChanged) {</span>
                  fStreamWriter.reset();
                  fStreamWriter.setOutput(sr, encoding);
<span class="line-modified">!                 if (DEBUG) {</span>
<span class="line-added">+                     System.out.println(&quot;reusing instance, object id : &quot; + fStreamWriter);</span>
<span class="line-added">+                 }</span>
                  return fStreamWriter;
              }
<span class="line-modified">!             return fStreamWriter = new XMLStreamWriterImpl(sr, encoding,</span>
<span class="line-modified">!                     new PropertyManager(fPropertyManager));</span>
<span class="line-added">+         } catch (IOException io) {</span>
              throw new XMLStreamException(io);
          }
      }//createXMLStreamWriter(StreamResult,String)
  
      private static final boolean DEBUG = false;
  
<span class="line-modified">!     /**</span>
<span class="line-added">+      * This flag indicates the change of property. If true,</span>
       * &lt;code&gt;PropertyManager&lt;/code&gt; should be passed when creating
<span class="line-modified">!      * &lt;code&gt;XMLStreamWriterImpl&lt;/code&gt;</span>
<span class="line-modified">!      */</span>
<span class="line-added">+     private boolean fPropertyChanged;</span>
  }//XMLOutputFactory
</pre>
<center><a href="StaxXMLInputSource.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="writers/XMLEventWriterImpl.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>