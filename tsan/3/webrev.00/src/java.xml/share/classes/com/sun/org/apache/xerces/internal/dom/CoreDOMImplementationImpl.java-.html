<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.xml/share/classes/com/sun/org/apache/xerces/internal/dom/CoreDOMImplementationImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.
  3  */
  4 /*
  5  * Licensed to the Apache Software Foundation (ASF) under one or more
  6  * contributor license agreements.  See the NOTICE file distributed with
  7  * this work for additional information regarding copyright ownership.
  8  * The ASF licenses this file to You under the Apache License, Version 2.0
  9  * (the &quot;License&quot;); you may not use this file except in compliance with
 10  * the License.  You may obtain a copy of the License at
 11  *
 12  *      http://www.apache.org/licenses/LICENSE-2.0
 13  *
 14  * Unless required by applicable law or agreed to in writing, software
 15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 17  * See the License for the specific language governing permissions and
 18  * limitations under the License.
 19  */
 20 package com.sun.org.apache.xerces.internal.dom;
 21 
 22 import com.sun.org.apache.xerces.internal.impl.RevalidationHandler;
 23 import com.sun.org.apache.xerces.internal.parsers.DOMParserImpl;
 24 import com.sun.org.apache.xerces.internal.parsers.DTDConfiguration;
 25 import com.sun.org.apache.xerces.internal.parsers.XIncludeAwareParserConfiguration;
 26 import com.sun.org.apache.xerces.internal.util.XMLChar;
 27 import com.sun.org.apache.xerces.internal.xni.grammars.XMLGrammarDescription;
 28 import org.w3c.dom.DOMException;
 29 import org.w3c.dom.DOMImplementation;
 30 import org.w3c.dom.Document;
 31 import org.w3c.dom.DocumentType;
 32 import org.w3c.dom.Element;
 33 import org.w3c.dom.ls.LSParser;
 34 import org.w3c.dom.ls.DOMImplementationLS;
 35 import org.w3c.dom.ls.LSInput;
 36 import org.w3c.dom.ls.LSOutput;
 37 import org.w3c.dom.ls.LSSerializer;
 38 /**
 39  * The DOMImplementation class is description of a particular
 40  * implementation of the Document Object Model. As such its data is
 41  * static, shared by all instances of this implementation.
 42  * &lt;P&gt;
 43  * The DOM API requires that it be a real object rather than static
 44  * methods. However, there&#39;s nothing that says it can&#39;t be a singleton,
 45  * so that&#39;s how I&#39;ve implemented it.
 46  * &lt;P&gt;
 47  * This particular class, along with CoreDocumentImpl, supports the DOM
 48  * Core and Load/Save (Experimental). Optional modules are supported by
 49  * the more complete DOMImplementation class along with DocumentImpl.
 50  *
 51  * @xerces.internal
 52  *
 53  * @since PR-DOM-Level-1-19980818.
 54  */
 55 public class CoreDOMImplementationImpl
 56         implements DOMImplementation, DOMImplementationLS {
 57         //
 58         // Data
 59         //
 60 
 61     // validators pool
 62     private static final int SIZE = 2;
 63     private RevalidationHandler validators[] = new RevalidationHandler[SIZE];
 64 
 65     private RevalidationHandler dtdValidators[] = new RevalidationHandler[SIZE];
 66     private int freeValidatorIndex = -1;
 67     private int freeDTDValidatorIndex = -1;
 68     private int currentSize = SIZE;
 69 
 70     // Document and doctype counter.  Used to assign order to documents and
 71     // doctypes without owners, on an demand basis.   Used for
 72     // compareDocumentPosition
 73     private int docAndDoctypeCounter = 0;
 74 
 75         // static
 76         /** Dom implementation singleton. */
 77         static CoreDOMImplementationImpl singleton =
 78                 new CoreDOMImplementationImpl();
 79         //
 80         // Public methods
 81         //
 82         /** NON-DOM: Obtain and return the single shared object */
 83         public static DOMImplementation getDOMImplementation() {
 84                 return singleton;
 85         }
 86         //
 87         // DOMImplementation methods
 88         //
 89         /**
 90          * Test if the DOM implementation supports a specific &quot;feature&quot; --
 91          * currently meaning language and level thereof.
 92          *
 93          * @param feature The package name of the feature to test.
 94          * In Level 1, supported values are &quot;HTML&quot; and &quot;XML&quot; (case-insensitive).
 95          * At this writing, com.sun.org.apache.xerces.internal.dom supports only XML.
 96          *
 97          * @param version The version number of the feature being tested.
 98          * This is interpreted as &quot;Version of the DOM API supported for the
 99          * specified Feature&quot;, and in Level 1 should be &quot;1.0&quot;
100          *
101          * @return true if this implementation is compatible with the specified
102          * feature and version.
103          */
104         public boolean hasFeature(String feature, String version) {
105 
106             boolean anyVersion = version == null || version.length() == 0;
107 
108             if (feature.startsWith(&quot;+&quot;)) {
109                 feature = feature.substring(1);
110             }
111             return (feature.equalsIgnoreCase(&quot;Core&quot;)
112                         &amp;&amp; (anyVersion
113                             || version.equals(&quot;1.0&quot;)
114                             || version.equals(&quot;2.0&quot;)
115                             || version.equals(&quot;3.0&quot;)))
116                     || (feature.equalsIgnoreCase(&quot;XML&quot;)
117                         &amp;&amp; (anyVersion
118                             || version.equals(&quot;1.0&quot;)
119                             || version.equals(&quot;2.0&quot;)
120                             || version.equals(&quot;3.0&quot;)))
121                     || (feature.equalsIgnoreCase(&quot;LS&quot;)
122                         &amp;&amp; (anyVersion
123                             || version.equals(&quot;3.0&quot;)))
124                     || (feature.equalsIgnoreCase(&quot;ElementTraversal&quot;)
125                         &amp;&amp; (anyVersion
126                             || version.equals(&quot;1.0&quot;)));
127         } // hasFeature(String,String):boolean
128 
129 
130         /**
131          * Introduced in DOM Level 2. &lt;p&gt;
132          *
133          * Creates an empty DocumentType node.
134          *
135          * @param qualifiedName The qualified name of the document type to be created.
136          * @param publicID The document type public identifier.
137          * @param systemID The document type system identifier.
138          * @since WD-DOM-Level-2-19990923
139          */
140         public DocumentType createDocumentType( String qualifiedName,
141                                     String publicID, String systemID) {
142                 // REVISIT: this might allow creation of invalid name for DOCTYPE
143                 //          xmlns prefix.
144                 //          also there is no way for a user to turn off error checking.
145                 checkQName(qualifiedName);
146                 return new DocumentTypeImpl(null, qualifiedName, publicID, systemID);
147         }
148 
149     final void checkQName(String qname){
150         int index = qname.indexOf(&#39;:&#39;);
151         int lastIndex = qname.lastIndexOf(&#39;:&#39;);
152         int length = qname.length();
153 
154         // it is an error for NCName to have more than one &#39;:&#39;
155         // check if it is valid QName [Namespace in XML production 6]
156         if (index == 0 || index == length - 1 || lastIndex != index) {
157             String msg =
158                 DOMMessageFormatter.formatMessage(
159                     DOMMessageFormatter.DOM_DOMAIN,
160                     &quot;NAMESPACE_ERR&quot;,
161                     null);
162             throw new DOMException(DOMException.NAMESPACE_ERR, msg);
163         }
164         int start = 0;
165         // Namespace in XML production [6]
166         if (index &gt; 0) {
167             // check that prefix is NCName
168             if (!XMLChar.isNCNameStart(qname.charAt(start))) {
169                 String msg =
170                     DOMMessageFormatter.formatMessage(
171                         DOMMessageFormatter.DOM_DOMAIN,
172                         &quot;INVALID_CHARACTER_ERR&quot;,
173                         null);
174                 throw new DOMException(DOMException.INVALID_CHARACTER_ERR, msg);
175             }
176             for (int i = 1; i &lt; index; i++) {
177                 if (!XMLChar.isNCName(qname.charAt(i))) {
178                     String msg =
179                         DOMMessageFormatter.formatMessage(
180                             DOMMessageFormatter.DOM_DOMAIN,
181                             &quot;INVALID_CHARACTER_ERR&quot;,
182                             null);
183                     throw new DOMException(
184                         DOMException.INVALID_CHARACTER_ERR,
185                         msg);
186                 }
187             }
188             start = index + 1;
189         }
190 
191         // check local part
192         if (!XMLChar.isNCNameStart(qname.charAt(start))) {
193             // REVISIT: add qname parameter to the message
194             String msg =
195                 DOMMessageFormatter.formatMessage(
196                     DOMMessageFormatter.DOM_DOMAIN,
197                     &quot;INVALID_CHARACTER_ERR&quot;,
198                     null);
199             throw new DOMException(DOMException.INVALID_CHARACTER_ERR, msg);
200         }
201         for (int i = start + 1; i &lt; length; i++) {
202             if (!XMLChar.isNCName(qname.charAt(i))) {
203                 String msg =
204                     DOMMessageFormatter.formatMessage(
205                         DOMMessageFormatter.DOM_DOMAIN,
206                         &quot;INVALID_CHARACTER_ERR&quot;,
207                         null);
208                 throw new DOMException(DOMException.INVALID_CHARACTER_ERR, msg);
209             }
210         }
211     }
212 
213 
214         /**
215          * Introduced in DOM Level 2. &lt;p&gt;
216          *
217          * Creates an XML Document object of the specified type with its document
218          * element.
219          *
220          * @param namespaceURI     The namespace URI of the document
221          *                         element to create, or null.
222          * @param qualifiedName    The qualified name of the document
223          *                         element to create.
224          * @param doctype          The type of document to be created or null.&lt;p&gt;
225          *
226          *                         When doctype is not null, its
227          *                         Node.ownerDocument attribute is set to
228          *                         the document being created.
229          * @return Document        A new Document object.
230          * @throws DOMException    WRONG_DOCUMENT_ERR: Raised if doctype has
231          *                         already been used with a different document.
232          * @since WD-DOM-Level-2-19990923
233          */
234         public Document createDocument(
235                 String namespaceURI,
236                 String qualifiedName,
237                 DocumentType doctype)
238                 throws DOMException {
239                 if (doctype != null &amp;&amp; doctype.getOwnerDocument() != null) {
240                         String msg =
241                                 DOMMessageFormatter.formatMessage(
242                                         DOMMessageFormatter.DOM_DOMAIN,
243                                         &quot;WRONG_DOCUMENT_ERR&quot;,
244                                         null);
245                         throw new DOMException(DOMException.WRONG_DOCUMENT_ERR, msg);
246                 }
247                 CoreDocumentImpl doc = new CoreDocumentImpl(doctype);
248                 Element e = doc.createElementNS(namespaceURI, qualifiedName);
249                 doc.appendChild(e);
250                 return doc;
251         }
252 
253         /**
254          * DOM Level 3 WD - Experimental.
255          */
256         public Object getFeature(String feature, String version) {
257             if (singleton.hasFeature(feature, version)) {
258                 return singleton;
259             }
260             return null;
261         }
262 
263         // DOM L3 LS
264 
265         /**
266          * DOM Level 3 LS CR - Experimental.
267      * Create a new &lt;code&gt;LSParser&lt;/code&gt;. The newly constructed parser may
268      * then be configured by means of its &lt;code&gt;DOMConfiguration&lt;/code&gt;
269      * object, and used to parse documents by means of its &lt;code&gt;parse&lt;/code&gt;
270      *  method.
271      * @param mode  The &lt;code&gt;mode&lt;/code&gt; argument is either
272      *   &lt;code&gt;MODE_SYNCHRONOUS&lt;/code&gt; or &lt;code&gt;MODE_ASYNCHRONOUS&lt;/code&gt;, if
273      *   &lt;code&gt;mode&lt;/code&gt; is &lt;code&gt;MODE_SYNCHRONOUS&lt;/code&gt; then the
274      *   &lt;code&gt;LSParser&lt;/code&gt; that is created will operate in synchronous
275      *   mode, if it&#39;s &lt;code&gt;MODE_ASYNCHRONOUS&lt;/code&gt; then the
276      *   &lt;code&gt;LSParser&lt;/code&gt; that is created will operate in asynchronous
277      *   mode.
278      * @param schemaType  An absolute URI representing the type of the schema
279      *   language used during the load of a &lt;code&gt;Document&lt;/code&gt; using the
280      *   newly created &lt;code&gt;LSParser&lt;/code&gt;. Note that no lexical checking
281      *   is done on the absolute URI. In order to create a
282      *   &lt;code&gt;LSParser&lt;/code&gt; for any kind of schema types (i.e. the
283      *   LSParser will be free to use any schema found), use the value
284      *   &lt;code&gt;null&lt;/code&gt;.
285      * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    For W3C XML Schema [&lt;a href=&#39;http://www.w3.org/TR/2001/REC-xmlschema-1-20010502/&#39;&gt;XML Schema Part 1&lt;/a&gt;]
286      *   , applications must use the value
287      *   &lt;code&gt;&quot;http://www.w3.org/2001/XMLSchema&quot;&lt;/code&gt;. For XML DTD [&lt;a href=&#39;http://www.w3.org/TR/2000/REC-xml-20001006&#39;&gt;XML 1.0&lt;/a&gt;],
288      *   applications must use the value
289      *   &lt;code&gt;&quot;http://www.w3.org/TR/REC-xml&quot;&lt;/code&gt;. Other Schema languages
290      *   are outside the scope of the W3C and therefore should recommend an
291      *   absolute URI in order to use this method.
292      * @return  The newly created &lt;code&gt;LSParser&lt;/code&gt; object. This
293      *   &lt;code&gt;LSParser&lt;/code&gt; is either synchronous or asynchronous
294      *   depending on the value of the &lt;code&gt;mode&lt;/code&gt; argument.
295      * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created &lt;code&gt;LSParser&lt;/code&gt;
296      *    does not contain a &lt;code&gt;DOMErrorHandler&lt;/code&gt;, i.e. the value of
297      *   the &quot;&lt;a href=&#39;http://www.w3.org/TR/2003/WD-DOM-Level-3-Core-20030609/core.html#parameter-error-handler&#39;&gt;
298      *   error-handler&lt;/a&gt;&quot; configuration parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations
299      *   may provide a default error handler at creation time. In that case,
300      *   the initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration
301      *   parameter on the new created &lt;code&gt;LSParser&lt;/code&gt; contains a
302      *   reference to the default error handler.
303      * @exception DOMException
304      *    NOT_SUPPORTED_ERR: Raised if the requested mode or schema type is
305      *   not supported.
306          */
307         public LSParser createLSParser(short mode, String schemaType)
308                 throws DOMException {
309                 if (mode != DOMImplementationLS.MODE_SYNCHRONOUS || (schemaType !=null &amp;&amp;
310                    !&quot;http://www.w3.org/2001/XMLSchema&quot;.equals(schemaType) &amp;&amp;
311                         !&quot;http://www.w3.org/TR/REC-xml&quot;.equals(schemaType))) {
312                         String msg =
313                                 DOMMessageFormatter.formatMessage(
314                                         DOMMessageFormatter.DOM_DOMAIN,
315                                         &quot;NOT_SUPPORTED_ERR&quot;,
316                                         null);
317                         throw new DOMException(DOMException.NOT_SUPPORTED_ERR, msg);
318                 }
319                 if (schemaType != null
320                         &amp;&amp; schemaType.equals(&quot;http://www.w3.org/TR/REC-xml&quot;)) {
321                         return new DOMParserImpl(new DTDConfiguration(),
322                                 schemaType);
323                 }
324                 else {
325                         // create default parser configuration validating against XMLSchemas
326                         return new DOMParserImpl(new XIncludeAwareParserConfiguration(),
327                                 schemaType);
328                 }
329         }
330 
331         /**
332          * DOM Level 3 LS CR - Experimental.
333          * Create a new &lt;code&gt;LSSerializer&lt;/code&gt; object.
334          * @return The newly created &lt;code&gt;LSSerializer&lt;/code&gt; object.
335          * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created
336          * &lt;code&gt;LSSerializer&lt;/code&gt; has no &lt;code&gt;DOMErrorHandler&lt;/code&gt;,
337          * i.e. the value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration
338          * parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations may
339          * provide a default error handler at creation time. In that case, the
340          * initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration
341          * parameter on the new created &lt;code&gt;LSSerializer&lt;/code&gt; contains a
342          * reference to the default error handler.
343          */
344         public LSSerializer createLSSerializer() {
345             return new com.sun.org.apache.xml.internal.serializer.dom3.LSSerializerImpl();
346         }
347 
348         /**
349          * DOM Level 3 LS CR - Experimental.
350          * Create a new empty input source.
351          * @return  The newly created input object.
352          */
353         public LSInput createLSInput() {
354                 return new DOMInputImpl();
355         }
356 
357         //
358         // Protected methods
359         //
360         /** NON-DOM: retrieve validator. */
361         synchronized RevalidationHandler getValidator(String schemaType) {
362                 // REVISIT: implement retrieving DTD validator
363         if (schemaType == XMLGrammarDescription.XML_SCHEMA) {
364             // create new validator - we should not attempt
365             // to restrict the number of validation handlers being
366             // requested
367             if(freeValidatorIndex &lt; 0) {
368                 return new com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator();
369             }
370             // return first available validator
371             RevalidationHandler val = validators[freeValidatorIndex];
372             validators[freeValidatorIndex--] = null;
373             return val;
374         }
375         else if(schemaType == XMLGrammarDescription.XML_DTD) {
376             if(freeDTDValidatorIndex &lt; 0) {
377                 return new com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDValidator();
378             }
379             // return first available validator
380             RevalidationHandler val = dtdValidators[freeDTDValidatorIndex];
381             dtdValidators[freeDTDValidatorIndex--] = null;
382             return val;
383         }
384         return null;
385         }
386 
387         /** NON-DOM: release validator */
388         synchronized void releaseValidator(String schemaType,
389                                          RevalidationHandler validator) {
390        // REVISIT: implement support for DTD validators as well
391        if(schemaType == XMLGrammarDescription.XML_SCHEMA) {
392            ++freeValidatorIndex;
393            if (validators.length == freeValidatorIndex ){
394                 // resize size of the validators
395                 currentSize+=SIZE;
396                 RevalidationHandler newarray[] =  new RevalidationHandler[currentSize];
397                 System.arraycopy(validators, 0, newarray, 0, validators.length);
398                 validators = newarray;
399            }
400            validators[freeValidatorIndex]=validator;
401        }
402        else if(schemaType == XMLGrammarDescription.XML_DTD) {
403            ++freeDTDValidatorIndex;
404            if (dtdValidators.length == freeDTDValidatorIndex ){
405                 // resize size of the validators
406                 currentSize+=SIZE;
407                 RevalidationHandler newarray[] =  new RevalidationHandler[currentSize];
408                 System.arraycopy(dtdValidators, 0, newarray, 0, dtdValidators.length);
409                 dtdValidators = newarray;
410            }
411            dtdValidators[freeDTDValidatorIndex]=validator;
412        }
413         }
414 
415        /** NON-DOM:  increment document/doctype counter */
416        protected synchronized int assignDocumentNumber() {
417             return ++docAndDoctypeCounter;
418        }
419        /** NON-DOM:  increment document/doctype counter */
420        protected synchronized int assignDocTypeNumber() {
421             return ++docAndDoctypeCounter;
422        }
423 
424     /* DOM Level 3 LS CR - Experimental.
425      *
426      * Create a new empty output destination object where
427      * &lt;code&gt;LSOutput.characterStream&lt;/code&gt;,
428      * &lt;code&gt;LSOutput.byteStream&lt;/code&gt;, &lt;code&gt;LSOutput.systemId&lt;/code&gt;,
429      * &lt;code&gt;LSOutput.encoding&lt;/code&gt; are null.
430 
431      * @return  The newly created output object.
432      */
433        public LSOutput createLSOutput() {
434            return new DOMOutputImpl();
435        }
436 
437 } // class DOMImplementationImpl
    </pre>
  </body>
</html>