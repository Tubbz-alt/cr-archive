<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.xml/share/classes/com/sun/org/apache/bcel/internal/classfile/Constant.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 /*
  5  * Licensed to the Apache Software Foundation (ASF) under one or more
  6  * contributor license agreements.  See the NOTICE file distributed with
  7  * this work for additional information regarding copyright ownership.
  8  * The ASF licenses this file to You under the Apache License, Version 2.0
  9  * (the &quot;License&quot;); you may not use this file except in compliance with
 10  * the License.  You may obtain a copy of the License at
 11  *
 12  *      http://www.apache.org/licenses/LICENSE-2.0
 13  *
 14  * Unless required by applicable law or agreed to in writing, software
 15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 17  * See the License for the specific language governing permissions and
 18  * limitations under the License.
 19  */
 20 package com.sun.org.apache.bcel.internal.classfile;
 21 
 22 import java.io.DataInput;
 23 import java.io.DataOutputStream;
 24 import java.io.IOException;
<a name="2" id="anc2"></a><span class="line-added"> 25 import java.util.Objects;</span>
 26 
 27 import com.sun.org.apache.bcel.internal.Const;
 28 import com.sun.org.apache.bcel.internal.util.BCELComparator;
 29 
 30 /**
<a name="3" id="anc3"></a><span class="line-modified"> 31  * Abstract superclass for classes to represent the different constant types</span>
<span class="line-modified"> 32  * in the constant pool of a class file. The classes keep closely to</span>
<span class="line-modified"> 33  * the JVM specification.</span>
 34  *
<a name="4" id="anc4"></a><span class="line-modified"> 35  * @LastModified: Jan 2020</span>
 36  */
 37 public abstract class Constant implements Cloneable, Node {
 38 
 39     private static BCELComparator bcelComparator = new BCELComparator() {
 40 
 41         @Override
<a name="5" id="anc5"></a><span class="line-modified"> 42         public boolean equals( final Object o1, final Object o2 ) {</span>
 43             final Constant THIS = (Constant) o1;
 44             final Constant THAT = (Constant) o2;
<a name="6" id="anc6"></a><span class="line-modified"> 45             return Objects.equals(THIS.toString(), THAT.toString());</span>
 46         }
 47 
<a name="7" id="anc7"></a><span class="line-added"> 48 </span>
 49         @Override
<a name="8" id="anc8"></a><span class="line-modified"> 50         public int hashCode( final Object o ) {</span>
 51             final Constant THIS = (Constant) o;
 52             return THIS.toString().hashCode();
 53         }
 54     };
 55 
 56     /* In fact this tag is redundant since we can distinguish different
 57      * `Constant&#39; objects by their type, i.e., via `instanceof&#39;. In some
 58      * places we will use the tag for switch()es anyway.
 59      *
 60      * First, we want match the specification as closely as possible. Second we
 61      * need the tag as an index to select the corresponding class name from the
 62      * `CONSTANT_NAMES&#39; array.
 63      */
 64     private byte tag;
 65 
 66     Constant(final byte tag) {
 67         this.tag = tag;
 68     }
 69 
 70     /**
 71      * Called by objects that are traversing the nodes of the tree implicitely
 72      * defined by the contents of a Java class. I.e., the hierarchy of methods,
 73      * fields, attributes, etc. spawns a tree of objects.
 74      *
 75      * @param v Visitor object
 76      */
 77     @Override
<a name="9" id="anc9"></a><span class="line-modified"> 78     public abstract void accept( Visitor v );</span>
 79 
<a name="10" id="anc10"></a><span class="line-modified"> 80     public abstract void dump( DataOutputStream file ) throws IOException;</span>
 81 
 82     /**
 83      * @return Tag of constant, i.e., its type. No setTag() method to avoid
 84      * confusion.
 85      */
 86     public final byte getTag() {
 87         return tag;
 88     }
 89 
 90     /**
 91      * @return String representation.
 92      */
 93     @Override
 94     public String toString() {
 95         return Const.getConstantName(tag) + &quot;[&quot; + tag + &quot;]&quot;;
 96     }
 97 
 98     /**
 99      * @return deep copy of this constant
100      */
101     public Constant copy() {
102         try {
103             return (Constant) super.clone();
104         } catch (final CloneNotSupportedException e) {
105             // TODO should this throw?
106         }
107         return null;
108     }
109 
110     @Override
111     public Object clone() {
112         try {
113             return super.clone();
114         } catch (final CloneNotSupportedException e) {
115             throw new Error(&quot;Clone Not Supported&quot;); // never happens
116         }
117     }
118 
119     /**
<a name="11" id="anc11"></a><span class="line-modified">120      * Reads one constant from the given input, the type depends on a tag byte.</span>
121      *
<a name="12" id="anc12"></a><span class="line-modified">122      * @param dataInput Input stream</span>
123      * @return Constant object
<a name="13" id="anc13"></a><span class="line-added">124      * @throws IOException if an I/O error occurs reading from the given {@code dataInput}.</span>
<span class="line-added">125      * @throws ClassFormatException if the next byte is not recognized</span>
126      * @since 6.0 made public
127      */
<a name="14" id="anc14"></a><span class="line-modified">128     public static Constant readConstant(final DataInput dataInput) throws IOException, ClassFormatException {</span>
<span class="line-modified">129         final byte b = dataInput.readByte(); // Read tag byte</span>

130         switch (b) {
<a name="15" id="anc15"></a><span class="line-modified">131         case Const.CONSTANT_Class:</span>
<span class="line-modified">132             return new ConstantClass(dataInput);</span>
<span class="line-modified">133         case Const.CONSTANT_Fieldref:</span>
<span class="line-modified">134             return new ConstantFieldref(dataInput);</span>
<span class="line-modified">135         case Const.CONSTANT_Methodref:</span>
<span class="line-modified">136             return new ConstantMethodref(dataInput);</span>
<span class="line-modified">137         case Const.CONSTANT_InterfaceMethodref:</span>
<span class="line-modified">138             return new ConstantInterfaceMethodref(dataInput);</span>
<span class="line-modified">139         case Const.CONSTANT_String:</span>
<span class="line-modified">140             return new ConstantString(dataInput);</span>
<span class="line-modified">141         case Const.CONSTANT_Integer:</span>
<span class="line-modified">142             return new ConstantInteger(dataInput);</span>
<span class="line-modified">143         case Const.CONSTANT_Float:</span>
<span class="line-modified">144             return new ConstantFloat(dataInput);</span>
<span class="line-modified">145         case Const.CONSTANT_Long:</span>
<span class="line-modified">146             return new ConstantLong(dataInput);</span>
<span class="line-modified">147         case Const.CONSTANT_Double:</span>
<span class="line-modified">148             return new ConstantDouble(dataInput);</span>
<span class="line-modified">149         case Const.CONSTANT_NameAndType:</span>
<span class="line-modified">150             return new ConstantNameAndType(dataInput);</span>
<span class="line-modified">151         case Const.CONSTANT_Utf8:</span>
<span class="line-modified">152             return ConstantUtf8.getInstance(dataInput);</span>
<span class="line-modified">153         case Const.CONSTANT_MethodHandle:</span>
<span class="line-modified">154             return new ConstantMethodHandle(dataInput);</span>
<span class="line-modified">155         case Const.CONSTANT_MethodType:</span>
<span class="line-modified">156             return new ConstantMethodType(dataInput);</span>
<span class="line-modified">157         case Const.CONSTANT_Dynamic:</span>
<span class="line-modified">158             return new ConstantDynamic(dataInput);</span>
<span class="line-modified">159         case Const.CONSTANT_InvokeDynamic:</span>
<span class="line-modified">160             return new ConstantInvokeDynamic(dataInput);</span>
<span class="line-added">161         case Const.CONSTANT_Module:</span>
<span class="line-added">162             return new ConstantModule(dataInput);</span>
<span class="line-added">163         case Const.CONSTANT_Package:</span>
<span class="line-added">164             return new ConstantPackage(dataInput);</span>
<span class="line-added">165         default:</span>
<span class="line-added">166             throw new ClassFormatException(&quot;Invalid byte tag in constant pool: &quot; + b);</span>
167         }
168     }
169 
170     /**
171      * @return Comparison strategy object
172      */
173     public static BCELComparator getComparator() {
174         return bcelComparator;
175     }
176 
177     /**
178      * @param comparator Comparison strategy object
179      */
<a name="16" id="anc16"></a><span class="line-modified">180     public static void setComparator( final BCELComparator comparator ) {</span>
181         bcelComparator = comparator;
182     }
183 
184     /**
<a name="17" id="anc17"></a><span class="line-modified">185      * Returns value as defined by given BCELComparator strategy.</span>
<span class="line-modified">186      * By default two Constant objects are said to be equal when</span>
<span class="line-modified">187      * the result of toString() is equal.</span>
188      *
189      * @see java.lang.Object#equals(java.lang.Object)
190      */
191     @Override
<a name="18" id="anc18"></a><span class="line-modified">192     public boolean equals( final Object obj ) {</span>
193         return bcelComparator.equals(this, obj);
194     }
195 
196     /**
<a name="19" id="anc19"></a><span class="line-modified">197      * Returns value as defined by given BCELComparator strategy.</span>
<span class="line-modified">198      * By default return the hashcode of the result of toString().</span>
199      *
200      * @see java.lang.Object#hashCode()
201      */
202     @Override
203     public int hashCode() {
204         return bcelComparator.hashCode(this);
205     }
206 }
<a name="20" id="anc20"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="20" type="hidden" />
</body>
</html>