<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.xml/share/classes/com/sun/org/apache/xerces/internal/dom/CoreDOMImplementationImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ChildNode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CoreDocumentImpl.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml/share/classes/com/sun/org/apache/xerces/internal/dom/CoreDOMImplementationImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 /*
  5  * Licensed to the Apache Software Foundation (ASF) under one or more
  6  * contributor license agreements.  See the NOTICE file distributed with
  7  * this work for additional information regarding copyright ownership.
  8  * The ASF licenses this file to You under the Apache License, Version 2.0
  9  * (the &quot;License&quot;); you may not use this file except in compliance with
 10  * the License.  You may obtain a copy of the License at
 11  *
 12  *      http://www.apache.org/licenses/LICENSE-2.0
 13  *
 14  * Unless required by applicable law or agreed to in writing, software
 15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 17  * See the License for the specific language governing permissions and
 18  * limitations under the License.
 19  */
 20 package com.sun.org.apache.xerces.internal.dom;
 21 
 22 import com.sun.org.apache.xerces.internal.impl.RevalidationHandler;





 23 import com.sun.org.apache.xerces.internal.parsers.DOMParserImpl;
 24 import com.sun.org.apache.xerces.internal.parsers.DTDConfiguration;
 25 import com.sun.org.apache.xerces.internal.parsers.XIncludeAwareParserConfiguration;

 26 import com.sun.org.apache.xerces.internal.util.XMLChar;
 27 import com.sun.org.apache.xerces.internal.xni.grammars.XMLGrammarDescription;

 28 import org.w3c.dom.DOMException;
 29 import org.w3c.dom.DOMImplementation;
 30 import org.w3c.dom.Document;
 31 import org.w3c.dom.DocumentType;
 32 import org.w3c.dom.Element;
 33 import org.w3c.dom.ls.LSParser;
 34 import org.w3c.dom.ls.DOMImplementationLS;
 35 import org.w3c.dom.ls.LSInput;
 36 import org.w3c.dom.ls.LSOutput;
 37 import org.w3c.dom.ls.LSSerializer;
 38 /**
 39  * The DOMImplementation class is description of a particular
 40  * implementation of the Document Object Model. As such its data is
 41  * static, shared by all instances of this implementation.
 42  * &lt;P&gt;
 43  * The DOM API requires that it be a real object rather than static
 44  * methods. However, there&#39;s nothing that says it can&#39;t be a singleton,
 45  * so that&#39;s how I&#39;ve implemented it.
 46  * &lt;P&gt;
 47  * This particular class, along with CoreDocumentImpl, supports the DOM
 48  * Core and Load/Save (Experimental). Optional modules are supported by
 49  * the more complete DOMImplementation class along with DocumentImpl.
 50  *
 51  * @xerces.internal
 52  *
 53  * @since PR-DOM-Level-1-19980818.

 54  */

 55 public class CoreDOMImplementationImpl
 56         implements DOMImplementation, DOMImplementationLS {
<span class="line-removed"> 57         //</span>
<span class="line-removed"> 58         // Data</span>
<span class="line-removed"> 59         //</span>
 60 
<span class="line-modified"> 61     // validators pool</span>




 62     private static final int SIZE = 2;
<span class="line-removed"> 63     private RevalidationHandler validators[] = new RevalidationHandler[SIZE];</span>
 64 
<span class="line-modified"> 65     private RevalidationHandler dtdValidators[] = new RevalidationHandler[SIZE];</span>
<span class="line-modified"> 66     private int freeValidatorIndex = -1;</span>
<span class="line-modified"> 67     private int freeDTDValidatorIndex = -1;</span>
<span class="line-modified"> 68     private int currentSize = SIZE;</span>
















 69 
 70     // Document and doctype counter.  Used to assign order to documents and
 71     // doctypes without owners, on an demand basis.   Used for
 72     // compareDocumentPosition
 73     private int docAndDoctypeCounter = 0;
 74 
 75         // static
 76         /** Dom implementation singleton. */
<span class="line-modified"> 77         static CoreDOMImplementationImpl singleton =</span>
<span class="line-modified"> 78                 new CoreDOMImplementationImpl();</span>
 79         //
 80         // Public methods
 81         //
 82         /** NON-DOM: Obtain and return the single shared object */
 83         public static DOMImplementation getDOMImplementation() {
 84                 return singleton;
 85         }
 86         //
 87         // DOMImplementation methods
 88         //
 89         /**
 90          * Test if the DOM implementation supports a specific &quot;feature&quot; --
 91          * currently meaning language and level thereof.
 92          *
 93          * @param feature The package name of the feature to test.
 94          * In Level 1, supported values are &quot;HTML&quot; and &quot;XML&quot; (case-insensitive).
 95          * At this writing, com.sun.org.apache.xerces.internal.dom supports only XML.
 96          *
 97          * @param version The version number of the feature being tested.
 98          * This is interpreted as &quot;Version of the DOM API supported for the
 99          * specified Feature&quot;, and in Level 1 should be &quot;1.0&quot;
100          *
101          * @return true if this implementation is compatible with the specified
102          * feature and version.
103          */
104         public boolean hasFeature(String feature, String version) {
105 
106             boolean anyVersion = version == null || version.length() == 0;
107 
108             if (feature.startsWith(&quot;+&quot;)) {
109                 feature = feature.substring(1);
110             }
111             return (feature.equalsIgnoreCase(&quot;Core&quot;)
<span class="line-modified">112                         &amp;&amp; (anyVersion</span>
<span class="line-modified">113                             || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">114                             || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">115                             || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">116                     || (feature.equalsIgnoreCase(&quot;XML&quot;)</span>
<span class="line-modified">117                         &amp;&amp; (anyVersion</span>
<span class="line-modified">118                             || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">119                             || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">120                             || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">121                     || (feature.equalsIgnoreCase(&quot;LS&quot;)</span>
<span class="line-modified">122                         &amp;&amp; (anyVersion</span>
<span class="line-modified">123                             || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">124                     || (feature.equalsIgnoreCase(&quot;ElementTraversal&quot;)</span>
<span class="line-modified">125                         &amp;&amp; (anyVersion</span>
<span class="line-modified">126                             || version.equals(&quot;1.0&quot;)));</span>




127         } // hasFeature(String,String):boolean
128 
129 
130         /**
131          * Introduced in DOM Level 2. &lt;p&gt;
132          *
133          * Creates an empty DocumentType node.
134          *
135          * @param qualifiedName The qualified name of the document type to be created.
136          * @param publicID The document type public identifier.
137          * @param systemID The document type system identifier.
138          * @since WD-DOM-Level-2-19990923
139          */
140         public DocumentType createDocumentType( String qualifiedName,
141                                     String publicID, String systemID) {
142                 // REVISIT: this might allow creation of invalid name for DOCTYPE
143                 //          xmlns prefix.
144                 //          also there is no way for a user to turn off error checking.
145                 checkQName(qualifiedName);
146                 return new DocumentTypeImpl(null, qualifiedName, publicID, systemID);
</pre>
<hr />
<pre>
227          *                         Node.ownerDocument attribute is set to
228          *                         the document being created.
229          * @return Document        A new Document object.
230          * @throws DOMException    WRONG_DOCUMENT_ERR: Raised if doctype has
231          *                         already been used with a different document.
232          * @since WD-DOM-Level-2-19990923
233          */
234         public Document createDocument(
235                 String namespaceURI,
236                 String qualifiedName,
237                 DocumentType doctype)
238                 throws DOMException {
239                 if (doctype != null &amp;&amp; doctype.getOwnerDocument() != null) {
240                         String msg =
241                                 DOMMessageFormatter.formatMessage(
242                                         DOMMessageFormatter.DOM_DOMAIN,
243                                         &quot;WRONG_DOCUMENT_ERR&quot;,
244                                         null);
245                         throw new DOMException(DOMException.WRONG_DOCUMENT_ERR, msg);
246                 }
<span class="line-modified">247                 CoreDocumentImpl doc = new CoreDocumentImpl(doctype);</span>
<span class="line-modified">248                 Element e = doc.createElementNS(namespaceURI, qualifiedName);</span>
<span class="line-modified">249                 doc.appendChild(e);</span>



250                 return doc;
251         }
252 




253         /**
254          * DOM Level 3 WD - Experimental.
255          */
256         public Object getFeature(String feature, String version) {
257             if (singleton.hasFeature(feature, version)) {
<span class="line-modified">258                 return singleton;</span>
<span class="line-modified">259             }</span>
260             return null;
261         }
262 
263         // DOM L3 LS
264 
265         /**
266          * DOM Level 3 LS CR - Experimental.
267      * Create a new &lt;code&gt;LSParser&lt;/code&gt;. The newly constructed parser may
268      * then be configured by means of its &lt;code&gt;DOMConfiguration&lt;/code&gt;
269      * object, and used to parse documents by means of its &lt;code&gt;parse&lt;/code&gt;
270      *  method.
271      * @param mode  The &lt;code&gt;mode&lt;/code&gt; argument is either
272      *   &lt;code&gt;MODE_SYNCHRONOUS&lt;/code&gt; or &lt;code&gt;MODE_ASYNCHRONOUS&lt;/code&gt;, if
273      *   &lt;code&gt;mode&lt;/code&gt; is &lt;code&gt;MODE_SYNCHRONOUS&lt;/code&gt; then the
274      *   &lt;code&gt;LSParser&lt;/code&gt; that is created will operate in synchronous
275      *   mode, if it&#39;s &lt;code&gt;MODE_ASYNCHRONOUS&lt;/code&gt; then the
276      *   &lt;code&gt;LSParser&lt;/code&gt; that is created will operate in asynchronous
277      *   mode.
278      * @param schemaType  An absolute URI representing the type of the schema
279      *   language used during the load of a &lt;code&gt;Document&lt;/code&gt; using the
</pre>
<hr />
<pre>
287      *   &lt;code&gt;&quot;http://www.w3.org/2001/XMLSchema&quot;&lt;/code&gt;. For XML DTD [&lt;a href=&#39;http://www.w3.org/TR/2000/REC-xml-20001006&#39;&gt;XML 1.0&lt;/a&gt;],
288      *   applications must use the value
289      *   &lt;code&gt;&quot;http://www.w3.org/TR/REC-xml&quot;&lt;/code&gt;. Other Schema languages
290      *   are outside the scope of the W3C and therefore should recommend an
291      *   absolute URI in order to use this method.
292      * @return  The newly created &lt;code&gt;LSParser&lt;/code&gt; object. This
293      *   &lt;code&gt;LSParser&lt;/code&gt; is either synchronous or asynchronous
294      *   depending on the value of the &lt;code&gt;mode&lt;/code&gt; argument.
295      * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created &lt;code&gt;LSParser&lt;/code&gt;
296      *    does not contain a &lt;code&gt;DOMErrorHandler&lt;/code&gt;, i.e. the value of
297      *   the &quot;&lt;a href=&#39;http://www.w3.org/TR/2003/WD-DOM-Level-3-Core-20030609/core.html#parameter-error-handler&#39;&gt;
298      *   error-handler&lt;/a&gt;&quot; configuration parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations
299      *   may provide a default error handler at creation time. In that case,
300      *   the initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration
301      *   parameter on the new created &lt;code&gt;LSParser&lt;/code&gt; contains a
302      *   reference to the default error handler.
303      * @exception DOMException
304      *    NOT_SUPPORTED_ERR: Raised if the requested mode or schema type is
305      *   not supported.
306          */
<span class="line-modified">307         public LSParser createLSParser(short mode, String schemaType)</span>
308                 throws DOMException {
309                 if (mode != DOMImplementationLS.MODE_SYNCHRONOUS || (schemaType !=null &amp;&amp;
310                    !&quot;http://www.w3.org/2001/XMLSchema&quot;.equals(schemaType) &amp;&amp;
311                         !&quot;http://www.w3.org/TR/REC-xml&quot;.equals(schemaType))) {
312                         String msg =
313                                 DOMMessageFormatter.formatMessage(
314                                         DOMMessageFormatter.DOM_DOMAIN,
315                                         &quot;NOT_SUPPORTED_ERR&quot;,
316                                         null);
317                         throw new DOMException(DOMException.NOT_SUPPORTED_ERR, msg);
318                 }
319                 if (schemaType != null
320                         &amp;&amp; schemaType.equals(&quot;http://www.w3.org/TR/REC-xml&quot;)) {
<span class="line-modified">321                         return new DOMParserImpl(new DTDConfiguration(),</span>
322                                 schemaType);
323                 }
324                 else {
325                         // create default parser configuration validating against XMLSchemas
326                         return new DOMParserImpl(new XIncludeAwareParserConfiguration(),
327                                 schemaType);
328                 }
329         }
330 
<span class="line-modified">331         /**</span>
<span class="line-modified">332          * DOM Level 3 LS CR - Experimental.</span>
<span class="line-modified">333          * Create a new &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">334          * @return The newly created &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">335          * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created</span>
<span class="line-modified">336          * &lt;code&gt;LSSerializer&lt;/code&gt; has no &lt;code&gt;DOMErrorHandler&lt;/code&gt;,</span>
<span class="line-modified">337          * i.e. the value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">338          * parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations may</span>
<span class="line-modified">339          * provide a default error handler at creation time. In that case, the</span>
<span class="line-modified">340          * initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">341          * parameter on the new created &lt;code&gt;LSSerializer&lt;/code&gt; contains a</span>
<span class="line-modified">342          * reference to the default error handler.</span>
<span class="line-modified">343          */</span>
<span class="line-modified">344         public LSSerializer createLSSerializer() {</span>
345             return new com.sun.org.apache.xml.internal.serializer.dom3.LSSerializerImpl();
346         }
347 
348         /**
349          * DOM Level 3 LS CR - Experimental.
350          * Create a new empty input source.
351          * @return  The newly created input object.
352          */
353         public LSInput createLSInput() {
354                 return new DOMInputImpl();
355         }
356 
357         //
358         // Protected methods
359         //
360         /** NON-DOM: retrieve validator. */
<span class="line-modified">361         synchronized RevalidationHandler getValidator(String schemaType) {</span>
<span class="line-removed">362                 // REVISIT: implement retrieving DTD validator</span>
363         if (schemaType == XMLGrammarDescription.XML_SCHEMA) {
364             // create new validator - we should not attempt
365             // to restrict the number of validation handlers being
366             // requested
<span class="line-modified">367             if(freeValidatorIndex &lt; 0) {</span>
<span class="line-modified">368                 return new com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator();</span>









369             }
<span class="line-modified">370             // return first available validator</span>
<span class="line-removed">371             RevalidationHandler val = validators[freeValidatorIndex];</span>
<span class="line-removed">372             validators[freeValidatorIndex--] = null;</span>
<span class="line-removed">373             return val;</span>
374         }
375         else if(schemaType == XMLGrammarDescription.XML_DTD) {
<span class="line-modified">376             if(freeDTDValidatorIndex &lt; 0) {</span>
<span class="line-modified">377                 return new com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDValidator();</span>





























378             }
<span class="line-removed">379             // return first available validator</span>
<span class="line-removed">380             RevalidationHandler val = dtdValidators[freeDTDValidatorIndex];</span>
<span class="line-removed">381             dtdValidators[freeDTDValidatorIndex--] = null;</span>
<span class="line-removed">382             return val;</span>
383         }
384         return null;
385         }
386 
387         /** NON-DOM: release validator */
<span class="line-modified">388         synchronized void releaseValidator(String schemaType,</span>
<span class="line-modified">389                                          RevalidationHandler validator) {</span>
<span class="line-modified">390        // REVISIT: implement support for DTD validators as well</span>
<span class="line-modified">391        if(schemaType == XMLGrammarDescription.XML_SCHEMA) {</span>
<span class="line-modified">392            ++freeValidatorIndex;</span>
<span class="line-modified">393            if (validators.length == freeValidatorIndex ){</span>
<span class="line-modified">394                 // resize size of the validators</span>
<span class="line-modified">395                 currentSize+=SIZE;</span>
<span class="line-modified">396                 RevalidationHandler newarray[] =  new RevalidationHandler[currentSize];</span>
<span class="line-modified">397                 System.arraycopy(validators, 0, newarray, 0, validators.length);</span>
<span class="line-modified">398                 validators = newarray;</span>
<span class="line-modified">399            }</span>
<span class="line-modified">400            validators[freeValidatorIndex]=validator;</span>
<span class="line-modified">401        }</span>
<span class="line-modified">402        else if(schemaType == XMLGrammarDescription.XML_DTD) {</span>
<span class="line-modified">403            ++freeDTDValidatorIndex;</span>
<span class="line-modified">404            if (dtdValidators.length == freeDTDValidatorIndex ){</span>
<span class="line-modified">405                 // resize size of the validators</span>
<span class="line-modified">406                 currentSize+=SIZE;</span>
<span class="line-modified">407                 RevalidationHandler newarray[] =  new RevalidationHandler[currentSize];</span>
<span class="line-modified">408                 System.arraycopy(dtdValidators, 0, newarray, 0, dtdValidators.length);</span>
<span class="line-modified">409                 dtdValidators = newarray;</span>
<span class="line-modified">410            }</span>
<span class="line-modified">411            dtdValidators[freeDTDValidatorIndex]=validator;</span>
<span class="line-modified">412        }</span>






































413         }
414 
<span class="line-modified">415        /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-modified">416        protected synchronized int assignDocumentNumber() {</span>
<span class="line-modified">417             return ++docAndDoctypeCounter;</span>
<span class="line-modified">418        }</span>
<span class="line-modified">419        /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-modified">420        protected synchronized int assignDocTypeNumber() {</span>
<span class="line-modified">421             return ++docAndDoctypeCounter;</span>
<span class="line-modified">422        }</span>

















































































423 
424     /* DOM Level 3 LS CR - Experimental.
425      *
426      * Create a new empty output destination object where
427      * &lt;code&gt;LSOutput.characterStream&lt;/code&gt;,
428      * &lt;code&gt;LSOutput.byteStream&lt;/code&gt;, &lt;code&gt;LSOutput.systemId&lt;/code&gt;,
429      * &lt;code&gt;LSOutput.encoding&lt;/code&gt; are null.
<span class="line-removed">430 </span>
431      * @return  The newly created output object.









432      */
<span class="line-modified">433        public LSOutput createLSOutput() {</span>
<span class="line-modified">434            return new DOMOutputImpl();</span>
<span class="line-modified">435        }</span>














436 
437 } // class DOMImplementationImpl
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 /*
  5  * Licensed to the Apache Software Foundation (ASF) under one or more
  6  * contributor license agreements.  See the NOTICE file distributed with
  7  * this work for additional information regarding copyright ownership.
  8  * The ASF licenses this file to You under the Apache License, Version 2.0
  9  * (the &quot;License&quot;); you may not use this file except in compliance with
 10  * the License.  You may obtain a copy of the License at
 11  *
 12  *      http://www.apache.org/licenses/LICENSE-2.0
 13  *
 14  * Unless required by applicable law or agreed to in writing, software
 15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 17  * See the License for the specific language governing permissions and
 18  * limitations under the License.
 19  */
 20 package com.sun.org.apache.xerces.internal.dom;
 21 
 22 import com.sun.org.apache.xerces.internal.impl.RevalidationHandler;
<span class="line-added"> 23 import com.sun.org.apache.xerces.internal.impl.dtd.XML11DTDProcessor;</span>
<span class="line-added"> 24 import com.sun.org.apache.xerces.internal.impl.dtd.XML11DTDValidator;</span>
<span class="line-added"> 25 import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDLoader;</span>
<span class="line-added"> 26 import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDValidator;</span>
<span class="line-added"> 27 import com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator;</span>
 28 import com.sun.org.apache.xerces.internal.parsers.DOMParserImpl;
 29 import com.sun.org.apache.xerces.internal.parsers.DTDConfiguration;
 30 import com.sun.org.apache.xerces.internal.parsers.XIncludeAwareParserConfiguration;
<span class="line-added"> 31 import com.sun.org.apache.xerces.internal.parsers.XML11DTDConfiguration;</span>
 32 import com.sun.org.apache.xerces.internal.util.XMLChar;
 33 import com.sun.org.apache.xerces.internal.xni.grammars.XMLGrammarDescription;
<span class="line-added"> 34 import java.lang.ref.SoftReference;</span>
 35 import org.w3c.dom.DOMException;
 36 import org.w3c.dom.DOMImplementation;
 37 import org.w3c.dom.Document;
 38 import org.w3c.dom.DocumentType;
 39 import org.w3c.dom.Element;
 40 import org.w3c.dom.ls.LSParser;
 41 import org.w3c.dom.ls.DOMImplementationLS;
 42 import org.w3c.dom.ls.LSInput;
 43 import org.w3c.dom.ls.LSOutput;
 44 import org.w3c.dom.ls.LSSerializer;
 45 /**
 46  * The DOMImplementation class is description of a particular
 47  * implementation of the Document Object Model. As such its data is
 48  * static, shared by all instances of this implementation.
 49  * &lt;P&gt;
 50  * The DOM API requires that it be a real object rather than static
 51  * methods. However, there&#39;s nothing that says it can&#39;t be a singleton,
 52  * so that&#39;s how I&#39;ve implemented it.
 53  * &lt;P&gt;
 54  * This particular class, along with CoreDocumentImpl, supports the DOM
 55  * Core and Load/Save (Experimental). Optional modules are supported by
 56  * the more complete DOMImplementation class along with DocumentImpl.
 57  *
 58  * @xerces.internal
 59  *
 60  * @since PR-DOM-Level-1-19980818.
<span class="line-added"> 61  * @LastModified: Apr 2019</span>
 62  */
<span class="line-added"> 63 @SuppressWarnings({&quot;rawtypes&quot;, &quot;unchecked&quot;}) //SoftReference array</span>
 64 public class CoreDOMImplementationImpl
 65         implements DOMImplementation, DOMImplementationLS {



 66 
<span class="line-modified"> 67     //</span>
<span class="line-added"> 68     // Data</span>
<span class="line-added"> 69     //</span>
<span class="line-added"> 70 </span>
<span class="line-added"> 71     // validator pools</span>
 72     private static final int SIZE = 2;

 73 
<span class="line-modified"> 74     private SoftReference schemaValidators[] = new SoftReference[SIZE];</span>
<span class="line-modified"> 75     private SoftReference xml10DTDValidators[] = new SoftReference[SIZE];</span>
<span class="line-modified"> 76     private SoftReference xml11DTDValidators[] = new SoftReference[SIZE];</span>
<span class="line-modified"> 77 </span>
<span class="line-added"> 78     private int freeSchemaValidatorIndex = -1;</span>
<span class="line-added"> 79     private int freeXML10DTDValidatorIndex = -1;</span>
<span class="line-added"> 80     private int freeXML11DTDValidatorIndex = -1;</span>
<span class="line-added"> 81 </span>
<span class="line-added"> 82     private int schemaValidatorsCurrentSize = SIZE;</span>
<span class="line-added"> 83     private int xml10DTDValidatorsCurrentSize = SIZE;</span>
<span class="line-added"> 84     private int xml11DTDValidatorsCurrentSize = SIZE;</span>
<span class="line-added"> 85 </span>
<span class="line-added"> 86     private SoftReference xml10DTDLoaders[] = new SoftReference[SIZE];</span>
<span class="line-added"> 87     private SoftReference xml11DTDLoaders[] = new SoftReference[SIZE];</span>
<span class="line-added"> 88 </span>
<span class="line-added"> 89     private int freeXML10DTDLoaderIndex = -1;</span>
<span class="line-added"> 90     private int freeXML11DTDLoaderIndex = -1;</span>
<span class="line-added"> 91 </span>
<span class="line-added"> 92     private int xml10DTDLoaderCurrentSize = SIZE;</span>
<span class="line-added"> 93     private int xml11DTDLoaderCurrentSize = SIZE;</span>
 94 
 95     // Document and doctype counter.  Used to assign order to documents and
 96     // doctypes without owners, on an demand basis.   Used for
 97     // compareDocumentPosition
 98     private int docAndDoctypeCounter = 0;
 99 
100         // static
101         /** Dom implementation singleton. */
<span class="line-modified">102         static final CoreDOMImplementationImpl singleton = new CoreDOMImplementationImpl();</span>
<span class="line-modified">103 </span>
104         //
105         // Public methods
106         //
107         /** NON-DOM: Obtain and return the single shared object */
108         public static DOMImplementation getDOMImplementation() {
109                 return singleton;
110         }
111         //
112         // DOMImplementation methods
113         //
114         /**
115          * Test if the DOM implementation supports a specific &quot;feature&quot; --
116          * currently meaning language and level thereof.
117          *
118          * @param feature The package name of the feature to test.
119          * In Level 1, supported values are &quot;HTML&quot; and &quot;XML&quot; (case-insensitive).
120          * At this writing, com.sun.org.apache.xerces.internal.dom supports only XML.
121          *
122          * @param version The version number of the feature being tested.
123          * This is interpreted as &quot;Version of the DOM API supported for the
124          * specified Feature&quot;, and in Level 1 should be &quot;1.0&quot;
125          *
126          * @return true if this implementation is compatible with the specified
127          * feature and version.
128          */
129         public boolean hasFeature(String feature, String version) {
130 
131             boolean anyVersion = version == null || version.length() == 0;
132 
133             if (feature.startsWith(&quot;+&quot;)) {
134                 feature = feature.substring(1);
135             }
136             return (feature.equalsIgnoreCase(&quot;Core&quot;)
<span class="line-modified">137                     &amp;&amp; (anyVersion</span>
<span class="line-modified">138                         || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">139                         || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">140                         || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">141                         || (feature.equalsIgnoreCase(&quot;XML&quot;)</span>
<span class="line-modified">142                     &amp;&amp; (anyVersion</span>
<span class="line-modified">143                         || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">144                         || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">145                         || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">146                         || (feature.equalsIgnoreCase(&quot;XMLVersion&quot;)</span>
<span class="line-modified">147                     &amp;&amp; (anyVersion</span>
<span class="line-modified">148                         || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">149                         || version.equals(&quot;1.1&quot;)))</span>
<span class="line-modified">150                         || (feature.equalsIgnoreCase(&quot;LS&quot;)</span>
<span class="line-modified">151                     &amp;&amp; (anyVersion</span>
<span class="line-added">152                         || version.equals(&quot;3.0&quot;)))</span>
<span class="line-added">153                         || (feature.equalsIgnoreCase(&quot;ElementTraversal&quot;)</span>
<span class="line-added">154                     &amp;&amp; (anyVersion</span>
<span class="line-added">155                         || version.equals(&quot;1.0&quot;)));</span>
156         } // hasFeature(String,String):boolean
157 
158 
159         /**
160          * Introduced in DOM Level 2. &lt;p&gt;
161          *
162          * Creates an empty DocumentType node.
163          *
164          * @param qualifiedName The qualified name of the document type to be created.
165          * @param publicID The document type public identifier.
166          * @param systemID The document type system identifier.
167          * @since WD-DOM-Level-2-19990923
168          */
169         public DocumentType createDocumentType( String qualifiedName,
170                                     String publicID, String systemID) {
171                 // REVISIT: this might allow creation of invalid name for DOCTYPE
172                 //          xmlns prefix.
173                 //          also there is no way for a user to turn off error checking.
174                 checkQName(qualifiedName);
175                 return new DocumentTypeImpl(null, qualifiedName, publicID, systemID);
</pre>
<hr />
<pre>
256          *                         Node.ownerDocument attribute is set to
257          *                         the document being created.
258          * @return Document        A new Document object.
259          * @throws DOMException    WRONG_DOCUMENT_ERR: Raised if doctype has
260          *                         already been used with a different document.
261          * @since WD-DOM-Level-2-19990923
262          */
263         public Document createDocument(
264                 String namespaceURI,
265                 String qualifiedName,
266                 DocumentType doctype)
267                 throws DOMException {
268                 if (doctype != null &amp;&amp; doctype.getOwnerDocument() != null) {
269                         String msg =
270                                 DOMMessageFormatter.formatMessage(
271                                         DOMMessageFormatter.DOM_DOMAIN,
272                                         &quot;WRONG_DOCUMENT_ERR&quot;,
273                                         null);
274                         throw new DOMException(DOMException.WRONG_DOCUMENT_ERR, msg);
275                 }
<span class="line-modified">276                 CoreDocumentImpl doc = createDocument(doctype);</span>
<span class="line-modified">277                 // If namespaceURI and qualifiedName are null return a Document with no document element.</span>
<span class="line-modified">278                 if (qualifiedName != null || namespaceURI != null) {</span>
<span class="line-added">279                     Element e = doc.createElementNS(namespaceURI, qualifiedName);</span>
<span class="line-added">280                     doc.appendChild(e);</span>
<span class="line-added">281                 }</span>
282                 return doc;
283         }
284 
<span class="line-added">285         protected CoreDocumentImpl createDocument(DocumentType doctype) {</span>
<span class="line-added">286             return new CoreDocumentImpl(doctype);</span>
<span class="line-added">287         }</span>
<span class="line-added">288 </span>
289         /**
290          * DOM Level 3 WD - Experimental.
291          */
292         public Object getFeature(String feature, String version) {
293             if (singleton.hasFeature(feature, version)) {
<span class="line-modified">294                     return singleton;</span>
<span class="line-modified">295                 }</span>
296             return null;
297         }
298 
299         // DOM L3 LS
300 
301         /**
302          * DOM Level 3 LS CR - Experimental.
303      * Create a new &lt;code&gt;LSParser&lt;/code&gt;. The newly constructed parser may
304      * then be configured by means of its &lt;code&gt;DOMConfiguration&lt;/code&gt;
305      * object, and used to parse documents by means of its &lt;code&gt;parse&lt;/code&gt;
306      *  method.
307      * @param mode  The &lt;code&gt;mode&lt;/code&gt; argument is either
308      *   &lt;code&gt;MODE_SYNCHRONOUS&lt;/code&gt; or &lt;code&gt;MODE_ASYNCHRONOUS&lt;/code&gt;, if
309      *   &lt;code&gt;mode&lt;/code&gt; is &lt;code&gt;MODE_SYNCHRONOUS&lt;/code&gt; then the
310      *   &lt;code&gt;LSParser&lt;/code&gt; that is created will operate in synchronous
311      *   mode, if it&#39;s &lt;code&gt;MODE_ASYNCHRONOUS&lt;/code&gt; then the
312      *   &lt;code&gt;LSParser&lt;/code&gt; that is created will operate in asynchronous
313      *   mode.
314      * @param schemaType  An absolute URI representing the type of the schema
315      *   language used during the load of a &lt;code&gt;Document&lt;/code&gt; using the
</pre>
<hr />
<pre>
323      *   &lt;code&gt;&quot;http://www.w3.org/2001/XMLSchema&quot;&lt;/code&gt;. For XML DTD [&lt;a href=&#39;http://www.w3.org/TR/2000/REC-xml-20001006&#39;&gt;XML 1.0&lt;/a&gt;],
324      *   applications must use the value
325      *   &lt;code&gt;&quot;http://www.w3.org/TR/REC-xml&quot;&lt;/code&gt;. Other Schema languages
326      *   are outside the scope of the W3C and therefore should recommend an
327      *   absolute URI in order to use this method.
328      * @return  The newly created &lt;code&gt;LSParser&lt;/code&gt; object. This
329      *   &lt;code&gt;LSParser&lt;/code&gt; is either synchronous or asynchronous
330      *   depending on the value of the &lt;code&gt;mode&lt;/code&gt; argument.
331      * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created &lt;code&gt;LSParser&lt;/code&gt;
332      *    does not contain a &lt;code&gt;DOMErrorHandler&lt;/code&gt;, i.e. the value of
333      *   the &quot;&lt;a href=&#39;http://www.w3.org/TR/2003/WD-DOM-Level-3-Core-20030609/core.html#parameter-error-handler&#39;&gt;
334      *   error-handler&lt;/a&gt;&quot; configuration parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations
335      *   may provide a default error handler at creation time. In that case,
336      *   the initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration
337      *   parameter on the new created &lt;code&gt;LSParser&lt;/code&gt; contains a
338      *   reference to the default error handler.
339      * @exception DOMException
340      *    NOT_SUPPORTED_ERR: Raised if the requested mode or schema type is
341      *   not supported.
342          */
<span class="line-modified">343     public LSParser createLSParser(short mode, String schemaType)</span>
344                 throws DOMException {
345                 if (mode != DOMImplementationLS.MODE_SYNCHRONOUS || (schemaType !=null &amp;&amp;
346                    !&quot;http://www.w3.org/2001/XMLSchema&quot;.equals(schemaType) &amp;&amp;
347                         !&quot;http://www.w3.org/TR/REC-xml&quot;.equals(schemaType))) {
348                         String msg =
349                                 DOMMessageFormatter.formatMessage(
350                                         DOMMessageFormatter.DOM_DOMAIN,
351                                         &quot;NOT_SUPPORTED_ERR&quot;,
352                                         null);
353                         throw new DOMException(DOMException.NOT_SUPPORTED_ERR, msg);
354                 }
355                 if (schemaType != null
356                         &amp;&amp; schemaType.equals(&quot;http://www.w3.org/TR/REC-xml&quot;)) {
<span class="line-modified">357                         return new DOMParserImpl(new XML11DTDConfiguration(),</span>
358                                 schemaType);
359                 }
360                 else {
361                         // create default parser configuration validating against XMLSchemas
362                         return new DOMParserImpl(new XIncludeAwareParserConfiguration(),
363                                 schemaType);
364                 }
365         }
366 
<span class="line-modified">367     /**</span>
<span class="line-modified">368      * DOM Level 3 LS CR - Experimental.</span>
<span class="line-modified">369      * Create a new &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">370      * @return The newly created &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">371      * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created</span>
<span class="line-modified">372      * &lt;code&gt;LSSerializer&lt;/code&gt; has no &lt;code&gt;DOMErrorHandler&lt;/code&gt;,</span>
<span class="line-modified">373      * i.e. the value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">374      * parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations may</span>
<span class="line-modified">375      * provide a default error handler at creation time. In that case, the</span>
<span class="line-modified">376      * initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">377      * parameter on the new created &lt;code&gt;LSSerializer&lt;/code&gt; contains a</span>
<span class="line-modified">378      * reference to the default error handler.</span>
<span class="line-modified">379      */</span>
<span class="line-modified">380     public LSSerializer createLSSerializer() {</span>
381             return new com.sun.org.apache.xml.internal.serializer.dom3.LSSerializerImpl();
382         }
383 
384         /**
385          * DOM Level 3 LS CR - Experimental.
386          * Create a new empty input source.
387          * @return  The newly created input object.
388          */
389         public LSInput createLSInput() {
390                 return new DOMInputImpl();
391         }
392 
393         //
394         // Protected methods
395         //
396         /** NON-DOM: retrieve validator. */
<span class="line-modified">397         synchronized RevalidationHandler getValidator(String schemaType, String xmlVersion) {</span>

398         if (schemaType == XMLGrammarDescription.XML_SCHEMA) {
399             // create new validator - we should not attempt
400             // to restrict the number of validation handlers being
401             // requested
<span class="line-modified">402             while (freeSchemaValidatorIndex &gt;= 0) {</span>
<span class="line-modified">403                 // return first available validator</span>
<span class="line-added">404                 SoftReference ref = schemaValidators[freeSchemaValidatorIndex];</span>
<span class="line-added">405                 RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">406                 if (holder != null &amp;&amp; holder.handler != null) {</span>
<span class="line-added">407                     RevalidationHandler val = holder.handler;</span>
<span class="line-added">408                     holder.handler = null;</span>
<span class="line-added">409                     --freeSchemaValidatorIndex;</span>
<span class="line-added">410                     return val;</span>
<span class="line-added">411                 }</span>
<span class="line-added">412                 schemaValidators[freeSchemaValidatorIndex--] = null;</span>
413             }
<span class="line-modified">414             return new XMLSchemaValidator();</span>



415         }
416         else if(schemaType == XMLGrammarDescription.XML_DTD) {
<span class="line-modified">417             // return an instance of XML11DTDValidator</span>
<span class="line-modified">418             if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-added">419                 while (freeXML11DTDValidatorIndex &gt;= 0) {</span>
<span class="line-added">420                     // return first available validator</span>
<span class="line-added">421                     SoftReference ref = xml11DTDValidators[freeXML11DTDValidatorIndex];</span>
<span class="line-added">422                     RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">423                     if (holder != null &amp;&amp; holder.handler != null) {</span>
<span class="line-added">424                         RevalidationHandler val = holder.handler;</span>
<span class="line-added">425                         holder.handler = null;</span>
<span class="line-added">426                         --freeXML11DTDValidatorIndex;</span>
<span class="line-added">427                         return val;</span>
<span class="line-added">428                     }</span>
<span class="line-added">429                     xml11DTDValidators[freeXML11DTDValidatorIndex--] = null;</span>
<span class="line-added">430                 }</span>
<span class="line-added">431                 return new XML11DTDValidator();</span>
<span class="line-added">432             }</span>
<span class="line-added">433             // return an instance of XMLDTDValidator</span>
<span class="line-added">434             else {</span>
<span class="line-added">435                 while (freeXML10DTDValidatorIndex &gt;= 0) {</span>
<span class="line-added">436                     // return first available validator</span>
<span class="line-added">437                     SoftReference ref = xml10DTDValidators[freeXML10DTDValidatorIndex];</span>
<span class="line-added">438                     RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">439                     if (holder != null &amp;&amp; holder.handler != null) {</span>
<span class="line-added">440                         RevalidationHandler val = holder.handler;</span>
<span class="line-added">441                         holder.handler = null;</span>
<span class="line-added">442                         --freeXML10DTDValidatorIndex;</span>
<span class="line-added">443                         return val;</span>
<span class="line-added">444                     }</span>
<span class="line-added">445                     xml10DTDValidators[freeXML10DTDValidatorIndex--] = null;</span>
<span class="line-added">446                 }</span>
<span class="line-added">447                 return new XMLDTDValidator();</span>
448             }




449         }
450         return null;
451         }
452 
453         /** NON-DOM: release validator */
<span class="line-modified">454         synchronized void releaseValidator(String schemaType, String xmlVersion,</span>
<span class="line-modified">455                 RevalidationHandler validator) {</span>
<span class="line-modified">456             if (schemaType == XMLGrammarDescription.XML_SCHEMA) {</span>
<span class="line-modified">457                 ++freeSchemaValidatorIndex;</span>
<span class="line-modified">458                 if (schemaValidators.length == freeSchemaValidatorIndex) {</span>
<span class="line-modified">459                     // resize size of the validators</span>
<span class="line-modified">460                     schemaValidatorsCurrentSize += SIZE;</span>
<span class="line-modified">461                     SoftReference newarray[] =  new SoftReference[schemaValidatorsCurrentSize];</span>
<span class="line-modified">462                     System.arraycopy(schemaValidators, 0, newarray, 0, schemaValidators.length);</span>
<span class="line-modified">463                     schemaValidators = newarray;</span>
<span class="line-modified">464                 }</span>
<span class="line-modified">465                 SoftReference ref = schemaValidators[freeSchemaValidatorIndex];</span>
<span class="line-modified">466                 if (ref != null) {</span>
<span class="line-modified">467                     RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-modified">468                     if (holder != null) {</span>
<span class="line-modified">469                         holder.handler = validator;</span>
<span class="line-modified">470                         return;</span>
<span class="line-modified">471                     }</span>
<span class="line-modified">472                 }</span>
<span class="line-modified">473                 schemaValidators[freeSchemaValidatorIndex] = new SoftReference(new RevalidationHandlerHolder(validator));</span>
<span class="line-modified">474             }</span>
<span class="line-modified">475             else if (schemaType == XMLGrammarDescription.XML_DTD) {</span>
<span class="line-modified">476                 // release an instance of XML11DTDValidator</span>
<span class="line-modified">477                 if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-modified">478                     ++freeXML11DTDValidatorIndex;</span>
<span class="line-added">479                     if (xml11DTDValidators.length == freeXML11DTDValidatorIndex) {</span>
<span class="line-added">480                         // resize size of the validators</span>
<span class="line-added">481                         xml11DTDValidatorsCurrentSize += SIZE;</span>
<span class="line-added">482                         SoftReference [] newarray = new SoftReference[xml11DTDValidatorsCurrentSize];</span>
<span class="line-added">483                         System.arraycopy(xml11DTDValidators, 0, newarray, 0, xml11DTDValidators.length);</span>
<span class="line-added">484                         xml11DTDValidators = newarray;</span>
<span class="line-added">485                     }</span>
<span class="line-added">486                     SoftReference ref = xml11DTDValidators[freeXML11DTDValidatorIndex];</span>
<span class="line-added">487                     if (ref != null) {</span>
<span class="line-added">488                         RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">489                         if (holder != null) {</span>
<span class="line-added">490                             holder.handler = validator;</span>
<span class="line-added">491                             return;</span>
<span class="line-added">492                         }</span>
<span class="line-added">493                     }</span>
<span class="line-added">494                     xml11DTDValidators[freeXML11DTDValidatorIndex] = new SoftReference(new RevalidationHandlerHolder(validator));</span>
<span class="line-added">495                 }</span>
<span class="line-added">496                 // release an instance of XMLDTDValidator</span>
<span class="line-added">497                 else {</span>
<span class="line-added">498                     ++freeXML10DTDValidatorIndex;</span>
<span class="line-added">499                     if (xml10DTDValidators.length == freeXML10DTDValidatorIndex) {</span>
<span class="line-added">500                         // resize size of the validators</span>
<span class="line-added">501                         xml10DTDValidatorsCurrentSize += SIZE;</span>
<span class="line-added">502                         SoftReference [] newarray = new SoftReference[xml10DTDValidatorsCurrentSize];</span>
<span class="line-added">503                         System.arraycopy(xml10DTDValidators, 0, newarray, 0, xml10DTDValidators.length);</span>
<span class="line-added">504                         xml10DTDValidators = newarray;</span>
<span class="line-added">505                     }</span>
<span class="line-added">506                     SoftReference ref = xml10DTDValidators[freeXML10DTDValidatorIndex];</span>
<span class="line-added">507                     if (ref != null) {</span>
<span class="line-added">508                         RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">509                         if (holder != null) {</span>
<span class="line-added">510                             holder.handler = validator;</span>
<span class="line-added">511                             return;</span>
<span class="line-added">512                         }</span>
<span class="line-added">513                     }</span>
<span class="line-added">514                     xml10DTDValidators[freeXML10DTDValidatorIndex] = new SoftReference(new RevalidationHandlerHolder(validator));</span>
<span class="line-added">515                 }</span>
<span class="line-added">516             }</span>
517         }
518 
<span class="line-modified">519     /** NON-DOM: retrieve DTD loader */</span>
<span class="line-modified">520     synchronized final XMLDTDLoader getDTDLoader(String xmlVersion) {</span>
<span class="line-modified">521         // return an instance of XML11DTDProcessor</span>
<span class="line-modified">522         if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-modified">523             while (freeXML11DTDLoaderIndex &gt;= 0) {</span>
<span class="line-modified">524                 // return first available DTD loader</span>
<span class="line-modified">525                 SoftReference ref = xml11DTDLoaders[freeXML11DTDLoaderIndex];</span>
<span class="line-modified">526                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">527                 if (holder != null &amp;&amp; holder.loader != null) {</span>
<span class="line-added">528                     XMLDTDLoader val = holder.loader;</span>
<span class="line-added">529                     holder.loader = null;</span>
<span class="line-added">530                     --freeXML11DTDLoaderIndex;</span>
<span class="line-added">531                     return val;</span>
<span class="line-added">532                 }</span>
<span class="line-added">533                 xml11DTDLoaders[freeXML11DTDLoaderIndex--] = null;</span>
<span class="line-added">534             }</span>
<span class="line-added">535             return new XML11DTDProcessor();</span>
<span class="line-added">536         }</span>
<span class="line-added">537         // return an instance of XMLDTDLoader</span>
<span class="line-added">538         else {</span>
<span class="line-added">539             while (freeXML10DTDLoaderIndex &gt;= 0) {</span>
<span class="line-added">540                 // return first available DTD loader</span>
<span class="line-added">541                 SoftReference ref = xml10DTDLoaders[freeXML10DTDLoaderIndex];</span>
<span class="line-added">542                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">543                 if (holder != null &amp;&amp; holder.loader != null) {</span>
<span class="line-added">544                     XMLDTDLoader val = holder.loader;</span>
<span class="line-added">545                     holder.loader = null;</span>
<span class="line-added">546                     --freeXML10DTDLoaderIndex;</span>
<span class="line-added">547                     return val;</span>
<span class="line-added">548                 }</span>
<span class="line-added">549                 xml10DTDLoaders[freeXML10DTDLoaderIndex--] = null;</span>
<span class="line-added">550             }</span>
<span class="line-added">551             return new XMLDTDLoader();</span>
<span class="line-added">552         }</span>
<span class="line-added">553     }</span>
<span class="line-added">554 </span>
<span class="line-added">555     /** NON-DOM: release DTD loader */</span>
<span class="line-added">556     synchronized final void releaseDTDLoader(String xmlVersion, XMLDTDLoader loader) {</span>
<span class="line-added">557         // release an instance of XMLDTDLoader</span>
<span class="line-added">558         if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-added">559             ++freeXML11DTDLoaderIndex;</span>
<span class="line-added">560             if (xml11DTDLoaders.length == freeXML11DTDLoaderIndex) {</span>
<span class="line-added">561                 // resize size of the DTD loaders</span>
<span class="line-added">562                 xml11DTDLoaderCurrentSize += SIZE;</span>
<span class="line-added">563                 SoftReference [] newarray = new SoftReference[xml11DTDLoaderCurrentSize];</span>
<span class="line-added">564                 System.arraycopy(xml11DTDLoaders, 0, newarray, 0, xml11DTDLoaders.length);</span>
<span class="line-added">565                 xml11DTDLoaders = newarray;</span>
<span class="line-added">566             }</span>
<span class="line-added">567             SoftReference ref = xml11DTDLoaders[freeXML11DTDLoaderIndex];</span>
<span class="line-added">568             if (ref != null) {</span>
<span class="line-added">569                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">570                 if (holder != null) {</span>
<span class="line-added">571                     holder.loader = loader;</span>
<span class="line-added">572                     return;</span>
<span class="line-added">573                 }</span>
<span class="line-added">574             }</span>
<span class="line-added">575             xml11DTDLoaders[freeXML11DTDLoaderIndex] = new SoftReference(new XMLDTDLoaderHolder(loader));</span>
<span class="line-added">576         }</span>
<span class="line-added">577         // release an instance of XMLDTDLoader</span>
<span class="line-added">578         else {</span>
<span class="line-added">579             ++freeXML10DTDLoaderIndex;</span>
<span class="line-added">580             if (xml10DTDLoaders.length == freeXML10DTDLoaderIndex) {</span>
<span class="line-added">581                 // resize size of the DTD loaders</span>
<span class="line-added">582                 xml10DTDLoaderCurrentSize += SIZE;</span>
<span class="line-added">583                 SoftReference [] newarray = new SoftReference[xml10DTDLoaderCurrentSize];</span>
<span class="line-added">584                 System.arraycopy(xml10DTDLoaders, 0, newarray, 0, xml10DTDLoaders.length);</span>
<span class="line-added">585                 xml10DTDLoaders = newarray;</span>
<span class="line-added">586             }</span>
<span class="line-added">587             SoftReference ref = xml10DTDLoaders[freeXML10DTDLoaderIndex];</span>
<span class="line-added">588             if (ref != null) {</span>
<span class="line-added">589                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">590                 if (holder != null) {</span>
<span class="line-added">591                     holder.loader = loader;</span>
<span class="line-added">592                     return;</span>
<span class="line-added">593                 }</span>
<span class="line-added">594             }</span>
<span class="line-added">595             xml10DTDLoaders[freeXML10DTDLoaderIndex] = new SoftReference(new XMLDTDLoaderHolder(loader));</span>
<span class="line-added">596         }</span>
<span class="line-added">597     }</span>
<span class="line-added">598 </span>
<span class="line-added">599     /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-added">600     protected synchronized int assignDocumentNumber() {</span>
<span class="line-added">601         return ++docAndDoctypeCounter;</span>
<span class="line-added">602     }</span>
<span class="line-added">603 </span>
<span class="line-added">604     /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-added">605     protected synchronized int assignDocTypeNumber() {</span>
<span class="line-added">606         return ++docAndDoctypeCounter;</span>
<span class="line-added">607     }</span>
608 
609     /* DOM Level 3 LS CR - Experimental.
610      *
611      * Create a new empty output destination object where
612      * &lt;code&gt;LSOutput.characterStream&lt;/code&gt;,
613      * &lt;code&gt;LSOutput.byteStream&lt;/code&gt;, &lt;code&gt;LSOutput.systemId&lt;/code&gt;,
614      * &lt;code&gt;LSOutput.encoding&lt;/code&gt; are null.

615      * @return  The newly created output object.
<span class="line-added">616     */</span>
<span class="line-added">617     public LSOutput createLSOutput() {</span>
<span class="line-added">618         return new DOMOutputImpl();</span>
<span class="line-added">619     }</span>
<span class="line-added">620 </span>
<span class="line-added">621     /**</span>
<span class="line-added">622      * A holder for RevalidationHandlers. This allows us to reuse</span>
<span class="line-added">623      * SoftReferences which haven&#39;t yet been cleared by the garbage</span>
<span class="line-added">624      * collector.</span>
625      */
<span class="line-modified">626     static final class RevalidationHandlerHolder {</span>
<span class="line-modified">627         RevalidationHandlerHolder(RevalidationHandler handler) {</span>
<span class="line-modified">628             this.handler = handler;</span>
<span class="line-added">629         }</span>
<span class="line-added">630         RevalidationHandler handler;</span>
<span class="line-added">631     }</span>
<span class="line-added">632 </span>
<span class="line-added">633     /**</span>
<span class="line-added">634      * A holder for XMLDTDLoaders. This allows us to reuse SoftReferences</span>
<span class="line-added">635      * which haven&#39;t yet been cleared by the garbage collector.</span>
<span class="line-added">636      */</span>
<span class="line-added">637     static final class XMLDTDLoaderHolder {</span>
<span class="line-added">638         XMLDTDLoaderHolder(XMLDTDLoader loader) {</span>
<span class="line-added">639             this.loader = loader;</span>
<span class="line-added">640         }</span>
<span class="line-added">641         XMLDTDLoader loader;</span>
<span class="line-added">642     }</span>
643 
644 } // class DOMImplementationImpl
</pre>
</td>
</tr>
</table>
<center><a href="ChildNode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CoreDocumentImpl.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>