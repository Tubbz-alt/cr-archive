<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.xml/share/classes/com/sun/org/apache/bcel/internal/util/ModularRuntimeImage.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /*
  6  * Licensed to the Apache Software Foundation (ASF) under one or more
  7  * contributor license agreements.  See the NOTICE file distributed with
  8  * this work for additional information regarding copyright ownership.
  9  * The ASF licenses this file to You under the Apache License, Version 2.0
 10  * (the &quot;License&quot;); you may not use this file except in compliance with
 11  * the License.  You may obtain a copy of the License at
 12  *
 13  *      http://www.apache.org/licenses/LICENSE-2.0
 14  *
 15  *  Unless required by applicable law or agreed to in writing, software
 16  *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 17  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 18  *  See the License for the specific language governing permissions and
 19  *  limitations under the License.
 20  *
 21  */
 22 package com.sun.org.apache.bcel.internal.util;
 23 
 24 import java.io.Closeable;
 25 import java.io.File;
 26 import java.io.IOException;
 27 import java.net.URI;
 28 import java.net.URL;
 29 import java.net.URLClassLoader;
 30 import java.nio.file.DirectoryStream;
 31 import java.nio.file.FileSystem;
 32 import java.nio.file.FileSystems;
 33 import java.nio.file.Files;
 34 import java.nio.file.Path;
 35 import java.nio.file.Paths;
 36 import java.util.ArrayList;
 37 import java.util.Collections;
 38 import java.util.Iterator;
 39 import java.util.List;
 40 import java.util.Map;
 41 
 42 /**
 43  * Wraps a Java 9 JEP 220 modular runtime image. Requires the JRT NIO file system.
 44  *
 45  * @since 6.3
 46  */
 47 public class ModularRuntimeImage implements Closeable {
 48 
 49     static final String MODULES_PATH = File.separator + &quot;modules&quot;;
 50     static final String PACKAGES_PATH = File.separator + &quot;packages&quot;;
 51 
 52     private final URLClassLoader classLoader;
 53     private final FileSystem fileSystem;
 54 
 55     /**
 56      * Constructs a default instance.
 57      *
 58      * @throws IOException
 59      *             an I/O error occurs accessing the file system
 60      */
 61     public ModularRuntimeImage() throws IOException {
 62         this(null, FileSystems.getFileSystem(URI.create(&quot;jrt:/&quot;)));
 63     }
 64 
 65     /**
 66      * Constructs an instance using the JRT file system implementation from a specific Java Home.
 67      *
 68      * @param javaHome
 69      *            Path to a Java 9 or greater home.
 70      *
 71      * @throws IOException
 72      *             an I/O error occurs accessing the file system
 73      */
 74     public ModularRuntimeImage(final String javaHome) throws IOException {
 75         final Map&lt;String, ?&gt; emptyMap = Collections.emptyMap();
 76         final Path jrePath = Paths.get(javaHome);
 77         final Path jrtFsPath = jrePath.resolve(&quot;lib&quot;).resolve(&quot;jrt-fs.jar&quot;);
 78         this.classLoader = new URLClassLoader(new URL[] {jrtFsPath.toUri().toURL() });
 79         this.fileSystem = FileSystems.newFileSystem(URI.create(&quot;jrt:/&quot;), emptyMap, classLoader);
 80     }
 81 
 82     private ModularRuntimeImage(final URLClassLoader cl, final FileSystem fs) {
 83         this.classLoader = cl;
 84         this.fileSystem = fs;
 85     }
 86 
 87     @Override
 88     public void close() throws IOException {
 89         if (classLoader != null) {
 90             classLoader.close();
 91         }
 92         if (fileSystem != null) {
 93             fileSystem.close();
 94         }
 95     }
 96 
 97     /**
 98      * Lists all entries in the given directory.
 99      *
100      * @param dirPath
101      *            directory path.
102      * @return a list of dir entries if an I/O error occurs
103      * @throws IOException
104      *             an I/O error occurs accessing the file system
105      */
106     public List&lt;Path&gt; list(final Path dirPath) throws IOException {
107         final List&lt;Path&gt; list = new ArrayList&lt;&gt;();
108         try (DirectoryStream&lt;Path&gt; ds = Files.newDirectoryStream(dirPath)) {
109             final Iterator&lt;Path&gt; iterator = ds.iterator();
110             while (iterator.hasNext()) {
111                 list.add(iterator.next());
112             }
113         }
114         return list;
115     }
116 
117     /**
118      * Lists all entries in the given directory.
119      *
120      * @param dirName
121      *            directory path.
122      * @return a list of dir entries if an I/O error occurs
123      * @throws IOException
124      *             an I/O error occurs accessing the file system
125      */
126     public List&lt;Path&gt; list(final String dirName) throws IOException {
127         return list(fileSystem.getPath(dirName));
128     }
129 
130     /**
131      * Lists all modules.
132      *
133      * @return a list of modules
134      * @throws IOException
135      *             an I/O error occurs accessing the file system
136      */
137     public List&lt;Path&gt; modules() throws IOException {
138         return list(MODULES_PATH);
139     }
140 
141     /**
142      * Lists all packages.
143      *
144      * @return a list of modules
145      * @throws IOException
146      *             an I/O error occurs accessing the file system
147      */
148     public List&lt;Path&gt; packages() throws IOException {
149         return list(PACKAGES_PATH);
150     }
151 
152     public FileSystem getFileSystem() {
153         return fileSystem;
154     }
155 
156 }
    </pre>
  </body>
</html>