<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.xml/share/classes/com/sun/org/apache/xerces/internal/impl/xs/traversers/XSDHandler.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="XSDComplexTypeTraverser.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../../index.html" target="_top">index</a> <a href="XSDSimpleTypeTraverser.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml/share/classes/com/sun/org/apache/xerces/internal/impl/xs/traversers/XSDHandler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2007, 2017, Oracle and/or its affiliates. All rights reserved.</span>
   */
  /*
   * Licensed to the Apache Software Foundation (ASF) under one or more
   * contributor license agreements.  See the NOTICE file distributed with
   * this work for additional information regarding copyright ownership.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2007, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   */
  /*
   * Licensed to the Apache Software Foundation (ASF) under one or more
   * contributor license agreements.  See the NOTICE file distributed with
   * this work for additional information regarding copyright ownership.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 58,10 ***</span>
<span class="line-new-header">--- 58,11 ---</span>
  import com.sun.org.apache.xerces.internal.util.StAXInputSource;
  import com.sun.org.apache.xerces.internal.util.StAXLocationWrapper;
  import com.sun.org.apache.xerces.internal.util.SymbolHash;
  import com.sun.org.apache.xerces.internal.util.SymbolTable;
  import com.sun.org.apache.xerces.internal.util.URI.MalformedURIException;
<span class="line-added">+ import com.sun.org.apache.xerces.internal.util.XMLChar;</span>
  import com.sun.org.apache.xerces.internal.util.XMLSymbols;
  import com.sun.org.apache.xerces.internal.utils.XMLSecurityManager;
  import com.sun.org.apache.xerces.internal.utils.XMLSecurityPropertyManager;
  import com.sun.org.apache.xerces.internal.xni.QName;
  import com.sun.org.apache.xerces.internal.xni.XNIException;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 127,11 ***</span>
   * @xerces.internal
   *
   * @author Neil Graham, IBM
   * @author Pavani Mukthipudi, Sun Microsystems
   *
<span class="line-modified">!  * @LastModified: Nov 2017</span>
   */
  @SuppressWarnings(&quot;deprecation&quot;) //org.xml.sax.helpers.XMLReaderFactory
  public class XSDHandler {
  
      /** Feature identifier: validation. */
<span class="line-new-header">--- 128,11 ---</span>
   * @xerces.internal
   *
   * @author Neil Graham, IBM
   * @author Pavani Mukthipudi, Sun Microsystems
   *
<span class="line-modified">!  * @LastModified: Apr 2019</span>
   */
  @SuppressWarnings(&quot;deprecation&quot;) //org.xml.sax.helpers.XMLReaderFactory
  public class XSDHandler {
  
      /** Feature identifier: validation. */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 589,14 ***</span>
                    referType, null);
  
          } //is instanceof XMLInputSource
  
          if (schemaRoot == null) {
<span class="line-removed">-             // something went wrong right off the hop</span>
              if (is instanceof XSInputSource) {
<span class="line-modified">!                 return fGrammarBucket.getGrammar(desc.getTargetNamespace());</span>
              }
              return grammar;
          }
  
          if (referType == XSDDescription.CONTEXT_PREPARSE) {
                  Element schemaElem = schemaRoot;
<span class="line-new-header">--- 590,31 ---</span>
                    referType, null);
  
          } //is instanceof XMLInputSource
  
          if (schemaRoot == null) {
              if (is instanceof XSInputSource) {
<span class="line-modified">!                 // Need to return a grammar. If the XSInputSource has a list</span>
<span class="line-added">+                 // of grammar objects, then get the first one and return it.</span>
<span class="line-added">+                 // If it has a list of components, then get the grammar that</span>
<span class="line-added">+                 // contains the first component and return it.</span>
<span class="line-added">+                 // If we return null, the XMLSchemaLoader will think nothing</span>
<span class="line-added">+                 // was loaded, and will not try to put the grammar objects</span>
<span class="line-added">+                 // into the grammar pool.</span>
<span class="line-added">+                 XSInputSource xsinput = (XSInputSource)is;</span>
<span class="line-added">+                 SchemaGrammar[] grammars = xsinput.getGrammars();</span>
<span class="line-added">+                 if (grammars != null &amp;&amp; grammars.length &gt; 0) {</span>
<span class="line-added">+                     grammar = fGrammarBucket.getGrammar(grammars[0].getTargetNamespace());</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 else {</span>
<span class="line-added">+                     XSObject[] components = xsinput.getComponents();</span>
<span class="line-added">+                     if (components != null &amp;&amp; components.length &gt; 0) {</span>
<span class="line-added">+                         grammar = fGrammarBucket.getGrammar(components[0].getNamespace());</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
              }
<span class="line-added">+             // something went wrong right off the hop</span>
              return grammar;
          }
  
          if (referType == XSDDescription.CONTEXT_PREPARSE) {
                  Element schemaElem = schemaRoot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1297,10 ***</span>
<span class="line-new-header">--- 1315,11 ---</span>
                          if (lName.length() == 0) // an error we&#39;ll catch later
                              continue;
                          String qName = currSchemaDoc.fTargetNamespace == null ?
                                  &quot;,&quot;+lName:
                                      currSchemaDoc.fTargetNamespace +&quot;,&quot;+lName;
<span class="line-added">+                         qName = XMLChar.trim(qName);</span>
                          String componentType = DOMUtil.getLocalName(redefineComp);
                          if (componentType.equals(SchemaSymbols.ELT_ATTRIBUTEGROUP)) {
                              checkForDuplicateNames(qName, ATTRIBUTEGROUP_TYPE, fUnparsedAttributeGroupRegistry, fUnparsedAttributeGroupRegistrySub, redefineComp, currSchemaDoc);
                              // the check will have changed our name;
                              String targetLName = DOMUtil.getAttrValue(redefineComp, SchemaSymbols.ATT_NAME)+REDEF_IDENTIFIER;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1341,10 ***</span>
<span class="line-new-header">--- 1360,11 ---</span>
                      if (lName.length() == 0) // an error we&#39;ll catch later
                          continue;
                      String qName = currSchemaDoc.fTargetNamespace == null?
                              &quot;,&quot;+lName:
                                  currSchemaDoc.fTargetNamespace +&quot;,&quot;+lName;
<span class="line-added">+                     qName = XMLChar.trim(qName);</span>
                      String componentType = DOMUtil.getLocalName(globalComp);
  
                      if (componentType.equals(SchemaSymbols.ELT_ATTRIBUTE)) {
                          checkForDuplicateNames(qName, ATTRIBUTE_TYPE, fUnparsedAttributeRegistry, fUnparsedAttributeRegistrySub, globalComp, currSchemaDoc);
                      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2464,13 ***</span>
              Document schemaDocument = fStAXSchemaParser.getDocument();
              schemaElement = schemaDocument != null ? DOMUtil.getRoot(schemaDocument) : null;
              return getSchemaDocument0(key, schemaId, schemaElement);
          }
          catch (XMLStreamException e) {
<span class="line-modified">!             StAXLocationWrapper slw = new StAXLocationWrapper();</span>
<span class="line-modified">!             slw.setLocation(e.getLocation());</span>
<span class="line-modified">!             throw new XMLParseException(slw, e.getMessage(), e);</span>
          }
          catch (IOException e) {
              exception = e;
          }
          return getSchemaDocument1(mustResolve, true, schemaSource, referElement, exception);
<span class="line-new-header">--- 2484,19 ---</span>
              Document schemaDocument = fStAXSchemaParser.getDocument();
              schemaElement = schemaDocument != null ? DOMUtil.getRoot(schemaDocument) : null;
              return getSchemaDocument0(key, schemaId, schemaElement);
          }
          catch (XMLStreamException e) {
<span class="line-modified">!             Throwable t = e.getNestedException();</span>
<span class="line-modified">!             if (t instanceof IOException) {</span>
<span class="line-modified">!                 exception = (IOException) t;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             else {</span>
<span class="line-added">+                 StAXLocationWrapper slw = new StAXLocationWrapper();</span>
<span class="line-added">+                 slw.setLocation(e.getLocation());</span>
<span class="line-added">+                 throw new XMLParseException(slw, e.getMessage(), e);</span>
<span class="line-added">+             }</span>
          }
          catch (IOException e) {
              exception = e;
          }
          return getSchemaDocument1(mustResolve, true, schemaSource, referElement, exception);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2739,20 ***</span>
          }
      }
  
      @SuppressWarnings(&quot;unchecked&quot;)
      private void addNewImportedGrammars(SchemaGrammar srcGrammar, SchemaGrammar dstGrammar) {
<span class="line-modified">!         final ArrayList&lt;SchemaGrammar&gt; igs1 = (ArrayList&lt;SchemaGrammar&gt;)srcGrammar.getImportedGrammars();</span>
<span class="line-modified">!         if (igs1 != null) {</span>
<span class="line-modified">!            ArrayList&lt;SchemaGrammar&gt; igs2 = (ArrayList&lt;SchemaGrammar&gt;)dstGrammar.getImportedGrammars();</span>
<span class="line-modified">! </span>
<span class="line-modified">!             if (igs2 == null) {</span>
<span class="line-modified">!                 igs2 = (ArrayList&lt;SchemaGrammar&gt;)igs1.clone();</span>
<span class="line-modified">!                 dstGrammar.setImportedGrammars(igs2);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             else {</span>
<span class="line-modified">!                 updateImportList(igs1, igs2);</span>
              }
          }
      }
  
      private void updateImportList(List&lt;SchemaGrammar&gt; importedSrc, List&lt;SchemaGrammar&gt; importedDst)
<span class="line-new-header">--- 2765,33 ---</span>
          }
      }
  
      @SuppressWarnings(&quot;unchecked&quot;)
      private void addNewImportedGrammars(SchemaGrammar srcGrammar, SchemaGrammar dstGrammar) {
<span class="line-modified">!         final ArrayList&lt;SchemaGrammar&gt; src = (ArrayList&lt;SchemaGrammar&gt;)srcGrammar.getImportedGrammars();</span>
<span class="line-modified">!         if (src != null) {</span>
<span class="line-modified">!             ArrayList&lt;SchemaGrammar&gt; dst = (ArrayList&lt;SchemaGrammar&gt;)dstGrammar.getImportedGrammars();</span>
<span class="line-modified">!             if (dst == null) {</span>
<span class="line-modified">!                 dst = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!                 dstGrammar.setImportedGrammars(dst);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             for (SchemaGrammar sg :src) {</span>
<span class="line-modified">!                 // Can&#39;t use the object from the source import list directly.</span>
<span class="line-modified">!                 // It&#39;s possible there is already a grammar with the same</span>
<span class="line-added">+                 // namespace in the bucket but a different object.</span>
<span class="line-added">+                 // This can happen if the bucket has grammar A1, and we try</span>
<span class="line-added">+                 // to add B and A2, where A2 imports B. When B is added, we</span>
<span class="line-added">+                 // create a new object B&#39; and store it in the bucket. Then we</span>
<span class="line-added">+                 // try to merge A2 and A1. We can&#39;t use B. Need to get B&#39; from</span>
<span class="line-added">+                 // the bucket and store it in A&#39;s import list.</span>
<span class="line-added">+                 SchemaGrammar sg1 = fGrammarBucket.getGrammar(sg.getTargetNamespace());</span>
<span class="line-added">+                 if (sg1 != null) {</span>
<span class="line-added">+                     sg = sg1;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 if (!containedImportedGrammar(dst, sg)) {</span>
<span class="line-added">+                     dst.add(sg);</span>
<span class="line-added">+                 }</span>
              }
          }
      }
  
      private void updateImportList(List&lt;SchemaGrammar&gt; importedSrc, List&lt;SchemaGrammar&gt; importedDst)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3160,11 ***</span>
          }
      }
  
      private void addRelatedType(XSTypeDefinition type, List&lt;XSObject&gt; componentList, String namespace, Map&lt;String, List&lt;String&gt;&gt; dependencies) {
          if (!type.getAnonymous()) {
<span class="line-modified">!             if (!type.getNamespace().equals(SchemaSymbols.URI_SCHEMAFORSCHEMA)) { //REVISIT - do we use == instead</span>
                  if (!componentList.contains(type)) {
                      final List&lt;String&gt; importedNamespaces = findDependentNamespaces(namespace, dependencies);
                      addNamespaceDependency(namespace, type.getNamespace(), importedNamespaces);
                      componentList.add(type);
                  }
<span class="line-new-header">--- 3199,11 ---</span>
          }
      }
  
      private void addRelatedType(XSTypeDefinition type, List&lt;XSObject&gt; componentList, String namespace, Map&lt;String, List&lt;String&gt;&gt; dependencies) {
          if (!type.getAnonymous()) {
<span class="line-modified">!             if (!SchemaSymbols.URI_SCHEMAFORSCHEMA.equals(type.getNamespace())) { //REVISIT - do we use == instead</span>
                  if (!componentList.contains(type)) {
                      final List&lt;String&gt; importedNamespaces = findDependentNamespaces(namespace, dependencies);
                      addNamespaceDependency(namespace, type.getNamespace(), importedNamespaces);
                      componentList.add(type);
                  }
</pre>
<center><a href="XSDComplexTypeTraverser.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../../index.html" target="_top">index</a> <a href="XSDSimpleTypeTraverser.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>