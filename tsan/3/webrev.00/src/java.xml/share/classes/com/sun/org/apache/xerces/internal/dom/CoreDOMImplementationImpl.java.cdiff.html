<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.xml/share/classes/com/sun/org/apache/xerces/internal/dom/CoreDOMImplementationImpl.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ChildNode.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CoreDocumentImpl.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml/share/classes/com/sun/org/apache/xerces/internal/dom/CoreDOMImplementationImpl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.</span>
   */
  /*
   * Licensed to the Apache Software Foundation (ASF) under one or more
   * contributor license agreements.  See the NOTICE file distributed with
   * this work for additional information regarding copyright ownership.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   */
  /*
   * Licensed to the Apache Software Foundation (ASF) under one or more
   * contributor license agreements.  See the NOTICE file distributed with
   * this work for additional information regarding copyright ownership.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 18,15 ***</span>
<span class="line-new-header">--- 18,22 ---</span>
   * limitations under the License.
   */
  package com.sun.org.apache.xerces.internal.dom;
  
  import com.sun.org.apache.xerces.internal.impl.RevalidationHandler;
<span class="line-added">+ import com.sun.org.apache.xerces.internal.impl.dtd.XML11DTDProcessor;</span>
<span class="line-added">+ import com.sun.org.apache.xerces.internal.impl.dtd.XML11DTDValidator;</span>
<span class="line-added">+ import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDLoader;</span>
<span class="line-added">+ import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDValidator;</span>
<span class="line-added">+ import com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator;</span>
  import com.sun.org.apache.xerces.internal.parsers.DOMParserImpl;
  import com.sun.org.apache.xerces.internal.parsers.DTDConfiguration;
  import com.sun.org.apache.xerces.internal.parsers.XIncludeAwareParserConfiguration;
<span class="line-added">+ import com.sun.org.apache.xerces.internal.parsers.XML11DTDConfiguration;</span>
  import com.sun.org.apache.xerces.internal.util.XMLChar;
  import com.sun.org.apache.xerces.internal.xni.grammars.XMLGrammarDescription;
<span class="line-added">+ import java.lang.ref.SoftReference;</span>
  import org.w3c.dom.DOMException;
  import org.w3c.dom.DOMImplementation;
  import org.w3c.dom.Document;
  import org.w3c.dom.DocumentType;
  import org.w3c.dom.Element;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 49,35 ***</span>
   * the more complete DOMImplementation class along with DocumentImpl.
   *
   * @xerces.internal
   *
   * @since PR-DOM-Level-1-19980818.
   */
  public class CoreDOMImplementationImpl
          implements DOMImplementation, DOMImplementationLS {
<span class="line-removed">-         //</span>
<span class="line-removed">-         // Data</span>
<span class="line-removed">-         //</span>
  
<span class="line-modified">!     // validators pool</span>
      private static final int SIZE = 2;
<span class="line-removed">-     private RevalidationHandler validators[] = new RevalidationHandler[SIZE];</span>
  
<span class="line-modified">!     private RevalidationHandler dtdValidators[] = new RevalidationHandler[SIZE];</span>
<span class="line-modified">!     private int freeValidatorIndex = -1;</span>
<span class="line-modified">!     private int freeDTDValidatorIndex = -1;</span>
<span class="line-modified">!     private int currentSize = SIZE;</span>
  
      // Document and doctype counter.  Used to assign order to documents and
      // doctypes without owners, on an demand basis.   Used for
      // compareDocumentPosition
      private int docAndDoctypeCounter = 0;
  
          // static
          /** Dom implementation singleton. */
<span class="line-modified">!         static CoreDOMImplementationImpl singleton =</span>
<span class="line-modified">!                 new CoreDOMImplementationImpl();</span>
          //
          // Public methods
          //
          /** NON-DOM: Obtain and return the single shared object */
          public static DOMImplementation getDOMImplementation() {
<span class="line-new-header">--- 56,53 ---</span>
   * the more complete DOMImplementation class along with DocumentImpl.
   *
   * @xerces.internal
   *
   * @since PR-DOM-Level-1-19980818.
<span class="line-added">+  * @LastModified: Apr 2019</span>
   */
<span class="line-added">+ @SuppressWarnings({&quot;rawtypes&quot;, &quot;unchecked&quot;}) //SoftReference array</span>
  public class CoreDOMImplementationImpl
          implements DOMImplementation, DOMImplementationLS {
  
<span class="line-modified">!     //</span>
<span class="line-added">+     // Data</span>
<span class="line-added">+     //</span>
<span class="line-added">+ </span>
<span class="line-added">+     // validator pools</span>
      private static final int SIZE = 2;
  
<span class="line-modified">!     private SoftReference schemaValidators[] = new SoftReference[SIZE];</span>
<span class="line-modified">!     private SoftReference xml10DTDValidators[] = new SoftReference[SIZE];</span>
<span class="line-modified">!     private SoftReference xml11DTDValidators[] = new SoftReference[SIZE];</span>
<span class="line-modified">! </span>
<span class="line-added">+     private int freeSchemaValidatorIndex = -1;</span>
<span class="line-added">+     private int freeXML10DTDValidatorIndex = -1;</span>
<span class="line-added">+     private int freeXML11DTDValidatorIndex = -1;</span>
<span class="line-added">+ </span>
<span class="line-added">+     private int schemaValidatorsCurrentSize = SIZE;</span>
<span class="line-added">+     private int xml10DTDValidatorsCurrentSize = SIZE;</span>
<span class="line-added">+     private int xml11DTDValidatorsCurrentSize = SIZE;</span>
<span class="line-added">+ </span>
<span class="line-added">+     private SoftReference xml10DTDLoaders[] = new SoftReference[SIZE];</span>
<span class="line-added">+     private SoftReference xml11DTDLoaders[] = new SoftReference[SIZE];</span>
<span class="line-added">+ </span>
<span class="line-added">+     private int freeXML10DTDLoaderIndex = -1;</span>
<span class="line-added">+     private int freeXML11DTDLoaderIndex = -1;</span>
<span class="line-added">+ </span>
<span class="line-added">+     private int xml10DTDLoaderCurrentSize = SIZE;</span>
<span class="line-added">+     private int xml11DTDLoaderCurrentSize = SIZE;</span>
  
      // Document and doctype counter.  Used to assign order to documents and
      // doctypes without owners, on an demand basis.   Used for
      // compareDocumentPosition
      private int docAndDoctypeCounter = 0;
  
          // static
          /** Dom implementation singleton. */
<span class="line-modified">!         static final CoreDOMImplementationImpl singleton = new CoreDOMImplementationImpl();</span>
<span class="line-modified">! </span>
          //
          // Public methods
          //
          /** NON-DOM: Obtain and return the single shared object */
          public static DOMImplementation getDOMImplementation() {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 107,25 ***</span>
  
              if (feature.startsWith(&quot;+&quot;)) {
                  feature = feature.substring(1);
              }
              return (feature.equalsIgnoreCase(&quot;Core&quot;)
<span class="line-modified">!                         &amp;&amp; (anyVersion</span>
<span class="line-modified">!                             || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">!                             || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">!                             || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">!                     || (feature.equalsIgnoreCase(&quot;XML&quot;)</span>
<span class="line-modified">!                         &amp;&amp; (anyVersion</span>
<span class="line-modified">!                             || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">!                             || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">!                             || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">!                     || (feature.equalsIgnoreCase(&quot;LS&quot;)</span>
<span class="line-modified">!                         &amp;&amp; (anyVersion</span>
<span class="line-modified">!                             || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">!                     || (feature.equalsIgnoreCase(&quot;ElementTraversal&quot;)</span>
<span class="line-modified">!                         &amp;&amp; (anyVersion</span>
<span class="line-modified">!                             || version.equals(&quot;1.0&quot;)));</span>
          } // hasFeature(String,String):boolean
  
  
          /**
           * Introduced in DOM Level 2. &lt;p&gt;
<span class="line-new-header">--- 132,29 ---</span>
  
              if (feature.startsWith(&quot;+&quot;)) {
                  feature = feature.substring(1);
              }
              return (feature.equalsIgnoreCase(&quot;Core&quot;)
<span class="line-modified">!                     &amp;&amp; (anyVersion</span>
<span class="line-modified">!                         || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">!                         || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">!                         || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">!                         || (feature.equalsIgnoreCase(&quot;XML&quot;)</span>
<span class="line-modified">!                     &amp;&amp; (anyVersion</span>
<span class="line-modified">!                         || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">!                         || version.equals(&quot;2.0&quot;)</span>
<span class="line-modified">!                         || version.equals(&quot;3.0&quot;)))</span>
<span class="line-modified">!                         || (feature.equalsIgnoreCase(&quot;XMLVersion&quot;)</span>
<span class="line-modified">!                     &amp;&amp; (anyVersion</span>
<span class="line-modified">!                         || version.equals(&quot;1.0&quot;)</span>
<span class="line-modified">!                         || version.equals(&quot;1.1&quot;)))</span>
<span class="line-modified">!                         || (feature.equalsIgnoreCase(&quot;LS&quot;)</span>
<span class="line-modified">!                     &amp;&amp; (anyVersion</span>
<span class="line-added">+                         || version.equals(&quot;3.0&quot;)))</span>
<span class="line-added">+                         || (feature.equalsIgnoreCase(&quot;ElementTraversal&quot;)</span>
<span class="line-added">+                     &amp;&amp; (anyVersion</span>
<span class="line-added">+                         || version.equals(&quot;1.0&quot;)));</span>
          } // hasFeature(String,String):boolean
  
  
          /**
           * Introduced in DOM Level 2. &lt;p&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 242,23 ***</span>
                                          DOMMessageFormatter.DOM_DOMAIN,
                                          &quot;WRONG_DOCUMENT_ERR&quot;,
                                          null);
                          throw new DOMException(DOMException.WRONG_DOCUMENT_ERR, msg);
                  }
<span class="line-modified">!                 CoreDocumentImpl doc = new CoreDocumentImpl(doctype);</span>
<span class="line-modified">!                 Element e = doc.createElementNS(namespaceURI, qualifiedName);</span>
<span class="line-modified">!                 doc.appendChild(e);</span>
                  return doc;
          }
  
          /**
           * DOM Level 3 WD - Experimental.
           */
          public Object getFeature(String feature, String version) {
              if (singleton.hasFeature(feature, version)) {
<span class="line-modified">!                 return singleton;</span>
<span class="line-modified">!             }</span>
              return null;
          }
  
          // DOM L3 LS
  
<span class="line-new-header">--- 271,30 ---</span>
                                          DOMMessageFormatter.DOM_DOMAIN,
                                          &quot;WRONG_DOCUMENT_ERR&quot;,
                                          null);
                          throw new DOMException(DOMException.WRONG_DOCUMENT_ERR, msg);
                  }
<span class="line-modified">!                 CoreDocumentImpl doc = createDocument(doctype);</span>
<span class="line-modified">!                 // If namespaceURI and qualifiedName are null return a Document with no document element.</span>
<span class="line-modified">!                 if (qualifiedName != null || namespaceURI != null) {</span>
<span class="line-added">+                     Element e = doc.createElementNS(namespaceURI, qualifiedName);</span>
<span class="line-added">+                     doc.appendChild(e);</span>
<span class="line-added">+                 }</span>
                  return doc;
          }
  
<span class="line-added">+         protected CoreDocumentImpl createDocument(DocumentType doctype) {</span>
<span class="line-added">+             return new CoreDocumentImpl(doctype);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          /**
           * DOM Level 3 WD - Experimental.
           */
          public Object getFeature(String feature, String version) {
              if (singleton.hasFeature(feature, version)) {
<span class="line-modified">!                     return singleton;</span>
<span class="line-modified">!                 }</span>
              return null;
          }
  
          // DOM L3 LS
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 302,11 ***</span>
       *   reference to the default error handler.
       * @exception DOMException
       *    NOT_SUPPORTED_ERR: Raised if the requested mode or schema type is
       *   not supported.
           */
<span class="line-modified">!         public LSParser createLSParser(short mode, String schemaType)</span>
                  throws DOMException {
                  if (mode != DOMImplementationLS.MODE_SYNCHRONOUS || (schemaType !=null &amp;&amp;
                     !&quot;http://www.w3.org/2001/XMLSchema&quot;.equals(schemaType) &amp;&amp;
                          !&quot;http://www.w3.org/TR/REC-xml&quot;.equals(schemaType))) {
                          String msg =
<span class="line-new-header">--- 338,11 ---</span>
       *   reference to the default error handler.
       * @exception DOMException
       *    NOT_SUPPORTED_ERR: Raised if the requested mode or schema type is
       *   not supported.
           */
<span class="line-modified">!     public LSParser createLSParser(short mode, String schemaType)</span>
                  throws DOMException {
                  if (mode != DOMImplementationLS.MODE_SYNCHRONOUS || (schemaType !=null &amp;&amp;
                     !&quot;http://www.w3.org/2001/XMLSchema&quot;.equals(schemaType) &amp;&amp;
                          !&quot;http://www.w3.org/TR/REC-xml&quot;.equals(schemaType))) {
                          String msg =
</pre>
<hr />
<pre>
<span class="line-old-header">*** 316,34 ***</span>
                                          null);
                          throw new DOMException(DOMException.NOT_SUPPORTED_ERR, msg);
                  }
                  if (schemaType != null
                          &amp;&amp; schemaType.equals(&quot;http://www.w3.org/TR/REC-xml&quot;)) {
<span class="line-modified">!                         return new DOMParserImpl(new DTDConfiguration(),</span>
                                  schemaType);
                  }
                  else {
                          // create default parser configuration validating against XMLSchemas
                          return new DOMParserImpl(new XIncludeAwareParserConfiguration(),
                                  schemaType);
                  }
          }
  
<span class="line-modified">!         /**</span>
<span class="line-modified">!          * DOM Level 3 LS CR - Experimental.</span>
<span class="line-modified">!          * Create a new &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">!          * @return The newly created &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">!          * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created</span>
<span class="line-modified">!          * &lt;code&gt;LSSerializer&lt;/code&gt; has no &lt;code&gt;DOMErrorHandler&lt;/code&gt;,</span>
<span class="line-modified">!          * i.e. the value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">!          * parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations may</span>
<span class="line-modified">!          * provide a default error handler at creation time. In that case, the</span>
<span class="line-modified">!          * initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">!          * parameter on the new created &lt;code&gt;LSSerializer&lt;/code&gt; contains a</span>
<span class="line-modified">!          * reference to the default error handler.</span>
<span class="line-modified">!          */</span>
<span class="line-modified">!         public LSSerializer createLSSerializer() {</span>
              return new com.sun.org.apache.xml.internal.serializer.dom3.LSSerializerImpl();
          }
  
          /**
           * DOM Level 3 LS CR - Experimental.
<span class="line-new-header">--- 352,34 ---</span>
                                          null);
                          throw new DOMException(DOMException.NOT_SUPPORTED_ERR, msg);
                  }
                  if (schemaType != null
                          &amp;&amp; schemaType.equals(&quot;http://www.w3.org/TR/REC-xml&quot;)) {
<span class="line-modified">!                         return new DOMParserImpl(new XML11DTDConfiguration(),</span>
                                  schemaType);
                  }
                  else {
                          // create default parser configuration validating against XMLSchemas
                          return new DOMParserImpl(new XIncludeAwareParserConfiguration(),
                                  schemaType);
                  }
          }
  
<span class="line-modified">!     /**</span>
<span class="line-modified">!      * DOM Level 3 LS CR - Experimental.</span>
<span class="line-modified">!      * Create a new &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">!      * @return The newly created &lt;code&gt;LSSerializer&lt;/code&gt; object.</span>
<span class="line-modified">!      * &lt;p &gt;&lt;b&gt;Note:&lt;/b&gt;    By default, the newly created</span>
<span class="line-modified">!      * &lt;code&gt;LSSerializer&lt;/code&gt; has no &lt;code&gt;DOMErrorHandler&lt;/code&gt;,</span>
<span class="line-modified">!      * i.e. the value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">!      * parameter is &lt;code&gt;null&lt;/code&gt;. However, implementations may</span>
<span class="line-modified">!      * provide a default error handler at creation time. In that case, the</span>
<span class="line-modified">!      * initial value of the &lt;code&gt;&quot;error-handler&quot;&lt;/code&gt; configuration</span>
<span class="line-modified">!      * parameter on the new created &lt;code&gt;LSSerializer&lt;/code&gt; contains a</span>
<span class="line-modified">!      * reference to the default error handler.</span>
<span class="line-modified">!      */</span>
<span class="line-modified">!     public LSSerializer createLSSerializer() {</span>
              return new com.sun.org.apache.xml.internal.serializer.dom3.LSSerializerImpl();
          }
  
          /**
           * DOM Level 3 LS CR - Experimental.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 356,82 ***</span>
  
          //
          // Protected methods
          //
          /** NON-DOM: retrieve validator. */
<span class="line-modified">!         synchronized RevalidationHandler getValidator(String schemaType) {</span>
<span class="line-removed">-                 // REVISIT: implement retrieving DTD validator</span>
          if (schemaType == XMLGrammarDescription.XML_SCHEMA) {
              // create new validator - we should not attempt
              // to restrict the number of validation handlers being
              // requested
<span class="line-modified">!             if(freeValidatorIndex &lt; 0) {</span>
<span class="line-modified">!                 return new com.sun.org.apache.xerces.internal.impl.xs.XMLSchemaValidator();</span>
              }
<span class="line-modified">!             // return first available validator</span>
<span class="line-removed">-             RevalidationHandler val = validators[freeValidatorIndex];</span>
<span class="line-removed">-             validators[freeValidatorIndex--] = null;</span>
<span class="line-removed">-             return val;</span>
          }
          else if(schemaType == XMLGrammarDescription.XML_DTD) {
<span class="line-modified">!             if(freeDTDValidatorIndex &lt; 0) {</span>
<span class="line-modified">!                 return new com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDValidator();</span>
              }
<span class="line-removed">-             // return first available validator</span>
<span class="line-removed">-             RevalidationHandler val = dtdValidators[freeDTDValidatorIndex];</span>
<span class="line-removed">-             dtdValidators[freeDTDValidatorIndex--] = null;</span>
<span class="line-removed">-             return val;</span>
          }
          return null;
          }
  
          /** NON-DOM: release validator */
<span class="line-modified">!         synchronized void releaseValidator(String schemaType,</span>
<span class="line-modified">!                                          RevalidationHandler validator) {</span>
<span class="line-modified">!        // REVISIT: implement support for DTD validators as well</span>
<span class="line-modified">!        if(schemaType == XMLGrammarDescription.XML_SCHEMA) {</span>
<span class="line-modified">!            ++freeValidatorIndex;</span>
<span class="line-modified">!            if (validators.length == freeValidatorIndex ){</span>
<span class="line-modified">!                 // resize size of the validators</span>
<span class="line-modified">!                 currentSize+=SIZE;</span>
<span class="line-modified">!                 RevalidationHandler newarray[] =  new RevalidationHandler[currentSize];</span>
<span class="line-modified">!                 System.arraycopy(validators, 0, newarray, 0, validators.length);</span>
<span class="line-modified">!                 validators = newarray;</span>
<span class="line-modified">!            }</span>
<span class="line-modified">!            validators[freeValidatorIndex]=validator;</span>
<span class="line-modified">!        }</span>
<span class="line-modified">!        else if(schemaType == XMLGrammarDescription.XML_DTD) {</span>
<span class="line-modified">!            ++freeDTDValidatorIndex;</span>
<span class="line-modified">!            if (dtdValidators.length == freeDTDValidatorIndex ){</span>
<span class="line-modified">!                 // resize size of the validators</span>
<span class="line-modified">!                 currentSize+=SIZE;</span>
<span class="line-modified">!                 RevalidationHandler newarray[] =  new RevalidationHandler[currentSize];</span>
<span class="line-modified">!                 System.arraycopy(dtdValidators, 0, newarray, 0, dtdValidators.length);</span>
<span class="line-modified">!                 dtdValidators = newarray;</span>
<span class="line-modified">!            }</span>
<span class="line-modified">!            dtdValidators[freeDTDValidatorIndex]=validator;</span>
<span class="line-modified">!        }</span>
          }
  
<span class="line-modified">!        /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-modified">!        protected synchronized int assignDocumentNumber() {</span>
<span class="line-modified">!             return ++docAndDoctypeCounter;</span>
<span class="line-modified">!        }</span>
<span class="line-modified">!        /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-modified">!        protected synchronized int assignDocTypeNumber() {</span>
<span class="line-modified">!             return ++docAndDoctypeCounter;</span>
<span class="line-modified">!        }</span>
  
      /* DOM Level 3 LS CR - Experimental.
       *
       * Create a new empty output destination object where
       * &lt;code&gt;LSOutput.characterStream&lt;/code&gt;,
       * &lt;code&gt;LSOutput.byteStream&lt;/code&gt;, &lt;code&gt;LSOutput.systemId&lt;/code&gt;,
       * &lt;code&gt;LSOutput.encoding&lt;/code&gt; are null.
<span class="line-removed">- </span>
       * @return  The newly created output object.
       */
<span class="line-modified">!        public LSOutput createLSOutput() {</span>
<span class="line-modified">!            return new DOMOutputImpl();</span>
<span class="line-modified">!        }</span>
  
  } // class DOMImplementationImpl
<span class="line-new-header">--- 392,253 ---</span>
  
          //
          // Protected methods
          //
          /** NON-DOM: retrieve validator. */
<span class="line-modified">!         synchronized RevalidationHandler getValidator(String schemaType, String xmlVersion) {</span>
          if (schemaType == XMLGrammarDescription.XML_SCHEMA) {
              // create new validator - we should not attempt
              // to restrict the number of validation handlers being
              // requested
<span class="line-modified">!             while (freeSchemaValidatorIndex &gt;= 0) {</span>
<span class="line-modified">!                 // return first available validator</span>
<span class="line-added">+                 SoftReference ref = schemaValidators[freeSchemaValidatorIndex];</span>
<span class="line-added">+                 RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">+                 if (holder != null &amp;&amp; holder.handler != null) {</span>
<span class="line-added">+                     RevalidationHandler val = holder.handler;</span>
<span class="line-added">+                     holder.handler = null;</span>
<span class="line-added">+                     --freeSchemaValidatorIndex;</span>
<span class="line-added">+                     return val;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 schemaValidators[freeSchemaValidatorIndex--] = null;</span>
              }
<span class="line-modified">!             return new XMLSchemaValidator();</span>
          }
          else if(schemaType == XMLGrammarDescription.XML_DTD) {
<span class="line-modified">!             // return an instance of XML11DTDValidator</span>
<span class="line-modified">!             if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-added">+                 while (freeXML11DTDValidatorIndex &gt;= 0) {</span>
<span class="line-added">+                     // return first available validator</span>
<span class="line-added">+                     SoftReference ref = xml11DTDValidators[freeXML11DTDValidatorIndex];</span>
<span class="line-added">+                     RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">+                     if (holder != null &amp;&amp; holder.handler != null) {</span>
<span class="line-added">+                         RevalidationHandler val = holder.handler;</span>
<span class="line-added">+                         holder.handler = null;</span>
<span class="line-added">+                         --freeXML11DTDValidatorIndex;</span>
<span class="line-added">+                         return val;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     xml11DTDValidators[freeXML11DTDValidatorIndex--] = null;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 return new XML11DTDValidator();</span>
<span class="line-added">+             }</span>
<span class="line-added">+             // return an instance of XMLDTDValidator</span>
<span class="line-added">+             else {</span>
<span class="line-added">+                 while (freeXML10DTDValidatorIndex &gt;= 0) {</span>
<span class="line-added">+                     // return first available validator</span>
<span class="line-added">+                     SoftReference ref = xml10DTDValidators[freeXML10DTDValidatorIndex];</span>
<span class="line-added">+                     RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">+                     if (holder != null &amp;&amp; holder.handler != null) {</span>
<span class="line-added">+                         RevalidationHandler val = holder.handler;</span>
<span class="line-added">+                         holder.handler = null;</span>
<span class="line-added">+                         --freeXML10DTDValidatorIndex;</span>
<span class="line-added">+                         return val;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     xml10DTDValidators[freeXML10DTDValidatorIndex--] = null;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 return new XMLDTDValidator();</span>
              }
          }
          return null;
          }
  
          /** NON-DOM: release validator */
<span class="line-modified">!         synchronized void releaseValidator(String schemaType, String xmlVersion,</span>
<span class="line-modified">!                 RevalidationHandler validator) {</span>
<span class="line-modified">!             if (schemaType == XMLGrammarDescription.XML_SCHEMA) {</span>
<span class="line-modified">!                 ++freeSchemaValidatorIndex;</span>
<span class="line-modified">!                 if (schemaValidators.length == freeSchemaValidatorIndex) {</span>
<span class="line-modified">!                     // resize size of the validators</span>
<span class="line-modified">!                     schemaValidatorsCurrentSize += SIZE;</span>
<span class="line-modified">!                     SoftReference newarray[] =  new SoftReference[schemaValidatorsCurrentSize];</span>
<span class="line-modified">!                     System.arraycopy(schemaValidators, 0, newarray, 0, schemaValidators.length);</span>
<span class="line-modified">!                     schemaValidators = newarray;</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 SoftReference ref = schemaValidators[freeSchemaValidatorIndex];</span>
<span class="line-modified">!                 if (ref != null) {</span>
<span class="line-modified">!                     RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-modified">!                     if (holder != null) {</span>
<span class="line-modified">!                         holder.handler = validator;</span>
<span class="line-modified">!                         return;</span>
<span class="line-modified">!                     }</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 schemaValidators[freeSchemaValidatorIndex] = new SoftReference(new RevalidationHandlerHolder(validator));</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             else if (schemaType == XMLGrammarDescription.XML_DTD) {</span>
<span class="line-modified">!                 // release an instance of XML11DTDValidator</span>
<span class="line-modified">!                 if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-modified">!                     ++freeXML11DTDValidatorIndex;</span>
<span class="line-added">+                     if (xml11DTDValidators.length == freeXML11DTDValidatorIndex) {</span>
<span class="line-added">+                         // resize size of the validators</span>
<span class="line-added">+                         xml11DTDValidatorsCurrentSize += SIZE;</span>
<span class="line-added">+                         SoftReference [] newarray = new SoftReference[xml11DTDValidatorsCurrentSize];</span>
<span class="line-added">+                         System.arraycopy(xml11DTDValidators, 0, newarray, 0, xml11DTDValidators.length);</span>
<span class="line-added">+                         xml11DTDValidators = newarray;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     SoftReference ref = xml11DTDValidators[freeXML11DTDValidatorIndex];</span>
<span class="line-added">+                     if (ref != null) {</span>
<span class="line-added">+                         RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">+                         if (holder != null) {</span>
<span class="line-added">+                             holder.handler = validator;</span>
<span class="line-added">+                             return;</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     xml11DTDValidators[freeXML11DTDValidatorIndex] = new SoftReference(new RevalidationHandlerHolder(validator));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 // release an instance of XMLDTDValidator</span>
<span class="line-added">+                 else {</span>
<span class="line-added">+                     ++freeXML10DTDValidatorIndex;</span>
<span class="line-added">+                     if (xml10DTDValidators.length == freeXML10DTDValidatorIndex) {</span>
<span class="line-added">+                         // resize size of the validators</span>
<span class="line-added">+                         xml10DTDValidatorsCurrentSize += SIZE;</span>
<span class="line-added">+                         SoftReference [] newarray = new SoftReference[xml10DTDValidatorsCurrentSize];</span>
<span class="line-added">+                         System.arraycopy(xml10DTDValidators, 0, newarray, 0, xml10DTDValidators.length);</span>
<span class="line-added">+                         xml10DTDValidators = newarray;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     SoftReference ref = xml10DTDValidators[freeXML10DTDValidatorIndex];</span>
<span class="line-added">+                     if (ref != null) {</span>
<span class="line-added">+                         RevalidationHandlerHolder holder = (RevalidationHandlerHolder) ref.get();</span>
<span class="line-added">+                         if (holder != null) {</span>
<span class="line-added">+                             holder.handler = validator;</span>
<span class="line-added">+                             return;</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     xml10DTDValidators[freeXML10DTDValidatorIndex] = new SoftReference(new RevalidationHandlerHolder(validator));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
          }
  
<span class="line-modified">!     /** NON-DOM: retrieve DTD loader */</span>
<span class="line-modified">!     synchronized final XMLDTDLoader getDTDLoader(String xmlVersion) {</span>
<span class="line-modified">!         // return an instance of XML11DTDProcessor</span>
<span class="line-modified">!         if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-modified">!             while (freeXML11DTDLoaderIndex &gt;= 0) {</span>
<span class="line-modified">!                 // return first available DTD loader</span>
<span class="line-modified">!                 SoftReference ref = xml11DTDLoaders[freeXML11DTDLoaderIndex];</span>
<span class="line-modified">!                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">+                 if (holder != null &amp;&amp; holder.loader != null) {</span>
<span class="line-added">+                     XMLDTDLoader val = holder.loader;</span>
<span class="line-added">+                     holder.loader = null;</span>
<span class="line-added">+                     --freeXML11DTDLoaderIndex;</span>
<span class="line-added">+                     return val;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 xml11DTDLoaders[freeXML11DTDLoaderIndex--] = null;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return new XML11DTDProcessor();</span>
<span class="line-added">+         }</span>
<span class="line-added">+         // return an instance of XMLDTDLoader</span>
<span class="line-added">+         else {</span>
<span class="line-added">+             while (freeXML10DTDLoaderIndex &gt;= 0) {</span>
<span class="line-added">+                 // return first available DTD loader</span>
<span class="line-added">+                 SoftReference ref = xml10DTDLoaders[freeXML10DTDLoaderIndex];</span>
<span class="line-added">+                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">+                 if (holder != null &amp;&amp; holder.loader != null) {</span>
<span class="line-added">+                     XMLDTDLoader val = holder.loader;</span>
<span class="line-added">+                     holder.loader = null;</span>
<span class="line-added">+                     --freeXML10DTDLoaderIndex;</span>
<span class="line-added">+                     return val;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 xml10DTDLoaders[freeXML10DTDLoaderIndex--] = null;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return new XMLDTDLoader();</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /** NON-DOM: release DTD loader */</span>
<span class="line-added">+     synchronized final void releaseDTDLoader(String xmlVersion, XMLDTDLoader loader) {</span>
<span class="line-added">+         // release an instance of XMLDTDLoader</span>
<span class="line-added">+         if (&quot;1.1&quot;.equals(xmlVersion)) {</span>
<span class="line-added">+             ++freeXML11DTDLoaderIndex;</span>
<span class="line-added">+             if (xml11DTDLoaders.length == freeXML11DTDLoaderIndex) {</span>
<span class="line-added">+                 // resize size of the DTD loaders</span>
<span class="line-added">+                 xml11DTDLoaderCurrentSize += SIZE;</span>
<span class="line-added">+                 SoftReference [] newarray = new SoftReference[xml11DTDLoaderCurrentSize];</span>
<span class="line-added">+                 System.arraycopy(xml11DTDLoaders, 0, newarray, 0, xml11DTDLoaders.length);</span>
<span class="line-added">+                 xml11DTDLoaders = newarray;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             SoftReference ref = xml11DTDLoaders[freeXML11DTDLoaderIndex];</span>
<span class="line-added">+             if (ref != null) {</span>
<span class="line-added">+                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">+                 if (holder != null) {</span>
<span class="line-added">+                     holder.loader = loader;</span>
<span class="line-added">+                     return;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+             xml11DTDLoaders[freeXML11DTDLoaderIndex] = new SoftReference(new XMLDTDLoaderHolder(loader));</span>
<span class="line-added">+         }</span>
<span class="line-added">+         // release an instance of XMLDTDLoader</span>
<span class="line-added">+         else {</span>
<span class="line-added">+             ++freeXML10DTDLoaderIndex;</span>
<span class="line-added">+             if (xml10DTDLoaders.length == freeXML10DTDLoaderIndex) {</span>
<span class="line-added">+                 // resize size of the DTD loaders</span>
<span class="line-added">+                 xml10DTDLoaderCurrentSize += SIZE;</span>
<span class="line-added">+                 SoftReference [] newarray = new SoftReference[xml10DTDLoaderCurrentSize];</span>
<span class="line-added">+                 System.arraycopy(xml10DTDLoaders, 0, newarray, 0, xml10DTDLoaders.length);</span>
<span class="line-added">+                 xml10DTDLoaders = newarray;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             SoftReference ref = xml10DTDLoaders[freeXML10DTDLoaderIndex];</span>
<span class="line-added">+             if (ref != null) {</span>
<span class="line-added">+                 XMLDTDLoaderHolder holder = (XMLDTDLoaderHolder) ref.get();</span>
<span class="line-added">+                 if (holder != null) {</span>
<span class="line-added">+                     holder.loader = loader;</span>
<span class="line-added">+                     return;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+             xml10DTDLoaders[freeXML10DTDLoaderIndex] = new SoftReference(new XMLDTDLoaderHolder(loader));</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-added">+     protected synchronized int assignDocumentNumber() {</span>
<span class="line-added">+         return ++docAndDoctypeCounter;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /** NON-DOM:  increment document/doctype counter */</span>
<span class="line-added">+     protected synchronized int assignDocTypeNumber() {</span>
<span class="line-added">+         return ++docAndDoctypeCounter;</span>
<span class="line-added">+     }</span>
  
      /* DOM Level 3 LS CR - Experimental.
       *
       * Create a new empty output destination object where
       * &lt;code&gt;LSOutput.characterStream&lt;/code&gt;,
       * &lt;code&gt;LSOutput.byteStream&lt;/code&gt;, &lt;code&gt;LSOutput.systemId&lt;/code&gt;,
       * &lt;code&gt;LSOutput.encoding&lt;/code&gt; are null.
       * @return  The newly created output object.
<span class="line-added">+     */</span>
<span class="line-added">+     public LSOutput createLSOutput() {</span>
<span class="line-added">+         return new DOMOutputImpl();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * A holder for RevalidationHandlers. This allows us to reuse</span>
<span class="line-added">+      * SoftReferences which haven&#39;t yet been cleared by the garbage</span>
<span class="line-added">+      * collector.</span>
       */
<span class="line-modified">!     static final class RevalidationHandlerHolder {</span>
<span class="line-modified">!         RevalidationHandlerHolder(RevalidationHandler handler) {</span>
<span class="line-modified">!             this.handler = handler;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         RevalidationHandler handler;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /**</span>
<span class="line-added">+      * A holder for XMLDTDLoaders. This allows us to reuse SoftReferences</span>
<span class="line-added">+      * which haven&#39;t yet been cleared by the garbage collector.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     static final class XMLDTDLoaderHolder {</span>
<span class="line-added">+         XMLDTDLoaderHolder(XMLDTDLoader loader) {</span>
<span class="line-added">+             this.loader = loader;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         XMLDTDLoader loader;</span>
<span class="line-added">+     }</span>
  
  } // class DOMImplementationImpl
</pre>
<center><a href="ChildNode.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CoreDocumentImpl.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>