<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.xml/share/classes/com/sun/org/apache/xpath/internal/compiler/Compiler.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../axes/WalkerFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="XPathParser.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml/share/classes/com/sun/org/apache/xpath/internal/compiler/Compiler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * reserved comment block</span>
<span class="line-removed">   3  * DO NOT REMOVE OR ALTER!</span>
   4  */
   5 /*
   6  * Licensed to the Apache Software Foundation (ASF) under one or more
   7  * contributor license agreements.  See the NOTICE file distributed with
   8  * this work for additional information regarding copyright ownership.
   9  * The ASF licenses this file to You under the Apache License, Version 2.0
  10  * (the &quot;License&quot;); you may not use this file except in compliance with
  11  * the License.  You may obtain a copy of the License at
  12  *
  13  *      http://www.apache.org/licenses/LICENSE-2.0
  14  *
  15  * Unless required by applicable law or agreed to in writing, software
  16  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  17  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  18  * See the License for the specific language governing permissions and
  19  * limitations under the License.
  20  */
  21 
  22 package com.sun.org.apache.xpath.internal.compiler;
  23 
</pre>
<hr />
<pre>
  53 import com.sun.org.apache.xpath.internal.operations.Mult;
  54 import com.sun.org.apache.xpath.internal.operations.Neg;
  55 import com.sun.org.apache.xpath.internal.operations.NotEquals;
  56 import com.sun.org.apache.xpath.internal.operations.Operation;
  57 import com.sun.org.apache.xpath.internal.operations.Or;
  58 import com.sun.org.apache.xpath.internal.operations.Plus;
  59 import com.sun.org.apache.xpath.internal.operations.UnaryOperation;
  60 import com.sun.org.apache.xpath.internal.operations.Variable;
  61 import com.sun.org.apache.xpath.internal.patterns.FunctionPattern;
  62 import com.sun.org.apache.xpath.internal.patterns.NodeTest;
  63 import com.sun.org.apache.xpath.internal.patterns.StepPattern;
  64 import com.sun.org.apache.xpath.internal.patterns.UnionPattern;
  65 import com.sun.org.apache.xpath.internal.res.XPATHErrorResources;
  66 
  67 /**
  68  * An instance of this class compiles an XPath string expression into
  69  * a Expression object.  This class compiles the string into a sequence
  70  * of operation codes (op map) and then builds from that into an Expression
  71  * tree.
  72  * @xsl.usage advanced

  73  */
  74 public class Compiler extends OpMap
  75 {


  76 
  77   /**
  78    * Construct a Compiler object with a specific ErrorListener and
  79    * SourceLocator where the expression is located.
  80    *
  81    * @param errorHandler Error listener where messages will be sent, or null
  82    *                     if messages should be sent to System err.
  83    * @param locator The location object where the expression lives, which
  84    *                may be null, but which, if not null, must be valid over
  85    *                the long haul, in other words, it will not be cloned.
  86    * @param fTable  The FunctionTable object where the xpath build-in
  87    *                functions are stored.
  88    */
  89   public Compiler(ErrorListener errorHandler, SourceLocator locator,
  90             FunctionTable fTable)
  91   {
  92     m_errorHandler = errorHandler;
  93     m_locator = locator;
  94     m_functionTable = fTable;
  95   }
  96 
  97   /**
  98    * Construct a Compiler instance that has a null error listener and a
  99    * null source locator.
 100    */
 101   public Compiler()
 102   {
 103     m_errorHandler = null;
 104     m_locator = null;
 105   }
 106 
 107   /**
 108    * Execute the XPath object from a given opcode position.





 109    * @param opPos The current position in the xpath.m_opMap array.
 110    * @return The result of the XPath.
 111    *
 112    * @throws TransformerException if there is a syntax or other error.
 113    * @xsl.usage advanced
 114    */
<span class="line-modified"> 115   public Expression compile(int opPos) throws TransformerException</span>
<span class="line-modified"> 116   {</span>








 117 












 118     int op = getOp(opPos);
 119 
 120     Expression expr = null;
 121     // System.out.println(getPatternString()+&quot;op: &quot;+op);
 122     switch (op)
 123     {
 124     case OpCodes.OP_XPATH :
 125       expr = compile(opPos + 2); break;
 126     case OpCodes.OP_OR :
 127       expr = or(opPos); break;
 128     case OpCodes.OP_AND :
 129       expr = and(opPos); break;
 130     case OpCodes.OP_NOTEQUALS :
 131       expr = notequals(opPos); break;
 132     case OpCodes.OP_EQUALS :
 133       expr = equals(opPos); break;
 134     case OpCodes.OP_LTE :
 135       expr = lte(opPos); break;
 136     case OpCodes.OP_LT :
 137       expr = lt(opPos); break;
</pre>
<hr />
<pre>
 193     }
 194 //    if(null != expr)
 195 //      expr.setSourceLocator(m_locator);
 196 
 197     return expr;
 198   }
 199 
 200   /**
 201    * Bottle-neck compilation of an operation with left and right operands.
 202    *
 203    * @param operation non-null reference to parent operation.
 204    * @param opPos The op map position of the parent operation.
 205    *
 206    * @return reference to {@link com.sun.org.apache.xpath.internal.operations.Operation} instance.
 207    *
 208    * @throws TransformerException if there is a syntax or other error.
 209    */
 210   private Expression compileOperation(Operation operation, int opPos)
 211           throws TransformerException
 212   {

 213 
 214     int leftPos = getFirstChildPos(opPos);
 215     int rightPos = getNextOpPos(leftPos);
 216 
 217     operation.setLeftRight(compile(leftPos), compile(rightPos));
 218 
 219     return operation;
 220   }
 221 
 222   /**
 223    * Bottle-neck compilation of a unary operation.
 224    *
 225    * @param unary The parent unary operation.
 226    * @param opPos The position in the op map of the parent operation.
 227    *
 228    * @return The unary argument.
 229    *
 230    * @throws TransformerException if syntax or other error occurs.
 231    */
 232   private Expression compileUnary(UnaryOperation unary, int opPos)
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>

   3  */
   4 /*
   5  * Licensed to the Apache Software Foundation (ASF) under one or more
   6  * contributor license agreements.  See the NOTICE file distributed with
   7  * this work for additional information regarding copyright ownership.
   8  * The ASF licenses this file to You under the Apache License, Version 2.0
   9  * (the &quot;License&quot;); you may not use this file except in compliance with
  10  * the License.  You may obtain a copy of the License at
  11  *
  12  *      http://www.apache.org/licenses/LICENSE-2.0
  13  *
  14  * Unless required by applicable law or agreed to in writing, software
  15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  17  * See the License for the specific language governing permissions and
  18  * limitations under the License.
  19  */
  20 
  21 package com.sun.org.apache.xpath.internal.compiler;
  22 
</pre>
<hr />
<pre>
  52 import com.sun.org.apache.xpath.internal.operations.Mult;
  53 import com.sun.org.apache.xpath.internal.operations.Neg;
  54 import com.sun.org.apache.xpath.internal.operations.NotEquals;
  55 import com.sun.org.apache.xpath.internal.operations.Operation;
  56 import com.sun.org.apache.xpath.internal.operations.Or;
  57 import com.sun.org.apache.xpath.internal.operations.Plus;
  58 import com.sun.org.apache.xpath.internal.operations.UnaryOperation;
  59 import com.sun.org.apache.xpath.internal.operations.Variable;
  60 import com.sun.org.apache.xpath.internal.patterns.FunctionPattern;
  61 import com.sun.org.apache.xpath.internal.patterns.NodeTest;
  62 import com.sun.org.apache.xpath.internal.patterns.StepPattern;
  63 import com.sun.org.apache.xpath.internal.patterns.UnionPattern;
  64 import com.sun.org.apache.xpath.internal.res.XPATHErrorResources;
  65 
  66 /**
  67  * An instance of this class compiles an XPath string expression into
  68  * a Expression object.  This class compiles the string into a sequence
  69  * of operation codes (op map) and then builds from that into an Expression
  70  * tree.
  71  * @xsl.usage advanced
<span class="line-added">  72  * @LastModified: May 2019</span>
  73  */
  74 public class Compiler extends OpMap
  75 {
<span class="line-added">  76   // count the number of operations or calls to compileOperation</span>
<span class="line-added">  77   int countOp;</span>
  78 
  79   /**
  80    * Construct a Compiler object with a specific ErrorListener and
  81    * SourceLocator where the expression is located.
  82    *
  83    * @param errorHandler Error listener where messages will be sent, or null
  84    *                     if messages should be sent to System err.
  85    * @param locator The location object where the expression lives, which
  86    *                may be null, but which, if not null, must be valid over
  87    *                the long haul, in other words, it will not be cloned.
  88    * @param fTable  The FunctionTable object where the xpath build-in
  89    *                functions are stored.
  90    */
  91   public Compiler(ErrorListener errorHandler, SourceLocator locator,
  92             FunctionTable fTable)
  93   {
  94     m_errorHandler = errorHandler;
  95     m_locator = locator;
  96     m_functionTable = fTable;
  97   }
  98 
  99   /**
 100    * Construct a Compiler instance that has a null error listener and a
 101    * null source locator.
 102    */
 103   public Compiler()
 104   {
 105     m_errorHandler = null;
 106     m_locator = null;
 107   }
 108 
 109   /**
 110    * Execute the XPath object from a given opcode position.
<span class="line-added"> 111    *</span>
<span class="line-added"> 112    * Note that this method is added so that when StackOverflowError is caught</span>
<span class="line-added"> 113    * the address space can be freed to this point allowing further activities</span>
<span class="line-added"> 114    * such as reporting the error.</span>
<span class="line-added"> 115    *</span>
 116    * @param opPos The current position in the xpath.m_opMap array.
 117    * @return The result of the XPath.
 118    *
 119    * @throws TransformerException if there is a syntax or other error.
 120    * @xsl.usage advanced
 121    */
<span class="line-modified"> 122    public Expression compileExpression(int opPos) throws TransformerException</span>
<span class="line-modified"> 123    {</span>
<span class="line-added"> 124        try {</span>
<span class="line-added"> 125            countOp = 0;</span>
<span class="line-added"> 126            return compile(opPos);</span>
<span class="line-added"> 127        } catch (StackOverflowError sof) {</span>
<span class="line-added"> 128            error(XPATHErrorResources.ER_COMPILATION_TOO_MANY_OPERATION, new Object[]{countOp});</span>
<span class="line-added"> 129        }</span>
<span class="line-added"> 130        return null;</span>
<span class="line-added"> 131    }</span>
 132 
<span class="line-added"> 133   /**</span>
<span class="line-added"> 134    * This method handles the actual compilation process. It is called from the</span>
<span class="line-added"> 135    * compileExpression method as well as the subsequent processes. See the note</span>
<span class="line-added"> 136    * for compileExpression.</span>
<span class="line-added"> 137    *</span>
<span class="line-added"> 138    * @param opPos The current position in the xpath.m_opMap array.</span>
<span class="line-added"> 139    * @return The result of the XPath.</span>
<span class="line-added"> 140    *</span>
<span class="line-added"> 141    * @throws TransformerException if there is a syntax or other error.</span>
<span class="line-added"> 142    */</span>
<span class="line-added"> 143   private Expression compile(int opPos) throws TransformerException</span>
<span class="line-added"> 144   {</span>
 145     int op = getOp(opPos);
 146 
 147     Expression expr = null;
 148     // System.out.println(getPatternString()+&quot;op: &quot;+op);
 149     switch (op)
 150     {
 151     case OpCodes.OP_XPATH :
 152       expr = compile(opPos + 2); break;
 153     case OpCodes.OP_OR :
 154       expr = or(opPos); break;
 155     case OpCodes.OP_AND :
 156       expr = and(opPos); break;
 157     case OpCodes.OP_NOTEQUALS :
 158       expr = notequals(opPos); break;
 159     case OpCodes.OP_EQUALS :
 160       expr = equals(opPos); break;
 161     case OpCodes.OP_LTE :
 162       expr = lte(opPos); break;
 163     case OpCodes.OP_LT :
 164       expr = lt(opPos); break;
</pre>
<hr />
<pre>
 220     }
 221 //    if(null != expr)
 222 //      expr.setSourceLocator(m_locator);
 223 
 224     return expr;
 225   }
 226 
 227   /**
 228    * Bottle-neck compilation of an operation with left and right operands.
 229    *
 230    * @param operation non-null reference to parent operation.
 231    * @param opPos The op map position of the parent operation.
 232    *
 233    * @return reference to {@link com.sun.org.apache.xpath.internal.operations.Operation} instance.
 234    *
 235    * @throws TransformerException if there is a syntax or other error.
 236    */
 237   private Expression compileOperation(Operation operation, int opPos)
 238           throws TransformerException
 239   {
<span class="line-added"> 240     ++countOp;</span>
 241 
 242     int leftPos = getFirstChildPos(opPos);
 243     int rightPos = getNextOpPos(leftPos);
 244 
 245     operation.setLeftRight(compile(leftPos), compile(rightPos));
 246 
 247     return operation;
 248   }
 249 
 250   /**
 251    * Bottle-neck compilation of a unary operation.
 252    *
 253    * @param unary The parent unary operation.
 254    * @param opPos The position in the op map of the parent operation.
 255    *
 256    * @return The unary argument.
 257    *
 258    * @throws TransformerException if syntax or other error occurs.
 259    */
 260   private Expression compileUnary(UnaryOperation unary, int opPos)
</pre>
</td>
</tr>
</table>
<center><a href="../axes/WalkerFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="XPathParser.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>