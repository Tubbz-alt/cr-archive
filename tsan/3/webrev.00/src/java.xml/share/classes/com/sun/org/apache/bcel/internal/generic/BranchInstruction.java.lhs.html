<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.xml/share/classes/com/sun/org/apache/bcel/internal/generic/BranchInstruction.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * reserved comment block</span>
<span class="line-removed">  3  * DO NOT REMOVE OR ALTER!</span>
  4  */
  5 /*
  6  * Licensed to the Apache Software Foundation (ASF) under one or more
  7  * contributor license agreements.  See the NOTICE file distributed with
  8  * this work for additional information regarding copyright ownership.
  9  * The ASF licenses this file to You under the Apache License, Version 2.0
 10  * (the &quot;License&quot;); you may not use this file except in compliance with
 11  * the License.  You may obtain a copy of the License at
 12  *
 13  *      http://www.apache.org/licenses/LICENSE-2.0
 14  *
 15  * Unless required by applicable law or agreed to in writing, software
 16  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 17  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 18  * See the License for the specific language governing permissions and
 19  * limitations under the License.
 20  */
 21 package com.sun.org.apache.bcel.internal.generic;
 22 
 23 import java.io.DataOutputStream;
 24 import java.io.IOException;
 25 
 26 import com.sun.org.apache.bcel.internal.util.ByteSequence;
 27 
 28 /**
<a name="2" id="anc2"></a><span class="line-modified"> 29  * Abstract super class for branching instructions like GOTO, IFEQ, etc.. Branch</span>
<span class="line-modified"> 30  * instructions may have a variable length, namely GOTO, JSR, LOOKUPSWITCH and</span>
<span class="line-modified"> 31  * TABLESWITCH.</span>
 32  *
 33  * @see InstructionList
<a name="3" id="anc3"></a><span class="line-modified"> 34  * @version $Id: BranchInstruction.java 1749603 2016-06-21 20:50:19Z ggregory $</span>
 35  */
 36 public abstract class BranchInstruction extends Instruction implements InstructionTargeter {
 37 
 38     private int index; // Branch target relative to this instruction
 39     private InstructionHandle target; // Target object in instruction list
 40     private int position; // Byte code offset
 41 
 42     /**
 43      * Empty constructor needed for the Class.newInstance() statement in
 44      * Instruction.readInstruction(). Not to be used otherwise.
 45      */
 46     BranchInstruction() {
 47     }
 48 
<a name="4" id="anc4"></a><span class="line-modified"> 49     /**</span>
<span class="line-modified"> 50      * Common super constructor</span>
<span class="line-removed"> 51      *</span>
 52      * @param opcode Instruction opcode
 53      * @param target instruction to branch to
 54      */
 55     protected BranchInstruction(final short opcode, final InstructionHandle target) {
 56         super(opcode, (short) 3);
 57         setTarget(target);
 58     }
 59 
<a name="5" id="anc5"></a>
 60     /**
 61      * Dump instruction as byte code to stream out.
<a name="6" id="anc6"></a><span class="line-removed"> 62      *</span>
 63      * @param out Output stream
 64      */
 65     @Override
<a name="7" id="anc7"></a><span class="line-modified"> 66     public void dump(final DataOutputStream out) throws IOException {</span>
 67         out.writeByte(super.getOpcode());
 68         index = getTargetOffset();
 69         if (!isValidShort(index)) {
 70             throw new ClassGenException(&quot;Branch target offset too large for short: &quot; + index);
 71         }
 72         out.writeShort(index); // May be negative, i.e., point backwards
 73     }
 74 
<a name="8" id="anc8"></a>
 75     /**
 76      * @param _target branch target
<a name="9" id="anc9"></a><span class="line-modified"> 77      * @return the offset to `target&#39; relative to this instruction</span>
 78      */
<a name="10" id="anc10"></a><span class="line-modified"> 79     protected int getTargetOffset(final InstructionHandle _target) {</span>
 80         if (_target == null) {
 81             throw new ClassGenException(&quot;Target of &quot; + super.toString(true)
 82                     + &quot; is invalid null handle&quot;);
 83         }
 84         final int t = _target.getPosition();
 85         if (t &lt; 0) {
 86             throw new ClassGenException(&quot;Invalid branch target position offset for &quot;
 87                     + super.toString(true) + &quot;:&quot; + t + &quot;:&quot; + _target);
 88         }
 89         return t - position;
 90     }
 91 
<a name="11" id="anc11"></a>
 92     /**
 93      * @return the offset to this instruction&#39;s target
 94      */
 95     protected int getTargetOffset() {
 96         return getTargetOffset(target);
 97     }
 98 
<a name="12" id="anc12"></a>
 99     /**
<a name="13" id="anc13"></a><span class="line-modified">100      * Called by InstructionList.setPositions when setting the position for</span>
<span class="line-modified">101      * every instruction. In the presence of variable length instructions</span>
<span class="line-modified">102      * `setPositions&#39; performs multiple passes over the instruction list to</span>
<span class="line-modified">103      * calculate the correct (byte) positions and offsets by calling this</span>
<span class="line-removed">104      * function.</span>
105      *
<a name="14" id="anc14"></a><span class="line-modified">106      * @param offset additional offset caused by preceding (variable length)</span>
<span class="line-modified">107      * instructions</span>
<span class="line-modified">108      * @param max_offset the maximum offset that may be caused by these</span>
<span class="line-removed">109      * instructions</span>
<span class="line-removed">110      * @return additional offset caused by possible change of this instruction&#39;s</span>
<span class="line-removed">111      * length</span>
112      */
<a name="15" id="anc15"></a><span class="line-modified">113     protected int updatePosition(final int offset, final int max_offset) {</span>
114         position += offset;
115         return 0;
116     }
117 
<a name="16" id="anc16"></a>
118     /**
119      * Long output format:
120      *
<a name="17" id="anc17"></a><span class="line-modified">121      * &amp;lt;position in byte code&amp;gt; &amp;lt;name of opcode&amp;gt; &quot;[&quot;&amp;lt;opcode</span>
<span class="line-modified">122      * number&amp;gt;&quot;]&quot; &quot;(&quot;&amp;lt;length of instruction&amp;gt;&quot;)&quot; &quot;&amp;lt;&quot;&amp;lt;target</span>
<span class="line-modified">123      * instruction&amp;gt;&quot;&amp;gt;&quot; &quot;@&quot;&amp;lt;branch target offset&amp;gt;</span>

124      *
125      * @param verbose long/short format switch
126      * @return mnemonic for instruction
127      */
128     @Override
<a name="18" id="anc18"></a><span class="line-modified">129     public String toString(final boolean verbose) {</span>
130         final String s = super.toString(verbose);
131         String t = &quot;null&quot;;
132         if (verbose) {
133             if (target != null) {
134                 if (target.getInstruction() == this) {
135                     t = &quot;&lt;points to itself&gt;&quot;;
136                 } else if (target.getInstruction() == null) {
137                     t = &quot;&lt;null instruction!!!?&gt;&quot;;
138                 } else {
139                     // I&#39;m more interested in the address of the target then
140                     // the instruction located there.
141                     //t = target.getInstruction().toString(false); // Avoid circles
142                     t = &quot;&quot; + target.getPosition();
143                 }
144             }
145         } else {
146             if (target != null) {
147                 index = target.getPosition();
148                 // index = getTargetOffset();  crashes if positions haven&#39;t been set
149                 // t = &quot;&quot; + (index + position);
150                 t = &quot;&quot; + index;
151             }
152         }
153         return s + &quot; -&gt; &quot; + t;
154     }
155 
<a name="19" id="anc19"></a>
156     /**
<a name="20" id="anc20"></a><span class="line-modified">157      * Read needed data (e.g. index) from file. Conversion to a</span>
<span class="line-modified">158      * InstructionHandle is done in InstructionList(byte[]).</span>
159      *
160      * @param bytes input stream
161      * @param wide wide prefix?
162      * @see InstructionList
163      */
164     @Override
<a name="21" id="anc21"></a><span class="line-modified">165     protected void initFromFile(final ByteSequence bytes, final boolean wide) throws IOException {</span>
166         super.setLength(3);
167         index = bytes.readShort();
168     }
169 
<a name="22" id="anc22"></a>
170     /**
171      * @return target offset in byte code
172      */
173     public final int getIndex() {
174         return index;
175     }
176 
<a name="23" id="anc23"></a>
177     /**
178      * @return target of branch instruction
179      */
180     public InstructionHandle getTarget() {
181         return target;
182     }
183 
<a name="24" id="anc24"></a>
184     /**
185      * Set branch target
<a name="25" id="anc25"></a><span class="line-removed">186      *</span>
187      * @param target branch target
188      */
<a name="26" id="anc26"></a><span class="line-modified">189     public void setTarget(final InstructionHandle target) {</span>
190         notifyTarget(this.target, target, this);
191         this.target = target;
192     }
193 
<a name="27" id="anc27"></a>
194     /**
<a name="28" id="anc28"></a><span class="line-modified">195      * Used by BranchInstruction, LocalVariableGen, CodeExceptionGen,</span>
<span class="line-removed">196      * LineNumberGen</span>
197      */
<a name="29" id="anc29"></a><span class="line-modified">198     static void notifyTarget(final InstructionHandle old_ih, final InstructionHandle new_ih,</span>
<span class="line-modified">199             final InstructionTargeter t) {</span>
200         if (old_ih != null) {
201             old_ih.removeTargeter(t);
202         }
203         if (new_ih != null) {
204             new_ih.addTargeter(t);
205         }
206     }
207 
<a name="30" id="anc30"></a>
208     /**
209      * @param old_ih old target
210      * @param new_ih new target
211      */
212     @Override
<a name="31" id="anc31"></a><span class="line-modified">213     public void updateTarget(final InstructionHandle old_ih, final InstructionHandle new_ih) {</span>
214         if (target == old_ih) {
215             setTarget(new_ih);
216         } else {
217             throw new ClassGenException(&quot;Not targeting &quot; + old_ih + &quot;, but &quot; + target);
218         }
219     }
220 
<a name="32" id="anc32"></a>
221     /**
222      * @return true, if ih is target of this instruction
223      */
224     @Override
<a name="33" id="anc33"></a><span class="line-modified">225     public boolean containsTarget(final InstructionHandle ih) {</span>
226         return target == ih;
227     }
228 
<a name="34" id="anc34"></a>
229     /**
230      * Inform target that it&#39;s not targeted anymore.
231      */
232     @Override
233     void dispose() {
234         setTarget(null);
235         index = -1;
236         position = -1;
237     }
238 
<a name="35" id="anc35"></a>
239     /**
240      * @return the position
241      * @since 6.0
242      */
243     protected int getPosition() {
244         return position;
245     }
246 
<a name="36" id="anc36"></a>
247     /**
248      * @param position the position to set
249      * @since 6.0
250      */
251     protected void setPosition(final int position) {
252         this.position = position;
253     }
254 
<a name="37" id="anc37"></a>
255     /**
256      * @param index the index to set
257      * @since 6.0
258      */
259     protected void setIndex(final int index) {
260         this.index = index;
261     }
262 
263 }
<a name="38" id="anc38"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="38" type="hidden" />
</body>
</html>