<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.xml/share/classes/com/sun/org/apache/xml/internal/serializer/ToStream.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ToHTMLStream.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="ToTextStream.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml/share/classes/com/sun/org/apache/xml/internal/serializer/ToStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2006, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2006, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   */
  /*
   * Licensed to the Apache Software Foundation (ASF) under one or more
   * contributor license agreements.  See the NOTICE file distributed with
   * this work for additional information regarding copyright ownership.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -49,11 +49,11 @@</span>
  /**
   * This abstract class is a base class for other stream
   * serializers (xml, html, text ...) that write output to a stream.
   *
   * @xsl.usage internal
<span class="udiff-line-modified-removed">-  * @LastModified: Sept 2018</span>
<span class="udiff-line-modified-added">+  * @LastModified: Aug 2019</span>
   */
  abstract public class ToStream extends SerializerBase {
  
      private static final String COMMENT_BEGIN = &quot;&lt;!--&quot;;
      private static final String COMMENT_END = &quot;--&gt;&quot;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -196,11 +196,17 @@</span>
      private char m_highSurrogate = 0;
  
      /**
       * Default constructor
       */
<span class="udiff-line-modified-removed">-     public ToStream() { }</span>
<span class="udiff-line-modified-added">+     public ToStream() {</span>
<span class="udiff-line-added">+         this(null);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public ToStream(ErrorListener l) {</span>
<span class="udiff-line-added">+         m_errListener = l;</span>
<span class="udiff-line-added">+     }</span>
  
      /**
       * This helper method to writes out &quot;]]&gt;&quot; when closing a CDATA section.
       *
       * @throws org.xml.sax.SAXException
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -420,49 +426,34 @@</span>
                              || ( !defaultVal &amp;&amp; (oldExplicitEncoding == null || !oldExplicitEncoding.equalsIgnoreCase(newEncoding) ))) {
                         // We are trying to change the default or the non-default setting of the encoding to a different value
                         // from what it was
  
                         EncodingInfo encodingInfo = Encodings.getEncodingInfo(newEncoding);
<span class="udiff-line-modified-removed">-                        if (newEncoding != null &amp;&amp; encodingInfo.name == null) {</span>
<span class="udiff-line-modified-removed">-                         // We tried to get an EncodingInfo for Object for the given</span>
<span class="udiff-line-modified-removed">-                         // encoding, but it came back with an internall null name</span>
<span class="udiff-line-modified-removed">-                         // so the encoding is not supported by the JDK, issue a message.</span>
<span class="udiff-line-modified-removed">-                         final String msg = Utils.messages.createMessage(</span>
<span class="udiff-line-modified-removed">-                                 MsgKey.ER_ENCODING_NOT_SUPPORTED,new Object[]{ newEncoding });</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                         final String msg2 =</span>
<span class="udiff-line-modified-removed">-                             &quot;Warning: encoding \&quot;&quot; + newEncoding + &quot;\&quot; not supported, using &quot;</span>
<span class="udiff-line-modified-removed">-                                    + Encodings.DEFAULT_MIME_ENCODING;</span>
<span class="udiff-line-modified-removed">-                         try {</span>
<span class="udiff-line-modified-removed">-                                 // Prepare to issue the warning message</span>
<span class="udiff-line-modified-removed">-                                 final Transformer tran = super.getTransformer();</span>
<span class="udiff-line-modified-removed">-                                 if (tran != null) {</span>
<span class="udiff-line-modified-removed">-                                     final ErrorListener errHandler = tran</span>
<span class="udiff-line-modified-removed">-                                             .getErrorListener();</span>
<span class="udiff-line-removed">-                                     // Issue the warning message</span>
<span class="udiff-line-removed">-                                     if (null != errHandler</span>
<span class="udiff-line-removed">-                                             &amp;&amp; m_sourceLocator != null) {</span>
<span class="udiff-line-removed">-                                         errHandler</span>
<span class="udiff-line-removed">-                                                 .warning(new TransformerException(</span>
<span class="udiff-line-removed">-                                                         msg, m_sourceLocator));</span>
<span class="udiff-line-removed">-                                         errHandler</span>
<span class="udiff-line-removed">-                                                 .warning(new TransformerException(</span>
<span class="udiff-line-removed">-                                                         msg2, m_sourceLocator));</span>
<span class="udiff-line-removed">-                                     } else {</span>
<span class="udiff-line-removed">-                                         System.out.println(msg);</span>
<span class="udiff-line-removed">-                                         System.out.println(msg2);</span>
<span class="udiff-line-removed">-                                     }</span>
<span class="udiff-line-removed">-                                 } else {</span>
<span class="udiff-line-removed">-                                     System.out.println(msg);</span>
<span class="udiff-line-removed">-                                     System.out.println(msg2);</span>
<span class="udiff-line-modified-added">+                        if (encodingInfo.name == null) {</span>
<span class="udiff-line-modified-added">+                             // We tried to get an EncodingInfo for Object for the given</span>
<span class="udiff-line-modified-added">+                             // encoding, but it came back with an internall null name</span>
<span class="udiff-line-modified-added">+                             // so the encoding is not supported by the JDK, issue a message.</span>
<span class="udiff-line-modified-added">+                             final String msg = Utils.messages.createMessage(</span>
<span class="udiff-line-modified-added">+                                     MsgKey.ER_ENCODING_NOT_SUPPORTED,new Object[]{ newEncoding });</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+                             final String msg2 =</span>
<span class="udiff-line-modified-added">+                                 &quot;Warning: encoding \&quot;&quot; + newEncoding + &quot;\&quot; not supported, using &quot;</span>
<span class="udiff-line-modified-added">+                                        + Encodings.DEFAULT_MIME_ENCODING;</span>
<span class="udiff-line-modified-added">+                             try {</span>
<span class="udiff-line-modified-added">+                                 // refer to JDK-8229005, should throw Exception instead of warning and</span>
<span class="udiff-line-modified-added">+                                 // then falling back to the default encoding. Keep it for now.</span>
<span class="udiff-line-modified-added">+                                 if (m_errListener != null) {</span>
<span class="udiff-line-modified-added">+                                     m_errListener.warning(new TransformerException(msg, m_sourceLocator));</span>
<span class="udiff-line-modified-added">+                                     m_errListener.warning(new TransformerException(msg2, m_sourceLocator));</span>
                                  }
                              } catch (Exception e) {
                              }
  
                              // We said we are using UTF-8, so use it
                              newEncoding = Encodings.DEFAULT_MIME_ENCODING;
<span class="udiff-line-modified-removed">-                             val = Encodings.DEFAULT_MIME_ENCODING; // to store the modified value into the properties a little later</span>
<span class="udiff-line-modified-added">+                             // to store the modified value into the properties a little later</span>
<span class="udiff-line-added">+                             val = Encodings.DEFAULT_MIME_ENCODING;</span>
                              encodingInfo = Encodings.getEncodingInfo(newEncoding);
                          }
                         // The encoding was good, or was forced to UTF-8 above
  
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1229,11 +1220,11 @@</span>
              {
                  closeStartTag();
                  m_elemContext.m_startTagOpen = false;
              }
  
<span class="udiff-line-modified-removed">-             if (!m_cdataTagOpen &amp;&amp; shouldIndent())</span>
<span class="udiff-line-modified-added">+             if (!m_cdataTagOpen &amp;&amp; shouldIndentForText())</span>
                  indent();
  
              boolean writeCDataBrackets =
                  (((length &gt;= 1) &amp;&amp; escapingNotNeeded(ch[start])));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1268,10 +1259,11 @@</span>
                   */
                  if (ch[start + length - 1] == &#39;]&#39;)
                      closeCDATA();
              }
  
<span class="udiff-line-added">+             m_isprevtext = true;</span>
              // time to fire off CDATA event
              if (m_tracer != null)
                  super.fireCDATAEvent(ch, old_start, length);
          }
          catch (IOException ioe)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1534,15 +1526,17 @@</span>
              throw new SAXException(e);
          }
      }
  
      /**
<span class="udiff-line-modified-removed">-      * Used to flush the buffered characters when indentation is on, this method</span>
<span class="udiff-line-modified-removed">-      * will be called when the next node is traversed.</span>
<span class="udiff-line-modified-added">+      * Flushes the buffered characters when indentation is on. This method</span>
<span class="udiff-line-modified-added">+      * is called before the next node is traversed.</span>
       *
<span class="udiff-line-added">+      * @param isText indicates whether the node to be traversed is text</span>
<span class="udiff-line-added">+      * @throws org.xml.sax.SAXException</span>
       */
<span class="udiff-line-modified-removed">-     final protected void flushCharactersBuffer() throws SAXException {</span>
<span class="udiff-line-modified-added">+     final protected void flushCharactersBuffer(boolean isText) throws SAXException {</span>
          try {
              if (shouldFormatOutput() &amp;&amp; m_charactersBuffer.isAnyCharactersBuffered()) {
                  if (m_elemContext.m_isCdataSection) {
                      /*
                       * due to cdata-section-elements atribute, we need this as
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1551,11 +1545,13 @@</span>
                      char[] chars = m_charactersBuffer.toChars();
                      cdata(chars, 0, chars.length);
                      return;
                  }
  
<span class="udiff-line-modified-removed">-                 m_childNodeNum++;</span>
<span class="udiff-line-modified-added">+                 if (!isText) {</span>
<span class="udiff-line-added">+                     m_childNodeNum++;</span>
<span class="udiff-line-added">+                 }</span>
                  boolean skipBeginningNewlines = false;
                  if (shouldIndentForText()) {
                      indent();
                      m_startNewLine = true;
                      // newline has always been added here because if this is the
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1844,11 +1840,11 @@</span>
          if (isInEntityRef())
              return;
  
          if (m_doIndent) {
              m_childNodeNum++;
<span class="udiff-line-modified-removed">-             flushCharactersBuffer();</span>
<span class="udiff-line-modified-added">+             flushCharactersBuffer(false);</span>
          }
  
          if (m_needToCallStartDocument)
          {
              startDocumentInternal();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2115,11 +2111,11 @@</span>
  
          if (isInEntityRef())
              return;
  
          if (m_doIndent) {
<span class="udiff-line-modified-removed">-             flushCharactersBuffer();</span>
<span class="udiff-line-modified-added">+             flushCharactersBuffer(false);</span>
          }
          // namespaces declared at the current depth are no longer valid
          // so get rid of them
          m_prefixMap.popNamespaces(m_elemContext.m_currentElemDepth, null);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2307,11 +2303,11 @@</span>
          int start_old = start;
          if (isInEntityRef())
              return;
          if (m_doIndent) {
              m_childNodeNum++;
<span class="udiff-line-modified-removed">-             flushCharactersBuffer();</span>
<span class="udiff-line-modified-added">+             flushCharactersBuffer(false);</span>
          }
          if (m_elemContext.m_startTagOpen)
          {
              closeStartTag();
              m_elemContext.m_startTagOpen = false;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2489,12 +2485,11 @@</span>
       * @see #endCDATA
       */
      public void startCDATA() throws org.xml.sax.SAXException
      {
          if (m_doIndent) {
<span class="udiff-line-modified-removed">-             m_childNodeNum++;</span>
<span class="udiff-line-removed">-             flushCharactersBuffer();</span>
<span class="udiff-line-modified-added">+             flushCharactersBuffer(true);</span>
          }
  
          m_cdataStartCalled = true;
      }
  
</pre>
<center><a href="ToHTMLStream.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="ToTextStream.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>