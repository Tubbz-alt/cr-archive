<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/java.xml/share/classes/com/sun/org/apache/xerces/internal/dom/DOMNormalizer.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DOMConfigurationImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="DeferredDocumentImpl.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml/share/classes/com/sun/org/apache/xerces/internal/dom/DOMNormalizer.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.</span>
   */
  /*
   * Licensed to the Apache Software Foundation (ASF) under one or more
   * contributor license agreements.  See the NOTICE file distributed with
   * this work for additional information regarding copyright ownership.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   */
  /*
   * Licensed to the Apache Software Foundation (ASF) under one or more
   * contributor license agreements.  See the NOTICE file distributed with
   * this work for additional information regarding copyright ownership.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 20,25 ***</span>
  
  package com.sun.org.apache.xerces.internal.dom;
  
  
  
<span class="line-removed">- import com.sun.org.apache.xerces.internal.dom.AbortException;</span>
  import com.sun.org.apache.xerces.internal.impl.Constants;
  import com.sun.org.apache.xerces.internal.impl.RevalidationHandler;
<span class="line-modified">! import com.sun.org.apache.xerces.internal.impl.dtd.DTDGrammar;</span>
<span class="line-removed">- import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDDescription;</span>
  import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDValidator;
  import com.sun.org.apache.xerces.internal.impl.dv.XSSimpleType;
  import com.sun.org.apache.xerces.internal.impl.xs.util.SimpleLocator;
<span class="line-removed">- import com.sun.org.apache.xerces.internal.parsers.XMLGrammarPreparser;</span>
  import com.sun.org.apache.xerces.internal.util.AugmentationsImpl;
  import com.sun.org.apache.xerces.internal.util.NamespaceSupport;
  import com.sun.org.apache.xerces.internal.util.SymbolTable;
  import com.sun.org.apache.xerces.internal.util.XML11Char;
  import com.sun.org.apache.xerces.internal.util.XMLChar;
<span class="line-removed">- import com.sun.org.apache.xerces.internal.util.XMLGrammarPoolImpl;</span>
  import com.sun.org.apache.xerces.internal.util.XMLSymbols;
  import com.sun.org.apache.xerces.internal.xni.Augmentations;
  import com.sun.org.apache.xerces.internal.xni.NamespaceContext;
  import com.sun.org.apache.xerces.internal.xni.QName;
  import com.sun.org.apache.xerces.internal.xni.XMLAttributes;
<span class="line-new-header">--- 20,21 ---</span>
  
  package com.sun.org.apache.xerces.internal.dom;
  
  
  
  import com.sun.org.apache.xerces.internal.impl.Constants;
  import com.sun.org.apache.xerces.internal.impl.RevalidationHandler;
<span class="line-modified">! import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDLoader;</span>
  import com.sun.org.apache.xerces.internal.impl.dtd.XMLDTDValidator;
  import com.sun.org.apache.xerces.internal.impl.dv.XSSimpleType;
  import com.sun.org.apache.xerces.internal.impl.xs.util.SimpleLocator;
  import com.sun.org.apache.xerces.internal.util.AugmentationsImpl;
  import com.sun.org.apache.xerces.internal.util.NamespaceSupport;
  import com.sun.org.apache.xerces.internal.util.SymbolTable;
  import com.sun.org.apache.xerces.internal.util.XML11Char;
  import com.sun.org.apache.xerces.internal.util.XMLChar;
  import com.sun.org.apache.xerces.internal.util.XMLSymbols;
  import com.sun.org.apache.xerces.internal.xni.Augmentations;
  import com.sun.org.apache.xerces.internal.xni.NamespaceContext;
  import com.sun.org.apache.xerces.internal.xni.QName;
  import com.sun.org.apache.xerces.internal.xni.XMLAttributes;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,19 ***</span>
  import com.sun.org.apache.xerces.internal.xni.XMLLocator;
  import com.sun.org.apache.xerces.internal.xni.XMLResourceIdentifier;
  import com.sun.org.apache.xerces.internal.xni.XMLString;
  import com.sun.org.apache.xerces.internal.xni.XNIException;
  import com.sun.org.apache.xerces.internal.xni.grammars.XMLGrammarDescription;
<span class="line-removed">- import com.sun.org.apache.xerces.internal.xni.grammars.XMLGrammarPool;</span>
  import com.sun.org.apache.xerces.internal.xni.parser.XMLComponent;
  import com.sun.org.apache.xerces.internal.xni.parser.XMLDocumentSource;
<span class="line-removed">- import com.sun.org.apache.xerces.internal.xni.parser.XMLInputSource;</span>
  import com.sun.org.apache.xerces.internal.xs.AttributePSVI;
  import com.sun.org.apache.xerces.internal.xs.ElementPSVI;
  import com.sun.org.apache.xerces.internal.xs.XSTypeDefinition;
  import java.io.IOException;
<span class="line-removed">- import java.io.StringReader;</span>
  import java.util.ArrayList;
  import java.util.List;
  import java.util.Vector;
  import org.w3c.dom.Attr;
  import org.w3c.dom.Comment;
<span class="line-new-header">--- 42,16 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 94,11 ***</span>
   *
   * @xerces.experimental
   *
   * @author Elena Litani, IBM
   * @author Neeraj Bajaj, Sun Microsystems, inc.
<span class="line-modified">!  * @LastModified: Nov 2017</span>
   */
  public class DOMNormalizer implements XMLDocumentHandler {
  
      //
      // constants
<span class="line-new-header">--- 87,11 ---</span>
   *
   * @xerces.experimental
   *
   * @author Elena Litani, IBM
   * @author Neeraj Bajaj, Sun Microsystems, inc.
<span class="line-modified">!  * @LastModified: Apr 2019</span>
   */
  public class DOMNormalizer implements XMLDocumentHandler {
  
      //
      // constants
</pre>
<hr />
<pre>
<span class="line-old-header">*** 153,20 ***</span>
      /** DOM Locator -  for namespace fixup algorithm */
      protected final DOMLocatorImpl fLocator = new DOMLocatorImpl();
  
      /** for setting the PSVI */
      protected Node fCurrentNode = null;
<span class="line-modified">!     private QName fAttrQName = new QName();</span>
  
      // attribute value normalization
      final XMLString fNormalizedValue = new XMLString(new char[16], 0, 0);
  
      //DTD validator
      private XMLDTDValidator fDTDValidator;
  
<span class="line-modified">!     //Check if element content is all &quot;ignorable whitespace&quot;</span>
<span class="line-modified">!     private boolean allWhitespace = false;</span>
  
      // Constructor
      //
  
      public DOMNormalizer(){}
<span class="line-new-header">--- 146,23 ---</span>
      /** DOM Locator -  for namespace fixup algorithm */
      protected final DOMLocatorImpl fLocator = new DOMLocatorImpl();
  
      /** for setting the PSVI */
      protected Node fCurrentNode = null;
<span class="line-modified">!     private final QName fAttrQName = new QName();</span>
  
      // attribute value normalization
      final XMLString fNormalizedValue = new XMLString(new char[16], 0, 0);
  
      //DTD validator
      private XMLDTDValidator fDTDValidator;
  
<span class="line-modified">!     /** Empty string to pass to the validator. **/</span>
<span class="line-modified">!     public static final XMLString EMPTY_STRING = new XMLString();</span>
<span class="line-added">+ </span>
<span class="line-added">+     // Check if element content is all &quot;ignorable whitespace&quot;</span>
<span class="line-added">+     private boolean fAllWhitespace = false;</span>
  
      // Constructor
      //
  
      public DOMNormalizer(){}
</pre>
<hr />
<pre>
<span class="line-old-header">*** 175,79 ***</span>
  
      /**
       * Normalizes document.
       * Note: reset() must be called before this method.
       */
<span class="line-modified">!         protected void normalizeDocument(CoreDocumentImpl document, DOMConfigurationImpl config) {</span>
  
<span class="line-modified">!                 fDocument = document;</span>
<span class="line-modified">!                 fConfiguration = config;</span>
  
<span class="line-modified">!                 // intialize and reset DOMNormalizer component</span>
<span class="line-modified">!                 //</span>
<span class="line-modified">!                 fSymbolTable = (SymbolTable) fConfiguration.getProperty(DOMConfigurationImpl.SYMBOL_TABLE);</span>
<span class="line-modified">!                 // reset namespace context</span>
<span class="line-modified">!                 fNamespaceContext.reset();</span>
<span class="line-modified">!                 fNamespaceContext.declarePrefix(XMLSymbols.EMPTY_STRING, XMLSymbols.EMPTY_STRING);</span>
  
<span class="line-modified">!                 if ((fConfiguration.features &amp; DOMConfigurationImpl.VALIDATE) != 0) {</span>
              String schemaLang = (String)fConfiguration.getProperty(DOMConfigurationImpl.JAXP_SCHEMA_LANGUAGE);
  
<span class="line-modified">!             if(schemaLang != null &amp;&amp; schemaLang.equals(Constants.NS_XMLSCHEMA)) {</span>
<span class="line-modified">!                         fValidationHandler =</span>
<span class="line-modified">!                                 CoreDOMImplementationImpl.singleton.getValidator(XMLGrammarDescription.XML_SCHEMA);</span>
                  fConfiguration.setFeature(DOMConfigurationImpl.SCHEMA, true);
                  fConfiguration.setFeature(DOMConfigurationImpl.SCHEMA_FULL_CHECKING, true);
                  // report fatal error on DOM Level 1 nodes
                  fNamespaceValidation = true;
  
                  // check if we need to fill in PSVI
                  fPSVI = ((fConfiguration.features &amp; DOMConfigurationImpl.PSVI) !=0)?true:false;
              }
  
<span class="line-modified">!                         fConfiguration.setFeature(DOMConfigurationImpl.XERCES_VALIDATION, true);</span>
  
              // reset ID table
              fDocument.clearIdentifiers();
  
<span class="line-modified">!             if(fValidationHandler != null)</span>
<span class="line-modified">!             // reset schema validator</span>
                  ((XMLComponent) fValidationHandler).reset(fConfiguration);
  
<span class="line-modified">!                 }</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 fErrorHandler = (DOMErrorHandler) fConfiguration.getParameter(Constants.DOM_ERROR_HANDLER);</span>
<span class="line-modified">!                 if (fValidationHandler != null) {</span>
<span class="line-removed">-                         fValidationHandler.setDocumentHandler(this);</span>
<span class="line-removed">-                         fValidationHandler.startDocument(</span>
                      new SimpleLocator(fDocument.fDocumentURI, fDocument.fDocumentURI,
<span class="line-modified">!                                                 -1, -1 ), fDocument.encoding, fNamespaceContext, null);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 try {</span>
<span class="line-modified">!                         Node kid, next;</span>
<span class="line-modified">!                         for (kid = fDocument.getFirstChild(); kid != null; kid = next) {</span>
<span class="line-modified">!                                 next = kid.getNextSibling();</span>
<span class="line-modified">!                                 kid = normalizeNode(kid);</span>
<span class="line-removed">-                                 if (kid != null) { // don&#39;t advance</span>
<span class="line-removed">-                                         next = kid;</span>
<span class="line-removed">-                                 }</span>
<span class="line-removed">-                         }</span>
  
<span class="line-modified">!                         // release resources</span>
<span class="line-modified">!                         if (fValidationHandler != null) {</span>
<span class="line-modified">!                                 fValidationHandler.endDocument(null);</span>
<span class="line-modified">!                                 CoreDOMImplementationImpl.singleton.releaseValidator(</span>
<span class="line-modified">!                                         XMLGrammarDescription.XML_SCHEMA, fValidationHandler);</span>
<span class="line-modified">!                                 fValidationHandler = null;</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                 } catch (AbortException e) {</span>
<span class="line-removed">-                     return;</span>
                  }
  
          }
<span class="line-modified">! </span>
  
      /**
       *
       * This method acts as if the document was going through a save
       * and load cycle, putting the document in a &quot;normal&quot; form. The actual result
<span class="line-new-header">--- 171,110 ---</span>
  
      /**
       * Normalizes document.
       * Note: reset() must be called before this method.
       */
<span class="line-modified">!     protected void normalizeDocument(CoreDocumentImpl document, DOMConfigurationImpl config) {</span>
<span class="line-added">+ </span>
<span class="line-added">+         fDocument = document;</span>
<span class="line-added">+         fConfiguration = config;</span>
<span class="line-added">+         fAllWhitespace = false;</span>
<span class="line-added">+         fNamespaceValidation = false;</span>
  
<span class="line-modified">!         String xmlVersion = fDocument.getXmlVersion();</span>
<span class="line-modified">!         String schemaType = null;</span>
<span class="line-added">+         String [] schemaLocations = null;</span>
  
<span class="line-modified">!         // intialize and reset DOMNormalizer component</span>
<span class="line-modified">!         //</span>
<span class="line-modified">!         fSymbolTable = (SymbolTable) fConfiguration.getProperty(DOMConfigurationImpl.SYMBOL_TABLE);</span>
<span class="line-modified">!         // reset namespace context</span>
<span class="line-modified">!         fNamespaceContext.reset();</span>
<span class="line-modified">!         fNamespaceContext.declarePrefix(XMLSymbols.EMPTY_STRING, null);</span>
  
<span class="line-modified">!         if ((fConfiguration.features &amp; DOMConfigurationImpl.VALIDATE) != 0) {</span>
              String schemaLang = (String)fConfiguration.getProperty(DOMConfigurationImpl.JAXP_SCHEMA_LANGUAGE);
  
<span class="line-modified">!             if (schemaLang != null &amp;&amp; schemaLang.equals(Constants.NS_XMLSCHEMA)) {</span>
<span class="line-modified">!                 schemaType = XMLGrammarDescription.XML_SCHEMA;</span>
<span class="line-modified">!                 fValidationHandler = CoreDOMImplementationImpl.singleton.getValidator(schemaType, xmlVersion);</span>
                  fConfiguration.setFeature(DOMConfigurationImpl.SCHEMA, true);
                  fConfiguration.setFeature(DOMConfigurationImpl.SCHEMA_FULL_CHECKING, true);
                  // report fatal error on DOM Level 1 nodes
                  fNamespaceValidation = true;
  
                  // check if we need to fill in PSVI
                  fPSVI = ((fConfiguration.features &amp; DOMConfigurationImpl.PSVI) !=0)?true:false;
              }
<span class="line-added">+             else {</span>
<span class="line-added">+                 schemaType = XMLGrammarDescription.XML_DTD;</span>
<span class="line-added">+                 if (schemaLang != null) {</span>
<span class="line-added">+                     schemaLocations = (String []) fConfiguration.getProperty(DOMConfigurationImpl.JAXP_SCHEMA_SOURCE);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 fConfiguration.setDTDValidatorFactory(xmlVersion);</span>
<span class="line-added">+                 fValidationHandler = CoreDOMImplementationImpl.singleton.getValidator(schemaType, xmlVersion);</span>
<span class="line-added">+                 fPSVI = false;</span>
<span class="line-added">+             }</span>
  
<span class="line-modified">!             fConfiguration.setFeature(DOMConfigurationImpl.XERCES_VALIDATION, true);</span>
  
              // reset ID table
              fDocument.clearIdentifiers();
  
<span class="line-modified">!             if (fValidationHandler != null) {</span>
<span class="line-modified">!                 // reset the validation handler</span>
                  ((XMLComponent) fValidationHandler).reset(fConfiguration);
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         else {</span>
<span class="line-added">+             fValidationHandler = null;</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         fErrorHandler = (DOMErrorHandler) fConfiguration.getParameter(Constants.DOM_ERROR_HANDLER);</span>
<span class="line-modified">!         if (fValidationHandler != null) {</span>
<span class="line-modified">!             fValidationHandler.setDocumentHandler(this);</span>
<span class="line-modified">!             fValidationHandler.startDocument(</span>
                      new SimpleLocator(fDocument.fDocumentURI, fDocument.fDocumentURI,
<span class="line-modified">!                             -1, -1 ), fDocument.encoding, fNamespaceContext, null);</span>
<span class="line-modified">!             fValidationHandler.xmlDecl(fDocument.getXmlVersion(),</span>
<span class="line-modified">!                     fDocument.getXmlEncoding(), fDocument.getXmlStandalone() ? &quot;yes&quot; : &quot;no&quot;, null);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         try {</span>
<span class="line-modified">!             if (schemaType == XMLGrammarDescription.XML_DTD) {</span>
<span class="line-modified">!                 processDTD(xmlVersion, schemaLocations != null ? schemaLocations[0] : null);</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             Node kid, next;</span>
<span class="line-modified">!             for (kid = fDocument.getFirstChild(); kid != null; kid = next) {</span>
<span class="line-modified">!                 next = kid.getNextSibling();</span>
<span class="line-modified">!                 kid = normalizeNode(kid);</span>
<span class="line-modified">!                 if (kid != null) { // don&#39;t advance</span>
<span class="line-modified">!                     next = kid;</span>
                  }
<span class="line-added">+             }</span>
  
<span class="line-added">+             // release resources</span>
<span class="line-added">+             if (fValidationHandler != null) {</span>
<span class="line-added">+                 fValidationHandler.endDocument(null);</span>
<span class="line-added">+                 fValidationHandler.setDocumentHandler(null);</span>
<span class="line-added">+                 CoreDOMImplementationImpl.singleton.releaseValidator(schemaType, xmlVersion, fValidationHandler);</span>
<span class="line-added">+                 fValidationHandler = null;</span>
<span class="line-added">+             }</span>
          }
<span class="line-modified">!         catch (RuntimeException e) {</span>
<span class="line-added">+             // release resources</span>
<span class="line-added">+             if (fValidationHandler != null) {</span>
<span class="line-added">+                 fValidationHandler.setDocumentHandler(null);</span>
<span class="line-added">+                 CoreDOMImplementationImpl.singleton.releaseValidator(schemaType, xmlVersion, fValidationHandler);</span>
<span class="line-added">+                 fValidationHandler = null;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             if (e instanceof AbortException) {</span>
<span class="line-added">+                 return; // processing aborted by the user</span>
<span class="line-added">+             }</span>
<span class="line-added">+             throw e; // otherwise re-throw.</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
  
      /**
       *
       * This method acts as if the document was going through a save
       * and load cycle, putting the document in a &quot;normal&quot; form. The actual result
</pre>
<hr />
<pre>
<span class="line-old-header">*** 271,20 ***</span>
          switch (type) {
          case Node.DOCUMENT_TYPE_NODE: {
                  if (DEBUG_ND) {
                      System.out.println(&quot;==&gt;normalizeNode:{doctype}&quot;);
                  }
<span class="line-modified">!                 DocumentTypeImpl docType = (DocumentTypeImpl)node;</span>
<span class="line-removed">-                 fDTDValidator = (XMLDTDValidator)CoreDOMImplementationImpl.singleton.getValidator(XMLGrammarDescription.XML_DTD);</span>
<span class="line-removed">-                 fDTDValidator.setDocumentHandler(this);</span>
<span class="line-removed">-                 fConfiguration.setProperty(Constants.XERCES_PROPERTY_PREFIX + Constants.XMLGRAMMAR_POOL_PROPERTY, createGrammarPool(docType));</span>
<span class="line-removed">-                 fDTDValidator.reset(fConfiguration);</span>
<span class="line-removed">-                 fDTDValidator.startDocument(</span>
<span class="line-removed">-                         new SimpleLocator(fDocument.fDocumentURI, fDocument.fDocumentURI,</span>
<span class="line-removed">-                             -1, -1 ), fDocument.encoding, fNamespaceContext, null);</span>
<span class="line-removed">-                 fDTDValidator.doctypeDecl(docType.getName(), docType.getPublicId(), docType.getSystemId(), null);</span>
<span class="line-removed">-                 //REVISIT: well-formness encoding info</span>
                  break;
              }
  
          case Node.ELEMENT_NODE: {
                  if (DEBUG_ND) {
<span class="line-new-header">--- 298,11 ---</span>
          switch (type) {
          case Node.DOCUMENT_TYPE_NODE: {
                  if (DEBUG_ND) {
                      System.out.println(&quot;==&gt;normalizeNode:{doctype}&quot;);
                  }
<span class="line-modified">!                 // REVISIT: well-formedness encoding info</span>
                  break;
              }
  
          case Node.ELEMENT_NODE: {
                  if (DEBUG_ND) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 295,11 ***</span>
                  //application has set the value of well-formed features to true
                  if (fDocument.errorChecking) {
                      if ( ((fConfiguration.features &amp; DOMConfigurationImpl.WELLFORMED) != 0) &amp;&amp;
                              fDocument.isXMLVersionChanged()){
                          if (fNamespaceValidation){
<span class="line-modified">!                             wellformed = CoreDocumentImpl.isValidQName(node.getPrefix() , node.getLocalName(), fDocument.isXML11Version()) ;</span>
                          }
                          else {
                              wellformed = CoreDocumentImpl.isXMLName(node.getNodeName() , fDocument.isXML11Version());
                          }
                          if (!wellformed){
<span class="line-new-header">--- 313,11 ---</span>
                  //application has set the value of well-formed features to true
                  if (fDocument.errorChecking) {
                      if ( ((fConfiguration.features &amp; DOMConfigurationImpl.WELLFORMED) != 0) &amp;&amp;
                              fDocument.isXMLVersionChanged()){
                          if (fNamespaceValidation){
<span class="line-modified">!                             wellformed = CoreDocumentImpl.isValidQName(node.getPrefix() , node.getLocalName(), fDocument.isXML11Version());</span>
                          }
                          else {
                              wellformed = CoreDocumentImpl.isXMLName(node.getNodeName() , fDocument.isXML11Version());
                          }
                          if (!wellformed){
</pre>
<hr />
<pre>
<span class="line-old-header">*** 327,17 ***</span>
                      // fix namespaces
                      // normalize attribute values
                      // remove default attributes
                      namespaceFixUp(elem, attributes);
  
<span class="line-modified">!                     if ((fConfiguration.features &amp; DOMConfigurationImpl.NSDECL) == 0 &amp;&amp; attributes != null ) {</span>
<span class="line-modified">!                         for (int i = 0; i &lt; attributes.getLength(); ++i) {</span>
<span class="line-modified">!                             Attr att = (Attr)attributes.getItem(i);</span>
<span class="line-modified">!                             if (XMLSymbols.PREFIX_XMLNS.equals(att.getPrefix()) ||</span>
<span class="line-modified">!                                 XMLSymbols.PREFIX_XMLNS.equals(att.getName())) {</span>
<span class="line-modified">!                                 elem.removeAttributeNode(att);</span>
<span class="line-modified">!                                 --i;</span>
                              }
                          }
                      }
  
                  } else {
<span class="line-new-header">--- 345,25 ---</span>
                      // fix namespaces
                      // normalize attribute values
                      // remove default attributes
                      namespaceFixUp(elem, attributes);
  
<span class="line-modified">!                     if ((fConfiguration.features &amp; DOMConfigurationImpl.NSDECL) == 0) {</span>
<span class="line-modified">!                         // Namespace declarations may have been added by namespace fix-up. Need</span>
<span class="line-modified">!                         // to fetch the AttributeMap again if it contained no attributes prior</span>
<span class="line-modified">!                         // to namespace fix-up.</span>
<span class="line-modified">!                         if (attributes == null) {</span>
<span class="line-modified">!                             attributes = (elem.hasAttributes()) ? (AttributeMap) elem.getAttributes() : null;</span>
<span class="line-modified">!                         }</span>
<span class="line-added">+                         if (attributes != null) {</span>
<span class="line-added">+                             for (int i = 0; i &lt; attributes.getLength(); ++i) {</span>
<span class="line-added">+                                 Attr att = (Attr)attributes.getItem(i);</span>
<span class="line-added">+                                 if (XMLSymbols.PREFIX_XMLNS.equals(att.getPrefix()) ||</span>
<span class="line-added">+                                         XMLSymbols.PREFIX_XMLNS.equals(att.getName())) {</span>
<span class="line-added">+                                     elem.removeAttributeNode(att);</span>
<span class="line-added">+                                     --i;</span>
<span class="line-added">+                                 }</span>
                              }
                          }
                      }
  
                  } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 345,20 ***</span>
                          for ( int i=0; i&lt;attributes.getLength(); ++i ) {
                              Attr attr = (Attr)attributes.item(i);
                              //removeDefault(attr, attributes);
                              attr.normalize();
                              if (fDocument.errorChecking &amp;&amp; ((fConfiguration.features &amp; DOMConfigurationImpl.WELLFORMED) != 0)){
<span class="line-modified">!                                     isAttrValueWF(fErrorHandler, fError, fLocator, attributes, (AttrImpl)attr, attr.getValue(), fDocument.isXML11Version());</span>
<span class="line-modified">!                                 if (fDocument.isXMLVersionChanged()){</span>
<span class="line-modified">!                                     wellformed=CoreDocumentImpl.isXMLName(node.getNodeName() , fDocument.isXML11Version());</span>
<span class="line-modified">!                                     if (!wellformed){</span>
<span class="line-modified">!                                                             String msg = DOMMessageFormatter.formatMessage(</span>
<span class="line-modified">!                                                               DOMMessageFormatter.DOM_DOMAIN,</span>
<span class="line-modified">!                                                               &quot;wf-invalid-character-in-node-name&quot;,</span>
<span class="line-modified">!                                                                new Object[]{&quot;Attr&quot;,node.getNodeName()});</span>
<span class="line-modified">!                                                             reportDOMError(fErrorHandler, fError, fLocator, msg, DOMError.SEVERITY_ERROR,</span>
<span class="line-modified">!                                                                 &quot;wf-invalid-character-in-node-name&quot;);</span>
                                      }
                                  }
                              }
                          }
                      }
<span class="line-new-header">--- 371,25 ---</span>
                          for ( int i=0; i&lt;attributes.getLength(); ++i ) {
                              Attr attr = (Attr)attributes.item(i);
                              //removeDefault(attr, attributes);
                              attr.normalize();
                              if (fDocument.errorChecking &amp;&amp; ((fConfiguration.features &amp; DOMConfigurationImpl.WELLFORMED) != 0)){
<span class="line-modified">!                                     isAttrValueWF(fErrorHandler, fError, fLocator, attributes, attr, attr.getValue(), fDocument.isXML11Version());</span>
<span class="line-modified">!                                 if (fDocument.isXMLVersionChanged()) {</span>
<span class="line-modified">!                                     if (fNamespaceValidation){</span>
<span class="line-modified">!                                         wellformed = CoreDocumentImpl.isValidQName(node.getPrefix(), node.getLocalName(), fDocument.isXML11Version());</span>
<span class="line-modified">!                                     }</span>
<span class="line-modified">!                                     else {</span>
<span class="line-modified">!                                         wellformed = CoreDocumentImpl.isXMLName(node.getNodeName(), fDocument.isXML11Version());</span>
<span class="line-modified">!                                     }</span>
<span class="line-modified">!                                     if (!wellformed) {</span>
<span class="line-modified">!                                         String msg = DOMMessageFormatter.formatMessage(</span>
<span class="line-added">+                                           DOMMessageFormatter.DOM_DOMAIN,</span>
<span class="line-added">+                                           &quot;wf-invalid-character-in-node-name&quot;,</span>
<span class="line-added">+                                            new Object[]{&quot;Attr&quot;,node.getNodeName()});</span>
<span class="line-added">+                                         reportDOMError(fErrorHandler, fError, fLocator, msg, DOMError.SEVERITY_ERROR,</span>
<span class="line-added">+                                             &quot;wf-invalid-character-in-node-name&quot;);</span>
                                      }
                                  }
                              }
                          }
                      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 377,30 ***</span>
                      fCurrentNode = node;
                      // call re-validation handler
                      fValidationHandler.startElement(fQName, fAttrProxy, null);
                  }
  
<span class="line-removed">-                 if (fDTDValidator != null) {</span>
<span class="line-removed">-                     // REVISIT: possible solutions to discard default content are:</span>
<span class="line-removed">-                     //         either we pass some flag to XML Schema validator</span>
<span class="line-removed">-                     //         or rely on the PSVI information.</span>
<span class="line-removed">-                     fAttrProxy.setAttributes(attributes, fDocument, elem);</span>
<span class="line-removed">-                     updateQName(elem, fQName); // updates global qname</span>
<span class="line-removed">-                     // set error node in the dom error wrapper</span>
<span class="line-removed">-                     // so if error occurs we can report an error node</span>
<span class="line-removed">-                     fConfiguration.fErrorHandlerWrapper.fCurrentNode = node;</span>
<span class="line-removed">-                     fCurrentNode = node;</span>
<span class="line-removed">-                     // call re-validation handler</span>
<span class="line-removed">-                     fDTDValidator.startElement(fQName, fAttrProxy, null);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
                  // normalize children
                  Node kid, next;
                  for (kid = elem.getFirstChild(); kid != null; kid = next) {
                      next = kid.getNextSibling();
                      kid = normalizeNode(kid);
<span class="line-modified">!                     if (kid !=null) {</span>
                          next = kid;  // don&#39;t advance
                      }
                  }
                  if (DEBUG_ND) {
                      // normalized subtree
<span class="line-new-header">--- 408,16 ---</span>
                      fCurrentNode = node;
                      // call re-validation handler
                      fValidationHandler.startElement(fQName, fAttrProxy, null);
                  }
  
                  // normalize children
                  Node kid, next;
                  for (kid = elem.getFirstChild(); kid != null; kid = next) {
                      next = kid.getNextSibling();
                      kid = normalizeNode(kid);
<span class="line-modified">!                     if (kid != null) {</span>
                          next = kid;  // don&#39;t advance
                      }
                  }
                  if (DEBUG_ND) {
                      // normalized subtree
</pre>
<hr />
<pre>
<span class="line-old-header">*** 410,31 ***</span>
                          System.out.println(kid.getNodeName() +&quot;[&quot;+kid.getNodeValue()+&quot;]&quot;);
                      }
  
                  }
  
<span class="line-removed">- </span>
                  if (fValidationHandler != null) {
                      updateQName(elem, fQName); // updates global qname
                      //
                      // set error node in the dom error wrapper
                      // so if error occurs we can report an error node
                      fConfiguration.fErrorHandlerWrapper.fCurrentNode = node;
                      fCurrentNode = node;
                      fValidationHandler.endElement(fQName, null);
                  }
  
<span class="line-removed">-                 if (fDTDValidator != null) {</span>
<span class="line-removed">-                     updateQName(elem, fQName); // updates global qname</span>
<span class="line-removed">-                     //</span>
<span class="line-removed">-                     // set error node in the dom error wrapper</span>
<span class="line-removed">-                     // so if error occurs we can report an error node</span>
<span class="line-removed">-                     fConfiguration.fErrorHandlerWrapper.fCurrentNode = node;</span>
<span class="line-removed">-                     fCurrentNode = node;</span>
<span class="line-removed">-                     fDTDValidator.endElement(fQName, null);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
                  // pop namespace context
                  fNamespaceContext.popContext();
  
                  break;
              }
<span class="line-new-header">--- 427,20 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 463,10 ***</span>
<span class="line-new-header">--- 469,17 ---</span>
                          String commentdata = ((Comment)node).getData();
                          // check comments for invalid xml chracter as per the version
                          // of the document
                          isCommentWF(fErrorHandler, fError, fLocator, commentdata, fDocument.isXML11Version());
                      }
<span class="line-added">+                     if (fValidationHandler != null) {</span>
<span class="line-added">+                         // Don&#39;t bother filling an XMLString with the text of the comment.</span>
<span class="line-added">+                         // We only send the comment event to the validator handler so that</span>
<span class="line-added">+                         // when  the schema-type is DTD an error will be reported for a</span>
<span class="line-added">+                         // comment appearing in EMPTY content.</span>
<span class="line-added">+                         fValidationHandler.comment(EMPTY_STRING, null);</span>
<span class="line-added">+                     }</span>
                  }//end-else if comment node is not to be removed.
                                  break;
              }
          case Node.ENTITY_REFERENCE_NODE: {
                  if (DEBUG_ND) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 529,20 ***</span>
                      fCurrentNode = node;
                      fValidationHandler.startCDATA(null);
                      fValidationHandler.characterData(node.getNodeValue(), null);
                      fValidationHandler.endCDATA(null);
                  }
<span class="line-removed">- </span>
<span class="line-removed">-                 if (fDTDValidator != null) {</span>
<span class="line-removed">-                     // set error node in the dom error wrapper</span>
<span class="line-removed">-                     // so if error occurs we can report an error node</span>
<span class="line-removed">-                     fConfiguration.fErrorHandlerWrapper.fCurrentNode = node;</span>
<span class="line-removed">-                     fCurrentNode = node;</span>
<span class="line-removed">-                     fDTDValidator.startCDATA(null);</span>
<span class="line-removed">-                     fDTDValidator.characterData(node.getNodeValue(), null);</span>
<span class="line-removed">-                     fDTDValidator.endCDATA(null);</span>
<span class="line-removed">-                 }</span>
                  String value = node.getNodeValue();
  
                  if ((fConfiguration.features &amp; DOMConfigurationImpl.SPLITCDATA) != 0) {
                      int index;
                      Node parent = node.getParentNode();
<span class="line-new-header">--- 542,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 603,46 ***</span>
                      // 2. comments is false, and next child is comment
                      // 3. cdata is false, and next child is cdata
  
                      short nextType = (next != null)?next.getNodeType():-1;
                      if (nextType == -1 || !(((fConfiguration.features &amp; DOMConfigurationImpl.ENTITIES) == 0 &amp;&amp;
<span class="line-modified">!                            nextType == Node.ENTITY_NODE) ||</span>
<span class="line-modified">!                           ((fConfiguration.features &amp; DOMConfigurationImpl.COMMENTS) == 0 &amp;&amp;</span>
<span class="line-modified">!                            nextType == Node.COMMENT_NODE) ||</span>
<span class="line-modified">!                           ((fConfiguration.features &amp; DOMConfigurationImpl.CDATA) == 0) &amp;&amp;</span>
<span class="line-modified">!                           nextType == Node.CDATA_SECTION_NODE)) {</span>
<span class="line-modified">!                               if (fDocument.errorChecking &amp;&amp; ((fConfiguration.features &amp; DOMConfigurationImpl.WELLFORMED) != 0) ){</span>
<span class="line-modified">!                                   isXMLCharWF(fErrorHandler, fError, fLocator, node.getNodeValue(), fDocument.isXML11Version());</span>
<span class="line-modified">!                               }</span>
<span class="line-modified">!                               if (fValidationHandler != null) {</span>
<span class="line-modified">!                                      fConfiguration.fErrorHandlerWrapper.fCurrentNode = node;</span>
<span class="line-modified">!                                      fCurrentNode = node;</span>
<span class="line-modified">!                                      fValidationHandler.characterData(node.getNodeValue(), null);</span>
<span class="line-modified">!                                      if (DEBUG_ND) {</span>
<span class="line-modified">!                                          System.out.println(&quot;=====&gt;characterData(),&quot;+nextType);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                                      }</span>
<span class="line-modified">!                               }</span>
<span class="line-modified">!                               if (fDTDValidator != null) {</span>
<span class="line-modified">!                                   fConfiguration.fErrorHandlerWrapper.fCurrentNode = node;</span>
<span class="line-modified">!                                   fCurrentNode = node;</span>
<span class="line-modified">!                                   fDTDValidator.characterData(node.getNodeValue(), null);</span>
<span class="line-modified">!                                   if (DEBUG_ND) {</span>
<span class="line-modified">!                                       System.out.println(&quot;=====&gt;characterData(),&quot;+nextType);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                                   }</span>
<span class="line-removed">-                                   if(allWhitespace) {</span>
<span class="line-removed">-                                       allWhitespace = false;</span>
<span class="line-removed">-                                       ((TextImpl)node).setIgnorableWhitespace(true);</span>
<span class="line-removed">-                                   }</span>
<span class="line-removed">-                               }</span>
                      }
                      else {
<span class="line-modified">!                             if (DEBUG_ND) {</span>
<span class="line-modified">!                                 System.out.println(&quot;=====&gt;don&#39;t send characters(),&quot;+nextType);</span>
  
<span class="line-modified">!                             }</span>
                      }
                  }
                  break;
              }
          case Node.PROCESSING_INSTRUCTION_NODE: {
<span class="line-new-header">--- 606,41 ---</span>
                      // 2. comments is false, and next child is comment
                      // 3. cdata is false, and next child is cdata
  
                      short nextType = (next != null)?next.getNodeType():-1;
                      if (nextType == -1 || !(((fConfiguration.features &amp; DOMConfigurationImpl.ENTITIES) == 0 &amp;&amp;
<span class="line-modified">!                             nextType == Node.ENTITY_NODE) ||</span>
<span class="line-modified">!                             ((fConfiguration.features &amp; DOMConfigurationImpl.COMMENTS) == 0 &amp;&amp;</span>
<span class="line-modified">!                                     nextType == Node.COMMENT_NODE) ||</span>
<span class="line-modified">!                                     ((fConfiguration.features &amp; DOMConfigurationImpl.CDATA) == 0) &amp;&amp;</span>
<span class="line-modified">!                                     nextType == Node.CDATA_SECTION_NODE)) {</span>
<span class="line-modified">!                         if (fDocument.errorChecking &amp;&amp; ((fConfiguration.features &amp; DOMConfigurationImpl.WELLFORMED) != 0) ){</span>
<span class="line-modified">!                             isXMLCharWF(fErrorHandler, fError, fLocator, node.getNodeValue(), fDocument.isXML11Version());</span>
<span class="line-modified">!                         }</span>
<span class="line-modified">!                         if (fValidationHandler != null) {</span>
<span class="line-modified">!                             fConfiguration.fErrorHandlerWrapper.fCurrentNode = node;</span>
<span class="line-modified">!                             fCurrentNode = node;</span>
<span class="line-modified">!                             fValidationHandler.characterData(node.getNodeValue(), null);</span>
<span class="line-modified">!                             if (!fNamespaceValidation) {</span>
<span class="line-modified">!                                 if (fAllWhitespace) {</span>
<span class="line-modified">!                                     fAllWhitespace = false;</span>
<span class="line-modified">!                                     ((TextImpl)node).setIgnorableWhitespace(true);</span>
<span class="line-modified">!                                 }</span>
<span class="line-modified">!                                 else {</span>
<span class="line-modified">!                                     ((TextImpl)node).setIgnorableWhitespace(false);</span>
<span class="line-modified">!                                 }</span>
<span class="line-modified">!                             }</span>
<span class="line-modified">!                             if (DEBUG_ND) {</span>
<span class="line-modified">!                                 System.out.println(&quot;=====&gt;characterData(),&quot;+nextType);</span>
<span class="line-modified">!                             }</span>
<span class="line-modified">!                         }</span>
                      }
                      else {
<span class="line-modified">!                         if (DEBUG_ND) {</span>
<span class="line-modified">!                             System.out.println(&quot;=====&gt;don&#39;t send characters(),&quot;+nextType);</span>
  
<span class="line-modified">!                         }</span>
                      }
                  }
                  break;
              }
          case Node.PROCESSING_INSTRUCTION_NODE: {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 672,46 ***</span>
                  //2. check PI data
                  //processing isntruction data may have certain characters
                  //which may not be valid XML character
                  isXMLCharWF(fErrorHandler, fError, fLocator, pinode.getData(), fDocument.isXML11Version());
              }
          }//end case Node.PROCESSING_INSTRUCTION_NODE
  
          }//end of switch
          return null;
      }//normalizeNode
  
<span class="line-modified">!     private XMLGrammarPool createGrammarPool(DocumentTypeImpl docType) {</span>
<span class="line-removed">- </span>
<span class="line-removed">-         XMLGrammarPoolImpl pool = new XMLGrammarPoolImpl();</span>
  
<span class="line-modified">!         XMLGrammarPreparser preParser = new XMLGrammarPreparser(fSymbolTable);</span>
<span class="line-modified">!         preParser.registerPreparser(XMLGrammarDescription.XML_DTD, null);</span>
<span class="line-modified">!         preParser.setFeature(Constants.XERCES_FEATURE_PREFIX + Constants.NAMESPACES_FEATURE, true);</span>
<span class="line-modified">!         preParser.setFeature(Constants.XERCES_FEATURE_PREFIX + Constants.VALIDATION_FEATURE, true);</span>
<span class="line-modified">!         preParser.setProperty(Constants.XERCES_PROPERTY_PREFIX + Constants.XMLGRAMMAR_POOL_PROPERTY, pool);</span>
  
<span class="line-modified">!         String internalSubset = docType.getInternalSubset();</span>
<span class="line-modified">!         XMLInputSource is = new XMLInputSource(docType.getPublicId(), docType.getSystemId(), null, false);</span>
  
<span class="line-modified">!         if(internalSubset != null)</span>
<span class="line-removed">-             is.setCharacterStream(new StringReader(internalSubset));</span>
          try {
<span class="line-modified">!             DTDGrammar g = (DTDGrammar)preParser.preparseGrammar(XMLGrammarDescription.XML_DTD, is);</span>
<span class="line-modified">!             ((XMLDTDDescription)g.getGrammarDescription()).setRootName(docType.getName());</span>
<span class="line-modified">!             is.setCharacterStream(null);</span>
<span class="line-modified">!             g = (DTDGrammar)preParser.preparseGrammar(XMLGrammarDescription.XML_DTD, is);</span>
<span class="line-modified">!             ((XMLDTDDescription)g.getGrammarDescription()).setRootName(docType.getName());</span>
<span class="line-modified">! </span>
<span class="line-modified">!         } catch (XNIException e) {</span>
<span class="line-removed">-         } catch (IOException e) {</span>
          }
<span class="line-modified">! </span>
<span class="line-modified">!         return pool;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">! </span>
  
      protected final void expandEntityRef (Node parent, Node reference){
          Node kid, next;
          for (kid = reference.getFirstChild(); kid != null; kid = next) {
              next = kid.getNextSibling();
<span class="line-new-header">--- 670,70 ---</span>
                  //2. check PI data
                  //processing isntruction data may have certain characters
                  //which may not be valid XML character
                  isXMLCharWF(fErrorHandler, fError, fLocator, pinode.getData(), fDocument.isXML11Version());
              }
<span class="line-added">+ </span>
<span class="line-added">+             if (fValidationHandler != null) {</span>
<span class="line-added">+                 // Don&#39;t bother filling an XMLString with the data section of the</span>
<span class="line-added">+                 // processing instruction. We only send the processing instruction</span>
<span class="line-added">+                 // event to the validator handler so that when the schema-type is</span>
<span class="line-added">+                 // DTD an error will be reported for a processing instruction</span>
<span class="line-added">+                 // appearing in EMPTY content.</span>
<span class="line-added">+                 fValidationHandler.processingInstruction(((ProcessingInstruction) node).getTarget(), EMPTY_STRING, null);</span>
<span class="line-added">+             }</span>
          }//end case Node.PROCESSING_INSTRUCTION_NODE
  
          }//end of switch
          return null;
      }//normalizeNode
  
<span class="line-modified">!     private void processDTD(String xmlVersion, String schemaLocation) {</span>
  
<span class="line-modified">!         String rootName = null;</span>
<span class="line-modified">!         String publicId = null;</span>
<span class="line-modified">!         String systemId = schemaLocation;</span>
<span class="line-modified">!         String baseSystemId = fDocument.getDocumentURI();</span>
<span class="line-modified">!         String internalSubset = null;</span>
  
<span class="line-modified">!         DocumentType docType = fDocument.getDoctype();</span>
<span class="line-modified">!         if (docType != null) {</span>
<span class="line-added">+             rootName = docType.getName();</span>
<span class="line-added">+             publicId = docType.getPublicId();</span>
<span class="line-added">+             if (systemId == null || systemId.length() == 0) {</span>
<span class="line-added">+                 systemId = docType.getSystemId();</span>
<span class="line-added">+             }</span>
<span class="line-added">+             internalSubset = docType.getInternalSubset();</span>
<span class="line-added">+         }</span>
<span class="line-added">+         // If the DOM doesn&#39;t have a DocumentType node we may still</span>
<span class="line-added">+         // be able to fetch a DTD if the application provided a URI</span>
<span class="line-added">+         else {</span>
<span class="line-added">+             Element elem = fDocument.getDocumentElement();</span>
<span class="line-added">+             if (elem == null) return;</span>
<span class="line-added">+             rootName = elem.getNodeName();</span>
<span class="line-added">+             if (systemId == null || systemId.length() == 0) return;</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         XMLDTDLoader loader = null;</span>
          try {
<span class="line-modified">!             fValidationHandler.doctypeDecl(rootName, publicId, systemId, null);</span>
<span class="line-modified">!             loader = CoreDOMImplementationImpl.singleton.getDTDLoader(xmlVersion);</span>
<span class="line-modified">!             loader.setFeature(DOMConfigurationImpl.XERCES_VALIDATION, true);</span>
<span class="line-modified">!             loader.setEntityResolver(fConfiguration.getEntityResolver());</span>
<span class="line-modified">!             loader.setErrorHandler(fConfiguration.getErrorHandler());</span>
<span class="line-modified">!             loader.loadGrammarWithContext((XMLDTDValidator) fValidationHandler, rootName,</span>
<span class="line-modified">!                     publicId, systemId, baseSystemId, internalSubset);</span>
          }
<span class="line-modified">!         // REVISIT: Should probably report this exception to the error handler.</span>
<span class="line-modified">!         catch (IOException e) {</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         finally {</span>
<span class="line-modified">!             if (loader != null) {</span>
<span class="line-added">+                 CoreDOMImplementationImpl.singleton.releaseDTDLoader(xmlVersion, loader);</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+     } // processDTD(String, String)</span>
  
      protected final void expandEntityRef (Node parent, Node reference){
          Node kid, next;
          for (kid = reference.getFirstChild(); kid != null; kid = next) {
              next = kid.getNextSibling();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 738,34 ***</span>
          //    --&gt;
          //   &lt;xsl:body xmlns:xsl=&quot;http://bound&quot;/&gt;
          //
          // ------------------------------------
  
<span class="line-modified">!         String value, name, uri, prefix;</span>
          if (attributes != null) {
  
              // Record all valid local declarations
              for (int k = 0; k &lt; attributes.getLength(); ++k) {
                  Attr attr = (Attr)attributes.getItem(k);
<span class="line-removed">- </span>
<span class="line-removed">-                 //do the name check only when version of the document was changed &amp;</span>
<span class="line-removed">-                 //application has set the value of well-formed features to true</span>
<span class="line-removed">-                 if (fDocument.errorChecking &amp;&amp; ((fConfiguration.features &amp; DOMConfigurationImpl.WELLFORMED) != 0) &amp;&amp;</span>
<span class="line-removed">-                     fDocument.isXMLVersionChanged()) {</span>
<span class="line-removed">-                     //checkQName does checking based on the version of the document</span>
<span class="line-removed">-                     fDocument.checkQName(attr.getPrefix() , attr.getLocalName()) ;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
                  uri = attr.getNamespaceURI();
                  if (uri != null &amp;&amp; uri.equals(NamespaceContext.XMLNS_URI)) {
                      // namespace attribute
<span class="line-removed">- </span>
<span class="line-removed">-                     // &quot;namespace-declarations&quot; == false; Discard all namespace declaration attributes</span>
<span class="line-removed">-                     if ((fConfiguration.features &amp; DOMConfigurationImpl.NSDECL) == 0) {</span>
<span class="line-removed">-                         continue;</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">- </span>
                      value = attr.getNodeValue();
                      if (value == null) {
                          value=XMLSymbols.EMPTY_STRING;
                      }
  
<span class="line-new-header">--- 760,19 ---</span>
          //    --&gt;
          //   &lt;xsl:body xmlns:xsl=&quot;http://bound&quot;/&gt;
          //
          // ------------------------------------
  
<span class="line-modified">!         String value, uri, prefix;</span>
          if (attributes != null) {
  
              // Record all valid local declarations
              for (int k = 0; k &lt; attributes.getLength(); ++k) {
                  Attr attr = (Attr)attributes.getItem(k);
                  uri = attr.getNamespaceURI();
                  if (uri != null &amp;&amp; uri.equals(NamespaceContext.XMLNS_URI)) {
                      // namespace attribute
                      value = attr.getNodeValue();
                      if (value == null) {
                          value=XMLSymbols.EMPTY_STRING;
                      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 796,11 ***</span>
                              //removeDefault (attr, attributes);
                              continue;
                          } else { // (localpart == fXmlnsSymbol &amp;&amp; prefix == fEmptySymbol)  -- xmlns
                              // empty prefix is always bound (&quot;&quot; or some string)
                              value = fSymbolTable.addSymbol(value);
<span class="line-modified">!                             fNamespaceContext.declarePrefix(XMLSymbols.EMPTY_STRING, value);</span>
                              //removeDefault (attr, attributes);
                              continue;
                          }
                      }  // end-else: valid declaration
                  } // end-if: namespace attribute
<span class="line-new-header">--- 803,11 ---</span>
                              //removeDefault (attr, attributes);
                              continue;
                          } else { // (localpart == fXmlnsSymbol &amp;&amp; prefix == fEmptySymbol)  -- xmlns
                              // empty prefix is always bound (&quot;&quot; or some string)
                              value = fSymbolTable.addSymbol(value);
<span class="line-modified">!                             fNamespaceContext.declarePrefix(XMLSymbols.EMPTY_STRING, value.length() != 0 ? value : null);</span>
                              //removeDefault (attr, attributes);
                              continue;
                          }
                      }  // end-else: valid declaration
                  } // end-if: namespace attribute
</pre>
<hr />
<pre>
<span class="line-old-header">*** 824,16 ***</span>
          // check if prefix/namespace is correct for current element
          // ---------------------------------------------------------
  
          uri = element.getNamespaceURI();
          prefix = element.getPrefix();
<span class="line-modified">! </span>
<span class="line-removed">-         // &quot;namespace-declarations&quot; == false? Discard all namespace declaration attributes</span>
<span class="line-removed">-         if ((fConfiguration.features &amp; DOMConfigurationImpl.NSDECL) == 0) {</span>
<span class="line-removed">-             // no namespace declaration == no namespace URI, semantics are to keep prefix</span>
<span class="line-removed">-             uri = null;</span>
<span class="line-removed">-         } else if (uri != null) {  // Element has a namespace</span>
              uri = fSymbolTable.addSymbol(uri);
              prefix = (prefix == null ||
                        prefix.length() == 0) ? XMLSymbols.EMPTY_STRING :fSymbolTable.addSymbol(prefix);
              if (fNamespaceContext.getURI(prefix) == uri) {
                  // The xmlns:prefix=namespace or xmlns=&quot;default&quot; was declared at parent.
<span class="line-new-header">--- 831,11 ---</span>
          // check if prefix/namespace is correct for current element
          // ---------------------------------------------------------
  
          uri = element.getNamespaceURI();
          prefix = element.getPrefix();
<span class="line-modified">!         if (uri != null) {  // Element has a namespace</span>
              uri = fSymbolTable.addSymbol(uri);
              prefix = (prefix == null ||
                        prefix.length() == 0) ? XMLSymbols.EMPTY_STRING :fSymbolTable.addSymbol(prefix);
              if (fNamespaceContext.getURI(prefix) == uri) {
                  // The xmlns:prefix=namespace or xmlns=&quot;default&quot; was declared at parent.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 868,12 ***</span>
                  uri = fNamespaceContext.getURI(XMLSymbols.EMPTY_STRING);
                  if (uri !=null &amp;&amp; uri.length() &gt; 0) {
                      // undeclare default namespace declaration (before that element
                      // bound to non-zero length uir), but adding xmlns=&quot;&quot; decl
                      addNamespaceDecl (XMLSymbols.EMPTY_STRING, XMLSymbols.EMPTY_STRING, element);
<span class="line-modified">!                     fLocalNSBinder.declarePrefix(XMLSymbols.EMPTY_STRING, XMLSymbols.EMPTY_STRING);</span>
<span class="line-modified">!                     fNamespaceContext.declarePrefix(XMLSymbols.EMPTY_STRING, XMLSymbols.EMPTY_STRING);</span>
                  }
              }
          }
  
          // -----------------------------------------
<span class="line-new-header">--- 870,12 ---</span>
                  uri = fNamespaceContext.getURI(XMLSymbols.EMPTY_STRING);
                  if (uri !=null &amp;&amp; uri.length() &gt; 0) {
                      // undeclare default namespace declaration (before that element
                      // bound to non-zero length uir), but adding xmlns=&quot;&quot; decl
                      addNamespaceDecl (XMLSymbols.EMPTY_STRING, XMLSymbols.EMPTY_STRING, element);
<span class="line-modified">!                     fLocalNSBinder.declarePrefix(XMLSymbols.EMPTY_STRING, null);</span>
<span class="line-modified">!                     fNamespaceContext.declarePrefix(XMLSymbols.EMPTY_STRING, null);</span>
                  }
              }
          }
  
          // -----------------------------------------
</pre>
<hr />
<pre>
<span class="line-old-header">*** 892,16 ***</span>
                      System.out.println(&quot;==&gt;[ns-fixup] process attribute: &quot;+attr.getNodeName());
                  }
                  // normalize attribute value
                  attr.normalize();
                  value = attr.getValue();
<span class="line-removed">-                 name = attr.getNodeName();</span>
                  uri = attr.getNamespaceURI();
  
                  // make sure that value is never null.
                  if (value == null) {
<span class="line-modified">!                     value=XMLSymbols.EMPTY_STRING;</span>
                  }
  
                  if (uri != null) {  // attribute has namespace !=null
                      prefix = attr.getPrefix();
                      prefix = (prefix == null ||
<span class="line-new-header">--- 894,39 ---</span>
                      System.out.println(&quot;==&gt;[ns-fixup] process attribute: &quot;+attr.getNodeName());
                  }
                  // normalize attribute value
                  attr.normalize();
                  value = attr.getValue();
                  uri = attr.getNamespaceURI();
  
                  // make sure that value is never null.
                  if (value == null) {
<span class="line-modified">!                     value = XMLSymbols.EMPTY_STRING;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+ </span>
<span class="line-added">+                 //---------------------------------------</span>
<span class="line-added">+                 // check if value of the attribute is namespace well-formed</span>
<span class="line-added">+                 //---------------------------------------</span>
<span class="line-added">+                 if (fDocument.errorChecking &amp;&amp; ((fConfiguration.features &amp; DOMConfigurationImpl.WELLFORMED) != 0)) {</span>
<span class="line-added">+                     isAttrValueWF(fErrorHandler, fError, fLocator, attributes, attr, value, fDocument.isXML11Version());</span>
<span class="line-added">+                     if (fDocument.isXMLVersionChanged()) {</span>
<span class="line-added">+                         boolean wellformed;</span>
<span class="line-added">+                         if (fNamespaceValidation){</span>
<span class="line-added">+                             wellformed = CoreDocumentImpl.isValidQName(attr.getPrefix(), attr.getLocalName(), fDocument.isXML11Version());</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                         else {</span>
<span class="line-added">+                             wellformed = CoreDocumentImpl.isXMLName(attr.getNodeName(), fDocument.isXML11Version());</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                         if (!wellformed) {</span>
<span class="line-added">+                             String msg = DOMMessageFormatter.formatMessage(</span>
<span class="line-added">+                                     DOMMessageFormatter.DOM_DOMAIN,</span>
<span class="line-added">+                                     &quot;wf-invalid-character-in-node-name&quot;,</span>
<span class="line-added">+                                     new Object[]{&quot;Attr&quot;, attr.getNodeName()});</span>
<span class="line-added">+                             reportDOMError(fErrorHandler, fError, fLocator, msg, DOMError.SEVERITY_ERROR,</span>
<span class="line-added">+                             &quot;wf-invalid-character-in-node-name&quot;);</span>
<span class="line-added">+                         }</span>
<span class="line-added">+                     }</span>
                  }
  
                  if (uri != null) {  // attribute has namespace !=null
                      prefix = attr.getPrefix();
                      prefix = (prefix == null ||
</pre>
<hr />
<pre>
<span class="line-old-header">*** 914,27 ***</span>
                      // REVISIT: can we assume that &quot;uri&quot; is from some symbol
                      // table, and compare by reference? -SG
                      if (uri != null &amp;&amp; uri.equals(NamespaceContext.XMLNS_URI)) {
                          continue;
                      }
<span class="line-removed">-                     //---------------------------------------</span>
<span class="line-removed">-                     // check if value of the attribute is namespace well-formed</span>
<span class="line-removed">-                     //---------------------------------------</span>
<span class="line-removed">-                     if (fDocument.errorChecking &amp;&amp; ((fConfiguration.features &amp; DOMConfigurationImpl.WELLFORMED) != 0)) {</span>
<span class="line-removed">-                             isAttrValueWF(fErrorHandler, fError, fLocator, attributes, (AttrImpl)attr, attr.getValue(), fDocument.isXML11Version());</span>
<span class="line-removed">-                             if (fDocument.isXMLVersionChanged()){</span>
<span class="line-removed">-                                 boolean wellformed=CoreDocumentImpl.isXMLName(attr.getNodeName() , fDocument.isXML11Version());</span>
<span class="line-removed">-                                 if (!wellformed){</span>
<span class="line-removed">-                                                         String msg = DOMMessageFormatter.formatMessage(</span>
<span class="line-removed">-                                                             DOMMessageFormatter.DOM_DOMAIN,</span>
<span class="line-removed">-                                                             &quot;wf-invalid-character-in-node-name&quot;,</span>
<span class="line-removed">-                                                             new Object[]{&quot;Attribute&quot;, attr.getNodeName()});</span>
<span class="line-removed">-                                         reportDOMError(fErrorHandler, fError, fLocator, msg, DOMError.SEVERITY_ERROR,</span>
<span class="line-removed">-                                             &quot;wf-invalid-character-in-node-name&quot;);</span>
<span class="line-removed">-                                 }</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     }</span>
  
                      // ---------------------------------------
                      // remove default attributes
                      // ---------------------------------------
                      /*
<span class="line-new-header">--- 939,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 946,11 ***</span>
                      //value = normalizeAttributeValue(value, attr);
  
                      // reset id-attributes
                      ((AttrImpl)attr).setIdAttribute(false);
  
<span class="line-removed">- </span>
                      uri = fSymbolTable.addSymbol(uri);
  
                      // find if for this prefix a URI was already declared
                      String declaredURI =  fNamespaceContext.getURI(prefix);
  
<span class="line-new-header">--- 954,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 960,11 ***</span>
                          // attribute prefix is not declared
                          // OR
                          // conflict: attribute has a prefix that conficlicts with a binding
                          //           already active in scope
  
<span class="line-removed">-                         name  = attr.getNodeName();</span>
                          // Find if any prefix for attributes namespace URI is available
                          // in the scope
                          String declaredPrefix = fNamespaceContext.getPrefix(uri);
                          if (declaredPrefix !=null &amp;&amp; declaredPrefix !=XMLSymbols.EMPTY_STRING) {
  
<span class="line-new-header">--- 967,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1445,64 ***</span>
      implements XMLAttributes {
          protected AttributeMap fAttributes;
          protected CoreDocumentImpl fDocument;
          protected ElementImpl fElement;
  
<span class="line-modified">!         protected final Vector&lt;Augmentations&gt; fAugmentations = new Vector&lt;&gt;(5);</span>
<span class="line-modified">! </span>
  
          public void setAttributes(AttributeMap attributes, CoreDocumentImpl doc, ElementImpl elem) {
              fDocument = doc;
              fAttributes = attributes;
              fElement = elem;
              if (attributes != null) {
                  int length = attributes.getLength();
<span class="line-modified">! </span>
                  fAugmentations.setSize(length);
                  // REVISIT: this implementation does not store any value in augmentations
                  //          and basically not keeping augs in parallel to attributes map
                  //          untill all attributes are added (default attributes)
                  for (int i = 0; i &lt; length; i++) {
                      fAugmentations.setElementAt(new AugmentationsImpl(), i);
                  }
<span class="line-modified">!             } else {</span>
                  fAugmentations.setSize(0);
              }
          }
  
  
<span class="line-modified">!                 /**</span>
           * This method adds default declarations
                   * @see com.sun.org.apache.xerces.internal.xni.XMLAttributes#addAttribute(QName, String, String)
<span class="line-modified">!                  */</span>
<span class="line-modified">!                 public int addAttribute(QName qname, String attrType, String attrValue) {</span>
<span class="line-modified">!                         int index = fElement.getXercesAttribute(qname.uri, qname.localpart);</span>
<span class="line-modified">!                         // add defaults to the tree</span>
<span class="line-modified">!                         if (index &lt; 0) {</span>
                  // the default attribute was removed by a user and needed to
                  // be added back
<span class="line-modified">!                                 AttrImpl attr = (AttrImpl)</span>
<span class="line-modified">!                                         ((CoreDocumentImpl) fElement.getOwnerDocument()).createAttributeNS(</span>
<span class="line-modified">!                                                 qname.uri,</span>
<span class="line-modified">!                                                 qname.rawname,</span>
<span class="line-modified">!                                                 qname.localpart);</span>
                  // REVISIT: the following should also update ID table
                  attr.setNodeValue(attrValue);
                  index = fElement.setXercesAttributeNode(attr);
                  fAugmentations.insertElementAt(new AugmentationsImpl(), index);
                  attr.setSpecified(false);
<span class="line-modified">!                         }</span>
<span class="line-modified">!                         else {</span>
                  // default attribute is in the tree
                  // we don&#39;t need to do anything since prefix was already fixed
                  // at the namespace fixup time and value must be same value, otherwise
                  // attribute will be treated as specified and we will never reach
                  // this method.
  
              }
              return index;
<span class="line-modified">!                 }</span>
  
  
          public void removeAllAttributes(){
              // REVISIT: implement
          }
<span class="line-new-header">--- 1451,67 ---</span>
      implements XMLAttributes {
          protected AttributeMap fAttributes;
          protected CoreDocumentImpl fDocument;
          protected ElementImpl fElement;
  
<span class="line-modified">!         protected Vector&lt;String&gt; fDTDTypes = new Vector&lt;&gt;(5);</span>
<span class="line-modified">!         protected Vector&lt;Augmentations&gt; fAugmentations = new Vector&lt;&gt;(5);</span>
  
          public void setAttributes(AttributeMap attributes, CoreDocumentImpl doc, ElementImpl elem) {
              fDocument = doc;
              fAttributes = attributes;
              fElement = elem;
              if (attributes != null) {
                  int length = attributes.getLength();
<span class="line-modified">!                 fDTDTypes.setSize(length);</span>
                  fAugmentations.setSize(length);
                  // REVISIT: this implementation does not store any value in augmentations
                  //          and basically not keeping augs in parallel to attributes map
                  //          untill all attributes are added (default attributes)
                  for (int i = 0; i &lt; length; i++) {
                      fAugmentations.setElementAt(new AugmentationsImpl(), i);
                  }
<span class="line-modified">!             }</span>
<span class="line-added">+             else {</span>
<span class="line-added">+                 fDTDTypes.setSize(0);</span>
                  fAugmentations.setSize(0);
              }
          }
  
  
<span class="line-modified">!         /**</span>
           * This method adds default declarations
                   * @see com.sun.org.apache.xerces.internal.xni.XMLAttributes#addAttribute(QName, String, String)
<span class="line-modified">!          */</span>
<span class="line-modified">!         public int addAttribute(QName qname, String attrType, String attrValue) {</span>
<span class="line-modified">!             int index = fElement.getXercesAttribute(qname.uri, qname.localpart);</span>
<span class="line-modified">!             // add defaults to the tree</span>
<span class="line-modified">!             if (index &lt; 0) {</span>
                  // the default attribute was removed by a user and needed to
                  // be added back
<span class="line-modified">!                 AttrImpl attr = (AttrImpl)</span>
<span class="line-modified">!                     ((CoreDocumentImpl) fElement.getOwnerDocument()).createAttributeNS(</span>
<span class="line-modified">!                         qname.uri,</span>
<span class="line-modified">!                         qname.rawname,</span>
<span class="line-modified">!                         qname.localpart);</span>
                  // REVISIT: the following should also update ID table
                  attr.setNodeValue(attrValue);
                  index = fElement.setXercesAttributeNode(attr);
<span class="line-added">+                 fDTDTypes.insertElementAt(attrType, index);</span>
                  fAugmentations.insertElementAt(new AugmentationsImpl(), index);
                  attr.setSpecified(false);
<span class="line-modified">!             }</span>
<span class="line-modified">!             else {</span>
                  // default attribute is in the tree
                  // we don&#39;t need to do anything since prefix was already fixed
                  // at the namespace fixup time and value must be same value, otherwise
                  // attribute will be treated as specified and we will never reach
                  // this method.
  
              }
              return index;
<span class="line-modified">!         }</span>
  
  
          public void removeAllAttributes(){
              // REVISIT: implement
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1521,74 ***</span>
          public int getIndex(String qName){
              // REVISIT: implement
              return -1;
          }
  
<span class="line-modified">!         public int getIndex(String uri, String localPart){</span>
              // REVISIT: implement
              return -1;
          }
  
<span class="line-modified">!         public void setName(int attrIndex, QName attrName){</span>
              // REVISIT: implement
          }
  
<span class="line-modified">!         public void getName(int attrIndex, QName attrName){</span>
<span class="line-modified">!             if (fAttributes !=null) {</span>
                  updateQName((Node)fAttributes.getItem(attrIndex), attrName);
              }
          }
  
<span class="line-modified">!         public String getPrefix(int index){</span>
<span class="line-modified">!             // REVISIT: implement</span>
              return null;
          }
  
<span class="line-modified">! </span>
<span class="line-modified">!         public String getURI(int index){</span>
<span class="line-modified">!             // REVISIT: implement</span>
              return null;
          }
  
  
<span class="line-modified">!         public String getLocalName(int index){</span>
<span class="line-modified">!             // REVISIT: implement</span>
              return null;
          }
  
<span class="line-modified">! </span>
<span class="line-modified">!         public String getQName(int index){</span>
<span class="line-modified">!             // REVISIT: implement</span>
              return null;
          }
  
           public QName getQualifiedName(int index){
              //return fAttributes.item(index).ge);
              return null;
          }
  
<span class="line-modified">!         public void setType(int attrIndex, String attrType){</span>
<span class="line-modified">!             // REVISIT: implement</span>
          }
  
<span class="line-modified">! </span>
<span class="line-modified">!         public String getType(int index){</span>
<span class="line-modified">!             return &quot;CDATA&quot;;</span>
          }
  
<span class="line-modified">! </span>
<span class="line-removed">-         public String getType(String qName){</span>
              return &quot;CDATA&quot;;
          }
  
<span class="line-modified">! </span>
<span class="line-removed">-         public String getType(String uri, String localName){</span>
              return &quot;CDATA&quot;;
          }
  
  
<span class="line-modified">!         public void setValue(int attrIndex, String attrValue){</span>
              // REVISIT: is this desired behaviour?
              // The values are updated in the case datatype-normalization is turned on
              // in this case we need to make sure that specified attributes stay specified
  
              if (fAttributes != null){
<span class="line-new-header">--- 1530,95 ---</span>
          public int getIndex(String qName){
              // REVISIT: implement
              return -1;
          }
  
<span class="line-modified">!         public int getIndex(String uri, String localPart) {</span>
              // REVISIT: implement
              return -1;
          }
  
<span class="line-modified">!         public void setName(int attrIndex, QName attrName) {</span>
              // REVISIT: implement
          }
  
<span class="line-modified">!         public void getName(int attrIndex, QName attrName) {</span>
<span class="line-modified">!             if (fAttributes != null) {</span>
                  updateQName((Node)fAttributes.getItem(attrIndex), attrName);
              }
          }
  
<span class="line-modified">!         public String getPrefix(int index) {</span>
<span class="line-modified">!             if (fAttributes != null) {</span>
<span class="line-added">+                 Node node = (Node) fAttributes.getItem(index);</span>
<span class="line-added">+                 String prefix = node.getPrefix();</span>
<span class="line-added">+                 prefix = (prefix != null &amp;&amp; prefix.length() != 0) ? fSymbolTable.addSymbol(prefix) : null;</span>
<span class="line-added">+                 return prefix;</span>
<span class="line-added">+             }</span>
              return null;
          }
  
<span class="line-modified">!         public String getURI(int index) {</span>
<span class="line-modified">!             if (fAttributes != null) {</span>
<span class="line-modified">!                 Node node = (Node) fAttributes.getItem(index);</span>
<span class="line-added">+                 String namespace = node.getNamespaceURI();</span>
<span class="line-added">+                 namespace = (namespace != null) ? fSymbolTable.addSymbol(namespace) : null;</span>
<span class="line-added">+                 return namespace;</span>
<span class="line-added">+             }</span>
              return null;
          }
  
  
<span class="line-modified">!         public String getLocalName(int index) {</span>
<span class="line-modified">!             if (fAttributes != null) {</span>
<span class="line-added">+                 Node node = (Node) fAttributes.getItem(index);</span>
<span class="line-added">+                 String localName = node.getLocalName();</span>
<span class="line-added">+                 localName = (localName != null) ? fSymbolTable.addSymbol(localName) : null;</span>
<span class="line-added">+                 return localName;</span>
<span class="line-added">+             }</span>
              return null;
          }
  
<span class="line-modified">!         public String getQName(int index) {</span>
<span class="line-modified">!             if (fAttributes != null) {</span>
<span class="line-modified">!                 Node node = (Node) fAttributes.getItem(index);</span>
<span class="line-added">+                 String rawname = fSymbolTable.addSymbol(node.getNodeName());</span>
<span class="line-added">+                 return rawname;</span>
<span class="line-added">+             }</span>
              return null;
          }
  
           public QName getQualifiedName(int index){
              //return fAttributes.item(index).ge);
              return null;
          }
  
<span class="line-modified">!         public void setType(int attrIndex, String attrType) {</span>
<span class="line-modified">!             fDTDTypes.setElementAt(attrType, attrIndex);</span>
          }
  
<span class="line-modified">!         public String getType(int index) {</span>
<span class="line-modified">!             String type = fDTDTypes.elementAt(index);</span>
<span class="line-modified">!             return (type != null) ? getReportableType(type) : &quot;CDATA&quot;;</span>
          }
  
<span class="line-modified">!         public String getType(String qName) {</span>
              return &quot;CDATA&quot;;
          }
  
<span class="line-modified">!         public String getType(String uri, String localName) {</span>
              return &quot;CDATA&quot;;
          }
  
<span class="line-added">+         private String getReportableType(String type) {</span>
<span class="line-added">+             if (type.charAt(0) == &#39;(&#39;) {</span>
<span class="line-added">+                 return &quot;NMTOKEN&quot;;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return type;</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         public void setValue(int attrIndex, String attrValue) {</span>
              // REVISIT: is this desired behaviour?
              // The values are updated in the case datatype-normalization is turned on
              // in this case we need to make sure that specified attributes stay specified
  
              if (fAttributes != null){
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1607,38 ***</span>
          public String getValue(int index){
              return (fAttributes !=null)?fAttributes.item(index).getNodeValue():&quot;&quot;;
  
          }
  
<span class="line-removed">- </span>
          public String getValue(String qName){
              // REVISIT: implement
              return null;
          }
  
<span class="line-removed">- </span>
          public String getValue(String uri, String localName){
              if (fAttributes != null) {
                  Node node =  fAttributes.getNamedItemNS(uri, localName);
                  return(node != null)? node.getNodeValue():null;
              }
              return null;
          }
  
<span class="line-removed">- </span>
          public void setNonNormalizedValue(int attrIndex, String attrValue){
              // REVISIT: implement
  
          }
  
<span class="line-removed">- </span>
          public String getNonNormalizedValue(int attrIndex){
              // REVISIT: implement
              return null;
          }
  
<span class="line-removed">- </span>
          public void setSpecified(int attrIndex, boolean specified){
              AttrImpl attr = (AttrImpl)fAttributes.getItem(attrIndex);
              attr.setSpecified(specified);
          }
  
<span class="line-new-header">--- 1637,33 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1786,62 ***</span>
       * @param augs       Additional information that may include infoset augmentations
       *
       * @exception XNIException
       *                   Thrown by handler to signal an error.
       */
<span class="line-modified">!         public void startElement(QName element, XMLAttributes attributes, Augmentations augs)</span>
<span class="line-modified">!                 throws XNIException {</span>
<span class="line-modified">!                 Element currentElement = (Element) fCurrentNode;</span>
<span class="line-modified">!                 int attrCount = attributes.getLength();</span>
          if (DEBUG_EVENTS) {
              System.out.println(&quot;==&gt;startElement: &quot; +element+
<span class="line-modified">!             &quot; attrs.length=&quot;+attrCount);</span>
          }
  
<span class="line-modified">!                 for (int i = 0; i &lt; attrCount; i++) {</span>
<span class="line-modified">!                         attributes.getName(i, fAttrQName);</span>
<span class="line-modified">!                         Attr attr = null;</span>
  
<span class="line-modified">!                         attr = currentElement.getAttributeNodeNS(fAttrQName.uri, fAttrQName.localpart);</span>
              AttributePSVI attrPSVI =
<span class="line-modified">!                                 (AttributePSVI) attributes.getAugmentations(i).getItem(Constants.ATTRIBUTE_PSVI);</span>
  
<span class="line-modified">!                         if (attrPSVI != null) {</span>
                  //REVISIT: instead we should be using augmentations:
                  // to set/retrieve Id attributes
                  XSTypeDefinition decl = attrPSVI.getMemberTypeDefinition();
                  boolean id = false;
<span class="line-modified">!                 if (decl != null){</span>
                      id = ((XSSimpleType)decl).isIDType();
<span class="line-modified">!                 } else{</span>
                      decl = attrPSVI.getTypeDefinition();
<span class="line-modified">!                     if (decl !=null){</span>
<span class="line-modified">!                        id = ((XSSimpleType)decl).isIDType();</span>
                      }
                  }
<span class="line-modified">!                 if (id){</span>
                      ((ElementImpl)currentElement).setIdAttributeNode(attr, true);
                  }
  
<span class="line-modified">!                                 if (fPSVI) {</span>
<span class="line-modified">!                                         ((PSVIAttrNSImpl) attr).setPSVI(attrPSVI);</span>
<span class="line-modified">!                                 }</span>
<span class="line-modified">!                                 if ((fConfiguration.features &amp; DOMConfigurationImpl.DTNORMALIZATION) != 0) {</span>
<span class="line-modified">!                                         // datatype-normalization</span>
<span class="line-modified">!                                         // NOTE: The specified value MUST be set after we set</span>
<span class="line-modified">!                                         //       the node value because that turns the &quot;specified&quot;</span>
<span class="line-modified">!                                         //       flag to &quot;true&quot; which may overwrite a &quot;false&quot;</span>
<span class="line-modified">!                                         //       value from the attribute list.</span>
<span class="line-modified">!                                         boolean specified = attr.getSpecified();</span>
<span class="line-modified">!                                         attr.setValue(attrPSVI.getSchemaValue().getNormalizedValue());</span>
<span class="line-modified">!                                         if (!specified) {</span>
<span class="line-modified">!                                                 ((AttrImpl) attr).setSpecified(specified);</span>
<span class="line-modified">!                                         }</span>
<span class="line-modified">!                                 }</span>
                          }
                  }
          }
  
  
      /**
       * An empty element.
       *
<span class="line-new-header">--- 1811,89 ---</span>
       * @param augs       Additional information that may include infoset augmentations
       *
       * @exception XNIException
       *                   Thrown by handler to signal an error.
       */
<span class="line-modified">!     public void startElement(QName element, XMLAttributes attributes, Augmentations augs)</span>
<span class="line-modified">!         throws XNIException {</span>
<span class="line-modified">!         Element currentElement = (Element) fCurrentNode;</span>
<span class="line-modified">!         int attrCount = attributes.getLength();</span>
          if (DEBUG_EVENTS) {
              System.out.println(&quot;==&gt;startElement: &quot; +element+
<span class="line-modified">!                     &quot; attrs.length=&quot;+attrCount);</span>
          }
  
<span class="line-modified">!         for (int i = 0; i &lt; attrCount; i++) {</span>
<span class="line-modified">!             attributes.getName(i, fAttrQName);</span>
<span class="line-modified">!             Attr attr = null;</span>
  
<span class="line-modified">!             attr = currentElement.getAttributeNodeNS(fAttrQName.uri, fAttrQName.localpart);</span>
<span class="line-added">+             if (attr == null) {</span>
<span class="line-added">+                 // Must be a non-namespace aware DOM Level 1 node.</span>
<span class="line-added">+                 attr = currentElement.getAttributeNode(fAttrQName.rawname);</span>
<span class="line-added">+             }</span>
              AttributePSVI attrPSVI =
<span class="line-modified">!                 (AttributePSVI) attributes.getAugmentations(i).getItem(Constants.ATTRIBUTE_PSVI);</span>
  
<span class="line-modified">!             if (attrPSVI != null) {</span>
                  //REVISIT: instead we should be using augmentations:
                  // to set/retrieve Id attributes
                  XSTypeDefinition decl = attrPSVI.getMemberTypeDefinition();
                  boolean id = false;
<span class="line-modified">!                 if (decl != null) {</span>
                      id = ((XSSimpleType)decl).isIDType();
<span class="line-modified">!                 }</span>
<span class="line-added">+                 else {</span>
                      decl = attrPSVI.getTypeDefinition();
<span class="line-modified">!                     if (decl != null) {</span>
<span class="line-modified">!                         id = ((XSSimpleType)decl).isIDType();</span>
                      }
                  }
<span class="line-modified">!                 if (id) {</span>
                      ((ElementImpl)currentElement).setIdAttributeNode(attr, true);
                  }
  
<span class="line-modified">!                 if (fPSVI) {</span>
<span class="line-modified">!                     ((PSVIAttrNSImpl) attr).setPSVI(attrPSVI);</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 // Updating the TypeInfo for this attribute.</span>
<span class="line-modified">!                 ((AttrImpl) attr).setType(decl);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 if ((fConfiguration.features &amp; DOMConfigurationImpl.DTNORMALIZATION) != 0) {</span>
<span class="line-modified">!                     // datatype-normalization</span>
<span class="line-modified">!                     // NOTE: The specified value MUST be set after we set</span>
<span class="line-modified">!                     //       the node value because that turns the &quot;specified&quot;</span>
<span class="line-modified">!                     //       flag to &quot;true&quot; which may overwrite a &quot;false&quot;</span>
<span class="line-modified">!                     //       value from the attribute list.</span>
<span class="line-modified">!                     final String normalizedValue = attrPSVI.getSchemaValue().getNormalizedValue();</span>
<span class="line-modified">!                     if (normalizedValue != null) {</span>
<span class="line-added">+                         boolean specified = attr.getSpecified();</span>
<span class="line-added">+                         attr.setValue(normalizedValue);</span>
<span class="line-added">+                         if (!specified) {</span>
<span class="line-added">+                             ((AttrImpl) attr).setSpecified(specified);</span>
                          }
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+             else { // DTD</span>
<span class="line-added">+                 String type = null;</span>
<span class="line-added">+                 boolean isDeclared = Boolean.TRUE.equals(attributes.getAugmentations(i).getItem (Constants.ATTRIBUTE_DECLARED));</span>
<span class="line-added">+                 // For DOM Level 3 TypeInfo, the type name must</span>
<span class="line-added">+                 // be null if this attribute has not been declared</span>
<span class="line-added">+                 // in the DTD.</span>
<span class="line-added">+                 if (isDeclared) {</span>
<span class="line-added">+                     type = attributes.getType(i);</span>
<span class="line-added">+                     if (&quot;ID&quot;.equals (type)) {</span>
<span class="line-added">+                         ((ElementImpl) currentElement).setIdAttributeNode(attr, true);</span>
<span class="line-added">+                     }</span>
                  }
<span class="line-added">+                 // Updating the TypeInfo for this attribute.</span>
<span class="line-added">+                 ((AttrImpl) attr).setType(type);</span>
<span class="line-added">+             }</span>
          }
<span class="line-added">+     }</span>
  
  
      /**
       * An empty element.
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1946,11 ***</span>
       *
       * @exception XNIException
       *                   Thrown by handler to signal an error.
       */
      public void ignorableWhitespace(XMLString text, Augmentations augs) throws XNIException{
<span class="line-modified">!         allWhitespace = true;</span>
      }
  
      /**
       * The end of an element.
       *
<span class="line-new-header">--- 1998,11 ---</span>
       *
       * @exception XNIException
       *                   Thrown by handler to signal an error.
       */
      public void ignorableWhitespace(XMLString text, Augmentations augs) throws XNIException{
<span class="line-modified">!         fAllWhitespace = true;</span>
      }
  
      /**
       * The end of an element.
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1958,42 ***</span>
       * @param augs    Additional information that may include infoset augmentations
       *
       * @exception XNIException
       *                   Thrown by handler to signal an error.
       */
<span class="line-modified">!         public void endElement(QName element, Augmentations augs) throws XNIException {</span>
<span class="line-modified">!                 if (DEBUG_EVENTS) {</span>
<span class="line-modified">!                         System.out.println(&quot;==&gt;endElement: &quot; + element);</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!         if(augs != null) {</span>
<span class="line-modified">!                 ElementPSVI elementPSVI = (ElementPSVI) augs.getItem(Constants.ELEMENT_PSVI);</span>
<span class="line-modified">!                 if (elementPSVI != null) {</span>
<span class="line-modified">!                         ElementImpl elementNode = (ElementImpl) fCurrentNode;</span>
<span class="line-modified">!                         if (fPSVI) {</span>
<span class="line-modified">!                                 ((PSVIElementNSImpl) fCurrentNode).setPSVI(elementPSVI);</span>
<span class="line-modified">!                         }</span>
<span class="line-modified">!                         // include element default content (if one is available)</span>
<span class="line-modified">!                         String normalizedValue = elementPSVI.getSchemaValue().getNormalizedValue();</span>
<span class="line-modified">!                         if ((fConfiguration.features &amp; DOMConfigurationImpl.DTNORMALIZATION) != 0) {</span>
                      if (normalizedValue !=null)
<span class="line-modified">!                                     elementNode.setTextContent(normalizedValue);</span>
<span class="line-modified">!                         }</span>
<span class="line-modified">!                         else {</span>
<span class="line-modified">!                                 // NOTE: this is a hack: it is possible that DOM had an empty element</span>
<span class="line-modified">!                                 // and validator sent default value using characters(), which we don&#39;t</span>
<span class="line-modified">!                                 // implement. Thus, here we attempt to add the default value.</span>
<span class="line-modified">!                                 String text = elementNode.getTextContent();</span>
<span class="line-modified">!                                 if (text.length() == 0) {</span>
<span class="line-modified">!                                         // default content could be provided</span>
                          if (normalizedValue !=null)
                              elementNode.setTextContent(normalizedValue);
<span class="line-modified">!                                 }</span>
<span class="line-removed">-                         }</span>
                  }
          }
          }
  
  
      /**
       * The start of a CDATA section.
       *
<span class="line-new-header">--- 2010,55 ---</span>
       * @param augs    Additional information that may include infoset augmentations
       *
       * @exception XNIException
       *                   Thrown by handler to signal an error.
       */
<span class="line-modified">!     public void endElement(QName element, Augmentations augs) throws XNIException {</span>
<span class="line-modified">!         if (DEBUG_EVENTS) {</span>
<span class="line-modified">!             System.out.println(&quot;==&gt;endElement: &quot; + element);</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!         if (augs != null) {</span>
<span class="line-modified">!             ElementPSVI elementPSVI = (ElementPSVI) augs.getItem(Constants.ELEMENT_PSVI);</span>
<span class="line-modified">!             if (elementPSVI != null) {</span>
<span class="line-modified">!                 ElementImpl elementNode = (ElementImpl) fCurrentNode;</span>
<span class="line-modified">!                 if (fPSVI) {</span>
<span class="line-modified">!                     ((PSVIElementNSImpl) fCurrentNode).setPSVI(elementPSVI);</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 // Updating the TypeInfo for this element.</span>
<span class="line-modified">!                 if (elementNode instanceof ElementNSImpl) {</span>
<span class="line-modified">!                     XSTypeDefinition type = elementPSVI.getMemberTypeDefinition();</span>
<span class="line-added">+                     if (type == null) {</span>
<span class="line-added">+                         type = elementPSVI.getTypeDefinition();</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     ((ElementNSImpl) elementNode).setType(type);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 // include element default content (if one is available)</span>
<span class="line-added">+                 String normalizedValue = elementPSVI.getSchemaValue().getNormalizedValue();</span>
<span class="line-added">+                 if ((fConfiguration.features &amp; DOMConfigurationImpl.DTNORMALIZATION) != 0) {</span>
                      if (normalizedValue !=null)
<span class="line-modified">!                         elementNode.setTextContent(normalizedValue);</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 else {</span>
<span class="line-modified">!                     // NOTE: this is a hack: it is possible that DOM had an empty element</span>
<span class="line-modified">!                     // and validator sent default value using characters(), which we don&#39;t</span>
<span class="line-modified">!                     // implement. Thus, here we attempt to add the default value.</span>
<span class="line-modified">!                     String text = elementNode.getTextContent();</span>
<span class="line-modified">!                     if (text.length() == 0) {</span>
<span class="line-modified">!                         // default content could be provided</span>
                          if (normalizedValue !=null)
                              elementNode.setTextContent(normalizedValue);
<span class="line-modified">!                     }</span>
                  }
<span class="line-added">+                 return;</span>
<span class="line-added">+             }</span>
          }
<span class="line-added">+         // DTD; elements have no type.</span>
<span class="line-added">+         if (fCurrentNode instanceof ElementNSImpl) {</span>
<span class="line-added">+             ((ElementNSImpl) fCurrentNode).setType(null);</span>
          }
<span class="line-added">+     }</span>
  
  
      /**
       * The start of a CDATA section.
       *
</pre>
<center><a href="DOMConfigurationImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="DeferredDocumentImpl.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>