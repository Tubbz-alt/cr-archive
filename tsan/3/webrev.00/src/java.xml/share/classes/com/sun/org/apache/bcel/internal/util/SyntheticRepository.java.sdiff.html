<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.xml/share/classes/com/sun/org/apache/bcel/internal/util/SyntheticRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Repository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../xalan/internal/xsltc/compiler/Parser.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml/share/classes/com/sun/org/apache/bcel/internal/util/SyntheticRepository.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 /*
  5  * Licensed to the Apache Software Foundation (ASF) under one or more
  6  * contributor license agreements.  See the NOTICE file distributed with
  7  * this work for additional information regarding copyright ownership.
  8  * The ASF licenses this file to You under the Apache License, Version 2.0
  9  * (the &quot;License&quot;); you may not use this file except in compliance with
 10  * the License.  You may obtain a copy of the License at
 11  *
 12  *      http://www.apache.org/licenses/LICENSE-2.0
 13  *
 14  * Unless required by applicable law or agreed to in writing, software
 15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 17  * See the License for the specific language governing permissions and
 18  * limitations under the License.
 19  */
 20 package com.sun.org.apache.bcel.internal.util;
 21 
 22 import java.io.IOException;
 23 import java.io.InputStream;
 24 
 25 import com.sun.org.apache.bcel.internal.classfile.ClassParser;
 26 import com.sun.org.apache.bcel.internal.classfile.JavaClass;
 27 import java.lang.ref.SoftReference;
 28 import java.util.HashMap;
 29 import java.util.Map;
 30 
 31 /**
 32  * This repository is used in situations where a Class is created outside the
 33  * realm of a ClassLoader. Classes are loaded from the file systems using the
 34  * paths specified in the given class path. By default, this is the value
 35  * returned by ClassPath.getClassPath(). &lt;br&gt;
 36  * This repository uses a factory design, allowing it to maintain a collection
 37  * of different classpaths, and as such It is designed to be used as a singleton
 38  * per classpath.
 39  *
 40  * @see com.sun.org.apache.bcel.internal.Repository
 41  *
<span class="line-modified"> 42  * @version $Id: SyntheticRepository.java 1748124 2016-06-13 08:02:16Z ggregory</span>
<span class="line-removed"> 43  * $</span>
 44  */
 45 public class SyntheticRepository implements Repository {
 46 
 47     // CLASSNAME X JAVACLASS
 48     private final Map&lt;String, SoftReference&lt;JavaClass&gt;&gt; loadedClasses = new HashMap&lt;&gt;();
 49 
 50     private SyntheticRepository() {
 51     }
 52 
 53     public static SyntheticRepository getInstance() {
 54         return new SyntheticRepository();
 55     }
 56 
 57     /**
 58      * Store a new JavaClass instance into this Repository.
 59      */
 60     @Override
 61     public void storeClass(final JavaClass clazz) {
 62         loadedClasses.put(clazz.getClassName(), new SoftReference&lt;&gt;(clazz));
 63         clazz.setRepository(this);
</pre>
<hr />
<pre>
 78     public JavaClass findClass(final String className) {
 79         final SoftReference&lt;JavaClass&gt; ref = loadedClasses.get(className);
 80         if (ref == null) {
 81             return null;
 82         }
 83         return ref.get();
 84     }
 85 
 86     /**
 87      * Finds a JavaClass object by name. If it is already in this Repository, the
 88      * Repository version is returned.
 89      *
 90      * @param className the name of the class
 91      * @return the JavaClass object
 92      * @throws ClassNotFoundException if the class is not in the Repository
 93      */
 94     @Override
 95     public JavaClass loadClass(String className) throws ClassNotFoundException {
 96         if ((className == null) || className.isEmpty()) {
 97             throw new IllegalArgumentException(&quot;Invalid class name &quot; + className);
<span class="line-modified"> 98         }</span>
 99         className = className.replace(&#39;/&#39;, &#39;.&#39;); // Just in case, canonical form
100         final JavaClass clazz = findClass(className);
101         if (clazz != null) {
102             return clazz;
103         }
104 
105         IOException e = new IOException(&quot;Couldn&#39;t find: &quot; + className + &quot;.class&quot;);
106         throw new ClassNotFoundException(&quot;Exception while looking for class &quot; +
107                 className + &quot;: &quot; + e, e);
108     }
109 
110     /**
111      * Find the JavaClass object for a runtime Class object. If a class with the
112      * same name is already in this Repository, the Repository version is
113      * returned. Otherwise, getResourceAsStream() is called on the Class object
114      * to find the class&#39;s representation. If the representation is found, it is
115      * added to the Repository.
116      *
117      * @see Class
118      * @param clazz the runtime Class object
119      * @return JavaClass object for given runtime class
120      * @throws ClassNotFoundException if the class is not in the Repository, and
121      * its representation could not be found
122      */
123     @Override
124     public JavaClass loadClass(final Class&lt;?&gt; clazz) throws ClassNotFoundException {
125         final String className = clazz.getName();
126         final JavaClass repositoryClass = findClass(className);
127         if (repositoryClass != null) {
128             return repositoryClass;
<span class="line-modified">129         }</span>
130         String name = className;
131         final int i = name.lastIndexOf(&#39;.&#39;);
132         if (i &gt; 0) {
133             name = name.substring(i + 1);
134         }
135         JavaClass cls = null;
136         try (InputStream clsStream = clazz.getResourceAsStream(name + &quot;.class&quot;)) {
137             return cls = loadClass(clsStream, className);
138         } catch (final IOException e) {
139             return cls;
140         }
141 
142     }
143 
144 
145     private JavaClass loadClass(final InputStream is, final String className)
146             throws ClassNotFoundException {
147         try {
148             if (is != null) {
149                 final ClassParser parser = new ClassParser(is, className);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 /*
  5  * Licensed to the Apache Software Foundation (ASF) under one or more
  6  * contributor license agreements.  See the NOTICE file distributed with
  7  * this work for additional information regarding copyright ownership.
  8  * The ASF licenses this file to You under the Apache License, Version 2.0
  9  * (the &quot;License&quot;); you may not use this file except in compliance with
 10  * the License.  You may obtain a copy of the License at
 11  *
 12  *      http://www.apache.org/licenses/LICENSE-2.0
 13  *
 14  * Unless required by applicable law or agreed to in writing, software
 15  * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 16  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 17  * See the License for the specific language governing permissions and
 18  * limitations under the License.
 19  */
 20 package com.sun.org.apache.bcel.internal.util;
 21 
 22 import java.io.IOException;
 23 import java.io.InputStream;
 24 
 25 import com.sun.org.apache.bcel.internal.classfile.ClassParser;
 26 import com.sun.org.apache.bcel.internal.classfile.JavaClass;
 27 import java.lang.ref.SoftReference;
 28 import java.util.HashMap;
 29 import java.util.Map;
 30 
 31 /**
 32  * This repository is used in situations where a Class is created outside the
 33  * realm of a ClassLoader. Classes are loaded from the file systems using the
 34  * paths specified in the given class path. By default, this is the value
 35  * returned by ClassPath.getClassPath(). &lt;br&gt;
 36  * This repository uses a factory design, allowing it to maintain a collection
 37  * of different classpaths, and as such It is designed to be used as a singleton
 38  * per classpath.
 39  *
 40  * @see com.sun.org.apache.bcel.internal.Repository
 41  *
<span class="line-modified"> 42  * @LastModified: Jan 2020</span>

 43  */
 44 public class SyntheticRepository implements Repository {
 45 
 46     // CLASSNAME X JAVACLASS
 47     private final Map&lt;String, SoftReference&lt;JavaClass&gt;&gt; loadedClasses = new HashMap&lt;&gt;();
 48 
 49     private SyntheticRepository() {
 50     }
 51 
 52     public static SyntheticRepository getInstance() {
 53         return new SyntheticRepository();
 54     }
 55 
 56     /**
 57      * Store a new JavaClass instance into this Repository.
 58      */
 59     @Override
 60     public void storeClass(final JavaClass clazz) {
 61         loadedClasses.put(clazz.getClassName(), new SoftReference&lt;&gt;(clazz));
 62         clazz.setRepository(this);
</pre>
<hr />
<pre>
 77     public JavaClass findClass(final String className) {
 78         final SoftReference&lt;JavaClass&gt; ref = loadedClasses.get(className);
 79         if (ref == null) {
 80             return null;
 81         }
 82         return ref.get();
 83     }
 84 
 85     /**
 86      * Finds a JavaClass object by name. If it is already in this Repository, the
 87      * Repository version is returned.
 88      *
 89      * @param className the name of the class
 90      * @return the JavaClass object
 91      * @throws ClassNotFoundException if the class is not in the Repository
 92      */
 93     @Override
 94     public JavaClass loadClass(String className) throws ClassNotFoundException {
 95         if ((className == null) || className.isEmpty()) {
 96             throw new IllegalArgumentException(&quot;Invalid class name &quot; + className);
<span class="line-modified"> 97     }</span>
 98         className = className.replace(&#39;/&#39;, &#39;.&#39;); // Just in case, canonical form
 99         final JavaClass clazz = findClass(className);
100         if (clazz != null) {
101             return clazz;
102         }
103 
104         IOException e = new IOException(&quot;Couldn&#39;t find: &quot; + className + &quot;.class&quot;);
105         throw new ClassNotFoundException(&quot;Exception while looking for class &quot; +
106                 className + &quot;: &quot; + e, e);
107     }
108 
109     /**
110      * Find the JavaClass object for a runtime Class object. If a class with the
111      * same name is already in this Repository, the Repository version is
112      * returned. Otherwise, getResourceAsStream() is called on the Class object
113      * to find the class&#39;s representation. If the representation is found, it is
114      * added to the Repository.
115      *
116      * @see Class
117      * @param clazz the runtime Class object
118      * @return JavaClass object for given runtime class
119      * @throws ClassNotFoundException if the class is not in the Repository, and
120      * its representation could not be found
121      */
122     @Override
123     public JavaClass loadClass(final Class&lt;?&gt; clazz) throws ClassNotFoundException {
124         final String className = clazz.getName();
125         final JavaClass repositoryClass = findClass(className);
126         if (repositoryClass != null) {
127             return repositoryClass;
<span class="line-modified">128     }</span>
129         String name = className;
130         final int i = name.lastIndexOf(&#39;.&#39;);
131         if (i &gt; 0) {
132             name = name.substring(i + 1);
133         }
134         JavaClass cls = null;
135         try (InputStream clsStream = clazz.getResourceAsStream(name + &quot;.class&quot;)) {
136             return cls = loadClass(clsStream, className);
137         } catch (final IOException e) {
138             return cls;
139         }
140 
141     }
142 
143 
144     private JavaClass loadClass(final InputStream is, final String className)
145             throws ClassNotFoundException {
146         try {
147             if (is != null) {
148                 final ClassParser parser = new ClassParser(is, className);
</pre>
</td>
</tr>
</table>
<center><a href="Repository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../xalan/internal/xsltc/compiler/Parser.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>