<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jfr/share/classes/jdk/jfr/internal/EventInstrumentation.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="EventControl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="EventWriter.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/EventInstrumentation.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -361,78 +361,76 @@</span>
              methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);
              methodVisitor.visitInsn(Opcodes.RETURN);
              methodVisitor.visitMaxs(0, 0);
          });
  
<span class="udiff-line-removed">-         // MyEvent#commit() - Java event writer</span>
          updateMethod(METHOD_COMMIT, methodVisitor -&gt; {
<span class="udiff-line-modified-removed">-                 // if (!isEnable()) {</span>
<span class="udiff-line-modified-removed">-                 // return;</span>
<span class="udiff-line-modified-removed">-                 // }</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitCode();</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), METHOD_IS_ENABLED.getName(), METHOD_IS_ENABLED.getDescriptor(), false);</span>
<span class="udiff-line-modified-removed">-                 Label l0 = new Label();</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitJumpInsn(Opcodes.IFNE, l0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitInsn(Opcodes.RETURN);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitLabel(l0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="udiff-line-modified-removed">-                 // if (startTime == 0) {</span>
<span class="udiff-line-modified-removed">-                 // startTime = EventWriter.timestamp();</span>
<span class="udiff-line-modified-removed">-                 // } else {</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitInsn(Opcodes.LCONST_0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitInsn(Opcodes.LCMP);</span>
<span class="udiff-line-modified-removed">-                 Label durationalEvent = new Label();</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitJumpInsn(Opcodes.IFNE, durationalEvent);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitMethodInsn(Opcodes.INVOKESTATIC, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP.getName(),</span>
<span class="udiff-line-modified-removed">-                         METHOD_TIME_STAMP.getDescriptor(), false);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="udiff-line-modified-removed">-                 Label commit = new Label();</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitJumpInsn(Opcodes.GOTO, commit);</span>
<span class="udiff-line-modified-removed">-                 // if (duration == 0) {</span>
<span class="udiff-line-modified-removed">-                 // duration = EventWriter.timestamp() - startTime;</span>
<span class="udiff-line-modified-removed">-                 // }</span>
<span class="udiff-line-modified-removed">-                 // }</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitLabel(durationalEvent);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitInsn(Opcodes.LCONST_0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitInsn(Opcodes.LCMP);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitJumpInsn(Opcodes.IFNE, commit);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitMethodInsn(Opcodes.INVOKESTATIC, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP.getName(), METHOD_TIME_STAMP.getDescriptor(), false);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitInsn(Opcodes.LSUB);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitLabel(commit);</span>
<span class="udiff-line-modified-removed">-                 // if (shouldCommit()) {</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), METHOD_EVENT_SHOULD_COMMIT.getName(), METHOD_EVENT_SHOULD_COMMIT.getDescriptor(), false);</span>
<span class="udiff-line-modified-removed">-                 Label end = new Label();</span>
<span class="udiff-line-modified-removed">-                 // eventHandler.write(...);</span>
<span class="udiff-line-modified-removed">-                 // }</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitJumpInsn(Opcodes.IFEQ, end);</span>
<span class="udiff-line-removed">-                 getEventHandler(methodVisitor);</span>
<span class="udiff-line-modified-added">+             // if (!isEnable()) {</span>
<span class="udiff-line-modified-added">+             // return;</span>
<span class="udiff-line-modified-added">+             // }</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitCode();</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), METHOD_IS_ENABLED.getName(), METHOD_IS_ENABLED.getDescriptor(), false);</span>
<span class="udiff-line-modified-added">+             Label l0 = new Label();</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitJumpInsn(Opcodes.IFNE, l0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitInsn(Opcodes.RETURN);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitLabel(l0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="udiff-line-modified-added">+             // if (startTime == 0) {</span>
<span class="udiff-line-modified-added">+             // startTime = EventWriter.timestamp();</span>
<span class="udiff-line-modified-added">+             // } else {</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitInsn(Opcodes.LCONST_0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitInsn(Opcodes.LCMP);</span>
<span class="udiff-line-modified-added">+             Label durationalEvent = new Label();</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitJumpInsn(Opcodes.IFNE, durationalEvent);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitMethodInsn(Opcodes.INVOKESTATIC, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP.getName(), METHOD_TIME_STAMP.getDescriptor(), false);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="udiff-line-modified-added">+             Label commit = new Label();</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitJumpInsn(Opcodes.GOTO, commit);</span>
<span class="udiff-line-modified-added">+             // if (duration == 0) {</span>
<span class="udiff-line-modified-added">+             // duration = EventWriter.timestamp() - startTime;</span>
<span class="udiff-line-modified-added">+             // }</span>
<span class="udiff-line-modified-added">+             // }</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitLabel(durationalEvent);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitInsn(Opcodes.LCONST_0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitInsn(Opcodes.LCMP);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitJumpInsn(Opcodes.IFNE, commit);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitMethodInsn(Opcodes.INVOKESTATIC, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP.getName(), METHOD_TIME_STAMP.getDescriptor(), false);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitInsn(Opcodes.LSUB);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitLabel(commit);</span>
<span class="udiff-line-modified-added">+             // if (shouldCommit()) {</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), METHOD_EVENT_SHOULD_COMMIT.getName(), METHOD_EVENT_SHOULD_COMMIT.getDescriptor(), false);</span>
<span class="udiff-line-modified-added">+             Label end = new Label();</span>
<span class="udiff-line-modified-added">+             // eventHandler.write(...);</span>
<span class="udiff-line-modified-added">+             // }</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitJumpInsn(Opcodes.IFEQ, end);</span>
<span class="udiff-line-modified-added">+             getEventHandler(methodVisitor);</span>
  
<span class="udiff-line-modified-removed">-                 methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, eventHandlerXInternalName);</span>
<span class="udiff-line-modified-removed">-                 for (FieldInfo fi : fieldInfos) {</span>
<span class="udiff-line-modified-removed">-                     methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-removed">-                     methodVisitor.visitFieldInsn(Opcodes.GETFIELD, fi.internalClassName, fi.fieldName, fi.fieldDescriptor);</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, eventHandlerXInternalName);</span>
<span class="udiff-line-modified-added">+             for (FieldInfo fi : fieldInfos) {</span>
<span class="udiff-line-modified-added">+                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="udiff-line-modified-added">+                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, fi.internalClassName, fi.fieldName, fi.fieldDescriptor);</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-                 methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, eventHandlerXInternalName, writeMethod.getName(), writeMethod.getDescriptor(), false);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitLabel(end);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitInsn(Opcodes.RETURN);</span>
<span class="udiff-line-modified-removed">-                 methodVisitor.visitEnd();</span>
<span class="udiff-line-modified-removed">-             });</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, eventHandlerXInternalName, writeMethod.getName(), writeMethod.getDescriptor(), false);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitLabel(end);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitInsn(Opcodes.RETURN);</span>
<span class="udiff-line-modified-added">+             methodVisitor.visitEnd();</span>
<span class="udiff-line-modified-added">+         });</span>
  
          // MyEvent#shouldCommit()
          updateMethod(METHOD_EVENT_SHOULD_COMMIT, methodVisitor -&gt; {
              Label fail = new Label();
              if (guardHandlerReference) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -467,10 +465,11 @@</span>
              methodVisitor.visitInsn(Opcodes.ICONST_0);
              methodVisitor.visitInsn(Opcodes.IRETURN);
          });
      }
  
<span class="udiff-line-added">+ </span>
      private void getEventHandler(MethodVisitor methodVisitor) {
          if (untypedEventHandler) {
              methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, getInternalClassName(), FIELD_EVENT_HANDLER, TYPE_OBJECT.getDescriptor());
              methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, TYPE_EVENT_HANDLER.getInternalName());
          } else {
</pre>
<center><a href="EventControl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="EventWriter.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>