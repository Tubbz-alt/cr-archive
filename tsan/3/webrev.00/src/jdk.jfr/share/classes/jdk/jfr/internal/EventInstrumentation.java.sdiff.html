<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.jfr/share/classes/jdk/jfr/internal/EventInstrumentation.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="EventControl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="EventWriter.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/EventInstrumentation.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
346 
347         // MyEvent#begin()
348         updateMethod(METHOD_BEGIN, methodVisitor -&gt; {
349             methodVisitor.visitIntInsn(Opcodes.ALOAD, 0);
350             ASMToolkit.invokeStatic(methodVisitor, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP);
351             methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);
352             methodVisitor.visitInsn(Opcodes.RETURN);
353         });
354 
355         // MyEvent#end()
356         updateMethod(METHOD_END, methodVisitor -&gt; {
357             methodVisitor.visitIntInsn(Opcodes.ALOAD, 0);
358             methodVisitor.visitIntInsn(Opcodes.ALOAD, 0);
359             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);
360             ASMToolkit.invokeStatic(methodVisitor, TYPE_EVENT_HANDLER.getInternalName(), METHOD_DURATION);
361             methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);
362             methodVisitor.visitInsn(Opcodes.RETURN);
363             methodVisitor.visitMaxs(0, 0);
364         });
365 
<span class="line-removed">366         // MyEvent#commit() - Java event writer</span>
367         updateMethod(METHOD_COMMIT, methodVisitor -&gt; {
<span class="line-modified">368                 // if (!isEnable()) {</span>
<span class="line-modified">369                 // return;</span>
<span class="line-modified">370                 // }</span>
<span class="line-modified">371                 methodVisitor.visitCode();</span>
<span class="line-modified">372                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">373                 methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), METHOD_IS_ENABLED.getName(), METHOD_IS_ENABLED.getDescriptor(), false);</span>
<span class="line-modified">374                 Label l0 = new Label();</span>
<span class="line-modified">375                 methodVisitor.visitJumpInsn(Opcodes.IFNE, l0);</span>
<span class="line-modified">376                 methodVisitor.visitInsn(Opcodes.RETURN);</span>
<span class="line-modified">377                 methodVisitor.visitLabel(l0);</span>
<span class="line-modified">378                 methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="line-modified">379                 // if (startTime == 0) {</span>
<span class="line-modified">380                 // startTime = EventWriter.timestamp();</span>
<span class="line-modified">381                 // } else {</span>
<span class="line-modified">382                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">383                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="line-modified">384                 methodVisitor.visitInsn(Opcodes.LCONST_0);</span>
<span class="line-modified">385                 methodVisitor.visitInsn(Opcodes.LCMP);</span>
<span class="line-modified">386                 Label durationalEvent = new Label();</span>
<span class="line-modified">387                 methodVisitor.visitJumpInsn(Opcodes.IFNE, durationalEvent);</span>
<span class="line-modified">388                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">389                 methodVisitor.visitMethodInsn(Opcodes.INVOKESTATIC, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP.getName(),</span>
<span class="line-modified">390                         METHOD_TIME_STAMP.getDescriptor(), false);</span>
<span class="line-modified">391                 methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="line-modified">392                 Label commit = new Label();</span>
<span class="line-modified">393                 methodVisitor.visitJumpInsn(Opcodes.GOTO, commit);</span>
<span class="line-modified">394                 // if (duration == 0) {</span>
<span class="line-modified">395                 // duration = EventWriter.timestamp() - startTime;</span>
<span class="line-modified">396                 // }</span>
<span class="line-modified">397                 // }</span>
<span class="line-modified">398                 methodVisitor.visitLabel(durationalEvent);</span>
<span class="line-modified">399                 methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="line-modified">400                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">401                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);</span>
<span class="line-modified">402                 methodVisitor.visitInsn(Opcodes.LCONST_0);</span>
<span class="line-modified">403                 methodVisitor.visitInsn(Opcodes.LCMP);</span>
<span class="line-modified">404                 methodVisitor.visitJumpInsn(Opcodes.IFNE, commit);</span>
<span class="line-modified">405                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">406                 methodVisitor.visitMethodInsn(Opcodes.INVOKESTATIC, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP.getName(), METHOD_TIME_STAMP.getDescriptor(), false);</span>
<span class="line-modified">407                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">408                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="line-modified">409                 methodVisitor.visitInsn(Opcodes.LSUB);</span>
<span class="line-modified">410                 methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);</span>
<span class="line-modified">411                 methodVisitor.visitLabel(commit);</span>
<span class="line-modified">412                 // if (shouldCommit()) {</span>
<span class="line-modified">413                 methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="line-modified">414                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">415                 methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), METHOD_EVENT_SHOULD_COMMIT.getName(), METHOD_EVENT_SHOULD_COMMIT.getDescriptor(), false);</span>
<span class="line-modified">416                 Label end = new Label();</span>
<span class="line-modified">417                 // eventHandler.write(...);</span>
<span class="line-modified">418                 // }</span>
<span class="line-modified">419                 methodVisitor.visitJumpInsn(Opcodes.IFEQ, end);</span>
<span class="line-removed">420                 getEventHandler(methodVisitor);</span>
421 
<span class="line-modified">422                 methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, eventHandlerXInternalName);</span>
<span class="line-modified">423                 for (FieldInfo fi : fieldInfos) {</span>
<span class="line-modified">424                     methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">425                     methodVisitor.visitFieldInsn(Opcodes.GETFIELD, fi.internalClassName, fi.fieldName, fi.fieldDescriptor);</span>
<span class="line-modified">426                 }</span>
427 
<span class="line-modified">428                 methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, eventHandlerXInternalName, writeMethod.getName(), writeMethod.getDescriptor(), false);</span>
<span class="line-modified">429                 methodVisitor.visitLabel(end);</span>
<span class="line-modified">430                 methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="line-modified">431                 methodVisitor.visitInsn(Opcodes.RETURN);</span>
<span class="line-modified">432                 methodVisitor.visitEnd();</span>
<span class="line-modified">433             });</span>
434 
435         // MyEvent#shouldCommit()
436         updateMethod(METHOD_EVENT_SHOULD_COMMIT, methodVisitor -&gt; {
437             Label fail = new Label();
438             if (guardHandlerReference) {
439                 getEventHandler(methodVisitor);
440                 methodVisitor.visitJumpInsn(Opcodes.IFNULL, fail);
441             }
442             // if (!eventHandler.shouldCommit(duration) goto fail;
443             getEventHandler(methodVisitor);
444             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);
445             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);
446             ASMToolkit.invokeVirtual(methodVisitor, TYPE_EVENT_HANDLER.getInternalName(), METHOD_EVENT_HANDLER_SHOULD_COMMIT);
447             methodVisitor.visitJumpInsn(Opcodes.IFEQ, fail);
448             for (SettingInfo si : settingInfos) {
449                 // if (!settingsMethod(eventHandler.settingX)) goto fail;
450                 methodVisitor.visitIntInsn(Opcodes.ALOAD, 0);
451                 if (untypedEventHandler) {
452                     methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, getInternalClassName(), FIELD_EVENT_HANDLER, TYPE_OBJECT.getDescriptor());
453                 } else {
454                     methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, getInternalClassName(), FIELD_EVENT_HANDLER, Type.getDescriptor(EventHandler.class));
455                 }
456                 methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, eventHandlerXInternalName);
457                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, eventHandlerXInternalName, si.fieldName, TYPE_SETTING_CONTROL.getDescriptor());
458                 methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, si.internalSettingName);
459                 methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), si.methodName, &quot;(&quot; + si.settingDescriptor + &quot;)Z&quot;, false);
460                 methodVisitor.visitJumpInsn(Opcodes.IFEQ, fail);
461             }
462             // return true
463             methodVisitor.visitInsn(Opcodes.ICONST_1);
464             methodVisitor.visitInsn(Opcodes.IRETURN);
465             // return false
466             methodVisitor.visitLabel(fail);
467             methodVisitor.visitInsn(Opcodes.ICONST_0);
468             methodVisitor.visitInsn(Opcodes.IRETURN);
469         });
470     }
471 

472     private void getEventHandler(MethodVisitor methodVisitor) {
473         if (untypedEventHandler) {
474             methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, getInternalClassName(), FIELD_EVENT_HANDLER, TYPE_OBJECT.getDescriptor());
475             methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, TYPE_EVENT_HANDLER.getInternalName());
476         } else {
477             methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, getInternalClassName(), FIELD_EVENT_HANDLER, Type.getDescriptor(EventHandler.class));
478         }
479     }
480 
481     private void makeUninstrumented() {
482         updateExistingWithReturnFalse(METHOD_EVENT_SHOULD_COMMIT);
483         updateExistingWithReturnFalse(METHOD_IS_ENABLED);
484         updateExistingWithEmptyVoidMethod(METHOD_COMMIT);
485         updateExistingWithEmptyVoidMethod(METHOD_BEGIN);
486         updateExistingWithEmptyVoidMethod(METHOD_END);
487     }
488 
489     private final void updateExistingWithEmptyVoidMethod(Method voidMethod) {
490         updateMethod(voidMethod, methodVisitor -&gt; {
491             methodVisitor.visitInsn(Opcodes.RETURN);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
346 
347         // MyEvent#begin()
348         updateMethod(METHOD_BEGIN, methodVisitor -&gt; {
349             methodVisitor.visitIntInsn(Opcodes.ALOAD, 0);
350             ASMToolkit.invokeStatic(methodVisitor, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP);
351             methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);
352             methodVisitor.visitInsn(Opcodes.RETURN);
353         });
354 
355         // MyEvent#end()
356         updateMethod(METHOD_END, methodVisitor -&gt; {
357             methodVisitor.visitIntInsn(Opcodes.ALOAD, 0);
358             methodVisitor.visitIntInsn(Opcodes.ALOAD, 0);
359             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);
360             ASMToolkit.invokeStatic(methodVisitor, TYPE_EVENT_HANDLER.getInternalName(), METHOD_DURATION);
361             methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);
362             methodVisitor.visitInsn(Opcodes.RETURN);
363             methodVisitor.visitMaxs(0, 0);
364         });
365 

366         updateMethod(METHOD_COMMIT, methodVisitor -&gt; {
<span class="line-modified">367             // if (!isEnable()) {</span>
<span class="line-modified">368             // return;</span>
<span class="line-modified">369             // }</span>
<span class="line-modified">370             methodVisitor.visitCode();</span>
<span class="line-modified">371             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">372             methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), METHOD_IS_ENABLED.getName(), METHOD_IS_ENABLED.getDescriptor(), false);</span>
<span class="line-modified">373             Label l0 = new Label();</span>
<span class="line-modified">374             methodVisitor.visitJumpInsn(Opcodes.IFNE, l0);</span>
<span class="line-modified">375             methodVisitor.visitInsn(Opcodes.RETURN);</span>
<span class="line-modified">376             methodVisitor.visitLabel(l0);</span>
<span class="line-modified">377             methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="line-modified">378             // if (startTime == 0) {</span>
<span class="line-modified">379             // startTime = EventWriter.timestamp();</span>
<span class="line-modified">380             // } else {</span>
<span class="line-modified">381             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">382             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="line-modified">383             methodVisitor.visitInsn(Opcodes.LCONST_0);</span>
<span class="line-modified">384             methodVisitor.visitInsn(Opcodes.LCMP);</span>
<span class="line-modified">385             Label durationalEvent = new Label();</span>
<span class="line-modified">386             methodVisitor.visitJumpInsn(Opcodes.IFNE, durationalEvent);</span>
<span class="line-modified">387             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">388             methodVisitor.visitMethodInsn(Opcodes.INVOKESTATIC, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP.getName(), METHOD_TIME_STAMP.getDescriptor(), false);</span>
<span class="line-modified">389             methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="line-modified">390             Label commit = new Label();</span>
<span class="line-modified">391             methodVisitor.visitJumpInsn(Opcodes.GOTO, commit);</span>
<span class="line-modified">392             // if (duration == 0) {</span>
<span class="line-modified">393             // duration = EventWriter.timestamp() - startTime;</span>
<span class="line-modified">394             // }</span>
<span class="line-modified">395             // }</span>
<span class="line-modified">396             methodVisitor.visitLabel(durationalEvent);</span>
<span class="line-modified">397             methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="line-modified">398             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">399             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);</span>
<span class="line-modified">400             methodVisitor.visitInsn(Opcodes.LCONST_0);</span>
<span class="line-modified">401             methodVisitor.visitInsn(Opcodes.LCMP);</span>
<span class="line-modified">402             methodVisitor.visitJumpInsn(Opcodes.IFNE, commit);</span>
<span class="line-modified">403             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">404             methodVisitor.visitMethodInsn(Opcodes.INVOKESTATIC, TYPE_EVENT_HANDLER.getInternalName(), METHOD_TIME_STAMP.getName(), METHOD_TIME_STAMP.getDescriptor(), false);</span>
<span class="line-modified">405             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">406             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_START_TIME, &quot;J&quot;);</span>
<span class="line-modified">407             methodVisitor.visitInsn(Opcodes.LSUB);</span>
<span class="line-modified">408             methodVisitor.visitFieldInsn(Opcodes.PUTFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);</span>
<span class="line-modified">409             methodVisitor.visitLabel(commit);</span>
<span class="line-modified">410             // if (shouldCommit()) {</span>
<span class="line-modified">411             methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="line-modified">412             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">413             methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), METHOD_EVENT_SHOULD_COMMIT.getName(), METHOD_EVENT_SHOULD_COMMIT.getDescriptor(), false);</span>
<span class="line-modified">414             Label end = new Label();</span>
<span class="line-modified">415             // eventHandler.write(...);</span>
<span class="line-modified">416             // }</span>
<span class="line-modified">417             methodVisitor.visitJumpInsn(Opcodes.IFEQ, end);</span>
<span class="line-modified">418             getEventHandler(methodVisitor);</span>

419 
<span class="line-modified">420             methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, eventHandlerXInternalName);</span>
<span class="line-modified">421             for (FieldInfo fi : fieldInfos) {</span>
<span class="line-modified">422                 methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="line-modified">423                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, fi.internalClassName, fi.fieldName, fi.fieldDescriptor);</span>
<span class="line-modified">424             }</span>
425 
<span class="line-modified">426             methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, eventHandlerXInternalName, writeMethod.getName(), writeMethod.getDescriptor(), false);</span>
<span class="line-modified">427             methodVisitor.visitLabel(end);</span>
<span class="line-modified">428             methodVisitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="line-modified">429             methodVisitor.visitInsn(Opcodes.RETURN);</span>
<span class="line-modified">430             methodVisitor.visitEnd();</span>
<span class="line-modified">431         });</span>
432 
433         // MyEvent#shouldCommit()
434         updateMethod(METHOD_EVENT_SHOULD_COMMIT, methodVisitor -&gt; {
435             Label fail = new Label();
436             if (guardHandlerReference) {
437                 getEventHandler(methodVisitor);
438                 methodVisitor.visitJumpInsn(Opcodes.IFNULL, fail);
439             }
440             // if (!eventHandler.shouldCommit(duration) goto fail;
441             getEventHandler(methodVisitor);
442             methodVisitor.visitVarInsn(Opcodes.ALOAD, 0);
443             methodVisitor.visitFieldInsn(Opcodes.GETFIELD, getInternalClassName(), FIELD_DURATION, &quot;J&quot;);
444             ASMToolkit.invokeVirtual(methodVisitor, TYPE_EVENT_HANDLER.getInternalName(), METHOD_EVENT_HANDLER_SHOULD_COMMIT);
445             methodVisitor.visitJumpInsn(Opcodes.IFEQ, fail);
446             for (SettingInfo si : settingInfos) {
447                 // if (!settingsMethod(eventHandler.settingX)) goto fail;
448                 methodVisitor.visitIntInsn(Opcodes.ALOAD, 0);
449                 if (untypedEventHandler) {
450                     methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, getInternalClassName(), FIELD_EVENT_HANDLER, TYPE_OBJECT.getDescriptor());
451                 } else {
452                     methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, getInternalClassName(), FIELD_EVENT_HANDLER, Type.getDescriptor(EventHandler.class));
453                 }
454                 methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, eventHandlerXInternalName);
455                 methodVisitor.visitFieldInsn(Opcodes.GETFIELD, eventHandlerXInternalName, si.fieldName, TYPE_SETTING_CONTROL.getDescriptor());
456                 methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, si.internalSettingName);
457                 methodVisitor.visitMethodInsn(Opcodes.INVOKEVIRTUAL, getInternalClassName(), si.methodName, &quot;(&quot; + si.settingDescriptor + &quot;)Z&quot;, false);
458                 methodVisitor.visitJumpInsn(Opcodes.IFEQ, fail);
459             }
460             // return true
461             methodVisitor.visitInsn(Opcodes.ICONST_1);
462             methodVisitor.visitInsn(Opcodes.IRETURN);
463             // return false
464             methodVisitor.visitLabel(fail);
465             methodVisitor.visitInsn(Opcodes.ICONST_0);
466             methodVisitor.visitInsn(Opcodes.IRETURN);
467         });
468     }
469 
<span class="line-added">470 </span>
471     private void getEventHandler(MethodVisitor methodVisitor) {
472         if (untypedEventHandler) {
473             methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, getInternalClassName(), FIELD_EVENT_HANDLER, TYPE_OBJECT.getDescriptor());
474             methodVisitor.visitTypeInsn(Opcodes.CHECKCAST, TYPE_EVENT_HANDLER.getInternalName());
475         } else {
476             methodVisitor.visitFieldInsn(Opcodes.GETSTATIC, getInternalClassName(), FIELD_EVENT_HANDLER, Type.getDescriptor(EventHandler.class));
477         }
478     }
479 
480     private void makeUninstrumented() {
481         updateExistingWithReturnFalse(METHOD_EVENT_SHOULD_COMMIT);
482         updateExistingWithReturnFalse(METHOD_IS_ENABLED);
483         updateExistingWithEmptyVoidMethod(METHOD_COMMIT);
484         updateExistingWithEmptyVoidMethod(METHOD_BEGIN);
485         updateExistingWithEmptyVoidMethod(METHOD_END);
486     }
487 
488     private final void updateExistingWithEmptyVoidMethod(Method voidMethod) {
489         updateMethod(voidMethod, methodVisitor -&gt; {
490             methodVisitor.visitInsn(Opcodes.RETURN);
</pre>
</td>
</tr>
</table>
<center><a href="EventControl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="EventWriter.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>