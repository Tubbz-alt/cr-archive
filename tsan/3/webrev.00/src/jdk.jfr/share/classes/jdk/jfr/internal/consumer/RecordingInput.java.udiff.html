<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jfr/share/classes/jdk/jfr/internal/consumer/RecordingInput.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ChunkHeader.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../dcmd/DCmdConfigure.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/consumer/RecordingInput.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,65 +28,86 @@</span>
  import java.io.DataInput;
  import java.io.EOFException;
  import java.io.File;
  import java.io.IOException;
  import java.io.RandomAccessFile;
<span class="udiff-line-modified-removed">- import java.nio.charset.Charset;</span>
<span class="udiff-line-modified-added">+ import java.nio.file.Path;</span>
  
  public final class RecordingInput implements DataInput, AutoCloseable {
  
<span class="udiff-line-modified-removed">-     public static final byte STRING_ENCODING_NULL = 0;</span>
<span class="udiff-line-removed">-     public static final byte STRING_ENCODING_EMPTY_STRING = 1;</span>
<span class="udiff-line-removed">-     public static final byte STRING_ENCODING_CONSTANT_POOL = 2;</span>
<span class="udiff-line-removed">-     public static final byte STRING_ENCODING_UTF8_BYTE_ARRAY = 3;</span>
<span class="udiff-line-removed">-     public static final byte STRING_ENCODING_CHAR_ARRAY = 4;</span>
<span class="udiff-line-removed">-     public static final byte STRING_ENCODING_LATIN1_BYTE_ARRAY = 5;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private final static int DEFAULT_BLOCK_SIZE = 16 * 1024 * 1024;</span>
<span class="udiff-line-removed">-     private final static Charset UTF8 = Charset.forName(&quot;UTF-8&quot;);</span>
<span class="udiff-line-removed">-     private final static Charset LATIN1 = Charset.forName(&quot;ISO-8859-1&quot;);</span>
<span class="udiff-line-modified-added">+     private final static int DEFAULT_BLOCK_SIZE = 64_000;</span>
  
      private static final class Block {
          private byte[] bytes = new byte[0];
          private long blockPosition;
<span class="udiff-line-added">+         private long blockPositionEnd;</span>
  
          boolean contains(long position) {
<span class="udiff-line-modified-removed">-             return position &gt;= blockPosition &amp;&amp; position &lt; blockPosition + bytes.length;</span>
<span class="udiff-line-modified-added">+             return position &gt;= blockPosition &amp;&amp; position &lt; blockPositionEnd;</span>
          }
  
          public void read(RandomAccessFile file, int amount) throws IOException {
              blockPosition = file.getFilePointer();
              // reuse byte array, if possible
<span class="udiff-line-modified-removed">-             if (amount != bytes.length) {</span>
<span class="udiff-line-modified-added">+             if (amount &gt; bytes.length) {</span>
                  bytes = new byte[amount];
              }
<span class="udiff-line-modified-removed">-             file.readFully(bytes);</span>
<span class="udiff-line-modified-added">+             this.blockPositionEnd = blockPosition + amount;</span>
<span class="udiff-line-added">+             file.readFully(bytes, 0, amount);</span>
          }
  
          public byte get(long position) {
              return bytes[(int) (position - blockPosition)];
          }
<span class="udiff-line-removed">-     }</span>
  
<span class="udiff-line-modified-removed">-     private final RandomAccessFile file;</span>
<span class="udiff-line-modified-removed">-     private final long size;</span>
<span class="udiff-line-modified-added">+         public void reset() {</span>
<span class="udiff-line-modified-added">+             blockPosition = 0;</span>
<span class="udiff-line-added">+             blockPositionEnd = 0;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     private final int blockSize;</span>
<span class="udiff-line-added">+     private final FileAccess fileAccess;</span>
<span class="udiff-line-added">+     private RandomAccessFile file;</span>
<span class="udiff-line-added">+     private String filename;</span>
      private Block currentBlock = new Block();
      private Block previousBlock = new Block();
      private long position;
<span class="udiff-line-modified-removed">-     private final int blockSize;</span>
<span class="udiff-line-modified-added">+     private long size = -1; // Fail fast if setSize(...) has not been called</span>
<span class="udiff-line-added">+                             // before parsing</span>
  
<span class="udiff-line-modified-removed">-     private RecordingInput(File f, int blockSize) throws IOException {</span>
<span class="udiff-line-removed">-         this.size = f.length();</span>
<span class="udiff-line-modified-added">+     RecordingInput(File f, FileAccess fileAccess, int blockSize) throws IOException {</span>
          this.blockSize = blockSize;
<span class="udiff-line-modified-removed">-         this.file = new RandomAccessFile(f, &quot;r&quot;);</span>
<span class="udiff-line-modified-removed">-         if (size &lt; 8) {</span>
<span class="udiff-line-modified-removed">-             throw new IOException(&quot;Not a valid Flight Recorder file. File length is only &quot; + size + &quot; bytes.&quot;);</span>
<span class="udiff-line-modified-added">+         this.fileAccess = fileAccess;</span>
<span class="udiff-line-modified-added">+         initialize(f);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void initialize(File f) throws IOException {</span>
<span class="udiff-line-added">+         this.filename = fileAccess.getAbsolutePath(f);</span>
<span class="udiff-line-added">+         this.file = fileAccess.openRAF(f, &quot;r&quot;);</span>
<span class="udiff-line-added">+         this.position = 0;</span>
<span class="udiff-line-added">+         this.size = -1;</span>
<span class="udiff-line-added">+         this.currentBlock.reset();</span>
<span class="udiff-line-added">+         previousBlock.reset();</span>
<span class="udiff-line-added">+         if (fileAccess.length(f) &lt; 8) {</span>
<span class="udiff-line-added">+             throw new IOException(&quot;Not a valid Flight Recorder file. File length is only &quot; + fileAccess.length(f) + &quot; bytes.&quot;);</span>
          }
      }
  
<span class="udiff-line-modified-removed">-     public RecordingInput(File f) throws IOException {</span>
<span class="udiff-line-modified-removed">-         this(f, DEFAULT_BLOCK_SIZE);</span>
<span class="udiff-line-modified-added">+     public RecordingInput(File f, FileAccess fileAccess) throws IOException {</span>
<span class="udiff-line-modified-added">+         this(f, fileAccess, DEFAULT_BLOCK_SIZE);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     void positionPhysical(long position) throws IOException {</span>
<span class="udiff-line-added">+         file.seek(position);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     byte readPhysicalByte() throws IOException {</span>
<span class="udiff-line-added">+         return file.readByte();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     long readPhysicalLong() throws IOException {</span>
<span class="udiff-line-added">+         return file.readLong();</span>
      }
  
      @Override
      public final byte readByte() throws IOException {
          if (!currentBlock.contains(position)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -107,39 +128,39 @@</span>
      @Override
      public final void readFully(byte[] dst) throws IOException {
          readFully(dst, 0, dst.length);
      }
  
<span class="udiff-line-modified-removed">-     public final short readRawShort() throws IOException {</span>
<span class="udiff-line-modified-added">+     short readRawShort() throws IOException {</span>
          // copied from java.io.Bits
          byte b0 = readByte();
          byte b1 = readByte();
          return (short) ((b1 &amp; 0xFF) + (b0 &lt;&lt; 8));
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public final double readDouble() throws IOException {</span>
<span class="udiff-line-modified-added">+     public double readDouble() throws IOException {</span>
          // copied from java.io.Bits
          return Double.longBitsToDouble(readRawLong());
      }
  
      @Override
<span class="udiff-line-modified-removed">-     public final float readFloat() throws IOException {</span>
<span class="udiff-line-modified-added">+     public float readFloat() throws IOException {</span>
          // copied from java.io.Bits
          return Float.intBitsToFloat(readRawInt());
      }
  
<span class="udiff-line-modified-removed">-     public final int readRawInt() throws IOException {</span>
<span class="udiff-line-modified-added">+     int readRawInt() throws IOException {</span>
          // copied from java.io.Bits
          byte b0 = readByte();
          byte b1 = readByte();
          byte b2 = readByte();
          byte b3 = readByte();
          return ((b3 &amp; 0xFF)) + ((b2 &amp; 0xFF) &lt;&lt; 8) + ((b1 &amp; 0xFF) &lt;&lt; 16) + ((b0) &lt;&lt; 24);
      }
  
<span class="udiff-line-modified-removed">-     public final long readRawLong() throws IOException {</span>
<span class="udiff-line-modified-added">+     long readRawLong() throws IOException {</span>
          // copied from java.io.Bits
          byte b0 = readByte();
          byte b1 = readByte();
          byte b2 = readByte();
          byte b3 = readByte();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -148,24 +169,24 @@</span>
          byte b6 = readByte();
          byte b7 = readByte();
          return ((b7 &amp; 0xFFL)) + ((b6 &amp; 0xFFL) &lt;&lt; 8) + ((b5 &amp; 0xFFL) &lt;&lt; 16) + ((b4 &amp; 0xFFL) &lt;&lt; 24) + ((b3 &amp; 0xFFL) &lt;&lt; 32) + ((b2 &amp; 0xFFL) &lt;&lt; 40) + ((b1 &amp; 0xFFL) &lt;&lt; 48) + (((long) b0) &lt;&lt; 56);
      }
  
<span class="udiff-line-modified-removed">-     public final long position() throws IOException {</span>
<span class="udiff-line-modified-added">+     public final long position() {</span>
          return position;
      }
  
      public final void position(long newPosition) throws IOException {
          if (!currentBlock.contains(newPosition)) {
              if (!previousBlock.contains(newPosition)) {
<span class="udiff-line-modified-removed">-                 if (newPosition &gt; size()) {</span>
<span class="udiff-line-modified-removed">-                     throw new EOFException(&quot;Trying to read at &quot; + newPosition + &quot;, but file is only &quot; + size() + &quot; bytes.&quot;);</span>
<span class="udiff-line-modified-added">+                 if (newPosition &gt; size) {</span>
<span class="udiff-line-modified-added">+                     throw new EOFException(&quot;Trying to read at &quot; + newPosition + &quot;, but file is only &quot; + size + &quot; bytes.&quot;);</span>
                  }
                  long blockStart = trimToFileSize(calculateBlockStart(newPosition));
                  file.seek(blockStart);
                  // trim amount to file size
<span class="udiff-line-modified-removed">-                 long amount = Math.min(size() - blockStart, blockSize);</span>
<span class="udiff-line-modified-added">+                 long amount = Math.min(size - blockStart, blockSize);</span>
                  previousBlock.read(file, (int) amount);
              }
              // swap previous and current
              Block tmp = currentBlock;
              currentBlock = previousBlock;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -189,15 +210,16 @@</span>
          }
          // not near current block, pick middle
          return newPosition - blockSize / 2;
      }
  
<span class="udiff-line-modified-removed">-     public final long size() throws IOException {</span>
<span class="udiff-line-modified-added">+     long size() {</span>
          return size;
      }
  
<span class="udiff-line-modified-removed">-     public final void close() throws IOException {</span>
<span class="udiff-line-modified-added">+     @Override</span>
<span class="udiff-line-added">+     public void close() throws IOException {</span>
          file.close();
      }
  
      @Override
      public final int skipBytes(int n) throws IOException {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -243,38 +265,11 @@</span>
      // 2, means char array
      // 3, means latin-1 (ISO-8859-1) encoded byte array
      // 4, means &quot;&quot;
      @Override
      public String readUTF() throws IOException {
<span class="udiff-line-modified-removed">-         return readEncodedString(readByte());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public String readEncodedString(byte encoding) throws IOException {</span>
<span class="udiff-line-removed">-         if (encoding == STRING_ENCODING_NULL) {</span>
<span class="udiff-line-removed">-             return null;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (encoding == STRING_ENCODING_EMPTY_STRING) {</span>
<span class="udiff-line-removed">-             return &quot;&quot;;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         int size = readInt();</span>
<span class="udiff-line-removed">-         if (encoding == STRING_ENCODING_CHAR_ARRAY) {</span>
<span class="udiff-line-removed">-             char[] c = new char[size];</span>
<span class="udiff-line-removed">-             for (int i = 0; i &lt; size; i++) {</span>
<span class="udiff-line-removed">-                 c[i] = readChar();</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return new String(c);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         byte[] bytes = new byte[size];</span>
<span class="udiff-line-removed">-         readFully(bytes); // TODO: optimize, check size, and copy only if needed</span>
<span class="udiff-line-removed">-         if (encoding == STRING_ENCODING_UTF8_BYTE_ARRAY) {</span>
<span class="udiff-line-removed">-             return new String(bytes, UTF8);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (encoding == STRING_ENCODING_LATIN1_BYTE_ARRAY) {</span>
<span class="udiff-line-removed">-             return new String(bytes, LATIN1);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         throw new IOException(&quot;Unknown string encoding &quot; + encoding);</span>
<span class="udiff-line-modified-added">+         throw new UnsupportedOperationException(&quot;Use StringParser&quot;);</span>
      }
  
      @Override
      public char readChar() throws IOException {
          return (char) readLong();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -290,50 +285,154 @@</span>
          return (int) readLong();
      }
  
      @Override
      public long readLong() throws IOException {
<span class="udiff-line-modified-removed">-         // can be optimized by branching checks, but will do for now</span>
<span class="udiff-line-modified-added">+         final byte[] bytes = currentBlock.bytes;</span>
<span class="udiff-line-added">+         final int index = (int) (position - currentBlock.blockPosition);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (index + 8 &lt; bytes.length &amp;&amp; index &gt;= 0) {</span>
<span class="udiff-line-added">+             byte b0 = bytes[index];</span>
<span class="udiff-line-added">+             long ret = (b0 &amp; 0x7FL);</span>
<span class="udiff-line-added">+             if (b0 &gt;= 0) {</span>
<span class="udiff-line-added">+                 position += 1;</span>
<span class="udiff-line-added">+                 return ret;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             int b1 = bytes[index + 1];</span>
<span class="udiff-line-added">+             ret += (b1 &amp; 0x7FL) &lt;&lt; 7;</span>
<span class="udiff-line-added">+             if (b1 &gt;= 0) {</span>
<span class="udiff-line-added">+                 position += 2;</span>
<span class="udiff-line-added">+                 return ret;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             int b2 = bytes[index + 2];</span>
<span class="udiff-line-added">+             ret += (b2 &amp; 0x7FL) &lt;&lt; 14;</span>
<span class="udiff-line-added">+             if (b2 &gt;= 0) {</span>
<span class="udiff-line-added">+                 position += 3;</span>
<span class="udiff-line-added">+                 return ret;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             int b3 = bytes[index + 3];</span>
<span class="udiff-line-added">+             ret += (b3 &amp; 0x7FL) &lt;&lt; 21;</span>
<span class="udiff-line-added">+             if (b3 &gt;= 0) {</span>
<span class="udiff-line-added">+                 position += 4;</span>
<span class="udiff-line-added">+                 return ret;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             int b4 = bytes[index + 4];</span>
<span class="udiff-line-added">+             ret += (b4 &amp; 0x7FL) &lt;&lt; 28;</span>
<span class="udiff-line-added">+             if (b4 &gt;= 0) {</span>
<span class="udiff-line-added">+                 position += 5;</span>
<span class="udiff-line-added">+                 return ret;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             int b5 = bytes[index + 5];</span>
<span class="udiff-line-added">+             ret += (b5 &amp; 0x7FL) &lt;&lt; 35;</span>
<span class="udiff-line-added">+             if (b5 &gt;= 0) {</span>
<span class="udiff-line-added">+                 position += 6;</span>
<span class="udiff-line-added">+                 return ret;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             int b6 = bytes[index + 6];</span>
<span class="udiff-line-added">+             ret += (b6 &amp; 0x7FL) &lt;&lt; 42;</span>
<span class="udiff-line-added">+             if (b6 &gt;= 0) {</span>
<span class="udiff-line-added">+                 position += 7;</span>
<span class="udiff-line-added">+                 return ret;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             int b7 = bytes[index + 7];</span>
<span class="udiff-line-added">+             ret += (b7 &amp; 0x7FL) &lt;&lt; 49;</span>
<span class="udiff-line-added">+             if (b7 &gt;= 0) {</span>
<span class="udiff-line-added">+                 position += 8;</span>
<span class="udiff-line-added">+                 return ret;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             int b8 = bytes[index + 8];// read last byte raw</span>
<span class="udiff-line-added">+             position += 9;</span>
<span class="udiff-line-added">+             return ret + (((long) (b8 &amp; 0XFF)) &lt;&lt; 56);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return readLongSlow();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private long readLongSlow() throws IOException {</span>
          byte b0 = readByte();
          long ret = (b0 &amp; 0x7FL);
          if (b0 &gt;= 0) {
              return ret;
          }
<span class="udiff-line-added">+ </span>
          int b1 = readByte();
          ret += (b1 &amp; 0x7FL) &lt;&lt; 7;
          if (b1 &gt;= 0) {
              return ret;
          }
<span class="udiff-line-added">+ </span>
          int b2 = readByte();
          ret += (b2 &amp; 0x7FL) &lt;&lt; 14;
          if (b2 &gt;= 0) {
              return ret;
          }
<span class="udiff-line-added">+ </span>
          int b3 = readByte();
          ret += (b3 &amp; 0x7FL) &lt;&lt; 21;
          if (b3 &gt;= 0) {
              return ret;
          }
<span class="udiff-line-added">+ </span>
          int b4 = readByte();
          ret += (b4 &amp; 0x7FL) &lt;&lt; 28;
          if (b4 &gt;= 0) {
              return ret;
          }
<span class="udiff-line-added">+ </span>
          int b5 = readByte();
          ret += (b5 &amp; 0x7FL) &lt;&lt; 35;
          if (b5 &gt;= 0) {
              return ret;
          }
<span class="udiff-line-added">+ </span>
          int b6 = readByte();
          ret += (b6 &amp; 0x7FL) &lt;&lt; 42;
          if (b6 &gt;= 0) {
              return ret;
          }
<span class="udiff-line-added">+ </span>
          int b7 = readByte();
          ret += (b7 &amp; 0x7FL) &lt;&lt; 49;
          if (b7 &gt;= 0) {
              return ret;
<span class="udiff-line-added">+ </span>
          }
<span class="udiff-line-added">+ </span>
          int b8 = readByte(); // read last byte raw
          return ret + (((long) (b8 &amp; 0XFF)) &lt;&lt; 56);
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public void setValidSize(long size) {</span>
<span class="udiff-line-added">+         if (size &gt; this.size) {</span>
<span class="udiff-line-added">+             this.size = size;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public long getFileSize() throws IOException {</span>
<span class="udiff-line-added">+         return file.length();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public String getFilename() {</span>
<span class="udiff-line-added">+         return filename;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Purpose of this method is to reuse block cache from a</span>
<span class="udiff-line-added">+     // previous RecordingInput</span>
<span class="udiff-line-added">+     public void setFile(Path path) throws IOException {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             file.close();</span>
<span class="udiff-line-added">+         } catch (IOException e) {</span>
<span class="udiff-line-added">+             // perhaps deleted</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         file = null;</span>
<span class="udiff-line-added">+         initialize(path.toFile());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ /*</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  */</span>
  }
</pre>
<center><a href="ChunkHeader.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../dcmd/DCmdConfigure.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>