<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.jfr/share/classes/jdk/jfr/internal/EventControl.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../events/ActiveSettingEvent.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="EventInstrumentation.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/EventControl.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 30,15 ***</span>
  import java.lang.reflect.InvocationTargetException;
  import java.lang.reflect.Method;
  import java.lang.reflect.Modifier;
  import java.util.ArrayList;
  import java.util.Collections;
<span class="line-removed">- import java.util.HashMap;</span>
  import java.util.List;
<span class="line-removed">- import java.util.Map;</span>
<span class="line-removed">- import java.util.Map.Entry;</span>
<span class="line-removed">- import java.util.Set;</span>
  
  import jdk.internal.module.Modules;
  import jdk.jfr.AnnotationElement;
  import jdk.jfr.Enabled;
  import jdk.jfr.Name;
<span class="line-new-header">--- 30,11 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 57,36 ***</span>
  
  // This class can&#39;t have a hard reference from PlatformEventType, since it
  // holds SettingControl instances that need to be released
  // when a class is unloaded (to avoid memory leaks).
  public final class EventControl {
<span class="line-modified">! </span>
      static final String FIELD_SETTING_PREFIX = &quot;setting&quot;;
      private static final Type TYPE_ENABLED = TypeLibrary.createType(EnabledSetting.class);
      private static final Type TYPE_THRESHOLD = TypeLibrary.createType(ThresholdSetting.class);
      private static final Type TYPE_STACK_TRACE = TypeLibrary.createType(StackTraceSetting.class);
      private static final Type TYPE_PERIOD = TypeLibrary.createType(PeriodSetting.class);
      private static final Type TYPE_CUTOFF = TypeLibrary.createType(CutoffSetting.class);
  
<span class="line-modified">!     private final List&lt;SettingInfo&gt; settingInfos = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!     private final Map&lt;String, Control&gt; eventControls = new HashMap&lt;&gt;(5);</span>
      private final PlatformEventType type;
      private final String idName;
  
      EventControl(PlatformEventType eventType) {
<span class="line-modified">!         eventControls.put(Enabled.NAME, defineEnabled(eventType));</span>
          if (eventType.hasDuration()) {
<span class="line-modified">!             eventControls.put(Threshold.NAME, defineThreshold(eventType));</span>
          }
          if (eventType.hasStackTrace()) {
<span class="line-modified">!             eventControls.put(StackTrace.NAME, defineStackTrace(eventType));</span>
          }
          if (eventType.hasPeriod()) {
<span class="line-modified">!             eventControls.put(Period.NAME, definePeriod(eventType));</span>
          }
          if (eventType.hasCutoff()) {
<span class="line-modified">!             eventControls.put(Cutoff.NAME, defineCutoff(eventType));</span>
          }
  
          ArrayList&lt;AnnotationElement&gt; aes = new ArrayList&lt;&gt;(eventType.getAnnotationElements());
          remove(eventType, aes, Threshold.class);
          remove(eventType, aes, Period.class);
<span class="line-new-header">--- 53,43 ---</span>
  
  // This class can&#39;t have a hard reference from PlatformEventType, since it
  // holds SettingControl instances that need to be released
  // when a class is unloaded (to avoid memory leaks).
  public final class EventControl {
<span class="line-modified">!     final static class NamedControl {</span>
<span class="line-added">+         public final String name;</span>
<span class="line-added">+         public final Control control;</span>
<span class="line-added">+         NamedControl(String name, Control control) {</span>
<span class="line-added">+             this.name = name;</span>
<span class="line-added">+             this.control = control;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
      static final String FIELD_SETTING_PREFIX = &quot;setting&quot;;
      private static final Type TYPE_ENABLED = TypeLibrary.createType(EnabledSetting.class);
      private static final Type TYPE_THRESHOLD = TypeLibrary.createType(ThresholdSetting.class);
      private static final Type TYPE_STACK_TRACE = TypeLibrary.createType(StackTraceSetting.class);
      private static final Type TYPE_PERIOD = TypeLibrary.createType(PeriodSetting.class);
      private static final Type TYPE_CUTOFF = TypeLibrary.createType(CutoffSetting.class);
  
<span class="line-modified">!     private final ArrayList&lt;SettingInfo&gt; settingInfos = new ArrayList&lt;&gt;();</span>
<span class="line-modified">!     private final ArrayList&lt;NamedControl&gt; namedControls = new ArrayList&lt;&gt;(5);</span>
      private final PlatformEventType type;
      private final String idName;
  
      EventControl(PlatformEventType eventType) {
<span class="line-modified">!         addControl(Enabled.NAME, defineEnabled(eventType));</span>
          if (eventType.hasDuration()) {
<span class="line-modified">!             addControl(Threshold.NAME, defineThreshold(eventType));</span>
          }
          if (eventType.hasStackTrace()) {
<span class="line-modified">!             addControl(StackTrace.NAME, defineStackTrace(eventType));</span>
          }
          if (eventType.hasPeriod()) {
<span class="line-modified">!             addControl(Period.NAME, definePeriod(eventType));</span>
          }
          if (eventType.hasCutoff()) {
<span class="line-modified">!             addControl(Cutoff.NAME, defineCutoff(eventType));</span>
          }
  
          ArrayList&lt;AnnotationElement&gt; aes = new ArrayList&lt;&gt;(eventType.getAnnotationElements());
          remove(eventType, aes, Threshold.class);
          remove(eventType, aes, Period.class);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 97,10 ***</span>
<span class="line-new-header">--- 100,23 ---</span>
          eventType.setAnnotations(aes);
          this.type = eventType;
          this.idName = String.valueOf(eventType.getId());
      }
  
<span class="line-added">+     private boolean hasControl(String name) {</span>
<span class="line-added">+         for (NamedControl nc : namedControls) {</span>
<span class="line-added">+             if (name.equals(nc.name)) {</span>
<span class="line-added">+                 return true;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private void addControl(String name, Control control) {</span>
<span class="line-added">+         namedControls.add(new NamedControl(name, control));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      static void remove(PlatformEventType type, List&lt;AnnotationElement&gt; aes, Class&lt;? extends java.lang.annotation.Annotation&gt; clazz) {
          long id = Type.getTypeId(clazz);
          for (AnnotationElement a : type.getAnnotationElements()) {
              if (a.getTypeId() == id &amp;&amp; a.getTypeName().equals(clazz.getName())) {
                  aes.remove(a);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 129,11 ***</span>
                              String name = m.getName();
                              Name n = m.getAnnotation(Name.class);
                              if (n != null) {
                                  name = n.value();
                              }
<span class="line-modified">!                             if (!eventControls.containsKey(name)) {</span>
                                  defineSetting((Class&lt;? extends SettingControl&gt;) settingClass, m, type, name);
                              }
                          }
                      }
                  }
<span class="line-new-header">--- 145,12 ---</span>
                              String name = m.getName();
                              Name n = m.getAnnotation(Name.class);
                              if (n != null) {
                                  name = n.value();
                              }
<span class="line-modified">! </span>
<span class="line-added">+                             if (!hasControl(name)) {</span>
                                  defineSetting((Class&lt;? extends SettingControl&gt;) settingClass, m, type, name);
                              }
                          }
                      }
                  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 161,11 ***</span>
                      if (ae != null) {
                          aes.add(ae);
                      }
                  }
                  aes.trimToSize();
<span class="line-modified">!                 eventControls.put(settingName, si.settingControl);</span>
                  eventType.add(PrivateAccess.getInstance().newSettingDescriptor(settingType, settingName, defaultValue, aes));
                  settingInfos.add(si);
              }
          } catch (InstantiationException e) {
              // Programming error by user, fail fast
<span class="line-new-header">--- 178,11 ---</span>
                      if (ae != null) {
                          aes.add(ae);
                      }
                  }
                  aes.trimToSize();
<span class="line-modified">!                 addControl(settingName, si.settingControl);</span>
                  eventType.add(PrivateAccess.getInstance().newSettingDescriptor(settingType, settingName, defaultValue, aes));
                  settingInfos.add(si);
              }
          } catch (InstantiationException e) {
              // Programming error by user, fail fast
</pre>
<hr />
<pre>
<span class="line-old-header">*** 245,40 ***</span>
          type.add(PrivateAccess.getInstance().newSettingDescriptor(TYPE_PERIOD, PeriodSetting.NAME, def, Collections.emptyList()));
          return new PeriodSetting(type, def);
      }
  
      void disable() {
<span class="line-modified">!         for (Control c : eventControls.values()) {</span>
<span class="line-modified">!             if (c instanceof EnabledSetting) {</span>
<span class="line-modified">!                 c.setValueSafe(&quot;false&quot;);</span>
                  return;
              }
          }
      }
  
      void writeActiveSettingEvent() {
          if (!type.isRegistered()) {
              return;
          }
<span class="line-modified">!         for (Map.Entry&lt;String, Control&gt; entry : eventControls.entrySet()) {</span>
<span class="line-modified">!             Control c = entry.getValue();</span>
<span class="line-modified">!             if (Utils.isSettingVisible(c, type.hasEventHook())) {</span>
<span class="line-modified">!                 String value = c.getLastValue();</span>
                  if (value == null) {
<span class="line-modified">!                     value = c.getDefaultValue();</span>
                  }
<span class="line-modified">!                 ActiveSettingEvent ase = new ActiveSettingEvent();</span>
<span class="line-modified">!                 ase.id = type.getId();</span>
<span class="line-modified">!                 ase.name = entry.getKey();</span>
<span class="line-modified">!                 ase.value = value;</span>
<span class="line-removed">-                 ase.commit();</span>
              }
          }
      }
  
<span class="line-modified">!     public Set&lt;Entry&lt;String, Control&gt;&gt; getEntries() {</span>
<span class="line-modified">!         return eventControls.entrySet();</span>
      }
  
      public PlatformEventType getEventType() {
          return type;
      }
<span class="line-new-header">--- 262,39 ---</span>
          type.add(PrivateAccess.getInstance().newSettingDescriptor(TYPE_PERIOD, PeriodSetting.NAME, def, Collections.emptyList()));
          return new PeriodSetting(type, def);
      }
  
      void disable() {
<span class="line-modified">!         for (NamedControl nc : namedControls) {</span>
<span class="line-modified">!             if (nc.control instanceof EnabledSetting) {</span>
<span class="line-modified">!                 nc.control.setValueSafe(&quot;false&quot;);</span>
                  return;
              }
          }
      }
  
      void writeActiveSettingEvent() {
          if (!type.isRegistered()) {
              return;
          }
<span class="line-modified">!         ActiveSettingEvent event = ActiveSettingEvent.EVENT.get();</span>
<span class="line-modified">!         for (NamedControl nc : namedControls) {</span>
<span class="line-modified">!             if (Utils.isSettingVisible(nc.control, type.hasEventHook())) {</span>
<span class="line-modified">!                 String value = nc.control.getLastValue();</span>
                  if (value == null) {
<span class="line-modified">!                     value = nc.control.getDefaultValue();</span>
                  }
<span class="line-modified">!                 event.id = type.getId();</span>
<span class="line-modified">!                 event.name = nc.name;</span>
<span class="line-modified">!                 event.value = value;</span>
<span class="line-modified">!                 event.commit();</span>
              }
          }
      }
  
<span class="line-modified">!     public ArrayList&lt;NamedControl&gt; getNamedControls() {</span>
<span class="line-modified">!         return namedControls;</span>
      }
  
      public PlatformEventType getEventType() {
          return type;
      }
</pre>
<center><a href="../events/ActiveSettingEvent.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="EventInstrumentation.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>