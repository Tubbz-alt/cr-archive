<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.jfr/share/classes/jdk/jfr/internal/SettingsManager.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="SecuritySupport.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ShutdownHook.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/SettingsManager.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.jfr.internal;
 27 
 28 import java.util.ArrayList;
 29 import java.util.Collection;
 30 import java.util.Collections;
 31 import java.util.HashMap;
 32 import java.util.HashSet;
 33 import java.util.LinkedHashMap;
 34 import java.util.List;
 35 import java.util.Map;
<span class="line-removed"> 36 import java.util.Map.Entry;</span>
 37 import java.util.Set;
 38 import java.util.StringJoiner;
 39 

 40 import jdk.jfr.internal.handlers.EventHandler;
 41 
 42 final class SettingsManager {
 43 
 44     private static class InternalSetting {
 45 
 46         private final String identifier;
 47         private Map&lt;String, Set&lt;String&gt;&gt; enabledMap = new LinkedHashMap&lt;&gt;(5);
 48         private Map&lt;String, Set&lt;String&gt;&gt; allMap = new LinkedHashMap&lt;&gt;(5);
 49         private boolean enabled;
 50 
 51         /**
 52          * Settings identifier, for example &quot;com.example.HelloWorld&quot; or &quot;56&quot;
 53          * (id of event)
 54          *
 55          * @param settingsId
 56          */
 57         public InternalSetting(String settingsId) {
 58             this.identifier = settingsId;
 59         }
</pre>
<hr />
<pre>
196                 String eventName = key.substring(0, index);
197                 eventName = Utils.upgradeLegacyJDKEvent(eventName);
198                 InternalSetting s = internals.get(eventName);
199                 String settingName = key.substring(index + 1).trim();
200                 if (s == null) {
201                     s = new InternalSetting(eventName);
202                     internals.put(eventName, s);
203                 }
204                 s.add(settingName, value);
205             }
206         }
207       for (InternalSetting s : internals.values()) {
208          s.finish();
209       }
210 
211       return internals.values();
212     }
213 
214     void setEventControl(EventControl ec) {
215         InternalSetting is = getInternalSetting(ec);
<span class="line-modified">216         Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, &quot;Applied settings for &quot; + ec.getEventType().getLogName() + &quot; {&quot;);</span>
<span class="line-modified">217         for (Entry&lt;String, Control&gt; entry : ec.getEntries()) {</span>



218             Set&lt;String&gt; values = null;
<span class="line-modified">219             String settingName = entry.getKey();</span>
220             if (is != null) {
221                 values = is.getValues(settingName);
222             }
<span class="line-modified">223             Control control = entry.getValue();</span>
224             if (values != null) {
225                 control.apply(values);
226                 String after = control.getLastValue();
<span class="line-modified">227                 if (Logger.shouldLog(LogTag.JFR_SETTING, LogLevel.INFO)) {</span>
228                     if (Utils.isSettingVisible(control, ec.getEventType().hasEventHook())) {
229                         if (values.size() &gt; 1) {
230                             StringJoiner sj = new StringJoiner(&quot;, &quot;, &quot;{&quot;, &quot;}&quot;);
231                             for (String s : values) {
232                                 sj.add(&quot;\&quot;&quot; + s + &quot;\&quot;&quot;);
233                             }
234                             String message = &quot;  &quot; + settingName + &quot;= &quot; + sj.toString() + &quot; =&gt; \&quot;&quot; + after + &quot;\&quot;&quot;;
235                             Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, message);
236                         } else {
237                             String message = &quot;  &quot; + settingName + &quot;=\&quot;&quot; + control.getLastValue() + &quot;\&quot;&quot;;
238                             Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, message);
239                         }
240                     }
241                 }
242             } else {
243                 control.setDefault();
<span class="line-modified">244                 if (Logger.shouldLog(LogTag.JFR_SETTING, LogLevel.INFO)) {</span>
245                     String message = &quot;  &quot; + settingName + &quot;=\&quot;&quot; + control.getLastValue() + &quot;\&quot;&quot;;
246                     Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, message);
247                 }
248             }
249         }
250         ec.writeActiveSettingEvent();
<span class="line-modified">251         Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, &quot;}&quot;);</span>


252     }
253 
254     private InternalSetting getInternalSetting(EventControl ec) {
255         String name = ec.getEventType().getName();
256         InternalSetting nameBased = availableSettings.get(name);
257         InternalSetting idBased = availableSettings.get(ec.getSettingsId());
258 
259         if (nameBased == null &amp;&amp; idBased == null) {
260             return null;
261         }
262         if (idBased == null) {
263             return nameBased;
264         }
265         if (nameBased == null) {
266             return idBased;
267         }
268         InternalSetting mixed = new InternalSetting(nameBased.getSettingsId());
269         mixed.add(nameBased);
270         mixed.add(idBased);
271         return mixed;
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.jfr.internal;
 27 
 28 import java.util.ArrayList;
 29 import java.util.Collection;
 30 import java.util.Collections;
 31 import java.util.HashMap;
 32 import java.util.HashSet;
 33 import java.util.LinkedHashMap;
 34 import java.util.List;
 35 import java.util.Map;

 36 import java.util.Set;
 37 import java.util.StringJoiner;
 38 
<span class="line-added"> 39 import jdk.jfr.internal.EventControl.NamedControl;</span>
 40 import jdk.jfr.internal.handlers.EventHandler;
 41 
 42 final class SettingsManager {
 43 
 44     private static class InternalSetting {
 45 
 46         private final String identifier;
 47         private Map&lt;String, Set&lt;String&gt;&gt; enabledMap = new LinkedHashMap&lt;&gt;(5);
 48         private Map&lt;String, Set&lt;String&gt;&gt; allMap = new LinkedHashMap&lt;&gt;(5);
 49         private boolean enabled;
 50 
 51         /**
 52          * Settings identifier, for example &quot;com.example.HelloWorld&quot; or &quot;56&quot;
 53          * (id of event)
 54          *
 55          * @param settingsId
 56          */
 57         public InternalSetting(String settingsId) {
 58             this.identifier = settingsId;
 59         }
</pre>
<hr />
<pre>
196                 String eventName = key.substring(0, index);
197                 eventName = Utils.upgradeLegacyJDKEvent(eventName);
198                 InternalSetting s = internals.get(eventName);
199                 String settingName = key.substring(index + 1).trim();
200                 if (s == null) {
201                     s = new InternalSetting(eventName);
202                     internals.put(eventName, s);
203                 }
204                 s.add(settingName, value);
205             }
206         }
207       for (InternalSetting s : internals.values()) {
208          s.finish();
209       }
210 
211       return internals.values();
212     }
213 
214     void setEventControl(EventControl ec) {
215         InternalSetting is = getInternalSetting(ec);
<span class="line-modified">216         boolean shouldLog = Logger.shouldLog(LogTag.JFR_SETTING, LogLevel.INFO);</span>
<span class="line-modified">217         if (shouldLog) {</span>
<span class="line-added">218             Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, &quot;Applied settings for &quot; + ec.getEventType().getLogName() + &quot; {&quot;);</span>
<span class="line-added">219         }</span>
<span class="line-added">220         for (NamedControl nc: ec.getNamedControls()) {</span>
221             Set&lt;String&gt; values = null;
<span class="line-modified">222             String settingName = nc.name;</span>
223             if (is != null) {
224                 values = is.getValues(settingName);
225             }
<span class="line-modified">226             Control control = nc.control;</span>
227             if (values != null) {
228                 control.apply(values);
229                 String after = control.getLastValue();
<span class="line-modified">230                 if (shouldLog) {</span>
231                     if (Utils.isSettingVisible(control, ec.getEventType().hasEventHook())) {
232                         if (values.size() &gt; 1) {
233                             StringJoiner sj = new StringJoiner(&quot;, &quot;, &quot;{&quot;, &quot;}&quot;);
234                             for (String s : values) {
235                                 sj.add(&quot;\&quot;&quot; + s + &quot;\&quot;&quot;);
236                             }
237                             String message = &quot;  &quot; + settingName + &quot;= &quot; + sj.toString() + &quot; =&gt; \&quot;&quot; + after + &quot;\&quot;&quot;;
238                             Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, message);
239                         } else {
240                             String message = &quot;  &quot; + settingName + &quot;=\&quot;&quot; + control.getLastValue() + &quot;\&quot;&quot;;
241                             Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, message);
242                         }
243                     }
244                 }
245             } else {
246                 control.setDefault();
<span class="line-modified">247                 if (shouldLog) {</span>
248                     String message = &quot;  &quot; + settingName + &quot;=\&quot;&quot; + control.getLastValue() + &quot;\&quot;&quot;;
249                     Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, message);
250                 }
251             }
252         }
253         ec.writeActiveSettingEvent();
<span class="line-modified">254         if (shouldLog) {</span>
<span class="line-added">255             Logger.log(LogTag.JFR_SETTING, LogLevel.INFO, &quot;}&quot;);</span>
<span class="line-added">256         }</span>
257     }
258 
259     private InternalSetting getInternalSetting(EventControl ec) {
260         String name = ec.getEventType().getName();
261         InternalSetting nameBased = availableSettings.get(name);
262         InternalSetting idBased = availableSettings.get(ec.getSettingsId());
263 
264         if (nameBased == null &amp;&amp; idBased == null) {
265             return null;
266         }
267         if (idBased == null) {
268             return nameBased;
269         }
270         if (nameBased == null) {
271             return idBased;
272         }
273         InternalSetting mixed = new InternalSetting(nameBased.getSettingsId());
274         mixed.add(nameBased);
275         mixed.add(idBased);
276         return mixed;
</pre>
</td>
</tr>
</table>
<center><a href="SecuritySupport.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ShutdownHook.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>