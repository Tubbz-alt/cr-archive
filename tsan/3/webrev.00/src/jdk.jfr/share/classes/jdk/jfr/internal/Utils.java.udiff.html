<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jfr/share/classes/jdk/jfr/internal/Utils.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="TypeLibrary.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="WriteableUserPath.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/Utils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -41,11 +41,13 @@</span>
  import java.lang.reflect.InvocationTargetException;
  import java.lang.reflect.Method;
  import java.lang.reflect.Modifier;
  import java.nio.file.Path;
  import java.time.Duration;
<span class="udiff-line-added">+ import java.time.Instant;</span>
  import java.time.LocalDateTime;
<span class="udiff-line-added">+ import java.time.temporal.ChronoUnit;</span>
  import java.util.ArrayList;
  import java.util.Arrays;
  import java.util.Collections;
  import java.util.HashMap;
  import java.util.List;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -63,22 +65,33 @@</span>
  import jdk.jfr.internal.settings.StackTraceSetting;
  import jdk.jfr.internal.settings.ThresholdSetting;
  
  public final class Utils {
  
<span class="udiff-line-added">+     private static final Object flushObject = new Object();</span>
      private static final String INFINITY = &quot;infinity&quot;;
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static Boolean SAVE_GENERATED;</span>
<span class="udiff-line-removed">- </span>
      public static final String EVENTS_PACKAGE_NAME = &quot;jdk.jfr.events&quot;;
      public static final String INSTRUMENT_PACKAGE_NAME = &quot;jdk.jfr.internal.instrument&quot;;
      public static final String HANDLERS_PACKAGE_NAME = &quot;jdk.jfr.internal.handlers&quot;;
      public static final String REGISTER_EVENT = &quot;registerEvent&quot;;
      public static final String ACCESS_FLIGHT_RECORDER = &quot;accessFlightRecorder&quot;;
<span class="udiff-line-removed">- </span>
      private final static String LEGACY_EVENT_NAME_PREFIX = &quot;com.oracle.jdk.&quot;;
  
<span class="udiff-line-added">+     private static Boolean SAVE_GENERATED;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static final Duration MICRO_SECOND = Duration.ofNanos(1_000);</span>
<span class="udiff-line-added">+     private static final Duration SECOND = Duration.ofSeconds(1);</span>
<span class="udiff-line-added">+     private static final Duration MINUTE = Duration.ofMinutes(1);</span>
<span class="udiff-line-added">+     private static final Duration HOUR = Duration.ofHours(1);</span>
<span class="udiff-line-added">+     private static final Duration DAY = Duration.ofDays(1);</span>
<span class="udiff-line-added">+     private static final int NANO_SIGNIFICANT_FIGURES = 9;</span>
<span class="udiff-line-added">+     private static final int MILL_SIGNIFICANT_FIGURES = 3;</span>
<span class="udiff-line-added">+     private static final int DISPLAY_NANO_DIGIT = 3;</span>
<span class="udiff-line-added">+     private static final int BASE = 10;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
      public static void checkAccessFlightRecorder() throws SecurityException {
          SecurityManager sm = System.getSecurityManager();
          if (sm != null) {
              sm.checkPermission(new FlightRecorderPermission(ACCESS_FLIGHT_RECORDER));
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -593,6 +606,119 @@</span>
          String pid = JVM.getJVM().getPid();
          String date = Repository.REPO_DATE_FORMAT.format(LocalDateTime.now());
          String idText = recording == null ? &quot;&quot; :  &quot;-id-&quot; + Long.toString(recording.getId());
          return &quot;hotspot-&quot; + &quot;pid-&quot; + pid + idText + &quot;-&quot; + date + &quot;.jfr&quot;;
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static String formatDuration(Duration d) {</span>
<span class="udiff-line-added">+         Duration roundedDuration = roundDuration(d);</span>
<span class="udiff-line-added">+         if (roundedDuration.equals(Duration.ZERO)) {</span>
<span class="udiff-line-added">+             return &quot;0 s&quot;;</span>
<span class="udiff-line-added">+         } else if(roundedDuration.isNegative()){</span>
<span class="udiff-line-added">+             return &quot;-&quot; + formatPositiveDuration(roundedDuration.abs());</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return formatPositiveDuration(roundedDuration);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static String formatPositiveDuration(Duration d){</span>
<span class="udiff-line-added">+         if (d.compareTo(MICRO_SECOND) &lt; 0) {</span>
<span class="udiff-line-added">+             // 0.000001 ms - 0.000999 ms</span>
<span class="udiff-line-added">+             double outputMs = (double) d.toNanosPart() / 1_000_000;</span>
<span class="udiff-line-added">+             return String.format(&quot;%.6f ms&quot;,  outputMs);</span>
<span class="udiff-line-added">+         } else if (d.compareTo(SECOND) &lt; 0) {</span>
<span class="udiff-line-added">+             // 0.001 ms - 999 ms</span>
<span class="udiff-line-added">+             int valueLength = countLength(d.toNanosPart());</span>
<span class="udiff-line-added">+             int outputDigit = NANO_SIGNIFICANT_FIGURES - valueLength;</span>
<span class="udiff-line-added">+             double outputMs = (double) d.toNanosPart() / 1_000_000;</span>
<span class="udiff-line-added">+             return String.format(&quot;%.&quot; + outputDigit + &quot;f ms&quot;,  outputMs);</span>
<span class="udiff-line-added">+         } else if (d.compareTo(MINUTE) &lt; 0) {</span>
<span class="udiff-line-added">+             // 1.00 s - 59.9 s</span>
<span class="udiff-line-added">+             int valueLength = countLength(d.toSecondsPart());</span>
<span class="udiff-line-added">+             int outputDigit = MILL_SIGNIFICANT_FIGURES - valueLength;</span>
<span class="udiff-line-added">+             double outputSecond = d.toSecondsPart() + (double) d.toMillisPart() / 1_000;</span>
<span class="udiff-line-added">+             return String.format(&quot;%.&quot; + outputDigit + &quot;f s&quot;,  outputSecond);</span>
<span class="udiff-line-added">+         } else if (d.compareTo(HOUR) &lt; 0) {</span>
<span class="udiff-line-added">+             // 1 m 0 s - 59 m 59 s</span>
<span class="udiff-line-added">+             return String.format(&quot;%d m %d s&quot;,  d.toMinutesPart(), d.toSecondsPart());</span>
<span class="udiff-line-added">+         } else if (d.compareTo(DAY) &lt; 0) {</span>
<span class="udiff-line-added">+             // 1 h 0 m - 23 h 59 m</span>
<span class="udiff-line-added">+             return String.format(&quot;%d h %d m&quot;,  d.toHoursPart(), d.toMinutesPart());</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             // 1 d 0 h -</span>
<span class="udiff-line-added">+             return String.format(&quot;%d d %d h&quot;,  d.toDaysPart(), d.toHoursPart());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static int countLength(long value){</span>
<span class="udiff-line-added">+         return (int) Math.log10(value) + 1;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static Duration roundDuration(Duration d) {</span>
<span class="udiff-line-added">+         if (d.equals(Duration.ZERO)) {</span>
<span class="udiff-line-added">+             return d;</span>
<span class="udiff-line-added">+         } else if(d.isNegative()){</span>
<span class="udiff-line-added">+             Duration roundedPositiveDuration = roundPositiveDuration(d.abs());</span>
<span class="udiff-line-added">+             return roundedPositiveDuration.negated();</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return roundPositiveDuration(d);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static Duration roundPositiveDuration(Duration d){</span>
<span class="udiff-line-added">+         if (d.compareTo(MICRO_SECOND) &lt; 0) {</span>
<span class="udiff-line-added">+             // No round</span>
<span class="udiff-line-added">+             return d;</span>
<span class="udiff-line-added">+         } else if (d.compareTo(SECOND) &lt; 0) {</span>
<span class="udiff-line-added">+             // Round significant figures to three digits</span>
<span class="udiff-line-added">+             int valueLength = countLength(d.toNanosPart());</span>
<span class="udiff-line-added">+             int roundValue = (int) Math.pow(BASE, valueLength - DISPLAY_NANO_DIGIT);</span>
<span class="udiff-line-added">+             long roundedNanos = Math.round((double) d.toNanosPart() / roundValue) * roundValue;</span>
<span class="udiff-line-added">+             return d.truncatedTo(ChronoUnit.SECONDS).plusNanos(roundedNanos);</span>
<span class="udiff-line-added">+         } else if (d.compareTo(MINUTE) &lt; 0) {</span>
<span class="udiff-line-added">+             // Round significant figures to three digits</span>
<span class="udiff-line-added">+             int valueLength = countLength(d.toSecondsPart());</span>
<span class="udiff-line-added">+             int roundValue = (int) Math.pow(BASE, valueLength);</span>
<span class="udiff-line-added">+             long roundedMills = Math.round((double) d.toMillisPart() / roundValue) * roundValue;</span>
<span class="udiff-line-added">+             return d.truncatedTo(ChronoUnit.SECONDS).plusMillis(roundedMills);</span>
<span class="udiff-line-added">+         } else if (d.compareTo(HOUR) &lt; 0) {</span>
<span class="udiff-line-added">+             // Round for more than 500 ms or less</span>
<span class="udiff-line-added">+             return d.plusMillis(SECOND.dividedBy(2).toMillisPart()).truncatedTo(ChronoUnit.SECONDS);</span>
<span class="udiff-line-added">+         } else if (d.compareTo(DAY) &lt; 0) {</span>
<span class="udiff-line-added">+             // Round for more than 30 seconds or less</span>
<span class="udiff-line-added">+             return d.plusSeconds(MINUTE.dividedBy(2).toSecondsPart()).truncatedTo(ChronoUnit.MINUTES);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             // Round for more than 30 minutes or less</span>
<span class="udiff-line-added">+             return d.plusMinutes(HOUR.dividedBy(2).toMinutesPart()).truncatedTo(ChronoUnit.HOURS);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static void takeNap(long millis) {</span>
<span class="udiff-line-added">+         try {</span>
<span class="udiff-line-added">+             Thread.sleep(millis);</span>
<span class="udiff-line-added">+         } catch (InterruptedException e) {</span>
<span class="udiff-line-added">+             // ok</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static void notifyFlush() {</span>
<span class="udiff-line-added">+         synchronized (flushObject) {</span>
<span class="udiff-line-added">+             flushObject.notifyAll();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static void waitFlush(long timeOut) {</span>
<span class="udiff-line-added">+         synchronized (flushObject) {</span>
<span class="udiff-line-added">+             try {</span>
<span class="udiff-line-added">+                 flushObject.wait(timeOut);</span>
<span class="udiff-line-added">+             } catch (InterruptedException e) {</span>
<span class="udiff-line-added">+                 // OK</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static long timeToNanos(Instant timestamp) {</span>
<span class="udiff-line-added">+         return timestamp.getEpochSecond() * 1_000_000_000L + timestamp.getNano();</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="TypeLibrary.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="WriteableUserPath.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>