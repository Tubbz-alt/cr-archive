<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.jfr/share/classes/jdk/jfr/internal/SecuritySupport.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="RequestEngine.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SettingsManager.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/SecuritySupport.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 36,10 ***</span>
<span class="line-new-header">--- 36,11 ---</span>
  import java.lang.reflect.Field;
  import java.lang.reflect.Method;
  import java.lang.reflect.ReflectPermission;
  import java.nio.channels.FileChannel;
  import java.nio.channels.ReadableByteChannel;
<span class="line-added">+ import java.nio.file.DirectoryStream;</span>
  import java.nio.file.FileVisitResult;
  import java.nio.file.Files;
  import java.nio.file.Path;
  import java.nio.file.Paths;
  import java.nio.file.SimpleFileVisitor;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 63,21 ***</span>
  import jdk.jfr.Event;
  import jdk.jfr.FlightRecorder;
  import jdk.jfr.FlightRecorderListener;
  import jdk.jfr.FlightRecorderPermission;
  import jdk.jfr.Recording;
  
  /**
   * Contains JFR code that does
   * {@link AccessController#doPrivileged(PrivilegedAction)}
   */
  public final class SecuritySupport {
      private final static Unsafe unsafe = Unsafe.getUnsafe();
      private final static MethodHandles.Lookup LOOKUP = MethodHandles.lookup();
      private final static Module JFR_MODULE = Event.class.getModule();
      public  final static SafePath JFC_DIRECTORY = getPathInProperty(&quot;java.home&quot;, &quot;lib/jfr&quot;);
<span class="line-modified">! </span>
      static final SafePath USER_HOME = getPathInProperty(&quot;user.home&quot;, null);
      static final SafePath JAVA_IO_TMPDIR = getPathInProperty(&quot;java.io.tmpdir&quot;, null);
  
      static {
          // ensure module java.base can read module jdk.jfr as early as possible
<span class="line-new-header">--- 64,22 ---</span>
  import jdk.jfr.Event;
  import jdk.jfr.FlightRecorder;
  import jdk.jfr.FlightRecorderListener;
  import jdk.jfr.FlightRecorderPermission;
  import jdk.jfr.Recording;
<span class="line-added">+ import jdk.jfr.internal.consumer.FileAccess;</span>
  
  /**
   * Contains JFR code that does
   * {@link AccessController#doPrivileged(PrivilegedAction)}
   */
  public final class SecuritySupport {
      private final static Unsafe unsafe = Unsafe.getUnsafe();
      private final static MethodHandles.Lookup LOOKUP = MethodHandles.lookup();
      private final static Module JFR_MODULE = Event.class.getModule();
      public  final static SafePath JFC_DIRECTORY = getPathInProperty(&quot;java.home&quot;, &quot;lib/jfr&quot;);
<span class="line-modified">!     public final static FileAccess PRIVILIGED = new Privileged();</span>
      static final SafePath USER_HOME = getPathInProperty(&quot;user.home&quot;, null);
      static final SafePath JAVA_IO_TMPDIR = getPathInProperty(&quot;java.io.tmpdir&quot;, null);
  
      static {
          // ensure module java.base can read module jdk.jfr as early as possible
</pre>
<hr />
<pre>
<span class="line-old-header">*** 148,11 ***</span>
      /**
       * Path created by the default file provider,and not
       * a malicious provider.
       *
       */
<span class="line-modified">!     public static final class SafePath {</span>
          private final Path path;
          private final String text;
  
          public SafePath(Path p) {
              // sanitize
<span class="line-new-header">--- 150,11 ---</span>
      /**
       * Path created by the default file provider,and not
       * a malicious provider.
       *
       */
<span class="line-modified">!     public static final class SafePath implements Comparable&lt;SafePath&gt; {</span>
          private final Path path;
          private final String text;
  
          public SafePath(Path p) {
              // sanitize
</pre>
<hr />
<pre>
<span class="line-old-header">*** 166,13 ***</span>
<span class="line-new-header">--- 168,35 ---</span>
  
          public Path toPath() {
              return path;
          }
  
<span class="line-added">+         public File toFile() {</span>
<span class="line-added">+             return path.toFile();</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          public String toString() {
              return text;
          }
<span class="line-added">+ </span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public int compareTo(SafePath that) {</span>
<span class="line-added">+             return that.text.compareTo(this.text);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public boolean equals(Object other) {</span>
<span class="line-added">+             if(other != null &amp;&amp; other instanceof SafePath){</span>
<span class="line-added">+                 return this.toPath().equals(((SafePath) other).toPath());</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return false;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public int hashCode() {</span>
<span class="line-added">+             return this.toPath().hashCode();</span>
<span class="line-added">+         }</span>
      }
  
      private interface RunnableWithCheckedException {
          public void run() throws Exception;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 288,10 ***</span>
<span class="line-new-header">--- 312,14 ---</span>
  
      public static void registerMirror(Class&lt;? extends Event&gt; eventClass) {
          doPrivileged(() -&gt;  MetadataRepository.getInstance().registerMirror(eventClass), new FlightRecorderPermission(Utils.REGISTER_EVENT));
      }
  
<span class="line-added">+     public static void setProperty(String propertyName, String value) {</span>
<span class="line-added">+         doPrivileged(() -&gt; System.setProperty(propertyName, value), new PropertyPermission(propertyName, &quot;write&quot;));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      static boolean getBooleanProperty(String propertyName) {
          return doPrivilegedWithReturn(() -&gt; Boolean.getBoolean(propertyName), new PropertyPermission(propertyName, &quot;read&quot;));
      }
  
      private static SafePath getPathInProperty(String prop, String subPath) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 328,11 ***</span>
  
      static void clearDirectory(SafePath safePath) throws IOException {
          doPriviligedIO(() -&gt; Files.walkFileTree(safePath.toPath(), new DirectoryCleaner()));
      }
  
<span class="line-modified">!     static SafePath toRealPath(SafePath safePath) throws Exception {</span>
          return new SafePath(doPrivilegedIOWithReturn(() -&gt; safePath.toPath().toRealPath()));
      }
  
      static boolean existDirectory(SafePath directory) throws IOException {
          return doPrivilegedIOWithReturn(() -&gt; Files.exists(directory.toPath()));
<span class="line-new-header">--- 356,11 ---</span>
  
      static void clearDirectory(SafePath safePath) throws IOException {
          doPriviligedIO(() -&gt; Files.walkFileTree(safePath.toPath(), new DirectoryCleaner()));
      }
  
<span class="line-modified">!     static SafePath toRealPath(SafePath safePath) throws IOException {</span>
          return new SafePath(doPrivilegedIOWithReturn(() -&gt; safePath.toPath().toRealPath()));
      }
  
      static boolean existDirectory(SafePath directory) throws IOException {
          return doPrivilegedIOWithReturn(() -&gt; Files.exists(directory.toPath()));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 354,11 ***</span>
          Path p = doPrivilegedIOWithReturn(() -&gt; Files.createDirectories(safePath.toPath()));
          return new SafePath(p);
      }
  
      public static boolean exists(SafePath safePath) throws IOException {
<span class="line-modified">!         return doPrivilegedIOWithReturn(() -&gt; Files.exists(safePath.toPath()));</span>
      }
  
      public static boolean isDirectory(SafePath safePath) throws IOException {
          return doPrivilegedIOWithReturn(() -&gt; Files.isDirectory(safePath.toPath()));
      }
<span class="line-new-header">--- 382,12 ---</span>
          Path p = doPrivilegedIOWithReturn(() -&gt; Files.createDirectories(safePath.toPath()));
          return new SafePath(p);
      }
  
      public static boolean exists(SafePath safePath) throws IOException {
<span class="line-modified">!         // Files.exist(path) is allocation intensive</span>
<span class="line-added">+         return doPrivilegedIOWithReturn(() -&gt; safePath.toPath().toFile().exists());</span>
      }
  
      public static boolean isDirectory(SafePath safePath) throws IOException {
          return doPrivilegedIOWithReturn(() -&gt; Files.isDirectory(safePath.toPath()));
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 406,11 ***</span>
      static void ensureClassIsInitialized(Class&lt;?&gt; clazz) {
          unsafe.ensureClassInitialized(clazz);
      }
  
      static Class&lt;?&gt; defineClass(Class&lt;?&gt; lookupClass, byte[] bytes) {
<span class="line-modified">!         return AccessController.doPrivileged(new PrivilegedAction&lt;&gt;() {</span>
              @Override
              public Class&lt;?&gt; run() {
                  try {
                      return MethodHandles.privateLookupIn(lookupClass, LOOKUP).defineClass(bytes);
                  } catch (IllegalAccessException e) {
<span class="line-new-header">--- 435,11 ---</span>
      static void ensureClassIsInitialized(Class&lt;?&gt; clazz) {
          unsafe.ensureClassInitialized(clazz);
      }
  
      static Class&lt;?&gt; defineClass(Class&lt;?&gt; lookupClass, byte[] bytes) {
<span class="line-modified">!         return AccessController.doPrivileged(new PrivilegedAction&lt;Class&lt;?&gt;&gt;() {</span>
              @Override
              public Class&lt;?&gt; run() {
                  try {
                      return MethodHandles.privateLookupIn(lookupClass, LOOKUP).defineClass(bytes);
                  } catch (IllegalAccessException e) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 418,17 ***</span>
                  }
              }
          });
      }
  
<span class="line-modified">!     static Thread createThreadWitNoPermissions(String threadName, Runnable runnable) {</span>
          return doPrivilegedWithReturn(() -&gt; new Thread(runnable, threadName), new Permission[0]);
      }
  
      static void setDaemonThread(Thread t, boolean daeomn) {
        doPrivileged(()-&gt; t.setDaemon(daeomn), new RuntimePermission(&quot;modifyThread&quot;));
      }
  
      public static SafePath getAbsolutePath(SafePath path) throws IOException {
          return new SafePath(doPrivilegedIOWithReturn((()-&gt; path.toPath().toAbsolutePath())));
      }
  }
<span class="line-new-header">--- 447,45 ---</span>
                  }
              }
          });
      }
  
<span class="line-modified">!     public static Thread createThreadWitNoPermissions(String threadName, Runnable runnable) {</span>
          return doPrivilegedWithReturn(() -&gt; new Thread(runnable, threadName), new Permission[0]);
      }
  
      static void setDaemonThread(Thread t, boolean daeomn) {
        doPrivileged(()-&gt; t.setDaemon(daeomn), new RuntimePermission(&quot;modifyThread&quot;));
      }
  
      public static SafePath getAbsolutePath(SafePath path) throws IOException {
          return new SafePath(doPrivilegedIOWithReturn((()-&gt; path.toPath().toAbsolutePath())));
      }
<span class="line-added">+ </span>
<span class="line-added">+     private final static class Privileged extends FileAccess {</span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public RandomAccessFile openRAF(File f, String mode) throws IOException {</span>
<span class="line-added">+             return doPrivilegedIOWithReturn( () -&gt; new RandomAccessFile(f, mode));</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public  DirectoryStream&lt;Path&gt; newDirectoryStream(Path directory)  throws IOException  {</span>
<span class="line-added">+             return doPrivilegedIOWithReturn( () -&gt; Files.newDirectoryStream(directory));</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public  String getAbsolutePath(File f) throws IOException {</span>
<span class="line-added">+             return doPrivilegedIOWithReturn( () -&gt; f.getAbsolutePath());</span>
<span class="line-added">+         }</span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public long length(File f) throws IOException {</span>
<span class="line-added">+             return doPrivilegedIOWithReturn( () -&gt; f.length());</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         @Override</span>
<span class="line-added">+         public  long fileSize(Path p) throws IOException {</span>
<span class="line-added">+             return doPrivilegedIOWithReturn( () -&gt; Files.size(p));</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
  }
</pre>
<center><a href="RequestEngine.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SettingsManager.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>