<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.httpserver/share/classes/com/sun/net/httpserver/BasicAuthenticator.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../jdk.hotspot.agent/windows/native/libsaproc/sawindbg.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HttpExchange.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.httpserver/share/classes/com/sun/net/httpserver/BasicAuthenticator.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -23,29 +23,62 @@</span>
   * questions.
   */
  
  package com.sun.net.httpserver;
  
<span class="udiff-line-added">+ import java.nio.charset.Charset;</span>
  import java.util.Base64;
<span class="udiff-line-added">+ import java.util.Objects;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import static java.nio.charset.StandardCharsets.UTF_8;</span>
  
  /**
   * BasicAuthenticator provides an implementation of HTTP Basic
   * authentication. It is an abstract class and must be extended
   * to provide an implementation of {@link #checkCredentials(String,String)}
   * which is called to verify each incoming request.
   */
  public abstract class BasicAuthenticator extends Authenticator {
  
<span class="udiff-line-modified-removed">-     protected String realm;</span>
<span class="udiff-line-modified-added">+     protected final String realm;</span>
<span class="udiff-line-added">+     private final Charset charset;</span>
<span class="udiff-line-added">+     private final boolean isUTF8;</span>
  
      /**
<span class="udiff-line-modified-removed">-      * Creates a BasicAuthenticator for the given HTTP realm</span>
<span class="udiff-line-modified-added">+      * Creates a BasicAuthenticator for the given HTTP realm.</span>
<span class="udiff-line-added">+      * The Basic authentication credentials (username and password) are decoded</span>
<span class="udiff-line-added">+      * using the platform&#39;s {@link Charset#defaultCharset() default character set}.</span>
<span class="udiff-line-added">+      *</span>
       * @param realm The HTTP Basic authentication realm
<span class="udiff-line-modified-removed">-      * @throws NullPointerException if the realm is an empty string</span>
<span class="udiff-line-modified-added">+      * @throws NullPointerException if realm is {@code null}</span>
<span class="udiff-line-added">+      * @throws IllegalArgumentException if realm is an empty string</span>
       */
      public BasicAuthenticator (String realm) {
<span class="udiff-line-added">+         this(realm, Charset.defaultCharset());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Creates a BasicAuthenticator for the given HTTP realm and using the</span>
<span class="udiff-line-added">+      * given {@link Charset} to decode the Basic authentication credentials</span>
<span class="udiff-line-added">+      * (username and password).</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @apiNote {@code UTF-8} is the recommended charset because its usage is</span>
<span class="udiff-line-added">+      * communicated to the client, and therefore more likely to be used also</span>
<span class="udiff-line-added">+      * by the client.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param realm The HTTP Basic authentication realm</span>
<span class="udiff-line-added">+      * @param charset The Charset to decode incoming credentials from the client</span>
<span class="udiff-line-added">+      * @throws NullPointerException if realm or charset are {@code null}</span>
<span class="udiff-line-added">+      * @throws IllegalArgumentException if realm is an empty string</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public BasicAuthenticator (String realm, Charset charset) {</span>
<span class="udiff-line-added">+         Objects.requireNonNull(charset);</span>
<span class="udiff-line-added">+         if (realm.isEmpty()) // implicit NPE check</span>
<span class="udiff-line-added">+             throw new IllegalArgumentException(&quot;realm must not be empty&quot;);</span>
          this.realm = realm;
<span class="udiff-line-added">+         this.charset = charset;</span>
<span class="udiff-line-added">+         this.isUTF8 = charset.equals(UTF_8);</span>
      }
  
      /**
       * returns the realm this BasicAuthenticator was created with
       * @return the authenticator&#39;s realm string.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -60,20 +93,19 @@</span>
          /*
           * look for auth token
           */
          String auth = rmap.getFirst (&quot;Authorization&quot;);
          if (auth == null) {
<span class="udiff-line-modified-removed">-             Headers map = t.getResponseHeaders();</span>
<span class="udiff-line-removed">-             map.set (&quot;WWW-Authenticate&quot;, &quot;Basic realm=&quot; + &quot;\&quot;&quot;+realm+&quot;\&quot;&quot;);</span>
<span class="udiff-line-modified-added">+             setAuthHeader(t);</span>
              return new Authenticator.Retry (401);
          }
          int sp = auth.indexOf (&#39; &#39;);
          if (sp == -1 || !auth.substring(0, sp).equals (&quot;Basic&quot;)) {
              return new Authenticator.Failure (401);
          }
          byte[] b = Base64.getDecoder().decode(auth.substring(sp+1));
<span class="udiff-line-modified-removed">-         String userpass = new String (b);</span>
<span class="udiff-line-modified-added">+         String userpass = new String (b, charset);</span>
          int colon = userpass.indexOf (&#39;:&#39;);
          String uname = userpass.substring (0, colon);
          String pass = userpass.substring (colon+1);
  
          if (checkCredentials (uname, pass)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -82,17 +114,22 @@</span>
                      uname, realm
                  )
              );
          } else {
              /* reject the request again with 401 */
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-             Headers map = t.getResponseHeaders();</span>
<span class="udiff-line-removed">-             map.set (&quot;WWW-Authenticate&quot;, &quot;Basic realm=&quot; + &quot;\&quot;&quot;+realm+&quot;\&quot;&quot;);</span>
<span class="udiff-line-modified-added">+             setAuthHeader(t);</span>
              return new Authenticator.Failure(401);
          }
      }
  
<span class="udiff-line-added">+     private void setAuthHeader(HttpExchange t) {</span>
<span class="udiff-line-added">+         Headers map = t.getResponseHeaders();</span>
<span class="udiff-line-added">+         var authString = &quot;Basic realm=&quot; + &quot;\&quot;&quot; + realm + &quot;\&quot;&quot; +</span>
<span class="udiff-line-added">+             (isUTF8 ? &quot;, charset=\&quot;UTF-8\&quot;&quot; : &quot;&quot;);</span>
<span class="udiff-line-added">+         map.set (&quot;WWW-Authenticate&quot;, authString);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * called for each incoming request to verify the
       * given name and password in the context of this
       * Authenticator&#39;s realm. Any caching of credentials
       * must be done by the implementation of this method
</pre>
<center><a href="../../../../../../../jdk.hotspot.agent/windows/native/libsaproc/sawindbg.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="HttpExchange.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>