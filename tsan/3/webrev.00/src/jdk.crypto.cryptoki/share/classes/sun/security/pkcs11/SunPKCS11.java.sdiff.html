<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/share/classes/sun/security/pkcs11/SunPKCS11.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="P11Util.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="wrapper/CK_MECHANISM.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/classes/sun/security/pkcs11/SunPKCS11.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  45 import sun.security.util.Debug;
  46 import sun.security.util.ResourcesMgr;
  47 import static sun.security.util.SecurityConstants.PROVIDER_VER;
  48 
  49 import sun.security.pkcs11.Secmod.*;
  50 
  51 import sun.security.pkcs11.wrapper.*;
  52 import static sun.security.pkcs11.wrapper.PKCS11Constants.*;
  53 
  54 /**
  55  * PKCS#11 provider main class.
  56  *
  57  * @author  Andreas Sterbenz
  58  * @since   1.5
  59  */
  60 public final class SunPKCS11 extends AuthProvider {
  61 
  62     private static final long serialVersionUID = -1354835039035306505L;
  63 
  64     static final Debug debug = Debug.getInstance(&quot;sunpkcs11&quot;);
<span class="line-removed">  65 </span>
  66     // the PKCS11 object through which we make the native calls
  67     final PKCS11 p11;
  68 
  69     // configuration information
  70     final Config config;
  71 
  72     // id of the PKCS#11 slot we are using
  73     final long slotID;
  74 
  75     private CallbackHandler pHandler;
  76     private final Object LOCK_HANDLER = new Object();
  77 
  78     final boolean removable;
  79 
  80     final Secmod.Module nssModule;
  81 
  82     final boolean nssUseSecmodTrust;
  83 
  84     private volatile Token token;
  85 
</pre>
<hr />
<pre>
 499     private final static String KA  = &quot;KeyAgreement&quot;;
 500 
 501     private final static String KS  = &quot;KeyStore&quot;;
 502 
 503     private final static String SR  = &quot;SecureRandom&quot;;
 504 
 505     static {
 506         // names of all the implementation classes
 507         // use local variables, only used here
 508         String P11Digest           = &quot;sun.security.pkcs11.P11Digest&quot;;
 509         String P11MAC              = &quot;sun.security.pkcs11.P11MAC&quot;;
 510         String P11KeyPairGenerator = &quot;sun.security.pkcs11.P11KeyPairGenerator&quot;;
 511         String P11KeyGenerator     = &quot;sun.security.pkcs11.P11KeyGenerator&quot;;
 512         String P11RSAKeyFactory    = &quot;sun.security.pkcs11.P11RSAKeyFactory&quot;;
 513         String P11DSAKeyFactory    = &quot;sun.security.pkcs11.P11DSAKeyFactory&quot;;
 514         String P11DHKeyFactory     = &quot;sun.security.pkcs11.P11DHKeyFactory&quot;;
 515         String P11KeyAgreement     = &quot;sun.security.pkcs11.P11KeyAgreement&quot;;
 516         String P11SecretKeyFactory = &quot;sun.security.pkcs11.P11SecretKeyFactory&quot;;
 517         String P11Cipher           = &quot;sun.security.pkcs11.P11Cipher&quot;;
 518         String P11RSACipher        = &quot;sun.security.pkcs11.P11RSACipher&quot;;

 519         String P11Signature        = &quot;sun.security.pkcs11.P11Signature&quot;;

 520 
 521         // XXX register all aliases
 522 
 523         d(MD, &quot;MD2&quot;,            P11Digest,
 524                 m(CKM_MD2));
 525         d(MD, &quot;MD5&quot;,            P11Digest,
 526                 m(CKM_MD5));
 527         d(MD, &quot;SHA1&quot;,           P11Digest,
 528                 s(&quot;SHA&quot;, &quot;SHA-1&quot;, &quot;1.3.14.3.2.26&quot;, &quot;OID.1.3.14.3.2.26&quot;),
 529                 m(CKM_SHA_1));
 530 
 531         d(MD, &quot;SHA-224&quot;,        P11Digest,
 532                 s(&quot;2.16.840.1.101.3.4.2.4&quot;, &quot;OID.2.16.840.1.101.3.4.2.4&quot;),
 533                 m(CKM_SHA224));
 534         d(MD, &quot;SHA-256&quot;,        P11Digest,
 535                 s(&quot;2.16.840.1.101.3.4.2.1&quot;, &quot;OID.2.16.840.1.101.3.4.2.1&quot;),
 536                 m(CKM_SHA256));
 537         d(MD, &quot;SHA-384&quot;,        P11Digest,
 538                 s(&quot;2.16.840.1.101.3.4.2.2&quot;, &quot;OID.2.16.840.1.101.3.4.2.2&quot;),
 539                 m(CKM_SHA384));
 540         d(MD, &quot;SHA-512&quot;,        P11Digest,
 541                 s(&quot;2.16.840.1.101.3.4.2.3&quot;, &quot;OID.2.16.840.1.101.3.4.2.3&quot;),
 542                 m(CKM_SHA512));






 543 
 544         d(MAC, &quot;HmacMD5&quot;,       P11MAC,
 545                 m(CKM_MD5_HMAC));
 546         d(MAC, &quot;HmacSHA1&quot;,      P11MAC,
 547                 s(&quot;1.2.840.113549.2.7&quot;, &quot;OID.1.2.840.113549.2.7&quot;),
 548                 m(CKM_SHA_1_HMAC));
 549         d(MAC, &quot;HmacSHA224&quot;,    P11MAC,
 550                 s(&quot;1.2.840.113549.2.8&quot;, &quot;OID.1.2.840.113549.2.8&quot;),
 551                 m(CKM_SHA224_HMAC));
 552         d(MAC, &quot;HmacSHA256&quot;,    P11MAC,
 553                 s(&quot;1.2.840.113549.2.9&quot;, &quot;OID.1.2.840.113549.2.9&quot;),
 554                 m(CKM_SHA256_HMAC));
 555         d(MAC, &quot;HmacSHA384&quot;,    P11MAC,
 556                 s(&quot;1.2.840.113549.2.10&quot;, &quot;OID.1.2.840.113549.2.10&quot;),
 557                 m(CKM_SHA384_HMAC));
 558         d(MAC, &quot;HmacSHA512&quot;,    P11MAC,
 559                 s(&quot;1.2.840.113549.2.11&quot;, &quot;OID.1.2.840.113549.2.11&quot;),
 560                 m(CKM_SHA512_HMAC));







 561         d(MAC, &quot;SslMacMD5&quot;,     P11MAC,
 562                 m(CKM_SSL3_MD5_MAC));
 563         d(MAC, &quot;SslMacSHA1&quot;,    P11MAC,
 564                 m(CKM_SSL3_SHA1_MAC));
 565 
 566         d(KPG, &quot;RSA&quot;,           P11KeyPairGenerator,

 567                 m(CKM_RSA_PKCS_KEY_PAIR_GEN));

 568         d(KPG, &quot;DSA&quot;,           P11KeyPairGenerator,
 569                 s(&quot;1.3.14.3.2.12&quot;, &quot;1.2.840.10040.4.1&quot;, &quot;OID.1.2.840.10040.4.1&quot;),
 570                 m(CKM_DSA_KEY_PAIR_GEN));
 571         d(KPG, &quot;DH&quot;,            P11KeyPairGenerator,    s(&quot;DiffieHellman&quot;),
 572                 m(CKM_DH_PKCS_KEY_PAIR_GEN));
 573         d(KPG, &quot;EC&quot;,            P11KeyPairGenerator,
 574                 m(CKM_EC_KEY_PAIR_GEN));
 575 
 576         d(KG,  &quot;ARCFOUR&quot;,       P11KeyGenerator,        s(&quot;RC4&quot;),
 577                 m(CKM_RC4_KEY_GEN));
 578         d(KG,  &quot;DES&quot;,           P11KeyGenerator,
 579                 m(CKM_DES_KEY_GEN));
 580         d(KG,  &quot;DESede&quot;,        P11KeyGenerator,
 581                 m(CKM_DES3_KEY_GEN, CKM_DES2_KEY_GEN));
 582         d(KG,  &quot;AES&quot;,           P11KeyGenerator,
 583                 m(CKM_AES_KEY_GEN));
 584         d(KG,  &quot;Blowfish&quot;,      P11KeyGenerator,
 585                 m(CKM_BLOWFISH_KEY_GEN));
 586 
 587         // register (Secret)KeyFactories if there are any mechanisms
 588         // for a particular algorithm that we support
 589         d(KF, &quot;RSA&quot;,            P11RSAKeyFactory,

 590                 m(CKM_RSA_PKCS_KEY_PAIR_GEN, CKM_RSA_PKCS, CKM_RSA_X_509));
 591         d(KF, &quot;DSA&quot;,            P11DSAKeyFactory,
 592                 s(&quot;1.3.14.3.2.12&quot;, &quot;1.2.840.10040.4.1&quot;, &quot;OID.1.2.840.10040.4.1&quot;),
 593                 m(CKM_DSA_KEY_PAIR_GEN, CKM_DSA, CKM_DSA_SHA1));
 594         d(KF, &quot;DH&quot;,             P11DHKeyFactory,        s(&quot;DiffieHellman&quot;),
 595                 m(CKM_DH_PKCS_KEY_PAIR_GEN, CKM_DH_PKCS_DERIVE));
 596         d(KF, &quot;EC&quot;,             P11DHKeyFactory,
 597                 m(CKM_EC_KEY_PAIR_GEN, CKM_ECDH1_DERIVE,
 598                     CKM_ECDSA, CKM_ECDSA_SHA1));
 599 
 600         // AlgorithmParameters for EC.
 601         // Only needed until we have an EC implementation in the SUN provider.
 602         d(AGP, &quot;EC&quot;,            &quot;sun.security.util.ECParameters&quot;,
<span class="line-modified"> 603                                                 s(&quot;1.2.840.10045.2.1&quot;),</span>
 604                 m(CKM_EC_KEY_PAIR_GEN, CKM_ECDH1_DERIVE,
 605                     CKM_ECDSA, CKM_ECDSA_SHA1));
 606 




 607         d(KA, &quot;DH&quot;,             P11KeyAgreement,        s(&quot;DiffieHellman&quot;),
 608                 m(CKM_DH_PKCS_DERIVE));
 609         d(KA, &quot;ECDH&quot;,           &quot;sun.security.pkcs11.P11ECDHKeyAgreement&quot;,
 610                 m(CKM_ECDH1_DERIVE));
 611 
 612         d(SKF, &quot;ARCFOUR&quot;,       P11SecretKeyFactory,    s(&quot;RC4&quot;),
 613                 m(CKM_RC4));
 614         d(SKF, &quot;DES&quot;,           P11SecretKeyFactory,
 615                 m(CKM_DES_CBC));
 616         d(SKF, &quot;DESede&quot;,        P11SecretKeyFactory,
 617                 m(CKM_DES3_CBC));
 618         d(SKF, &quot;AES&quot;,           P11SecretKeyFactory,
 619                 s(&quot;2.16.840.1.101.3.4.1&quot;, &quot;OID.2.16.840.1.101.3.4.1&quot;),
 620                 m(CKM_AES_CBC));
 621         d(SKF, &quot;Blowfish&quot;,      P11SecretKeyFactory,
 622                 m(CKM_BLOWFISH_CBC));
 623 
 624         // XXX attributes for Ciphers (supported modes, padding)
 625         d(CIP, &quot;ARCFOUR&quot;,                       P11Cipher,      s(&quot;RC4&quot;),
 626                 m(CKM_RC4));
</pre>
<hr />
<pre>
 652         d(CIP, &quot;AES_256/CBC/NoPadding&quot;,          P11Cipher,
 653                 s(&quot;2.16.840.1.101.3.4.1.42&quot;, &quot;OID.2.16.840.1.101.3.4.1.42&quot;),
 654                 m(CKM_AES_CBC));
 655         d(CIP, &quot;AES/CBC/PKCS5Padding&quot;,          P11Cipher,
 656                 m(CKM_AES_CBC_PAD, CKM_AES_CBC));
 657         d(CIP, &quot;AES/ECB/NoPadding&quot;,             P11Cipher,
 658                 m(CKM_AES_ECB));
 659         d(CIP, &quot;AES_128/ECB/NoPadding&quot;,          P11Cipher,
 660                 s(&quot;2.16.840.1.101.3.4.1.1&quot;, &quot;OID.2.16.840.1.101.3.4.1.1&quot;),
 661                 m(CKM_AES_ECB));
 662         d(CIP, &quot;AES_192/ECB/NoPadding&quot;,          P11Cipher,
 663                 s(&quot;2.16.840.1.101.3.4.1.21&quot;, &quot;OID.2.16.840.1.101.3.4.1.21&quot;),
 664                 m(CKM_AES_ECB));
 665         d(CIP, &quot;AES_256/ECB/NoPadding&quot;,          P11Cipher,
 666                 s(&quot;2.16.840.1.101.3.4.1.41&quot;, &quot;OID.2.16.840.1.101.3.4.1.41&quot;),
 667                 m(CKM_AES_ECB));
 668         d(CIP, &quot;AES/ECB/PKCS5Padding&quot;,          P11Cipher,      s(&quot;AES&quot;),
 669                 m(CKM_AES_ECB));
 670         d(CIP, &quot;AES/CTR/NoPadding&quot;,             P11Cipher,
 671                 m(CKM_AES_CTR));













 672         d(CIP, &quot;Blowfish/CBC/NoPadding&quot;,        P11Cipher,
 673                 m(CKM_BLOWFISH_CBC));
 674         d(CIP, &quot;Blowfish/CBC/PKCS5Padding&quot;,     P11Cipher,
 675                 m(CKM_BLOWFISH_CBC));
 676 
<span class="line-removed"> 677         // XXX RSA_X_509, RSA_OAEP not yet supported</span>
 678         d(CIP, &quot;RSA/ECB/PKCS1Padding&quot;,          P11RSACipher,   s(&quot;RSA&quot;),
 679                 m(CKM_RSA_PKCS));
 680         d(CIP, &quot;RSA/ECB/NoPadding&quot;,             P11RSACipher,
 681                 m(CKM_RSA_X_509));
 682 
 683         d(SIG, &quot;RawDSA&quot;,        P11Signature,   s(&quot;NONEwithDSA&quot;),
 684                 m(CKM_DSA));
 685         d(SIG, &quot;DSA&quot;,           P11Signature,
 686                 s(&quot;SHA1withDSA&quot;, &quot;1.3.14.3.2.13&quot;, &quot;1.3.14.3.2.27&quot;,
 687                   &quot;1.2.840.10040.4.3&quot;, &quot;OID.1.2.840.10040.4.3&quot;),
 688                 m(CKM_DSA_SHA1, CKM_DSA));












 689         d(SIG, &quot;RawDSAinP1363Format&quot;,   P11Signature,
 690                 s(&quot;NONEwithDSAinP1363Format&quot;),
 691                 m(CKM_DSA));
 692         d(SIG, &quot;DSAinP1363Format&quot;,      P11Signature,
 693                 s(&quot;SHA1withDSAinP1363Format&quot;),
 694                 m(CKM_DSA_SHA1, CKM_DSA));

 695         d(SIG, &quot;NONEwithECDSA&quot;, P11Signature,
 696                 m(CKM_ECDSA));
 697         d(SIG, &quot;SHA1withECDSA&quot;, P11Signature,
 698                 s(&quot;ECDSA&quot;, &quot;1.2.840.10045.4.1&quot;, &quot;OID.1.2.840.10045.4.1&quot;),
 699                 m(CKM_ECDSA_SHA1, CKM_ECDSA));
 700         d(SIG, &quot;SHA224withECDSA&quot;,       P11Signature,
 701                 s(&quot;1.2.840.10045.4.3.1&quot;, &quot;OID.1.2.840.10045.4.3.1&quot;),
 702                 m(CKM_ECDSA));
 703         d(SIG, &quot;SHA256withECDSA&quot;,       P11Signature,
 704                 s(&quot;1.2.840.10045.4.3.2&quot;, &quot;OID.1.2.840.10045.4.3.2&quot;),
 705                 m(CKM_ECDSA));
 706         d(SIG, &quot;SHA384withECDSA&quot;,       P11Signature,
 707                 s(&quot;1.2.840.10045.4.3.3&quot;, &quot;OID.1.2.840.10045.4.3.3&quot;),
 708                 m(CKM_ECDSA));
 709         d(SIG, &quot;SHA512withECDSA&quot;,       P11Signature,
 710                 s(&quot;1.2.840.10045.4.3.4&quot;, &quot;OID.1.2.840.10045.4.3.4&quot;),
 711                 m(CKM_ECDSA));
 712         d(SIG, &quot;NONEwithECDSAinP1363Format&quot;,   P11Signature,
 713                 m(CKM_ECDSA));
 714         d(SIG, &quot;SHA1withECDSAinP1363Format&quot;,   P11Signature,
</pre>
<hr />
<pre>
 726                 m(CKM_MD2_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 727         d(SIG, &quot;MD5withRSA&quot;,    P11Signature,
 728                 s(&quot;1.2.840.113549.1.1.4&quot;, &quot;OID.1.2.840.113549.1.1.4&quot;),
 729                 m(CKM_MD5_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 730         d(SIG, &quot;SHA1withRSA&quot;,   P11Signature,
 731                 s(&quot;1.2.840.113549.1.1.5&quot;, &quot;OID.1.2.840.113549.1.1.5&quot;,
 732                   &quot;1.3.14.3.2.29&quot;),
 733                 m(CKM_SHA1_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 734         d(SIG, &quot;SHA224withRSA&quot;, P11Signature,
 735                 s(&quot;1.2.840.113549.1.1.14&quot;, &quot;OID.1.2.840.113549.1.1.14&quot;),
 736                 m(CKM_SHA224_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 737         d(SIG, &quot;SHA256withRSA&quot;, P11Signature,
 738                 s(&quot;1.2.840.113549.1.1.11&quot;, &quot;OID.1.2.840.113549.1.1.11&quot;),
 739                 m(CKM_SHA256_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 740         d(SIG, &quot;SHA384withRSA&quot;, P11Signature,
 741                 s(&quot;1.2.840.113549.1.1.12&quot;, &quot;OID.1.2.840.113549.1.1.12&quot;),
 742                 m(CKM_SHA384_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 743         d(SIG, &quot;SHA512withRSA&quot;, P11Signature,
 744                 s(&quot;1.2.840.113549.1.1.13&quot;, &quot;OID.1.2.840.113549.1.1.13&quot;),
 745                 m(CKM_SHA512_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));













 746 
 747         d(KG, &quot;SunTlsRsaPremasterSecret&quot;,
 748                     &quot;sun.security.pkcs11.P11TlsRsaPremasterSecretGenerator&quot;,
 749                     s(&quot;SunTls12RsaPremasterSecret&quot;),
 750                 m(CKM_SSL3_PRE_MASTER_KEY_GEN, CKM_TLS_PRE_MASTER_KEY_GEN));
 751         d(KG, &quot;SunTlsMasterSecret&quot;,
 752                     &quot;sun.security.pkcs11.P11TlsMasterSecretGenerator&quot;,
 753                 m(CKM_SSL3_MASTER_KEY_DERIVE, CKM_TLS_MASTER_KEY_DERIVE,
 754                     CKM_SSL3_MASTER_KEY_DERIVE_DH,
 755                     CKM_TLS_MASTER_KEY_DERIVE_DH));
 756         d(KG, &quot;SunTls12MasterSecret&quot;,
 757                 &quot;sun.security.pkcs11.P11TlsMasterSecretGenerator&quot;,
 758             m(CKM_TLS12_MASTER_KEY_DERIVE, CKM_TLS12_MASTER_KEY_DERIVE_DH));
 759         d(KG, &quot;SunTlsKeyMaterial&quot;,
 760                     &quot;sun.security.pkcs11.P11TlsKeyMaterialGenerator&quot;,
 761                 m(CKM_SSL3_KEY_AND_MAC_DERIVE, CKM_TLS_KEY_AND_MAC_DERIVE));
 762         d(KG, &quot;SunTls12KeyMaterial&quot;,
 763                 &quot;sun.security.pkcs11.P11TlsKeyMaterialGenerator&quot;,
 764             m(CKM_TLS12_KEY_AND_MAC_DERIVE));
 765         d(KG, &quot;SunTlsPrf&quot;, &quot;sun.security.pkcs11.P11TlsPrfGenerator&quot;,
</pre>
<hr />
<pre>
 836     }
 837 
 838     // destroy the token. Called if we detect that it has been removed
 839     synchronized void uninitToken(Token token) {
 840         if (this.token != token) {
 841             // mismatch, our token must already be destroyed
 842             return;
 843         }
 844         destroyPoller();
 845         this.token = null;
 846         // unregister all algorithms
 847         AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() {
 848             public Object run() {
 849                 clear();
 850                 return null;
 851             }
 852         });
 853         createPoller();
 854     }
 855 



















 856     // test if a token is present and initialize this provider for it if so.
 857     // does nothing if no token is found
 858     // called from constructor and by poller
 859     private void initToken(CK_SLOT_INFO slotInfo) throws PKCS11Exception {
 860         if (slotInfo == null) {
 861             slotInfo = p11.C_GetSlotInfo(slotID);
 862         }
 863         if (removable &amp;&amp; (slotInfo.flags &amp; CKF_TOKEN_PRESENT) == 0) {
 864             createPoller();
 865             return;
 866         }
 867         destroyPoller();
 868         boolean showInfo = config.getShowInfo();
 869         if (showInfo) {
 870             System.out.println(&quot;Slot info for slot &quot; + slotID + &quot;:&quot;);
 871             System.out.println(slotInfo);
 872         }
 873         final Token token = new Token(this);
 874         if (showInfo) {
 875             System.out.println
 876                 (&quot;Token info for token in slot &quot; + slotID + &quot;:&quot;);
 877             System.out.println(token.tokenInfo);
 878         }
 879         long[] supportedMechanisms = p11.C_GetMechanismList(slotID);
 880 
 881         // Create a map from the various Descriptors to the &quot;most
 882         // preferred&quot; mechanism that was defined during the
 883         // static initialization.  For example, DES/CBC/PKCS5Padding
 884         // could be mapped to CKM_DES_CBC_PAD or CKM_DES_CBC.  Prefer
 885         // the earliest entry.  When asked for &quot;DES/CBC/PKCS5Padding&quot;, we
 886         // return a CKM_DES_CBC_PAD.
 887         final Map&lt;Descriptor,Integer&gt; supportedAlgs =
 888                                         new HashMap&lt;Descriptor,Integer&gt;();

 889         for (int i = 0; i &lt; supportedMechanisms.length; i++) {
 890             long longMech = supportedMechanisms[i];
<span class="line-modified"> 891             boolean isEnabled = config.isEnabled(longMech);</span>
 892             if (showInfo) {
<span class="line-removed"> 893                 CK_MECHANISM_INFO mechInfo =</span>
<span class="line-removed"> 894                         p11.C_GetMechanismInfo(slotID, longMech);</span>
 895                 System.out.println(&quot;Mechanism &quot; +
<span class="line-modified"> 896                         Functions.getMechanismName(longMech) + &quot;:&quot;);</span>
<span class="line-modified"> 897                 if (isEnabled == false) {</span>





 898                     System.out.println(&quot;DISABLED in configuration&quot;);
 899                 }
<span class="line-modified"> 900                 System.out.println(mechInfo);</span>
 901             }
<span class="line-modified"> 902             if (isEnabled == false) {</span>



 903                 continue;
 904             }

 905             // we do not know of mechs with the upper 32 bits set
 906             if (longMech &gt;&gt;&gt; 32 != 0) {



 907                 continue;
 908             }
 909             int mech = (int)longMech;
 910             Integer integerMech = Integer.valueOf(mech);
 911             List&lt;Descriptor&gt; ds = descriptors.get(integerMech);
 912             if (ds == null) {
 913                 continue;
 914             }
 915             for (Descriptor d : ds) {
 916                 Integer oldMech = supportedAlgs.get(d);
 917                 if (oldMech == null) {
 918                     supportedAlgs.put(d, integerMech);
 919                     continue;
 920                 }
 921                 // See if there is something &quot;more preferred&quot;
 922                 // than what we currently have in the supportedAlgs
 923                 // map.
 924                 int intOldMech = oldMech.intValue();
 925                 for (int j = 0; j &lt; d.mechanisms.length; j++) {
 926                     int nextMech = d.mechanisms[j];
</pre>
<hr />
<pre>
 991                 throws NoSuchAlgorithmException {
 992             if (token.isValid() == false) {
 993                 throw new NoSuchAlgorithmException(&quot;Token has been removed&quot;);
 994             }
 995             try {
 996                 return newInstance0(param);
 997             } catch (PKCS11Exception e) {
 998                 throw new NoSuchAlgorithmException(e);
 999             }
1000         }
1001 
1002         public Object newInstance0(Object param) throws
1003                 PKCS11Exception, NoSuchAlgorithmException {
1004             String algorithm = getAlgorithm();
1005             String type = getType();
1006             if (type == MD) {
1007                 return new P11Digest(token, algorithm, mechanism);
1008             } else if (type == CIP) {
1009                 if (algorithm.startsWith(&quot;RSA&quot;)) {
1010                     return new P11RSACipher(token, algorithm, mechanism);


1011                 } else {
1012                     return new P11Cipher(token, algorithm, mechanism);
1013                 }
1014             } else if (type == SIG) {
<span class="line-modified">1015                 return new P11Signature(token, algorithm, mechanism);</span>




1016             } else if (type == MAC) {
1017                 return new P11Mac(token, algorithm, mechanism);
1018             } else if (type == KPG) {
1019                 return new P11KeyPairGenerator(token, algorithm, mechanism);
1020             } else if (type == KA) {
1021                 if (algorithm.equals(&quot;ECDH&quot;)) {
1022                     return new P11ECDHKeyAgreement(token, algorithm, mechanism);
1023                 } else {
1024                     return new P11KeyAgreement(token, algorithm, mechanism);
1025                 }
1026             } else if (type == KF) {
1027                 return token.getKeyFactory(algorithm);
1028             } else if (type == SKF) {
1029                 return new P11SecretKeyFactory(token, algorithm);
1030             } else if (type == KG) {
1031                 // reference equality
1032                 if (algorithm == &quot;SunTlsRsaPremasterSecret&quot;) {
1033                     return new P11TlsRsaPremasterSecretGenerator(
1034                         token, algorithm, mechanism);
1035                 } else if (algorithm == &quot;SunTlsMasterSecret&quot;
1036                         || algorithm == &quot;SunTls12MasterSecret&quot;) {
1037                     return new P11TlsMasterSecretGenerator(
1038                         token, algorithm, mechanism);
1039                 } else if (algorithm == &quot;SunTlsKeyMaterial&quot;
1040                         || algorithm == &quot;SunTls12KeyMaterial&quot;) {
1041                     return new P11TlsKeyMaterialGenerator(
1042                         token, algorithm, mechanism);
1043                 } else if (algorithm == &quot;SunTlsPrf&quot;
1044                         || algorithm == &quot;SunTls12Prf&quot;) {
1045                     return new P11TlsPrfGenerator(token, algorithm, mechanism);
1046                 } else {
1047                     return new P11KeyGenerator(token, algorithm, mechanism);
1048                 }
1049             } else if (type == SR) {
1050                 return token.getRandom();
1051             } else if (type == KS) {
1052                 return token.getKeyStore();
1053             } else if (type == AGP) {
<span class="line-modified">1054                 return new sun.security.util.ECParameters();</span>







1055             } else {
1056                 throw new NoSuchAlgorithmException(&quot;Unknown type: &quot; + type);
1057             }
1058         }
1059 
1060         public boolean supportsParameter(Object param) {
1061             if ((param == null) || (token.isValid() == false)) {
1062                 return false;
1063             }
1064             if (param instanceof Key == false) {
1065                 throw new InvalidParameterException(&quot;Parameter must be a Key&quot;);
1066             }
1067             String algorithm = getAlgorithm();
1068             String type = getType();
1069             Key key = (Key)param;
1070             String keyAlgorithm = key.getAlgorithm();
1071             // RSA signatures and cipher
1072             if (((type == CIP) &amp;&amp; algorithm.startsWith(&quot;RSA&quot;))
<span class="line-modified">1073                     || (type == SIG) &amp;&amp; algorithm.endsWith(&quot;RSA&quot;)) {</span>
1074                 if (keyAlgorithm.equals(&quot;RSA&quot;) == false) {
1075                     return false;
1076                 }
1077                 return isLocalKey(key)
1078                         || (key instanceof RSAPrivateKey)
1079                         || (key instanceof RSAPublicKey);
1080             }
1081             // EC
1082             if (((type == KA) &amp;&amp; algorithm.equals(&quot;ECDH&quot;))
1083                     || ((type == SIG) &amp;&amp; algorithm.contains(&quot;ECDSA&quot;))) {
1084                 if (keyAlgorithm.equals(&quot;EC&quot;) == false) {
1085                     return false;
1086                 }
1087                 return isLocalKey(key)
1088                         || (key instanceof ECPrivateKey)
1089                         || (key instanceof ECPublicKey);
1090             }
1091             // DSA signatures
1092             if ((type == SIG) &amp;&amp; algorithm.contains(&quot;DSA&quot;) &amp;&amp;
1093                     !algorithm.contains(&quot;ECDSA&quot;)) {
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
  45 import sun.security.util.Debug;
  46 import sun.security.util.ResourcesMgr;
  47 import static sun.security.util.SecurityConstants.PROVIDER_VER;
  48 
  49 import sun.security.pkcs11.Secmod.*;
  50 
  51 import sun.security.pkcs11.wrapper.*;
  52 import static sun.security.pkcs11.wrapper.PKCS11Constants.*;
  53 
  54 /**
  55  * PKCS#11 provider main class.
  56  *
  57  * @author  Andreas Sterbenz
  58  * @since   1.5
  59  */
  60 public final class SunPKCS11 extends AuthProvider {
  61 
  62     private static final long serialVersionUID = -1354835039035306505L;
  63 
  64     static final Debug debug = Debug.getInstance(&quot;sunpkcs11&quot;);

  65     // the PKCS11 object through which we make the native calls
  66     final PKCS11 p11;
  67 
  68     // configuration information
  69     final Config config;
  70 
  71     // id of the PKCS#11 slot we are using
  72     final long slotID;
  73 
  74     private CallbackHandler pHandler;
  75     private final Object LOCK_HANDLER = new Object();
  76 
  77     final boolean removable;
  78 
  79     final Secmod.Module nssModule;
  80 
  81     final boolean nssUseSecmodTrust;
  82 
  83     private volatile Token token;
  84 
</pre>
<hr />
<pre>
 498     private final static String KA  = &quot;KeyAgreement&quot;;
 499 
 500     private final static String KS  = &quot;KeyStore&quot;;
 501 
 502     private final static String SR  = &quot;SecureRandom&quot;;
 503 
 504     static {
 505         // names of all the implementation classes
 506         // use local variables, only used here
 507         String P11Digest           = &quot;sun.security.pkcs11.P11Digest&quot;;
 508         String P11MAC              = &quot;sun.security.pkcs11.P11MAC&quot;;
 509         String P11KeyPairGenerator = &quot;sun.security.pkcs11.P11KeyPairGenerator&quot;;
 510         String P11KeyGenerator     = &quot;sun.security.pkcs11.P11KeyGenerator&quot;;
 511         String P11RSAKeyFactory    = &quot;sun.security.pkcs11.P11RSAKeyFactory&quot;;
 512         String P11DSAKeyFactory    = &quot;sun.security.pkcs11.P11DSAKeyFactory&quot;;
 513         String P11DHKeyFactory     = &quot;sun.security.pkcs11.P11DHKeyFactory&quot;;
 514         String P11KeyAgreement     = &quot;sun.security.pkcs11.P11KeyAgreement&quot;;
 515         String P11SecretKeyFactory = &quot;sun.security.pkcs11.P11SecretKeyFactory&quot;;
 516         String P11Cipher           = &quot;sun.security.pkcs11.P11Cipher&quot;;
 517         String P11RSACipher        = &quot;sun.security.pkcs11.P11RSACipher&quot;;
<span class="line-added"> 518         String P11AEADCipher       = &quot;sun.security.pkcs11.P11AEADCipher&quot;;</span>
 519         String P11Signature        = &quot;sun.security.pkcs11.P11Signature&quot;;
<span class="line-added"> 520         String P11PSSSignature     = &quot;sun.security.pkcs11.P11PSSSignature&quot;;</span>
 521 
 522         // XXX register all aliases
 523 
 524         d(MD, &quot;MD2&quot;,            P11Digest,
 525                 m(CKM_MD2));
 526         d(MD, &quot;MD5&quot;,            P11Digest,
 527                 m(CKM_MD5));
 528         d(MD, &quot;SHA1&quot;,           P11Digest,
 529                 s(&quot;SHA&quot;, &quot;SHA-1&quot;, &quot;1.3.14.3.2.26&quot;, &quot;OID.1.3.14.3.2.26&quot;),
 530                 m(CKM_SHA_1));
 531 
 532         d(MD, &quot;SHA-224&quot;,        P11Digest,
 533                 s(&quot;2.16.840.1.101.3.4.2.4&quot;, &quot;OID.2.16.840.1.101.3.4.2.4&quot;),
 534                 m(CKM_SHA224));
 535         d(MD, &quot;SHA-256&quot;,        P11Digest,
 536                 s(&quot;2.16.840.1.101.3.4.2.1&quot;, &quot;OID.2.16.840.1.101.3.4.2.1&quot;),
 537                 m(CKM_SHA256));
 538         d(MD, &quot;SHA-384&quot;,        P11Digest,
 539                 s(&quot;2.16.840.1.101.3.4.2.2&quot;, &quot;OID.2.16.840.1.101.3.4.2.2&quot;),
 540                 m(CKM_SHA384));
 541         d(MD, &quot;SHA-512&quot;,        P11Digest,
 542                 s(&quot;2.16.840.1.101.3.4.2.3&quot;, &quot;OID.2.16.840.1.101.3.4.2.3&quot;),
 543                 m(CKM_SHA512));
<span class="line-added"> 544         d(MD, &quot;SHA-512/224&quot;,        P11Digest,</span>
<span class="line-added"> 545                 s(&quot;2.16.840.1.101.3.4.2.5&quot;, &quot;OID.2.16.840.1.101.3.4.2.5&quot;),</span>
<span class="line-added"> 546                 m(CKM_SHA512_224));</span>
<span class="line-added"> 547         d(MD, &quot;SHA-512/256&quot;,        P11Digest,</span>
<span class="line-added"> 548                 s(&quot;2.16.840.1.101.3.4.2.6&quot;, &quot;OID.2.16.840.1.101.3.4.2.6&quot;),</span>
<span class="line-added"> 549                 m(CKM_SHA512_256));</span>
 550 
 551         d(MAC, &quot;HmacMD5&quot;,       P11MAC,
 552                 m(CKM_MD5_HMAC));
 553         d(MAC, &quot;HmacSHA1&quot;,      P11MAC,
 554                 s(&quot;1.2.840.113549.2.7&quot;, &quot;OID.1.2.840.113549.2.7&quot;),
 555                 m(CKM_SHA_1_HMAC));
 556         d(MAC, &quot;HmacSHA224&quot;,    P11MAC,
 557                 s(&quot;1.2.840.113549.2.8&quot;, &quot;OID.1.2.840.113549.2.8&quot;),
 558                 m(CKM_SHA224_HMAC));
 559         d(MAC, &quot;HmacSHA256&quot;,    P11MAC,
 560                 s(&quot;1.2.840.113549.2.9&quot;, &quot;OID.1.2.840.113549.2.9&quot;),
 561                 m(CKM_SHA256_HMAC));
 562         d(MAC, &quot;HmacSHA384&quot;,    P11MAC,
 563                 s(&quot;1.2.840.113549.2.10&quot;, &quot;OID.1.2.840.113549.2.10&quot;),
 564                 m(CKM_SHA384_HMAC));
 565         d(MAC, &quot;HmacSHA512&quot;,    P11MAC,
 566                 s(&quot;1.2.840.113549.2.11&quot;, &quot;OID.1.2.840.113549.2.11&quot;),
 567                 m(CKM_SHA512_HMAC));
<span class="line-added"> 568         d(MAC, &quot;HmacSHA512/224&quot;,    P11MAC,</span>
<span class="line-added"> 569                 s(&quot;1.2.840.113549.2.12&quot;, &quot;OID.1.2.840.113549.2.12&quot;),</span>
<span class="line-added"> 570                 m(CKM_SHA512_224_HMAC));</span>
<span class="line-added"> 571         d(MAC, &quot;HmacSHA512/256&quot;,    P11MAC,</span>
<span class="line-added"> 572                 s(&quot;1.2.840.113549.2.13&quot;, &quot;OID.1.2.840.113549.2.13&quot;),</span>
<span class="line-added"> 573                 m(CKM_SHA512_256_HMAC));</span>
<span class="line-added"> 574 </span>
 575         d(MAC, &quot;SslMacMD5&quot;,     P11MAC,
 576                 m(CKM_SSL3_MD5_MAC));
 577         d(MAC, &quot;SslMacSHA1&quot;,    P11MAC,
 578                 m(CKM_SSL3_SHA1_MAC));
 579 
 580         d(KPG, &quot;RSA&quot;,           P11KeyPairGenerator,
<span class="line-added"> 581                 s(&quot;1.2.840.113549.1.1&quot;, &quot;OID.1.2.840.113549.1.1&quot;),</span>
 582                 m(CKM_RSA_PKCS_KEY_PAIR_GEN));
<span class="line-added"> 583 </span>
 584         d(KPG, &quot;DSA&quot;,           P11KeyPairGenerator,
 585                 s(&quot;1.3.14.3.2.12&quot;, &quot;1.2.840.10040.4.1&quot;, &quot;OID.1.2.840.10040.4.1&quot;),
 586                 m(CKM_DSA_KEY_PAIR_GEN));
 587         d(KPG, &quot;DH&quot;,            P11KeyPairGenerator,    s(&quot;DiffieHellman&quot;),
 588                 m(CKM_DH_PKCS_KEY_PAIR_GEN));
 589         d(KPG, &quot;EC&quot;,            P11KeyPairGenerator,
 590                 m(CKM_EC_KEY_PAIR_GEN));
 591 
 592         d(KG,  &quot;ARCFOUR&quot;,       P11KeyGenerator,        s(&quot;RC4&quot;),
 593                 m(CKM_RC4_KEY_GEN));
 594         d(KG,  &quot;DES&quot;,           P11KeyGenerator,
 595                 m(CKM_DES_KEY_GEN));
 596         d(KG,  &quot;DESede&quot;,        P11KeyGenerator,
 597                 m(CKM_DES3_KEY_GEN, CKM_DES2_KEY_GEN));
 598         d(KG,  &quot;AES&quot;,           P11KeyGenerator,
 599                 m(CKM_AES_KEY_GEN));
 600         d(KG,  &quot;Blowfish&quot;,      P11KeyGenerator,
 601                 m(CKM_BLOWFISH_KEY_GEN));
 602 
 603         // register (Secret)KeyFactories if there are any mechanisms
 604         // for a particular algorithm that we support
 605         d(KF, &quot;RSA&quot;,            P11RSAKeyFactory,
<span class="line-added"> 606                 s(&quot;1.2.840.113549.1.1&quot;, &quot;OID.1.2.840.113549.1.1&quot;),</span>
 607                 m(CKM_RSA_PKCS_KEY_PAIR_GEN, CKM_RSA_PKCS, CKM_RSA_X_509));
 608         d(KF, &quot;DSA&quot;,            P11DSAKeyFactory,
 609                 s(&quot;1.3.14.3.2.12&quot;, &quot;1.2.840.10040.4.1&quot;, &quot;OID.1.2.840.10040.4.1&quot;),
 610                 m(CKM_DSA_KEY_PAIR_GEN, CKM_DSA, CKM_DSA_SHA1));
 611         d(KF, &quot;DH&quot;,             P11DHKeyFactory,        s(&quot;DiffieHellman&quot;),
 612                 m(CKM_DH_PKCS_KEY_PAIR_GEN, CKM_DH_PKCS_DERIVE));
 613         d(KF, &quot;EC&quot;,             P11DHKeyFactory,
 614                 m(CKM_EC_KEY_PAIR_GEN, CKM_ECDH1_DERIVE,
 615                     CKM_ECDSA, CKM_ECDSA_SHA1));
 616 
 617         // AlgorithmParameters for EC.
 618         // Only needed until we have an EC implementation in the SUN provider.
 619         d(AGP, &quot;EC&quot;,            &quot;sun.security.util.ECParameters&quot;,
<span class="line-modified"> 620                 s(&quot;1.2.840.10045.2.1&quot;),</span>
 621                 m(CKM_EC_KEY_PAIR_GEN, CKM_ECDH1_DERIVE,
 622                     CKM_ECDSA, CKM_ECDSA_SHA1));
 623 
<span class="line-added"> 624 </span>
<span class="line-added"> 625         d(AGP, &quot;GCM&quot;,            &quot;sun.security.util.GCMParameters&quot;,</span>
<span class="line-added"> 626                 m(CKM_AES_GCM));</span>
<span class="line-added"> 627 </span>
 628         d(KA, &quot;DH&quot;,             P11KeyAgreement,        s(&quot;DiffieHellman&quot;),
 629                 m(CKM_DH_PKCS_DERIVE));
 630         d(KA, &quot;ECDH&quot;,           &quot;sun.security.pkcs11.P11ECDHKeyAgreement&quot;,
 631                 m(CKM_ECDH1_DERIVE));
 632 
 633         d(SKF, &quot;ARCFOUR&quot;,       P11SecretKeyFactory,    s(&quot;RC4&quot;),
 634                 m(CKM_RC4));
 635         d(SKF, &quot;DES&quot;,           P11SecretKeyFactory,
 636                 m(CKM_DES_CBC));
 637         d(SKF, &quot;DESede&quot;,        P11SecretKeyFactory,
 638                 m(CKM_DES3_CBC));
 639         d(SKF, &quot;AES&quot;,           P11SecretKeyFactory,
 640                 s(&quot;2.16.840.1.101.3.4.1&quot;, &quot;OID.2.16.840.1.101.3.4.1&quot;),
 641                 m(CKM_AES_CBC));
 642         d(SKF, &quot;Blowfish&quot;,      P11SecretKeyFactory,
 643                 m(CKM_BLOWFISH_CBC));
 644 
 645         // XXX attributes for Ciphers (supported modes, padding)
 646         d(CIP, &quot;ARCFOUR&quot;,                       P11Cipher,      s(&quot;RC4&quot;),
 647                 m(CKM_RC4));
</pre>
<hr />
<pre>
 673         d(CIP, &quot;AES_256/CBC/NoPadding&quot;,          P11Cipher,
 674                 s(&quot;2.16.840.1.101.3.4.1.42&quot;, &quot;OID.2.16.840.1.101.3.4.1.42&quot;),
 675                 m(CKM_AES_CBC));
 676         d(CIP, &quot;AES/CBC/PKCS5Padding&quot;,          P11Cipher,
 677                 m(CKM_AES_CBC_PAD, CKM_AES_CBC));
 678         d(CIP, &quot;AES/ECB/NoPadding&quot;,             P11Cipher,
 679                 m(CKM_AES_ECB));
 680         d(CIP, &quot;AES_128/ECB/NoPadding&quot;,          P11Cipher,
 681                 s(&quot;2.16.840.1.101.3.4.1.1&quot;, &quot;OID.2.16.840.1.101.3.4.1.1&quot;),
 682                 m(CKM_AES_ECB));
 683         d(CIP, &quot;AES_192/ECB/NoPadding&quot;,          P11Cipher,
 684                 s(&quot;2.16.840.1.101.3.4.1.21&quot;, &quot;OID.2.16.840.1.101.3.4.1.21&quot;),
 685                 m(CKM_AES_ECB));
 686         d(CIP, &quot;AES_256/ECB/NoPadding&quot;,          P11Cipher,
 687                 s(&quot;2.16.840.1.101.3.4.1.41&quot;, &quot;OID.2.16.840.1.101.3.4.1.41&quot;),
 688                 m(CKM_AES_ECB));
 689         d(CIP, &quot;AES/ECB/PKCS5Padding&quot;,          P11Cipher,      s(&quot;AES&quot;),
 690                 m(CKM_AES_ECB));
 691         d(CIP, &quot;AES/CTR/NoPadding&quot;,             P11Cipher,
 692                 m(CKM_AES_CTR));
<span class="line-added"> 693 </span>
<span class="line-added"> 694         d(CIP, &quot;AES/GCM/NoPadding&quot;,             P11AEADCipher,</span>
<span class="line-added"> 695                 m(CKM_AES_GCM));</span>
<span class="line-added"> 696         d(CIP, &quot;AES_128/GCM/NoPadding&quot;,          P11AEADCipher,</span>
<span class="line-added"> 697                 s(&quot;2.16.840.1.101.3.4.1.6&quot;, &quot;OID.2.16.840.1.101.3.4.1.6&quot;),</span>
<span class="line-added"> 698                 m(CKM_AES_GCM));</span>
<span class="line-added"> 699         d(CIP, &quot;AES_192/GCM/NoPadding&quot;,          P11AEADCipher,</span>
<span class="line-added"> 700                 s(&quot;2.16.840.1.101.3.4.1.26&quot;, &quot;OID.2.16.840.1.101.3.4.1.26&quot;),</span>
<span class="line-added"> 701                 m(CKM_AES_GCM));</span>
<span class="line-added"> 702         d(CIP, &quot;AES_256/GCM/NoPadding&quot;,          P11AEADCipher,</span>
<span class="line-added"> 703                 s(&quot;2.16.840.1.101.3.4.1.46&quot;, &quot;OID.2.16.840.1.101.3.4.1.46&quot;),</span>
<span class="line-added"> 704                 m(CKM_AES_GCM));</span>
<span class="line-added"> 705 </span>
 706         d(CIP, &quot;Blowfish/CBC/NoPadding&quot;,        P11Cipher,
 707                 m(CKM_BLOWFISH_CBC));
 708         d(CIP, &quot;Blowfish/CBC/PKCS5Padding&quot;,     P11Cipher,
 709                 m(CKM_BLOWFISH_CBC));
 710 

 711         d(CIP, &quot;RSA/ECB/PKCS1Padding&quot;,          P11RSACipher,   s(&quot;RSA&quot;),
 712                 m(CKM_RSA_PKCS));
 713         d(CIP, &quot;RSA/ECB/NoPadding&quot;,             P11RSACipher,
 714                 m(CKM_RSA_X_509));
 715 
 716         d(SIG, &quot;RawDSA&quot;,        P11Signature,   s(&quot;NONEwithDSA&quot;),
 717                 m(CKM_DSA));
 718         d(SIG, &quot;DSA&quot;,           P11Signature,
 719                 s(&quot;SHA1withDSA&quot;, &quot;1.3.14.3.2.13&quot;, &quot;1.3.14.3.2.27&quot;,
 720                   &quot;1.2.840.10040.4.3&quot;, &quot;OID.1.2.840.10040.4.3&quot;),
 721                 m(CKM_DSA_SHA1, CKM_DSA));
<span class="line-added"> 722         d(SIG, &quot;SHA224withDSA&quot;, P11Signature,</span>
<span class="line-added"> 723                 s(&quot;2.16.840.1.101.3.4.3.1&quot;, &quot;OID.2.16.840.1.101.3.4.3.1&quot;),</span>
<span class="line-added"> 724                 m(CKM_DSA_SHA224));</span>
<span class="line-added"> 725         d(SIG, &quot;SHA256withDSA&quot;, P11Signature,</span>
<span class="line-added"> 726                 s(&quot;2.16.840.1.101.3.4.3.2&quot;, &quot;OID.2.16.840.1.101.3.4.3.2&quot;),</span>
<span class="line-added"> 727                 m(CKM_DSA_SHA256));</span>
<span class="line-added"> 728         d(SIG, &quot;SHA384withDSA&quot;, P11Signature,</span>
<span class="line-added"> 729                 s(&quot;2.16.840.1.101.3.4.3.3&quot;, &quot;OID.2.16.840.1.101.3.4.3.3&quot;),</span>
<span class="line-added"> 730                 m(CKM_DSA_SHA384));</span>
<span class="line-added"> 731         d(SIG, &quot;SHA512withDSA&quot;, P11Signature,</span>
<span class="line-added"> 732                 s(&quot;2.16.840.1.101.3.4.3.4&quot;, &quot;OID.2.16.840.1.101.3.4.3.4&quot;),</span>
<span class="line-added"> 733                 m(CKM_DSA_SHA512));</span>
 734         d(SIG, &quot;RawDSAinP1363Format&quot;,   P11Signature,
 735                 s(&quot;NONEwithDSAinP1363Format&quot;),
 736                 m(CKM_DSA));
 737         d(SIG, &quot;DSAinP1363Format&quot;,      P11Signature,
 738                 s(&quot;SHA1withDSAinP1363Format&quot;),
 739                 m(CKM_DSA_SHA1, CKM_DSA));
<span class="line-added"> 740 </span>
 741         d(SIG, &quot;NONEwithECDSA&quot;, P11Signature,
 742                 m(CKM_ECDSA));
 743         d(SIG, &quot;SHA1withECDSA&quot;, P11Signature,
 744                 s(&quot;ECDSA&quot;, &quot;1.2.840.10045.4.1&quot;, &quot;OID.1.2.840.10045.4.1&quot;),
 745                 m(CKM_ECDSA_SHA1, CKM_ECDSA));
 746         d(SIG, &quot;SHA224withECDSA&quot;,       P11Signature,
 747                 s(&quot;1.2.840.10045.4.3.1&quot;, &quot;OID.1.2.840.10045.4.3.1&quot;),
 748                 m(CKM_ECDSA));
 749         d(SIG, &quot;SHA256withECDSA&quot;,       P11Signature,
 750                 s(&quot;1.2.840.10045.4.3.2&quot;, &quot;OID.1.2.840.10045.4.3.2&quot;),
 751                 m(CKM_ECDSA));
 752         d(SIG, &quot;SHA384withECDSA&quot;,       P11Signature,
 753                 s(&quot;1.2.840.10045.4.3.3&quot;, &quot;OID.1.2.840.10045.4.3.3&quot;),
 754                 m(CKM_ECDSA));
 755         d(SIG, &quot;SHA512withECDSA&quot;,       P11Signature,
 756                 s(&quot;1.2.840.10045.4.3.4&quot;, &quot;OID.1.2.840.10045.4.3.4&quot;),
 757                 m(CKM_ECDSA));
 758         d(SIG, &quot;NONEwithECDSAinP1363Format&quot;,   P11Signature,
 759                 m(CKM_ECDSA));
 760         d(SIG, &quot;SHA1withECDSAinP1363Format&quot;,   P11Signature,
</pre>
<hr />
<pre>
 772                 m(CKM_MD2_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 773         d(SIG, &quot;MD5withRSA&quot;,    P11Signature,
 774                 s(&quot;1.2.840.113549.1.1.4&quot;, &quot;OID.1.2.840.113549.1.1.4&quot;),
 775                 m(CKM_MD5_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 776         d(SIG, &quot;SHA1withRSA&quot;,   P11Signature,
 777                 s(&quot;1.2.840.113549.1.1.5&quot;, &quot;OID.1.2.840.113549.1.1.5&quot;,
 778                   &quot;1.3.14.3.2.29&quot;),
 779                 m(CKM_SHA1_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 780         d(SIG, &quot;SHA224withRSA&quot;, P11Signature,
 781                 s(&quot;1.2.840.113549.1.1.14&quot;, &quot;OID.1.2.840.113549.1.1.14&quot;),
 782                 m(CKM_SHA224_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 783         d(SIG, &quot;SHA256withRSA&quot;, P11Signature,
 784                 s(&quot;1.2.840.113549.1.1.11&quot;, &quot;OID.1.2.840.113549.1.1.11&quot;),
 785                 m(CKM_SHA256_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 786         d(SIG, &quot;SHA384withRSA&quot;, P11Signature,
 787                 s(&quot;1.2.840.113549.1.1.12&quot;, &quot;OID.1.2.840.113549.1.1.12&quot;),
 788                 m(CKM_SHA384_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
 789         d(SIG, &quot;SHA512withRSA&quot;, P11Signature,
 790                 s(&quot;1.2.840.113549.1.1.13&quot;, &quot;OID.1.2.840.113549.1.1.13&quot;),
 791                 m(CKM_SHA512_RSA_PKCS, CKM_RSA_PKCS, CKM_RSA_X_509));
<span class="line-added"> 792         d(SIG, &quot;RSASSA-PSS&quot;, P11PSSSignature,</span>
<span class="line-added"> 793                 s(&quot;1.2.840.113549.1.1.10&quot;, &quot;OID.1.2.840.113549.1.1.10&quot;),</span>
<span class="line-added"> 794                 m(CKM_RSA_PKCS_PSS));</span>
<span class="line-added"> 795         d(SIG, &quot;SHA1withRSASSA-PSS&quot;, P11PSSSignature,</span>
<span class="line-added"> 796                 m(CKM_SHA1_RSA_PKCS_PSS));</span>
<span class="line-added"> 797         d(SIG, &quot;SHA224withRSASSA-PSS&quot;, P11PSSSignature,</span>
<span class="line-added"> 798                 m(CKM_SHA224_RSA_PKCS_PSS));</span>
<span class="line-added"> 799         d(SIG, &quot;SHA256withRSASSA-PSS&quot;, P11PSSSignature,</span>
<span class="line-added"> 800                 m(CKM_SHA256_RSA_PKCS_PSS));</span>
<span class="line-added"> 801         d(SIG, &quot;SHA384withRSASSA-PSS&quot;, P11PSSSignature,</span>
<span class="line-added"> 802                 m(CKM_SHA384_RSA_PKCS_PSS));</span>
<span class="line-added"> 803         d(SIG, &quot;SHA512withRSASSA-PSS&quot;, P11PSSSignature,</span>
<span class="line-added"> 804                 m(CKM_SHA512_RSA_PKCS_PSS));</span>
 805 
 806         d(KG, &quot;SunTlsRsaPremasterSecret&quot;,
 807                     &quot;sun.security.pkcs11.P11TlsRsaPremasterSecretGenerator&quot;,
 808                     s(&quot;SunTls12RsaPremasterSecret&quot;),
 809                 m(CKM_SSL3_PRE_MASTER_KEY_GEN, CKM_TLS_PRE_MASTER_KEY_GEN));
 810         d(KG, &quot;SunTlsMasterSecret&quot;,
 811                     &quot;sun.security.pkcs11.P11TlsMasterSecretGenerator&quot;,
 812                 m(CKM_SSL3_MASTER_KEY_DERIVE, CKM_TLS_MASTER_KEY_DERIVE,
 813                     CKM_SSL3_MASTER_KEY_DERIVE_DH,
 814                     CKM_TLS_MASTER_KEY_DERIVE_DH));
 815         d(KG, &quot;SunTls12MasterSecret&quot;,
 816                 &quot;sun.security.pkcs11.P11TlsMasterSecretGenerator&quot;,
 817             m(CKM_TLS12_MASTER_KEY_DERIVE, CKM_TLS12_MASTER_KEY_DERIVE_DH));
 818         d(KG, &quot;SunTlsKeyMaterial&quot;,
 819                     &quot;sun.security.pkcs11.P11TlsKeyMaterialGenerator&quot;,
 820                 m(CKM_SSL3_KEY_AND_MAC_DERIVE, CKM_TLS_KEY_AND_MAC_DERIVE));
 821         d(KG, &quot;SunTls12KeyMaterial&quot;,
 822                 &quot;sun.security.pkcs11.P11TlsKeyMaterialGenerator&quot;,
 823             m(CKM_TLS12_KEY_AND_MAC_DERIVE));
 824         d(KG, &quot;SunTlsPrf&quot;, &quot;sun.security.pkcs11.P11TlsPrfGenerator&quot;,
</pre>
<hr />
<pre>
 895     }
 896 
 897     // destroy the token. Called if we detect that it has been removed
 898     synchronized void uninitToken(Token token) {
 899         if (this.token != token) {
 900             // mismatch, our token must already be destroyed
 901             return;
 902         }
 903         destroyPoller();
 904         this.token = null;
 905         // unregister all algorithms
 906         AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() {
 907             public Object run() {
 908                 clear();
 909                 return null;
 910             }
 911         });
 912         createPoller();
 913     }
 914 
<span class="line-added"> 915     private static boolean isLegacy(CK_MECHANISM_INFO mechInfo)</span>
<span class="line-added"> 916             throws PKCS11Exception {</span>
<span class="line-added"> 917         // assume full support if no mech info available</span>
<span class="line-added"> 918         // For vendor-specific mechanisms, often no mech info is provided</span>
<span class="line-added"> 919         boolean partialSupport = false;</span>
<span class="line-added"> 920 </span>
<span class="line-added"> 921         if (mechInfo != null) {</span>
<span class="line-added"> 922             if ((mechInfo.flags &amp; CKF_DECRYPT) != 0) {</span>
<span class="line-added"> 923                 // non-legacy cipher mechs should support encryption</span>
<span class="line-added"> 924                 partialSupport |= ((mechInfo.flags &amp; CKF_ENCRYPT) == 0);</span>
<span class="line-added"> 925             }</span>
<span class="line-added"> 926             if ((mechInfo.flags &amp; CKF_VERIFY) != 0) {</span>
<span class="line-added"> 927                 // non-legacy signature mechs should support signing</span>
<span class="line-added"> 928                 partialSupport |= ((mechInfo.flags &amp; CKF_SIGN) == 0);</span>
<span class="line-added"> 929             }</span>
<span class="line-added"> 930         }</span>
<span class="line-added"> 931         return partialSupport;</span>
<span class="line-added"> 932     }</span>
<span class="line-added"> 933 </span>
 934     // test if a token is present and initialize this provider for it if so.
 935     // does nothing if no token is found
 936     // called from constructor and by poller
 937     private void initToken(CK_SLOT_INFO slotInfo) throws PKCS11Exception {
 938         if (slotInfo == null) {
 939             slotInfo = p11.C_GetSlotInfo(slotID);
 940         }
 941         if (removable &amp;&amp; (slotInfo.flags &amp; CKF_TOKEN_PRESENT) == 0) {
 942             createPoller();
 943             return;
 944         }
 945         destroyPoller();
 946         boolean showInfo = config.getShowInfo();
 947         if (showInfo) {
 948             System.out.println(&quot;Slot info for slot &quot; + slotID + &quot;:&quot;);
 949             System.out.println(slotInfo);
 950         }
 951         final Token token = new Token(this);
 952         if (showInfo) {
 953             System.out.println
 954                 (&quot;Token info for token in slot &quot; + slotID + &quot;:&quot;);
 955             System.out.println(token.tokenInfo);
 956         }
 957         long[] supportedMechanisms = p11.C_GetMechanismList(slotID);
 958 
 959         // Create a map from the various Descriptors to the &quot;most
 960         // preferred&quot; mechanism that was defined during the
 961         // static initialization.  For example, DES/CBC/PKCS5Padding
 962         // could be mapped to CKM_DES_CBC_PAD or CKM_DES_CBC.  Prefer
 963         // the earliest entry.  When asked for &quot;DES/CBC/PKCS5Padding&quot;, we
 964         // return a CKM_DES_CBC_PAD.
 965         final Map&lt;Descriptor,Integer&gt; supportedAlgs =
 966                                         new HashMap&lt;Descriptor,Integer&gt;();
<span class="line-added"> 967 </span>
 968         for (int i = 0; i &lt; supportedMechanisms.length; i++) {
 969             long longMech = supportedMechanisms[i];
<span class="line-modified"> 970             CK_MECHANISM_INFO mechInfo = token.getMechanismInfo(longMech);</span>
 971             if (showInfo) {


 972                 System.out.println(&quot;Mechanism &quot; +
<span class="line-modified"> 973                     Functions.getMechanismName(longMech) + &quot;:&quot;);</span>
<span class="line-modified"> 974                 System.out.println(mechInfo == null?</span>
<span class="line-added"> 975                     (Constants.INDENT + &quot;info n/a&quot;) :</span>
<span class="line-added"> 976                     mechInfo);</span>
<span class="line-added"> 977             }</span>
<span class="line-added"> 978             if (!config.isEnabled(longMech)) {</span>
<span class="line-added"> 979                 if (showInfo) {</span>
 980                     System.out.println(&quot;DISABLED in configuration&quot;);
 981                 }
<span class="line-modified"> 982                 continue;</span>
 983             }
<span class="line-modified"> 984             if (isLegacy(mechInfo)) {</span>
<span class="line-added"> 985                 if (showInfo) {</span>
<span class="line-added"> 986                     System.out.println(&quot;DISABLED due to legacy&quot;);</span>
<span class="line-added"> 987                 }</span>
 988                 continue;
 989             }
<span class="line-added"> 990 </span>
 991             // we do not know of mechs with the upper 32 bits set
 992             if (longMech &gt;&gt;&gt; 32 != 0) {
<span class="line-added"> 993                 if (showInfo) {</span>
<span class="line-added"> 994                     System.out.println(&quot;DISABLED due to unknown mech value&quot;);</span>
<span class="line-added"> 995                 }</span>
 996                 continue;
 997             }
 998             int mech = (int)longMech;
 999             Integer integerMech = Integer.valueOf(mech);
1000             List&lt;Descriptor&gt; ds = descriptors.get(integerMech);
1001             if (ds == null) {
1002                 continue;
1003             }
1004             for (Descriptor d : ds) {
1005                 Integer oldMech = supportedAlgs.get(d);
1006                 if (oldMech == null) {
1007                     supportedAlgs.put(d, integerMech);
1008                     continue;
1009                 }
1010                 // See if there is something &quot;more preferred&quot;
1011                 // than what we currently have in the supportedAlgs
1012                 // map.
1013                 int intOldMech = oldMech.intValue();
1014                 for (int j = 0; j &lt; d.mechanisms.length; j++) {
1015                     int nextMech = d.mechanisms[j];
</pre>
<hr />
<pre>
1080                 throws NoSuchAlgorithmException {
1081             if (token.isValid() == false) {
1082                 throw new NoSuchAlgorithmException(&quot;Token has been removed&quot;);
1083             }
1084             try {
1085                 return newInstance0(param);
1086             } catch (PKCS11Exception e) {
1087                 throw new NoSuchAlgorithmException(e);
1088             }
1089         }
1090 
1091         public Object newInstance0(Object param) throws
1092                 PKCS11Exception, NoSuchAlgorithmException {
1093             String algorithm = getAlgorithm();
1094             String type = getType();
1095             if (type == MD) {
1096                 return new P11Digest(token, algorithm, mechanism);
1097             } else if (type == CIP) {
1098                 if (algorithm.startsWith(&quot;RSA&quot;)) {
1099                     return new P11RSACipher(token, algorithm, mechanism);
<span class="line-added">1100                 } else if (algorithm.endsWith(&quot;GCM/NoPadding&quot;)) {</span>
<span class="line-added">1101                     return new P11AEADCipher(token, algorithm, mechanism);</span>
1102                 } else {
1103                     return new P11Cipher(token, algorithm, mechanism);
1104                 }
1105             } else if (type == SIG) {
<span class="line-modified">1106                 if (algorithm.indexOf(&quot;RSASSA-PSS&quot;) != -1) {</span>
<span class="line-added">1107                     return new P11PSSSignature(token, algorithm, mechanism);</span>
<span class="line-added">1108                 } else {</span>
<span class="line-added">1109                     return new P11Signature(token, algorithm, mechanism);</span>
<span class="line-added">1110                 }</span>
1111             } else if (type == MAC) {
1112                 return new P11Mac(token, algorithm, mechanism);
1113             } else if (type == KPG) {
1114                 return new P11KeyPairGenerator(token, algorithm, mechanism);
1115             } else if (type == KA) {
1116                 if (algorithm.equals(&quot;ECDH&quot;)) {
1117                     return new P11ECDHKeyAgreement(token, algorithm, mechanism);
1118                 } else {
1119                     return new P11KeyAgreement(token, algorithm, mechanism);
1120                 }
1121             } else if (type == KF) {
1122                 return token.getKeyFactory(algorithm);
1123             } else if (type == SKF) {
1124                 return new P11SecretKeyFactory(token, algorithm);
1125             } else if (type == KG) {
1126                 // reference equality
1127                 if (algorithm == &quot;SunTlsRsaPremasterSecret&quot;) {
1128                     return new P11TlsRsaPremasterSecretGenerator(
1129                         token, algorithm, mechanism);
1130                 } else if (algorithm == &quot;SunTlsMasterSecret&quot;
1131                         || algorithm == &quot;SunTls12MasterSecret&quot;) {
1132                     return new P11TlsMasterSecretGenerator(
1133                         token, algorithm, mechanism);
1134                 } else if (algorithm == &quot;SunTlsKeyMaterial&quot;
1135                         || algorithm == &quot;SunTls12KeyMaterial&quot;) {
1136                     return new P11TlsKeyMaterialGenerator(
1137                         token, algorithm, mechanism);
1138                 } else if (algorithm == &quot;SunTlsPrf&quot;
1139                         || algorithm == &quot;SunTls12Prf&quot;) {
1140                     return new P11TlsPrfGenerator(token, algorithm, mechanism);
1141                 } else {
1142                     return new P11KeyGenerator(token, algorithm, mechanism);
1143                 }
1144             } else if (type == SR) {
1145                 return token.getRandom();
1146             } else if (type == KS) {
1147                 return token.getKeyStore();
1148             } else if (type == AGP) {
<span class="line-modified">1149                 if (algorithm == &quot;EC&quot;) {</span>
<span class="line-added">1150                     return new sun.security.util.ECParameters();</span>
<span class="line-added">1151                 } else if (algorithm == &quot;GCM&quot;) {</span>
<span class="line-added">1152                     return new sun.security.util.GCMParameters();</span>
<span class="line-added">1153                 } else {</span>
<span class="line-added">1154                     throw new NoSuchAlgorithmException(&quot;Unsupported algorithm: &quot;</span>
<span class="line-added">1155                             + algorithm);</span>
<span class="line-added">1156                 }</span>
1157             } else {
1158                 throw new NoSuchAlgorithmException(&quot;Unknown type: &quot; + type);
1159             }
1160         }
1161 
1162         public boolean supportsParameter(Object param) {
1163             if ((param == null) || (token.isValid() == false)) {
1164                 return false;
1165             }
1166             if (param instanceof Key == false) {
1167                 throw new InvalidParameterException(&quot;Parameter must be a Key&quot;);
1168             }
1169             String algorithm = getAlgorithm();
1170             String type = getType();
1171             Key key = (Key)param;
1172             String keyAlgorithm = key.getAlgorithm();
1173             // RSA signatures and cipher
1174             if (((type == CIP) &amp;&amp; algorithm.startsWith(&quot;RSA&quot;))
<span class="line-modified">1175                     || (type == SIG) &amp;&amp; (algorithm.indexOf(&quot;RSA&quot;) != -1)) {</span>
1176                 if (keyAlgorithm.equals(&quot;RSA&quot;) == false) {
1177                     return false;
1178                 }
1179                 return isLocalKey(key)
1180                         || (key instanceof RSAPrivateKey)
1181                         || (key instanceof RSAPublicKey);
1182             }
1183             // EC
1184             if (((type == KA) &amp;&amp; algorithm.equals(&quot;ECDH&quot;))
1185                     || ((type == SIG) &amp;&amp; algorithm.contains(&quot;ECDSA&quot;))) {
1186                 if (keyAlgorithm.equals(&quot;EC&quot;) == false) {
1187                     return false;
1188                 }
1189                 return isLocalKey(key)
1190                         || (key instanceof ECPrivateKey)
1191                         || (key instanceof ECPublicKey);
1192             }
1193             // DSA signatures
1194             if ((type == SIG) &amp;&amp; algorithm.contains(&quot;DSA&quot;) &amp;&amp;
1195                     !algorithm.contains(&quot;ECDSA&quot;)) {
</pre>
</td>
</tr>
</table>
<center><a href="P11Util.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="wrapper/CK_MECHANISM.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>