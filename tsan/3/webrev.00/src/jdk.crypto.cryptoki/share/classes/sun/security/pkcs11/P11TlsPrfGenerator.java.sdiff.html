<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/share/classes/sun/security/pkcs11/P11TlsPrfGenerator.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="P11Signature.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="P11Util.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/classes/sun/security/pkcs11/P11TlsPrfGenerator.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.pkcs11;
 27 
 28 import java.security.*;
 29 import java.security.spec.AlgorithmParameterSpec;
 30 
 31 import javax.crypto.*;
 32 import javax.crypto.spec.*;
 33 


 34 import sun.security.internal.spec.TlsPrfParameterSpec;
 35 
 36 import static sun.security.pkcs11.TemplateManager.*;
 37 import sun.security.pkcs11.wrapper.*;
 38 import static sun.security.pkcs11.wrapper.PKCS11Constants.*;
 39 
 40 /**
 41  * KeyGenerator for the TLS PRF. Note that although the PRF is used in a number
 42  * of places during the handshake, this class is usually only used to calculate
 43  * the Finished messages. The reason is that for those other uses more specific
 44  * PKCS#11 mechanisms have been defined (CKM_SSL3_MASTER_KEY_DERIVE, etc.).
 45  *
 46  * &lt;p&gt;This class supports the CKM_TLS_PRF mechanism from PKCS#11 v2.20 and
 47  * the older NSS private mechanism.
 48  *
 49  * @author  Andreas Sterbenz
 50  * @since   1.6
 51  */
 52 final class P11TlsPrfGenerator extends KeyGeneratorSpi {
 53 
</pre>
<hr />
<pre>
150                 try {
151                     session = token.getOpSession();
152                     token.p11.C_SignInit(session.id(),
153                             new CK_MECHANISM(mechanism, params), keyID);
154                     token.p11.C_SignUpdate(session.id(), 0, seed, 0, seed.length);
155                     byte[] out = token.p11.C_SignFinal
156                                         (session.id(), spec.getOutputLength());
157                     return new SecretKeySpec(out, &quot;TlsPrf&quot;);
158                 } catch (PKCS11Exception e) {
159                     throw new ProviderException(&quot;Could not calculate PRF&quot;, e);
160                 } finally {
161                     p11Key.releaseKeyID();
162                     token.releaseSession(session);
163                 }
164             } else {
165                 throw new ProviderException(&quot;Only Finished message authentication code&quot;+
166                                             &quot; generation supported for TLS 1.2.&quot;);
167             }
168         }
169 
<span class="line-modified">170         byte[] label = P11Util.getBytesUTF8(spec.getLabel());</span>
171 
172         if (mechanism == CKM_NSS_TLS_PRF_GENERAL) {
173             Session session = null;
174             long keyID = p11Key.getKeyID();
175             try {
176                 session = token.getOpSession();
177                 token.p11.C_SignInit
178                     (session.id(), new CK_MECHANISM(mechanism), keyID);
179                 token.p11.C_SignUpdate(session.id(), 0, label, 0, label.length);
180                 token.p11.C_SignUpdate(session.id(), 0, seed, 0, seed.length);
181                 byte[] out = token.p11.C_SignFinal
182                                     (session.id(), spec.getOutputLength());
183                 return new SecretKeySpec(out, &quot;TlsPrf&quot;);
184             } catch (PKCS11Exception e) {
185                 throw new ProviderException(&quot;Could not calculate PRF&quot;, e);
186             } finally {
187                 p11Key.releaseKeyID();
188                 token.releaseSession(session);
189             }
190         }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package sun.security.pkcs11;
 27 
 28 import java.security.*;
 29 import java.security.spec.AlgorithmParameterSpec;
 30 
 31 import javax.crypto.*;
 32 import javax.crypto.spec.*;
 33 
<span class="line-added"> 34 import static java.nio.charset.StandardCharsets.UTF_8;</span>
<span class="line-added"> 35 </span>
 36 import sun.security.internal.spec.TlsPrfParameterSpec;
 37 
 38 import static sun.security.pkcs11.TemplateManager.*;
 39 import sun.security.pkcs11.wrapper.*;
 40 import static sun.security.pkcs11.wrapper.PKCS11Constants.*;
 41 
 42 /**
 43  * KeyGenerator for the TLS PRF. Note that although the PRF is used in a number
 44  * of places during the handshake, this class is usually only used to calculate
 45  * the Finished messages. The reason is that for those other uses more specific
 46  * PKCS#11 mechanisms have been defined (CKM_SSL3_MASTER_KEY_DERIVE, etc.).
 47  *
 48  * &lt;p&gt;This class supports the CKM_TLS_PRF mechanism from PKCS#11 v2.20 and
 49  * the older NSS private mechanism.
 50  *
 51  * @author  Andreas Sterbenz
 52  * @since   1.6
 53  */
 54 final class P11TlsPrfGenerator extends KeyGeneratorSpi {
 55 
</pre>
<hr />
<pre>
152                 try {
153                     session = token.getOpSession();
154                     token.p11.C_SignInit(session.id(),
155                             new CK_MECHANISM(mechanism, params), keyID);
156                     token.p11.C_SignUpdate(session.id(), 0, seed, 0, seed.length);
157                     byte[] out = token.p11.C_SignFinal
158                                         (session.id(), spec.getOutputLength());
159                     return new SecretKeySpec(out, &quot;TlsPrf&quot;);
160                 } catch (PKCS11Exception e) {
161                     throw new ProviderException(&quot;Could not calculate PRF&quot;, e);
162                 } finally {
163                     p11Key.releaseKeyID();
164                     token.releaseSession(session);
165                 }
166             } else {
167                 throw new ProviderException(&quot;Only Finished message authentication code&quot;+
168                                             &quot; generation supported for TLS 1.2.&quot;);
169             }
170         }
171 
<span class="line-modified">172         byte[] label = spec.getLabel().getBytes(UTF_8);</span>
173 
174         if (mechanism == CKM_NSS_TLS_PRF_GENERAL) {
175             Session session = null;
176             long keyID = p11Key.getKeyID();
177             try {
178                 session = token.getOpSession();
179                 token.p11.C_SignInit
180                     (session.id(), new CK_MECHANISM(mechanism), keyID);
181                 token.p11.C_SignUpdate(session.id(), 0, label, 0, label.length);
182                 token.p11.C_SignUpdate(session.id(), 0, seed, 0, seed.length);
183                 byte[] out = token.p11.C_SignFinal
184                                     (session.id(), spec.getOutputLength());
185                 return new SecretKeySpec(out, &quot;TlsPrf&quot;);
186             } catch (PKCS11Exception e) {
187                 throw new ProviderException(&quot;Could not calculate PRF&quot;, e);
188             } finally {
189                 p11Key.releaseKeyID();
190                 token.releaseSession(session);
191             }
192         }
</pre>
</td>
</tr>
</table>
<center><a href="P11Signature.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="P11Util.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>