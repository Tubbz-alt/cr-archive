<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_sessmgmt.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="p11_objmgmt.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_sign.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_sessmgmt.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2013, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
100         if (notifyEncapsulation == NULL) {
101             throwOutOfMemoryError(env, 0);
102             return 0L;
103         }
104         notifyEncapsulation-&gt;jApplicationData = (jApplication != NULL)
105                 ? (*env)-&gt;NewGlobalRef(env, jApplication)
106                 : NULL;
107         notifyEncapsulation-&gt;jNotifyObject = (*env)-&gt;NewGlobalRef(env, jNotify);
108         ckpApplication = notifyEncapsulation;
109         ckNotify = (CK_NOTIFY) &amp;notifyCallback;
110     } else {
111         ckpApplication = NULL_PTR;
112         ckNotify = NULL_PTR;
113     }
114 #else
115         ckpApplication = NULL_PTR;
116         ckNotify = NULL_PTR;
117 #endif /* NO_CALLBACKS */
118 
119     TRACE0(&quot;DEBUG: C_OpenSession&quot;);
<span class="line-modified">120     TRACE1(&quot;, slotID=%u&quot;, ckSlotID);</span>
<span class="line-modified">121     TRACE1(&quot;, flags=%x&quot;, ckFlags);</span>
122     TRACE0(&quot; ... &quot;);
123 
124     rv = (*ckpFunctions-&gt;C_OpenSession)(ckSlotID, ckFlags, ckpApplication, ckNotify, &amp;ckSessionHandle);
125     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) {
126 #ifndef NO_CALLBACKS
127         if (notifyEncapsulation != NULL) {
128             if (notifyEncapsulation-&gt;jApplicationData != NULL) {
129                 (*env)-&gt;DeleteGlobalRef(env, jApplication);
130             }
131             (*env)-&gt;DeleteGlobalRef(env, jNotify);
132             free(notifyEncapsulation);
133         }
134 #endif /* NO_CALLBACKS */
135         return 0L;
136     }
137 
138     TRACE0(&quot;got session&quot;);
<span class="line-modified">139     TRACE1(&quot;, SessionHandle=%u&quot;, ckSessionHandle);</span>
140     TRACE0(&quot; ... &quot;);
141 
142     jSessionHandle = ckULongToJLong(ckSessionHandle);
143 
144 #ifndef NO_CALLBACKS
145     if (notifyEncapsulation != NULL) {
146         /* store the notifyEncapsulation to enable later cleanup */
147         putNotifyEntry(env, ckSessionHandle, notifyEncapsulation);
148     }
149 #endif /* NO_CALLBACKS */
150 
151     TRACE0(&quot;FINISHED\n&quot;);
152 
153     return jSessionHandle ;
154 }
155 #endif
156 
157 #ifdef P11_ENABLE_C_CLOSESESSION
158 /*
159  * Class:     sun_security_pkcs11_wrapper_PKCS11
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
100         if (notifyEncapsulation == NULL) {
101             throwOutOfMemoryError(env, 0);
102             return 0L;
103         }
104         notifyEncapsulation-&gt;jApplicationData = (jApplication != NULL)
105                 ? (*env)-&gt;NewGlobalRef(env, jApplication)
106                 : NULL;
107         notifyEncapsulation-&gt;jNotifyObject = (*env)-&gt;NewGlobalRef(env, jNotify);
108         ckpApplication = notifyEncapsulation;
109         ckNotify = (CK_NOTIFY) &amp;notifyCallback;
110     } else {
111         ckpApplication = NULL_PTR;
112         ckNotify = NULL_PTR;
113     }
114 #else
115         ckpApplication = NULL_PTR;
116         ckNotify = NULL_PTR;
117 #endif /* NO_CALLBACKS */
118 
119     TRACE0(&quot;DEBUG: C_OpenSession&quot;);
<span class="line-modified">120     TRACE1(&quot;, slotID=%lu&quot;, ckSlotID);</span>
<span class="line-modified">121     TRACE1(&quot;, flags=%lu&quot;, (unsigned long) ckFlags);</span>
122     TRACE0(&quot; ... &quot;);
123 
124     rv = (*ckpFunctions-&gt;C_OpenSession)(ckSlotID, ckFlags, ckpApplication, ckNotify, &amp;ckSessionHandle);
125     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) {
126 #ifndef NO_CALLBACKS
127         if (notifyEncapsulation != NULL) {
128             if (notifyEncapsulation-&gt;jApplicationData != NULL) {
129                 (*env)-&gt;DeleteGlobalRef(env, jApplication);
130             }
131             (*env)-&gt;DeleteGlobalRef(env, jNotify);
132             free(notifyEncapsulation);
133         }
134 #endif /* NO_CALLBACKS */
135         return 0L;
136     }
137 
138     TRACE0(&quot;got session&quot;);
<span class="line-modified">139     TRACE1(&quot;, SessionHandle=%lu&quot;, (unsigned long) ckSessionHandle);</span>
140     TRACE0(&quot; ... &quot;);
141 
142     jSessionHandle = ckULongToJLong(ckSessionHandle);
143 
144 #ifndef NO_CALLBACKS
145     if (notifyEncapsulation != NULL) {
146         /* store the notifyEncapsulation to enable later cleanup */
147         putNotifyEntry(env, ckSessionHandle, notifyEncapsulation);
148     }
149 #endif /* NO_CALLBACKS */
150 
151     TRACE0(&quot;FINISHED\n&quot;);
152 
153     return jSessionHandle ;
154 }
155 #endif
156 
157 #ifdef P11_ENABLE_C_CLOSESESSION
158 /*
159  * Class:     sun_security_pkcs11_wrapper_PKCS11
</pre>
</td>
</tr>
</table>
<center><a href="p11_objmgmt.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_sign.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>