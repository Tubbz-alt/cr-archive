<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_convert.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  */
   4 
   5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
   6  *
   7  * Redistribution and use in  source and binary forms, with or without
   8  * modification, are permitted  provided that the following conditions are met:
   9  *
  10  * 1. Redistributions of  source code must retain the above copyright notice,
  11  *    this list of conditions and the following disclaimer.
  12  *
  13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
  14  *    this list of conditions and the following disclaimer in the documentation
  15  *    and/or other materials provided with the distribution.
  16  *
  17  * 3. The end-user documentation included with the redistribution, if any, must
  18  *    include the following acknowledgment:
  19  *
  20  *    &quot;This product includes software developed by IAIK of Graz University of
  21  *     Technology.&quot;
  22  *
  23  *    Alternately, this acknowledgment may appear in the software itself, if
  24  *    and wherever such third-party acknowledgments normally appear.
  25  *
  26  * 4. The names &quot;Graz University of Technology&quot; and &quot;IAIK of Graz University of
  27  *    Technology&quot; must not be used to endorse or promote products derived from
  28  *    this software without prior written permission.
  29  *
  30  * 5. Products derived from this software may not be called
  31  *    &quot;IAIK PKCS Wrapper&quot;, nor may &quot;IAIK&quot; appear in their name, without prior
  32  *    written permission of Graz University of Technology.
  33  *
  34  *  THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY EXPRESSED OR IMPLIED
  35  *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  36  *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  37  *  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE LICENSOR BE
  38  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
  39  *  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  40  *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
  41  *  OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
  42  *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  43  *  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
  44  *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
  45  *  POSSIBILITY  OF SUCH DAMAGE.
  46  */
  47 
  48 /*
  49  * pkcs11wrapper.c
  50  * 18.05.2001
  51  *
  52  * This is the implementation of the native functions of the Java to PKCS#11 interface.
  53  * All function use some helper functions to convert the JNI types to PKCS#11 types.
  54  *
  55  * @author Karl Scheibelhofer &lt;Karl.Scheibelhofer@iaik.at&gt;
  56  * @author Martin Schlaeffer &lt;schlaeff@sbox.tugraz.at&gt;
  57  */
  58 
  59 
  60 #include &quot;pkcs11wrapper.h&quot;
  61 
  62 #include &lt;stdio.h&gt;
  63 #include &lt;stdlib.h&gt;
  64 #include &lt;string.h&gt;
  65 #include &lt;assert.h&gt;
  66 
  67 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
  68 
  69 /* declare file private functions */
  70 
<a name="2" id="anc2"></a><span class="line-modified">  71 void jMechanismParameterToCKMechanismParameterSlow(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength);</span>

  72 
  73 
  74 /*
<a name="3" id="anc3"></a><span class="line-modified">  75  * converts a pointer to a CK_DATE structure into a Java CK_DATE Object.</span>
  76  *
  77  * @param env - used to call JNI funktions to create the new Java object
  78  * @param ckpValue - the pointer to the CK_DATE structure
  79  * @return - the new Java CK_DATE object
  80  */
  81 jobject ckDatePtrToJDateObject(JNIEnv *env, const CK_DATE *ckpDate)
  82 {
  83     jclass jDateClass;
  84     jmethodID jCtrId;
  85     jobject jDateObject;
  86     jcharArray jYear;
  87     jcharArray jMonth;
  88     jcharArray jDay;
  89 
  90     /* load CK_DATE class */
  91     jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
  92     if (jDateClass == NULL) { return NULL; }
  93 
  94     /* load CK_DATE constructor */
  95     jCtrId = (*env)-&gt;GetMethodID(env, jDateClass, &quot;&lt;init&gt;&quot;, &quot;([C[C[C)V&quot;);
  96     if (jCtrId == NULL) { return NULL; }
  97 
  98     /* prep all fields */
  99     jYear = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;year), 4);
 100     if (jYear == NULL) { return NULL; }
 101     jMonth = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;month), 2);
 102     if (jMonth == NULL) { return NULL; }
 103     jDay = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;day), 2);
 104     if (jDay == NULL) { return NULL; }
 105 
 106     /* create new CK_DATE object */
 107     jDateObject =
 108       (*env)-&gt;NewObject(env, jDateClass, jCtrId, jYear, jMonth, jDay);
 109     if (jDateObject == NULL) { return NULL; }
 110 
 111     /* free local references */
 112     (*env)-&gt;DeleteLocalRef(env, jDateClass);
 113     (*env)-&gt;DeleteLocalRef(env, jYear);
 114     (*env)-&gt;DeleteLocalRef(env, jMonth);
 115     (*env)-&gt;DeleteLocalRef(env, jDay);
 116 
 117     return jDateObject ;
 118 }
 119 
 120 /*
<a name="4" id="anc4"></a><span class="line-modified"> 121  * converts a pointer to a CK_VERSION structure into a Java CK_VERSION Object.</span>
 122  *
 123  * @param env - used to call JNI funktions to create the new Java object
 124  * @param ckpVersion - the pointer to the CK_VERSION structure
<a name="5" id="anc5"></a><span class="line-modified"> 125  * @return - the new Java CK_VERSION object</span>
 126  */
 127 jobject ckVersionPtrToJVersion(JNIEnv *env, const CK_VERSION_PTR ckpVersion)
 128 {
 129     jclass jVersionClass;
 130     jmethodID jCtrId;
 131     jobject jVersionObject;
 132     jint jMajor;
 133     jint jMinor;
 134 
 135     /* load CK_VERSION class */
 136     jVersionClass = (*env)-&gt;FindClass(env, CLASS_VERSION);
 137     if (jVersionClass == NULL) { return NULL; }
 138 
 139     /* load CK_VERSION constructor */
 140     jCtrId = (*env)-&gt;GetMethodID(env, jVersionClass, &quot;&lt;init&gt;&quot;, &quot;(II)V&quot;);
 141     if (jCtrId == NULL) { return NULL; }
 142 
 143     /* prep both fields */
 144     jMajor = ckpVersion-&gt;major;
 145     jMinor = ckpVersion-&gt;minor;
 146 
 147     /* create new CK_VERSION object */
 148     jVersionObject =
 149       (*env)-&gt;NewObject(env, jVersionClass, jCtrId, jMajor, jMinor);
 150     if (jVersionObject == NULL) { return NULL; }
 151 
 152     /* free local references */
 153     (*env)-&gt;DeleteLocalRef(env, jVersionClass);
 154 
 155     return jVersionObject ;
 156 }
 157 
 158 /*
<a name="6" id="anc6"></a><span class="line-modified"> 159  * converts a pointer to a CK_SESSION_INFO structure into a Java CK_SESSION_INFO Object.</span>
 160  *
 161  * @param env - used to call JNI funktions to create the new Java object
 162  * @param ckpSessionInfo - the pointer to the CK_SESSION_INFO structure
<a name="7" id="anc7"></a><span class="line-modified"> 163  * @return - the new Java CK_SESSION_INFO object</span>
 164  */
 165 jobject ckSessionInfoPtrToJSessionInfo(JNIEnv *env, const CK_SESSION_INFO_PTR ckpSessionInfo)
 166 {
 167     jclass jSessionInfoClass;
 168     jmethodID jCtrId;
 169     jobject jSessionInfoObject;
 170     jlong jSlotID;
 171     jlong jState;
 172     jlong jFlags;
 173     jlong jDeviceError;
 174 
 175     /* load CK_SESSION_INFO class */
 176     jSessionInfoClass = (*env)-&gt;FindClass(env, CLASS_SESSION_INFO);
 177     if (jSessionInfoClass == NULL) { return NULL; }
 178 
 179     /* load CK_SESSION_INFO constructor */
 180     jCtrId = (*env)-&gt;GetMethodID(env, jSessionInfoClass, &quot;&lt;init&gt;&quot;, &quot;(JJJJ)V&quot;);
 181     if (jCtrId == NULL) { return NULL; }
 182 
 183     /* prep all fields */
 184     jSlotID = ckULongToJLong(ckpSessionInfo-&gt;slotID);
 185     jState = ckULongToJLong(ckpSessionInfo-&gt;state);
 186     jFlags = ckULongToJLong(ckpSessionInfo-&gt;flags);
 187     jDeviceError = ckULongToJLong(ckpSessionInfo-&gt;ulDeviceError);
 188 
 189     /* create new CK_SESSION_INFO object */
 190     jSessionInfoObject =
 191       (*env)-&gt;NewObject(env, jSessionInfoClass, jCtrId, jSlotID, jState,
 192                         jFlags, jDeviceError);
 193     if (jSessionInfoObject == NULL) { return NULL; }
 194 
 195     /* free local references */
 196     (*env)-&gt;DeleteLocalRef(env, jSessionInfoClass);
 197 
 198     return jSessionInfoObject ;
 199 }
 200 
 201 /*
<a name="8" id="anc8"></a><span class="line-modified"> 202  * converts a pointer to a CK_ATTRIBUTE structure into a Java CK_ATTRIBUTE Object.</span>
 203  *
 204  * @param env - used to call JNI funktions to create the new Java object
 205  * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure
<a name="9" id="anc9"></a><span class="line-modified"> 206  * @return - the new Java CK_ATTRIBUTE object</span>
 207  */
 208 jobject ckAttributePtrToJAttribute(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
 209 {
 210     jclass jAttributeClass;
 211     jmethodID jCtrId;
 212     jobject jAttributeObject;
 213     jlong jType;
 214     jobject jPValue = NULL;
 215 
 216     jAttributeClass = (*env)-&gt;FindClass(env, CLASS_ATTRIBUTE);
 217     if (jAttributeClass == NULL) { return NULL; }
 218 
 219     /* load CK_INFO constructor */
 220     jCtrId = (*env)-&gt;GetMethodID(env, jAttributeClass, &quot;&lt;init&gt;&quot;, &quot;(JLjava/lang/Object;)V&quot;);
 221     if (jCtrId == NULL) { return NULL; }
 222 
 223     /* prep both fields */
 224     jType = ckULongToJLong(ckpAttribute-&gt;type);
 225     jPValue = ckAttributeValueToJObject(env, ckpAttribute);
 226     if ((*env)-&gt;ExceptionCheck(env)) { return NULL; }
 227 
 228     /* create new CK_ATTRIBUTE object */
 229     jAttributeObject =
 230       (*env)-&gt;NewObject(env, jAttributeClass, jCtrId, jType, jPValue);
 231     if (jAttributeObject == NULL) { return NULL; }
 232 
 233     /* free local references */
 234     (*env)-&gt;DeleteLocalRef(env, jAttributeClass);
 235     (*env)-&gt;DeleteLocalRef(env, jPValue);
 236 
 237     return jAttributeObject;
 238 }
 239 
 240 
 241 /*
<a name="10" id="anc10"></a><span class="line-modified"> 242  * converts a Java CK_VERSION object into a pointer to a CK_VERSION structure</span>
 243  *
 244  * @param env - used to call JNI funktions to get the values out of the Java object
 245  * @param jVersion - the Java CK_VERSION object to convert
<a name="11" id="anc11"></a><span class="line-modified"> 246  * @return - the pointer to the new CK_VERSION structure</span>
 247  */
<a name="12" id="anc12"></a><span class="line-modified"> 248 CK_VERSION_PTR jVersionToCKVersionPtr(JNIEnv *env, jobject jVersion)</span>

 249 {
 250     CK_VERSION_PTR ckpVersion;
 251     jclass jVersionClass;
 252     jfieldID jFieldID;
 253     jbyte jMajor, jMinor;
 254 
 255     if (jVersion == NULL) {
 256         return NULL;
 257     }
 258 
<a name="13" id="anc13"></a><span class="line-modified"> 259     /* get CK_VERSION class */</span>
 260     jVersionClass = (*env)-&gt;GetObjectClass(env, jVersion);
 261     if (jVersionClass == NULL) { return NULL; }
<a name="14" id="anc14"></a><span class="line-removed"> 262 </span>
<span class="line-removed"> 263     /* get Major */</span>
 264     jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;major&quot;, &quot;B&quot;);
 265     if (jFieldID == NULL) { return NULL; }
 266     jMajor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
<a name="15" id="anc15"></a><span class="line-removed"> 267 </span>
<span class="line-removed"> 268     /* get Minor */</span>
 269     jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;minor&quot;, &quot;B&quot;);
 270     if (jFieldID == NULL) { return NULL; }
 271     jMinor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
 272 
<a name="16" id="anc16"></a><span class="line-modified"> 273     /* allocate memory for CK_VERSION pointer */</span>
<span class="line-modified"> 274     ckpVersion = (CK_VERSION_PTR) malloc(sizeof(CK_VERSION));</span>
 275     if (ckpVersion == NULL) {
 276         throwOutOfMemoryError(env, 0);
 277         return NULL;
 278     }
<a name="17" id="anc17"></a>

 279     ckpVersion-&gt;major = jByteToCKByte(jMajor);
 280     ckpVersion-&gt;minor = jByteToCKByte(jMinor);
 281 
<a name="18" id="anc18"></a><span class="line-modified"> 282     return ckpVersion ;</span>
 283 }
 284 
 285 
 286 /*
<a name="19" id="anc19"></a><span class="line-modified"> 287  * converts a Java CK_DATE object into a pointer to a CK_DATE structure</span>
 288  *
<a name="20" id="anc20"></a><span class="line-modified"> 289  * @param env - used to call JNI funktions to get the values out of the Java object</span>
<span class="line-modified"> 290  * @param jVersion - the Java CK_DATE object to convert</span>
<span class="line-modified"> 291  * @return - the pointer to the new CK_DATE structure</span>
 292  */
<a name="21" id="anc21"></a><span class="line-modified"> 293 CK_DATE * jDateObjectPtrToCKDatePtr(JNIEnv *env, jobject jDate)</span>
 294 {
<a name="22" id="anc22"></a><span class="line-modified"> 295     CK_DATE * ckpDate;</span>
 296     CK_ULONG ckLength;
 297     jclass jDateClass;
 298     jfieldID jFieldID;
 299     jobject jYear, jMonth, jDay;
<a name="23" id="anc23"></a><span class="line-modified"> 300     jchar *jTempChars;</span>
 301     CK_ULONG i;
 302 
 303     if (jDate == NULL) {
 304         return NULL;
 305     }
 306 
<a name="24" id="anc24"></a><span class="line-modified"> 307     /* get CK_DATE class */</span>
 308     jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
 309     if (jDateClass == NULL) { return NULL; }
<a name="25" id="anc25"></a><span class="line-removed"> 310 </span>
<span class="line-removed"> 311     /* get Year */</span>
 312     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;year&quot;, &quot;[C&quot;);
 313     if (jFieldID == NULL) { return NULL; }
 314     jYear = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
<a name="26" id="anc26"></a><span class="line-removed"> 315 </span>
<span class="line-removed"> 316     /* get Month */</span>
 317     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;month&quot;, &quot;[C&quot;);
 318     if (jFieldID == NULL) { return NULL; }
 319     jMonth = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
<a name="27" id="anc27"></a><span class="line-removed"> 320 </span>
<span class="line-removed"> 321     /* get Day */</span>
 322     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;day&quot;, &quot;[C&quot;);
 323     if (jFieldID == NULL) { return NULL; }
 324     jDay = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
 325 
<a name="28" id="anc28"></a><span class="line-modified"> 326     /* allocate memory for CK_DATE pointer */</span>
<span class="line-modified"> 327     ckpDate = (CK_DATE *) malloc(sizeof(CK_DATE));</span>
 328     if (ckpDate == NULL) {
 329         throwOutOfMemoryError(env, 0);
 330         return NULL;
 331     }
 332 
<a name="29" id="anc29"></a>
 333     if (jYear == NULL) {
 334         ckpDate-&gt;year[0] = 0;
 335         ckpDate-&gt;year[1] = 0;
 336         ckpDate-&gt;year[2] = 0;
 337         ckpDate-&gt;year[3] = 0;
 338     } else {
 339         ckLength = (*env)-&gt;GetArrayLength(env, jYear);
<a name="30" id="anc30"></a><span class="line-modified"> 340         jTempChars = (jchar*) malloc((ckLength) * sizeof(jchar));</span>
 341         if (jTempChars == NULL) {
<a name="31" id="anc31"></a><span class="line-removed"> 342             free(ckpDate);</span>
 343             throwOutOfMemoryError(env, 0);
<a name="32" id="anc32"></a><span class="line-modified"> 344             return NULL;</span>
 345         }
 346         (*env)-&gt;GetCharArrayRegion(env, jYear, 0, ckLength, jTempChars);
 347         if ((*env)-&gt;ExceptionCheck(env)) {
<a name="33" id="anc33"></a><span class="line-modified"> 348             free(ckpDate);</span>
<span class="line-removed"> 349             free(jTempChars);</span>
<span class="line-removed"> 350             return NULL;</span>
 351         }
 352 
 353         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 4) ; i++) {
 354             ckpDate-&gt;year[i] = jCharToCKChar(jTempChars[i]);
 355         }
 356         free(jTempChars);
 357     }
 358 
 359     if (jMonth == NULL) {
 360         ckpDate-&gt;month[0] = 0;
 361         ckpDate-&gt;month[1] = 0;
 362     } else {
 363         ckLength = (*env)-&gt;GetArrayLength(env, jMonth);
<a name="34" id="anc34"></a><span class="line-modified"> 364         jTempChars = (jchar*) malloc((ckLength) * sizeof(jchar));</span>
 365         if (jTempChars == NULL) {
<a name="35" id="anc35"></a><span class="line-removed"> 366             free(ckpDate);</span>
 367             throwOutOfMemoryError(env, 0);
<a name="36" id="anc36"></a><span class="line-modified"> 368             return NULL;</span>
 369         }
 370         (*env)-&gt;GetCharArrayRegion(env, jMonth, 0, ckLength, jTempChars);
 371         if ((*env)-&gt;ExceptionCheck(env)) {
<a name="37" id="anc37"></a><span class="line-modified"> 372             free(ckpDate);</span>
<span class="line-removed"> 373             free(jTempChars);</span>
<span class="line-removed"> 374             return NULL;</span>
 375         }
 376 
 377         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
 378             ckpDate-&gt;month[i] = jCharToCKChar(jTempChars[i]);
 379         }
 380         free(jTempChars);
 381     }
 382 
 383     if (jDay == NULL) {
 384         ckpDate-&gt;day[0] = 0;
 385         ckpDate-&gt;day[1] = 0;
 386     } else {
 387         ckLength = (*env)-&gt;GetArrayLength(env, jDay);
<a name="38" id="anc38"></a><span class="line-modified"> 388         jTempChars = (jchar*) malloc((ckLength) * sizeof(jchar));</span>
 389         if (jTempChars == NULL) {
<a name="39" id="anc39"></a><span class="line-removed"> 390             free(ckpDate);</span>
 391             throwOutOfMemoryError(env, 0);
<a name="40" id="anc40"></a><span class="line-modified"> 392             return NULL;</span>
 393         }
 394         (*env)-&gt;GetCharArrayRegion(env, jDay, 0, ckLength, jTempChars);
 395         if ((*env)-&gt;ExceptionCheck(env)) {
<a name="41" id="anc41"></a><span class="line-modified"> 396             free(ckpDate);</span>
<span class="line-removed"> 397             free(jTempChars);</span>
<span class="line-removed"> 398             return NULL;</span>
 399         }
 400 
 401         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
 402             ckpDate-&gt;day[i] = jCharToCKChar(jTempChars[i]);
 403         }
 404         free(jTempChars);
 405     }
 406 
<a name="42" id="anc42"></a><span class="line-modified"> 407     return ckpDate ;</span>




 408 }
 409 
 410 
 411 /*
 412  * converts a Java CK_ATTRIBUTE object into a CK_ATTRIBUTE structure
 413  *
 414  * @param env - used to call JNI funktions to get the values out of the Java object
 415  * @param jAttribute - the Java CK_ATTRIBUTE object to convert
<a name="43" id="anc43"></a><span class="line-modified"> 416  * @return - the new CK_ATTRIBUTE structure</span>
 417  */
 418 CK_ATTRIBUTE jAttributeToCKAttribute(JNIEnv *env, jobject jAttribute)
 419 {
 420     CK_ATTRIBUTE ckAttribute;
 421     jclass jAttributeClass;
 422     jfieldID jFieldID;
 423     jlong jType;
 424     jobject jPValue;
<a name="44" id="anc44"></a>
 425     memset(&amp;ckAttribute, 0, sizeof(CK_ATTRIBUTE));
 426 
 427     // TBD: what if jAttribute == NULL?!
<a name="45" id="anc45"></a><span class="line-removed"> 428 </span>
 429     TRACE0(&quot;\nDEBUG: jAttributeToCKAttribute&quot;);
<a name="46" id="anc46"></a>
 430     /* get CK_ATTRIBUTE class */
 431     TRACE0(&quot;, getting attribute object class&quot;);
 432     jAttributeClass = (*env)-&gt;GetObjectClass(env, jAttribute);
 433     if (jAttributeClass == NULL) { return ckAttribute; }
 434 
 435     /* get type */
 436     TRACE0(&quot;, getting type field&quot;);
 437     jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;type&quot;, &quot;J&quot;);
 438     if (jFieldID == NULL) { return ckAttribute; }
 439     jType = (*env)-&gt;GetLongField(env, jAttribute, jFieldID);
<a name="47" id="anc47"></a><span class="line-modified"> 440     TRACE1(&quot;, type=0x%X&quot;, jType);</span>
 441 
 442     /* get pValue */
 443     TRACE0(&quot;, getting pValue field&quot;);
 444     jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;pValue&quot;, &quot;Ljava/lang/Object;&quot;);
 445     if (jFieldID == NULL) { return ckAttribute; }
 446     jPValue = (*env)-&gt;GetObjectField(env, jAttribute, jFieldID);
 447     TRACE1(&quot;, pValue=%p&quot;, jPValue);
 448 
 449     ckAttribute.type = jLongToCKULong(jType);
 450     TRACE0(&quot;, converting pValue to primitive object&quot;);
 451 
 452     /* convert the Java pValue object to a CK-type pValue pointer */
<a name="48" id="anc48"></a><span class="line-modified"> 453     jObjectToPrimitiveCKObjectPtrPtr(env, jPValue, &amp;(ckAttribute.pValue), &amp;(ckAttribute.ulValueLen));</span>
 454 
<a name="49" id="anc49"></a><span class="line-modified"> 455     TRACE0(&quot;\nFINISHED\n&quot;);</span>
 456 
 457     return ckAttribute ;
 458 }
 459 
 460 void masterKeyDeriveParamToCKMasterKeyDeriveParam(JNIEnv *env, jobject jParam,
 461         jclass masterKeyDeriveParamClass,
 462         CK_VERSION_PTR* cKMasterKeyDeriveParamVersion,
 463         CK_SSL3_RANDOM_DATA* cKMasterKeyDeriveParamRandomInfo) {
 464     jfieldID fieldID;
 465     jclass jSsl3RandomDataClass;
 466     jobject jRandomInfo, jRIClientRandom, jRIServerRandom, jVersion;
 467 
<a name="50" id="anc50"></a><span class="line-modified"> 468     /* get RandomInfo */</span>
 469     fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;RandomInfo&quot;,
 470             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
 471     if (fieldID == NULL) { return; }
 472     jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="51" id="anc51"></a><span class="line-removed"> 473 </span>
<span class="line-removed"> 474     /* get pClientRandom and ulClientRandomLength out of RandomInfo */</span>
 475     jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
 476     if (jSsl3RandomDataClass == NULL) { return; }
 477     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
 478     if (fieldID == NULL) { return; }
 479     jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<a name="52" id="anc52"></a><span class="line-removed"> 480 </span>
<span class="line-removed"> 481     /* get pServerRandom and ulServerRandomLength out of RandomInfo */</span>
 482     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
 483     if (fieldID == NULL) { return; }
 484     jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<a name="53" id="anc53"></a><span class="line-removed"> 485 </span>
<span class="line-removed"> 486     /* get pVersion */</span>
 487     fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;pVersion&quot;,
 488             &quot;Lsun/security/pkcs11/wrapper/CK_VERSION;&quot;);
 489     if (fieldID == NULL) { return; }
 490     jVersion = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 491 
<a name="54" id="anc54"></a><span class="line-modified"> 492     /* populate java values */</span>
 493     *cKMasterKeyDeriveParamVersion = jVersionToCKVersionPtr(env, jVersion);
 494     if ((*env)-&gt;ExceptionCheck(env)) { return; }
 495     jByteArrayToCKByteArray(env, jRIClientRandom,
 496             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom),
 497             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulClientRandomLen));
 498     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="55" id="anc55"></a><span class="line-modified"> 499         free(*cKMasterKeyDeriveParamVersion);</span>
<span class="line-removed"> 500         return;</span>
 501     }
 502     jByteArrayToCKByteArray(env, jRIServerRandom,
 503             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom),
 504             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulServerRandomLen));
 505     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="56" id="anc56"></a><span class="line-modified"> 506         free(*cKMasterKeyDeriveParamVersion);</span>
<span class="line-removed"> 507         free(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 508         return;</span>
 509     }
<a name="57" id="anc57"></a>










 510 }
 511 
 512 /*
 513  * converts the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to a
<a name="58" id="anc58"></a><span class="line-modified"> 514  * CK_SSL3_MASTER_KEY_DERIVE_PARAMS structure</span>
 515  *
 516  * @param env - used to call JNI functions to get the Java classes and objects
 517  * @param jParam - the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to convert
<a name="59" id="anc59"></a><span class="line-modified"> 518  * @return - the new CK_SSL3_MASTER_KEY_DERIVE_PARAMS structure</span>

 519  */
<a name="60" id="anc60"></a><span class="line-modified"> 520 CK_SSL3_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-modified"> 521 jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParam(JNIEnv *env,</span>
<span class="line-modified"> 522         jobject jParam)</span>
 523 {
<a name="61" id="anc61"></a><span class="line-modified"> 524     CK_SSL3_MASTER_KEY_DERIVE_PARAMS ckParam;</span>
 525     jclass jSsl3MasterKeyDeriveParamsClass;
<a name="62" id="anc62"></a><span class="line-modified"> 526     memset(&amp;ckParam, 0, sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS));</span>












 527     jSsl3MasterKeyDeriveParamsClass =
 528             (*env)-&gt;FindClass(env, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);
<a name="63" id="anc63"></a><span class="line-modified"> 529     if (jSsl3MasterKeyDeriveParamsClass == NULL) { return ckParam; }</span>


 530     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,
 531             jSsl3MasterKeyDeriveParamsClass,
<a name="64" id="anc64"></a><span class="line-modified"> 532             &amp;ckParam.pVersion, &amp;ckParam.RandomInfo);</span>
<span class="line-modified"> 533     return ckParam;</span>










 534 }
 535 
 536 /*
 537  * converts the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to a
<a name="65" id="anc65"></a><span class="line-modified"> 538  * CK_TLS12_MASTER_KEY_DERIVE_PARAMS structure</span>
 539  *
 540  * @param env - used to call JNI functions to get the Java classes and objects
 541  * @param jParam - the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to convert
<a name="66" id="anc66"></a><span class="line-modified"> 542  * @return - the new CK_TLS12_MASTER_KEY_DERIVE_PARAMS structure</span>

 543  */
<a name="67" id="anc67"></a><span class="line-modified"> 544 CK_TLS12_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-modified"> 545 jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParam(JNIEnv *env,</span>
<span class="line-modified"> 546         jobject jParam)</span>
 547 {
<a name="68" id="anc68"></a><span class="line-modified"> 548     CK_TLS12_MASTER_KEY_DERIVE_PARAMS ckParam;</span>
 549     jclass jTls12MasterKeyDeriveParamsClass;
 550     jfieldID fieldID;
<a name="69" id="anc69"></a><span class="line-modified"> 551     memset(&amp;ckParam, 0, sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS));</span>






 552     jTls12MasterKeyDeriveParamsClass =
<a name="70" id="anc70"></a><span class="line-modified"> 553             (*env)-&gt;FindClass(env, CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified"> 554     if (jTls12MasterKeyDeriveParamsClass == NULL) { return ckParam; }</span>
<span class="line-removed"> 555     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,</span>
<span class="line-removed"> 556             jTls12MasterKeyDeriveParamsClass, &amp;ckParam.pVersion,</span>
<span class="line-removed"> 557             &amp;ckParam.RandomInfo);</span>
 558     fieldID = (*env)-&gt;GetFieldID(env,
 559             jTls12MasterKeyDeriveParamsClass, &quot;prfHashMechanism&quot;, &quot;J&quot;);
<a name="71" id="anc71"></a><span class="line-modified"> 560     if (fieldID != NULL) {</span>
<span class="line-modified"> 561         jlong prfHashMechanism =</span>
<span class="line-modified"> 562                 (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified"> 563         ckParam.prfHashMechanism = (CK_MECHANISM_TYPE)prfHashMechanism;</span>




 564     }
<a name="72" id="anc72"></a><span class="line-modified"> 565     return ckParam;</span>

















 566 }
 567 
 568 /*
<a name="73" id="anc73"></a><span class="line-modified"> 569  * converts the Java CK_TLS_PRF_PARAMS object to a CK_TLS_PRF_PARAMS structure</span>





 570  */
<a name="74" id="anc74"></a><span class="line-modified"> 571 CK_TLS_PRF_PARAMS jTlsPrfParamsToCKTlsPrfParam(JNIEnv *env, jobject jParam)</span>

 572 {
<a name="75" id="anc75"></a>
 573     jclass jTlsPrfParamsClass;
<a name="76" id="anc76"></a><span class="line-removed"> 574     CK_TLS_PRF_PARAMS ckParam;</span>
 575     jfieldID fieldID;
 576     jobject jSeed, jLabel, jOutput;
<a name="77" id="anc77"></a><span class="line-removed"> 577     memset(&amp;ckParam, 0, sizeof(CK_TLS_PRF_PARAMS));</span>
 578 
<a name="78" id="anc78"></a><span class="line-modified"> 579     // TBD: what if jParam == NULL?!</span>


 580 
<a name="79" id="anc79"></a><span class="line-modified"> 581     /* get pSeed */</span>
 582     jTlsPrfParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_PRF_PARAMS);
<a name="80" id="anc80"></a><span class="line-modified"> 583     if (jTlsPrfParamsClass == NULL) { return ckParam; }</span>
 584     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pSeed&quot;, &quot;[B&quot;);
<a name="81" id="anc81"></a><span class="line-modified"> 585     if (fieldID == NULL) { return ckParam; }</span>
 586     jSeed = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="82" id="anc82"></a><span class="line-removed"> 587 </span>
<span class="line-removed"> 588     /* get pLabel */</span>
 589     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pLabel&quot;, &quot;[B&quot;);
<a name="83" id="anc83"></a><span class="line-modified"> 590     if (fieldID == NULL) { return ckParam; }</span>
 591     jLabel = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="84" id="anc84"></a><span class="line-removed"> 592 </span>
<span class="line-removed"> 593     /* get pOutput */</span>
 594     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pOutput&quot;, &quot;[B&quot;);
<a name="85" id="anc85"></a><span class="line-modified"> 595     if (fieldID == NULL) { return ckParam; }</span>
 596     jOutput = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 597 
<a name="86" id="anc86"></a><span class="line-modified"> 598     /* populate java values */</span>
<span class="line-modified"> 599     jByteArrayToCKByteArray(env, jSeed, &amp;(ckParam.pSeed), &amp;(ckParam.ulSeedLen));</span>
<span class="line-modified"> 600     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified"> 601     jByteArrayToCKByteArray(env, jLabel, &amp;(ckParam.pLabel), &amp;(ckParam.ulLabelLen));</span>





 602     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="87" id="anc87"></a><span class="line-modified"> 603         free(ckParam.pSeed);</span>
<span class="line-removed"> 604         return ckParam;</span>
 605     }
<a name="88" id="anc88"></a><span class="line-modified"> 606     ckParam.pulOutputLen = malloc(sizeof(CK_ULONG));</span>
<span class="line-modified"> 607     if (ckParam.pulOutputLen == NULL) {</span>
<span class="line-modified"> 608         free(ckParam.pSeed);</span>
<span class="line-removed"> 609         free(ckParam.pLabel);</span>
<span class="line-removed"> 610         throwOutOfMemoryError(env, 0);</span>
<span class="line-removed"> 611         return ckParam;</span>
 612     }
<a name="89" id="anc89"></a><span class="line-modified"> 613     jByteArrayToCKByteArray(env, jOutput, &amp;(ckParam.pOutput), ckParam.pulOutputLen);</span>




 614     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="90" id="anc90"></a><span class="line-modified"> 615         free(ckParam.pSeed);</span>
<span class="line-removed"> 616         free(ckParam.pLabel);</span>
<span class="line-removed"> 617         free(ckParam.pulOutputLen);</span>
<span class="line-removed"> 618         return ckParam;</span>
 619     }
 620 
<a name="91" id="anc91"></a><span class="line-modified"> 621     return ckParam ;</span>










 622 }
 623 
 624 /*
<a name="92" id="anc92"></a><span class="line-modified"> 625  * converts the Java CK_TLS_MAC_PARAMS object to a CK_TLS_MAC_PARAMS structure</span>





 626  */
<a name="93" id="anc93"></a><span class="line-modified"> 627 CK_TLS_MAC_PARAMS jTlsMacParamsToCKTlsMacParam(JNIEnv *env, jobject jParam)</span>


 628 {
<a name="94" id="anc94"></a>
 629     jclass jTlsMacParamsClass;
<a name="95" id="anc95"></a><span class="line-removed"> 630     CK_TLS_MAC_PARAMS ckParam;</span>
 631     jfieldID fieldID;
 632     jlong jPrfMechanism, jUlMacLength, jUlServerOrClient;
<a name="96" id="anc96"></a><span class="line-removed"> 633     memset(&amp;ckParam, 0, sizeof(CK_TLS_MAC_PARAMS));</span>
 634 
<a name="97" id="anc97"></a><span class="line-modified"> 635     jTlsMacParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_MAC_PARAMS);</span>
<span class="line-modified"> 636     if (jTlsMacParamsClass == NULL) { return ckParam; }</span>

 637 
<a name="98" id="anc98"></a><span class="line-modified"> 638     /* get prfMechanism */</span>


 639     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;prfMechanism&quot;, &quot;J&quot;);
<a name="99" id="anc99"></a><span class="line-modified"> 640     if (fieldID == NULL) { return ckParam; }</span>
 641     jPrfMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="100" id="anc100"></a><span class="line-removed"> 642 </span>
<span class="line-removed"> 643     /* get ulMacLength */</span>
 644     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulMacLength&quot;, &quot;J&quot;);
<a name="101" id="anc101"></a><span class="line-modified"> 645     if (fieldID == NULL) { return ckParam; }</span>
 646     jUlMacLength = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="102" id="anc102"></a><span class="line-removed"> 647 </span>
<span class="line-removed"> 648     /* get ulServerOrClient */</span>
 649     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulServerOrClient&quot;, &quot;J&quot;);
<a name="103" id="anc103"></a><span class="line-modified"> 650     if (fieldID == NULL) { return ckParam; }</span>
 651     jUlServerOrClient = (*env)-&gt;GetLongField(env, jParam, fieldID);
 652 
<a name="104" id="anc104"></a><span class="line-modified"> 653     /* populate java values */</span>
<span class="line-modified"> 654     ckParam.prfMechanism = jLongToCKULong(jPrfMechanism);</span>
<span class="line-modified"> 655     ckParam.ulMacLength = jLongToCKULong(jUlMacLength);</span>
<span class="line-modified"> 656     ckParam.ulServerOrClient = jLongToCKULong(jUlServerOrClient);</span>







 657 
<a name="105" id="anc105"></a><span class="line-modified"> 658     return ckParam;</span>



 659 }
 660 
 661 void keyMatParamToCKKeyMatParam(JNIEnv *env, jobject jParam,
 662         jclass jKeyMatParamClass,
 663         CK_ULONG* cKKeyMatParamUlMacSizeInBits,
 664         CK_ULONG* cKKeyMatParamUlKeySizeInBits,
 665         CK_ULONG* cKKeyMatParamUlIVSizeInBits,
 666         CK_BBOOL* cKKeyMatParamBIsExport,
 667         CK_SSL3_RANDOM_DATA* cKKeyMatParamRandomInfo,
 668         CK_SSL3_KEY_MAT_OUT_PTR* cKKeyMatParamPReturnedKeyMaterial)
 669 {
 670     jclass jSsl3RandomDataClass, jSsl3KeyMatOutClass;
 671     jfieldID fieldID;
 672     jlong jMacSizeInBits, jKeySizeInBits, jIVSizeInBits;
 673     jboolean jIsExport;
 674     jobject jRandomInfo, jRIClientRandom, jRIServerRandom;
 675     jobject jReturnedKeyMaterial, jRMIvClient, jRMIvServer;
 676     CK_ULONG ckTemp;
 677 
<a name="106" id="anc106"></a><span class="line-modified"> 678     /* get ulMacSizeInBits */</span>


 679     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulMacSizeInBits&quot;, &quot;J&quot;);
 680     if (fieldID == NULL) { return; }
 681     jMacSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="107" id="anc107"></a><span class="line-removed"> 682 </span>
<span class="line-removed"> 683     /* get ulKeySizeInBits */</span>
 684     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulKeySizeInBits&quot;, &quot;J&quot;);
 685     if (fieldID == NULL) { return; }
 686     jKeySizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="108" id="anc108"></a><span class="line-removed"> 687 </span>
<span class="line-removed"> 688     /* get ulIVSizeInBits */</span>
 689     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulIVSizeInBits&quot;, &quot;J&quot;);
 690     if (fieldID == NULL) { return; }
 691     jIVSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="109" id="anc109"></a><span class="line-removed"> 692 </span>
<span class="line-removed"> 693     /* get bIsExport */</span>
 694     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;bIsExport&quot;, &quot;Z&quot;);
 695     if (fieldID == NULL) { return; }
 696     jIsExport = (*env)-&gt;GetBooleanField(env, jParam, fieldID);
<a name="110" id="anc110"></a><span class="line-removed"> 697 </span>
<span class="line-removed"> 698     /* get RandomInfo */</span>
 699     jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
 700     if (jSsl3RandomDataClass == NULL) { return; }
 701     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;RandomInfo&quot;,
 702             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
 703     if (fieldID == NULL) { return; }
 704     jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="111" id="anc111"></a><span class="line-removed"> 705 </span>
<span class="line-removed"> 706     /* get pClientRandom and ulClientRandomLength out of RandomInfo */</span>
 707     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
 708     if (fieldID == NULL) { return; }
 709     jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<a name="112" id="anc112"></a><span class="line-removed"> 710 </span>
<span class="line-removed"> 711     /* get pServerRandom and ulServerRandomLength out of RandomInfo */</span>
 712     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
 713     if (fieldID == NULL) { return; }
 714     jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<a name="113" id="anc113"></a><span class="line-removed"> 715 </span>
<span class="line-removed"> 716     /* get pReturnedKeyMaterial */</span>
 717     jSsl3KeyMatOutClass = (*env)-&gt;FindClass(env, CLASS_SSL3_KEY_MAT_OUT);
 718     if (jSsl3KeyMatOutClass == NULL) { return; }
 719     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;pReturnedKeyMaterial&quot;,
 720             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_OUT;&quot;);
 721     if (fieldID == NULL) { return; }
 722     jReturnedKeyMaterial = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="114" id="anc114"></a><span class="line-removed"> 723 </span>
<span class="line-removed"> 724     /* get pIVClient out of pReturnedKeyMaterial */</span>
 725     fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVClient&quot;, &quot;[B&quot;);
 726     if (fieldID == NULL) { return; }
 727     jRMIvClient = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
<a name="115" id="anc115"></a><span class="line-removed"> 728 </span>
<span class="line-removed"> 729     /* get pIVServer out of pReturnedKeyMaterial */</span>
 730     fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVServer&quot;, &quot;[B&quot;);
 731     if (fieldID == NULL) { return; }
 732     jRMIvServer = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
 733 
<a name="116" id="anc116"></a><span class="line-modified"> 734     /* populate java values */</span>
 735     *cKKeyMatParamUlMacSizeInBits = jLongToCKULong(jMacSizeInBits);
 736     *cKKeyMatParamUlKeySizeInBits = jLongToCKULong(jKeySizeInBits);
 737     *cKKeyMatParamUlIVSizeInBits = jLongToCKULong(jIVSizeInBits);
 738     *cKKeyMatParamBIsExport = jBooleanToCKBBool(jIsExport);
 739     jByteArrayToCKByteArray(env, jRIClientRandom,
 740             &amp;(cKKeyMatParamRandomInfo-&gt;pClientRandom),
 741             &amp;(cKKeyMatParamRandomInfo-&gt;ulClientRandomLen));
<a name="117" id="anc117"></a><span class="line-modified"> 742     if ((*env)-&gt;ExceptionCheck(env)) { return; }</span>



 743     jByteArrayToCKByteArray(env, jRIServerRandom,
 744             &amp;(cKKeyMatParamRandomInfo-&gt;pServerRandom),
 745             &amp;(cKKeyMatParamRandomInfo-&gt;ulServerRandomLen));
 746     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="118" id="anc118"></a><span class="line-modified"> 747         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 748         return;</span>
 749     }
<a name="119" id="anc119"></a><span class="line-modified"> 750     /* allocate memory for pRetrunedKeyMaterial */</span>
 751     *cKKeyMatParamPReturnedKeyMaterial =
<a name="120" id="anc120"></a><span class="line-modified"> 752             (CK_SSL3_KEY_MAT_OUT_PTR)malloc(sizeof(CK_SSL3_KEY_MAT_OUT));</span>
 753     if (*cKKeyMatParamPReturnedKeyMaterial == NULL) {
<a name="121" id="anc121"></a><span class="line-removed"> 754         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 755         free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
 756         throwOutOfMemoryError(env, 0);
<a name="122" id="anc122"></a><span class="line-modified"> 757         return;</span>
 758     }
 759 
 760     // the handles are output params only, no need to fetch them from Java
 761     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientMacSecret = 0;
 762     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerMacSecret = 0;
 763     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientKey = 0;
 764     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerKey = 0;
 765 
 766     jByteArrayToCKByteArray(env, jRMIvClient,
 767             &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient), &amp;ckTemp);
 768     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="123" id="anc123"></a><span class="line-modified"> 769         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 770         free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-removed"> 771         free((*cKKeyMatParamPReturnedKeyMaterial));</span>
<span class="line-removed"> 772         return;</span>
 773     }
 774     jByteArrayToCKByteArray(env, jRMIvServer,
 775             &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVServer), &amp;ckTemp);
 776     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="124" id="anc124"></a><span class="line-modified"> 777         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 778         free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-removed"> 779         free((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient);</span>
<span class="line-removed"> 780         free((*cKKeyMatParamPReturnedKeyMaterial));</span>
<span class="line-removed"> 781         return;</span>
 782     }
 783 
<a name="125" id="anc125"></a>











 784     return;
 785 }
 786 /*
 787  * converts the Java CK_SSL3_KEY_MAT_PARAMS object to a
<a name="126" id="anc126"></a><span class="line-modified"> 788  * CK_SSL3_KEY_MAT_PARAMS structure</span>
 789  *
 790  * @param env - used to call JNI funktions to get the Java classes and objects
 791  * @param jParam - the Java CK_SSL3_KEY_MAT_PARAMS object to convert
<a name="127" id="anc127"></a><span class="line-modified"> 792  * @return - the new CK_SSL3_KEY_MAT_PARAMS structure</span>

 793  */
<a name="128" id="anc128"></a><span class="line-modified"> 794 CK_SSL3_KEY_MAT_PARAMS</span>
<span class="line-modified"> 795 jSsl3KeyMatParamToCKSsl3KeyMatParam(JNIEnv *env, jobject jParam)</span>
 796 {
<a name="129" id="anc129"></a><span class="line-modified"> 797     CK_SSL3_KEY_MAT_PARAMS ckParam;</span>
 798     jclass jSsl3KeyMatParamsClass;
<a name="130" id="anc130"></a><span class="line-modified"> 799     memset(&amp;ckParam, 0, sizeof(CK_SSL3_KEY_MAT_PARAMS));</span>












 800     jSsl3KeyMatParamsClass = (*env)-&gt;FindClass(env,
 801             CLASS_SSL3_KEY_MAT_PARAMS);
<a name="131" id="anc131"></a><span class="line-modified"> 802     if (jSsl3KeyMatParamsClass == NULL) { return ckParam; }</span>


 803     keyMatParamToCKKeyMatParam(env, jParam, jSsl3KeyMatParamsClass,
<a name="132" id="anc132"></a><span class="line-modified"> 804             &amp;ckParam.ulMacSizeInBits, &amp;ckParam.ulKeySizeInBits,</span>
<span class="line-modified"> 805             &amp;ckParam.ulIVSizeInBits, &amp;ckParam.bIsExport,</span>
<span class="line-modified"> 806             &amp;ckParam.RandomInfo, &amp;ckParam.pReturnedKeyMaterial);</span>
<span class="line-modified"> 807     return ckParam;</span>










 808 }
 809 
 810 /*
 811  * converts the Java CK_TLS12_KEY_MAT_PARAMS object to a
<a name="133" id="anc133"></a><span class="line-modified"> 812  * CK_TLS12_KEY_MAT_PARAMS structure</span>
 813  *
 814  * @param env - used to call JNI functions to get the Java classes and objects
 815  * @param jParam - the Java CK_TLS12_KEY_MAT_PARAMS object to convert
<a name="134" id="anc134"></a><span class="line-modified"> 816  * @return - the new CK_TLS12_KEY_MAT_PARAMS structure</span>

 817  */
<a name="135" id="anc135"></a><span class="line-modified"> 818 CK_TLS12_KEY_MAT_PARAMS jTls12KeyMatParamToCKTls12KeyMatParam(JNIEnv *env,</span>
<span class="line-modified"> 819         jobject jParam)</span>
 820 {
<a name="136" id="anc136"></a><span class="line-modified"> 821     CK_TLS12_KEY_MAT_PARAMS ckParam;</span>
 822     jclass jTls12KeyMatParamsClass;
 823     jfieldID fieldID;
<a name="137" id="anc137"></a><span class="line-modified"> 824     memset(&amp;ckParam, 0, sizeof(CK_TLS12_KEY_MAT_PARAMS));</span>






 825     jTls12KeyMatParamsClass = (*env)-&gt;FindClass(env,
 826             CLASS_TLS12_KEY_MAT_PARAMS);
<a name="138" id="anc138"></a><span class="line-modified"> 827     if (jTls12KeyMatParamsClass == NULL) { return ckParam; }</span>
<span class="line-removed"> 828     keyMatParamToCKKeyMatParam(env, jParam, jTls12KeyMatParamsClass,</span>
<span class="line-removed"> 829             &amp;ckParam.ulMacSizeInBits, &amp;ckParam.ulKeySizeInBits,</span>
<span class="line-removed"> 830             &amp;ckParam.ulIVSizeInBits, &amp;ckParam.bIsExport,</span>
<span class="line-removed"> 831             &amp;ckParam.RandomInfo, &amp;ckParam.pReturnedKeyMaterial);</span>
 832     fieldID = (*env)-&gt;GetFieldID(env, jTls12KeyMatParamsClass,
 833             &quot;prfHashMechanism&quot;, &quot;J&quot;);
<a name="139" id="anc139"></a><span class="line-modified"> 834     if (fieldID != NULL) {</span>
<span class="line-modified"> 835         jlong prfHashMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified"> 836         ckParam.prfHashMechanism = (CK_MECHANISM_TYPE)prfHashMechanism;</span>














 837     }
<a name="140" id="anc140"></a><span class="line-modified"> 838     return ckParam;</span>








 839 }
 840 
 841 /*
<a name="141" id="anc141"></a><span class="line-modified"> 842  * converts the Java CK_AES_CTR_PARAMS object to a CK_AES_CTR_PARAMS structure</span>
 843  *
 844  * @param env - used to call JNI funktions to get the Java classes and objects
 845  * @param jParam - the Java CK_AES_CTR_PARAMS object to convert
<a name="142" id="anc142"></a><span class="line-modified"> 846  * @param ckpParam - pointer to the new CK_AES_CTR_PARAMS structure</span>

 847  */
<a name="143" id="anc143"></a><span class="line-modified"> 848 void jAesCtrParamsToCKAesCtrParam(JNIEnv *env, jobject jParam,</span>
<span class="line-modified"> 849                                   CK_AES_CTR_PARAMS_PTR ckpParam) {</span>


 850     jclass jAesCtrParamsClass;
 851     jfieldID fieldID;
 852     jlong jCounterBits;
 853     jobject jCb;
<a name="144" id="anc144"></a><span class="line-modified"> 854     CK_BYTE_PTR ckBytes;</span>
 855     CK_ULONG ckTemp;
 856 
<a name="145" id="anc145"></a><span class="line-modified"> 857     /* get ulCounterBits */</span>




 858     jAesCtrParamsClass = (*env)-&gt;FindClass(env, CLASS_AES_CTR_PARAMS);
<a name="146" id="anc146"></a><span class="line-modified"> 859     if (jAesCtrParamsClass == NULL) { return; }</span>



 860     fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;ulCounterBits&quot;, &quot;J&quot;);
<a name="147" id="anc147"></a><span class="line-modified"> 861     if (fieldID == NULL) { return; }</span>
 862     jCounterBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="148" id="anc148"></a><span class="line-removed"> 863 </span>
<span class="line-removed"> 864     /* get cb */</span>
 865     fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;cb&quot;, &quot;[B&quot;);
<a name="149" id="anc149"></a><span class="line-modified"> 866     if (fieldID == NULL) { return; }</span>
 867     jCb = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 868 
<a name="150" id="anc150"></a><span class="line-modified"> 869     /* populate java values */</span>
<span class="line-modified"> 870     ckpParam-&gt;ulCounterBits = jLongToCKULong(jCounterBits);</span>






 871     jByteArrayToCKByteArray(env, jCb, &amp;ckBytes, &amp;ckTemp);
<a name="151" id="anc151"></a><span class="line-modified"> 872     if ((*env)-&gt;ExceptionCheck(env)) { return; }</span>
<span class="line-modified"> 873     if (ckTemp != 16) {</span>
<span class="line-modified"> 874         TRACE1(&quot;ERROR: WRONG CTR IV LENGTH %d&quot;, ckTemp);</span>
<span class="line-modified"> 875     } else {</span>
<span class="line-modified"> 876         memcpy(ckpParam-&gt;cb, ckBytes, ckTemp);</span>
<span class="line-modified"> 877         free(ckBytes);</span>




 878     }
<a name="152" id="anc152"></a>




 879 }
 880 
 881 /*
<a name="153" id="anc153"></a><span class="line-modified"> 882  * converts a Java CK_MECHANISM object into a CK_MECHANISM structure</span>

 883  *
<a name="154" id="anc154"></a><span class="line-modified"> 884  * @param env - used to call JNI funktions to get the values out of the Java object</span>
<span class="line-modified"> 885  * @param jMechanism - the Java CK_MECHANISM object to convert</span>
<span class="line-modified"> 886  * @return - the new CK_MECHANISM structure</span>

 887  */
<a name="155" id="anc155"></a><span class="line-modified"> 888 void jMechanismToCKMechanism(JNIEnv *env, jobject jMechanism, CK_MECHANISM_PTR ckMechanismPtr)</span>

 889 {
<a name="156" id="anc156"></a><span class="line-modified"> 890     jlong jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, mech_mechanismID);</span>
<span class="line-modified"> 891     jobject jParameter = (*env)-&gt;GetObjectField(env, jMechanism, mech_pParameterID);</span>



 892 
<a name="157" id="anc157"></a><span class="line-modified"> 893     (*ckMechanismPtr).mechanism = jLongToCKULong(jMechanismType);</span>
 894 
<a name="158" id="anc158"></a><span class="line-modified"> 895     /* convert the specific Java mechanism parameter object to a pointer to a CK-type mechanism</span>
<span class="line-modified"> 896      * structure</span>
<span class="line-modified"> 897      */</span>
<span class="line-modified"> 898     if (jParameter == NULL) {</span>
<span class="line-modified"> 899         (*ckMechanismPtr).pParameter = NULL;</span>
<span class="line-modified"> 900         (*ckMechanismPtr).ulParameterLen = 0;</span>
<span class="line-modified"> 901     } else {</span>
<span class="line-modified"> 902         jMechanismParameterToCKMechanismParameter(env, jParameter, &amp;(*ckMechanismPtr).pParameter, &amp;(*ckMechanismPtr).ulParameterLen);</span>


































 903     }
<a name="159" id="anc159"></a>






 904 }
 905 
 906 /*
<a name="160" id="anc160"></a><span class="line-modified"> 907  * the following functions convert Attribute and Mechanism value pointers</span>
<span class="line-removed"> 908  *</span>
<span class="line-removed"> 909  * jobject ckAttributeValueToJObject(JNIEnv *env,</span>
<span class="line-removed"> 910  *                                   const CK_ATTRIBUTE_PTR ckpAttribute);</span>
<span class="line-removed"> 911  *</span>
<span class="line-removed"> 912  * void jObjectToPrimitiveCKObjectPtrPtr(JNIEnv *env,</span>
<span class="line-removed"> 913  *                                       jobject jObject,</span>
<span class="line-removed"> 914  *                                       CK_VOID_PTR *ckpObjectPtr,</span>
<span class="line-removed"> 915  *                                       CK_ULONG *pLength);</span>
 916  *
<a name="161" id="anc161"></a><span class="line-modified"> 917  * void jMechanismParameterToCKMechanismParameter(JNIEnv *env,</span>
<span class="line-modified"> 918  *                                                jobject jParam,</span>
<span class="line-modified"> 919  *                                                CK_VOID_PTR *ckpParamPtr,</span>
<span class="line-modified"> 920  *                                                CK_ULONG *ckpLength);</span>
<span class="line-modified"> 921  *</span>
<span class="line-modified"> 922  * These functions are used if a PKCS#11 mechanism or attribute structure gets</span>
<span class="line-modified"> 923  * convertet to a Java attribute or mechanism object or vice versa.</span>
<span class="line-modified"> 924  *</span>
<span class="line-modified"> 925  * ckAttributeValueToJObject converts a PKCS#11 attribute value pointer to a Java</span>
<span class="line-modified"> 926  * object depending on the type of the Attribute. A PKCS#11 attribute value can</span>
<span class="line-modified"> 927  * be a CK_ULONG, CK_BYTE[], CK_CHAR[], big integer, CK_BBOOL, CK_UTF8CHAR[],</span>
<span class="line-modified"> 928  * CK_DATE or CK_FLAGS that gets converted to a corresponding Java object.</span>
<span class="line-modified"> 929  *</span>
<span class="line-modified"> 930  * jObjectToPrimitiveCKObjectPtrPtr is used by jAttributeToCKAttributePtr for</span>
<span class="line-modified"> 931  * converting the Java attribute value to a PKCS#11 attribute value pointer.</span>
<span class="line-modified"> 932  * For now only primitive datatypes and arrays of primitive datatypes can get</span>
<span class="line-modified"> 933  * converted. Otherwise this function throws a PKCS#11Exception with the</span>
<span class="line-modified"> 934  * errorcode CKR_VENDOR_DEFINED.</span>
























































 935  *
<a name="162" id="anc162"></a><span class="line-modified"> 936  * jMechanismParameterToCKMechanismParameter converts a Java mechanism parameter</span>
<span class="line-modified"> 937  * to a PKCS#11 mechanism parameter. First this function determines what mechanism</span>
<span class="line-modified"> 938  * parameter the Java object is, then it allocates the memory for the new PKCS#11</span>
<span class="line-removed"> 939  * structure and calls the corresponding function to convert the Java object to</span>
<span class="line-removed"> 940  * a PKCS#11 mechanism parameter structure.</span>
 941  */
<a name="163" id="anc163"></a>



























 942 
 943 /*
<a name="164" id="anc164"></a><span class="line-modified"> 944  * converts the pValue of a CK_ATTRIBUTE structure into a Java Object by checking the type</span>
<span class="line-modified"> 945  * of the attribute.</span>


 946  *
<a name="165" id="anc165"></a><span class="line-modified"> 947  * @param env - used to call JNI funktions to create the new Java object</span>
 948  * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure that contains the type
 949  *                       and the pValue to convert
<a name="166" id="anc166"></a><span class="line-modified"> 950  * @return - the new Java object of the CK-type pValue</span>
 951  */
 952 jobject ckAttributeValueToJObject(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
 953 {
 954     jint jValueLength;
 955     jobject jValueObject = NULL;
 956 
 957     jValueLength = ckULongToJInt(ckpAttribute-&gt;ulValueLen);
 958 
 959     if ((jValueLength &lt;= 0) || (ckpAttribute-&gt;pValue == NULL)) {
 960         return NULL ;
 961     }
 962 
 963     switch(ckpAttribute-&gt;type) {
 964         case CKA_CLASS:
 965             /* value CK_OBJECT_CLASS, defacto a CK_ULONG */
 966         case CKA_KEY_TYPE:
 967             /* value CK_KEY_TYPE, defacto a CK_ULONG */
 968         case CKA_CERTIFICATE_TYPE:
 969             /* value CK_CERTIFICATE_TYPE, defacto a CK_ULONG */
 970         case CKA_HW_FEATURE_TYPE:
 971             /* value CK_HW_FEATURE_TYPE, defacto a CK_ULONG */
 972         case CKA_MODULUS_BITS:
 973         case CKA_VALUE_BITS:
 974         case CKA_VALUE_LEN:
 975         case CKA_KEY_GEN_MECHANISM:
 976         case CKA_PRIME_BITS:
 977         case CKA_SUB_PRIME_BITS:
 978             /* value CK_ULONG */
 979             jValueObject = ckULongPtrToJLongObject(env, (CK_ULONG*) ckpAttribute-&gt;pValue);
 980             break;
 981 
 982             /* can be CK_BYTE[],CK_CHAR[] or big integer; defacto always CK_BYTE[] */
 983         case CKA_VALUE:
 984         case CKA_OBJECT_ID:
 985         case CKA_SUBJECT:
 986         case CKA_ID:
 987         case CKA_ISSUER:
 988         case CKA_SERIAL_NUMBER:
 989         case CKA_OWNER:
 990         case CKA_AC_ISSUER:
 991         case CKA_ATTR_TYPES:
 992         case CKA_ECDSA_PARAMS:
 993             /* CKA_EC_PARAMS is the same, these two are equivalent */
 994         case CKA_EC_POINT:
 995         case CKA_PRIVATE_EXPONENT:
 996         case CKA_PRIME_1:
 997         case CKA_PRIME_2:
 998         case CKA_EXPONENT_1:
 999         case CKA_EXPONENT_2:
1000         case CKA_COEFFICIENT:
1001             /* value CK_BYTE[] */
1002             jValueObject = ckByteArrayToJByteArray(env, (CK_BYTE*) ckpAttribute-&gt;pValue, jValueLength);
1003             break;
1004 
1005         case CKA_RESET_ON_INIT:
1006         case CKA_HAS_RESET:
1007         case CKA_TOKEN:
1008         case CKA_PRIVATE:
1009         case CKA_MODIFIABLE:
1010         case CKA_DERIVE:
1011         case CKA_LOCAL:
1012         case CKA_ENCRYPT:
1013         case CKA_VERIFY:
1014         case CKA_VERIFY_RECOVER:
1015         case CKA_WRAP:
1016         case CKA_SENSITIVE:
1017         case CKA_SECONDARY_AUTH:
1018         case CKA_DECRYPT:
1019         case CKA_SIGN:
1020         case CKA_SIGN_RECOVER:
1021         case CKA_UNWRAP:
1022         case CKA_EXTRACTABLE:
1023         case CKA_ALWAYS_SENSITIVE:
1024         case CKA_NEVER_EXTRACTABLE:
1025         case CKA_TRUSTED:
1026             /* value CK_BBOOL */
1027             jValueObject = ckBBoolPtrToJBooleanObject(env, (CK_BBOOL*) ckpAttribute-&gt;pValue);
1028             break;
1029 
1030         case CKA_LABEL:
1031         case CKA_APPLICATION:
1032             /* value RFC 2279 (UTF-8) string */
1033             jValueObject = ckUTF8CharArrayToJCharArray(env, (CK_UTF8CHAR*) ckpAttribute-&gt;pValue, jValueLength);
1034             break;
1035 
1036         case CKA_START_DATE:
1037         case CKA_END_DATE:
1038             /* value CK_DATE */
1039             jValueObject = ckDatePtrToJDateObject(env, (CK_DATE*) ckpAttribute-&gt;pValue);
1040             break;
1041 
1042         case CKA_MODULUS:
1043         case CKA_PUBLIC_EXPONENT:
1044         case CKA_PRIME:
1045         case CKA_SUBPRIME:
1046         case CKA_BASE:
1047             /* value big integer, i.e. CK_BYTE[] */
1048             jValueObject = ckByteArrayToJByteArray(env, (CK_BYTE*) ckpAttribute-&gt;pValue, jValueLength);
1049             break;
1050 
1051         case CKA_AUTH_PIN_FLAGS:
1052             jValueObject = ckULongPtrToJLongObject(env, (CK_ULONG*) ckpAttribute-&gt;pValue);
1053             /* value FLAGS, defacto a CK_ULONG */
1054             break;
1055 
1056         case CKA_VENDOR_DEFINED:
1057             /* we make a CK_BYTE[] out of this */
1058             jValueObject = ckByteArrayToJByteArray(env, (CK_BYTE*) ckpAttribute-&gt;pValue, jValueLength);
1059             break;
1060 
1061         // Netscape trust attributes
1062         case CKA_NETSCAPE_TRUST_SERVER_AUTH:
1063         case CKA_NETSCAPE_TRUST_CLIENT_AUTH:
1064         case CKA_NETSCAPE_TRUST_CODE_SIGNING:
1065         case CKA_NETSCAPE_TRUST_EMAIL_PROTECTION:
1066             /* value CK_ULONG */
1067             jValueObject = ckULongPtrToJLongObject(env, (CK_ULONG*) ckpAttribute-&gt;pValue);
1068             break;
1069 
1070         default:
1071             /* we make a CK_BYTE[] out of this */
1072             jValueObject = ckByteArrayToJByteArray(env, (CK_BYTE*) ckpAttribute-&gt;pValue, jValueLength);
1073             break;
1074     }
1075 
1076     return jValueObject ;
1077 }
1078 
1079 /*
1080  * the following functions convert a Java mechanism parameter object to a PKCS#11
1081  * mechanism parameter structure
1082  *
1083  * CK_&lt;Param&gt;_PARAMS j&lt;Param&gt;ParamToCK&lt;Param&gt;Param(JNIEnv *env,
1084  *                                                 jobject jParam);
1085  *
1086  * These functions get a Java object, that must be the right Java mechanism
1087  * object and they return the new PKCS#11 mechanism parameter structure.
1088  * Every field of the Java object is retrieved, gets converted to a corresponding
1089  * PKCS#11 type and is set in the new PKCS#11 structure.
1090  */
1091 
1092 /*
<a name="167" id="anc167"></a><span class="line-modified">1093  * converts the given Java mechanism parameter to a CK mechanism parameter structure</span>
<span class="line-modified">1094  * and store the length in bytes in the length variable.</span>
<span class="line-removed">1095  * The memory of *ckpParamPtr has to be freed after use!</span>
1096  *
1097  * @param env - used to call JNI funktions to get the Java classes and objects
1098  * @param jParam - the Java mechanism parameter object to convert
<a name="168" id="anc168"></a><span class="line-modified">1099  * @param ckpParamPtr - the reference of the new pointer to the new CK mechanism parameter</span>
<span class="line-removed">1100  *                      structure</span>
1101  * @param ckpLength - the reference of the length in bytes of the new CK mechanism parameter
1102  *                    structure
<a name="169" id="anc169"></a>
1103  */
<a name="170" id="anc170"></a><span class="line-modified">1104 void jMechanismParameterToCKMechanismParameter(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength)</span>

1105 {
<a name="171" id="anc171"></a>
1106     if (jParam == NULL) {
<a name="172" id="anc172"></a><span class="line-modified">1107         *ckpParamPtr = NULL;</span>
1108         *ckpLength = 0;
1109     } else if ((*env)-&gt;IsInstanceOf(env, jParam, jByteArrayClass)) {
<a name="173" id="anc173"></a><span class="line-modified">1110         jByteArrayToCKByteArray(env, jParam, (CK_BYTE_PTR *)ckpParamPtr, ckpLength);</span>
1111     } else if ((*env)-&gt;IsInstanceOf(env, jParam, jLongClass)) {
<a name="174" id="anc174"></a><span class="line-modified">1112         *ckpParamPtr = jLongObjectToCKULongPtr(env, jParam);</span>
1113         *ckpLength = sizeof(CK_ULONG);
1114     } else {
<a name="175" id="anc175"></a><span class="line-modified">1115         TRACE0(&quot;\nSLOW PATH jMechanismParameterToCKMechanismParameter\n&quot;);</span>
<span class="line-removed">1116         jMechanismParameterToCKMechanismParameterSlow(env, jParam, ckpParamPtr, ckpLength);</span>
1117     }
<a name="176" id="anc176"></a>
1118 }
1119 
<a name="177" id="anc177"></a><span class="line-modified">1120 void jMechanismParameterToCKMechanismParameterSlow(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength)</span>

1121 {
<a name="178" id="anc178"></a><span class="line-modified">1122     /* get all Java mechanism parameter classes */</span>
<span class="line-removed">1123     jclass jVersionClass, jSsl3MasterKeyDeriveParamsClass;</span>
<span class="line-removed">1124     jclass jTls12MasterKeyDeriveParamsClass, jSsl3KeyMatParamsClass;</span>
<span class="line-removed">1125     jclass jTls12KeyMatParamsClass;</span>
<span class="line-removed">1126     jclass jTlsPrfParamsClass, jTlsMacParamsClass, jAesCtrParamsClass;</span>
<span class="line-removed">1127     jclass jRsaPkcsOaepParamsClass;</span>
<span class="line-removed">1128     jclass jPbeParamsClass, jPkcs5Pbkd2ParamsClass, jRsaPkcsPssParamsClass;</span>
<span class="line-removed">1129     jclass jEcdh1DeriveParamsClass, jEcdh2DeriveParamsClass;</span>
<span class="line-removed">1130     jclass jX942Dh1DeriveParamsClass, jX942Dh2DeriveParamsClass;</span>
<span class="line-removed">1131     TRACE0(&quot;\nDEBUG: jMechanismParameterToCKMechanismParameter&quot;);</span>
1132 
<a name="179" id="anc179"></a><span class="line-modified">1133     /* most common cases, i.e. NULL/byte[]/long, are already handled by</span>
<span class="line-modified">1134      * jMechanismParameterToCKMechanismParameter before calling this method.</span>

1135      */
<a name="180" id="anc180"></a><span class="line-modified">1136     jVersionClass = (*env)-&gt;FindClass(env, CLASS_VERSION);</span>
<span class="line-modified">1137     if (jVersionClass == NULL) { return; }</span>
<span class="line-modified">1138     if ((*env)-&gt;IsInstanceOf(env, jParam, jVersionClass)) {</span>
<span class="line-modified">1139         /*</span>
<span class="line-modified">1140          * CK_VERSION used by CKM_SSL3_PRE_MASTER_KEY_GEN</span>
<span class="line-modified">1141          */</span>
<span class="line-modified">1142         CK_VERSION_PTR ckpParam;</span>
<span class="line-modified">1143 </span>
<span class="line-modified">1144         /* convert jParameter to CKParameter */</span>
<span class="line-modified">1145         ckpParam = jVersionToCKVersionPtr(env, jParam);</span>
<span class="line-modified">1146 </span>
<span class="line-modified">1147         /* get length and pointer of parameter */</span>
<span class="line-modified">1148         *ckpLength = sizeof(CK_VERSION);</span>
<span class="line-modified">1149         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">1150         return;</span>
<span class="line-modified">1151     }</span>
<span class="line-modified">1152 </span>
<span class="line-modified">1153     jSsl3MasterKeyDeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">1154     if (jSsl3MasterKeyDeriveParamsClass == NULL) { return; }</span>
<span class="line-modified">1155     if ((*env)-&gt;IsInstanceOf(env, jParam, jSsl3MasterKeyDeriveParamsClass)) {</span>
<span class="line-modified">1156         /*</span>
<span class="line-modified">1157          * CK_SSL3_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-modified">1158          */</span>
<span class="line-modified">1159         CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-modified">1160 </span>
<span class="line-modified">1161         ckpParam = (CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR) malloc(sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-modified">1162         if (ckpParam == NULL) {</span>
<span class="line-modified">1163             throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1164             return;</span>
<span class="line-modified">1165         }</span>
<span class="line-modified">1166 </span>
<span class="line-modified">1167         /* convert jParameter to CKParameter */</span>
<span class="line-modified">1168         *ckpParam = jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParam(env, jParam);</span>
<span class="line-modified">1169         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">1170             free(ckpParam);</span>
<span class="line-modified">1171             return;</span>
<span class="line-modified">1172         }</span>
<span class="line-modified">1173 </span>
<span class="line-modified">1174         /* get length and pointer of parameter */</span>
<span class="line-modified">1175         *ckpLength = sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">1176         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">1177         return;</span>
<span class="line-modified">1178     }</span>
<span class="line-modified">1179 </span>
<span class="line-modified">1180     jSsl3KeyMatParamsClass = (*env)-&gt;FindClass(env, CLASS_SSL3_KEY_MAT_PARAMS);</span>
<span class="line-modified">1181     if (jSsl3KeyMatParamsClass == NULL) { return; }</span>
<span class="line-modified">1182     if ((*env)-&gt;IsInstanceOf(env, jParam, jSsl3KeyMatParamsClass)) {</span>
<span class="line-modified">1183         /*</span>
<span class="line-modified">1184          * CK_SSL3_KEY_MAT_PARAMS</span>
<span class="line-modified">1185          */</span>
<span class="line-modified">1186         CK_SSL3_KEY_MAT_PARAMS_PTR ckpParam;</span>
<span class="line-modified">1187 </span>
<span class="line-modified">1188         ckpParam = (CK_SSL3_KEY_MAT_PARAMS_PTR) malloc(sizeof(CK_SSL3_KEY_MAT_PARAMS));</span>
<span class="line-modified">1189         if (ckpParam == NULL) {</span>
<span class="line-modified">1190             throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1191             return;</span>
<span class="line-modified">1192         }</span>
<span class="line-modified">1193 </span>
<span class="line-modified">1194         /* convert jParameter to CKParameter */</span>
<span class="line-modified">1195         *ckpParam = jSsl3KeyMatParamToCKSsl3KeyMatParam(env, jParam);</span>
<span class="line-modified">1196         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">1197             free(ckpParam);</span>
<span class="line-modified">1198             return;</span>
<span class="line-modified">1199         }</span>
<span class="line-modified">1200 </span>
<span class="line-modified">1201         /* get length and pointer of parameter */</span>
<span class="line-modified">1202         *ckpLength = sizeof(CK_SSL3_KEY_MAT_PARAMS);</span>
<span class="line-modified">1203         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">1204         return;</span>
<span class="line-modified">1205     }</span>
<span class="line-modified">1206 </span>
<span class="line-modified">1207     jTls12KeyMatParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS12_KEY_MAT_PARAMS);</span>
<span class="line-modified">1208     if (jTls12KeyMatParamsClass == NULL) { return; }</span>
<span class="line-modified">1209     if ((*env)-&gt;IsInstanceOf(env, jParam, jTls12KeyMatParamsClass)) {</span>
<span class="line-modified">1210         /*</span>
<span class="line-modified">1211          * CK_TLS12_KEY_MAT_PARAMS</span>
<span class="line-modified">1212          */</span>
<span class="line-modified">1213         CK_TLS12_KEY_MAT_PARAMS_PTR ckpParam;</span>
<span class="line-modified">1214 </span>
<span class="line-modified">1215         ckpParam = (CK_TLS12_KEY_MAT_PARAMS_PTR) malloc(sizeof(CK_TLS12_KEY_MAT_PARAMS));</span>
<span class="line-modified">1216         if (ckpParam == NULL) {</span>
<span class="line-modified">1217             throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1218             return;</span>
<span class="line-modified">1219         }</span>
<span class="line-modified">1220 </span>
<span class="line-modified">1221         /* convert jParameter to CKParameter */</span>
<span class="line-modified">1222         *ckpParam = jTls12KeyMatParamToCKTls12KeyMatParam(env, jParam);</span>
<span class="line-modified">1223         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">1224             free(ckpParam);</span>
<span class="line-modified">1225             return;</span>
<span class="line-modified">1226         }</span>
<span class="line-modified">1227 </span>
<span class="line-modified">1228         /* get length and pointer of parameter */</span>
<span class="line-modified">1229         *ckpLength = sizeof(CK_TLS12_KEY_MAT_PARAMS);</span>
<span class="line-modified">1230         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">1231         return;</span>
<span class="line-modified">1232     }</span>
<span class="line-modified">1233 </span>
<span class="line-modified">1234     jTls12MasterKeyDeriveParamsClass =</span>
<span class="line-modified">1235             (*env)-&gt;FindClass(env, CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">1236     if (jTls12MasterKeyDeriveParamsClass == NULL) { return; }</span>
<span class="line-modified">1237     if ((*env)-&gt;IsInstanceOf(env, jParam, jTls12MasterKeyDeriveParamsClass)) {</span>
<span class="line-modified">1238         /*</span>
<span class="line-modified">1239          * CK_TLS12_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-removed">1240          */</span>
<span class="line-removed">1241         CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1242 </span>
<span class="line-removed">1243         ckpParam = (CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR)malloc(</span>
<span class="line-removed">1244                 sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-removed">1245         if (ckpParam == NULL) {</span>
<span class="line-removed">1246             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1247             return;</span>
<span class="line-removed">1248         }</span>
<span class="line-removed">1249 </span>
<span class="line-removed">1250         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1251         *ckpParam = jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParam(env, jParam);</span>
<span class="line-removed">1252         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1253             free(ckpParam);</span>
<span class="line-removed">1254             return;</span>
<span class="line-removed">1255         }</span>
<span class="line-removed">1256 </span>
<span class="line-removed">1257         /* get length and pointer of parameter */</span>
<span class="line-removed">1258         *ckpLength = sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-removed">1259         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1260         return;</span>
<span class="line-removed">1261     }</span>
<span class="line-removed">1262 </span>
<span class="line-removed">1263     jTlsPrfParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_PRF_PARAMS);</span>
<span class="line-removed">1264     if (jTlsPrfParamsClass == NULL) { return; }</span>
<span class="line-removed">1265     if ((*env)-&gt;IsInstanceOf(env, jParam, jTlsPrfParamsClass)) {</span>
<span class="line-removed">1266         /*</span>
<span class="line-removed">1267          * CK_TLS_PRF_PARAMS</span>
<span class="line-removed">1268          */</span>
<span class="line-removed">1269         CK_TLS_PRF_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1270 </span>
<span class="line-removed">1271         ckpParam = (CK_TLS_PRF_PARAMS_PTR) malloc(sizeof(CK_TLS_PRF_PARAMS));</span>
<span class="line-removed">1272         if (ckpParam == NULL) {</span>
<span class="line-removed">1273             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1274             return;</span>
<span class="line-removed">1275         }</span>
<span class="line-removed">1276 </span>
<span class="line-removed">1277         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1278         *ckpParam = jTlsPrfParamsToCKTlsPrfParam(env, jParam);</span>
<span class="line-removed">1279         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1280             free(ckpParam);</span>
<span class="line-removed">1281             return;</span>
<span class="line-removed">1282         }</span>
<span class="line-removed">1283 </span>
<span class="line-removed">1284         /* get length and pointer of parameter */</span>
<span class="line-removed">1285         *ckpLength = sizeof(CK_TLS_PRF_PARAMS);</span>
<span class="line-removed">1286         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1287         return;</span>
<span class="line-removed">1288     }</span>
<span class="line-removed">1289 </span>
<span class="line-removed">1290     jTlsMacParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_MAC_PARAMS);</span>
<span class="line-removed">1291     if (jTlsMacParamsClass == NULL) { return; }</span>
<span class="line-removed">1292     if ((*env)-&gt;IsInstanceOf(env, jParam, jTlsMacParamsClass)) {</span>
<span class="line-removed">1293         CK_TLS_MAC_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1294 </span>
<span class="line-removed">1295         ckpParam = (CK_TLS_MAC_PARAMS_PTR) malloc(sizeof(CK_TLS_MAC_PARAMS));</span>
<span class="line-removed">1296         if (ckpParam == NULL) {</span>
<span class="line-removed">1297             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1298             return;</span>
<span class="line-removed">1299         }</span>
<span class="line-removed">1300 </span>
<span class="line-removed">1301         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1302         *ckpParam = jTlsMacParamsToCKTlsMacParam(env, jParam);</span>
<span class="line-removed">1303         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1304             free(ckpParam);</span>
<span class="line-removed">1305             return;</span>
<span class="line-removed">1306         }</span>
<span class="line-removed">1307 </span>
<span class="line-removed">1308         /* get length and pointer of parameter */</span>
<span class="line-removed">1309         *ckpLength = sizeof(CK_TLS_MAC_PARAMS);</span>
<span class="line-removed">1310         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1311         return;</span>
<span class="line-removed">1312     }</span>
<span class="line-removed">1313 </span>
<span class="line-removed">1314     jAesCtrParamsClass = (*env)-&gt;FindClass(env, CLASS_AES_CTR_PARAMS);</span>
<span class="line-removed">1315     if (jAesCtrParamsClass == NULL) { return; }</span>
<span class="line-removed">1316     if ((*env)-&gt;IsInstanceOf(env, jParam, jAesCtrParamsClass)) {</span>
<span class="line-removed">1317         /*</span>
<span class="line-removed">1318          * CK_AES_CTR_PARAMS</span>
<span class="line-removed">1319          */</span>
<span class="line-removed">1320         CK_AES_CTR_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1321 </span>
<span class="line-removed">1322         ckpParam = (CK_AES_CTR_PARAMS_PTR) malloc(sizeof(CK_AES_CTR_PARAMS));</span>
<span class="line-removed">1323         if (ckpParam == NULL) {</span>
<span class="line-removed">1324             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1325             return;</span>
<span class="line-removed">1326         }</span>
<span class="line-removed">1327 </span>
<span class="line-removed">1328         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1329         jAesCtrParamsToCKAesCtrParam(env, jParam, ckpParam);</span>
<span class="line-removed">1330         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1331             free(ckpParam);</span>
<span class="line-removed">1332             return;</span>
<span class="line-removed">1333         }</span>
<span class="line-removed">1334 </span>
<span class="line-removed">1335         /* get length and pointer of parameter */</span>
<span class="line-removed">1336         *ckpLength = sizeof(CK_AES_CTR_PARAMS);</span>
<span class="line-removed">1337         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1338         return;</span>
<span class="line-removed">1339     }</span>
<span class="line-removed">1340 </span>
<span class="line-removed">1341     jRsaPkcsOaepParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_OAEP_PARAMS);</span>
<span class="line-removed">1342     if (jRsaPkcsOaepParamsClass == NULL) { return; }</span>
<span class="line-removed">1343     if ((*env)-&gt;IsInstanceOf(env, jParam, jRsaPkcsOaepParamsClass)) {</span>
<span class="line-removed">1344         /*</span>
<span class="line-removed">1345          * CK_RSA_PKCS_OAEP_PARAMS</span>
<span class="line-removed">1346          */</span>
<span class="line-removed">1347         CK_RSA_PKCS_OAEP_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1348 </span>
<span class="line-removed">1349         ckpParam = (CK_RSA_PKCS_OAEP_PARAMS_PTR) malloc(sizeof(CK_RSA_PKCS_OAEP_PARAMS));</span>
<span class="line-removed">1350         if (ckpParam == NULL) {</span>
<span class="line-removed">1351             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1352             return;</span>
<span class="line-removed">1353         }</span>
<span class="line-removed">1354 </span>
<span class="line-removed">1355         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1356         *ckpParam = jRsaPkcsOaepParamToCKRsaPkcsOaepParam(env, jParam);</span>
<span class="line-removed">1357         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1358             free(ckpParam);</span>
<span class="line-removed">1359             return;</span>
<span class="line-removed">1360         }</span>
<span class="line-removed">1361 </span>
<span class="line-removed">1362         /* get length and pointer of parameter */</span>
<span class="line-removed">1363         *ckpLength = sizeof(CK_RSA_PKCS_OAEP_PARAMS);</span>
<span class="line-removed">1364         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1365         return;</span>
<span class="line-removed">1366     }</span>
<span class="line-removed">1367 </span>
<span class="line-removed">1368     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);</span>
<span class="line-removed">1369     if (jPbeParamsClass == NULL) { return; }</span>
<span class="line-removed">1370     if ((*env)-&gt;IsInstanceOf(env, jParam, jPbeParamsClass)) {</span>
<span class="line-removed">1371         /*</span>
<span class="line-removed">1372          * CK_PBE_PARAMS</span>
<span class="line-removed">1373          */</span>
<span class="line-removed">1374         CK_PBE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1375 </span>
<span class="line-removed">1376         ckpParam = (CK_PBE_PARAMS_PTR) malloc(sizeof(CK_PBE_PARAMS));</span>
<span class="line-removed">1377         if (ckpParam == NULL) {</span>
<span class="line-removed">1378             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1379             return;</span>
<span class="line-removed">1380         }</span>
<span class="line-removed">1381 </span>
<span class="line-removed">1382         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1383         *ckpParam = jPbeParamToCKPbeParam(env, jParam);</span>
<span class="line-removed">1384         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1385             free(ckpParam);</span>
<span class="line-removed">1386             return;</span>
<span class="line-removed">1387         }</span>
<span class="line-removed">1388 </span>
<span class="line-removed">1389         /* get length and pointer of parameter */</span>
<span class="line-removed">1390         *ckpLength = sizeof(CK_PBE_PARAMS);</span>
<span class="line-removed">1391         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1392         return;</span>
<span class="line-removed">1393     }</span>
<span class="line-removed">1394 </span>
<span class="line-removed">1395     jPkcs5Pbkd2ParamsClass = (*env)-&gt;FindClass(env, CLASS_PKCS5_PBKD2_PARAMS);</span>
<span class="line-removed">1396     if (jPkcs5Pbkd2ParamsClass == NULL) { return; }</span>
<span class="line-removed">1397     if ((*env)-&gt;IsInstanceOf(env, jParam, jPkcs5Pbkd2ParamsClass)) {</span>
<span class="line-removed">1398         /*</span>
<span class="line-removed">1399          * CK_PKCS5_PBKD2_PARAMS</span>
<span class="line-removed">1400          */</span>
<span class="line-removed">1401         CK_PKCS5_PBKD2_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1402 </span>
<span class="line-removed">1403         ckpParam = (CK_PKCS5_PBKD2_PARAMS_PTR) malloc(sizeof(CK_PKCS5_PBKD2_PARAMS));</span>
<span class="line-removed">1404         if (ckpParam == NULL) {</span>
<span class="line-removed">1405             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1406             return;</span>
<span class="line-removed">1407         }</span>
<span class="line-removed">1408 </span>
<span class="line-removed">1409         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1410         *ckpParam = jPkcs5Pbkd2ParamToCKPkcs5Pbkd2Param(env, jParam);</span>
<span class="line-removed">1411         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1412             free(ckpParam);</span>
<span class="line-removed">1413             return;</span>
<span class="line-removed">1414         }</span>
<span class="line-removed">1415 </span>
<span class="line-removed">1416         /* get length and pointer of parameter */</span>
<span class="line-removed">1417         *ckpLength = sizeof(CK_PKCS5_PBKD2_PARAMS);</span>
<span class="line-removed">1418         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1419         return;</span>
<span class="line-removed">1420     }</span>
<span class="line-removed">1421 </span>
<span class="line-removed">1422     jRsaPkcsPssParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_PSS_PARAMS);</span>
<span class="line-removed">1423     if (jRsaPkcsPssParamsClass == NULL) { return; }</span>
<span class="line-removed">1424     if ((*env)-&gt;IsInstanceOf(env, jParam, jRsaPkcsPssParamsClass)) {</span>
<span class="line-removed">1425         /*</span>
<span class="line-removed">1426          * CK_RSA_PKCS_PSS_PARAMS</span>
<span class="line-removed">1427          */</span>
<span class="line-removed">1428         CK_RSA_PKCS_PSS_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1429 </span>
<span class="line-removed">1430         ckpParam = (CK_RSA_PKCS_PSS_PARAMS_PTR) malloc(sizeof(CK_RSA_PKCS_PSS_PARAMS));</span>
<span class="line-removed">1431         if (ckpParam == NULL) {</span>
<span class="line-removed">1432             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1433             return;</span>
<span class="line-removed">1434         }</span>
<span class="line-removed">1435 </span>
<span class="line-removed">1436         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1437         *ckpParam = jRsaPkcsPssParamToCKRsaPkcsPssParam(env, jParam);</span>
<span class="line-removed">1438         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1439             free(ckpParam);</span>
<span class="line-removed">1440             return;</span>
<span class="line-removed">1441         }</span>
<span class="line-removed">1442 </span>
<span class="line-removed">1443         /* get length and pointer of parameter */</span>
<span class="line-removed">1444         *ckpLength = sizeof(CK_RSA_PKCS_PSS_PARAMS);</span>
<span class="line-removed">1445         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1446         return;</span>
<span class="line-removed">1447     }</span>
<span class="line-removed">1448 </span>
<span class="line-removed">1449     jEcdh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH1_DERIVE_PARAMS);</span>
<span class="line-removed">1450     if (jEcdh1DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">1451     if ((*env)-&gt;IsInstanceOf(env, jParam, jEcdh1DeriveParamsClass)) {</span>
<span class="line-removed">1452         /*</span>
<span class="line-removed">1453          * CK_ECDH1_DERIVE_PARAMS</span>
<span class="line-removed">1454          */</span>
<span class="line-removed">1455         CK_ECDH1_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1456 </span>
<span class="line-removed">1457         ckpParam = (CK_ECDH1_DERIVE_PARAMS_PTR) malloc(sizeof(CK_ECDH1_DERIVE_PARAMS));</span>
<span class="line-removed">1458         if (ckpParam == NULL) {</span>
<span class="line-removed">1459             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1460             return;</span>
<span class="line-removed">1461         }</span>
<span class="line-removed">1462 </span>
<span class="line-removed">1463         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1464         *ckpParam = jEcdh1DeriveParamToCKEcdh1DeriveParam(env, jParam);</span>
<span class="line-removed">1465         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1466             free(ckpParam);</span>
<span class="line-removed">1467             return;</span>
<span class="line-removed">1468         }</span>
<span class="line-removed">1469 </span>
<span class="line-removed">1470         /* get length and pointer of parameter */</span>
<span class="line-removed">1471         *ckpLength = sizeof(CK_ECDH1_DERIVE_PARAMS);</span>
<span class="line-removed">1472         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1473         return;</span>
<span class="line-removed">1474     }</span>
<span class="line-removed">1475 </span>
<span class="line-removed">1476     jEcdh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH2_DERIVE_PARAMS);</span>
<span class="line-removed">1477     if (jEcdh2DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">1478     if ((*env)-&gt;IsInstanceOf(env, jParam, jEcdh2DeriveParamsClass)) {</span>
<span class="line-removed">1479         /*</span>
<span class="line-removed">1480          * CK_ECDH2_DERIVE_PARAMS</span>
<span class="line-removed">1481          */</span>
<span class="line-removed">1482         CK_ECDH2_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1483 </span>
<span class="line-removed">1484         ckpParam = (CK_ECDH2_DERIVE_PARAMS_PTR) malloc(sizeof(CK_ECDH2_DERIVE_PARAMS));</span>
<span class="line-removed">1485         if (ckpParam == NULL) {</span>
<span class="line-removed">1486             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1487             return;</span>
<span class="line-removed">1488         }</span>
<span class="line-removed">1489 </span>
<span class="line-removed">1490         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1491         *ckpParam = jEcdh2DeriveParamToCKEcdh2DeriveParam(env, jParam);</span>
<span class="line-removed">1492         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1493             free(ckpParam);</span>
<span class="line-removed">1494             return;</span>
<span class="line-removed">1495         }</span>
<span class="line-removed">1496 </span>
<span class="line-removed">1497         /* get length and pointer of parameter */</span>
<span class="line-removed">1498         *ckpLength = sizeof(CK_ECDH2_DERIVE_PARAMS);</span>
<span class="line-removed">1499         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1500         return;</span>
<span class="line-removed">1501     }</span>
<span class="line-removed">1502 </span>
<span class="line-removed">1503     jX942Dh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH1_DERIVE_PARAMS);</span>
<span class="line-removed">1504     if (jX942Dh1DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">1505     if ((*env)-&gt;IsInstanceOf(env, jParam, jX942Dh1DeriveParamsClass)) {</span>
<span class="line-removed">1506         /*</span>
<span class="line-removed">1507          * CK_X9_42_DH1_DERIVE_PARAMS</span>
<span class="line-removed">1508          */</span>
<span class="line-removed">1509         CK_X9_42_DH1_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1510 </span>
<span class="line-removed">1511         ckpParam = (CK_X9_42_DH1_DERIVE_PARAMS_PTR) malloc(sizeof(CK_X9_42_DH1_DERIVE_PARAMS));</span>
<span class="line-removed">1512         if (ckpParam == NULL) {</span>
<span class="line-removed">1513             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1514             return;</span>
<span class="line-removed">1515         }</span>
<span class="line-removed">1516 </span>
<span class="line-removed">1517         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1518         *ckpParam = jX942Dh1DeriveParamToCKX942Dh1DeriveParam(env, jParam);</span>
<span class="line-removed">1519         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1520             free(ckpParam);</span>
<span class="line-removed">1521             return;</span>
<span class="line-removed">1522         }</span>
<span class="line-removed">1523 </span>
<span class="line-removed">1524         /* get length and pointer of parameter */</span>
<span class="line-removed">1525         *ckpLength = sizeof(CK_X9_42_DH1_DERIVE_PARAMS);</span>
<span class="line-removed">1526         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1527         return;</span>
1528     }
<a name="181" id="anc181"></a>
1529 
<a name="182" id="anc182"></a><span class="line-modified">1530     jX942Dh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH2_DERIVE_PARAMS);</span>
<span class="line-modified">1531     if (jX942Dh2DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">1532     if ((*env)-&gt;IsInstanceOf(env, jParam, jX942Dh2DeriveParamsClass)) {</span>
<span class="line-removed">1533         /*</span>
<span class="line-removed">1534          * CK_X9_42_DH2_DERIVE_PARAMS</span>
<span class="line-removed">1535          */</span>
<span class="line-removed">1536         CK_X9_42_DH2_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1537 </span>
<span class="line-removed">1538         ckpParam = (CK_X9_42_DH2_DERIVE_PARAMS_PTR) malloc(sizeof(CK_X9_42_DH2_DERIVE_PARAMS));</span>
<span class="line-removed">1539         if (ckpParam == NULL) {</span>
<span class="line-removed">1540             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1541             return;</span>
<span class="line-removed">1542         }</span>
<span class="line-removed">1543 </span>
<span class="line-removed">1544         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1545         *ckpParam = jX942Dh2DeriveParamToCKX942Dh2DeriveParam(env, jParam);</span>
<span class="line-removed">1546         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1547             free(ckpParam);</span>
<span class="line-removed">1548             return;</span>
<span class="line-removed">1549         }</span>
<span class="line-removed">1550 </span>
<span class="line-removed">1551         /* get length and pointer of parameter */</span>
<span class="line-removed">1552         *ckpLength = sizeof(CK_X9_42_DH2_DERIVE_PARAMS);</span>
<span class="line-removed">1553         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1554         return;</span>
1555     }
1556 
<a name="183" id="anc183"></a><span class="line-modified">1557     /* if everything faild up to here */</span>
<span class="line-removed">1558     /* try if the parameter is a primitive Java type */</span>
<span class="line-removed">1559     jObjectToPrimitiveCKObjectPtrPtr(env, jParam, ckpParamPtr, ckpLength);</span>
<span class="line-removed">1560     /* *ckpParamPtr = jObjectToCKVoidPtr(jParam); */</span>
<span class="line-removed">1561     /* *ckpLength = 1; */</span>
<span class="line-removed">1562 </span>
<span class="line-removed">1563     TRACE0(&quot;FINISHED\n&quot;);</span>
1564 }
1565 
<a name="184" id="anc184"></a><span class="line-removed">1566 </span>
<span class="line-removed">1567 /* the mechanism parameter convertion functions: */</span>
<span class="line-removed">1568 </span>
1569 /*
<a name="185" id="anc185"></a><span class="line-modified">1570  * converts the Java CK_RSA_PKCS_OAEP_PARAMS object to a CK_RSA_PKCS_OAEP_PARAMS structure</span>

1571  *
1572  * @param env - used to call JNI funktions to get the Java classes and objects
1573  * @param jParam - the Java CK_RSA_PKCS_OAEP_PARAMS object to convert
<a name="186" id="anc186"></a><span class="line-modified">1574  * @return - the new CK_RSA_PKCS_OAEP_PARAMS structure</span>

1575  */
<a name="187" id="anc187"></a><span class="line-modified">1576 CK_RSA_PKCS_OAEP_PARAMS jRsaPkcsOaepParamToCKRsaPkcsOaepParam(JNIEnv *env, jobject jParam)</span>

1577 {
<a name="188" id="anc188"></a>
1578     jclass jRsaPkcsOaepParamsClass;
<a name="189" id="anc189"></a><span class="line-removed">1579     CK_RSA_PKCS_OAEP_PARAMS ckParam;</span>
1580     jfieldID fieldID;
1581     jlong jHashAlg, jMgf, jSource;
1582     jobject jSourceData;
<a name="190" id="anc190"></a><span class="line-removed">1583     CK_BYTE_PTR ckpByte;</span>
<span class="line-removed">1584     memset(&amp;ckParam, 0, sizeof(CK_RSA_PKCS_OAEP_PARAMS));</span>
1585 
<a name="191" id="anc191"></a><span class="line-modified">1586     /* get hashAlg */</span>




1587     jRsaPkcsOaepParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_OAEP_PARAMS);
<a name="192" id="anc192"></a><span class="line-modified">1588     if (jRsaPkcsOaepParamsClass == NULL) { return ckParam; }</span>
1589     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<a name="193" id="anc193"></a><span class="line-modified">1590     if (fieldID == NULL) { return ckParam; }</span>
1591     jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="194" id="anc194"></a><span class="line-removed">1592 </span>
<span class="line-removed">1593     /* get mgf */</span>
1594     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<a name="195" id="anc195"></a><span class="line-modified">1595     if (fieldID == NULL) { return ckParam; }</span>
1596     jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="196" id="anc196"></a><span class="line-removed">1597 </span>
<span class="line-removed">1598     /* get source */</span>
1599     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;source&quot;, &quot;J&quot;);
<a name="197" id="anc197"></a><span class="line-modified">1600     if (fieldID == NULL) { return ckParam; }</span>
1601     jSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="198" id="anc198"></a><span class="line-removed">1602 </span>
<span class="line-removed">1603     /* get sourceData and sourceDataLength */</span>
1604     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;pSourceData&quot;, &quot;[B&quot;);
<a name="199" id="anc199"></a><span class="line-modified">1605     if (fieldID == NULL) { return ckParam; }</span>
1606     jSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1607 
<a name="200" id="anc200"></a><span class="line-modified">1608     /* populate java values */</span>
<span class="line-modified">1609     ckParam.hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-modified">1610     ckParam.mgf = jLongToCKULong(jMgf);</span>
<span class="line-modified">1611     ckParam.source = jLongToCKULong(jSource);</span>
<span class="line-modified">1612     jByteArrayToCKByteArray(env, jSourceData, &amp; ckpByte, &amp;(ckParam.ulSourceDataLen));</span>
<span class="line-modified">1613     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1614     ckParam.pSourceData = (CK_VOID_PTR) ckpByte;</span>










1615 
<a name="201" id="anc201"></a><span class="line-modified">1616     return ckParam ;</span>



1617 }
1618 
1619 /*
<a name="202" id="anc202"></a><span class="line-modified">1620  * converts the Java CK_PBE_PARAMS object to a CK_PBE_PARAMS structure</span>
1621  *
1622  * @param env - used to call JNI funktions to get the Java classes and objects
1623  * @param jParam - the Java CK_PBE_PARAMS object to convert
<a name="203" id="anc203"></a><span class="line-modified">1624  * @return - the new CK_PBE_PARAMS structure</span>

1625  */
<a name="204" id="anc204"></a><span class="line-modified">1626 CK_PBE_PARAMS jPbeParamToCKPbeParam(JNIEnv *env, jobject jParam)</span>

1627 {
<a name="205" id="anc205"></a>
1628     jclass jPbeParamsClass;
<a name="206" id="anc206"></a><span class="line-removed">1629     CK_PBE_PARAMS ckParam;</span>
1630     jfieldID fieldID;
1631     jlong jIteration;
1632     jobject jInitVector, jPassword, jSalt;
1633     CK_ULONG ckTemp;
<a name="207" id="anc207"></a><span class="line-removed">1634     memset(&amp;ckParam, 0, sizeof(CK_PBE_PARAMS));</span>
1635 
<a name="208" id="anc208"></a><span class="line-modified">1636     /* get pInitVector */</span>




1637     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
<a name="209" id="anc209"></a><span class="line-modified">1638     if (jPbeParamsClass == NULL) { return ckParam; }</span>
1639     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVector&quot;, &quot;[C&quot;);
<a name="210" id="anc210"></a><span class="line-modified">1640     if (fieldID == NULL) { return ckParam; }</span>
1641     jInitVector = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="211" id="anc211"></a><span class="line-removed">1642 </span>
<span class="line-removed">1643     /* get pPassword and ulPasswordLength */</span>
1644     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pPassword&quot;, &quot;[C&quot;);
<a name="212" id="anc212"></a><span class="line-modified">1645     if (fieldID == NULL) { return ckParam; }</span>
1646     jPassword = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="213" id="anc213"></a><span class="line-removed">1647 </span>
<span class="line-removed">1648     /* get pSalt and ulSaltLength */</span>
1649     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pSalt&quot;, &quot;[C&quot;);
<a name="214" id="anc214"></a><span class="line-modified">1650     if (fieldID == NULL) { return ckParam; }</span>
1651     jSalt = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="215" id="anc215"></a><span class="line-removed">1652 </span>
<span class="line-removed">1653     /* get ulIteration */</span>
1654     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;ulIteration&quot;, &quot;J&quot;);
<a name="216" id="anc216"></a><span class="line-modified">1655     if (fieldID == NULL) { return ckParam; }</span>
1656     jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
1657 
<a name="217" id="anc217"></a><span class="line-modified">1658     /* populate java values */</span>
<span class="line-modified">1659     ckParam.ulIteration = jLongToCKULong(jIteration);</span>
<span class="line-modified">1660     jCharArrayToCKCharArray(env, jInitVector, &amp;(ckParam.pInitVector), &amp;ckTemp);</span>
<span class="line-modified">1661     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1662     jCharArrayToCKCharArray(env, jPassword, &amp;(ckParam.pPassword), &amp;(ckParam.ulPasswordLen));</span>









1663     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="218" id="anc218"></a><span class="line-modified">1664         free(ckParam.pInitVector);</span>
<span class="line-removed">1665         return ckParam;</span>
1666     }
<a name="219" id="anc219"></a><span class="line-modified">1667     jCharArrayToCKCharArray(env, jSalt, &amp;(ckParam.pSalt), &amp;(ckParam.ulSaltLen));</span>
1668     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="220" id="anc220"></a><span class="line-modified">1669         free(ckParam.pInitVector);</span>
<span class="line-removed">1670         free(ckParam.pPassword);</span>
<span class="line-removed">1671         return ckParam;</span>
1672     }
1673 
<a name="221" id="anc221"></a><span class="line-modified">1674     return ckParam ;</span>









1675 }
1676 
1677 /*
1678  * Copy back the initialization vector from the native structure to the
1679  * Java object. This is only used for CKM_PBE_* mechanisms and their
1680  * CK_PBE_PARAMS parameters.
1681  *
1682  */
1683 void copyBackPBEInitializationVector(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism)
1684 {
1685     jclass jMechanismClass, jPbeParamsClass;
1686     CK_PBE_PARAMS *ckParam;
1687     jfieldID fieldID;
1688     CK_MECHANISM_TYPE ckMechanismType;
1689     jlong jMechanismType;
1690     jobject jParameter;
1691     jobject jInitVector;
1692     jint jInitVectorLength;
1693     CK_CHAR_PTR initVector;
1694     int i;
1695     jchar* jInitVectorChars;
1696 
1697     /* get mechanism */
1698     jMechanismClass = (*env)-&gt;FindClass(env, CLASS_MECHANISM);
1699     if (jMechanismClass == NULL) { return; }
1700     fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;mechanism&quot;, &quot;J&quot;);
1701     if (fieldID == NULL) { return; }
1702     jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, fieldID);
1703     ckMechanismType = jLongToCKULong(jMechanismType);
1704     if (ckMechanismType != ckMechanism-&gt;mechanism) {
<a name="222" id="anc222"></a><span class="line-modified">1705         /* we do not have maching types, this should not occur */</span>
1706         return;
1707     }
1708 
1709     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
1710     if (jPbeParamsClass == NULL) { return; }
1711     ckParam = (CK_PBE_PARAMS *) ckMechanism-&gt;pParameter;
1712     if (ckParam != NULL_PTR) {
1713         initVector = ckParam-&gt;pInitVector;
1714         if (initVector != NULL_PTR) {
1715             /* get pParameter */
1716             fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;pParameter&quot;, &quot;Ljava/lang/Object;&quot;);
1717             if (fieldID == NULL) { return; }
1718             jParameter = (*env)-&gt;GetObjectField(env, jMechanism, fieldID);
1719             fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVektor&quot;, &quot;[C&quot;);
1720             if (fieldID == NULL) { return; }
1721             jInitVector = (*env)-&gt;GetObjectField(env, jParameter, fieldID);
1722 
1723             if (jInitVector != NULL) {
1724                 jInitVectorLength = (*env)-&gt;GetArrayLength(env, jInitVector);
1725                 jInitVectorChars = (*env)-&gt;GetCharArrayElements(env, jInitVector, NULL);
1726                 if (jInitVectorChars == NULL) { return; }
1727 
1728                 /* copy the chars to the Java buffer */
1729                 for (i=0; i &lt; jInitVectorLength; i++) {
1730                     jInitVectorChars[i] = ckCharToJChar(initVector[i]);
1731                 }
1732                 /* copy back the Java buffer to the object */
1733                 (*env)-&gt;ReleaseCharArrayElements(env, jInitVector, jInitVectorChars, 0);
1734             }
1735         }
1736     }
1737 }
1738 
1739 /*
<a name="223" id="anc223"></a><span class="line-modified">1740  * converts the Java CK_PKCS5_PBKD2_PARAMS object to a CK_PKCS5_PBKD2_PARAMS structure</span>

1741  *
1742  * @param env - used to call JNI funktions to get the Java classes and objects
1743  * @param jParam - the Java CK_PKCS5_PBKD2_PARAMS object to convert
<a name="224" id="anc224"></a><span class="line-modified">1744  * @return - the new CK_PKCS5_PBKD2_PARAMS structure</span>

1745  */
<a name="225" id="anc225"></a><span class="line-modified">1746 CK_PKCS5_PBKD2_PARAMS jPkcs5Pbkd2ParamToCKPkcs5Pbkd2Param(JNIEnv *env, jobject jParam)</span>

1747 {
<a name="226" id="anc226"></a>
1748     jclass jPkcs5Pbkd2ParamsClass;
<a name="227" id="anc227"></a><span class="line-removed">1749     CK_PKCS5_PBKD2_PARAMS ckParam;</span>
1750     jfieldID fieldID;
1751     jlong jSaltSource, jIteration, jPrf;
1752     jobject jSaltSourceData, jPrfData;
<a name="228" id="anc228"></a><span class="line-removed">1753     memset(&amp;ckParam, 0, sizeof(CK_PKCS5_PBKD2_PARAMS));</span>
1754 
<a name="229" id="anc229"></a><span class="line-modified">1755     /* get saltSource */</span>




1756     jPkcs5Pbkd2ParamsClass = (*env)-&gt;FindClass(env, CLASS_PKCS5_PBKD2_PARAMS);
<a name="230" id="anc230"></a><span class="line-modified">1757     if (jPkcs5Pbkd2ParamsClass == NULL) { return ckParam; }</span>
1758     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;saltSource&quot;, &quot;J&quot;);
<a name="231" id="anc231"></a><span class="line-modified">1759     if (fieldID == NULL) { return ckParam; }</span>
1760     jSaltSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="232" id="anc232"></a><span class="line-removed">1761 </span>
<span class="line-removed">1762     /* get pSaltSourceData */</span>
1763     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pSaltSourceData&quot;, &quot;[B&quot;);
<a name="233" id="anc233"></a><span class="line-modified">1764     if (fieldID == NULL) { return ckParam; }</span>
1765     jSaltSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="234" id="anc234"></a><span class="line-removed">1766 </span>
<span class="line-removed">1767     /* get iterations */</span>
1768     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;iterations&quot;, &quot;J&quot;);
<a name="235" id="anc235"></a><span class="line-modified">1769     if (fieldID == NULL) { return ckParam; }</span>
1770     jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="236" id="anc236"></a><span class="line-removed">1771 </span>
<span class="line-removed">1772     /* get prf */</span>
1773     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;prf&quot;, &quot;J&quot;);
<a name="237" id="anc237"></a><span class="line-modified">1774     if (fieldID == NULL) { return ckParam; }</span>
1775     jPrf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="238" id="anc238"></a><span class="line-removed">1776 </span>
<span class="line-removed">1777     /* get pPrfData and ulPrfDataLength in byte */</span>
1778     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pPrfData&quot;, &quot;[B&quot;);
<a name="239" id="anc239"></a><span class="line-modified">1779     if (fieldID == NULL) { return ckParam; }</span>
1780     jPrfData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1781 
<a name="240" id="anc240"></a><span class="line-modified">1782     /* populate java values */</span>
<span class="line-modified">1783     ckParam.saltSource = jLongToCKULong(jSaltSource);</span>
<span class="line-modified">1784     jByteArrayToCKByteArray(env, jSaltSourceData, (CK_BYTE_PTR *) &amp;(ckParam.pSaltSourceData), &amp;(ckParam.ulSaltSourceDataLen));</span>
<span class="line-modified">1785     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1786     ckParam.iterations = jLongToCKULong(jIteration);</span>
<span class="line-modified">1787     ckParam.prf = jLongToCKULong(jPrf);</span>
<span class="line-modified">1788     jByteArrayToCKByteArray(env, jPrfData, (CK_BYTE_PTR *) &amp;(ckParam.pPrfData), &amp;(ckParam.ulPrfDataLen));</span>




1789     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="241" id="anc241"></a><span class="line-modified">1790         free(ckParam.pSaltSourceData);</span>
<span class="line-modified">1791         return ckParam;</span>










1792     }
<a name="242" id="anc242"></a>





1793 
<a name="243" id="anc243"></a><span class="line-removed">1794     return ckParam ;</span>
1795 }
1796 
1797 /*
<a name="244" id="anc244"></a><span class="line-modified">1798  * converts the Java CK_RSA_PKCS_PSS_PARAMS object to a CK_RSA_PKCS_PSS_PARAMS structure</span>

1799  *
1800  * @param env - used to call JNI funktions to get the Java classes and objects
1801  * @param jParam - the Java CK_RSA_PKCS_PSS_PARAMS object to convert
<a name="245" id="anc245"></a><span class="line-modified">1802  * @return - the new CK_RSA_PKCS_PSS_PARAMS structure</span>

1803  */
<a name="246" id="anc246"></a><span class="line-modified">1804 CK_RSA_PKCS_PSS_PARAMS jRsaPkcsPssParamToCKRsaPkcsPssParam(JNIEnv *env, jobject jParam)</span>

1805 {
<a name="247" id="anc247"></a>
1806     jclass jRsaPkcsPssParamsClass;
<a name="248" id="anc248"></a><span class="line-removed">1807     CK_RSA_PKCS_PSS_PARAMS ckParam;</span>
1808     jfieldID fieldID;
1809     jlong jHashAlg, jMgf, jSLen;
<a name="249" id="anc249"></a><span class="line-removed">1810     memset(&amp;ckParam, 0, sizeof(CK_RSA_PKCS_PSS_PARAMS));</span>
1811 
<a name="250" id="anc250"></a><span class="line-modified">1812     /* get hashAlg */</span>




1813     jRsaPkcsPssParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_PSS_PARAMS);
<a name="251" id="anc251"></a><span class="line-modified">1814     if (jRsaPkcsPssParamsClass == NULL) { return ckParam; }</span>
1815     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<a name="252" id="anc252"></a><span class="line-modified">1816     if (fieldID == NULL) { return ckParam; }</span>
1817     jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="253" id="anc253"></a><span class="line-removed">1818 </span>
<span class="line-removed">1819     /* get mgf */</span>
1820     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<a name="254" id="anc254"></a><span class="line-modified">1821     if (fieldID == NULL) { return ckParam; }</span>
1822     jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="255" id="anc255"></a><span class="line-removed">1823 </span>
<span class="line-removed">1824     /* get sLen */</span>
1825     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;sLen&quot;, &quot;J&quot;);
<a name="256" id="anc256"></a><span class="line-modified">1826     if (fieldID == NULL) { return ckParam; }</span>
1827     jSLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
1828 
<a name="257" id="anc257"></a><span class="line-modified">1829     /* populate java values */</span>
<span class="line-modified">1830     ckParam.hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-modified">1831     ckParam.mgf = jLongToCKULong(jMgf);</span>
<span class="line-modified">1832     ckParam.sLen = jLongToCKULong(jSLen);</span>















1833 
<a name="258" id="anc258"></a><span class="line-removed">1834     return ckParam ;</span>
1835 }
1836 
1837 /*
<a name="259" id="anc259"></a><span class="line-modified">1838  * converts the Java CK_ECDH1_DERIVE_PARAMS object to a CK_ECDH1_DERIVE_PARAMS structure</span>

1839  *
1840  * @param env - used to call JNI funktions to get the Java classes and objects
1841  * @param jParam - the Java CK_ECDH1_DERIVE_PARAMS object to convert
<a name="260" id="anc260"></a><span class="line-modified">1842  * @return - the new CK_ECDH1_DERIVE_PARAMS structure</span>

1843  */
<a name="261" id="anc261"></a><span class="line-modified">1844 CK_ECDH1_DERIVE_PARAMS jEcdh1DeriveParamToCKEcdh1DeriveParam(JNIEnv *env, jobject jParam)</span>

1845 {
<a name="262" id="anc262"></a>
1846     jclass jEcdh1DeriveParamsClass;
<a name="263" id="anc263"></a><span class="line-removed">1847     CK_ECDH1_DERIVE_PARAMS ckParam;</span>
1848     jfieldID fieldID;
1849     jlong jLong;
1850     jobject jSharedData, jPublicData;
<a name="264" id="anc264"></a><span class="line-removed">1851     memset(&amp;ckParam, 0, sizeof(CK_ECDH1_DERIVE_PARAMS));</span>
1852 
<a name="265" id="anc265"></a><span class="line-modified">1853     /* get kdf */</span>




1854     jEcdh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH1_DERIVE_PARAMS);
<a name="266" id="anc266"></a><span class="line-modified">1855     if (jEcdh1DeriveParamsClass == NULL) { return ckParam; }</span>
1856     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<a name="267" id="anc267"></a><span class="line-modified">1857     if (fieldID == NULL) { return ckParam; }</span>
1858     jLong = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="268" id="anc268"></a><span class="line-removed">1859     ckParam.kdf = jLongToCKULong(jLong);</span>
<span class="line-removed">1860 </span>
<span class="line-removed">1861     /* get pSharedData and ulSharedDataLen */</span>
1862     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<a name="269" id="anc269"></a><span class="line-modified">1863     if (fieldID == NULL) { return ckParam; }</span>
1864     jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="270" id="anc270"></a><span class="line-removed">1865 </span>
<span class="line-removed">1866     /* get pPublicData and ulPublicDataLen */</span>
1867     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<a name="271" id="anc271"></a><span class="line-modified">1868     if (fieldID == NULL) { return ckParam; }</span>
1869     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1870 
<a name="272" id="anc272"></a><span class="line-modified">1871     /* populate java values */</span>
<span class="line-modified">1872     ckParam.kdf = jLongToCKULong(jLong);</span>
<span class="line-modified">1873     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParam.pSharedData), &amp;(ckParam.ulSharedDataLen));</span>
<span class="line-modified">1874     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1875     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>











1876     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="273" id="anc273"></a><span class="line-modified">1877         free(ckParam.pSharedData);</span>
<span class="line-removed">1878         return ckParam;</span>
1879     }
1880 
<a name="274" id="anc274"></a><span class="line-modified">1881     return ckParam ;</span>








1882 }
1883 
1884 /*
<a name="275" id="anc275"></a><span class="line-modified">1885  * converts the Java CK_ECDH2_DERIVE_PARAMS object to a CK_ECDH2_DERIVE_PARAMS structure</span>

1886  *
1887  * @param env - used to call JNI funktions to get the Java classes and objects
1888  * @param jParam - the Java CK_ECDH2_DERIVE_PARAMS object to convert
<a name="276" id="anc276"></a><span class="line-modified">1889  * @return - the new CK_ECDH2_DERIVE_PARAMS structure</span>

1890  */
<a name="277" id="anc277"></a><span class="line-modified">1891 CK_ECDH2_DERIVE_PARAMS jEcdh2DeriveParamToCKEcdh2DeriveParam(JNIEnv *env, jobject jParam)</span>

1892 {
<a name="278" id="anc278"></a>
1893     jclass jEcdh2DeriveParamsClass;
<a name="279" id="anc279"></a><span class="line-removed">1894     CK_ECDH2_DERIVE_PARAMS ckParam;</span>
1895     jfieldID fieldID;
1896     jlong jKdf, jPrivateDataLen, jPrivateData;
1897     jobject jSharedData, jPublicData, jPublicData2;
<a name="280" id="anc280"></a><span class="line-removed">1898     memset(&amp;ckParam, 0, sizeof(CK_ECDH2_DERIVE_PARAMS));</span>
1899 
<a name="281" id="anc281"></a><span class="line-modified">1900     /* get kdf */</span>
1901     jEcdh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH2_DERIVE_PARAMS);
<a name="282" id="anc282"></a><span class="line-modified">1902     if (jEcdh2DeriveParamsClass == NULL) { return ckParam; }</span>
1903     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<a name="283" id="anc283"></a><span class="line-modified">1904     if (fieldID == NULL) { return ckParam; }</span>
1905     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="284" id="anc284"></a><span class="line-removed">1906 </span>
<span class="line-removed">1907     /* get pSharedData and ulSharedDataLen */</span>
1908     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<a name="285" id="anc285"></a><span class="line-modified">1909     if (fieldID == NULL) { return ckParam; }</span>
1910     jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="286" id="anc286"></a><span class="line-removed">1911 </span>
<span class="line-removed">1912     /* get pPublicData and ulPublicDataLen */</span>
1913     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<a name="287" id="anc287"></a><span class="line-modified">1914     if (fieldID == NULL) { return ckParam; }</span>
1915     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="288" id="anc288"></a><span class="line-removed">1916 </span>
<span class="line-removed">1917     /* get ulPrivateDataLen */</span>
1918     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<a name="289" id="anc289"></a><span class="line-modified">1919     if (fieldID == NULL) { return ckParam; }</span>
1920     jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="290" id="anc290"></a><span class="line-removed">1921 </span>
<span class="line-removed">1922     /* get hPrivateData */</span>
1923     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<a name="291" id="anc291"></a><span class="line-modified">1924     if (fieldID == NULL) { return ckParam; }</span>
1925     jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="292" id="anc292"></a><span class="line-removed">1926 </span>
<span class="line-removed">1927     /* get pPublicData2 and ulPublicDataLen2 */</span>
1928     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<a name="293" id="anc293"></a><span class="line-modified">1929     if (fieldID == NULL) { return ckParam; }</span>
1930     jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1931 
<a name="294" id="anc294"></a><span class="line-modified">1932     /* populate java values */</span>
<span class="line-modified">1933     ckParam.kdf = jLongToCKULong(jKdf);</span>
<span class="line-modified">1934     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParam.pSharedData), &amp;(ckParam.ulSharedDataLen));</span>
<span class="line-modified">1935     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1936     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>






1937     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="295" id="anc295"></a><span class="line-modified">1938         free(ckParam.pSharedData);</span>
<span class="line-removed">1939         return ckParam;</span>
1940     }
<a name="296" id="anc296"></a><span class="line-modified">1941     ckParam.ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-modified">1942     ckParam.hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-removed">1943     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParam.pPublicData2), &amp;(ckParam.ulPublicDataLen2));</span>
1944     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="297" id="anc297"></a><span class="line-modified">1945         free(ckParam.pSharedData);</span>
<span class="line-removed">1946         free(ckParam.pPublicData);</span>
<span class="line-removed">1947         return ckParam;</span>
1948     }
<a name="298" id="anc298"></a><span class="line-modified">1949     return ckParam ;</span>

















1950 }
1951 
1952 /*
<a name="299" id="anc299"></a><span class="line-modified">1953  * converts the Java CK_X9_42_DH1_DERIVE_PARAMS object to a CK_X9_42_DH1_DERIVE_PARAMS structure</span>

1954  *
1955  * @param env - used to call JNI funktions to get the Java classes and objects
1956  * @param jParam - the Java CK_X9_42_DH1_DERIVE_PARAMS object to convert
<a name="300" id="anc300"></a><span class="line-modified">1957  * @return - the new CK_X9_42_DH1_DERIVE_PARAMS structure</span>

1958  */
<a name="301" id="anc301"></a><span class="line-modified">1959 CK_X9_42_DH1_DERIVE_PARAMS jX942Dh1DeriveParamToCKX942Dh1DeriveParam(JNIEnv *env, jobject jParam)</span>

1960 {
<a name="302" id="anc302"></a>
1961     jclass jX942Dh1DeriveParamsClass;
<a name="303" id="anc303"></a><span class="line-removed">1962     CK_X9_42_DH1_DERIVE_PARAMS ckParam;</span>
1963     jfieldID fieldID;
1964     jlong jKdf;
1965     jobject jOtherInfo, jPublicData;
<a name="304" id="anc304"></a><span class="line-removed">1966     memset(&amp;ckParam, 0, sizeof(CK_X9_42_DH1_DERIVE_PARAMS));</span>
1967 
<a name="305" id="anc305"></a><span class="line-modified">1968     /* get kdf */</span>




1969     jX942Dh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH1_DERIVE_PARAMS);
<a name="306" id="anc306"></a><span class="line-modified">1970     if (jX942Dh1DeriveParamsClass == NULL) { return ckParam; }</span>
1971     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<a name="307" id="anc307"></a><span class="line-modified">1972     if (fieldID == NULL) { return ckParam; }</span>
1973     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="308" id="anc308"></a><span class="line-removed">1974 </span>
<span class="line-removed">1975     /* get pOtherInfo and ulOtherInfoLen */</span>
1976     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<a name="309" id="anc309"></a><span class="line-modified">1977     if (fieldID == NULL) { return ckParam; }</span>
1978     jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="310" id="anc310"></a><span class="line-removed">1979 </span>
<span class="line-removed">1980     /* get pPublicData and ulPublicDataLen */</span>
1981     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<a name="311" id="anc311"></a><span class="line-modified">1982     if (fieldID == NULL) { return ckParam; }</span>
1983     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1984 
<a name="312" id="anc312"></a><span class="line-modified">1985     /* populate java values */</span>
<span class="line-modified">1986     ckParam.kdf = jLongToCKULong(jKdf);</span>
<span class="line-modified">1987     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParam.pOtherInfo), &amp;(ckParam.ulOtherInfoLen));</span>
<span class="line-modified">1988     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1989     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>






1990     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="313" id="anc313"></a><span class="line-modified">1991         free(ckParam.pOtherInfo);</span>
<span class="line-modified">1992         return ckParam;</span>




1993     }
1994 
<a name="314" id="anc314"></a><span class="line-modified">1995     return ckParam ;</span>








1996 }
1997 
1998 /*
<a name="315" id="anc315"></a><span class="line-modified">1999  * converts the Java CK_X9_42_DH2_DERIVE_PARAMS object to a CK_X9_42_DH2_DERIVE_PARAMS structure</span>

2000  *
2001  * @param env - used to call JNI funktions to get the Java classes and objects
2002  * @param jParam - the Java CK_X9_42_DH2_DERIVE_PARAMS object to convert
<a name="316" id="anc316"></a><span class="line-modified">2003  * @return - the new CK_X9_42_DH2_DERIVE_PARAMS structure</span>

2004  */
<a name="317" id="anc317"></a><span class="line-modified">2005 CK_X9_42_DH2_DERIVE_PARAMS jX942Dh2DeriveParamToCKX942Dh2DeriveParam(JNIEnv *env, jobject jParam)</span>

2006 {
<a name="318" id="anc318"></a>
2007     jclass jX942Dh2DeriveParamsClass;
<a name="319" id="anc319"></a><span class="line-removed">2008     CK_X9_42_DH2_DERIVE_PARAMS ckParam;</span>
2009     jfieldID fieldID;
2010     jlong jKdf, jPrivateDataLen, jPrivateData;
2011     jobject jOtherInfo, jPublicData, jPublicData2;
<a name="320" id="anc320"></a><span class="line-removed">2012     memset(&amp;ckParam, 0, sizeof(CK_X9_42_DH2_DERIVE_PARAMS));</span>
2013 
<a name="321" id="anc321"></a><span class="line-modified">2014     /* get kdf */</span>




2015     jX942Dh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH2_DERIVE_PARAMS);
<a name="322" id="anc322"></a><span class="line-modified">2016     if (jX942Dh2DeriveParamsClass == NULL) { return ckParam; }</span>
2017     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<a name="323" id="anc323"></a><span class="line-modified">2018     if (fieldID == NULL) { return ckParam; }</span>
2019     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="324" id="anc324"></a><span class="line-removed">2020 </span>
<span class="line-removed">2021     /* get pOtherInfo and ulOtherInfoLen */</span>
2022     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<a name="325" id="anc325"></a><span class="line-modified">2023     if (fieldID == NULL) { return ckParam; }</span>
2024     jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="326" id="anc326"></a><span class="line-removed">2025 </span>
<span class="line-removed">2026     /* get pPublicData and ulPublicDataLen */</span>
2027     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<a name="327" id="anc327"></a><span class="line-modified">2028     if (fieldID == NULL) { return ckParam; }</span>
2029     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="328" id="anc328"></a><span class="line-removed">2030 </span>
<span class="line-removed">2031     /* get ulPrivateDataLen */</span>
2032     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<a name="329" id="anc329"></a><span class="line-modified">2033     if (fieldID == NULL) { return ckParam; }</span>
2034     jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="330" id="anc330"></a><span class="line-removed">2035 </span>
<span class="line-removed">2036     /* get hPrivateData */</span>
2037     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<a name="331" id="anc331"></a><span class="line-modified">2038     if (fieldID == NULL) { return ckParam; }</span>
2039     jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="332" id="anc332"></a><span class="line-removed">2040 </span>
<span class="line-removed">2041     /* get pPublicData2 and ulPublicDataLen2 */</span>
2042     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<a name="333" id="anc333"></a><span class="line-modified">2043     if (fieldID == NULL) { return ckParam; }</span>
2044     jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
2045 
<a name="334" id="anc334"></a><span class="line-modified">2046     /* populate java values */</span>
<span class="line-modified">2047     ckParam.kdf = jLongToCKULong(jKdf);</span>
<span class="line-modified">2048     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParam.pOtherInfo), &amp;(ckParam.ulOtherInfoLen));</span>
<span class="line-modified">2049     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">2050     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>






2051     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="335" id="anc335"></a><span class="line-modified">2052         free(ckParam.pOtherInfo);</span>
<span class="line-removed">2053         return ckParam;</span>
2054     }
<a name="336" id="anc336"></a><span class="line-modified">2055     ckParam.ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-modified">2056     ckParam.hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-removed">2057     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParam.pPublicData2), &amp;(ckParam.ulPublicDataLen2));</span>
2058     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="337" id="anc337"></a><span class="line-modified">2059         free(ckParam.pOtherInfo);</span>
<span class="line-modified">2060         free(ckParam.pPublicData);</span>
<span class="line-modified">2061         return ckParam;</span>





2062     }
2063 
<a name="338" id="anc338"></a><span class="line-modified">2064     return ckParam ;</span>









2065 }
<a name="339" id="anc339"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="339" type="hidden" />
</body>
</html>