<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_convert.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  */
   4 
   5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
   6  *
   7  * Redistribution and use in  source and binary forms, with or without
   8  * modification, are permitted  provided that the following conditions are met:
   9  *
  10  * 1. Redistributions of  source code must retain the above copyright notice,
  11  *    this list of conditions and the following disclaimer.
  12  *
  13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
  14  *    this list of conditions and the following disclaimer in the documentation
  15  *    and/or other materials provided with the distribution.
  16  *
  17  * 3. The end-user documentation included with the redistribution, if any, must
  18  *    include the following acknowledgment:
  19  *
  20  *    &quot;This product includes software developed by IAIK of Graz University of
  21  *     Technology.&quot;
  22  *
  23  *    Alternately, this acknowledgment may appear in the software itself, if
  24  *    and wherever such third-party acknowledgments normally appear.
  25  *
  26  * 4. The names &quot;Graz University of Technology&quot; and &quot;IAIK of Graz University of
  27  *    Technology&quot; must not be used to endorse or promote products derived from
  28  *    this software without prior written permission.
  29  *
  30  * 5. Products derived from this software may not be called
  31  *    &quot;IAIK PKCS Wrapper&quot;, nor may &quot;IAIK&quot; appear in their name, without prior
  32  *    written permission of Graz University of Technology.
  33  *
  34  *  THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY EXPRESSED OR IMPLIED
  35  *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  36  *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  37  *  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE LICENSOR BE
  38  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
  39  *  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  40  *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
  41  *  OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
  42  *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
  43  *  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
  44  *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
  45  *  POSSIBILITY  OF SUCH DAMAGE.
  46  */
  47 
  48 /*
  49  * pkcs11wrapper.c
  50  * 18.05.2001
  51  *
  52  * This is the implementation of the native functions of the Java to PKCS#11 interface.
  53  * All function use some helper functions to convert the JNI types to PKCS#11 types.
  54  *
  55  * @author Karl Scheibelhofer &lt;Karl.Scheibelhofer@iaik.at&gt;
  56  * @author Martin Schlaeffer &lt;schlaeff@sbox.tugraz.at&gt;
  57  */
  58 
  59 
  60 #include &quot;pkcs11wrapper.h&quot;
  61 
  62 #include &lt;stdio.h&gt;
  63 #include &lt;stdlib.h&gt;
  64 #include &lt;string.h&gt;
  65 #include &lt;assert.h&gt;
  66 
  67 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
  68 
  69 /* declare file private functions */
  70 
<a name="2" id="anc2"></a><span class="line-modified">  71 CK_VOID_PTR jMechParamToCKMechParamPtrSlow(JNIEnv *env, jobject jParam,</span>
<span class="line-added">  72         CK_MECHANISM_TYPE ckMech, CK_ULONG *ckpLength);</span>
  73 
  74 
  75 /*
<a name="3" id="anc3"></a><span class="line-modified">  76  * converts a CK_DATE pointer into a Java CK_DATE Object.</span>
  77  *
  78  * @param env - used to call JNI funktions to create the new Java object
  79  * @param ckpValue - the pointer to the CK_DATE structure
  80  * @return - the new Java CK_DATE object
  81  */
  82 jobject ckDatePtrToJDateObject(JNIEnv *env, const CK_DATE *ckpDate)
  83 {
  84     jclass jDateClass;
  85     jmethodID jCtrId;
  86     jobject jDateObject;
  87     jcharArray jYear;
  88     jcharArray jMonth;
  89     jcharArray jDay;
  90 
  91     /* load CK_DATE class */
  92     jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
  93     if (jDateClass == NULL) { return NULL; }
  94 
  95     /* load CK_DATE constructor */
  96     jCtrId = (*env)-&gt;GetMethodID(env, jDateClass, &quot;&lt;init&gt;&quot;, &quot;([C[C[C)V&quot;);
  97     if (jCtrId == NULL) { return NULL; }
  98 
  99     /* prep all fields */
 100     jYear = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;year), 4);
 101     if (jYear == NULL) { return NULL; }
 102     jMonth = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;month), 2);
 103     if (jMonth == NULL) { return NULL; }
 104     jDay = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;day), 2);
 105     if (jDay == NULL) { return NULL; }
 106 
 107     /* create new CK_DATE object */
 108     jDateObject =
 109       (*env)-&gt;NewObject(env, jDateClass, jCtrId, jYear, jMonth, jDay);
 110     if (jDateObject == NULL) { return NULL; }
 111 
 112     /* free local references */
 113     (*env)-&gt;DeleteLocalRef(env, jDateClass);
 114     (*env)-&gt;DeleteLocalRef(env, jYear);
 115     (*env)-&gt;DeleteLocalRef(env, jMonth);
 116     (*env)-&gt;DeleteLocalRef(env, jDay);
 117 
 118     return jDateObject ;
 119 }
 120 
 121 /*
<a name="4" id="anc4"></a><span class="line-modified"> 122  * converts a CK_VERSION pointer into a Java CK_VERSION Object.</span>
 123  *
 124  * @param env - used to call JNI funktions to create the new Java object
 125  * @param ckpVersion - the pointer to the CK_VERSION structure
<a name="5" id="anc5"></a><span class="line-modified"> 126  * @return the new Java CK_VERSION object</span>
 127  */
 128 jobject ckVersionPtrToJVersion(JNIEnv *env, const CK_VERSION_PTR ckpVersion)
 129 {
 130     jclass jVersionClass;
 131     jmethodID jCtrId;
 132     jobject jVersionObject;
 133     jint jMajor;
 134     jint jMinor;
 135 
 136     /* load CK_VERSION class */
 137     jVersionClass = (*env)-&gt;FindClass(env, CLASS_VERSION);
 138     if (jVersionClass == NULL) { return NULL; }
 139 
 140     /* load CK_VERSION constructor */
 141     jCtrId = (*env)-&gt;GetMethodID(env, jVersionClass, &quot;&lt;init&gt;&quot;, &quot;(II)V&quot;);
 142     if (jCtrId == NULL) { return NULL; }
 143 
 144     /* prep both fields */
 145     jMajor = ckpVersion-&gt;major;
 146     jMinor = ckpVersion-&gt;minor;
 147 
 148     /* create new CK_VERSION object */
 149     jVersionObject =
 150       (*env)-&gt;NewObject(env, jVersionClass, jCtrId, jMajor, jMinor);
 151     if (jVersionObject == NULL) { return NULL; }
 152 
 153     /* free local references */
 154     (*env)-&gt;DeleteLocalRef(env, jVersionClass);
 155 
 156     return jVersionObject ;
 157 }
 158 
 159 /*
<a name="6" id="anc6"></a><span class="line-modified"> 160  * converts a CK_SESSION_INFO pointer into a Java CK_SESSION_INFO Object.</span>
 161  *
 162  * @param env - used to call JNI funktions to create the new Java object
 163  * @param ckpSessionInfo - the pointer to the CK_SESSION_INFO structure
<a name="7" id="anc7"></a><span class="line-modified"> 164  * @return the new Java CK_SESSION_INFO object</span>
 165  */
 166 jobject ckSessionInfoPtrToJSessionInfo(JNIEnv *env, const CK_SESSION_INFO_PTR ckpSessionInfo)
 167 {
 168     jclass jSessionInfoClass;
 169     jmethodID jCtrId;
 170     jobject jSessionInfoObject;
 171     jlong jSlotID;
 172     jlong jState;
 173     jlong jFlags;
 174     jlong jDeviceError;
 175 
 176     /* load CK_SESSION_INFO class */
 177     jSessionInfoClass = (*env)-&gt;FindClass(env, CLASS_SESSION_INFO);
 178     if (jSessionInfoClass == NULL) { return NULL; }
 179 
 180     /* load CK_SESSION_INFO constructor */
 181     jCtrId = (*env)-&gt;GetMethodID(env, jSessionInfoClass, &quot;&lt;init&gt;&quot;, &quot;(JJJJ)V&quot;);
 182     if (jCtrId == NULL) { return NULL; }
 183 
 184     /* prep all fields */
 185     jSlotID = ckULongToJLong(ckpSessionInfo-&gt;slotID);
 186     jState = ckULongToJLong(ckpSessionInfo-&gt;state);
 187     jFlags = ckULongToJLong(ckpSessionInfo-&gt;flags);
 188     jDeviceError = ckULongToJLong(ckpSessionInfo-&gt;ulDeviceError);
 189 
 190     /* create new CK_SESSION_INFO object */
 191     jSessionInfoObject =
 192       (*env)-&gt;NewObject(env, jSessionInfoClass, jCtrId, jSlotID, jState,
 193                         jFlags, jDeviceError);
 194     if (jSessionInfoObject == NULL) { return NULL; }
 195 
 196     /* free local references */
 197     (*env)-&gt;DeleteLocalRef(env, jSessionInfoClass);
 198 
 199     return jSessionInfoObject ;
 200 }
 201 
 202 /*
<a name="8" id="anc8"></a><span class="line-modified"> 203  * converts a CK_ATTRIBUTE pointer into a Java CK_ATTRIBUTE Object.</span>
 204  *
 205  * @param env - used to call JNI funktions to create the new Java object
 206  * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure
<a name="9" id="anc9"></a><span class="line-modified"> 207  * @return the new Java CK_ATTRIBUTE object</span>
 208  */
 209 jobject ckAttributePtrToJAttribute(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
 210 {
 211     jclass jAttributeClass;
 212     jmethodID jCtrId;
 213     jobject jAttributeObject;
 214     jlong jType;
 215     jobject jPValue = NULL;
 216 
 217     jAttributeClass = (*env)-&gt;FindClass(env, CLASS_ATTRIBUTE);
 218     if (jAttributeClass == NULL) { return NULL; }
 219 
 220     /* load CK_INFO constructor */
 221     jCtrId = (*env)-&gt;GetMethodID(env, jAttributeClass, &quot;&lt;init&gt;&quot;, &quot;(JLjava/lang/Object;)V&quot;);
 222     if (jCtrId == NULL) { return NULL; }
 223 
 224     /* prep both fields */
 225     jType = ckULongToJLong(ckpAttribute-&gt;type);
 226     jPValue = ckAttributeValueToJObject(env, ckpAttribute);
 227     if ((*env)-&gt;ExceptionCheck(env)) { return NULL; }
 228 
 229     /* create new CK_ATTRIBUTE object */
 230     jAttributeObject =
 231       (*env)-&gt;NewObject(env, jAttributeClass, jCtrId, jType, jPValue);
 232     if (jAttributeObject == NULL) { return NULL; }
 233 
 234     /* free local references */
 235     (*env)-&gt;DeleteLocalRef(env, jAttributeClass);
 236     (*env)-&gt;DeleteLocalRef(env, jPValue);
 237 
 238     return jAttributeObject;
 239 }
 240 
 241 
 242 /*
<a name="10" id="anc10"></a><span class="line-modified"> 243  * converts a Java CK_VERSION object into a CK_VERSION pointer</span>
 244  *
 245  * @param env - used to call JNI funktions to get the values out of the Java object
 246  * @param jVersion - the Java CK_VERSION object to convert
<a name="11" id="anc11"></a><span class="line-modified"> 247  * @return pointer to the new CK_VERSION structure</span>
 248  */
<a name="12" id="anc12"></a><span class="line-modified"> 249 CK_VERSION_PTR</span>
<span class="line-added"> 250 jVersionToCKVersionPtr(JNIEnv *env, jobject jVersion)</span>
 251 {
 252     CK_VERSION_PTR ckpVersion;
 253     jclass jVersionClass;
 254     jfieldID jFieldID;
 255     jbyte jMajor, jMinor;
 256 
 257     if (jVersion == NULL) {
 258         return NULL;
 259     }
 260 
<a name="13" id="anc13"></a><span class="line-modified"> 261     // retrieve java values</span>
 262     jVersionClass = (*env)-&gt;GetObjectClass(env, jVersion);
 263     if (jVersionClass == NULL) { return NULL; }
<a name="14" id="anc14"></a>

 264     jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;major&quot;, &quot;B&quot;);
 265     if (jFieldID == NULL) { return NULL; }
 266     jMajor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
<a name="15" id="anc15"></a>

 267     jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;minor&quot;, &quot;B&quot;);
 268     if (jFieldID == NULL) { return NULL; }
 269     jMinor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
 270 
<a name="16" id="anc16"></a><span class="line-modified"> 271     // allocate memory for CK_VERSION pointer</span>
<span class="line-modified"> 272     ckpVersion = (CK_VERSION_PTR) calloc(1, sizeof(CK_VERSION));</span>
 273     if (ckpVersion == NULL) {
 274         throwOutOfMemoryError(env, 0);
 275         return NULL;
 276     }
<a name="17" id="anc17"></a><span class="line-added"> 277 </span>
<span class="line-added"> 278     // populate using java values</span>
 279     ckpVersion-&gt;major = jByteToCKByte(jMajor);
 280     ckpVersion-&gt;minor = jByteToCKByte(jMinor);
 281 
<a name="18" id="anc18"></a><span class="line-modified"> 282     return ckpVersion;</span>
 283 }
 284 
 285 
 286 /*
<a name="19" id="anc19"></a><span class="line-modified"> 287  * converts a Java CK_DATE object into a CK_DATE pointer</span>
 288  *
<a name="20" id="anc20"></a><span class="line-modified"> 289  * @param env - used to call JNI functions to get the values out of the Java object</span>
<span class="line-modified"> 290  * @param jDate - the Java CK_DATE object to convert</span>
<span class="line-modified"> 291  * @return pointer to the new CK_DATE structure</span>
 292  */
<a name="21" id="anc21"></a><span class="line-modified"> 293 CK_DATE * jDateObjectToCKDatePtr(JNIEnv *env, jobject jDate)</span>
 294 {
<a name="22" id="anc22"></a><span class="line-modified"> 295     CK_DATE * ckpDate = NULL;</span>
 296     CK_ULONG ckLength;
 297     jclass jDateClass;
 298     jfieldID jFieldID;
 299     jobject jYear, jMonth, jDay;
<a name="23" id="anc23"></a><span class="line-modified"> 300     jchar *jTempChars = NULL;</span>
 301     CK_ULONG i;
 302 
 303     if (jDate == NULL) {
 304         return NULL;
 305     }
 306 
<a name="24" id="anc24"></a><span class="line-modified"> 307     // retrieve java values</span>
 308     jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
 309     if (jDateClass == NULL) { return NULL; }
<a name="25" id="anc25"></a>

 310     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;year&quot;, &quot;[C&quot;);
 311     if (jFieldID == NULL) { return NULL; }
 312     jYear = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
<a name="26" id="anc26"></a>

 313     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;month&quot;, &quot;[C&quot;);
 314     if (jFieldID == NULL) { return NULL; }
 315     jMonth = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
<a name="27" id="anc27"></a>

 316     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;day&quot;, &quot;[C&quot;);
 317     if (jFieldID == NULL) { return NULL; }
 318     jDay = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
 319 
<a name="28" id="anc28"></a><span class="line-modified"> 320     // allocate memory for CK_DATE pointer</span>
<span class="line-modified"> 321     ckpDate = (CK_DATE *) calloc(1, sizeof(CK_DATE));</span>
 322     if (ckpDate == NULL) {
 323         throwOutOfMemoryError(env, 0);
 324         return NULL;
 325     }
 326 
<a name="29" id="anc29"></a><span class="line-added"> 327     // populate using java values</span>
 328     if (jYear == NULL) {
 329         ckpDate-&gt;year[0] = 0;
 330         ckpDate-&gt;year[1] = 0;
 331         ckpDate-&gt;year[2] = 0;
 332         ckpDate-&gt;year[3] = 0;
 333     } else {
 334         ckLength = (*env)-&gt;GetArrayLength(env, jYear);
<a name="30" id="anc30"></a><span class="line-modified"> 335         jTempChars = (jchar*) calloc(ckLength, sizeof(jchar));</span>
 336         if (jTempChars == NULL) {
<a name="31" id="anc31"></a>
 337             throwOutOfMemoryError(env, 0);
<a name="32" id="anc32"></a><span class="line-modified"> 338             goto cleanup;</span>
 339         }
 340         (*env)-&gt;GetCharArrayRegion(env, jYear, 0, ckLength, jTempChars);
 341         if ((*env)-&gt;ExceptionCheck(env)) {
<a name="33" id="anc33"></a><span class="line-modified"> 342             goto cleanup;</span>


 343         }
 344 
 345         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 4) ; i++) {
 346             ckpDate-&gt;year[i] = jCharToCKChar(jTempChars[i]);
 347         }
 348         free(jTempChars);
 349     }
 350 
 351     if (jMonth == NULL) {
 352         ckpDate-&gt;month[0] = 0;
 353         ckpDate-&gt;month[1] = 0;
 354     } else {
 355         ckLength = (*env)-&gt;GetArrayLength(env, jMonth);
<a name="34" id="anc34"></a><span class="line-modified"> 356         jTempChars = (jchar*) calloc(ckLength, sizeof(jchar));</span>
 357         if (jTempChars == NULL) {
<a name="35" id="anc35"></a>
 358             throwOutOfMemoryError(env, 0);
<a name="36" id="anc36"></a><span class="line-modified"> 359             goto cleanup;</span>
 360         }
 361         (*env)-&gt;GetCharArrayRegion(env, jMonth, 0, ckLength, jTempChars);
 362         if ((*env)-&gt;ExceptionCheck(env)) {
<a name="37" id="anc37"></a><span class="line-modified"> 363             goto cleanup;</span>


 364         }
 365 
 366         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
 367             ckpDate-&gt;month[i] = jCharToCKChar(jTempChars[i]);
 368         }
 369         free(jTempChars);
 370     }
 371 
 372     if (jDay == NULL) {
 373         ckpDate-&gt;day[0] = 0;
 374         ckpDate-&gt;day[1] = 0;
 375     } else {
 376         ckLength = (*env)-&gt;GetArrayLength(env, jDay);
<a name="38" id="anc38"></a><span class="line-modified"> 377         jTempChars = (jchar*) calloc(ckLength, sizeof(jchar));</span>
 378         if (jTempChars == NULL) {
<a name="39" id="anc39"></a>
 379             throwOutOfMemoryError(env, 0);
<a name="40" id="anc40"></a><span class="line-modified"> 380             goto cleanup;</span>
 381         }
 382         (*env)-&gt;GetCharArrayRegion(env, jDay, 0, ckLength, jTempChars);
 383         if ((*env)-&gt;ExceptionCheck(env)) {
<a name="41" id="anc41"></a><span class="line-modified"> 384             goto cleanup;</span>


 385         }
 386 
 387         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
 388             ckpDate-&gt;day[i] = jCharToCKChar(jTempChars[i]);
 389         }
 390         free(jTempChars);
 391     }
 392 
<a name="42" id="anc42"></a><span class="line-modified"> 393     return ckpDate;</span>
<span class="line-added"> 394 cleanup:</span>
<span class="line-added"> 395     free(jTempChars);</span>
<span class="line-added"> 396     free(ckpDate);</span>
<span class="line-added"> 397     return NULL;</span>
 398 }
 399 
 400 
 401 /*
 402  * converts a Java CK_ATTRIBUTE object into a CK_ATTRIBUTE structure
 403  *
 404  * @param env - used to call JNI funktions to get the values out of the Java object
 405  * @param jAttribute - the Java CK_ATTRIBUTE object to convert
<a name="43" id="anc43"></a><span class="line-modified"> 406  * @return the new CK_ATTRIBUTE structure</span>
 407  */
 408 CK_ATTRIBUTE jAttributeToCKAttribute(JNIEnv *env, jobject jAttribute)
 409 {
 410     CK_ATTRIBUTE ckAttribute;
 411     jclass jAttributeClass;
 412     jfieldID jFieldID;
 413     jlong jType;
 414     jobject jPValue;
<a name="44" id="anc44"></a><span class="line-added"> 415 </span>
 416     memset(&amp;ckAttribute, 0, sizeof(CK_ATTRIBUTE));
 417 
 418     // TBD: what if jAttribute == NULL?!
<a name="45" id="anc45"></a>
 419     TRACE0(&quot;\nDEBUG: jAttributeToCKAttribute&quot;);
<a name="46" id="anc46"></a><span class="line-added"> 420 </span>
 421     /* get CK_ATTRIBUTE class */
 422     TRACE0(&quot;, getting attribute object class&quot;);
 423     jAttributeClass = (*env)-&gt;GetObjectClass(env, jAttribute);
 424     if (jAttributeClass == NULL) { return ckAttribute; }
 425 
 426     /* get type */
 427     TRACE0(&quot;, getting type field&quot;);
 428     jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;type&quot;, &quot;J&quot;);
 429     if (jFieldID == NULL) { return ckAttribute; }
 430     jType = (*env)-&gt;GetLongField(env, jAttribute, jFieldID);
<a name="47" id="anc47"></a><span class="line-modified"> 431     TRACE1(&quot;, type=0x%lX&quot;, jType);</span>
 432 
 433     /* get pValue */
 434     TRACE0(&quot;, getting pValue field&quot;);
 435     jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;pValue&quot;, &quot;Ljava/lang/Object;&quot;);
 436     if (jFieldID == NULL) { return ckAttribute; }
 437     jPValue = (*env)-&gt;GetObjectField(env, jAttribute, jFieldID);
 438     TRACE1(&quot;, pValue=%p&quot;, jPValue);
 439 
 440     ckAttribute.type = jLongToCKULong(jType);
 441     TRACE0(&quot;, converting pValue to primitive object&quot;);
 442 
 443     /* convert the Java pValue object to a CK-type pValue pointer */
<a name="48" id="anc48"></a><span class="line-modified"> 444     ckAttribute.pValue = jObjectToPrimitiveCKObjectPtr(env, jPValue, &amp;(ckAttribute.ulValueLen));</span>
 445 
<a name="49" id="anc49"></a><span class="line-modified"> 446     TRACE0(&quot;\nDEBUG: jAttributeToCKAttribute FINISHED\n&quot;);</span>
 447 
 448     return ckAttribute ;
 449 }
 450 
 451 void masterKeyDeriveParamToCKMasterKeyDeriveParam(JNIEnv *env, jobject jParam,
 452         jclass masterKeyDeriveParamClass,
 453         CK_VERSION_PTR* cKMasterKeyDeriveParamVersion,
 454         CK_SSL3_RANDOM_DATA* cKMasterKeyDeriveParamRandomInfo) {
 455     jfieldID fieldID;
 456     jclass jSsl3RandomDataClass;
 457     jobject jRandomInfo, jRIClientRandom, jRIServerRandom, jVersion;
 458 
<a name="50" id="anc50"></a><span class="line-modified"> 459     // retrieve java values</span>
 460     fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;RandomInfo&quot;,
 461             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
 462     if (fieldID == NULL) { return; }
 463     jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="51" id="anc51"></a>

 464     jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
 465     if (jSsl3RandomDataClass == NULL) { return; }
 466     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
 467     if (fieldID == NULL) { return; }
 468     jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<a name="52" id="anc52"></a>

 469     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
 470     if (fieldID == NULL) { return; }
 471     jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<a name="53" id="anc53"></a>

 472     fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;pVersion&quot;,
 473             &quot;Lsun/security/pkcs11/wrapper/CK_VERSION;&quot;);
 474     if (fieldID == NULL) { return; }
 475     jVersion = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 476 
<a name="54" id="anc54"></a><span class="line-modified"> 477     // populate using java values</span>
 478     *cKMasterKeyDeriveParamVersion = jVersionToCKVersionPtr(env, jVersion);
 479     if ((*env)-&gt;ExceptionCheck(env)) { return; }
 480     jByteArrayToCKByteArray(env, jRIClientRandom,
 481             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom),
 482             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulClientRandomLen));
 483     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="55" id="anc55"></a><span class="line-modified"> 484         goto cleanup;</span>

 485     }
 486     jByteArrayToCKByteArray(env, jRIServerRandom,
 487             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom),
 488             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulServerRandomLen));
 489     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="56" id="anc56"></a><span class="line-modified"> 490         goto cleanup;</span>


 491     }
<a name="57" id="anc57"></a><span class="line-added"> 492     return;</span>
<span class="line-added"> 493 cleanup:</span>
<span class="line-added"> 494     free(*cKMasterKeyDeriveParamVersion);</span>
<span class="line-added"> 495     free(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-added"> 496     cKMasterKeyDeriveParamRandomInfo-&gt;ulClientRandomLen = 0L;</span>
<span class="line-added"> 497     free(cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-added"> 498     cKMasterKeyDeriveParamRandomInfo-&gt;ulServerRandomLen = 0L;</span>
<span class="line-added"> 499     // explicitly set to NULL to ensure no double free possible</span>
<span class="line-added"> 500     *cKMasterKeyDeriveParamVersion = NULL;</span>
<span class="line-added"> 501     cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom = NULL;</span>
<span class="line-added"> 502     cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom = NULL;</span>
 503 }
 504 
 505 /*
 506  * converts the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to a
<a name="58" id="anc58"></a><span class="line-modified"> 507  * CK_SSL3_MASTER_KEY_DERIVE_PARAMS pointer</span>
 508  *
 509  * @param env - used to call JNI functions to get the Java classes and objects
 510  * @param jParam - the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to convert
<a name="59" id="anc59"></a><span class="line-modified"> 511  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 512  * @return pointer to the new CK_SSL3_MASTER_KEY_DERIVE_PARAMS structure</span>
 513  */
<a name="60" id="anc60"></a><span class="line-modified"> 514 CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR</span>
<span class="line-modified"> 515 jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParamPtr(JNIEnv *env,</span>
<span class="line-modified"> 516         jobject jParam, CK_ULONG *pLength)</span>
 517 {
<a name="61" id="anc61"></a><span class="line-modified"> 518     CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR ckParamPtr;</span>
 519     jclass jSsl3MasterKeyDeriveParamsClass;
<a name="62" id="anc62"></a><span class="line-modified"> 520 </span>
<span class="line-added"> 521     if (pLength != NULL) {</span>
<span class="line-added"> 522         *pLength = 0L;</span>
<span class="line-added"> 523     }</span>
<span class="line-added"> 524 </span>
<span class="line-added"> 525     // allocate memory for CK_SSL3_MASTER_KEY_DERIVE_PARAMS pointer</span>
<span class="line-added"> 526     ckParamPtr = calloc(1, sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-added"> 527     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 528         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 529         return NULL;</span>
<span class="line-added"> 530     }</span>
<span class="line-added"> 531 </span>
<span class="line-added"> 532     // retrieve and populate using java values</span>
 533     jSsl3MasterKeyDeriveParamsClass =
 534             (*env)-&gt;FindClass(env, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);
<a name="63" id="anc63"></a><span class="line-modified"> 535     if (jSsl3MasterKeyDeriveParamsClass == NULL) {</span>
<span class="line-added"> 536         goto cleanup;</span>
<span class="line-added"> 537     }</span>
 538     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,
 539             jSsl3MasterKeyDeriveParamsClass,
<a name="64" id="anc64"></a><span class="line-modified"> 540             &amp;(ckParamPtr-&gt;pVersion), &amp;(ckParamPtr-&gt;RandomInfo));</span>
<span class="line-modified"> 541     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 542         goto cleanup;</span>
<span class="line-added"> 543     }</span>
<span class="line-added"> 544 </span>
<span class="line-added"> 545     if (pLength != NULL) {</span>
<span class="line-added"> 546         *pLength = sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-added"> 547     }</span>
<span class="line-added"> 548     return ckParamPtr;</span>
<span class="line-added"> 549 cleanup:</span>
<span class="line-added"> 550     free(ckParamPtr);</span>
<span class="line-added"> 551     return NULL;</span>
 552 }
 553 
 554 /*
 555  * converts the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to a
<a name="65" id="anc65"></a><span class="line-modified"> 556  * CK_TLS12_MASTER_KEY_DERIVE_PARAMS pointer</span>
 557  *
 558  * @param env - used to call JNI functions to get the Java classes and objects
 559  * @param jParam - the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to convert
<a name="66" id="anc66"></a><span class="line-modified"> 560  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 561  * @return pointer to the new CK_TLS12_MASTER_KEY_DERIVE_PARAMS structure</span>
 562  */
<a name="67" id="anc67"></a><span class="line-modified"> 563 CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR</span>
<span class="line-modified"> 564 jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParamPtr(JNIEnv *env,</span>
<span class="line-modified"> 565         jobject jParam, CK_ULONG *pLength)</span>
 566 {
<a name="68" id="anc68"></a><span class="line-modified"> 567     CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR ckParamPtr;</span>
 568     jclass jTls12MasterKeyDeriveParamsClass;
 569     jfieldID fieldID;
<a name="69" id="anc69"></a><span class="line-modified"> 570     jlong prfHashMechanism;</span>
<span class="line-added"> 571 </span>
<span class="line-added"> 572     if (pLength != NULL) {</span>
<span class="line-added"> 573         *pLength = 0L;</span>
<span class="line-added"> 574     }</span>
<span class="line-added"> 575 </span>
<span class="line-added"> 576     // retrieve java values</span>
 577     jTls12MasterKeyDeriveParamsClass =
<a name="70" id="anc70"></a><span class="line-modified"> 578         (*env)-&gt;FindClass(env, CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified"> 579     if (jTls12MasterKeyDeriveParamsClass == NULL) { return NULL; }</span>



 580     fieldID = (*env)-&gt;GetFieldID(env,
 581             jTls12MasterKeyDeriveParamsClass, &quot;prfHashMechanism&quot;, &quot;J&quot;);
<a name="71" id="anc71"></a><span class="line-modified"> 582     if (fieldID == NULL) { return NULL; }</span>
<span class="line-modified"> 583     prfHashMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified"> 584 </span>
<span class="line-modified"> 585     // allocate memory for CK_TLS12_MASTER_KEY_DERIVE_PARAMS pointer</span>
<span class="line-added"> 586     ckParamPtr = calloc(1, sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-added"> 587     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 588         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 589         return NULL;</span>
 590     }
<a name="72" id="anc72"></a><span class="line-modified"> 591 </span>
<span class="line-added"> 592     // populate using java values</span>
<span class="line-added"> 593     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,</span>
<span class="line-added"> 594             jTls12MasterKeyDeriveParamsClass, &amp;ckParamPtr-&gt;pVersion,</span>
<span class="line-added"> 595             &amp;ckParamPtr-&gt;RandomInfo);</span>
<span class="line-added"> 596     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 597         goto cleanup;</span>
<span class="line-added"> 598     }</span>
<span class="line-added"> 599 </span>
<span class="line-added"> 600     ckParamPtr-&gt;prfHashMechanism = (CK_MECHANISM_TYPE) prfHashMechanism;</span>
<span class="line-added"> 601 </span>
<span class="line-added"> 602     if (pLength != NULL) {</span>
<span class="line-added"> 603         *pLength = sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-added"> 604     }</span>
<span class="line-added"> 605     return ckParamPtr;</span>
<span class="line-added"> 606 cleanup:</span>
<span class="line-added"> 607     free(ckParamPtr);</span>
<span class="line-added"> 608     return NULL;</span>
 609 }
 610 
 611 /*
<a name="73" id="anc73"></a><span class="line-modified"> 612  * converts the Java CK_TLS_PRF_PARAMS object to a CK_TLS_PRF_PARAMS pointer</span>
<span class="line-added"> 613  *</span>
<span class="line-added"> 614  * @param env - used to call JNI functions to get the Java classes and objects</span>
<span class="line-added"> 615  * @param jParam - the Java CK_TLS_PRF_PARAMS object to convert</span>
<span class="line-added"> 616  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 617  * @return pointer to the new CK_TLS_PRF_PARAMS structure</span>
 618  */
<a name="74" id="anc74"></a><span class="line-modified"> 619 CK_TLS_PRF_PARAMS_PTR</span>
<span class="line-added"> 620 jTlsPrfParamsToCKTlsPrfParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
 621 {
<a name="75" id="anc75"></a><span class="line-added"> 622     CK_TLS_PRF_PARAMS_PTR ckParamPtr;</span>
 623     jclass jTlsPrfParamsClass;
<a name="76" id="anc76"></a>
 624     jfieldID fieldID;
 625     jobject jSeed, jLabel, jOutput;
<a name="77" id="anc77"></a>
 626 
<a name="78" id="anc78"></a><span class="line-modified"> 627     if (pLength != NULL) {</span>
<span class="line-added"> 628         *pLength = 0;</span>
<span class="line-added"> 629     }</span>
 630 
<a name="79" id="anc79"></a><span class="line-modified"> 631     // retrieve java values</span>
 632     jTlsPrfParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_PRF_PARAMS);
<a name="80" id="anc80"></a><span class="line-modified"> 633     if (jTlsPrfParamsClass == NULL) { return NULL; }</span>
 634     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pSeed&quot;, &quot;[B&quot;);
<a name="81" id="anc81"></a><span class="line-modified"> 635     if (fieldID == NULL) { return NULL; }</span>
 636     jSeed = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="82" id="anc82"></a>

 637     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pLabel&quot;, &quot;[B&quot;);
<a name="83" id="anc83"></a><span class="line-modified"> 638     if (fieldID == NULL) { return NULL; }</span>
 639     jLabel = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="84" id="anc84"></a>

 640     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pOutput&quot;, &quot;[B&quot;);
<a name="85" id="anc85"></a><span class="line-modified"> 641     if (fieldID == NULL) { return NULL; }</span>
 642     jOutput = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 643 
<a name="86" id="anc86"></a><span class="line-modified"> 644     // allocate memory for CK_TLS_PRF_PARAMS pointer</span>
<span class="line-modified"> 645     ckParamPtr = calloc(1, sizeof(CK_TLS_PRF_PARAMS));</span>
<span class="line-modified"> 646     if (ckParamPtr == NULL) {</span>
<span class="line-modified"> 647         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 648         return NULL;</span>
<span class="line-added"> 649     }</span>
<span class="line-added"> 650 </span>
<span class="line-added"> 651     // populate using java values</span>
<span class="line-added"> 652     jByteArrayToCKByteArray(env, jSeed, &amp;(ckParamPtr-&gt;pSeed), &amp;(ckParamPtr-&gt;ulSeedLen));</span>
 653     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="87" id="anc87"></a><span class="line-modified"> 654         goto cleanup;</span>

 655     }
<a name="88" id="anc88"></a><span class="line-modified"> 656     jByteArrayToCKByteArray(env, jLabel, &amp;(ckParamPtr-&gt;pLabel), &amp;(ckParamPtr-&gt;ulLabelLen));</span>
<span class="line-modified"> 657     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified"> 658         goto cleanup;</span>



 659     }
<a name="89" id="anc89"></a><span class="line-modified"> 660     ckParamPtr-&gt;pulOutputLen = calloc(1, sizeof(CK_ULONG));</span>
<span class="line-added"> 661     if (ckParamPtr-&gt;pulOutputLen == NULL) {</span>
<span class="line-added"> 662         goto cleanup;</span>
<span class="line-added"> 663     }</span>
<span class="line-added"> 664     jByteArrayToCKByteArray(env, jOutput, &amp;(ckParamPtr-&gt;pOutput), ckParamPtr-&gt;pulOutputLen);</span>
 665     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="90" id="anc90"></a><span class="line-modified"> 666         goto cleanup;</span>



 667     }
 668 
<a name="91" id="anc91"></a><span class="line-modified"> 669     if (pLength != NULL) {</span>
<span class="line-added"> 670         *pLength = sizeof(CK_TLS_PRF_PARAMS);</span>
<span class="line-added"> 671     }</span>
<span class="line-added"> 672     return ckParamPtr;</span>
<span class="line-added"> 673 cleanup:</span>
<span class="line-added"> 674     free(ckParamPtr-&gt;pSeed);</span>
<span class="line-added"> 675     free(ckParamPtr-&gt;pLabel);</span>
<span class="line-added"> 676     free(ckParamPtr-&gt;pOutput);</span>
<span class="line-added"> 677     free(ckParamPtr-&gt;pulOutputLen);</span>
<span class="line-added"> 678     free(ckParamPtr);</span>
<span class="line-added"> 679     return NULL;</span>
 680 }
 681 
 682 /*
<a name="92" id="anc92"></a><span class="line-modified"> 683  * converts the Java CK_TLS_MAC_PARAMS object to a CK_TLS_MAC_PARAMS pointer</span>
<span class="line-added"> 684  *</span>
<span class="line-added"> 685  * @param env - used to call JNI functions to get the Java classes and objects</span>
<span class="line-added"> 686  * @param jParam - the Java CK_TLS_MAC_PARAMS object to convert</span>
<span class="line-added"> 687  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 688  * @return pointer to the new CK_TLS_MAC_PARAMS structure</span>
 689  */
<a name="93" id="anc93"></a><span class="line-modified"> 690 </span>
<span class="line-added"> 691 CK_TLS_MAC_PARAMS_PTR</span>
<span class="line-added"> 692 jTlsMacParamsToCKTlsMacParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
 693 {
<a name="94" id="anc94"></a><span class="line-added"> 694     CK_TLS_MAC_PARAMS_PTR ckParamPtr;</span>
 695     jclass jTlsMacParamsClass;
<a name="95" id="anc95"></a>
 696     jfieldID fieldID;
 697     jlong jPrfMechanism, jUlMacLength, jUlServerOrClient;
<a name="96" id="anc96"></a>
 698 
<a name="97" id="anc97"></a><span class="line-modified"> 699     if (pLength != NULL) {</span>
<span class="line-modified"> 700         *pLength = 0L;</span>
<span class="line-added"> 701     }</span>
 702 
<a name="98" id="anc98"></a><span class="line-modified"> 703     // retrieve java values</span>
<span class="line-added"> 704     jTlsMacParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_MAC_PARAMS);</span>
<span class="line-added"> 705     if (jTlsMacParamsClass == NULL) { return NULL; }</span>
 706     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;prfMechanism&quot;, &quot;J&quot;);
<a name="99" id="anc99"></a><span class="line-modified"> 707     if (fieldID == NULL) { return NULL; }</span>
 708     jPrfMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="100" id="anc100"></a>

 709     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulMacLength&quot;, &quot;J&quot;);
<a name="101" id="anc101"></a><span class="line-modified"> 710     if (fieldID == NULL) { return NULL; }</span>
 711     jUlMacLength = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="102" id="anc102"></a>

 712     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulServerOrClient&quot;, &quot;J&quot;);
<a name="103" id="anc103"></a><span class="line-modified"> 713     if (fieldID == NULL) { return NULL; }</span>
 714     jUlServerOrClient = (*env)-&gt;GetLongField(env, jParam, fieldID);
 715 
<a name="104" id="anc104"></a><span class="line-modified"> 716     // allocate memory for CK_TLS_MAC_PARAMS pointer</span>
<span class="line-modified"> 717     ckParamPtr = calloc(1, sizeof(CK_TLS_MAC_PARAMS));</span>
<span class="line-modified"> 718     if (ckParamPtr == NULL) {</span>
<span class="line-modified"> 719         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 720         return NULL;</span>
<span class="line-added"> 721     }</span>
<span class="line-added"> 722 </span>
<span class="line-added"> 723     // populate using java values</span>
<span class="line-added"> 724     ckParamPtr-&gt;prfHashMechanism = jLongToCKULong(jPrfMechanism);</span>
<span class="line-added"> 725     ckParamPtr-&gt;ulMacLength = jLongToCKULong(jUlMacLength);</span>
<span class="line-added"> 726     ckParamPtr-&gt;ulServerOrClient = jLongToCKULong(jUlServerOrClient);</span>
 727 
<a name="105" id="anc105"></a><span class="line-modified"> 728     if (pLength != NULL) {</span>
<span class="line-added"> 729         *pLength = sizeof(CK_TLS_MAC_PARAMS);</span>
<span class="line-added"> 730     }</span>
<span class="line-added"> 731     return ckParamPtr;</span>
 732 }
 733 
 734 void keyMatParamToCKKeyMatParam(JNIEnv *env, jobject jParam,
 735         jclass jKeyMatParamClass,
 736         CK_ULONG* cKKeyMatParamUlMacSizeInBits,
 737         CK_ULONG* cKKeyMatParamUlKeySizeInBits,
 738         CK_ULONG* cKKeyMatParamUlIVSizeInBits,
 739         CK_BBOOL* cKKeyMatParamBIsExport,
 740         CK_SSL3_RANDOM_DATA* cKKeyMatParamRandomInfo,
 741         CK_SSL3_KEY_MAT_OUT_PTR* cKKeyMatParamPReturnedKeyMaterial)
 742 {
 743     jclass jSsl3RandomDataClass, jSsl3KeyMatOutClass;
 744     jfieldID fieldID;
 745     jlong jMacSizeInBits, jKeySizeInBits, jIVSizeInBits;
 746     jboolean jIsExport;
 747     jobject jRandomInfo, jRIClientRandom, jRIServerRandom;
 748     jobject jReturnedKeyMaterial, jRMIvClient, jRMIvServer;
 749     CK_ULONG ckTemp;
 750 
<a name="106" id="anc106"></a><span class="line-modified"> 751     // the pointer arguments should already be initialized by caller</span>
<span class="line-added"> 752 </span>
<span class="line-added"> 753     // retrieve java values</span>
 754     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulMacSizeInBits&quot;, &quot;J&quot;);
 755     if (fieldID == NULL) { return; }
 756     jMacSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="107" id="anc107"></a>

 757     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulKeySizeInBits&quot;, &quot;J&quot;);
 758     if (fieldID == NULL) { return; }
 759     jKeySizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="108" id="anc108"></a>

 760     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulIVSizeInBits&quot;, &quot;J&quot;);
 761     if (fieldID == NULL) { return; }
 762     jIVSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="109" id="anc109"></a>

 763     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;bIsExport&quot;, &quot;Z&quot;);
 764     if (fieldID == NULL) { return; }
 765     jIsExport = (*env)-&gt;GetBooleanField(env, jParam, fieldID);
<a name="110" id="anc110"></a>

 766     jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
 767     if (jSsl3RandomDataClass == NULL) { return; }
 768     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;RandomInfo&quot;,
 769             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
 770     if (fieldID == NULL) { return; }
 771     jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="111" id="anc111"></a>

 772     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
 773     if (fieldID == NULL) { return; }
 774     jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<a name="112" id="anc112"></a>

 775     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
 776     if (fieldID == NULL) { return; }
 777     jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<a name="113" id="anc113"></a>

 778     jSsl3KeyMatOutClass = (*env)-&gt;FindClass(env, CLASS_SSL3_KEY_MAT_OUT);
 779     if (jSsl3KeyMatOutClass == NULL) { return; }
 780     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;pReturnedKeyMaterial&quot;,
 781             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_OUT;&quot;);
 782     if (fieldID == NULL) { return; }
 783     jReturnedKeyMaterial = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="114" id="anc114"></a>

 784     fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVClient&quot;, &quot;[B&quot;);
 785     if (fieldID == NULL) { return; }
 786     jRMIvClient = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
<a name="115" id="anc115"></a>

 787     fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVServer&quot;, &quot;[B&quot;);
 788     if (fieldID == NULL) { return; }
 789     jRMIvServer = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
 790 
<a name="116" id="anc116"></a><span class="line-modified"> 791     // populate the specified pointers using java values</span>
 792     *cKKeyMatParamUlMacSizeInBits = jLongToCKULong(jMacSizeInBits);
 793     *cKKeyMatParamUlKeySizeInBits = jLongToCKULong(jKeySizeInBits);
 794     *cKKeyMatParamUlIVSizeInBits = jLongToCKULong(jIVSizeInBits);
 795     *cKKeyMatParamBIsExport = jBooleanToCKBBool(jIsExport);
 796     jByteArrayToCKByteArray(env, jRIClientRandom,
 797             &amp;(cKKeyMatParamRandomInfo-&gt;pClientRandom),
 798             &amp;(cKKeyMatParamRandomInfo-&gt;ulClientRandomLen));
<a name="117" id="anc117"></a><span class="line-modified"> 799     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 800         // just return as no memory allocation yet</span>
<span class="line-added"> 801         return;</span>
<span class="line-added"> 802     }</span>
 803     jByteArrayToCKByteArray(env, jRIServerRandom,
 804             &amp;(cKKeyMatParamRandomInfo-&gt;pServerRandom),
 805             &amp;(cKKeyMatParamRandomInfo-&gt;ulServerRandomLen));
 806     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="118" id="anc118"></a><span class="line-modified"> 807         goto cleanup;</span>

 808     }
<a name="119" id="anc119"></a><span class="line-modified"> 809     /* allocate memory for pReturnedKeyMaterial */</span>
 810     *cKKeyMatParamPReturnedKeyMaterial =
<a name="120" id="anc120"></a><span class="line-modified"> 811             (CK_SSL3_KEY_MAT_OUT_PTR) calloc(1, sizeof(CK_SSL3_KEY_MAT_OUT));</span>
 812     if (*cKKeyMatParamPReturnedKeyMaterial == NULL) {
<a name="121" id="anc121"></a>

 813         throwOutOfMemoryError(env, 0);
<a name="122" id="anc122"></a><span class="line-modified"> 814         goto cleanup;</span>
 815     }
 816 
 817     // the handles are output params only, no need to fetch them from Java
 818     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientMacSecret = 0;
 819     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerMacSecret = 0;
 820     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientKey = 0;
 821     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerKey = 0;
 822 
 823     jByteArrayToCKByteArray(env, jRMIvClient,
 824             &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient), &amp;ckTemp);
 825     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="123" id="anc123"></a><span class="line-modified"> 826         goto cleanup;</span>



 827     }
 828     jByteArrayToCKByteArray(env, jRMIvServer,
 829             &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVServer), &amp;ckTemp);
 830     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="124" id="anc124"></a><span class="line-modified"> 831         goto cleanup;</span>




 832     }
 833 
<a name="125" id="anc125"></a><span class="line-added"> 834     return;</span>
<span class="line-added"> 835 cleanup:</span>
<span class="line-added"> 836     free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-added"> 837     free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-added"> 838     if ((*cKKeyMatParamPReturnedKeyMaterial) != NULL) {</span>
<span class="line-added"> 839         free((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient);</span>
<span class="line-added"> 840         free(*cKKeyMatParamPReturnedKeyMaterial);</span>
<span class="line-added"> 841     }</span>
<span class="line-added"> 842     // explicitly set to NULL to ensure no double free possible</span>
<span class="line-added"> 843     cKKeyMatParamRandomInfo-&gt;pClientRandom = NULL;</span>
<span class="line-added"> 844     cKKeyMatParamRandomInfo-&gt;pServerRandom = NULL;</span>
<span class="line-added"> 845     *cKKeyMatParamPReturnedKeyMaterial = NULL;</span>
 846     return;
 847 }
 848 /*
 849  * converts the Java CK_SSL3_KEY_MAT_PARAMS object to a
<a name="126" id="anc126"></a><span class="line-modified"> 850  * CK_SSL3_KEY_MAT_PARAMS pointer</span>
 851  *
 852  * @param env - used to call JNI funktions to get the Java classes and objects
 853  * @param jParam - the Java CK_SSL3_KEY_MAT_PARAMS object to convert
<a name="127" id="anc127"></a><span class="line-modified"> 854  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 855  * @return pointer to the new CK_SSL3_KEY_MAT_PARAMS structure</span>
 856  */
<a name="128" id="anc128"></a><span class="line-modified"> 857 CK_SSL3_KEY_MAT_PARAMS_PTR</span>
<span class="line-modified"> 858 jSsl3KeyMatParamToCKSsl3KeyMatParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
 859 {
<a name="129" id="anc129"></a><span class="line-modified"> 860     CK_SSL3_KEY_MAT_PARAMS_PTR ckParamPtr;</span>
 861     jclass jSsl3KeyMatParamsClass;
<a name="130" id="anc130"></a><span class="line-modified"> 862 </span>
<span class="line-added"> 863     if (pLength != NULL) {</span>
<span class="line-added"> 864         *pLength = 0;</span>
<span class="line-added"> 865     }</span>
<span class="line-added"> 866 </span>
<span class="line-added"> 867     // allocate memory for CK_SSL3_KEY_MAT_PARAMS pointer</span>
<span class="line-added"> 868     ckParamPtr = calloc(1, sizeof(CK_SSL3_KEY_MAT_PARAMS));</span>
<span class="line-added"> 869     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 870         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 871         return NULL;</span>
<span class="line-added"> 872     }</span>
<span class="line-added"> 873 </span>
<span class="line-added"> 874     // retrieve and  populate using java values</span>
 875     jSsl3KeyMatParamsClass = (*env)-&gt;FindClass(env,
 876             CLASS_SSL3_KEY_MAT_PARAMS);
<a name="131" id="anc131"></a><span class="line-modified"> 877     if (jSsl3KeyMatParamsClass == NULL) {</span>
<span class="line-added"> 878         goto cleanup;</span>
<span class="line-added"> 879     }</span>
 880     keyMatParamToCKKeyMatParam(env, jParam, jSsl3KeyMatParamsClass,
<a name="132" id="anc132"></a><span class="line-modified"> 881             &amp;(ckParamPtr-&gt;ulMacSizeInBits), &amp;(ckParamPtr-&gt;ulKeySizeInBits),</span>
<span class="line-modified"> 882             &amp;(ckParamPtr-&gt;ulIVSizeInBits), &amp;(ckParamPtr-&gt;bIsExport),</span>
<span class="line-modified"> 883             &amp;(ckParamPtr-&gt;RandomInfo), &amp;(ckParamPtr-&gt;pReturnedKeyMaterial));</span>
<span class="line-modified"> 884     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 885         goto cleanup;</span>
<span class="line-added"> 886     }</span>
<span class="line-added"> 887 </span>
<span class="line-added"> 888     if (pLength != NULL) {</span>
<span class="line-added"> 889         *pLength = sizeof(CK_SSL3_KEY_MAT_PARAMS);</span>
<span class="line-added"> 890     }</span>
<span class="line-added"> 891     return ckParamPtr;</span>
<span class="line-added"> 892 cleanup:</span>
<span class="line-added"> 893     free(ckParamPtr);</span>
<span class="line-added"> 894     return NULL;</span>
 895 }
 896 
 897 /*
 898  * converts the Java CK_TLS12_KEY_MAT_PARAMS object to a
<a name="133" id="anc133"></a><span class="line-modified"> 899  * CK_TLS12_KEY_MAT_PARAMS pointer</span>
 900  *
 901  * @param env - used to call JNI functions to get the Java classes and objects
 902  * @param jParam - the Java CK_TLS12_KEY_MAT_PARAMS object to convert
<a name="134" id="anc134"></a><span class="line-modified"> 903  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 904  * @return pointer to the new CK_TLS12_KEY_MAT_PARAMS structure</span>
 905  */
<a name="135" id="anc135"></a><span class="line-modified"> 906 CK_TLS12_KEY_MAT_PARAMS_PTR jTls12KeyMatParamToCKTls12KeyMatParamPtr(JNIEnv *env,</span>
<span class="line-modified"> 907         jobject jParam, CK_ULONG *pLength)</span>
 908 {
<a name="136" id="anc136"></a><span class="line-modified"> 909     CK_TLS12_KEY_MAT_PARAMS_PTR ckParamPtr;</span>
 910     jclass jTls12KeyMatParamsClass;
 911     jfieldID fieldID;
<a name="137" id="anc137"></a><span class="line-modified"> 912     jlong prfHashMechanism;</span>
<span class="line-added"> 913 </span>
<span class="line-added"> 914     if (pLength != NULL) {</span>
<span class="line-added"> 915         *pLength = 0;</span>
<span class="line-added"> 916     }</span>
<span class="line-added"> 917 </span>
<span class="line-added"> 918     // retrieve java values</span>
 919     jTls12KeyMatParamsClass = (*env)-&gt;FindClass(env,
 920             CLASS_TLS12_KEY_MAT_PARAMS);
<a name="138" id="anc138"></a><span class="line-modified"> 921     if (jTls12KeyMatParamsClass == NULL) { return NULL; }</span>




 922     fieldID = (*env)-&gt;GetFieldID(env, jTls12KeyMatParamsClass,
 923             &quot;prfHashMechanism&quot;, &quot;J&quot;);
<a name="139" id="anc139"></a><span class="line-modified"> 924     if (fieldID == NULL) { return NULL; }</span>
<span class="line-modified"> 925     prfHashMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified"> 926 </span>
<span class="line-added"> 927     // allocate memory for CK_TLS12_KEY_MAT_PARAMS pointer</span>
<span class="line-added"> 928     ckParamPtr = calloc(1, sizeof(CK_TLS12_KEY_MAT_PARAMS));</span>
<span class="line-added"> 929     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 930         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 931         return NULL;</span>
<span class="line-added"> 932     }</span>
<span class="line-added"> 933 </span>
<span class="line-added"> 934     // populate using java values</span>
<span class="line-added"> 935     keyMatParamToCKKeyMatParam(env, jParam, jTls12KeyMatParamsClass,</span>
<span class="line-added"> 936             &amp;(ckParamPtr-&gt;ulMacSizeInBits), &amp;(ckParamPtr-&gt;ulKeySizeInBits),</span>
<span class="line-added"> 937             &amp;(ckParamPtr-&gt;ulIVSizeInBits), &amp;(ckParamPtr-&gt;bIsExport),</span>
<span class="line-added"> 938             &amp;(ckParamPtr-&gt;RandomInfo), &amp;(ckParamPtr-&gt;pReturnedKeyMaterial));</span>
<span class="line-added"> 939     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 940         goto cleanup;</span>
 941     }
<a name="140" id="anc140"></a><span class="line-modified"> 942     ckParamPtr-&gt;prfHashMechanism = (CK_MECHANISM_TYPE)prfHashMechanism;</span>
<span class="line-added"> 943 </span>
<span class="line-added"> 944     if (pLength != NULL) {</span>
<span class="line-added"> 945         *pLength = sizeof(CK_TLS12_KEY_MAT_PARAMS);</span>
<span class="line-added"> 946     }</span>
<span class="line-added"> 947     return ckParamPtr;</span>
<span class="line-added"> 948 cleanup:</span>
<span class="line-added"> 949     free(ckParamPtr);</span>
<span class="line-added"> 950     return NULL;</span>
 951 }
 952 
 953 /*
<a name="141" id="anc141"></a><span class="line-modified"> 954  * converts the Java CK_AES_CTR_PARAMS object to a CK_AES_CTR_PARAMS pointer</span>
 955  *
 956  * @param env - used to call JNI funktions to get the Java classes and objects
 957  * @param jParam - the Java CK_AES_CTR_PARAMS object to convert
<a name="142" id="anc142"></a><span class="line-modified"> 958  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 959  * @return pointer to the new CK_AES_CTR_PARAMS structure</span>
 960  */
<a name="143" id="anc143"></a><span class="line-modified"> 961 CK_AES_CTR_PARAMS_PTR</span>
<span class="line-modified"> 962 jAesCtrParamsToCKAesCtrParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
<span class="line-added"> 963 {</span>
<span class="line-added"> 964     CK_AES_CTR_PARAMS_PTR ckParamPtr;</span>
 965     jclass jAesCtrParamsClass;
 966     jfieldID fieldID;
 967     jlong jCounterBits;
 968     jobject jCb;
<a name="144" id="anc144"></a><span class="line-modified"> 969     CK_BYTE_PTR ckBytes = NULL;</span>
 970     CK_ULONG ckTemp;
 971 
<a name="145" id="anc145"></a><span class="line-modified"> 972     if (pLength != NULL) {</span>
<span class="line-added"> 973         *pLength = 0L;</span>
<span class="line-added"> 974     }</span>
<span class="line-added"> 975 </span>
<span class="line-added"> 976     // retrieve java values</span>
 977     jAesCtrParamsClass = (*env)-&gt;FindClass(env, CLASS_AES_CTR_PARAMS);
<a name="146" id="anc146"></a><span class="line-modified"> 978     if (jAesCtrParamsClass == NULL) { return NULL; }</span>
<span class="line-added"> 979     if (!(*env)-&gt;IsInstanceOf(env, jParam, jAesCtrParamsClass)) {</span>
<span class="line-added"> 980         return NULL;</span>
<span class="line-added"> 981     }</span>
 982     fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;ulCounterBits&quot;, &quot;J&quot;);
<a name="147" id="anc147"></a><span class="line-modified"> 983     if (fieldID == NULL) { return NULL; }</span>
 984     jCounterBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="148" id="anc148"></a>

 985     fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;cb&quot;, &quot;[B&quot;);
<a name="149" id="anc149"></a><span class="line-modified"> 986     if (fieldID == NULL) { return NULL; }</span>
 987     jCb = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 988 
<a name="150" id="anc150"></a><span class="line-modified"> 989     // allocate memory for CK_AES_CTR_PARAMS pointer</span>
<span class="line-modified"> 990     ckParamPtr = calloc(1, sizeof(CK_AES_CTR_PARAMS));</span>
<span class="line-added"> 991     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 992         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 993         return NULL;</span>
<span class="line-added"> 994     }</span>
<span class="line-added"> 995 </span>
<span class="line-added"> 996     // populate using java values</span>
 997     jByteArrayToCKByteArray(env, jCb, &amp;ckBytes, &amp;ckTemp);
<a name="151" id="anc151"></a><span class="line-modified"> 998     if ((*env)-&gt;ExceptionCheck(env) || ckTemp != 16) {</span>
<span class="line-modified"> 999         goto cleanup;</span>
<span class="line-modified">1000     }</span>
<span class="line-modified">1001     memcpy(ckParamPtr-&gt;cb, ckBytes, ckTemp);</span>
<span class="line-modified">1002     free(ckBytes);</span>
<span class="line-modified">1003 </span>
<span class="line-added">1004     ckParamPtr-&gt;ulCounterBits = jLongToCKULong(jCounterBits);</span>
<span class="line-added">1005 </span>
<span class="line-added">1006     if (pLength != NULL) {</span>
<span class="line-added">1007         *pLength = sizeof(CK_AES_CTR_PARAMS);</span>
1008     }
<a name="152" id="anc152"></a><span class="line-added">1009     return ckParamPtr;</span>
<span class="line-added">1010 cleanup:</span>
<span class="line-added">1011     free(ckBytes);</span>
<span class="line-added">1012     free(ckParamPtr);</span>
<span class="line-added">1013     return NULL;</span>
1014 }
1015 
1016 /*
<a name="153" id="anc153"></a><span class="line-modified">1017  * converts the Java CK_GCM_PARAMS object to a CK_GCM_PARAMS_NO_IVBITS pointer</span>
<span class="line-added">1018  * Note: Need to try NSS definition first to avoid SIGSEGV.</span>
1019  *
<a name="154" id="anc154"></a><span class="line-modified">1020  * @param env - used to call JNI funktions to get the Java classes and objects</span>
<span class="line-modified">1021  * @param jParam - the Java CK_GCM_PARAMS object to convert</span>
<span class="line-modified">1022  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1023  * @return pointer to the new CK_GCM_PARAMS_NO_IVBITS structure</span>
1024  */
<a name="155" id="anc155"></a><span class="line-modified">1025 CK_GCM_PARAMS_NO_IVBITS_PTR</span>
<span class="line-added">1026 jGCMParamsToCKGCMParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1027 {
<a name="156" id="anc156"></a><span class="line-modified">1028     CK_GCM_PARAMS_NO_IVBITS_PTR ckParamPtr;</span>
<span class="line-modified">1029     jclass jGcmParamsClass;</span>
<span class="line-added">1030     jfieldID fieldID;</span>
<span class="line-added">1031     jobject jIv, jAad;</span>
<span class="line-added">1032     jlong jTagLen;</span>
1033 
<a name="157" id="anc157"></a><span class="line-modified">1034     TRACE0(&quot;DEBUG jGCMParamsToCKGCMParam is called\n&quot;);</span>
1035 
<a name="158" id="anc158"></a><span class="line-modified">1036     if (pLength != NULL) {</span>
<span class="line-modified">1037         *pLength = 0L;</span>
<span class="line-modified">1038     }</span>
<span class="line-modified">1039 </span>
<span class="line-modified">1040     // retrieve java values</span>
<span class="line-modified">1041     jGcmParamsClass = (*env)-&gt;FindClass(env, CLASS_GCM_PARAMS);</span>
<span class="line-modified">1042     if (jGcmParamsClass == NULL) { return NULL; }</span>
<span class="line-modified">1043     if (!(*env)-&gt;IsInstanceOf(env, jParam, jGcmParamsClass)) {</span>
<span class="line-added">1044         return NULL;</span>
<span class="line-added">1045     }</span>
<span class="line-added">1046     fieldID = (*env)-&gt;GetFieldID(env, jGcmParamsClass, &quot;iv&quot;, &quot;[B&quot;);</span>
<span class="line-added">1047     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1048     jIv = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">1049     fieldID = (*env)-&gt;GetFieldID(env, jGcmParamsClass, &quot;aad&quot;, &quot;[B&quot;);</span>
<span class="line-added">1050     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1051     jAad = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">1052     fieldID = (*env)-&gt;GetFieldID(env, jGcmParamsClass, &quot;tagBits&quot;, &quot;J&quot;);</span>
<span class="line-added">1053     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1054     jTagLen = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-added">1055 </span>
<span class="line-added">1056     // allocate memory for CK_GCM_PARAMS_NO_IVBITS pointer</span>
<span class="line-added">1057     ckParamPtr = calloc(1, sizeof(CK_GCM_PARAMS_NO_IVBITS));</span>
<span class="line-added">1058     if (ckParamPtr == NULL) {</span>
<span class="line-added">1059         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">1060         return NULL;</span>
<span class="line-added">1061     }</span>
<span class="line-added">1062 </span>
<span class="line-added">1063     // populate using java values</span>
<span class="line-added">1064     jByteArrayToCKByteArray(env, jIv, &amp;(ckParamPtr-&gt;pIv), &amp;(ckParamPtr-&gt;ulIvLen));</span>
<span class="line-added">1065     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1066         goto cleanup;</span>
<span class="line-added">1067     }</span>
<span class="line-added">1068 </span>
<span class="line-added">1069     jByteArrayToCKByteArray(env, jAad, &amp;(ckParamPtr-&gt;pAAD), &amp;(ckParamPtr-&gt;ulAADLen));</span>
<span class="line-added">1070     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1071         goto cleanup;</span>
<span class="line-added">1072     }</span>
<span class="line-added">1073 </span>
<span class="line-added">1074     ckParamPtr-&gt;ulTagBits = jLongToCKULong(jTagLen);</span>
<span class="line-added">1075 </span>
<span class="line-added">1076     if (pLength != NULL) {</span>
<span class="line-added">1077         *pLength = sizeof(CK_GCM_PARAMS_NO_IVBITS);</span>
1078     }
<a name="159" id="anc159"></a><span class="line-added">1079     TRACE1(&quot;Created inner GCM_PARAMS PTR w/o ulIvBits %p\n&quot;, ckParamPtr);</span>
<span class="line-added">1080     return ckParamPtr;</span>
<span class="line-added">1081 cleanup:</span>
<span class="line-added">1082     free(ckParamPtr-&gt;pIv);</span>
<span class="line-added">1083     free(ckParamPtr-&gt;pAAD);</span>
<span class="line-added">1084     free(ckParamPtr);</span>
<span class="line-added">1085     return NULL;</span>
1086 }
1087 
1088 /*
<a name="160" id="anc160"></a><span class="line-modified">1089  * converts the Java CK_CCM_PARAMS object to a CK_CCM_PARAMS pointer</span>








1090  *
<a name="161" id="anc161"></a><span class="line-modified">1091  * @param env - used to call JNI functions to get the Java classes and objects</span>
<span class="line-modified">1092  * @param jParam - the Java CK_CCM_PARAMS object to convert</span>
<span class="line-modified">1093  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-modified">1094  * @return pointer to the new CK_CCM_PARAMS structure</span>
<span class="line-modified">1095  */</span>
<span class="line-modified">1096 CK_CCM_PARAMS_PTR</span>
<span class="line-modified">1097 jCCMParamsToCKCCMParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
<span class="line-modified">1098 {</span>
<span class="line-modified">1099     CK_CCM_PARAMS_PTR ckParamPtr;</span>
<span class="line-modified">1100     jclass jCcmParamsClass;</span>
<span class="line-modified">1101     jfieldID fieldID;</span>
<span class="line-modified">1102     jobject jNonce, jAad;</span>
<span class="line-modified">1103     jlong jDataLen, jMacLen;</span>
<span class="line-modified">1104 </span>
<span class="line-modified">1105     if (pLength != NULL) {</span>
<span class="line-modified">1106         *pLength = 0;</span>
<span class="line-modified">1107     }</span>
<span class="line-modified">1108 </span>
<span class="line-added">1109     // retrieve java values</span>
<span class="line-added">1110     jCcmParamsClass = (*env)-&gt;FindClass(env, CLASS_CCM_PARAMS);</span>
<span class="line-added">1111     if (jCcmParamsClass == NULL) { return NULL; }</span>
<span class="line-added">1112     if (!(*env)-&gt;IsInstanceOf(env, jParam, jCcmParamsClass)) {</span>
<span class="line-added">1113         return NULL;</span>
<span class="line-added">1114     }</span>
<span class="line-added">1115     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;dataLen&quot;, &quot;J&quot;);</span>
<span class="line-added">1116     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1117     jDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-added">1118     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;nonce&quot;, &quot;[B&quot;);</span>
<span class="line-added">1119     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1120     jNonce = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">1121     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;aad&quot;, &quot;[B&quot;);</span>
<span class="line-added">1122     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1123     jAad = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">1124     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;macLen&quot;, &quot;J&quot;);</span>
<span class="line-added">1125     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1126     jMacLen = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-added">1127 </span>
<span class="line-added">1128     // allocate memory for CK_CCM_PARAMS pointer</span>
<span class="line-added">1129     ckParamPtr = calloc(1, sizeof(CK_CCM_PARAMS));</span>
<span class="line-added">1130     if (ckParamPtr == NULL) {</span>
<span class="line-added">1131         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">1132         return NULL;</span>
<span class="line-added">1133     }</span>
<span class="line-added">1134 </span>
<span class="line-added">1135     // populate using java values</span>
<span class="line-added">1136     ckParamPtr-&gt;ulDataLen = jLongToCKULong(jDataLen);</span>
<span class="line-added">1137     jByteArrayToCKByteArray(env, jNonce, &amp;(ckParamPtr-&gt;pNonce),</span>
<span class="line-added">1138             &amp;(ckParamPtr-&gt;ulNonceLen));</span>
<span class="line-added">1139     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1140         goto cleanup;</span>
<span class="line-added">1141     }</span>
<span class="line-added">1142 </span>
<span class="line-added">1143     jByteArrayToCKByteArray(env, jAad, &amp;(ckParamPtr-&gt;pAAD),</span>
<span class="line-added">1144             &amp;(ckParamPtr-&gt;ulAADLen));</span>
<span class="line-added">1145     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1146         goto cleanup;</span>
<span class="line-added">1147     }</span>
<span class="line-added">1148 </span>
<span class="line-added">1149     ckParamPtr-&gt;ulMACLen = jLongToCKULong(jMacLen);</span>
<span class="line-added">1150 </span>
<span class="line-added">1151     if (pLength != NULL) {</span>
<span class="line-added">1152         *pLength = sizeof(CK_CCM_PARAMS);</span>
<span class="line-added">1153     }</span>
<span class="line-added">1154     return ckParamPtr;</span>
<span class="line-added">1155 cleanup:</span>
<span class="line-added">1156     free(ckParamPtr-&gt;pNonce);</span>
<span class="line-added">1157     free(ckParamPtr-&gt;pAAD);</span>
<span class="line-added">1158     free(ckParamPtr);</span>
<span class="line-added">1159     return NULL;</span>
<span class="line-added">1160 }</span>
<span class="line-added">1161 </span>
<span class="line-added">1162 /*</span>
<span class="line-added">1163  * converts a Java CK_MECHANISM object into a CK_MECHANISM pointer</span>
<span class="line-added">1164  * pointer.</span>
1165  *
<a name="162" id="anc162"></a><span class="line-modified">1166  * @param env - used to call JNI funktions to get the values out of the Java object</span>
<span class="line-modified">1167  * @param jMech - the Java CK_MECHANISM object to convert</span>
<span class="line-modified">1168  * @return pointer to the new CK_MECHANISM structure</span>


1169  */
<a name="163" id="anc163"></a><span class="line-added">1170 CK_MECHANISM_PTR jMechanismToCKMechanismPtr(JNIEnv *env, jobject jMech)</span>
<span class="line-added">1171 {</span>
<span class="line-added">1172     CK_MECHANISM_PTR ckpMech;</span>
<span class="line-added">1173     jlong jMechType = (*env)-&gt;GetLongField(env, jMech, mech_mechanismID);</span>
<span class="line-added">1174     jobject jParam = (*env)-&gt;GetObjectField(env, jMech, mech_pParameterID);</span>
<span class="line-added">1175 </span>
<span class="line-added">1176     /* allocate memory for CK_MECHANISM_PTR */</span>
<span class="line-added">1177     ckpMech =  (CK_MECHANISM_PTR) calloc(1, sizeof(CK_MECHANISM));</span>
<span class="line-added">1178     if (ckpMech == NULL) {</span>
<span class="line-added">1179         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">1180         return NULL;</span>
<span class="line-added">1181     }</span>
<span class="line-added">1182     TRACE1(&quot;DEBUG jMechanismToCKMechanismPtr: allocated mech %p\n&quot;, ckpMech);</span>
<span class="line-added">1183 </span>
<span class="line-added">1184     ckpMech-&gt;mechanism = jLongToCKULong(jMechType);</span>
<span class="line-added">1185 </span>
<span class="line-added">1186     /* convert the specific Java mechanism parameter object to a pointer to a</span>
<span class="line-added">1187      *  CK-type mechanism structure</span>
<span class="line-added">1188      */</span>
<span class="line-added">1189     if (jParam == NULL) {</span>
<span class="line-added">1190         ckpMech-&gt;pParameter = NULL;</span>
<span class="line-added">1191         ckpMech-&gt;ulParameterLen = 0;</span>
<span class="line-added">1192     } else {</span>
<span class="line-added">1193         ckpMech-&gt;pParameter = jMechParamToCKMechParamPtr(env, jParam,</span>
<span class="line-added">1194             ckpMech-&gt;mechanism, &amp;(ckpMech-&gt;ulParameterLen));</span>
<span class="line-added">1195     }</span>
<span class="line-added">1196     return ckpMech;</span>
<span class="line-added">1197 }</span>
1198 
1199 /*
<a name="164" id="anc164"></a><span class="line-modified">1200  * converts the pValue of a CK_ATTRIBUTE structure into a Java Object by</span>
<span class="line-modified">1201  * checking the type of the attribute. A PKCS#11 attribute value can</span>
<span class="line-added">1202  * be a CK_ULONG, CK_BYTE[], CK_CHAR[], big integer, CK_BBOOL, CK_UTF8CHAR[],</span>
<span class="line-added">1203  * CK_DATE or CK_FLAGS that gets converted to a corresponding Java object.</span>
1204  *
<a name="165" id="anc165"></a><span class="line-modified">1205  * @param env - used to call JNI functions to create the new Java object</span>
1206  * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure that contains the type
1207  *                       and the pValue to convert
<a name="166" id="anc166"></a><span class="line-modified">1208  * @return the new Java object of the CK-type pValue</span>
1209  */
1210 jobject ckAttributeValueToJObject(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
1211 {
1212     jint jValueLength;
1213     jobject jValueObject = NULL;
1214 
1215     jValueLength = ckULongToJInt(ckpAttribute-&gt;ulValueLen);
1216 
1217     if ((jValueLength &lt;= 0) || (ckpAttribute-&gt;pValue == NULL)) {
1218         return NULL ;
1219     }
1220 
1221     switch(ckpAttribute-&gt;type) {
1222         case CKA_CLASS:
1223             /* value CK_OBJECT_CLASS, defacto a CK_ULONG */
1224         case CKA_KEY_TYPE:
1225             /* value CK_KEY_TYPE, defacto a CK_ULONG */
1226         case CKA_CERTIFICATE_TYPE:
1227             /* value CK_CERTIFICATE_TYPE, defacto a CK_ULONG */
1228         case CKA_HW_FEATURE_TYPE:
1229             /* value CK_HW_FEATURE_TYPE, defacto a CK_ULONG */
1230         case CKA_MODULUS_BITS:
1231         case CKA_VALUE_BITS:
1232         case CKA_VALUE_LEN:
1233         case CKA_KEY_GEN_MECHANISM:
1234         case CKA_PRIME_BITS:
1235         case CKA_SUB_PRIME_BITS:
1236             /* value CK_ULONG */
1237             jValueObject = ckULongPtrToJLongObject(env, (CK_ULONG*) ckpAttribute-&gt;pValue);
1238             break;
1239 
1240             /* can be CK_BYTE[],CK_CHAR[] or big integer; defacto always CK_BYTE[] */
1241         case CKA_VALUE:
1242         case CKA_OBJECT_ID:
1243         case CKA_SUBJECT:
1244         case CKA_ID:
1245         case CKA_ISSUER:
1246         case CKA_SERIAL_NUMBER:
1247         case CKA_OWNER:
1248         case CKA_AC_ISSUER:
1249         case CKA_ATTR_TYPES:
1250         case CKA_ECDSA_PARAMS:
1251             /* CKA_EC_PARAMS is the same, these two are equivalent */
1252         case CKA_EC_POINT:
1253         case CKA_PRIVATE_EXPONENT:
1254         case CKA_PRIME_1:
1255         case CKA_PRIME_2:
1256         case CKA_EXPONENT_1:
1257         case CKA_EXPONENT_2:
1258         case CKA_COEFFICIENT:
1259             /* value CK_BYTE[] */
1260             jValueObject = ckByteArrayToJByteArray(env, (CK_BYTE*) ckpAttribute-&gt;pValue, jValueLength);
1261             break;
1262 
1263         case CKA_RESET_ON_INIT:
1264         case CKA_HAS_RESET:
1265         case CKA_TOKEN:
1266         case CKA_PRIVATE:
1267         case CKA_MODIFIABLE:
1268         case CKA_DERIVE:
1269         case CKA_LOCAL:
1270         case CKA_ENCRYPT:
1271         case CKA_VERIFY:
1272         case CKA_VERIFY_RECOVER:
1273         case CKA_WRAP:
1274         case CKA_SENSITIVE:
1275         case CKA_SECONDARY_AUTH:
1276         case CKA_DECRYPT:
1277         case CKA_SIGN:
1278         case CKA_SIGN_RECOVER:
1279         case CKA_UNWRAP:
1280         case CKA_EXTRACTABLE:
1281         case CKA_ALWAYS_SENSITIVE:
1282         case CKA_NEVER_EXTRACTABLE:
1283         case CKA_TRUSTED:
1284             /* value CK_BBOOL */
1285             jValueObject = ckBBoolPtrToJBooleanObject(env, (CK_BBOOL*) ckpAttribute-&gt;pValue);
1286             break;
1287 
1288         case CKA_LABEL:
1289         case CKA_APPLICATION:
1290             /* value RFC 2279 (UTF-8) string */
1291             jValueObject = ckUTF8CharArrayToJCharArray(env, (CK_UTF8CHAR*) ckpAttribute-&gt;pValue, jValueLength);
1292             break;
1293 
1294         case CKA_START_DATE:
1295         case CKA_END_DATE:
1296             /* value CK_DATE */
1297             jValueObject = ckDatePtrToJDateObject(env, (CK_DATE*) ckpAttribute-&gt;pValue);
1298             break;
1299 
1300         case CKA_MODULUS:
1301         case CKA_PUBLIC_EXPONENT:
1302         case CKA_PRIME:
1303         case CKA_SUBPRIME:
1304         case CKA_BASE:
1305             /* value big integer, i.e. CK_BYTE[] */
1306             jValueObject = ckByteArrayToJByteArray(env, (CK_BYTE*) ckpAttribute-&gt;pValue, jValueLength);
1307             break;
1308 
1309         case CKA_AUTH_PIN_FLAGS:
1310             jValueObject = ckULongPtrToJLongObject(env, (CK_ULONG*) ckpAttribute-&gt;pValue);
1311             /* value FLAGS, defacto a CK_ULONG */
1312             break;
1313 
1314         case CKA_VENDOR_DEFINED:
1315             /* we make a CK_BYTE[] out of this */
1316             jValueObject = ckByteArrayToJByteArray(env, (CK_BYTE*) ckpAttribute-&gt;pValue, jValueLength);
1317             break;
1318 
1319         // Netscape trust attributes
1320         case CKA_NETSCAPE_TRUST_SERVER_AUTH:
1321         case CKA_NETSCAPE_TRUST_CLIENT_AUTH:
1322         case CKA_NETSCAPE_TRUST_CODE_SIGNING:
1323         case CKA_NETSCAPE_TRUST_EMAIL_PROTECTION:
1324             /* value CK_ULONG */
1325             jValueObject = ckULongPtrToJLongObject(env, (CK_ULONG*) ckpAttribute-&gt;pValue);
1326             break;
1327 
1328         default:
1329             /* we make a CK_BYTE[] out of this */
1330             jValueObject = ckByteArrayToJByteArray(env, (CK_BYTE*) ckpAttribute-&gt;pValue, jValueLength);
1331             break;
1332     }
1333 
1334     return jValueObject ;
1335 }
1336 
1337 /*
1338  * the following functions convert a Java mechanism parameter object to a PKCS#11
1339  * mechanism parameter structure
1340  *
1341  * CK_&lt;Param&gt;_PARAMS j&lt;Param&gt;ParamToCK&lt;Param&gt;Param(JNIEnv *env,
1342  *                                                 jobject jParam);
1343  *
1344  * These functions get a Java object, that must be the right Java mechanism
1345  * object and they return the new PKCS#11 mechanism parameter structure.
1346  * Every field of the Java object is retrieved, gets converted to a corresponding
1347  * PKCS#11 type and is set in the new PKCS#11 structure.
1348  */
1349 
1350 /*
<a name="167" id="anc167"></a><span class="line-modified">1351  * converts the given Java mechanism parameter to a CK mechanism parameter</span>
<span class="line-modified">1352  * pointer and store the length in bytes in the length variable.</span>

1353  *
1354  * @param env - used to call JNI funktions to get the Java classes and objects
1355  * @param jParam - the Java mechanism parameter object to convert
<a name="168" id="anc168"></a><span class="line-modified">1356  * @param ckMech - the PKCS#11 mechanism type</span>

1357  * @param ckpLength - the reference of the length in bytes of the new CK mechanism parameter
1358  *                    structure
<a name="169" id="anc169"></a><span class="line-added">1359  * @return pointer to the new CK mechanism parameter structure</span>
1360  */
<a name="170" id="anc170"></a><span class="line-modified">1361 CK_VOID_PTR jMechParamToCKMechParamPtr(JNIEnv *env, jobject jParam,</span>
<span class="line-added">1362         CK_MECHANISM_TYPE ckMech, CK_ULONG *ckpLength)</span>
1363 {
<a name="171" id="anc171"></a><span class="line-added">1364     CK_VOID_PTR ckpParamPtr;</span>
1365     if (jParam == NULL) {
<a name="172" id="anc172"></a><span class="line-modified">1366         ckpParamPtr = NULL;</span>
1367         *ckpLength = 0;
1368     } else if ((*env)-&gt;IsInstanceOf(env, jParam, jByteArrayClass)) {
<a name="173" id="anc173"></a><span class="line-modified">1369         jByteArrayToCKByteArray(env, jParam, (CK_BYTE_PTR *) &amp;ckpParamPtr, ckpLength);</span>
1370     } else if ((*env)-&gt;IsInstanceOf(env, jParam, jLongClass)) {
<a name="174" id="anc174"></a><span class="line-modified">1371         ckpParamPtr = jLongObjectToCKULongPtr(env, jParam);</span>
1372         *ckpLength = sizeof(CK_ULONG);
1373     } else {
<a name="175" id="anc175"></a><span class="line-modified">1374         ckpParamPtr = jMechParamToCKMechParamPtrSlow(env, jParam, ckMech, ckpLength);</span>

1375     }
<a name="176" id="anc176"></a><span class="line-added">1376     return ckpParamPtr;</span>
1377 }
1378 
<a name="177" id="anc177"></a><span class="line-modified">1379 CK_VOID_PTR jMechParamToCKMechParamPtrSlow(JNIEnv *env, jobject jParam,</span>
<span class="line-added">1380         CK_MECHANISM_TYPE ckMech, CK_ULONG *ckpLength)</span>
1381 {
<a name="178" id="anc178"></a><span class="line-modified">1382     CK_VOID_PTR ckpParamPtr = NULL;</span>









1383 
<a name="179" id="anc179"></a><span class="line-modified">1384     /*</span>
<span class="line-modified">1385      * Most common cases, i.e. NULL/byte[]/long, are already handled by</span>
<span class="line-added">1386      * jMechParamToCKMechParam before calling this method.</span>
1387      */
<a name="180" id="anc180"></a><span class="line-modified">1388     TRACE1(&quot;\nDEBUG: jMechParamToCKMechParamPtrSlow, mech=0x%lX\n&quot;, ckMech);</span>
<span class="line-modified">1389 </span>
<span class="line-modified">1390     switch (ckMech) {</span>
<span class="line-modified">1391         case CKM_SSL3_PRE_MASTER_KEY_GEN:</span>
<span class="line-modified">1392         case CKM_TLS_PRE_MASTER_KEY_GEN:</span>
<span class="line-modified">1393             ckpParamPtr = jVersionToCKVersionPtr(env, jParam);</span>
<span class="line-modified">1394             if (ckpParamPtr != NULL) {</span>
<span class="line-modified">1395                 *ckpLength = sizeof(CK_VERSION);</span>
<span class="line-modified">1396             } else {</span>
<span class="line-modified">1397                 *ckpLength = 0;</span>
<span class="line-modified">1398             }</span>
<span class="line-modified">1399             break;</span>
<span class="line-modified">1400         case CKM_SSL3_MASTER_KEY_DERIVE:</span>
<span class="line-modified">1401         case CKM_TLS_MASTER_KEY_DERIVE:</span>
<span class="line-modified">1402         case CKM_SSL3_MASTER_KEY_DERIVE_DH:</span>
<span class="line-modified">1403         case CKM_TLS_MASTER_KEY_DERIVE_DH:</span>
<span class="line-modified">1404             ckpParamPtr = jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParamPtr(env, jParam,</span>
<span class="line-modified">1405                     ckpLength);</span>
<span class="line-modified">1406             break;</span>
<span class="line-modified">1407         case CKM_SSL3_KEY_AND_MAC_DERIVE:</span>
<span class="line-modified">1408         case CKM_TLS_KEY_AND_MAC_DERIVE:</span>
<span class="line-modified">1409             ckpParamPtr = jSsl3KeyMatParamToCKSsl3KeyMatParamPtr(env, jParam,</span>
<span class="line-modified">1410                     ckpLength);</span>
<span class="line-modified">1411             break;</span>
<span class="line-modified">1412         case CKM_TLS12_KEY_AND_MAC_DERIVE:</span>
<span class="line-modified">1413             ckpParamPtr = jTls12KeyMatParamToCKTls12KeyMatParamPtr(env, jParam,</span>
<span class="line-modified">1414                     ckpLength);</span>
<span class="line-modified">1415             break;</span>
<span class="line-modified">1416         case CKM_TLS12_MASTER_KEY_DERIVE:</span>
<span class="line-modified">1417         case CKM_TLS12_MASTER_KEY_DERIVE_DH:</span>
<span class="line-modified">1418             ckpParamPtr = jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParamPtr(env, jParam,</span>
<span class="line-modified">1419                     ckpLength);</span>
<span class="line-modified">1420             break;</span>
<span class="line-modified">1421         case CKM_TLS_PRF:</span>
<span class="line-modified">1422         case CKM_NSS_TLS_PRF_GENERAL:</span>
<span class="line-modified">1423             ckpParamPtr = jTlsPrfParamsToCKTlsPrfParamPtr(env, jParam,</span>
<span class="line-modified">1424                     ckpLength);</span>
<span class="line-modified">1425             break;</span>
<span class="line-modified">1426         case CKM_TLS_MAC:</span>
<span class="line-modified">1427             ckpParamPtr = jTlsMacParamsToCKTlsMacParamPtr(env, jParam,</span>
<span class="line-modified">1428                     ckpLength);</span>
<span class="line-modified">1429             break;</span>
<span class="line-modified">1430         case CKM_AES_CTR:</span>
<span class="line-modified">1431             ckpParamPtr = jAesCtrParamsToCKAesCtrParamPtr(env, jParam,</span>
<span class="line-modified">1432                     ckpLength);</span>
<span class="line-modified">1433             break;</span>
<span class="line-modified">1434         case CKM_AES_GCM:</span>
<span class="line-modified">1435             ckpParamPtr = jGCMParamsToCKGCMParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1436             break;</span>
<span class="line-modified">1437         case CKM_AES_CCM:</span>
<span class="line-modified">1438             ckpParamPtr = jCCMParamsToCKCCMParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1439             break;</span>
<span class="line-modified">1440         case CKM_RSA_PKCS_OAEP:</span>
<span class="line-modified">1441             ckpParamPtr = jRsaPkcsOaepParamToCKRsaPkcsOaepParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1442             break;</span>
<span class="line-modified">1443         case CKM_PBE_SHA1_DES3_EDE_CBC:</span>
<span class="line-modified">1444         case CKM_PBE_SHA1_DES2_EDE_CBC:</span>
<span class="line-modified">1445         case CKM_PBA_SHA1_WITH_SHA1_HMAC:</span>
<span class="line-modified">1446             ckpParamPtr = jPbeParamToCKPbeParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1447             break;</span>
<span class="line-modified">1448         case CKM_PKCS5_PBKD2:</span>
<span class="line-modified">1449             ckpParamPtr = jPkcs5Pbkd2ParamToCKPkcs5Pbkd2ParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1450             break;</span>
<span class="line-modified">1451         case CKM_RSA_PKCS_PSS:</span>
<span class="line-modified">1452         case CKM_SHA1_RSA_PKCS_PSS:</span>
<span class="line-modified">1453         case CKM_SHA256_RSA_PKCS_PSS:</span>
<span class="line-modified">1454         case CKM_SHA384_RSA_PKCS_PSS:</span>
<span class="line-modified">1455         case CKM_SHA512_RSA_PKCS_PSS:</span>
<span class="line-modified">1456         case CKM_SHA224_RSA_PKCS_PSS:</span>
<span class="line-modified">1457             ckpParamPtr = jRsaPkcsPssParamToCKRsaPkcsPssParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1458             break;</span>
<span class="line-modified">1459         case CKM_ECDH1_DERIVE:</span>
<span class="line-modified">1460         case CKM_ECDH1_COFACTOR_DERIVE:</span>
<span class="line-modified">1461             ckpParamPtr = jEcdh1DeriveParamToCKEcdh1DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1462             break;</span>
<span class="line-modified">1463         case CKM_ECMQV_DERIVE:</span>
<span class="line-modified">1464             ckpParamPtr = jEcdh2DeriveParamToCKEcdh2DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1465             break;</span>
<span class="line-modified">1466         case CKM_X9_42_DH_DERIVE:</span>
<span class="line-modified">1467             ckpParamPtr = jX942Dh1DeriveParamToCKX942Dh1DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1468             break;</span>
<span class="line-modified">1469         case CKM_X9_42_DH_HYBRID_DERIVE:</span>
<span class="line-modified">1470         case CKM_X9_42_MQV_DERIVE:</span>
<span class="line-modified">1471             ckpParamPtr = jX942Dh2DeriveParamToCKX942Dh2DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1472             break;</span>
<span class="line-modified">1473         // defined by pkcs11.h but we don&#39;t support</span>
<span class="line-modified">1474         case CKM_KEA_DERIVE: // CK_KEA_DERIVE_PARAMS</span>
<span class="line-modified">1475         case CKM_RC2_CBC: // CK_RC2_CBC_PARAMS</span>
<span class="line-modified">1476         case CKM_RC2_MAC_GENERAL: // CK_RC2_MAC_GENERAL_PARAMS</span>
<span class="line-modified">1477         case CKM_RC5_ECB: // CK_RC5_PARAMS</span>
<span class="line-modified">1478         case CKM_RC5_MAC: // CK_RC5_PARAMS</span>
<span class="line-modified">1479         case CKM_RC5_CBC: // CK_RC5_CBC_PARAMS</span>
<span class="line-modified">1480         case CKM_RC5_MAC_GENERAL: // CK_RC5_MAC_GENERAL_PARAMS</span>
<span class="line-modified">1481         case CKM_SKIPJACK_PRIVATE_WRAP: // CK_SKIPJACK_PRIVATE_WRAP_PARAMS</span>
<span class="line-modified">1482         case CKM_SKIPJACK_RELAYX: // CK_SKIPJACK_RELAYX_PARAMS</span>
<span class="line-modified">1483         case CKM_KEY_WRAP_SET_OAEP: // CK_KEY_WRAP_SET_OAEP_PARAMS</span>
<span class="line-modified">1484             throwPKCS11RuntimeException(env, &quot;No parameter support for this mchanism&quot;);</span>
<span class="line-modified">1485             break;</span>
<span class="line-modified">1486         default:</span>
<span class="line-modified">1487             /* if everything faild up to here */</span>
<span class="line-modified">1488             /* try if the parameter is a primitive Java type */</span>
<span class="line-modified">1489             ckpParamPtr = jObjectToPrimitiveCKObjectPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1490             /* *ckpParamPtr = jObjectToCKVoidPtr(jParam); */</span>
<span class="line-modified">1491             /* *ckpLength = 1; */</span>
































































































































































































































































































1492     }
<a name="181" id="anc181"></a><span class="line-added">1493     TRACE0(&quot;\nDEBUG: jMechParamToCKMechParamPtrSlow FINISHED\n&quot;);</span>
1494 
<a name="182" id="anc182"></a><span class="line-modified">1495     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">1496         return NULL;</span>























1497     }
1498 
<a name="183" id="anc183"></a><span class="line-modified">1499     return ckpParamPtr;</span>






1500 }
1501 
<a name="184" id="anc184"></a>


1502 /*
<a name="185" id="anc185"></a><span class="line-modified">1503  * converts the Java CK_RSA_PKCS_OAEP_PARAMS object to a</span>
<span class="line-added">1504  * CK_RSA_PKCS_OAEP_PARAMS pointer</span>
1505  *
1506  * @param env - used to call JNI funktions to get the Java classes and objects
1507  * @param jParam - the Java CK_RSA_PKCS_OAEP_PARAMS object to convert
<a name="186" id="anc186"></a><span class="line-modified">1508  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1509  * @return pointer to the new CK_RSA_PKCS_OAEP_PARAMS structure</span>
1510  */
<a name="187" id="anc187"></a><span class="line-modified">1511 CK_RSA_PKCS_OAEP_PARAMS_PTR</span>
<span class="line-added">1512 jRsaPkcsOaepParamToCKRsaPkcsOaepParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1513 {
<a name="188" id="anc188"></a><span class="line-added">1514     CK_RSA_PKCS_OAEP_PARAMS_PTR ckParamPtr;</span>
1515     jclass jRsaPkcsOaepParamsClass;
<a name="189" id="anc189"></a>
1516     jfieldID fieldID;
1517     jlong jHashAlg, jMgf, jSource;
1518     jobject jSourceData;
<a name="190" id="anc190"></a>

1519 
<a name="191" id="anc191"></a><span class="line-modified">1520     if (pLength!= NULL) {</span>
<span class="line-added">1521         *pLength = 0L;</span>
<span class="line-added">1522     }</span>
<span class="line-added">1523 </span>
<span class="line-added">1524     // retrieve java values</span>
1525     jRsaPkcsOaepParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_OAEP_PARAMS);
<a name="192" id="anc192"></a><span class="line-modified">1526     if (jRsaPkcsOaepParamsClass == NULL) { return NULL; }</span>
1527     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<a name="193" id="anc193"></a><span class="line-modified">1528     if (fieldID == NULL) { return NULL; }</span>
1529     jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="194" id="anc194"></a>

1530     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<a name="195" id="anc195"></a><span class="line-modified">1531     if (fieldID == NULL) { return NULL; }</span>
1532     jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="196" id="anc196"></a>

1533     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;source&quot;, &quot;J&quot;);
<a name="197" id="anc197"></a><span class="line-modified">1534     if (fieldID == NULL) { return NULL; }</span>
1535     jSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="198" id="anc198"></a>

1536     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;pSourceData&quot;, &quot;[B&quot;);
<a name="199" id="anc199"></a><span class="line-modified">1537     if (fieldID == NULL) { return NULL; }</span>
1538     jSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1539 
<a name="200" id="anc200"></a><span class="line-modified">1540     // allocate memory for CK_RSA_PKCS_OAEP_PARAMS pointer</span>
<span class="line-modified">1541     ckParamPtr = calloc(1, sizeof(CK_RSA_PKCS_OAEP_PARAMS));</span>
<span class="line-modified">1542     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1543         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1544         return NULL;</span>
<span class="line-modified">1545     }</span>
<span class="line-modified">1546 </span>
<span class="line-added">1547     // populate using java values</span>
<span class="line-added">1548     ckParamPtr-&gt;hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-added">1549     ckParamPtr-&gt;mgf = jLongToCKULong(jMgf);</span>
<span class="line-added">1550     ckParamPtr-&gt;source = jLongToCKULong(jSource);</span>
<span class="line-added">1551     jByteArrayToCKByteArray(env, jSourceData, (CK_BYTE_PTR*) &amp;(ckParamPtr-&gt;pSourceData),</span>
<span class="line-added">1552             &amp;(ckParamPtr-&gt;ulSourceDataLen));</span>
<span class="line-added">1553     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1554         free(ckParamPtr);</span>
<span class="line-added">1555         return NULL;</span>
<span class="line-added">1556     }</span>
1557 
<a name="201" id="anc201"></a><span class="line-modified">1558     if (pLength!= NULL) {</span>
<span class="line-added">1559         *pLength = sizeof(CK_RSA_PKCS_OAEP_PARAMS);</span>
<span class="line-added">1560     }</span>
<span class="line-added">1561     return ckParamPtr;</span>
1562 }
1563 
1564 /*
<a name="202" id="anc202"></a><span class="line-modified">1565  * converts the Java CK_PBE_PARAMS object to a CK_PBE_PARAMS pointer</span>
1566  *
1567  * @param env - used to call JNI funktions to get the Java classes and objects
1568  * @param jParam - the Java CK_PBE_PARAMS object to convert
<a name="203" id="anc203"></a><span class="line-modified">1569  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1570  * @return pointer to the new CK_PBE_PARAMS structure</span>
1571  */
<a name="204" id="anc204"></a><span class="line-modified">1572 CK_PBE_PARAMS_PTR</span>
<span class="line-added">1573 jPbeParamToCKPbeParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1574 {
<a name="205" id="anc205"></a><span class="line-added">1575     CK_PBE_PARAMS_PTR ckParamPtr;</span>
1576     jclass jPbeParamsClass;
<a name="206" id="anc206"></a>
1577     jfieldID fieldID;
1578     jlong jIteration;
1579     jobject jInitVector, jPassword, jSalt;
1580     CK_ULONG ckTemp;
<a name="207" id="anc207"></a>
1581 
<a name="208" id="anc208"></a><span class="line-modified">1582     if (pLength != NULL) {</span>
<span class="line-added">1583         *pLength = 0;</span>
<span class="line-added">1584     }</span>
<span class="line-added">1585 </span>
<span class="line-added">1586     // retrieve java values</span>
1587     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
<a name="209" id="anc209"></a><span class="line-modified">1588     if (jPbeParamsClass == NULL) { return NULL; }</span>
1589     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVector&quot;, &quot;[C&quot;);
<a name="210" id="anc210"></a><span class="line-modified">1590     if (fieldID == NULL) { return NULL; }</span>
1591     jInitVector = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="211" id="anc211"></a>

1592     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pPassword&quot;, &quot;[C&quot;);
<a name="212" id="anc212"></a><span class="line-modified">1593     if (fieldID == NULL) { return NULL; }</span>
1594     jPassword = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="213" id="anc213"></a>

1595     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pSalt&quot;, &quot;[C&quot;);
<a name="214" id="anc214"></a><span class="line-modified">1596     if (fieldID == NULL) { return NULL; }</span>
1597     jSalt = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="215" id="anc215"></a>

1598     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;ulIteration&quot;, &quot;J&quot;);
<a name="216" id="anc216"></a><span class="line-modified">1599     if (fieldID == NULL) { return NULL; }</span>
1600     jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
1601 
<a name="217" id="anc217"></a><span class="line-modified">1602     // allocate memory for CK_PBE_PARAMS pointer</span>
<span class="line-modified">1603     ckParamPtr = calloc(1, sizeof(CK_PBE_PARAMS));</span>
<span class="line-modified">1604     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1605         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1606         return NULL;</span>
<span class="line-added">1607     }</span>
<span class="line-added">1608 </span>
<span class="line-added">1609     // populate using java values</span>
<span class="line-added">1610     ckParamPtr-&gt;ulIteration = jLongToCKULong(jIteration);</span>
<span class="line-added">1611     jCharArrayToCKCharArray(env, jInitVector, &amp;(ckParamPtr-&gt;pInitVector), &amp;ckTemp);</span>
<span class="line-added">1612     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1613         goto cleanup;</span>
<span class="line-added">1614     }</span>
<span class="line-added">1615     jCharArrayToCKCharArray(env, jPassword, &amp;(ckParamPtr-&gt;pPassword), &amp;(ckParamPtr-&gt;ulPasswordLen));</span>
1616     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="218" id="anc218"></a><span class="line-modified">1617         goto cleanup;</span>

1618     }
<a name="219" id="anc219"></a><span class="line-modified">1619     jCharArrayToCKCharArray(env, jSalt, &amp;(ckParamPtr-&gt;pSalt), &amp;(ckParamPtr-&gt;ulSaltLen));</span>
1620     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="220" id="anc220"></a><span class="line-modified">1621         goto cleanup;</span>


1622     }
1623 
<a name="221" id="anc221"></a><span class="line-modified">1624     if (pLength != NULL) {</span>
<span class="line-added">1625         *pLength = sizeof(CK_PBE_PARAMS);</span>
<span class="line-added">1626     }</span>
<span class="line-added">1627     return ckParamPtr;</span>
<span class="line-added">1628 cleanup:</span>
<span class="line-added">1629     free(ckParamPtr-&gt;pInitVector);</span>
<span class="line-added">1630     free(ckParamPtr-&gt;pPassword);</span>
<span class="line-added">1631     free(ckParamPtr-&gt;pSalt);</span>
<span class="line-added">1632     free(ckParamPtr);</span>
<span class="line-added">1633     return NULL;</span>
1634 }
1635 
1636 /*
1637  * Copy back the initialization vector from the native structure to the
1638  * Java object. This is only used for CKM_PBE_* mechanisms and their
1639  * CK_PBE_PARAMS parameters.
1640  *
1641  */
1642 void copyBackPBEInitializationVector(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism)
1643 {
1644     jclass jMechanismClass, jPbeParamsClass;
1645     CK_PBE_PARAMS *ckParam;
1646     jfieldID fieldID;
1647     CK_MECHANISM_TYPE ckMechanismType;
1648     jlong jMechanismType;
1649     jobject jParameter;
1650     jobject jInitVector;
1651     jint jInitVectorLength;
1652     CK_CHAR_PTR initVector;
1653     int i;
1654     jchar* jInitVectorChars;
1655 
1656     /* get mechanism */
1657     jMechanismClass = (*env)-&gt;FindClass(env, CLASS_MECHANISM);
1658     if (jMechanismClass == NULL) { return; }
1659     fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;mechanism&quot;, &quot;J&quot;);
1660     if (fieldID == NULL) { return; }
1661     jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, fieldID);
1662     ckMechanismType = jLongToCKULong(jMechanismType);
1663     if (ckMechanismType != ckMechanism-&gt;mechanism) {
<a name="222" id="anc222"></a><span class="line-modified">1664         /* we do not have matching types, this should not occur */</span>
1665         return;
1666     }
1667 
1668     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
1669     if (jPbeParamsClass == NULL) { return; }
1670     ckParam = (CK_PBE_PARAMS *) ckMechanism-&gt;pParameter;
1671     if (ckParam != NULL_PTR) {
1672         initVector = ckParam-&gt;pInitVector;
1673         if (initVector != NULL_PTR) {
1674             /* get pParameter */
1675             fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;pParameter&quot;, &quot;Ljava/lang/Object;&quot;);
1676             if (fieldID == NULL) { return; }
1677             jParameter = (*env)-&gt;GetObjectField(env, jMechanism, fieldID);
1678             fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVektor&quot;, &quot;[C&quot;);
1679             if (fieldID == NULL) { return; }
1680             jInitVector = (*env)-&gt;GetObjectField(env, jParameter, fieldID);
1681 
1682             if (jInitVector != NULL) {
1683                 jInitVectorLength = (*env)-&gt;GetArrayLength(env, jInitVector);
1684                 jInitVectorChars = (*env)-&gt;GetCharArrayElements(env, jInitVector, NULL);
1685                 if (jInitVectorChars == NULL) { return; }
1686 
1687                 /* copy the chars to the Java buffer */
1688                 for (i=0; i &lt; jInitVectorLength; i++) {
1689                     jInitVectorChars[i] = ckCharToJChar(initVector[i]);
1690                 }
1691                 /* copy back the Java buffer to the object */
1692                 (*env)-&gt;ReleaseCharArrayElements(env, jInitVector, jInitVectorChars, 0);
1693             }
1694         }
1695     }
1696 }
1697 
1698 /*
<a name="223" id="anc223"></a><span class="line-modified">1699  * converts the Java CK_PKCS5_PBKD2_PARAMS object to a CK_PKCS5_PBKD2_PARAMS</span>
<span class="line-added">1700  * pointer</span>
1701  *
1702  * @param env - used to call JNI funktions to get the Java classes and objects
1703  * @param jParam - the Java CK_PKCS5_PBKD2_PARAMS object to convert
<a name="224" id="anc224"></a><span class="line-modified">1704  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1705  * @return pointer to the new CK_PKCS5_PBKD2_PARAMS structure</span>
1706  */
<a name="225" id="anc225"></a><span class="line-modified">1707 CK_PKCS5_PBKD2_PARAMS_PTR</span>
<span class="line-added">1708 jPkcs5Pbkd2ParamToCKPkcs5Pbkd2ParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1709 {
<a name="226" id="anc226"></a><span class="line-added">1710     CK_PKCS5_PBKD2_PARAMS_PTR ckParamPtr;</span>
1711     jclass jPkcs5Pbkd2ParamsClass;
<a name="227" id="anc227"></a>
1712     jfieldID fieldID;
1713     jlong jSaltSource, jIteration, jPrf;
1714     jobject jSaltSourceData, jPrfData;
<a name="228" id="anc228"></a>
1715 
<a name="229" id="anc229"></a><span class="line-modified">1716     if (pLength != NULL) {</span>
<span class="line-added">1717         *pLength = 0L;</span>
<span class="line-added">1718     }</span>
<span class="line-added">1719 </span>
<span class="line-added">1720     // retrieve java values</span>
1721     jPkcs5Pbkd2ParamsClass = (*env)-&gt;FindClass(env, CLASS_PKCS5_PBKD2_PARAMS);
<a name="230" id="anc230"></a><span class="line-modified">1722     if (jPkcs5Pbkd2ParamsClass == NULL) { return NULL; }</span>
1723     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;saltSource&quot;, &quot;J&quot;);
<a name="231" id="anc231"></a><span class="line-modified">1724     if (fieldID == NULL) { return NULL; }</span>
1725     jSaltSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="232" id="anc232"></a>

1726     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pSaltSourceData&quot;, &quot;[B&quot;);
<a name="233" id="anc233"></a><span class="line-modified">1727     if (fieldID == NULL) { return NULL; }</span>
1728     jSaltSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="234" id="anc234"></a>

1729     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;iterations&quot;, &quot;J&quot;);
<a name="235" id="anc235"></a><span class="line-modified">1730     if (fieldID == NULL) { return NULL; }</span>
1731     jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="236" id="anc236"></a>

1732     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;prf&quot;, &quot;J&quot;);
<a name="237" id="anc237"></a><span class="line-modified">1733     if (fieldID == NULL) { return NULL; }</span>
1734     jPrf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="238" id="anc238"></a>

1735     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pPrfData&quot;, &quot;[B&quot;);
<a name="239" id="anc239"></a><span class="line-modified">1736     if (fieldID == NULL) { return NULL; }</span>
1737     jPrfData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1738 
<a name="240" id="anc240"></a><span class="line-modified">1739     // allocate memory for CK_PKCS5_PBKD2_PARAMS pointer</span>
<span class="line-modified">1740     ckParamPtr = calloc(1, sizeof(CK_PKCS5_PBKD2_PARAMS));</span>
<span class="line-modified">1741     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1742         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1743         return NULL;</span>
<span class="line-modified">1744     }</span>
<span class="line-modified">1745 </span>
<span class="line-added">1746     // populate using java values</span>
<span class="line-added">1747     ckParamPtr-&gt;saltSource = jLongToCKULong(jSaltSource);</span>
<span class="line-added">1748     jByteArrayToCKByteArray(env, jSaltSourceData, (CK_BYTE_PTR *)</span>
<span class="line-added">1749             &amp;(ckParamPtr-&gt;pSaltSourceData), &amp;(ckParamPtr-&gt;ulSaltSourceDataLen));</span>
1750     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="241" id="anc241"></a><span class="line-modified">1751         goto cleanup;</span>
<span class="line-modified">1752     }</span>
<span class="line-added">1753     ckParamPtr-&gt;iterations = jLongToCKULong(jIteration);</span>
<span class="line-added">1754     ckParamPtr-&gt;prf = jLongToCKULong(jPrf);</span>
<span class="line-added">1755     jByteArrayToCKByteArray(env, jPrfData, (CK_BYTE_PTR *)</span>
<span class="line-added">1756             &amp;(ckParamPtr-&gt;pPrfData), &amp;(ckParamPtr-&gt;ulPrfDataLen));</span>
<span class="line-added">1757     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1758         goto cleanup;</span>
<span class="line-added">1759     }</span>
<span class="line-added">1760 </span>
<span class="line-added">1761     if (pLength != NULL) {</span>
<span class="line-added">1762         *pLength = sizeof(CK_PKCS5_PBKD2_PARAMS);</span>
1763     }
<a name="242" id="anc242"></a><span class="line-added">1764     return ckParamPtr;</span>
<span class="line-added">1765 cleanup:</span>
<span class="line-added">1766     free(ckParamPtr-&gt;pSaltSourceData);</span>
<span class="line-added">1767     free(ckParamPtr-&gt;pPrfData);</span>
<span class="line-added">1768     free(ckParamPtr);</span>
<span class="line-added">1769     return NULL;</span>
1770 
<a name="243" id="anc243"></a>
1771 }
1772 
1773 /*
<a name="244" id="anc244"></a><span class="line-modified">1774  * converts the Java CK_RSA_PKCS_PSS_PARAMS object to a CK_RSA_PKCS_PSS_PARAMS</span>
<span class="line-added">1775  * pointer</span>
1776  *
1777  * @param env - used to call JNI funktions to get the Java classes and objects
1778  * @param jParam - the Java CK_RSA_PKCS_PSS_PARAMS object to convert
<a name="245" id="anc245"></a><span class="line-modified">1779  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1780  * @return pointer to the new CK_RSA_PKCS_PSS_PARAMS structure</span>
1781  */
<a name="246" id="anc246"></a><span class="line-modified">1782 CK_RSA_PKCS_PSS_PARAMS_PTR</span>
<span class="line-added">1783 jRsaPkcsPssParamToCKRsaPkcsPssParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1784 {
<a name="247" id="anc247"></a><span class="line-added">1785     CK_RSA_PKCS_PSS_PARAMS_PTR ckParamPtr;</span>
1786     jclass jRsaPkcsPssParamsClass;
<a name="248" id="anc248"></a>
1787     jfieldID fieldID;
1788     jlong jHashAlg, jMgf, jSLen;
<a name="249" id="anc249"></a>
1789 
<a name="250" id="anc250"></a><span class="line-modified">1790     if (pLength != NULL) {</span>
<span class="line-added">1791         *pLength = 0;</span>
<span class="line-added">1792     }</span>
<span class="line-added">1793 </span>
<span class="line-added">1794     // retrieve java values</span>
1795     jRsaPkcsPssParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_PSS_PARAMS);
<a name="251" id="anc251"></a><span class="line-modified">1796     if (jRsaPkcsPssParamsClass == NULL) { return NULL; }</span>
1797     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<a name="252" id="anc252"></a><span class="line-modified">1798     if (fieldID == NULL) { return NULL; }</span>
1799     jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="253" id="anc253"></a>

1800     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<a name="254" id="anc254"></a><span class="line-modified">1801     if (fieldID == NULL) { return NULL; }</span>
1802     jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="255" id="anc255"></a>

1803     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;sLen&quot;, &quot;J&quot;);
<a name="256" id="anc256"></a><span class="line-modified">1804     if (fieldID == NULL) { return NULL; }</span>
1805     jSLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
1806 
<a name="257" id="anc257"></a><span class="line-modified">1807     // allocate memory for CK_RSA_PKCS_PSS_PARAMS pointer</span>
<span class="line-modified">1808     ckParamPtr = calloc(1, sizeof(CK_RSA_PKCS_PSS_PARAMS));</span>
<span class="line-modified">1809     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1810         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">1811         return NULL;</span>
<span class="line-added">1812     }</span>
<span class="line-added">1813 </span>
<span class="line-added">1814     // populate using java values</span>
<span class="line-added">1815     ckParamPtr-&gt;hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-added">1816     ckParamPtr-&gt;mgf = jLongToCKULong(jMgf);</span>
<span class="line-added">1817     ckParamPtr-&gt;sLen = jLongToCKULong(jSLen);</span>
<span class="line-added">1818     TRACE1(&quot;DEBUG: jRsaPkcsPssParamToCKRsaPkcsPssParam, hashAlg=0x%lX\n&quot;, ckParamPtr-&gt;hashAlg);</span>
<span class="line-added">1819     TRACE1(&quot;DEBUG: jRsaPkcsPssParamToCKRsaPkcsPssParam, mgf=0x%lX\n&quot;, ckParamPtr-&gt;mgf);</span>
<span class="line-added">1820     TRACE1(&quot;DEBUG: jRsaPkcsPssParamToCKRsaPkcsPssParam, sLen=%lu\n&quot;, ckParamPtr-&gt;sLen);</span>
<span class="line-added">1821 </span>
<span class="line-added">1822     if (pLength != NULL) {</span>
<span class="line-added">1823         *pLength = sizeof(CK_RSA_PKCS_PSS_PARAMS);</span>
<span class="line-added">1824     }</span>
<span class="line-added">1825     return ckParamPtr;</span>
1826 
<a name="258" id="anc258"></a>
1827 }
1828 
1829 /*
<a name="259" id="anc259"></a><span class="line-modified">1830  * converts the Java CK_ECDH1_DERIVE_PARAMS object to a CK_ECDH1_DERIVE_PARAMS</span>
<span class="line-added">1831  * pointer</span>
1832  *
1833  * @param env - used to call JNI funktions to get the Java classes and objects
1834  * @param jParam - the Java CK_ECDH1_DERIVE_PARAMS object to convert
<a name="260" id="anc260"></a><span class="line-modified">1835  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1836  * @retur pointer to nthe new CK_ECDH1_DERIVE_PARAMS structure</span>
1837  */
<a name="261" id="anc261"></a><span class="line-modified">1838 CK_ECDH1_DERIVE_PARAMS_PTR</span>
<span class="line-added">1839 jEcdh1DeriveParamToCKEcdh1DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1840 {
<a name="262" id="anc262"></a><span class="line-added">1841     CK_ECDH1_DERIVE_PARAMS_PTR ckParamPtr;</span>
1842     jclass jEcdh1DeriveParamsClass;
<a name="263" id="anc263"></a>
1843     jfieldID fieldID;
1844     jlong jLong;
1845     jobject jSharedData, jPublicData;
<a name="264" id="anc264"></a>
1846 
<a name="265" id="anc265"></a><span class="line-modified">1847     if (pLength != NULL) {</span>
<span class="line-added">1848         *pLength = 0;</span>
<span class="line-added">1849     }</span>
<span class="line-added">1850 </span>
<span class="line-added">1851     // retrieve java values</span>
1852     jEcdh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH1_DERIVE_PARAMS);
<a name="266" id="anc266"></a><span class="line-modified">1853     if (jEcdh1DeriveParamsClass == NULL) { return NULL; }</span>
1854     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<a name="267" id="anc267"></a><span class="line-modified">1855     if (fieldID == NULL) { return NULL; }</span>
1856     jLong = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="268" id="anc268"></a>


1857     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<a name="269" id="anc269"></a><span class="line-modified">1858     if (fieldID == NULL) { return NULL; }</span>
1859     jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="270" id="anc270"></a>

1860     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<a name="271" id="anc271"></a><span class="line-modified">1861     if (fieldID == NULL) { return NULL; }</span>
1862     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1863 
<a name="272" id="anc272"></a><span class="line-modified">1864     // allocate memory for CK_ECDH1_DERIVE_PARAMS pointer</span>
<span class="line-modified">1865     ckParamPtr = calloc(1, sizeof(CK_ECDH1_DERIVE_PARAMS));</span>
<span class="line-modified">1866     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1867         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1868         return NULL;</span>
<span class="line-added">1869     }</span>
<span class="line-added">1870 </span>
<span class="line-added">1871     // populate using java values</span>
<span class="line-added">1872     ckParamPtr-&gt;kdf = jLongToCKULong(jLong);</span>
<span class="line-added">1873     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParamPtr-&gt;pSharedData),</span>
<span class="line-added">1874             &amp;(ckParamPtr-&gt;ulSharedDataLen));</span>
<span class="line-added">1875     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1876         goto cleanup;</span>
<span class="line-added">1877     }</span>
<span class="line-added">1878     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-added">1879             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>
1880     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="273" id="anc273"></a><span class="line-modified">1881         goto cleanup;</span>

1882     }
1883 
<a name="274" id="anc274"></a><span class="line-modified">1884     if (pLength != NULL) {</span>
<span class="line-added">1885         *pLength = sizeof(CK_ECDH1_DERIVE_PARAMS);</span>
<span class="line-added">1886     }</span>
<span class="line-added">1887     return ckParamPtr;</span>
<span class="line-added">1888 cleanup:</span>
<span class="line-added">1889     free(ckParamPtr-&gt;pSharedData);</span>
<span class="line-added">1890     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">1891     free(ckParamPtr);</span>
<span class="line-added">1892     return NULL;</span>
1893 }
1894 
1895 /*
<a name="275" id="anc275"></a><span class="line-modified">1896  * converts the Java CK_ECDH2_DERIVE_PARAMS object to a CK_ECDH2_DERIVE_PARAMS</span>
<span class="line-added">1897  * pointer</span>
1898  *
1899  * @param env - used to call JNI funktions to get the Java classes and objects
1900  * @param jParam - the Java CK_ECDH2_DERIVE_PARAMS object to convert
<a name="276" id="anc276"></a><span class="line-modified">1901  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1902  * @return pointer to the new CK_ECDH2_DERIVE_PARAMS structure</span>
1903  */
<a name="277" id="anc277"></a><span class="line-modified">1904 CK_ECDH2_DERIVE_PARAMS_PTR</span>
<span class="line-added">1905 jEcdh2DeriveParamToCKEcdh2DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1906 {
<a name="278" id="anc278"></a><span class="line-added">1907     CK_ECDH2_DERIVE_PARAMS_PTR ckParamPtr;</span>
1908     jclass jEcdh2DeriveParamsClass;
<a name="279" id="anc279"></a>
1909     jfieldID fieldID;
1910     jlong jKdf, jPrivateDataLen, jPrivateData;
1911     jobject jSharedData, jPublicData, jPublicData2;
<a name="280" id="anc280"></a>
1912 
<a name="281" id="anc281"></a><span class="line-modified">1913     // retrieve java values</span>
1914     jEcdh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH2_DERIVE_PARAMS);
<a name="282" id="anc282"></a><span class="line-modified">1915     if (jEcdh2DeriveParamsClass == NULL) { return NULL; }</span>
1916     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<a name="283" id="anc283"></a><span class="line-modified">1917     if (fieldID == NULL) { return NULL; }</span>
1918     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="284" id="anc284"></a>

1919     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<a name="285" id="anc285"></a><span class="line-modified">1920     if (fieldID == NULL) { return NULL; }</span>
1921     jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="286" id="anc286"></a>

1922     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<a name="287" id="anc287"></a><span class="line-modified">1923     if (fieldID == NULL) { return NULL; }</span>
1924     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="288" id="anc288"></a>

1925     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<a name="289" id="anc289"></a><span class="line-modified">1926     if (fieldID == NULL) { return NULL; }</span>
1927     jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="290" id="anc290"></a>

1928     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<a name="291" id="anc291"></a><span class="line-modified">1929     if (fieldID == NULL) { return NULL; }</span>
1930     jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="292" id="anc292"></a>

1931     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<a name="293" id="anc293"></a><span class="line-modified">1932     if (fieldID == NULL) { return NULL; }</span>
1933     jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1934 
<a name="294" id="anc294"></a><span class="line-modified">1935     // allocate memory for CK_ECDH2_DERIVE_PARAMS pointer</span>
<span class="line-modified">1936     ckParamPtr = calloc(1, sizeof(CK_ECDH2_DERIVE_PARAMS));</span>
<span class="line-modified">1937     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1938         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1939         return NULL;</span>
<span class="line-added">1940     }</span>
<span class="line-added">1941 </span>
<span class="line-added">1942     // populate using java values</span>
<span class="line-added">1943     ckParamPtr-&gt;kdf = jLongToCKULong(jKdf);</span>
<span class="line-added">1944     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParamPtr-&gt;pSharedData),</span>
<span class="line-added">1945             &amp;(ckParamPtr-&gt;ulSharedDataLen));</span>
1946     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="295" id="anc295"></a><span class="line-modified">1947         goto cleanup;</span>

1948     }
<a name="296" id="anc296"></a><span class="line-modified">1949     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-modified">1950             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>

1951     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="297" id="anc297"></a><span class="line-modified">1952         goto cleanup;</span>


1953     }
<a name="298" id="anc298"></a><span class="line-modified">1954     ckParamPtr-&gt;ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-added">1955     ckParamPtr-&gt;hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-added">1956     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParamPtr-&gt;pPublicData2),</span>
<span class="line-added">1957             &amp;(ckParamPtr-&gt;ulPublicDataLen2));</span>
<span class="line-added">1958     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1959         goto cleanup;</span>
<span class="line-added">1960     }</span>
<span class="line-added">1961 </span>
<span class="line-added">1962     if (pLength != NULL) {</span>
<span class="line-added">1963         *pLength = sizeof(CK_ECDH2_DERIVE_PARAMS);</span>
<span class="line-added">1964     }</span>
<span class="line-added">1965     return ckParamPtr;</span>
<span class="line-added">1966 cleanup:</span>
<span class="line-added">1967     free(ckParamPtr-&gt;pSharedData);</span>
<span class="line-added">1968     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">1969     free(ckParamPtr-&gt;pPublicData2);</span>
<span class="line-added">1970     free(ckParamPtr);</span>
<span class="line-added">1971     return NULL;</span>
1972 }
1973 
1974 /*
<a name="299" id="anc299"></a><span class="line-modified">1975  * converts the Java CK_X9_42_DH1_DERIVE_PARAMS object to a</span>
<span class="line-added">1976  * CK_X9_42_DH1_DERIVE_PARAMS pointer</span>
1977  *
1978  * @param env - used to call JNI funktions to get the Java classes and objects
1979  * @param jParam - the Java CK_X9_42_DH1_DERIVE_PARAMS object to convert
<a name="300" id="anc300"></a><span class="line-modified">1980  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1981  * @return pointer to the new CK_X9_42_DH1_DERIVE_PARAMS structure</span>
1982  */
<a name="301" id="anc301"></a><span class="line-modified">1983 CK_X9_42_DH1_DERIVE_PARAMS_PTR</span>
<span class="line-added">1984 jX942Dh1DeriveParamToCKX942Dh1DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1985 {
<a name="302" id="anc302"></a><span class="line-added">1986     CK_X9_42_DH1_DERIVE_PARAMS_PTR ckParamPtr;</span>
1987     jclass jX942Dh1DeriveParamsClass;
<a name="303" id="anc303"></a>
1988     jfieldID fieldID;
1989     jlong jKdf;
1990     jobject jOtherInfo, jPublicData;
<a name="304" id="anc304"></a>
1991 
<a name="305" id="anc305"></a><span class="line-modified">1992     if (pLength != NULL) {</span>
<span class="line-added">1993         *pLength = 0;</span>
<span class="line-added">1994     }</span>
<span class="line-added">1995 </span>
<span class="line-added">1996     // retrieve java values</span>
1997     jX942Dh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH1_DERIVE_PARAMS);
<a name="306" id="anc306"></a><span class="line-modified">1998     if (jX942Dh1DeriveParamsClass == NULL) { return NULL; }</span>
1999     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<a name="307" id="anc307"></a><span class="line-modified">2000     if (fieldID == NULL) { return NULL; }</span>
2001     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="308" id="anc308"></a>

2002     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<a name="309" id="anc309"></a><span class="line-modified">2003     if (fieldID == NULL) { return NULL; }</span>
2004     jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="310" id="anc310"></a>

2005     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<a name="311" id="anc311"></a><span class="line-modified">2006     if (fieldID == NULL) { return NULL; }</span>
2007     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
2008 
<a name="312" id="anc312"></a><span class="line-modified">2009     // allocate memory for CK_X9_42_DH1_DERIVE_PARAMS pointer</span>
<span class="line-modified">2010     ckParamPtr = calloc(1, sizeof(CK_X9_42_DH1_DERIVE_PARAMS));</span>
<span class="line-modified">2011     if (ckParamPtr == NULL) {</span>
<span class="line-modified">2012         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">2013         return NULL;</span>
<span class="line-added">2014     }</span>
<span class="line-added">2015 </span>
<span class="line-added">2016     // populate using java values</span>
<span class="line-added">2017     ckParamPtr-&gt;kdf = jLongToCKULong(jKdf);</span>
<span class="line-added">2018     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParamPtr-&gt;pOtherInfo),</span>
<span class="line-added">2019             &amp;(ckParamPtr-&gt;ulOtherInfoLen));</span>
2020     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="313" id="anc313"></a><span class="line-modified">2021         goto cleanup;</span>
<span class="line-modified">2022     }</span>
<span class="line-added">2023     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-added">2024             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>
<span class="line-added">2025     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">2026         goto cleanup;</span>
2027     }
2028 
<a name="314" id="anc314"></a><span class="line-modified">2029     if (pLength != NULL) {</span>
<span class="line-added">2030         *pLength = sizeof(CK_X9_42_DH1_DERIVE_PARAMS);</span>
<span class="line-added">2031     }</span>
<span class="line-added">2032     return ckParamPtr;</span>
<span class="line-added">2033 cleanup:</span>
<span class="line-added">2034     free(ckParamPtr-&gt;pOtherInfo);</span>
<span class="line-added">2035     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">2036     free(ckParamPtr);</span>
<span class="line-added">2037     return NULL;</span>
2038 }
2039 
2040 /*
<a name="315" id="anc315"></a><span class="line-modified">2041  * converts the Java CK_X9_42_DH2_DERIVE_PARAMS object to a</span>
<span class="line-added">2042  * CK_X9_42_DH2_DERIVE_PARAMS pointer</span>
2043  *
2044  * @param env - used to call JNI funktions to get the Java classes and objects
2045  * @param jParam - the Java CK_X9_42_DH2_DERIVE_PARAMS object to convert
<a name="316" id="anc316"></a><span class="line-modified">2046  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">2047  * @return pointer to the new CK_X9_42_DH2_DERIVE_PARAMS structure</span>
2048  */
<a name="317" id="anc317"></a><span class="line-modified">2049 CK_X9_42_DH2_DERIVE_PARAMS_PTR</span>
<span class="line-added">2050 jX942Dh2DeriveParamToCKX942Dh2DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
2051 {
<a name="318" id="anc318"></a><span class="line-added">2052     CK_X9_42_DH2_DERIVE_PARAMS_PTR ckParamPtr;</span>
2053     jclass jX942Dh2DeriveParamsClass;
<a name="319" id="anc319"></a>
2054     jfieldID fieldID;
2055     jlong jKdf, jPrivateDataLen, jPrivateData;
2056     jobject jOtherInfo, jPublicData, jPublicData2;
<a name="320" id="anc320"></a>
2057 
<a name="321" id="anc321"></a><span class="line-modified">2058     if (pLength != NULL) {</span>
<span class="line-added">2059         *pLength = 0L;</span>
<span class="line-added">2060     }</span>
<span class="line-added">2061 </span>
<span class="line-added">2062     // retrieve java values</span>
2063     jX942Dh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH2_DERIVE_PARAMS);
<a name="322" id="anc322"></a><span class="line-modified">2064     if (jX942Dh2DeriveParamsClass == NULL) { return NULL; }</span>
2065     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<a name="323" id="anc323"></a><span class="line-modified">2066     if (fieldID == NULL) { return NULL; }</span>
2067     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="324" id="anc324"></a>

2068     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<a name="325" id="anc325"></a><span class="line-modified">2069     if (fieldID == NULL) { return NULL; }</span>
2070     jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="326" id="anc326"></a>

2071     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<a name="327" id="anc327"></a><span class="line-modified">2072     if (fieldID == NULL) { return NULL; }</span>
2073     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<a name="328" id="anc328"></a>

2074     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<a name="329" id="anc329"></a><span class="line-modified">2075     if (fieldID == NULL) { return NULL; }</span>
2076     jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="330" id="anc330"></a>

2077     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<a name="331" id="anc331"></a><span class="line-modified">2078     if (fieldID == NULL) { return NULL; }</span>
2079     jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
<a name="332" id="anc332"></a>

2080     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<a name="333" id="anc333"></a><span class="line-modified">2081     if (fieldID == NULL) { return NULL; }</span>
2082     jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
2083 
<a name="334" id="anc334"></a><span class="line-modified">2084     // allocate memory for CK_DATE pointer</span>
<span class="line-modified">2085     ckParamPtr = calloc(1, sizeof(CK_X9_42_DH2_DERIVE_PARAMS));</span>
<span class="line-modified">2086     if (ckParamPtr == NULL) {</span>
<span class="line-modified">2087         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">2088         return NULL;</span>
<span class="line-added">2089     }</span>
<span class="line-added">2090 </span>
<span class="line-added">2091     // populate using java values</span>
<span class="line-added">2092     ckParamPtr-&gt;kdf = jLongToCKULong(jKdf);</span>
<span class="line-added">2093     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParamPtr-&gt;pOtherInfo),</span>
<span class="line-added">2094             &amp;(ckParamPtr-&gt;ulOtherInfoLen));</span>
2095     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="335" id="anc335"></a><span class="line-modified">2096         goto cleanup;</span>

2097     }
<a name="336" id="anc336"></a><span class="line-modified">2098     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-modified">2099             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>

2100     if ((*env)-&gt;ExceptionCheck(env)) {
<a name="337" id="anc337"></a><span class="line-modified">2101         goto cleanup;</span>
<span class="line-modified">2102     }</span>
<span class="line-modified">2103     ckParamPtr-&gt;ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-added">2104     ckParamPtr-&gt;hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-added">2105     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParamPtr-&gt;pPublicData2),</span>
<span class="line-added">2106             &amp;(ckParamPtr-&gt;ulPublicDataLen2));</span>
<span class="line-added">2107     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">2108         goto cleanup;</span>
2109     }
2110 
<a name="338" id="anc338"></a><span class="line-modified">2111     if (pLength != NULL) {</span>
<span class="line-added">2112         *pLength = sizeof(CK_X9_42_DH2_DERIVE_PARAMS);</span>
<span class="line-added">2113     }</span>
<span class="line-added">2114     return ckParamPtr;</span>
<span class="line-added">2115 cleanup:</span>
<span class="line-added">2116     free(ckParamPtr-&gt;pOtherInfo);</span>
<span class="line-added">2117     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">2118     free(ckParamPtr-&gt;pPublicData2);</span>
<span class="line-added">2119     free(ckParamPtr);</span>
<span class="line-added">2120     return NULL;</span>
2121 }
<a name="339" id="anc339"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="339" type="hidden" />
</body>
</html>