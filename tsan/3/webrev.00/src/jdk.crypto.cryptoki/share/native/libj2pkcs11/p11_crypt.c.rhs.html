<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_crypt.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
 23  *    Alternately, this acknowledgment may appear in the software itself, if
 24  *    and wherever such third-party acknowledgments normally appear.
 25  *
 26  * 4. The names &quot;Graz University of Technology&quot; and &quot;IAIK of Graz University of
 27  *    Technology&quot; must not be used to endorse or promote products derived from
 28  *    this software without prior written permission.
 29  *
 30  * 5. Products derived from this software may not be called
 31  *    &quot;IAIK PKCS Wrapper&quot;, nor may &quot;IAIK&quot; appear in their name, without prior
 32  *    written permission of Graz University of Technology.
 33  *
 34  *  THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY EXPRESSED OR IMPLIED
 35  *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 36  *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 37  *  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE LICENSOR BE
 38  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
 39  *  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 40  *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
 41  *  OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 42  *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 43  *  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 44  *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 45  *  POSSIBILITY  OF SUCH DAMAGE.
 46  * ===========================================================================
 47  */
 48 
 49 #include &quot;pkcs11wrapper.h&quot;
 50 
 51 #include &lt;stdio.h&gt;
 52 #include &lt;stdlib.h&gt;
 53 #include &lt;string.h&gt;
 54 #include &lt;assert.h&gt;
 55 
 56 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
 57 
 58 #ifdef P11_ENABLE_C_ENCRYPTINIT
 59 /*
 60  * Class:     sun_security_pkcs11_wrapper_PKCS11
 61  * Method:    C_EncryptInit
 62  * Signature: (JLsun/security/pkcs11/wrapper/CK_MECHANISM;J)V
 63  * Parametermapping:                    *PKCS11*
 64  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
 65  * @param   jobject jMechanism          CK_MECHANISM_PTR pMechanism
 66  * @param   jlong jKeyHandle            CK_OBJECT_HANDLE hKey
 67  */
 68 JNIEXPORT void JNICALL
 69 Java_sun_security_pkcs11_wrapper_PKCS11_C_1EncryptInit
 70 (JNIEnv *env, jobject obj, jlong jSessionHandle,
 71  jobject jMechanism, jlong jKeyHandle)
 72 {
 73     CK_SESSION_HANDLE ckSessionHandle;
<a name="2" id="anc2"></a><span class="line-modified"> 74     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
<span class="line-added"> 75     CK_MECHANISM_PTR ckpTemp;</span>
 76     CK_OBJECT_HANDLE ckKeyHandle;
 77     CK_RV rv;
 78 
 79     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
 80     if (ckpFunctions == NULL) { return; }
 81 
 82     ckSessionHandle = jLongToCKULong(jSessionHandle);
 83     ckKeyHandle = jLongToCKULong(jKeyHandle);
<a name="3" id="anc3"></a><span class="line-modified"> 84     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
<span class="line-added"> 85     TRACE1(&quot;DEBUG C_EncryptInit: created pMech = %p\n&quot;,</span>
<span class="line-added"> 86             ckpMechanism);</span>
<span class="line-added"> 87 </span>
 88     if ((*env)-&gt;ExceptionCheck(env)) { return; }
 89 
<a name="4" id="anc4"></a><span class="line-modified"> 90     rv = (*ckpFunctions-&gt;C_EncryptInit)(ckSessionHandle, ckpMechanism,</span>
 91                                         ckKeyHandle);
 92 
<a name="5" id="anc5"></a><span class="line-modified"> 93     if (ckpMechanism-&gt;mechanism == CKM_AES_GCM) {</span>
<span class="line-modified"> 94         if (rv == CKR_ARGUMENTS_BAD || rv == CKR_MECHANISM_PARAM_INVALID) {</span>
<span class="line-added"> 95             // retry with CKM_GCM_PARAMS structure in pkcs11t.h</span>
<span class="line-added"> 96             TRACE0(&quot;DEBUG C_EncryptInit: retry with CK_GCM_PARAMS\n&quot;);</span>
<span class="line-added"> 97             ckpTemp = updateGCMParams(env, ckpMechanism);</span>
<span class="line-added"> 98             if (ckpTemp != NULL) { // only re-call if conversion succeeds</span>
<span class="line-added"> 99                 ckpMechanism = ckpTemp;</span>
<span class="line-added">100                 rv = (*ckpFunctions-&gt;C_EncryptInit)(ckSessionHandle, ckpMechanism,</span>
<span class="line-added">101                         ckKeyHandle);</span>
<span class="line-added">102             }</span>
<span class="line-added">103         }</span>
104     }
105 
<a name="6" id="anc6"></a><span class="line-added">106     TRACE1(&quot;DEBUG C_EncryptInit: freed pMech = %p\n&quot;, ckpMechanism);</span>
<span class="line-added">107     freeCKMechanismPtr(ckpMechanism);</span>
108     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
<a name="7" id="anc7"></a><span class="line-added">109 </span>
<span class="line-added">110     TRACE0(&quot;FINISHED\n&quot;);</span>
111 }
112 #endif
113 
114 #ifdef P11_ENABLE_C_ENCRYPT
115 /*
116  * Class:     sun_security_pkcs11_wrapper_PKCS11
117  * Method:    C_Encrypt
<a name="8" id="anc8"></a><span class="line-modified">118  * Signature: (JJ[BIIJ[BII)I</span>
119  * Parametermapping:                    *PKCS11*
120  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
<a name="9" id="anc9"></a><span class="line-added">121  * @param   jlong directIn              CK_BYTE_PTR pData</span>
122  * @param   jbyteArray jData            CK_BYTE_PTR pData
123  *                                      CK_ULONG ulDataLen
<a name="10" id="anc10"></a><span class="line-modified">124  * @param   jlong directOut             CK_BYTE_PTR pEncryptedData</span>
<span class="line-added">125  * @return  jint encryptedDataLen       CK_BYTE_PTR pEncryptedData</span>
126  *                                      CK_ULONG_PTR pulEncryptedDataLen
127  */
128 JNIEXPORT jint JNICALL
129 Java_sun_security_pkcs11_wrapper_PKCS11_C_1Encrypt
130 (JNIEnv *env, jobject obj, jlong jSessionHandle,
<a name="11" id="anc11"></a><span class="line-modified">131  jlong directIn, jbyteArray jIn, jint jInOfs, jint jInLen,</span>
<span class="line-modified">132  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)</span>
133 {
134     CK_SESSION_HANDLE ckSessionHandle;
135     CK_RV rv;
136 
137     CK_BYTE_PTR inBufP;
138     CK_BYTE_PTR outBufP;
<a name="12" id="anc12"></a><span class="line-modified">139     CK_ULONG ckEncryptedLen = 0;</span>
140 
141     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
142     if (ckpFunctions == NULL) { return 0; }
143 
144     ckSessionHandle = jLongToCKULong(jSessionHandle);
145 
<a name="13" id="anc13"></a><span class="line-modified">146     if (directIn != 0) {</span>
<span class="line-modified">147       inBufP = (CK_BYTE_PTR) jlong_to_ptr(directIn);</span>
<span class="line-added">148     } else {</span>
<span class="line-added">149       inBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jIn, NULL);</span>
<span class="line-added">150       if (inBufP == NULL) { return 0; }</span>
<span class="line-added">151     }</span>
152 
<a name="14" id="anc14"></a><span class="line-modified">153     if (directOut != 0) {</span>
<span class="line-modified">154       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);</span>
<span class="line-modified">155     } else {</span>
<span class="line-modified">156       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);</span>
<span class="line-modified">157       if (outBufP == NULL) {</span>
<span class="line-added">158           goto cleanup;</span>
<span class="line-added">159       }</span>
160     }
161 
<a name="15" id="anc15"></a><span class="line-modified">162     ckEncryptedLen = jOutLen;</span>
163 
164     rv = (*ckpFunctions-&gt;C_Encrypt)(ckSessionHandle,
165                                     (CK_BYTE_PTR)(inBufP + jInOfs), jInLen,
166                                     (CK_BYTE_PTR)(outBufP + jOutOfs),
<a name="16" id="anc16"></a><span class="line-modified">167                                     &amp;ckEncryptedLen);</span>



168 
169     ckAssertReturnValueOK(env, rv);
<a name="17" id="anc17"></a><span class="line-modified">170 </span>
<span class="line-added">171 cleanup:</span>
<span class="line-added">172     if (directIn == 0 &amp;&amp; inBufP != NULL) {</span>
<span class="line-added">173         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);</span>
<span class="line-added">174     }</span>
<span class="line-added">175     if (directOut == 0 &amp;&amp; outBufP != NULL) {</span>
<span class="line-added">176         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);</span>
<span class="line-added">177     }</span>
<span class="line-added">178     return ckEncryptedLen;</span>
179 }
180 #endif
181 
182 #ifdef P11_ENABLE_C_ENCRYPTUPDATE
183 /*
184  * Class:     sun_security_pkcs11_wrapper_PKCS11
185  * Method:    C_EncryptUpdate
186  * Signature: (J[BII[BII)I
187  * Parametermapping:                    *PKCS11*
188  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
189  * @param   jbyteArray jPart            CK_BYTE_PTR pPart
190  *                                      CK_ULONG ulPartLen
191  * @return  jbyteArray jEncryptedPart   CK_BYTE_PTR pEncryptedPart
192  *                                      CK_ULONG_PTR pulEncryptedPartLen
193  */
194 JNIEXPORT jint JNICALL
195 Java_sun_security_pkcs11_wrapper_PKCS11_C_1EncryptUpdate
196 (JNIEnv *env, jobject obj, jlong jSessionHandle,
197  jlong directIn, jbyteArray jIn, jint jInOfs, jint jInLen,
198  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)
199 {
200     CK_SESSION_HANDLE ckSessionHandle;
201     CK_RV rv;
202 
203     CK_BYTE_PTR inBufP;
204     CK_BYTE_PTR outBufP;
<a name="18" id="anc18"></a><span class="line-modified">205     CK_ULONG ckEncryptedPartLen = 0;</span>
206 
207     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
208     if (ckpFunctions == NULL) { return 0; }
209 
210     ckSessionHandle = jLongToCKULong(jSessionHandle);
211 
212     if (directIn != 0) {
213       inBufP = (CK_BYTE_PTR) jlong_to_ptr(directIn);
214     } else {
215       inBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jIn, NULL);
216       if (inBufP == NULL) { return 0; }
217     }
218 
219     if (directOut != 0) {
220       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);
221     } else {
222       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);
223       if (outBufP == NULL) {
<a name="19" id="anc19"></a><span class="line-modified">224           goto cleanup;</span>


225       }
226     }
227 
228     ckEncryptedPartLen = jOutLen;
229 
<a name="20" id="anc20"></a>


230     rv = (*ckpFunctions-&gt;C_EncryptUpdate)(ckSessionHandle,
231                                           (CK_BYTE_PTR)(inBufP + jInOfs), jInLen,
232                                           (CK_BYTE_PTR)(outBufP + jOutOfs),
233                                           &amp;ckEncryptedPartLen);
234 
<a name="21" id="anc21"></a><span class="line-modified">235     ckAssertReturnValueOK(env, rv);</span>
236 
<a name="22" id="anc22"></a><span class="line-modified">237 cleanup:</span>
<span class="line-added">238     if (directIn == 0 &amp;&amp; inBufP != NULL) {</span>
239         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);
240     }
<a name="23" id="anc23"></a><span class="line-modified">241     if (directOut == 0 &amp;&amp; outBufP != NULL) {</span>

242         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);
243     }
<a name="24" id="anc24"></a>


244     return ckEncryptedPartLen;
245 }
246 #endif
247 
248 #ifdef P11_ENABLE_C_ENCRYPTFINAL
249 /*
250  * Class:     sun_security_pkcs11_wrapper_PKCS11
251  * Method:    C_EncryptFinal
252  * Signature: (J[BII)I
253  * Parametermapping:                        *PKCS11*
254  * @param   jlong jSessionHandle            CK_SESSION_HANDLE hSession
255  * @return  jbyteArray jLastEncryptedPart   CK_BYTE_PTR pLastEncryptedDataPart
256  *                                          CK_ULONG_PTR pulLastEncryptedDataPartLen
257  */
258 JNIEXPORT jint JNICALL
259 Java_sun_security_pkcs11_wrapper_PKCS11_C_1EncryptFinal
260 (JNIEnv *env, jobject obj, jlong jSessionHandle,
261  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)
262 {
263     CK_SESSION_HANDLE ckSessionHandle;
264     CK_RV rv;
265     CK_BYTE_PTR outBufP;
266     CK_ULONG ckLastEncryptedPartLen;
267 
268     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
269     if (ckpFunctions == NULL) { return 0; }
270 
271     ckSessionHandle = jLongToCKULong(jSessionHandle);
272 
273     if (directOut != 0) {
274       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);
275     } else {
276       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);
277       if (outBufP == NULL) { return 0; }
278     }
279 
280     ckLastEncryptedPartLen = jOutLen;
281 
<a name="25" id="anc25"></a>

282     rv = (*ckpFunctions-&gt;C_EncryptFinal)(ckSessionHandle,
283                                          (CK_BYTE_PTR)(outBufP + jOutOfs),
284                                          &amp;ckLastEncryptedPartLen);
285 
<a name="26" id="anc26"></a>

286     if (directOut == 0) {
287         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);
288     }
289 
290     ckAssertReturnValueOK(env, rv);
291 
292     return ckLastEncryptedPartLen;
293 }
294 #endif
295 
296 #ifdef P11_ENABLE_C_DECRYPTINIT
297 /*
298  * Class:     sun_security_pkcs11_wrapper_PKCS11
299  * Method:    C_DecryptInit
300  * Signature: (JLsun/security/pkcs11/wrapper/CK_MECHANISM;J)V
301  * Parametermapping:                    *PKCS11*
302  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
303  * @param   jobject jMechanism          CK_MECHANISM_PTR pMechanism
304  * @param   jlong jKeyHandle            CK_OBJECT_HANDLE hKey
305  */
306 JNIEXPORT void JNICALL
307 Java_sun_security_pkcs11_wrapper_PKCS11_C_1DecryptInit
308 (JNIEnv *env, jobject obj, jlong jSessionHandle,
309  jobject jMechanism, jlong jKeyHandle)
310 {
311     CK_SESSION_HANDLE ckSessionHandle;
<a name="27" id="anc27"></a><span class="line-modified">312     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
<span class="line-added">313     CK_MECHANISM_PTR ckpTemp;</span>
314     CK_OBJECT_HANDLE ckKeyHandle;
315     CK_RV rv;
316 
317     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
318     if (ckpFunctions == NULL) { return; }
319 
320     ckSessionHandle = jLongToCKULong(jSessionHandle);
321     ckKeyHandle = jLongToCKULong(jKeyHandle);
<a name="28" id="anc28"></a><span class="line-modified">322     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
<span class="line-added">323     TRACE1(&quot;DEBUG C_DecryptInit: created pMech = %p\n&quot;,</span>
<span class="line-added">324             ckpMechanism);</span>
<span class="line-added">325 </span>
326     if ((*env)-&gt;ExceptionCheck(env)) { return; }
327 
<a name="29" id="anc29"></a><span class="line-modified">328     rv = (*ckpFunctions-&gt;C_DecryptInit)(ckSessionHandle, ckpMechanism,</span>
329                                         ckKeyHandle);
330 
<a name="30" id="anc30"></a><span class="line-modified">331     if (ckpMechanism-&gt;mechanism == CKM_AES_GCM) {</span>
<span class="line-modified">332         if (rv == CKR_ARGUMENTS_BAD || rv == CKR_MECHANISM_PARAM_INVALID) {</span>
<span class="line-added">333             // retry with CKM_GCM_PARAMS structure in pkcs11t.h</span>
<span class="line-added">334             TRACE0(&quot;DEBUG C_DecryptInit: retry with CK_GCM_PARAMS\n&quot;);</span>
<span class="line-added">335             ckpTemp = updateGCMParams(env, ckpMechanism);</span>
<span class="line-added">336             if (ckpTemp != NULL) { // only re-call if conversion succeeds</span>
<span class="line-added">337                 ckpMechanism = ckpTemp;</span>
<span class="line-added">338                 rv = (*ckpFunctions-&gt;C_DecryptInit)(ckSessionHandle, ckpMechanism,</span>
<span class="line-added">339                         ckKeyHandle);</span>
<span class="line-added">340             }</span>
<span class="line-added">341         }</span>
342     }
343 
<a name="31" id="anc31"></a><span class="line-added">344     TRACE1(&quot;DEBUG C_DecryptInit: freed pMech = %p\n&quot;, ckpMechanism);</span>
<span class="line-added">345     freeCKMechanismPtr(ckpMechanism);</span>
346     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
<a name="32" id="anc32"></a><span class="line-added">347 </span>
<span class="line-added">348     TRACE0(&quot;FINISHED\n&quot;);</span>
349 }
350 #endif
351 
352 #ifdef P11_ENABLE_C_DECRYPT
353 /*
354  * Class:     sun_security_pkcs11_wrapper_PKCS11
355  * Method:    C_Decrypt
<a name="33" id="anc33"></a><span class="line-modified">356  * Signature: (JJ[BIIJ[BII)I</span>
357  * Parametermapping:                    *PKCS11*
358  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
359  * @param   jbyteArray jEncryptedData   CK_BYTE_PTR pEncryptedData
360  *                                      CK_ULONG ulEncryptedDataLen
361  * @return  jbyteArray jData            CK_BYTE_PTR pData
362  *                                      CK_ULONG_PTR pulDataLen
363  */
364 JNIEXPORT jint JNICALL
365 Java_sun_security_pkcs11_wrapper_PKCS11_C_1Decrypt
366 (JNIEnv *env, jobject obj, jlong jSessionHandle,
<a name="34" id="anc34"></a><span class="line-modified">367  jlong directIn, jbyteArray jIn, jint jInOfs, jint jInLen,</span>
<span class="line-modified">368  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)</span>
369 {
370     CK_SESSION_HANDLE ckSessionHandle;
371     CK_RV rv;
372 
373     CK_BYTE_PTR inBufP;
374     CK_BYTE_PTR outBufP;
<a name="35" id="anc35"></a><span class="line-modified">375     CK_ULONG ckOutLen = 0;</span>
376 
377     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
378     if (ckpFunctions == NULL) { return 0; }
379 
380     ckSessionHandle = jLongToCKULong(jSessionHandle);
381 
<a name="36" id="anc36"></a><span class="line-modified">382     if (directIn != 0) {</span>
<span class="line-modified">383       inBufP = (CK_BYTE_PTR) jlong_to_ptr(directIn);</span>
<span class="line-modified">384     } else {</span>
<span class="line-modified">385       inBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jIn, NULL);</span>
<span class="line-modified">386       if (inBufP == NULL) { return 0; }</span>



387     }
388 
<a name="37" id="anc37"></a><span class="line-modified">389     if (directOut != 0) {</span>
<span class="line-added">390       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);</span>
<span class="line-added">391     } else {</span>
<span class="line-added">392       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);</span>
<span class="line-added">393       if (outBufP == NULL) {</span>
<span class="line-added">394           goto cleanup;</span>
<span class="line-added">395       }</span>
<span class="line-added">396     }</span>
<span class="line-added">397     ckOutLen = jOutLen;</span>
398 
399     rv = (*ckpFunctions-&gt;C_Decrypt)(ckSessionHandle,
400                                     (CK_BYTE_PTR)(inBufP + jInOfs), jInLen,
401                                     (CK_BYTE_PTR)(outBufP + jOutOfs),
<a name="38" id="anc38"></a><span class="line-modified">402                                     &amp;ckOutLen);</span>



403 
404     ckAssertReturnValueOK(env, rv);
405 
<a name="39" id="anc39"></a><span class="line-modified">406 cleanup:</span>
<span class="line-added">407     if (directIn == 0 &amp;&amp; inBufP != NULL) {</span>
<span class="line-added">408         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);</span>
<span class="line-added">409     }</span>
<span class="line-added">410     if (directOut == 0 &amp;&amp; outBufP != NULL) {</span>
<span class="line-added">411         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);</span>
<span class="line-added">412     }</span>
<span class="line-added">413     return ckOutLen;</span>
414 }
415 #endif
416 
417 #ifdef P11_ENABLE_C_DECRYPTUPDATE
418 /*
419  * Class:     sun_security_pkcs11_wrapper_PKCS11
420  * Method:    C_DecryptUpdate
421  * Signature: (J[BII[BII)I
422  * Parametermapping:                    *PKCS11*
423  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
424  * @param   jbyteArray jEncryptedPart   CK_BYTE_PTR pEncryptedPart
425  *                                      CK_ULONG ulEncryptedPartLen
426  * @return  jbyteArray jPart            CK_BYTE_PTR pPart
427  *                                      CK_ULONG_PTR pulPartLen
428  */
429 JNIEXPORT jint JNICALL
430 Java_sun_security_pkcs11_wrapper_PKCS11_C_1DecryptUpdate
431 (JNIEnv *env, jobject obj, jlong jSessionHandle,
432  jlong directIn, jbyteArray jIn, jint jInOfs, jint jInLen,
433  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)
434 {
435     CK_SESSION_HANDLE ckSessionHandle;
436     CK_RV rv;
437 
438     CK_BYTE_PTR inBufP;
439     CK_BYTE_PTR outBufP;
<a name="40" id="anc40"></a><span class="line-modified">440     CK_ULONG ckDecryptedPartLen = 0;</span>
441 
442     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
443     if (ckpFunctions == NULL) { return 0; }
444 
445     ckSessionHandle = jLongToCKULong(jSessionHandle);
446 
447     if (directIn != 0) {
448       inBufP = (CK_BYTE_PTR) jlong_to_ptr(directIn);
449     } else {
450       inBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jIn, NULL);
451       if (inBufP == NULL) { return 0; }
452     }
453 
454     if (directOut != 0) {
455       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);
456     } else {
457       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);
458       if (outBufP == NULL) {
<a name="41" id="anc41"></a><span class="line-modified">459           goto cleanup;</span>


460       }
461     }
462 
463     ckDecryptedPartLen = jOutLen;
<a name="42" id="anc42"></a>
464     rv = (*ckpFunctions-&gt;C_DecryptUpdate)(ckSessionHandle,
465                                           (CK_BYTE_PTR)(inBufP + jInOfs), jInLen,
466                                           (CK_BYTE_PTR)(outBufP + jOutOfs),
467                                           &amp;ckDecryptedPartLen);
<a name="43" id="anc43"></a><span class="line-modified">468     ckAssertReturnValueOK(env, rv);</span>
<span class="line-added">469 </span>
<span class="line-added">470 cleanup:</span>
<span class="line-added">471     if (directIn == 0 &amp;&amp; inBufP != NULL) {</span>
472         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);
473     }
<a name="44" id="anc44"></a><span class="line-modified">474     if (directOut == 0 &amp;&amp; outBufP != NULL) {</span>

475         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);
476     }
<a name="45" id="anc45"></a>


477     return ckDecryptedPartLen;
478 }
479 
480 #endif
481 
482 #ifdef P11_ENABLE_C_DECRYPTFINAL
483 /*
484  * Class:     sun_security_pkcs11_wrapper_PKCS11
485  * Method:    C_DecryptFinal
486  * Signature: (J[BII)I
487  * Parametermapping:                    *PKCS11*
488  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
489  * @return  jbyteArray jLastPart        CK_BYTE_PTR pLastPart
490  *                                      CK_ULONG_PTR pulLastPartLen
491  */
492 JNIEXPORT jint JNICALL
493 Java_sun_security_pkcs11_wrapper_PKCS11_C_1DecryptFinal
494 (JNIEnv *env, jobject obj, jlong jSessionHandle,
495  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)
496 {
497     CK_SESSION_HANDLE ckSessionHandle;
498     CK_RV rv;
499     CK_BYTE_PTR outBufP;
500     CK_ULONG ckLastPartLen;
501 
502     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
503     if (ckpFunctions == NULL) { return 0; }
504 
505     ckSessionHandle = jLongToCKULong(jSessionHandle);
506 
507     if (directOut != 0) {
508       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);
509     } else {
510       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);
511       if (outBufP == NULL) { return 0; }
512     }
513 
514     ckLastPartLen = jOutLen;
515 
516     rv = (*ckpFunctions-&gt;C_DecryptFinal)(ckSessionHandle,
517                                          (CK_BYTE_PTR)(outBufP + jOutOfs),
518                                          &amp;ckLastPartLen);
519 
520     if (directOut == 0) {
521         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);
522 
523     }
524 
525     ckAssertReturnValueOK(env, rv);
526 
527     return ckLastPartLen;
528 }
529 #endif
<a name="46" id="anc46"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="46" type="hidden" />
</body>
</html>