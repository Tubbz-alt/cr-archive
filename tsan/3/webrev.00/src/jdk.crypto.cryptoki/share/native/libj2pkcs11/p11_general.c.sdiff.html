<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_general.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="p11_digest.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_keymgmt.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_general.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2016, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
 34  *  THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY EXPRESSED OR IMPLIED
 35  *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 36  *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 37  *  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE LICENSOR BE
 38  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
 39  *  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 40  *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
 41  *  OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 42  *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 43  *  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 44  *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 45  *  POSSIBILITY  OF SUCH DAMAGE.
 46  */
 47 
 48 #include &quot;pkcs11wrapper.h&quot;
 49 
 50 #include &lt;stdio.h&gt;
 51 #include &lt;stdlib.h&gt;
 52 #include &lt;string.h&gt;
 53 #include &lt;assert.h&gt;

 54 
 55 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
 56 
 57 /* declare file private functions */
 58 
 59 void prefetchFields(JNIEnv *env, jclass thisClass);
 60 jobject ckInfoPtrToJInfo(JNIEnv *env, const CK_INFO_PTR ckpInfo);
 61 jobject ckSlotInfoPtrToJSlotInfo(JNIEnv *env, const CK_SLOT_INFO_PTR ckpSlotInfo);
 62 jobject ckTokenInfoPtrToJTokenInfo(JNIEnv *env, const CK_TOKEN_INFO_PTR ckpTokenInfo);
 63 jobject ckMechanismInfoPtrToJMechanismInfo(JNIEnv *env, const CK_MECHANISM_INFO_PTR ckpMechanismInfo);
 64 
 65 /* define variables */
 66 
 67 jfieldID pNativeDataID;
 68 jfieldID mech_mechanismID;
 69 jfieldID mech_pParameterID;

 70 
 71 jclass jByteArrayClass;
 72 jclass jLongClass;
 73 
 74 JavaVM* jvm = NULL;
 75 
 76 jboolean debug = 0;
 77 
 78 JNIEXPORT jint JNICALL DEF_JNI_OnLoad(JavaVM *vm, void *reserved) {
 79     jvm = vm;
 80     return JNI_VERSION_1_4;
 81 }
 82 
 83 /* ************************************************************************** */
 84 /* The native implementation of the methods of the PKCS11Implementation class */
 85 /* ************************************************************************** */
 86 

















 87 /*
 88  * This method is used to do static initialization. This method is static and
 89  * synchronized. Summary: use this method like a static initialization block.
 90  *
 91  * Class:     sun_security_pkcs11_wrapper_PKCS11
 92  * Method:    initializeLibrary
 93  * Signature: ()V
 94  */
 95 JNIEXPORT void JNICALL
 96 Java_sun_security_pkcs11_wrapper_PKCS11_initializeLibrary
 97 (JNIEnv *env, jclass thisClass, jboolean enableDebug)
 98 {
 99 #ifndef NO_CALLBACKS
100     if (notifyListLock == NULL) {
101         notifyListLock = createLockObject(env);
102     }
103 #endif
104 
105     prefetchFields(env, thisClass);
106     debug = enableDebug;
107 }
108 
109 jclass fetchClass(JNIEnv *env, const char *name) {
110     jclass tmpClass = (*env)-&gt;FindClass(env, name);
111     if (tmpClass == NULL) { return NULL; }
112     return (*env)-&gt;NewGlobalRef(env, tmpClass);
113 }
114 
115 void prefetchFields(JNIEnv *env, jclass thisClass) {
116     jclass tmpClass;
117 
<span class="line-modified">118     /* PKCS11 */</span>
119     pNativeDataID = (*env)-&gt;GetFieldID(env, thisClass, &quot;pNativeData&quot;, &quot;J&quot;);
120     if (pNativeDataID == NULL) { return; }
121 
<span class="line-modified">122     /* CK_MECHANISM */</span>
123     tmpClass = (*env)-&gt;FindClass(env, CLASS_MECHANISM);
124     if (tmpClass == NULL) { return; }
125     mech_mechanismID = (*env)-&gt;GetFieldID(env, tmpClass, &quot;mechanism&quot;, &quot;J&quot;);
126     if (mech_mechanismID == NULL) { return; }
127     mech_pParameterID = (*env)-&gt;GetFieldID(env, tmpClass, &quot;pParameter&quot;,
128                                            &quot;Ljava/lang/Object;&quot;);
129     if (mech_pParameterID == NULL) { return; }




130     jByteArrayClass = fetchClass(env, &quot;[B&quot;);
131     if (jByteArrayClass == NULL) { return; }
132     jLongClass = fetchClass(env, &quot;java/lang/Long&quot;);
133 }
134 
135 /* This method is designed to do a clean-up. It releases all global resources
136  * of this library. By now, this function is not called. Calling from
137  * JNI_OnUnload would be an option, but some VMs do not support JNI_OnUnload.
138  *
139  * Class:     sun_security_pkcs11_wrapper_PKCS11
140  * Method:    finalizeLibrary
141  * Signature: ()V
142  */
143 JNIEXPORT void JNICALL
144 Java_sun_security_pkcs11_wrapper_PKCS11_finalizeLibrary
145 (JNIEnv *env, jclass thisClass)
146 {
147 /* XXX
148     * remove all left lists and release the resources and the lock
149      * objects that synchroniz access to these lists.
</pre>
<hr />
<pre>
192     CK_C_INITIALIZE_ARGS_PTR ckpInitArgs;
193     CK_RV rv;
194     CK_FUNCTION_LIST_PTR ckpFunctions;
195 
196     TRACE0(&quot;DEBUG: initializing module... &quot;);
197 
198     ckpFunctions = getFunctionList(env, obj);
199     if (ckpFunctions == NULL) {
200         TRACE0(&quot;failed getting module entry&quot;);
201         return;
202     }
203 
204     ckpInitArgs = (jInitArgs != NULL)
205                 ? makeCKInitArgsAdapter(env, jInitArgs)
206                 : NULL_PTR;
207 
208     rv = (*ckpFunctions-&gt;C_Initialize)(ckpInitArgs);
209 
210     free(ckpInitArgs);
211 
<span class="line-modified">212     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }</span>



213 
214     TRACE0(&quot;FINISHED\n&quot;);
215 }
216 #endif
217 
218 #ifdef P11_ENABLE_C_FINALIZE
219 /*
220  * Class:     sun_security_pkcs11_wrapper_PKCS11
221  * Method:    C_Finalize
222  * Signature: (Ljava/lang/Object;)V
223  * Parametermapping:                    *PKCS11*
224  * @param   jobject jReserved           CK_VOID_PTR pReserved
225  */
226 JNIEXPORT void JNICALL
227 Java_sun_security_pkcs11_wrapper_PKCS11_C_1Finalize
228 (JNIEnv *env, jobject obj, jobject jReserved)
229 {
230     /*
231      * Finalize Cryptoki
232      */
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
 34  *  THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY EXPRESSED OR IMPLIED
 35  *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 36  *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 37  *  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE LICENSOR BE
 38  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
 39  *  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 40  *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
 41  *  OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 42  *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 43  *  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 44  *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 45  *  POSSIBILITY  OF SUCH DAMAGE.
 46  */
 47 
 48 #include &quot;pkcs11wrapper.h&quot;
 49 
 50 #include &lt;stdio.h&gt;
 51 #include &lt;stdlib.h&gt;
 52 #include &lt;string.h&gt;
 53 #include &lt;assert.h&gt;
<span class="line-added"> 54 #include &quot;jlong.h&quot;</span>
 55 
 56 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
 57 
 58 /* declare file private functions */
 59 
 60 void prefetchFields(JNIEnv *env, jclass thisClass);
 61 jobject ckInfoPtrToJInfo(JNIEnv *env, const CK_INFO_PTR ckpInfo);
 62 jobject ckSlotInfoPtrToJSlotInfo(JNIEnv *env, const CK_SLOT_INFO_PTR ckpSlotInfo);
 63 jobject ckTokenInfoPtrToJTokenInfo(JNIEnv *env, const CK_TOKEN_INFO_PTR ckpTokenInfo);
 64 jobject ckMechanismInfoPtrToJMechanismInfo(JNIEnv *env, const CK_MECHANISM_INFO_PTR ckpMechanismInfo);
 65 
 66 /* define variables */
 67 
 68 jfieldID pNativeDataID;
 69 jfieldID mech_mechanismID;
 70 jfieldID mech_pParameterID;
<span class="line-added"> 71 jfieldID mech_pHandleID;</span>
 72 
 73 jclass jByteArrayClass;
 74 jclass jLongClass;
 75 
 76 JavaVM* jvm = NULL;
 77 
 78 jboolean debug = 0;
 79 
 80 JNIEXPORT jint JNICALL DEF_JNI_OnLoad(JavaVM *vm, void *reserved) {
 81     jvm = vm;
 82     return JNI_VERSION_1_4;
 83 }
 84 
 85 /* ************************************************************************** */
 86 /* The native implementation of the methods of the PKCS11Implementation class */
 87 /* ************************************************************************** */
 88 
<span class="line-added"> 89 /*</span>
<span class="line-added"> 90  * This method is used to do free the memory allocated for CK_MECHANISM structure.</span>
<span class="line-added"> 91  *</span>
<span class="line-added"> 92  * Class:     sun_security_pkcs11_wrapper_PKCS11</span>
<span class="line-added"> 93  * Method:    freeMechanism</span>
<span class="line-added"> 94  * Signature: (J)J</span>
<span class="line-added"> 95  */</span>
<span class="line-added"> 96 JNIEXPORT jlong JNICALL</span>
<span class="line-added"> 97 Java_sun_security_pkcs11_wrapper_PKCS11_freeMechanism</span>
<span class="line-added"> 98 (JNIEnv *env, jclass thisClass, jlong ckpMechanism) {</span>
<span class="line-added"> 99     if (ckpMechanism != 0L) {</span>
<span class="line-added">100         freeCKMechanismPtr(jlong_to_ptr(ckpMechanism));</span>
<span class="line-added">101         TRACE1(&quot;DEBUG PKCS11_freeMechanism: free pMech = %lld\n&quot;, (long long int) ckpMechanism);</span>
<span class="line-added">102     }</span>
<span class="line-added">103     return 0L;</span>
<span class="line-added">104 }</span>
<span class="line-added">105 </span>
106 /*
107  * This method is used to do static initialization. This method is static and
108  * synchronized. Summary: use this method like a static initialization block.
109  *
110  * Class:     sun_security_pkcs11_wrapper_PKCS11
111  * Method:    initializeLibrary
112  * Signature: ()V
113  */
114 JNIEXPORT void JNICALL
115 Java_sun_security_pkcs11_wrapper_PKCS11_initializeLibrary
116 (JNIEnv *env, jclass thisClass, jboolean enableDebug)
117 {
118 #ifndef NO_CALLBACKS
119     if (notifyListLock == NULL) {
120         notifyListLock = createLockObject(env);
121     }
122 #endif
123 
124     prefetchFields(env, thisClass);
125     debug = enableDebug;
126 }
127 
128 jclass fetchClass(JNIEnv *env, const char *name) {
129     jclass tmpClass = (*env)-&gt;FindClass(env, name);
130     if (tmpClass == NULL) { return NULL; }
131     return (*env)-&gt;NewGlobalRef(env, tmpClass);
132 }
133 
134 void prefetchFields(JNIEnv *env, jclass thisClass) {
135     jclass tmpClass;
136 
<span class="line-modified">137     /* PKCS11 - pNativeData */</span>
138     pNativeDataID = (*env)-&gt;GetFieldID(env, thisClass, &quot;pNativeData&quot;, &quot;J&quot;);
139     if (pNativeDataID == NULL) { return; }
140 
<span class="line-modified">141     /* CK_MECHANISM - mechanism, pParameter, pHandle */</span>
142     tmpClass = (*env)-&gt;FindClass(env, CLASS_MECHANISM);
143     if (tmpClass == NULL) { return; }
144     mech_mechanismID = (*env)-&gt;GetFieldID(env, tmpClass, &quot;mechanism&quot;, &quot;J&quot;);
145     if (mech_mechanismID == NULL) { return; }
146     mech_pParameterID = (*env)-&gt;GetFieldID(env, tmpClass, &quot;pParameter&quot;,
147                                            &quot;Ljava/lang/Object;&quot;);
148     if (mech_pParameterID == NULL) { return; }
<span class="line-added">149     mech_pHandleID = (*env)-&gt;GetFieldID(env, tmpClass, &quot;pHandle&quot;, &quot;J&quot;);</span>
<span class="line-added">150     if (mech_pHandleID == NULL) { return; }</span>
<span class="line-added">151 </span>
<span class="line-added">152     /* java classes for primitive types - byte[], long */</span>
153     jByteArrayClass = fetchClass(env, &quot;[B&quot;);
154     if (jByteArrayClass == NULL) { return; }
155     jLongClass = fetchClass(env, &quot;java/lang/Long&quot;);
156 }
157 
158 /* This method is designed to do a clean-up. It releases all global resources
159  * of this library. By now, this function is not called. Calling from
160  * JNI_OnUnload would be an option, but some VMs do not support JNI_OnUnload.
161  *
162  * Class:     sun_security_pkcs11_wrapper_PKCS11
163  * Method:    finalizeLibrary
164  * Signature: ()V
165  */
166 JNIEXPORT void JNICALL
167 Java_sun_security_pkcs11_wrapper_PKCS11_finalizeLibrary
168 (JNIEnv *env, jclass thisClass)
169 {
170 /* XXX
171     * remove all left lists and release the resources and the lock
172      * objects that synchroniz access to these lists.
</pre>
<hr />
<pre>
215     CK_C_INITIALIZE_ARGS_PTR ckpInitArgs;
216     CK_RV rv;
217     CK_FUNCTION_LIST_PTR ckpFunctions;
218 
219     TRACE0(&quot;DEBUG: initializing module... &quot;);
220 
221     ckpFunctions = getFunctionList(env, obj);
222     if (ckpFunctions == NULL) {
223         TRACE0(&quot;failed getting module entry&quot;);
224         return;
225     }
226 
227     ckpInitArgs = (jInitArgs != NULL)
228                 ? makeCKInitArgsAdapter(env, jInitArgs)
229                 : NULL_PTR;
230 
231     rv = (*ckpFunctions-&gt;C_Initialize)(ckpInitArgs);
232 
233     free(ckpInitArgs);
234 
<span class="line-modified">235     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) {</span>
<span class="line-added">236       TRACE1(&quot;DEBUG: C_Initialize had a bad return value %lu \n&quot;, (unsigned long) rv);</span>
<span class="line-added">237       return;</span>
<span class="line-added">238     }</span>
239 
240     TRACE0(&quot;FINISHED\n&quot;);
241 }
242 #endif
243 
244 #ifdef P11_ENABLE_C_FINALIZE
245 /*
246  * Class:     sun_security_pkcs11_wrapper_PKCS11
247  * Method:    C_Finalize
248  * Signature: (Ljava/lang/Object;)V
249  * Parametermapping:                    *PKCS11*
250  * @param   jobject jReserved           CK_VOID_PTR pReserved
251  */
252 JNIEXPORT void JNICALL
253 Java_sun_security_pkcs11_wrapper_PKCS11_C_1Finalize
254 (JNIEnv *env, jobject obj, jobject jReserved)
255 {
256     /*
257      * Finalize Cryptoki
258      */
</pre>
</td>
</tr>
</table>
<center><a href="p11_digest.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_keymgmt.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>