<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_digest.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="p11_crypt.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_general.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_digest.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
 51 #include &lt;stdlib.h&gt;
 52 #include &lt;string.h&gt;
 53 #include &lt;assert.h&gt;
 54 #include &quot;jlong.h&quot;
 55 
 56 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
 57 
 58 #ifdef P11_ENABLE_C_DIGESTINIT
 59 /*
 60  * Class:     sun_security_pkcs11_wrapper_PKCS11
 61  * Method:    C_DigestInit
 62  * Signature: (JLsun/security/pkcs11/wrapper/CK_MECHANISM;)V
 63  * Parametermapping:                    *PKCS11*
 64  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
 65  * @param   jobject jMechanism          CK_MECHANISM_PTR pMechanism
 66  */
 67 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestInit
 68     (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism)
 69 {
 70     CK_SESSION_HANDLE ckSessionHandle;
<span class="line-modified"> 71     CK_MECHANISM ckMechanism;</span>
 72     CK_RV rv;
 73 
 74     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
 75     if (ckpFunctions == NULL) { return; }
 76 
 77     ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="line-modified"> 78     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>
 79     if ((*env)-&gt;ExceptionCheck(env)) { return; }
 80 
<span class="line-modified"> 81     rv = (*ckpFunctions-&gt;C_DigestInit)(ckSessionHandle, &amp;ckMechanism);</span>
 82 
<span class="line-modified"> 83     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="line-removed"> 84         free(ckMechanism.pParameter);</span>
<span class="line-removed"> 85     }</span>
 86 
 87     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
 88 }
 89 #endif
 90 
 91 #ifdef P11_ENABLE_C_DIGEST
 92 /*
 93  * Class:     sun_security_pkcs11_wrapper_PKCS11
 94  * Method:    C_Digest
 95  * Signature: (J[BII[BII)I
 96  * Parametermapping:                    *PKCS11*
 97  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
 98  * @param   jbyteArray jData            CK_BYTE_PTR pData
 99  *                                      CK_ULONG ulDataLen
100  * @return  jbyteArray jDigest          CK_BYTE_PTR pDigest
101  *                                      CK_ULONG_PTR pulDigestLen
102  */
103 JNIEXPORT jint JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestSingle
<span class="line-modified">104   (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism, jbyteArray jIn, jint jInOfs, jint jInLen, jbyteArray jDigest, jint jDigestOfs, jint jDigestLen)</span>


105 {
106     CK_SESSION_HANDLE ckSessionHandle;
107     CK_RV rv;
<span class="line-removed">108     CK_BYTE_PTR bufP;</span>
109     CK_BYTE BUF[MAX_STACK_BUFFER_LEN];

110     CK_BYTE DIGESTBUF[MAX_DIGEST_LEN];
<span class="line-modified">111     CK_ULONG ckDigestLength = min(MAX_DIGEST_LEN, jDigestLen);</span>
<span class="line-modified">112     CK_MECHANISM ckMechanism;</span>
113 
114     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
115     if (ckpFunctions == NULL) { return 0; }
116 
117     ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="line-modified">118     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>
119     if ((*env)-&gt;ExceptionCheck(env)) { return 0; }
120 
<span class="line-modified">121     rv = (*ckpFunctions-&gt;C_DigestInit)(ckSessionHandle, &amp;ckMechanism);</span>
<span class="line-modified">122 </span>
<span class="line-removed">123     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="line-removed">124         free(ckMechanism.pParameter);</span>
<span class="line-removed">125     }</span>
<span class="line-removed">126 </span>
<span class="line-removed">127     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return 0; }</span>
128 
<span class="line-modified">129     if (jInLen &lt;= MAX_STACK_BUFFER_LEN) {</span>
<span class="line-removed">130         bufP = BUF;</span>
<span class="line-removed">131     } else {</span>
132         /* always use single part op, even for large data */
133         bufP = (CK_BYTE_PTR) malloc((size_t)jInLen);
134         if (bufP == NULL) {
135             throwOutOfMemoryError(env, 0);
<span class="line-modified">136             return 0;</span>
137         }
138     }
139 
140     (*env)-&gt;GetByteArrayRegion(env, jIn, jInOfs, jInLen, (jbyte *)bufP);
141     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">142         if (bufP != BUF) { free(bufP); }</span>
<span class="line-removed">143         return 0;</span>
144     }
145 


146     rv = (*ckpFunctions-&gt;C_Digest)(ckSessionHandle, bufP, jInLen, DIGESTBUF, &amp;ckDigestLength);
147     if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
148         (*env)-&gt;SetByteArrayRegion(env, jDigest, jDigestOfs, ckDigestLength, (jbyte *)DIGESTBUF);
149     }
<span class="line-modified">150 </span>

151     if (bufP != BUF) { free(bufP); }
152 
153     return ckDigestLength;
154 }
155 #endif
156 
157 #ifdef P11_ENABLE_C_DIGESTUPDATE
158 /*
159  * Class:     sun_security_pkcs11_wrapper_PKCS11
160  * Method:    C_DigestUpdate
161  * Signature: (J[B)V
162  * Parametermapping:                    *PKCS11*
163  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
164  * @param   jbyteArray jData            CK_BYTE_PTR pData
165  *                                      CK_ULONG ulDataLen
166  */
167 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestUpdate
<span class="line-modified">168   (JNIEnv *env, jobject obj, jlong jSessionHandle, jlong directIn, jbyteArray jIn, jint jInOfs, jint jInLen)</span>

169 {
170     CK_SESSION_HANDLE ckSessionHandle;
171     CK_RV rv;
172     CK_BYTE_PTR bufP;
173     CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
174     jsize bufLen;
175 
176     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
177     if (ckpFunctions == NULL) { return; }
178 
179     ckSessionHandle = jLongToCKULong(jSessionHandle);
180 
181     if (directIn != 0) {
182         rv = (*ckpFunctions-&gt;C_DigestUpdate)(ckSessionHandle, (CK_BYTE_PTR)jlong_to_ptr(directIn), jInLen);
183         ckAssertReturnValueOK(env, rv);
184         return;
185     }
186 
187     if (jInLen &lt;= MAX_STACK_BUFFER_LEN) {
188         bufLen = MAX_STACK_BUFFER_LEN;
</pre>
<hr />
<pre>
239 
240     ckSessionHandle = jLongToCKULong(jSessionHandle);
241     ckKeyHandle = jLongToCKULong(jKeyHandle);
242 
243     rv = (*ckpFunctions-&gt;C_DigestKey)(ckSessionHandle, ckKeyHandle);
244     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
245 }
246 #endif
247 
248 #ifdef P11_ENABLE_C_DIGESTFINAL
249 /*
250  * Class:     sun_security_pkcs11_wrapper_PKCS11
251  * Method:    C_DigestFinal
252  * Signature: (J[BII)I
253  * Parametermapping:                    *PKCS11*
254  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
255  * @return  jbyteArray jDigest          CK_BYTE_PTR pDigest
256  *                                      CK_ULONG_PTR pulDigestLen
257  */
258 JNIEXPORT jint JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestFinal
<span class="line-modified">259   (JNIEnv *env, jobject obj, jlong jSessionHandle, jbyteArray jDigest, jint jDigestOfs, jint jDigestLen)</span>

260 {
261     CK_SESSION_HANDLE ckSessionHandle;
262     CK_RV rv;
263     CK_BYTE BUF[MAX_DIGEST_LEN];
264     CK_ULONG ckDigestLength = min(MAX_DIGEST_LEN, jDigestLen);
265 
266     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
267     if (ckpFunctions == NULL) { return 0; }
268 
269     ckSessionHandle = jLongToCKULong(jSessionHandle);
270 
271     rv = (*ckpFunctions-&gt;C_DigestFinal)(ckSessionHandle, BUF, &amp;ckDigestLength);
272     if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
273         (*env)-&gt;SetByteArrayRegion(env, jDigest, jDigestOfs, ckDigestLength, (jbyte *)BUF);
274     }
275     return ckDigestLength;
276 }
277 #endif
278 
279 #ifdef P11_ENABLE_C_SEEDRANDOM
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
 51 #include &lt;stdlib.h&gt;
 52 #include &lt;string.h&gt;
 53 #include &lt;assert.h&gt;
 54 #include &quot;jlong.h&quot;
 55 
 56 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
 57 
 58 #ifdef P11_ENABLE_C_DIGESTINIT
 59 /*
 60  * Class:     sun_security_pkcs11_wrapper_PKCS11
 61  * Method:    C_DigestInit
 62  * Signature: (JLsun/security/pkcs11/wrapper/CK_MECHANISM;)V
 63  * Parametermapping:                    *PKCS11*
 64  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
 65  * @param   jobject jMechanism          CK_MECHANISM_PTR pMechanism
 66  */
 67 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestInit
 68     (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism)
 69 {
 70     CK_SESSION_HANDLE ckSessionHandle;
<span class="line-modified"> 71     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
 72     CK_RV rv;
 73 
 74     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
 75     if (ckpFunctions == NULL) { return; }
 76 
 77     ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="line-modified"> 78     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
 79     if ((*env)-&gt;ExceptionCheck(env)) { return; }
 80 
<span class="line-modified"> 81     rv = (*ckpFunctions-&gt;C_DigestInit)(ckSessionHandle, ckpMechanism);</span>
 82 
<span class="line-modified"> 83     freeCKMechanismPtr(ckpMechanism);</span>


 84 
 85     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
 86 }
 87 #endif
 88 
 89 #ifdef P11_ENABLE_C_DIGEST
 90 /*
 91  * Class:     sun_security_pkcs11_wrapper_PKCS11
 92  * Method:    C_Digest
 93  * Signature: (J[BII[BII)I
 94  * Parametermapping:                    *PKCS11*
 95  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
 96  * @param   jbyteArray jData            CK_BYTE_PTR pData
 97  *                                      CK_ULONG ulDataLen
 98  * @return  jbyteArray jDigest          CK_BYTE_PTR pDigest
 99  *                                      CK_ULONG_PTR pulDigestLen
100  */
101 JNIEXPORT jint JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestSingle
<span class="line-modified">102     (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism,</span>
<span class="line-added">103      jbyteArray jIn, jint jInOfs, jint jInLen, jbyteArray jDigest,</span>
<span class="line-added">104      jint jDigestOfs, jint jDigestLen)</span>
105 {
106     CK_SESSION_HANDLE ckSessionHandle;
107     CK_RV rv;

108     CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
<span class="line-added">109     CK_BYTE_PTR bufP = BUF;</span>
110     CK_BYTE DIGESTBUF[MAX_DIGEST_LEN];
<span class="line-modified">111     CK_ULONG ckDigestLength = 0;</span>
<span class="line-modified">112     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
113 
114     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
115     if (ckpFunctions == NULL) { return 0; }
116 
117     ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="line-modified">118     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
119     if ((*env)-&gt;ExceptionCheck(env)) { return 0; }
120 
<span class="line-modified">121     rv = (*ckpFunctions-&gt;C_DigestInit)(ckSessionHandle, ckpMechanism);</span>
<span class="line-modified">122     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { goto cleanup; }</span>





123 
<span class="line-modified">124     if (jInLen &gt; MAX_STACK_BUFFER_LEN) {</span>


125         /* always use single part op, even for large data */
126         bufP = (CK_BYTE_PTR) malloc((size_t)jInLen);
127         if (bufP == NULL) {
128             throwOutOfMemoryError(env, 0);
<span class="line-modified">129             goto cleanup;</span>
130         }
131     }
132 
133     (*env)-&gt;GetByteArrayRegion(env, jIn, jInOfs, jInLen, (jbyte *)bufP);
134     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">135         goto cleanup;</span>

136     }
137 
<span class="line-added">138     ckDigestLength = min(MAX_DIGEST_LEN, jDigestLen);</span>
<span class="line-added">139 </span>
140     rv = (*ckpFunctions-&gt;C_Digest)(ckSessionHandle, bufP, jInLen, DIGESTBUF, &amp;ckDigestLength);
141     if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
142         (*env)-&gt;SetByteArrayRegion(env, jDigest, jDigestOfs, ckDigestLength, (jbyte *)DIGESTBUF);
143     }
<span class="line-modified">144 cleanup:</span>
<span class="line-added">145     freeCKMechanismPtr(ckpMechanism);</span>
146     if (bufP != BUF) { free(bufP); }
147 
148     return ckDigestLength;
149 }
150 #endif
151 
152 #ifdef P11_ENABLE_C_DIGESTUPDATE
153 /*
154  * Class:     sun_security_pkcs11_wrapper_PKCS11
155  * Method:    C_DigestUpdate
156  * Signature: (J[B)V
157  * Parametermapping:                    *PKCS11*
158  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
159  * @param   jbyteArray jData            CK_BYTE_PTR pData
160  *                                      CK_ULONG ulDataLen
161  */
162 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestUpdate
<span class="line-modified">163     (JNIEnv *env, jobject obj, jlong jSessionHandle, jlong directIn, jbyteArray jIn,</span>
<span class="line-added">164      jint jInOfs, jint jInLen)</span>
165 {
166     CK_SESSION_HANDLE ckSessionHandle;
167     CK_RV rv;
168     CK_BYTE_PTR bufP;
169     CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
170     jsize bufLen;
171 
172     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
173     if (ckpFunctions == NULL) { return; }
174 
175     ckSessionHandle = jLongToCKULong(jSessionHandle);
176 
177     if (directIn != 0) {
178         rv = (*ckpFunctions-&gt;C_DigestUpdate)(ckSessionHandle, (CK_BYTE_PTR)jlong_to_ptr(directIn), jInLen);
179         ckAssertReturnValueOK(env, rv);
180         return;
181     }
182 
183     if (jInLen &lt;= MAX_STACK_BUFFER_LEN) {
184         bufLen = MAX_STACK_BUFFER_LEN;
</pre>
<hr />
<pre>
235 
236     ckSessionHandle = jLongToCKULong(jSessionHandle);
237     ckKeyHandle = jLongToCKULong(jKeyHandle);
238 
239     rv = (*ckpFunctions-&gt;C_DigestKey)(ckSessionHandle, ckKeyHandle);
240     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
241 }
242 #endif
243 
244 #ifdef P11_ENABLE_C_DIGESTFINAL
245 /*
246  * Class:     sun_security_pkcs11_wrapper_PKCS11
247  * Method:    C_DigestFinal
248  * Signature: (J[BII)I
249  * Parametermapping:                    *PKCS11*
250  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
251  * @return  jbyteArray jDigest          CK_BYTE_PTR pDigest
252  *                                      CK_ULONG_PTR pulDigestLen
253  */
254 JNIEXPORT jint JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestFinal
<span class="line-modified">255     (JNIEnv *env, jobject obj, jlong jSessionHandle, jbyteArray jDigest,</span>
<span class="line-added">256      jint jDigestOfs, jint jDigestLen)</span>
257 {
258     CK_SESSION_HANDLE ckSessionHandle;
259     CK_RV rv;
260     CK_BYTE BUF[MAX_DIGEST_LEN];
261     CK_ULONG ckDigestLength = min(MAX_DIGEST_LEN, jDigestLen);
262 
263     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
264     if (ckpFunctions == NULL) { return 0; }
265 
266     ckSessionHandle = jLongToCKULong(jSessionHandle);
267 
268     rv = (*ckpFunctions-&gt;C_DigestFinal)(ckSessionHandle, BUF, &amp;ckDigestLength);
269     if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
270         (*env)-&gt;SetByteArrayRegion(env, jDigest, jDigestOfs, ckDigestLength, (jbyte *)BUF);
271     }
272     return ckDigestLength;
273 }
274 #endif
275 
276 #ifdef P11_ENABLE_C_SEEDRANDOM
</pre>
</td>
</tr>
</table>
<center><a href="p11_crypt.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_general.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>