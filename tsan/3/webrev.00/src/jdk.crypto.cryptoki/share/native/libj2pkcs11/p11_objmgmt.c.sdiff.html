<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_objmgmt.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="p11_mutex.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_sessmgmt.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_objmgmt.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2011, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
206  * @param   jlong jObjectHandle         CK_OBJECT_HANDLE hObject
207  * @param   jobjectArray jTemplate      CK_ATTRIBUTE_PTR pTemplate
208  *                                      CK_ULONG ulCount
209  */
210 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1GetAttributeValue
211     (JNIEnv *env, jobject obj, jlong jSessionHandle, jlong jObjectHandle, jobjectArray jTemplate)
212 {
213     CK_SESSION_HANDLE ckSessionHandle;
214     CK_OBJECT_HANDLE ckObjectHandle;
215     CK_ATTRIBUTE_PTR ckpAttributes = NULL_PTR;
216     CK_ULONG ckAttributesLength;
217     CK_ULONG ckBufferLength;
218     CK_ULONG i;
219     jobject jAttribute;
220     CK_RV rv;
221 
222     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
223     if (ckpFunctions == NULL) { return; }
224 
225     TRACE0(&quot;DEBUG: C_GetAttributeValue&quot;);
<span class="line-modified">226     TRACE1(&quot;, hSession=%u&quot;, jSessionHandle);</span>
<span class="line-modified">227     TRACE1(&quot;, hObject=%u&quot;, jObjectHandle);</span>
228     TRACE1(&quot;, pTemplate=%p&quot;, jTemplate);
229     TRACE0(&quot; ... &quot;);
230 
231     ckSessionHandle = jLongToCKULong(jSessionHandle);
232     ckObjectHandle = jLongToCKULong(jObjectHandle);
<span class="line-modified">233     TRACE1(&quot;jAttributeArrayToCKAttributeArray now with jTemplate = %d&quot;, jTemplate);</span>
234     jAttributeArrayToCKAttributeArray(env, jTemplate, &amp;ckpAttributes, &amp;ckAttributesLength);
235     if ((*env)-&gt;ExceptionCheck(env)) { return; }
236 
<span class="line-modified">237     TRACE2(&quot;DEBUG: jAttributeArrayToCKAttributeArray finished with ckpAttribute = %d, Length = %d\n&quot;, ckpAttributes, ckAttributesLength);</span>
238 
239     /* first set all pValue to NULL, to get the needed buffer length */
240     for(i = 0; i &lt; ckAttributesLength; i++) {
241         if (ckpAttributes[i].pValue != NULL_PTR) {
242             free(ckpAttributes[i].pValue);
243             ckpAttributes[i].pValue = NULL_PTR;
244         }
245     }
246 
247     rv = (*ckpFunctions-&gt;C_GetAttributeValue)(ckSessionHandle, ckObjectHandle, ckpAttributes, ckAttributesLength);
248     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) {
249         free(ckpAttributes);
250         return ;
251     }
252 
253     /* now, the ulValueLength field of each attribute should hold the exact buffer length needed
254      * allocate the needed buffers accordingly
255      */
256     for (i = 0; i &lt; ckAttributesLength; i++) {
257         ckBufferLength = sizeof(CK_BYTE) * ckpAttributes[i].ulValueLen;
</pre>
<hr />
<pre>
328  * Class:     sun_security_pkcs11_wrapper_PKCS11
329  * Method:    C_FindObjectsInit
330  * Signature: (J[Lsun/security/pkcs11/wrapper/CK_ATTRIBUTE;)V
331  * Parametermapping:                    *PKCS11*
332  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
333  * @param   jobjectArray jTemplate      CK_ATTRIBUTE_PTR pTemplate
334  *                                      CK_ULONG ulCount
335  */
336 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1FindObjectsInit
337     (JNIEnv *env, jobject obj, jlong jSessionHandle, jobjectArray jTemplate)
338 {
339     CK_SESSION_HANDLE ckSessionHandle;
340     CK_ATTRIBUTE_PTR ckpAttributes = NULL_PTR;
341     CK_ULONG ckAttributesLength;
342     CK_RV rv;
343 
344     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
345     if (ckpFunctions == NULL) { return; }
346 
347     TRACE0(&quot;DEBUG: C_FindObjectsInit&quot;);
<span class="line-modified">348     TRACE1(&quot;, hSession=%u&quot;, jSessionHandle);</span>
349     TRACE1(&quot;, pTemplate=%p&quot;, jTemplate);
350     TRACE0(&quot; ... &quot;);
351 
352     ckSessionHandle = jLongToCKULong(jSessionHandle);
353     jAttributeArrayToCKAttributeArray(env, jTemplate, &amp;ckpAttributes, &amp;ckAttributesLength);
354     if ((*env)-&gt;ExceptionCheck(env)) { return; }
355 
356     rv = (*ckpFunctions-&gt;C_FindObjectsInit)(ckSessionHandle, ckpAttributes, ckAttributesLength);
357 
358     freeCKAttributeArray(ckpAttributes, ckAttributesLength);
359     TRACE0(&quot;FINISHED\n&quot;);
360 
361     if(ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
362 }
363 #endif
364 
365 #ifdef P11_ENABLE_C_FINDOBJECTS
366 /*
367  * Class:     sun_security_pkcs11_wrapper_PKCS11
368  * Method:    C_FindObjects
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
206  * @param   jlong jObjectHandle         CK_OBJECT_HANDLE hObject
207  * @param   jobjectArray jTemplate      CK_ATTRIBUTE_PTR pTemplate
208  *                                      CK_ULONG ulCount
209  */
210 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1GetAttributeValue
211     (JNIEnv *env, jobject obj, jlong jSessionHandle, jlong jObjectHandle, jobjectArray jTemplate)
212 {
213     CK_SESSION_HANDLE ckSessionHandle;
214     CK_OBJECT_HANDLE ckObjectHandle;
215     CK_ATTRIBUTE_PTR ckpAttributes = NULL_PTR;
216     CK_ULONG ckAttributesLength;
217     CK_ULONG ckBufferLength;
218     CK_ULONG i;
219     jobject jAttribute;
220     CK_RV rv;
221 
222     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
223     if (ckpFunctions == NULL) { return; }
224 
225     TRACE0(&quot;DEBUG: C_GetAttributeValue&quot;);
<span class="line-modified">226     TRACE1(&quot;, hSession=%lld&quot;, (long long) jSessionHandle);</span>
<span class="line-modified">227     TRACE1(&quot;, hObject=%lld&quot;, (long long) jObjectHandle);</span>
228     TRACE1(&quot;, pTemplate=%p&quot;, jTemplate);
229     TRACE0(&quot; ... &quot;);
230 
231     ckSessionHandle = jLongToCKULong(jSessionHandle);
232     ckObjectHandle = jLongToCKULong(jObjectHandle);
<span class="line-modified">233     TRACE1(&quot;jAttributeArrayToCKAttributeArray now with jTemplate = %p&quot;, jTemplate);</span>
234     jAttributeArrayToCKAttributeArray(env, jTemplate, &amp;ckpAttributes, &amp;ckAttributesLength);
235     if ((*env)-&gt;ExceptionCheck(env)) { return; }
236 
<span class="line-modified">237     TRACE2(&quot;DEBUG: jAttributeArrayToCKAttributeArray finished with ckpAttribute = %p, Length = %lu\n&quot;, ckpAttributes, (unsigned long) ckAttributesLength);</span>
238 
239     /* first set all pValue to NULL, to get the needed buffer length */
240     for(i = 0; i &lt; ckAttributesLength; i++) {
241         if (ckpAttributes[i].pValue != NULL_PTR) {
242             free(ckpAttributes[i].pValue);
243             ckpAttributes[i].pValue = NULL_PTR;
244         }
245     }
246 
247     rv = (*ckpFunctions-&gt;C_GetAttributeValue)(ckSessionHandle, ckObjectHandle, ckpAttributes, ckAttributesLength);
248     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) {
249         free(ckpAttributes);
250         return ;
251     }
252 
253     /* now, the ulValueLength field of each attribute should hold the exact buffer length needed
254      * allocate the needed buffers accordingly
255      */
256     for (i = 0; i &lt; ckAttributesLength; i++) {
257         ckBufferLength = sizeof(CK_BYTE) * ckpAttributes[i].ulValueLen;
</pre>
<hr />
<pre>
328  * Class:     sun_security_pkcs11_wrapper_PKCS11
329  * Method:    C_FindObjectsInit
330  * Signature: (J[Lsun/security/pkcs11/wrapper/CK_ATTRIBUTE;)V
331  * Parametermapping:                    *PKCS11*
332  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
333  * @param   jobjectArray jTemplate      CK_ATTRIBUTE_PTR pTemplate
334  *                                      CK_ULONG ulCount
335  */
336 JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1FindObjectsInit
337     (JNIEnv *env, jobject obj, jlong jSessionHandle, jobjectArray jTemplate)
338 {
339     CK_SESSION_HANDLE ckSessionHandle;
340     CK_ATTRIBUTE_PTR ckpAttributes = NULL_PTR;
341     CK_ULONG ckAttributesLength;
342     CK_RV rv;
343 
344     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
345     if (ckpFunctions == NULL) { return; }
346 
347     TRACE0(&quot;DEBUG: C_FindObjectsInit&quot;);
<span class="line-modified">348     TRACE1(&quot;, hSession=%lld&quot;, (long long int) jSessionHandle);</span>
349     TRACE1(&quot;, pTemplate=%p&quot;, jTemplate);
350     TRACE0(&quot; ... &quot;);
351 
352     ckSessionHandle = jLongToCKULong(jSessionHandle);
353     jAttributeArrayToCKAttributeArray(env, jTemplate, &amp;ckpAttributes, &amp;ckAttributesLength);
354     if ((*env)-&gt;ExceptionCheck(env)) { return; }
355 
356     rv = (*ckpFunctions-&gt;C_FindObjectsInit)(ckSessionHandle, ckpAttributes, ckAttributesLength);
357 
358     freeCKAttributeArray(ckpAttributes, ckAttributesLength);
359     TRACE0(&quot;FINISHED\n&quot;);
360 
361     if(ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
362 }
363 #endif
364 
365 #ifdef P11_ENABLE_C_FINDOBJECTS
366 /*
367  * Class:     sun_security_pkcs11_wrapper_PKCS11
368  * Method:    C_FindObjects
</pre>
</td>
</tr>
</table>
<center><a href="p11_mutex.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_sessmgmt.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>