<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_digest.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="p11_crypt.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_general.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_digest.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2012, Oracle and/or its affiliates. All rights reserved.</span>
   */
  
  /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
   *
   * Redistribution and use in  source and binary forms, with or without
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   */
  
  /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
   *
   * Redistribution and use in  source and binary forms, with or without
</pre>
<hr />
<pre>
<span class="line-old-header">*** 66,25 ***</span>
   */
  JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestInit
      (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism)
  {
      CK_SESSION_HANDLE ckSessionHandle;
<span class="line-modified">!     CK_MECHANISM ckMechanism;</span>
      CK_RV rv;
  
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
      if (ckpFunctions == NULL) { return; }
  
      ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="line-modified">!     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>
      if ((*env)-&gt;ExceptionCheck(env)) { return; }
  
<span class="line-modified">!     rv = (*ckpFunctions-&gt;C_DigestInit)(ckSessionHandle, &amp;ckMechanism);</span>
  
<span class="line-modified">!     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="line-removed">-         free(ckMechanism.pParameter);</span>
<span class="line-removed">-     }</span>
  
      if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
  }
  #endif
  
<span class="line-new-header">--- 66,23 ---</span>
   */
  JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestInit
      (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism)
  {
      CK_SESSION_HANDLE ckSessionHandle;
<span class="line-modified">!     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
      CK_RV rv;
  
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
      if (ckpFunctions == NULL) { return; }
  
      ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="line-modified">!     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
      if ((*env)-&gt;ExceptionCheck(env)) { return; }
  
<span class="line-modified">!     rv = (*ckpFunctions-&gt;C_DigestInit)(ckSessionHandle, ckpMechanism);</span>
  
<span class="line-modified">!     freeCKMechanismPtr(ckpMechanism);</span>
  
      if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
  }
  #endif
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 99,57 ***</span>
   *                                      CK_ULONG ulDataLen
   * @return  jbyteArray jDigest          CK_BYTE_PTR pDigest
   *                                      CK_ULONG_PTR pulDigestLen
   */
  JNIEXPORT jint JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestSingle
<span class="line-modified">!   (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism, jbyteArray jIn, jint jInOfs, jint jInLen, jbyteArray jDigest, jint jDigestOfs, jint jDigestLen)</span>
  {
      CK_SESSION_HANDLE ckSessionHandle;
      CK_RV rv;
<span class="line-removed">-     CK_BYTE_PTR bufP;</span>
      CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
      CK_BYTE DIGESTBUF[MAX_DIGEST_LEN];
<span class="line-modified">!     CK_ULONG ckDigestLength = min(MAX_DIGEST_LEN, jDigestLen);</span>
<span class="line-modified">!     CK_MECHANISM ckMechanism;</span>
  
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
      if (ckpFunctions == NULL) { return 0; }
  
      ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="line-modified">!     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>
      if ((*env)-&gt;ExceptionCheck(env)) { return 0; }
  
<span class="line-modified">!     rv = (*ckpFunctions-&gt;C_DigestInit)(ckSessionHandle, &amp;ckMechanism);</span>
<span class="line-modified">! </span>
<span class="line-removed">-     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="line-removed">-         free(ckMechanism.pParameter);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return 0; }</span>
  
<span class="line-modified">!     if (jInLen &lt;= MAX_STACK_BUFFER_LEN) {</span>
<span class="line-removed">-         bufP = BUF;</span>
<span class="line-removed">-     } else {</span>
          /* always use single part op, even for large data */
          bufP = (CK_BYTE_PTR) malloc((size_t)jInLen);
          if (bufP == NULL) {
              throwOutOfMemoryError(env, 0);
<span class="line-modified">!             return 0;</span>
          }
      }
  
      (*env)-&gt;GetByteArrayRegion(env, jIn, jInOfs, jInLen, (jbyte *)bufP);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         if (bufP != BUF) { free(bufP); }</span>
<span class="line-removed">-         return 0;</span>
      }
  
      rv = (*ckpFunctions-&gt;C_Digest)(ckSessionHandle, bufP, jInLen, DIGESTBUF, &amp;ckDigestLength);
      if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
          (*env)-&gt;SetByteArrayRegion(env, jDigest, jDigestOfs, ckDigestLength, (jbyte *)DIGESTBUF);
      }
<span class="line-modified">! </span>
      if (bufP != BUF) { free(bufP); }
  
      return ckDigestLength;
  }
  #endif
<span class="line-new-header">--- 97,54 ---</span>
   *                                      CK_ULONG ulDataLen
   * @return  jbyteArray jDigest          CK_BYTE_PTR pDigest
   *                                      CK_ULONG_PTR pulDigestLen
   */
  JNIEXPORT jint JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestSingle
<span class="line-modified">!     (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism,</span>
<span class="line-added">+      jbyteArray jIn, jint jInOfs, jint jInLen, jbyteArray jDigest,</span>
<span class="line-added">+      jint jDigestOfs, jint jDigestLen)</span>
  {
      CK_SESSION_HANDLE ckSessionHandle;
      CK_RV rv;
      CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
<span class="line-added">+     CK_BYTE_PTR bufP = BUF;</span>
      CK_BYTE DIGESTBUF[MAX_DIGEST_LEN];
<span class="line-modified">!     CK_ULONG ckDigestLength = 0;</span>
<span class="line-modified">!     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
  
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
      if (ckpFunctions == NULL) { return 0; }
  
      ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="line-modified">!     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
      if ((*env)-&gt;ExceptionCheck(env)) { return 0; }
  
<span class="line-modified">!     rv = (*ckpFunctions-&gt;C_DigestInit)(ckSessionHandle, ckpMechanism);</span>
<span class="line-modified">!     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { goto cleanup; }</span>
  
<span class="line-modified">!     if (jInLen &gt; MAX_STACK_BUFFER_LEN) {</span>
          /* always use single part op, even for large data */
          bufP = (CK_BYTE_PTR) malloc((size_t)jInLen);
          if (bufP == NULL) {
              throwOutOfMemoryError(env, 0);
<span class="line-modified">!             goto cleanup;</span>
          }
      }
  
      (*env)-&gt;GetByteArrayRegion(env, jIn, jInOfs, jInLen, (jbyte *)bufP);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
  
<span class="line-added">+     ckDigestLength = min(MAX_DIGEST_LEN, jDigestLen);</span>
<span class="line-added">+ </span>
      rv = (*ckpFunctions-&gt;C_Digest)(ckSessionHandle, bufP, jInLen, DIGESTBUF, &amp;ckDigestLength);
      if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
          (*env)-&gt;SetByteArrayRegion(env, jDigest, jDigestOfs, ckDigestLength, (jbyte *)DIGESTBUF);
      }
<span class="line-modified">! cleanup:</span>
<span class="line-added">+     freeCKMechanismPtr(ckpMechanism);</span>
      if (bufP != BUF) { free(bufP); }
  
      return ckDigestLength;
  }
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 163,11 ***</span>
   * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
   * @param   jbyteArray jData            CK_BYTE_PTR pData
   *                                      CK_ULONG ulDataLen
   */
  JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestUpdate
<span class="line-modified">!   (JNIEnv *env, jobject obj, jlong jSessionHandle, jlong directIn, jbyteArray jIn, jint jInOfs, jint jInLen)</span>
  {
      CK_SESSION_HANDLE ckSessionHandle;
      CK_RV rv;
      CK_BYTE_PTR bufP;
      CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
<span class="line-new-header">--- 158,12 ---</span>
   * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
   * @param   jbyteArray jData            CK_BYTE_PTR pData
   *                                      CK_ULONG ulDataLen
   */
  JNIEXPORT void JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestUpdate
<span class="line-modified">!     (JNIEnv *env, jobject obj, jlong jSessionHandle, jlong directIn, jbyteArray jIn,</span>
<span class="line-added">+      jint jInOfs, jint jInLen)</span>
  {
      CK_SESSION_HANDLE ckSessionHandle;
      CK_RV rv;
      CK_BYTE_PTR bufP;
      CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
</pre>
<hr />
<pre>
<span class="line-old-header">*** 254,11 ***</span>
   * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
   * @return  jbyteArray jDigest          CK_BYTE_PTR pDigest
   *                                      CK_ULONG_PTR pulDigestLen
   */
  JNIEXPORT jint JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestFinal
<span class="line-modified">!   (JNIEnv *env, jobject obj, jlong jSessionHandle, jbyteArray jDigest, jint jDigestOfs, jint jDigestLen)</span>
  {
      CK_SESSION_HANDLE ckSessionHandle;
      CK_RV rv;
      CK_BYTE BUF[MAX_DIGEST_LEN];
      CK_ULONG ckDigestLength = min(MAX_DIGEST_LEN, jDigestLen);
<span class="line-new-header">--- 250,12 ---</span>
   * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
   * @return  jbyteArray jDigest          CK_BYTE_PTR pDigest
   *                                      CK_ULONG_PTR pulDigestLen
   */
  JNIEXPORT jint JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DigestFinal
<span class="line-modified">!     (JNIEnv *env, jobject obj, jlong jSessionHandle, jbyteArray jDigest,</span>
<span class="line-added">+      jint jDigestOfs, jint jDigestLen)</span>
  {
      CK_SESSION_HANDLE ckSessionHandle;
      CK_RV rv;
      CK_BYTE BUF[MAX_DIGEST_LEN];
      CK_ULONG ckDigestLength = min(MAX_DIGEST_LEN, jDigestLen);
</pre>
<center><a href="p11_crypt.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_general.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>