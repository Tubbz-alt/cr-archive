<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_convert.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../legal/pkcs11cryptotoken.md.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_crypt.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_convert.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   3  */
   4 
   5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
   6  *
   7  * Redistribution and use in  source and binary forms, with or without
   8  * modification, are permitted  provided that the following conditions are met:
   9  *
  10  * 1. Redistributions of  source code must retain the above copyright notice,
  11  *    this list of conditions and the following disclaimer.
  12  *
  13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
  14  *    this list of conditions and the following disclaimer in the documentation
  15  *    and/or other materials provided with the distribution.
  16  *
  17  * 3. The end-user documentation included with the redistribution, if any, must
  18  *    include the following acknowledgment:
  19  *
  20  *    &quot;This product includes software developed by IAIK of Graz University of
  21  *     Technology.&quot;
  22  *
</pre>
<hr />
<pre>
  51  *
  52  * This is the implementation of the native functions of the Java to PKCS#11 interface.
  53  * All function use some helper functions to convert the JNI types to PKCS#11 types.
  54  *
  55  * @author Karl Scheibelhofer &lt;Karl.Scheibelhofer@iaik.at&gt;
  56  * @author Martin Schlaeffer &lt;schlaeff@sbox.tugraz.at&gt;
  57  */
  58 
  59 
  60 #include &quot;pkcs11wrapper.h&quot;
  61 
  62 #include &lt;stdio.h&gt;
  63 #include &lt;stdlib.h&gt;
  64 #include &lt;string.h&gt;
  65 #include &lt;assert.h&gt;
  66 
  67 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
  68 
  69 /* declare file private functions */
  70 
<span class="line-modified">  71 void jMechanismParameterToCKMechanismParameterSlow(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength);</span>

  72 
  73 
  74 /*
<span class="line-modified">  75  * converts a pointer to a CK_DATE structure into a Java CK_DATE Object.</span>
  76  *
  77  * @param env - used to call JNI funktions to create the new Java object
  78  * @param ckpValue - the pointer to the CK_DATE structure
  79  * @return - the new Java CK_DATE object
  80  */
  81 jobject ckDatePtrToJDateObject(JNIEnv *env, const CK_DATE *ckpDate)
  82 {
  83     jclass jDateClass;
  84     jmethodID jCtrId;
  85     jobject jDateObject;
  86     jcharArray jYear;
  87     jcharArray jMonth;
  88     jcharArray jDay;
  89 
  90     /* load CK_DATE class */
  91     jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
  92     if (jDateClass == NULL) { return NULL; }
  93 
  94     /* load CK_DATE constructor */
  95     jCtrId = (*env)-&gt;GetMethodID(env, jDateClass, &quot;&lt;init&gt;&quot;, &quot;([C[C[C)V&quot;);
</pre>
<hr />
<pre>
 101     jMonth = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;month), 2);
 102     if (jMonth == NULL) { return NULL; }
 103     jDay = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;day), 2);
 104     if (jDay == NULL) { return NULL; }
 105 
 106     /* create new CK_DATE object */
 107     jDateObject =
 108       (*env)-&gt;NewObject(env, jDateClass, jCtrId, jYear, jMonth, jDay);
 109     if (jDateObject == NULL) { return NULL; }
 110 
 111     /* free local references */
 112     (*env)-&gt;DeleteLocalRef(env, jDateClass);
 113     (*env)-&gt;DeleteLocalRef(env, jYear);
 114     (*env)-&gt;DeleteLocalRef(env, jMonth);
 115     (*env)-&gt;DeleteLocalRef(env, jDay);
 116 
 117     return jDateObject ;
 118 }
 119 
 120 /*
<span class="line-modified"> 121  * converts a pointer to a CK_VERSION structure into a Java CK_VERSION Object.</span>
 122  *
 123  * @param env - used to call JNI funktions to create the new Java object
 124  * @param ckpVersion - the pointer to the CK_VERSION structure
<span class="line-modified"> 125  * @return - the new Java CK_VERSION object</span>
 126  */
 127 jobject ckVersionPtrToJVersion(JNIEnv *env, const CK_VERSION_PTR ckpVersion)
 128 {
 129     jclass jVersionClass;
 130     jmethodID jCtrId;
 131     jobject jVersionObject;
 132     jint jMajor;
 133     jint jMinor;
 134 
 135     /* load CK_VERSION class */
 136     jVersionClass = (*env)-&gt;FindClass(env, CLASS_VERSION);
 137     if (jVersionClass == NULL) { return NULL; }
 138 
 139     /* load CK_VERSION constructor */
 140     jCtrId = (*env)-&gt;GetMethodID(env, jVersionClass, &quot;&lt;init&gt;&quot;, &quot;(II)V&quot;);
 141     if (jCtrId == NULL) { return NULL; }
 142 
 143     /* prep both fields */
 144     jMajor = ckpVersion-&gt;major;
 145     jMinor = ckpVersion-&gt;minor;
 146 
 147     /* create new CK_VERSION object */
 148     jVersionObject =
 149       (*env)-&gt;NewObject(env, jVersionClass, jCtrId, jMajor, jMinor);
 150     if (jVersionObject == NULL) { return NULL; }
 151 
 152     /* free local references */
 153     (*env)-&gt;DeleteLocalRef(env, jVersionClass);
 154 
 155     return jVersionObject ;
 156 }
 157 
 158 /*
<span class="line-modified"> 159  * converts a pointer to a CK_SESSION_INFO structure into a Java CK_SESSION_INFO Object.</span>
 160  *
 161  * @param env - used to call JNI funktions to create the new Java object
 162  * @param ckpSessionInfo - the pointer to the CK_SESSION_INFO structure
<span class="line-modified"> 163  * @return - the new Java CK_SESSION_INFO object</span>
 164  */
 165 jobject ckSessionInfoPtrToJSessionInfo(JNIEnv *env, const CK_SESSION_INFO_PTR ckpSessionInfo)
 166 {
 167     jclass jSessionInfoClass;
 168     jmethodID jCtrId;
 169     jobject jSessionInfoObject;
 170     jlong jSlotID;
 171     jlong jState;
 172     jlong jFlags;
 173     jlong jDeviceError;
 174 
 175     /* load CK_SESSION_INFO class */
 176     jSessionInfoClass = (*env)-&gt;FindClass(env, CLASS_SESSION_INFO);
 177     if (jSessionInfoClass == NULL) { return NULL; }
 178 
 179     /* load CK_SESSION_INFO constructor */
 180     jCtrId = (*env)-&gt;GetMethodID(env, jSessionInfoClass, &quot;&lt;init&gt;&quot;, &quot;(JJJJ)V&quot;);
 181     if (jCtrId == NULL) { return NULL; }
 182 
 183     /* prep all fields */
 184     jSlotID = ckULongToJLong(ckpSessionInfo-&gt;slotID);
 185     jState = ckULongToJLong(ckpSessionInfo-&gt;state);
 186     jFlags = ckULongToJLong(ckpSessionInfo-&gt;flags);
 187     jDeviceError = ckULongToJLong(ckpSessionInfo-&gt;ulDeviceError);
 188 
 189     /* create new CK_SESSION_INFO object */
 190     jSessionInfoObject =
 191       (*env)-&gt;NewObject(env, jSessionInfoClass, jCtrId, jSlotID, jState,
 192                         jFlags, jDeviceError);
 193     if (jSessionInfoObject == NULL) { return NULL; }
 194 
 195     /* free local references */
 196     (*env)-&gt;DeleteLocalRef(env, jSessionInfoClass);
 197 
 198     return jSessionInfoObject ;
 199 }
 200 
 201 /*
<span class="line-modified"> 202  * converts a pointer to a CK_ATTRIBUTE structure into a Java CK_ATTRIBUTE Object.</span>
 203  *
 204  * @param env - used to call JNI funktions to create the new Java object
 205  * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure
<span class="line-modified"> 206  * @return - the new Java CK_ATTRIBUTE object</span>
 207  */
 208 jobject ckAttributePtrToJAttribute(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
 209 {
 210     jclass jAttributeClass;
 211     jmethodID jCtrId;
 212     jobject jAttributeObject;
 213     jlong jType;
 214     jobject jPValue = NULL;
 215 
 216     jAttributeClass = (*env)-&gt;FindClass(env, CLASS_ATTRIBUTE);
 217     if (jAttributeClass == NULL) { return NULL; }
 218 
 219     /* load CK_INFO constructor */
 220     jCtrId = (*env)-&gt;GetMethodID(env, jAttributeClass, &quot;&lt;init&gt;&quot;, &quot;(JLjava/lang/Object;)V&quot;);
 221     if (jCtrId == NULL) { return NULL; }
 222 
 223     /* prep both fields */
 224     jType = ckULongToJLong(ckpAttribute-&gt;type);
 225     jPValue = ckAttributeValueToJObject(env, ckpAttribute);
 226     if ((*env)-&gt;ExceptionCheck(env)) { return NULL; }
 227 
 228     /* create new CK_ATTRIBUTE object */
 229     jAttributeObject =
 230       (*env)-&gt;NewObject(env, jAttributeClass, jCtrId, jType, jPValue);
 231     if (jAttributeObject == NULL) { return NULL; }
 232 
 233     /* free local references */
 234     (*env)-&gt;DeleteLocalRef(env, jAttributeClass);
 235     (*env)-&gt;DeleteLocalRef(env, jPValue);
 236 
 237     return jAttributeObject;
 238 }
 239 
 240 
 241 /*
<span class="line-modified"> 242  * converts a Java CK_VERSION object into a pointer to a CK_VERSION structure</span>
 243  *
 244  * @param env - used to call JNI funktions to get the values out of the Java object
 245  * @param jVersion - the Java CK_VERSION object to convert
<span class="line-modified"> 246  * @return - the pointer to the new CK_VERSION structure</span>
 247  */
<span class="line-modified"> 248 CK_VERSION_PTR jVersionToCKVersionPtr(JNIEnv *env, jobject jVersion)</span>

 249 {
 250     CK_VERSION_PTR ckpVersion;
 251     jclass jVersionClass;
 252     jfieldID jFieldID;
 253     jbyte jMajor, jMinor;
 254 
 255     if (jVersion == NULL) {
 256         return NULL;
 257     }
 258 
<span class="line-modified"> 259     /* get CK_VERSION class */</span>
 260     jVersionClass = (*env)-&gt;GetObjectClass(env, jVersion);
 261     if (jVersionClass == NULL) { return NULL; }
<span class="line-removed"> 262 </span>
<span class="line-removed"> 263     /* get Major */</span>
 264     jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;major&quot;, &quot;B&quot;);
 265     if (jFieldID == NULL) { return NULL; }
 266     jMajor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
<span class="line-removed"> 267 </span>
<span class="line-removed"> 268     /* get Minor */</span>
 269     jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;minor&quot;, &quot;B&quot;);
 270     if (jFieldID == NULL) { return NULL; }
 271     jMinor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
 272 
<span class="line-modified"> 273     /* allocate memory for CK_VERSION pointer */</span>
<span class="line-modified"> 274     ckpVersion = (CK_VERSION_PTR) malloc(sizeof(CK_VERSION));</span>
 275     if (ckpVersion == NULL) {
 276         throwOutOfMemoryError(env, 0);
 277         return NULL;
 278     }


 279     ckpVersion-&gt;major = jByteToCKByte(jMajor);
 280     ckpVersion-&gt;minor = jByteToCKByte(jMinor);
 281 
<span class="line-modified"> 282     return ckpVersion ;</span>
 283 }
 284 
 285 
 286 /*
<span class="line-modified"> 287  * converts a Java CK_DATE object into a pointer to a CK_DATE structure</span>
 288  *
<span class="line-modified"> 289  * @param env - used to call JNI funktions to get the values out of the Java object</span>
<span class="line-modified"> 290  * @param jVersion - the Java CK_DATE object to convert</span>
<span class="line-modified"> 291  * @return - the pointer to the new CK_DATE structure</span>
 292  */
<span class="line-modified"> 293 CK_DATE * jDateObjectPtrToCKDatePtr(JNIEnv *env, jobject jDate)</span>
 294 {
<span class="line-modified"> 295     CK_DATE * ckpDate;</span>
 296     CK_ULONG ckLength;
 297     jclass jDateClass;
 298     jfieldID jFieldID;
 299     jobject jYear, jMonth, jDay;
<span class="line-modified"> 300     jchar *jTempChars;</span>
 301     CK_ULONG i;
 302 
 303     if (jDate == NULL) {
 304         return NULL;
 305     }
 306 
<span class="line-modified"> 307     /* get CK_DATE class */</span>
 308     jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
 309     if (jDateClass == NULL) { return NULL; }
<span class="line-removed"> 310 </span>
<span class="line-removed"> 311     /* get Year */</span>
 312     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;year&quot;, &quot;[C&quot;);
 313     if (jFieldID == NULL) { return NULL; }
 314     jYear = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
<span class="line-removed"> 315 </span>
<span class="line-removed"> 316     /* get Month */</span>
 317     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;month&quot;, &quot;[C&quot;);
 318     if (jFieldID == NULL) { return NULL; }
 319     jMonth = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
<span class="line-removed"> 320 </span>
<span class="line-removed"> 321     /* get Day */</span>
 322     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;day&quot;, &quot;[C&quot;);
 323     if (jFieldID == NULL) { return NULL; }
 324     jDay = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
 325 
<span class="line-modified"> 326     /* allocate memory for CK_DATE pointer */</span>
<span class="line-modified"> 327     ckpDate = (CK_DATE *) malloc(sizeof(CK_DATE));</span>
 328     if (ckpDate == NULL) {
 329         throwOutOfMemoryError(env, 0);
 330         return NULL;
 331     }
 332 

 333     if (jYear == NULL) {
 334         ckpDate-&gt;year[0] = 0;
 335         ckpDate-&gt;year[1] = 0;
 336         ckpDate-&gt;year[2] = 0;
 337         ckpDate-&gt;year[3] = 0;
 338     } else {
 339         ckLength = (*env)-&gt;GetArrayLength(env, jYear);
<span class="line-modified"> 340         jTempChars = (jchar*) malloc((ckLength) * sizeof(jchar));</span>
 341         if (jTempChars == NULL) {
<span class="line-removed"> 342             free(ckpDate);</span>
 343             throwOutOfMemoryError(env, 0);
<span class="line-modified"> 344             return NULL;</span>
 345         }
 346         (*env)-&gt;GetCharArrayRegion(env, jYear, 0, ckLength, jTempChars);
 347         if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 348             free(ckpDate);</span>
<span class="line-removed"> 349             free(jTempChars);</span>
<span class="line-removed"> 350             return NULL;</span>
 351         }
 352 
 353         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 4) ; i++) {
 354             ckpDate-&gt;year[i] = jCharToCKChar(jTempChars[i]);
 355         }
 356         free(jTempChars);
 357     }
 358 
 359     if (jMonth == NULL) {
 360         ckpDate-&gt;month[0] = 0;
 361         ckpDate-&gt;month[1] = 0;
 362     } else {
 363         ckLength = (*env)-&gt;GetArrayLength(env, jMonth);
<span class="line-modified"> 364         jTempChars = (jchar*) malloc((ckLength) * sizeof(jchar));</span>
 365         if (jTempChars == NULL) {
<span class="line-removed"> 366             free(ckpDate);</span>
 367             throwOutOfMemoryError(env, 0);
<span class="line-modified"> 368             return NULL;</span>
 369         }
 370         (*env)-&gt;GetCharArrayRegion(env, jMonth, 0, ckLength, jTempChars);
 371         if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 372             free(ckpDate);</span>
<span class="line-removed"> 373             free(jTempChars);</span>
<span class="line-removed"> 374             return NULL;</span>
 375         }
 376 
 377         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
 378             ckpDate-&gt;month[i] = jCharToCKChar(jTempChars[i]);
 379         }
 380         free(jTempChars);
 381     }
 382 
 383     if (jDay == NULL) {
 384         ckpDate-&gt;day[0] = 0;
 385         ckpDate-&gt;day[1] = 0;
 386     } else {
 387         ckLength = (*env)-&gt;GetArrayLength(env, jDay);
<span class="line-modified"> 388         jTempChars = (jchar*) malloc((ckLength) * sizeof(jchar));</span>
 389         if (jTempChars == NULL) {
<span class="line-removed"> 390             free(ckpDate);</span>
 391             throwOutOfMemoryError(env, 0);
<span class="line-modified"> 392             return NULL;</span>
 393         }
 394         (*env)-&gt;GetCharArrayRegion(env, jDay, 0, ckLength, jTempChars);
 395         if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 396             free(ckpDate);</span>
<span class="line-removed"> 397             free(jTempChars);</span>
<span class="line-removed"> 398             return NULL;</span>
 399         }
 400 
 401         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
 402             ckpDate-&gt;day[i] = jCharToCKChar(jTempChars[i]);
 403         }
 404         free(jTempChars);
 405     }
 406 
<span class="line-modified"> 407     return ckpDate ;</span>




 408 }
 409 
 410 
 411 /*
 412  * converts a Java CK_ATTRIBUTE object into a CK_ATTRIBUTE structure
 413  *
 414  * @param env - used to call JNI funktions to get the values out of the Java object
 415  * @param jAttribute - the Java CK_ATTRIBUTE object to convert
<span class="line-modified"> 416  * @return - the new CK_ATTRIBUTE structure</span>
 417  */
 418 CK_ATTRIBUTE jAttributeToCKAttribute(JNIEnv *env, jobject jAttribute)
 419 {
 420     CK_ATTRIBUTE ckAttribute;
 421     jclass jAttributeClass;
 422     jfieldID jFieldID;
 423     jlong jType;
 424     jobject jPValue;

 425     memset(&amp;ckAttribute, 0, sizeof(CK_ATTRIBUTE));
 426 
 427     // TBD: what if jAttribute == NULL?!
<span class="line-removed"> 428 </span>
 429     TRACE0(&quot;\nDEBUG: jAttributeToCKAttribute&quot;);

 430     /* get CK_ATTRIBUTE class */
 431     TRACE0(&quot;, getting attribute object class&quot;);
 432     jAttributeClass = (*env)-&gt;GetObjectClass(env, jAttribute);
 433     if (jAttributeClass == NULL) { return ckAttribute; }
 434 
 435     /* get type */
 436     TRACE0(&quot;, getting type field&quot;);
 437     jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;type&quot;, &quot;J&quot;);
 438     if (jFieldID == NULL) { return ckAttribute; }
 439     jType = (*env)-&gt;GetLongField(env, jAttribute, jFieldID);
<span class="line-modified"> 440     TRACE1(&quot;, type=0x%X&quot;, jType);</span>
 441 
 442     /* get pValue */
 443     TRACE0(&quot;, getting pValue field&quot;);
 444     jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;pValue&quot;, &quot;Ljava/lang/Object;&quot;);
 445     if (jFieldID == NULL) { return ckAttribute; }
 446     jPValue = (*env)-&gt;GetObjectField(env, jAttribute, jFieldID);
 447     TRACE1(&quot;, pValue=%p&quot;, jPValue);
 448 
 449     ckAttribute.type = jLongToCKULong(jType);
 450     TRACE0(&quot;, converting pValue to primitive object&quot;);
 451 
 452     /* convert the Java pValue object to a CK-type pValue pointer */
<span class="line-modified"> 453     jObjectToPrimitiveCKObjectPtrPtr(env, jPValue, &amp;(ckAttribute.pValue), &amp;(ckAttribute.ulValueLen));</span>
 454 
<span class="line-modified"> 455     TRACE0(&quot;\nFINISHED\n&quot;);</span>
 456 
 457     return ckAttribute ;
 458 }
 459 
 460 void masterKeyDeriveParamToCKMasterKeyDeriveParam(JNIEnv *env, jobject jParam,
 461         jclass masterKeyDeriveParamClass,
 462         CK_VERSION_PTR* cKMasterKeyDeriveParamVersion,
 463         CK_SSL3_RANDOM_DATA* cKMasterKeyDeriveParamRandomInfo) {
 464     jfieldID fieldID;
 465     jclass jSsl3RandomDataClass;
 466     jobject jRandomInfo, jRIClientRandom, jRIServerRandom, jVersion;
 467 
<span class="line-modified"> 468     /* get RandomInfo */</span>
 469     fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;RandomInfo&quot;,
 470             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
 471     if (fieldID == NULL) { return; }
 472     jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed"> 473 </span>
<span class="line-removed"> 474     /* get pClientRandom and ulClientRandomLength out of RandomInfo */</span>
 475     jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
 476     if (jSsl3RandomDataClass == NULL) { return; }
 477     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
 478     if (fieldID == NULL) { return; }
 479     jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<span class="line-removed"> 480 </span>
<span class="line-removed"> 481     /* get pServerRandom and ulServerRandomLength out of RandomInfo */</span>
 482     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
 483     if (fieldID == NULL) { return; }
 484     jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<span class="line-removed"> 485 </span>
<span class="line-removed"> 486     /* get pVersion */</span>
 487     fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;pVersion&quot;,
 488             &quot;Lsun/security/pkcs11/wrapper/CK_VERSION;&quot;);
 489     if (fieldID == NULL) { return; }
 490     jVersion = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 491 
<span class="line-modified"> 492     /* populate java values */</span>
 493     *cKMasterKeyDeriveParamVersion = jVersionToCKVersionPtr(env, jVersion);
 494     if ((*env)-&gt;ExceptionCheck(env)) { return; }
 495     jByteArrayToCKByteArray(env, jRIClientRandom,
 496             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom),
 497             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulClientRandomLen));
 498     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 499         free(*cKMasterKeyDeriveParamVersion);</span>
<span class="line-removed"> 500         return;</span>
 501     }
 502     jByteArrayToCKByteArray(env, jRIServerRandom,
 503             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom),
 504             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulServerRandomLen));
 505     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 506         free(*cKMasterKeyDeriveParamVersion);</span>
<span class="line-removed"> 507         free(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 508         return;</span>
 509     }











 510 }
 511 
 512 /*
 513  * converts the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to a
<span class="line-modified"> 514  * CK_SSL3_MASTER_KEY_DERIVE_PARAMS structure</span>
 515  *
 516  * @param env - used to call JNI functions to get the Java classes and objects
 517  * @param jParam - the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to convert
<span class="line-modified"> 518  * @return - the new CK_SSL3_MASTER_KEY_DERIVE_PARAMS structure</span>

 519  */
<span class="line-modified"> 520 CK_SSL3_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-modified"> 521 jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParam(JNIEnv *env,</span>
<span class="line-modified"> 522         jobject jParam)</span>
 523 {
<span class="line-modified"> 524     CK_SSL3_MASTER_KEY_DERIVE_PARAMS ckParam;</span>
 525     jclass jSsl3MasterKeyDeriveParamsClass;
<span class="line-modified"> 526     memset(&amp;ckParam, 0, sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS));</span>












 527     jSsl3MasterKeyDeriveParamsClass =
 528             (*env)-&gt;FindClass(env, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);
<span class="line-modified"> 529     if (jSsl3MasterKeyDeriveParamsClass == NULL) { return ckParam; }</span>


 530     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,
 531             jSsl3MasterKeyDeriveParamsClass,
<span class="line-modified"> 532             &amp;ckParam.pVersion, &amp;ckParam.RandomInfo);</span>
<span class="line-modified"> 533     return ckParam;</span>










 534 }
 535 
 536 /*
 537  * converts the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to a
<span class="line-modified"> 538  * CK_TLS12_MASTER_KEY_DERIVE_PARAMS structure</span>
 539  *
 540  * @param env - used to call JNI functions to get the Java classes and objects
 541  * @param jParam - the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to convert
<span class="line-modified"> 542  * @return - the new CK_TLS12_MASTER_KEY_DERIVE_PARAMS structure</span>

 543  */
<span class="line-modified"> 544 CK_TLS12_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-modified"> 545 jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParam(JNIEnv *env,</span>
<span class="line-modified"> 546         jobject jParam)</span>
 547 {
<span class="line-modified"> 548     CK_TLS12_MASTER_KEY_DERIVE_PARAMS ckParam;</span>
 549     jclass jTls12MasterKeyDeriveParamsClass;
 550     jfieldID fieldID;
<span class="line-modified"> 551     memset(&amp;ckParam, 0, sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS));</span>






 552     jTls12MasterKeyDeriveParamsClass =
<span class="line-modified"> 553             (*env)-&gt;FindClass(env, CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified"> 554     if (jTls12MasterKeyDeriveParamsClass == NULL) { return ckParam; }</span>
<span class="line-removed"> 555     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,</span>
<span class="line-removed"> 556             jTls12MasterKeyDeriveParamsClass, &amp;ckParam.pVersion,</span>
<span class="line-removed"> 557             &amp;ckParam.RandomInfo);</span>
 558     fieldID = (*env)-&gt;GetFieldID(env,
 559             jTls12MasterKeyDeriveParamsClass, &quot;prfHashMechanism&quot;, &quot;J&quot;);
<span class="line-modified"> 560     if (fieldID != NULL) {</span>
<span class="line-modified"> 561         jlong prfHashMechanism =</span>
<span class="line-modified"> 562                 (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified"> 563         ckParam.prfHashMechanism = (CK_MECHANISM_TYPE)prfHashMechanism;</span>




 564     }
<span class="line-modified"> 565     return ckParam;</span>

















 566 }
 567 
 568 /*
<span class="line-modified"> 569  * converts the Java CK_TLS_PRF_PARAMS object to a CK_TLS_PRF_PARAMS structure</span>





 570  */
<span class="line-modified"> 571 CK_TLS_PRF_PARAMS jTlsPrfParamsToCKTlsPrfParam(JNIEnv *env, jobject jParam)</span>

 572 {

 573     jclass jTlsPrfParamsClass;
<span class="line-removed"> 574     CK_TLS_PRF_PARAMS ckParam;</span>
 575     jfieldID fieldID;
 576     jobject jSeed, jLabel, jOutput;
<span class="line-removed"> 577     memset(&amp;ckParam, 0, sizeof(CK_TLS_PRF_PARAMS));</span>
 578 
<span class="line-modified"> 579     // TBD: what if jParam == NULL?!</span>


 580 
<span class="line-modified"> 581     /* get pSeed */</span>
 582     jTlsPrfParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_PRF_PARAMS);
<span class="line-modified"> 583     if (jTlsPrfParamsClass == NULL) { return ckParam; }</span>
 584     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pSeed&quot;, &quot;[B&quot;);
<span class="line-modified"> 585     if (fieldID == NULL) { return ckParam; }</span>
 586     jSeed = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed"> 587 </span>
<span class="line-removed"> 588     /* get pLabel */</span>
 589     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pLabel&quot;, &quot;[B&quot;);
<span class="line-modified"> 590     if (fieldID == NULL) { return ckParam; }</span>
 591     jLabel = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed"> 592 </span>
<span class="line-removed"> 593     /* get pOutput */</span>
 594     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pOutput&quot;, &quot;[B&quot;);
<span class="line-modified"> 595     if (fieldID == NULL) { return ckParam; }</span>
 596     jOutput = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 597 
<span class="line-modified"> 598     /* populate java values */</span>
<span class="line-modified"> 599     jByteArrayToCKByteArray(env, jSeed, &amp;(ckParam.pSeed), &amp;(ckParam.ulSeedLen));</span>
<span class="line-modified"> 600     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified"> 601     jByteArrayToCKByteArray(env, jLabel, &amp;(ckParam.pLabel), &amp;(ckParam.ulLabelLen));</span>





 602     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 603         free(ckParam.pSeed);</span>
<span class="line-removed"> 604         return ckParam;</span>
 605     }
<span class="line-modified"> 606     ckParam.pulOutputLen = malloc(sizeof(CK_ULONG));</span>
<span class="line-modified"> 607     if (ckParam.pulOutputLen == NULL) {</span>
<span class="line-modified"> 608         free(ckParam.pSeed);</span>
<span class="line-removed"> 609         free(ckParam.pLabel);</span>
<span class="line-removed"> 610         throwOutOfMemoryError(env, 0);</span>
<span class="line-removed"> 611         return ckParam;</span>
 612     }
<span class="line-modified"> 613     jByteArrayToCKByteArray(env, jOutput, &amp;(ckParam.pOutput), ckParam.pulOutputLen);</span>




 614     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 615         free(ckParam.pSeed);</span>
<span class="line-removed"> 616         free(ckParam.pLabel);</span>
<span class="line-removed"> 617         free(ckParam.pulOutputLen);</span>
<span class="line-removed"> 618         return ckParam;</span>
 619     }
 620 
<span class="line-modified"> 621     return ckParam ;</span>










 622 }
 623 
 624 /*
<span class="line-modified"> 625  * converts the Java CK_TLS_MAC_PARAMS object to a CK_TLS_MAC_PARAMS structure</span>





 626  */
<span class="line-modified"> 627 CK_TLS_MAC_PARAMS jTlsMacParamsToCKTlsMacParam(JNIEnv *env, jobject jParam)</span>


 628 {

 629     jclass jTlsMacParamsClass;
<span class="line-removed"> 630     CK_TLS_MAC_PARAMS ckParam;</span>
 631     jfieldID fieldID;
 632     jlong jPrfMechanism, jUlMacLength, jUlServerOrClient;
<span class="line-removed"> 633     memset(&amp;ckParam, 0, sizeof(CK_TLS_MAC_PARAMS));</span>
 634 
<span class="line-modified"> 635     jTlsMacParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_MAC_PARAMS);</span>
<span class="line-modified"> 636     if (jTlsMacParamsClass == NULL) { return ckParam; }</span>

 637 
<span class="line-modified"> 638     /* get prfMechanism */</span>


 639     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;prfMechanism&quot;, &quot;J&quot;);
<span class="line-modified"> 640     if (fieldID == NULL) { return ckParam; }</span>
 641     jPrfMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed"> 642 </span>
<span class="line-removed"> 643     /* get ulMacLength */</span>
 644     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulMacLength&quot;, &quot;J&quot;);
<span class="line-modified"> 645     if (fieldID == NULL) { return ckParam; }</span>
 646     jUlMacLength = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed"> 647 </span>
<span class="line-removed"> 648     /* get ulServerOrClient */</span>
 649     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulServerOrClient&quot;, &quot;J&quot;);
<span class="line-modified"> 650     if (fieldID == NULL) { return ckParam; }</span>
 651     jUlServerOrClient = (*env)-&gt;GetLongField(env, jParam, fieldID);
 652 
<span class="line-modified"> 653     /* populate java values */</span>
<span class="line-modified"> 654     ckParam.prfMechanism = jLongToCKULong(jPrfMechanism);</span>
<span class="line-modified"> 655     ckParam.ulMacLength = jLongToCKULong(jUlMacLength);</span>
<span class="line-modified"> 656     ckParam.ulServerOrClient = jLongToCKULong(jUlServerOrClient);</span>







 657 
<span class="line-modified"> 658     return ckParam;</span>



 659 }
 660 
 661 void keyMatParamToCKKeyMatParam(JNIEnv *env, jobject jParam,
 662         jclass jKeyMatParamClass,
 663         CK_ULONG* cKKeyMatParamUlMacSizeInBits,
 664         CK_ULONG* cKKeyMatParamUlKeySizeInBits,
 665         CK_ULONG* cKKeyMatParamUlIVSizeInBits,
 666         CK_BBOOL* cKKeyMatParamBIsExport,
 667         CK_SSL3_RANDOM_DATA* cKKeyMatParamRandomInfo,
 668         CK_SSL3_KEY_MAT_OUT_PTR* cKKeyMatParamPReturnedKeyMaterial)
 669 {
 670     jclass jSsl3RandomDataClass, jSsl3KeyMatOutClass;
 671     jfieldID fieldID;
 672     jlong jMacSizeInBits, jKeySizeInBits, jIVSizeInBits;
 673     jboolean jIsExport;
 674     jobject jRandomInfo, jRIClientRandom, jRIServerRandom;
 675     jobject jReturnedKeyMaterial, jRMIvClient, jRMIvServer;
 676     CK_ULONG ckTemp;
 677 
<span class="line-modified"> 678     /* get ulMacSizeInBits */</span>


 679     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulMacSizeInBits&quot;, &quot;J&quot;);
 680     if (fieldID == NULL) { return; }
 681     jMacSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed"> 682 </span>
<span class="line-removed"> 683     /* get ulKeySizeInBits */</span>
 684     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulKeySizeInBits&quot;, &quot;J&quot;);
 685     if (fieldID == NULL) { return; }
 686     jKeySizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed"> 687 </span>
<span class="line-removed"> 688     /* get ulIVSizeInBits */</span>
 689     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulIVSizeInBits&quot;, &quot;J&quot;);
 690     if (fieldID == NULL) { return; }
 691     jIVSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed"> 692 </span>
<span class="line-removed"> 693     /* get bIsExport */</span>
 694     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;bIsExport&quot;, &quot;Z&quot;);
 695     if (fieldID == NULL) { return; }
 696     jIsExport = (*env)-&gt;GetBooleanField(env, jParam, fieldID);
<span class="line-removed"> 697 </span>
<span class="line-removed"> 698     /* get RandomInfo */</span>
 699     jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
 700     if (jSsl3RandomDataClass == NULL) { return; }
 701     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;RandomInfo&quot;,
 702             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
 703     if (fieldID == NULL) { return; }
 704     jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed"> 705 </span>
<span class="line-removed"> 706     /* get pClientRandom and ulClientRandomLength out of RandomInfo */</span>
 707     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
 708     if (fieldID == NULL) { return; }
 709     jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<span class="line-removed"> 710 </span>
<span class="line-removed"> 711     /* get pServerRandom and ulServerRandomLength out of RandomInfo */</span>
 712     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
 713     if (fieldID == NULL) { return; }
 714     jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<span class="line-removed"> 715 </span>
<span class="line-removed"> 716     /* get pReturnedKeyMaterial */</span>
 717     jSsl3KeyMatOutClass = (*env)-&gt;FindClass(env, CLASS_SSL3_KEY_MAT_OUT);
 718     if (jSsl3KeyMatOutClass == NULL) { return; }
 719     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;pReturnedKeyMaterial&quot;,
 720             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_OUT;&quot;);
 721     if (fieldID == NULL) { return; }
 722     jReturnedKeyMaterial = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed"> 723 </span>
<span class="line-removed"> 724     /* get pIVClient out of pReturnedKeyMaterial */</span>
 725     fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVClient&quot;, &quot;[B&quot;);
 726     if (fieldID == NULL) { return; }
 727     jRMIvClient = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
<span class="line-removed"> 728 </span>
<span class="line-removed"> 729     /* get pIVServer out of pReturnedKeyMaterial */</span>
 730     fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVServer&quot;, &quot;[B&quot;);
 731     if (fieldID == NULL) { return; }
 732     jRMIvServer = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
 733 
<span class="line-modified"> 734     /* populate java values */</span>
 735     *cKKeyMatParamUlMacSizeInBits = jLongToCKULong(jMacSizeInBits);
 736     *cKKeyMatParamUlKeySizeInBits = jLongToCKULong(jKeySizeInBits);
 737     *cKKeyMatParamUlIVSizeInBits = jLongToCKULong(jIVSizeInBits);
 738     *cKKeyMatParamBIsExport = jBooleanToCKBBool(jIsExport);
 739     jByteArrayToCKByteArray(env, jRIClientRandom,
 740             &amp;(cKKeyMatParamRandomInfo-&gt;pClientRandom),
 741             &amp;(cKKeyMatParamRandomInfo-&gt;ulClientRandomLen));
<span class="line-modified"> 742     if ((*env)-&gt;ExceptionCheck(env)) { return; }</span>



 743     jByteArrayToCKByteArray(env, jRIServerRandom,
 744             &amp;(cKKeyMatParamRandomInfo-&gt;pServerRandom),
 745             &amp;(cKKeyMatParamRandomInfo-&gt;ulServerRandomLen));
 746     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 747         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 748         return;</span>
 749     }
<span class="line-modified"> 750     /* allocate memory for pRetrunedKeyMaterial */</span>
 751     *cKKeyMatParamPReturnedKeyMaterial =
<span class="line-modified"> 752             (CK_SSL3_KEY_MAT_OUT_PTR)malloc(sizeof(CK_SSL3_KEY_MAT_OUT));</span>
 753     if (*cKKeyMatParamPReturnedKeyMaterial == NULL) {
<span class="line-removed"> 754         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 755         free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
 756         throwOutOfMemoryError(env, 0);
<span class="line-modified"> 757         return;</span>
 758     }
 759 
 760     // the handles are output params only, no need to fetch them from Java
 761     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientMacSecret = 0;
 762     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerMacSecret = 0;
 763     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientKey = 0;
 764     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerKey = 0;
 765 
 766     jByteArrayToCKByteArray(env, jRMIvClient,
 767             &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient), &amp;ckTemp);
 768     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 769         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 770         free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-removed"> 771         free((*cKKeyMatParamPReturnedKeyMaterial));</span>
<span class="line-removed"> 772         return;</span>
 773     }
 774     jByteArrayToCKByteArray(env, jRMIvServer,
 775             &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVServer), &amp;ckTemp);
 776     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 777         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed"> 778         free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-removed"> 779         free((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient);</span>
<span class="line-removed"> 780         free((*cKKeyMatParamPReturnedKeyMaterial));</span>
<span class="line-removed"> 781         return;</span>
 782     }
 783 












 784     return;
 785 }
 786 /*
 787  * converts the Java CK_SSL3_KEY_MAT_PARAMS object to a
<span class="line-modified"> 788  * CK_SSL3_KEY_MAT_PARAMS structure</span>
 789  *
 790  * @param env - used to call JNI funktions to get the Java classes and objects
 791  * @param jParam - the Java CK_SSL3_KEY_MAT_PARAMS object to convert
<span class="line-modified"> 792  * @return - the new CK_SSL3_KEY_MAT_PARAMS structure</span>

 793  */
<span class="line-modified"> 794 CK_SSL3_KEY_MAT_PARAMS</span>
<span class="line-modified"> 795 jSsl3KeyMatParamToCKSsl3KeyMatParam(JNIEnv *env, jobject jParam)</span>
 796 {
<span class="line-modified"> 797     CK_SSL3_KEY_MAT_PARAMS ckParam;</span>
 798     jclass jSsl3KeyMatParamsClass;
<span class="line-modified"> 799     memset(&amp;ckParam, 0, sizeof(CK_SSL3_KEY_MAT_PARAMS));</span>












 800     jSsl3KeyMatParamsClass = (*env)-&gt;FindClass(env,
 801             CLASS_SSL3_KEY_MAT_PARAMS);
<span class="line-modified"> 802     if (jSsl3KeyMatParamsClass == NULL) { return ckParam; }</span>


 803     keyMatParamToCKKeyMatParam(env, jParam, jSsl3KeyMatParamsClass,
<span class="line-modified"> 804             &amp;ckParam.ulMacSizeInBits, &amp;ckParam.ulKeySizeInBits,</span>
<span class="line-modified"> 805             &amp;ckParam.ulIVSizeInBits, &amp;ckParam.bIsExport,</span>
<span class="line-modified"> 806             &amp;ckParam.RandomInfo, &amp;ckParam.pReturnedKeyMaterial);</span>
<span class="line-modified"> 807     return ckParam;</span>










 808 }
 809 
 810 /*
 811  * converts the Java CK_TLS12_KEY_MAT_PARAMS object to a
<span class="line-modified"> 812  * CK_TLS12_KEY_MAT_PARAMS structure</span>
 813  *
 814  * @param env - used to call JNI functions to get the Java classes and objects
 815  * @param jParam - the Java CK_TLS12_KEY_MAT_PARAMS object to convert
<span class="line-modified"> 816  * @return - the new CK_TLS12_KEY_MAT_PARAMS structure</span>

 817  */
<span class="line-modified"> 818 CK_TLS12_KEY_MAT_PARAMS jTls12KeyMatParamToCKTls12KeyMatParam(JNIEnv *env,</span>
<span class="line-modified"> 819         jobject jParam)</span>
 820 {
<span class="line-modified"> 821     CK_TLS12_KEY_MAT_PARAMS ckParam;</span>
 822     jclass jTls12KeyMatParamsClass;
 823     jfieldID fieldID;
<span class="line-modified"> 824     memset(&amp;ckParam, 0, sizeof(CK_TLS12_KEY_MAT_PARAMS));</span>






 825     jTls12KeyMatParamsClass = (*env)-&gt;FindClass(env,
 826             CLASS_TLS12_KEY_MAT_PARAMS);
<span class="line-modified"> 827     if (jTls12KeyMatParamsClass == NULL) { return ckParam; }</span>
<span class="line-removed"> 828     keyMatParamToCKKeyMatParam(env, jParam, jTls12KeyMatParamsClass,</span>
<span class="line-removed"> 829             &amp;ckParam.ulMacSizeInBits, &amp;ckParam.ulKeySizeInBits,</span>
<span class="line-removed"> 830             &amp;ckParam.ulIVSizeInBits, &amp;ckParam.bIsExport,</span>
<span class="line-removed"> 831             &amp;ckParam.RandomInfo, &amp;ckParam.pReturnedKeyMaterial);</span>
 832     fieldID = (*env)-&gt;GetFieldID(env, jTls12KeyMatParamsClass,
 833             &quot;prfHashMechanism&quot;, &quot;J&quot;);
<span class="line-modified"> 834     if (fieldID != NULL) {</span>
<span class="line-modified"> 835         jlong prfHashMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified"> 836         ckParam.prfHashMechanism = (CK_MECHANISM_TYPE)prfHashMechanism;</span>














 837     }
<span class="line-modified"> 838     return ckParam;</span>








 839 }
 840 
 841 /*
<span class="line-modified"> 842  * converts the Java CK_AES_CTR_PARAMS object to a CK_AES_CTR_PARAMS structure</span>
 843  *
 844  * @param env - used to call JNI funktions to get the Java classes and objects
 845  * @param jParam - the Java CK_AES_CTR_PARAMS object to convert
<span class="line-modified"> 846  * @param ckpParam - pointer to the new CK_AES_CTR_PARAMS structure</span>

 847  */
<span class="line-modified"> 848 void jAesCtrParamsToCKAesCtrParam(JNIEnv *env, jobject jParam,</span>
<span class="line-modified"> 849                                   CK_AES_CTR_PARAMS_PTR ckpParam) {</span>


 850     jclass jAesCtrParamsClass;
 851     jfieldID fieldID;
 852     jlong jCounterBits;
 853     jobject jCb;
<span class="line-modified"> 854     CK_BYTE_PTR ckBytes;</span>
 855     CK_ULONG ckTemp;
 856 
<span class="line-modified"> 857     /* get ulCounterBits */</span>




 858     jAesCtrParamsClass = (*env)-&gt;FindClass(env, CLASS_AES_CTR_PARAMS);
<span class="line-modified"> 859     if (jAesCtrParamsClass == NULL) { return; }</span>



 860     fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;ulCounterBits&quot;, &quot;J&quot;);
<span class="line-modified"> 861     if (fieldID == NULL) { return; }</span>
 862     jCounterBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed"> 863 </span>
<span class="line-removed"> 864     /* get cb */</span>
 865     fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;cb&quot;, &quot;[B&quot;);
<span class="line-modified"> 866     if (fieldID == NULL) { return; }</span>
 867     jCb = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 868 
<span class="line-modified"> 869     /* populate java values */</span>
<span class="line-modified"> 870     ckpParam-&gt;ulCounterBits = jLongToCKULong(jCounterBits);</span>






 871     jByteArrayToCKByteArray(env, jCb, &amp;ckBytes, &amp;ckTemp);
<span class="line-modified"> 872     if ((*env)-&gt;ExceptionCheck(env)) { return; }</span>
<span class="line-modified"> 873     if (ckTemp != 16) {</span>
<span class="line-modified"> 874         TRACE1(&quot;ERROR: WRONG CTR IV LENGTH %d&quot;, ckTemp);</span>
<span class="line-modified"> 875     } else {</span>
<span class="line-modified"> 876         memcpy(ckpParam-&gt;cb, ckBytes, ckTemp);</span>
<span class="line-modified"> 877         free(ckBytes);</span>




 878     }





 879 }
 880 
 881 /*
<span class="line-modified"> 882  * converts a Java CK_MECHANISM object into a CK_MECHANISM structure</span>

 883  *
<span class="line-modified"> 884  * @param env - used to call JNI funktions to get the values out of the Java object</span>
<span class="line-modified"> 885  * @param jMechanism - the Java CK_MECHANISM object to convert</span>
<span class="line-modified"> 886  * @return - the new CK_MECHANISM structure</span>

 887  */
<span class="line-modified"> 888 void jMechanismToCKMechanism(JNIEnv *env, jobject jMechanism, CK_MECHANISM_PTR ckMechanismPtr)</span>

 889 {
<span class="line-modified"> 890     jlong jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, mech_mechanismID);</span>
<span class="line-modified"> 891     jobject jParameter = (*env)-&gt;GetObjectField(env, jMechanism, mech_pParameterID);</span>



 892 
<span class="line-modified"> 893     (*ckMechanismPtr).mechanism = jLongToCKULong(jMechanismType);</span>
 894 
<span class="line-modified"> 895     /* convert the specific Java mechanism parameter object to a pointer to a CK-type mechanism</span>
<span class="line-modified"> 896      * structure</span>
<span class="line-modified"> 897      */</span>
<span class="line-modified"> 898     if (jParameter == NULL) {</span>
<span class="line-modified"> 899         (*ckMechanismPtr).pParameter = NULL;</span>
<span class="line-modified"> 900         (*ckMechanismPtr).ulParameterLen = 0;</span>
<span class="line-modified"> 901     } else {</span>
<span class="line-modified"> 902         jMechanismParameterToCKMechanismParameter(env, jParameter, &amp;(*ckMechanismPtr).pParameter, &amp;(*ckMechanismPtr).ulParameterLen);</span>


































 903     }







 904 }
 905 
 906 /*
<span class="line-modified"> 907  * the following functions convert Attribute and Mechanism value pointers</span>
<span class="line-removed"> 908  *</span>
<span class="line-removed"> 909  * jobject ckAttributeValueToJObject(JNIEnv *env,</span>
<span class="line-removed"> 910  *                                   const CK_ATTRIBUTE_PTR ckpAttribute);</span>
<span class="line-removed"> 911  *</span>
<span class="line-removed"> 912  * void jObjectToPrimitiveCKObjectPtrPtr(JNIEnv *env,</span>
<span class="line-removed"> 913  *                                       jobject jObject,</span>
<span class="line-removed"> 914  *                                       CK_VOID_PTR *ckpObjectPtr,</span>
<span class="line-removed"> 915  *                                       CK_ULONG *pLength);</span>
 916  *
<span class="line-modified"> 917  * void jMechanismParameterToCKMechanismParameter(JNIEnv *env,</span>
<span class="line-modified"> 918  *                                                jobject jParam,</span>
<span class="line-modified"> 919  *                                                CK_VOID_PTR *ckpParamPtr,</span>
<span class="line-modified"> 920  *                                                CK_ULONG *ckpLength);</span>
<span class="line-modified"> 921  *</span>
<span class="line-modified"> 922  * These functions are used if a PKCS#11 mechanism or attribute structure gets</span>
<span class="line-modified"> 923  * convertet to a Java attribute or mechanism object or vice versa.</span>
<span class="line-modified"> 924  *</span>
<span class="line-modified"> 925  * ckAttributeValueToJObject converts a PKCS#11 attribute value pointer to a Java</span>
<span class="line-modified"> 926  * object depending on the type of the Attribute. A PKCS#11 attribute value can</span>
<span class="line-modified"> 927  * be a CK_ULONG, CK_BYTE[], CK_CHAR[], big integer, CK_BBOOL, CK_UTF8CHAR[],</span>
<span class="line-modified"> 928  * CK_DATE or CK_FLAGS that gets converted to a corresponding Java object.</span>
<span class="line-modified"> 929  *</span>
<span class="line-modified"> 930  * jObjectToPrimitiveCKObjectPtrPtr is used by jAttributeToCKAttributePtr for</span>
<span class="line-modified"> 931  * converting the Java attribute value to a PKCS#11 attribute value pointer.</span>
<span class="line-modified"> 932  * For now only primitive datatypes and arrays of primitive datatypes can get</span>
<span class="line-modified"> 933  * converted. Otherwise this function throws a PKCS#11Exception with the</span>
<span class="line-modified"> 934  * errorcode CKR_VENDOR_DEFINED.</span>
























































 935  *
<span class="line-modified"> 936  * jMechanismParameterToCKMechanismParameter converts a Java mechanism parameter</span>
<span class="line-modified"> 937  * to a PKCS#11 mechanism parameter. First this function determines what mechanism</span>
<span class="line-modified"> 938  * parameter the Java object is, then it allocates the memory for the new PKCS#11</span>
<span class="line-removed"> 939  * structure and calls the corresponding function to convert the Java object to</span>
<span class="line-removed"> 940  * a PKCS#11 mechanism parameter structure.</span>
 941  */




























 942 
 943 /*
<span class="line-modified"> 944  * converts the pValue of a CK_ATTRIBUTE structure into a Java Object by checking the type</span>
<span class="line-modified"> 945  * of the attribute.</span>


 946  *
<span class="line-modified"> 947  * @param env - used to call JNI funktions to create the new Java object</span>
 948  * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure that contains the type
 949  *                       and the pValue to convert
<span class="line-modified"> 950  * @return - the new Java object of the CK-type pValue</span>
 951  */
 952 jobject ckAttributeValueToJObject(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
 953 {
 954     jint jValueLength;
 955     jobject jValueObject = NULL;
 956 
 957     jValueLength = ckULongToJInt(ckpAttribute-&gt;ulValueLen);
 958 
 959     if ((jValueLength &lt;= 0) || (ckpAttribute-&gt;pValue == NULL)) {
 960         return NULL ;
 961     }
 962 
 963     switch(ckpAttribute-&gt;type) {
 964         case CKA_CLASS:
 965             /* value CK_OBJECT_CLASS, defacto a CK_ULONG */
 966         case CKA_KEY_TYPE:
 967             /* value CK_KEY_TYPE, defacto a CK_ULONG */
 968         case CKA_CERTIFICATE_TYPE:
 969             /* value CK_CERTIFICATE_TYPE, defacto a CK_ULONG */
 970         case CKA_HW_FEATURE_TYPE:
</pre>
<hr />
<pre>
1073             break;
1074     }
1075 
1076     return jValueObject ;
1077 }
1078 
1079 /*
1080  * the following functions convert a Java mechanism parameter object to a PKCS#11
1081  * mechanism parameter structure
1082  *
1083  * CK_&lt;Param&gt;_PARAMS j&lt;Param&gt;ParamToCK&lt;Param&gt;Param(JNIEnv *env,
1084  *                                                 jobject jParam);
1085  *
1086  * These functions get a Java object, that must be the right Java mechanism
1087  * object and they return the new PKCS#11 mechanism parameter structure.
1088  * Every field of the Java object is retrieved, gets converted to a corresponding
1089  * PKCS#11 type and is set in the new PKCS#11 structure.
1090  */
1091 
1092 /*
<span class="line-modified">1093  * converts the given Java mechanism parameter to a CK mechanism parameter structure</span>
<span class="line-modified">1094  * and store the length in bytes in the length variable.</span>
<span class="line-removed">1095  * The memory of *ckpParamPtr has to be freed after use!</span>
1096  *
1097  * @param env - used to call JNI funktions to get the Java classes and objects
1098  * @param jParam - the Java mechanism parameter object to convert
<span class="line-modified">1099  * @param ckpParamPtr - the reference of the new pointer to the new CK mechanism parameter</span>
<span class="line-removed">1100  *                      structure</span>
1101  * @param ckpLength - the reference of the length in bytes of the new CK mechanism parameter
1102  *                    structure

1103  */
<span class="line-modified">1104 void jMechanismParameterToCKMechanismParameter(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength)</span>

1105 {

1106     if (jParam == NULL) {
<span class="line-modified">1107         *ckpParamPtr = NULL;</span>
1108         *ckpLength = 0;
1109     } else if ((*env)-&gt;IsInstanceOf(env, jParam, jByteArrayClass)) {
<span class="line-modified">1110         jByteArrayToCKByteArray(env, jParam, (CK_BYTE_PTR *)ckpParamPtr, ckpLength);</span>
1111     } else if ((*env)-&gt;IsInstanceOf(env, jParam, jLongClass)) {
<span class="line-modified">1112         *ckpParamPtr = jLongObjectToCKULongPtr(env, jParam);</span>
1113         *ckpLength = sizeof(CK_ULONG);
1114     } else {
<span class="line-modified">1115         TRACE0(&quot;\nSLOW PATH jMechanismParameterToCKMechanismParameter\n&quot;);</span>
<span class="line-removed">1116         jMechanismParameterToCKMechanismParameterSlow(env, jParam, ckpParamPtr, ckpLength);</span>
1117     }

1118 }
1119 
<span class="line-modified">1120 void jMechanismParameterToCKMechanismParameterSlow(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength)</span>

1121 {
<span class="line-modified">1122     /* get all Java mechanism parameter classes */</span>
<span class="line-removed">1123     jclass jVersionClass, jSsl3MasterKeyDeriveParamsClass;</span>
<span class="line-removed">1124     jclass jTls12MasterKeyDeriveParamsClass, jSsl3KeyMatParamsClass;</span>
<span class="line-removed">1125     jclass jTls12KeyMatParamsClass;</span>
<span class="line-removed">1126     jclass jTlsPrfParamsClass, jTlsMacParamsClass, jAesCtrParamsClass;</span>
<span class="line-removed">1127     jclass jRsaPkcsOaepParamsClass;</span>
<span class="line-removed">1128     jclass jPbeParamsClass, jPkcs5Pbkd2ParamsClass, jRsaPkcsPssParamsClass;</span>
<span class="line-removed">1129     jclass jEcdh1DeriveParamsClass, jEcdh2DeriveParamsClass;</span>
<span class="line-removed">1130     jclass jX942Dh1DeriveParamsClass, jX942Dh2DeriveParamsClass;</span>
<span class="line-removed">1131     TRACE0(&quot;\nDEBUG: jMechanismParameterToCKMechanismParameter&quot;);</span>
1132 
<span class="line-modified">1133     /* most common cases, i.e. NULL/byte[]/long, are already handled by</span>
<span class="line-modified">1134      * jMechanismParameterToCKMechanismParameter before calling this method.</span>

1135      */
<span class="line-modified">1136     jVersionClass = (*env)-&gt;FindClass(env, CLASS_VERSION);</span>
<span class="line-modified">1137     if (jVersionClass == NULL) { return; }</span>
<span class="line-modified">1138     if ((*env)-&gt;IsInstanceOf(env, jParam, jVersionClass)) {</span>
<span class="line-modified">1139         /*</span>
<span class="line-modified">1140          * CK_VERSION used by CKM_SSL3_PRE_MASTER_KEY_GEN</span>
<span class="line-modified">1141          */</span>
<span class="line-modified">1142         CK_VERSION_PTR ckpParam;</span>
<span class="line-modified">1143 </span>
<span class="line-modified">1144         /* convert jParameter to CKParameter */</span>
<span class="line-modified">1145         ckpParam = jVersionToCKVersionPtr(env, jParam);</span>
<span class="line-modified">1146 </span>
<span class="line-modified">1147         /* get length and pointer of parameter */</span>
<span class="line-modified">1148         *ckpLength = sizeof(CK_VERSION);</span>
<span class="line-modified">1149         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">1150         return;</span>
<span class="line-modified">1151     }</span>
<span class="line-modified">1152 </span>
<span class="line-modified">1153     jSsl3MasterKeyDeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">1154     if (jSsl3MasterKeyDeriveParamsClass == NULL) { return; }</span>
<span class="line-modified">1155     if ((*env)-&gt;IsInstanceOf(env, jParam, jSsl3MasterKeyDeriveParamsClass)) {</span>
<span class="line-modified">1156         /*</span>
<span class="line-modified">1157          * CK_SSL3_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-modified">1158          */</span>
<span class="line-modified">1159         CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-modified">1160 </span>
<span class="line-modified">1161         ckpParam = (CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR) malloc(sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-modified">1162         if (ckpParam == NULL) {</span>
<span class="line-modified">1163             throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1164             return;</span>
<span class="line-modified">1165         }</span>
<span class="line-modified">1166 </span>
<span class="line-modified">1167         /* convert jParameter to CKParameter */</span>
<span class="line-modified">1168         *ckpParam = jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParam(env, jParam);</span>
<span class="line-modified">1169         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">1170             free(ckpParam);</span>
<span class="line-modified">1171             return;</span>
<span class="line-modified">1172         }</span>
<span class="line-modified">1173 </span>
<span class="line-modified">1174         /* get length and pointer of parameter */</span>
<span class="line-modified">1175         *ckpLength = sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">1176         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">1177         return;</span>
<span class="line-modified">1178     }</span>
<span class="line-modified">1179 </span>
<span class="line-modified">1180     jSsl3KeyMatParamsClass = (*env)-&gt;FindClass(env, CLASS_SSL3_KEY_MAT_PARAMS);</span>
<span class="line-modified">1181     if (jSsl3KeyMatParamsClass == NULL) { return; }</span>
<span class="line-modified">1182     if ((*env)-&gt;IsInstanceOf(env, jParam, jSsl3KeyMatParamsClass)) {</span>
<span class="line-modified">1183         /*</span>
<span class="line-modified">1184          * CK_SSL3_KEY_MAT_PARAMS</span>
<span class="line-modified">1185          */</span>
<span class="line-modified">1186         CK_SSL3_KEY_MAT_PARAMS_PTR ckpParam;</span>
<span class="line-modified">1187 </span>
<span class="line-modified">1188         ckpParam = (CK_SSL3_KEY_MAT_PARAMS_PTR) malloc(sizeof(CK_SSL3_KEY_MAT_PARAMS));</span>
<span class="line-modified">1189         if (ckpParam == NULL) {</span>
<span class="line-modified">1190             throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1191             return;</span>
<span class="line-modified">1192         }</span>
<span class="line-modified">1193 </span>
<span class="line-modified">1194         /* convert jParameter to CKParameter */</span>
<span class="line-modified">1195         *ckpParam = jSsl3KeyMatParamToCKSsl3KeyMatParam(env, jParam);</span>
<span class="line-modified">1196         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">1197             free(ckpParam);</span>
<span class="line-modified">1198             return;</span>
<span class="line-modified">1199         }</span>
<span class="line-modified">1200 </span>
<span class="line-modified">1201         /* get length and pointer of parameter */</span>
<span class="line-modified">1202         *ckpLength = sizeof(CK_SSL3_KEY_MAT_PARAMS);</span>
<span class="line-modified">1203         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">1204         return;</span>
<span class="line-modified">1205     }</span>
<span class="line-modified">1206 </span>
<span class="line-modified">1207     jTls12KeyMatParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS12_KEY_MAT_PARAMS);</span>
<span class="line-modified">1208     if (jTls12KeyMatParamsClass == NULL) { return; }</span>
<span class="line-modified">1209     if ((*env)-&gt;IsInstanceOf(env, jParam, jTls12KeyMatParamsClass)) {</span>
<span class="line-modified">1210         /*</span>
<span class="line-modified">1211          * CK_TLS12_KEY_MAT_PARAMS</span>
<span class="line-modified">1212          */</span>
<span class="line-modified">1213         CK_TLS12_KEY_MAT_PARAMS_PTR ckpParam;</span>
<span class="line-modified">1214 </span>
<span class="line-modified">1215         ckpParam = (CK_TLS12_KEY_MAT_PARAMS_PTR) malloc(sizeof(CK_TLS12_KEY_MAT_PARAMS));</span>
<span class="line-modified">1216         if (ckpParam == NULL) {</span>
<span class="line-modified">1217             throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1218             return;</span>
<span class="line-modified">1219         }</span>
<span class="line-modified">1220 </span>
<span class="line-modified">1221         /* convert jParameter to CKParameter */</span>
<span class="line-modified">1222         *ckpParam = jTls12KeyMatParamToCKTls12KeyMatParam(env, jParam);</span>
<span class="line-modified">1223         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">1224             free(ckpParam);</span>
<span class="line-modified">1225             return;</span>
<span class="line-modified">1226         }</span>
<span class="line-modified">1227 </span>
<span class="line-modified">1228         /* get length and pointer of parameter */</span>
<span class="line-modified">1229         *ckpLength = sizeof(CK_TLS12_KEY_MAT_PARAMS);</span>
<span class="line-modified">1230         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">1231         return;</span>
<span class="line-modified">1232     }</span>
<span class="line-modified">1233 </span>
<span class="line-modified">1234     jTls12MasterKeyDeriveParamsClass =</span>
<span class="line-modified">1235             (*env)-&gt;FindClass(env, CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">1236     if (jTls12MasterKeyDeriveParamsClass == NULL) { return; }</span>
<span class="line-modified">1237     if ((*env)-&gt;IsInstanceOf(env, jParam, jTls12MasterKeyDeriveParamsClass)) {</span>
<span class="line-modified">1238         /*</span>
<span class="line-modified">1239          * CK_TLS12_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-removed">1240          */</span>
<span class="line-removed">1241         CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1242 </span>
<span class="line-removed">1243         ckpParam = (CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR)malloc(</span>
<span class="line-removed">1244                 sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-removed">1245         if (ckpParam == NULL) {</span>
<span class="line-removed">1246             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1247             return;</span>
<span class="line-removed">1248         }</span>
<span class="line-removed">1249 </span>
<span class="line-removed">1250         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1251         *ckpParam = jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParam(env, jParam);</span>
<span class="line-removed">1252         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1253             free(ckpParam);</span>
<span class="line-removed">1254             return;</span>
<span class="line-removed">1255         }</span>
<span class="line-removed">1256 </span>
<span class="line-removed">1257         /* get length and pointer of parameter */</span>
<span class="line-removed">1258         *ckpLength = sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-removed">1259         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1260         return;</span>
<span class="line-removed">1261     }</span>
<span class="line-removed">1262 </span>
<span class="line-removed">1263     jTlsPrfParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_PRF_PARAMS);</span>
<span class="line-removed">1264     if (jTlsPrfParamsClass == NULL) { return; }</span>
<span class="line-removed">1265     if ((*env)-&gt;IsInstanceOf(env, jParam, jTlsPrfParamsClass)) {</span>
<span class="line-removed">1266         /*</span>
<span class="line-removed">1267          * CK_TLS_PRF_PARAMS</span>
<span class="line-removed">1268          */</span>
<span class="line-removed">1269         CK_TLS_PRF_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1270 </span>
<span class="line-removed">1271         ckpParam = (CK_TLS_PRF_PARAMS_PTR) malloc(sizeof(CK_TLS_PRF_PARAMS));</span>
<span class="line-removed">1272         if (ckpParam == NULL) {</span>
<span class="line-removed">1273             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1274             return;</span>
<span class="line-removed">1275         }</span>
<span class="line-removed">1276 </span>
<span class="line-removed">1277         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1278         *ckpParam = jTlsPrfParamsToCKTlsPrfParam(env, jParam);</span>
<span class="line-removed">1279         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1280             free(ckpParam);</span>
<span class="line-removed">1281             return;</span>
<span class="line-removed">1282         }</span>
<span class="line-removed">1283 </span>
<span class="line-removed">1284         /* get length and pointer of parameter */</span>
<span class="line-removed">1285         *ckpLength = sizeof(CK_TLS_PRF_PARAMS);</span>
<span class="line-removed">1286         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1287         return;</span>
<span class="line-removed">1288     }</span>
<span class="line-removed">1289 </span>
<span class="line-removed">1290     jTlsMacParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_MAC_PARAMS);</span>
<span class="line-removed">1291     if (jTlsMacParamsClass == NULL) { return; }</span>
<span class="line-removed">1292     if ((*env)-&gt;IsInstanceOf(env, jParam, jTlsMacParamsClass)) {</span>
<span class="line-removed">1293         CK_TLS_MAC_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1294 </span>
<span class="line-removed">1295         ckpParam = (CK_TLS_MAC_PARAMS_PTR) malloc(sizeof(CK_TLS_MAC_PARAMS));</span>
<span class="line-removed">1296         if (ckpParam == NULL) {</span>
<span class="line-removed">1297             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1298             return;</span>
<span class="line-removed">1299         }</span>
<span class="line-removed">1300 </span>
<span class="line-removed">1301         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1302         *ckpParam = jTlsMacParamsToCKTlsMacParam(env, jParam);</span>
<span class="line-removed">1303         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1304             free(ckpParam);</span>
<span class="line-removed">1305             return;</span>
<span class="line-removed">1306         }</span>
<span class="line-removed">1307 </span>
<span class="line-removed">1308         /* get length and pointer of parameter */</span>
<span class="line-removed">1309         *ckpLength = sizeof(CK_TLS_MAC_PARAMS);</span>
<span class="line-removed">1310         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1311         return;</span>
<span class="line-removed">1312     }</span>
<span class="line-removed">1313 </span>
<span class="line-removed">1314     jAesCtrParamsClass = (*env)-&gt;FindClass(env, CLASS_AES_CTR_PARAMS);</span>
<span class="line-removed">1315     if (jAesCtrParamsClass == NULL) { return; }</span>
<span class="line-removed">1316     if ((*env)-&gt;IsInstanceOf(env, jParam, jAesCtrParamsClass)) {</span>
<span class="line-removed">1317         /*</span>
<span class="line-removed">1318          * CK_AES_CTR_PARAMS</span>
<span class="line-removed">1319          */</span>
<span class="line-removed">1320         CK_AES_CTR_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1321 </span>
<span class="line-removed">1322         ckpParam = (CK_AES_CTR_PARAMS_PTR) malloc(sizeof(CK_AES_CTR_PARAMS));</span>
<span class="line-removed">1323         if (ckpParam == NULL) {</span>
<span class="line-removed">1324             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1325             return;</span>
<span class="line-removed">1326         }</span>
<span class="line-removed">1327 </span>
<span class="line-removed">1328         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1329         jAesCtrParamsToCKAesCtrParam(env, jParam, ckpParam);</span>
<span class="line-removed">1330         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1331             free(ckpParam);</span>
<span class="line-removed">1332             return;</span>
<span class="line-removed">1333         }</span>
<span class="line-removed">1334 </span>
<span class="line-removed">1335         /* get length and pointer of parameter */</span>
<span class="line-removed">1336         *ckpLength = sizeof(CK_AES_CTR_PARAMS);</span>
<span class="line-removed">1337         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1338         return;</span>
<span class="line-removed">1339     }</span>
<span class="line-removed">1340 </span>
<span class="line-removed">1341     jRsaPkcsOaepParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_OAEP_PARAMS);</span>
<span class="line-removed">1342     if (jRsaPkcsOaepParamsClass == NULL) { return; }</span>
<span class="line-removed">1343     if ((*env)-&gt;IsInstanceOf(env, jParam, jRsaPkcsOaepParamsClass)) {</span>
<span class="line-removed">1344         /*</span>
<span class="line-removed">1345          * CK_RSA_PKCS_OAEP_PARAMS</span>
<span class="line-removed">1346          */</span>
<span class="line-removed">1347         CK_RSA_PKCS_OAEP_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1348 </span>
<span class="line-removed">1349         ckpParam = (CK_RSA_PKCS_OAEP_PARAMS_PTR) malloc(sizeof(CK_RSA_PKCS_OAEP_PARAMS));</span>
<span class="line-removed">1350         if (ckpParam == NULL) {</span>
<span class="line-removed">1351             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1352             return;</span>
<span class="line-removed">1353         }</span>
<span class="line-removed">1354 </span>
<span class="line-removed">1355         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1356         *ckpParam = jRsaPkcsOaepParamToCKRsaPkcsOaepParam(env, jParam);</span>
<span class="line-removed">1357         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1358             free(ckpParam);</span>
<span class="line-removed">1359             return;</span>
<span class="line-removed">1360         }</span>
<span class="line-removed">1361 </span>
<span class="line-removed">1362         /* get length and pointer of parameter */</span>
<span class="line-removed">1363         *ckpLength = sizeof(CK_RSA_PKCS_OAEP_PARAMS);</span>
<span class="line-removed">1364         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1365         return;</span>
<span class="line-removed">1366     }</span>
<span class="line-removed">1367 </span>
<span class="line-removed">1368     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);</span>
<span class="line-removed">1369     if (jPbeParamsClass == NULL) { return; }</span>
<span class="line-removed">1370     if ((*env)-&gt;IsInstanceOf(env, jParam, jPbeParamsClass)) {</span>
<span class="line-removed">1371         /*</span>
<span class="line-removed">1372          * CK_PBE_PARAMS</span>
<span class="line-removed">1373          */</span>
<span class="line-removed">1374         CK_PBE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1375 </span>
<span class="line-removed">1376         ckpParam = (CK_PBE_PARAMS_PTR) malloc(sizeof(CK_PBE_PARAMS));</span>
<span class="line-removed">1377         if (ckpParam == NULL) {</span>
<span class="line-removed">1378             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1379             return;</span>
<span class="line-removed">1380         }</span>
<span class="line-removed">1381 </span>
<span class="line-removed">1382         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1383         *ckpParam = jPbeParamToCKPbeParam(env, jParam);</span>
<span class="line-removed">1384         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1385             free(ckpParam);</span>
<span class="line-removed">1386             return;</span>
<span class="line-removed">1387         }</span>
<span class="line-removed">1388 </span>
<span class="line-removed">1389         /* get length and pointer of parameter */</span>
<span class="line-removed">1390         *ckpLength = sizeof(CK_PBE_PARAMS);</span>
<span class="line-removed">1391         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1392         return;</span>
<span class="line-removed">1393     }</span>
<span class="line-removed">1394 </span>
<span class="line-removed">1395     jPkcs5Pbkd2ParamsClass = (*env)-&gt;FindClass(env, CLASS_PKCS5_PBKD2_PARAMS);</span>
<span class="line-removed">1396     if (jPkcs5Pbkd2ParamsClass == NULL) { return; }</span>
<span class="line-removed">1397     if ((*env)-&gt;IsInstanceOf(env, jParam, jPkcs5Pbkd2ParamsClass)) {</span>
<span class="line-removed">1398         /*</span>
<span class="line-removed">1399          * CK_PKCS5_PBKD2_PARAMS</span>
<span class="line-removed">1400          */</span>
<span class="line-removed">1401         CK_PKCS5_PBKD2_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1402 </span>
<span class="line-removed">1403         ckpParam = (CK_PKCS5_PBKD2_PARAMS_PTR) malloc(sizeof(CK_PKCS5_PBKD2_PARAMS));</span>
<span class="line-removed">1404         if (ckpParam == NULL) {</span>
<span class="line-removed">1405             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1406             return;</span>
<span class="line-removed">1407         }</span>
<span class="line-removed">1408 </span>
<span class="line-removed">1409         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1410         *ckpParam = jPkcs5Pbkd2ParamToCKPkcs5Pbkd2Param(env, jParam);</span>
<span class="line-removed">1411         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1412             free(ckpParam);</span>
<span class="line-removed">1413             return;</span>
<span class="line-removed">1414         }</span>
<span class="line-removed">1415 </span>
<span class="line-removed">1416         /* get length and pointer of parameter */</span>
<span class="line-removed">1417         *ckpLength = sizeof(CK_PKCS5_PBKD2_PARAMS);</span>
<span class="line-removed">1418         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1419         return;</span>
<span class="line-removed">1420     }</span>
<span class="line-removed">1421 </span>
<span class="line-removed">1422     jRsaPkcsPssParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_PSS_PARAMS);</span>
<span class="line-removed">1423     if (jRsaPkcsPssParamsClass == NULL) { return; }</span>
<span class="line-removed">1424     if ((*env)-&gt;IsInstanceOf(env, jParam, jRsaPkcsPssParamsClass)) {</span>
<span class="line-removed">1425         /*</span>
<span class="line-removed">1426          * CK_RSA_PKCS_PSS_PARAMS</span>
<span class="line-removed">1427          */</span>
<span class="line-removed">1428         CK_RSA_PKCS_PSS_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1429 </span>
<span class="line-removed">1430         ckpParam = (CK_RSA_PKCS_PSS_PARAMS_PTR) malloc(sizeof(CK_RSA_PKCS_PSS_PARAMS));</span>
<span class="line-removed">1431         if (ckpParam == NULL) {</span>
<span class="line-removed">1432             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1433             return;</span>
<span class="line-removed">1434         }</span>
<span class="line-removed">1435 </span>
<span class="line-removed">1436         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1437         *ckpParam = jRsaPkcsPssParamToCKRsaPkcsPssParam(env, jParam);</span>
<span class="line-removed">1438         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1439             free(ckpParam);</span>
<span class="line-removed">1440             return;</span>
<span class="line-removed">1441         }</span>
<span class="line-removed">1442 </span>
<span class="line-removed">1443         /* get length and pointer of parameter */</span>
<span class="line-removed">1444         *ckpLength = sizeof(CK_RSA_PKCS_PSS_PARAMS);</span>
<span class="line-removed">1445         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1446         return;</span>
<span class="line-removed">1447     }</span>
<span class="line-removed">1448 </span>
<span class="line-removed">1449     jEcdh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH1_DERIVE_PARAMS);</span>
<span class="line-removed">1450     if (jEcdh1DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">1451     if ((*env)-&gt;IsInstanceOf(env, jParam, jEcdh1DeriveParamsClass)) {</span>
<span class="line-removed">1452         /*</span>
<span class="line-removed">1453          * CK_ECDH1_DERIVE_PARAMS</span>
<span class="line-removed">1454          */</span>
<span class="line-removed">1455         CK_ECDH1_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1456 </span>
<span class="line-removed">1457         ckpParam = (CK_ECDH1_DERIVE_PARAMS_PTR) malloc(sizeof(CK_ECDH1_DERIVE_PARAMS));</span>
<span class="line-removed">1458         if (ckpParam == NULL) {</span>
<span class="line-removed">1459             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1460             return;</span>
<span class="line-removed">1461         }</span>
<span class="line-removed">1462 </span>
<span class="line-removed">1463         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1464         *ckpParam = jEcdh1DeriveParamToCKEcdh1DeriveParam(env, jParam);</span>
<span class="line-removed">1465         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1466             free(ckpParam);</span>
<span class="line-removed">1467             return;</span>
<span class="line-removed">1468         }</span>
<span class="line-removed">1469 </span>
<span class="line-removed">1470         /* get length and pointer of parameter */</span>
<span class="line-removed">1471         *ckpLength = sizeof(CK_ECDH1_DERIVE_PARAMS);</span>
<span class="line-removed">1472         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1473         return;</span>
<span class="line-removed">1474     }</span>
<span class="line-removed">1475 </span>
<span class="line-removed">1476     jEcdh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH2_DERIVE_PARAMS);</span>
<span class="line-removed">1477     if (jEcdh2DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">1478     if ((*env)-&gt;IsInstanceOf(env, jParam, jEcdh2DeriveParamsClass)) {</span>
<span class="line-removed">1479         /*</span>
<span class="line-removed">1480          * CK_ECDH2_DERIVE_PARAMS</span>
<span class="line-removed">1481          */</span>
<span class="line-removed">1482         CK_ECDH2_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1483 </span>
<span class="line-removed">1484         ckpParam = (CK_ECDH2_DERIVE_PARAMS_PTR) malloc(sizeof(CK_ECDH2_DERIVE_PARAMS));</span>
<span class="line-removed">1485         if (ckpParam == NULL) {</span>
<span class="line-removed">1486             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1487             return;</span>
<span class="line-removed">1488         }</span>
<span class="line-removed">1489 </span>
<span class="line-removed">1490         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1491         *ckpParam = jEcdh2DeriveParamToCKEcdh2DeriveParam(env, jParam);</span>
<span class="line-removed">1492         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1493             free(ckpParam);</span>
<span class="line-removed">1494             return;</span>
<span class="line-removed">1495         }</span>
<span class="line-removed">1496 </span>
<span class="line-removed">1497         /* get length and pointer of parameter */</span>
<span class="line-removed">1498         *ckpLength = sizeof(CK_ECDH2_DERIVE_PARAMS);</span>
<span class="line-removed">1499         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1500         return;</span>
<span class="line-removed">1501     }</span>
<span class="line-removed">1502 </span>
<span class="line-removed">1503     jX942Dh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH1_DERIVE_PARAMS);</span>
<span class="line-removed">1504     if (jX942Dh1DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">1505     if ((*env)-&gt;IsInstanceOf(env, jParam, jX942Dh1DeriveParamsClass)) {</span>
<span class="line-removed">1506         /*</span>
<span class="line-removed">1507          * CK_X9_42_DH1_DERIVE_PARAMS</span>
<span class="line-removed">1508          */</span>
<span class="line-removed">1509         CK_X9_42_DH1_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1510 </span>
<span class="line-removed">1511         ckpParam = (CK_X9_42_DH1_DERIVE_PARAMS_PTR) malloc(sizeof(CK_X9_42_DH1_DERIVE_PARAMS));</span>
<span class="line-removed">1512         if (ckpParam == NULL) {</span>
<span class="line-removed">1513             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1514             return;</span>
<span class="line-removed">1515         }</span>
<span class="line-removed">1516 </span>
<span class="line-removed">1517         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1518         *ckpParam = jX942Dh1DeriveParamToCKX942Dh1DeriveParam(env, jParam);</span>
<span class="line-removed">1519         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1520             free(ckpParam);</span>
<span class="line-removed">1521             return;</span>
<span class="line-removed">1522         }</span>
<span class="line-removed">1523 </span>
<span class="line-removed">1524         /* get length and pointer of parameter */</span>
<span class="line-removed">1525         *ckpLength = sizeof(CK_X9_42_DH1_DERIVE_PARAMS);</span>
<span class="line-removed">1526         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1527         return;</span>
1528     }

1529 
<span class="line-modified">1530     jX942Dh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH2_DERIVE_PARAMS);</span>
<span class="line-modified">1531     if (jX942Dh2DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">1532     if ((*env)-&gt;IsInstanceOf(env, jParam, jX942Dh2DeriveParamsClass)) {</span>
<span class="line-removed">1533         /*</span>
<span class="line-removed">1534          * CK_X9_42_DH2_DERIVE_PARAMS</span>
<span class="line-removed">1535          */</span>
<span class="line-removed">1536         CK_X9_42_DH2_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">1537 </span>
<span class="line-removed">1538         ckpParam = (CK_X9_42_DH2_DERIVE_PARAMS_PTR) malloc(sizeof(CK_X9_42_DH2_DERIVE_PARAMS));</span>
<span class="line-removed">1539         if (ckpParam == NULL) {</span>
<span class="line-removed">1540             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">1541             return;</span>
<span class="line-removed">1542         }</span>
<span class="line-removed">1543 </span>
<span class="line-removed">1544         /* convert jParameter to CKParameter */</span>
<span class="line-removed">1545         *ckpParam = jX942Dh2DeriveParamToCKX942Dh2DeriveParam(env, jParam);</span>
<span class="line-removed">1546         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">1547             free(ckpParam);</span>
<span class="line-removed">1548             return;</span>
<span class="line-removed">1549         }</span>
<span class="line-removed">1550 </span>
<span class="line-removed">1551         /* get length and pointer of parameter */</span>
<span class="line-removed">1552         *ckpLength = sizeof(CK_X9_42_DH2_DERIVE_PARAMS);</span>
<span class="line-removed">1553         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">1554         return;</span>
1555     }
1556 
<span class="line-modified">1557     /* if everything faild up to here */</span>
<span class="line-removed">1558     /* try if the parameter is a primitive Java type */</span>
<span class="line-removed">1559     jObjectToPrimitiveCKObjectPtrPtr(env, jParam, ckpParamPtr, ckpLength);</span>
<span class="line-removed">1560     /* *ckpParamPtr = jObjectToCKVoidPtr(jParam); */</span>
<span class="line-removed">1561     /* *ckpLength = 1; */</span>
<span class="line-removed">1562 </span>
<span class="line-removed">1563     TRACE0(&quot;FINISHED\n&quot;);</span>
1564 }
1565 
<span class="line-removed">1566 </span>
<span class="line-removed">1567 /* the mechanism parameter convertion functions: */</span>
<span class="line-removed">1568 </span>
1569 /*
<span class="line-modified">1570  * converts the Java CK_RSA_PKCS_OAEP_PARAMS object to a CK_RSA_PKCS_OAEP_PARAMS structure</span>

1571  *
1572  * @param env - used to call JNI funktions to get the Java classes and objects
1573  * @param jParam - the Java CK_RSA_PKCS_OAEP_PARAMS object to convert
<span class="line-modified">1574  * @return - the new CK_RSA_PKCS_OAEP_PARAMS structure</span>

1575  */
<span class="line-modified">1576 CK_RSA_PKCS_OAEP_PARAMS jRsaPkcsOaepParamToCKRsaPkcsOaepParam(JNIEnv *env, jobject jParam)</span>

1577 {

1578     jclass jRsaPkcsOaepParamsClass;
<span class="line-removed">1579     CK_RSA_PKCS_OAEP_PARAMS ckParam;</span>
1580     jfieldID fieldID;
1581     jlong jHashAlg, jMgf, jSource;
1582     jobject jSourceData;
<span class="line-removed">1583     CK_BYTE_PTR ckpByte;</span>
<span class="line-removed">1584     memset(&amp;ckParam, 0, sizeof(CK_RSA_PKCS_OAEP_PARAMS));</span>
1585 
<span class="line-modified">1586     /* get hashAlg */</span>




1587     jRsaPkcsOaepParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_OAEP_PARAMS);
<span class="line-modified">1588     if (jRsaPkcsOaepParamsClass == NULL) { return ckParam; }</span>
1589     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<span class="line-modified">1590     if (fieldID == NULL) { return ckParam; }</span>
1591     jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1592 </span>
<span class="line-removed">1593     /* get mgf */</span>
1594     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<span class="line-modified">1595     if (fieldID == NULL) { return ckParam; }</span>
1596     jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1597 </span>
<span class="line-removed">1598     /* get source */</span>
1599     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;source&quot;, &quot;J&quot;);
<span class="line-modified">1600     if (fieldID == NULL) { return ckParam; }</span>
1601     jSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1602 </span>
<span class="line-removed">1603     /* get sourceData and sourceDataLength */</span>
1604     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;pSourceData&quot;, &quot;[B&quot;);
<span class="line-modified">1605     if (fieldID == NULL) { return ckParam; }</span>
1606     jSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1607 
<span class="line-modified">1608     /* populate java values */</span>
<span class="line-modified">1609     ckParam.hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-modified">1610     ckParam.mgf = jLongToCKULong(jMgf);</span>
<span class="line-modified">1611     ckParam.source = jLongToCKULong(jSource);</span>
<span class="line-modified">1612     jByteArrayToCKByteArray(env, jSourceData, &amp; ckpByte, &amp;(ckParam.ulSourceDataLen));</span>
<span class="line-modified">1613     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1614     ckParam.pSourceData = (CK_VOID_PTR) ckpByte;</span>










1615 
<span class="line-modified">1616     return ckParam ;</span>



1617 }
1618 
1619 /*
<span class="line-modified">1620  * converts the Java CK_PBE_PARAMS object to a CK_PBE_PARAMS structure</span>
1621  *
1622  * @param env - used to call JNI funktions to get the Java classes and objects
1623  * @param jParam - the Java CK_PBE_PARAMS object to convert
<span class="line-modified">1624  * @return - the new CK_PBE_PARAMS structure</span>

1625  */
<span class="line-modified">1626 CK_PBE_PARAMS jPbeParamToCKPbeParam(JNIEnv *env, jobject jParam)</span>

1627 {

1628     jclass jPbeParamsClass;
<span class="line-removed">1629     CK_PBE_PARAMS ckParam;</span>
1630     jfieldID fieldID;
1631     jlong jIteration;
1632     jobject jInitVector, jPassword, jSalt;
1633     CK_ULONG ckTemp;
<span class="line-removed">1634     memset(&amp;ckParam, 0, sizeof(CK_PBE_PARAMS));</span>
1635 
<span class="line-modified">1636     /* get pInitVector */</span>




1637     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
<span class="line-modified">1638     if (jPbeParamsClass == NULL) { return ckParam; }</span>
1639     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVector&quot;, &quot;[C&quot;);
<span class="line-modified">1640     if (fieldID == NULL) { return ckParam; }</span>
1641     jInitVector = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">1642 </span>
<span class="line-removed">1643     /* get pPassword and ulPasswordLength */</span>
1644     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pPassword&quot;, &quot;[C&quot;);
<span class="line-modified">1645     if (fieldID == NULL) { return ckParam; }</span>
1646     jPassword = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">1647 </span>
<span class="line-removed">1648     /* get pSalt and ulSaltLength */</span>
1649     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pSalt&quot;, &quot;[C&quot;);
<span class="line-modified">1650     if (fieldID == NULL) { return ckParam; }</span>
1651     jSalt = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">1652 </span>
<span class="line-removed">1653     /* get ulIteration */</span>
1654     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;ulIteration&quot;, &quot;J&quot;);
<span class="line-modified">1655     if (fieldID == NULL) { return ckParam; }</span>
1656     jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
1657 
<span class="line-modified">1658     /* populate java values */</span>
<span class="line-modified">1659     ckParam.ulIteration = jLongToCKULong(jIteration);</span>
<span class="line-modified">1660     jCharArrayToCKCharArray(env, jInitVector, &amp;(ckParam.pInitVector), &amp;ckTemp);</span>
<span class="line-modified">1661     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1662     jCharArrayToCKCharArray(env, jPassword, &amp;(ckParam.pPassword), &amp;(ckParam.ulPasswordLen));</span>









1663     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1664         free(ckParam.pInitVector);</span>
<span class="line-removed">1665         return ckParam;</span>
1666     }
<span class="line-modified">1667     jCharArrayToCKCharArray(env, jSalt, &amp;(ckParam.pSalt), &amp;(ckParam.ulSaltLen));</span>
1668     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1669         free(ckParam.pInitVector);</span>
<span class="line-removed">1670         free(ckParam.pPassword);</span>
<span class="line-removed">1671         return ckParam;</span>
1672     }
1673 
<span class="line-modified">1674     return ckParam ;</span>









1675 }
1676 
1677 /*
1678  * Copy back the initialization vector from the native structure to the
1679  * Java object. This is only used for CKM_PBE_* mechanisms and their
1680  * CK_PBE_PARAMS parameters.
1681  *
1682  */
1683 void copyBackPBEInitializationVector(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism)
1684 {
1685     jclass jMechanismClass, jPbeParamsClass;
1686     CK_PBE_PARAMS *ckParam;
1687     jfieldID fieldID;
1688     CK_MECHANISM_TYPE ckMechanismType;
1689     jlong jMechanismType;
1690     jobject jParameter;
1691     jobject jInitVector;
1692     jint jInitVectorLength;
1693     CK_CHAR_PTR initVector;
1694     int i;
1695     jchar* jInitVectorChars;
1696 
1697     /* get mechanism */
1698     jMechanismClass = (*env)-&gt;FindClass(env, CLASS_MECHANISM);
1699     if (jMechanismClass == NULL) { return; }
1700     fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;mechanism&quot;, &quot;J&quot;);
1701     if (fieldID == NULL) { return; }
1702     jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, fieldID);
1703     ckMechanismType = jLongToCKULong(jMechanismType);
1704     if (ckMechanismType != ckMechanism-&gt;mechanism) {
<span class="line-modified">1705         /* we do not have maching types, this should not occur */</span>
1706         return;
1707     }
1708 
1709     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
1710     if (jPbeParamsClass == NULL) { return; }
1711     ckParam = (CK_PBE_PARAMS *) ckMechanism-&gt;pParameter;
1712     if (ckParam != NULL_PTR) {
1713         initVector = ckParam-&gt;pInitVector;
1714         if (initVector != NULL_PTR) {
1715             /* get pParameter */
1716             fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;pParameter&quot;, &quot;Ljava/lang/Object;&quot;);
1717             if (fieldID == NULL) { return; }
1718             jParameter = (*env)-&gt;GetObjectField(env, jMechanism, fieldID);
1719             fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVektor&quot;, &quot;[C&quot;);
1720             if (fieldID == NULL) { return; }
1721             jInitVector = (*env)-&gt;GetObjectField(env, jParameter, fieldID);
1722 
1723             if (jInitVector != NULL) {
1724                 jInitVectorLength = (*env)-&gt;GetArrayLength(env, jInitVector);
1725                 jInitVectorChars = (*env)-&gt;GetCharArrayElements(env, jInitVector, NULL);
1726                 if (jInitVectorChars == NULL) { return; }
1727 
1728                 /* copy the chars to the Java buffer */
1729                 for (i=0; i &lt; jInitVectorLength; i++) {
1730                     jInitVectorChars[i] = ckCharToJChar(initVector[i]);
1731                 }
1732                 /* copy back the Java buffer to the object */
1733                 (*env)-&gt;ReleaseCharArrayElements(env, jInitVector, jInitVectorChars, 0);
1734             }
1735         }
1736     }
1737 }
1738 
1739 /*
<span class="line-modified">1740  * converts the Java CK_PKCS5_PBKD2_PARAMS object to a CK_PKCS5_PBKD2_PARAMS structure</span>

1741  *
1742  * @param env - used to call JNI funktions to get the Java classes and objects
1743  * @param jParam - the Java CK_PKCS5_PBKD2_PARAMS object to convert
<span class="line-modified">1744  * @return - the new CK_PKCS5_PBKD2_PARAMS structure</span>

1745  */
<span class="line-modified">1746 CK_PKCS5_PBKD2_PARAMS jPkcs5Pbkd2ParamToCKPkcs5Pbkd2Param(JNIEnv *env, jobject jParam)</span>

1747 {

1748     jclass jPkcs5Pbkd2ParamsClass;
<span class="line-removed">1749     CK_PKCS5_PBKD2_PARAMS ckParam;</span>
1750     jfieldID fieldID;
1751     jlong jSaltSource, jIteration, jPrf;
1752     jobject jSaltSourceData, jPrfData;
<span class="line-removed">1753     memset(&amp;ckParam, 0, sizeof(CK_PKCS5_PBKD2_PARAMS));</span>
1754 
<span class="line-modified">1755     /* get saltSource */</span>




1756     jPkcs5Pbkd2ParamsClass = (*env)-&gt;FindClass(env, CLASS_PKCS5_PBKD2_PARAMS);
<span class="line-modified">1757     if (jPkcs5Pbkd2ParamsClass == NULL) { return ckParam; }</span>
1758     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;saltSource&quot;, &quot;J&quot;);
<span class="line-modified">1759     if (fieldID == NULL) { return ckParam; }</span>
1760     jSaltSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1761 </span>
<span class="line-removed">1762     /* get pSaltSourceData */</span>
1763     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pSaltSourceData&quot;, &quot;[B&quot;);
<span class="line-modified">1764     if (fieldID == NULL) { return ckParam; }</span>
1765     jSaltSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">1766 </span>
<span class="line-removed">1767     /* get iterations */</span>
1768     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;iterations&quot;, &quot;J&quot;);
<span class="line-modified">1769     if (fieldID == NULL) { return ckParam; }</span>
1770     jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1771 </span>
<span class="line-removed">1772     /* get prf */</span>
1773     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;prf&quot;, &quot;J&quot;);
<span class="line-modified">1774     if (fieldID == NULL) { return ckParam; }</span>
1775     jPrf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1776 </span>
<span class="line-removed">1777     /* get pPrfData and ulPrfDataLength in byte */</span>
1778     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pPrfData&quot;, &quot;[B&quot;);
<span class="line-modified">1779     if (fieldID == NULL) { return ckParam; }</span>
1780     jPrfData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1781 
<span class="line-modified">1782     /* populate java values */</span>
<span class="line-modified">1783     ckParam.saltSource = jLongToCKULong(jSaltSource);</span>
<span class="line-modified">1784     jByteArrayToCKByteArray(env, jSaltSourceData, (CK_BYTE_PTR *) &amp;(ckParam.pSaltSourceData), &amp;(ckParam.ulSaltSourceDataLen));</span>
<span class="line-modified">1785     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1786     ckParam.iterations = jLongToCKULong(jIteration);</span>
<span class="line-modified">1787     ckParam.prf = jLongToCKULong(jPrf);</span>
<span class="line-modified">1788     jByteArrayToCKByteArray(env, jPrfData, (CK_BYTE_PTR *) &amp;(ckParam.pPrfData), &amp;(ckParam.ulPrfDataLen));</span>




1789     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1790         free(ckParam.pSaltSourceData);</span>
<span class="line-modified">1791         return ckParam;</span>










1792     }






1793 
<span class="line-removed">1794     return ckParam ;</span>
1795 }
1796 
1797 /*
<span class="line-modified">1798  * converts the Java CK_RSA_PKCS_PSS_PARAMS object to a CK_RSA_PKCS_PSS_PARAMS structure</span>

1799  *
1800  * @param env - used to call JNI funktions to get the Java classes and objects
1801  * @param jParam - the Java CK_RSA_PKCS_PSS_PARAMS object to convert
<span class="line-modified">1802  * @return - the new CK_RSA_PKCS_PSS_PARAMS structure</span>

1803  */
<span class="line-modified">1804 CK_RSA_PKCS_PSS_PARAMS jRsaPkcsPssParamToCKRsaPkcsPssParam(JNIEnv *env, jobject jParam)</span>

1805 {

1806     jclass jRsaPkcsPssParamsClass;
<span class="line-removed">1807     CK_RSA_PKCS_PSS_PARAMS ckParam;</span>
1808     jfieldID fieldID;
1809     jlong jHashAlg, jMgf, jSLen;
<span class="line-removed">1810     memset(&amp;ckParam, 0, sizeof(CK_RSA_PKCS_PSS_PARAMS));</span>
1811 
<span class="line-modified">1812     /* get hashAlg */</span>




1813     jRsaPkcsPssParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_PSS_PARAMS);
<span class="line-modified">1814     if (jRsaPkcsPssParamsClass == NULL) { return ckParam; }</span>
1815     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<span class="line-modified">1816     if (fieldID == NULL) { return ckParam; }</span>
1817     jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1818 </span>
<span class="line-removed">1819     /* get mgf */</span>
1820     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<span class="line-modified">1821     if (fieldID == NULL) { return ckParam; }</span>
1822     jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1823 </span>
<span class="line-removed">1824     /* get sLen */</span>
1825     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;sLen&quot;, &quot;J&quot;);
<span class="line-modified">1826     if (fieldID == NULL) { return ckParam; }</span>
1827     jSLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
1828 
<span class="line-modified">1829     /* populate java values */</span>
<span class="line-modified">1830     ckParam.hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-modified">1831     ckParam.mgf = jLongToCKULong(jMgf);</span>
<span class="line-modified">1832     ckParam.sLen = jLongToCKULong(jSLen);</span>















1833 
<span class="line-removed">1834     return ckParam ;</span>
1835 }
1836 
1837 /*
<span class="line-modified">1838  * converts the Java CK_ECDH1_DERIVE_PARAMS object to a CK_ECDH1_DERIVE_PARAMS structure</span>

1839  *
1840  * @param env - used to call JNI funktions to get the Java classes and objects
1841  * @param jParam - the Java CK_ECDH1_DERIVE_PARAMS object to convert
<span class="line-modified">1842  * @return - the new CK_ECDH1_DERIVE_PARAMS structure</span>

1843  */
<span class="line-modified">1844 CK_ECDH1_DERIVE_PARAMS jEcdh1DeriveParamToCKEcdh1DeriveParam(JNIEnv *env, jobject jParam)</span>

1845 {

1846     jclass jEcdh1DeriveParamsClass;
<span class="line-removed">1847     CK_ECDH1_DERIVE_PARAMS ckParam;</span>
1848     jfieldID fieldID;
1849     jlong jLong;
1850     jobject jSharedData, jPublicData;
<span class="line-removed">1851     memset(&amp;ckParam, 0, sizeof(CK_ECDH1_DERIVE_PARAMS));</span>
1852 
<span class="line-modified">1853     /* get kdf */</span>




1854     jEcdh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH1_DERIVE_PARAMS);
<span class="line-modified">1855     if (jEcdh1DeriveParamsClass == NULL) { return ckParam; }</span>
1856     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">1857     if (fieldID == NULL) { return ckParam; }</span>
1858     jLong = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1859     ckParam.kdf = jLongToCKULong(jLong);</span>
<span class="line-removed">1860 </span>
<span class="line-removed">1861     /* get pSharedData and ulSharedDataLen */</span>
1862     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<span class="line-modified">1863     if (fieldID == NULL) { return ckParam; }</span>
1864     jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">1865 </span>
<span class="line-removed">1866     /* get pPublicData and ulPublicDataLen */</span>
1867     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">1868     if (fieldID == NULL) { return ckParam; }</span>
1869     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1870 
<span class="line-modified">1871     /* populate java values */</span>
<span class="line-modified">1872     ckParam.kdf = jLongToCKULong(jLong);</span>
<span class="line-modified">1873     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParam.pSharedData), &amp;(ckParam.ulSharedDataLen));</span>
<span class="line-modified">1874     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1875     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>











1876     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1877         free(ckParam.pSharedData);</span>
<span class="line-removed">1878         return ckParam;</span>
1879     }
1880 
<span class="line-modified">1881     return ckParam ;</span>








1882 }
1883 
1884 /*
<span class="line-modified">1885  * converts the Java CK_ECDH2_DERIVE_PARAMS object to a CK_ECDH2_DERIVE_PARAMS structure</span>

1886  *
1887  * @param env - used to call JNI funktions to get the Java classes and objects
1888  * @param jParam - the Java CK_ECDH2_DERIVE_PARAMS object to convert
<span class="line-modified">1889  * @return - the new CK_ECDH2_DERIVE_PARAMS structure</span>

1890  */
<span class="line-modified">1891 CK_ECDH2_DERIVE_PARAMS jEcdh2DeriveParamToCKEcdh2DeriveParam(JNIEnv *env, jobject jParam)</span>

1892 {

1893     jclass jEcdh2DeriveParamsClass;
<span class="line-removed">1894     CK_ECDH2_DERIVE_PARAMS ckParam;</span>
1895     jfieldID fieldID;
1896     jlong jKdf, jPrivateDataLen, jPrivateData;
1897     jobject jSharedData, jPublicData, jPublicData2;
<span class="line-removed">1898     memset(&amp;ckParam, 0, sizeof(CK_ECDH2_DERIVE_PARAMS));</span>
1899 
<span class="line-modified">1900     /* get kdf */</span>
1901     jEcdh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH2_DERIVE_PARAMS);
<span class="line-modified">1902     if (jEcdh2DeriveParamsClass == NULL) { return ckParam; }</span>
1903     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">1904     if (fieldID == NULL) { return ckParam; }</span>
1905     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1906 </span>
<span class="line-removed">1907     /* get pSharedData and ulSharedDataLen */</span>
1908     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<span class="line-modified">1909     if (fieldID == NULL) { return ckParam; }</span>
1910     jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">1911 </span>
<span class="line-removed">1912     /* get pPublicData and ulPublicDataLen */</span>
1913     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">1914     if (fieldID == NULL) { return ckParam; }</span>
1915     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">1916 </span>
<span class="line-removed">1917     /* get ulPrivateDataLen */</span>
1918     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<span class="line-modified">1919     if (fieldID == NULL) { return ckParam; }</span>
1920     jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1921 </span>
<span class="line-removed">1922     /* get hPrivateData */</span>
1923     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<span class="line-modified">1924     if (fieldID == NULL) { return ckParam; }</span>
1925     jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1926 </span>
<span class="line-removed">1927     /* get pPublicData2 and ulPublicDataLen2 */</span>
1928     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<span class="line-modified">1929     if (fieldID == NULL) { return ckParam; }</span>
1930     jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1931 
<span class="line-modified">1932     /* populate java values */</span>
<span class="line-modified">1933     ckParam.kdf = jLongToCKULong(jKdf);</span>
<span class="line-modified">1934     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParam.pSharedData), &amp;(ckParam.ulSharedDataLen));</span>
<span class="line-modified">1935     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1936     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>






1937     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1938         free(ckParam.pSharedData);</span>
<span class="line-removed">1939         return ckParam;</span>
1940     }
<span class="line-modified">1941     ckParam.ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-modified">1942     ckParam.hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-removed">1943     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParam.pPublicData2), &amp;(ckParam.ulPublicDataLen2));</span>
1944     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1945         free(ckParam.pSharedData);</span>
<span class="line-removed">1946         free(ckParam.pPublicData);</span>
<span class="line-removed">1947         return ckParam;</span>
1948     }
<span class="line-modified">1949     return ckParam ;</span>

















1950 }
1951 
1952 /*
<span class="line-modified">1953  * converts the Java CK_X9_42_DH1_DERIVE_PARAMS object to a CK_X9_42_DH1_DERIVE_PARAMS structure</span>

1954  *
1955  * @param env - used to call JNI funktions to get the Java classes and objects
1956  * @param jParam - the Java CK_X9_42_DH1_DERIVE_PARAMS object to convert
<span class="line-modified">1957  * @return - the new CK_X9_42_DH1_DERIVE_PARAMS structure</span>

1958  */
<span class="line-modified">1959 CK_X9_42_DH1_DERIVE_PARAMS jX942Dh1DeriveParamToCKX942Dh1DeriveParam(JNIEnv *env, jobject jParam)</span>

1960 {

1961     jclass jX942Dh1DeriveParamsClass;
<span class="line-removed">1962     CK_X9_42_DH1_DERIVE_PARAMS ckParam;</span>
1963     jfieldID fieldID;
1964     jlong jKdf;
1965     jobject jOtherInfo, jPublicData;
<span class="line-removed">1966     memset(&amp;ckParam, 0, sizeof(CK_X9_42_DH1_DERIVE_PARAMS));</span>
1967 
<span class="line-modified">1968     /* get kdf */</span>




1969     jX942Dh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH1_DERIVE_PARAMS);
<span class="line-modified">1970     if (jX942Dh1DeriveParamsClass == NULL) { return ckParam; }</span>
1971     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">1972     if (fieldID == NULL) { return ckParam; }</span>
1973     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">1974 </span>
<span class="line-removed">1975     /* get pOtherInfo and ulOtherInfoLen */</span>
1976     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<span class="line-modified">1977     if (fieldID == NULL) { return ckParam; }</span>
1978     jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">1979 </span>
<span class="line-removed">1980     /* get pPublicData and ulPublicDataLen */</span>
1981     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">1982     if (fieldID == NULL) { return ckParam; }</span>
1983     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1984 
<span class="line-modified">1985     /* populate java values */</span>
<span class="line-modified">1986     ckParam.kdf = jLongToCKULong(jKdf);</span>
<span class="line-modified">1987     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParam.pOtherInfo), &amp;(ckParam.ulOtherInfoLen));</span>
<span class="line-modified">1988     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">1989     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>






1990     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1991         free(ckParam.pOtherInfo);</span>
<span class="line-modified">1992         return ckParam;</span>




1993     }
1994 
<span class="line-modified">1995     return ckParam ;</span>








1996 }
1997 
1998 /*
<span class="line-modified">1999  * converts the Java CK_X9_42_DH2_DERIVE_PARAMS object to a CK_X9_42_DH2_DERIVE_PARAMS structure</span>

2000  *
2001  * @param env - used to call JNI funktions to get the Java classes and objects
2002  * @param jParam - the Java CK_X9_42_DH2_DERIVE_PARAMS object to convert
<span class="line-modified">2003  * @return - the new CK_X9_42_DH2_DERIVE_PARAMS structure</span>

2004  */
<span class="line-modified">2005 CK_X9_42_DH2_DERIVE_PARAMS jX942Dh2DeriveParamToCKX942Dh2DeriveParam(JNIEnv *env, jobject jParam)</span>

2006 {

2007     jclass jX942Dh2DeriveParamsClass;
<span class="line-removed">2008     CK_X9_42_DH2_DERIVE_PARAMS ckParam;</span>
2009     jfieldID fieldID;
2010     jlong jKdf, jPrivateDataLen, jPrivateData;
2011     jobject jOtherInfo, jPublicData, jPublicData2;
<span class="line-removed">2012     memset(&amp;ckParam, 0, sizeof(CK_X9_42_DH2_DERIVE_PARAMS));</span>
2013 
<span class="line-modified">2014     /* get kdf */</span>




2015     jX942Dh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH2_DERIVE_PARAMS);
<span class="line-modified">2016     if (jX942Dh2DeriveParamsClass == NULL) { return ckParam; }</span>
2017     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">2018     if (fieldID == NULL) { return ckParam; }</span>
2019     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">2020 </span>
<span class="line-removed">2021     /* get pOtherInfo and ulOtherInfoLen */</span>
2022     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<span class="line-modified">2023     if (fieldID == NULL) { return ckParam; }</span>
2024     jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">2025 </span>
<span class="line-removed">2026     /* get pPublicData and ulPublicDataLen */</span>
2027     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">2028     if (fieldID == NULL) { return ckParam; }</span>
2029     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">2030 </span>
<span class="line-removed">2031     /* get ulPrivateDataLen */</span>
2032     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<span class="line-modified">2033     if (fieldID == NULL) { return ckParam; }</span>
2034     jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">2035 </span>
<span class="line-removed">2036     /* get hPrivateData */</span>
2037     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<span class="line-modified">2038     if (fieldID == NULL) { return ckParam; }</span>
2039     jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">2040 </span>
<span class="line-removed">2041     /* get pPublicData2 and ulPublicDataLen2 */</span>
2042     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<span class="line-modified">2043     if (fieldID == NULL) { return ckParam; }</span>
2044     jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
2045 
<span class="line-modified">2046     /* populate java values */</span>
<span class="line-modified">2047     ckParam.kdf = jLongToCKULong(jKdf);</span>
<span class="line-modified">2048     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParam.pOtherInfo), &amp;(ckParam.ulOtherInfoLen));</span>
<span class="line-modified">2049     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">2050     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>






2051     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">2052         free(ckParam.pOtherInfo);</span>
<span class="line-removed">2053         return ckParam;</span>
2054     }
<span class="line-modified">2055     ckParam.ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-modified">2056     ckParam.hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-removed">2057     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParam.pPublicData2), &amp;(ckParam.ulPublicDataLen2));</span>
2058     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">2059         free(ckParam.pOtherInfo);</span>
<span class="line-modified">2060         free(ckParam.pPublicData);</span>
<span class="line-modified">2061         return ckParam;</span>





2062     }
2063 
<span class="line-modified">2064     return ckParam ;</span>









2065 }
</pre>
</td>
<td>
<hr />
<pre>
   1 /*
<span class="line-modified">   2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  */
   4 
   5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
   6  *
   7  * Redistribution and use in  source and binary forms, with or without
   8  * modification, are permitted  provided that the following conditions are met:
   9  *
  10  * 1. Redistributions of  source code must retain the above copyright notice,
  11  *    this list of conditions and the following disclaimer.
  12  *
  13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
  14  *    this list of conditions and the following disclaimer in the documentation
  15  *    and/or other materials provided with the distribution.
  16  *
  17  * 3. The end-user documentation included with the redistribution, if any, must
  18  *    include the following acknowledgment:
  19  *
  20  *    &quot;This product includes software developed by IAIK of Graz University of
  21  *     Technology.&quot;
  22  *
</pre>
<hr />
<pre>
  51  *
  52  * This is the implementation of the native functions of the Java to PKCS#11 interface.
  53  * All function use some helper functions to convert the JNI types to PKCS#11 types.
  54  *
  55  * @author Karl Scheibelhofer &lt;Karl.Scheibelhofer@iaik.at&gt;
  56  * @author Martin Schlaeffer &lt;schlaeff@sbox.tugraz.at&gt;
  57  */
  58 
  59 
  60 #include &quot;pkcs11wrapper.h&quot;
  61 
  62 #include &lt;stdio.h&gt;
  63 #include &lt;stdlib.h&gt;
  64 #include &lt;string.h&gt;
  65 #include &lt;assert.h&gt;
  66 
  67 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
  68 
  69 /* declare file private functions */
  70 
<span class="line-modified">  71 CK_VOID_PTR jMechParamToCKMechParamPtrSlow(JNIEnv *env, jobject jParam,</span>
<span class="line-added">  72         CK_MECHANISM_TYPE ckMech, CK_ULONG *ckpLength);</span>
  73 
  74 
  75 /*
<span class="line-modified">  76  * converts a CK_DATE pointer into a Java CK_DATE Object.</span>
  77  *
  78  * @param env - used to call JNI funktions to create the new Java object
  79  * @param ckpValue - the pointer to the CK_DATE structure
  80  * @return - the new Java CK_DATE object
  81  */
  82 jobject ckDatePtrToJDateObject(JNIEnv *env, const CK_DATE *ckpDate)
  83 {
  84     jclass jDateClass;
  85     jmethodID jCtrId;
  86     jobject jDateObject;
  87     jcharArray jYear;
  88     jcharArray jMonth;
  89     jcharArray jDay;
  90 
  91     /* load CK_DATE class */
  92     jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
  93     if (jDateClass == NULL) { return NULL; }
  94 
  95     /* load CK_DATE constructor */
  96     jCtrId = (*env)-&gt;GetMethodID(env, jDateClass, &quot;&lt;init&gt;&quot;, &quot;([C[C[C)V&quot;);
</pre>
<hr />
<pre>
 102     jMonth = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;month), 2);
 103     if (jMonth == NULL) { return NULL; }
 104     jDay = ckCharArrayToJCharArray(env, (CK_CHAR_PTR)(ckpDate-&gt;day), 2);
 105     if (jDay == NULL) { return NULL; }
 106 
 107     /* create new CK_DATE object */
 108     jDateObject =
 109       (*env)-&gt;NewObject(env, jDateClass, jCtrId, jYear, jMonth, jDay);
 110     if (jDateObject == NULL) { return NULL; }
 111 
 112     /* free local references */
 113     (*env)-&gt;DeleteLocalRef(env, jDateClass);
 114     (*env)-&gt;DeleteLocalRef(env, jYear);
 115     (*env)-&gt;DeleteLocalRef(env, jMonth);
 116     (*env)-&gt;DeleteLocalRef(env, jDay);
 117 
 118     return jDateObject ;
 119 }
 120 
 121 /*
<span class="line-modified"> 122  * converts a CK_VERSION pointer into a Java CK_VERSION Object.</span>
 123  *
 124  * @param env - used to call JNI funktions to create the new Java object
 125  * @param ckpVersion - the pointer to the CK_VERSION structure
<span class="line-modified"> 126  * @return the new Java CK_VERSION object</span>
 127  */
 128 jobject ckVersionPtrToJVersion(JNIEnv *env, const CK_VERSION_PTR ckpVersion)
 129 {
 130     jclass jVersionClass;
 131     jmethodID jCtrId;
 132     jobject jVersionObject;
 133     jint jMajor;
 134     jint jMinor;
 135 
 136     /* load CK_VERSION class */
 137     jVersionClass = (*env)-&gt;FindClass(env, CLASS_VERSION);
 138     if (jVersionClass == NULL) { return NULL; }
 139 
 140     /* load CK_VERSION constructor */
 141     jCtrId = (*env)-&gt;GetMethodID(env, jVersionClass, &quot;&lt;init&gt;&quot;, &quot;(II)V&quot;);
 142     if (jCtrId == NULL) { return NULL; }
 143 
 144     /* prep both fields */
 145     jMajor = ckpVersion-&gt;major;
 146     jMinor = ckpVersion-&gt;minor;
 147 
 148     /* create new CK_VERSION object */
 149     jVersionObject =
 150       (*env)-&gt;NewObject(env, jVersionClass, jCtrId, jMajor, jMinor);
 151     if (jVersionObject == NULL) { return NULL; }
 152 
 153     /* free local references */
 154     (*env)-&gt;DeleteLocalRef(env, jVersionClass);
 155 
 156     return jVersionObject ;
 157 }
 158 
 159 /*
<span class="line-modified"> 160  * converts a CK_SESSION_INFO pointer into a Java CK_SESSION_INFO Object.</span>
 161  *
 162  * @param env - used to call JNI funktions to create the new Java object
 163  * @param ckpSessionInfo - the pointer to the CK_SESSION_INFO structure
<span class="line-modified"> 164  * @return the new Java CK_SESSION_INFO object</span>
 165  */
 166 jobject ckSessionInfoPtrToJSessionInfo(JNIEnv *env, const CK_SESSION_INFO_PTR ckpSessionInfo)
 167 {
 168     jclass jSessionInfoClass;
 169     jmethodID jCtrId;
 170     jobject jSessionInfoObject;
 171     jlong jSlotID;
 172     jlong jState;
 173     jlong jFlags;
 174     jlong jDeviceError;
 175 
 176     /* load CK_SESSION_INFO class */
 177     jSessionInfoClass = (*env)-&gt;FindClass(env, CLASS_SESSION_INFO);
 178     if (jSessionInfoClass == NULL) { return NULL; }
 179 
 180     /* load CK_SESSION_INFO constructor */
 181     jCtrId = (*env)-&gt;GetMethodID(env, jSessionInfoClass, &quot;&lt;init&gt;&quot;, &quot;(JJJJ)V&quot;);
 182     if (jCtrId == NULL) { return NULL; }
 183 
 184     /* prep all fields */
 185     jSlotID = ckULongToJLong(ckpSessionInfo-&gt;slotID);
 186     jState = ckULongToJLong(ckpSessionInfo-&gt;state);
 187     jFlags = ckULongToJLong(ckpSessionInfo-&gt;flags);
 188     jDeviceError = ckULongToJLong(ckpSessionInfo-&gt;ulDeviceError);
 189 
 190     /* create new CK_SESSION_INFO object */
 191     jSessionInfoObject =
 192       (*env)-&gt;NewObject(env, jSessionInfoClass, jCtrId, jSlotID, jState,
 193                         jFlags, jDeviceError);
 194     if (jSessionInfoObject == NULL) { return NULL; }
 195 
 196     /* free local references */
 197     (*env)-&gt;DeleteLocalRef(env, jSessionInfoClass);
 198 
 199     return jSessionInfoObject ;
 200 }
 201 
 202 /*
<span class="line-modified"> 203  * converts a CK_ATTRIBUTE pointer into a Java CK_ATTRIBUTE Object.</span>
 204  *
 205  * @param env - used to call JNI funktions to create the new Java object
 206  * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure
<span class="line-modified"> 207  * @return the new Java CK_ATTRIBUTE object</span>
 208  */
 209 jobject ckAttributePtrToJAttribute(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
 210 {
 211     jclass jAttributeClass;
 212     jmethodID jCtrId;
 213     jobject jAttributeObject;
 214     jlong jType;
 215     jobject jPValue = NULL;
 216 
 217     jAttributeClass = (*env)-&gt;FindClass(env, CLASS_ATTRIBUTE);
 218     if (jAttributeClass == NULL) { return NULL; }
 219 
 220     /* load CK_INFO constructor */
 221     jCtrId = (*env)-&gt;GetMethodID(env, jAttributeClass, &quot;&lt;init&gt;&quot;, &quot;(JLjava/lang/Object;)V&quot;);
 222     if (jCtrId == NULL) { return NULL; }
 223 
 224     /* prep both fields */
 225     jType = ckULongToJLong(ckpAttribute-&gt;type);
 226     jPValue = ckAttributeValueToJObject(env, ckpAttribute);
 227     if ((*env)-&gt;ExceptionCheck(env)) { return NULL; }
 228 
 229     /* create new CK_ATTRIBUTE object */
 230     jAttributeObject =
 231       (*env)-&gt;NewObject(env, jAttributeClass, jCtrId, jType, jPValue);
 232     if (jAttributeObject == NULL) { return NULL; }
 233 
 234     /* free local references */
 235     (*env)-&gt;DeleteLocalRef(env, jAttributeClass);
 236     (*env)-&gt;DeleteLocalRef(env, jPValue);
 237 
 238     return jAttributeObject;
 239 }
 240 
 241 
 242 /*
<span class="line-modified"> 243  * converts a Java CK_VERSION object into a CK_VERSION pointer</span>
 244  *
 245  * @param env - used to call JNI funktions to get the values out of the Java object
 246  * @param jVersion - the Java CK_VERSION object to convert
<span class="line-modified"> 247  * @return pointer to the new CK_VERSION structure</span>
 248  */
<span class="line-modified"> 249 CK_VERSION_PTR</span>
<span class="line-added"> 250 jVersionToCKVersionPtr(JNIEnv *env, jobject jVersion)</span>
 251 {
 252     CK_VERSION_PTR ckpVersion;
 253     jclass jVersionClass;
 254     jfieldID jFieldID;
 255     jbyte jMajor, jMinor;
 256 
 257     if (jVersion == NULL) {
 258         return NULL;
 259     }
 260 
<span class="line-modified"> 261     // retrieve java values</span>
 262     jVersionClass = (*env)-&gt;GetObjectClass(env, jVersion);
 263     if (jVersionClass == NULL) { return NULL; }


 264     jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;major&quot;, &quot;B&quot;);
 265     if (jFieldID == NULL) { return NULL; }
 266     jMajor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);


 267     jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;minor&quot;, &quot;B&quot;);
 268     if (jFieldID == NULL) { return NULL; }
 269     jMinor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
 270 
<span class="line-modified"> 271     // allocate memory for CK_VERSION pointer</span>
<span class="line-modified"> 272     ckpVersion = (CK_VERSION_PTR) calloc(1, sizeof(CK_VERSION));</span>
 273     if (ckpVersion == NULL) {
 274         throwOutOfMemoryError(env, 0);
 275         return NULL;
 276     }
<span class="line-added"> 277 </span>
<span class="line-added"> 278     // populate using java values</span>
 279     ckpVersion-&gt;major = jByteToCKByte(jMajor);
 280     ckpVersion-&gt;minor = jByteToCKByte(jMinor);
 281 
<span class="line-modified"> 282     return ckpVersion;</span>
 283 }
 284 
 285 
 286 /*
<span class="line-modified"> 287  * converts a Java CK_DATE object into a CK_DATE pointer</span>
 288  *
<span class="line-modified"> 289  * @param env - used to call JNI functions to get the values out of the Java object</span>
<span class="line-modified"> 290  * @param jDate - the Java CK_DATE object to convert</span>
<span class="line-modified"> 291  * @return pointer to the new CK_DATE structure</span>
 292  */
<span class="line-modified"> 293 CK_DATE * jDateObjectToCKDatePtr(JNIEnv *env, jobject jDate)</span>
 294 {
<span class="line-modified"> 295     CK_DATE * ckpDate = NULL;</span>
 296     CK_ULONG ckLength;
 297     jclass jDateClass;
 298     jfieldID jFieldID;
 299     jobject jYear, jMonth, jDay;
<span class="line-modified"> 300     jchar *jTempChars = NULL;</span>
 301     CK_ULONG i;
 302 
 303     if (jDate == NULL) {
 304         return NULL;
 305     }
 306 
<span class="line-modified"> 307     // retrieve java values</span>
 308     jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
 309     if (jDateClass == NULL) { return NULL; }


 310     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;year&quot;, &quot;[C&quot;);
 311     if (jFieldID == NULL) { return NULL; }
 312     jYear = (*env)-&gt;GetObjectField(env, jDate, jFieldID);


 313     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;month&quot;, &quot;[C&quot;);
 314     if (jFieldID == NULL) { return NULL; }
 315     jMonth = (*env)-&gt;GetObjectField(env, jDate, jFieldID);


 316     jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;day&quot;, &quot;[C&quot;);
 317     if (jFieldID == NULL) { return NULL; }
 318     jDay = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
 319 
<span class="line-modified"> 320     // allocate memory for CK_DATE pointer</span>
<span class="line-modified"> 321     ckpDate = (CK_DATE *) calloc(1, sizeof(CK_DATE));</span>
 322     if (ckpDate == NULL) {
 323         throwOutOfMemoryError(env, 0);
 324         return NULL;
 325     }
 326 
<span class="line-added"> 327     // populate using java values</span>
 328     if (jYear == NULL) {
 329         ckpDate-&gt;year[0] = 0;
 330         ckpDate-&gt;year[1] = 0;
 331         ckpDate-&gt;year[2] = 0;
 332         ckpDate-&gt;year[3] = 0;
 333     } else {
 334         ckLength = (*env)-&gt;GetArrayLength(env, jYear);
<span class="line-modified"> 335         jTempChars = (jchar*) calloc(ckLength, sizeof(jchar));</span>
 336         if (jTempChars == NULL) {

 337             throwOutOfMemoryError(env, 0);
<span class="line-modified"> 338             goto cleanup;</span>
 339         }
 340         (*env)-&gt;GetCharArrayRegion(env, jYear, 0, ckLength, jTempChars);
 341         if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 342             goto cleanup;</span>


 343         }
 344 
 345         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 4) ; i++) {
 346             ckpDate-&gt;year[i] = jCharToCKChar(jTempChars[i]);
 347         }
 348         free(jTempChars);
 349     }
 350 
 351     if (jMonth == NULL) {
 352         ckpDate-&gt;month[0] = 0;
 353         ckpDate-&gt;month[1] = 0;
 354     } else {
 355         ckLength = (*env)-&gt;GetArrayLength(env, jMonth);
<span class="line-modified"> 356         jTempChars = (jchar*) calloc(ckLength, sizeof(jchar));</span>
 357         if (jTempChars == NULL) {

 358             throwOutOfMemoryError(env, 0);
<span class="line-modified"> 359             goto cleanup;</span>
 360         }
 361         (*env)-&gt;GetCharArrayRegion(env, jMonth, 0, ckLength, jTempChars);
 362         if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 363             goto cleanup;</span>


 364         }
 365 
 366         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
 367             ckpDate-&gt;month[i] = jCharToCKChar(jTempChars[i]);
 368         }
 369         free(jTempChars);
 370     }
 371 
 372     if (jDay == NULL) {
 373         ckpDate-&gt;day[0] = 0;
 374         ckpDate-&gt;day[1] = 0;
 375     } else {
 376         ckLength = (*env)-&gt;GetArrayLength(env, jDay);
<span class="line-modified"> 377         jTempChars = (jchar*) calloc(ckLength, sizeof(jchar));</span>
 378         if (jTempChars == NULL) {

 379             throwOutOfMemoryError(env, 0);
<span class="line-modified"> 380             goto cleanup;</span>
 381         }
 382         (*env)-&gt;GetCharArrayRegion(env, jDay, 0, ckLength, jTempChars);
 383         if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 384             goto cleanup;</span>


 385         }
 386 
 387         for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
 388             ckpDate-&gt;day[i] = jCharToCKChar(jTempChars[i]);
 389         }
 390         free(jTempChars);
 391     }
 392 
<span class="line-modified"> 393     return ckpDate;</span>
<span class="line-added"> 394 cleanup:</span>
<span class="line-added"> 395     free(jTempChars);</span>
<span class="line-added"> 396     free(ckpDate);</span>
<span class="line-added"> 397     return NULL;</span>
 398 }
 399 
 400 
 401 /*
 402  * converts a Java CK_ATTRIBUTE object into a CK_ATTRIBUTE structure
 403  *
 404  * @param env - used to call JNI funktions to get the values out of the Java object
 405  * @param jAttribute - the Java CK_ATTRIBUTE object to convert
<span class="line-modified"> 406  * @return the new CK_ATTRIBUTE structure</span>
 407  */
 408 CK_ATTRIBUTE jAttributeToCKAttribute(JNIEnv *env, jobject jAttribute)
 409 {
 410     CK_ATTRIBUTE ckAttribute;
 411     jclass jAttributeClass;
 412     jfieldID jFieldID;
 413     jlong jType;
 414     jobject jPValue;
<span class="line-added"> 415 </span>
 416     memset(&amp;ckAttribute, 0, sizeof(CK_ATTRIBUTE));
 417 
 418     // TBD: what if jAttribute == NULL?!

 419     TRACE0(&quot;\nDEBUG: jAttributeToCKAttribute&quot;);
<span class="line-added"> 420 </span>
 421     /* get CK_ATTRIBUTE class */
 422     TRACE0(&quot;, getting attribute object class&quot;);
 423     jAttributeClass = (*env)-&gt;GetObjectClass(env, jAttribute);
 424     if (jAttributeClass == NULL) { return ckAttribute; }
 425 
 426     /* get type */
 427     TRACE0(&quot;, getting type field&quot;);
 428     jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;type&quot;, &quot;J&quot;);
 429     if (jFieldID == NULL) { return ckAttribute; }
 430     jType = (*env)-&gt;GetLongField(env, jAttribute, jFieldID);
<span class="line-modified"> 431     TRACE1(&quot;, type=0x%lX&quot;, jType);</span>
 432 
 433     /* get pValue */
 434     TRACE0(&quot;, getting pValue field&quot;);
 435     jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;pValue&quot;, &quot;Ljava/lang/Object;&quot;);
 436     if (jFieldID == NULL) { return ckAttribute; }
 437     jPValue = (*env)-&gt;GetObjectField(env, jAttribute, jFieldID);
 438     TRACE1(&quot;, pValue=%p&quot;, jPValue);
 439 
 440     ckAttribute.type = jLongToCKULong(jType);
 441     TRACE0(&quot;, converting pValue to primitive object&quot;);
 442 
 443     /* convert the Java pValue object to a CK-type pValue pointer */
<span class="line-modified"> 444     ckAttribute.pValue = jObjectToPrimitiveCKObjectPtr(env, jPValue, &amp;(ckAttribute.ulValueLen));</span>
 445 
<span class="line-modified"> 446     TRACE0(&quot;\nDEBUG: jAttributeToCKAttribute FINISHED\n&quot;);</span>
 447 
 448     return ckAttribute ;
 449 }
 450 
 451 void masterKeyDeriveParamToCKMasterKeyDeriveParam(JNIEnv *env, jobject jParam,
 452         jclass masterKeyDeriveParamClass,
 453         CK_VERSION_PTR* cKMasterKeyDeriveParamVersion,
 454         CK_SSL3_RANDOM_DATA* cKMasterKeyDeriveParamRandomInfo) {
 455     jfieldID fieldID;
 456     jclass jSsl3RandomDataClass;
 457     jobject jRandomInfo, jRIClientRandom, jRIServerRandom, jVersion;
 458 
<span class="line-modified"> 459     // retrieve java values</span>
 460     fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;RandomInfo&quot;,
 461             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
 462     if (fieldID == NULL) { return; }
 463     jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);


 464     jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
 465     if (jSsl3RandomDataClass == NULL) { return; }
 466     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
 467     if (fieldID == NULL) { return; }
 468     jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);


 469     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
 470     if (fieldID == NULL) { return; }
 471     jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);


 472     fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;pVersion&quot;,
 473             &quot;Lsun/security/pkcs11/wrapper/CK_VERSION;&quot;);
 474     if (fieldID == NULL) { return; }
 475     jVersion = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 476 
<span class="line-modified"> 477     // populate using java values</span>
 478     *cKMasterKeyDeriveParamVersion = jVersionToCKVersionPtr(env, jVersion);
 479     if ((*env)-&gt;ExceptionCheck(env)) { return; }
 480     jByteArrayToCKByteArray(env, jRIClientRandom,
 481             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom),
 482             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulClientRandomLen));
 483     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 484         goto cleanup;</span>

 485     }
 486     jByteArrayToCKByteArray(env, jRIServerRandom,
 487             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom),
 488             &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulServerRandomLen));
 489     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 490         goto cleanup;</span>


 491     }
<span class="line-added"> 492     return;</span>
<span class="line-added"> 493 cleanup:</span>
<span class="line-added"> 494     free(*cKMasterKeyDeriveParamVersion);</span>
<span class="line-added"> 495     free(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-added"> 496     cKMasterKeyDeriveParamRandomInfo-&gt;ulClientRandomLen = 0L;</span>
<span class="line-added"> 497     free(cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-added"> 498     cKMasterKeyDeriveParamRandomInfo-&gt;ulServerRandomLen = 0L;</span>
<span class="line-added"> 499     // explicitly set to NULL to ensure no double free possible</span>
<span class="line-added"> 500     *cKMasterKeyDeriveParamVersion = NULL;</span>
<span class="line-added"> 501     cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom = NULL;</span>
<span class="line-added"> 502     cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom = NULL;</span>
 503 }
 504 
 505 /*
 506  * converts the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to a
<span class="line-modified"> 507  * CK_SSL3_MASTER_KEY_DERIVE_PARAMS pointer</span>
 508  *
 509  * @param env - used to call JNI functions to get the Java classes and objects
 510  * @param jParam - the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to convert
<span class="line-modified"> 511  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 512  * @return pointer to the new CK_SSL3_MASTER_KEY_DERIVE_PARAMS structure</span>
 513  */
<span class="line-modified"> 514 CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR</span>
<span class="line-modified"> 515 jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParamPtr(JNIEnv *env,</span>
<span class="line-modified"> 516         jobject jParam, CK_ULONG *pLength)</span>
 517 {
<span class="line-modified"> 518     CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR ckParamPtr;</span>
 519     jclass jSsl3MasterKeyDeriveParamsClass;
<span class="line-modified"> 520 </span>
<span class="line-added"> 521     if (pLength != NULL) {</span>
<span class="line-added"> 522         *pLength = 0L;</span>
<span class="line-added"> 523     }</span>
<span class="line-added"> 524 </span>
<span class="line-added"> 525     // allocate memory for CK_SSL3_MASTER_KEY_DERIVE_PARAMS pointer</span>
<span class="line-added"> 526     ckParamPtr = calloc(1, sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-added"> 527     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 528         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 529         return NULL;</span>
<span class="line-added"> 530     }</span>
<span class="line-added"> 531 </span>
<span class="line-added"> 532     // retrieve and populate using java values</span>
 533     jSsl3MasterKeyDeriveParamsClass =
 534             (*env)-&gt;FindClass(env, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);
<span class="line-modified"> 535     if (jSsl3MasterKeyDeriveParamsClass == NULL) {</span>
<span class="line-added"> 536         goto cleanup;</span>
<span class="line-added"> 537     }</span>
 538     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,
 539             jSsl3MasterKeyDeriveParamsClass,
<span class="line-modified"> 540             &amp;(ckParamPtr-&gt;pVersion), &amp;(ckParamPtr-&gt;RandomInfo));</span>
<span class="line-modified"> 541     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 542         goto cleanup;</span>
<span class="line-added"> 543     }</span>
<span class="line-added"> 544 </span>
<span class="line-added"> 545     if (pLength != NULL) {</span>
<span class="line-added"> 546         *pLength = sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-added"> 547     }</span>
<span class="line-added"> 548     return ckParamPtr;</span>
<span class="line-added"> 549 cleanup:</span>
<span class="line-added"> 550     free(ckParamPtr);</span>
<span class="line-added"> 551     return NULL;</span>
 552 }
 553 
 554 /*
 555  * converts the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to a
<span class="line-modified"> 556  * CK_TLS12_MASTER_KEY_DERIVE_PARAMS pointer</span>
 557  *
 558  * @param env - used to call JNI functions to get the Java classes and objects
 559  * @param jParam - the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to convert
<span class="line-modified"> 560  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 561  * @return pointer to the new CK_TLS12_MASTER_KEY_DERIVE_PARAMS structure</span>
 562  */
<span class="line-modified"> 563 CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR</span>
<span class="line-modified"> 564 jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParamPtr(JNIEnv *env,</span>
<span class="line-modified"> 565         jobject jParam, CK_ULONG *pLength)</span>
 566 {
<span class="line-modified"> 567     CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR ckParamPtr;</span>
 568     jclass jTls12MasterKeyDeriveParamsClass;
 569     jfieldID fieldID;
<span class="line-modified"> 570     jlong prfHashMechanism;</span>
<span class="line-added"> 571 </span>
<span class="line-added"> 572     if (pLength != NULL) {</span>
<span class="line-added"> 573         *pLength = 0L;</span>
<span class="line-added"> 574     }</span>
<span class="line-added"> 575 </span>
<span class="line-added"> 576     // retrieve java values</span>
 577     jTls12MasterKeyDeriveParamsClass =
<span class="line-modified"> 578         (*env)-&gt;FindClass(env, CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified"> 579     if (jTls12MasterKeyDeriveParamsClass == NULL) { return NULL; }</span>



 580     fieldID = (*env)-&gt;GetFieldID(env,
 581             jTls12MasterKeyDeriveParamsClass, &quot;prfHashMechanism&quot;, &quot;J&quot;);
<span class="line-modified"> 582     if (fieldID == NULL) { return NULL; }</span>
<span class="line-modified"> 583     prfHashMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified"> 584 </span>
<span class="line-modified"> 585     // allocate memory for CK_TLS12_MASTER_KEY_DERIVE_PARAMS pointer</span>
<span class="line-added"> 586     ckParamPtr = calloc(1, sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-added"> 587     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 588         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 589         return NULL;</span>
 590     }
<span class="line-modified"> 591 </span>
<span class="line-added"> 592     // populate using java values</span>
<span class="line-added"> 593     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,</span>
<span class="line-added"> 594             jTls12MasterKeyDeriveParamsClass, &amp;ckParamPtr-&gt;pVersion,</span>
<span class="line-added"> 595             &amp;ckParamPtr-&gt;RandomInfo);</span>
<span class="line-added"> 596     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 597         goto cleanup;</span>
<span class="line-added"> 598     }</span>
<span class="line-added"> 599 </span>
<span class="line-added"> 600     ckParamPtr-&gt;prfHashMechanism = (CK_MECHANISM_TYPE) prfHashMechanism;</span>
<span class="line-added"> 601 </span>
<span class="line-added"> 602     if (pLength != NULL) {</span>
<span class="line-added"> 603         *pLength = sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-added"> 604     }</span>
<span class="line-added"> 605     return ckParamPtr;</span>
<span class="line-added"> 606 cleanup:</span>
<span class="line-added"> 607     free(ckParamPtr);</span>
<span class="line-added"> 608     return NULL;</span>
 609 }
 610 
 611 /*
<span class="line-modified"> 612  * converts the Java CK_TLS_PRF_PARAMS object to a CK_TLS_PRF_PARAMS pointer</span>
<span class="line-added"> 613  *</span>
<span class="line-added"> 614  * @param env - used to call JNI functions to get the Java classes and objects</span>
<span class="line-added"> 615  * @param jParam - the Java CK_TLS_PRF_PARAMS object to convert</span>
<span class="line-added"> 616  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 617  * @return pointer to the new CK_TLS_PRF_PARAMS structure</span>
 618  */
<span class="line-modified"> 619 CK_TLS_PRF_PARAMS_PTR</span>
<span class="line-added"> 620 jTlsPrfParamsToCKTlsPrfParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
 621 {
<span class="line-added"> 622     CK_TLS_PRF_PARAMS_PTR ckParamPtr;</span>
 623     jclass jTlsPrfParamsClass;

 624     jfieldID fieldID;
 625     jobject jSeed, jLabel, jOutput;

 626 
<span class="line-modified"> 627     if (pLength != NULL) {</span>
<span class="line-added"> 628         *pLength = 0;</span>
<span class="line-added"> 629     }</span>
 630 
<span class="line-modified"> 631     // retrieve java values</span>
 632     jTlsPrfParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_PRF_PARAMS);
<span class="line-modified"> 633     if (jTlsPrfParamsClass == NULL) { return NULL; }</span>
 634     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pSeed&quot;, &quot;[B&quot;);
<span class="line-modified"> 635     if (fieldID == NULL) { return NULL; }</span>
 636     jSeed = (*env)-&gt;GetObjectField(env, jParam, fieldID);


 637     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pLabel&quot;, &quot;[B&quot;);
<span class="line-modified"> 638     if (fieldID == NULL) { return NULL; }</span>
 639     jLabel = (*env)-&gt;GetObjectField(env, jParam, fieldID);


 640     fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pOutput&quot;, &quot;[B&quot;);
<span class="line-modified"> 641     if (fieldID == NULL) { return NULL; }</span>
 642     jOutput = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 643 
<span class="line-modified"> 644     // allocate memory for CK_TLS_PRF_PARAMS pointer</span>
<span class="line-modified"> 645     ckParamPtr = calloc(1, sizeof(CK_TLS_PRF_PARAMS));</span>
<span class="line-modified"> 646     if (ckParamPtr == NULL) {</span>
<span class="line-modified"> 647         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 648         return NULL;</span>
<span class="line-added"> 649     }</span>
<span class="line-added"> 650 </span>
<span class="line-added"> 651     // populate using java values</span>
<span class="line-added"> 652     jByteArrayToCKByteArray(env, jSeed, &amp;(ckParamPtr-&gt;pSeed), &amp;(ckParamPtr-&gt;ulSeedLen));</span>
 653     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 654         goto cleanup;</span>

 655     }
<span class="line-modified"> 656     jByteArrayToCKByteArray(env, jLabel, &amp;(ckParamPtr-&gt;pLabel), &amp;(ckParamPtr-&gt;ulLabelLen));</span>
<span class="line-modified"> 657     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified"> 658         goto cleanup;</span>



 659     }
<span class="line-modified"> 660     ckParamPtr-&gt;pulOutputLen = calloc(1, sizeof(CK_ULONG));</span>
<span class="line-added"> 661     if (ckParamPtr-&gt;pulOutputLen == NULL) {</span>
<span class="line-added"> 662         goto cleanup;</span>
<span class="line-added"> 663     }</span>
<span class="line-added"> 664     jByteArrayToCKByteArray(env, jOutput, &amp;(ckParamPtr-&gt;pOutput), ckParamPtr-&gt;pulOutputLen);</span>
 665     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 666         goto cleanup;</span>



 667     }
 668 
<span class="line-modified"> 669     if (pLength != NULL) {</span>
<span class="line-added"> 670         *pLength = sizeof(CK_TLS_PRF_PARAMS);</span>
<span class="line-added"> 671     }</span>
<span class="line-added"> 672     return ckParamPtr;</span>
<span class="line-added"> 673 cleanup:</span>
<span class="line-added"> 674     free(ckParamPtr-&gt;pSeed);</span>
<span class="line-added"> 675     free(ckParamPtr-&gt;pLabel);</span>
<span class="line-added"> 676     free(ckParamPtr-&gt;pOutput);</span>
<span class="line-added"> 677     free(ckParamPtr-&gt;pulOutputLen);</span>
<span class="line-added"> 678     free(ckParamPtr);</span>
<span class="line-added"> 679     return NULL;</span>
 680 }
 681 
 682 /*
<span class="line-modified"> 683  * converts the Java CK_TLS_MAC_PARAMS object to a CK_TLS_MAC_PARAMS pointer</span>
<span class="line-added"> 684  *</span>
<span class="line-added"> 685  * @param env - used to call JNI functions to get the Java classes and objects</span>
<span class="line-added"> 686  * @param jParam - the Java CK_TLS_MAC_PARAMS object to convert</span>
<span class="line-added"> 687  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 688  * @return pointer to the new CK_TLS_MAC_PARAMS structure</span>
 689  */
<span class="line-modified"> 690 </span>
<span class="line-added"> 691 CK_TLS_MAC_PARAMS_PTR</span>
<span class="line-added"> 692 jTlsMacParamsToCKTlsMacParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
 693 {
<span class="line-added"> 694     CK_TLS_MAC_PARAMS_PTR ckParamPtr;</span>
 695     jclass jTlsMacParamsClass;

 696     jfieldID fieldID;
 697     jlong jPrfMechanism, jUlMacLength, jUlServerOrClient;

 698 
<span class="line-modified"> 699     if (pLength != NULL) {</span>
<span class="line-modified"> 700         *pLength = 0L;</span>
<span class="line-added"> 701     }</span>
 702 
<span class="line-modified"> 703     // retrieve java values</span>
<span class="line-added"> 704     jTlsMacParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_MAC_PARAMS);</span>
<span class="line-added"> 705     if (jTlsMacParamsClass == NULL) { return NULL; }</span>
 706     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;prfMechanism&quot;, &quot;J&quot;);
<span class="line-modified"> 707     if (fieldID == NULL) { return NULL; }</span>
 708     jPrfMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);


 709     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulMacLength&quot;, &quot;J&quot;);
<span class="line-modified"> 710     if (fieldID == NULL) { return NULL; }</span>
 711     jUlMacLength = (*env)-&gt;GetLongField(env, jParam, fieldID);


 712     fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulServerOrClient&quot;, &quot;J&quot;);
<span class="line-modified"> 713     if (fieldID == NULL) { return NULL; }</span>
 714     jUlServerOrClient = (*env)-&gt;GetLongField(env, jParam, fieldID);
 715 
<span class="line-modified"> 716     // allocate memory for CK_TLS_MAC_PARAMS pointer</span>
<span class="line-modified"> 717     ckParamPtr = calloc(1, sizeof(CK_TLS_MAC_PARAMS));</span>
<span class="line-modified"> 718     if (ckParamPtr == NULL) {</span>
<span class="line-modified"> 719         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 720         return NULL;</span>
<span class="line-added"> 721     }</span>
<span class="line-added"> 722 </span>
<span class="line-added"> 723     // populate using java values</span>
<span class="line-added"> 724     ckParamPtr-&gt;prfHashMechanism = jLongToCKULong(jPrfMechanism);</span>
<span class="line-added"> 725     ckParamPtr-&gt;ulMacLength = jLongToCKULong(jUlMacLength);</span>
<span class="line-added"> 726     ckParamPtr-&gt;ulServerOrClient = jLongToCKULong(jUlServerOrClient);</span>
 727 
<span class="line-modified"> 728     if (pLength != NULL) {</span>
<span class="line-added"> 729         *pLength = sizeof(CK_TLS_MAC_PARAMS);</span>
<span class="line-added"> 730     }</span>
<span class="line-added"> 731     return ckParamPtr;</span>
 732 }
 733 
 734 void keyMatParamToCKKeyMatParam(JNIEnv *env, jobject jParam,
 735         jclass jKeyMatParamClass,
 736         CK_ULONG* cKKeyMatParamUlMacSizeInBits,
 737         CK_ULONG* cKKeyMatParamUlKeySizeInBits,
 738         CK_ULONG* cKKeyMatParamUlIVSizeInBits,
 739         CK_BBOOL* cKKeyMatParamBIsExport,
 740         CK_SSL3_RANDOM_DATA* cKKeyMatParamRandomInfo,
 741         CK_SSL3_KEY_MAT_OUT_PTR* cKKeyMatParamPReturnedKeyMaterial)
 742 {
 743     jclass jSsl3RandomDataClass, jSsl3KeyMatOutClass;
 744     jfieldID fieldID;
 745     jlong jMacSizeInBits, jKeySizeInBits, jIVSizeInBits;
 746     jboolean jIsExport;
 747     jobject jRandomInfo, jRIClientRandom, jRIServerRandom;
 748     jobject jReturnedKeyMaterial, jRMIvClient, jRMIvServer;
 749     CK_ULONG ckTemp;
 750 
<span class="line-modified"> 751     // the pointer arguments should already be initialized by caller</span>
<span class="line-added"> 752 </span>
<span class="line-added"> 753     // retrieve java values</span>
 754     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulMacSizeInBits&quot;, &quot;J&quot;);
 755     if (fieldID == NULL) { return; }
 756     jMacSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);


 757     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulKeySizeInBits&quot;, &quot;J&quot;);
 758     if (fieldID == NULL) { return; }
 759     jKeySizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);


 760     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulIVSizeInBits&quot;, &quot;J&quot;);
 761     if (fieldID == NULL) { return; }
 762     jIVSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);


 763     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;bIsExport&quot;, &quot;Z&quot;);
 764     if (fieldID == NULL) { return; }
 765     jIsExport = (*env)-&gt;GetBooleanField(env, jParam, fieldID);


 766     jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
 767     if (jSsl3RandomDataClass == NULL) { return; }
 768     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;RandomInfo&quot;,
 769             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
 770     if (fieldID == NULL) { return; }
 771     jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);


 772     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
 773     if (fieldID == NULL) { return; }
 774     jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);


 775     fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
 776     if (fieldID == NULL) { return; }
 777     jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);


 778     jSsl3KeyMatOutClass = (*env)-&gt;FindClass(env, CLASS_SSL3_KEY_MAT_OUT);
 779     if (jSsl3KeyMatOutClass == NULL) { return; }
 780     fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;pReturnedKeyMaterial&quot;,
 781             &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_OUT;&quot;);
 782     if (fieldID == NULL) { return; }
 783     jReturnedKeyMaterial = (*env)-&gt;GetObjectField(env, jParam, fieldID);


 784     fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVClient&quot;, &quot;[B&quot;);
 785     if (fieldID == NULL) { return; }
 786     jRMIvClient = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);


 787     fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVServer&quot;, &quot;[B&quot;);
 788     if (fieldID == NULL) { return; }
 789     jRMIvServer = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
 790 
<span class="line-modified"> 791     // populate the specified pointers using java values</span>
 792     *cKKeyMatParamUlMacSizeInBits = jLongToCKULong(jMacSizeInBits);
 793     *cKKeyMatParamUlKeySizeInBits = jLongToCKULong(jKeySizeInBits);
 794     *cKKeyMatParamUlIVSizeInBits = jLongToCKULong(jIVSizeInBits);
 795     *cKKeyMatParamBIsExport = jBooleanToCKBBool(jIsExport);
 796     jByteArrayToCKByteArray(env, jRIClientRandom,
 797             &amp;(cKKeyMatParamRandomInfo-&gt;pClientRandom),
 798             &amp;(cKKeyMatParamRandomInfo-&gt;ulClientRandomLen));
<span class="line-modified"> 799     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 800         // just return as no memory allocation yet</span>
<span class="line-added"> 801         return;</span>
<span class="line-added"> 802     }</span>
 803     jByteArrayToCKByteArray(env, jRIServerRandom,
 804             &amp;(cKKeyMatParamRandomInfo-&gt;pServerRandom),
 805             &amp;(cKKeyMatParamRandomInfo-&gt;ulServerRandomLen));
 806     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 807         goto cleanup;</span>

 808     }
<span class="line-modified"> 809     /* allocate memory for pReturnedKeyMaterial */</span>
 810     *cKKeyMatParamPReturnedKeyMaterial =
<span class="line-modified"> 811             (CK_SSL3_KEY_MAT_OUT_PTR) calloc(1, sizeof(CK_SSL3_KEY_MAT_OUT));</span>
 812     if (*cKKeyMatParamPReturnedKeyMaterial == NULL) {


 813         throwOutOfMemoryError(env, 0);
<span class="line-modified"> 814         goto cleanup;</span>
 815     }
 816 
 817     // the handles are output params only, no need to fetch them from Java
 818     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientMacSecret = 0;
 819     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerMacSecret = 0;
 820     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientKey = 0;
 821     (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerKey = 0;
 822 
 823     jByteArrayToCKByteArray(env, jRMIvClient,
 824             &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient), &amp;ckTemp);
 825     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 826         goto cleanup;</span>



 827     }
 828     jByteArrayToCKByteArray(env, jRMIvServer,
 829             &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVServer), &amp;ckTemp);
 830     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified"> 831         goto cleanup;</span>




 832     }
 833 
<span class="line-added"> 834     return;</span>
<span class="line-added"> 835 cleanup:</span>
<span class="line-added"> 836     free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-added"> 837     free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-added"> 838     if ((*cKKeyMatParamPReturnedKeyMaterial) != NULL) {</span>
<span class="line-added"> 839         free((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient);</span>
<span class="line-added"> 840         free(*cKKeyMatParamPReturnedKeyMaterial);</span>
<span class="line-added"> 841     }</span>
<span class="line-added"> 842     // explicitly set to NULL to ensure no double free possible</span>
<span class="line-added"> 843     cKKeyMatParamRandomInfo-&gt;pClientRandom = NULL;</span>
<span class="line-added"> 844     cKKeyMatParamRandomInfo-&gt;pServerRandom = NULL;</span>
<span class="line-added"> 845     *cKKeyMatParamPReturnedKeyMaterial = NULL;</span>
 846     return;
 847 }
 848 /*
 849  * converts the Java CK_SSL3_KEY_MAT_PARAMS object to a
<span class="line-modified"> 850  * CK_SSL3_KEY_MAT_PARAMS pointer</span>
 851  *
 852  * @param env - used to call JNI funktions to get the Java classes and objects
 853  * @param jParam - the Java CK_SSL3_KEY_MAT_PARAMS object to convert
<span class="line-modified"> 854  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 855  * @return pointer to the new CK_SSL3_KEY_MAT_PARAMS structure</span>
 856  */
<span class="line-modified"> 857 CK_SSL3_KEY_MAT_PARAMS_PTR</span>
<span class="line-modified"> 858 jSsl3KeyMatParamToCKSsl3KeyMatParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
 859 {
<span class="line-modified"> 860     CK_SSL3_KEY_MAT_PARAMS_PTR ckParamPtr;</span>
 861     jclass jSsl3KeyMatParamsClass;
<span class="line-modified"> 862 </span>
<span class="line-added"> 863     if (pLength != NULL) {</span>
<span class="line-added"> 864         *pLength = 0;</span>
<span class="line-added"> 865     }</span>
<span class="line-added"> 866 </span>
<span class="line-added"> 867     // allocate memory for CK_SSL3_KEY_MAT_PARAMS pointer</span>
<span class="line-added"> 868     ckParamPtr = calloc(1, sizeof(CK_SSL3_KEY_MAT_PARAMS));</span>
<span class="line-added"> 869     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 870         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 871         return NULL;</span>
<span class="line-added"> 872     }</span>
<span class="line-added"> 873 </span>
<span class="line-added"> 874     // retrieve and  populate using java values</span>
 875     jSsl3KeyMatParamsClass = (*env)-&gt;FindClass(env,
 876             CLASS_SSL3_KEY_MAT_PARAMS);
<span class="line-modified"> 877     if (jSsl3KeyMatParamsClass == NULL) {</span>
<span class="line-added"> 878         goto cleanup;</span>
<span class="line-added"> 879     }</span>
 880     keyMatParamToCKKeyMatParam(env, jParam, jSsl3KeyMatParamsClass,
<span class="line-modified"> 881             &amp;(ckParamPtr-&gt;ulMacSizeInBits), &amp;(ckParamPtr-&gt;ulKeySizeInBits),</span>
<span class="line-modified"> 882             &amp;(ckParamPtr-&gt;ulIVSizeInBits), &amp;(ckParamPtr-&gt;bIsExport),</span>
<span class="line-modified"> 883             &amp;(ckParamPtr-&gt;RandomInfo), &amp;(ckParamPtr-&gt;pReturnedKeyMaterial));</span>
<span class="line-modified"> 884     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 885         goto cleanup;</span>
<span class="line-added"> 886     }</span>
<span class="line-added"> 887 </span>
<span class="line-added"> 888     if (pLength != NULL) {</span>
<span class="line-added"> 889         *pLength = sizeof(CK_SSL3_KEY_MAT_PARAMS);</span>
<span class="line-added"> 890     }</span>
<span class="line-added"> 891     return ckParamPtr;</span>
<span class="line-added"> 892 cleanup:</span>
<span class="line-added"> 893     free(ckParamPtr);</span>
<span class="line-added"> 894     return NULL;</span>
 895 }
 896 
 897 /*
 898  * converts the Java CK_TLS12_KEY_MAT_PARAMS object to a
<span class="line-modified"> 899  * CK_TLS12_KEY_MAT_PARAMS pointer</span>
 900  *
 901  * @param env - used to call JNI functions to get the Java classes and objects
 902  * @param jParam - the Java CK_TLS12_KEY_MAT_PARAMS object to convert
<span class="line-modified"> 903  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 904  * @return pointer to the new CK_TLS12_KEY_MAT_PARAMS structure</span>
 905  */
<span class="line-modified"> 906 CK_TLS12_KEY_MAT_PARAMS_PTR jTls12KeyMatParamToCKTls12KeyMatParamPtr(JNIEnv *env,</span>
<span class="line-modified"> 907         jobject jParam, CK_ULONG *pLength)</span>
 908 {
<span class="line-modified"> 909     CK_TLS12_KEY_MAT_PARAMS_PTR ckParamPtr;</span>
 910     jclass jTls12KeyMatParamsClass;
 911     jfieldID fieldID;
<span class="line-modified"> 912     jlong prfHashMechanism;</span>
<span class="line-added"> 913 </span>
<span class="line-added"> 914     if (pLength != NULL) {</span>
<span class="line-added"> 915         *pLength = 0;</span>
<span class="line-added"> 916     }</span>
<span class="line-added"> 917 </span>
<span class="line-added"> 918     // retrieve java values</span>
 919     jTls12KeyMatParamsClass = (*env)-&gt;FindClass(env,
 920             CLASS_TLS12_KEY_MAT_PARAMS);
<span class="line-modified"> 921     if (jTls12KeyMatParamsClass == NULL) { return NULL; }</span>




 922     fieldID = (*env)-&gt;GetFieldID(env, jTls12KeyMatParamsClass,
 923             &quot;prfHashMechanism&quot;, &quot;J&quot;);
<span class="line-modified"> 924     if (fieldID == NULL) { return NULL; }</span>
<span class="line-modified"> 925     prfHashMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified"> 926 </span>
<span class="line-added"> 927     // allocate memory for CK_TLS12_KEY_MAT_PARAMS pointer</span>
<span class="line-added"> 928     ckParamPtr = calloc(1, sizeof(CK_TLS12_KEY_MAT_PARAMS));</span>
<span class="line-added"> 929     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 930         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 931         return NULL;</span>
<span class="line-added"> 932     }</span>
<span class="line-added"> 933 </span>
<span class="line-added"> 934     // populate using java values</span>
<span class="line-added"> 935     keyMatParamToCKKeyMatParam(env, jParam, jTls12KeyMatParamsClass,</span>
<span class="line-added"> 936             &amp;(ckParamPtr-&gt;ulMacSizeInBits), &amp;(ckParamPtr-&gt;ulKeySizeInBits),</span>
<span class="line-added"> 937             &amp;(ckParamPtr-&gt;ulIVSizeInBits), &amp;(ckParamPtr-&gt;bIsExport),</span>
<span class="line-added"> 938             &amp;(ckParamPtr-&gt;RandomInfo), &amp;(ckParamPtr-&gt;pReturnedKeyMaterial));</span>
<span class="line-added"> 939     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added"> 940         goto cleanup;</span>
 941     }
<span class="line-modified"> 942     ckParamPtr-&gt;prfHashMechanism = (CK_MECHANISM_TYPE)prfHashMechanism;</span>
<span class="line-added"> 943 </span>
<span class="line-added"> 944     if (pLength != NULL) {</span>
<span class="line-added"> 945         *pLength = sizeof(CK_TLS12_KEY_MAT_PARAMS);</span>
<span class="line-added"> 946     }</span>
<span class="line-added"> 947     return ckParamPtr;</span>
<span class="line-added"> 948 cleanup:</span>
<span class="line-added"> 949     free(ckParamPtr);</span>
<span class="line-added"> 950     return NULL;</span>
 951 }
 952 
 953 /*
<span class="line-modified"> 954  * converts the Java CK_AES_CTR_PARAMS object to a CK_AES_CTR_PARAMS pointer</span>
 955  *
 956  * @param env - used to call JNI funktions to get the Java classes and objects
 957  * @param jParam - the Java CK_AES_CTR_PARAMS object to convert
<span class="line-modified"> 958  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added"> 959  * @return pointer to the new CK_AES_CTR_PARAMS structure</span>
 960  */
<span class="line-modified"> 961 CK_AES_CTR_PARAMS_PTR</span>
<span class="line-modified"> 962 jAesCtrParamsToCKAesCtrParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
<span class="line-added"> 963 {</span>
<span class="line-added"> 964     CK_AES_CTR_PARAMS_PTR ckParamPtr;</span>
 965     jclass jAesCtrParamsClass;
 966     jfieldID fieldID;
 967     jlong jCounterBits;
 968     jobject jCb;
<span class="line-modified"> 969     CK_BYTE_PTR ckBytes = NULL;</span>
 970     CK_ULONG ckTemp;
 971 
<span class="line-modified"> 972     if (pLength != NULL) {</span>
<span class="line-added"> 973         *pLength = 0L;</span>
<span class="line-added"> 974     }</span>
<span class="line-added"> 975 </span>
<span class="line-added"> 976     // retrieve java values</span>
 977     jAesCtrParamsClass = (*env)-&gt;FindClass(env, CLASS_AES_CTR_PARAMS);
<span class="line-modified"> 978     if (jAesCtrParamsClass == NULL) { return NULL; }</span>
<span class="line-added"> 979     if (!(*env)-&gt;IsInstanceOf(env, jParam, jAesCtrParamsClass)) {</span>
<span class="line-added"> 980         return NULL;</span>
<span class="line-added"> 981     }</span>
 982     fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;ulCounterBits&quot;, &quot;J&quot;);
<span class="line-modified"> 983     if (fieldID == NULL) { return NULL; }</span>
 984     jCounterBits = (*env)-&gt;GetLongField(env, jParam, fieldID);


 985     fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;cb&quot;, &quot;[B&quot;);
<span class="line-modified"> 986     if (fieldID == NULL) { return NULL; }</span>
 987     jCb = (*env)-&gt;GetObjectField(env, jParam, fieldID);
 988 
<span class="line-modified"> 989     // allocate memory for CK_AES_CTR_PARAMS pointer</span>
<span class="line-modified"> 990     ckParamPtr = calloc(1, sizeof(CK_AES_CTR_PARAMS));</span>
<span class="line-added"> 991     if (ckParamPtr == NULL) {</span>
<span class="line-added"> 992         throwOutOfMemoryError(env, 0);</span>
<span class="line-added"> 993         return NULL;</span>
<span class="line-added"> 994     }</span>
<span class="line-added"> 995 </span>
<span class="line-added"> 996     // populate using java values</span>
 997     jByteArrayToCKByteArray(env, jCb, &amp;ckBytes, &amp;ckTemp);
<span class="line-modified"> 998     if ((*env)-&gt;ExceptionCheck(env) || ckTemp != 16) {</span>
<span class="line-modified"> 999         goto cleanup;</span>
<span class="line-modified">1000     }</span>
<span class="line-modified">1001     memcpy(ckParamPtr-&gt;cb, ckBytes, ckTemp);</span>
<span class="line-modified">1002     free(ckBytes);</span>
<span class="line-modified">1003 </span>
<span class="line-added">1004     ckParamPtr-&gt;ulCounterBits = jLongToCKULong(jCounterBits);</span>
<span class="line-added">1005 </span>
<span class="line-added">1006     if (pLength != NULL) {</span>
<span class="line-added">1007         *pLength = sizeof(CK_AES_CTR_PARAMS);</span>
1008     }
<span class="line-added">1009     return ckParamPtr;</span>
<span class="line-added">1010 cleanup:</span>
<span class="line-added">1011     free(ckBytes);</span>
<span class="line-added">1012     free(ckParamPtr);</span>
<span class="line-added">1013     return NULL;</span>
1014 }
1015 
1016 /*
<span class="line-modified">1017  * converts the Java CK_GCM_PARAMS object to a CK_GCM_PARAMS_NO_IVBITS pointer</span>
<span class="line-added">1018  * Note: Need to try NSS definition first to avoid SIGSEGV.</span>
1019  *
<span class="line-modified">1020  * @param env - used to call JNI funktions to get the Java classes and objects</span>
<span class="line-modified">1021  * @param jParam - the Java CK_GCM_PARAMS object to convert</span>
<span class="line-modified">1022  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1023  * @return pointer to the new CK_GCM_PARAMS_NO_IVBITS structure</span>
1024  */
<span class="line-modified">1025 CK_GCM_PARAMS_NO_IVBITS_PTR</span>
<span class="line-added">1026 jGCMParamsToCKGCMParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1027 {
<span class="line-modified">1028     CK_GCM_PARAMS_NO_IVBITS_PTR ckParamPtr;</span>
<span class="line-modified">1029     jclass jGcmParamsClass;</span>
<span class="line-added">1030     jfieldID fieldID;</span>
<span class="line-added">1031     jobject jIv, jAad;</span>
<span class="line-added">1032     jlong jTagLen;</span>
1033 
<span class="line-modified">1034     TRACE0(&quot;DEBUG jGCMParamsToCKGCMParam is called\n&quot;);</span>
1035 
<span class="line-modified">1036     if (pLength != NULL) {</span>
<span class="line-modified">1037         *pLength = 0L;</span>
<span class="line-modified">1038     }</span>
<span class="line-modified">1039 </span>
<span class="line-modified">1040     // retrieve java values</span>
<span class="line-modified">1041     jGcmParamsClass = (*env)-&gt;FindClass(env, CLASS_GCM_PARAMS);</span>
<span class="line-modified">1042     if (jGcmParamsClass == NULL) { return NULL; }</span>
<span class="line-modified">1043     if (!(*env)-&gt;IsInstanceOf(env, jParam, jGcmParamsClass)) {</span>
<span class="line-added">1044         return NULL;</span>
<span class="line-added">1045     }</span>
<span class="line-added">1046     fieldID = (*env)-&gt;GetFieldID(env, jGcmParamsClass, &quot;iv&quot;, &quot;[B&quot;);</span>
<span class="line-added">1047     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1048     jIv = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">1049     fieldID = (*env)-&gt;GetFieldID(env, jGcmParamsClass, &quot;aad&quot;, &quot;[B&quot;);</span>
<span class="line-added">1050     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1051     jAad = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">1052     fieldID = (*env)-&gt;GetFieldID(env, jGcmParamsClass, &quot;tagBits&quot;, &quot;J&quot;);</span>
<span class="line-added">1053     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1054     jTagLen = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-added">1055 </span>
<span class="line-added">1056     // allocate memory for CK_GCM_PARAMS_NO_IVBITS pointer</span>
<span class="line-added">1057     ckParamPtr = calloc(1, sizeof(CK_GCM_PARAMS_NO_IVBITS));</span>
<span class="line-added">1058     if (ckParamPtr == NULL) {</span>
<span class="line-added">1059         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">1060         return NULL;</span>
<span class="line-added">1061     }</span>
<span class="line-added">1062 </span>
<span class="line-added">1063     // populate using java values</span>
<span class="line-added">1064     jByteArrayToCKByteArray(env, jIv, &amp;(ckParamPtr-&gt;pIv), &amp;(ckParamPtr-&gt;ulIvLen));</span>
<span class="line-added">1065     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1066         goto cleanup;</span>
<span class="line-added">1067     }</span>
<span class="line-added">1068 </span>
<span class="line-added">1069     jByteArrayToCKByteArray(env, jAad, &amp;(ckParamPtr-&gt;pAAD), &amp;(ckParamPtr-&gt;ulAADLen));</span>
<span class="line-added">1070     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1071         goto cleanup;</span>
<span class="line-added">1072     }</span>
<span class="line-added">1073 </span>
<span class="line-added">1074     ckParamPtr-&gt;ulTagBits = jLongToCKULong(jTagLen);</span>
<span class="line-added">1075 </span>
<span class="line-added">1076     if (pLength != NULL) {</span>
<span class="line-added">1077         *pLength = sizeof(CK_GCM_PARAMS_NO_IVBITS);</span>
1078     }
<span class="line-added">1079     TRACE1(&quot;Created inner GCM_PARAMS PTR w/o ulIvBits %p\n&quot;, ckParamPtr);</span>
<span class="line-added">1080     return ckParamPtr;</span>
<span class="line-added">1081 cleanup:</span>
<span class="line-added">1082     free(ckParamPtr-&gt;pIv);</span>
<span class="line-added">1083     free(ckParamPtr-&gt;pAAD);</span>
<span class="line-added">1084     free(ckParamPtr);</span>
<span class="line-added">1085     return NULL;</span>
1086 }
1087 
1088 /*
<span class="line-modified">1089  * converts the Java CK_CCM_PARAMS object to a CK_CCM_PARAMS pointer</span>








1090  *
<span class="line-modified">1091  * @param env - used to call JNI functions to get the Java classes and objects</span>
<span class="line-modified">1092  * @param jParam - the Java CK_CCM_PARAMS object to convert</span>
<span class="line-modified">1093  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-modified">1094  * @return pointer to the new CK_CCM_PARAMS structure</span>
<span class="line-modified">1095  */</span>
<span class="line-modified">1096 CK_CCM_PARAMS_PTR</span>
<span class="line-modified">1097 jCCMParamsToCKCCMParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
<span class="line-modified">1098 {</span>
<span class="line-modified">1099     CK_CCM_PARAMS_PTR ckParamPtr;</span>
<span class="line-modified">1100     jclass jCcmParamsClass;</span>
<span class="line-modified">1101     jfieldID fieldID;</span>
<span class="line-modified">1102     jobject jNonce, jAad;</span>
<span class="line-modified">1103     jlong jDataLen, jMacLen;</span>
<span class="line-modified">1104 </span>
<span class="line-modified">1105     if (pLength != NULL) {</span>
<span class="line-modified">1106         *pLength = 0;</span>
<span class="line-modified">1107     }</span>
<span class="line-modified">1108 </span>
<span class="line-added">1109     // retrieve java values</span>
<span class="line-added">1110     jCcmParamsClass = (*env)-&gt;FindClass(env, CLASS_CCM_PARAMS);</span>
<span class="line-added">1111     if (jCcmParamsClass == NULL) { return NULL; }</span>
<span class="line-added">1112     if (!(*env)-&gt;IsInstanceOf(env, jParam, jCcmParamsClass)) {</span>
<span class="line-added">1113         return NULL;</span>
<span class="line-added">1114     }</span>
<span class="line-added">1115     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;dataLen&quot;, &quot;J&quot;);</span>
<span class="line-added">1116     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1117     jDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-added">1118     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;nonce&quot;, &quot;[B&quot;);</span>
<span class="line-added">1119     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1120     jNonce = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">1121     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;aad&quot;, &quot;[B&quot;);</span>
<span class="line-added">1122     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1123     jAad = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">1124     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;macLen&quot;, &quot;J&quot;);</span>
<span class="line-added">1125     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">1126     jMacLen = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-added">1127 </span>
<span class="line-added">1128     // allocate memory for CK_CCM_PARAMS pointer</span>
<span class="line-added">1129     ckParamPtr = calloc(1, sizeof(CK_CCM_PARAMS));</span>
<span class="line-added">1130     if (ckParamPtr == NULL) {</span>
<span class="line-added">1131         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">1132         return NULL;</span>
<span class="line-added">1133     }</span>
<span class="line-added">1134 </span>
<span class="line-added">1135     // populate using java values</span>
<span class="line-added">1136     ckParamPtr-&gt;ulDataLen = jLongToCKULong(jDataLen);</span>
<span class="line-added">1137     jByteArrayToCKByteArray(env, jNonce, &amp;(ckParamPtr-&gt;pNonce),</span>
<span class="line-added">1138             &amp;(ckParamPtr-&gt;ulNonceLen));</span>
<span class="line-added">1139     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1140         goto cleanup;</span>
<span class="line-added">1141     }</span>
<span class="line-added">1142 </span>
<span class="line-added">1143     jByteArrayToCKByteArray(env, jAad, &amp;(ckParamPtr-&gt;pAAD),</span>
<span class="line-added">1144             &amp;(ckParamPtr-&gt;ulAADLen));</span>
<span class="line-added">1145     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1146         goto cleanup;</span>
<span class="line-added">1147     }</span>
<span class="line-added">1148 </span>
<span class="line-added">1149     ckParamPtr-&gt;ulMACLen = jLongToCKULong(jMacLen);</span>
<span class="line-added">1150 </span>
<span class="line-added">1151     if (pLength != NULL) {</span>
<span class="line-added">1152         *pLength = sizeof(CK_CCM_PARAMS);</span>
<span class="line-added">1153     }</span>
<span class="line-added">1154     return ckParamPtr;</span>
<span class="line-added">1155 cleanup:</span>
<span class="line-added">1156     free(ckParamPtr-&gt;pNonce);</span>
<span class="line-added">1157     free(ckParamPtr-&gt;pAAD);</span>
<span class="line-added">1158     free(ckParamPtr);</span>
<span class="line-added">1159     return NULL;</span>
<span class="line-added">1160 }</span>
<span class="line-added">1161 </span>
<span class="line-added">1162 /*</span>
<span class="line-added">1163  * converts a Java CK_MECHANISM object into a CK_MECHANISM pointer</span>
<span class="line-added">1164  * pointer.</span>
1165  *
<span class="line-modified">1166  * @param env - used to call JNI funktions to get the values out of the Java object</span>
<span class="line-modified">1167  * @param jMech - the Java CK_MECHANISM object to convert</span>
<span class="line-modified">1168  * @return pointer to the new CK_MECHANISM structure</span>


1169  */
<span class="line-added">1170 CK_MECHANISM_PTR jMechanismToCKMechanismPtr(JNIEnv *env, jobject jMech)</span>
<span class="line-added">1171 {</span>
<span class="line-added">1172     CK_MECHANISM_PTR ckpMech;</span>
<span class="line-added">1173     jlong jMechType = (*env)-&gt;GetLongField(env, jMech, mech_mechanismID);</span>
<span class="line-added">1174     jobject jParam = (*env)-&gt;GetObjectField(env, jMech, mech_pParameterID);</span>
<span class="line-added">1175 </span>
<span class="line-added">1176     /* allocate memory for CK_MECHANISM_PTR */</span>
<span class="line-added">1177     ckpMech =  (CK_MECHANISM_PTR) calloc(1, sizeof(CK_MECHANISM));</span>
<span class="line-added">1178     if (ckpMech == NULL) {</span>
<span class="line-added">1179         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">1180         return NULL;</span>
<span class="line-added">1181     }</span>
<span class="line-added">1182     TRACE1(&quot;DEBUG jMechanismToCKMechanismPtr: allocated mech %p\n&quot;, ckpMech);</span>
<span class="line-added">1183 </span>
<span class="line-added">1184     ckpMech-&gt;mechanism = jLongToCKULong(jMechType);</span>
<span class="line-added">1185 </span>
<span class="line-added">1186     /* convert the specific Java mechanism parameter object to a pointer to a</span>
<span class="line-added">1187      *  CK-type mechanism structure</span>
<span class="line-added">1188      */</span>
<span class="line-added">1189     if (jParam == NULL) {</span>
<span class="line-added">1190         ckpMech-&gt;pParameter = NULL;</span>
<span class="line-added">1191         ckpMech-&gt;ulParameterLen = 0;</span>
<span class="line-added">1192     } else {</span>
<span class="line-added">1193         ckpMech-&gt;pParameter = jMechParamToCKMechParamPtr(env, jParam,</span>
<span class="line-added">1194             ckpMech-&gt;mechanism, &amp;(ckpMech-&gt;ulParameterLen));</span>
<span class="line-added">1195     }</span>
<span class="line-added">1196     return ckpMech;</span>
<span class="line-added">1197 }</span>
1198 
1199 /*
<span class="line-modified">1200  * converts the pValue of a CK_ATTRIBUTE structure into a Java Object by</span>
<span class="line-modified">1201  * checking the type of the attribute. A PKCS#11 attribute value can</span>
<span class="line-added">1202  * be a CK_ULONG, CK_BYTE[], CK_CHAR[], big integer, CK_BBOOL, CK_UTF8CHAR[],</span>
<span class="line-added">1203  * CK_DATE or CK_FLAGS that gets converted to a corresponding Java object.</span>
1204  *
<span class="line-modified">1205  * @param env - used to call JNI functions to create the new Java object</span>
1206  * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure that contains the type
1207  *                       and the pValue to convert
<span class="line-modified">1208  * @return the new Java object of the CK-type pValue</span>
1209  */
1210 jobject ckAttributeValueToJObject(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
1211 {
1212     jint jValueLength;
1213     jobject jValueObject = NULL;
1214 
1215     jValueLength = ckULongToJInt(ckpAttribute-&gt;ulValueLen);
1216 
1217     if ((jValueLength &lt;= 0) || (ckpAttribute-&gt;pValue == NULL)) {
1218         return NULL ;
1219     }
1220 
1221     switch(ckpAttribute-&gt;type) {
1222         case CKA_CLASS:
1223             /* value CK_OBJECT_CLASS, defacto a CK_ULONG */
1224         case CKA_KEY_TYPE:
1225             /* value CK_KEY_TYPE, defacto a CK_ULONG */
1226         case CKA_CERTIFICATE_TYPE:
1227             /* value CK_CERTIFICATE_TYPE, defacto a CK_ULONG */
1228         case CKA_HW_FEATURE_TYPE:
</pre>
<hr />
<pre>
1331             break;
1332     }
1333 
1334     return jValueObject ;
1335 }
1336 
1337 /*
1338  * the following functions convert a Java mechanism parameter object to a PKCS#11
1339  * mechanism parameter structure
1340  *
1341  * CK_&lt;Param&gt;_PARAMS j&lt;Param&gt;ParamToCK&lt;Param&gt;Param(JNIEnv *env,
1342  *                                                 jobject jParam);
1343  *
1344  * These functions get a Java object, that must be the right Java mechanism
1345  * object and they return the new PKCS#11 mechanism parameter structure.
1346  * Every field of the Java object is retrieved, gets converted to a corresponding
1347  * PKCS#11 type and is set in the new PKCS#11 structure.
1348  */
1349 
1350 /*
<span class="line-modified">1351  * converts the given Java mechanism parameter to a CK mechanism parameter</span>
<span class="line-modified">1352  * pointer and store the length in bytes in the length variable.</span>

1353  *
1354  * @param env - used to call JNI funktions to get the Java classes and objects
1355  * @param jParam - the Java mechanism parameter object to convert
<span class="line-modified">1356  * @param ckMech - the PKCS#11 mechanism type</span>

1357  * @param ckpLength - the reference of the length in bytes of the new CK mechanism parameter
1358  *                    structure
<span class="line-added">1359  * @return pointer to the new CK mechanism parameter structure</span>
1360  */
<span class="line-modified">1361 CK_VOID_PTR jMechParamToCKMechParamPtr(JNIEnv *env, jobject jParam,</span>
<span class="line-added">1362         CK_MECHANISM_TYPE ckMech, CK_ULONG *ckpLength)</span>
1363 {
<span class="line-added">1364     CK_VOID_PTR ckpParamPtr;</span>
1365     if (jParam == NULL) {
<span class="line-modified">1366         ckpParamPtr = NULL;</span>
1367         *ckpLength = 0;
1368     } else if ((*env)-&gt;IsInstanceOf(env, jParam, jByteArrayClass)) {
<span class="line-modified">1369         jByteArrayToCKByteArray(env, jParam, (CK_BYTE_PTR *) &amp;ckpParamPtr, ckpLength);</span>
1370     } else if ((*env)-&gt;IsInstanceOf(env, jParam, jLongClass)) {
<span class="line-modified">1371         ckpParamPtr = jLongObjectToCKULongPtr(env, jParam);</span>
1372         *ckpLength = sizeof(CK_ULONG);
1373     } else {
<span class="line-modified">1374         ckpParamPtr = jMechParamToCKMechParamPtrSlow(env, jParam, ckMech, ckpLength);</span>

1375     }
<span class="line-added">1376     return ckpParamPtr;</span>
1377 }
1378 
<span class="line-modified">1379 CK_VOID_PTR jMechParamToCKMechParamPtrSlow(JNIEnv *env, jobject jParam,</span>
<span class="line-added">1380         CK_MECHANISM_TYPE ckMech, CK_ULONG *ckpLength)</span>
1381 {
<span class="line-modified">1382     CK_VOID_PTR ckpParamPtr = NULL;</span>









1383 
<span class="line-modified">1384     /*</span>
<span class="line-modified">1385      * Most common cases, i.e. NULL/byte[]/long, are already handled by</span>
<span class="line-added">1386      * jMechParamToCKMechParam before calling this method.</span>
1387      */
<span class="line-modified">1388     TRACE1(&quot;\nDEBUG: jMechParamToCKMechParamPtrSlow, mech=0x%lX\n&quot;, ckMech);</span>
<span class="line-modified">1389 </span>
<span class="line-modified">1390     switch (ckMech) {</span>
<span class="line-modified">1391         case CKM_SSL3_PRE_MASTER_KEY_GEN:</span>
<span class="line-modified">1392         case CKM_TLS_PRE_MASTER_KEY_GEN:</span>
<span class="line-modified">1393             ckpParamPtr = jVersionToCKVersionPtr(env, jParam);</span>
<span class="line-modified">1394             if (ckpParamPtr != NULL) {</span>
<span class="line-modified">1395                 *ckpLength = sizeof(CK_VERSION);</span>
<span class="line-modified">1396             } else {</span>
<span class="line-modified">1397                 *ckpLength = 0;</span>
<span class="line-modified">1398             }</span>
<span class="line-modified">1399             break;</span>
<span class="line-modified">1400         case CKM_SSL3_MASTER_KEY_DERIVE:</span>
<span class="line-modified">1401         case CKM_TLS_MASTER_KEY_DERIVE:</span>
<span class="line-modified">1402         case CKM_SSL3_MASTER_KEY_DERIVE_DH:</span>
<span class="line-modified">1403         case CKM_TLS_MASTER_KEY_DERIVE_DH:</span>
<span class="line-modified">1404             ckpParamPtr = jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParamPtr(env, jParam,</span>
<span class="line-modified">1405                     ckpLength);</span>
<span class="line-modified">1406             break;</span>
<span class="line-modified">1407         case CKM_SSL3_KEY_AND_MAC_DERIVE:</span>
<span class="line-modified">1408         case CKM_TLS_KEY_AND_MAC_DERIVE:</span>
<span class="line-modified">1409             ckpParamPtr = jSsl3KeyMatParamToCKSsl3KeyMatParamPtr(env, jParam,</span>
<span class="line-modified">1410                     ckpLength);</span>
<span class="line-modified">1411             break;</span>
<span class="line-modified">1412         case CKM_TLS12_KEY_AND_MAC_DERIVE:</span>
<span class="line-modified">1413             ckpParamPtr = jTls12KeyMatParamToCKTls12KeyMatParamPtr(env, jParam,</span>
<span class="line-modified">1414                     ckpLength);</span>
<span class="line-modified">1415             break;</span>
<span class="line-modified">1416         case CKM_TLS12_MASTER_KEY_DERIVE:</span>
<span class="line-modified">1417         case CKM_TLS12_MASTER_KEY_DERIVE_DH:</span>
<span class="line-modified">1418             ckpParamPtr = jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParamPtr(env, jParam,</span>
<span class="line-modified">1419                     ckpLength);</span>
<span class="line-modified">1420             break;</span>
<span class="line-modified">1421         case CKM_TLS_PRF:</span>
<span class="line-modified">1422         case CKM_NSS_TLS_PRF_GENERAL:</span>
<span class="line-modified">1423             ckpParamPtr = jTlsPrfParamsToCKTlsPrfParamPtr(env, jParam,</span>
<span class="line-modified">1424                     ckpLength);</span>
<span class="line-modified">1425             break;</span>
<span class="line-modified">1426         case CKM_TLS_MAC:</span>
<span class="line-modified">1427             ckpParamPtr = jTlsMacParamsToCKTlsMacParamPtr(env, jParam,</span>
<span class="line-modified">1428                     ckpLength);</span>
<span class="line-modified">1429             break;</span>
<span class="line-modified">1430         case CKM_AES_CTR:</span>
<span class="line-modified">1431             ckpParamPtr = jAesCtrParamsToCKAesCtrParamPtr(env, jParam,</span>
<span class="line-modified">1432                     ckpLength);</span>
<span class="line-modified">1433             break;</span>
<span class="line-modified">1434         case CKM_AES_GCM:</span>
<span class="line-modified">1435             ckpParamPtr = jGCMParamsToCKGCMParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1436             break;</span>
<span class="line-modified">1437         case CKM_AES_CCM:</span>
<span class="line-modified">1438             ckpParamPtr = jCCMParamsToCKCCMParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1439             break;</span>
<span class="line-modified">1440         case CKM_RSA_PKCS_OAEP:</span>
<span class="line-modified">1441             ckpParamPtr = jRsaPkcsOaepParamToCKRsaPkcsOaepParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1442             break;</span>
<span class="line-modified">1443         case CKM_PBE_SHA1_DES3_EDE_CBC:</span>
<span class="line-modified">1444         case CKM_PBE_SHA1_DES2_EDE_CBC:</span>
<span class="line-modified">1445         case CKM_PBA_SHA1_WITH_SHA1_HMAC:</span>
<span class="line-modified">1446             ckpParamPtr = jPbeParamToCKPbeParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1447             break;</span>
<span class="line-modified">1448         case CKM_PKCS5_PBKD2:</span>
<span class="line-modified">1449             ckpParamPtr = jPkcs5Pbkd2ParamToCKPkcs5Pbkd2ParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1450             break;</span>
<span class="line-modified">1451         case CKM_RSA_PKCS_PSS:</span>
<span class="line-modified">1452         case CKM_SHA1_RSA_PKCS_PSS:</span>
<span class="line-modified">1453         case CKM_SHA256_RSA_PKCS_PSS:</span>
<span class="line-modified">1454         case CKM_SHA384_RSA_PKCS_PSS:</span>
<span class="line-modified">1455         case CKM_SHA512_RSA_PKCS_PSS:</span>
<span class="line-modified">1456         case CKM_SHA224_RSA_PKCS_PSS:</span>
<span class="line-modified">1457             ckpParamPtr = jRsaPkcsPssParamToCKRsaPkcsPssParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1458             break;</span>
<span class="line-modified">1459         case CKM_ECDH1_DERIVE:</span>
<span class="line-modified">1460         case CKM_ECDH1_COFACTOR_DERIVE:</span>
<span class="line-modified">1461             ckpParamPtr = jEcdh1DeriveParamToCKEcdh1DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1462             break;</span>
<span class="line-modified">1463         case CKM_ECMQV_DERIVE:</span>
<span class="line-modified">1464             ckpParamPtr = jEcdh2DeriveParamToCKEcdh2DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1465             break;</span>
<span class="line-modified">1466         case CKM_X9_42_DH_DERIVE:</span>
<span class="line-modified">1467             ckpParamPtr = jX942Dh1DeriveParamToCKX942Dh1DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1468             break;</span>
<span class="line-modified">1469         case CKM_X9_42_DH_HYBRID_DERIVE:</span>
<span class="line-modified">1470         case CKM_X9_42_MQV_DERIVE:</span>
<span class="line-modified">1471             ckpParamPtr = jX942Dh2DeriveParamToCKX942Dh2DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1472             break;</span>
<span class="line-modified">1473         // defined by pkcs11.h but we don&#39;t support</span>
<span class="line-modified">1474         case CKM_KEA_DERIVE: // CK_KEA_DERIVE_PARAMS</span>
<span class="line-modified">1475         case CKM_RC2_CBC: // CK_RC2_CBC_PARAMS</span>
<span class="line-modified">1476         case CKM_RC2_MAC_GENERAL: // CK_RC2_MAC_GENERAL_PARAMS</span>
<span class="line-modified">1477         case CKM_RC5_ECB: // CK_RC5_PARAMS</span>
<span class="line-modified">1478         case CKM_RC5_MAC: // CK_RC5_PARAMS</span>
<span class="line-modified">1479         case CKM_RC5_CBC: // CK_RC5_CBC_PARAMS</span>
<span class="line-modified">1480         case CKM_RC5_MAC_GENERAL: // CK_RC5_MAC_GENERAL_PARAMS</span>
<span class="line-modified">1481         case CKM_SKIPJACK_PRIVATE_WRAP: // CK_SKIPJACK_PRIVATE_WRAP_PARAMS</span>
<span class="line-modified">1482         case CKM_SKIPJACK_RELAYX: // CK_SKIPJACK_RELAYX_PARAMS</span>
<span class="line-modified">1483         case CKM_KEY_WRAP_SET_OAEP: // CK_KEY_WRAP_SET_OAEP_PARAMS</span>
<span class="line-modified">1484             throwPKCS11RuntimeException(env, &quot;No parameter support for this mchanism&quot;);</span>
<span class="line-modified">1485             break;</span>
<span class="line-modified">1486         default:</span>
<span class="line-modified">1487             /* if everything faild up to here */</span>
<span class="line-modified">1488             /* try if the parameter is a primitive Java type */</span>
<span class="line-modified">1489             ckpParamPtr = jObjectToPrimitiveCKObjectPtr(env, jParam, ckpLength);</span>
<span class="line-modified">1490             /* *ckpParamPtr = jObjectToCKVoidPtr(jParam); */</span>
<span class="line-modified">1491             /* *ckpLength = 1; */</span>
































































































































































































































































































1492     }
<span class="line-added">1493     TRACE0(&quot;\nDEBUG: jMechParamToCKMechParamPtrSlow FINISHED\n&quot;);</span>
1494 
<span class="line-modified">1495     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">1496         return NULL;</span>























1497     }
1498 
<span class="line-modified">1499     return ckpParamPtr;</span>






1500 }
1501 



1502 /*
<span class="line-modified">1503  * converts the Java CK_RSA_PKCS_OAEP_PARAMS object to a</span>
<span class="line-added">1504  * CK_RSA_PKCS_OAEP_PARAMS pointer</span>
1505  *
1506  * @param env - used to call JNI funktions to get the Java classes and objects
1507  * @param jParam - the Java CK_RSA_PKCS_OAEP_PARAMS object to convert
<span class="line-modified">1508  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1509  * @return pointer to the new CK_RSA_PKCS_OAEP_PARAMS structure</span>
1510  */
<span class="line-modified">1511 CK_RSA_PKCS_OAEP_PARAMS_PTR</span>
<span class="line-added">1512 jRsaPkcsOaepParamToCKRsaPkcsOaepParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1513 {
<span class="line-added">1514     CK_RSA_PKCS_OAEP_PARAMS_PTR ckParamPtr;</span>
1515     jclass jRsaPkcsOaepParamsClass;

1516     jfieldID fieldID;
1517     jlong jHashAlg, jMgf, jSource;
1518     jobject jSourceData;


1519 
<span class="line-modified">1520     if (pLength!= NULL) {</span>
<span class="line-added">1521         *pLength = 0L;</span>
<span class="line-added">1522     }</span>
<span class="line-added">1523 </span>
<span class="line-added">1524     // retrieve java values</span>
1525     jRsaPkcsOaepParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_OAEP_PARAMS);
<span class="line-modified">1526     if (jRsaPkcsOaepParamsClass == NULL) { return NULL; }</span>
1527     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<span class="line-modified">1528     if (fieldID == NULL) { return NULL; }</span>
1529     jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);


1530     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<span class="line-modified">1531     if (fieldID == NULL) { return NULL; }</span>
1532     jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);


1533     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;source&quot;, &quot;J&quot;);
<span class="line-modified">1534     if (fieldID == NULL) { return NULL; }</span>
1535     jSource = (*env)-&gt;GetLongField(env, jParam, fieldID);


1536     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;pSourceData&quot;, &quot;[B&quot;);
<span class="line-modified">1537     if (fieldID == NULL) { return NULL; }</span>
1538     jSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1539 
<span class="line-modified">1540     // allocate memory for CK_RSA_PKCS_OAEP_PARAMS pointer</span>
<span class="line-modified">1541     ckParamPtr = calloc(1, sizeof(CK_RSA_PKCS_OAEP_PARAMS));</span>
<span class="line-modified">1542     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1543         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1544         return NULL;</span>
<span class="line-modified">1545     }</span>
<span class="line-modified">1546 </span>
<span class="line-added">1547     // populate using java values</span>
<span class="line-added">1548     ckParamPtr-&gt;hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-added">1549     ckParamPtr-&gt;mgf = jLongToCKULong(jMgf);</span>
<span class="line-added">1550     ckParamPtr-&gt;source = jLongToCKULong(jSource);</span>
<span class="line-added">1551     jByteArrayToCKByteArray(env, jSourceData, (CK_BYTE_PTR*) &amp;(ckParamPtr-&gt;pSourceData),</span>
<span class="line-added">1552             &amp;(ckParamPtr-&gt;ulSourceDataLen));</span>
<span class="line-added">1553     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1554         free(ckParamPtr);</span>
<span class="line-added">1555         return NULL;</span>
<span class="line-added">1556     }</span>
1557 
<span class="line-modified">1558     if (pLength!= NULL) {</span>
<span class="line-added">1559         *pLength = sizeof(CK_RSA_PKCS_OAEP_PARAMS);</span>
<span class="line-added">1560     }</span>
<span class="line-added">1561     return ckParamPtr;</span>
1562 }
1563 
1564 /*
<span class="line-modified">1565  * converts the Java CK_PBE_PARAMS object to a CK_PBE_PARAMS pointer</span>
1566  *
1567  * @param env - used to call JNI funktions to get the Java classes and objects
1568  * @param jParam - the Java CK_PBE_PARAMS object to convert
<span class="line-modified">1569  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1570  * @return pointer to the new CK_PBE_PARAMS structure</span>
1571  */
<span class="line-modified">1572 CK_PBE_PARAMS_PTR</span>
<span class="line-added">1573 jPbeParamToCKPbeParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1574 {
<span class="line-added">1575     CK_PBE_PARAMS_PTR ckParamPtr;</span>
1576     jclass jPbeParamsClass;

1577     jfieldID fieldID;
1578     jlong jIteration;
1579     jobject jInitVector, jPassword, jSalt;
1580     CK_ULONG ckTemp;

1581 
<span class="line-modified">1582     if (pLength != NULL) {</span>
<span class="line-added">1583         *pLength = 0;</span>
<span class="line-added">1584     }</span>
<span class="line-added">1585 </span>
<span class="line-added">1586     // retrieve java values</span>
1587     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
<span class="line-modified">1588     if (jPbeParamsClass == NULL) { return NULL; }</span>
1589     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVector&quot;, &quot;[C&quot;);
<span class="line-modified">1590     if (fieldID == NULL) { return NULL; }</span>
1591     jInitVector = (*env)-&gt;GetObjectField(env, jParam, fieldID);


1592     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pPassword&quot;, &quot;[C&quot;);
<span class="line-modified">1593     if (fieldID == NULL) { return NULL; }</span>
1594     jPassword = (*env)-&gt;GetObjectField(env, jParam, fieldID);


1595     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pSalt&quot;, &quot;[C&quot;);
<span class="line-modified">1596     if (fieldID == NULL) { return NULL; }</span>
1597     jSalt = (*env)-&gt;GetObjectField(env, jParam, fieldID);


1598     fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;ulIteration&quot;, &quot;J&quot;);
<span class="line-modified">1599     if (fieldID == NULL) { return NULL; }</span>
1600     jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
1601 
<span class="line-modified">1602     // allocate memory for CK_PBE_PARAMS pointer</span>
<span class="line-modified">1603     ckParamPtr = calloc(1, sizeof(CK_PBE_PARAMS));</span>
<span class="line-modified">1604     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1605         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1606         return NULL;</span>
<span class="line-added">1607     }</span>
<span class="line-added">1608 </span>
<span class="line-added">1609     // populate using java values</span>
<span class="line-added">1610     ckParamPtr-&gt;ulIteration = jLongToCKULong(jIteration);</span>
<span class="line-added">1611     jCharArrayToCKCharArray(env, jInitVector, &amp;(ckParamPtr-&gt;pInitVector), &amp;ckTemp);</span>
<span class="line-added">1612     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1613         goto cleanup;</span>
<span class="line-added">1614     }</span>
<span class="line-added">1615     jCharArrayToCKCharArray(env, jPassword, &amp;(ckParamPtr-&gt;pPassword), &amp;(ckParamPtr-&gt;ulPasswordLen));</span>
1616     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1617         goto cleanup;</span>

1618     }
<span class="line-modified">1619     jCharArrayToCKCharArray(env, jSalt, &amp;(ckParamPtr-&gt;pSalt), &amp;(ckParamPtr-&gt;ulSaltLen));</span>
1620     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1621         goto cleanup;</span>


1622     }
1623 
<span class="line-modified">1624     if (pLength != NULL) {</span>
<span class="line-added">1625         *pLength = sizeof(CK_PBE_PARAMS);</span>
<span class="line-added">1626     }</span>
<span class="line-added">1627     return ckParamPtr;</span>
<span class="line-added">1628 cleanup:</span>
<span class="line-added">1629     free(ckParamPtr-&gt;pInitVector);</span>
<span class="line-added">1630     free(ckParamPtr-&gt;pPassword);</span>
<span class="line-added">1631     free(ckParamPtr-&gt;pSalt);</span>
<span class="line-added">1632     free(ckParamPtr);</span>
<span class="line-added">1633     return NULL;</span>
1634 }
1635 
1636 /*
1637  * Copy back the initialization vector from the native structure to the
1638  * Java object. This is only used for CKM_PBE_* mechanisms and their
1639  * CK_PBE_PARAMS parameters.
1640  *
1641  */
1642 void copyBackPBEInitializationVector(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism)
1643 {
1644     jclass jMechanismClass, jPbeParamsClass;
1645     CK_PBE_PARAMS *ckParam;
1646     jfieldID fieldID;
1647     CK_MECHANISM_TYPE ckMechanismType;
1648     jlong jMechanismType;
1649     jobject jParameter;
1650     jobject jInitVector;
1651     jint jInitVectorLength;
1652     CK_CHAR_PTR initVector;
1653     int i;
1654     jchar* jInitVectorChars;
1655 
1656     /* get mechanism */
1657     jMechanismClass = (*env)-&gt;FindClass(env, CLASS_MECHANISM);
1658     if (jMechanismClass == NULL) { return; }
1659     fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;mechanism&quot;, &quot;J&quot;);
1660     if (fieldID == NULL) { return; }
1661     jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, fieldID);
1662     ckMechanismType = jLongToCKULong(jMechanismType);
1663     if (ckMechanismType != ckMechanism-&gt;mechanism) {
<span class="line-modified">1664         /* we do not have matching types, this should not occur */</span>
1665         return;
1666     }
1667 
1668     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
1669     if (jPbeParamsClass == NULL) { return; }
1670     ckParam = (CK_PBE_PARAMS *) ckMechanism-&gt;pParameter;
1671     if (ckParam != NULL_PTR) {
1672         initVector = ckParam-&gt;pInitVector;
1673         if (initVector != NULL_PTR) {
1674             /* get pParameter */
1675             fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;pParameter&quot;, &quot;Ljava/lang/Object;&quot;);
1676             if (fieldID == NULL) { return; }
1677             jParameter = (*env)-&gt;GetObjectField(env, jMechanism, fieldID);
1678             fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVektor&quot;, &quot;[C&quot;);
1679             if (fieldID == NULL) { return; }
1680             jInitVector = (*env)-&gt;GetObjectField(env, jParameter, fieldID);
1681 
1682             if (jInitVector != NULL) {
1683                 jInitVectorLength = (*env)-&gt;GetArrayLength(env, jInitVector);
1684                 jInitVectorChars = (*env)-&gt;GetCharArrayElements(env, jInitVector, NULL);
1685                 if (jInitVectorChars == NULL) { return; }
1686 
1687                 /* copy the chars to the Java buffer */
1688                 for (i=0; i &lt; jInitVectorLength; i++) {
1689                     jInitVectorChars[i] = ckCharToJChar(initVector[i]);
1690                 }
1691                 /* copy back the Java buffer to the object */
1692                 (*env)-&gt;ReleaseCharArrayElements(env, jInitVector, jInitVectorChars, 0);
1693             }
1694         }
1695     }
1696 }
1697 
1698 /*
<span class="line-modified">1699  * converts the Java CK_PKCS5_PBKD2_PARAMS object to a CK_PKCS5_PBKD2_PARAMS</span>
<span class="line-added">1700  * pointer</span>
1701  *
1702  * @param env - used to call JNI funktions to get the Java classes and objects
1703  * @param jParam - the Java CK_PKCS5_PBKD2_PARAMS object to convert
<span class="line-modified">1704  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1705  * @return pointer to the new CK_PKCS5_PBKD2_PARAMS structure</span>
1706  */
<span class="line-modified">1707 CK_PKCS5_PBKD2_PARAMS_PTR</span>
<span class="line-added">1708 jPkcs5Pbkd2ParamToCKPkcs5Pbkd2ParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1709 {
<span class="line-added">1710     CK_PKCS5_PBKD2_PARAMS_PTR ckParamPtr;</span>
1711     jclass jPkcs5Pbkd2ParamsClass;

1712     jfieldID fieldID;
1713     jlong jSaltSource, jIteration, jPrf;
1714     jobject jSaltSourceData, jPrfData;

1715 
<span class="line-modified">1716     if (pLength != NULL) {</span>
<span class="line-added">1717         *pLength = 0L;</span>
<span class="line-added">1718     }</span>
<span class="line-added">1719 </span>
<span class="line-added">1720     // retrieve java values</span>
1721     jPkcs5Pbkd2ParamsClass = (*env)-&gt;FindClass(env, CLASS_PKCS5_PBKD2_PARAMS);
<span class="line-modified">1722     if (jPkcs5Pbkd2ParamsClass == NULL) { return NULL; }</span>
1723     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;saltSource&quot;, &quot;J&quot;);
<span class="line-modified">1724     if (fieldID == NULL) { return NULL; }</span>
1725     jSaltSource = (*env)-&gt;GetLongField(env, jParam, fieldID);


1726     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pSaltSourceData&quot;, &quot;[B&quot;);
<span class="line-modified">1727     if (fieldID == NULL) { return NULL; }</span>
1728     jSaltSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);


1729     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;iterations&quot;, &quot;J&quot;);
<span class="line-modified">1730     if (fieldID == NULL) { return NULL; }</span>
1731     jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);


1732     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;prf&quot;, &quot;J&quot;);
<span class="line-modified">1733     if (fieldID == NULL) { return NULL; }</span>
1734     jPrf = (*env)-&gt;GetLongField(env, jParam, fieldID);


1735     fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pPrfData&quot;, &quot;[B&quot;);
<span class="line-modified">1736     if (fieldID == NULL) { return NULL; }</span>
1737     jPrfData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1738 
<span class="line-modified">1739     // allocate memory for CK_PKCS5_PBKD2_PARAMS pointer</span>
<span class="line-modified">1740     ckParamPtr = calloc(1, sizeof(CK_PKCS5_PBKD2_PARAMS));</span>
<span class="line-modified">1741     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1742         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1743         return NULL;</span>
<span class="line-modified">1744     }</span>
<span class="line-modified">1745 </span>
<span class="line-added">1746     // populate using java values</span>
<span class="line-added">1747     ckParamPtr-&gt;saltSource = jLongToCKULong(jSaltSource);</span>
<span class="line-added">1748     jByteArrayToCKByteArray(env, jSaltSourceData, (CK_BYTE_PTR *)</span>
<span class="line-added">1749             &amp;(ckParamPtr-&gt;pSaltSourceData), &amp;(ckParamPtr-&gt;ulSaltSourceDataLen));</span>
1750     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1751         goto cleanup;</span>
<span class="line-modified">1752     }</span>
<span class="line-added">1753     ckParamPtr-&gt;iterations = jLongToCKULong(jIteration);</span>
<span class="line-added">1754     ckParamPtr-&gt;prf = jLongToCKULong(jPrf);</span>
<span class="line-added">1755     jByteArrayToCKByteArray(env, jPrfData, (CK_BYTE_PTR *)</span>
<span class="line-added">1756             &amp;(ckParamPtr-&gt;pPrfData), &amp;(ckParamPtr-&gt;ulPrfDataLen));</span>
<span class="line-added">1757     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1758         goto cleanup;</span>
<span class="line-added">1759     }</span>
<span class="line-added">1760 </span>
<span class="line-added">1761     if (pLength != NULL) {</span>
<span class="line-added">1762         *pLength = sizeof(CK_PKCS5_PBKD2_PARAMS);</span>
1763     }
<span class="line-added">1764     return ckParamPtr;</span>
<span class="line-added">1765 cleanup:</span>
<span class="line-added">1766     free(ckParamPtr-&gt;pSaltSourceData);</span>
<span class="line-added">1767     free(ckParamPtr-&gt;pPrfData);</span>
<span class="line-added">1768     free(ckParamPtr);</span>
<span class="line-added">1769     return NULL;</span>
1770 

1771 }
1772 
1773 /*
<span class="line-modified">1774  * converts the Java CK_RSA_PKCS_PSS_PARAMS object to a CK_RSA_PKCS_PSS_PARAMS</span>
<span class="line-added">1775  * pointer</span>
1776  *
1777  * @param env - used to call JNI funktions to get the Java classes and objects
1778  * @param jParam - the Java CK_RSA_PKCS_PSS_PARAMS object to convert
<span class="line-modified">1779  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1780  * @return pointer to the new CK_RSA_PKCS_PSS_PARAMS structure</span>
1781  */
<span class="line-modified">1782 CK_RSA_PKCS_PSS_PARAMS_PTR</span>
<span class="line-added">1783 jRsaPkcsPssParamToCKRsaPkcsPssParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1784 {
<span class="line-added">1785     CK_RSA_PKCS_PSS_PARAMS_PTR ckParamPtr;</span>
1786     jclass jRsaPkcsPssParamsClass;

1787     jfieldID fieldID;
1788     jlong jHashAlg, jMgf, jSLen;

1789 
<span class="line-modified">1790     if (pLength != NULL) {</span>
<span class="line-added">1791         *pLength = 0;</span>
<span class="line-added">1792     }</span>
<span class="line-added">1793 </span>
<span class="line-added">1794     // retrieve java values</span>
1795     jRsaPkcsPssParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_PSS_PARAMS);
<span class="line-modified">1796     if (jRsaPkcsPssParamsClass == NULL) { return NULL; }</span>
1797     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<span class="line-modified">1798     if (fieldID == NULL) { return NULL; }</span>
1799     jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);


1800     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<span class="line-modified">1801     if (fieldID == NULL) { return NULL; }</span>
1802     jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);


1803     fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;sLen&quot;, &quot;J&quot;);
<span class="line-modified">1804     if (fieldID == NULL) { return NULL; }</span>
1805     jSLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
1806 
<span class="line-modified">1807     // allocate memory for CK_RSA_PKCS_PSS_PARAMS pointer</span>
<span class="line-modified">1808     ckParamPtr = calloc(1, sizeof(CK_RSA_PKCS_PSS_PARAMS));</span>
<span class="line-modified">1809     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1810         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">1811         return NULL;</span>
<span class="line-added">1812     }</span>
<span class="line-added">1813 </span>
<span class="line-added">1814     // populate using java values</span>
<span class="line-added">1815     ckParamPtr-&gt;hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-added">1816     ckParamPtr-&gt;mgf = jLongToCKULong(jMgf);</span>
<span class="line-added">1817     ckParamPtr-&gt;sLen = jLongToCKULong(jSLen);</span>
<span class="line-added">1818     TRACE1(&quot;DEBUG: jRsaPkcsPssParamToCKRsaPkcsPssParam, hashAlg=0x%lX\n&quot;, ckParamPtr-&gt;hashAlg);</span>
<span class="line-added">1819     TRACE1(&quot;DEBUG: jRsaPkcsPssParamToCKRsaPkcsPssParam, mgf=0x%lX\n&quot;, ckParamPtr-&gt;mgf);</span>
<span class="line-added">1820     TRACE1(&quot;DEBUG: jRsaPkcsPssParamToCKRsaPkcsPssParam, sLen=%lu\n&quot;, ckParamPtr-&gt;sLen);</span>
<span class="line-added">1821 </span>
<span class="line-added">1822     if (pLength != NULL) {</span>
<span class="line-added">1823         *pLength = sizeof(CK_RSA_PKCS_PSS_PARAMS);</span>
<span class="line-added">1824     }</span>
<span class="line-added">1825     return ckParamPtr;</span>
1826 

1827 }
1828 
1829 /*
<span class="line-modified">1830  * converts the Java CK_ECDH1_DERIVE_PARAMS object to a CK_ECDH1_DERIVE_PARAMS</span>
<span class="line-added">1831  * pointer</span>
1832  *
1833  * @param env - used to call JNI funktions to get the Java classes and objects
1834  * @param jParam - the Java CK_ECDH1_DERIVE_PARAMS object to convert
<span class="line-modified">1835  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1836  * @retur pointer to nthe new CK_ECDH1_DERIVE_PARAMS structure</span>
1837  */
<span class="line-modified">1838 CK_ECDH1_DERIVE_PARAMS_PTR</span>
<span class="line-added">1839 jEcdh1DeriveParamToCKEcdh1DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1840 {
<span class="line-added">1841     CK_ECDH1_DERIVE_PARAMS_PTR ckParamPtr;</span>
1842     jclass jEcdh1DeriveParamsClass;

1843     jfieldID fieldID;
1844     jlong jLong;
1845     jobject jSharedData, jPublicData;

1846 
<span class="line-modified">1847     if (pLength != NULL) {</span>
<span class="line-added">1848         *pLength = 0;</span>
<span class="line-added">1849     }</span>
<span class="line-added">1850 </span>
<span class="line-added">1851     // retrieve java values</span>
1852     jEcdh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH1_DERIVE_PARAMS);
<span class="line-modified">1853     if (jEcdh1DeriveParamsClass == NULL) { return NULL; }</span>
1854     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">1855     if (fieldID == NULL) { return NULL; }</span>
1856     jLong = (*env)-&gt;GetLongField(env, jParam, fieldID);



1857     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<span class="line-modified">1858     if (fieldID == NULL) { return NULL; }</span>
1859     jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);


1860     fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">1861     if (fieldID == NULL) { return NULL; }</span>
1862     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1863 
<span class="line-modified">1864     // allocate memory for CK_ECDH1_DERIVE_PARAMS pointer</span>
<span class="line-modified">1865     ckParamPtr = calloc(1, sizeof(CK_ECDH1_DERIVE_PARAMS));</span>
<span class="line-modified">1866     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1867         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1868         return NULL;</span>
<span class="line-added">1869     }</span>
<span class="line-added">1870 </span>
<span class="line-added">1871     // populate using java values</span>
<span class="line-added">1872     ckParamPtr-&gt;kdf = jLongToCKULong(jLong);</span>
<span class="line-added">1873     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParamPtr-&gt;pSharedData),</span>
<span class="line-added">1874             &amp;(ckParamPtr-&gt;ulSharedDataLen));</span>
<span class="line-added">1875     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1876         goto cleanup;</span>
<span class="line-added">1877     }</span>
<span class="line-added">1878     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-added">1879             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>
1880     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1881         goto cleanup;</span>

1882     }
1883 
<span class="line-modified">1884     if (pLength != NULL) {</span>
<span class="line-added">1885         *pLength = sizeof(CK_ECDH1_DERIVE_PARAMS);</span>
<span class="line-added">1886     }</span>
<span class="line-added">1887     return ckParamPtr;</span>
<span class="line-added">1888 cleanup:</span>
<span class="line-added">1889     free(ckParamPtr-&gt;pSharedData);</span>
<span class="line-added">1890     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">1891     free(ckParamPtr);</span>
<span class="line-added">1892     return NULL;</span>
1893 }
1894 
1895 /*
<span class="line-modified">1896  * converts the Java CK_ECDH2_DERIVE_PARAMS object to a CK_ECDH2_DERIVE_PARAMS</span>
<span class="line-added">1897  * pointer</span>
1898  *
1899  * @param env - used to call JNI funktions to get the Java classes and objects
1900  * @param jParam - the Java CK_ECDH2_DERIVE_PARAMS object to convert
<span class="line-modified">1901  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1902  * @return pointer to the new CK_ECDH2_DERIVE_PARAMS structure</span>
1903  */
<span class="line-modified">1904 CK_ECDH2_DERIVE_PARAMS_PTR</span>
<span class="line-added">1905 jEcdh2DeriveParamToCKEcdh2DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1906 {
<span class="line-added">1907     CK_ECDH2_DERIVE_PARAMS_PTR ckParamPtr;</span>
1908     jclass jEcdh2DeriveParamsClass;

1909     jfieldID fieldID;
1910     jlong jKdf, jPrivateDataLen, jPrivateData;
1911     jobject jSharedData, jPublicData, jPublicData2;

1912 
<span class="line-modified">1913     // retrieve java values</span>
1914     jEcdh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH2_DERIVE_PARAMS);
<span class="line-modified">1915     if (jEcdh2DeriveParamsClass == NULL) { return NULL; }</span>
1916     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">1917     if (fieldID == NULL) { return NULL; }</span>
1918     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);


1919     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<span class="line-modified">1920     if (fieldID == NULL) { return NULL; }</span>
1921     jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);


1922     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">1923     if (fieldID == NULL) { return NULL; }</span>
1924     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);


1925     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<span class="line-modified">1926     if (fieldID == NULL) { return NULL; }</span>
1927     jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);


1928     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<span class="line-modified">1929     if (fieldID == NULL) { return NULL; }</span>
1930     jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);


1931     fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<span class="line-modified">1932     if (fieldID == NULL) { return NULL; }</span>
1933     jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
1934 
<span class="line-modified">1935     // allocate memory for CK_ECDH2_DERIVE_PARAMS pointer</span>
<span class="line-modified">1936     ckParamPtr = calloc(1, sizeof(CK_ECDH2_DERIVE_PARAMS));</span>
<span class="line-modified">1937     if (ckParamPtr == NULL) {</span>
<span class="line-modified">1938         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">1939         return NULL;</span>
<span class="line-added">1940     }</span>
<span class="line-added">1941 </span>
<span class="line-added">1942     // populate using java values</span>
<span class="line-added">1943     ckParamPtr-&gt;kdf = jLongToCKULong(jKdf);</span>
<span class="line-added">1944     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParamPtr-&gt;pSharedData),</span>
<span class="line-added">1945             &amp;(ckParamPtr-&gt;ulSharedDataLen));</span>
1946     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1947         goto cleanup;</span>

1948     }
<span class="line-modified">1949     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-modified">1950             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>

1951     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">1952         goto cleanup;</span>


1953     }
<span class="line-modified">1954     ckParamPtr-&gt;ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-added">1955     ckParamPtr-&gt;hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-added">1956     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParamPtr-&gt;pPublicData2),</span>
<span class="line-added">1957             &amp;(ckParamPtr-&gt;ulPublicDataLen2));</span>
<span class="line-added">1958     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">1959         goto cleanup;</span>
<span class="line-added">1960     }</span>
<span class="line-added">1961 </span>
<span class="line-added">1962     if (pLength != NULL) {</span>
<span class="line-added">1963         *pLength = sizeof(CK_ECDH2_DERIVE_PARAMS);</span>
<span class="line-added">1964     }</span>
<span class="line-added">1965     return ckParamPtr;</span>
<span class="line-added">1966 cleanup:</span>
<span class="line-added">1967     free(ckParamPtr-&gt;pSharedData);</span>
<span class="line-added">1968     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">1969     free(ckParamPtr-&gt;pPublicData2);</span>
<span class="line-added">1970     free(ckParamPtr);</span>
<span class="line-added">1971     return NULL;</span>
1972 }
1973 
1974 /*
<span class="line-modified">1975  * converts the Java CK_X9_42_DH1_DERIVE_PARAMS object to a</span>
<span class="line-added">1976  * CK_X9_42_DH1_DERIVE_PARAMS pointer</span>
1977  *
1978  * @param env - used to call JNI funktions to get the Java classes and objects
1979  * @param jParam - the Java CK_X9_42_DH1_DERIVE_PARAMS object to convert
<span class="line-modified">1980  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">1981  * @return pointer to the new CK_X9_42_DH1_DERIVE_PARAMS structure</span>
1982  */
<span class="line-modified">1983 CK_X9_42_DH1_DERIVE_PARAMS_PTR</span>
<span class="line-added">1984 jX942Dh1DeriveParamToCKX942Dh1DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
1985 {
<span class="line-added">1986     CK_X9_42_DH1_DERIVE_PARAMS_PTR ckParamPtr;</span>
1987     jclass jX942Dh1DeriveParamsClass;

1988     jfieldID fieldID;
1989     jlong jKdf;
1990     jobject jOtherInfo, jPublicData;

1991 
<span class="line-modified">1992     if (pLength != NULL) {</span>
<span class="line-added">1993         *pLength = 0;</span>
<span class="line-added">1994     }</span>
<span class="line-added">1995 </span>
<span class="line-added">1996     // retrieve java values</span>
1997     jX942Dh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH1_DERIVE_PARAMS);
<span class="line-modified">1998     if (jX942Dh1DeriveParamsClass == NULL) { return NULL; }</span>
1999     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">2000     if (fieldID == NULL) { return NULL; }</span>
2001     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);


2002     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<span class="line-modified">2003     if (fieldID == NULL) { return NULL; }</span>
2004     jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);


2005     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">2006     if (fieldID == NULL) { return NULL; }</span>
2007     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
2008 
<span class="line-modified">2009     // allocate memory for CK_X9_42_DH1_DERIVE_PARAMS pointer</span>
<span class="line-modified">2010     ckParamPtr = calloc(1, sizeof(CK_X9_42_DH1_DERIVE_PARAMS));</span>
<span class="line-modified">2011     if (ckParamPtr == NULL) {</span>
<span class="line-modified">2012         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">2013         return NULL;</span>
<span class="line-added">2014     }</span>
<span class="line-added">2015 </span>
<span class="line-added">2016     // populate using java values</span>
<span class="line-added">2017     ckParamPtr-&gt;kdf = jLongToCKULong(jKdf);</span>
<span class="line-added">2018     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParamPtr-&gt;pOtherInfo),</span>
<span class="line-added">2019             &amp;(ckParamPtr-&gt;ulOtherInfoLen));</span>
2020     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">2021         goto cleanup;</span>
<span class="line-modified">2022     }</span>
<span class="line-added">2023     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-added">2024             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>
<span class="line-added">2025     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">2026         goto cleanup;</span>
2027     }
2028 
<span class="line-modified">2029     if (pLength != NULL) {</span>
<span class="line-added">2030         *pLength = sizeof(CK_X9_42_DH1_DERIVE_PARAMS);</span>
<span class="line-added">2031     }</span>
<span class="line-added">2032     return ckParamPtr;</span>
<span class="line-added">2033 cleanup:</span>
<span class="line-added">2034     free(ckParamPtr-&gt;pOtherInfo);</span>
<span class="line-added">2035     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">2036     free(ckParamPtr);</span>
<span class="line-added">2037     return NULL;</span>
2038 }
2039 
2040 /*
<span class="line-modified">2041  * converts the Java CK_X9_42_DH2_DERIVE_PARAMS object to a</span>
<span class="line-added">2042  * CK_X9_42_DH2_DERIVE_PARAMS pointer</span>
2043  *
2044  * @param env - used to call JNI funktions to get the Java classes and objects
2045  * @param jParam - the Java CK_X9_42_DH2_DERIVE_PARAMS object to convert
<span class="line-modified">2046  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">2047  * @return pointer to the new CK_X9_42_DH2_DERIVE_PARAMS structure</span>
2048  */
<span class="line-modified">2049 CK_X9_42_DH2_DERIVE_PARAMS_PTR</span>
<span class="line-added">2050 jX942Dh2DeriveParamToCKX942Dh2DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
2051 {
<span class="line-added">2052     CK_X9_42_DH2_DERIVE_PARAMS_PTR ckParamPtr;</span>
2053     jclass jX942Dh2DeriveParamsClass;

2054     jfieldID fieldID;
2055     jlong jKdf, jPrivateDataLen, jPrivateData;
2056     jobject jOtherInfo, jPublicData, jPublicData2;

2057 
<span class="line-modified">2058     if (pLength != NULL) {</span>
<span class="line-added">2059         *pLength = 0L;</span>
<span class="line-added">2060     }</span>
<span class="line-added">2061 </span>
<span class="line-added">2062     // retrieve java values</span>
2063     jX942Dh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH2_DERIVE_PARAMS);
<span class="line-modified">2064     if (jX942Dh2DeriveParamsClass == NULL) { return NULL; }</span>
2065     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">2066     if (fieldID == NULL) { return NULL; }</span>
2067     jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);


2068     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<span class="line-modified">2069     if (fieldID == NULL) { return NULL; }</span>
2070     jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);


2071     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">2072     if (fieldID == NULL) { return NULL; }</span>
2073     jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);


2074     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<span class="line-modified">2075     if (fieldID == NULL) { return NULL; }</span>
2076     jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);


2077     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<span class="line-modified">2078     if (fieldID == NULL) { return NULL; }</span>
2079     jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);


2080     fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<span class="line-modified">2081     if (fieldID == NULL) { return NULL; }</span>
2082     jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
2083 
<span class="line-modified">2084     // allocate memory for CK_DATE pointer</span>
<span class="line-modified">2085     ckParamPtr = calloc(1, sizeof(CK_X9_42_DH2_DERIVE_PARAMS));</span>
<span class="line-modified">2086     if (ckParamPtr == NULL) {</span>
<span class="line-modified">2087         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">2088         return NULL;</span>
<span class="line-added">2089     }</span>
<span class="line-added">2090 </span>
<span class="line-added">2091     // populate using java values</span>
<span class="line-added">2092     ckParamPtr-&gt;kdf = jLongToCKULong(jKdf);</span>
<span class="line-added">2093     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParamPtr-&gt;pOtherInfo),</span>
<span class="line-added">2094             &amp;(ckParamPtr-&gt;ulOtherInfoLen));</span>
2095     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">2096         goto cleanup;</span>

2097     }
<span class="line-modified">2098     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-modified">2099             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>

2100     if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">2101         goto cleanup;</span>
<span class="line-modified">2102     }</span>
<span class="line-modified">2103     ckParamPtr-&gt;ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-added">2104     ckParamPtr-&gt;hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-added">2105     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParamPtr-&gt;pPublicData2),</span>
<span class="line-added">2106             &amp;(ckParamPtr-&gt;ulPublicDataLen2));</span>
<span class="line-added">2107     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">2108         goto cleanup;</span>
2109     }
2110 
<span class="line-modified">2111     if (pLength != NULL) {</span>
<span class="line-added">2112         *pLength = sizeof(CK_X9_42_DH2_DERIVE_PARAMS);</span>
<span class="line-added">2113     }</span>
<span class="line-added">2114     return ckParamPtr;</span>
<span class="line-added">2115 cleanup:</span>
<span class="line-added">2116     free(ckParamPtr-&gt;pOtherInfo);</span>
<span class="line-added">2117     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">2118     free(ckParamPtr-&gt;pPublicData2);</span>
<span class="line-added">2119     free(ckParamPtr);</span>
<span class="line-added">2120     return NULL;</span>
2121 }
</pre>
</td>
</tr>
</table>
<center><a href="../../legal/pkcs11cryptotoken.md.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_crypt.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>