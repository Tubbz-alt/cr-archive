<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_convert.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../legal/pkcs11cryptotoken.md.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_crypt.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_convert.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   */
  
  /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
   *
   * Redistribution and use in  source and binary forms, with or without
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   */
  
  /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
   *
   * Redistribution and use in  source and binary forms, with or without
</pre>
<hr />
<pre>
<span class="line-old-header">*** 66,15 ***</span>
  
  #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
  
  /* declare file private functions */
  
<span class="line-modified">! void jMechanismParameterToCKMechanismParameterSlow(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength);</span>
  
  
  /*
<span class="line-modified">!  * converts a pointer to a CK_DATE structure into a Java CK_DATE Object.</span>
   *
   * @param env - used to call JNI funktions to create the new Java object
   * @param ckpValue - the pointer to the CK_DATE structure
   * @return - the new Java CK_DATE object
   */
<span class="line-new-header">--- 66,16 ---</span>
  
  #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
  
  /* declare file private functions */
  
<span class="line-modified">! CK_VOID_PTR jMechParamToCKMechParamPtrSlow(JNIEnv *env, jobject jParam,</span>
<span class="line-added">+         CK_MECHANISM_TYPE ckMech, CK_ULONG *ckpLength);</span>
  
  
  /*
<span class="line-modified">!  * converts a CK_DATE pointer into a Java CK_DATE Object.</span>
   *
   * @param env - used to call JNI funktions to create the new Java object
   * @param ckpValue - the pointer to the CK_DATE structure
   * @return - the new Java CK_DATE object
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 116,15 ***</span>
  
      return jDateObject ;
  }
  
  /*
<span class="line-modified">!  * converts a pointer to a CK_VERSION structure into a Java CK_VERSION Object.</span>
   *
   * @param env - used to call JNI funktions to create the new Java object
   * @param ckpVersion - the pointer to the CK_VERSION structure
<span class="line-modified">!  * @return - the new Java CK_VERSION object</span>
   */
  jobject ckVersionPtrToJVersion(JNIEnv *env, const CK_VERSION_PTR ckpVersion)
  {
      jclass jVersionClass;
      jmethodID jCtrId;
<span class="line-new-header">--- 117,15 ---</span>
  
      return jDateObject ;
  }
  
  /*
<span class="line-modified">!  * converts a CK_VERSION pointer into a Java CK_VERSION Object.</span>
   *
   * @param env - used to call JNI funktions to create the new Java object
   * @param ckpVersion - the pointer to the CK_VERSION structure
<span class="line-modified">!  * @return the new Java CK_VERSION object</span>
   */
  jobject ckVersionPtrToJVersion(JNIEnv *env, const CK_VERSION_PTR ckpVersion)
  {
      jclass jVersionClass;
      jmethodID jCtrId;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 154,15 ***</span>
  
      return jVersionObject ;
  }
  
  /*
<span class="line-modified">!  * converts a pointer to a CK_SESSION_INFO structure into a Java CK_SESSION_INFO Object.</span>
   *
   * @param env - used to call JNI funktions to create the new Java object
   * @param ckpSessionInfo - the pointer to the CK_SESSION_INFO structure
<span class="line-modified">!  * @return - the new Java CK_SESSION_INFO object</span>
   */
  jobject ckSessionInfoPtrToJSessionInfo(JNIEnv *env, const CK_SESSION_INFO_PTR ckpSessionInfo)
  {
      jclass jSessionInfoClass;
      jmethodID jCtrId;
<span class="line-new-header">--- 155,15 ---</span>
  
      return jVersionObject ;
  }
  
  /*
<span class="line-modified">!  * converts a CK_SESSION_INFO pointer into a Java CK_SESSION_INFO Object.</span>
   *
   * @param env - used to call JNI funktions to create the new Java object
   * @param ckpSessionInfo - the pointer to the CK_SESSION_INFO structure
<span class="line-modified">!  * @return the new Java CK_SESSION_INFO object</span>
   */
  jobject ckSessionInfoPtrToJSessionInfo(JNIEnv *env, const CK_SESSION_INFO_PTR ckpSessionInfo)
  {
      jclass jSessionInfoClass;
      jmethodID jCtrId;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 197,15 ***</span>
  
      return jSessionInfoObject ;
  }
  
  /*
<span class="line-modified">!  * converts a pointer to a CK_ATTRIBUTE structure into a Java CK_ATTRIBUTE Object.</span>
   *
   * @param env - used to call JNI funktions to create the new Java object
   * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure
<span class="line-modified">!  * @return - the new Java CK_ATTRIBUTE object</span>
   */
  jobject ckAttributePtrToJAttribute(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
  {
      jclass jAttributeClass;
      jmethodID jCtrId;
<span class="line-new-header">--- 198,15 ---</span>
  
      return jSessionInfoObject ;
  }
  
  /*
<span class="line-modified">!  * converts a CK_ATTRIBUTE pointer into a Java CK_ATTRIBUTE Object.</span>
   *
   * @param env - used to call JNI funktions to create the new Java object
   * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure
<span class="line-modified">!  * @return the new Java CK_ATTRIBUTE object</span>
   */
  jobject ckAttributePtrToJAttribute(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
  {
      jclass jAttributeClass;
      jmethodID jCtrId;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 237,119 ***</span>
      return jAttributeObject;
  }
  
  
  /*
<span class="line-modified">!  * converts a Java CK_VERSION object into a pointer to a CK_VERSION structure</span>
   *
   * @param env - used to call JNI funktions to get the values out of the Java object
   * @param jVersion - the Java CK_VERSION object to convert
<span class="line-modified">!  * @return - the pointer to the new CK_VERSION structure</span>
   */
<span class="line-modified">! CK_VERSION_PTR jVersionToCKVersionPtr(JNIEnv *env, jobject jVersion)</span>
  {
      CK_VERSION_PTR ckpVersion;
      jclass jVersionClass;
      jfieldID jFieldID;
      jbyte jMajor, jMinor;
  
      if (jVersion == NULL) {
          return NULL;
      }
  
<span class="line-modified">!     /* get CK_VERSION class */</span>
      jVersionClass = (*env)-&gt;GetObjectClass(env, jVersion);
      if (jVersionClass == NULL) { return NULL; }
<span class="line-removed">- </span>
<span class="line-removed">-     /* get Major */</span>
      jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;major&quot;, &quot;B&quot;);
      if (jFieldID == NULL) { return NULL; }
      jMajor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get Minor */</span>
      jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;minor&quot;, &quot;B&quot;);
      if (jFieldID == NULL) { return NULL; }
      jMinor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
  
<span class="line-modified">!     /* allocate memory for CK_VERSION pointer */</span>
<span class="line-modified">!     ckpVersion = (CK_VERSION_PTR) malloc(sizeof(CK_VERSION));</span>
      if (ckpVersion == NULL) {
          throwOutOfMemoryError(env, 0);
          return NULL;
      }
      ckpVersion-&gt;major = jByteToCKByte(jMajor);
      ckpVersion-&gt;minor = jByteToCKByte(jMinor);
  
<span class="line-modified">!     return ckpVersion ;</span>
  }
  
  
  /*
<span class="line-modified">!  * converts a Java CK_DATE object into a pointer to a CK_DATE structure</span>
   *
<span class="line-modified">!  * @param env - used to call JNI funktions to get the values out of the Java object</span>
<span class="line-modified">!  * @param jVersion - the Java CK_DATE object to convert</span>
<span class="line-modified">!  * @return - the pointer to the new CK_DATE structure</span>
   */
<span class="line-modified">! CK_DATE * jDateObjectPtrToCKDatePtr(JNIEnv *env, jobject jDate)</span>
  {
<span class="line-modified">!     CK_DATE * ckpDate;</span>
      CK_ULONG ckLength;
      jclass jDateClass;
      jfieldID jFieldID;
      jobject jYear, jMonth, jDay;
<span class="line-modified">!     jchar *jTempChars;</span>
      CK_ULONG i;
  
      if (jDate == NULL) {
          return NULL;
      }
  
<span class="line-modified">!     /* get CK_DATE class */</span>
      jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
      if (jDateClass == NULL) { return NULL; }
<span class="line-removed">- </span>
<span class="line-removed">-     /* get Year */</span>
      jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;year&quot;, &quot;[C&quot;);
      if (jFieldID == NULL) { return NULL; }
      jYear = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get Month */</span>
      jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;month&quot;, &quot;[C&quot;);
      if (jFieldID == NULL) { return NULL; }
      jMonth = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get Day */</span>
      jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;day&quot;, &quot;[C&quot;);
      if (jFieldID == NULL) { return NULL; }
      jDay = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
  
<span class="line-modified">!     /* allocate memory for CK_DATE pointer */</span>
<span class="line-modified">!     ckpDate = (CK_DATE *) malloc(sizeof(CK_DATE));</span>
      if (ckpDate == NULL) {
          throwOutOfMemoryError(env, 0);
          return NULL;
      }
  
      if (jYear == NULL) {
          ckpDate-&gt;year[0] = 0;
          ckpDate-&gt;year[1] = 0;
          ckpDate-&gt;year[2] = 0;
          ckpDate-&gt;year[3] = 0;
      } else {
          ckLength = (*env)-&gt;GetArrayLength(env, jYear);
<span class="line-modified">!         jTempChars = (jchar*) malloc((ckLength) * sizeof(jchar));</span>
          if (jTempChars == NULL) {
<span class="line-removed">-             free(ckpDate);</span>
              throwOutOfMemoryError(env, 0);
<span class="line-modified">!             return NULL;</span>
          }
          (*env)-&gt;GetCharArrayRegion(env, jYear, 0, ckLength, jTempChars);
          if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!             free(ckpDate);</span>
<span class="line-removed">-             free(jTempChars);</span>
<span class="line-removed">-             return NULL;</span>
          }
  
          for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 4) ; i++) {
              ckpDate-&gt;year[i] = jCharToCKChar(jTempChars[i]);
          }
<span class="line-new-header">--- 238,110 ---</span>
      return jAttributeObject;
  }
  
  
  /*
<span class="line-modified">!  * converts a Java CK_VERSION object into a CK_VERSION pointer</span>
   *
   * @param env - used to call JNI funktions to get the values out of the Java object
   * @param jVersion - the Java CK_VERSION object to convert
<span class="line-modified">!  * @return pointer to the new CK_VERSION structure</span>
   */
<span class="line-modified">! CK_VERSION_PTR</span>
<span class="line-added">+ jVersionToCKVersionPtr(JNIEnv *env, jobject jVersion)</span>
  {
      CK_VERSION_PTR ckpVersion;
      jclass jVersionClass;
      jfieldID jFieldID;
      jbyte jMajor, jMinor;
  
      if (jVersion == NULL) {
          return NULL;
      }
  
<span class="line-modified">!     // retrieve java values</span>
      jVersionClass = (*env)-&gt;GetObjectClass(env, jVersion);
      if (jVersionClass == NULL) { return NULL; }
      jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;major&quot;, &quot;B&quot;);
      if (jFieldID == NULL) { return NULL; }
      jMajor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
      jFieldID = (*env)-&gt;GetFieldID(env, jVersionClass, &quot;minor&quot;, &quot;B&quot;);
      if (jFieldID == NULL) { return NULL; }
      jMinor = (*env)-&gt;GetByteField(env, jVersion, jFieldID);
  
<span class="line-modified">!     // allocate memory for CK_VERSION pointer</span>
<span class="line-modified">!     ckpVersion = (CK_VERSION_PTR) calloc(1, sizeof(CK_VERSION));</span>
      if (ckpVersion == NULL) {
          throwOutOfMemoryError(env, 0);
          return NULL;
      }
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
      ckpVersion-&gt;major = jByteToCKByte(jMajor);
      ckpVersion-&gt;minor = jByteToCKByte(jMinor);
  
<span class="line-modified">!     return ckpVersion;</span>
  }
  
  
  /*
<span class="line-modified">!  * converts a Java CK_DATE object into a CK_DATE pointer</span>
   *
<span class="line-modified">!  * @param env - used to call JNI functions to get the values out of the Java object</span>
<span class="line-modified">!  * @param jDate - the Java CK_DATE object to convert</span>
<span class="line-modified">!  * @return pointer to the new CK_DATE structure</span>
   */
<span class="line-modified">! CK_DATE * jDateObjectToCKDatePtr(JNIEnv *env, jobject jDate)</span>
  {
<span class="line-modified">!     CK_DATE * ckpDate = NULL;</span>
      CK_ULONG ckLength;
      jclass jDateClass;
      jfieldID jFieldID;
      jobject jYear, jMonth, jDay;
<span class="line-modified">!     jchar *jTempChars = NULL;</span>
      CK_ULONG i;
  
      if (jDate == NULL) {
          return NULL;
      }
  
<span class="line-modified">!     // retrieve java values</span>
      jDateClass = (*env)-&gt;FindClass(env, CLASS_DATE);
      if (jDateClass == NULL) { return NULL; }
      jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;year&quot;, &quot;[C&quot;);
      if (jFieldID == NULL) { return NULL; }
      jYear = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
      jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;month&quot;, &quot;[C&quot;);
      if (jFieldID == NULL) { return NULL; }
      jMonth = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
      jFieldID = (*env)-&gt;GetFieldID(env, jDateClass, &quot;day&quot;, &quot;[C&quot;);
      if (jFieldID == NULL) { return NULL; }
      jDay = (*env)-&gt;GetObjectField(env, jDate, jFieldID);
  
<span class="line-modified">!     // allocate memory for CK_DATE pointer</span>
<span class="line-modified">!     ckpDate = (CK_DATE *) calloc(1, sizeof(CK_DATE));</span>
      if (ckpDate == NULL) {
          throwOutOfMemoryError(env, 0);
          return NULL;
      }
  
<span class="line-added">+     // populate using java values</span>
      if (jYear == NULL) {
          ckpDate-&gt;year[0] = 0;
          ckpDate-&gt;year[1] = 0;
          ckpDate-&gt;year[2] = 0;
          ckpDate-&gt;year[3] = 0;
      } else {
          ckLength = (*env)-&gt;GetArrayLength(env, jYear);
<span class="line-modified">!         jTempChars = (jchar*) calloc(ckLength, sizeof(jchar));</span>
          if (jTempChars == NULL) {
              throwOutOfMemoryError(env, 0);
<span class="line-modified">!             goto cleanup;</span>
          }
          (*env)-&gt;GetCharArrayRegion(env, jYear, 0, ckLength, jTempChars);
          if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!             goto cleanup;</span>
          }
  
          for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 4) ; i++) {
              ckpDate-&gt;year[i] = jCharToCKChar(jTempChars[i]);
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 359,21 ***</span>
      if (jMonth == NULL) {
          ckpDate-&gt;month[0] = 0;
          ckpDate-&gt;month[1] = 0;
      } else {
          ckLength = (*env)-&gt;GetArrayLength(env, jMonth);
<span class="line-modified">!         jTempChars = (jchar*) malloc((ckLength) * sizeof(jchar));</span>
          if (jTempChars == NULL) {
<span class="line-removed">-             free(ckpDate);</span>
              throwOutOfMemoryError(env, 0);
<span class="line-modified">!             return NULL;</span>
          }
          (*env)-&gt;GetCharArrayRegion(env, jMonth, 0, ckLength, jTempChars);
          if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!             free(ckpDate);</span>
<span class="line-removed">-             free(jTempChars);</span>
<span class="line-removed">-             return NULL;</span>
          }
  
          for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
              ckpDate-&gt;month[i] = jCharToCKChar(jTempChars[i]);
          }
<span class="line-new-header">--- 351,18 ---</span>
      if (jMonth == NULL) {
          ckpDate-&gt;month[0] = 0;
          ckpDate-&gt;month[1] = 0;
      } else {
          ckLength = (*env)-&gt;GetArrayLength(env, jMonth);
<span class="line-modified">!         jTempChars = (jchar*) calloc(ckLength, sizeof(jchar));</span>
          if (jTempChars == NULL) {
              throwOutOfMemoryError(env, 0);
<span class="line-modified">!             goto cleanup;</span>
          }
          (*env)-&gt;GetCharArrayRegion(env, jMonth, 0, ckLength, jTempChars);
          if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!             goto cleanup;</span>
          }
  
          for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
              ckpDate-&gt;month[i] = jCharToCKChar(jTempChars[i]);
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 383,63 ***</span>
      if (jDay == NULL) {
          ckpDate-&gt;day[0] = 0;
          ckpDate-&gt;day[1] = 0;
      } else {
          ckLength = (*env)-&gt;GetArrayLength(env, jDay);
<span class="line-modified">!         jTempChars = (jchar*) malloc((ckLength) * sizeof(jchar));</span>
          if (jTempChars == NULL) {
<span class="line-removed">-             free(ckpDate);</span>
              throwOutOfMemoryError(env, 0);
<span class="line-modified">!             return NULL;</span>
          }
          (*env)-&gt;GetCharArrayRegion(env, jDay, 0, ckLength, jTempChars);
          if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!             free(ckpDate);</span>
<span class="line-removed">-             free(jTempChars);</span>
<span class="line-removed">-             return NULL;</span>
          }
  
          for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
              ckpDate-&gt;day[i] = jCharToCKChar(jTempChars[i]);
          }
          free(jTempChars);
      }
  
<span class="line-modified">!     return ckpDate ;</span>
  }
  
  
  /*
   * converts a Java CK_ATTRIBUTE object into a CK_ATTRIBUTE structure
   *
   * @param env - used to call JNI funktions to get the values out of the Java object
   * @param jAttribute - the Java CK_ATTRIBUTE object to convert
<span class="line-modified">!  * @return - the new CK_ATTRIBUTE structure</span>
   */
  CK_ATTRIBUTE jAttributeToCKAttribute(JNIEnv *env, jobject jAttribute)
  {
      CK_ATTRIBUTE ckAttribute;
      jclass jAttributeClass;
      jfieldID jFieldID;
      jlong jType;
      jobject jPValue;
      memset(&amp;ckAttribute, 0, sizeof(CK_ATTRIBUTE));
  
      // TBD: what if jAttribute == NULL?!
<span class="line-removed">- </span>
      TRACE0(&quot;\nDEBUG: jAttributeToCKAttribute&quot;);
      /* get CK_ATTRIBUTE class */
      TRACE0(&quot;, getting attribute object class&quot;);
      jAttributeClass = (*env)-&gt;GetObjectClass(env, jAttribute);
      if (jAttributeClass == NULL) { return ckAttribute; }
  
      /* get type */
      TRACE0(&quot;, getting type field&quot;);
      jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;type&quot;, &quot;J&quot;);
      if (jFieldID == NULL) { return ckAttribute; }
      jType = (*env)-&gt;GetLongField(env, jAttribute, jFieldID);
<span class="line-modified">!     TRACE1(&quot;, type=0x%X&quot;, jType);</span>
  
      /* get pValue */
      TRACE0(&quot;, getting pValue field&quot;);
      jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;pValue&quot;, &quot;Ljava/lang/Object;&quot;);
      if (jFieldID == NULL) { return ckAttribute; }
<span class="line-new-header">--- 372,65 ---</span>
      if (jDay == NULL) {
          ckpDate-&gt;day[0] = 0;
          ckpDate-&gt;day[1] = 0;
      } else {
          ckLength = (*env)-&gt;GetArrayLength(env, jDay);
<span class="line-modified">!         jTempChars = (jchar*) calloc(ckLength, sizeof(jchar));</span>
          if (jTempChars == NULL) {
              throwOutOfMemoryError(env, 0);
<span class="line-modified">!             goto cleanup;</span>
          }
          (*env)-&gt;GetCharArrayRegion(env, jDay, 0, ckLength, jTempChars);
          if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!             goto cleanup;</span>
          }
  
          for (i = 0; (i &lt; ckLength) &amp;&amp; (i &lt; 2) ; i++) {
              ckpDate-&gt;day[i] = jCharToCKChar(jTempChars[i]);
          }
          free(jTempChars);
      }
  
<span class="line-modified">!     return ckpDate;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(jTempChars);</span>
<span class="line-added">+     free(ckpDate);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  
  /*
   * converts a Java CK_ATTRIBUTE object into a CK_ATTRIBUTE structure
   *
   * @param env - used to call JNI funktions to get the values out of the Java object
   * @param jAttribute - the Java CK_ATTRIBUTE object to convert
<span class="line-modified">!  * @return the new CK_ATTRIBUTE structure</span>
   */
  CK_ATTRIBUTE jAttributeToCKAttribute(JNIEnv *env, jobject jAttribute)
  {
      CK_ATTRIBUTE ckAttribute;
      jclass jAttributeClass;
      jfieldID jFieldID;
      jlong jType;
      jobject jPValue;
<span class="line-added">+ </span>
      memset(&amp;ckAttribute, 0, sizeof(CK_ATTRIBUTE));
  
      // TBD: what if jAttribute == NULL?!
      TRACE0(&quot;\nDEBUG: jAttributeToCKAttribute&quot;);
<span class="line-added">+ </span>
      /* get CK_ATTRIBUTE class */
      TRACE0(&quot;, getting attribute object class&quot;);
      jAttributeClass = (*env)-&gt;GetObjectClass(env, jAttribute);
      if (jAttributeClass == NULL) { return ckAttribute; }
  
      /* get type */
      TRACE0(&quot;, getting type field&quot;);
      jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;type&quot;, &quot;J&quot;);
      if (jFieldID == NULL) { return ckAttribute; }
      jType = (*env)-&gt;GetLongField(env, jAttribute, jFieldID);
<span class="line-modified">!     TRACE1(&quot;, type=0x%lX&quot;, jType);</span>
  
      /* get pValue */
      TRACE0(&quot;, getting pValue field&quot;);
      jFieldID = (*env)-&gt;GetFieldID(env, jAttributeClass, &quot;pValue&quot;, &quot;Ljava/lang/Object;&quot;);
      if (jFieldID == NULL) { return ckAttribute; }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 448,13 ***</span>
  
      ckAttribute.type = jLongToCKULong(jType);
      TRACE0(&quot;, converting pValue to primitive object&quot;);
  
      /* convert the Java pValue object to a CK-type pValue pointer */
<span class="line-modified">!     jObjectToPrimitiveCKObjectPtrPtr(env, jPValue, &amp;(ckAttribute.pValue), &amp;(ckAttribute.ulValueLen));</span>
  
<span class="line-modified">!     TRACE0(&quot;\nFINISHED\n&quot;);</span>
  
      return ckAttribute ;
  }
  
  void masterKeyDeriveParamToCKMasterKeyDeriveParam(JNIEnv *env, jobject jParam,
<span class="line-new-header">--- 439,13 ---</span>
  
      ckAttribute.type = jLongToCKULong(jType);
      TRACE0(&quot;, converting pValue to primitive object&quot;);
  
      /* convert the Java pValue object to a CK-type pValue pointer */
<span class="line-modified">!     ckAttribute.pValue = jObjectToPrimitiveCKObjectPtr(env, jPValue, &amp;(ckAttribute.ulValueLen));</span>
  
<span class="line-modified">!     TRACE0(&quot;\nDEBUG: jAttributeToCKAttribute FINISHED\n&quot;);</span>
  
      return ckAttribute ;
  }
  
  void masterKeyDeriveParamToCKMasterKeyDeriveParam(JNIEnv *env, jobject jParam,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 463,201 ***</span>
          CK_SSL3_RANDOM_DATA* cKMasterKeyDeriveParamRandomInfo) {
      jfieldID fieldID;
      jclass jSsl3RandomDataClass;
      jobject jRandomInfo, jRIClientRandom, jRIServerRandom, jVersion;
  
<span class="line-modified">!     /* get RandomInfo */</span>
      fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;RandomInfo&quot;,
              &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
      if (fieldID == NULL) { return; }
      jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pClientRandom and ulClientRandomLength out of RandomInfo */</span>
      jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
      if (jSsl3RandomDataClass == NULL) { return; }
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pServerRandom and ulServerRandomLength out of RandomInfo */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pVersion */</span>
      fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;pVersion&quot;,
              &quot;Lsun/security/pkcs11/wrapper/CK_VERSION;&quot;);
      if (fieldID == NULL) { return; }
      jVersion = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
      *cKMasterKeyDeriveParamVersion = jVersionToCKVersionPtr(env, jVersion);
      if ((*env)-&gt;ExceptionCheck(env)) { return; }
      jByteArrayToCKByteArray(env, jRIClientRandom,
              &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom),
              &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulClientRandomLen));
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(*cKMasterKeyDeriveParamVersion);</span>
<span class="line-removed">-         return;</span>
      }
      jByteArrayToCKByteArray(env, jRIServerRandom,
              &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom),
              &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulServerRandomLen));
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(*cKMasterKeyDeriveParamVersion);</span>
<span class="line-removed">-         free(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed">-         return;</span>
      }
  }
  
  /*
   * converts the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to a
<span class="line-modified">!  * CK_SSL3_MASTER_KEY_DERIVE_PARAMS structure</span>
   *
   * @param env - used to call JNI functions to get the Java classes and objects
   * @param jParam - the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_SSL3_MASTER_KEY_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_SSL3_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-modified">! jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParam(JNIEnv *env,</span>
<span class="line-modified">!         jobject jParam)</span>
  {
<span class="line-modified">!     CK_SSL3_MASTER_KEY_DERIVE_PARAMS ckParam;</span>
      jclass jSsl3MasterKeyDeriveParamsClass;
<span class="line-modified">!     memset(&amp;ckParam, 0, sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS));</span>
      jSsl3MasterKeyDeriveParamsClass =
              (*env)-&gt;FindClass(env, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);
<span class="line-modified">!     if (jSsl3MasterKeyDeriveParamsClass == NULL) { return ckParam; }</span>
      masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,
              jSsl3MasterKeyDeriveParamsClass,
<span class="line-modified">!             &amp;ckParam.pVersion, &amp;ckParam.RandomInfo);</span>
<span class="line-modified">!     return ckParam;</span>
  }
  
  /*
   * converts the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to a
<span class="line-modified">!  * CK_TLS12_MASTER_KEY_DERIVE_PARAMS structure</span>
   *
   * @param env - used to call JNI functions to get the Java classes and objects
   * @param jParam - the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_TLS12_MASTER_KEY_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_TLS12_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-modified">! jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParam(JNIEnv *env,</span>
<span class="line-modified">!         jobject jParam)</span>
  {
<span class="line-modified">!     CK_TLS12_MASTER_KEY_DERIVE_PARAMS ckParam;</span>
      jclass jTls12MasterKeyDeriveParamsClass;
      jfieldID fieldID;
<span class="line-modified">!     memset(&amp;ckParam, 0, sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS));</span>
      jTls12MasterKeyDeriveParamsClass =
<span class="line-modified">!             (*env)-&gt;FindClass(env, CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">!     if (jTls12MasterKeyDeriveParamsClass == NULL) { return ckParam; }</span>
<span class="line-removed">-     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,</span>
<span class="line-removed">-             jTls12MasterKeyDeriveParamsClass, &amp;ckParam.pVersion,</span>
<span class="line-removed">-             &amp;ckParam.RandomInfo);</span>
      fieldID = (*env)-&gt;GetFieldID(env,
              jTls12MasterKeyDeriveParamsClass, &quot;prfHashMechanism&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID != NULL) {</span>
<span class="line-modified">!         jlong prfHashMechanism =</span>
<span class="line-modified">!                 (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified">!         ckParam.prfHashMechanism = (CK_MECHANISM_TYPE)prfHashMechanism;</span>
      }
<span class="line-modified">!     return ckParam;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_TLS_PRF_PARAMS object to a CK_TLS_PRF_PARAMS structure</span>
   */
<span class="line-modified">! CK_TLS_PRF_PARAMS jTlsPrfParamsToCKTlsPrfParam(JNIEnv *env, jobject jParam)</span>
  {
      jclass jTlsPrfParamsClass;
<span class="line-removed">-     CK_TLS_PRF_PARAMS ckParam;</span>
      jfieldID fieldID;
      jobject jSeed, jLabel, jOutput;
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_TLS_PRF_PARAMS));</span>
  
<span class="line-modified">!     // TBD: what if jParam == NULL?!</span>
  
<span class="line-modified">!     /* get pSeed */</span>
      jTlsPrfParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_PRF_PARAMS);
<span class="line-modified">!     if (jTlsPrfParamsClass == NULL) { return ckParam; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pSeed&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jSeed = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pLabel */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pLabel&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jLabel = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pOutput */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pOutput&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jOutput = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jSeed, &amp;(ckParam.pSeed), &amp;(ckParam.ulSeedLen));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jLabel, &amp;(ckParam.pLabel), &amp;(ckParam.ulLabelLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pSeed);</span>
<span class="line-removed">-         return ckParam;</span>
      }
<span class="line-modified">!     ckParam.pulOutputLen = malloc(sizeof(CK_ULONG));</span>
<span class="line-modified">!     if (ckParam.pulOutputLen == NULL) {</span>
<span class="line-modified">!         free(ckParam.pSeed);</span>
<span class="line-removed">-         free(ckParam.pLabel);</span>
<span class="line-removed">-         throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-         return ckParam;</span>
      }
<span class="line-modified">!     jByteArrayToCKByteArray(env, jOutput, &amp;(ckParam.pOutput), ckParam.pulOutputLen);</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pSeed);</span>
<span class="line-removed">-         free(ckParam.pLabel);</span>
<span class="line-removed">-         free(ckParam.pulOutputLen);</span>
<span class="line-removed">-         return ckParam;</span>
      }
  
<span class="line-modified">!     return ckParam ;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_TLS_MAC_PARAMS object to a CK_TLS_MAC_PARAMS structure</span>
   */
<span class="line-modified">! CK_TLS_MAC_PARAMS jTlsMacParamsToCKTlsMacParam(JNIEnv *env, jobject jParam)</span>
  {
      jclass jTlsMacParamsClass;
<span class="line-removed">-     CK_TLS_MAC_PARAMS ckParam;</span>
      jfieldID fieldID;
      jlong jPrfMechanism, jUlMacLength, jUlServerOrClient;
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_TLS_MAC_PARAMS));</span>
  
<span class="line-modified">!     jTlsMacParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_MAC_PARAMS);</span>
<span class="line-modified">!     if (jTlsMacParamsClass == NULL) { return ckParam; }</span>
  
<span class="line-modified">!     /* get prfMechanism */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;prfMechanism&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPrfMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get ulMacLength */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulMacLength&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jUlMacLength = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get ulServerOrClient */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulServerOrClient&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jUlServerOrClient = (*env)-&gt;GetLongField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckParam.prfMechanism = jLongToCKULong(jPrfMechanism);</span>
<span class="line-modified">!     ckParam.ulMacLength = jLongToCKULong(jUlMacLength);</span>
<span class="line-modified">!     ckParam.ulServerOrClient = jLongToCKULong(jUlServerOrClient);</span>
  
<span class="line-modified">!     return ckParam;</span>
  }
  
  void keyMatParamToCKKeyMatParam(JNIEnv *env, jobject jParam,
          jclass jKeyMatParamClass,
          CK_ULONG* cKKeyMatParamUlMacSizeInBits,
<span class="line-new-header">--- 454,283 ---</span>
          CK_SSL3_RANDOM_DATA* cKMasterKeyDeriveParamRandomInfo) {
      jfieldID fieldID;
      jclass jSsl3RandomDataClass;
      jobject jRandomInfo, jRIClientRandom, jRIServerRandom, jVersion;
  
<span class="line-modified">!     // retrieve java values</span>
      fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;RandomInfo&quot;,
              &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
      if (fieldID == NULL) { return; }
      jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
      if (jSsl3RandomDataClass == NULL) { return; }
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, masterKeyDeriveParamClass, &quot;pVersion&quot;,
              &quot;Lsun/security/pkcs11/wrapper/CK_VERSION;&quot;);
      if (fieldID == NULL) { return; }
      jVersion = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     // populate using java values</span>
      *cKMasterKeyDeriveParamVersion = jVersionToCKVersionPtr(env, jVersion);
      if ((*env)-&gt;ExceptionCheck(env)) { return; }
      jByteArrayToCKByteArray(env, jRIClientRandom,
              &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom),
              &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulClientRandomLen));
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
      jByteArrayToCKByteArray(env, jRIServerRandom,
              &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom),
              &amp;(cKMasterKeyDeriveParamRandomInfo-&gt;ulServerRandomLen));
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
<span class="line-added">+     return;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(*cKMasterKeyDeriveParamVersion);</span>
<span class="line-added">+     free(cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-added">+     cKMasterKeyDeriveParamRandomInfo-&gt;ulClientRandomLen = 0L;</span>
<span class="line-added">+     free(cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-added">+     cKMasterKeyDeriveParamRandomInfo-&gt;ulServerRandomLen = 0L;</span>
<span class="line-added">+     // explicitly set to NULL to ensure no double free possible</span>
<span class="line-added">+     *cKMasterKeyDeriveParamVersion = NULL;</span>
<span class="line-added">+     cKMasterKeyDeriveParamRandomInfo-&gt;pClientRandom = NULL;</span>
<span class="line-added">+     cKMasterKeyDeriveParamRandomInfo-&gt;pServerRandom = NULL;</span>
  }
  
  /*
   * converts the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to a
<span class="line-modified">!  * CK_SSL3_MASTER_KEY_DERIVE_PARAMS pointer</span>
   *
   * @param env - used to call JNI functions to get the Java classes and objects
   * @param jParam - the Java CK_SSL3_MASTER_KEY_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_SSL3_MASTER_KEY_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR</span>
<span class="line-modified">! jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParamPtr(JNIEnv *env,</span>
<span class="line-modified">!         jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-modified">!     CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR ckParamPtr;</span>
      jclass jSsl3MasterKeyDeriveParamsClass;
<span class="line-modified">! </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0L;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // allocate memory for CK_SSL3_MASTER_KEY_DERIVE_PARAMS pointer</span>
<span class="line-added">+     ckParamPtr = calloc(1, sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-added">+     if (ckParamPtr == NULL) {</span>
<span class="line-added">+         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve and populate using java values</span>
      jSsl3MasterKeyDeriveParamsClass =
              (*env)-&gt;FindClass(env, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);
<span class="line-modified">!     if (jSsl3MasterKeyDeriveParamsClass == NULL) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
      masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,
              jSsl3MasterKeyDeriveParamsClass,
<span class="line-modified">!             &amp;(ckParamPtr-&gt;pVersion), &amp;(ckParamPtr-&gt;RandomInfo));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
   * converts the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to a
<span class="line-modified">!  * CK_TLS12_MASTER_KEY_DERIVE_PARAMS pointer</span>
   *
   * @param env - used to call JNI functions to get the Java classes and objects
   * @param jParam - the Java CK_TLS12_MASTER_KEY_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_TLS12_MASTER_KEY_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR</span>
<span class="line-modified">! jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParamPtr(JNIEnv *env,</span>
<span class="line-modified">!         jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-modified">!     CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR ckParamPtr;</span>
      jclass jTls12MasterKeyDeriveParamsClass;
      jfieldID fieldID;
<span class="line-modified">!     jlong prfHashMechanism;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0L;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jTls12MasterKeyDeriveParamsClass =
<span class="line-modified">!         (*env)-&gt;FindClass(env, CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">!     if (jTls12MasterKeyDeriveParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env,
              jTls12MasterKeyDeriveParamsClass, &quot;prfHashMechanism&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
<span class="line-modified">!     prfHashMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified">! </span>
<span class="line-modified">!     // allocate memory for CK_TLS12_MASTER_KEY_DERIVE_PARAMS pointer</span>
<span class="line-added">+     ckParamPtr = calloc(1, sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-added">+     if (ckParamPtr == NULL) {</span>
<span class="line-added">+         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
      }
<span class="line-modified">! </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     masterKeyDeriveParamToCKMasterKeyDeriveParam(env, jParam,</span>
<span class="line-added">+             jTls12MasterKeyDeriveParamsClass, &amp;ckParamPtr-&gt;pVersion,</span>
<span class="line-added">+             &amp;ckParamPtr-&gt;RandomInfo);</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     ckParamPtr-&gt;prfHashMechanism = (CK_MECHANISM_TYPE) prfHashMechanism;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_TLS_PRF_PARAMS object to a CK_TLS_PRF_PARAMS pointer</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * @param env - used to call JNI functions to get the Java classes and objects</span>
<span class="line-added">+  * @param jParam - the Java CK_TLS_PRF_PARAMS object to convert</span>
<span class="line-added">+  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_TLS_PRF_PARAMS structure</span>
   */
<span class="line-modified">! CK_TLS_PRF_PARAMS_PTR</span>
<span class="line-added">+ jTlsPrfParamsToCKTlsPrfParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_TLS_PRF_PARAMS_PTR ckParamPtr;</span>
      jclass jTlsPrfParamsClass;
      jfieldID fieldID;
      jobject jSeed, jLabel, jOutput;
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0;</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     // retrieve java values</span>
      jTlsPrfParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_PRF_PARAMS);
<span class="line-modified">!     if (jTlsPrfParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pSeed&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jSeed = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pLabel&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jLabel = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jTlsPrfParamsClass, &quot;pOutput&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jOutput = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_TLS_PRF_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_TLS_PRF_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jSeed, &amp;(ckParamPtr-&gt;pSeed), &amp;(ckParamPtr-&gt;ulSeedLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
<span class="line-modified">!     jByteArrayToCKByteArray(env, jLabel, &amp;(ckParamPtr-&gt;pLabel), &amp;(ckParamPtr-&gt;ulLabelLen));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">!         goto cleanup;</span>
      }
<span class="line-modified">!     ckParamPtr-&gt;pulOutputLen = calloc(1, sizeof(CK_ULONG));</span>
<span class="line-added">+     if (ckParamPtr-&gt;pulOutputLen == NULL) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jOutput, &amp;(ckParamPtr-&gt;pOutput), ckParamPtr-&gt;pulOutputLen);</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_TLS_PRF_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr-&gt;pSeed);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pLabel);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pOutput);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pulOutputLen);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_TLS_MAC_PARAMS object to a CK_TLS_MAC_PARAMS pointer</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * @param env - used to call JNI functions to get the Java classes and objects</span>
<span class="line-added">+  * @param jParam - the Java CK_TLS_MAC_PARAMS object to convert</span>
<span class="line-added">+  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_TLS_MAC_PARAMS structure</span>
   */
<span class="line-modified">! </span>
<span class="line-added">+ CK_TLS_MAC_PARAMS_PTR</span>
<span class="line-added">+ jTlsMacParamsToCKTlsMacParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_TLS_MAC_PARAMS_PTR ckParamPtr;</span>
      jclass jTlsMacParamsClass;
      jfieldID fieldID;
      jlong jPrfMechanism, jUlMacLength, jUlServerOrClient;
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-modified">!         *pLength = 0L;</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     // retrieve java values</span>
<span class="line-added">+     jTlsMacParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_MAC_PARAMS);</span>
<span class="line-added">+     if (jTlsMacParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;prfMechanism&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPrfMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulMacLength&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jUlMacLength = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jTlsMacParamsClass, &quot;ulServerOrClient&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jUlServerOrClient = (*env)-&gt;GetLongField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_TLS_MAC_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_TLS_MAC_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;prfHashMechanism = jLongToCKULong(jPrfMechanism);</span>
<span class="line-added">+     ckParamPtr-&gt;ulMacLength = jLongToCKULong(jUlMacLength);</span>
<span class="line-added">+     ckParamPtr-&gt;ulServerOrClient = jLongToCKULong(jUlServerOrClient);</span>
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_TLS_MAC_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
  }
  
  void keyMatParamToCKKeyMatParam(JNIEnv *env, jobject jParam,
          jclass jKeyMatParamClass,
          CK_ULONG* cKKeyMatParamUlMacSizeInBits,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 673,90 ***</span>
      jboolean jIsExport;
      jobject jRandomInfo, jRIClientRandom, jRIServerRandom;
      jobject jReturnedKeyMaterial, jRMIvClient, jRMIvServer;
      CK_ULONG ckTemp;
  
<span class="line-modified">!     /* get ulMacSizeInBits */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulMacSizeInBits&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jMacSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get ulKeySizeInBits */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulKeySizeInBits&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jKeySizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get ulIVSizeInBits */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulIVSizeInBits&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jIVSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get bIsExport */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;bIsExport&quot;, &quot;Z&quot;);
      if (fieldID == NULL) { return; }
      jIsExport = (*env)-&gt;GetBooleanField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get RandomInfo */</span>
      jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
      if (jSsl3RandomDataClass == NULL) { return; }
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;RandomInfo&quot;,
              &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
      if (fieldID == NULL) { return; }
      jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pClientRandom and ulClientRandomLength out of RandomInfo */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pServerRandom and ulServerRandomLength out of RandomInfo */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pReturnedKeyMaterial */</span>
      jSsl3KeyMatOutClass = (*env)-&gt;FindClass(env, CLASS_SSL3_KEY_MAT_OUT);
      if (jSsl3KeyMatOutClass == NULL) { return; }
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;pReturnedKeyMaterial&quot;,
              &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_OUT;&quot;);
      if (fieldID == NULL) { return; }
      jReturnedKeyMaterial = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pIVClient out of pReturnedKeyMaterial */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVClient&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRMIvClient = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pIVServer out of pReturnedKeyMaterial */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVServer&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRMIvServer = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
      *cKKeyMatParamUlMacSizeInBits = jLongToCKULong(jMacSizeInBits);
      *cKKeyMatParamUlKeySizeInBits = jLongToCKULong(jKeySizeInBits);
      *cKKeyMatParamUlIVSizeInBits = jLongToCKULong(jIVSizeInBits);
      *cKKeyMatParamBIsExport = jBooleanToCKBBool(jIsExport);
      jByteArrayToCKByteArray(env, jRIClientRandom,
              &amp;(cKKeyMatParamRandomInfo-&gt;pClientRandom),
              &amp;(cKKeyMatParamRandomInfo-&gt;ulClientRandomLen));
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return; }</span>
      jByteArrayToCKByteArray(env, jRIServerRandom,
              &amp;(cKKeyMatParamRandomInfo-&gt;pServerRandom),
              &amp;(cKKeyMatParamRandomInfo-&gt;ulServerRandomLen));
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed">-         return;</span>
      }
<span class="line-modified">!     /* allocate memory for pRetrunedKeyMaterial */</span>
      *cKKeyMatParamPReturnedKeyMaterial =
<span class="line-modified">!             (CK_SSL3_KEY_MAT_OUT_PTR)malloc(sizeof(CK_SSL3_KEY_MAT_OUT));</span>
      if (*cKKeyMatParamPReturnedKeyMaterial == NULL) {
<span class="line-removed">-         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed">-         free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
          throwOutOfMemoryError(env, 0);
<span class="line-modified">!         return;</span>
      }
  
      // the handles are output params only, no need to fetch them from Java
      (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientMacSecret = 0;
      (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerMacSecret = 0;
<span class="line-new-header">--- 746,74 ---</span>
      jboolean jIsExport;
      jobject jRandomInfo, jRIClientRandom, jRIServerRandom;
      jobject jReturnedKeyMaterial, jRMIvClient, jRMIvServer;
      CK_ULONG ckTemp;
  
<span class="line-modified">!     // the pointer arguments should already be initialized by caller</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulMacSizeInBits&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jMacSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulKeySizeInBits&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jKeySizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;ulIVSizeInBits&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jIVSizeInBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;bIsExport&quot;, &quot;Z&quot;);
      if (fieldID == NULL) { return; }
      jIsExport = (*env)-&gt;GetBooleanField(env, jParam, fieldID);
      jSsl3RandomDataClass = (*env)-&gt;FindClass(env, CLASS_SSL3_RANDOM_DATA);
      if (jSsl3RandomDataClass == NULL) { return; }
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;RandomInfo&quot;,
              &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA;&quot;);
      if (fieldID == NULL) { return; }
      jRandomInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pClientRandom&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRIClientRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3RandomDataClass, &quot;pServerRandom&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRIServerRandom = (*env)-&gt;GetObjectField(env, jRandomInfo, fieldID);
      jSsl3KeyMatOutClass = (*env)-&gt;FindClass(env, CLASS_SSL3_KEY_MAT_OUT);
      if (jSsl3KeyMatOutClass == NULL) { return; }
      fieldID = (*env)-&gt;GetFieldID(env, jKeyMatParamClass, &quot;pReturnedKeyMaterial&quot;,
              &quot;Lsun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_OUT;&quot;);
      if (fieldID == NULL) { return; }
      jReturnedKeyMaterial = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVClient&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRMIvClient = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jSsl3KeyMatOutClass, &quot;pIVServer&quot;, &quot;[B&quot;);
      if (fieldID == NULL) { return; }
      jRMIvServer = (*env)-&gt;GetObjectField(env, jReturnedKeyMaterial, fieldID);
  
<span class="line-modified">!     // populate the specified pointers using java values</span>
      *cKKeyMatParamUlMacSizeInBits = jLongToCKULong(jMacSizeInBits);
      *cKKeyMatParamUlKeySizeInBits = jLongToCKULong(jKeySizeInBits);
      *cKKeyMatParamUlIVSizeInBits = jLongToCKULong(jIVSizeInBits);
      *cKKeyMatParamBIsExport = jBooleanToCKBBool(jIsExport);
      jByteArrayToCKByteArray(env, jRIClientRandom,
              &amp;(cKKeyMatParamRandomInfo-&gt;pClientRandom),
              &amp;(cKKeyMatParamRandomInfo-&gt;ulClientRandomLen));
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         // just return as no memory allocation yet</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
      jByteArrayToCKByteArray(env, jRIServerRandom,
              &amp;(cKKeyMatParamRandomInfo-&gt;pServerRandom),
              &amp;(cKKeyMatParamRandomInfo-&gt;ulServerRandomLen));
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
<span class="line-modified">!     /* allocate memory for pReturnedKeyMaterial */</span>
      *cKKeyMatParamPReturnedKeyMaterial =
<span class="line-modified">!             (CK_SSL3_KEY_MAT_OUT_PTR) calloc(1, sizeof(CK_SSL3_KEY_MAT_OUT));</span>
      if (*cKKeyMatParamPReturnedKeyMaterial == NULL) {
          throwOutOfMemoryError(env, 0);
<span class="line-modified">!         goto cleanup;</span>
      }
  
      // the handles are output params only, no need to fetch them from Java
      (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hClientMacSecret = 0;
      (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerMacSecret = 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 764,192 ***</span>
      (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerKey = 0;
  
      jByteArrayToCKByteArray(env, jRMIvClient,
              &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient), &amp;ckTemp);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed">-         free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-removed">-         free((*cKKeyMatParamPReturnedKeyMaterial));</span>
<span class="line-removed">-         return;</span>
      }
      jByteArrayToCKByteArray(env, jRMIvServer,
              &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVServer), &amp;ckTemp);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-removed">-         free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-removed">-         free((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient);</span>
<span class="line-removed">-         free((*cKKeyMatParamPReturnedKeyMaterial));</span>
<span class="line-removed">-         return;</span>
      }
  
      return;
  }
  /*
   * converts the Java CK_SSL3_KEY_MAT_PARAMS object to a
<span class="line-modified">!  * CK_SSL3_KEY_MAT_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_SSL3_KEY_MAT_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_SSL3_KEY_MAT_PARAMS structure</span>
   */
<span class="line-modified">! CK_SSL3_KEY_MAT_PARAMS</span>
<span class="line-modified">! jSsl3KeyMatParamToCKSsl3KeyMatParam(JNIEnv *env, jobject jParam)</span>
  {
<span class="line-modified">!     CK_SSL3_KEY_MAT_PARAMS ckParam;</span>
      jclass jSsl3KeyMatParamsClass;
<span class="line-modified">!     memset(&amp;ckParam, 0, sizeof(CK_SSL3_KEY_MAT_PARAMS));</span>
      jSsl3KeyMatParamsClass = (*env)-&gt;FindClass(env,
              CLASS_SSL3_KEY_MAT_PARAMS);
<span class="line-modified">!     if (jSsl3KeyMatParamsClass == NULL) { return ckParam; }</span>
      keyMatParamToCKKeyMatParam(env, jParam, jSsl3KeyMatParamsClass,
<span class="line-modified">!             &amp;ckParam.ulMacSizeInBits, &amp;ckParam.ulKeySizeInBits,</span>
<span class="line-modified">!             &amp;ckParam.ulIVSizeInBits, &amp;ckParam.bIsExport,</span>
<span class="line-modified">!             &amp;ckParam.RandomInfo, &amp;ckParam.pReturnedKeyMaterial);</span>
<span class="line-modified">!     return ckParam;</span>
  }
  
  /*
   * converts the Java CK_TLS12_KEY_MAT_PARAMS object to a
<span class="line-modified">!  * CK_TLS12_KEY_MAT_PARAMS structure</span>
   *
   * @param env - used to call JNI functions to get the Java classes and objects
   * @param jParam - the Java CK_TLS12_KEY_MAT_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_TLS12_KEY_MAT_PARAMS structure</span>
   */
<span class="line-modified">! CK_TLS12_KEY_MAT_PARAMS jTls12KeyMatParamToCKTls12KeyMatParam(JNIEnv *env,</span>
<span class="line-modified">!         jobject jParam)</span>
  {
<span class="line-modified">!     CK_TLS12_KEY_MAT_PARAMS ckParam;</span>
      jclass jTls12KeyMatParamsClass;
      jfieldID fieldID;
<span class="line-modified">!     memset(&amp;ckParam, 0, sizeof(CK_TLS12_KEY_MAT_PARAMS));</span>
      jTls12KeyMatParamsClass = (*env)-&gt;FindClass(env,
              CLASS_TLS12_KEY_MAT_PARAMS);
<span class="line-modified">!     if (jTls12KeyMatParamsClass == NULL) { return ckParam; }</span>
<span class="line-removed">-     keyMatParamToCKKeyMatParam(env, jParam, jTls12KeyMatParamsClass,</span>
<span class="line-removed">-             &amp;ckParam.ulMacSizeInBits, &amp;ckParam.ulKeySizeInBits,</span>
<span class="line-removed">-             &amp;ckParam.ulIVSizeInBits, &amp;ckParam.bIsExport,</span>
<span class="line-removed">-             &amp;ckParam.RandomInfo, &amp;ckParam.pReturnedKeyMaterial);</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTls12KeyMatParamsClass,
              &quot;prfHashMechanism&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID != NULL) {</span>
<span class="line-modified">!         jlong prfHashMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified">!         ckParam.prfHashMechanism = (CK_MECHANISM_TYPE)prfHashMechanism;</span>
      }
<span class="line-modified">!     return ckParam;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_AES_CTR_PARAMS object to a CK_AES_CTR_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_AES_CTR_PARAMS object to convert
<span class="line-modified">!  * @param ckpParam - pointer to the new CK_AES_CTR_PARAMS structure</span>
   */
<span class="line-modified">! void jAesCtrParamsToCKAesCtrParam(JNIEnv *env, jobject jParam,</span>
<span class="line-modified">!                                   CK_AES_CTR_PARAMS_PTR ckpParam) {</span>
      jclass jAesCtrParamsClass;
      jfieldID fieldID;
      jlong jCounterBits;
      jobject jCb;
<span class="line-modified">!     CK_BYTE_PTR ckBytes;</span>
      CK_ULONG ckTemp;
  
<span class="line-modified">!     /* get ulCounterBits */</span>
      jAesCtrParamsClass = (*env)-&gt;FindClass(env, CLASS_AES_CTR_PARAMS);
<span class="line-modified">!     if (jAesCtrParamsClass == NULL) { return; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;ulCounterBits&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return; }</span>
      jCounterBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get cb */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;cb&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return; }</span>
      jCb = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckpParam-&gt;ulCounterBits = jLongToCKULong(jCounterBits);</span>
      jByteArrayToCKByteArray(env, jCb, &amp;ckBytes, &amp;ckTemp);
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return; }</span>
<span class="line-modified">!     if (ckTemp != 16) {</span>
<span class="line-modified">!         TRACE1(&quot;ERROR: WRONG CTR IV LENGTH %d&quot;, ckTemp);</span>
<span class="line-modified">!     } else {</span>
<span class="line-modified">!         memcpy(ckpParam-&gt;cb, ckBytes, ckTemp);</span>
<span class="line-modified">!         free(ckBytes);</span>
      }
  }
  
  /*
<span class="line-modified">!  * converts a Java CK_MECHANISM object into a CK_MECHANISM structure</span>
   *
<span class="line-modified">!  * @param env - used to call JNI funktions to get the values out of the Java object</span>
<span class="line-modified">!  * @param jMechanism - the Java CK_MECHANISM object to convert</span>
<span class="line-modified">!  * @return - the new CK_MECHANISM structure</span>
   */
<span class="line-modified">! void jMechanismToCKMechanism(JNIEnv *env, jobject jMechanism, CK_MECHANISM_PTR ckMechanismPtr)</span>
  {
<span class="line-modified">!     jlong jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, mech_mechanismID);</span>
<span class="line-modified">!     jobject jParameter = (*env)-&gt;GetObjectField(env, jMechanism, mech_pParameterID);</span>
  
<span class="line-modified">!     (*ckMechanismPtr).mechanism = jLongToCKULong(jMechanismType);</span>
  
<span class="line-modified">!     /* convert the specific Java mechanism parameter object to a pointer to a CK-type mechanism</span>
<span class="line-modified">!      * structure</span>
<span class="line-modified">!      */</span>
<span class="line-modified">!     if (jParameter == NULL) {</span>
<span class="line-modified">!         (*ckMechanismPtr).pParameter = NULL;</span>
<span class="line-modified">!         (*ckMechanismPtr).ulParameterLen = 0;</span>
<span class="line-modified">!     } else {</span>
<span class="line-modified">!         jMechanismParameterToCKMechanismParameter(env, jParameter, &amp;(*ckMechanismPtr).pParameter, &amp;(*ckMechanismPtr).ulParameterLen);</span>
      }
  }
  
  /*
<span class="line-modified">!  * the following functions convert Attribute and Mechanism value pointers</span>
<span class="line-removed">-  *</span>
<span class="line-removed">-  * jobject ckAttributeValueToJObject(JNIEnv *env,</span>
<span class="line-removed">-  *                                   const CK_ATTRIBUTE_PTR ckpAttribute);</span>
<span class="line-removed">-  *</span>
<span class="line-removed">-  * void jObjectToPrimitiveCKObjectPtrPtr(JNIEnv *env,</span>
<span class="line-removed">-  *                                       jobject jObject,</span>
<span class="line-removed">-  *                                       CK_VOID_PTR *ckpObjectPtr,</span>
<span class="line-removed">-  *                                       CK_ULONG *pLength);</span>
   *
<span class="line-modified">!  * void jMechanismParameterToCKMechanismParameter(JNIEnv *env,</span>
<span class="line-modified">!  *                                                jobject jParam,</span>
<span class="line-modified">!  *                                                CK_VOID_PTR *ckpParamPtr,</span>
<span class="line-modified">!  *                                                CK_ULONG *ckpLength);</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * These functions are used if a PKCS#11 mechanism or attribute structure gets</span>
<span class="line-modified">!  * convertet to a Java attribute or mechanism object or vice versa.</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * ckAttributeValueToJObject converts a PKCS#11 attribute value pointer to a Java</span>
<span class="line-modified">!  * object depending on the type of the Attribute. A PKCS#11 attribute value can</span>
<span class="line-modified">!  * be a CK_ULONG, CK_BYTE[], CK_CHAR[], big integer, CK_BBOOL, CK_UTF8CHAR[],</span>
<span class="line-modified">!  * CK_DATE or CK_FLAGS that gets converted to a corresponding Java object.</span>
<span class="line-modified">!  *</span>
<span class="line-modified">!  * jObjectToPrimitiveCKObjectPtrPtr is used by jAttributeToCKAttributePtr for</span>
<span class="line-modified">!  * converting the Java attribute value to a PKCS#11 attribute value pointer.</span>
<span class="line-modified">!  * For now only primitive datatypes and arrays of primitive datatypes can get</span>
<span class="line-modified">!  * converted. Otherwise this function throws a PKCS#11Exception with the</span>
<span class="line-modified">!  * errorcode CKR_VENDOR_DEFINED.</span>
   *
<span class="line-modified">!  * jMechanismParameterToCKMechanismParameter converts a Java mechanism parameter</span>
<span class="line-modified">!  * to a PKCS#11 mechanism parameter. First this function determines what mechanism</span>
<span class="line-modified">!  * parameter the Java object is, then it allocates the memory for the new PKCS#11</span>
<span class="line-removed">-  * structure and calls the corresponding function to convert the Java object to</span>
<span class="line-removed">-  * a PKCS#11 mechanism parameter structure.</span>
   */
  
  /*
<span class="line-modified">!  * converts the pValue of a CK_ATTRIBUTE structure into a Java Object by checking the type</span>
<span class="line-modified">!  * of the attribute.</span>
   *
<span class="line-modified">!  * @param env - used to call JNI funktions to create the new Java object</span>
   * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure that contains the type
   *                       and the pValue to convert
<span class="line-modified">!  * @return - the new Java object of the CK-type pValue</span>
   */
  jobject ckAttributeValueToJObject(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
  {
      jint jValueLength;
      jobject jValueObject = NULL;
<span class="line-new-header">--- 821,393 ---</span>
      (*cKKeyMatParamPReturnedKeyMaterial)-&gt;hServerKey = 0;
  
      jByteArrayToCKByteArray(env, jRMIvClient,
              &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient), &amp;ckTemp);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
      jByteArrayToCKByteArray(env, jRMIvServer,
              &amp;((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVServer), &amp;ckTemp);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
  
<span class="line-added">+     return;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(cKKeyMatParamRandomInfo-&gt;pClientRandom);</span>
<span class="line-added">+     free(cKKeyMatParamRandomInfo-&gt;pServerRandom);</span>
<span class="line-added">+     if ((*cKKeyMatParamPReturnedKeyMaterial) != NULL) {</span>
<span class="line-added">+         free((*cKKeyMatParamPReturnedKeyMaterial)-&gt;pIVClient);</span>
<span class="line-added">+         free(*cKKeyMatParamPReturnedKeyMaterial);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     // explicitly set to NULL to ensure no double free possible</span>
<span class="line-added">+     cKKeyMatParamRandomInfo-&gt;pClientRandom = NULL;</span>
<span class="line-added">+     cKKeyMatParamRandomInfo-&gt;pServerRandom = NULL;</span>
<span class="line-added">+     *cKKeyMatParamPReturnedKeyMaterial = NULL;</span>
      return;
  }
  /*
   * converts the Java CK_SSL3_KEY_MAT_PARAMS object to a
<span class="line-modified">!  * CK_SSL3_KEY_MAT_PARAMS pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_SSL3_KEY_MAT_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_SSL3_KEY_MAT_PARAMS structure</span>
   */
<span class="line-modified">! CK_SSL3_KEY_MAT_PARAMS_PTR</span>
<span class="line-modified">! jSsl3KeyMatParamToCKSsl3KeyMatParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-modified">!     CK_SSL3_KEY_MAT_PARAMS_PTR ckParamPtr;</span>
      jclass jSsl3KeyMatParamsClass;
<span class="line-modified">! </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // allocate memory for CK_SSL3_KEY_MAT_PARAMS pointer</span>
<span class="line-added">+     ckParamPtr = calloc(1, sizeof(CK_SSL3_KEY_MAT_PARAMS));</span>
<span class="line-added">+     if (ckParamPtr == NULL) {</span>
<span class="line-added">+         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve and  populate using java values</span>
      jSsl3KeyMatParamsClass = (*env)-&gt;FindClass(env,
              CLASS_SSL3_KEY_MAT_PARAMS);
<span class="line-modified">!     if (jSsl3KeyMatParamsClass == NULL) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
      keyMatParamToCKKeyMatParam(env, jParam, jSsl3KeyMatParamsClass,
<span class="line-modified">!             &amp;(ckParamPtr-&gt;ulMacSizeInBits), &amp;(ckParamPtr-&gt;ulKeySizeInBits),</span>
<span class="line-modified">!             &amp;(ckParamPtr-&gt;ulIVSizeInBits), &amp;(ckParamPtr-&gt;bIsExport),</span>
<span class="line-modified">!             &amp;(ckParamPtr-&gt;RandomInfo), &amp;(ckParamPtr-&gt;pReturnedKeyMaterial));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_SSL3_KEY_MAT_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
   * converts the Java CK_TLS12_KEY_MAT_PARAMS object to a
<span class="line-modified">!  * CK_TLS12_KEY_MAT_PARAMS pointer</span>
   *
   * @param env - used to call JNI functions to get the Java classes and objects
   * @param jParam - the Java CK_TLS12_KEY_MAT_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_TLS12_KEY_MAT_PARAMS structure</span>
   */
<span class="line-modified">! CK_TLS12_KEY_MAT_PARAMS_PTR jTls12KeyMatParamToCKTls12KeyMatParamPtr(JNIEnv *env,</span>
<span class="line-modified">!         jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-modified">!     CK_TLS12_KEY_MAT_PARAMS_PTR ckParamPtr;</span>
      jclass jTls12KeyMatParamsClass;
      jfieldID fieldID;
<span class="line-modified">!     jlong prfHashMechanism;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jTls12KeyMatParamsClass = (*env)-&gt;FindClass(env,
              CLASS_TLS12_KEY_MAT_PARAMS);
<span class="line-modified">!     if (jTls12KeyMatParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jTls12KeyMatParamsClass,
              &quot;prfHashMechanism&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
<span class="line-modified">!     prfHashMechanism = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-modified">! </span>
<span class="line-added">+     // allocate memory for CK_TLS12_KEY_MAT_PARAMS pointer</span>
<span class="line-added">+     ckParamPtr = calloc(1, sizeof(CK_TLS12_KEY_MAT_PARAMS));</span>
<span class="line-added">+     if (ckParamPtr == NULL) {</span>
<span class="line-added">+         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     keyMatParamToCKKeyMatParam(env, jParam, jTls12KeyMatParamsClass,</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulMacSizeInBits), &amp;(ckParamPtr-&gt;ulKeySizeInBits),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulIVSizeInBits), &amp;(ckParamPtr-&gt;bIsExport),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;RandomInfo), &amp;(ckParamPtr-&gt;pReturnedKeyMaterial));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
      }
<span class="line-modified">!     ckParamPtr-&gt;prfHashMechanism = (CK_MECHANISM_TYPE)prfHashMechanism;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_TLS12_KEY_MAT_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_AES_CTR_PARAMS object to a CK_AES_CTR_PARAMS pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_AES_CTR_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_AES_CTR_PARAMS structure</span>
   */
<span class="line-modified">! CK_AES_CTR_PARAMS_PTR</span>
<span class="line-modified">! jAesCtrParamsToCKAesCtrParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     CK_AES_CTR_PARAMS_PTR ckParamPtr;</span>
      jclass jAesCtrParamsClass;
      jfieldID fieldID;
      jlong jCounterBits;
      jobject jCb;
<span class="line-modified">!     CK_BYTE_PTR ckBytes = NULL;</span>
      CK_ULONG ckTemp;
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0L;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jAesCtrParamsClass = (*env)-&gt;FindClass(env, CLASS_AES_CTR_PARAMS);
<span class="line-modified">!     if (jAesCtrParamsClass == NULL) { return NULL; }</span>
<span class="line-added">+     if (!(*env)-&gt;IsInstanceOf(env, jParam, jAesCtrParamsClass)) {</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;ulCounterBits&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jCounterBits = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jAesCtrParamsClass, &quot;cb&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jCb = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_AES_CTR_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_AES_CTR_PARAMS));</span>
<span class="line-added">+     if (ckParamPtr == NULL) {</span>
<span class="line-added">+         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
      jByteArrayToCKByteArray(env, jCb, &amp;ckBytes, &amp;ckTemp);
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env) || ckTemp != 16) {</span>
<span class="line-modified">!         goto cleanup;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     memcpy(ckParamPtr-&gt;cb, ckBytes, ckTemp);</span>
<span class="line-modified">!     free(ckBytes);</span>
<span class="line-modified">! </span>
<span class="line-added">+     ckParamPtr-&gt;ulCounterBits = jLongToCKULong(jCounterBits);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_AES_CTR_PARAMS);</span>
      }
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckBytes);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_GCM_PARAMS object to a CK_GCM_PARAMS_NO_IVBITS pointer</span>
<span class="line-added">+  * Note: Need to try NSS definition first to avoid SIGSEGV.</span>
   *
<span class="line-modified">!  * @param env - used to call JNI funktions to get the Java classes and objects</span>
<span class="line-modified">!  * @param jParam - the Java CK_GCM_PARAMS object to convert</span>
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_GCM_PARAMS_NO_IVBITS structure</span>
   */
<span class="line-modified">! CK_GCM_PARAMS_NO_IVBITS_PTR</span>
<span class="line-added">+ jGCMParamsToCKGCMParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-modified">!     CK_GCM_PARAMS_NO_IVBITS_PTR ckParamPtr;</span>
<span class="line-modified">!     jclass jGcmParamsClass;</span>
<span class="line-added">+     jfieldID fieldID;</span>
<span class="line-added">+     jobject jIv, jAad;</span>
<span class="line-added">+     jlong jTagLen;</span>
  
<span class="line-modified">!     TRACE0(&quot;DEBUG jGCMParamsToCKGCMParam is called\n&quot;);</span>
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-modified">!         *pLength = 0L;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     // retrieve java values</span>
<span class="line-modified">!     jGcmParamsClass = (*env)-&gt;FindClass(env, CLASS_GCM_PARAMS);</span>
<span class="line-modified">!     if (jGcmParamsClass == NULL) { return NULL; }</span>
<span class="line-modified">!     if (!(*env)-&gt;IsInstanceOf(env, jParam, jGcmParamsClass)) {</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     fieldID = (*env)-&gt;GetFieldID(env, jGcmParamsClass, &quot;iv&quot;, &quot;[B&quot;);</span>
<span class="line-added">+     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">+     jIv = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">+     fieldID = (*env)-&gt;GetFieldID(env, jGcmParamsClass, &quot;aad&quot;, &quot;[B&quot;);</span>
<span class="line-added">+     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">+     jAad = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">+     fieldID = (*env)-&gt;GetFieldID(env, jGcmParamsClass, &quot;tagBits&quot;, &quot;J&quot;);</span>
<span class="line-added">+     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">+     jTagLen = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-added">+ </span>
<span class="line-added">+     // allocate memory for CK_GCM_PARAMS_NO_IVBITS pointer</span>
<span class="line-added">+     ckParamPtr = calloc(1, sizeof(CK_GCM_PARAMS_NO_IVBITS));</span>
<span class="line-added">+     if (ckParamPtr == NULL) {</span>
<span class="line-added">+         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jIv, &amp;(ckParamPtr-&gt;pIv), &amp;(ckParamPtr-&gt;ulIvLen));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jAad, &amp;(ckParamPtr-&gt;pAAD), &amp;(ckParamPtr-&gt;ulAADLen));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     ckParamPtr-&gt;ulTagBits = jLongToCKULong(jTagLen);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_GCM_PARAMS_NO_IVBITS);</span>
      }
<span class="line-added">+     TRACE1(&quot;Created inner GCM_PARAMS PTR w/o ulIvBits %p\n&quot;, ckParamPtr);</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr-&gt;pIv);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pAAD);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_CCM_PARAMS object to a CK_CCM_PARAMS pointer</span>
   *
<span class="line-modified">!  * @param env - used to call JNI functions to get the Java classes and objects</span>
<span class="line-modified">!  * @param jParam - the Java CK_CCM_PARAMS object to convert</span>
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-modified">!  * @return pointer to the new CK_CCM_PARAMS structure</span>
<span class="line-modified">!  */</span>
<span class="line-modified">! CK_CCM_PARAMS_PTR</span>
<span class="line-modified">! jCCMParamsToCKCCMParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     CK_CCM_PARAMS_PTR ckParamPtr;</span>
<span class="line-modified">!     jclass jCcmParamsClass;</span>
<span class="line-modified">!     jfieldID fieldID;</span>
<span class="line-modified">!     jobject jNonce, jAad;</span>
<span class="line-modified">!     jlong jDataLen, jMacLen;</span>
<span class="line-modified">! </span>
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-modified">!         *pLength = 0;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-added">+     // retrieve java values</span>
<span class="line-added">+     jCcmParamsClass = (*env)-&gt;FindClass(env, CLASS_CCM_PARAMS);</span>
<span class="line-added">+     if (jCcmParamsClass == NULL) { return NULL; }</span>
<span class="line-added">+     if (!(*env)-&gt;IsInstanceOf(env, jParam, jCcmParamsClass)) {</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;dataLen&quot;, &quot;J&quot;);</span>
<span class="line-added">+     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">+     jDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-added">+     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;nonce&quot;, &quot;[B&quot;);</span>
<span class="line-added">+     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">+     jNonce = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">+     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;aad&quot;, &quot;[B&quot;);</span>
<span class="line-added">+     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">+     jAad = (*env)-&gt;GetObjectField(env, jParam, fieldID);</span>
<span class="line-added">+     fieldID = (*env)-&gt;GetFieldID(env, jCcmParamsClass, &quot;macLen&quot;, &quot;J&quot;);</span>
<span class="line-added">+     if (fieldID == NULL) { return NULL; }</span>
<span class="line-added">+     jMacLen = (*env)-&gt;GetLongField(env, jParam, fieldID);</span>
<span class="line-added">+ </span>
<span class="line-added">+     // allocate memory for CK_CCM_PARAMS pointer</span>
<span class="line-added">+     ckParamPtr = calloc(1, sizeof(CK_CCM_PARAMS));</span>
<span class="line-added">+     if (ckParamPtr == NULL) {</span>
<span class="line-added">+         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;ulDataLen = jLongToCKULong(jDataLen);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jNonce, &amp;(ckParamPtr-&gt;pNonce),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulNonceLen));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jAad, &amp;(ckParamPtr-&gt;pAAD),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulAADLen));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     ckParamPtr-&gt;ulMACLen = jLongToCKULong(jMacLen);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_CCM_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr-&gt;pNonce);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pAAD);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ /*</span>
<span class="line-added">+  * converts a Java CK_MECHANISM object into a CK_MECHANISM pointer</span>
<span class="line-added">+  * pointer.</span>
   *
<span class="line-modified">!  * @param env - used to call JNI funktions to get the values out of the Java object</span>
<span class="line-modified">!  * @param jMech - the Java CK_MECHANISM object to convert</span>
<span class="line-modified">!  * @return pointer to the new CK_MECHANISM structure</span>
   */
<span class="line-added">+ CK_MECHANISM_PTR jMechanismToCKMechanismPtr(JNIEnv *env, jobject jMech)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     CK_MECHANISM_PTR ckpMech;</span>
<span class="line-added">+     jlong jMechType = (*env)-&gt;GetLongField(env, jMech, mech_mechanismID);</span>
<span class="line-added">+     jobject jParam = (*env)-&gt;GetObjectField(env, jMech, mech_pParameterID);</span>
<span class="line-added">+ </span>
<span class="line-added">+     /* allocate memory for CK_MECHANISM_PTR */</span>
<span class="line-added">+     ckpMech =  (CK_MECHANISM_PTR) calloc(1, sizeof(CK_MECHANISM));</span>
<span class="line-added">+     if (ckpMech == NULL) {</span>
<span class="line-added">+         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     TRACE1(&quot;DEBUG jMechanismToCKMechanismPtr: allocated mech %p\n&quot;, ckpMech);</span>
<span class="line-added">+ </span>
<span class="line-added">+     ckpMech-&gt;mechanism = jLongToCKULong(jMechType);</span>
<span class="line-added">+ </span>
<span class="line-added">+     /* convert the specific Java mechanism parameter object to a pointer to a</span>
<span class="line-added">+      *  CK-type mechanism structure</span>
<span class="line-added">+      */</span>
<span class="line-added">+     if (jParam == NULL) {</span>
<span class="line-added">+         ckpMech-&gt;pParameter = NULL;</span>
<span class="line-added">+         ckpMech-&gt;ulParameterLen = 0;</span>
<span class="line-added">+     } else {</span>
<span class="line-added">+         ckpMech-&gt;pParameter = jMechParamToCKMechParamPtr(env, jParam,</span>
<span class="line-added">+             ckpMech-&gt;mechanism, &amp;(ckpMech-&gt;ulParameterLen));</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckpMech;</span>
<span class="line-added">+ }</span>
  
  /*
<span class="line-modified">!  * converts the pValue of a CK_ATTRIBUTE structure into a Java Object by</span>
<span class="line-modified">!  * checking the type of the attribute. A PKCS#11 attribute value can</span>
<span class="line-added">+  * be a CK_ULONG, CK_BYTE[], CK_CHAR[], big integer, CK_BBOOL, CK_UTF8CHAR[],</span>
<span class="line-added">+  * CK_DATE or CK_FLAGS that gets converted to a corresponding Java object.</span>
   *
<span class="line-modified">!  * @param env - used to call JNI functions to create the new Java object</span>
   * @param ckpAttribute - the pointer to the CK_ATTRIBUTE structure that contains the type
   *                       and the pValue to convert
<span class="line-modified">!  * @return the new Java object of the CK-type pValue</span>
   */
  jobject ckAttributeValueToJObject(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute)
  {
      jint jValueLength;
      jobject jValueObject = NULL;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1088,592 ***</span>
   * Every field of the Java object is retrieved, gets converted to a corresponding
   * PKCS#11 type and is set in the new PKCS#11 structure.
   */
  
  /*
<span class="line-modified">!  * converts the given Java mechanism parameter to a CK mechanism parameter structure</span>
<span class="line-modified">!  * and store the length in bytes in the length variable.</span>
<span class="line-removed">-  * The memory of *ckpParamPtr has to be freed after use!</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java mechanism parameter object to convert
<span class="line-modified">!  * @param ckpParamPtr - the reference of the new pointer to the new CK mechanism parameter</span>
<span class="line-removed">-  *                      structure</span>
   * @param ckpLength - the reference of the length in bytes of the new CK mechanism parameter
   *                    structure
   */
<span class="line-modified">! void jMechanismParameterToCKMechanismParameter(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength)</span>
  {
      if (jParam == NULL) {
<span class="line-modified">!         *ckpParamPtr = NULL;</span>
          *ckpLength = 0;
      } else if ((*env)-&gt;IsInstanceOf(env, jParam, jByteArrayClass)) {
<span class="line-modified">!         jByteArrayToCKByteArray(env, jParam, (CK_BYTE_PTR *)ckpParamPtr, ckpLength);</span>
      } else if ((*env)-&gt;IsInstanceOf(env, jParam, jLongClass)) {
<span class="line-modified">!         *ckpParamPtr = jLongObjectToCKULongPtr(env, jParam);</span>
          *ckpLength = sizeof(CK_ULONG);
      } else {
<span class="line-modified">!         TRACE0(&quot;\nSLOW PATH jMechanismParameterToCKMechanismParameter\n&quot;);</span>
<span class="line-removed">-         jMechanismParameterToCKMechanismParameterSlow(env, jParam, ckpParamPtr, ckpLength);</span>
      }
  }
  
<span class="line-modified">! void jMechanismParameterToCKMechanismParameterSlow(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength)</span>
  {
<span class="line-modified">!     /* get all Java mechanism parameter classes */</span>
<span class="line-removed">-     jclass jVersionClass, jSsl3MasterKeyDeriveParamsClass;</span>
<span class="line-removed">-     jclass jTls12MasterKeyDeriveParamsClass, jSsl3KeyMatParamsClass;</span>
<span class="line-removed">-     jclass jTls12KeyMatParamsClass;</span>
<span class="line-removed">-     jclass jTlsPrfParamsClass, jTlsMacParamsClass, jAesCtrParamsClass;</span>
<span class="line-removed">-     jclass jRsaPkcsOaepParamsClass;</span>
<span class="line-removed">-     jclass jPbeParamsClass, jPkcs5Pbkd2ParamsClass, jRsaPkcsPssParamsClass;</span>
<span class="line-removed">-     jclass jEcdh1DeriveParamsClass, jEcdh2DeriveParamsClass;</span>
<span class="line-removed">-     jclass jX942Dh1DeriveParamsClass, jX942Dh2DeriveParamsClass;</span>
<span class="line-removed">-     TRACE0(&quot;\nDEBUG: jMechanismParameterToCKMechanismParameter&quot;);</span>
  
<span class="line-modified">!     /* most common cases, i.e. NULL/byte[]/long, are already handled by</span>
<span class="line-modified">!      * jMechanismParameterToCKMechanismParameter before calling this method.</span>
       */
<span class="line-modified">!     jVersionClass = (*env)-&gt;FindClass(env, CLASS_VERSION);</span>
<span class="line-modified">!     if (jVersionClass == NULL) { return; }</span>
<span class="line-modified">!     if ((*env)-&gt;IsInstanceOf(env, jParam, jVersionClass)) {</span>
<span class="line-modified">!         /*</span>
<span class="line-modified">!          * CK_VERSION used by CKM_SSL3_PRE_MASTER_KEY_GEN</span>
<span class="line-modified">!          */</span>
<span class="line-modified">!         CK_VERSION_PTR ckpParam;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         /* convert jParameter to CKParameter */</span>
<span class="line-modified">!         ckpParam = jVersionToCKVersionPtr(env, jParam);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         /* get length and pointer of parameter */</span>
<span class="line-modified">!         *ckpLength = sizeof(CK_VERSION);</span>
<span class="line-modified">!         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">!         return;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     jSsl3MasterKeyDeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">!     if (jSsl3MasterKeyDeriveParamsClass == NULL) { return; }</span>
<span class="line-modified">!     if ((*env)-&gt;IsInstanceOf(env, jParam, jSsl3MasterKeyDeriveParamsClass)) {</span>
<span class="line-modified">!         /*</span>
<span class="line-modified">!          * CK_SSL3_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-modified">!          */</span>
<span class="line-modified">!         CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         ckpParam = (CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR) malloc(sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-modified">!         if (ckpParam == NULL) {</span>
<span class="line-modified">!             throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-modified">!         /* convert jParameter to CKParameter */</span>
<span class="line-modified">!         *ckpParam = jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParam(env, jParam);</span>
<span class="line-modified">!         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">!             free(ckpParam);</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-modified">!         /* get length and pointer of parameter */</span>
<span class="line-modified">!         *ckpLength = sizeof(CK_SSL3_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">!         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">!         return;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     jSsl3KeyMatParamsClass = (*env)-&gt;FindClass(env, CLASS_SSL3_KEY_MAT_PARAMS);</span>
<span class="line-modified">!     if (jSsl3KeyMatParamsClass == NULL) { return; }</span>
<span class="line-modified">!     if ((*env)-&gt;IsInstanceOf(env, jParam, jSsl3KeyMatParamsClass)) {</span>
<span class="line-modified">!         /*</span>
<span class="line-modified">!          * CK_SSL3_KEY_MAT_PARAMS</span>
<span class="line-modified">!          */</span>
<span class="line-modified">!         CK_SSL3_KEY_MAT_PARAMS_PTR ckpParam;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         ckpParam = (CK_SSL3_KEY_MAT_PARAMS_PTR) malloc(sizeof(CK_SSL3_KEY_MAT_PARAMS));</span>
<span class="line-modified">!         if (ckpParam == NULL) {</span>
<span class="line-modified">!             throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-modified">!         /* convert jParameter to CKParameter */</span>
<span class="line-modified">!         *ckpParam = jSsl3KeyMatParamToCKSsl3KeyMatParam(env, jParam);</span>
<span class="line-modified">!         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">!             free(ckpParam);</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-modified">!         /* get length and pointer of parameter */</span>
<span class="line-modified">!         *ckpLength = sizeof(CK_SSL3_KEY_MAT_PARAMS);</span>
<span class="line-modified">!         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">!         return;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     jTls12KeyMatParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS12_KEY_MAT_PARAMS);</span>
<span class="line-modified">!     if (jTls12KeyMatParamsClass == NULL) { return; }</span>
<span class="line-modified">!     if ((*env)-&gt;IsInstanceOf(env, jParam, jTls12KeyMatParamsClass)) {</span>
<span class="line-modified">!         /*</span>
<span class="line-modified">!          * CK_TLS12_KEY_MAT_PARAMS</span>
<span class="line-modified">!          */</span>
<span class="line-modified">!         CK_TLS12_KEY_MAT_PARAMS_PTR ckpParam;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         ckpParam = (CK_TLS12_KEY_MAT_PARAMS_PTR) malloc(sizeof(CK_TLS12_KEY_MAT_PARAMS));</span>
<span class="line-modified">!         if (ckpParam == NULL) {</span>
<span class="line-modified">!             throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-modified">!         /* convert jParameter to CKParameter */</span>
<span class="line-modified">!         *ckpParam = jTls12KeyMatParamToCKTls12KeyMatParam(env, jParam);</span>
<span class="line-modified">!         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">!             free(ckpParam);</span>
<span class="line-modified">!             return;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-modified">!         /* get length and pointer of parameter */</span>
<span class="line-modified">!         *ckpLength = sizeof(CK_TLS12_KEY_MAT_PARAMS);</span>
<span class="line-modified">!         *ckpParamPtr = ckpParam;</span>
<span class="line-modified">!         return;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     jTls12MasterKeyDeriveParamsClass =</span>
<span class="line-modified">!             (*env)-&gt;FindClass(env, CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-modified">!     if (jTls12MasterKeyDeriveParamsClass == NULL) { return; }</span>
<span class="line-modified">!     if ((*env)-&gt;IsInstanceOf(env, jParam, jTls12MasterKeyDeriveParamsClass)) {</span>
<span class="line-modified">!         /*</span>
<span class="line-modified">!          * CK_TLS12_MASTER_KEY_DERIVE_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_TLS12_MASTER_KEY_DERIVE_PARAMS_PTR)malloc(</span>
<span class="line-removed">-                 sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_TLS12_MASTER_KEY_DERIVE_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jTlsPrfParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_PRF_PARAMS);</span>
<span class="line-removed">-     if (jTlsPrfParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jTlsPrfParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_TLS_PRF_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_TLS_PRF_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_TLS_PRF_PARAMS_PTR) malloc(sizeof(CK_TLS_PRF_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jTlsPrfParamsToCKTlsPrfParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_TLS_PRF_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jTlsMacParamsClass = (*env)-&gt;FindClass(env, CLASS_TLS_MAC_PARAMS);</span>
<span class="line-removed">-     if (jTlsMacParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jTlsMacParamsClass)) {</span>
<span class="line-removed">-         CK_TLS_MAC_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_TLS_MAC_PARAMS_PTR) malloc(sizeof(CK_TLS_MAC_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jTlsMacParamsToCKTlsMacParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_TLS_MAC_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jAesCtrParamsClass = (*env)-&gt;FindClass(env, CLASS_AES_CTR_PARAMS);</span>
<span class="line-removed">-     if (jAesCtrParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jAesCtrParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_AES_CTR_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_AES_CTR_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_AES_CTR_PARAMS_PTR) malloc(sizeof(CK_AES_CTR_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         jAesCtrParamsToCKAesCtrParam(env, jParam, ckpParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_AES_CTR_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jRsaPkcsOaepParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_OAEP_PARAMS);</span>
<span class="line-removed">-     if (jRsaPkcsOaepParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jRsaPkcsOaepParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_RSA_PKCS_OAEP_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_RSA_PKCS_OAEP_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_RSA_PKCS_OAEP_PARAMS_PTR) malloc(sizeof(CK_RSA_PKCS_OAEP_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jRsaPkcsOaepParamToCKRsaPkcsOaepParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_RSA_PKCS_OAEP_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);</span>
<span class="line-removed">-     if (jPbeParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jPbeParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_PBE_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_PBE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_PBE_PARAMS_PTR) malloc(sizeof(CK_PBE_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jPbeParamToCKPbeParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_PBE_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jPkcs5Pbkd2ParamsClass = (*env)-&gt;FindClass(env, CLASS_PKCS5_PBKD2_PARAMS);</span>
<span class="line-removed">-     if (jPkcs5Pbkd2ParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jPkcs5Pbkd2ParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_PKCS5_PBKD2_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_PKCS5_PBKD2_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_PKCS5_PBKD2_PARAMS_PTR) malloc(sizeof(CK_PKCS5_PBKD2_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jPkcs5Pbkd2ParamToCKPkcs5Pbkd2Param(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_PKCS5_PBKD2_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jRsaPkcsPssParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_PSS_PARAMS);</span>
<span class="line-removed">-     if (jRsaPkcsPssParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jRsaPkcsPssParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_RSA_PKCS_PSS_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_RSA_PKCS_PSS_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_RSA_PKCS_PSS_PARAMS_PTR) malloc(sizeof(CK_RSA_PKCS_PSS_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jRsaPkcsPssParamToCKRsaPkcsPssParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_RSA_PKCS_PSS_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jEcdh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH1_DERIVE_PARAMS);</span>
<span class="line-removed">-     if (jEcdh1DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jEcdh1DeriveParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_ECDH1_DERIVE_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_ECDH1_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_ECDH1_DERIVE_PARAMS_PTR) malloc(sizeof(CK_ECDH1_DERIVE_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jEcdh1DeriveParamToCKEcdh1DeriveParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_ECDH1_DERIVE_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jEcdh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH2_DERIVE_PARAMS);</span>
<span class="line-removed">-     if (jEcdh2DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jEcdh2DeriveParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_ECDH2_DERIVE_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_ECDH2_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_ECDH2_DERIVE_PARAMS_PTR) malloc(sizeof(CK_ECDH2_DERIVE_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jEcdh2DeriveParamToCKEcdh2DeriveParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_ECDH2_DERIVE_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     jX942Dh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH1_DERIVE_PARAMS);</span>
<span class="line-removed">-     if (jX942Dh1DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jX942Dh1DeriveParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_X9_42_DH1_DERIVE_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_X9_42_DH1_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_X9_42_DH1_DERIVE_PARAMS_PTR) malloc(sizeof(CK_X9_42_DH1_DERIVE_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jX942Dh1DeriveParamToCKX942Dh1DeriveParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_X9_42_DH1_DERIVE_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
      }
  
<span class="line-modified">!     jX942Dh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH2_DERIVE_PARAMS);</span>
<span class="line-modified">!     if (jX942Dh2DeriveParamsClass == NULL) { return; }</span>
<span class="line-removed">-     if ((*env)-&gt;IsInstanceOf(env, jParam, jX942Dh2DeriveParamsClass)) {</span>
<span class="line-removed">-         /*</span>
<span class="line-removed">-          * CK_X9_42_DH2_DERIVE_PARAMS</span>
<span class="line-removed">-          */</span>
<span class="line-removed">-         CK_X9_42_DH2_DERIVE_PARAMS_PTR ckpParam;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         ckpParam = (CK_X9_42_DH2_DERIVE_PARAMS_PTR) malloc(sizeof(CK_X9_42_DH2_DERIVE_PARAMS));</span>
<span class="line-removed">-         if (ckpParam == NULL) {</span>
<span class="line-removed">-             throwOutOfMemoryError(env, 0);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* convert jParameter to CKParameter */</span>
<span class="line-removed">-         *ckpParam = jX942Dh2DeriveParamToCKX942Dh2DeriveParam(env, jParam);</span>
<span class="line-removed">-         if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-removed">-             free(ckpParam);</span>
<span class="line-removed">-             return;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         /* get length and pointer of parameter */</span>
<span class="line-removed">-         *ckpLength = sizeof(CK_X9_42_DH2_DERIVE_PARAMS);</span>
<span class="line-removed">-         *ckpParamPtr = ckpParam;</span>
<span class="line-removed">-         return;</span>
      }
  
<span class="line-modified">!     /* if everything faild up to here */</span>
<span class="line-removed">-     /* try if the parameter is a primitive Java type */</span>
<span class="line-removed">-     jObjectToPrimitiveCKObjectPtrPtr(env, jParam, ckpParamPtr, ckpLength);</span>
<span class="line-removed">-     /* *ckpParamPtr = jObjectToCKVoidPtr(jParam); */</span>
<span class="line-removed">-     /* *ckpLength = 1; */</span>
<span class="line-removed">- </span>
<span class="line-removed">-     TRACE0(&quot;FINISHED\n&quot;);</span>
  }
  
<span class="line-removed">- </span>
<span class="line-removed">- /* the mechanism parameter convertion functions: */</span>
<span class="line-removed">- </span>
  /*
<span class="line-modified">!  * converts the Java CK_RSA_PKCS_OAEP_PARAMS object to a CK_RSA_PKCS_OAEP_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_RSA_PKCS_OAEP_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_RSA_PKCS_OAEP_PARAMS structure</span>
   */
<span class="line-modified">! CK_RSA_PKCS_OAEP_PARAMS jRsaPkcsOaepParamToCKRsaPkcsOaepParam(JNIEnv *env, jobject jParam)</span>
  {
      jclass jRsaPkcsOaepParamsClass;
<span class="line-removed">-     CK_RSA_PKCS_OAEP_PARAMS ckParam;</span>
      jfieldID fieldID;
      jlong jHashAlg, jMgf, jSource;
      jobject jSourceData;
<span class="line-removed">-     CK_BYTE_PTR ckpByte;</span>
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_RSA_PKCS_OAEP_PARAMS));</span>
  
<span class="line-modified">!     /* get hashAlg */</span>
      jRsaPkcsOaepParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_OAEP_PARAMS);
<span class="line-modified">!     if (jRsaPkcsOaepParamsClass == NULL) { return ckParam; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get mgf */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get source */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;source&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get sourceData and sourceDataLength */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;pSourceData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckParam.hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-modified">!     ckParam.mgf = jLongToCKULong(jMgf);</span>
<span class="line-modified">!     ckParam.source = jLongToCKULong(jSource);</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jSourceData, &amp; ckpByte, &amp;(ckParam.ulSourceDataLen));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">!     ckParam.pSourceData = (CK_VOID_PTR) ckpByte;</span>
  
<span class="line-modified">!     return ckParam ;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_PBE_PARAMS object to a CK_PBE_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_PBE_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_PBE_PARAMS structure</span>
   */
<span class="line-modified">! CK_PBE_PARAMS jPbeParamToCKPbeParam(JNIEnv *env, jobject jParam)</span>
  {
      jclass jPbeParamsClass;
<span class="line-removed">-     CK_PBE_PARAMS ckParam;</span>
      jfieldID fieldID;
      jlong jIteration;
      jobject jInitVector, jPassword, jSalt;
      CK_ULONG ckTemp;
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_PBE_PARAMS));</span>
  
<span class="line-modified">!     /* get pInitVector */</span>
      jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
<span class="line-modified">!     if (jPbeParamsClass == NULL) { return ckParam; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVector&quot;, &quot;[C&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jInitVector = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pPassword and ulPasswordLength */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pPassword&quot;, &quot;[C&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPassword = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pSalt and ulSaltLength */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pSalt&quot;, &quot;[C&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jSalt = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get ulIteration */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;ulIteration&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckParam.ulIteration = jLongToCKULong(jIteration);</span>
<span class="line-modified">!     jCharArrayToCKCharArray(env, jInitVector, &amp;(ckParam.pInitVector), &amp;ckTemp);</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">!     jCharArrayToCKCharArray(env, jPassword, &amp;(ckParam.pPassword), &amp;(ckParam.ulPasswordLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pInitVector);</span>
<span class="line-removed">-         return ckParam;</span>
      }
<span class="line-modified">!     jCharArrayToCKCharArray(env, jSalt, &amp;(ckParam.pSalt), &amp;(ckParam.ulSaltLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pInitVector);</span>
<span class="line-removed">-         free(ckParam.pPassword);</span>
<span class="line-removed">-         return ckParam;</span>
      }
  
<span class="line-modified">!     return ckParam ;</span>
  }
  
  /*
   * Copy back the initialization vector from the native structure to the
   * Java object. This is only used for CKM_PBE_* mechanisms and their
<span class="line-new-header">--- 1346,293 ---</span>
   * Every field of the Java object is retrieved, gets converted to a corresponding
   * PKCS#11 type and is set in the new PKCS#11 structure.
   */
  
  /*
<span class="line-modified">!  * converts the given Java mechanism parameter to a CK mechanism parameter</span>
<span class="line-modified">!  * pointer and store the length in bytes in the length variable.</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java mechanism parameter object to convert
<span class="line-modified">!  * @param ckMech - the PKCS#11 mechanism type</span>
   * @param ckpLength - the reference of the length in bytes of the new CK mechanism parameter
   *                    structure
<span class="line-added">+  * @return pointer to the new CK mechanism parameter structure</span>
   */
<span class="line-modified">! CK_VOID_PTR jMechParamToCKMechParamPtr(JNIEnv *env, jobject jParam,</span>
<span class="line-added">+         CK_MECHANISM_TYPE ckMech, CK_ULONG *ckpLength)</span>
  {
<span class="line-added">+     CK_VOID_PTR ckpParamPtr;</span>
      if (jParam == NULL) {
<span class="line-modified">!         ckpParamPtr = NULL;</span>
          *ckpLength = 0;
      } else if ((*env)-&gt;IsInstanceOf(env, jParam, jByteArrayClass)) {
<span class="line-modified">!         jByteArrayToCKByteArray(env, jParam, (CK_BYTE_PTR *) &amp;ckpParamPtr, ckpLength);</span>
      } else if ((*env)-&gt;IsInstanceOf(env, jParam, jLongClass)) {
<span class="line-modified">!         ckpParamPtr = jLongObjectToCKULongPtr(env, jParam);</span>
          *ckpLength = sizeof(CK_ULONG);
      } else {
<span class="line-modified">!         ckpParamPtr = jMechParamToCKMechParamPtrSlow(env, jParam, ckMech, ckpLength);</span>
      }
<span class="line-added">+     return ckpParamPtr;</span>
  }
  
<span class="line-modified">! CK_VOID_PTR jMechParamToCKMechParamPtrSlow(JNIEnv *env, jobject jParam,</span>
<span class="line-added">+         CK_MECHANISM_TYPE ckMech, CK_ULONG *ckpLength)</span>
  {
<span class="line-modified">!     CK_VOID_PTR ckpParamPtr = NULL;</span>
  
<span class="line-modified">!     /*</span>
<span class="line-modified">!      * Most common cases, i.e. NULL/byte[]/long, are already handled by</span>
<span class="line-added">+      * jMechParamToCKMechParam before calling this method.</span>
       */
<span class="line-modified">!     TRACE1(&quot;\nDEBUG: jMechParamToCKMechParamPtrSlow, mech=0x%lX\n&quot;, ckMech);</span>
<span class="line-modified">! </span>
<span class="line-modified">!     switch (ckMech) {</span>
<span class="line-modified">!         case CKM_SSL3_PRE_MASTER_KEY_GEN:</span>
<span class="line-modified">!         case CKM_TLS_PRE_MASTER_KEY_GEN:</span>
<span class="line-modified">!             ckpParamPtr = jVersionToCKVersionPtr(env, jParam);</span>
<span class="line-modified">!             if (ckpParamPtr != NULL) {</span>
<span class="line-modified">!                 *ckpLength = sizeof(CK_VERSION);</span>
<span class="line-modified">!             } else {</span>
<span class="line-modified">!                 *ckpLength = 0;</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_SSL3_MASTER_KEY_DERIVE:</span>
<span class="line-modified">!         case CKM_TLS_MASTER_KEY_DERIVE:</span>
<span class="line-modified">!         case CKM_SSL3_MASTER_KEY_DERIVE_DH:</span>
<span class="line-modified">!         case CKM_TLS_MASTER_KEY_DERIVE_DH:</span>
<span class="line-modified">!             ckpParamPtr = jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParamPtr(env, jParam,</span>
<span class="line-modified">!                     ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_SSL3_KEY_AND_MAC_DERIVE:</span>
<span class="line-modified">!         case CKM_TLS_KEY_AND_MAC_DERIVE:</span>
<span class="line-modified">!             ckpParamPtr = jSsl3KeyMatParamToCKSsl3KeyMatParamPtr(env, jParam,</span>
<span class="line-modified">!                     ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_TLS12_KEY_AND_MAC_DERIVE:</span>
<span class="line-modified">!             ckpParamPtr = jTls12KeyMatParamToCKTls12KeyMatParamPtr(env, jParam,</span>
<span class="line-modified">!                     ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_TLS12_MASTER_KEY_DERIVE:</span>
<span class="line-modified">!         case CKM_TLS12_MASTER_KEY_DERIVE_DH:</span>
<span class="line-modified">!             ckpParamPtr = jTls12MasterKeyDeriveParamToCKTls12MasterKeyDeriveParamPtr(env, jParam,</span>
<span class="line-modified">!                     ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_TLS_PRF:</span>
<span class="line-modified">!         case CKM_NSS_TLS_PRF_GENERAL:</span>
<span class="line-modified">!             ckpParamPtr = jTlsPrfParamsToCKTlsPrfParamPtr(env, jParam,</span>
<span class="line-modified">!                     ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_TLS_MAC:</span>
<span class="line-modified">!             ckpParamPtr = jTlsMacParamsToCKTlsMacParamPtr(env, jParam,</span>
<span class="line-modified">!                     ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_AES_CTR:</span>
<span class="line-modified">!             ckpParamPtr = jAesCtrParamsToCKAesCtrParamPtr(env, jParam,</span>
<span class="line-modified">!                     ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_AES_GCM:</span>
<span class="line-modified">!             ckpParamPtr = jGCMParamsToCKGCMParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_AES_CCM:</span>
<span class="line-modified">!             ckpParamPtr = jCCMParamsToCKCCMParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_RSA_PKCS_OAEP:</span>
<span class="line-modified">!             ckpParamPtr = jRsaPkcsOaepParamToCKRsaPkcsOaepParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_PBE_SHA1_DES3_EDE_CBC:</span>
<span class="line-modified">!         case CKM_PBE_SHA1_DES2_EDE_CBC:</span>
<span class="line-modified">!         case CKM_PBA_SHA1_WITH_SHA1_HMAC:</span>
<span class="line-modified">!             ckpParamPtr = jPbeParamToCKPbeParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_PKCS5_PBKD2:</span>
<span class="line-modified">!             ckpParamPtr = jPkcs5Pbkd2ParamToCKPkcs5Pbkd2ParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_RSA_PKCS_PSS:</span>
<span class="line-modified">!         case CKM_SHA1_RSA_PKCS_PSS:</span>
<span class="line-modified">!         case CKM_SHA256_RSA_PKCS_PSS:</span>
<span class="line-modified">!         case CKM_SHA384_RSA_PKCS_PSS:</span>
<span class="line-modified">!         case CKM_SHA512_RSA_PKCS_PSS:</span>
<span class="line-modified">!         case CKM_SHA224_RSA_PKCS_PSS:</span>
<span class="line-modified">!             ckpParamPtr = jRsaPkcsPssParamToCKRsaPkcsPssParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_ECDH1_DERIVE:</span>
<span class="line-modified">!         case CKM_ECDH1_COFACTOR_DERIVE:</span>
<span class="line-modified">!             ckpParamPtr = jEcdh1DeriveParamToCKEcdh1DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_ECMQV_DERIVE:</span>
<span class="line-modified">!             ckpParamPtr = jEcdh2DeriveParamToCKEcdh2DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_X9_42_DH_DERIVE:</span>
<span class="line-modified">!             ckpParamPtr = jX942Dh1DeriveParamToCKX942Dh1DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         case CKM_X9_42_DH_HYBRID_DERIVE:</span>
<span class="line-modified">!         case CKM_X9_42_MQV_DERIVE:</span>
<span class="line-modified">!             ckpParamPtr = jX942Dh2DeriveParamToCKX942Dh2DeriveParamPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         // defined by pkcs11.h but we don&#39;t support</span>
<span class="line-modified">!         case CKM_KEA_DERIVE: // CK_KEA_DERIVE_PARAMS</span>
<span class="line-modified">!         case CKM_RC2_CBC: // CK_RC2_CBC_PARAMS</span>
<span class="line-modified">!         case CKM_RC2_MAC_GENERAL: // CK_RC2_MAC_GENERAL_PARAMS</span>
<span class="line-modified">!         case CKM_RC5_ECB: // CK_RC5_PARAMS</span>
<span class="line-modified">!         case CKM_RC5_MAC: // CK_RC5_PARAMS</span>
<span class="line-modified">!         case CKM_RC5_CBC: // CK_RC5_CBC_PARAMS</span>
<span class="line-modified">!         case CKM_RC5_MAC_GENERAL: // CK_RC5_MAC_GENERAL_PARAMS</span>
<span class="line-modified">!         case CKM_SKIPJACK_PRIVATE_WRAP: // CK_SKIPJACK_PRIVATE_WRAP_PARAMS</span>
<span class="line-modified">!         case CKM_SKIPJACK_RELAYX: // CK_SKIPJACK_RELAYX_PARAMS</span>
<span class="line-modified">!         case CKM_KEY_WRAP_SET_OAEP: // CK_KEY_WRAP_SET_OAEP_PARAMS</span>
<span class="line-modified">!             throwPKCS11RuntimeException(env, &quot;No parameter support for this mchanism&quot;);</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         default:</span>
<span class="line-modified">!             /* if everything faild up to here */</span>
<span class="line-modified">!             /* try if the parameter is a primitive Java type */</span>
<span class="line-modified">!             ckpParamPtr = jObjectToPrimitiveCKObjectPtr(env, jParam, ckpLength);</span>
<span class="line-modified">!             /* *ckpParamPtr = jObjectToCKVoidPtr(jParam); */</span>
<span class="line-modified">!             /* *ckpLength = 1; */</span>
      }
<span class="line-added">+     TRACE0(&quot;\nDEBUG: jMechParamToCKMechParamPtrSlow FINISHED\n&quot;);</span>
  
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-modified">!         return NULL;</span>
      }
  
<span class="line-modified">!     return ckpParamPtr;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_RSA_PKCS_OAEP_PARAMS object to a</span>
<span class="line-added">+  * CK_RSA_PKCS_OAEP_PARAMS pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_RSA_PKCS_OAEP_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_RSA_PKCS_OAEP_PARAMS structure</span>
   */
<span class="line-modified">! CK_RSA_PKCS_OAEP_PARAMS_PTR</span>
<span class="line-added">+ jRsaPkcsOaepParamToCKRsaPkcsOaepParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_RSA_PKCS_OAEP_PARAMS_PTR ckParamPtr;</span>
      jclass jRsaPkcsOaepParamsClass;
      jfieldID fieldID;
      jlong jHashAlg, jMgf, jSource;
      jobject jSourceData;
  
<span class="line-modified">!     if (pLength!= NULL) {</span>
<span class="line-added">+         *pLength = 0L;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jRsaPkcsOaepParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_OAEP_PARAMS);
<span class="line-modified">!     if (jRsaPkcsOaepParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;source&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsOaepParamsClass, &quot;pSourceData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_RSA_PKCS_OAEP_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_RSA_PKCS_OAEP_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!         return NULL;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-added">+     ckParamPtr-&gt;mgf = jLongToCKULong(jMgf);</span>
<span class="line-added">+     ckParamPtr-&gt;source = jLongToCKULong(jSource);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jSourceData, (CK_BYTE_PTR*) &amp;(ckParamPtr-&gt;pSourceData),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulSourceDataLen));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         free(ckParamPtr);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     if (pLength!= NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_RSA_PKCS_OAEP_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_PBE_PARAMS object to a CK_PBE_PARAMS pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_PBE_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_PBE_PARAMS structure</span>
   */
<span class="line-modified">! CK_PBE_PARAMS_PTR</span>
<span class="line-added">+ jPbeParamToCKPbeParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_PBE_PARAMS_PTR ckParamPtr;</span>
      jclass jPbeParamsClass;
      jfieldID fieldID;
      jlong jIteration;
      jobject jInitVector, jPassword, jSalt;
      CK_ULONG ckTemp;
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
<span class="line-modified">!     if (jPbeParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pInitVector&quot;, &quot;[C&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jInitVector = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pPassword&quot;, &quot;[C&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPassword = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;pSalt&quot;, &quot;[C&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jSalt = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jPbeParamsClass, &quot;ulIteration&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_PBE_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_PBE_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;ulIteration = jLongToCKULong(jIteration);</span>
<span class="line-added">+     jCharArrayToCKCharArray(env, jInitVector, &amp;(ckParamPtr-&gt;pInitVector), &amp;ckTemp);</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     jCharArrayToCKCharArray(env, jPassword, &amp;(ckParamPtr-&gt;pPassword), &amp;(ckParamPtr-&gt;ulPasswordLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
<span class="line-modified">!     jCharArrayToCKCharArray(env, jSalt, &amp;(ckParamPtr-&gt;pSalt), &amp;(ckParamPtr-&gt;ulSaltLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_PBE_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr-&gt;pInitVector);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pPassword);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pSalt);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
   * Copy back the initialization vector from the native structure to the
   * Java object. This is only used for CKM_PBE_* mechanisms and their
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1700,11 ***</span>
      fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;mechanism&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, fieldID);
      ckMechanismType = jLongToCKULong(jMechanismType);
      if (ckMechanismType != ckMechanism-&gt;mechanism) {
<span class="line-modified">!         /* we do not have maching types, this should not occur */</span>
          return;
      }
  
      jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
      if (jPbeParamsClass == NULL) { return; }
<span class="line-new-header">--- 1659,11 ---</span>
      fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;mechanism&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, fieldID);
      ckMechanismType = jLongToCKULong(jMechanismType);
      if (ckMechanismType != ckMechanism-&gt;mechanism) {
<span class="line-modified">!         /* we do not have matching types, this should not occur */</span>
          return;
      }
  
      jPbeParamsClass = (*env)-&gt;FindClass(env, CLASS_PBE_PARAMS);
      if (jPbeParamsClass == NULL) { return; }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1735,331 ***</span>
          }
      }
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_PKCS5_PBKD2_PARAMS object to a CK_PKCS5_PBKD2_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_PKCS5_PBKD2_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_PKCS5_PBKD2_PARAMS structure</span>
   */
<span class="line-modified">! CK_PKCS5_PBKD2_PARAMS jPkcs5Pbkd2ParamToCKPkcs5Pbkd2Param(JNIEnv *env, jobject jParam)</span>
  {
      jclass jPkcs5Pbkd2ParamsClass;
<span class="line-removed">-     CK_PKCS5_PBKD2_PARAMS ckParam;</span>
      jfieldID fieldID;
      jlong jSaltSource, jIteration, jPrf;
      jobject jSaltSourceData, jPrfData;
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_PKCS5_PBKD2_PARAMS));</span>
  
<span class="line-modified">!     /* get saltSource */</span>
      jPkcs5Pbkd2ParamsClass = (*env)-&gt;FindClass(env, CLASS_PKCS5_PBKD2_PARAMS);
<span class="line-modified">!     if (jPkcs5Pbkd2ParamsClass == NULL) { return ckParam; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;saltSource&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jSaltSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pSaltSourceData */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pSaltSourceData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jSaltSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get iterations */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;iterations&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get prf */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;prf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPrf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pPrfData and ulPrfDataLength in byte */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pPrfData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPrfData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckParam.saltSource = jLongToCKULong(jSaltSource);</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jSaltSourceData, (CK_BYTE_PTR *) &amp;(ckParam.pSaltSourceData), &amp;(ckParam.ulSaltSourceDataLen));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">!     ckParam.iterations = jLongToCKULong(jIteration);</span>
<span class="line-modified">!     ckParam.prf = jLongToCKULong(jPrf);</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jPrfData, (CK_BYTE_PTR *) &amp;(ckParam.pPrfData), &amp;(ckParam.ulPrfDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pSaltSourceData);</span>
<span class="line-modified">!         return ckParam;</span>
      }
  
<span class="line-removed">-     return ckParam ;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_RSA_PKCS_PSS_PARAMS object to a CK_RSA_PKCS_PSS_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_RSA_PKCS_PSS_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_RSA_PKCS_PSS_PARAMS structure</span>
   */
<span class="line-modified">! CK_RSA_PKCS_PSS_PARAMS jRsaPkcsPssParamToCKRsaPkcsPssParam(JNIEnv *env, jobject jParam)</span>
  {
      jclass jRsaPkcsPssParamsClass;
<span class="line-removed">-     CK_RSA_PKCS_PSS_PARAMS ckParam;</span>
      jfieldID fieldID;
      jlong jHashAlg, jMgf, jSLen;
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_RSA_PKCS_PSS_PARAMS));</span>
  
<span class="line-modified">!     /* get hashAlg */</span>
      jRsaPkcsPssParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_PSS_PARAMS);
<span class="line-modified">!     if (jRsaPkcsPssParamsClass == NULL) { return ckParam; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get mgf */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get sLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;sLen&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jSLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckParam.hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-modified">!     ckParam.mgf = jLongToCKULong(jMgf);</span>
<span class="line-modified">!     ckParam.sLen = jLongToCKULong(jSLen);</span>
  
<span class="line-removed">-     return ckParam ;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_ECDH1_DERIVE_PARAMS object to a CK_ECDH1_DERIVE_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_ECDH1_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_ECDH1_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_ECDH1_DERIVE_PARAMS jEcdh1DeriveParamToCKEcdh1DeriveParam(JNIEnv *env, jobject jParam)</span>
  {
      jclass jEcdh1DeriveParamsClass;
<span class="line-removed">-     CK_ECDH1_DERIVE_PARAMS ckParam;</span>
      jfieldID fieldID;
      jlong jLong;
      jobject jSharedData, jPublicData;
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_ECDH1_DERIVE_PARAMS));</span>
  
<span class="line-modified">!     /* get kdf */</span>
      jEcdh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH1_DERIVE_PARAMS);
<span class="line-modified">!     if (jEcdh1DeriveParamsClass == NULL) { return ckParam; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jLong = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">-     ckParam.kdf = jLongToCKULong(jLong);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pSharedData and ulSharedDataLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pPublicData and ulPublicDataLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckParam.kdf = jLongToCKULong(jLong);</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParam.pSharedData), &amp;(ckParam.ulSharedDataLen));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pSharedData);</span>
<span class="line-removed">-         return ckParam;</span>
      }
  
<span class="line-modified">!     return ckParam ;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_ECDH2_DERIVE_PARAMS object to a CK_ECDH2_DERIVE_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_ECDH2_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_ECDH2_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_ECDH2_DERIVE_PARAMS jEcdh2DeriveParamToCKEcdh2DeriveParam(JNIEnv *env, jobject jParam)</span>
  {
      jclass jEcdh2DeriveParamsClass;
<span class="line-removed">-     CK_ECDH2_DERIVE_PARAMS ckParam;</span>
      jfieldID fieldID;
      jlong jKdf, jPrivateDataLen, jPrivateData;
      jobject jSharedData, jPublicData, jPublicData2;
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_ECDH2_DERIVE_PARAMS));</span>
  
<span class="line-modified">!     /* get kdf */</span>
      jEcdh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH2_DERIVE_PARAMS);
<span class="line-modified">!     if (jEcdh2DeriveParamsClass == NULL) { return ckParam; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pSharedData and ulSharedDataLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pPublicData and ulPublicDataLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get ulPrivateDataLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get hPrivateData */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pPublicData2 and ulPublicDataLen2 */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckParam.kdf = jLongToCKULong(jKdf);</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParam.pSharedData), &amp;(ckParam.ulSharedDataLen));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pSharedData);</span>
<span class="line-removed">-         return ckParam;</span>
      }
<span class="line-modified">!     ckParam.ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-modified">!     ckParam.hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-removed">-     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParam.pPublicData2), &amp;(ckParam.ulPublicDataLen2));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pSharedData);</span>
<span class="line-removed">-         free(ckParam.pPublicData);</span>
<span class="line-removed">-         return ckParam;</span>
      }
<span class="line-modified">!     return ckParam ;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_X9_42_DH1_DERIVE_PARAMS object to a CK_X9_42_DH1_DERIVE_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_X9_42_DH1_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_X9_42_DH1_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_X9_42_DH1_DERIVE_PARAMS jX942Dh1DeriveParamToCKX942Dh1DeriveParam(JNIEnv *env, jobject jParam)</span>
  {
      jclass jX942Dh1DeriveParamsClass;
<span class="line-removed">-     CK_X9_42_DH1_DERIVE_PARAMS ckParam;</span>
      jfieldID fieldID;
      jlong jKdf;
      jobject jOtherInfo, jPublicData;
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_X9_42_DH1_DERIVE_PARAMS));</span>
  
<span class="line-modified">!     /* get kdf */</span>
      jX942Dh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH1_DERIVE_PARAMS);
<span class="line-modified">!     if (jX942Dh1DeriveParamsClass == NULL) { return ckParam; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pOtherInfo and ulOtherInfoLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pPublicData and ulPublicDataLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckParam.kdf = jLongToCKULong(jKdf);</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParam.pOtherInfo), &amp;(ckParam.ulOtherInfoLen));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pOtherInfo);</span>
<span class="line-modified">!         return ckParam;</span>
      }
  
<span class="line-modified">!     return ckParam ;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_X9_42_DH2_DERIVE_PARAMS object to a CK_X9_42_DH2_DERIVE_PARAMS structure</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_X9_42_DH2_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @return - the new CK_X9_42_DH2_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_X9_42_DH2_DERIVE_PARAMS jX942Dh2DeriveParamToCKX942Dh2DeriveParam(JNIEnv *env, jobject jParam)</span>
  {
      jclass jX942Dh2DeriveParamsClass;
<span class="line-removed">-     CK_X9_42_DH2_DERIVE_PARAMS ckParam;</span>
      jfieldID fieldID;
      jlong jKdf, jPrivateDataLen, jPrivateData;
      jobject jOtherInfo, jPublicData, jPublicData2;
<span class="line-removed">-     memset(&amp;ckParam, 0, sizeof(CK_X9_42_DH2_DERIVE_PARAMS));</span>
  
<span class="line-modified">!     /* get kdf */</span>
      jX942Dh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH2_DERIVE_PARAMS);
<span class="line-modified">!     if (jX942Dh2DeriveParamsClass == NULL) { return ckParam; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pOtherInfo and ulOtherInfoLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pPublicData and ulPublicDataLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get ulPrivateDataLen */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get hPrivateData */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
<span class="line-removed">- </span>
<span class="line-removed">-     /* get pPublicData2 and ulPublicDataLen2 */</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return ckParam; }</span>
      jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     /* populate java values */</span>
<span class="line-modified">!     ckParam.kdf = jLongToCKULong(jKdf);</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParam.pOtherInfo), &amp;(ckParam.ulOtherInfoLen));</span>
<span class="line-modified">!     if ((*env)-&gt;ExceptionCheck(env)) { return ckParam; }</span>
<span class="line-modified">!     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParam.pPublicData), &amp;(ckParam.ulPublicDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pOtherInfo);</span>
<span class="line-removed">-         return ckParam;</span>
      }
<span class="line-modified">!     ckParam.ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-modified">!     ckParam.hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-removed">-     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParam.pPublicData2), &amp;(ckParam.ulPublicDataLen2));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         free(ckParam.pOtherInfo);</span>
<span class="line-modified">!         free(ckParam.pPublicData);</span>
<span class="line-modified">!         return ckParam;</span>
      }
  
<span class="line-modified">!     return ckParam ;</span>
  }
<span class="line-new-header">--- 1694,428 ---</span>
          }
      }
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_PKCS5_PBKD2_PARAMS object to a CK_PKCS5_PBKD2_PARAMS</span>
<span class="line-added">+  * pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_PKCS5_PBKD2_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_PKCS5_PBKD2_PARAMS structure</span>
   */
<span class="line-modified">! CK_PKCS5_PBKD2_PARAMS_PTR</span>
<span class="line-added">+ jPkcs5Pbkd2ParamToCKPkcs5Pbkd2ParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_PKCS5_PBKD2_PARAMS_PTR ckParamPtr;</span>
      jclass jPkcs5Pbkd2ParamsClass;
      jfieldID fieldID;
      jlong jSaltSource, jIteration, jPrf;
      jobject jSaltSourceData, jPrfData;
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0L;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jPkcs5Pbkd2ParamsClass = (*env)-&gt;FindClass(env, CLASS_PKCS5_PBKD2_PARAMS);
<span class="line-modified">!     if (jPkcs5Pbkd2ParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;saltSource&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jSaltSource = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pSaltSourceData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jSaltSourceData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;iterations&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jIteration = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;prf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPrf = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jPkcs5Pbkd2ParamsClass, &quot;pPrfData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPrfData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_PKCS5_PBKD2_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_PKCS5_PBKD2_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!         return NULL;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;saltSource = jLongToCKULong(jSaltSource);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jSaltSourceData, (CK_BYTE_PTR *)</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;pSaltSourceData), &amp;(ckParamPtr-&gt;ulSaltSourceDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
<span class="line-modified">!     }</span>
<span class="line-added">+     ckParamPtr-&gt;iterations = jLongToCKULong(jIteration);</span>
<span class="line-added">+     ckParamPtr-&gt;prf = jLongToCKULong(jPrf);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jPrfData, (CK_BYTE_PTR *)</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;pPrfData), &amp;(ckParamPtr-&gt;ulPrfDataLen));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_PKCS5_PBKD2_PARAMS);</span>
      }
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr-&gt;pSaltSourceData);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pPrfData);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_RSA_PKCS_PSS_PARAMS object to a CK_RSA_PKCS_PSS_PARAMS</span>
<span class="line-added">+  * pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_RSA_PKCS_PSS_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_RSA_PKCS_PSS_PARAMS structure</span>
   */
<span class="line-modified">! CK_RSA_PKCS_PSS_PARAMS_PTR</span>
<span class="line-added">+ jRsaPkcsPssParamToCKRsaPkcsPssParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_RSA_PKCS_PSS_PARAMS_PTR ckParamPtr;</span>
      jclass jRsaPkcsPssParamsClass;
      jfieldID fieldID;
      jlong jHashAlg, jMgf, jSLen;
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jRsaPkcsPssParamsClass = (*env)-&gt;FindClass(env, CLASS_RSA_PKCS_PSS_PARAMS);
<span class="line-modified">!     if (jRsaPkcsPssParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;hashAlg&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jHashAlg = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;mgf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jMgf = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jRsaPkcsPssParamsClass, &quot;sLen&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jSLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_RSA_PKCS_PSS_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_RSA_PKCS_PSS_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;hashAlg = jLongToCKULong(jHashAlg);</span>
<span class="line-added">+     ckParamPtr-&gt;mgf = jLongToCKULong(jMgf);</span>
<span class="line-added">+     ckParamPtr-&gt;sLen = jLongToCKULong(jSLen);</span>
<span class="line-added">+     TRACE1(&quot;DEBUG: jRsaPkcsPssParamToCKRsaPkcsPssParam, hashAlg=0x%lX\n&quot;, ckParamPtr-&gt;hashAlg);</span>
<span class="line-added">+     TRACE1(&quot;DEBUG: jRsaPkcsPssParamToCKRsaPkcsPssParam, mgf=0x%lX\n&quot;, ckParamPtr-&gt;mgf);</span>
<span class="line-added">+     TRACE1(&quot;DEBUG: jRsaPkcsPssParamToCKRsaPkcsPssParam, sLen=%lu\n&quot;, ckParamPtr-&gt;sLen);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_RSA_PKCS_PSS_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
  
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_ECDH1_DERIVE_PARAMS object to a CK_ECDH1_DERIVE_PARAMS</span>
<span class="line-added">+  * pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_ECDH1_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @retur pointer to nthe new CK_ECDH1_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_ECDH1_DERIVE_PARAMS_PTR</span>
<span class="line-added">+ jEcdh1DeriveParamToCKEcdh1DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_ECDH1_DERIVE_PARAMS_PTR ckParamPtr;</span>
      jclass jEcdh1DeriveParamsClass;
      jfieldID fieldID;
      jlong jLong;
      jobject jSharedData, jPublicData;
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jEcdh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH1_DERIVE_PARAMS);
<span class="line-modified">!     if (jEcdh1DeriveParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jLong = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_ECDH1_DERIVE_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_ECDH1_DERIVE_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;kdf = jLongToCKULong(jLong);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParamPtr-&gt;pSharedData),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulSharedDataLen));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_ECDH1_DERIVE_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr-&gt;pSharedData);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_ECDH2_DERIVE_PARAMS object to a CK_ECDH2_DERIVE_PARAMS</span>
<span class="line-added">+  * pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_ECDH2_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_ECDH2_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_ECDH2_DERIVE_PARAMS_PTR</span>
<span class="line-added">+ jEcdh2DeriveParamToCKEcdh2DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_ECDH2_DERIVE_PARAMS_PTR ckParamPtr;</span>
      jclass jEcdh2DeriveParamsClass;
      jfieldID fieldID;
      jlong jKdf, jPrivateDataLen, jPrivateData;
      jobject jSharedData, jPublicData, jPublicData2;
  
<span class="line-modified">!     // retrieve java values</span>
      jEcdh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_ECDH2_DERIVE_PARAMS);
<span class="line-modified">!     if (jEcdh2DeriveParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pSharedData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jSharedData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jEcdh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_ECDH2_DERIVE_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_ECDH2_DERIVE_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;kdf = jLongToCKULong(jKdf);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jSharedData, &amp;(ckParamPtr-&gt;pSharedData),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulSharedDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
<span class="line-modified">!     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-modified">!             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
<span class="line-modified">!     ckParamPtr-&gt;ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-added">+     ckParamPtr-&gt;hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParamPtr-&gt;pPublicData2),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulPublicDataLen2));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_ECDH2_DERIVE_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr-&gt;pSharedData);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pPublicData2);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_X9_42_DH1_DERIVE_PARAMS object to a</span>
<span class="line-added">+  * CK_X9_42_DH1_DERIVE_PARAMS pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_X9_42_DH1_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_X9_42_DH1_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_X9_42_DH1_DERIVE_PARAMS_PTR</span>
<span class="line-added">+ jX942Dh1DeriveParamToCKX942Dh1DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_X9_42_DH1_DERIVE_PARAMS_PTR ckParamPtr;</span>
      jclass jX942Dh1DeriveParamsClass;
      jfieldID fieldID;
      jlong jKdf;
      jobject jOtherInfo, jPublicData;
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jX942Dh1DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH1_DERIVE_PARAMS);
<span class="line-modified">!     if (jX942Dh1DeriveParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh1DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_X9_42_DH1_DERIVE_PARAMS pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_X9_42_DH1_DERIVE_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;kdf = jLongToCKULong(jKdf);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParamPtr-&gt;pOtherInfo),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulOtherInfoLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
<span class="line-modified">!     }</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
      }
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_X9_42_DH1_DERIVE_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr-&gt;pOtherInfo);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
  
  /*
<span class="line-modified">!  * converts the Java CK_X9_42_DH2_DERIVE_PARAMS object to a</span>
<span class="line-added">+  * CK_X9_42_DH2_DERIVE_PARAMS pointer</span>
   *
   * @param env - used to call JNI funktions to get the Java classes and objects
   * @param jParam - the Java CK_X9_42_DH2_DERIVE_PARAMS object to convert
<span class="line-modified">!  * @param pLength - length of the allocated memory of the returned pointer</span>
<span class="line-added">+  * @return pointer to the new CK_X9_42_DH2_DERIVE_PARAMS structure</span>
   */
<span class="line-modified">! CK_X9_42_DH2_DERIVE_PARAMS_PTR</span>
<span class="line-added">+ jX942Dh2DeriveParamToCKX942Dh2DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG *pLength)</span>
  {
<span class="line-added">+     CK_X9_42_DH2_DERIVE_PARAMS_PTR ckParamPtr;</span>
      jclass jX942Dh2DeriveParamsClass;
      jfieldID fieldID;
      jlong jKdf, jPrivateDataLen, jPrivateData;
      jobject jOtherInfo, jPublicData, jPublicData2;
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = 0L;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // retrieve java values</span>
      jX942Dh2DeriveParamsClass = (*env)-&gt;FindClass(env, CLASS_X9_42_DH2_DERIVE_PARAMS);
<span class="line-modified">!     if (jX942Dh2DeriveParamsClass == NULL) { return NULL; }</span>
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;kdf&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jKdf = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pOtherInfo&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jOtherInfo = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPublicData = (*env)-&gt;GetObjectField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;ulPrivateDataLen&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPrivateDataLen = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;hPrivateData&quot;, &quot;J&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPrivateData = (*env)-&gt;GetLongField(env, jParam, fieldID);
      fieldID = (*env)-&gt;GetFieldID(env, jX942Dh2DeriveParamsClass, &quot;pPublicData2&quot;, &quot;[B&quot;);
<span class="line-modified">!     if (fieldID == NULL) { return NULL; }</span>
      jPublicData2 = (*env)-&gt;GetObjectField(env, jParam, fieldID);
  
<span class="line-modified">!     // allocate memory for CK_DATE pointer</span>
<span class="line-modified">!     ckParamPtr = calloc(1, sizeof(CK_X9_42_DH2_DERIVE_PARAMS));</span>
<span class="line-modified">!     if (ckParamPtr == NULL) {</span>
<span class="line-modified">!         throwOutOfMemoryError(env, 0);</span>
<span class="line-modified">!         return NULL;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     // populate using java values</span>
<span class="line-added">+     ckParamPtr-&gt;kdf = jLongToCKULong(jKdf);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jOtherInfo, &amp;(ckParamPtr-&gt;pOtherInfo),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulOtherInfoLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
      }
<span class="line-modified">!     jByteArrayToCKByteArray(env, jPublicData, &amp;(ckParamPtr-&gt;pPublicData),</span>
<span class="line-modified">!             &amp;(ckParamPtr-&gt;ulPublicDataLen));</span>
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="line-modified">!         goto cleanup;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     ckParamPtr-&gt;ulPrivateDataLen = jLongToCKULong(jPrivateDataLen);</span>
<span class="line-added">+     ckParamPtr-&gt;hPrivateData = jLongToCKULong(jPrivateData);</span>
<span class="line-added">+     jByteArrayToCKByteArray(env, jPublicData2, &amp;(ckParamPtr-&gt;pPublicData2),</span>
<span class="line-added">+             &amp;(ckParamPtr-&gt;ulPublicDataLen2));</span>
<span class="line-added">+     if ((*env)-&gt;ExceptionCheck(env)) {</span>
<span class="line-added">+         goto cleanup;</span>
      }
  
<span class="line-modified">!     if (pLength != NULL) {</span>
<span class="line-added">+         *pLength = sizeof(CK_X9_42_DH2_DERIVE_PARAMS);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return ckParamPtr;</span>
<span class="line-added">+ cleanup:</span>
<span class="line-added">+     free(ckParamPtr-&gt;pOtherInfo);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pPublicData);</span>
<span class="line-added">+     free(ckParamPtr-&gt;pPublicData2);</span>
<span class="line-added">+     free(ckParamPtr);</span>
<span class="line-added">+     return NULL;</span>
  }
</pre>
<center><a href="../../legal/pkcs11cryptotoken.md.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_crypt.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>