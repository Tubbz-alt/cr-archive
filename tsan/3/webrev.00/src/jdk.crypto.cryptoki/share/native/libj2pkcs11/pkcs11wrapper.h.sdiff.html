<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.crypto.cryptoki/share/native/libj2pkcs11/pkcs11wrapper.h</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="pkcs11t.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../unix/native/libj2pkcs11/p11_md.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/native/libj2pkcs11/pkcs11wrapper.h</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
 52  * declaration of all functions used by pkcs11wrapper.c
 53  *
 54  * @author Karl Scheibelhofer &lt;Karl.Scheibelhofer@iaik.at&gt;
 55  * @author Martin Schlaeffer &lt;schlaeff@sbox.tugraz.at&gt;
 56  */
 57 
 58 #ifndef _PKCS11WRAPPER_H
 59 #define _PKCS11WRAPPER_H 1
 60 
 61 /* disable asserts in product mode */
 62 #ifndef DEBUG
 63   #ifndef NDEBUG
 64     #define NDEBUG
 65   #endif
 66 #endif
 67 
 68 /* extra PKCS#11 constants not in the standard include files */
 69 
 70 #define CKA_NETSCAPE_BASE                       (0x80000000 + 0x4E534350)
 71 #define CKA_NETSCAPE_TRUST_BASE                 (CKA_NETSCAPE_BASE + 0x2000)
<span class="line-removed"> 72 </span>
 73 #define CKA_NETSCAPE_TRUST_SERVER_AUTH          (CKA_NETSCAPE_TRUST_BASE + 8)
 74 #define CKA_NETSCAPE_TRUST_CLIENT_AUTH          (CKA_NETSCAPE_TRUST_BASE + 9)
 75 #define CKA_NETSCAPE_TRUST_CODE_SIGNING (CKA_NETSCAPE_TRUST_BASE + 10)
 76 #define CKA_NETSCAPE_TRUST_EMAIL_PROTECTION     (CKA_NETSCAPE_TRUST_BASE + 11)


 77 
 78 /*
 79 
 80  Define the PKCS#11 functions to include and exclude. Reduces the size
 81  of the binary somewhat.
 82 
 83  This list needs to be kept in sync with the mapfile and PKCS11.java
 84 
 85 */
 86 
 87 #define P11_ENABLE_C_INITIALIZE
 88 #define P11_ENABLE_C_FINALIZE
 89 #define P11_ENABLE_C_GETINFO
 90 #define P11_ENABLE_C_GETSLOTLIST
 91 #define P11_ENABLE_C_GETSLOTINFO
 92 #define P11_ENABLE_C_GETTOKENINFO
 93 #define P11_ENABLE_C_GETMECHANISMLIST
 94 #define P11_ENABLE_C_GETMECHANISMINFO
 95 #undef  P11_ENABLE_C_INITTOKEN
 96 #undef  P11_ENABLE_C_INITPIN
</pre>
<hr />
<pre>
137 #define P11_ENABLE_C_VERIFYFINAL
138 #define P11_ENABLE_C_VERIFYRECOVERINIT
139 #define P11_ENABLE_C_VERIFYRECOVER
140 #undef  P11_ENABLE_C_DIGESTENCRYPTUPDATE
141 #undef  P11_ENABLE_C_DECRYPTDIGESTUPDATE
142 #undef  P11_ENABLE_C_SIGNENCRYPTUPDATE
143 #undef  P11_ENABLE_C_DECRYPTVERIFYUPDATE
144 #define P11_ENABLE_C_GENERATEKEY
145 #define P11_ENABLE_C_GENERATEKEYPAIR
146 #define P11_ENABLE_C_WRAPKEY
147 #define P11_ENABLE_C_UNWRAPKEY
148 #define P11_ENABLE_C_DERIVEKEY
149 #define P11_ENABLE_C_SEEDRANDOM
150 #define P11_ENABLE_C_GENERATERANDOM
151 #undef  P11_ENABLE_C_GETFUNCTIONSTATUS
152 #undef  P11_ENABLE_C_CANCELFUNCTION
153 #undef  P11_ENABLE_C_WAITFORSLOTEVENT
154 #define P11_ENABLE_GETNATIVEKEYINFO
155 #define P11_ENABLE_CREATENATIVEKEY
156 

157 /* include the platform dependent part of the header */
158 #include &quot;p11_md.h&quot;
159 
<span class="line-removed">160 #include &quot;pkcs11.h&quot;</span>
<span class="line-removed">161 #include &quot;pkcs-11v2-20a3.h&quot;</span>
162 #include &lt;jni.h&gt;
163 #include &lt;jni_util.h&gt;
164 #include &lt;stdarg.h&gt;
165 
166 #define MAX_STACK_BUFFER_LEN (4 * 1024)
167 #define MAX_HEAP_BUFFER_LEN (64 * 1024)
168 
169 #define MAX_DIGEST_LEN (64)
170 
171 #ifndef min
172 #define min(a, b)       (((a) &lt; (b)) ? (a) : (b))
173 #endif
174 
175 #define ckBBoolToJBoolean(x) ((x == TRUE) ? JNI_TRUE : JNI_FALSE);
176 #define jBooleanToCKBBool(x) ((x == JNI_TRUE) ? TRUE : FALSE);
177 
178 #define ckByteToJByte(x) ((jbyte) x)
179 #define jByteToCKByte(x) ((CK_BYTE) x)
180 
181 #define ckLongToJLong(x) ((jlong) x)
</pre>
<hr />
<pre>
189     ? (jlong)-1 : ((jlong) x))
190 
191 #define ckCharToJChar(x) ((jchar) x)
192 #define jCharToCKChar(x) ((CK_CHAR) x)
193 
194 #define ckUTF8CharToJChar(x) ((jchar) x)
195 #define jCharToCKUTF8Char(x) ((CK_UTF8CHAR) x)
196 
197 #define ckFlageToJLong(x) ((jlong) x)
198 
199 #define ckVoidPtrToJObject(x) ((jobject) x)
200 #define jObjectToCKVoidPtr(x) ((CK_VOID_PTR) x)
201 
202 #define jIntToCKLong(x)         ((CK_LONG) x)
203 #define jIntToCKULong(x)        ((CK_ULONG) x)
204 #define ckLongToJInt(x)         ((jint) x)
205 #define ckULongToJInt(x)        ((jint) x)
206 #define ckULongToJSize(x)       ((jsize) x)
207 #define unsignedIntToCKULong(x) ((CK_ULONG) x)
208 
<span class="line-modified">209 //#define P11_DEBUG</span>


210 
211 #ifdef P11_DEBUG
212 #define TRACE0(s) { printf(s); fflush(stdout); }
213 #define TRACE1(s, p1) { printf(s, p1); fflush(stdout); }
214 #define TRACE2(s, p1, p2) { printf(s, p1, p2); fflush(stdout); }
215 #define TRACE3(s, p1, p2, p3) { printf(s, p1, p2, p3); fflush(stdout); }
216 #else
217 #define TRACE0(s)
218 #define TRACE1(s, p1)
219 #define TRACE2(s, p1, p2)
220 #define TRACE3(s, p1, p2, p3)
221 #define TRACE_INTEND
222 #define TRACE_UNINTEND
223 #endif
224 
225 /* debug output */
226 extern jboolean debug;
227 void printDebug(const char *format, ...);
228 
229 #define CK_ASSERT_OK 0L
230 


231 #define CLASS_INFO &quot;sun/security/pkcs11/wrapper/CK_INFO&quot;
232 #define CLASS_VERSION &quot;sun/security/pkcs11/wrapper/CK_VERSION&quot;
233 #define CLASS_SLOT_INFO &quot;sun/security/pkcs11/wrapper/CK_SLOT_INFO&quot;
234 #define CLASS_TOKEN_INFO &quot;sun/security/pkcs11/wrapper/CK_TOKEN_INFO&quot;
235 #define CLASS_MECHANISM &quot;sun/security/pkcs11/wrapper/CK_MECHANISM&quot;
236 #define CLASS_MECHANISM_INFO &quot;sun/security/pkcs11/wrapper/CK_MECHANISM_INFO&quot;
237 #define CLASS_SESSION_INFO &quot;sun/security/pkcs11/wrapper/CK_SESSION_INFO&quot;
238 #define CLASS_ATTRIBUTE &quot;sun/security/pkcs11/wrapper/CK_ATTRIBUTE&quot;
239 #define CLASS_DATE &quot;sun/security/pkcs11/wrapper/CK_DATE&quot;
240 #define CLASS_PKCS11EXCEPTION &quot;sun/security/pkcs11/wrapper/PKCS11Exception&quot;
241 #define CLASS_PKCS11RUNTIMEEXCEPTION &quot;sun/security/pkcs11/wrapper/PKCS11RuntimeException&quot;
242 #define CLASS_FILE_NOT_FOUND_EXCEPTION &quot;java/io/FileNotFoundException&quot;
243 #define CLASS_C_INITIALIZE_ARGS &quot;sun/security/pkcs11/wrapper/CK_C_INITIALIZE_ARGS&quot;
244 #define CLASS_CREATEMUTEX &quot;sun/security/pkcs11/wrapper/CK_CREATEMUTEX&quot;
245 #define CLASS_DESTROYMUTEX &quot;sun/security/pkcs11/wrapper/CK_DESTROYMUTEX&quot;
246 #define CLASS_LOCKMUTEX &quot;sun/security/pkcs11/wrapper/CK_LOCKMUTEX&quot;
247 #define CLASS_UNLOCKMUTEX &quot;sun/security/pkcs11/wrapper/CK_UNLOCKMUTEX&quot;
248 #define CLASS_NOTIFY &quot;sun/security/pkcs11/wrapper/CK_NOTIFY&quot;
249 
250 
251 /* mechanism parameter classes */
<span class="line-modified">252 </span>



253 #define CLASS_RSA_PKCS_OAEP_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RSA_PKCS_OAEP_PARAMS&quot;

254 #define CLASS_MAC_GENERAL_PARAMS &quot;sun/security/pkcs11/wrapper/CK_MAC_GENERAL_PARAMS&quot;
255 #define CLASS_PBE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_PBE_PARAMS&quot;
256 #define PBE_INIT_VECTOR_SIZE 8
257 #define CLASS_PKCS5_PBKD2_PARAMS &quot;sun/security/pkcs11/wrapper/CK_PKCS5_PBKD2_PARAMS&quot;
258 #define CLASS_EXTRACT_PARAMS &quot;sun/security/pkcs11/wrapper/CK_EXTRACT_PARAMS&quot;
259 
<span class="line-removed">260 #define CLASS_RSA_PKCS_PSS_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RSA_PKCS_PSS_PARAMS&quot;</span>
261 #define CLASS_ECDH1_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_ECDH1_DERIVE_PARAMS&quot;
262 #define CLASS_ECDH2_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_ECDH2_DERIVE_PARAMS&quot;
263 #define CLASS_X9_42_DH1_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_X9_42_DH1_DERIVE_PARAMS&quot;
264 #define CLASS_X9_42_DH2_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_X9_42_DH2_DERIVE_PARAMS&quot;
265 
266 /*
267 #define CLASS_KEA_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_KEA_DERIVE_PARAMS&quot;
268 #define CLASS_RC2_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC2_PARAMS&quot;
269 #define CLASS_RC2_CBC_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC2_CBC_PARAMS&quot;
270 #define CLASS_RC2_MAC_GENERAL_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC2_MAC_GENERAL_PARAMS&quot;
271 #define CLASS_RC5_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC5_PARAMS&quot;
272 #define CLASS_RC5_CBC_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC5_CBC_PARAMS&quot;
273 #define CLASS_RC5_MAC_GENERAL_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC5_MAC_GENERAL_PARAMS&quot;
274 #define CLASS_SKIPJACK_PRIVATE_WRAP_PARAMS &quot;sun/security/pkcs11/wrapper/CK_SKIPJACK_PRIVATE_WRAP_PARAMS&quot;
275 #define CLASS_SKIPJACK_RELAYX_PARAMS &quot;sun/security/pkcs11/wrapper/CK_SKIPJACK_RELAYX_PARAMS&quot;
276 #define CLASS_KEY_WRAP_SET_OAEP_PARAMS &quot;sun/security/pkcs11/wrapper/CK_KEY_WRAP_SET_OAEP_PARAMS&quot;
277 #define CLASS_KEY_DERIVATION_STRING_DATA &quot;sun/security/pkcs11/wrapper/CK_KEY_DERIVATION_STRING_DATA&quot;
278 */
279 
280 #define CLASS_SSL3_RANDOM_DATA &quot;sun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA&quot;
281 // CLASS_SSL3_RANDOM_DATA is used by CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS
282 #define CLASS_SSL3_KEY_MAT_OUT &quot;sun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_OUT&quot;
283 // CLASS_SSL3_KEY_MAT_OUT is used by CLASS_SSL3_KEY_MAT_PARAMS and CK_TLS12_KEY_MAT_PARAMS
284 #define CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_SSL3_MASTER_KEY_DERIVE_PARAMS&quot;
285 #define CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_TLS12_MASTER_KEY_DERIVE_PARAMS&quot;
286 #define CLASS_SSL3_KEY_MAT_PARAMS &quot;sun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_PARAMS&quot;
287 #define CLASS_TLS12_KEY_MAT_PARAMS &quot;sun/security/pkcs11/wrapper/CK_TLS12_KEY_MAT_PARAMS&quot;
288 #define CLASS_TLS_PRF_PARAMS &quot;sun/security/pkcs11/wrapper/CK_TLS_PRF_PARAMS&quot;
289 #define CLASS_TLS_MAC_PARAMS &quot;sun/security/pkcs11/wrapper/CK_TLS_MAC_PARAMS&quot;
<span class="line-modified">290 #define CLASS_AES_CTR_PARAMS &quot;sun/security/pkcs11/wrapper/CK_AES_CTR_PARAMS&quot;</span>




291 
292 /* function to convert a PKCS#11 return value other than CK_OK into a Java Exception
293  * or to throw a PKCS11RuntimeException
294  */
295 
296 jlong ckAssertReturnValueOK(JNIEnv *env, CK_RV returnValue);
297 void throwOutOfMemoryError(JNIEnv *env, const char *message);
298 void throwNullPointerException(JNIEnv *env, const char *message);
299 void throwIOException(JNIEnv *env, const char *message);
300 void throwPKCS11RuntimeException(JNIEnv *env, const char *message);
301 void throwDisconnectedRuntimeException(JNIEnv *env);
302 
<span class="line-modified">303 /* function to free CK_ATTRIBUTE array</span>
304  */
305 void freeCKAttributeArray(CK_ATTRIBUTE_PTR attrPtr, int len);

306 
<span class="line-modified">307 /* funktions to convert Java arrays to a CK-type array and the array length */</span>
308 
309 void jBooleanArrayToCKBBoolArray(JNIEnv *env, const jbooleanArray jArray, CK_BBOOL **ckpArray, CK_ULONG_PTR ckLength);
310 void jByteArrayToCKByteArray(JNIEnv *env, const jbyteArray jArray, CK_BYTE_PTR *ckpArray, CK_ULONG_PTR ckLength);
311 void jLongArrayToCKULongArray(JNIEnv *env, const jlongArray jArray, CK_ULONG_PTR *ckpArray, CK_ULONG_PTR ckLength);
312 void jCharArrayToCKCharArray(JNIEnv *env, const jcharArray jArray, CK_CHAR_PTR *ckpArray, CK_ULONG_PTR ckLength);
313 void jCharArrayToCKUTF8CharArray(JNIEnv *env, const jcharArray jArray, CK_UTF8CHAR_PTR *ckpArray, CK_ULONG_PTR ckLength);
314 void jStringToCKUTF8CharArray(JNIEnv *env, const jstring jArray, CK_UTF8CHAR_PTR *ckpArray, CK_ULONG_PTR ckpLength);
315 void jAttributeArrayToCKAttributeArray(JNIEnv *env, jobjectArray jAArray, CK_ATTRIBUTE_PTR *ckpArray, CK_ULONG_PTR ckpLength);
316 /*void jObjectArrayToCKVoidPtrArray(JNIEnv *env, const jobjectArray jArray, CK_VOID_PTR_PTR ckpArray, CK_ULONG_PTR ckpLength); */
317 
318 
<span class="line-modified">319 /* funktions to convert a CK-type array and the array length to a Java array */</span>
320 
321 jbyteArray ckByteArrayToJByteArray(JNIEnv *env, const CK_BYTE_PTR ckpArray, CK_ULONG ckLength);
322 jlongArray ckULongArrayToJLongArray(JNIEnv *env, const CK_ULONG_PTR ckpArray, CK_ULONG ckLength);
323 jcharArray ckCharArrayToJCharArray(JNIEnv *env, const CK_CHAR_PTR ckpArray, CK_ULONG length);
324 jcharArray ckUTF8CharArrayToJCharArray(JNIEnv *env, const CK_UTF8CHAR_PTR ckpArray, CK_ULONG ckLength);
325 
326 
<span class="line-modified">327 /* funktions to convert a CK-type structure or a pointer to a CK-value to a Java object */</span>
328 
329 jobject ckBBoolPtrToJBooleanObject(JNIEnv *env, const CK_BBOOL* ckpValue);
330 jobject ckULongPtrToJLongObject(JNIEnv *env, const CK_ULONG_PTR ckpValue);
331 jobject ckDatePtrToJDateObject(JNIEnv *env, const CK_DATE *ckpValue);
332 jobject ckVersionPtrToJVersion(JNIEnv *env, const CK_VERSION_PTR ckpVersion);
333 jobject ckSessionInfoPtrToJSessionInfo(JNIEnv *env, const CK_SESSION_INFO_PTR ckpSessionInfo);
334 jobject ckAttributePtrToJAttribute(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute);
335 
336 
<span class="line-modified">337 /* funktion to convert the CK-value used by the CK_ATTRIBUTE structure to a Java object */</span>
338 
339 jobject ckAttributeValueToJObject(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute);
340 
341 
<span class="line-modified">342 /* funktions to convert a Java object to a CK-type structure or a pointer to a CK-value */</span>
343 
344 CK_BBOOL* jBooleanObjectToCKBBoolPtr(JNIEnv *env, jobject jObject);
345 CK_BYTE_PTR jByteObjectToCKBytePtr(JNIEnv *env, jobject jObject);
346 CK_ULONG* jIntegerObjectToCKULongPtr(JNIEnv *env, jobject jObject);
347 CK_ULONG* jLongObjectToCKULongPtr(JNIEnv *env, jobject jObject);
348 CK_CHAR_PTR jCharObjectToCKCharPtr(JNIEnv *env, jobject jObject);
349 CK_VERSION_PTR jVersionToCKVersionPtr(JNIEnv *env, jobject jVersion);
<span class="line-modified">350 CK_DATE * jDateObjectPtrToCKDatePtr(JNIEnv *env, jobject jDate);</span>
351 CK_ATTRIBUTE jAttributeToCKAttribute(JNIEnv *env, jobject jAttribute);
<span class="line-modified">352 /*CK_MECHANISM jMechanismToCKMechanism(JNIEnv *env, jobject jMechanism);*/</span>
<span class="line-removed">353 void jMechanismToCKMechanism(JNIEnv *env, jobject jMechanism, CK_MECHANISM_PTR ckMechanismPtr);</span>
354 
355 
<span class="line-modified">356 /* funktions to convert Java objects used by the Mechanism and Attribute class to a CK-type structure */</span>



357 
<span class="line-removed">358 void jObjectToPrimitiveCKObjectPtrPtr(JNIEnv *env, jobject jObject, CK_VOID_PTR *ckpObjectPtr, CK_ULONG *pLength);</span>
<span class="line-removed">359 void jMechanismParameterToCKMechanismParameter(JNIEnv *env, jobject jParam, CK_VOID_PTR *ckpParamPtr, CK_ULONG *ckpLength);</span>
360 

361 
<span class="line-modified">362 /* functions to convert a specific Java mechanism parameter object to a CK-mechanism parameter structure */</span>













363 
<span class="line-removed">364 CK_RSA_PKCS_OAEP_PARAMS jRsaPkcsOaepParamToCKRsaPkcsOaepParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">365 CK_KEA_DERIVE_PARAMS jKeaDeriveParamToCKKeaDeriveParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">366 CK_RC2_CBC_PARAMS jRc2CbcParamToCKRc2CbcParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">367 CK_RC2_MAC_GENERAL_PARAMS jRc2MacGeneralParamToCKRc2MacGeneralParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">368 CK_RC5_PARAMS jRc5ParamToCKRc5Param(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">369 CK_RC5_CBC_PARAMS jRc5CbcParamToCKRc5CbcParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">370 CK_RC5_MAC_GENERAL_PARAMS jRc5MacGeneralParamToCKRc5MacGeneralParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">371 CK_SKIPJACK_PRIVATE_WRAP_PARAMS jSkipjackPrivateWrapParamToCKSkipjackPrivateWrapParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">372 CK_SKIPJACK_RELAYX_PARAMS jSkipjackRelayxParamToCKSkipjackRelayxParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">373 CK_PBE_PARAMS jPbeParamToCKPbeParam(JNIEnv *env, jobject jParam);</span>
374 void copyBackPBEInitializationVector(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);
<span class="line-removed">375 CK_PKCS5_PBKD2_PARAMS jPkcs5Pbkd2ParamToCKPkcs5Pbkd2Param(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">376 CK_KEY_WRAP_SET_OAEP_PARAMS jKeyWrapSetOaepParamToCKKeyWrapSetOaepParam(JNIEnv *env, jobject jParam);</span>
377 void copyBackSetUnwrappedKey(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);
<span class="line-removed">378 CK_SSL3_MASTER_KEY_DERIVE_PARAMS jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParam(JNIEnv *env, jobject jParam);</span>
379 void ssl3CopyBackClientVersion(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);
380 void tls12CopyBackClientVersion(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);
<span class="line-removed">381 CK_SSL3_KEY_MAT_PARAMS jSsl3KeyMatParamToCKSsl3KeyMatParam(JNIEnv *env, jobject jParam);</span>
382 void ssl3CopyBackKeyMatParams(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);
383 void tls12CopyBackKeyMatParams(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);
<span class="line-removed">384 CK_KEY_DERIVATION_STRING_DATA jKeyDerivationStringDataToCKKeyDerivationStringData(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">385 CK_RSA_PKCS_PSS_PARAMS jRsaPkcsPssParamToCKRsaPkcsPssParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">386 CK_ECDH1_DERIVE_PARAMS jEcdh1DeriveParamToCKEcdh1DeriveParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">387 CK_ECDH2_DERIVE_PARAMS jEcdh2DeriveParamToCKEcdh2DeriveParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">388 CK_X9_42_DH1_DERIVE_PARAMS jX942Dh1DeriveParamToCKX942Dh1DeriveParam(JNIEnv *env, jobject jParam);</span>
<span class="line-removed">389 CK_X9_42_DH2_DERIVE_PARAMS jX942Dh2DeriveParamToCKX942Dh2DeriveParam(JNIEnv *env, jobject jParam);</span>
390 
391 
392 /* functions to convert the InitArgs object for calling the right Java mutex functions */
393 
394 CK_C_INITIALIZE_ARGS_PTR makeCKInitArgsAdapter(JNIEnv *env, jobject pInitArgs);
395 
396 #ifndef NO_CALLBACKS /* if the library should not make callbacks; e.g. no javai.lib or jvm.lib available */
397 CK_RV callJCreateMutex(CK_VOID_PTR_PTR ppMutex);
398 CK_RV callJDestroyMutex(CK_VOID_PTR pMutex);
399 CK_RV callJLockMutex(CK_VOID_PTR pMutex);
400 CK_RV callJUnlockMutex(CK_VOID_PTR pMutex);
401 #endif /* NO_CALLBACKS */
402 
403 void putModuleEntry(JNIEnv *env, jobject pkcs11Implementation, ModuleData *moduleData);
404 ModuleData * removeModuleEntry(JNIEnv *env, jobject pkcs11Implementation);
405 CK_FUNCTION_LIST_PTR getFunctionList(JNIEnv *env, jobject pkcs11Implementation);
406 
407 /* A structure to encapsulate the required data for a Notify callback */
408 struct NotifyEncapsulation {
409 
</pre>
<hr />
<pre>
433 
434     /* Reference to the Notify encapsulation object that was passed to C_OpenSession. */
435     NotifyEncapsulation *notifyEncapsulation;
436 
437     /* Pointer to the next node in the list. */
438     struct NotifyListNode *next;
439 
440 };
441 typedef struct NotifyListNode NotifyListNode;
442 
443 void putNotifyEntry(JNIEnv *env, CK_SESSION_HANDLE hSession, NotifyEncapsulation *notifyEncapsulation);
444 NotifyEncapsulation * removeNotifyEntry(JNIEnv *env, CK_SESSION_HANDLE hSession);
445 NotifyEncapsulation * removeFirstNotifyEntry(JNIEnv *env);
446 
447 jobject createLockObject(JNIEnv *env);
448 void destroyLockObject(JNIEnv *env, jobject jLockObject);
449 
450 extern jfieldID pNativeDataID;
451 extern jfieldID mech_mechanismID;
452 extern jfieldID mech_pParameterID;

453 
454 extern jclass jByteArrayClass;
455 extern jclass jLongClass;
456 
457 #ifndef NO_CALLBACKS
458 extern NotifyListNode *notifyListHead;
459 extern jobject notifyListLock;
460 
461 extern jobject jInitArgsObject;
462 extern CK_C_INITIALIZE_ARGS_PTR ckpGlobalInitArgs;
463 #endif /* NO_CALLBACKS */
464 
465 #ifdef P11_MEMORYDEBUG
466 #include &lt;stdlib.h&gt;
467 
<span class="line-modified">468 /* Simple malloc/free dumper */</span>
469 void *p11malloc(size_t c, char *file, int line);

470 void p11free(void *p, char *file, int line);
471 
472 /* Use THIS_FILE when it is available. */
473 #ifndef THIS_FILE
474     #define THIS_FILE __FILE__
475 #endif
476 
477 #define malloc(c)       (p11malloc((c), THIS_FILE, __LINE__))

478 #define free(c)         (p11free((c), THIS_FILE, __LINE__))
479 
480 #endif
481 
482 #endif /* _PKCS11WRAPPER_H */
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
</pre>
<hr />
<pre>
 52  * declaration of all functions used by pkcs11wrapper.c
 53  *
 54  * @author Karl Scheibelhofer &lt;Karl.Scheibelhofer@iaik.at&gt;
 55  * @author Martin Schlaeffer &lt;schlaeff@sbox.tugraz.at&gt;
 56  */
 57 
 58 #ifndef _PKCS11WRAPPER_H
 59 #define _PKCS11WRAPPER_H 1
 60 
 61 /* disable asserts in product mode */
 62 #ifndef DEBUG
 63   #ifndef NDEBUG
 64     #define NDEBUG
 65   #endif
 66 #endif
 67 
 68 /* extra PKCS#11 constants not in the standard include files */
 69 
 70 #define CKA_NETSCAPE_BASE                       (0x80000000 + 0x4E534350)
 71 #define CKA_NETSCAPE_TRUST_BASE                 (CKA_NETSCAPE_BASE + 0x2000)

 72 #define CKA_NETSCAPE_TRUST_SERVER_AUTH          (CKA_NETSCAPE_TRUST_BASE + 8)
 73 #define CKA_NETSCAPE_TRUST_CLIENT_AUTH          (CKA_NETSCAPE_TRUST_BASE + 9)
 74 #define CKA_NETSCAPE_TRUST_CODE_SIGNING (CKA_NETSCAPE_TRUST_BASE + 10)
 75 #define CKA_NETSCAPE_TRUST_EMAIL_PROTECTION     (CKA_NETSCAPE_TRUST_BASE + 11)
<span class="line-added"> 76 #define CKA_NETSCAPE_DB                         0xD5A0DB00</span>
<span class="line-added"> 77 #define CKM_NSS_TLS_PRF_GENERAL                 0x80000373</span>
 78 
 79 /*
 80 
 81  Define the PKCS#11 functions to include and exclude. Reduces the size
 82  of the binary somewhat.
 83 
 84  This list needs to be kept in sync with the mapfile and PKCS11.java
 85 
 86 */
 87 
 88 #define P11_ENABLE_C_INITIALIZE
 89 #define P11_ENABLE_C_FINALIZE
 90 #define P11_ENABLE_C_GETINFO
 91 #define P11_ENABLE_C_GETSLOTLIST
 92 #define P11_ENABLE_C_GETSLOTINFO
 93 #define P11_ENABLE_C_GETTOKENINFO
 94 #define P11_ENABLE_C_GETMECHANISMLIST
 95 #define P11_ENABLE_C_GETMECHANISMINFO
 96 #undef  P11_ENABLE_C_INITTOKEN
 97 #undef  P11_ENABLE_C_INITPIN
</pre>
<hr />
<pre>
138 #define P11_ENABLE_C_VERIFYFINAL
139 #define P11_ENABLE_C_VERIFYRECOVERINIT
140 #define P11_ENABLE_C_VERIFYRECOVER
141 #undef  P11_ENABLE_C_DIGESTENCRYPTUPDATE
142 #undef  P11_ENABLE_C_DECRYPTDIGESTUPDATE
143 #undef  P11_ENABLE_C_SIGNENCRYPTUPDATE
144 #undef  P11_ENABLE_C_DECRYPTVERIFYUPDATE
145 #define P11_ENABLE_C_GENERATEKEY
146 #define P11_ENABLE_C_GENERATEKEYPAIR
147 #define P11_ENABLE_C_WRAPKEY
148 #define P11_ENABLE_C_UNWRAPKEY
149 #define P11_ENABLE_C_DERIVEKEY
150 #define P11_ENABLE_C_SEEDRANDOM
151 #define P11_ENABLE_C_GENERATERANDOM
152 #undef  P11_ENABLE_C_GETFUNCTIONSTATUS
153 #undef  P11_ENABLE_C_CANCELFUNCTION
154 #undef  P11_ENABLE_C_WAITFORSLOTEVENT
155 #define P11_ENABLE_GETNATIVEKEYINFO
156 #define P11_ENABLE_CREATENATIVEKEY
157 
<span class="line-added">158 </span>
159 /* include the platform dependent part of the header */
160 #include &quot;p11_md.h&quot;
161 


162 #include &lt;jni.h&gt;
163 #include &lt;jni_util.h&gt;
164 #include &lt;stdarg.h&gt;
165 
166 #define MAX_STACK_BUFFER_LEN (4 * 1024)
167 #define MAX_HEAP_BUFFER_LEN (64 * 1024)
168 
169 #define MAX_DIGEST_LEN (64)
170 
171 #ifndef min
172 #define min(a, b)       (((a) &lt; (b)) ? (a) : (b))
173 #endif
174 
175 #define ckBBoolToJBoolean(x) ((x == TRUE) ? JNI_TRUE : JNI_FALSE);
176 #define jBooleanToCKBBool(x) ((x == JNI_TRUE) ? TRUE : FALSE);
177 
178 #define ckByteToJByte(x) ((jbyte) x)
179 #define jByteToCKByte(x) ((CK_BYTE) x)
180 
181 #define ckLongToJLong(x) ((jlong) x)
</pre>
<hr />
<pre>
189     ? (jlong)-1 : ((jlong) x))
190 
191 #define ckCharToJChar(x) ((jchar) x)
192 #define jCharToCKChar(x) ((CK_CHAR) x)
193 
194 #define ckUTF8CharToJChar(x) ((jchar) x)
195 #define jCharToCKUTF8Char(x) ((CK_UTF8CHAR) x)
196 
197 #define ckFlageToJLong(x) ((jlong) x)
198 
199 #define ckVoidPtrToJObject(x) ((jobject) x)
200 #define jObjectToCKVoidPtr(x) ((CK_VOID_PTR) x)
201 
202 #define jIntToCKLong(x)         ((CK_LONG) x)
203 #define jIntToCKULong(x)        ((CK_ULONG) x)
204 #define ckLongToJInt(x)         ((jint) x)
205 #define ckULongToJInt(x)        ((jint) x)
206 #define ckULongToJSize(x)       ((jsize) x)
207 #define unsignedIntToCKULong(x) ((CK_ULONG) x)
208 
<span class="line-modified">209 //#define TRACE0d(s) { printf(s); fflush(stdout); }</span>
<span class="line-added">210 //#define TRACE1d(s, p1) { printf(s, p1); fflush(stdout); }</span>
<span class="line-added">211 //#define TRACE2d(s, p1, p2) { printf(s, p1, p2); fflush(stdout); }</span>
212 
213 #ifdef P11_DEBUG
214 #define TRACE0(s) { printf(s); fflush(stdout); }
215 #define TRACE1(s, p1) { printf(s, p1); fflush(stdout); }
216 #define TRACE2(s, p1, p2) { printf(s, p1, p2); fflush(stdout); }
217 #define TRACE3(s, p1, p2, p3) { printf(s, p1, p2, p3); fflush(stdout); }
218 #else
219 #define TRACE0(s)
220 #define TRACE1(s, p1)
221 #define TRACE2(s, p1, p2)
222 #define TRACE3(s, p1, p2, p3)
223 #define TRACE_INTEND
224 #define TRACE_UNINTEND
225 #endif
226 
227 /* debug output */
228 extern jboolean debug;
229 void printDebug(const char *format, ...);
230 
231 #define CK_ASSERT_OK 0L
232 
<span class="line-added">233 #define CLASS_P11PSSSIGNATURE &quot;sun/security/pkcs11/P11PSSSignature&quot;</span>
<span class="line-added">234 </span>
235 #define CLASS_INFO &quot;sun/security/pkcs11/wrapper/CK_INFO&quot;
236 #define CLASS_VERSION &quot;sun/security/pkcs11/wrapper/CK_VERSION&quot;
237 #define CLASS_SLOT_INFO &quot;sun/security/pkcs11/wrapper/CK_SLOT_INFO&quot;
238 #define CLASS_TOKEN_INFO &quot;sun/security/pkcs11/wrapper/CK_TOKEN_INFO&quot;
239 #define CLASS_MECHANISM &quot;sun/security/pkcs11/wrapper/CK_MECHANISM&quot;
240 #define CLASS_MECHANISM_INFO &quot;sun/security/pkcs11/wrapper/CK_MECHANISM_INFO&quot;
241 #define CLASS_SESSION_INFO &quot;sun/security/pkcs11/wrapper/CK_SESSION_INFO&quot;
242 #define CLASS_ATTRIBUTE &quot;sun/security/pkcs11/wrapper/CK_ATTRIBUTE&quot;
243 #define CLASS_DATE &quot;sun/security/pkcs11/wrapper/CK_DATE&quot;
244 #define CLASS_PKCS11EXCEPTION &quot;sun/security/pkcs11/wrapper/PKCS11Exception&quot;
245 #define CLASS_PKCS11RUNTIMEEXCEPTION &quot;sun/security/pkcs11/wrapper/PKCS11RuntimeException&quot;
246 #define CLASS_FILE_NOT_FOUND_EXCEPTION &quot;java/io/FileNotFoundException&quot;
247 #define CLASS_C_INITIALIZE_ARGS &quot;sun/security/pkcs11/wrapper/CK_C_INITIALIZE_ARGS&quot;
248 #define CLASS_CREATEMUTEX &quot;sun/security/pkcs11/wrapper/CK_CREATEMUTEX&quot;
249 #define CLASS_DESTROYMUTEX &quot;sun/security/pkcs11/wrapper/CK_DESTROYMUTEX&quot;
250 #define CLASS_LOCKMUTEX &quot;sun/security/pkcs11/wrapper/CK_LOCKMUTEX&quot;
251 #define CLASS_UNLOCKMUTEX &quot;sun/security/pkcs11/wrapper/CK_UNLOCKMUTEX&quot;
252 #define CLASS_NOTIFY &quot;sun/security/pkcs11/wrapper/CK_NOTIFY&quot;
253 
254 
255 /* mechanism parameter classes */
<span class="line-modified">256 #define CLASS_AES_CTR_PARAMS &quot;sun/security/pkcs11/wrapper/CK_AES_CTR_PARAMS&quot;</span>
<span class="line-added">257 #define CLASS_GCM_PARAMS &quot;sun/security/pkcs11/wrapper/CK_GCM_PARAMS&quot;</span>
<span class="line-added">258 #define CLASS_CCM_PARAMS &quot;sun/security/pkcs11/wrapper/CK_CCM_PARAMS&quot;</span>
<span class="line-added">259 #define CLASS_RSA_PKCS_PSS_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RSA_PKCS_PSS_PARAMS&quot;</span>
260 #define CLASS_RSA_PKCS_OAEP_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RSA_PKCS_OAEP_PARAMS&quot;
<span class="line-added">261 </span>
262 #define CLASS_MAC_GENERAL_PARAMS &quot;sun/security/pkcs11/wrapper/CK_MAC_GENERAL_PARAMS&quot;
263 #define CLASS_PBE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_PBE_PARAMS&quot;
264 #define PBE_INIT_VECTOR_SIZE 8
265 #define CLASS_PKCS5_PBKD2_PARAMS &quot;sun/security/pkcs11/wrapper/CK_PKCS5_PBKD2_PARAMS&quot;
266 #define CLASS_EXTRACT_PARAMS &quot;sun/security/pkcs11/wrapper/CK_EXTRACT_PARAMS&quot;
267 

268 #define CLASS_ECDH1_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_ECDH1_DERIVE_PARAMS&quot;
269 #define CLASS_ECDH2_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_ECDH2_DERIVE_PARAMS&quot;
270 #define CLASS_X9_42_DH1_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_X9_42_DH1_DERIVE_PARAMS&quot;
271 #define CLASS_X9_42_DH2_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_X9_42_DH2_DERIVE_PARAMS&quot;
272 
273 /*
274 #define CLASS_KEA_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_KEA_DERIVE_PARAMS&quot;
275 #define CLASS_RC2_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC2_PARAMS&quot;
276 #define CLASS_RC2_CBC_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC2_CBC_PARAMS&quot;
277 #define CLASS_RC2_MAC_GENERAL_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC2_MAC_GENERAL_PARAMS&quot;
278 #define CLASS_RC5_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC5_PARAMS&quot;
279 #define CLASS_RC5_CBC_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC5_CBC_PARAMS&quot;
280 #define CLASS_RC5_MAC_GENERAL_PARAMS &quot;sun/security/pkcs11/wrapper/CK_RC5_MAC_GENERAL_PARAMS&quot;
281 #define CLASS_SKIPJACK_PRIVATE_WRAP_PARAMS &quot;sun/security/pkcs11/wrapper/CK_SKIPJACK_PRIVATE_WRAP_PARAMS&quot;
282 #define CLASS_SKIPJACK_RELAYX_PARAMS &quot;sun/security/pkcs11/wrapper/CK_SKIPJACK_RELAYX_PARAMS&quot;
283 #define CLASS_KEY_WRAP_SET_OAEP_PARAMS &quot;sun/security/pkcs11/wrapper/CK_KEY_WRAP_SET_OAEP_PARAMS&quot;
284 #define CLASS_KEY_DERIVATION_STRING_DATA &quot;sun/security/pkcs11/wrapper/CK_KEY_DERIVATION_STRING_DATA&quot;
285 */
286 
287 #define CLASS_SSL3_RANDOM_DATA &quot;sun/security/pkcs11/wrapper/CK_SSL3_RANDOM_DATA&quot;
288 // CLASS_SSL3_RANDOM_DATA is used by CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS
289 #define CLASS_SSL3_KEY_MAT_OUT &quot;sun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_OUT&quot;
290 // CLASS_SSL3_KEY_MAT_OUT is used by CLASS_SSL3_KEY_MAT_PARAMS and CK_TLS12_KEY_MAT_PARAMS
291 #define CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_SSL3_MASTER_KEY_DERIVE_PARAMS&quot;
292 #define CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS &quot;sun/security/pkcs11/wrapper/CK_TLS12_MASTER_KEY_DERIVE_PARAMS&quot;
293 #define CLASS_SSL3_KEY_MAT_PARAMS &quot;sun/security/pkcs11/wrapper/CK_SSL3_KEY_MAT_PARAMS&quot;
294 #define CLASS_TLS12_KEY_MAT_PARAMS &quot;sun/security/pkcs11/wrapper/CK_TLS12_KEY_MAT_PARAMS&quot;
295 #define CLASS_TLS_PRF_PARAMS &quot;sun/security/pkcs11/wrapper/CK_TLS_PRF_PARAMS&quot;
296 #define CLASS_TLS_MAC_PARAMS &quot;sun/security/pkcs11/wrapper/CK_TLS_MAC_PARAMS&quot;
<span class="line-modified">297 </span>
<span class="line-added">298 /* function to update the CK_NSS_GCM_PARAMS in mechanism pointer with</span>
<span class="line-added">299  * CK_GCM_PARAMS</span>
<span class="line-added">300  */</span>
<span class="line-added">301 CK_MECHANISM_PTR updateGCMParams(JNIEnv *env, CK_MECHANISM_PTR mechPtr);</span>
302 
303 /* function to convert a PKCS#11 return value other than CK_OK into a Java Exception
304  * or to throw a PKCS11RuntimeException
305  */
306 
307 jlong ckAssertReturnValueOK(JNIEnv *env, CK_RV returnValue);
308 void throwOutOfMemoryError(JNIEnv *env, const char *message);
309 void throwNullPointerException(JNIEnv *env, const char *message);
310 void throwIOException(JNIEnv *env, const char *message);
311 void throwPKCS11RuntimeException(JNIEnv *env, const char *message);
312 void throwDisconnectedRuntimeException(JNIEnv *env);
313 
<span class="line-modified">314 /* functions to free CK structures and pointers</span>
315  */
316 void freeCKAttributeArray(CK_ATTRIBUTE_PTR attrPtr, int len);
<span class="line-added">317 void freeCKMechanismPtr(CK_MECHANISM_PTR mechPtr);</span>
318 
<span class="line-modified">319 /* functions to convert Java arrays to a CK-type array and the array length */</span>
320 
321 void jBooleanArrayToCKBBoolArray(JNIEnv *env, const jbooleanArray jArray, CK_BBOOL **ckpArray, CK_ULONG_PTR ckLength);
322 void jByteArrayToCKByteArray(JNIEnv *env, const jbyteArray jArray, CK_BYTE_PTR *ckpArray, CK_ULONG_PTR ckLength);
323 void jLongArrayToCKULongArray(JNIEnv *env, const jlongArray jArray, CK_ULONG_PTR *ckpArray, CK_ULONG_PTR ckLength);
324 void jCharArrayToCKCharArray(JNIEnv *env, const jcharArray jArray, CK_CHAR_PTR *ckpArray, CK_ULONG_PTR ckLength);
325 void jCharArrayToCKUTF8CharArray(JNIEnv *env, const jcharArray jArray, CK_UTF8CHAR_PTR *ckpArray, CK_ULONG_PTR ckLength);
326 void jStringToCKUTF8CharArray(JNIEnv *env, const jstring jArray, CK_UTF8CHAR_PTR *ckpArray, CK_ULONG_PTR ckpLength);
327 void jAttributeArrayToCKAttributeArray(JNIEnv *env, jobjectArray jAArray, CK_ATTRIBUTE_PTR *ckpArray, CK_ULONG_PTR ckpLength);
328 /*void jObjectArrayToCKVoidPtrArray(JNIEnv *env, const jobjectArray jArray, CK_VOID_PTR_PTR ckpArray, CK_ULONG_PTR ckpLength); */
329 
330 
<span class="line-modified">331 /* functions to convert a CK-type array and the array length to a Java array */</span>
332 
333 jbyteArray ckByteArrayToJByteArray(JNIEnv *env, const CK_BYTE_PTR ckpArray, CK_ULONG ckLength);
334 jlongArray ckULongArrayToJLongArray(JNIEnv *env, const CK_ULONG_PTR ckpArray, CK_ULONG ckLength);
335 jcharArray ckCharArrayToJCharArray(JNIEnv *env, const CK_CHAR_PTR ckpArray, CK_ULONG length);
336 jcharArray ckUTF8CharArrayToJCharArray(JNIEnv *env, const CK_UTF8CHAR_PTR ckpArray, CK_ULONG ckLength);
337 
338 
<span class="line-modified">339 /* functions to convert a CK-type structure or a pointer to a CK-value to a Java object */</span>
340 
341 jobject ckBBoolPtrToJBooleanObject(JNIEnv *env, const CK_BBOOL* ckpValue);
342 jobject ckULongPtrToJLongObject(JNIEnv *env, const CK_ULONG_PTR ckpValue);
343 jobject ckDatePtrToJDateObject(JNIEnv *env, const CK_DATE *ckpValue);
344 jobject ckVersionPtrToJVersion(JNIEnv *env, const CK_VERSION_PTR ckpVersion);
345 jobject ckSessionInfoPtrToJSessionInfo(JNIEnv *env, const CK_SESSION_INFO_PTR ckpSessionInfo);
346 jobject ckAttributePtrToJAttribute(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute);
347 
348 
<span class="line-modified">349 /* function to convert the CK-value used by the CK_ATTRIBUTE structure to a Java object */</span>
350 
351 jobject ckAttributeValueToJObject(JNIEnv *env, const CK_ATTRIBUTE_PTR ckpAttribute);
352 
353 
<span class="line-modified">354 /* functions to convert a Java object to a CK-type structure or a pointer to a CK-value */</span>
355 
356 CK_BBOOL* jBooleanObjectToCKBBoolPtr(JNIEnv *env, jobject jObject);
357 CK_BYTE_PTR jByteObjectToCKBytePtr(JNIEnv *env, jobject jObject);
358 CK_ULONG* jIntegerObjectToCKULongPtr(JNIEnv *env, jobject jObject);
359 CK_ULONG* jLongObjectToCKULongPtr(JNIEnv *env, jobject jObject);
360 CK_CHAR_PTR jCharObjectToCKCharPtr(JNIEnv *env, jobject jObject);
361 CK_VERSION_PTR jVersionToCKVersionPtr(JNIEnv *env, jobject jVersion);
<span class="line-modified">362 CK_DATE * jDateObjectToCKDatePtr(JNIEnv *env, jobject jDate);</span>
363 CK_ATTRIBUTE jAttributeToCKAttribute(JNIEnv *env, jobject jAttribute);
<span class="line-modified">364 CK_MECHANISM_PTR jMechanismToCKMechanismPtr(JNIEnv *env, jobject jMechanism);</span>

365 
366 
<span class="line-modified">367 /* functions to convert Java objects used by the Mechanism and Attribute class to a CK-type structure */</span>
<span class="line-added">368 CK_VOID_PTR jObjectToPrimitiveCKObjectPtr(JNIEnv *env, jobject jObject, CK_ULONG *ckpLength);</span>
<span class="line-added">369 CK_VOID_PTR jMechParamToCKMechParamPtr(JNIEnv *env, jobject jParam, CK_MECHANISM_TYPE, CK_ULONG</span>
<span class="line-added">370 *ckpLength);</span>
371 


372 
<span class="line-added">373 /* functions to convert a specific Java mechanism parameter object to a CK-mechanism parameter pointer */</span>
374 
<span class="line-modified">375 CK_RSA_PKCS_OAEP_PARAMS_PTR jRsaPkcsOaepParamToCKRsaPkcsOaepParamPtr(JNIEnv *env,</span>
<span class="line-added">376     jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">377 CK_PBE_PARAMS_PTR jPbeParamToCKPbeParamPtr(JNIEnv *env, jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">378 CK_PKCS5_PBKD2_PARAMS_PTR jPkcs5Pbkd2ParamToCKPkcs5Pbkd2ParamPtr(JNIEnv *env, jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">379 CK_SSL3_MASTER_KEY_DERIVE_PARAMS_PTR jSsl3MasterKeyDeriveParamToCKSsl3MasterKeyDeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">380 CK_SSL3_KEY_MAT_PARAMS_PTR jSsl3KeyMatParamToCKSsl3KeyMatParamPtr(JNIEnv *env, jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">381 CK_KEY_DERIVATION_STRING_DATA jKeyDerivationStringDataToCKKeyDerivationStringData(JNIEnv *env, jobject jParam);</span>
<span class="line-added">382 CK_RSA_PKCS_PSS_PARAMS_PTR jRsaPkcsPssParamToCKRsaPkcsPssParamPtr(JNIEnv *env, jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">383 CK_ECDH1_DERIVE_PARAMS_PTR jEcdh1DeriveParamToCKEcdh1DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">384 CK_ECDH2_DERIVE_PARAMS_PTR jEcdh2DeriveParamToCKEcdh2DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">385 CK_X9_42_DH1_DERIVE_PARAMS_PTR jX942Dh1DeriveParamToCKX942Dh1DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">386 CK_X9_42_DH2_DERIVE_PARAMS_PTR jX942Dh2DeriveParamToCKX942Dh2DeriveParamPtr(JNIEnv *env, jobject jParam, CK_ULONG* pLength);</span>
<span class="line-added">387 </span>
<span class="line-added">388 /* functions to copy the returned values inside CK-mechanism back to Java object */</span>
389 










390 void copyBackPBEInitializationVector(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);


391 void copyBackSetUnwrappedKey(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);

392 void ssl3CopyBackClientVersion(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);
393 void tls12CopyBackClientVersion(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);

394 void ssl3CopyBackKeyMatParams(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);
395 void tls12CopyBackKeyMatParams(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism);






396 
397 
398 /* functions to convert the InitArgs object for calling the right Java mutex functions */
399 
400 CK_C_INITIALIZE_ARGS_PTR makeCKInitArgsAdapter(JNIEnv *env, jobject pInitArgs);
401 
402 #ifndef NO_CALLBACKS /* if the library should not make callbacks; e.g. no javai.lib or jvm.lib available */
403 CK_RV callJCreateMutex(CK_VOID_PTR_PTR ppMutex);
404 CK_RV callJDestroyMutex(CK_VOID_PTR pMutex);
405 CK_RV callJLockMutex(CK_VOID_PTR pMutex);
406 CK_RV callJUnlockMutex(CK_VOID_PTR pMutex);
407 #endif /* NO_CALLBACKS */
408 
409 void putModuleEntry(JNIEnv *env, jobject pkcs11Implementation, ModuleData *moduleData);
410 ModuleData * removeModuleEntry(JNIEnv *env, jobject pkcs11Implementation);
411 CK_FUNCTION_LIST_PTR getFunctionList(JNIEnv *env, jobject pkcs11Implementation);
412 
413 /* A structure to encapsulate the required data for a Notify callback */
414 struct NotifyEncapsulation {
415 
</pre>
<hr />
<pre>
439 
440     /* Reference to the Notify encapsulation object that was passed to C_OpenSession. */
441     NotifyEncapsulation *notifyEncapsulation;
442 
443     /* Pointer to the next node in the list. */
444     struct NotifyListNode *next;
445 
446 };
447 typedef struct NotifyListNode NotifyListNode;
448 
449 void putNotifyEntry(JNIEnv *env, CK_SESSION_HANDLE hSession, NotifyEncapsulation *notifyEncapsulation);
450 NotifyEncapsulation * removeNotifyEntry(JNIEnv *env, CK_SESSION_HANDLE hSession);
451 NotifyEncapsulation * removeFirstNotifyEntry(JNIEnv *env);
452 
453 jobject createLockObject(JNIEnv *env);
454 void destroyLockObject(JNIEnv *env, jobject jLockObject);
455 
456 extern jfieldID pNativeDataID;
457 extern jfieldID mech_mechanismID;
458 extern jfieldID mech_pParameterID;
<span class="line-added">459 extern jfieldID mech_pHandleID;</span>
460 
461 extern jclass jByteArrayClass;
462 extern jclass jLongClass;
463 
464 #ifndef NO_CALLBACKS
465 extern NotifyListNode *notifyListHead;
466 extern jobject notifyListLock;
467 
468 extern jobject jInitArgsObject;
469 extern CK_C_INITIALIZE_ARGS_PTR ckpGlobalInitArgs;
470 #endif /* NO_CALLBACKS */
471 
472 #ifdef P11_MEMORYDEBUG
473 #include &lt;stdlib.h&gt;
474 
<span class="line-modified">475 /* Simple malloc/calloc/free dumper */</span>
476 void *p11malloc(size_t c, char *file, int line);
<span class="line-added">477 void *p11calloc(size_t c, size_t s, char *file, int line);</span>
478 void p11free(void *p, char *file, int line);
479 
480 /* Use THIS_FILE when it is available. */
481 #ifndef THIS_FILE
482     #define THIS_FILE __FILE__
483 #endif
484 
485 #define malloc(c)       (p11malloc((c), THIS_FILE, __LINE__))
<span class="line-added">486 #define calloc(c, s)    (p11calloc((c), (s), THIS_FILE, __LINE__))</span>
487 #define free(c)         (p11free((c), THIS_FILE, __LINE__))
488 
489 #endif
490 
491 #endif /* _PKCS11WRAPPER_H */
</pre>
</td>
</tr>
</table>
<center><a href="pkcs11t.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../../../unix/native/libj2pkcs11/p11_md.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>