<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_keymgmt.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="p11_general.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_mutex.c.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_keymgmt.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -153,11 +153,11 @@</span>
      unsigned long totalCkAttributesSize = 0UL, totalNativeKeyInfoArraySize = 0UL;
      jbyte* wrappedKeySizePtr = NULL;
      jbyte* nativeKeyInfoArrayRawCkAttributes = NULL;
      jbyte* nativeKeyInfoArrayRawCkAttributesPtr = NULL;
      jbyte* nativeKeyInfoArrayRawDataPtr = NULL;
<span class="udiff-line-modified-removed">-     CK_MECHANISM ckMechanism;</span>
<span class="udiff-line-modified-added">+     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
      char iv[16] = {0x0};
      CK_ULONG ckWrappedKeyLength = 0U;
      jbyte* wrappedKeySizeWrappedKeyArrayPtr = NULL;
      CK_BYTE_PTR wrappedKeyBufferPtr = NULL;
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -196,12 +196,12 @@</span>
          // the extracted buffer.
          netscapeAttributeValueNeeded = CK_TRUE;
          TRACE0(&quot;DEBUG: override CKA_NETSCAPE_DB attr value to TRUE\n&quot;);
      }
  
<span class="udiff-line-modified-removed">-     ckpAttributes = (CK_ATTRIBUTE_PTR)malloc(</span>
<span class="udiff-line-modified-removed">-             CK_ATTRIBUTES_TEMPLATE_LENGTH * sizeof(CK_ATTRIBUTE));</span>
<span class="udiff-line-modified-added">+     ckpAttributes = (CK_ATTRIBUTE_PTR) calloc(</span>
<span class="udiff-line-modified-added">+             CK_ATTRIBUTES_TEMPLATE_LENGTH, sizeof(CK_ATTRIBUTE));</span>
      if (ckpAttributes == NULL) {
          throwOutOfMemoryError(env, 0);
          goto cleanup;
      }
      memcpy(ckpAttributes, ckpAttributesTemplate,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -306,14 +306,14 @@</span>
  
      if ((sensitiveAttributePosition != (unsigned int)-1) &amp;&amp;
          *(CK_BBOOL*)(((CK_ATTRIBUTE_PTR)(((CK_ATTRIBUTE_PTR)nativeKeyInfoArrayRawCkAttributes)
                  +sensitiveAttributePosition))-&gt;pValue) == CK_TRUE) {
          // Key is sensitive. Need to extract it wrapped.
<span class="udiff-line-modified-removed">-         if (jWrappingKeyHandle != -1) {</span>
<span class="udiff-line-modified-added">+         if (jWrappingKeyHandle != 0) {</span>
  
<span class="udiff-line-modified-removed">-             jMechanismToCKMechanism(env, jWrappingMech, &amp;ckMechanism);</span>
<span class="udiff-line-modified-removed">-             rv = (*ckpFunctions-&gt;C_WrapKey)(ckSessionHandle, &amp;ckMechanism,</span>
<span class="udiff-line-modified-added">+             ckpMechanism = jMechanismToCKMechanismPtr(env, jWrappingMech);</span>
<span class="udiff-line-modified-added">+             rv = (*ckpFunctions-&gt;C_WrapKey)(ckSessionHandle, ckpMechanism,</span>
                      jLongToCKULong(jWrappingKeyHandle), ckObjectHandle,
                      NULL_PTR, &amp;ckWrappedKeyLength);
              if (ckWrappedKeyLength != 0) {
                  // Allocate space for getting the wrapped key
                  nativeKeyInfoWrappedKeyArray = (*env)-&gt;NewByteArray(env,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -337,11 +337,11 @@</span>
                  TRACE1(&quot;DEBUG: GetNativeKeyInfo 1st C_WrapKey wrappedKeyLength = %lu\n&quot;, ckWrappedKeyLength);
  
                  wrappedKeyBufferPtr =
                          (CK_BYTE_PTR) (wrappedKeySizeWrappedKeyArrayPtr +
                          sizeof(unsigned long));
<span class="udiff-line-modified-removed">-                 rv = (*ckpFunctions-&gt;C_WrapKey)(ckSessionHandle, &amp;ckMechanism,</span>
<span class="udiff-line-modified-added">+                 rv = (*ckpFunctions-&gt;C_WrapKey)(ckSessionHandle, ckpMechanism,</span>
                          jLongToCKULong(jWrappingKeyHandle),ckObjectHandle,
                          wrappedKeyBufferPtr, &amp;ckWrappedKeyLength);
                  if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) {
                      goto cleanup;
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -349,10 +349,11 @@</span>
                  TRACE1(&quot;DEBUG: GetNativeKeyInfo 2nd C_WrapKey wrappedKeyLength = %lu\n&quot;, ckWrappedKeyLength);
              } else {
                  goto cleanup;
              }
          } else {
<span class="udiff-line-added">+             ckAssertReturnValueOK(env, CKR_KEY_HANDLE_INVALID);</span>
              goto cleanup;
          }
          returnValue = nativeKeyInfoWrappedKeyArray;
      } else {
          returnValue = nativeKeyInfoArray;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -379,10 +380,11 @@</span>
  
      if (nativeKeyInfoWrappedKeyArray != NULL
              &amp;&amp; returnValue != nativeKeyInfoWrappedKeyArray) {
          (*env)-&gt;DeleteLocalRef(env, nativeKeyInfoWrappedKeyArray);
      }
<span class="udiff-line-added">+     freeCKMechanismPtr(ckpMechanism);</span>
  
      return returnValue;
  }
  #endif
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -414,11 +416,11 @@</span>
      jbyte* nativeKeyInfoArrayRawCkAttributesPtr = NULL;
      jbyte* nativeKeyInfoArrayRawDataPtr = NULL;
      unsigned long totalDataSize = 0UL;
      jbyte* wrappedKeySizePtr = NULL;
      unsigned int i = 0U;
<span class="udiff-line-modified-removed">-     CK_MECHANISM ckMechanism;</span>
<span class="udiff-line-modified-added">+     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
      char iv[16] = {0x0};
      CK_ULONG ckWrappedKeyLength = 0UL;
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
  
      if (ckpFunctions == NULL) { goto cleanup; }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -465,12 +467,12 @@</span>
          rv = (*ckpFunctions-&gt;C_CreateObject)(ckSessionHandle,
                  (CK_ATTRIBUTE_PTR)nativeKeyInfoArrayRawCkAttributes,
                  jLongToCKULong(nativeKeyInfoCkAttributesCount), &amp;ckObjectHandle);
      } else {
          // Wrapped key
<span class="udiff-line-modified-removed">-         jMechanismToCKMechanism(env, jWrappingMech, &amp;ckMechanism);</span>
<span class="udiff-line-modified-removed">-         rv = (*ckpFunctions-&gt;C_UnwrapKey)(ckSessionHandle, &amp;ckMechanism,</span>
<span class="udiff-line-modified-added">+         ckpMechanism = jMechanismToCKMechanismPtr(env, jWrappingMech);</span>
<span class="udiff-line-modified-added">+         rv = (*ckpFunctions-&gt;C_UnwrapKey)(ckSessionHandle, ckpMechanism,</span>
                  jLongToCKULong(jWrappingKeyHandle),
                  (CK_BYTE_PTR)(wrappedKeySizePtr + sizeof(unsigned long)),
                  ckWrappedKeyLength,
                  (CK_ATTRIBUTE_PTR)nativeKeyInfoArrayRawCkAttributes,
                  jLongToCKULong(nativeKeyInfoCkAttributesCount),
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -487,10 +489,11 @@</span>
      if (nativeKeyInfoArrayRaw != NULL) {
          (*env)-&gt;ReleaseByteArrayElements(env, jNativeKeyInfo,
                  nativeKeyInfoArrayRaw, JNI_ABORT);
      }
  
<span class="udiff-line-added">+     freeCKMechanismPtr(ckpMechanism);</span>
      return jObjectHandle;
  }
  #endif
  
  #ifdef P11_ENABLE_C_GENERATEKEY
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -507,56 +510,51 @@</span>
   */
  JNIEXPORT jlong JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1GenerateKey
      (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism, jobjectArray jTemplate)
  {
      CK_SESSION_HANDLE ckSessionHandle;
<span class="udiff-line-modified-removed">-     CK_MECHANISM ckMechanism;</span>
<span class="udiff-line-modified-added">+     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
      CK_ATTRIBUTE_PTR ckpAttributes = NULL_PTR;
<span class="udiff-line-modified-removed">-     CK_ULONG ckAttributesLength;</span>
<span class="udiff-line-modified-added">+     CK_ULONG ckAttributesLength = 0;</span>
      CK_OBJECT_HANDLE ckKeyHandle = 0;
      jlong jKeyHandle = 0L;
      CK_RV rv;
  
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
      if (ckpFunctions == NULL) { return 0L; }
  
      ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="udiff-line-modified-removed">-     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>
<span class="udiff-line-modified-added">+     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
      if ((*env)-&gt;ExceptionCheck(env)) { return 0L ; }
  
      jAttributeArrayToCKAttributeArray(env, jTemplate, &amp;ckpAttributes, &amp;ckAttributesLength);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="udiff-line-modified-removed">-         if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-             free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return 0L;</span>
<span class="udiff-line-modified-added">+         goto cleanup;</span>
      }
  
<span class="udiff-line-modified-removed">-     rv = (*ckpFunctions-&gt;C_GenerateKey)(ckSessionHandle, &amp;ckMechanism, ckpAttributes, ckAttributesLength, &amp;ckKeyHandle);</span>
<span class="udiff-line-modified-added">+     rv = (*ckpFunctions-&gt;C_GenerateKey)(ckSessionHandle, ckpMechanism, ckpAttributes, ckAttributesLength, &amp;ckKeyHandle);</span>
  
      if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
          jKeyHandle = ckULongToJLong(ckKeyHandle);
  
          /* cheack, if we must give a initialization vector back to Java */
<span class="udiff-line-modified-removed">-         switch (ckMechanism.mechanism) {</span>
<span class="udiff-line-modified-added">+         switch (ckpMechanism-&gt;mechanism) {</span>
          case CKM_PBE_MD2_DES_CBC:
          case CKM_PBE_MD5_DES_CBC:
          case CKM_PBE_MD5_CAST_CBC:
          case CKM_PBE_MD5_CAST3_CBC:
          case CKM_PBE_MD5_CAST128_CBC:
          /* case CKM_PBE_MD5_CAST5_CBC:  the same as CKM_PBE_MD5_CAST128_CBC */
          case CKM_PBE_SHA1_CAST128_CBC:
          /* case CKM_PBE_SHA1_CAST5_CBC: the same as CKM_PBE_SHA1_CAST128_CBC */
              /* we must copy back the initialization vector to the jMechanism object */
<span class="udiff-line-modified-removed">-             copyBackPBEInitializationVector(env, &amp;ckMechanism, jMechanism);</span>
<span class="udiff-line-modified-added">+             copyBackPBEInitializationVector(env, ckpMechanism, jMechanism);</span>
              break;
          }
      }
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-         free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ cleanup:</span>
<span class="udiff-line-modified-added">+     freeCKMechanismPtr(ckpMechanism);</span>
      freeCKAttributeArray(ckpAttributes, ckAttributesLength);
  
      return jKeyHandle ;
  }
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -579,58 +577,46 @@</span>
  JNIEXPORT jlongArray JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1GenerateKeyPair
      (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism,
       jobjectArray jPublicKeyTemplate, jobjectArray jPrivateKeyTemplate)
  {
      CK_SESSION_HANDLE ckSessionHandle;
<span class="udiff-line-modified-removed">-     CK_MECHANISM ckMechanism;</span>
<span class="udiff-line-modified-added">+     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
      CK_ATTRIBUTE_PTR ckpPublicKeyAttributes = NULL_PTR;
      CK_ATTRIBUTE_PTR ckpPrivateKeyAttributes = NULL_PTR;
<span class="udiff-line-modified-removed">-     CK_ULONG ckPublicKeyAttributesLength;</span>
<span class="udiff-line-modified-removed">-     CK_ULONG ckPrivateKeyAttributesLength;</span>
<span class="udiff-line-modified-added">+     CK_ULONG ckPublicKeyAttributesLength = 0;</span>
<span class="udiff-line-modified-added">+     CK_ULONG ckPrivateKeyAttributesLength = 0;</span>
      CK_OBJECT_HANDLE_PTR ckpPublicKeyHandle;  /* pointer to Public Key */
      CK_OBJECT_HANDLE_PTR ckpPrivateKeyHandle; /* pointer to Private Key */
<span class="udiff-line-modified-removed">-     CK_OBJECT_HANDLE_PTR ckpKeyHandles;     /* pointer to array with Public and Private Key */</span>
<span class="udiff-line-modified-added">+     CK_OBJECT_HANDLE_PTR ckpKeyHandles = NULL; /* pointer to array with Public and Private Key */</span>
      jlongArray jKeyHandles = NULL;
      CK_RV rv;
      int attempts;
      const int MAX_ATTEMPTS = 3;
  
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
      if (ckpFunctions == NULL) { return NULL; }
  
      ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="udiff-line-modified-removed">-     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>
<span class="udiff-line-modified-added">+     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
      if ((*env)-&gt;ExceptionCheck(env)) { return NULL; }
  
<span class="udiff-line-modified-removed">-     ckpKeyHandles = (CK_OBJECT_HANDLE_PTR) malloc(2 * sizeof(CK_OBJECT_HANDLE));</span>
<span class="udiff-line-modified-added">+     ckpKeyHandles = (CK_OBJECT_HANDLE_PTR) calloc(2, sizeof(CK_OBJECT_HANDLE));</span>
      if (ckpKeyHandles == NULL) {
<span class="udiff-line-removed">-         if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-             free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-         }</span>
          throwOutOfMemoryError(env, 0);
<span class="udiff-line-modified-removed">-         return NULL;</span>
<span class="udiff-line-modified-added">+         goto cleanup;</span>
      }
      ckpPublicKeyHandle = ckpKeyHandles;   /* first element of array is Public Key */
      ckpPrivateKeyHandle = (ckpKeyHandles + 1);  /* second element of array is Private Key */
  
      jAttributeArrayToCKAttributeArray(env, jPublicKeyTemplate, &amp;ckpPublicKeyAttributes, &amp;ckPublicKeyAttributesLength);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="udiff-line-modified-removed">-         if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-             free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         free(ckpKeyHandles);</span>
<span class="udiff-line-removed">-         return NULL;</span>
<span class="udiff-line-modified-added">+         goto cleanup;</span>
      }
  
      jAttributeArrayToCKAttributeArray(env, jPrivateKeyTemplate, &amp;ckpPrivateKeyAttributes, &amp;ckPrivateKeyAttributesLength);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="udiff-line-modified-removed">-         if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-             free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         free(ckpKeyHandles);</span>
<span class="udiff-line-removed">-         freeCKAttributeArray(ckpPublicKeyAttributes, ckPublicKeyAttributesLength);</span>
<span class="udiff-line-removed">-         return NULL;</span>
<span class="udiff-line-modified-added">+         goto cleanup;</span>
      }
  
      /*
       * Workaround for NSS bug 1012786:
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -647,11 +633,11 @@</span>
       *      to make the exact same function call again would succeed.
       *
       * Call C_GenerateKeyPair() several times if CKR_FUNCTION_FAILED occurs.
       */
      for (attempts = 0; attempts &lt; MAX_ATTEMPTS; attempts++) {
<span class="udiff-line-modified-removed">-         rv = (*ckpFunctions-&gt;C_GenerateKeyPair)(ckSessionHandle, &amp;ckMechanism,</span>
<span class="udiff-line-modified-added">+         rv = (*ckpFunctions-&gt;C_GenerateKeyPair)(ckSessionHandle, ckpMechanism,</span>
                          ckpPublicKeyAttributes, ckPublicKeyAttributesLength,
                          ckpPrivateKeyAttributes, ckPrivateKeyAttributesLength,
                          ckpPublicKeyHandle, ckpPrivateKeyHandle);
          if (rv == CKR_FUNCTION_FAILED) {
              printDebug(&quot;C_1GenerateKeyPair(): C_GenerateKeyPair() failed \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -663,17 +649,15 @@</span>
  
      if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
          jKeyHandles = ckULongArrayToJLongArray(env, ckpKeyHandles, 2);
      }
  
<span class="udiff-line-modified-removed">-     if(ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-modified-removed">-         free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ cleanup:</span>
<span class="udiff-line-modified-added">+     freeCKMechanismPtr(ckpMechanism);</span>
      free(ckpKeyHandles);
      freeCKAttributeArray(ckpPublicKeyAttributes, ckPublicKeyAttributesLength);
      freeCKAttributeArray(ckpPrivateKeyAttributes, ckPrivateKeyAttributesLength);
<span class="udiff-line-removed">- </span>
      return jKeyHandles ;
  }
  #endif
  
  #ifdef P11_ENABLE_C_WRAPKEY
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -691,11 +675,11 @@</span>
   */
  JNIEXPORT jbyteArray JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1WrapKey
      (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism, jlong jWrappingKeyHandle, jlong jKeyHandle)
  {
      CK_SESSION_HANDLE ckSessionHandle;
<span class="udiff-line-modified-removed">-     CK_MECHANISM ckMechanism;</span>
<span class="udiff-line-modified-added">+     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
      CK_OBJECT_HANDLE ckWrappingKeyHandle;
      CK_OBJECT_HANDLE ckKeyHandle;
      jbyteArray jWrappedKey = NULL;
      CK_RV rv;
      CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -704,37 +688,35 @@</span>
  
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
      if (ckpFunctions == NULL) { return NULL; }
  
      ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="udiff-line-modified-removed">-     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>
<span class="udiff-line-modified-added">+     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
      if ((*env)-&gt;ExceptionCheck(env)) { return NULL; }
  
      ckWrappingKeyHandle = jLongToCKULong(jWrappingKeyHandle);
      ckKeyHandle = jLongToCKULong(jKeyHandle);
  
<span class="udiff-line-modified-removed">-     rv = (*ckpFunctions-&gt;C_WrapKey)(ckSessionHandle, &amp;ckMechanism, ckWrappingKeyHandle, ckKeyHandle, ckpWrappedKey, &amp;ckWrappedKeyLength);</span>
<span class="udiff-line-modified-added">+     rv = (*ckpFunctions-&gt;C_WrapKey)(ckSessionHandle, ckpMechanism, ckWrappingKeyHandle, ckKeyHandle, ckpWrappedKey, &amp;ckWrappedKeyLength);</span>
      if (rv == CKR_BUFFER_TOO_SMALL) {
<span class="udiff-line-modified-removed">-         ckpWrappedKey = (CK_BYTE_PTR) malloc(ckWrappedKeyLength);</span>
<span class="udiff-line-modified-added">+         ckpWrappedKey = (CK_BYTE_PTR)</span>
<span class="udiff-line-added">+                 calloc(ckWrappedKeyLength, sizeof(CK_BYTE));</span>
          if (ckpWrappedKey == NULL) {
<span class="udiff-line-removed">-             if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-                 free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-             }</span>
              throwOutOfMemoryError(env, 0);
<span class="udiff-line-modified-removed">-             return NULL;</span>
<span class="udiff-line-modified-added">+             goto cleanup;</span>
          }
  
<span class="udiff-line-modified-removed">-         rv = (*ckpFunctions-&gt;C_WrapKey)(ckSessionHandle, &amp;ckMechanism, ckWrappingKeyHandle, ckKeyHandle, ckpWrappedKey, &amp;ckWrappedKeyLength);</span>
<span class="udiff-line-modified-added">+         rv = (*ckpFunctions-&gt;C_WrapKey)(ckSessionHandle, ckpMechanism, ckWrappingKeyHandle, ckKeyHandle, ckpWrappedKey, &amp;ckWrappedKeyLength);</span>
      }
      if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
          jWrappedKey = ckByteArrayToJByteArray(env, ckpWrappedKey, ckWrappedKeyLength);
      }
  
<span class="udiff-line-added">+ cleanup:</span>
      if (ckpWrappedKey != BUF) { free(ckpWrappedKey); }
<span class="udiff-line-modified-removed">-     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-modified-removed">-         free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     freeCKMechanismPtr(ckpMechanism);</span>
<span class="udiff-line-modified-added">+ </span>
      return jWrappedKey ;
  }
  #endif
  
  #ifdef P11_ENABLE_C_UNWRAPKEY
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -755,122 +737,69 @@</span>
  JNIEXPORT jlong JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1UnwrapKey
      (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism, jlong jUnwrappingKeyHandle,
       jbyteArray jWrappedKey, jobjectArray jTemplate)
  {
      CK_SESSION_HANDLE ckSessionHandle;
<span class="udiff-line-modified-removed">-     CK_MECHANISM ckMechanism;</span>
<span class="udiff-line-modified-added">+     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
      CK_OBJECT_HANDLE ckUnwrappingKeyHandle;
      CK_BYTE_PTR ckpWrappedKey = NULL_PTR;
      CK_ULONG ckWrappedKeyLength;
      CK_ATTRIBUTE_PTR ckpAttributes = NULL_PTR;
<span class="udiff-line-modified-removed">-     CK_ULONG ckAttributesLength;</span>
<span class="udiff-line-modified-added">+     CK_ULONG ckAttributesLength = 0;</span>
      CK_OBJECT_HANDLE ckKeyHandle = 0;
      jlong jKeyHandle = 0L;
      CK_RV rv;
  
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
      if (ckpFunctions == NULL) { return 0L; }
  
      ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="udiff-line-modified-removed">-     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>
<span class="udiff-line-modified-added">+     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
      if ((*env)-&gt;ExceptionCheck(env)) { return 0L; }
  
      ckUnwrappingKeyHandle = jLongToCKULong(jUnwrappingKeyHandle);
      jByteArrayToCKByteArray(env, jWrappedKey, &amp;ckpWrappedKey, &amp;ckWrappedKeyLength);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="udiff-line-modified-removed">-         if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-             free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return 0L;</span>
<span class="udiff-line-modified-added">+         goto cleanup;</span>
      }
  
      jAttributeArrayToCKAttributeArray(env, jTemplate, &amp;ckpAttributes, &amp;ckAttributesLength);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="udiff-line-modified-removed">-         if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-             free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         free(ckpWrappedKey);</span>
<span class="udiff-line-removed">-         return 0L;</span>
<span class="udiff-line-modified-added">+         goto cleanup;</span>
      }
  
  
<span class="udiff-line-modified-removed">-     rv = (*ckpFunctions-&gt;C_UnwrapKey)(ckSessionHandle, &amp;ckMechanism, ckUnwrappingKeyHandle,</span>
<span class="udiff-line-modified-added">+     rv = (*ckpFunctions-&gt;C_UnwrapKey)(ckSessionHandle, ckpMechanism, ckUnwrappingKeyHandle,</span>
                   ckpWrappedKey, ckWrappedKeyLength,
                   ckpAttributes, ckAttributesLength, &amp;ckKeyHandle);
  
      if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {
          jKeyHandle = ckLongToJLong(ckKeyHandle);
  
  #if 0
          /* cheack, if we must give a initialization vector back to Java */
<span class="udiff-line-modified-removed">-         if (ckMechanism.mechanism == CKM_KEY_WRAP_SET_OAEP) {</span>
<span class="udiff-line-modified-added">+         if (ckpMechanism-&gt;mechanism == CKM_KEY_WRAP_SET_OAEP) {</span>
              /* we must copy back the unwrapped key info to the jMechanism object */
<span class="udiff-line-modified-removed">-             copyBackSetUnwrappedKey(env, &amp;ckMechanism, jMechanism);</span>
<span class="udiff-line-modified-added">+             copyBackSetUnwrappedKey(env, ckpMechanism, jMechanism);</span>
          }
  #endif
      }
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-         free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ cleanup:</span>
<span class="udiff-line-modified-added">+     freeCKMechanismPtr(ckpMechanism);</span>
      freeCKAttributeArray(ckpAttributes, ckAttributesLength);
      free(ckpWrappedKey);
  
      return jKeyHandle ;
  }
  #endif
  
  #ifdef P11_ENABLE_C_DERIVEKEY
  
<span class="udiff-line-removed">- static void freeMasterKeyDeriveParams(CK_SSL3_RANDOM_DATA *RandomInfo, CK_VERSION_PTR pVersion) {</span>
<span class="udiff-line-removed">-     if (RandomInfo-&gt;pClientRandom != NULL) {</span>
<span class="udiff-line-removed">-         free(RandomInfo-&gt;pClientRandom);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     if (RandomInfo-&gt;pServerRandom != NULL) {</span>
<span class="udiff-line-removed">-         free(RandomInfo-&gt;pServerRandom);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     if (pVersion != NULL) {</span>
<span class="udiff-line-removed">-         free(pVersion);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void ssl3FreeMasterKeyDeriveParams(CK_MECHANISM_PTR ckMechanism) {</span>
<span class="udiff-line-removed">-     CK_SSL3_MASTER_KEY_DERIVE_PARAMS *params = (CK_SSL3_MASTER_KEY_DERIVE_PARAMS *) ckMechanism-&gt;pParameter;</span>
<span class="udiff-line-removed">-     if (params == NULL) {</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     freeMasterKeyDeriveParams(&amp;(params-&gt;RandomInfo), params-&gt;pVersion);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void tls12FreeMasterKeyDeriveParams(CK_MECHANISM_PTR ckMechanism) {</span>
<span class="udiff-line-removed">-     CK_TLS12_MASTER_KEY_DERIVE_PARAMS *params =</span>
<span class="udiff-line-removed">-             (CK_TLS12_MASTER_KEY_DERIVE_PARAMS *)ckMechanism-&gt;pParameter;</span>
<span class="udiff-line-removed">-     if (params == NULL) {</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     freeMasterKeyDeriveParams(&amp;(params-&gt;RandomInfo), params-&gt;pVersion);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void freeEcdh1DeriveParams(CK_MECHANISM_PTR ckMechanism) {</span>
<span class="udiff-line-removed">-     CK_ECDH1_DERIVE_PARAMS *params =</span>
<span class="udiff-line-removed">-             (CK_ECDH1_DERIVE_PARAMS *)ckMechanism-&gt;pParameter;</span>
<span class="udiff-line-removed">-     if (params == NULL) {</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (params-&gt;pSharedData != NULL) {</span>
<span class="udiff-line-removed">-         free(params-&gt;pSharedData);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     if (params-&gt;pPublicData != NULL) {</span>
<span class="udiff-line-removed">-         free(params-&gt;pPublicData);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  /*
   * Copy back the PRF output to Java.
   */
<span class="udiff-line-modified-removed">- void copyBackTLSPrfParams(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism)</span>
<span class="udiff-line-modified-added">+ void copyBackTLSPrfParams(JNIEnv *env, CK_MECHANISM_PTR ckpMechanism, jobject jMechanism)</span>
  {
      jclass jMechanismClass, jTLSPrfParamsClass;
      CK_TLS_PRF_PARAMS *ckTLSPrfParams;
      jobject jTLSPrfParams;
      jfieldID fieldID;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -887,17 +816,17 @@</span>
      if (jMechanismClass == NULL) { return; }
      fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;mechanism&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, fieldID);
      ckMechanismType = jLongToCKULong(jMechanismType);
<span class="udiff-line-modified-removed">-     if (ckMechanismType != ckMechanism-&gt;mechanism) {</span>
<span class="udiff-line-modified-added">+     if (ckMechanismType != ckpMechanism-&gt;mechanism) {</span>
          /* we do not have maching types, this should not occur */
          return;
      }
  
      /* get the native CK_TLS_PRF_PARAMS */
<span class="udiff-line-modified-removed">-     ckTLSPrfParams = (CK_TLS_PRF_PARAMS *) ckMechanism-&gt;pParameter;</span>
<span class="udiff-line-modified-added">+     ckTLSPrfParams = (CK_TLS_PRF_PARAMS *) ckpMechanism-&gt;pParameter;</span>
      if (ckTLSPrfParams != NULL_PTR) {
          /* get the Java CK_TLS_PRF_PARAMS object (pParameter) */
          fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;pParameter&quot;, &quot;Ljava/lang/Object;&quot;);
          if (fieldID == NULL) { return; }
          jTLSPrfParams = (*env)-&gt;GetObjectField(env, jMechanism, fieldID);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -922,16 +851,10 @@</span>
                  jBytes[i] = ckByteToJByte(output[i]);
              }
              /* copy back the Java buffer to the object */
              (*env)-&gt;ReleaseByteArrayElements(env, jOutput, jBytes, 0);
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // free malloc&#39;d data</span>
<span class="udiff-line-removed">-         free(ckTLSPrfParams-&gt;pSeed);</span>
<span class="udiff-line-removed">-         free(ckTLSPrfParams-&gt;pLabel);</span>
<span class="udiff-line-removed">-         free(ckTLSPrfParams-&gt;pulOutputLen);</span>
<span class="udiff-line-removed">-         free(ckTLSPrfParams-&gt;pOutput);</span>
      }
  }
  
  /*
   * Class:     sun_security_pkcs11_wrapper_PKCS11
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -947,36 +870,33 @@</span>
   */
  JNIEXPORT jlong JNICALL Java_sun_security_pkcs11_wrapper_PKCS11_C_1DeriveKey
      (JNIEnv *env, jobject obj, jlong jSessionHandle, jobject jMechanism, jlong jBaseKeyHandle, jobjectArray jTemplate)
  {
      CK_SESSION_HANDLE ckSessionHandle;
<span class="udiff-line-modified-removed">-     CK_MECHANISM ckMechanism;</span>
<span class="udiff-line-modified-added">+     CK_MECHANISM_PTR ckpMechanism = NULL;</span>
      CK_OBJECT_HANDLE ckBaseKeyHandle;
      CK_ATTRIBUTE_PTR ckpAttributes = NULL_PTR;
<span class="udiff-line-modified-removed">-     CK_ULONG ckAttributesLength;</span>
<span class="udiff-line-modified-added">+     CK_ULONG ckAttributesLength = 0;</span>
      CK_OBJECT_HANDLE ckKeyHandle = 0;
      jlong jKeyHandle = 0L;
      CK_RV rv;
      CK_OBJECT_HANDLE_PTR phKey = &amp;ckKeyHandle;
  
      CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
      if (ckpFunctions == NULL) { return 0L; }
  
      ckSessionHandle = jLongToCKULong(jSessionHandle);
<span class="udiff-line-modified-removed">-     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>
<span class="udiff-line-modified-added">+     ckpMechanism = jMechanismToCKMechanismPtr(env, jMechanism);</span>
      if ((*env)-&gt;ExceptionCheck(env)) { return 0L; }
  
      ckBaseKeyHandle = jLongToCKULong(jBaseKeyHandle);
      jAttributeArrayToCKAttributeArray(env, jTemplate, &amp;ckpAttributes, &amp;ckAttributesLength);
      if ((*env)-&gt;ExceptionCheck(env)) {
<span class="udiff-line-modified-removed">-         if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-             free(ckMechanism.pParameter);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return 0L;</span>
<span class="udiff-line-modified-added">+         goto cleanup;</span>
      }
  
<span class="udiff-line-modified-removed">-     switch (ckMechanism.mechanism) {</span>
<span class="udiff-line-modified-added">+     switch (ckpMechanism-&gt;mechanism) {</span>
      case CKM_SSL3_KEY_AND_MAC_DERIVE:
      case CKM_TLS_KEY_AND_MAC_DERIVE:
      case CKM_TLS12_KEY_AND_MAC_DERIVE:
      case CKM_TLS_PRF:
          // these mechanism do not return a key handle via phKey
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -986,64 +906,52 @@</span>
      default:
          // empty
          break;
      }
  
<span class="udiff-line-modified-removed">-     rv = (*ckpFunctions-&gt;C_DeriveKey)(ckSessionHandle, &amp;ckMechanism, ckBaseKeyHandle,</span>
<span class="udiff-line-modified-added">+     rv = (*ckpFunctions-&gt;C_DeriveKey)(ckSessionHandle, ckpMechanism, ckBaseKeyHandle,</span>
                   ckpAttributes, ckAttributesLength, phKey);
  
      jKeyHandle = ckLongToJLong(ckKeyHandle);
  
<span class="udiff-line-modified-removed">-     freeCKAttributeArray(ckpAttributes, ckAttributesLength);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     switch (ckMechanism.mechanism) {</span>
<span class="udiff-line-modified-added">+     switch (ckpMechanism-&gt;mechanism) {</span>
      case CKM_SSL3_MASTER_KEY_DERIVE:
      case CKM_TLS_MASTER_KEY_DERIVE:
          /* we must copy back the client version */
<span class="udiff-line-modified-removed">-         ssl3CopyBackClientVersion(env, &amp;ckMechanism, jMechanism);</span>
<span class="udiff-line-removed">-         ssl3FreeMasterKeyDeriveParams(&amp;ckMechanism);</span>
<span class="udiff-line-modified-added">+         ssl3CopyBackClientVersion(env, ckpMechanism, jMechanism);</span>
          break;
      case CKM_TLS12_MASTER_KEY_DERIVE:
<span class="udiff-line-modified-removed">-         tls12CopyBackClientVersion(env, &amp;ckMechanism, jMechanism);</span>
<span class="udiff-line-removed">-         tls12FreeMasterKeyDeriveParams(&amp;ckMechanism);</span>
<span class="udiff-line-removed">-         break;</span>
<span class="udiff-line-removed">-     case CKM_SSL3_MASTER_KEY_DERIVE_DH:</span>
<span class="udiff-line-removed">-     case CKM_TLS_MASTER_KEY_DERIVE_DH:</span>
<span class="udiff-line-removed">-         ssl3FreeMasterKeyDeriveParams(&amp;ckMechanism);</span>
<span class="udiff-line-removed">-         break;</span>
<span class="udiff-line-removed">-     case CKM_TLS12_MASTER_KEY_DERIVE_DH:</span>
<span class="udiff-line-removed">-         tls12FreeMasterKeyDeriveParams(&amp;ckMechanism);</span>
<span class="udiff-line-modified-added">+         tls12CopyBackClientVersion(env, ckpMechanism, jMechanism);</span>
          break;
      case CKM_SSL3_KEY_AND_MAC_DERIVE:
      case CKM_TLS_KEY_AND_MAC_DERIVE:
          /* we must copy back the unwrapped key info to the jMechanism object */
<span class="udiff-line-modified-removed">-         ssl3CopyBackKeyMatParams(env, &amp;ckMechanism, jMechanism);</span>
<span class="udiff-line-modified-added">+         ssl3CopyBackKeyMatParams(env, ckpMechanism, jMechanism);</span>
          break;
      case CKM_TLS12_KEY_AND_MAC_DERIVE:
          /* we must copy back the unwrapped key info to the jMechanism object */
<span class="udiff-line-modified-removed">-         tls12CopyBackKeyMatParams(env, &amp;ckMechanism, jMechanism);</span>
<span class="udiff-line-modified-added">+         tls12CopyBackKeyMatParams(env, ckpMechanism, jMechanism);</span>
          break;
      case CKM_TLS_PRF:
<span class="udiff-line-modified-removed">-         copyBackTLSPrfParams(env, &amp;ckMechanism, jMechanism);</span>
<span class="udiff-line-removed">-         break;</span>
<span class="udiff-line-removed">-     case CKM_ECDH1_DERIVE:</span>
<span class="udiff-line-removed">-         freeEcdh1DeriveParams(&amp;ckMechanism);</span>
<span class="udiff-line-modified-added">+         copyBackTLSPrfParams(env, ckpMechanism, jMechanism);</span>
          break;
      default:
          // empty
          break;
      }
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="udiff-line-removed">-         free(ckMechanism.pParameter);</span>
<span class="udiff-line-modified-added">+     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) {</span>
<span class="udiff-line-modified-added">+         jKeyHandle =0L;</span>
      }
<span class="udiff-line-modified-removed">-     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return 0L ; }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+ cleanup:</span>
<span class="udiff-line-added">+     freeCKMechanismPtr(ckpMechanism);</span>
<span class="udiff-line-added">+     freeCKAttributeArray(ckpAttributes, ckAttributesLength);</span>
  
      return jKeyHandle ;
  }
  
<span class="udiff-line-modified-removed">- static void copyBackClientVersion(JNIEnv *env, CK_MECHANISM *ckMechanism, jobject jMechanism,</span>
<span class="udiff-line-modified-added">+ static void copyBackClientVersion(JNIEnv *env, CK_MECHANISM_PTR ckpMechanism, jobject jMechanism,</span>
          CK_VERSION *ckVersion, const char *class_master_key_derive_params)
  {
      jclass jMasterKeyDeriveParamsClass, jMechanismClass, jVersionClass;
      jobject jMasterKeyDeriveParams;
      jfieldID fieldID;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1056,11 +964,11 @@</span>
      if (jMechanismClass == NULL) { return; }
      fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;mechanism&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, fieldID);
      ckMechanismType = jLongToCKULong(jMechanismType);
<span class="udiff-line-modified-removed">-     if (ckMechanismType != ckMechanism-&gt;mechanism) {</span>
<span class="udiff-line-modified-added">+     if (ckMechanismType != ckpMechanism-&gt;mechanism) {</span>
          /* we do not have maching types, this should not occur */
          return;
      }
  
      if (ckVersion != NULL_PTR) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1099,18 +1007,18 @@</span>
   * structure to the Java object. This is only used for
   * CKM_SSL3_MASTER_KEY_DERIVE and CKM_TLS_MASTER_KEY_DERIVE
   * mechanisms when used for deriving a key.
   *
   */
<span class="udiff-line-modified-removed">- void ssl3CopyBackClientVersion(JNIEnv *env, CK_MECHANISM *ckMechanism,</span>
<span class="udiff-line-modified-added">+ void ssl3CopyBackClientVersion(JNIEnv *env, CK_MECHANISM_PTR ckpMechanism,</span>
          jobject jMechanism)
  {
      CK_SSL3_MASTER_KEY_DERIVE_PARAMS *ckSSL3MasterKeyDeriveParams;
      ckSSL3MasterKeyDeriveParams =
<span class="udiff-line-modified-removed">-             (CK_SSL3_MASTER_KEY_DERIVE_PARAMS *)ckMechanism-&gt;pParameter;</span>
<span class="udiff-line-modified-added">+             (CK_SSL3_MASTER_KEY_DERIVE_PARAMS *)ckpMechanism-&gt;pParameter;</span>
      if (ckSSL3MasterKeyDeriveParams != NULL_PTR) {
<span class="udiff-line-modified-removed">-         copyBackClientVersion(env, ckMechanism, jMechanism,</span>
<span class="udiff-line-modified-added">+         copyBackClientVersion(env, ckpMechanism, jMechanism,</span>
                  ckSSL3MasterKeyDeriveParams-&gt;pVersion,
                  CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);
      }
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1118,24 +1026,24 @@</span>
   * Copy back the client version information from the native
   * structure to the Java object. This is only used for
   * CKM_TLS12_MASTER_KEY_DERIVE mechanism when used for deriving a key.
   *
   */
<span class="udiff-line-modified-removed">- void tls12CopyBackClientVersion(JNIEnv *env, CK_MECHANISM *ckMechanism,</span>
<span class="udiff-line-modified-added">+ void tls12CopyBackClientVersion(JNIEnv *env, CK_MECHANISM_PTR ckpMechanism,</span>
          jobject jMechanism)
  {
      CK_TLS12_MASTER_KEY_DERIVE_PARAMS *ckTLS12MasterKeyDeriveParams;
      ckTLS12MasterKeyDeriveParams =
<span class="udiff-line-modified-removed">-             (CK_TLS12_MASTER_KEY_DERIVE_PARAMS *)ckMechanism-&gt;pParameter;</span>
<span class="udiff-line-modified-added">+             (CK_TLS12_MASTER_KEY_DERIVE_PARAMS *)ckpMechanism-&gt;pParameter;</span>
      if (ckTLS12MasterKeyDeriveParams != NULL_PTR) {
<span class="udiff-line-modified-removed">-         copyBackClientVersion(env, ckMechanism, jMechanism,</span>
<span class="udiff-line-modified-added">+         copyBackClientVersion(env, ckpMechanism, jMechanism,</span>
                  ckTLS12MasterKeyDeriveParams-&gt;pVersion,
                  CLASS_TLS12_MASTER_KEY_DERIVE_PARAMS);
      }
  }
  
<span class="udiff-line-modified-removed">- static void copyBackKeyMatParams(JNIEnv *env, CK_MECHANISM *ckMechanism,</span>
<span class="udiff-line-modified-added">+ static void copyBackKeyMatParams(JNIEnv *env, CK_MECHANISM_PTR ckpMechanism,</span>
          jobject jMechanism, CK_SSL3_RANDOM_DATA *RandomInfo,
          CK_SSL3_KEY_MAT_OUT_PTR ckSSL3KeyMatOut, const char *class_key_mat_params)
  {
      jclass jMechanismClass, jKeyMatParamsClass, jSSL3KeyMatOutClass;
      jfieldID fieldID;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1154,23 +1062,15 @@</span>
      if (jMechanismClass == NULL) { return; }
      fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;mechanism&quot;, &quot;J&quot;);
      if (fieldID == NULL) { return; }
      jMechanismType = (*env)-&gt;GetLongField(env, jMechanism, fieldID);
      ckMechanismType = jLongToCKULong(jMechanismType);
<span class="udiff-line-modified-removed">-     if (ckMechanismType != ckMechanism-&gt;mechanism) {</span>
<span class="udiff-line-modified-added">+     if (ckMechanismType != ckpMechanism-&gt;mechanism) {</span>
          /* we do not have maching types, this should not occur */
          return;
      }
  
<span class="udiff-line-removed">-     // free malloc&#39;d data</span>
<span class="udiff-line-removed">-     if (RandomInfo-&gt;pClientRandom != NULL) {</span>
<span class="udiff-line-removed">-         free(RandomInfo-&gt;pClientRandom);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     if (RandomInfo-&gt;pServerRandom != NULL) {</span>
<span class="udiff-line-removed">-         free(RandomInfo-&gt;pServerRandom);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      if (ckSSL3KeyMatOut != NULL_PTR) {
        /* get the Java params object (pParameter) */
        fieldID = (*env)-&gt;GetFieldID(env, jMechanismClass, &quot;pParameter&quot;,
                &quot;Ljava/lang/Object;&quot;);
        if (fieldID == NULL) { return; }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1228,12 +1128,10 @@</span>
            jBytes[i] = ckByteToJByte(iv[i]);
          }
          /* copy back the Java buffer to the object */
          (*env)-&gt;ReleaseByteArrayElements(env, jIV, jBytes, 0);
        }
<span class="udiff-line-removed">-       // free malloc&#39;d data</span>
<span class="udiff-line-removed">-       free(ckSSL3KeyMatOut-&gt;pIVClient);</span>
  
        /* copy back the server IV */
        fieldID = (*env)-&gt;GetFieldID(env, jSSL3KeyMatOutClass, &quot;pIVServer&quot;, &quot;[B&quot;);
        if (fieldID == NULL) { return; }
        jIV = (*env)-&gt;GetObjectField(env, jSSL3KeyMatOut, fieldID);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1248,30 +1146,27 @@</span>
            jBytes[i] = ckByteToJByte(iv[i]);
          }
          /* copy back the Java buffer to the object */
          (*env)-&gt;ReleaseByteArrayElements(env, jIV, jBytes, 0);
        }
<span class="udiff-line-removed">-       // free malloc&#39;d data</span>
<span class="udiff-line-removed">-       free(ckSSL3KeyMatOut-&gt;pIVServer);</span>
<span class="udiff-line-removed">-       free(ckSSL3KeyMatOut);</span>
      }
  }
  
  /*
   * Copy back the derived keys and initialization vectors from the native
   * structure to the Java object. This is only used for
   * CKM_SSL3_KEY_AND_MAC_DERIVE and CKM_TLS_KEY_AND_MAC_DERIVE mechanisms
   * when used for deriving a key.
   *
   */
<span class="udiff-line-modified-removed">- void ssl3CopyBackKeyMatParams(JNIEnv *env, CK_MECHANISM *ckMechanism,</span>
<span class="udiff-line-modified-added">+ void ssl3CopyBackKeyMatParams(JNIEnv *env, CK_MECHANISM_PTR ckpMechanism,</span>
          jobject jMechanism)
  {
      CK_SSL3_KEY_MAT_PARAMS *ckSSL3KeyMatParam;
<span class="udiff-line-modified-removed">-     ckSSL3KeyMatParam = (CK_SSL3_KEY_MAT_PARAMS *)ckMechanism-&gt;pParameter;</span>
<span class="udiff-line-modified-added">+     ckSSL3KeyMatParam = (CK_SSL3_KEY_MAT_PARAMS *)ckpMechanism-&gt;pParameter;</span>
      if (ckSSL3KeyMatParam != NULL_PTR) {
<span class="udiff-line-modified-removed">-         copyBackKeyMatParams(env, ckMechanism, jMechanism,</span>
<span class="udiff-line-modified-added">+         copyBackKeyMatParams(env, ckpMechanism, jMechanism,</span>
                  &amp;(ckSSL3KeyMatParam-&gt;RandomInfo),
                  ckSSL3KeyMatParam-&gt;pReturnedKeyMaterial,
                  CLASS_SSL3_KEY_MAT_PARAMS);
      }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1280,17 +1175,17 @@</span>
   * Copy back the derived keys and initialization vectors from the native
   * structure to the Java object. This is only used for
   * CKM_TLS12_KEY_AND_MAC_DERIVE mechanism when used for deriving a key.
   *
   */
<span class="udiff-line-modified-removed">- void tls12CopyBackKeyMatParams(JNIEnv *env, CK_MECHANISM *ckMechanism,</span>
<span class="udiff-line-modified-added">+ void tls12CopyBackKeyMatParams(JNIEnv *env, CK_MECHANISM_PTR ckpMechanism,</span>
          jobject jMechanism)
  {
      CK_TLS12_KEY_MAT_PARAMS *ckTLS12KeyMatParam;
<span class="udiff-line-modified-removed">-     ckTLS12KeyMatParam = (CK_TLS12_KEY_MAT_PARAMS *) ckMechanism-&gt;pParameter;</span>
<span class="udiff-line-modified-added">+     ckTLS12KeyMatParam = (CK_TLS12_KEY_MAT_PARAMS *)ckpMechanism-&gt;pParameter;</span>
      if (ckTLS12KeyMatParam != NULL_PTR) {
<span class="udiff-line-modified-removed">-         copyBackKeyMatParams(env, ckMechanism, jMechanism,</span>
<span class="udiff-line-modified-added">+         copyBackKeyMatParams(env, ckpMechanism, jMechanism,</span>
                  &amp;(ckTLS12KeyMatParam-&gt;RandomInfo),
                  ckTLS12KeyMatParam-&gt;pReturnedKeyMaterial,
                  CLASS_TLS12_KEY_MAT_PARAMS);
      }
  }
</pre>
<center><a href="p11_general.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="p11_mutex.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>