<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.crypto.cryptoki/share/native/libj2pkcs11/p11_crypt.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2003, 2012, Oracle and/or its affiliates. All rights reserved.</span>
  3  */
  4 
  5 /* Copyright  (c) 2002 Graz University of Technology. All rights reserved.
  6  *
  7  * Redistribution and use in  source and binary forms, with or without
  8  * modification, are permitted  provided that the following conditions are met:
  9  *
 10  * 1. Redistributions of  source code must retain the above copyright notice,
 11  *    this list of conditions and the following disclaimer.
 12  *
 13  * 2. Redistributions in  binary form must reproduce the above copyright notice,
 14  *    this list of conditions and the following disclaimer in the documentation
 15  *    and/or other materials provided with the distribution.
 16  *
 17  * 3. The end-user documentation included with the redistribution, if any, must
 18  *    include the following acknowledgment:
 19  *
 20  *    &quot;This product includes software developed by IAIK of Graz University of
 21  *     Technology.&quot;
 22  *
 23  *    Alternately, this acknowledgment may appear in the software itself, if
 24  *    and wherever such third-party acknowledgments normally appear.
 25  *
 26  * 4. The names &quot;Graz University of Technology&quot; and &quot;IAIK of Graz University of
 27  *    Technology&quot; must not be used to endorse or promote products derived from
 28  *    this software without prior written permission.
 29  *
 30  * 5. Products derived from this software may not be called
 31  *    &quot;IAIK PKCS Wrapper&quot;, nor may &quot;IAIK&quot; appear in their name, without prior
 32  *    written permission of Graz University of Technology.
 33  *
 34  *  THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY EXPRESSED OR IMPLIED
 35  *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 36  *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 37  *  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE LICENSOR BE
 38  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
 39  *  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 40  *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
 41  *  OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 42  *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 43  *  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 44  *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 45  *  POSSIBILITY  OF SUCH DAMAGE.
 46  * ===========================================================================
 47  */
 48 
 49 #include &quot;pkcs11wrapper.h&quot;
 50 
 51 #include &lt;stdio.h&gt;
 52 #include &lt;stdlib.h&gt;
 53 #include &lt;string.h&gt;
 54 #include &lt;assert.h&gt;
 55 
 56 #include &quot;sun_security_pkcs11_wrapper_PKCS11.h&quot;
 57 
 58 #ifdef P11_ENABLE_C_ENCRYPTINIT
 59 /*
 60  * Class:     sun_security_pkcs11_wrapper_PKCS11
 61  * Method:    C_EncryptInit
 62  * Signature: (JLsun/security/pkcs11/wrapper/CK_MECHANISM;J)V
 63  * Parametermapping:                    *PKCS11*
 64  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
 65  * @param   jobject jMechanism          CK_MECHANISM_PTR pMechanism
 66  * @param   jlong jKeyHandle            CK_OBJECT_HANDLE hKey
 67  */
 68 JNIEXPORT void JNICALL
 69 Java_sun_security_pkcs11_wrapper_PKCS11_C_1EncryptInit
 70 (JNIEnv *env, jobject obj, jlong jSessionHandle,
 71  jobject jMechanism, jlong jKeyHandle)
 72 {
 73     CK_SESSION_HANDLE ckSessionHandle;
<a name="2" id="anc2"></a><span class="line-modified"> 74     CK_MECHANISM ckMechanism;</span>

 75     CK_OBJECT_HANDLE ckKeyHandle;
 76     CK_RV rv;
 77 
 78     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
 79     if (ckpFunctions == NULL) { return; }
 80 
 81     ckSessionHandle = jLongToCKULong(jSessionHandle);
 82     ckKeyHandle = jLongToCKULong(jKeyHandle);
<a name="3" id="anc3"></a><span class="line-modified"> 83     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>



 84     if ((*env)-&gt;ExceptionCheck(env)) { return; }
 85 
<a name="4" id="anc4"></a><span class="line-modified"> 86     rv = (*ckpFunctions-&gt;C_EncryptInit)(ckSessionHandle, &amp;ckMechanism,</span>
 87                                         ckKeyHandle);
 88 
<a name="5" id="anc5"></a><span class="line-modified"> 89     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="line-modified"> 90         free(ckMechanism.pParameter);</span>









 91     }
 92 
<a name="6" id="anc6"></a>

 93     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
<a name="7" id="anc7"></a>

 94 }
 95 #endif
 96 
 97 #ifdef P11_ENABLE_C_ENCRYPT
 98 /*
 99  * Class:     sun_security_pkcs11_wrapper_PKCS11
100  * Method:    C_Encrypt
<a name="8" id="anc8"></a><span class="line-modified">101  * Signature: (J[BII[BII)I</span>
102  * Parametermapping:                    *PKCS11*
103  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
<a name="9" id="anc9"></a>
104  * @param   jbyteArray jData            CK_BYTE_PTR pData
105  *                                      CK_ULONG ulDataLen
<a name="10" id="anc10"></a><span class="line-modified">106  * @return  jbyteArray jEncryptedData   CK_BYTE_PTR pEncryptedData</span>

107  *                                      CK_ULONG_PTR pulEncryptedDataLen
108  */
109 JNIEXPORT jint JNICALL
110 Java_sun_security_pkcs11_wrapper_PKCS11_C_1Encrypt
111 (JNIEnv *env, jobject obj, jlong jSessionHandle,
<a name="11" id="anc11"></a><span class="line-modified">112  jbyteArray jIn, jint jInOfs, jint jInLen,</span>
<span class="line-modified">113  jbyteArray jOut, jint jOutOfs, jint jOutLen)</span>
114 {
115     CK_SESSION_HANDLE ckSessionHandle;
116     CK_RV rv;
117 
118     CK_BYTE_PTR inBufP;
119     CK_BYTE_PTR outBufP;
<a name="12" id="anc12"></a><span class="line-modified">120     CK_ULONG ckEncryptedPartLen;</span>
121 
122     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
123     if (ckpFunctions == NULL) { return 0; }
124 
125     ckSessionHandle = jLongToCKULong(jSessionHandle);
126 
<a name="13" id="anc13"></a><span class="line-modified">127     inBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jIn, NULL);</span>
<span class="line-modified">128     if (inBufP == NULL) { return 0; }</span>




129 
<a name="14" id="anc14"></a><span class="line-modified">130     outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);</span>
<span class="line-modified">131     if (outBufP == NULL) {</span>
<span class="line-modified">132         // Make sure to release inBufP</span>
<span class="line-modified">133         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);</span>
<span class="line-modified">134         return 0;</span>


135     }
136 
<a name="15" id="anc15"></a><span class="line-modified">137     ckEncryptedPartLen = jOutLen;</span>
138 
139     rv = (*ckpFunctions-&gt;C_Encrypt)(ckSessionHandle,
140                                     (CK_BYTE_PTR)(inBufP + jInOfs), jInLen,
141                                     (CK_BYTE_PTR)(outBufP + jOutOfs),
<a name="16" id="anc16"></a><span class="line-modified">142                                     &amp;ckEncryptedPartLen);</span>
<span class="line-removed">143 </span>
<span class="line-removed">144     (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);</span>
<span class="line-removed">145     (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);</span>
146 
147     ckAssertReturnValueOK(env, rv);
<a name="17" id="anc17"></a><span class="line-modified">148     return ckEncryptedPartLen;</span>








149 }
150 #endif
151 
152 #ifdef P11_ENABLE_C_ENCRYPTUPDATE
153 /*
154  * Class:     sun_security_pkcs11_wrapper_PKCS11
155  * Method:    C_EncryptUpdate
156  * Signature: (J[BII[BII)I
157  * Parametermapping:                    *PKCS11*
158  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
159  * @param   jbyteArray jPart            CK_BYTE_PTR pPart
160  *                                      CK_ULONG ulPartLen
161  * @return  jbyteArray jEncryptedPart   CK_BYTE_PTR pEncryptedPart
162  *                                      CK_ULONG_PTR pulEncryptedPartLen
163  */
164 JNIEXPORT jint JNICALL
165 Java_sun_security_pkcs11_wrapper_PKCS11_C_1EncryptUpdate
166 (JNIEnv *env, jobject obj, jlong jSessionHandle,
167  jlong directIn, jbyteArray jIn, jint jInOfs, jint jInLen,
168  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)
169 {
170     CK_SESSION_HANDLE ckSessionHandle;
171     CK_RV rv;
172 
173     CK_BYTE_PTR inBufP;
174     CK_BYTE_PTR outBufP;
<a name="18" id="anc18"></a><span class="line-modified">175     CK_ULONG ckEncryptedPartLen;</span>
176 
177     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
178     if (ckpFunctions == NULL) { return 0; }
179 
180     ckSessionHandle = jLongToCKULong(jSessionHandle);
181 
182     if (directIn != 0) {
183       inBufP = (CK_BYTE_PTR) jlong_to_ptr(directIn);
184     } else {
185       inBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jIn, NULL);
186       if (inBufP == NULL) { return 0; }
187     }
188 
189     if (directOut != 0) {
190       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);
191     } else {
192       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);
193       if (outBufP == NULL) {
<a name="19" id="anc19"></a><span class="line-modified">194           // Make sure to release inBufP</span>
<span class="line-removed">195           (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);</span>
<span class="line-removed">196           return 0;</span>
197       }
198     }
199 
200     ckEncryptedPartLen = jOutLen;
201 
<a name="20" id="anc20"></a><span class="line-removed">202     //printf(&quot;EU: inBufP=%i, jInOfs=%i, jInLen=%i, outBufP=%i\n&quot;,</span>
<span class="line-removed">203     //       inBufP, jInOfs, jInLen, outBufP);</span>
<span class="line-removed">204 </span>
205     rv = (*ckpFunctions-&gt;C_EncryptUpdate)(ckSessionHandle,
206                                           (CK_BYTE_PTR)(inBufP + jInOfs), jInLen,
207                                           (CK_BYTE_PTR)(outBufP + jOutOfs),
208                                           &amp;ckEncryptedPartLen);
209 
<a name="21" id="anc21"></a><span class="line-modified">210     //printf(&quot;EU: ckEncryptedPartLen=%i\n&quot;, ckEncryptedPartLen);</span>
211 
<a name="22" id="anc22"></a><span class="line-modified">212     if (directIn == 0) {</span>

213         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);
214     }
<a name="23" id="anc23"></a><span class="line-modified">215 </span>
<span class="line-removed">216     if (directOut == 0) {</span>
217         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);
218     }
<a name="24" id="anc24"></a><span class="line-removed">219 </span>
<span class="line-removed">220     ckAssertReturnValueOK(env, rv);</span>
<span class="line-removed">221 </span>
222     return ckEncryptedPartLen;
223 }
224 #endif
225 
226 #ifdef P11_ENABLE_C_ENCRYPTFINAL
227 /*
228  * Class:     sun_security_pkcs11_wrapper_PKCS11
229  * Method:    C_EncryptFinal
230  * Signature: (J[BII)I
231  * Parametermapping:                        *PKCS11*
232  * @param   jlong jSessionHandle            CK_SESSION_HANDLE hSession
233  * @return  jbyteArray jLastEncryptedPart   CK_BYTE_PTR pLastEncryptedDataPart
234  *                                          CK_ULONG_PTR pulLastEncryptedDataPartLen
235  */
236 JNIEXPORT jint JNICALL
237 Java_sun_security_pkcs11_wrapper_PKCS11_C_1EncryptFinal
238 (JNIEnv *env, jobject obj, jlong jSessionHandle,
239  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)
240 {
241     CK_SESSION_HANDLE ckSessionHandle;
242     CK_RV rv;
243     CK_BYTE_PTR outBufP;
244     CK_ULONG ckLastEncryptedPartLen;
245 
246     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
247     if (ckpFunctions == NULL) { return 0; }
248 
249     ckSessionHandle = jLongToCKULong(jSessionHandle);
250 
251     if (directOut != 0) {
252       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);
253     } else {
254       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);
255       if (outBufP == NULL) { return 0; }
256     }
257 
258     ckLastEncryptedPartLen = jOutLen;
259 
<a name="25" id="anc25"></a><span class="line-removed">260     //printf(&quot;EF: outBufP=%i\n&quot;, outBufP);</span>
<span class="line-removed">261 </span>
262     rv = (*ckpFunctions-&gt;C_EncryptFinal)(ckSessionHandle,
263                                          (CK_BYTE_PTR)(outBufP + jOutOfs),
264                                          &amp;ckLastEncryptedPartLen);
265 
<a name="26" id="anc26"></a><span class="line-removed">266     //printf(&quot;EF: ckLastEncryptedPartLen=%i&quot;, ckLastEncryptedPartLen);</span>
<span class="line-removed">267 </span>
268     if (directOut == 0) {
269         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);
270     }
271 
272     ckAssertReturnValueOK(env, rv);
273 
274     return ckLastEncryptedPartLen;
275 }
276 #endif
277 
278 #ifdef P11_ENABLE_C_DECRYPTINIT
279 /*
280  * Class:     sun_security_pkcs11_wrapper_PKCS11
281  * Method:    C_DecryptInit
282  * Signature: (JLsun/security/pkcs11/wrapper/CK_MECHANISM;J)V
283  * Parametermapping:                    *PKCS11*
284  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
285  * @param   jobject jMechanism          CK_MECHANISM_PTR pMechanism
286  * @param   jlong jKeyHandle            CK_OBJECT_HANDLE hKey
287  */
288 JNIEXPORT void JNICALL
289 Java_sun_security_pkcs11_wrapper_PKCS11_C_1DecryptInit
290 (JNIEnv *env, jobject obj, jlong jSessionHandle,
291  jobject jMechanism, jlong jKeyHandle)
292 {
293     CK_SESSION_HANDLE ckSessionHandle;
<a name="27" id="anc27"></a><span class="line-modified">294     CK_MECHANISM ckMechanism;</span>

295     CK_OBJECT_HANDLE ckKeyHandle;
296     CK_RV rv;
297 
298     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
299     if (ckpFunctions == NULL) { return; }
300 
301     ckSessionHandle = jLongToCKULong(jSessionHandle);
302     ckKeyHandle = jLongToCKULong(jKeyHandle);
<a name="28" id="anc28"></a><span class="line-modified">303     jMechanismToCKMechanism(env, jMechanism, &amp;ckMechanism);</span>



304     if ((*env)-&gt;ExceptionCheck(env)) { return; }
305 
<a name="29" id="anc29"></a><span class="line-modified">306     rv = (*ckpFunctions-&gt;C_DecryptInit)(ckSessionHandle, &amp;ckMechanism,</span>
307                                         ckKeyHandle);
308 
<a name="30" id="anc30"></a><span class="line-modified">309     if (ckMechanism.pParameter != NULL_PTR) {</span>
<span class="line-modified">310         free(ckMechanism.pParameter);</span>









311     }
312 
<a name="31" id="anc31"></a>

313     if (ckAssertReturnValueOK(env, rv) != CK_ASSERT_OK) { return; }
<a name="32" id="anc32"></a>

314 }
315 #endif
316 
317 #ifdef P11_ENABLE_C_DECRYPT
318 /*
319  * Class:     sun_security_pkcs11_wrapper_PKCS11
320  * Method:    C_Decrypt
<a name="33" id="anc33"></a><span class="line-modified">321  * Signature: (J[BII[BII)I</span>
322  * Parametermapping:                    *PKCS11*
323  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
324  * @param   jbyteArray jEncryptedData   CK_BYTE_PTR pEncryptedData
325  *                                      CK_ULONG ulEncryptedDataLen
326  * @return  jbyteArray jData            CK_BYTE_PTR pData
327  *                                      CK_ULONG_PTR pulDataLen
328  */
329 JNIEXPORT jint JNICALL
330 Java_sun_security_pkcs11_wrapper_PKCS11_C_1Decrypt
331 (JNIEnv *env, jobject obj, jlong jSessionHandle,
<a name="34" id="anc34"></a><span class="line-modified">332  jbyteArray jIn, jint jInOfs, jint jInLen,</span>
<span class="line-modified">333  jbyteArray jOut, jint jOutOfs, jint jOutLen)</span>
334 {
335     CK_SESSION_HANDLE ckSessionHandle;
336     CK_RV rv;
337 
338     CK_BYTE_PTR inBufP;
339     CK_BYTE_PTR outBufP;
<a name="35" id="anc35"></a><span class="line-modified">340     CK_ULONG ckPartLen;</span>
341 
342     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
343     if (ckpFunctions == NULL) { return 0; }
344 
345     ckSessionHandle = jLongToCKULong(jSessionHandle);
346 
<a name="36" id="anc36"></a><span class="line-modified">347     inBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jIn, NULL);</span>
<span class="line-modified">348     if (inBufP == NULL) { return 0; }</span>
<span class="line-modified">349 </span>
<span class="line-modified">350     outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);</span>
<span class="line-modified">351     if (outBufP == NULL) {</span>
<span class="line-removed">352         // Make sure to release inBufP</span>
<span class="line-removed">353         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);</span>
<span class="line-removed">354         return 0;</span>
355     }
356 
<a name="37" id="anc37"></a><span class="line-modified">357     ckPartLen = jOutLen;</span>








358 
359     rv = (*ckpFunctions-&gt;C_Decrypt)(ckSessionHandle,
360                                     (CK_BYTE_PTR)(inBufP + jInOfs), jInLen,
361                                     (CK_BYTE_PTR)(outBufP + jOutOfs),
<a name="38" id="anc38"></a><span class="line-modified">362                                     &amp;ckPartLen);</span>
<span class="line-removed">363 </span>
<span class="line-removed">364     (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);</span>
<span class="line-removed">365     (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);</span>
366 
367     ckAssertReturnValueOK(env, rv);
368 
<a name="39" id="anc39"></a><span class="line-modified">369     return ckPartLen;</span>







370 }
371 #endif
372 
373 #ifdef P11_ENABLE_C_DECRYPTUPDATE
374 /*
375  * Class:     sun_security_pkcs11_wrapper_PKCS11
376  * Method:    C_DecryptUpdate
377  * Signature: (J[BII[BII)I
378  * Parametermapping:                    *PKCS11*
379  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
380  * @param   jbyteArray jEncryptedPart   CK_BYTE_PTR pEncryptedPart
381  *                                      CK_ULONG ulEncryptedPartLen
382  * @return  jbyteArray jPart            CK_BYTE_PTR pPart
383  *                                      CK_ULONG_PTR pulPartLen
384  */
385 JNIEXPORT jint JNICALL
386 Java_sun_security_pkcs11_wrapper_PKCS11_C_1DecryptUpdate
387 (JNIEnv *env, jobject obj, jlong jSessionHandle,
388  jlong directIn, jbyteArray jIn, jint jInOfs, jint jInLen,
389  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)
390 {
391     CK_SESSION_HANDLE ckSessionHandle;
392     CK_RV rv;
393 
394     CK_BYTE_PTR inBufP;
395     CK_BYTE_PTR outBufP;
<a name="40" id="anc40"></a><span class="line-modified">396     CK_ULONG ckDecryptedPartLen;</span>
397 
398     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
399     if (ckpFunctions == NULL) { return 0; }
400 
401     ckSessionHandle = jLongToCKULong(jSessionHandle);
402 
403     if (directIn != 0) {
404       inBufP = (CK_BYTE_PTR) jlong_to_ptr(directIn);
405     } else {
406       inBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jIn, NULL);
407       if (inBufP == NULL) { return 0; }
408     }
409 
410     if (directOut != 0) {
411       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);
412     } else {
413       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);
414       if (outBufP == NULL) {
<a name="41" id="anc41"></a><span class="line-modified">415           // Make sure to release inBufP</span>
<span class="line-removed">416           (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);</span>
<span class="line-removed">417           return 0;</span>
418       }
419     }
420 
421     ckDecryptedPartLen = jOutLen;
<a name="42" id="anc42"></a><span class="line-removed">422 </span>
423     rv = (*ckpFunctions-&gt;C_DecryptUpdate)(ckSessionHandle,
424                                           (CK_BYTE_PTR)(inBufP + jInOfs), jInLen,
425                                           (CK_BYTE_PTR)(outBufP + jOutOfs),
426                                           &amp;ckDecryptedPartLen);
<a name="43" id="anc43"></a><span class="line-modified">427     if (directIn == 0) {</span>



428         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jIn, inBufP, JNI_ABORT);
429     }
<a name="44" id="anc44"></a><span class="line-modified">430 </span>
<span class="line-removed">431     if (directOut == 0) {</span>
432         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);
433     }
<a name="45" id="anc45"></a><span class="line-removed">434 </span>
<span class="line-removed">435     ckAssertReturnValueOK(env, rv);</span>
<span class="line-removed">436 </span>
437     return ckDecryptedPartLen;
438 }
439 
440 #endif
441 
442 #ifdef P11_ENABLE_C_DECRYPTFINAL
443 /*
444  * Class:     sun_security_pkcs11_wrapper_PKCS11
445  * Method:    C_DecryptFinal
446  * Signature: (J[BII)I
447  * Parametermapping:                    *PKCS11*
448  * @param   jlong jSessionHandle        CK_SESSION_HANDLE hSession
449  * @return  jbyteArray jLastPart        CK_BYTE_PTR pLastPart
450  *                                      CK_ULONG_PTR pulLastPartLen
451  */
452 JNIEXPORT jint JNICALL
453 Java_sun_security_pkcs11_wrapper_PKCS11_C_1DecryptFinal
454 (JNIEnv *env, jobject obj, jlong jSessionHandle,
455  jlong directOut, jbyteArray jOut, jint jOutOfs, jint jOutLen)
456 {
457     CK_SESSION_HANDLE ckSessionHandle;
458     CK_RV rv;
459     CK_BYTE_PTR outBufP;
460     CK_ULONG ckLastPartLen;
461 
462     CK_FUNCTION_LIST_PTR ckpFunctions = getFunctionList(env, obj);
463     if (ckpFunctions == NULL) { return 0; }
464 
465     ckSessionHandle = jLongToCKULong(jSessionHandle);
466 
467     if (directOut != 0) {
468       outBufP = (CK_BYTE_PTR) jlong_to_ptr(directOut);
469     } else {
470       outBufP = (*env)-&gt;GetPrimitiveArrayCritical(env, jOut, NULL);
471       if (outBufP == NULL) { return 0; }
472     }
473 
474     ckLastPartLen = jOutLen;
475 
476     rv = (*ckpFunctions-&gt;C_DecryptFinal)(ckSessionHandle,
477                                          (CK_BYTE_PTR)(outBufP + jOutOfs),
478                                          &amp;ckLastPartLen);
479 
480     if (directOut == 0) {
481         (*env)-&gt;ReleasePrimitiveArrayCritical(env, jOut, outBufP, JNI_COMMIT);
482 
483     }
484 
485     ckAssertReturnValueOK(env, rv);
486 
487     return ckLastPartLen;
488 }
489 #endif
<a name="46" id="anc46"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="46" type="hidden" />
</body>
</html>