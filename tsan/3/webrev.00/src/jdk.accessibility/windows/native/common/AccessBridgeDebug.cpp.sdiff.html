<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.accessibility/windows/native/common/AccessBridgeDebug.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../../classes/com/sun/java/accessibility/internal/AccessBridge.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="AccessBridgeDebug.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.accessibility/windows/native/common/AccessBridgeDebug.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2015, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 24  */
 25 
 26 /*
 27  * A class to manage AccessBridge debugging
 28  */
 29 
 30 #include &quot;AccessBridgeDebug.h&quot;
 31 #include &lt;stdarg.h&gt;
 32 #include &lt;stdio.h&gt;
 33 #include &lt;windows.h&gt;
 34 #include &lt;cstdlib&gt;
 35 #include &lt;chrono&gt;
 36 #include &lt;cstring&gt;
 37 
 38 #ifdef __cplusplus
 39 extern &quot;C&quot; {
 40 #endif
 41 
 42 static FILE* logFP = nullptr;
 43 
<span class="line-modified"> 44 void initializeFileLogger(char * suffix) {</span>
<span class="line-modified"> 45     auto var = &quot;JAVA_ACCESSBRIDGE_LOGFILE&quot;;</span>
 46     const auto envfilePath = getenv(var);
<span class="line-modified"> 47     if (envfilePath != nullptr) {</span>
<span class="line-modified"> 48         auto ext = const_cast&lt;char*&gt;(strrchr(envfilePath, &#39;.&#39;));</span>
<span class="line-modified"> 49         auto filePath = static_cast&lt;char*&gt;(nullptr);</span>
<span class="line-modified"> 50         auto len = strlen(envfilePath);</span>
<span class="line-modified"> 51         auto suffixlen = suffix != nullptr ? strlen(suffix) : (decltype(strlen(nullptr)))0;</span>
<span class="line-modified"> 52 </span>
<span class="line-modified"> 53         if (ext == nullptr) {</span>
<span class="line-modified"> 54             filePath = new char[len + suffixlen + 5];</span>
<span class="line-modified"> 55             memset(filePath, 0, len + suffixlen + 5);</span>
<span class="line-modified"> 56             memcpy(filePath, envfilePath, len);</span>
<span class="line-removed"> 57             memcpy(filePath + len, suffix, suffixlen);</span>
<span class="line-removed"> 58             memcpy(filePath + len + suffixlen, &quot;.log&quot;, 4);</span>
<span class="line-removed"> 59         } else {</span>
<span class="line-removed"> 60             auto extLen = strlen(ext);</span>
<span class="line-removed"> 61 </span>
<span class="line-removed"> 62             filePath = new char[len + suffixlen + 1];</span>
<span class="line-removed"> 63             memset(filePath, 0, len + suffixlen + 1);</span>
<span class="line-removed"> 64             memcpy(filePath, envfilePath, len - extLen);</span>
<span class="line-removed"> 65             memcpy(filePath + len - extLen, suffix, suffixlen);</span>
<span class="line-removed"> 66             memcpy(filePath + len + suffixlen - extLen, ext, extLen);</span>
<span class="line-removed"> 67         }</span>
 68 
 69         logFP = fopen(filePath, &quot;w&quot;);
 70         if (logFP == nullptr) {
<span class="line-modified"> 71             PrintDebugString(&quot;couldnot open file %s&quot;, filePath);</span>

 72         }
 73 
 74         delete [] filePath;
 75     }
 76 }
 77 
 78 void finalizeFileLogger() {
 79     if (logFP) {
 80         fclose(logFP);
 81         logFP = nullptr;
 82     }
 83 }
 84 
 85 auto getTimeStamp() -&gt; long long {
 86     using namespace std::chrono;
 87     auto timeNow = duration_cast&lt;milliseconds&gt;(steady_clock::now().time_since_epoch());
 88 
 89     return timeNow.count();
 90 }
 91 
</pre>
<hr />
<pre>
127 
128     /**
129      * Send debugging info to the appropriate place
130      */
131     void PrintDebugString(char *msg, ...) {
132 #ifdef DEBUGGING_ON
133         char buf[1024] = {0};
134         va_list argprt;
135 
136         va_start(argprt, msg);     // set up argptr
137         vsprintf(buf, msg, argprt);
138 #ifdef SEND_TO_OUTPUT_DEBUG_STRING
139         OutputDebugString(buf);
140 #endif
141 #ifdef SEND_TO_CONSOLE
142         printf(buf);
143         printf(&quot;\r\n&quot;);
144 #endif
145 #endif
146         if (logFP) {
<span class="line-modified">147             fprintf(logFP, &quot;[%lldu] &quot;, getTimeStamp());</span>
148             va_list args;
149             va_start(args, msg);
150             vfprintf(logFP, msg, args);
151             va_end(args);
152             fprintf(logFP, &quot;\r\n&quot;);
153         }
154     }
155 
156     /**
157      * Send Java debugging info to the appropriate place
158      */
159     void PrintJavaDebugString2(char *msg, ...) {
160 #ifdef JAVA_DEBUGGING_ON
161         char buf[1024] = {0};
162         va_list argprt;
163 
164         va_start(argprt, msg);     // set up argptr
165         vsprintf(buf, msg, argprt);
166 #ifdef SEND_TO_OUTPUT_DEBUG_STRING
167         OutputDebugString(buf);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
</pre>
<hr />
<pre>
 24  */
 25 
 26 /*
 27  * A class to manage AccessBridge debugging
 28  */
 29 
 30 #include &quot;AccessBridgeDebug.h&quot;
 31 #include &lt;stdarg.h&gt;
 32 #include &lt;stdio.h&gt;
 33 #include &lt;windows.h&gt;
 34 #include &lt;cstdlib&gt;
 35 #include &lt;chrono&gt;
 36 #include &lt;cstring&gt;
 37 
 38 #ifdef __cplusplus
 39 extern &quot;C&quot; {
 40 #endif
 41 
 42 static FILE* logFP = nullptr;
 43 
<span class="line-modified"> 44 void initializeFileLogger(char * fileName) {</span>
<span class="line-modified"> 45     auto var = &quot;JAVA_ACCESSBRIDGE_LOGDIR&quot;;</span>
 46     const auto envfilePath = getenv(var);
<span class="line-modified"> 47     if (envfilePath != nullptr &amp;&amp; fileName != nullptr) {</span>
<span class="line-modified"> 48         auto envFilePathLength = strlen(envfilePath);</span>
<span class="line-modified"> 49         auto fileNameLength = strlen(fileName);</span>
<span class="line-modified"> 50         auto filePathSize = envFilePathLength + 1 + fileNameLength + 5; //1 for &quot;/&quot;, 5 for &quot;.log&quot; and 0;</span>
<span class="line-modified"> 51         auto filePath = new char[filePathSize];</span>
<span class="line-modified"> 52         memset(filePath, 0, filePathSize*sizeof(char));</span>
<span class="line-modified"> 53         memcpy(filePath, envfilePath, envFilePathLength*sizeof(char));</span>
<span class="line-modified"> 54         filePath[envFilePathLength] = &#39;/&#39;;</span>
<span class="line-modified"> 55         memcpy(filePath + envFilePathLength + 1, fileName, fileNameLength*sizeof(char));</span>
<span class="line-modified"> 56         memcpy(filePath + envFilePathLength + 1 + fileNameLength, &quot;.log&quot;, 4*sizeof(char));</span>











 57 
 58         logFP = fopen(filePath, &quot;w&quot;);
 59         if (logFP == nullptr) {
<span class="line-modified"> 60             printf(&quot;\n%s\n&quot;, filePath);</span>
<span class="line-added"> 61             PrintDebugString(&quot;Could not open file %s&quot;, filePath);</span>
 62         }
 63 
 64         delete [] filePath;
 65     }
 66 }
 67 
 68 void finalizeFileLogger() {
 69     if (logFP) {
 70         fclose(logFP);
 71         logFP = nullptr;
 72     }
 73 }
 74 
 75 auto getTimeStamp() -&gt; long long {
 76     using namespace std::chrono;
 77     auto timeNow = duration_cast&lt;milliseconds&gt;(steady_clock::now().time_since_epoch());
 78 
 79     return timeNow.count();
 80 }
 81 
</pre>
<hr />
<pre>
117 
118     /**
119      * Send debugging info to the appropriate place
120      */
121     void PrintDebugString(char *msg, ...) {
122 #ifdef DEBUGGING_ON
123         char buf[1024] = {0};
124         va_list argprt;
125 
126         va_start(argprt, msg);     // set up argptr
127         vsprintf(buf, msg, argprt);
128 #ifdef SEND_TO_OUTPUT_DEBUG_STRING
129         OutputDebugString(buf);
130 #endif
131 #ifdef SEND_TO_CONSOLE
132         printf(buf);
133         printf(&quot;\r\n&quot;);
134 #endif
135 #endif
136         if (logFP) {
<span class="line-modified">137             fprintf(logFP, &quot;[%llu] &quot;, getTimeStamp());</span>
138             va_list args;
139             va_start(args, msg);
140             vfprintf(logFP, msg, args);
141             va_end(args);
142             fprintf(logFP, &quot;\r\n&quot;);
143         }
144     }
145 
146     /**
147      * Send Java debugging info to the appropriate place
148      */
149     void PrintJavaDebugString2(char *msg, ...) {
150 #ifdef JAVA_DEBUGGING_ON
151         char buf[1024] = {0};
152         va_list argprt;
153 
154         va_start(argprt, msg);     // set up argptr
155         vsprintf(buf, msg, argprt);
156 #ifdef SEND_TO_OUTPUT_DEBUG_STRING
157         OutputDebugString(buf);
</pre>
</td>
</tr>
</table>
<center><a href="../../classes/com/sun/java/accessibility/internal/AccessBridge.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="AccessBridgeDebug.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>