<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/utils/WeakObjectPool.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 package com.sun.org.apache.xml.internal.security.utils;
 24 
 25 import java.lang.ref.WeakReference;
 26 import java.util.Collections;
 27 import java.util.Map;
 28 import java.util.WeakHashMap;
 29 import java.util.concurrent.BlockingQueue;
 30 import java.util.concurrent.LinkedBlockingDeque;
 31 
 32 /**
 33  * Abstract base class for pooling objects.  The two public methods are
 34  * {@link #getObject()} and ({@link #repool(Object)}.  Objects are held through
 35  * weak references so even objects that are not repooled are subject to garbage collection.
 36  *
 37  * Subclasses must implement the abstract {@link #createObject()}.
 38  * &lt;p&gt;
 39  *
 40  * Internally, the pool is stored in a java.util.concurrent.LinkedBlockingDeque
 41  * instance.
 42  *
 43  * @deprecated This class is no longer in use in Santuario 2.1.4
 44  */
 45 @Deprecated
 46 public abstract class WeakObjectPool&lt;T, E extends Throwable&gt; {
 47 
 48     private static final Integer MARKER_VALUE = Integer.MAX_VALUE;//once here rather than auto-box it?
 49 
 50     /** created, available objects to be checked out to clients */
 51     private final BlockingQueue&lt;WeakReference&lt;T&gt;&gt; available;
 52 
 53     /**
 54      * Synchronized, identity map of loaned out objects (WeakHashMap);
 55      * use to ensure we repool only object originating from here
 56      * and do it once.
 57      */
 58     private final Map&lt;T, Integer&gt; onLoan;
 59 
 60     /**
 61      * The lone constructor.
 62      */
 63     protected WeakObjectPool() {
 64         //alternative implementations: ArrayBlockingQueue has a fixed size
 65         //  PriorityBlockingQueue: requires a dummy comparator; less memory but more overhead
 66         available = new LinkedBlockingDeque&lt;WeakReference&lt;T&gt;&gt;();
 67         this.onLoan = Collections.synchronizedMap(new WeakHashMap&lt;T, Integer&gt;());
 68     }
 69 
 70     /**
 71      * Called whenever a new pool object is desired; subclasses must implement.
 72      *
 73      * @return object of the type desired by the subclass
 74      * @throws E Throwable&#39;s subclass
 75      */
 76     protected abstract T createObject() throws E;
 77 
 78 
 79     /**
 80      * Subclasses can subclass to return a more specific type.
 81      *
 82      * @return an object from the pool; will block until an object is available
 83      * @throws E
 84      */
 85     public T getObject() throws E {
 86         WeakReference&lt;T&gt; ref;
 87         T retValue = null;
 88         do {
 89             //remove any stale entries as well
 90             ref = available.poll();
 91         } while (ref != null &amp;&amp; (retValue = ref.get()) == null);
 92 
 93         if (retValue == null) {
 94             //empty pool; create &amp; add new one
 95             retValue = createObject();
 96         }
 97         onLoan.put(retValue, MARKER_VALUE);
 98         return retValue;
 99     }
100 
101 
102     /**
103      * Adds the given object to the pool, provided that the object
104      * was created by this pool.
105      *
106      * @param obj the object to return to the pool
107      * @return whether the object was successfully added as available
108      */
109     public boolean repool(T obj) {
110         if (obj != null &amp;&amp; onLoan.containsKey(obj)) {
111             //synchronize to protect against a caller returning the same object again...
112             synchronized (obj) {
113                 //...and check to see that it was removed
114                 if (onLoan.remove(obj) != null) {
115                     return available.offer(new WeakReference&lt;T&gt;(obj));
116                 }
117             }
118         }
119         return false;
120     }
121 }
    </pre>
  </body>
</html>