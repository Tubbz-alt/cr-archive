<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/signature/SignedInfo.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 package com.sun.org.apache.xml.internal.security.signature;
 24 
 25 import java.io.ByteArrayInputStream;
 26 import java.io.IOException;
 27 import java.io.InputStream;
 28 import java.io.OutputStream;
 29 
 30 import javax.crypto.SecretKey;
 31 import javax.crypto.spec.SecretKeySpec;
 32 import javax.xml.parsers.ParserConfigurationException;
 33 
 34 import com.sun.org.apache.xml.internal.security.algorithms.SignatureAlgorithm;
 35 import com.sun.org.apache.xml.internal.security.c14n.CanonicalizationException;
 36 import com.sun.org.apache.xml.internal.security.c14n.Canonicalizer;
 37 import com.sun.org.apache.xml.internal.security.c14n.InvalidCanonicalizerException;
 38 import com.sun.org.apache.xml.internal.security.exceptions.XMLSecurityException;
 39 import com.sun.org.apache.xml.internal.security.transforms.params.InclusiveNamespaces;
 40 import com.sun.org.apache.xml.internal.security.utils.Constants;
 41 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 42 import org.w3c.dom.Document;
 43 import org.w3c.dom.Element;
 44 import org.w3c.dom.Node;
 45 import org.xml.sax.SAXException;
 46 
 47 /**
 48  * Handles {@code &amp;lt;ds:SignedInfo&amp;gt;} elements
 49  * This {@code SignedInfo} element includes the canonicalization algorithm,
 50  * a signature algorithm, and one or more references.
 51  *
 52  */
 53 public class SignedInfo extends Manifest {
 54 
 55     /** Field signatureAlgorithm */
 56     private SignatureAlgorithm signatureAlgorithm;
 57 
 58     /** Field c14nizedBytes           */
 59     private byte[] c14nizedBytes;
 60 
 61     private Element c14nMethod;
 62     private Element signatureMethod;
 63 
 64     /**
 65      * Overwrites {@link Manifest#addDocument} because it creates another
 66      * Element.
 67      *
 68      * @param doc the {@link Document} in which {@code XMLsignature} will
 69      *    be placed
 70      * @throws XMLSecurityException
 71      */
 72     public SignedInfo(Document doc) throws XMLSecurityException {
 73         this(doc, XMLSignature.ALGO_ID_SIGNATURE_DSA,
 74              Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS);
 75     }
 76 
 77     /**
 78      * Constructs {@link SignedInfo} using given Canonicalization algorithm and
 79      * Signature algorithm.
 80      *
 81      * @param doc {@code SignedInfo} is placed in this document
 82      * @param signatureMethodURI URI representation of the Digest and
 83      *    Signature algorithm
 84      * @param canonicalizationMethodURI URI representation of the
 85      *    Canonicalization method
 86      * @throws XMLSecurityException
 87      */
 88     public SignedInfo(
 89         Document doc, String signatureMethodURI, String canonicalizationMethodURI
 90     ) throws XMLSecurityException {
 91         this(doc, signatureMethodURI, 0, canonicalizationMethodURI);
 92     }
 93 
 94     /**
 95      * Constructor SignedInfo
 96      *
 97      * @param doc {@code SignedInfo} is placed in this document
 98      * @param signatureMethodURI URI representation of the Digest and
 99      *    Signature algorithm
100      * @param hMACOutputLength
101      * @param canonicalizationMethodURI URI representation of the
102      *    Canonicalization method
103      * @throws XMLSecurityException
104      */
105     public SignedInfo(
106         Document doc, String signatureMethodURI,
107         int hMACOutputLength, String canonicalizationMethodURI
108     ) throws XMLSecurityException {
109         super(doc);
110 
111         c14nMethod =
112             XMLUtils.createElementInSignatureSpace(getDocument(), Constants._TAG_CANONICALIZATIONMETHOD);
113 
114         c14nMethod.setAttributeNS(null, Constants._ATT_ALGORITHM, canonicalizationMethodURI);
115         appendSelf(c14nMethod);
116         addReturnToSelf();
117 
118         if (hMACOutputLength &gt; 0) {
119             this.signatureAlgorithm =
120                 new SignatureAlgorithm(getDocument(), signatureMethodURI, hMACOutputLength);
121         } else {
122             this.signatureAlgorithm = new SignatureAlgorithm(getDocument(), signatureMethodURI);
123         }
124 
125         signatureMethod = this.signatureAlgorithm.getElement();
126         appendSelf(signatureMethod);
127         addReturnToSelf();
128     }
129 
130     /**
131      * @param doc
132      * @param signatureMethodElem
133      * @param canonicalizationMethodElem
134      * @throws XMLSecurityException
135      */
136     public SignedInfo(
137         Document doc, Element signatureMethodElem, Element canonicalizationMethodElem
138     ) throws XMLSecurityException {
139         super(doc);
140         // Check this?
141         this.c14nMethod = canonicalizationMethodElem;
142         appendSelf(c14nMethod);
143         addReturnToSelf();
144 
145         this.signatureAlgorithm =
146             new SignatureAlgorithm(signatureMethodElem, null);
147 
148         signatureMethod = this.signatureAlgorithm.getElement();
149         appendSelf(signatureMethod);
150 
151         addReturnToSelf();
152     }
153 
154     /**
155      * Build a {@link SignedInfo} from an {@link Element}
156      *
157      * @param element {@code SignedInfo}
158      * @param baseURI the URI of the resource where the XML instance was stored
159      * @throws XMLSecurityException
160      * @see &lt;A HREF=&quot;http://lists.w3.org/Archives/Public/w3c-ietf-xmldsig/2001OctDec/0033.html&quot;&gt;
161      * Question&lt;/A&gt;
162      * @see &lt;A HREF=&quot;http://lists.w3.org/Archives/Public/w3c-ietf-xmldsig/2001OctDec/0054.html&quot;&gt;
163      * Answer&lt;/A&gt;
164      */
165     public SignedInfo(Element element, String baseURI) throws XMLSecurityException {
166         this(element, baseURI, true);
167     }
168 
169     /**
170      * Build a {@link SignedInfo} from an {@link Element}
171      *
172      * @param element {@code SignedInfo}
173      * @param baseURI the URI of the resource where the XML instance was stored
174      * @param secureValidation whether secure validation is enabled or not
175      * @throws XMLSecurityException
176      * @see &lt;A HREF=&quot;http://lists.w3.org/Archives/Public/w3c-ietf-xmldsig/2001OctDec/0033.html&quot;&gt;
177      * Question&lt;/A&gt;
178      * @see &lt;A HREF=&quot;http://lists.w3.org/Archives/Public/w3c-ietf-xmldsig/2001OctDec/0054.html&quot;&gt;
179      * Answer&lt;/A&gt;
180      */
181     public SignedInfo(
182         Element element, String baseURI, boolean secureValidation
183     ) throws XMLSecurityException {
184         // Parse the Reference children and Id attribute in the Manifest
185         super(reparseSignedInfoElem(element, secureValidation), baseURI, secureValidation);
186 
187         c14nMethod = XMLUtils.getNextElement(element.getFirstChild());
188         signatureMethod = XMLUtils.getNextElement(c14nMethod.getNextSibling());
189         this.signatureAlgorithm =
190             new SignatureAlgorithm(signatureMethod, this.getBaseURI(), secureValidation);
191     }
192 
193     private static Element reparseSignedInfoElem(Element element, boolean secureValidation)
194         throws XMLSecurityException {
195         /*
196          * If a custom canonicalizationMethod is used, canonicalize
197          * ds:SignedInfo, reparse it into a new document
198          * and replace the original not-canonicalized ds:SignedInfo by
199          * the re-parsed canonicalized one.
200          */
201         Element c14nMethod = XMLUtils.getNextElement(element.getFirstChild());
202         String c14nMethodURI =
203             c14nMethod.getAttributeNS(null, Constants._ATT_ALGORITHM);
204         if (!(c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS) ||
205             c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS) ||
206             c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N_EXCL_OMIT_COMMENTS) ||
207             c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N_EXCL_WITH_COMMENTS) ||
208             c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N11_OMIT_COMMENTS) ||
209             c14nMethodURI.equals(Canonicalizer.ALGO_ID_C14N11_WITH_COMMENTS))) {
210             // the c14n is not a secure one and can rewrite the URIs or like
211             // so reparse the SignedInfo to be sure
212             try {
213                 Canonicalizer c14nizer =
214                     Canonicalizer.getInstance(c14nMethodURI);
215                 c14nizer.setSecureValidation(secureValidation);
216 
217                 byte[] c14nizedBytes = c14nizer.canonicalizeSubtree(element);
218                 try (InputStream is = new ByteArrayInputStream(c14nizedBytes)) {
219                     Document newdoc = XMLUtils.read(is, secureValidation);
220                     Node imported = element.getOwnerDocument().importNode(
221                             newdoc.getDocumentElement(), true);
222                     element.getParentNode().replaceChild(imported, element);
223                     return (Element) imported;
224                 }
225             } catch (ParserConfigurationException ex) {
226                 throw new XMLSecurityException(ex);
227             } catch (IOException ex) {
228                 throw new XMLSecurityException(ex);
229             } catch (SAXException ex) {
230                 throw new XMLSecurityException(ex);
231             }
232         }
233         return element;
234     }
235 
236     /**
237      * Tests core validation process
238      *
239      * @return true if verification was successful
240      * @throws MissingResourceFailureException
241      * @throws XMLSecurityException
242      */
243     public boolean verify()
244         throws MissingResourceFailureException, XMLSecurityException {
245         return super.verifyReferences(false);
246     }
247 
248     /**
249      * Tests core validation process
250      *
251      * @param followManifests defines whether the verification process has to verify referenced {@code ds:Manifest}s, too
252      * @return true if verification was successful
253      * @throws MissingResourceFailureException
254      * @throws XMLSecurityException
255      */
256     public boolean verify(boolean followManifests)
257         throws MissingResourceFailureException, XMLSecurityException {
258         return super.verifyReferences(followManifests);
259     }
260 
261     /**
262      * Returns getCanonicalizedOctetStream
263      *
264      * @return the canonicalization result octet stream of {@code SignedInfo} element
265      * @throws CanonicalizationException
266      * @throws InvalidCanonicalizerException
267      * @throws XMLSecurityException
268      */
269     public byte[] getCanonicalizedOctetStream()
270         throws CanonicalizationException, InvalidCanonicalizerException, XMLSecurityException {
271         if (this.c14nizedBytes == null) {
272             Canonicalizer c14nizer =
273                 Canonicalizer.getInstance(this.getCanonicalizationMethodURI());
274             c14nizer.setSecureValidation(isSecureValidation());
275 
276             String inclusiveNamespaces = this.getInclusiveNamespaces();
277             if (inclusiveNamespaces == null) {
278                 this.c14nizedBytes = c14nizer.canonicalizeSubtree(getElement());
279             } else {
280                 this.c14nizedBytes = c14nizer.canonicalizeSubtree(getElement(), inclusiveNamespaces);
281             }
282         }
283 
284         // make defensive copy
285         return this.c14nizedBytes.clone();
286     }
287 
288     /**
289      * Output the C14n stream to the given OutputStream.
290      * @param os
291      * @throws CanonicalizationException
292      * @throws InvalidCanonicalizerException
293      * @throws XMLSecurityException
294      */
295     public void signInOctetStream(OutputStream os)
296         throws CanonicalizationException, InvalidCanonicalizerException, XMLSecurityException {
297         if (this.c14nizedBytes == null) {
298             Canonicalizer c14nizer =
299                 Canonicalizer.getInstance(this.getCanonicalizationMethodURI());
300             c14nizer.setSecureValidation(isSecureValidation());
301             c14nizer.setWriter(os);
302             String inclusiveNamespaces = this.getInclusiveNamespaces();
303 
304             if (inclusiveNamespaces == null) {
305                 c14nizer.canonicalizeSubtree(getElement());
306             } else {
307                 c14nizer.canonicalizeSubtree(getElement(), inclusiveNamespaces);
308             }
309         } else {
310             try {
311                 os.write(this.c14nizedBytes);
312             } catch (IOException e) {
313                 throw new RuntimeException(e);
314             }
315         }
316     }
317 
318     /**
319      * Returns the Canonicalization method URI
320      *
321      * @return the Canonicalization method URI
322      */
323     public String getCanonicalizationMethodURI() {
324         return c14nMethod.getAttributeNS(null, Constants._ATT_ALGORITHM);
325     }
326 
327     /**
328      * Returns the Signature method URI
329      *
330      * @return the Signature method URI
331      */
332     public String getSignatureMethodURI() {
333         Element signatureElement = this.getSignatureMethodElement();
334 
335         if (signatureElement != null) {
336             return signatureElement.getAttributeNS(null, Constants._ATT_ALGORITHM);
337         }
338 
339         return null;
340     }
341 
342     /**
343      * Method getSignatureMethodElement
344      * @return returns the SignatureMethod Element
345      *
346      */
347     public Element getSignatureMethodElement() {
348         return signatureMethod;
349     }
350 
351     /**
352      * Creates a SecretKey for the appropriate Mac algorithm based on a
353      * byte[] array password.
354      *
355      * @param secretKeyBytes
356      * @return the secret key for the SignedInfo element.
357      */
358     public SecretKey createSecretKey(byte[] secretKeyBytes) {
359         return new SecretKeySpec(secretKeyBytes, this.signatureAlgorithm.getJCEAlgorithmString());
360     }
361 
362     public SignatureAlgorithm getSignatureAlgorithm() {
363         return signatureAlgorithm;
364     }
365 
366     /**
367      * Method getBaseLocalName
368      * {@inheritDoc}
369      *
370      */
371     public String getBaseLocalName() {
372         return Constants._TAG_SIGNEDINFO;
373     }
374 
375     public String getInclusiveNamespaces() {
376         String c14nMethodURI = getCanonicalizationMethodURI();
377         if (!(c14nMethodURI.equals(&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;) ||
378             c14nMethodURI.equals(&quot;http://www.w3.org/2001/10/xml-exc-c14n#WithComments&quot;))) {
379             return null;
380         }
381 
382         Element inclusiveElement = XMLUtils.getNextElement(c14nMethod.getFirstChild());
383 
384         if (inclusiveElement != null) {
385             try {
386                 String inclusiveNamespaces =
387                     new InclusiveNamespaces(
388                         inclusiveElement,
389                         InclusiveNamespaces.ExclusiveCanonicalizationNamespace
390                     ).getInclusiveNamespaces();
391                 return inclusiveNamespaces;
392             } catch (XMLSecurityException e) {
393                 return null;
394             }
395         }
396         return null;
397     }
398 }
    </pre>
  </body>
</html>