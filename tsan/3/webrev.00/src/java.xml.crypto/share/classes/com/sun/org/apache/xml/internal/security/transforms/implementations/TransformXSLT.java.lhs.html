<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/transforms/implementations/TransformXSLT.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 package com.sun.org.apache.xml.internal.security.transforms.implementations;
 24 
 25 import java.io.ByteArrayInputStream;
 26 import java.io.ByteArrayOutputStream;
 27 import java.io.IOException;
 28 import java.io.InputStream;
 29 import java.io.OutputStream;
 30 
 31 import javax.xml.XMLConstants;
 32 import javax.xml.transform.Source;
 33 import javax.xml.transform.Transformer;
 34 import javax.xml.transform.TransformerConfigurationException;
 35 import javax.xml.transform.TransformerException;
 36 import javax.xml.transform.TransformerFactory;
 37 import javax.xml.transform.dom.DOMSource;
 38 import javax.xml.transform.stream.StreamResult;
 39 import javax.xml.transform.stream.StreamSource;
 40 
 41 import com.sun.org.apache.xml.internal.security.exceptions.XMLSecurityException;
 42 import com.sun.org.apache.xml.internal.security.signature.XMLSignatureInput;
 43 import com.sun.org.apache.xml.internal.security.transforms.Transform;
 44 import com.sun.org.apache.xml.internal.security.transforms.TransformSpi;
 45 import com.sun.org.apache.xml.internal.security.transforms.TransformationException;
 46 import com.sun.org.apache.xml.internal.security.transforms.Transforms;
 47 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 48 import org.w3c.dom.Element;
 49 
 50 /**
 51  * Class TransformXSLT
 52  *
 53  * Implements the {@code http://www.w3.org/TR/1999/REC-xslt-19991116}
 54  * transform.
 55  *
 56  */
 57 public class TransformXSLT extends TransformSpi {
 58 
 59     /** Field implementedTransformURI */
 60     public static final String implementedTransformURI =
 61         Transforms.TRANSFORM_XSLT;
 62 
 63     static final String XSLTSpecNS = &quot;http://www.w3.org/1999/XSL/Transform&quot;;
 64     static final String defaultXSLTSpecNSprefix = &quot;xslt&quot;;
 65     static final String XSLTSTYLESHEET = &quot;stylesheet&quot;;
 66 
 67     private static final com.sun.org.slf4j.internal.Logger LOG =
 68         com.sun.org.slf4j.internal.LoggerFactory.getLogger(TransformXSLT.class);
 69 
 70     /**
 71      * Method engineGetURI
 72      *
 73      * {@inheritDoc}
 74      */
 75     protected String engineGetURI() {
 76         return implementedTransformURI;
 77     }
 78 
 79     protected XMLSignatureInput enginePerformTransform(
 80         XMLSignatureInput input, OutputStream baos, Transform transformObject
 81     ) throws IOException, TransformationException {
 82         try {
 83             Element transformElement = transformObject.getElement();
 84 
 85             Element xsltElement =
 86                 XMLUtils.selectNode(transformElement.getFirstChild(), XSLTSpecNS, &quot;stylesheet&quot;, 0);
<a name="1" id="anc1"></a><span class="line-modified"> 87 </span>



 88             if (xsltElement == null) {
 89                 Object exArgs[] = { &quot;xslt:stylesheet&quot;, &quot;Transform&quot; };
 90 
 91                 throw new TransformationException(&quot;xml.WrongContent&quot;, exArgs);
 92             }
 93 
 94             TransformerFactory tFactory = TransformerFactory.newInstance();
 95             // Process XSLT stylesheets in a secure manner
 96             tFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, Boolean.TRUE);
 97 
 98             /*
 99              * This transform requires an octet stream as input. If the actual
100              * input is an XPath node-set, then the signature application should
101              * attempt to convert it to octets (apply Canonical XML]) as described
102              * in the Reference Processing Model (section 4.3.3.2).
103              */
104             Source stylesheet;
105 
106             /*
107              * This complicated transformation of the stylesheet itself is necessary
108              * because of the need to get the pure style sheet. If we simply say
109              * Source stylesheet = new DOMSource(this.xsltElement);
110              * whereby this.xsltElement is not the rootElement of the Document,
111              * this causes problems;
112              * so we convert the stylesheet to byte[] and use this as input stream
113              */
114             {
115                 try (ByteArrayOutputStream os = new ByteArrayOutputStream()) {
116                     Transformer transformer = tFactory.newTransformer();
117                     DOMSource source = new DOMSource(xsltElement);
118                     StreamResult result = new StreamResult(os);
119 
120                     transformer.transform(source, result);
121 
122                     stylesheet =
123                         new StreamSource(new ByteArrayInputStream(os.toByteArray()));
124                 }
125             }
126 
127             Transformer transformer = tFactory.newTransformer(stylesheet);
128 
129             // Force Xalan to use \n as line separator on all OSes. This
130             // avoids OS specific signature validation failures due to line
131             // separator differences in the transformed output. Unfortunately,
132             // this is not a standard JAXP property so will not work with non-Xalan
133             // implementations.
134             try {
135                 transformer.setOutputProperty(&quot;{http://xml.apache.org/xalan}line-separator&quot;, &quot;\n&quot;);
136             } catch (Exception e) {
137                 LOG.warn(&quot;Unable to set Xalan line-separator property: &quot; + e.getMessage());
138             }
139 
140             try (InputStream is = new ByteArrayInputStream(input.getBytes())) {
141                 Source xmlSource = new StreamSource(is);
142                 if (baos == null) {
143                     try (ByteArrayOutputStream baos1 = new ByteArrayOutputStream()) {
144                         StreamResult outputTarget = new StreamResult(baos1);
145                         transformer.transform(xmlSource, outputTarget);
146                         XMLSignatureInput output = new XMLSignatureInput(baos1.toByteArray());
147                         output.setSecureValidation(secureValidation);
148                         return output;
149                     }
150                 }
151                 StreamResult outputTarget = new StreamResult(baos);
152 
153                 transformer.transform(xmlSource, outputTarget);
154             }
155             XMLSignatureInput output = new XMLSignatureInput((byte[])null);
156             output.setSecureValidation(secureValidation);
157             output.setOutputStream(baos);
158             return output;
159         } catch (XMLSecurityException ex) {
160             throw new TransformationException(ex);
161         } catch (TransformerConfigurationException ex) {
162             throw new TransformationException(ex);
163         } catch (TransformerException ex) {
164             throw new TransformationException(ex);
165         }
166     }
167 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>