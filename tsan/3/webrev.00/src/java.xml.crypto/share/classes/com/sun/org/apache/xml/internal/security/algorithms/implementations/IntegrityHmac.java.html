<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/algorithms/implementations/IntegrityHmac.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 package com.sun.org.apache.xml.internal.security.algorithms.implementations;
 24 
 25 import java.security.InvalidAlgorithmParameterException;
 26 import java.security.InvalidKeyException;
 27 import java.security.Key;
 28 import java.security.SecureRandom;
 29 import java.security.spec.AlgorithmParameterSpec;
 30 
 31 import javax.crypto.Mac;
 32 import javax.crypto.SecretKey;
 33 
 34 import com.sun.org.apache.xml.internal.security.algorithms.JCEMapper;
 35 import com.sun.org.apache.xml.internal.security.algorithms.MessageDigestAlgorithm;
 36 import com.sun.org.apache.xml.internal.security.algorithms.SignatureAlgorithmSpi;
 37 import com.sun.org.apache.xml.internal.security.signature.XMLSignature;
 38 import com.sun.org.apache.xml.internal.security.signature.XMLSignatureException;
 39 import com.sun.org.apache.xml.internal.security.utils.Constants;
 40 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 41 import org.w3c.dom.Document;
 42 import org.w3c.dom.Element;
 43 import org.w3c.dom.Node;
 44 import org.w3c.dom.Text;
 45 
 46 public abstract class IntegrityHmac extends SignatureAlgorithmSpi {
 47 
 48     private static final com.sun.org.slf4j.internal.Logger LOG =
 49         com.sun.org.slf4j.internal.LoggerFactory.getLogger(IntegrityHmac.class);
 50 
 51     /** Field macAlgorithm */
 52     private Mac macAlgorithm;
 53 
 54     /** Field HMACOutputLength */
 55     private int HMACOutputLength;
 56     private boolean HMACOutputLengthSet = false;
 57 
 58     /**
 59      * Method engineGetURI
 60      *
 61      *{@inheritDoc}
 62      */
 63     public abstract String engineGetURI();
 64 
 65     /**
 66      * Returns the output length of the hash/digest.
 67      */
 68     abstract int getDigestLength();
 69 
 70     /**
 71      * Method IntegrityHmac
 72      *
 73      * @throws XMLSignatureException
 74      */
 75     public IntegrityHmac() throws XMLSignatureException {
 76         String algorithmID = JCEMapper.translateURItoJCEID(this.engineGetURI());
 77         LOG.debug(&quot;Created IntegrityHmacSHA1 using {}&quot;, algorithmID);
 78 
 79         try {
 80             this.macAlgorithm = Mac.getInstance(algorithmID);
 81         } catch (java.security.NoSuchAlgorithmException ex) {
 82             Object[] exArgs = { algorithmID, ex.getLocalizedMessage() };
 83 
 84             throw new XMLSignatureException(&quot;algorithms.NoSuchAlgorithm&quot;, exArgs);
 85         }
 86     }
 87 
 88     /**
 89      * Proxy method for {@link java.security.Signature#setParameter(
 90      * java.security.spec.AlgorithmParameterSpec)}
 91      * which is executed on the internal {@link java.security.Signature} object.
 92      *
 93      * @param params
 94      * @throws XMLSignatureException
 95      */
 96     protected void engineSetParameter(AlgorithmParameterSpec params) throws XMLSignatureException {
 97         throw new XMLSignatureException(&quot;empty&quot;, new Object[]{&quot;Incorrect method call&quot;});
 98     }
 99 
100     public void reset() {
101         HMACOutputLength = 0;
102         HMACOutputLengthSet = false;
103         this.macAlgorithm.reset();
104     }
105 
106     /**
107      * Proxy method for {@link java.security.Signature#verify(byte[])}
108      * which is executed on the internal {@link java.security.Signature} object.
109      *
110      * @param signature
111      * @return true if the signature is correct
112      * @throws XMLSignatureException
113      */
114     protected boolean engineVerify(byte[] signature) throws XMLSignatureException {
115         try {
116             if (this.HMACOutputLengthSet &amp;&amp; this.HMACOutputLength &lt; getDigestLength()) {
117                 LOG.debug(&quot;HMACOutputLength must not be less than {}&quot;, getDigestLength());
118                 Object[] exArgs = { String.valueOf(getDigestLength()) };
119                 throw new XMLSignatureException(&quot;algorithms.HMACOutputLengthMin&quot;, exArgs);
120             } else {
121                 byte[] completeResult = this.macAlgorithm.doFinal();
122                 return MessageDigestAlgorithm.isEqual(completeResult, signature);
123             }
124         } catch (IllegalStateException ex) {
125             throw new XMLSignatureException(ex);
126         }
127     }
128 
129     /**
130      * Proxy method for {@link java.security.Signature#initVerify(java.security.PublicKey)}
131      * which is executed on the internal {@link java.security.Signature} object.
132      *
133      * @param secretKey
134      * @throws XMLSignatureException
135      */
136     protected void engineInitVerify(Key secretKey) throws XMLSignatureException {
137         if (!(secretKey instanceof SecretKey)) {
138             String supplied = null;
139             if (secretKey != null) {
140                 supplied = secretKey.getClass().getName();
141             }
142             String needed = SecretKey.class.getName();
143             Object exArgs[] = { supplied, needed };
144 
145             throw new XMLSignatureException(&quot;algorithms.WrongKeyForThisOperation&quot;, exArgs);
146         }
147 
148         try {
149             this.macAlgorithm.init(secretKey);
150         } catch (InvalidKeyException ex) {
151             // reinstantiate Mac object to work around bug in JDK
152             // see: http://bugs.java.com/view_bug.do?bug_id=4953555
153             Mac mac = this.macAlgorithm;
154             try {
155                 this.macAlgorithm = Mac.getInstance(macAlgorithm.getAlgorithm());
156             } catch (Exception e) {
157                 // this shouldn&#39;t occur, but if it does, restore previous Mac
158                 LOG.debug(&quot;Exception when reinstantiating Mac: {}&quot;, e);
159                 this.macAlgorithm = mac;
160             }
161             throw new XMLSignatureException(ex);
162         }
163     }
164 
165     /**
166      * Proxy method for {@link java.security.Signature#sign()}
167      * which is executed on the internal {@link java.security.Signature} object.
168      *
169      * @return the result of the {@link java.security.Signature#sign()} method
170      * @throws XMLSignatureException
171      */
172     protected byte[] engineSign() throws XMLSignatureException {
173         try {
174             if (this.HMACOutputLengthSet &amp;&amp; this.HMACOutputLength &lt; getDigestLength()) {
175                 LOG.debug(&quot;HMACOutputLength must not be less than {}&quot;, getDigestLength());
176                 Object[] exArgs = { String.valueOf(getDigestLength()) };
177                 throw new XMLSignatureException(&quot;algorithms.HMACOutputLengthMin&quot;, exArgs);
178             } else {
179                 return this.macAlgorithm.doFinal();
180             }
181         } catch (IllegalStateException ex) {
182             throw new XMLSignatureException(ex);
183         }
184     }
185 
186     /**
187      * Method engineInitSign
188      *
189      * @param secretKey
190      * @throws XMLSignatureException
191      */
192     protected void engineInitSign(Key secretKey) throws XMLSignatureException {
193         engineInitSign(secretKey, (AlgorithmParameterSpec)null);
194     }
195 
196     /**
197      * Method engineInitSign
198      *
199      * @param secretKey
200      * @param algorithmParameterSpec
201      * @throws XMLSignatureException
202      */
203     protected void engineInitSign(
204         Key secretKey, AlgorithmParameterSpec algorithmParameterSpec
205     ) throws XMLSignatureException {
206         if (!(secretKey instanceof SecretKey)) {
207             String supplied = null;
208             if (secretKey != null) {
209                 supplied = secretKey.getClass().getName();
210             }
211             String needed = SecretKey.class.getName();
212             Object exArgs[] = { supplied, needed };
213 
214             throw new XMLSignatureException(&quot;algorithms.WrongKeyForThisOperation&quot;, exArgs);
215         }
216 
217         try {
218             if (algorithmParameterSpec == null) {
219                 this.macAlgorithm.init(secretKey);
220             } else {
221                 this.macAlgorithm.init(secretKey, algorithmParameterSpec);
222             }
223         } catch (InvalidKeyException ex) {
224             throw new XMLSignatureException(ex);
225         } catch (InvalidAlgorithmParameterException ex) {
226             throw new XMLSignatureException(ex);
227         }
228     }
229 
230     /**
231      * Method engineInitSign
232      *
233      * @param secretKey
234      * @param secureRandom
235      * @throws XMLSignatureException
236      */
237     protected void engineInitSign(Key secretKey, SecureRandom secureRandom)
238         throws XMLSignatureException {
239         throw new XMLSignatureException(&quot;algorithms.CannotUseSecureRandomOnMAC&quot;);
240     }
241 
242     /**
243      * Proxy method for {@link java.security.Signature#update(byte[])}
244      * which is executed on the internal {@link java.security.Signature} object.
245      *
246      * @param input
247      * @throws XMLSignatureException
248      */
249     protected void engineUpdate(byte[] input) throws XMLSignatureException {
250         try {
251             this.macAlgorithm.update(input);
252         } catch (IllegalStateException ex) {
253             throw new XMLSignatureException(ex);
254         }
255     }
256 
257     /**
258      * Proxy method for {@link java.security.Signature#update(byte)}
259      * which is executed on the internal {@link java.security.Signature} object.
260      *
261      * @param input
262      * @throws XMLSignatureException
263      */
264     protected void engineUpdate(byte input) throws XMLSignatureException {
265         try {
266             this.macAlgorithm.update(input);
267         } catch (IllegalStateException ex) {
268             throw new XMLSignatureException(ex);
269         }
270     }
271 
272     /**
273      * Proxy method for {@link java.security.Signature#update(byte[], int, int)}
274      * which is executed on the internal {@link java.security.Signature} object.
275      *
276      * @param buf
277      * @param offset
278      * @param len
279      * @throws XMLSignatureException
280      */
281     protected void engineUpdate(byte buf[], int offset, int len) throws XMLSignatureException {
282         try {
283             this.macAlgorithm.update(buf, offset, len);
284         } catch (IllegalStateException ex) {
285             throw new XMLSignatureException(ex);
286         }
287     }
288 
289     /**
290      * Method engineGetJCEAlgorithmString
291      * {@inheritDoc}
292      *
293      */
294     protected String engineGetJCEAlgorithmString() {
295         return this.macAlgorithm.getAlgorithm();
296     }
297 
298     /**
299      * Method engineGetJCEAlgorithmString
300      *
301      * {@inheritDoc}
302      */
303     protected String engineGetJCEProviderName() {
304         return this.macAlgorithm.getProvider().getName();
305     }
306 
307     /**
308      * Method engineSetHMACOutputLength
309      *
310      * @param HMACOutputLength
311      */
312     protected void engineSetHMACOutputLength(int HMACOutputLength) {
313         this.HMACOutputLength = HMACOutputLength;
314         this.HMACOutputLengthSet = true;
315     }
316 
317     /**
318      * Method engineGetContextFromElement
319      *
320      * @param element
321      */
322     protected void engineGetContextFromElement(Element element) {
323         super.engineGetContextFromElement(element);
324 
325         if (element == null) {
326             throw new IllegalArgumentException(&quot;element null&quot;);
327         }
328 
329         Node n = XMLUtils.selectDsNode(element.getFirstChild(), Constants._TAG_HMACOUTPUTLENGTH, 0);
330         if (n != null) {
331             String hmacLength = XMLUtils.getFullTextChildrenFromNode(n);
332             if (hmacLength != null &amp;&amp; !&quot;&quot;.equals(hmacLength)) {
333                 this.HMACOutputLength = Integer.parseInt(hmacLength);
334                 this.HMACOutputLengthSet = true;
335             }
336         }
337     }
338 
339     /**
340      * Method engineAddContextToElement
341      *
342      * @param element
343      */
344     public void engineAddContextToElement(Element element) {
345         if (element == null) {
346             throw new IllegalArgumentException(&quot;null element&quot;);
347         }
348 
349         if (this.HMACOutputLengthSet) {
350             Document doc = element.getOwnerDocument();
351             Element HMElem =
352                 XMLUtils.createElementInSignatureSpace(doc, Constants._TAG_HMACOUTPUTLENGTH);
353             Text HMText =
354                 doc.createTextNode(&quot;&quot; + this.HMACOutputLength);
355 
356             HMElem.appendChild(HMText);
357             XMLUtils.addReturnToElement(element);
358             element.appendChild(HMElem);
359             XMLUtils.addReturnToElement(element);
360         }
361     }
362 
363     /**
364      * Class IntegrityHmacSHA1
365      */
366     public static class IntegrityHmacSHA1 extends IntegrityHmac {
367 
368         /**
369          * Constructor IntegrityHmacSHA1
370          *
371          * @throws XMLSignatureException
372          */
373         public IntegrityHmacSHA1() throws XMLSignatureException {
374             super();
375         }
376 
377         /**
378          * Method engineGetURI
379          * {@inheritDoc}
380          *
381          */
382         public String engineGetURI() {
383             return XMLSignature.ALGO_ID_MAC_HMAC_SHA1;
384         }
385 
386         int getDigestLength() {
387             return 160;
388         }
389     }
390 
391     /**
392      * Class IntegrityHmacSHA224
393      */
394     public static class IntegrityHmacSHA224 extends IntegrityHmac {
395 
396         /**
397          * Constructor IntegrityHmacSHA224
398          *
399          * @throws XMLSignatureException
400          */
401         public IntegrityHmacSHA224() throws XMLSignatureException {
402             super();
403         }
404 
405         /**
406          * Method engineGetURI
407          *
408          * {@inheritDoc}
409          */
410         public String engineGetURI() {
411             return XMLSignature.ALGO_ID_MAC_HMAC_SHA224;
412         }
413 
414         int getDigestLength() {
415             return 224;
416         }
417     }
418 
419     /**
420      * Class IntegrityHmacSHA256
421      */
422     public static class IntegrityHmacSHA256 extends IntegrityHmac {
423 
424         /**
425          * Constructor IntegrityHmacSHA256
426          *
427          * @throws XMLSignatureException
428          */
429         public IntegrityHmacSHA256() throws XMLSignatureException {
430             super();
431         }
432 
433         /**
434          * Method engineGetURI
435          *
436          * {@inheritDoc}
437          */
438         public String engineGetURI() {
439             return XMLSignature.ALGO_ID_MAC_HMAC_SHA256;
440         }
441 
442         int getDigestLength() {
443             return 256;
444         }
445     }
446 
447     /**
448      * Class IntegrityHmacSHA384
449      */
450     public static class IntegrityHmacSHA384 extends IntegrityHmac {
451 
452         /**
453          * Constructor IntegrityHmacSHA384
454          *
455          * @throws XMLSignatureException
456          */
457         public IntegrityHmacSHA384() throws XMLSignatureException {
458             super();
459         }
460 
461         /**
462          * Method engineGetURI
463          * {@inheritDoc}
464          *
465          */
466         public String engineGetURI() {
467             return XMLSignature.ALGO_ID_MAC_HMAC_SHA384;
468         }
469 
470         int getDigestLength() {
471             return 384;
472         }
473     }
474 
475     /**
476      * Class IntegrityHmacSHA512
477      */
478     public static class IntegrityHmacSHA512 extends IntegrityHmac {
479 
480         /**
481          * Constructor IntegrityHmacSHA512
482          *
483          * @throws XMLSignatureException
484          */
485         public IntegrityHmacSHA512() throws XMLSignatureException {
486             super();
487         }
488 
489         /**
490          * Method engineGetURI
491          * {@inheritDoc}
492          *
493          */
494         public String engineGetURI() {
495             return XMLSignature.ALGO_ID_MAC_HMAC_SHA512;
496         }
497 
498         int getDigestLength() {
499             return 512;
500         }
501     }
502 
503     /**
504      * Class IntegrityHmacRIPEMD160
505      */
506     public static class IntegrityHmacRIPEMD160 extends IntegrityHmac {
507 
508         /**
509          * Constructor IntegrityHmacRIPEMD160
510          *
511          * @throws XMLSignatureException
512          */
513         public IntegrityHmacRIPEMD160() throws XMLSignatureException {
514             super();
515         }
516 
517         /**
518          * Method engineGetURI
519          *
520          * {@inheritDoc}
521          */
522         public String engineGetURI() {
523             return XMLSignature.ALGO_ID_MAC_HMAC_RIPEMD160;
524         }
525 
526         int getDigestLength() {
527             return 160;
528         }
529     }
530 
531     /**
532      * Class IntegrityHmacMD5
533      */
534     public static class IntegrityHmacMD5 extends IntegrityHmac {
535 
536         /**
537          * Constructor IntegrityHmacMD5
538          *
539          * @throws XMLSignatureException
540          */
541         public IntegrityHmacMD5() throws XMLSignatureException {
542             super();
543         }
544 
545         /**
546          * Method engineGetURI
547          *
548          * {@inheritDoc}
549          */
550         public String engineGetURI() {
551             return XMLSignature.ALGO_ID_MAC_HMAC_NOT_RECOMMENDED_MD5;
552         }
553 
554         int getDigestLength() {
555             return 128;
556         }
557     }
558 }
    </pre>
  </body>
</html>