<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/utils/XMLUtils.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="WeakObjectPool.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="resolver/ResourceResolver.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/utils/XMLUtils.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -21,20 +21,26 @@</span>
   * under the License.
   */
  package com.sun.org.apache.xml.internal.security.utils;
  
  import java.io.IOException;
<span class="udiff-line-added">+ import java.io.InputStream;</span>
  import java.io.OutputStream;
  import java.math.BigInteger;
  import java.security.AccessController;
  import java.security.PrivilegedAction;
  import java.util.ArrayList;
  import java.util.Base64;
<span class="udiff-line-added">+ import java.util.Collections;</span>
  import java.util.HashSet;
  import java.util.Iterator;
  import java.util.List;
<span class="udiff-line-added">+ import java.util.Map;</span>
<span class="udiff-line-added">+ import java.util.Queue;</span>
  import java.util.Set;
<span class="udiff-line-added">+ import java.util.WeakHashMap;</span>
<span class="udiff-line-added">+ import java.util.concurrent.ArrayBlockingQueue;</span>
  
  import javax.xml.parsers.DocumentBuilder;
  import javax.xml.parsers.DocumentBuilderFactory;
  import javax.xml.parsers.ParserConfigurationException;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,29 +52,39 @@</span>
  import org.w3c.dom.Element;
  import org.w3c.dom.NamedNodeMap;
  import org.w3c.dom.Node;
  import org.w3c.dom.NodeList;
  import org.w3c.dom.Text;
<span class="udiff-line-added">+ import org.xml.sax.InputSource;</span>
<span class="udiff-line-added">+ import org.xml.sax.SAXException;</span>
  
  /**
   * DOM and XML accessibility and comfort functions.
   *
   */
  public final class XMLUtils {
  
      private static boolean ignoreLineBreaks =
          AccessController.doPrivileged(
              (PrivilegedAction&lt;Boolean&gt;) () -&gt; Boolean.getBoolean(&quot;com.sun.org.apache.xml.internal.security.ignoreLineBreaks&quot;));
<span class="udiff-line-added">+     private static int parserPoolSize =</span>
<span class="udiff-line-added">+         AccessController.doPrivileged(</span>
<span class="udiff-line-added">+             (PrivilegedAction&lt;Integer&gt;) () -&gt; Integer.getInteger(&quot;com.sun.org.apache.xml.internal.security.parser.pool-size&quot;, 20));</span>
  
      private static volatile String dsPrefix = &quot;ds&quot;;
      private static volatile String ds11Prefix = &quot;dsig11&quot;;
      private static volatile String xencPrefix = &quot;xenc&quot;;
      private static volatile String xenc11Prefix = &quot;xenc11&quot;;
  
      private static final com.sun.org.slf4j.internal.Logger LOG =
          com.sun.org.slf4j.internal.LoggerFactory.getLogger(XMLUtils.class);
  
<span class="udiff-line-added">+     private static final Map&lt;ClassLoader, Queue&lt;DocumentBuilder&gt;&gt; DOCUMENT_BUILDERS =</span>
<span class="udiff-line-added">+         Collections.synchronizedMap(new WeakHashMap&lt;ClassLoader, Queue&lt;DocumentBuilder&gt;&gt;());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static final Map&lt;ClassLoader, Queue&lt;DocumentBuilder&gt;&gt; DOCUMENT_BUILDERS_DISALLOW_DOCTYPE =</span>
<span class="udiff-line-added">+         Collections.synchronizedMap(new WeakHashMap&lt;ClassLoader, Queue&lt;DocumentBuilder&gt;&gt;());</span>
  
      /**
       * Constructor XMLUtils
       *
       */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -145,11 +161,11 @@</span>
      private static void getSetRec(final Node rootNode, final Set&lt;Node&gt; result,
                                  final Node exclude, final boolean com) {
          if (rootNode == exclude) {
              return;
          }
<span class="udiff-line-modified-removed">-         switch (rootNode.getNodeType()) {</span>
<span class="udiff-line-modified-added">+         switch (rootNode.getNodeType()) { //NOPMD</span>
          case Node.ELEMENT_NODE:
              result.add(rootNode);
              Element el = (Element)rootNode;
              if (el.hasAttributes()) {
                  NamedNodeMap nl = el.getAttributes();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,24 +186,23 @@</span>
                          return;
                      }
                  }
                  getSetRec(r, result, exclude, com);
              }
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-added">+             break;</span>
          case Node.COMMENT_NODE:
              if (com) {
                  result.add(rootNode);
              }
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-added">+             break;</span>
          case Node.DOCUMENT_TYPE_NODE:
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-added">+             break;</span>
          default:
              result.add(rootNode);
          }
      }
  
<span class="udiff-line-removed">- </span>
      /**
       * Outputs a DOM tree to an {@link OutputStream}.
       *
       * @param contextNode root node of the DOM tree
       * @param os the {@link OutputStream}
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -252,20 +267,25 @@</span>
              LOG.debug(ex.getMessage(), ex);
              // throw new RuntimeException(ex.getMessage());
          }
      }
  
<span class="udiff-line-added">+     @Deprecated</span>
<span class="udiff-line-added">+     public static String getFullTextChildrenFromElement(Element element) {</span>
<span class="udiff-line-added">+         return getFullTextChildrenFromNode(element);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
<span class="udiff-line-modified-removed">-      * Method getFullTextChildrenFromElement</span>
<span class="udiff-line-modified-added">+      * Method getFullTextChildrenFromNode</span>
       *
<span class="udiff-line-modified-removed">-      * @param element</span>
<span class="udiff-line-modified-added">+      * @param node</span>
       * @return the string of children
       */
<span class="udiff-line-modified-removed">-     public static String getFullTextChildrenFromElement(Element element) {</span>
<span class="udiff-line-modified-added">+     public static String getFullTextChildrenFromNode(Node node) {</span>
          StringBuilder sb = new StringBuilder();
  
<span class="udiff-line-modified-removed">-         Node child = element.getFirstChild();</span>
<span class="udiff-line-modified-added">+         Node child = node.getFirstChild();</span>
          while (child != null) {
              if (child.getNodeType() == Node.TEXT_NODE) {
                  sb.append(((Text)child).getData());
              }
              child = child.getNextSibling();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -680,11 +700,11 @@</span>
       */
      public static Element selectNode(Node sibling, String uri, String nodeName, int number) {
          while (sibling != null) {
              if (sibling.getNamespaceURI() != null &amp;&amp; sibling.getNamespaceURI().equals(uri)
                  &amp;&amp; sibling.getLocalName().equals(nodeName)) {
<span class="udiff-line-modified-removed">-                 if (number == 0){</span>
<span class="udiff-line-modified-added">+                 if (number == 0) {</span>
                      return (Element)sibling;
                  }
                  number--;
              }
              sibling = sibling.getNextSibling();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -953,30 +973,125 @@</span>
              }
          }
          return true;
      }
  
<span class="udiff-line-modified-removed">-     public static DocumentBuilder createDocumentBuilder(boolean validating)</span>
<span class="udiff-line-modified-removed">-             throws ParserConfigurationException {</span>
<span class="udiff-line-modified-added">+     public static Document newDocument() throws ParserConfigurationException {</span>
<span class="udiff-line-modified-added">+         ClassLoader loader = getContextClassLoader();</span>
<span class="udiff-line-added">+         if (loader == null) {</span>
<span class="udiff-line-added">+             loader = getClassLoader(XMLUtils.class);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         // If the ClassLoader is null then just create a DocumentBuilder and use it</span>
<span class="udiff-line-added">+         if (loader == null) {</span>
<span class="udiff-line-added">+             DocumentBuilder documentBuilder = buildDocumentBuilder(true);</span>
<span class="udiff-line-added">+             return documentBuilder.newDocument();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Queue&lt;DocumentBuilder&gt; queue = getDocumentBuilderQueue(true, loader);</span>
<span class="udiff-line-added">+         DocumentBuilder documentBuilder = getDocumentBuilder(true, queue);</span>
<span class="udiff-line-added">+         Document doc = documentBuilder.newDocument();</span>
<span class="udiff-line-added">+         repoolDocumentBuilder(documentBuilder, queue);</span>
<span class="udiff-line-added">+         return doc;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static Document read(InputStream inputStream) throws ParserConfigurationException, SAXException, IOException {</span>
<span class="udiff-line-added">+         return read(inputStream, true);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static Document read(InputStream inputStream, boolean disAllowDocTypeDeclarations) throws ParserConfigurationException, SAXException, IOException {</span>
<span class="udiff-line-added">+         ClassLoader loader = getContextClassLoader();</span>
<span class="udiff-line-added">+         if (loader == null) {</span>
<span class="udiff-line-added">+             loader = getClassLoader(XMLUtils.class);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         // If the ClassLoader is null then just create a DocumentBuilder and use it</span>
<span class="udiff-line-added">+         if (loader == null) {</span>
<span class="udiff-line-added">+             DocumentBuilder documentBuilder = buildDocumentBuilder(disAllowDocTypeDeclarations);</span>
<span class="udiff-line-added">+             return documentBuilder.parse(inputStream);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Queue&lt;DocumentBuilder&gt; queue = getDocumentBuilderQueue(disAllowDocTypeDeclarations, loader);</span>
<span class="udiff-line-added">+         DocumentBuilder documentBuilder = getDocumentBuilder(disAllowDocTypeDeclarations, queue);</span>
<span class="udiff-line-added">+         Document doc = documentBuilder.parse(inputStream);</span>
<span class="udiff-line-added">+         repoolDocumentBuilder(documentBuilder, queue);</span>
<span class="udiff-line-added">+         return doc;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static Document read(String uri, boolean disAllowDocTypeDeclarations)</span>
<span class="udiff-line-added">+         throws ParserConfigurationException, SAXException, IOException {</span>
<span class="udiff-line-added">+         ClassLoader loader = getContextClassLoader();</span>
<span class="udiff-line-added">+         if (loader == null) {</span>
<span class="udiff-line-added">+             loader = getClassLoader(XMLUtils.class);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         // If the ClassLoader is null then just create a DocumentBuilder and use it</span>
<span class="udiff-line-added">+         if (loader == null) {</span>
<span class="udiff-line-added">+             DocumentBuilder documentBuilder = buildDocumentBuilder(disAllowDocTypeDeclarations);</span>
<span class="udiff-line-added">+             return documentBuilder.parse(uri);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Queue&lt;DocumentBuilder&gt; queue = getDocumentBuilderQueue(disAllowDocTypeDeclarations, loader);</span>
<span class="udiff-line-added">+         DocumentBuilder documentBuilder = getDocumentBuilder(disAllowDocTypeDeclarations, queue);</span>
<span class="udiff-line-added">+         Document doc = documentBuilder.parse(uri);</span>
<span class="udiff-line-added">+         repoolDocumentBuilder(documentBuilder, queue);</span>
<span class="udiff-line-added">+         return doc;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static Document read(InputSource inputSource) throws ParserConfigurationException, SAXException, IOException {</span>
<span class="udiff-line-added">+         return read(inputSource, true);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static Document read(InputSource inputSource, boolean disAllowDocTypeDeclarations)</span>
<span class="udiff-line-added">+         throws ParserConfigurationException, SAXException, IOException {</span>
<span class="udiff-line-added">+         ClassLoader loader = getContextClassLoader();</span>
<span class="udiff-line-added">+         if (loader == null) {</span>
<span class="udiff-line-added">+             loader = getClassLoader(XMLUtils.class);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         // If the ClassLoader is null then just create a DocumentBuilder and use it</span>
<span class="udiff-line-added">+         if (loader == null) {</span>
<span class="udiff-line-added">+             DocumentBuilder documentBuilder = buildDocumentBuilder(disAllowDocTypeDeclarations);</span>
<span class="udiff-line-added">+             return documentBuilder.parse(inputSource);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Queue&lt;DocumentBuilder&gt; queue = getDocumentBuilderQueue(disAllowDocTypeDeclarations, loader);</span>
<span class="udiff-line-added">+         DocumentBuilder documentBuilder = getDocumentBuilder(disAllowDocTypeDeclarations, queue);</span>
<span class="udiff-line-added">+         Document doc = documentBuilder.parse(inputSource);</span>
<span class="udiff-line-added">+         repoolDocumentBuilder(documentBuilder, queue);</span>
<span class="udiff-line-added">+         return doc;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * @deprecated Use XMLUtils.read instead to directly read a document.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Deprecated</span>
<span class="udiff-line-added">+     public static DocumentBuilder createDocumentBuilder(boolean validating) throws ParserConfigurationException {</span>
          return createDocumentBuilder(validating, true);
      }
  
<span class="udiff-line-modified-removed">-     // The current implementation does not throw a ParserConfigurationException.</span>
<span class="udiff-line-modified-removed">-     // Kept here in case we create the DocumentBuilder inline again.</span>
<span class="udiff-line-modified-added">+     /**</span>
<span class="udiff-line-modified-added">+      * @deprecated Use XMLUtils.read instead to directly read a document.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Deprecated</span>
      public static DocumentBuilder createDocumentBuilder(
          boolean validating, boolean disAllowDocTypeDeclarations
      ) throws ParserConfigurationException {
          DocumentBuilderFactory dfactory = DocumentBuilderFactory.newInstance();
<span class="udiff-line-modified-removed">-         dfactory.setFeature(javax.xml.XMLConstants.FEATURE_SECURE_PROCESSING, true);</span>
<span class="udiff-line-modified-added">+         dfactory.setFeature(javax.xml.XMLConstants.FEATURE_SECURE_PROCESSING, Boolean.TRUE);</span>
          if (disAllowDocTypeDeclarations) {
              dfactory.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;, true);
          }
          dfactory.setValidating(validating);
          dfactory.setNamespaceAware(true);
          return dfactory.newDocumentBuilder();
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * @deprecated This method has no effect in Santuario 2.1.4</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Deprecated</span>
<span class="udiff-line-added">+     public static boolean repoolDocumentBuilder(DocumentBuilder db) {</span>
<span class="udiff-line-added">+         return true;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Returns a byte-array representation of a {@code {@link BigInteger}}.
       * No sign-bit is output.
       *
       * &lt;b&gt;N.B.:&lt;/B&gt; {@code {@link BigInteger}}&#39;s toByteArray
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1017,6 +1132,66 @@</span>
  
          System.arraycopy(bigBytes, startSrc, resizedBytes, startDst, bigLen);
  
          return resizedBytes;
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static Queue&lt;DocumentBuilder&gt; getDocumentBuilderQueue(boolean disAllowDocTypeDeclarations, ClassLoader loader) throws ParserConfigurationException {</span>
<span class="udiff-line-added">+         Map&lt;ClassLoader, Queue&lt;DocumentBuilder&gt;&gt; docBuilderCache =</span>
<span class="udiff-line-added">+             disAllowDocTypeDeclarations ? DOCUMENT_BUILDERS_DISALLOW_DOCTYPE : DOCUMENT_BUILDERS;</span>
<span class="udiff-line-added">+         Queue&lt;DocumentBuilder&gt; queue = docBuilderCache.get(loader);</span>
<span class="udiff-line-added">+         if (queue == null) {</span>
<span class="udiff-line-added">+             queue = new ArrayBlockingQueue&lt;&gt;(parserPoolSize);</span>
<span class="udiff-line-added">+             docBuilderCache.put(loader, queue);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return queue;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static DocumentBuilder getDocumentBuilder(boolean disAllowDocTypeDeclarations, Queue&lt;DocumentBuilder&gt; queue) throws ParserConfigurationException {</span>
<span class="udiff-line-added">+         DocumentBuilder db = queue.poll();</span>
<span class="udiff-line-added">+         if (db == null) {</span>
<span class="udiff-line-added">+             db = buildDocumentBuilder(disAllowDocTypeDeclarations);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return db;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static DocumentBuilder buildDocumentBuilder(boolean disAllowDocTypeDeclarations) throws ParserConfigurationException {</span>
<span class="udiff-line-added">+         DocumentBuilderFactory f = DocumentBuilderFactory.newInstance();</span>
<span class="udiff-line-added">+         f.setNamespaceAware(true);</span>
<span class="udiff-line-added">+         f.setFeature(javax.xml.XMLConstants.FEATURE_SECURE_PROCESSING, true);</span>
<span class="udiff-line-added">+         f.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;, disAllowDocTypeDeclarations);</span>
<span class="udiff-line-added">+         return f.newDocumentBuilder();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void repoolDocumentBuilder(DocumentBuilder db, Queue&lt;DocumentBuilder&gt; queue) {</span>
<span class="udiff-line-added">+         if (queue != null) {</span>
<span class="udiff-line-added">+             db.reset();</span>
<span class="udiff-line-added">+             queue.offer(db);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static ClassLoader getContextClassLoader() {</span>
<span class="udiff-line-added">+         final SecurityManager sm = System.getSecurityManager();</span>
<span class="udiff-line-added">+         if (sm != null) {</span>
<span class="udiff-line-added">+             return AccessController.doPrivileged(new PrivilegedAction&lt;ClassLoader&gt;() {</span>
<span class="udiff-line-added">+                 public ClassLoader run() {</span>
<span class="udiff-line-added">+                     return Thread.currentThread().getContextClassLoader();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return Thread.currentThread().getContextClassLoader();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static ClassLoader getClassLoader(final Class&lt;?&gt; clazz) {</span>
<span class="udiff-line-added">+         final SecurityManager sm = System.getSecurityManager();</span>
<span class="udiff-line-added">+         if (sm != null) {</span>
<span class="udiff-line-added">+             return AccessController.doPrivileged(new PrivilegedAction&lt;ClassLoader&gt;() {</span>
<span class="udiff-line-added">+                 public ClassLoader run() {</span>
<span class="udiff-line-added">+                     return clazz.getClassLoader();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             });</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return clazz.getClassLoader();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
  }
</pre>
<center><a href="WeakObjectPool.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="resolver/ResourceResolver.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>