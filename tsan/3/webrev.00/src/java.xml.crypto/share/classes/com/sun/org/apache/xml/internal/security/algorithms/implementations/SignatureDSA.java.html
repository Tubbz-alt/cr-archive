<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/algorithms/implementations/SignatureDSA.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 package com.sun.org.apache.xml.internal.security.algorithms.implementations;
 24 
 25 import java.io.IOException;
 26 import java.security.InvalidAlgorithmParameterException;
 27 import java.security.InvalidKeyException;
 28 import java.security.Key;
 29 import java.security.PrivateKey;
 30 import java.security.PublicKey;
 31 import java.security.SecureRandom;
 32 import java.security.Signature;
 33 import java.security.SignatureException;
 34 import java.security.interfaces.DSAKey;
 35 import java.security.spec.AlgorithmParameterSpec;
 36 
 37 import com.sun.org.apache.xml.internal.security.algorithms.JCEMapper;
 38 import com.sun.org.apache.xml.internal.security.algorithms.SignatureAlgorithmSpi;
 39 import com.sun.org.apache.xml.internal.security.signature.XMLSignature;
 40 import com.sun.org.apache.xml.internal.security.signature.XMLSignatureException;
 41 import com.sun.org.apache.xml.internal.security.utils.Constants;
 42 import com.sun.org.apache.xml.internal.security.utils.JavaUtils;
 43 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 44 
 45 public class SignatureDSA extends SignatureAlgorithmSpi {
 46 
 47     public static final String URI = Constants.SignatureSpecNS + &quot;dsa-sha1&quot;;
 48 
 49     private static final com.sun.org.slf4j.internal.Logger LOG =
 50         com.sun.org.slf4j.internal.LoggerFactory.getLogger(SignatureDSA.class);
 51 
 52     /** Field algorithm */
 53     private Signature signatureAlgorithm;
 54 
 55     /** size of Q */
 56     private int size;
 57 
 58     /**
 59      * Method engineGetURI
 60      *
 61      * {@inheritDoc}
 62      */
 63     protected String engineGetURI() {
 64         return XMLSignature.ALGO_ID_SIGNATURE_DSA;
 65     }
 66 
 67     /**
 68      * Constructor SignatureDSA
 69      *
 70      * @throws XMLSignatureException
 71      */
 72     public SignatureDSA() throws XMLSignatureException {
 73         String algorithmID = JCEMapper.translateURItoJCEID(engineGetURI());
 74         LOG.debug(&quot;Created SignatureDSA using {}&quot;, algorithmID);
 75 
 76         String provider = JCEMapper.getProviderId();
 77         try {
 78             if (provider == null) {
 79                 this.signatureAlgorithm = Signature.getInstance(algorithmID);
 80             } else {
 81                 this.signatureAlgorithm =
 82                     Signature.getInstance(algorithmID, provider);
 83             }
 84         } catch (java.security.NoSuchAlgorithmException ex) {
 85             Object[] exArgs = { algorithmID, ex.getLocalizedMessage() };
 86             throw new XMLSignatureException(&quot;algorithms.NoSuchAlgorithm&quot;, exArgs);
 87         } catch (java.security.NoSuchProviderException ex) {
 88             Object[] exArgs = { algorithmID, ex.getLocalizedMessage() };
 89             throw new XMLSignatureException(&quot;algorithms.NoSuchAlgorithm&quot;, exArgs);
 90         }
 91     }
 92 
 93     /**
 94      * {@inheritDoc}
 95      */
 96     protected void engineSetParameter(AlgorithmParameterSpec params)
 97         throws XMLSignatureException {
 98         try {
 99             this.signatureAlgorithm.setParameter(params);
100         } catch (InvalidAlgorithmParameterException ex) {
101             throw new XMLSignatureException(ex);
102         }
103     }
104 
105     /**
106      * {@inheritDoc}
107      */
108     protected boolean engineVerify(byte[] signature)
109         throws XMLSignatureException {
110         try {
111             if (LOG.isDebugEnabled()) {
112                 LOG.debug(&quot;Called DSA.verify() on &quot; + XMLUtils.encodeToString(signature));
113             }
114 
115             byte[] jcebytes = JavaUtils.convertDsaXMLDSIGtoASN1(signature,
116                                                                 size/8);
117 
118             return this.signatureAlgorithm.verify(jcebytes);
119         } catch (SignatureException ex) {
120             throw new XMLSignatureException(ex);
121         } catch (IOException ex) {
122             throw new XMLSignatureException(ex);
123         }
124     }
125 
126     /**
127      * {@inheritDoc}
128      */
129     protected void engineInitVerify(Key publicKey) throws XMLSignatureException {
130         if (!(publicKey instanceof PublicKey)) {
131             String supplied = null;
132             if (publicKey != null) {
133                 supplied = publicKey.getClass().getName();
134             }
135             String needed = PublicKey.class.getName();
136             Object exArgs[] = { supplied, needed };
137 
138             throw new XMLSignatureException(&quot;algorithms.WrongKeyForThisOperation&quot;, exArgs);
139         }
140 
141         try {
142             this.signatureAlgorithm.initVerify((PublicKey) publicKey);
143         } catch (InvalidKeyException ex) {
144             // reinstantiate Signature object to work around bug in JDK
145             // see: http://bugs.java.com/view_bug.do?bug_id=4953555
146             Signature sig = this.signatureAlgorithm;
147             try {
148                 this.signatureAlgorithm = Signature.getInstance(signatureAlgorithm.getAlgorithm());
149             } catch (Exception e) {
150                 // this shouldn&#39;t occur, but if it does, restore previous
151                 // Signature
152                 LOG.debug(&quot;Exception when reinstantiating Signature: {}&quot;, e);
153                 this.signatureAlgorithm = sig;
154             }
155             throw new XMLSignatureException(ex);
156         }
157         size = ((DSAKey)publicKey).getParams().getQ().bitLength();
158     }
159 
160     /**
161      * {@inheritDoc}
162      */
163     protected byte[] engineSign() throws XMLSignatureException {
164         try {
165             byte jcebytes[] = this.signatureAlgorithm.sign();
166 
167             return JavaUtils.convertDsaASN1toXMLDSIG(jcebytes, size/8);
168         } catch (IOException ex) {
169             throw new XMLSignatureException(ex);
170         } catch (SignatureException ex) {
171             throw new XMLSignatureException(ex);
172         }
173     }
174 
175     /**
176      * {@inheritDoc}
177      */
178     protected void engineInitSign(Key privateKey, SecureRandom secureRandom)
179         throws XMLSignatureException {
180         if (!(privateKey instanceof PrivateKey)) {
181             String supplied = null;
182             if (privateKey != null) {
183                 supplied = privateKey.getClass().getName();
184             }
185             String needed = PrivateKey.class.getName();
186             Object exArgs[] = { supplied, needed };
187 
188             throw new XMLSignatureException(&quot;algorithms.WrongKeyForThisOperation&quot;, exArgs);
189         }
190 
191         try {
192             if (secureRandom == null) {
193                 this.signatureAlgorithm.initSign((PrivateKey) privateKey);
194             } else {
195                 this.signatureAlgorithm.initSign((PrivateKey) privateKey, secureRandom);
196             }
197         } catch (InvalidKeyException ex) {
198             throw new XMLSignatureException(ex);
199         }
200         size = ((DSAKey)privateKey).getParams().getQ().bitLength();
201     }
202 
203     /**
204      * {@inheritDoc}
205      */
206     protected void engineInitSign(Key privateKey) throws XMLSignatureException {
207         engineInitSign(privateKey, (SecureRandom)null);
208     }
209 
210     /**
211      * {@inheritDoc}
212      */
213     protected void engineUpdate(byte[] input) throws XMLSignatureException {
214         try {
215             this.signatureAlgorithm.update(input);
216         } catch (SignatureException ex) {
217             throw new XMLSignatureException(ex);
218         }
219     }
220 
221     /**
222      * {@inheritDoc}
223      */
224     protected void engineUpdate(byte input) throws XMLSignatureException {
225         try {
226             this.signatureAlgorithm.update(input);
227         } catch (SignatureException ex) {
228             throw new XMLSignatureException(ex);
229         }
230     }
231 
232     /**
233      * {@inheritDoc}
234      */
235     protected void engineUpdate(byte buf[], int offset, int len) throws XMLSignatureException {
236         try {
237             this.signatureAlgorithm.update(buf, offset, len);
238         } catch (SignatureException ex) {
239             throw new XMLSignatureException(ex);
240         }
241     }
242 
243     /**
244      * Method engineGetJCEAlgorithmString
245      *
246      * {@inheritDoc}
247      */
248     protected String engineGetJCEAlgorithmString() {
249         return this.signatureAlgorithm.getAlgorithm();
250     }
251 
252     /**
253      * Method engineGetJCEProviderName
254      *
255      * {@inheritDoc}
256      */
257     protected String engineGetJCEProviderName() {
258         return this.signatureAlgorithm.getProvider().getName();
259     }
260 
261     /**
262      * Method engineSetHMACOutputLength
263      *
264      * @param HMACOutputLength
265      * @throws XMLSignatureException
266      */
267     protected void engineSetHMACOutputLength(int HMACOutputLength) throws XMLSignatureException {
268         throw new XMLSignatureException(&quot;algorithms.HMACOutputLengthOnlyForHMAC&quot;);
269     }
270 
271     /**
272      * Method engineInitSign
273      *
274      * @param signingKey
275      * @param algorithmParameterSpec
276      * @throws XMLSignatureException
277      */
278     protected void engineInitSign(
279         Key signingKey, AlgorithmParameterSpec algorithmParameterSpec
280     ) throws XMLSignatureException {
281         throw new XMLSignatureException(&quot;algorithms.CannotUseAlgorithmParameterSpecOnDSA&quot;);
282     }
283 
284     public static class SHA256 extends SignatureDSA {
285 
286         public SHA256() throws XMLSignatureException {
287             super();
288         }
289 
290         public String engineGetURI() {
291             return XMLSignature.ALGO_ID_SIGNATURE_DSA_SHA256;
292         }
293     }
294 }
    </pre>
  </body>
</html>