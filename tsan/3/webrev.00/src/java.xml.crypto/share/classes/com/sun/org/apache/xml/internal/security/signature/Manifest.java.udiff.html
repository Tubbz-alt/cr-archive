<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/signature/Manifest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../resource/config.xml.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="Reference.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/signature/Manifest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -21,11 +21,14 @@</span>
   * under the License.
   */
  package com.sun.org.apache.xml.internal.security.signature;
  
  import java.io.IOException;
<span class="udiff-line-added">+ import java.security.AccessController;</span>
<span class="udiff-line-added">+ import java.security.PrivilegedAction;</span>
  import java.util.ArrayList;
<span class="udiff-line-added">+ import java.util.Collections;</span>
  import java.util.HashMap;
  import java.util.Iterator;
  import java.util.List;
  import java.util.Map;
  import java.util.Set;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -54,23 +57,28 @@</span>
   * &lt;p&gt; This element holds the {@code Reference} elements&lt;/p&gt;
   */
  public class Manifest extends SignatureElementProxy {
  
      /**
<span class="udiff-line-modified-removed">-      * The maximum number of references per Manifest, if secure validation is enabled.</span>
<span class="udiff-line-modified-added">+      * The default maximum number of references per Manifest, if secure validation is enabled.</span>
       */
      public static final int MAXIMUM_REFERENCE_COUNT = 30;
  
      private static final com.sun.org.slf4j.internal.Logger LOG =
          com.sun.org.slf4j.internal.LoggerFactory.getLogger(Manifest.class);
  
<span class="udiff-line-added">+     private static Integer referenceCount =</span>
<span class="udiff-line-added">+         AccessController.doPrivileged(</span>
<span class="udiff-line-added">+             (PrivilegedAction&lt;Integer&gt;) () -&gt; Integer.parseInt(System.getProperty(&quot;com.sun.org.apache.xml.internal.security.maxReferences&quot;,</span>
<span class="udiff-line-added">+                                                                 Integer.toString(MAXIMUM_REFERENCE_COUNT))));</span>
<span class="udiff-line-added">+ </span>
      /** Field references */
      private List&lt;Reference&gt; references;
      private Element[] referencesEl;
  
      /** Field verificationResults[] */
<span class="udiff-line-modified-removed">-     private boolean[] verificationResults;</span>
<span class="udiff-line-modified-added">+     private List&lt;VerifiedReference&gt; verificationResults;</span>
  
      /** Field resolverProperties */
      private Map&lt;String, String&gt; resolverProperties;
  
      /** Field perManifestResolvers */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -133,12 +141,12 @@</span>
  
              throw new DOMException(DOMException.WRONG_DOCUMENT_ERR,
                                     I18n.translate(&quot;xml.WrongContent&quot;, exArgs));
          }
  
<span class="udiff-line-modified-removed">-         if (secureValidation &amp;&amp; le &gt; MAXIMUM_REFERENCE_COUNT) {</span>
<span class="udiff-line-modified-removed">-             Object exArgs[] = { le, MAXIMUM_REFERENCE_COUNT };</span>
<span class="udiff-line-modified-added">+         if (secureValidation &amp;&amp; le &gt; referenceCount) {</span>
<span class="udiff-line-modified-added">+             Object exArgs[] = { le, referenceCount };</span>
  
              throw new XMLSecurityException(&quot;signature.tooManyReferences&quot;, exArgs);
          }
  
          // create List
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -315,17 +323,17 @@</span>
          LOG.debug(&quot;I am {} requested to follow nested Manifests&quot;, (followManifests
              ? &quot;&quot; : &quot;not&quot;));
          if (referencesEl.length == 0) {
              throw new XMLSecurityException(&quot;empty&quot;, new Object[]{&quot;References are empty&quot;});
          }
<span class="udiff-line-modified-removed">-         if (secureValidation &amp;&amp; referencesEl.length &gt; MAXIMUM_REFERENCE_COUNT) {</span>
<span class="udiff-line-modified-removed">-             Object exArgs[] = { referencesEl.length, MAXIMUM_REFERENCE_COUNT };</span>
<span class="udiff-line-modified-added">+         if (secureValidation &amp;&amp; referencesEl.length &gt; referenceCount) {</span>
<span class="udiff-line-modified-added">+             Object exArgs[] = { referencesEl.length, referenceCount };</span>
  
              throw new XMLSecurityException(&quot;signature.tooManyReferences&quot;, exArgs);
          }
  
<span class="udiff-line-modified-removed">-         this.verificationResults = new boolean[referencesEl.length];</span>
<span class="udiff-line-modified-added">+         this.verificationResults = new ArrayList&lt;&gt;(referencesEl.length);</span>
          boolean verify = true;
          for (int i = 0; i &lt; this.referencesEl.length; i++) {
              Reference currentRef =
                  new Reference(referencesEl[i], this.baseURI, this, secureValidation);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -333,17 +341,17 @@</span>
  
              // if only one item does not verify, the whole verification fails
              try {
                  boolean currentRefVerified = currentRef.verify();
  
<span class="udiff-line-removed">-                 this.setVerificationResult(i, currentRefVerified);</span>
<span class="udiff-line-removed">- </span>
                  if (!currentRefVerified) {
                      verify = false;
                  }
                  LOG.debug(&quot;The Reference has Type {}&quot;, currentRef.getType());
  
<span class="udiff-line-added">+                 List&lt;VerifiedReference&gt; manifestReferences = Collections.emptyList();</span>
<span class="udiff-line-added">+ </span>
                  // was verification successful till now and do we want to verify the Manifest?
                  if (verify &amp;&amp; followManifests &amp;&amp; currentRef.typeIsReferenceToManifest()) {
                      LOG.debug(&quot;We have to follow a nested Manifest&quot;);
  
                      try {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -391,18 +399,22 @@</span>
  
                              LOG.warn(&quot;The nested Manifest was invalid (bad)&quot;);
                          } else {
                              LOG.debug(&quot;The nested Manifest was valid (good)&quot;);
                          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                         manifestReferences = referencedManifest.getVerificationResults();</span>
                      } catch (IOException ex) {
                          throw new ReferenceNotInitializedException(ex);
                      } catch (ParserConfigurationException ex) {
                          throw new ReferenceNotInitializedException(ex);
                      } catch (SAXException ex) {
                          throw new ReferenceNotInitializedException(ex);
                      }
                  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 verificationResults.add(new VerifiedReference(currentRefVerified, currentRef.getURI(), manifestReferences));</span>
              } catch (ReferenceNotInitializedException ex) {
                  Object exArgs[] = { currentRef.getURI() };
  
                  throw new MissingResourceFailureException(
                      ex, currentRef, &quot;signature.Verification.Reference.NoInput&quot;, exArgs
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -411,24 +423,10 @@</span>
          }
  
          return verify;
      }
  
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Method setVerificationResult</span>
<span class="udiff-line-removed">-      *</span>
<span class="udiff-line-removed">-      * @param index</span>
<span class="udiff-line-removed">-      * @param verify</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     private void setVerificationResult(int index, boolean verify) {</span>
<span class="udiff-line-removed">-         if (this.verificationResults == null) {</span>
<span class="udiff-line-removed">-             this.verificationResults = new boolean[this.getLength()];</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         this.verificationResults[index] = verify;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      /**
       * After verifying a {@link Manifest} or a {@link SignedInfo} using the
       * {@link Manifest#verifyReferences()} or {@link SignedInfo#verify()} methods,
       * the individual results can be retrieved with this method.
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -453,18 +451,28 @@</span>
              } catch (Exception ex) {
                  throw new XMLSecurityException(ex);
              }
          }
  
<span class="udiff-line-modified-removed">-         return this.verificationResults[index];</span>
<span class="udiff-line-modified-added">+         return ((ArrayList&lt;VerifiedReference&gt;)verificationResults).get(index).isValid();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Get the list of verification result objects</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public List&lt;VerifiedReference&gt; getVerificationResults() {</span>
<span class="udiff-line-added">+         if (verificationResults == null) {</span>
<span class="udiff-line-added">+             return Collections.emptyList();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return Collections.unmodifiableList(verificationResults);</span>
      }
  
      /**
       * Adds Resource Resolver for retrieving resources at specified {@code URI} attribute
       * in {@code reference} element
       *
<span class="udiff-line-modified-removed">-      * @param resolver {@link ResourceResolver} can provide the implemenatin subclass of</span>
<span class="udiff-line-modified-added">+      * @param resolver {@link ResourceResolver} can provide the implementation subclass of</span>
       * {@link ResourceResolverSpi} for retrieving resource.
       */
      public void addResourceResolver(ResourceResolver resolver) {
          if (resolver == null) {
              return;
</pre>
<center><a href="../resource/config.xml.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="Reference.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>