<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.xml.crypto/share/classes/com/sun/org/apache/xml/internal/security/algorithms/implementations/IntegrityHmac.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 package com.sun.org.apache.xml.internal.security.algorithms.implementations;
 24 
 25 import java.security.InvalidAlgorithmParameterException;
 26 import java.security.InvalidKeyException;
 27 import java.security.Key;
 28 import java.security.SecureRandom;
 29 import java.security.spec.AlgorithmParameterSpec;
 30 
 31 import javax.crypto.Mac;
 32 import javax.crypto.SecretKey;
 33 
 34 import com.sun.org.apache.xml.internal.security.algorithms.JCEMapper;
 35 import com.sun.org.apache.xml.internal.security.algorithms.MessageDigestAlgorithm;
 36 import com.sun.org.apache.xml.internal.security.algorithms.SignatureAlgorithmSpi;
 37 import com.sun.org.apache.xml.internal.security.signature.XMLSignature;
 38 import com.sun.org.apache.xml.internal.security.signature.XMLSignatureException;
 39 import com.sun.org.apache.xml.internal.security.utils.Constants;
 40 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 41 import org.w3c.dom.Document;
 42 import org.w3c.dom.Element;
 43 import org.w3c.dom.Text;
 44 
 45 public abstract class IntegrityHmac extends SignatureAlgorithmSpi {
 46 
 47     private static final com.sun.org.slf4j.internal.Logger LOG =
 48         com.sun.org.slf4j.internal.LoggerFactory.getLogger(IntegrityHmac.class);
 49 
 50     /** Field macAlgorithm */
 51     private Mac macAlgorithm;
 52 
 53     /** Field HMACOutputLength */
 54     private int HMACOutputLength;
 55     private boolean HMACOutputLengthSet = false;
 56 
 57     /**
 58      * Method engineGetURI
 59      *
 60      *{@inheritDoc}
 61      */
 62     public abstract String engineGetURI();
 63 
 64     /**
 65      * Returns the output length of the hash/digest.
 66      */
 67     abstract int getDigestLength();
 68 
 69     /**
 70      * Method IntegrityHmac
 71      *
 72      * @throws XMLSignatureException
 73      */
 74     public IntegrityHmac() throws XMLSignatureException {
 75         String algorithmID = JCEMapper.translateURItoJCEID(this.engineGetURI());
 76         LOG.debug(&quot;Created IntegrityHmacSHA1 using {}&quot;, algorithmID);
 77 
 78         try {
 79             this.macAlgorithm = Mac.getInstance(algorithmID);
 80         } catch (java.security.NoSuchAlgorithmException ex) {
 81             Object[] exArgs = { algorithmID, ex.getLocalizedMessage() };
 82 
 83             throw new XMLSignatureException(&quot;algorithms.NoSuchAlgorithm&quot;, exArgs);
 84         }
 85     }
 86 
 87     /**
 88      * Proxy method for {@link java.security.Signature#setParameter(
 89      * java.security.spec.AlgorithmParameterSpec)}
 90      * which is executed on the internal {@link java.security.Signature} object.
 91      *
 92      * @param params
 93      * @throws XMLSignatureException
 94      */
 95     protected void engineSetParameter(AlgorithmParameterSpec params) throws XMLSignatureException {
 96         throw new XMLSignatureException(&quot;empty&quot;, new Object[]{&quot;Incorrect method call&quot;});
 97     }
 98 
 99     public void reset() {
100         HMACOutputLength = 0;
101         HMACOutputLengthSet = false;
102         this.macAlgorithm.reset();
103     }
104 
105     /**
106      * Proxy method for {@link java.security.Signature#verify(byte[])}
107      * which is executed on the internal {@link java.security.Signature} object.
108      *
109      * @param signature
110      * @return true if the signature is correct
111      * @throws XMLSignatureException
112      */
113     protected boolean engineVerify(byte[] signature) throws XMLSignatureException {
114         try {
115             if (this.HMACOutputLengthSet &amp;&amp; this.HMACOutputLength &lt; getDigestLength()) {
116                 LOG.debug(&quot;HMACOutputLength must not be less than {}&quot;, getDigestLength());
117                 Object[] exArgs = { String.valueOf(getDigestLength()) };
118                 throw new XMLSignatureException(&quot;algorithms.HMACOutputLengthMin&quot;, exArgs);
119             } else {
120                 byte[] completeResult = this.macAlgorithm.doFinal();
121                 return MessageDigestAlgorithm.isEqual(completeResult, signature);
122             }
123         } catch (IllegalStateException ex) {
124             throw new XMLSignatureException(ex);
125         }
126     }
127 
128     /**
129      * Proxy method for {@link java.security.Signature#initVerify(java.security.PublicKey)}
130      * which is executed on the internal {@link java.security.Signature} object.
131      *
132      * @param secretKey
133      * @throws XMLSignatureException
134      */
135     protected void engineInitVerify(Key secretKey) throws XMLSignatureException {
136         if (!(secretKey instanceof SecretKey)) {
137             String supplied = null;
138             if (secretKey != null) {
139                 supplied = secretKey.getClass().getName();
140             }
141             String needed = SecretKey.class.getName();
142             Object exArgs[] = { supplied, needed };
143 
144             throw new XMLSignatureException(&quot;algorithms.WrongKeyForThisOperation&quot;, exArgs);
145         }
146 
147         try {
148             this.macAlgorithm.init(secretKey);
149         } catch (InvalidKeyException ex) {
150             // reinstantiate Mac object to work around bug in JDK
151             // see: http://bugs.java.com/view_bug.do?bug_id=4953555
152             Mac mac = this.macAlgorithm;
153             try {
154                 this.macAlgorithm = Mac.getInstance(macAlgorithm.getAlgorithm());
155             } catch (Exception e) {
156                 // this shouldn&#39;t occur, but if it does, restore previous Mac
157                 LOG.debug(&quot;Exception when reinstantiating Mac: {}&quot;, e);
158                 this.macAlgorithm = mac;
159             }
160             throw new XMLSignatureException(ex);
161         }
162     }
163 
164     /**
165      * Proxy method for {@link java.security.Signature#sign()}
166      * which is executed on the internal {@link java.security.Signature} object.
167      *
168      * @return the result of the {@link java.security.Signature#sign()} method
169      * @throws XMLSignatureException
170      */
171     protected byte[] engineSign() throws XMLSignatureException {
172         try {
173             if (this.HMACOutputLengthSet &amp;&amp; this.HMACOutputLength &lt; getDigestLength()) {
174                 LOG.debug(&quot;HMACOutputLength must not be less than {}&quot;, getDigestLength());
175                 Object[] exArgs = { String.valueOf(getDigestLength()) };
176                 throw new XMLSignatureException(&quot;algorithms.HMACOutputLengthMin&quot;, exArgs);
177             } else {
178                 return this.macAlgorithm.doFinal();
179             }
180         } catch (IllegalStateException ex) {
181             throw new XMLSignatureException(ex);
182         }
183     }
184 
185     /**
186      * Method engineInitSign
187      *
188      * @param secretKey
189      * @throws XMLSignatureException
190      */
191     protected void engineInitSign(Key secretKey) throws XMLSignatureException {
192         engineInitSign(secretKey, (AlgorithmParameterSpec)null);
193     }
194 
195     /**
196      * Method engineInitSign
197      *
198      * @param secretKey
199      * @param algorithmParameterSpec
200      * @throws XMLSignatureException
201      */
202     protected void engineInitSign(
203         Key secretKey, AlgorithmParameterSpec algorithmParameterSpec
204     ) throws XMLSignatureException {
205         if (!(secretKey instanceof SecretKey)) {
206             String supplied = null;
207             if (secretKey != null) {
208                 supplied = secretKey.getClass().getName();
209             }
210             String needed = SecretKey.class.getName();
211             Object exArgs[] = { supplied, needed };
212 
213             throw new XMLSignatureException(&quot;algorithms.WrongKeyForThisOperation&quot;, exArgs);
214         }
215 
216         try {
217             if (algorithmParameterSpec == null) {
218                 this.macAlgorithm.init(secretKey);
219             } else {
220                 this.macAlgorithm.init(secretKey, algorithmParameterSpec);
221             }
222         } catch (InvalidKeyException ex) {
223             throw new XMLSignatureException(ex);
224         } catch (InvalidAlgorithmParameterException ex) {
225             throw new XMLSignatureException(ex);
226         }
227     }
228 
229     /**
230      * Method engineInitSign
231      *
232      * @param secretKey
233      * @param secureRandom
234      * @throws XMLSignatureException
235      */
236     protected void engineInitSign(Key secretKey, SecureRandom secureRandom)
237         throws XMLSignatureException {
238         throw new XMLSignatureException(&quot;algorithms.CannotUseSecureRandomOnMAC&quot;);
239     }
240 
241     /**
242      * Proxy method for {@link java.security.Signature#update(byte[])}
243      * which is executed on the internal {@link java.security.Signature} object.
244      *
245      * @param input
246      * @throws XMLSignatureException
247      */
248     protected void engineUpdate(byte[] input) throws XMLSignatureException {
249         try {
250             this.macAlgorithm.update(input);
251         } catch (IllegalStateException ex) {
252             throw new XMLSignatureException(ex);
253         }
254     }
255 
256     /**
257      * Proxy method for {@link java.security.Signature#update(byte)}
258      * which is executed on the internal {@link java.security.Signature} object.
259      *
260      * @param input
261      * @throws XMLSignatureException
262      */
263     protected void engineUpdate(byte input) throws XMLSignatureException {
264         try {
265             this.macAlgorithm.update(input);
266         } catch (IllegalStateException ex) {
267             throw new XMLSignatureException(ex);
268         }
269     }
270 
271     /**
272      * Proxy method for {@link java.security.Signature#update(byte[], int, int)}
273      * which is executed on the internal {@link java.security.Signature} object.
274      *
275      * @param buf
276      * @param offset
277      * @param len
278      * @throws XMLSignatureException
279      */
280     protected void engineUpdate(byte buf[], int offset, int len) throws XMLSignatureException {
281         try {
282             this.macAlgorithm.update(buf, offset, len);
283         } catch (IllegalStateException ex) {
284             throw new XMLSignatureException(ex);
285         }
286     }
287 
288     /**
289      * Method engineGetJCEAlgorithmString
290      * {@inheritDoc}
291      *
292      */
293     protected String engineGetJCEAlgorithmString() {
294         return this.macAlgorithm.getAlgorithm();
295     }
296 
297     /**
298      * Method engineGetJCEAlgorithmString
299      *
300      * {@inheritDoc}
301      */
302     protected String engineGetJCEProviderName() {
303         return this.macAlgorithm.getProvider().getName();
304     }
305 
306     /**
307      * Method engineSetHMACOutputLength
308      *
309      * @param HMACOutputLength
310      */
311     protected void engineSetHMACOutputLength(int HMACOutputLength) {
312         this.HMACOutputLength = HMACOutputLength;
313         this.HMACOutputLengthSet = true;
314     }
315 
316     /**
317      * Method engineGetContextFromElement
318      *
319      * @param element
320      */
321     protected void engineGetContextFromElement(Element element) {
322         super.engineGetContextFromElement(element);
323 
324         if (element == null) {
325             throw new IllegalArgumentException(&quot;element null&quot;);
326         }
327 
328         Text hmaclength =
329             XMLUtils.selectDsNodeText(element.getFirstChild(), Constants._TAG_HMACOUTPUTLENGTH, 0);
330 
331         if (hmaclength != null) {
332             this.HMACOutputLength = Integer.parseInt(hmaclength.getData());
333             this.HMACOutputLengthSet = true;
334         }
335     }
336 
337     /**
338      * Method engineAddContextToElement
339      *
340      * @param element
341      */
342     public void engineAddContextToElement(Element element) {
343         if (element == null) {
344             throw new IllegalArgumentException(&quot;null element&quot;);
345         }
346 
347         if (this.HMACOutputLengthSet) {
348             Document doc = element.getOwnerDocument();
349             Element HMElem =
350                 XMLUtils.createElementInSignatureSpace(doc, Constants._TAG_HMACOUTPUTLENGTH);
351             Text HMText =
352                 doc.createTextNode(&quot;&quot; + this.HMACOutputLength);
353 
354             HMElem.appendChild(HMText);
355             XMLUtils.addReturnToElement(element);
356             element.appendChild(HMElem);
357             XMLUtils.addReturnToElement(element);
358         }
359     }
360 
361     /**
362      * Class IntegrityHmacSHA1
363      */
364     public static class IntegrityHmacSHA1 extends IntegrityHmac {
365 
366         /**
367          * Constructor IntegrityHmacSHA1
368          *
369          * @throws XMLSignatureException
370          */
371         public IntegrityHmacSHA1() throws XMLSignatureException {
372             super();
373         }
374 
375         /**
376          * Method engineGetURI
377          * {@inheritDoc}
378          *
379          */
380         public String engineGetURI() {
381             return XMLSignature.ALGO_ID_MAC_HMAC_SHA1;
382         }
383 
384         int getDigestLength() {
385             return 160;
386         }
387     }
388 
389     /**
390      * Class IntegrityHmacSHA224
391      */
392     public static class IntegrityHmacSHA224 extends IntegrityHmac {
393 
394         /**
395          * Constructor IntegrityHmacSHA224
396          *
397          * @throws XMLSignatureException
398          */
399         public IntegrityHmacSHA224() throws XMLSignatureException {
400             super();
401         }
402 
403         /**
404          * Method engineGetURI
405          *
406          * {@inheritDoc}
407          */
408         public String engineGetURI() {
409             return XMLSignature.ALGO_ID_MAC_HMAC_SHA224;
410         }
411 
412         int getDigestLength() {
413             return 224;
414         }
415     }
416 
417     /**
418      * Class IntegrityHmacSHA256
419      */
420     public static class IntegrityHmacSHA256 extends IntegrityHmac {
421 
422         /**
423          * Constructor IntegrityHmacSHA256
424          *
425          * @throws XMLSignatureException
426          */
427         public IntegrityHmacSHA256() throws XMLSignatureException {
428             super();
429         }
430 
431         /**
432          * Method engineGetURI
433          *
434          * {@inheritDoc}
435          */
436         public String engineGetURI() {
437             return XMLSignature.ALGO_ID_MAC_HMAC_SHA256;
438         }
439 
440         int getDigestLength() {
441             return 256;
442         }
443     }
444 
445     /**
446      * Class IntegrityHmacSHA384
447      */
448     public static class IntegrityHmacSHA384 extends IntegrityHmac {
449 
450         /**
451          * Constructor IntegrityHmacSHA384
452          *
453          * @throws XMLSignatureException
454          */
455         public IntegrityHmacSHA384() throws XMLSignatureException {
456             super();
457         }
458 
459         /**
460          * Method engineGetURI
461          * {@inheritDoc}
462          *
463          */
464         public String engineGetURI() {
465             return XMLSignature.ALGO_ID_MAC_HMAC_SHA384;
466         }
467 
468         int getDigestLength() {
469             return 384;
470         }
471     }
472 
473     /**
474      * Class IntegrityHmacSHA512
475      */
476     public static class IntegrityHmacSHA512 extends IntegrityHmac {
477 
478         /**
479          * Constructor IntegrityHmacSHA512
480          *
481          * @throws XMLSignatureException
482          */
483         public IntegrityHmacSHA512() throws XMLSignatureException {
484             super();
485         }
486 
487         /**
488          * Method engineGetURI
489          * {@inheritDoc}
490          *
491          */
492         public String engineGetURI() {
493             return XMLSignature.ALGO_ID_MAC_HMAC_SHA512;
494         }
495 
496         int getDigestLength() {
497             return 512;
498         }
499     }
500 
501     /**
502      * Class IntegrityHmacRIPEMD160
503      */
504     public static class IntegrityHmacRIPEMD160 extends IntegrityHmac {
505 
506         /**
507          * Constructor IntegrityHmacRIPEMD160
508          *
509          * @throws XMLSignatureException
510          */
511         public IntegrityHmacRIPEMD160() throws XMLSignatureException {
512             super();
513         }
514 
515         /**
516          * Method engineGetURI
517          *
518          * {@inheritDoc}
519          */
520         public String engineGetURI() {
521             return XMLSignature.ALGO_ID_MAC_HMAC_RIPEMD160;
522         }
523 
524         int getDigestLength() {
525             return 160;
526         }
527     }
528 
529     /**
530      * Class IntegrityHmacMD5
531      */
532     public static class IntegrityHmacMD5 extends IntegrityHmac {
533 
534         /**
535          * Constructor IntegrityHmacMD5
536          *
537          * @throws XMLSignatureException
538          */
539         public IntegrityHmacMD5() throws XMLSignatureException {
540             super();
541         }
542 
543         /**
544          * Method engineGetURI
545          *
546          * {@inheritDoc}
547          */
548         public String engineGetURI() {
549             return XMLSignature.ALGO_ID_MAC_HMAC_NOT_RECOMMENDED_MD5;
550         }
551 
552         int getDigestLength() {
553             return 128;
554         }
555     }
556 }
    </pre>
  </body>
</html>