<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMX509Data.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DOMUtils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DOMX509IssuerSerial.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMX509Data.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
<span class="line-modified"> 24  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
 25  */
 26 /*
<span class="line-modified"> 27  * $Id: DOMX509Data.java 1789702 2017-03-31 15:15:04Z coheigea $</span>
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
 31 import java.io.ByteArrayInputStream;
 32 import java.io.IOException;
 33 import java.security.cert.*;
 34 import java.util.*;
 35 
<span class="line-modified"> 36 import javax.xml.crypto.*;</span>


 37 import javax.xml.crypto.dom.DOMCryptoContext;
<span class="line-modified"> 38 import javax.xml.crypto.dsig.*;</span>
 39 import javax.xml.crypto.dsig.keyinfo.X509Data;
 40 import javax.xml.crypto.dsig.keyinfo.X509IssuerSerial;
<span class="line-removed"> 41 import javax.security.auth.x500.X500Principal;</span>
 42 
 43 import org.w3c.dom.Document;
 44 import org.w3c.dom.Element;
 45 import org.w3c.dom.Node;
 46 
 47 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 48 
 49 /**
 50  * DOM-based implementation of X509Data.
 51  *
 52  */
 53 //@@@ check for illegal combinations of data violating MUSTs in W3c spec
 54 public final class DOMX509Data extends DOMStructure implements X509Data {
 55 
 56     private final List&lt;Object&gt; content;
 57     private CertificateFactory cf;
 58 
 59     /**
 60      * Creates a DOMX509Data.
 61      *
</pre>
<hr />
<pre>
 98      *
 99      * @param xdElem an X509Data element
100      * @throws MarshalException if there is an error while unmarshalling
101      */
102     public DOMX509Data(Element xdElem) throws MarshalException {
103         // get all children nodes
104         List&lt;Object&gt; newContent = new ArrayList&lt;&gt;();
105         Node firstChild = xdElem.getFirstChild();
106         while (firstChild != null) {
107             if (firstChild.getNodeType() == Node.ELEMENT_NODE) {
108                 Element childElem = (Element)firstChild;
109                 String localName = childElem.getLocalName();
110                 String namespace = childElem.getNamespaceURI();
111                 if (&quot;X509Certificate&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
112                     newContent.add(unmarshalX509Certificate(childElem));
113                 } else if (&quot;X509IssuerSerial&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
114                     newContent.add(new DOMX509IssuerSerial(childElem));
115                 } else if (&quot;X509SubjectName&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
116                     newContent.add(childElem.getFirstChild().getNodeValue());
117                 } else if (&quot;X509SKI&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
<span class="line-modified">118                     String content = XMLUtils.getFullTextChildrenFromElement(childElem);</span>
119                     newContent.add(XMLUtils.decode(content));
120                 } else if (&quot;X509CRL&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
121                     newContent.add(unmarshalX509CRL(childElem));
122                 } else {
123                     newContent.add(new javax.xml.crypto.dom.DOMStructure(childElem));
124                 }
125             }
126             firstChild = firstChild.getNextSibling();
127         }
128         this.content = Collections.unmodifiableList(newContent);
129     }
130 
131     public List&lt;Object&gt; getContent() {
132         return content;
133     }
134 

135     public void marshal(Node parent, String dsPrefix, DOMCryptoContext context)
136         throws MarshalException
137     {
138         Document ownerDoc = DOMUtils.getOwnerDocument(parent);
139         Element xdElem = DOMUtils.createElement(ownerDoc, &quot;X509Data&quot;,
140                                                 XMLSignature.XMLNS, dsPrefix);
141 
142         // append children and preserve order
143         for (int i = 0, size = content.size(); i &lt; size; i++) {
144             Object object = content.get(i);
145             if (object instanceof X509Certificate) {
146                 marshalCert((X509Certificate)object,xdElem,ownerDoc,dsPrefix);
147             } else if (object instanceof XMLStructure) {
148                 if (object instanceof X509IssuerSerial) {
149                     ((DOMX509IssuerSerial)object).marshal
150                         (xdElem, dsPrefix, context);
151                 } else {
152                     javax.xml.crypto.dom.DOMStructure domContent =
153                         (javax.xml.crypto.dom.DOMStructure)object;
154                     DOMUtils.appendChild(xdElem, domContent.getNode());
</pre>
<hr />
<pre>
224             throw new MarshalException(&quot;Error closing stream&quot;, e);
225         }
226     }
227 
228     private X509CRL unmarshalX509CRL(Element elem) throws MarshalException {
229         try (ByteArrayInputStream bs = unmarshalBase64Binary(elem)) {
230             return (X509CRL)cf.generateCRL(bs);
231         } catch (CRLException e) {
232             throw new MarshalException(&quot;Cannot create X509CRL&quot;, e);
233         } catch (IOException e) {
234             throw new MarshalException(&quot;Error closing stream&quot;, e);
235         }
236     }
237 
238     private ByteArrayInputStream unmarshalBase64Binary(Element elem)
239         throws MarshalException {
240         try {
241             if (cf == null) {
242                 cf = CertificateFactory.getInstance(&quot;X.509&quot;);
243             }
<span class="line-modified">244             String content = XMLUtils.getFullTextChildrenFromElement(elem);</span>
245             return new ByteArrayInputStream(XMLUtils.decode(content));
246         } catch (CertificateException e) {
247             throw new MarshalException(&quot;Cannot create CertificateFactory&quot;, e);
248         }
249     }
250 
251     @Override
252     public boolean equals(Object o) {
253         if (this == o) {
254             return true;
255         }
256 
257         if (!(o instanceof X509Data)) {
258             return false;
259         }
260         X509Data oxd = (X509Data)o;
261 
262         List&lt;?&gt; ocontent = oxd.getContent();
263         int size = content.size();
264         if (size != ocontent.size()) {
</pre>
</td>
<td>
<hr />
<pre>
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
<span class="line-modified"> 24  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
 25  */
 26 /*
<span class="line-modified"> 27  * $Id: DOMX509Data.java 1854026 2019-02-21 09:30:01Z coheigea $</span>
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
 31 import java.io.ByteArrayInputStream;
 32 import java.io.IOException;
 33 import java.security.cert.*;
 34 import java.util.*;
 35 
<span class="line-modified"> 36 import javax.security.auth.x500.X500Principal;</span>
<span class="line-added"> 37 import javax.xml.crypto.MarshalException;</span>
<span class="line-added"> 38 import javax.xml.crypto.XMLStructure;</span>
 39 import javax.xml.crypto.dom.DOMCryptoContext;
<span class="line-modified"> 40 import javax.xml.crypto.dsig.XMLSignature;</span>
 41 import javax.xml.crypto.dsig.keyinfo.X509Data;
 42 import javax.xml.crypto.dsig.keyinfo.X509IssuerSerial;

 43 
 44 import org.w3c.dom.Document;
 45 import org.w3c.dom.Element;
 46 import org.w3c.dom.Node;
 47 
 48 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 49 
 50 /**
 51  * DOM-based implementation of X509Data.
 52  *
 53  */
 54 //@@@ check for illegal combinations of data violating MUSTs in W3c spec
 55 public final class DOMX509Data extends DOMStructure implements X509Data {
 56 
 57     private final List&lt;Object&gt; content;
 58     private CertificateFactory cf;
 59 
 60     /**
 61      * Creates a DOMX509Data.
 62      *
</pre>
<hr />
<pre>
 99      *
100      * @param xdElem an X509Data element
101      * @throws MarshalException if there is an error while unmarshalling
102      */
103     public DOMX509Data(Element xdElem) throws MarshalException {
104         // get all children nodes
105         List&lt;Object&gt; newContent = new ArrayList&lt;&gt;();
106         Node firstChild = xdElem.getFirstChild();
107         while (firstChild != null) {
108             if (firstChild.getNodeType() == Node.ELEMENT_NODE) {
109                 Element childElem = (Element)firstChild;
110                 String localName = childElem.getLocalName();
111                 String namespace = childElem.getNamespaceURI();
112                 if (&quot;X509Certificate&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
113                     newContent.add(unmarshalX509Certificate(childElem));
114                 } else if (&quot;X509IssuerSerial&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
115                     newContent.add(new DOMX509IssuerSerial(childElem));
116                 } else if (&quot;X509SubjectName&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
117                     newContent.add(childElem.getFirstChild().getNodeValue());
118                 } else if (&quot;X509SKI&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
<span class="line-modified">119                     String content = XMLUtils.getFullTextChildrenFromNode(childElem);</span>
120                     newContent.add(XMLUtils.decode(content));
121                 } else if (&quot;X509CRL&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
122                     newContent.add(unmarshalX509CRL(childElem));
123                 } else {
124                     newContent.add(new javax.xml.crypto.dom.DOMStructure(childElem));
125                 }
126             }
127             firstChild = firstChild.getNextSibling();
128         }
129         this.content = Collections.unmodifiableList(newContent);
130     }
131 
132     public List&lt;Object&gt; getContent() {
133         return content;
134     }
135 
<span class="line-added">136     @Override</span>
137     public void marshal(Node parent, String dsPrefix, DOMCryptoContext context)
138         throws MarshalException
139     {
140         Document ownerDoc = DOMUtils.getOwnerDocument(parent);
141         Element xdElem = DOMUtils.createElement(ownerDoc, &quot;X509Data&quot;,
142                                                 XMLSignature.XMLNS, dsPrefix);
143 
144         // append children and preserve order
145         for (int i = 0, size = content.size(); i &lt; size; i++) {
146             Object object = content.get(i);
147             if (object instanceof X509Certificate) {
148                 marshalCert((X509Certificate)object,xdElem,ownerDoc,dsPrefix);
149             } else if (object instanceof XMLStructure) {
150                 if (object instanceof X509IssuerSerial) {
151                     ((DOMX509IssuerSerial)object).marshal
152                         (xdElem, dsPrefix, context);
153                 } else {
154                     javax.xml.crypto.dom.DOMStructure domContent =
155                         (javax.xml.crypto.dom.DOMStructure)object;
156                     DOMUtils.appendChild(xdElem, domContent.getNode());
</pre>
<hr />
<pre>
226             throw new MarshalException(&quot;Error closing stream&quot;, e);
227         }
228     }
229 
230     private X509CRL unmarshalX509CRL(Element elem) throws MarshalException {
231         try (ByteArrayInputStream bs = unmarshalBase64Binary(elem)) {
232             return (X509CRL)cf.generateCRL(bs);
233         } catch (CRLException e) {
234             throw new MarshalException(&quot;Cannot create X509CRL&quot;, e);
235         } catch (IOException e) {
236             throw new MarshalException(&quot;Error closing stream&quot;, e);
237         }
238     }
239 
240     private ByteArrayInputStream unmarshalBase64Binary(Element elem)
241         throws MarshalException {
242         try {
243             if (cf == null) {
244                 cf = CertificateFactory.getInstance(&quot;X.509&quot;);
245             }
<span class="line-modified">246             String content = XMLUtils.getFullTextChildrenFromNode(elem);</span>
247             return new ByteArrayInputStream(XMLUtils.decode(content));
248         } catch (CertificateException e) {
249             throw new MarshalException(&quot;Cannot create CertificateFactory&quot;, e);
250         }
251     }
252 
253     @Override
254     public boolean equals(Object o) {
255         if (this == o) {
256             return true;
257         }
258 
259         if (!(o instanceof X509Data)) {
260             return false;
261         }
262         X509Data oxd = (X509Data)o;
263 
264         List&lt;?&gt; ocontent = oxd.getContent();
265         int size = content.size();
266         if (size != ocontent.size()) {
</pre>
</td>
</tr>
</table>
<center><a href="DOMUtils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DOMX509IssuerSerial.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>