<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMRetrievalMethod.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DOMReference.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DOMSignatureMethod.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMRetrievalMethod.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
<span class="line-modified"> 24  * Portions copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
 25  */
 26 /*
 27  * ===========================================================================
 28  *
 29  * (C) Copyright IBM Corp. 2003 All Rights Reserved.
 30  *
 31  * ===========================================================================
 32  */
 33 /*
<span class="line-modified"> 34  * $Id: DOMRetrievalMethod.java 1788465 2017-03-24 15:10:51Z coheigea $</span>
 35  */
 36 package org.jcp.xml.dsig.internal.dom;
 37 
 38 import java.io.ByteArrayInputStream;
 39 import java.io.InputStream;
 40 import java.net.URI;
 41 import java.net.URISyntaxException;
 42 import java.security.Provider;
 43 import java.util.ArrayList;
 44 import java.util.Collections;
 45 import java.util.Iterator;
 46 import java.util.List;
 47 
 48 import javax.xml.crypto.Data;
 49 import javax.xml.crypto.MarshalException;
 50 import javax.xml.crypto.NodeSetData;
 51 import javax.xml.crypto.URIDereferencer;
 52 import javax.xml.crypto.URIReferenceException;
 53 import javax.xml.crypto.XMLCryptoContext;
 54 import javax.xml.crypto.XMLStructure;
 55 import javax.xml.crypto.dom.DOMCryptoContext;
 56 import javax.xml.crypto.dom.DOMURIReference;
 57 import javax.xml.crypto.dsig.Transform;
 58 import javax.xml.crypto.dsig.XMLSignature;
 59 import javax.xml.crypto.dsig.keyinfo.RetrievalMethod;
<span class="line-removed"> 60 import javax.xml.parsers.DocumentBuilder;</span>
 61 
 62 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 63 import org.w3c.dom.Attr;
 64 import org.w3c.dom.Document;
 65 import org.w3c.dom.Element;
 66 import org.w3c.dom.Node;
 67 
 68 /**
 69  * DOM-based implementation of RetrievalMethod.
 70  *
 71  */
 72 public final class DOMRetrievalMethod extends DOMStructure
 73     implements RetrievalMethod, DOMURIReference {
 74 
 75     private final List&lt;Transform&gt; transforms;
 76     private String uri;
 77     private String type;
 78     private Attr here;
 79 
 80     /**
</pre>
<hr />
<pre>
258         if (data instanceof NodeSetData &amp;&amp; Utils.secureValidation(context)
259                 &amp;&amp; Policy.restrictRetrievalMethodLoops()) {
260             NodeSetData&lt;?&gt; nsd = (NodeSetData&lt;?&gt;)data;
261             Iterator&lt;?&gt; i = nsd.iterator();
262             if (i.hasNext()) {
263                 Node root = (Node)i.next();
264                 if (&quot;RetrievalMethod&quot;.equals(root.getLocalName())) {
265                     throw new URIReferenceException(
266                         &quot;It is forbidden to have one RetrievalMethod point &quot; +
267                         &quot;to another when secure validation is enabled&quot;);
268                 }
269             }
270         }
271 
272         return data;
273     }
274 
275     public XMLStructure dereferenceAsXMLStructure(XMLCryptoContext context)
276         throws URIReferenceException
277     {
<span class="line-removed">278         DocumentBuilder db = null;</span>
279         boolean secVal = Utils.secureValidation(context);
280         ApacheData data = (ApacheData)dereference(context);
281         try (InputStream is = new ByteArrayInputStream(data.getXMLSignatureInput().getBytes())) {
<span class="line-modified">282             db = XMLUtils.createDocumentBuilder(false, secVal);</span>
<span class="line-removed">283             Document doc = db.parse(is);</span>
284             Element kiElem = doc.getDocumentElement();
285             if (kiElem.getLocalName().equals(&quot;X509Data&quot;)
286                 &amp;&amp; XMLSignature.XMLNS.equals(kiElem.getNamespaceURI())) {
287                 return new DOMX509Data(kiElem);
288             } else {
289                 return null; // unsupported
290             }
291         } catch (Exception e) {
292             throw new URIReferenceException(e);
293         }
294     }
295 
296     @Override
297     public boolean equals(Object obj) {
298         if (this == obj) {
299             return true;
300         }
301         if (!(obj instanceof RetrievalMethod)) {
302             return false;
303         }
</pre>
</td>
<td>
<hr />
<pre>
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
<span class="line-modified"> 24  * Portions copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
 25  */
 26 /*
 27  * ===========================================================================
 28  *
 29  * (C) Copyright IBM Corp. 2003 All Rights Reserved.
 30  *
 31  * ===========================================================================
 32  */
 33 /*
<span class="line-modified"> 34  * $Id: DOMRetrievalMethod.java 1862080 2019-06-25 16:50:17Z coheigea $</span>
 35  */
 36 package org.jcp.xml.dsig.internal.dom;
 37 
 38 import java.io.ByteArrayInputStream;
 39 import java.io.InputStream;
 40 import java.net.URI;
 41 import java.net.URISyntaxException;
 42 import java.security.Provider;
 43 import java.util.ArrayList;
 44 import java.util.Collections;
 45 import java.util.Iterator;
 46 import java.util.List;
 47 
 48 import javax.xml.crypto.Data;
 49 import javax.xml.crypto.MarshalException;
 50 import javax.xml.crypto.NodeSetData;
 51 import javax.xml.crypto.URIDereferencer;
 52 import javax.xml.crypto.URIReferenceException;
 53 import javax.xml.crypto.XMLCryptoContext;
 54 import javax.xml.crypto.XMLStructure;
 55 import javax.xml.crypto.dom.DOMCryptoContext;
 56 import javax.xml.crypto.dom.DOMURIReference;
 57 import javax.xml.crypto.dsig.Transform;
 58 import javax.xml.crypto.dsig.XMLSignature;
 59 import javax.xml.crypto.dsig.keyinfo.RetrievalMethod;

 60 
 61 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 62 import org.w3c.dom.Attr;
 63 import org.w3c.dom.Document;
 64 import org.w3c.dom.Element;
 65 import org.w3c.dom.Node;
 66 
 67 /**
 68  * DOM-based implementation of RetrievalMethod.
 69  *
 70  */
 71 public final class DOMRetrievalMethod extends DOMStructure
 72     implements RetrievalMethod, DOMURIReference {
 73 
 74     private final List&lt;Transform&gt; transforms;
 75     private String uri;
 76     private String type;
 77     private Attr here;
 78 
 79     /**
</pre>
<hr />
<pre>
257         if (data instanceof NodeSetData &amp;&amp; Utils.secureValidation(context)
258                 &amp;&amp; Policy.restrictRetrievalMethodLoops()) {
259             NodeSetData&lt;?&gt; nsd = (NodeSetData&lt;?&gt;)data;
260             Iterator&lt;?&gt; i = nsd.iterator();
261             if (i.hasNext()) {
262                 Node root = (Node)i.next();
263                 if (&quot;RetrievalMethod&quot;.equals(root.getLocalName())) {
264                     throw new URIReferenceException(
265                         &quot;It is forbidden to have one RetrievalMethod point &quot; +
266                         &quot;to another when secure validation is enabled&quot;);
267                 }
268             }
269         }
270 
271         return data;
272     }
273 
274     public XMLStructure dereferenceAsXMLStructure(XMLCryptoContext context)
275         throws URIReferenceException
276     {

277         boolean secVal = Utils.secureValidation(context);
278         ApacheData data = (ApacheData)dereference(context);
279         try (InputStream is = new ByteArrayInputStream(data.getXMLSignatureInput().getBytes())) {
<span class="line-modified">280             Document doc = XMLUtils.read(is, secVal);</span>

281             Element kiElem = doc.getDocumentElement();
282             if (kiElem.getLocalName().equals(&quot;X509Data&quot;)
283                 &amp;&amp; XMLSignature.XMLNS.equals(kiElem.getNamespaceURI())) {
284                 return new DOMX509Data(kiElem);
285             } else {
286                 return null; // unsupported
287             }
288         } catch (Exception e) {
289             throw new URIReferenceException(e);
290         }
291     }
292 
293     @Override
294     public boolean equals(Object obj) {
295         if (this == obj) {
296             return true;
297         }
298         if (!(obj instanceof RetrievalMethod)) {
299             return false;
300         }
</pre>
</td>
</tr>
</table>
<center><a href="DOMReference.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DOMSignatureMethod.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>