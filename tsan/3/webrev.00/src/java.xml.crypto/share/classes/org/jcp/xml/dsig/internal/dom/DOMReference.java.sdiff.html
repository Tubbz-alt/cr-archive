<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMReference.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DOMPGPData.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DOMRetrievalMethod.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMReference.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
<span class="line-modified"> 24  * Portions copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
 25  */
 26 /*
 27  * ===========================================================================
 28  *
 29  * (C) Copyright IBM Corp. 2003 All Rights Reserved.
 30  *
 31  * ===========================================================================
 32  */
 33 /*
<span class="line-modified"> 34  * $Id: DOMReference.java 1803518 2017-07-31 11:02:52Z coheigea $</span>
 35  */
 36 package org.jcp.xml.dsig.internal.dom;
 37 
 38 import javax.xml.crypto.*;
 39 import javax.xml.crypto.dsig.*;
 40 import javax.xml.crypto.dom.DOMCryptoContext;
 41 import javax.xml.crypto.dom.DOMURIReference;
 42 
 43 import java.io.*;
 44 import java.net.URI;
 45 import java.net.URISyntaxException;
 46 import java.security.*;
 47 import java.util.*;
 48 
 49 import org.w3c.dom.Attr;
 50 import org.w3c.dom.Document;
 51 import org.w3c.dom.Element;
 52 import org.w3c.dom.Node;
 53 
 54 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 55 
 56 import org.jcp.xml.dsig.internal.DigesterOutputStream;
 57 import com.sun.org.apache.xml.internal.security.signature.XMLSignatureInput;
 58 import com.sun.org.apache.xml.internal.security.utils.UnsyncBufferedOutputStream;
<span class="line-removed"> 59 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;</span>
 60 
 61 /**
 62  * DOM-based implementation of Reference.
 63  *
 64  */
 65 public final class DOMReference extends DOMStructure
 66     implements Reference, DOMURIReference {
 67 
 68    /**
 69     * The maximum number of transforms per reference, if secure validation is enabled.
 70     */
 71    public static final int MAXIMUM_TRANSFORM_COUNT = 5;
 72 
 73    /**
 74     * Look up useC14N11 system property. If true, an explicit C14N11 transform
 75     * will be added if necessary when generating the signature. See section
 76     * 3.1.1 of http://www.w3.org/2007/xmlsec/Drafts/xmldsig-core/ for more info.
 77     *
 78     * If true, overrides the same property if set in the XMLSignContext.
 79     */
</pre>
<hr />
<pre>
227         if (!nextSibling.getLocalName().equals(&quot;DigestMethod&quot;)
228             &amp;&amp; XMLSignature.XMLNS.equals(nextSibling.getNamespaceURI())) {
229             throw new MarshalException(&quot;Invalid element name: &quot; +
230                                        nextSibling.getLocalName() +
231                                        &quot;, expected DigestMethod&quot;);
232         }
233 
234         // unmarshal DigestMethod
235         Element dmElem = nextSibling;
236         this.digestMethod = DOMDigestMethod.unmarshal(dmElem);
237         String digestMethodAlgorithm = this.digestMethod.getAlgorithm();
238         if (secVal &amp;&amp; Policy.restrictAlg(digestMethodAlgorithm)) {
239             throw new MarshalException(
240                 &quot;It is forbidden to use algorithm &quot; + digestMethodAlgorithm +
241                 &quot; when secure validation is enabled&quot;
242             );
243         }
244 
245         // unmarshal DigestValue
246         Element dvElem = DOMUtils.getNextSiblingElement(dmElem, &quot;DigestValue&quot;, XMLSignature.XMLNS);
<span class="line-modified">247         String content = XMLUtils.getFullTextChildrenFromElement(dvElem);</span>
248         this.digestValue = XMLUtils.decode(content);
249 
250         // check for extra elements
251         if (DOMUtils.getNextSiblingElement(dvElem) != null) {
252             throw new MarshalException(
253                 &quot;Unexpected element after DigestValue element&quot;);
254         }
255 
256         // unmarshal attributes
257         this.uri = DOMUtils.getAttributeValue(refElem, &quot;URI&quot;);
258 
259         Attr attr = refElem.getAttributeNodeNS(null, &quot;Id&quot;);
260         if (attr != null) {
261             this.id = attr.getValue();
262             refElem.setIdAttributeNode(attr, true);
263         } else {
264             this.id = null;
265         }
266 
267         this.type = DOMUtils.getAttributeValue(refElem, &quot;Type&quot;);
</pre>
<hr />
<pre>
294     }
295 
296     public byte[] getDigestValue() {
297         return digestValue == null ? null : digestValue.clone();
298     }
299 
300     public byte[] getCalculatedDigestValue() {
301         return calcDigestValue == null ? null
302                                         : calcDigestValue.clone();
303     }
304 
305     @Override
306     public void marshal(Node parent, String dsPrefix, DOMCryptoContext context)
307         throws MarshalException
308     {
309         LOG.debug(&quot;Marshalling Reference&quot;);
310         Document ownerDoc = DOMUtils.getOwnerDocument(parent);
311 
312         refElem = DOMUtils.createElement(ownerDoc, &quot;Reference&quot;,
313                                          XMLSignature.XMLNS, dsPrefix);

314         // set attributes
315         DOMUtils.setAttributeID(refElem, &quot;Id&quot;, id);
316         DOMUtils.setAttribute(refElem, &quot;URI&quot;, uri);
317         DOMUtils.setAttribute(refElem, &quot;Type&quot;, type);
318 
319         // create and append Transforms element
320         if (!allTransforms.isEmpty()) {
321             Element transformsElem = DOMUtils.createElement(ownerDoc,
322                                                             &quot;Transforms&quot;,
323                                                             XMLSignature.XMLNS,
324                                                             dsPrefix);
325             refElem.appendChild(transformsElem);
326             for (Transform transform : allTransforms) {
327                 ((DOMStructure)transform).marshal(transformsElem,
328                                                   dsPrefix, context);
329             }
330         }
331 
332         // create and append DigestMethod element
333         ((DOMDigestMethod)digestMethod).marshal(refElem, dsPrefix, context);
334 
335         // create and append DigestValue element
336         LOG.debug(&quot;Adding digestValueElem&quot;);
337         Element digestValueElem = DOMUtils.createElement(ownerDoc,
338                                                          &quot;DigestValue&quot;,
339                                                          XMLSignature.XMLNS,
340                                                          dsPrefix);
341         if (digestValue != null) {
342             digestValueElem.appendChild
343                 (ownerDoc.createTextNode(XMLUtils.encodeToString(digestValue)));
<span class="line-removed">344 </span>
345         }
346         refElem.appendChild(digestValueElem);
347 
348         parent.appendChild(refElem);
349         here = refElem.getAttributeNodeNS(null, &quot;URI&quot;);
350     }
351 
352     public void digest(XMLSignContext signContext)
353         throws XMLSignatureException
354     {
355         Data data = null;
356         if (appliedTransformData == null) {
357             data = dereference(signContext);
358         } else {
359             data = appliedTransformData;
360         }
361         digestValue = transform(data, signContext);
362 
363         // insert digestValue into DigestValue element
364         String encodedDV = XMLUtils.encodeToString(digestValue);
</pre>
</td>
<td>
<hr />
<pre>
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
<span class="line-modified"> 24  * Portions copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
 25  */
 26 /*
 27  * ===========================================================================
 28  *
 29  * (C) Copyright IBM Corp. 2003 All Rights Reserved.
 30  *
 31  * ===========================================================================
 32  */
 33 /*
<span class="line-modified"> 34  * $Id: DOMReference.java 1854026 2019-02-21 09:30:01Z coheigea $</span>
 35  */
 36 package org.jcp.xml.dsig.internal.dom;
 37 
 38 import javax.xml.crypto.*;
 39 import javax.xml.crypto.dsig.*;
 40 import javax.xml.crypto.dom.DOMCryptoContext;
 41 import javax.xml.crypto.dom.DOMURIReference;
 42 
 43 import java.io.*;
 44 import java.net.URI;
 45 import java.net.URISyntaxException;
 46 import java.security.*;
 47 import java.util.*;
 48 
 49 import org.w3c.dom.Attr;
 50 import org.w3c.dom.Document;
 51 import org.w3c.dom.Element;
 52 import org.w3c.dom.Node;
 53 
 54 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 55 
 56 import org.jcp.xml.dsig.internal.DigesterOutputStream;
 57 import com.sun.org.apache.xml.internal.security.signature.XMLSignatureInput;
 58 import com.sun.org.apache.xml.internal.security.utils.UnsyncBufferedOutputStream;

 59 
 60 /**
 61  * DOM-based implementation of Reference.
 62  *
 63  */
 64 public final class DOMReference extends DOMStructure
 65     implements Reference, DOMURIReference {
 66 
 67    /**
 68     * The maximum number of transforms per reference, if secure validation is enabled.
 69     */
 70    public static final int MAXIMUM_TRANSFORM_COUNT = 5;
 71 
 72    /**
 73     * Look up useC14N11 system property. If true, an explicit C14N11 transform
 74     * will be added if necessary when generating the signature. See section
 75     * 3.1.1 of http://www.w3.org/2007/xmlsec/Drafts/xmldsig-core/ for more info.
 76     *
 77     * If true, overrides the same property if set in the XMLSignContext.
 78     */
</pre>
<hr />
<pre>
226         if (!nextSibling.getLocalName().equals(&quot;DigestMethod&quot;)
227             &amp;&amp; XMLSignature.XMLNS.equals(nextSibling.getNamespaceURI())) {
228             throw new MarshalException(&quot;Invalid element name: &quot; +
229                                        nextSibling.getLocalName() +
230                                        &quot;, expected DigestMethod&quot;);
231         }
232 
233         // unmarshal DigestMethod
234         Element dmElem = nextSibling;
235         this.digestMethod = DOMDigestMethod.unmarshal(dmElem);
236         String digestMethodAlgorithm = this.digestMethod.getAlgorithm();
237         if (secVal &amp;&amp; Policy.restrictAlg(digestMethodAlgorithm)) {
238             throw new MarshalException(
239                 &quot;It is forbidden to use algorithm &quot; + digestMethodAlgorithm +
240                 &quot; when secure validation is enabled&quot;
241             );
242         }
243 
244         // unmarshal DigestValue
245         Element dvElem = DOMUtils.getNextSiblingElement(dmElem, &quot;DigestValue&quot;, XMLSignature.XMLNS);
<span class="line-modified">246         String content = XMLUtils.getFullTextChildrenFromNode(dvElem);</span>
247         this.digestValue = XMLUtils.decode(content);
248 
249         // check for extra elements
250         if (DOMUtils.getNextSiblingElement(dvElem) != null) {
251             throw new MarshalException(
252                 &quot;Unexpected element after DigestValue element&quot;);
253         }
254 
255         // unmarshal attributes
256         this.uri = DOMUtils.getAttributeValue(refElem, &quot;URI&quot;);
257 
258         Attr attr = refElem.getAttributeNodeNS(null, &quot;Id&quot;);
259         if (attr != null) {
260             this.id = attr.getValue();
261             refElem.setIdAttributeNode(attr, true);
262         } else {
263             this.id = null;
264         }
265 
266         this.type = DOMUtils.getAttributeValue(refElem, &quot;Type&quot;);
</pre>
<hr />
<pre>
293     }
294 
295     public byte[] getDigestValue() {
296         return digestValue == null ? null : digestValue.clone();
297     }
298 
299     public byte[] getCalculatedDigestValue() {
300         return calcDigestValue == null ? null
301                                         : calcDigestValue.clone();
302     }
303 
304     @Override
305     public void marshal(Node parent, String dsPrefix, DOMCryptoContext context)
306         throws MarshalException
307     {
308         LOG.debug(&quot;Marshalling Reference&quot;);
309         Document ownerDoc = DOMUtils.getOwnerDocument(parent);
310 
311         refElem = DOMUtils.createElement(ownerDoc, &quot;Reference&quot;,
312                                          XMLSignature.XMLNS, dsPrefix);
<span class="line-added">313 </span>
314         // set attributes
315         DOMUtils.setAttributeID(refElem, &quot;Id&quot;, id);
316         DOMUtils.setAttribute(refElem, &quot;URI&quot;, uri);
317         DOMUtils.setAttribute(refElem, &quot;Type&quot;, type);
318 
319         // create and append Transforms element
320         if (!allTransforms.isEmpty()) {
321             Element transformsElem = DOMUtils.createElement(ownerDoc,
322                                                             &quot;Transforms&quot;,
323                                                             XMLSignature.XMLNS,
324                                                             dsPrefix);
325             refElem.appendChild(transformsElem);
326             for (Transform transform : allTransforms) {
327                 ((DOMStructure)transform).marshal(transformsElem,
328                                                   dsPrefix, context);
329             }
330         }
331 
332         // create and append DigestMethod element
333         ((DOMDigestMethod)digestMethod).marshal(refElem, dsPrefix, context);
334 
335         // create and append DigestValue element
336         LOG.debug(&quot;Adding digestValueElem&quot;);
337         Element digestValueElem = DOMUtils.createElement(ownerDoc,
338                                                          &quot;DigestValue&quot;,
339                                                          XMLSignature.XMLNS,
340                                                          dsPrefix);
341         if (digestValue != null) {
342             digestValueElem.appendChild
343                 (ownerDoc.createTextNode(XMLUtils.encodeToString(digestValue)));

344         }
345         refElem.appendChild(digestValueElem);
346 
347         parent.appendChild(refElem);
348         here = refElem.getAttributeNodeNS(null, &quot;URI&quot;);
349     }
350 
351     public void digest(XMLSignContext signContext)
352         throws XMLSignatureException
353     {
354         Data data = null;
355         if (appliedTransformData == null) {
356             data = dereference(signContext);
357         } else {
358             data = appliedTransformData;
359         }
360         digestValue = transform(data, signContext);
361 
362         // insert digestValue into DigestValue element
363         String encodedDV = XMLUtils.encodeToString(digestValue);
</pre>
</td>
</tr>
</table>
<center><a href="DOMPGPData.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DOMRetrievalMethod.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>