<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMURIDereferencer.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
 24  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.
 25  */
 26 /*
 27  * $Id: DOMURIDereferencer.java 1788465 2017-03-24 15:10:51Z coheigea $
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
 31 import org.w3c.dom.Attr;
 32 import org.w3c.dom.Element;
 33 import org.w3c.dom.Node;
 34 
 35 import com.sun.org.apache.xml.internal.security.Init;
 36 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 37 import com.sun.org.apache.xml.internal.security.utils.resolver.ResourceResolver;
 38 import com.sun.org.apache.xml.internal.security.signature.XMLSignatureInput;
 39 
 40 import javax.xml.crypto.*;
 41 import javax.xml.crypto.dom.*;
 42 
 43 /**
 44  * DOM-based implementation of URIDereferencer.
 45  *
 46  */
 47 public final class DOMURIDereferencer implements URIDereferencer {
 48 
 49     static final URIDereferencer INSTANCE = new DOMURIDereferencer();
 50 
 51     private DOMURIDereferencer() {
 52         // need to call com.sun.org.apache.xml.internal.security.Init.init()
 53         // before calling any apache security code
 54         Init.init();
 55     }
 56 
 57     public Data dereference(URIReference uriRef, XMLCryptoContext context)
 58         throws URIReferenceException {
 59 
 60         if (uriRef == null) {
 61             throw new NullPointerException(&quot;uriRef cannot be null&quot;);
 62         }
 63         if (context == null) {
 64             throw new NullPointerException(&quot;context cannot be null&quot;);
 65         }
 66 
 67         DOMURIReference domRef = (DOMURIReference) uriRef;
 68         Attr uriAttr = (Attr) domRef.getHere();
 69         String uri = uriRef.getURI();
 70         DOMCryptoContext dcc = (DOMCryptoContext) context;
 71         String baseURI = context.getBaseURI();
 72 
 73         boolean secVal = Utils.secureValidation(context);
 74 
 75         if (secVal &amp;&amp; Policy.restrictReferenceUriScheme(uri)) {
 76             throw new URIReferenceException(
 77                 &quot;Uri &quot; + uri + &quot; is forbidden when secure validation is enabled&quot;);
 78         }
 79 
 80         // Check if same-document URI and already registered on the context
 81         if (uri != null &amp;&amp; uri.length() != 0 &amp;&amp; uri.charAt(0) == &#39;#&#39;) {
 82             String id = uri.substring(1);
 83 
 84             if (id.startsWith(&quot;xpointer(id(&quot;)) {
 85                 int i1 = id.indexOf(&#39;\&#39;&#39;);
 86                 int i2 = id.indexOf(&#39;\&#39;&#39;, i1+1);
 87                 id = id.substring(i1+1, i2);
 88             }
 89 
 90             // check if element is registered by Id
 91             Node referencedElem = uriAttr.getOwnerDocument().getElementById(id);
 92             if (referencedElem == null) {
 93                // see if element is registered in DOMCryptoContext
 94                referencedElem = dcc.getElementById(id);
 95             }
 96             if (referencedElem != null) {
 97                 if (secVal &amp;&amp; Policy.restrictDuplicateIds()) {
 98                     Element start = referencedElem.getOwnerDocument().getDocumentElement();
 99                     if (!XMLUtils.protectAgainstWrappingAttack(start, (Element)referencedElem, id)) {
100                         String error = &quot;Multiple Elements with the same ID &quot;
101                             + id + &quot; detected when secure validation&quot;
102                             + &quot; is enabled&quot;;
103                         throw new URIReferenceException(error);
104                     }
105                 }
106 
107                 XMLSignatureInput result = new XMLSignatureInput(referencedElem);
108                 result.setSecureValidation(secVal);
109                 if (!uri.substring(1).startsWith(&quot;xpointer(id(&quot;)) {
110                     result.setExcludeComments(true);
111                 }
112 
113                 result.setMIMEType(&quot;text/xml&quot;);
114                 if (baseURI != null &amp;&amp; baseURI.length() &gt; 0) {
115                     result.setSourceURI(baseURI.concat(uriAttr.getNodeValue()));
116                 } else {
117                     result.setSourceURI(uriAttr.getNodeValue());
118                 }
119                 return new ApacheNodeSetData(result);
120             }
121         }
122 
123         try {
124             ResourceResolver apacheResolver =
125                 ResourceResolver.getInstance(uriAttr, baseURI, false);
126             XMLSignatureInput in = apacheResolver.resolve(uriAttr, baseURI, false);
127             if (in.isOctetStream()) {
128                 return new ApacheOctetStreamData(in);
129             } else {
130                 return new ApacheNodeSetData(in);
131             }
132         } catch (Exception e) {
133             throw new URIReferenceException(e);
134         }
135     }
136 }
    </pre>
  </body>
</html>