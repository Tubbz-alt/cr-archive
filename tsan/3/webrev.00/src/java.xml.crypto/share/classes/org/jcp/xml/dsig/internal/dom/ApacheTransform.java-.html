<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/ApacheTransform.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
 24  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.
 25  */
 26 /*
 27  * $Id: ApacheTransform.java 1788465 2017-03-24 15:10:51Z coheigea $
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
 31 import java.io.OutputStream;
 32 import java.security.InvalidAlgorithmParameterException;
 33 import java.security.spec.AlgorithmParameterSpec;
 34 import java.util.Set;
 35 
 36 import org.w3c.dom.Document;
 37 import org.w3c.dom.Element;
 38 import org.w3c.dom.Node;
 39 import com.sun.org.apache.xml.internal.security.signature.XMLSignatureInput;
 40 import com.sun.org.apache.xml.internal.security.transforms.Transform;
 41 
 42 import javax.xml.crypto.*;
 43 import javax.xml.crypto.dom.DOMCryptoContext;
 44 import javax.xml.crypto.dsig.*;
 45 import javax.xml.crypto.dsig.spec.TransformParameterSpec;
 46 
 47 /**
 48  * This is a wrapper/glue class which invokes the Apache XML-Security
 49  * Transform.
 50  *
 51  */
 52 public abstract class ApacheTransform extends TransformService {
 53 
 54     static {
 55         com.sun.org.apache.xml.internal.security.Init.init();
 56     }
 57 
 58     private static final com.sun.org.slf4j.internal.Logger LOG =
 59         com.sun.org.slf4j.internal.LoggerFactory.getLogger(ApacheTransform.class);
 60     private Transform apacheTransform;
 61     protected Document ownerDoc;
 62     protected Element transformElem;
 63     protected TransformParameterSpec params;
 64 
 65     @Override
 66     public final AlgorithmParameterSpec getParameterSpec() {
 67         return params;
 68     }
 69 
 70     public void init(XMLStructure parent, XMLCryptoContext context)
 71         throws InvalidAlgorithmParameterException
 72     {
 73         if (context != null &amp;&amp; !(context instanceof DOMCryptoContext)) {
 74             throw new ClassCastException
 75                 (&quot;context must be of type DOMCryptoContext&quot;);
 76         }
 77         if (parent == null) {
 78             throw new NullPointerException();
 79         }
 80         if (!(parent instanceof javax.xml.crypto.dom.DOMStructure)) {
 81             throw new ClassCastException(&quot;parent must be of type DOMStructure&quot;);
 82         }
 83         transformElem = (Element)
 84             ((javax.xml.crypto.dom.DOMStructure) parent).getNode();
 85         ownerDoc = DOMUtils.getOwnerDocument(transformElem);
 86     }
 87 
 88     public void marshalParams(XMLStructure parent, XMLCryptoContext context)
 89         throws MarshalException
 90     {
 91         if (context != null &amp;&amp; !(context instanceof DOMCryptoContext)) {
 92             throw new ClassCastException
 93                 (&quot;context must be of type DOMCryptoContext&quot;);
 94         }
 95         if (parent == null) {
 96             throw new NullPointerException();
 97         }
 98         if (!(parent instanceof javax.xml.crypto.dom.DOMStructure)) {
 99             throw new ClassCastException(&quot;parent must be of type DOMStructure&quot;);
100         }
101         transformElem = (Element)
102             ((javax.xml.crypto.dom.DOMStructure) parent).getNode();
103         ownerDoc = DOMUtils.getOwnerDocument(transformElem);
104     }
105 
106     public Data transform(Data data, XMLCryptoContext xc)
107         throws TransformException
108     {
109         if (data == null) {
110             throw new NullPointerException(&quot;data must not be null&quot;);
111         }
112         return transformIt(data, xc, null);
113     }
114 
115     public Data transform(Data data, XMLCryptoContext xc, OutputStream os)
116         throws TransformException
117     {
118         if (data == null) {
119             throw new NullPointerException(&quot;data must not be null&quot;);
120         }
121         if (os == null) {
122             throw new NullPointerException(&quot;output stream must not be null&quot;);
123         }
124         return transformIt(data, xc, os);
125     }
126 
127     private Data transformIt(Data data, XMLCryptoContext xc, OutputStream os)
128         throws TransformException
129     {
130         if (ownerDoc == null) {
131             throw new TransformException(&quot;transform must be marshalled&quot;);
132         }
133 
134         if (apacheTransform == null) {
135             try {
136                 apacheTransform =
137                     new Transform(ownerDoc, getAlgorithm(), transformElem.getChildNodes());
138                 apacheTransform.setElement(transformElem, xc.getBaseURI());
139                 boolean secVal = Utils.secureValidation(xc);
140                 apacheTransform.setSecureValidation(secVal);
141                 LOG.debug(&quot;Created transform for algorithm: {}&quot;, getAlgorithm());
142             } catch (Exception ex) {
143                 throw new TransformException(&quot;Couldn&#39;t find Transform for: &quot; +
144                                              getAlgorithm(), ex);
145             }
146         }
147 
148         if (Utils.secureValidation(xc)) {
149             String algorithm = getAlgorithm();
150             if (Policy.restrictAlg(algorithm)) {
151                 throw new TransformException(
152                     &quot;Transform &quot; + algorithm + &quot; is forbidden when secure validation is enabled&quot;
153                 );
154             }
155         }
156 
157         XMLSignatureInput in;
158         if (data instanceof ApacheData) {
159             LOG.debug(&quot;ApacheData = true&quot;);
160             in = ((ApacheData)data).getXMLSignatureInput();
161         } else if (data instanceof NodeSetData) {
162             LOG.debug(&quot;isNodeSet() = true&quot;);
163             if (data instanceof DOMSubTreeData) {
164                 LOG.debug(&quot;DOMSubTreeData = true&quot;);
165                 DOMSubTreeData subTree = (DOMSubTreeData)data;
166                 in = new XMLSignatureInput(subTree.getRoot());
167                 in.setExcludeComments(subTree.excludeComments());
168             } else {
169                 @SuppressWarnings(&quot;unchecked&quot;)
170                 Set&lt;Node&gt; nodeSet =
171                     Utils.toNodeSet(((NodeSetData)data).iterator());
172                 in = new XMLSignatureInput(nodeSet);
173             }
174         } else {
175             LOG.debug(&quot;isNodeSet() = false&quot;);
176             try {
177                 in = new XMLSignatureInput
178                     (((OctetStreamData)data).getOctetStream());
179             } catch (Exception ex) {
180                 throw new TransformException(ex);
181             }
182         }
183         boolean secVal = Utils.secureValidation(xc);
184         in.setSecureValidation(secVal);
185 
186         try {
187             if (os != null) {
188                 in = apacheTransform.performTransform(in, os);
189                 if (!in.isNodeSet() &amp;&amp; !in.isElement()) {
190                     return null;
191                 }
192             } else {
193                 in = apacheTransform.performTransform(in);
194             }
195             if (in.isOctetStream()) {
196                 return new ApacheOctetStreamData(in);
197             } else {
198                 return new ApacheNodeSetData(in);
199             }
200         } catch (Exception ex) {
201             throw new TransformException(ex);
202         }
203     }
204 
205     public final boolean isFeatureSupported(String feature) {
206         if (feature == null) {
207             throw new NullPointerException();
208         } else {
209             return false;
210         }
211     }
212 }
    </pre>
  </body>
</html>