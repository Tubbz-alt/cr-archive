<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMX509Data.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
 24  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.
 25  */
 26 /*
 27  * $Id: DOMX509Data.java 1854026 2019-02-21 09:30:01Z coheigea $
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
 31 import java.io.ByteArrayInputStream;
 32 import java.io.IOException;
 33 import java.security.cert.*;
 34 import java.util.*;
 35 
 36 import javax.security.auth.x500.X500Principal;
 37 import javax.xml.crypto.MarshalException;
 38 import javax.xml.crypto.XMLStructure;
 39 import javax.xml.crypto.dom.DOMCryptoContext;
 40 import javax.xml.crypto.dsig.XMLSignature;
 41 import javax.xml.crypto.dsig.keyinfo.X509Data;
 42 import javax.xml.crypto.dsig.keyinfo.X509IssuerSerial;
 43 
 44 import org.w3c.dom.Document;
 45 import org.w3c.dom.Element;
 46 import org.w3c.dom.Node;
 47 
 48 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 49 
 50 /**
 51  * DOM-based implementation of X509Data.
 52  *
 53  */
 54 //@@@ check for illegal combinations of data violating MUSTs in W3c spec
 55 public final class DOMX509Data extends DOMStructure implements X509Data {
 56 
 57     private final List&lt;Object&gt; content;
 58     private CertificateFactory cf;
 59 
 60     /**
 61      * Creates a DOMX509Data.
 62      *
 63      * @param content a list of one or more X.509 data types. Valid types are
 64      *    {@link String} (subject names), {@code byte[]} (subject key ids),
 65      *    {@link java.security.cert.X509Certificate}, {@link X509CRL},
 66      *    or {@link javax.xml.dsig.XMLStructure}
 67      *    objects or elements from an external namespace). The list is
 68      *    defensively copied to protect against subsequent modification.
 69      * @throws NullPointerException if {@code content} is {@code null}
 70      * @throws IllegalArgumentException if {@code content} is empty
 71      * @throws ClassCastException if {@code content} contains any entries
 72      *    that are not of one of the valid types mentioned above
 73      */
 74     public DOMX509Data(List&lt;?&gt; content) {
 75         if (content == null) {
 76             throw new NullPointerException(&quot;content cannot be null&quot;);
 77         }
 78         List&lt;Object&gt; contentCopy = new ArrayList&lt;&gt;(content);
 79         if (contentCopy.isEmpty()) {
 80             throw new IllegalArgumentException(&quot;content cannot be empty&quot;);
 81         }
 82         for (int i = 0, size = contentCopy.size(); i &lt; size; i++) {
 83             Object x509Type = contentCopy.get(i);
 84             if (x509Type instanceof String) {
 85                 new X500Principal((String)x509Type);
 86             } else if (!(x509Type instanceof byte[]) &amp;&amp;
 87                 !(x509Type instanceof X509Certificate) &amp;&amp;
 88                 !(x509Type instanceof X509CRL) &amp;&amp;
 89                 !(x509Type instanceof XMLStructure)) {
 90                 throw new ClassCastException
 91                     (&quot;content[&quot;+i+&quot;] is not a valid X509Data type&quot;);
 92             }
 93         }
 94         this.content = Collections.unmodifiableList(contentCopy);
 95     }
 96 
 97     /**
 98      * Creates a {@code DOMX509Data} from an element.
 99      *
100      * @param xdElem an X509Data element
101      * @throws MarshalException if there is an error while unmarshalling
102      */
103     public DOMX509Data(Element xdElem) throws MarshalException {
104         // get all children nodes
105         List&lt;Object&gt; newContent = new ArrayList&lt;&gt;();
106         Node firstChild = xdElem.getFirstChild();
107         while (firstChild != null) {
108             if (firstChild.getNodeType() == Node.ELEMENT_NODE) {
109                 Element childElem = (Element)firstChild;
110                 String localName = childElem.getLocalName();
111                 String namespace = childElem.getNamespaceURI();
112                 if (&quot;X509Certificate&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
113                     newContent.add(unmarshalX509Certificate(childElem));
114                 } else if (&quot;X509IssuerSerial&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
115                     newContent.add(new DOMX509IssuerSerial(childElem));
116                 } else if (&quot;X509SubjectName&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
117                     newContent.add(childElem.getFirstChild().getNodeValue());
118                 } else if (&quot;X509SKI&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
119                     String content = XMLUtils.getFullTextChildrenFromNode(childElem);
120                     newContent.add(XMLUtils.decode(content));
121                 } else if (&quot;X509CRL&quot;.equals(localName) &amp;&amp; XMLSignature.XMLNS.equals(namespace)) {
122                     newContent.add(unmarshalX509CRL(childElem));
123                 } else {
124                     newContent.add(new javax.xml.crypto.dom.DOMStructure(childElem));
125                 }
126             }
127             firstChild = firstChild.getNextSibling();
128         }
129         this.content = Collections.unmodifiableList(newContent);
130     }
131 
132     public List&lt;Object&gt; getContent() {
133         return content;
134     }
135 
136     @Override
137     public void marshal(Node parent, String dsPrefix, DOMCryptoContext context)
138         throws MarshalException
139     {
140         Document ownerDoc = DOMUtils.getOwnerDocument(parent);
141         Element xdElem = DOMUtils.createElement(ownerDoc, &quot;X509Data&quot;,
142                                                 XMLSignature.XMLNS, dsPrefix);
143 
144         // append children and preserve order
145         for (int i = 0, size = content.size(); i &lt; size; i++) {
146             Object object = content.get(i);
147             if (object instanceof X509Certificate) {
148                 marshalCert((X509Certificate)object,xdElem,ownerDoc,dsPrefix);
149             } else if (object instanceof XMLStructure) {
150                 if (object instanceof X509IssuerSerial) {
151                     ((DOMX509IssuerSerial)object).marshal
152                         (xdElem, dsPrefix, context);
153                 } else {
154                     javax.xml.crypto.dom.DOMStructure domContent =
155                         (javax.xml.crypto.dom.DOMStructure)object;
156                     DOMUtils.appendChild(xdElem, domContent.getNode());
157                 }
158             } else if (object instanceof byte[]) {
159                 marshalSKI((byte[])object, xdElem, ownerDoc, dsPrefix);
160             } else if (object instanceof String) {
161                 marshalSubjectName((String)object, xdElem, ownerDoc,dsPrefix);
162             } else if (object instanceof X509CRL) {
163                 marshalCRL((X509CRL)object, xdElem, ownerDoc, dsPrefix);
164             }
165         }
166 
167         parent.appendChild(xdElem);
168     }
169 
170     private void marshalSKI(byte[] skid, Node parent, Document doc,
171                             String dsPrefix)
172     {
173         Element skidElem = DOMUtils.createElement(doc, &quot;X509SKI&quot;,
174                                                   XMLSignature.XMLNS, dsPrefix);
175         skidElem.appendChild(doc.createTextNode(XMLUtils.encodeToString(skid)));
176         parent.appendChild(skidElem);
177     }
178 
179     private void marshalSubjectName(String name, Node parent, Document doc,
180                                     String dsPrefix)
181     {
182         Element snElem = DOMUtils.createElement(doc, &quot;X509SubjectName&quot;,
183                                                 XMLSignature.XMLNS, dsPrefix);
184         snElem.appendChild(doc.createTextNode(name));
185         parent.appendChild(snElem);
186     }
187 
188     private void marshalCert(X509Certificate cert, Node parent, Document doc,
189                              String dsPrefix)
190         throws MarshalException
191     {
192         Element certElem = DOMUtils.createElement(doc, &quot;X509Certificate&quot;,
193                                                   XMLSignature.XMLNS, dsPrefix);
194         try {
195             certElem.appendChild(doc.createTextNode
196                                  (XMLUtils.encodeToString(cert.getEncoded())));
197         } catch (CertificateEncodingException e) {
198             throw new MarshalException(&quot;Error encoding X509Certificate&quot;, e);
199         }
200         parent.appendChild(certElem);
201     }
202 
203     private void marshalCRL(X509CRL crl, Node parent, Document doc,
204                             String dsPrefix)
205         throws MarshalException
206     {
207         Element crlElem = DOMUtils.createElement(doc, &quot;X509CRL&quot;,
208                                                  XMLSignature.XMLNS, dsPrefix);
209         try {
210             crlElem.appendChild(doc.createTextNode
211                                 (XMLUtils.encodeToString(crl.getEncoded())));
212         } catch (CRLException e) {
213             throw new MarshalException(&quot;Error encoding X509CRL&quot;, e);
214         }
215         parent.appendChild(crlElem);
216     }
217 
218     private X509Certificate unmarshalX509Certificate(Element elem)
219         throws MarshalException
220     {
221         try (ByteArrayInputStream bs = unmarshalBase64Binary(elem)) {
222             return (X509Certificate)cf.generateCertificate(bs);
223         } catch (CertificateException e) {
224             throw new MarshalException(&quot;Cannot create X509Certificate&quot;, e);
225         } catch (IOException e) {
226             throw new MarshalException(&quot;Error closing stream&quot;, e);
227         }
228     }
229 
230     private X509CRL unmarshalX509CRL(Element elem) throws MarshalException {
231         try (ByteArrayInputStream bs = unmarshalBase64Binary(elem)) {
232             return (X509CRL)cf.generateCRL(bs);
233         } catch (CRLException e) {
234             throw new MarshalException(&quot;Cannot create X509CRL&quot;, e);
235         } catch (IOException e) {
236             throw new MarshalException(&quot;Error closing stream&quot;, e);
237         }
238     }
239 
240     private ByteArrayInputStream unmarshalBase64Binary(Element elem)
241         throws MarshalException {
242         try {
243             if (cf == null) {
244                 cf = CertificateFactory.getInstance(&quot;X.509&quot;);
245             }
246             String content = XMLUtils.getFullTextChildrenFromNode(elem);
247             return new ByteArrayInputStream(XMLUtils.decode(content));
248         } catch (CertificateException e) {
249             throw new MarshalException(&quot;Cannot create CertificateFactory&quot;, e);
250         }
251     }
252 
253     @Override
254     public boolean equals(Object o) {
255         if (this == o) {
256             return true;
257         }
258 
259         if (!(o instanceof X509Data)) {
260             return false;
261         }
262         X509Data oxd = (X509Data)o;
263 
264         List&lt;?&gt; ocontent = oxd.getContent();
265         int size = content.size();
266         if (size != ocontent.size()) {
267             return false;
268         }
269 
270         for (int i = 0; i &lt; size; i++) {
271             Object x = content.get(i);
272             Object ox = ocontent.get(i);
273             if (x instanceof byte[]) {
274                 if (!(ox instanceof byte[]) ||
275                     !Arrays.equals((byte[])x, (byte[])ox)) {
276                     return false;
277                 }
278             } else {
279                 if (!(x.equals(ox))) {
280                     return false;
281                 }
282             }
283         }
284 
285         return true;
286     }
287 
288     @Override
289     public int hashCode() {
290         int result = 17;
291         result = 31 * result + content.hashCode();
292 
293         return result;
294     }
295 }
    </pre>
  </body>
</html>