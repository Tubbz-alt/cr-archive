<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMXPathTransform.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
 24  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.
 25  */
 26 /*
 27  * $Id: DOMXPathTransform.java 1854026 2019-02-21 09:30:01Z coheigea $
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
 31 import javax.xml.crypto.*;
 32 import javax.xml.crypto.dsig.*;
 33 import javax.xml.crypto.dsig.spec.TransformParameterSpec;
 34 import javax.xml.crypto.dsig.spec.XPathFilterParameterSpec;
 35 import java.security.InvalidAlgorithmParameterException;
 36 import java.util.HashMap;
 37 import java.util.Map;
 38 import java.util.Set;
 39 import org.w3c.dom.Attr;
 40 import org.w3c.dom.Element;
 41 import org.w3c.dom.NamedNodeMap;
 42 
 43 /**
 44  * DOM-based implementation of XPath Filtering Transform.
 45  * (Uses Apache XML-Sec Transform implementation)
 46  *
 47  */
 48 public final class DOMXPathTransform extends ApacheTransform {
 49 
 50     @Override
 51     public void init(TransformParameterSpec params)
 52         throws InvalidAlgorithmParameterException
 53     {
 54         if (params == null) {
 55             throw new InvalidAlgorithmParameterException(&quot;params are required&quot;);
 56         } else if (!(params instanceof XPathFilterParameterSpec)) {
 57             throw new InvalidAlgorithmParameterException
 58                 (&quot;params must be of type XPathFilterParameterSpec&quot;);
 59         }
 60         this.params = params;
 61     }
 62 
 63     public void init(XMLStructure parent, XMLCryptoContext context)
 64         throws InvalidAlgorithmParameterException
 65     {
 66         super.init(parent, context);
 67         unmarshalParams(DOMUtils.getFirstChildElement(transformElem));
 68     }
 69 
 70     private void unmarshalParams(Element paramsElem) {
 71         String xPath = paramsElem.getFirstChild().getNodeValue();
 72         // create a Map of namespace prefixes
 73         NamedNodeMap attributes = paramsElem.getAttributes();
 74         if (attributes != null) {
 75             int length = attributes.getLength();
 76             Map&lt;String, String&gt; namespaceMap =
 77                 new HashMap&lt;&gt;(length);
 78             for (int i = 0; i &lt; length; i++) {
 79                 Attr attr = (Attr)attributes.item(i);
 80                 String prefix = attr.getPrefix();
 81                 if (prefix != null &amp;&amp; &quot;xmlns&quot;.equals(prefix)) {
 82                     namespaceMap.put(attr.getLocalName(), attr.getValue());
 83                 }
 84             }
 85             this.params = new XPathFilterParameterSpec(xPath, namespaceMap);
 86         } else {
 87             this.params = new XPathFilterParameterSpec(xPath);
 88         }
 89     }
 90 
 91     public void marshalParams(XMLStructure parent, XMLCryptoContext context)
 92         throws MarshalException
 93     {
 94         super.marshalParams(parent, context);
 95         XPathFilterParameterSpec xp =
 96             (XPathFilterParameterSpec)getParameterSpec();
 97         Element xpathElem = DOMUtils.createElement(ownerDoc, &quot;XPath&quot;,
 98              XMLSignature.XMLNS, DOMUtils.getSignaturePrefix(context));
 99         xpathElem.appendChild(ownerDoc.createTextNode(xp.getXPath()));
100 
101         // add namespace attributes, if necessary
102         @SuppressWarnings(&quot;unchecked&quot;)
103         Set&lt;Map.Entry&lt;String, String&gt;&gt; entries =
104             xp.getNamespaceMap().entrySet();
105         for (Map.Entry&lt;String, String&gt; entry : entries) {
106             xpathElem.setAttributeNS(&quot;http://www.w3.org/2000/xmlns/&quot;, &quot;xmlns:&quot; +
107                                      entry.getKey(),
108                                      entry.getValue());
109         }
110 
111         transformElem.appendChild(xpathElem);
112     }
113 }
    </pre>
  </body>
</html>