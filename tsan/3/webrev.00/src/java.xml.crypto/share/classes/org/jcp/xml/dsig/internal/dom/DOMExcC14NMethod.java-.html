<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMExcC14NMethod.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
 24  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.
 25  */
 26 /*
 27  * $Id: DOMExcC14NMethod.java 1788465 2017-03-24 15:10:51Z coheigea $
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
 31 import javax.xml.crypto.*;
 32 import javax.xml.crypto.dsig.*;
 33 import javax.xml.crypto.dsig.spec.C14NMethodParameterSpec;
 34 import javax.xml.crypto.dsig.spec.ExcC14NParameterSpec;
 35 import javax.xml.crypto.dsig.spec.TransformParameterSpec;
 36 
 37 import java.security.InvalidAlgorithmParameterException;
 38 import java.security.spec.AlgorithmParameterSpec;
 39 import java.util.*;
 40 
 41 import org.w3c.dom.Element;
 42 import com.sun.org.apache.xml.internal.security.c14n.Canonicalizer;
 43 import com.sun.org.apache.xml.internal.security.c14n.InvalidCanonicalizerException;
 44 
 45 /**
 46  * DOM-based implementation of CanonicalizationMethod for Exclusive
 47  * Canonical XML algorithm (with or without comments).
 48  * Uses Apache XML-Sec Canonicalizer.
 49  *
 50  */
 51 public final class DOMExcC14NMethod extends ApacheCanonicalizer {
 52 
 53     public void init(TransformParameterSpec params)
 54         throws InvalidAlgorithmParameterException
 55     {
 56         if (params != null) {
 57             if (!(params instanceof ExcC14NParameterSpec)) {
 58                 throw new InvalidAlgorithmParameterException
 59                     (&quot;params must be of type ExcC14NParameterSpec&quot;);
 60             }
 61             this.params = (C14NMethodParameterSpec)params;
 62         }
 63     }
 64 
 65     public void init(XMLStructure parent, XMLCryptoContext context)
 66         throws InvalidAlgorithmParameterException
 67     {
 68         super.init(parent, context);
 69         Element paramsElem = DOMUtils.getFirstChildElement(transformElem);
 70         if (paramsElem == null) {
 71             this.params = null;
 72             this.inclusiveNamespaces = null;
 73             return;
 74         }
 75         unmarshalParams(paramsElem);
 76     }
 77 
 78     private void unmarshalParams(Element paramsElem) {
 79         String prefixListAttr = paramsElem.getAttributeNS(null, &quot;PrefixList&quot;);
 80         this.inclusiveNamespaces = prefixListAttr;
 81         int begin = 0;
 82         int end = prefixListAttr.indexOf(&#39; &#39;);
 83         List&lt;String&gt; prefixList = new ArrayList&lt;&gt;();
 84         while (end != -1) {
 85             prefixList.add(prefixListAttr.substring(begin, end));
 86             begin = end + 1;
 87             end = prefixListAttr.indexOf(&#39; &#39;, begin);
 88         }
 89         if (begin &lt;= prefixListAttr.length()) {
 90             prefixList.add(prefixListAttr.substring(begin));
 91         }
 92         this.params = new ExcC14NParameterSpec(prefixList);
 93     }
 94 
 95     @SuppressWarnings(&quot;unchecked&quot;)
 96     public List&lt;String&gt; getParameterSpecPrefixList(ExcC14NParameterSpec paramSpec) {
 97         return paramSpec.getPrefixList();
 98     }
 99 
100     @Override
101     public void marshalParams(XMLStructure parent, XMLCryptoContext context)
102         throws MarshalException
103     {
104         super.marshalParams(parent, context);
105         AlgorithmParameterSpec spec = getParameterSpec();
106         if (spec == null) {
107             return;
108         }
109 
110         String prefix = DOMUtils.getNSPrefix(context,
111                                              CanonicalizationMethod.EXCLUSIVE);
112         Element eElem = DOMUtils.createElement(ownerDoc,
113                                                &quot;InclusiveNamespaces&quot;,
114                                                CanonicalizationMethod.EXCLUSIVE,
115                                                prefix);
116         if (prefix == null || prefix.length() == 0) {
117             eElem.setAttributeNS(&quot;http://www.w3.org/2000/xmlns/&quot;, &quot;xmlns&quot;,
118                                  CanonicalizationMethod.EXCLUSIVE);
119         } else {
120             eElem.setAttributeNS(&quot;http://www.w3.org/2000/xmlns/&quot;,
121                                    &quot;xmlns:&quot; + prefix,
122                                    CanonicalizationMethod.EXCLUSIVE);
123         }
124 
125         ExcC14NParameterSpec params = (ExcC14NParameterSpec)spec;
126         StringBuilder prefixListAttr = new StringBuilder(&quot;&quot;);
127         List&lt;String&gt; prefixList = getParameterSpecPrefixList(params);
128         for (int i = 0, size = prefixList.size(); i &lt; size; i++) {
129             prefixListAttr.append(prefixList.get(i));
130             if (i &lt; size - 1) {
131                 prefixListAttr.append(&quot; &quot;);
132             }
133         }
134         DOMUtils.setAttribute(eElem, &quot;PrefixList&quot;, prefixListAttr.toString());
135         this.inclusiveNamespaces = prefixListAttr.toString();
136         transformElem.appendChild(eElem);
137     }
138 
139     public String getParamsNSURI() {
140         return CanonicalizationMethod.EXCLUSIVE;
141     }
142 
143     public Data transform(Data data, XMLCryptoContext xc)
144         throws TransformException
145     {
146         // ignore comments if dereferencing same-document URI that require
147         // you to omit comments, even if the Transform says otherwise -
148         // this is to be compliant with section 4.3.3.3 of W3C Rec.
149         if (data instanceof DOMSubTreeData) {
150             DOMSubTreeData subTree = (DOMSubTreeData)data;
151             if (subTree.excludeComments()) {
152                 try {
153                     apacheCanonicalizer = Canonicalizer.getInstance
154                         (CanonicalizationMethod.EXCLUSIVE);
155                     boolean secVal = Utils.secureValidation(xc);
156                     apacheCanonicalizer.setSecureValidation(secVal);
157                 } catch (InvalidCanonicalizerException ice) {
158                     throw new TransformException
159                         (&quot;Couldn&#39;t find Canonicalizer for: &quot; +
160                          CanonicalizationMethod.EXCLUSIVE + &quot;: &quot; +
161                          ice.getMessage(), ice);
162                 }
163             }
164         }
165 
166         return canonicalize(data, xc);
167     }
168 }
    </pre>
  </body>
</html>