<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMHMACSignatureMethod.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * reserved comment block
  3  * DO NOT REMOVE OR ALTER!
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
<a name="1" id="anc1"></a><span class="line-modified"> 24  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
 25  */
 26 /*
<a name="2" id="anc2"></a><span class="line-modified"> 27  * $Id: DOMHMACSignatureMethod.java 1854026 2019-02-21 09:30:01Z coheigea $</span>
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
 31 import javax.xml.crypto.*;
 32 import javax.xml.crypto.dsig.*;
 33 import javax.xml.crypto.dsig.spec.HMACParameterSpec;
 34 import javax.xml.crypto.dsig.spec.SignatureMethodParameterSpec;
 35 
 36 import java.security.InvalidAlgorithmParameterException;
 37 import java.security.InvalidKeyException;
 38 import java.security.Key;
 39 import java.security.MessageDigest;
 40 import java.security.NoSuchAlgorithmException;
 41 import java.security.SignatureException;
 42 import java.security.spec.AlgorithmParameterSpec;
 43 import javax.crypto.Mac;
 44 import javax.crypto.SecretKey;
 45 import org.w3c.dom.Document;
 46 import org.w3c.dom.Element;
 47 
 48 import org.jcp.xml.dsig.internal.MacOutputStream;
 49 
 50 /**
 51  * DOM-based implementation of HMAC SignatureMethod.
 52  *
 53  */
 54 public abstract class DOMHMACSignatureMethod extends AbstractDOMSignatureMethod {
 55 
 56     private static final com.sun.org.slf4j.internal.Logger LOG =
 57         com.sun.org.slf4j.internal.LoggerFactory.getLogger(DOMHMACSignatureMethod.class);
 58 
 59     // see RFC 4051 for these algorithm definitions
 60     static final String HMAC_SHA224 =
 61         &quot;http://www.w3.org/2001/04/xmldsig-more#hmac-sha224&quot;;
 62     static final String HMAC_SHA256 =
 63         &quot;http://www.w3.org/2001/04/xmldsig-more#hmac-sha256&quot;;
 64     static final String HMAC_SHA384 =
 65         &quot;http://www.w3.org/2001/04/xmldsig-more#hmac-sha384&quot;;
 66     static final String HMAC_SHA512 =
 67         &quot;http://www.w3.org/2001/04/xmldsig-more#hmac-sha512&quot;;
 68     static final String HMAC_RIPEMD160 =
 69         &quot;http://www.w3.org/2001/04/xmldsig-more#hmac-ripemd160&quot;;
 70 
 71     private Mac hmac;
 72     private int outputLength;
 73     private boolean outputLengthSet;
 74     private SignatureMethodParameterSpec params;
 75 
 76     /**
 77      * Creates a {@code DOMHMACSignatureMethod} with the specified params
 78      *
 79      * @param params algorithm-specific parameters (may be {@code null})
 80      * @throws InvalidAlgorithmParameterException if params are inappropriate
 81      */
 82     DOMHMACSignatureMethod(AlgorithmParameterSpec params)
 83         throws InvalidAlgorithmParameterException
 84     {
 85         checkParams((SignatureMethodParameterSpec)params);
 86         this.params = (SignatureMethodParameterSpec)params;
 87     }
 88 
 89     /**
 90      * Creates a {@code DOMHMACSignatureMethod} from an element.
 91      *
 92      * @param smElem a SignatureMethod element
 93      */
 94     DOMHMACSignatureMethod(Element smElem) throws MarshalException {
 95         Element paramsElem = DOMUtils.getFirstChildElement(smElem);
 96         if (paramsElem != null) {
 97             params = unmarshalParams(paramsElem);
 98         }
 99         try {
100             checkParams(params);
101         } catch (InvalidAlgorithmParameterException iape) {
102             throw new MarshalException(iape);
103         }
104     }
105 
106     @Override
107     void checkParams(SignatureMethodParameterSpec params)
108         throws InvalidAlgorithmParameterException
109     {
110         if (params != null) {
111             if (!(params instanceof HMACParameterSpec)) {
112                 throw new InvalidAlgorithmParameterException
113                     (&quot;params must be of type HMACParameterSpec&quot;);
114             }
115             outputLength = ((HMACParameterSpec)params).getOutputLength();
116             outputLengthSet = true;
117             LOG.debug(&quot;Setting outputLength from HMACParameterSpec to: {}&quot;, outputLength);
118         }
119     }
120 
121     public final AlgorithmParameterSpec getParameterSpec() {
122         return params;
123     }
124 
125     SignatureMethodParameterSpec unmarshalParams(Element paramsElem)
126         throws MarshalException
127     {
128         outputLength = Integer.parseInt(paramsElem.getFirstChild().getNodeValue());
129         outputLengthSet = true;
130         LOG.debug(&quot;unmarshalled outputLength: {}&quot;, outputLength);
131         return new HMACParameterSpec(outputLength);
132     }
133 
134     void marshalParams(Element parent, String prefix)
135         throws MarshalException
136     {
137         Document ownerDoc = DOMUtils.getOwnerDocument(parent);
138         Element hmacElem = DOMUtils.createElement(ownerDoc, &quot;HMACOutputLength&quot;,
139                                                   XMLSignature.XMLNS, prefix);
140         hmacElem.appendChild(ownerDoc.createTextNode
141            (String.valueOf(outputLength)));
142 
143         parent.appendChild(hmacElem);
144     }
145 
146     boolean verify(Key key, SignedInfo si, byte[] sig,
147                    XMLValidateContext context)
148         throws InvalidKeyException, SignatureException, XMLSignatureException
149     {
150         if (key == null || si == null || sig == null) {
151             throw new NullPointerException();
152         }
153         if (!(key instanceof SecretKey)) {
154             throw new InvalidKeyException(&quot;key must be SecretKey&quot;);
155         }
156         if (hmac == null) {
157             try {
158                 hmac = Mac.getInstance(getJCAAlgorithm());
159             } catch (NoSuchAlgorithmException nsae) {
160                 throw new XMLSignatureException(nsae);
161             }
162         }
163         if (outputLengthSet &amp;&amp; outputLength &lt; getDigestLength()) {
164             throw new XMLSignatureException
165                 (&quot;HMACOutputLength must not be less than &quot; + getDigestLength());
166         }
167         hmac.init(key);
168         ((DOMSignedInfo)si).canonicalize(context, new MacOutputStream(hmac));
169         byte[] result = hmac.doFinal();
170 
171         return MessageDigest.isEqual(sig, result);
172     }
173 
174     byte[] sign(Key key, SignedInfo si, XMLSignContext context)
175         throws InvalidKeyException, XMLSignatureException
176     {
177         if (key == null || si == null) {
178             throw new NullPointerException();
179         }
180         if (!(key instanceof SecretKey)) {
181             throw new InvalidKeyException(&quot;key must be SecretKey&quot;);
182         }
183         if (hmac == null) {
184             try {
185                 hmac = Mac.getInstance(getJCAAlgorithm());
186             } catch (NoSuchAlgorithmException nsae) {
187                 throw new XMLSignatureException(nsae);
188             }
189         }
190         if (outputLengthSet &amp;&amp; outputLength &lt; getDigestLength()) {
191             throw new XMLSignatureException
192                 (&quot;HMACOutputLength must not be less than &quot; + getDigestLength());
193         }
194         hmac.init(key);
195         ((DOMSignedInfo)si).canonicalize(context, new MacOutputStream(hmac));
196         return hmac.doFinal();
197     }
198 
199     boolean paramsEqual(AlgorithmParameterSpec spec) {
200         if (getParameterSpec() == spec) {
201             return true;
202         }
203         if (!(spec instanceof HMACParameterSpec)) {
204             return false;
205         }
206         HMACParameterSpec ospec = (HMACParameterSpec)spec;
207 
208         return outputLength == ospec.getOutputLength();
209     }
210 
211     Type getAlgorithmType() {
212         return Type.HMAC;
213     }
214 
215     /**
216      * Returns the output length of the hash/digest.
217      */
218     abstract int getDigestLength();
219 
220     static final class SHA1 extends DOMHMACSignatureMethod {
221         SHA1(AlgorithmParameterSpec params)
222             throws InvalidAlgorithmParameterException {
223             super(params);
224         }
225         SHA1(Element dmElem) throws MarshalException {
226             super(dmElem);
227         }
228         public String getAlgorithm() {
229             return SignatureMethod.HMAC_SHA1;
230         }
231         String getJCAAlgorithm() {
232             return &quot;HmacSHA1&quot;;
233         }
234         int getDigestLength() {
235             return 160;
236         }
237     }
238 
239     static final class SHA224 extends DOMHMACSignatureMethod {
240         SHA224(AlgorithmParameterSpec params)
241             throws InvalidAlgorithmParameterException {
242             super(params);
243         }
244         SHA224(Element dmElem) throws MarshalException {
245             super(dmElem);
246         }
247         @Override
248         public String getAlgorithm() {
249             return HMAC_SHA224;
250         }
251         @Override
252         String getJCAAlgorithm() {
253             return &quot;HmacSHA224&quot;;
254         }
255         @Override
256         int getDigestLength() {
257             return 224;
258         }
259     }
260 
261     static final class SHA256 extends DOMHMACSignatureMethod {
262         SHA256(AlgorithmParameterSpec params)
263             throws InvalidAlgorithmParameterException {
264             super(params);
265         }
266         SHA256(Element dmElem) throws MarshalException {
267             super(dmElem);
268         }
269         public String getAlgorithm() {
270             return HMAC_SHA256;
271         }
272         String getJCAAlgorithm() {
273             return &quot;HmacSHA256&quot;;
274         }
275         int getDigestLength() {
276             return 256;
277         }
278     }
279 
280     static final class SHA384 extends DOMHMACSignatureMethod {
281         SHA384(AlgorithmParameterSpec params)
282             throws InvalidAlgorithmParameterException {
283             super(params);
284         }
285         SHA384(Element dmElem) throws MarshalException {
286             super(dmElem);
287         }
288         public String getAlgorithm() {
289             return HMAC_SHA384;
290         }
291         String getJCAAlgorithm() {
292             return &quot;HmacSHA384&quot;;
293         }
294         int getDigestLength() {
295             return 384;
296         }
297     }
298 
299     static final class SHA512 extends DOMHMACSignatureMethod {
300         SHA512(AlgorithmParameterSpec params)
301             throws InvalidAlgorithmParameterException {
302             super(params);
303         }
304         SHA512(Element dmElem) throws MarshalException {
305             super(dmElem);
306         }
307         public String getAlgorithm() {
308             return HMAC_SHA512;
309         }
310         String getJCAAlgorithm() {
311             return &quot;HmacSHA512&quot;;
312         }
313         int getDigestLength() {
314             return 512;
315         }
316     }
317 
318     static final class RIPEMD160 extends DOMHMACSignatureMethod {
319         RIPEMD160(AlgorithmParameterSpec params)
320             throws InvalidAlgorithmParameterException {
321             super(params);
322         }
323         RIPEMD160(Element dmElem) throws MarshalException {
324             super(dmElem);
325         }
326         @Override
327         public String getAlgorithm() {
328             return HMAC_RIPEMD160;
329         }
330         @Override
331         String getJCAAlgorithm() {
332             return &quot;HMACRIPEMD160&quot;;
333         }
334         @Override
335         int getDigestLength() {
336             return 160;
337         }
338     }
339 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>