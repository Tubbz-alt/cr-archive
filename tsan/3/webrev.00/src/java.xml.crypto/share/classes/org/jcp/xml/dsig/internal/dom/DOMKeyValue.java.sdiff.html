<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMKeyValue.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DOMKeyName.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DOMManifest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/java.xml.crypto/share/classes/org/jcp/xml/dsig/internal/dom/DOMKeyValue.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
<span class="line-modified"> 24  * Copyright (c) 2005, 2018, Oracle and/or its affiliates. All rights reserved.</span>
 25  */
 26 /*
<span class="line-modified"> 27  * $Id: DOMKeyValue.java 1788465 2017-03-24 15:10:51Z coheigea $</span>
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 
<span class="line-removed"> 31 import javax.xml.crypto.*;</span>
<span class="line-removed"> 32 import javax.xml.crypto.dom.DOMCryptoContext;</span>
<span class="line-removed"> 33 import javax.xml.crypto.dsig.*;</span>
<span class="line-removed"> 34 import javax.xml.crypto.dsig.keyinfo.KeyValue;</span>
<span class="line-removed"> 35 </span>
 36 import java.io.IOException;
 37 import java.math.BigInteger;
 38 import java.security.KeyException;
 39 import java.security.KeyFactory;
 40 import java.security.NoSuchAlgorithmException;
 41 import java.security.PublicKey;
 42 import java.security.interfaces.DSAParams;
 43 import java.security.interfaces.DSAPublicKey;
 44 import java.security.interfaces.ECPublicKey;
 45 import java.security.interfaces.RSAPublicKey;
 46 import java.security.spec.DSAPublicKeySpec;
 47 import java.security.spec.ECField;
 48 import java.security.spec.ECFieldFp;
 49 import java.security.spec.ECParameterSpec;
 50 import java.security.spec.ECPoint;
 51 import java.security.spec.ECPublicKeySpec;
 52 import java.security.spec.EllipticCurve;
 53 import java.security.spec.InvalidKeySpecException;
 54 import java.security.spec.KeySpec;
 55 import java.security.spec.RSAPublicKeySpec;
 56 import java.util.Arrays;
 57 





 58 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 59 import org.w3c.dom.Document;
 60 import org.w3c.dom.Element;
 61 import org.w3c.dom.Node;
 62 
 63 /**
 64  * DOM-based implementation of KeyValue.
 65  *
 66  */
 67 public abstract class DOMKeyValue&lt;K extends PublicKey&gt; extends DOMStructure implements KeyValue {
 68 
 69     private static final String XMLDSIG_11_XMLNS
 70         = &quot;http://www.w3.org/2009/xmldsig11#&quot;;
 71     private final K publicKey;
 72 
 73     public DOMKeyValue(K key) throws KeyException {
 74         if (key == null) {
 75             throw new NullPointerException(&quot;key cannot be null&quot;);
 76         }
 77         this.publicKey = key;
</pre>
<hr />
<pre>
483         @Override
484         void marshalPublicKey(Node parent, Document doc, String dsPrefix,
485                               DOMCryptoContext context)
486             throws MarshalException
487         {
488             String prefix = DOMUtils.getNSPrefix(context, XMLDSIG_11_XMLNS);
489             Element ecKeyValueElem = DOMUtils.createElement(doc, &quot;ECKeyValue&quot;,
490                                                             XMLDSIG_11_XMLNS,
491                                                             prefix);
492             Element namedCurveElem = DOMUtils.createElement(doc, &quot;NamedCurve&quot;,
493                                                             XMLDSIG_11_XMLNS,
494                                                             prefix);
495             Element publicKeyElem = DOMUtils.createElement(doc, &quot;PublicKey&quot;,
496                                                            XMLDSIG_11_XMLNS,
497                                                            prefix);
498             String oid = getCurveOid(ecParams);
499             if (oid == null) {
500                 throw new MarshalException(&quot;Invalid ECParameterSpec&quot;);
501             }
502             DOMUtils.setAttribute(namedCurveElem, &quot;URI&quot;, &quot;urn:oid:&quot; + oid);
<span class="line-modified">503             String qname = (prefix == null || prefix.length() == 0)</span>
504                        ? &quot;xmlns&quot; : &quot;xmlns:&quot; + prefix;
505             namedCurveElem.setAttributeNS(&quot;http://www.w3.org/2000/xmlns/&quot;,
506                                           qname, XMLDSIG_11_XMLNS);
507             ecKeyValueElem.appendChild(namedCurveElem);
508             String encoded = XMLUtils.encodeToString(ecPublicKey);
509             publicKeyElem.appendChild
510                 (DOMUtils.getOwnerDocument(publicKeyElem).createTextNode(encoded));
511             ecKeyValueElem.appendChild(publicKeyElem);
512             parent.appendChild(ecKeyValueElem);
513         }
514 
515         @Override
516         ECPublicKey unmarshalKeyValue(Element kvtElem)
517             throws MarshalException
518         {
519             if (eckf == null) {
520                 try {
521                     eckf = KeyFactory.getInstance(&quot;EC&quot;);
522                 } catch (NoSuchAlgorithmException e) {
523                     throw new RuntimeException
</pre>
<hr />
<pre>
537             } else if (curElem.getLocalName().equals(&quot;NamedCurve&quot;)
538                 &amp;&amp; XMLDSIG_11_XMLNS.equals(curElem.getNamespaceURI())) {
539                 String uri = DOMUtils.getAttributeValue(curElem, &quot;URI&quot;);
540                 // strip off &quot;urn:oid&quot;
541                 if (uri.startsWith(&quot;urn:oid:&quot;)) {
542                     String oid = uri.substring(&quot;urn:oid:&quot;.length());
543                     ecParams = getECParameterSpec(oid);
544                     if (ecParams == null) {
545                         throw new MarshalException(&quot;Invalid curve OID&quot;);
546                     }
547                 } else {
548                     throw new MarshalException(&quot;Invalid NamedCurve URI&quot;);
549                 }
550             } else {
551                 throw new MarshalException(&quot;Invalid ECKeyValue&quot;);
552             }
553             curElem = DOMUtils.getNextSiblingElement(curElem, &quot;PublicKey&quot;, XMLDSIG_11_XMLNS);
554             ECPoint ecPoint = null;
555 
556             try {
<span class="line-modified">557                 String content = XMLUtils.getFullTextChildrenFromElement(curElem);</span>
558                 ecPoint = decodePoint(XMLUtils.decode(content),
559                                       ecParams.getCurve());
560             } catch (IOException ioe) {
561                 throw new MarshalException(&quot;Invalid EC Point&quot;, ioe);
562             }
563 
564             ECPublicKeySpec spec = new ECPublicKeySpec(ecPoint, ecParams);
565             return (ECPublicKey) generatePublicKey(eckf, spec);
566         }
567 
568         private static ECParameterSpec getECParameterSpec(String oid) {
569             if (oid.equals(SECP256R1.getObjectId())) {
570                 return SECP256R1;
571             } else if (oid.equals(SECP384R1.getObjectId())) {
572                 return SECP384R1;
573             } else if (oid.equals(SECP521R1.getObjectId())) {
574                 return SECP521R1;
575             } else {
576                 return null;
577             }
</pre>
</td>
<td>
<hr />
<pre>
  4  */
  5 /**
  6  * Licensed to the Apache Software Foundation (ASF) under one
  7  * or more contributor license agreements. See the NOTICE file
  8  * distributed with this work for additional information
  9  * regarding copyright ownership. The ASF licenses this file
 10  * to you under the Apache License, Version 2.0 (the
 11  * &quot;License&quot;); you may not use this file except in compliance
 12  * with the License. You may obtain a copy of the License at
 13  *
 14  * http://www.apache.org/licenses/LICENSE-2.0
 15  *
 16  * Unless required by applicable law or agreed to in writing,
 17  * software distributed under the License is distributed on an
 18  * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 19  * KIND, either express or implied. See the License for the
 20  * specific language governing permissions and limitations
 21  * under the License.
 22  */
 23 /*
<span class="line-modified"> 24  * Copyright (c) 2005, 2019, Oracle and/or its affiliates. All rights reserved.</span>
 25  */
 26 /*
<span class="line-modified"> 27  * $Id: DOMKeyValue.java 1854026 2019-02-21 09:30:01Z coheigea $</span>
 28  */
 29 package org.jcp.xml.dsig.internal.dom;
 30 





 31 import java.io.IOException;
 32 import java.math.BigInteger;
 33 import java.security.KeyException;
 34 import java.security.KeyFactory;
 35 import java.security.NoSuchAlgorithmException;
 36 import java.security.PublicKey;
 37 import java.security.interfaces.DSAParams;
 38 import java.security.interfaces.DSAPublicKey;
 39 import java.security.interfaces.ECPublicKey;
 40 import java.security.interfaces.RSAPublicKey;
 41 import java.security.spec.DSAPublicKeySpec;
 42 import java.security.spec.ECField;
 43 import java.security.spec.ECFieldFp;
 44 import java.security.spec.ECParameterSpec;
 45 import java.security.spec.ECPoint;
 46 import java.security.spec.ECPublicKeySpec;
 47 import java.security.spec.EllipticCurve;
 48 import java.security.spec.InvalidKeySpecException;
 49 import java.security.spec.KeySpec;
 50 import java.security.spec.RSAPublicKeySpec;
 51 import java.util.Arrays;
 52 
<span class="line-added"> 53 import javax.xml.crypto.MarshalException;</span>
<span class="line-added"> 54 import javax.xml.crypto.dom.DOMCryptoContext;</span>
<span class="line-added"> 55 import javax.xml.crypto.dsig.XMLSignature;</span>
<span class="line-added"> 56 import javax.xml.crypto.dsig.keyinfo.KeyValue;</span>
<span class="line-added"> 57 </span>
 58 import com.sun.org.apache.xml.internal.security.utils.XMLUtils;
 59 import org.w3c.dom.Document;
 60 import org.w3c.dom.Element;
 61 import org.w3c.dom.Node;
 62 
 63 /**
 64  * DOM-based implementation of KeyValue.
 65  *
 66  */
 67 public abstract class DOMKeyValue&lt;K extends PublicKey&gt; extends DOMStructure implements KeyValue {
 68 
 69     private static final String XMLDSIG_11_XMLNS
 70         = &quot;http://www.w3.org/2009/xmldsig11#&quot;;
 71     private final K publicKey;
 72 
 73     public DOMKeyValue(K key) throws KeyException {
 74         if (key == null) {
 75             throw new NullPointerException(&quot;key cannot be null&quot;);
 76         }
 77         this.publicKey = key;
</pre>
<hr />
<pre>
483         @Override
484         void marshalPublicKey(Node parent, Document doc, String dsPrefix,
485                               DOMCryptoContext context)
486             throws MarshalException
487         {
488             String prefix = DOMUtils.getNSPrefix(context, XMLDSIG_11_XMLNS);
489             Element ecKeyValueElem = DOMUtils.createElement(doc, &quot;ECKeyValue&quot;,
490                                                             XMLDSIG_11_XMLNS,
491                                                             prefix);
492             Element namedCurveElem = DOMUtils.createElement(doc, &quot;NamedCurve&quot;,
493                                                             XMLDSIG_11_XMLNS,
494                                                             prefix);
495             Element publicKeyElem = DOMUtils.createElement(doc, &quot;PublicKey&quot;,
496                                                            XMLDSIG_11_XMLNS,
497                                                            prefix);
498             String oid = getCurveOid(ecParams);
499             if (oid == null) {
500                 throw new MarshalException(&quot;Invalid ECParameterSpec&quot;);
501             }
502             DOMUtils.setAttribute(namedCurveElem, &quot;URI&quot;, &quot;urn:oid:&quot; + oid);
<span class="line-modified">503             String qname = prefix == null || prefix.length() == 0</span>
504                        ? &quot;xmlns&quot; : &quot;xmlns:&quot; + prefix;
505             namedCurveElem.setAttributeNS(&quot;http://www.w3.org/2000/xmlns/&quot;,
506                                           qname, XMLDSIG_11_XMLNS);
507             ecKeyValueElem.appendChild(namedCurveElem);
508             String encoded = XMLUtils.encodeToString(ecPublicKey);
509             publicKeyElem.appendChild
510                 (DOMUtils.getOwnerDocument(publicKeyElem).createTextNode(encoded));
511             ecKeyValueElem.appendChild(publicKeyElem);
512             parent.appendChild(ecKeyValueElem);
513         }
514 
515         @Override
516         ECPublicKey unmarshalKeyValue(Element kvtElem)
517             throws MarshalException
518         {
519             if (eckf == null) {
520                 try {
521                     eckf = KeyFactory.getInstance(&quot;EC&quot;);
522                 } catch (NoSuchAlgorithmException e) {
523                     throw new RuntimeException
</pre>
<hr />
<pre>
537             } else if (curElem.getLocalName().equals(&quot;NamedCurve&quot;)
538                 &amp;&amp; XMLDSIG_11_XMLNS.equals(curElem.getNamespaceURI())) {
539                 String uri = DOMUtils.getAttributeValue(curElem, &quot;URI&quot;);
540                 // strip off &quot;urn:oid&quot;
541                 if (uri.startsWith(&quot;urn:oid:&quot;)) {
542                     String oid = uri.substring(&quot;urn:oid:&quot;.length());
543                     ecParams = getECParameterSpec(oid);
544                     if (ecParams == null) {
545                         throw new MarshalException(&quot;Invalid curve OID&quot;);
546                     }
547                 } else {
548                     throw new MarshalException(&quot;Invalid NamedCurve URI&quot;);
549                 }
550             } else {
551                 throw new MarshalException(&quot;Invalid ECKeyValue&quot;);
552             }
553             curElem = DOMUtils.getNextSiblingElement(curElem, &quot;PublicKey&quot;, XMLDSIG_11_XMLNS);
554             ECPoint ecPoint = null;
555 
556             try {
<span class="line-modified">557                 String content = XMLUtils.getFullTextChildrenFromNode(curElem);</span>
558                 ecPoint = decodePoint(XMLUtils.decode(content),
559                                       ecParams.getCurve());
560             } catch (IOException ioe) {
561                 throw new MarshalException(&quot;Invalid EC Point&quot;, ioe);
562             }
563 
564             ECPublicKeySpec spec = new ECPublicKeySpec(ecPoint, ecParams);
565             return (ECPublicKey) generatePublicKey(eckf, spec);
566         }
567 
568         private static ECParameterSpec getECParameterSpec(String oid) {
569             if (oid.equals(SECP256R1.getObjectId())) {
570                 return SECP256R1;
571             } else if (oid.equals(SECP384R1.getObjectId())) {
572                 return SECP384R1;
573             } else if (oid.equals(SECP521R1.getObjectId())) {
574                 return SECP521R1;
575             } else {
576                 return null;
577             }
</pre>
</td>
</tr>
</table>
<center><a href="DOMKeyName.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DOMManifest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>