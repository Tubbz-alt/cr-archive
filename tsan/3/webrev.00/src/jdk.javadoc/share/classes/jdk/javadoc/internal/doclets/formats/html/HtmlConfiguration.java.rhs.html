<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.javadoc/share/classes/jdk/javadoc/internal/doclets/formats/html/HtmlConfiguration.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.javadoc.internal.doclets.formats.html;
 27 
<a name="2" id="anc2"></a>
 28 import java.util.*;
 29 import java.util.stream.Collectors;
 30 
 31 import javax.lang.model.element.Element;
 32 import javax.lang.model.element.PackageElement;
 33 import javax.lang.model.element.TypeElement;
 34 import javax.tools.JavaFileManager;
 35 import javax.tools.JavaFileObject;
 36 import javax.tools.StandardJavaFileManager;
 37 
 38 import com.sun.source.util.DocTreePath;
<a name="3" id="anc3"></a>
 39 
 40 import jdk.javadoc.doclet.Doclet;
 41 import jdk.javadoc.doclet.DocletEnvironment;
<a name="4" id="anc4"></a><span class="line-added"> 42 import jdk.javadoc.doclet.Reporter;</span>
<span class="line-added"> 43 import jdk.javadoc.doclet.StandardDoclet;</span>
<span class="line-added"> 44 import jdk.javadoc.doclet.Taglet;</span>
 45 import jdk.javadoc.internal.doclets.toolkit.BaseConfiguration;
 46 import jdk.javadoc.internal.doclets.toolkit.DocletException;
 47 import jdk.javadoc.internal.doclets.toolkit.Messages;
 48 import jdk.javadoc.internal.doclets.toolkit.Resources;
 49 import jdk.javadoc.internal.doclets.toolkit.WriterFactory;
 50 import jdk.javadoc.internal.doclets.toolkit.util.DocFile;
 51 import jdk.javadoc.internal.doclets.toolkit.util.DocPath;
 52 import jdk.javadoc.internal.doclets.toolkit.util.DocPaths;
 53 
 54 import static javax.tools.Diagnostic.Kind.*;
 55 
 56 /**
<a name="5" id="anc5"></a><span class="line-modified"> 57  * Configure the output based on the command-line options.</span>
 58  * &lt;p&gt;
<a name="6" id="anc6"></a><span class="line-modified"> 59  * Also determine the length of the command-line option. For example,</span>
 60  * for a option &quot;-header&quot; there will be a string argument associated, then the
 61  * the length of option &quot;-header&quot; is two. But for option &quot;-nohelp&quot; no argument
 62  * is needed so it&#39;s length is 1.
 63  * &lt;/p&gt;
 64  * &lt;p&gt;
 65  * Also do the error checking on the options used. For example it is illegal to
 66  * use &quot;-helpfile&quot; option when already &quot;-nohelp&quot; option is used.
 67  * &lt;/p&gt;
 68  *
 69  *  &lt;p&gt;&lt;b&gt;This is NOT part of any supported API.
 70  *  If you write code that depends on this, you do so at your own risk.
 71  *  This code and its internal interfaces are subject to change or
 72  *  deletion without notice.&lt;/b&gt;
<a name="7" id="anc7"></a>




 73  */
 74 public class HtmlConfiguration extends BaseConfiguration {
 75 
 76     /**
 77      * Default charset for HTML.
 78      */
 79     public static final String HTML_DEFAULT_CHARSET = &quot;utf-8&quot;;
 80 
<a name="8" id="anc8"></a><span class="line-modified"> 81     public final Resources docResources;</span>





























































































































 82 
 83     /**
 84      * First file to appear in the right-hand frame in the generated
 85      * documentation.
 86      */
 87     public DocPath topFile = DocPath.empty;
 88 
 89     /**
 90      * The TypeElement for the class file getting generated.
 91      */
 92     public TypeElement currentTypeElement = null;  // Set this TypeElement in the ClassWriter.
 93 
 94     protected SortedSet&lt;SearchIndexItem&gt; memberSearchIndex;
 95 
 96     protected SortedSet&lt;SearchIndexItem&gt; moduleSearchIndex;
 97 
 98     protected SortedSet&lt;SearchIndexItem&gt; packageSearchIndex;
 99 
100     protected SortedSet&lt;SearchIndexItem&gt; tagSearchIndex;
101 
102     protected SortedSet&lt;SearchIndexItem&gt; typeSearchIndex;
103 
<a name="9" id="anc9"></a><span class="line-modified">104     protected Map&lt;Character, List&lt;SearchIndexItem&gt;&gt; tagSearchIndexMap = new HashMap&lt;&gt;();</span>
105 
106     protected Set&lt;Character&gt; tagSearchIndexKeys;
107 
108     public final Contents contents;
109 
110     protected final Messages messages;
111 
112     public DocPaths docPaths;
113 
114     public Map&lt;Element, List&lt;DocPath&gt;&gt; localStylesheetMap = new HashMap&lt;&gt;();
115 
<a name="10" id="anc10"></a><span class="line-added">116     private final HtmlOptions options;</span>
<span class="line-added">117 </span>
118     /**
<a name="11" id="anc11"></a><span class="line-modified">119      * Constructs the full configuration needed by the doclet, including</span>
<span class="line-added">120      * the format-specific part, defined in this class, and the format-independent</span>
<span class="line-added">121      * part, defined in the supertype.</span>
122      *
<a name="12" id="anc12"></a><span class="line-modified">123      * @apiNote The {@code doclet} parameter is used when</span>
<span class="line-added">124      * {@link Taglet#init(DocletEnvironment, Doclet) initializing tags}.</span>
<span class="line-added">125      * Some doclets (such as the {@link StandardDoclet}), may delegate to another</span>
<span class="line-added">126      * (such as the {@link HtmlDoclet}).  In such cases, the primary doclet (i.e</span>
<span class="line-added">127      * {@code StandardDoclet}) should be provided here, and not any internal</span>
<span class="line-added">128      * class like {@code HtmlDoclet}.</span>
<span class="line-added">129      *</span>
<span class="line-added">130      * @param doclet   the doclet for this run of javadoc</span>
<span class="line-added">131      * @param locale   the locale for the generated documentation</span>
<span class="line-added">132      * @param reporter the reporter to use for console messages</span>
133      */
<a name="13" id="anc13"></a><span class="line-modified">134     public HtmlConfiguration(Doclet doclet, Locale locale, Reporter reporter) {</span>
<span class="line-modified">135         super(doclet, locale, reporter);</span>
<span class="line-modified">136 </span>
<span class="line-added">137         // Use the default locale for console messages.</span>
<span class="line-added">138         Resources msgResources = new Resources(Locale.getDefault(),</span>
139                 BaseConfiguration.sharedResourceBundleName,
140                 &quot;jdk.javadoc.internal.doclets.formats.html.resources.standard&quot;);
141 
<a name="14" id="anc14"></a><span class="line-modified">142         // Use the provided locale for generated docs</span>
<span class="line-added">143         // Ideally, the doc resources would be in different resource files than the</span>
<span class="line-added">144         // message resources, so that we do not have different copies of the same resources.</span>
<span class="line-added">145         if (locale.equals(Locale.getDefault())) {</span>
<span class="line-added">146             docResources = msgResources;</span>
<span class="line-added">147         } else {</span>
<span class="line-added">148             docResources = new Resources(locale,</span>
<span class="line-added">149                     BaseConfiguration.sharedResourceBundleName,</span>
<span class="line-added">150                     &quot;jdk.javadoc.internal.doclets.formats.html.resources.standard&quot;);</span>
<span class="line-added">151         }</span>
<span class="line-added">152 </span>
<span class="line-added">153         messages = new Messages(this, msgResources);</span>
154         contents = new Contents(this);
<a name="15" id="anc15"></a><span class="line-added">155         options = new HtmlOptions(this);</span>
156 
157         String v;
158         try {
<a name="16" id="anc16"></a><span class="line-modified">159             // the version bundle is not localized</span>
<span class="line-added">160             ResourceBundle rb = ResourceBundle.getBundle(versionBundleName, Locale.getDefault());</span>
161             try {
162                 v = rb.getString(&quot;release&quot;);
163             } catch (MissingResourceException e) {
164                 v = defaultDocletVersion;
165             }
166         } catch (MissingResourceException e) {
167             v = defaultDocletVersion;
168         }
169         docletVersion = v;
170     }
171 
172     private static final String versionBundleName = &quot;jdk.javadoc.internal.tool.resources.version&quot;;
173     private static final String defaultDocletVersion = System.getProperty(&quot;java.version&quot;);
174     public final String docletVersion;
<a name="17" id="anc17"></a><span class="line-added">175     public final Date startTime = new Date();</span>
176 
177     @Override
178     public String getDocletVersion() {
179         return docletVersion;
180     }
181 
182     @Override
<a name="18" id="anc18"></a><span class="line-modified">183     public Resources getDocResources() {</span>
<span class="line-modified">184         return docResources;</span>
185     }
186 
<a name="19" id="anc19"></a><span class="line-added">187     /**</span>
<span class="line-added">188      * Returns a utility object providing commonly used fragments of content.</span>
<span class="line-added">189      *</span>
<span class="line-added">190      * @return a utility object providing commonly used fragments of content</span>
<span class="line-added">191      */</span>
192     public Contents getContents() {
193         return contents;
194     }
195 
196     @Override
197     public Messages getMessages() {
198         return messages;
199     }
200 
<a name="20" id="anc20"></a><span class="line-modified">201     @Override</span>
<span class="line-modified">202     public HtmlOptions getOptions() {</span>
<span class="line-modified">203         return options;</span>







































204     }
205 
<a name="21" id="anc21"></a>
206     @Override
207     public boolean finishOptionSettings() {
<a name="22" id="anc22"></a><span class="line-modified">208         if (!options.validateOptions()) {</span>
209             return false;
210         }
211         if (!getSpecifiedTypeElements().isEmpty()) {
212             Map&lt;String, PackageElement&gt; map = new HashMap&lt;&gt;();
213             PackageElement pkg;
214             for (TypeElement aClass : getIncludedTypeElements()) {
215                 pkg = utils.containingPackage(aClass);
216                 if (!map.containsKey(utils.getPackageName(pkg))) {
217                     map.put(utils.getPackageName(pkg), pkg);
218                 }
219             }
220         }
<a name="23" id="anc23"></a><span class="line-modified">221         docPaths = new DocPaths(utils);</span>
222         setCreateOverview();
223         setTopFile(docEnv);
<a name="24" id="anc24"></a><span class="line-modified">224         workArounds.initDocLint(options.doclintOpts(), tagletManager.getAllTagletNames());</span>
225         return true;
226     }
227 
228     /**
229      * Decide the page which will appear first in the right-hand frame. It will
230      * be &quot;overview-summary.html&quot; if &quot;-overview&quot; option is used or no
231      * &quot;-overview&quot; but the number of packages is more than one. It will be
232      * &quot;package-summary.html&quot; of the respective package if there is only one
233      * package to document. It will be a class page(first in the sorted order),
234      * if only classes are provided on the command line.
235      *
236      * @param docEnv the doclet environment
237      */
238     protected void setTopFile(DocletEnvironment docEnv) {
239         if (!checkForDeprecation(docEnv)) {
240             return;
241         }
<a name="25" id="anc25"></a><span class="line-modified">242         if (options.createOverview()) {</span>
<span class="line-modified">243             topFile = DocPaths.INDEX;</span>
244         } else {
245             if (showModules) {
246                 topFile = DocPath.empty.resolve(docPaths.moduleSummary(modules.first()));
247             } else if (packages.size() == 1 &amp;&amp; packages.first().isUnnamed()) {
248                 List&lt;TypeElement&gt; classes = new ArrayList&lt;&gt;(getIncludedTypeElements());
249                 if (!classes.isEmpty()) {
250                     TypeElement te = getValidClass(classes);
251                     topFile = docPaths.forClass(te);
252                 }
253             } else if (!packages.isEmpty()) {
254                 topFile = docPaths.forPackage(packages.first()).resolve(DocPaths.PACKAGE_SUMMARY);
255             }
256         }
257     }
258 
259     protected TypeElement getValidClass(List&lt;TypeElement&gt; classes) {
<a name="26" id="anc26"></a><span class="line-modified">260         if (!options.noDeprecated()) {</span>
261             return classes.get(0);
262         }
263         for (TypeElement te : classes) {
264             if (!utils.isDeprecated(te)) {
265                 return te;
266             }
267         }
268         return null;
269     }
270 
271     protected boolean checkForDeprecation(DocletEnvironment docEnv) {
272         for (TypeElement te : getIncludedTypeElements()) {
273             if (isGeneratedDoc(te)) {
274                 return true;
275             }
276         }
277         return false;
278     }
279 
280     /**
281      * Generate &quot;overview.html&quot; page if option &quot;-overview&quot; is used or number of
<a name="27" id="anc27"></a><span class="line-modified">282      * packages is more than one. Sets {@code HtmlOptions.createOverview} field to true.</span>
283      */
284     protected void setCreateOverview() {
<a name="28" id="anc28"></a><span class="line-modified">285         if (!options.noOverview()) {</span>
<span class="line-modified">286             if (options.overviewPath() != null</span>
287                     || modules.size() &gt; 1
288                     || (modules.isEmpty() &amp;&amp; packages.size() &gt; 1)) {
<a name="29" id="anc29"></a><span class="line-modified">289                 options.setCreateOverview(true);</span>
290             }
291         }
292     }
293 
<a name="30" id="anc30"></a>


294     @Override
295     public WriterFactory getWriterFactory() {
296         return new WriterFactoryImpl(this);
297     }
298 
<a name="31" id="anc31"></a>


299     @Override
300     public Locale getLocale() {
301         if (locale == null)
302             return Locale.getDefault();
303         return locale;
304     }
305 
306     /**
307      * Return the path of the overview file or null if it does not exist.
308      *
309      * @return the path of the overview file or null if it does not exist.
310      */
311     @Override
312     public JavaFileObject getOverviewPath() {
<a name="32" id="anc32"></a><span class="line-added">313         String overviewpath = options.overviewPath();</span>
314         if (overviewpath != null &amp;&amp; getFileManager() instanceof StandardJavaFileManager) {
315             StandardJavaFileManager fm = (StandardJavaFileManager) getFileManager();
316             return fm.getJavaFileObjects(overviewpath).iterator().next();
317         }
318         return null;
319     }
320 
<a name="33" id="anc33"></a><span class="line-modified">321     public DocPath getMainStylesheet() {</span>
<span class="line-modified">322         String stylesheetfile = options.stylesheetFile();</span>
<span class="line-added">323         if(!stylesheetfile.isEmpty()){</span>
<span class="line-added">324             DocFile docFile = DocFile.createFileForInput(this, stylesheetfile);</span>
<span class="line-added">325             return DocPath.create(docFile.getName());</span>
<span class="line-added">326         }</span>
<span class="line-added">327         return  null;</span>
328     }
329 
<a name="34" id="anc34"></a><span class="line-modified">330     public List&lt;DocPath&gt; getAdditionalStylesheets() {</span>
<span class="line-modified">331         return options.additionalStylesheets().stream()</span>
332                 .map(ssf -&gt; DocFile.createFileForInput(this, ssf))
<a name="35" id="anc35"></a><span class="line-added">333                 .map(file -&gt; DocPath.create(file.getName()))</span>
334                 .collect(Collectors.toList());
335     }
336 
<a name="36" id="anc36"></a>


337     @Override
338     public JavaFileManager getFileManager() {
339         return docEnv.getJavaFileManager();
340     }
341 
342     @Override
343     public boolean showMessage(DocTreePath path, String key) {
344         return (path == null || workArounds.haveDocLint());
345     }
346 
347     @Override
348     public boolean showMessage(Element e, String key) {
349         return (e == null || workArounds.haveDocLint());
350     }
351 
352     protected void buildSearchTagIndex() {
353         for (SearchIndexItem sii : tagSearchIndex) {
354             String tagLabel = sii.getLabel();
355             Character unicode = (tagLabel.length() == 0)
356                     ? &#39;*&#39;
357                     : Character.toUpperCase(tagLabel.charAt(0));
<a name="37" id="anc37"></a><span class="line-modified">358             tagSearchIndexMap.computeIfAbsent(unicode, k -&gt; new ArrayList&lt;&gt;()).add(sii);</span>





359         }
360         tagSearchIndexKeys = tagSearchIndexMap.keySet();
361     }
362 
<a name="38" id="anc38"></a>






























































































































































































































































363     @Override
364     protected boolean finishOptionSettings0() throws DocletException {
<a name="39" id="anc39"></a><span class="line-modified">365         if (options.docEncoding() == null) {</span>
<span class="line-modified">366             if (options.charset() == null) {</span>
<span class="line-modified">367                 String charset = (options.encoding() == null) ? HTML_DEFAULT_CHARSET : options.encoding();</span>
<span class="line-added">368                 options.setCharset(charset);</span>
<span class="line-added">369                 options.setDocEncoding((options.charset()));</span>
370             } else {
<a name="40" id="anc40"></a><span class="line-modified">371                 options.setDocEncoding(options.charset());</span>
372             }
373         } else {
<a name="41" id="anc41"></a><span class="line-modified">374             if (options.charset() == null) {</span>
<span class="line-modified">375                 options.setCharset(options.docEncoding());</span>
<span class="line-modified">376             } else if (!options.charset().equals(options.docEncoding())) {</span>
<span class="line-modified">377                 messages.error(&quot;doclet.Option_conflict&quot;, &quot;-charset&quot;, &quot;-docencoding&quot;);</span>
378                 return false;
379             }
380         }
381         return super.finishOptionSettings0();
382     }
383 
384     @Override
385     protected void initConfiguration(DocletEnvironment docEnv) {
386         super.initConfiguration(docEnv);
387         memberSearchIndex = new TreeSet&lt;&gt;(utils.makeGenericSearchIndexComparator());
388         moduleSearchIndex = new TreeSet&lt;&gt;(utils.makeGenericSearchIndexComparator());
389         packageSearchIndex = new TreeSet&lt;&gt;(utils.makeGenericSearchIndexComparator());
390         tagSearchIndex = new TreeSet&lt;&gt;(utils.makeGenericSearchIndexComparator());
391         typeSearchIndex = new TreeSet&lt;&gt;(utils.makeTypeSearchIndexComparator());
392     }
393 }
<a name="42" id="anc42"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="42" type="hidden" />
</body>
</html>