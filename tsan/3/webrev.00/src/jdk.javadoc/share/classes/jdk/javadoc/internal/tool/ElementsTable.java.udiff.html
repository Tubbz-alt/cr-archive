<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.javadoc/share/classes/jdk/javadoc/internal/tool/ElementsTable.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DocEnvImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IllegalOptionValue.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.javadoc/share/classes/jdk/javadoc/internal/tool/ElementsTable.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2001, 2017, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -45,11 +45,11 @@</span>
  import javax.lang.model.element.ModuleElement.ExportsDirective;
  import javax.lang.model.element.ModuleElement.RequiresDirective;
  import javax.lang.model.element.PackageElement;
  import javax.lang.model.element.TypeElement;
  import javax.lang.model.util.ElementFilter;
<span class="udiff-line-modified-removed">- import javax.lang.model.util.SimpleElementVisitor9;</span>
<span class="udiff-line-modified-added">+ import javax.lang.model.util.SimpleElementVisitor14;</span>
  import javax.tools.JavaFileManager;
  import javax.tools.JavaFileManager.Location;
  import javax.tools.JavaFileObject;
  import javax.tools.StandardLocation;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -162,20 +162,20 @@</span>
      private final Symtab syms;
      private final Names names;
      private final JavaFileManager fm;
      private final List&lt;Location&gt; locations;
      private final Modules modules;
<span class="udiff-line-modified-removed">-     private final Map&lt;ToolOption, Object&gt; opts;</span>
<span class="udiff-line-modified-added">+     private final ToolOptions options;</span>
      private final Messager messager;
      private final JavaCompiler compiler;
  
      private final Map&lt;String, Entry&gt; entries = new LinkedHashMap&lt;&gt;();
  
      // specified elements
      private Set&lt;ModuleElement&gt; specifiedModuleElements = new LinkedHashSet&lt;&gt;();
      private Set&lt;PackageElement&gt; specifiedPackageElements = new LinkedHashSet&lt;&gt;();
<span class="udiff-line-modified-removed">-     private Set&lt;TypeElement&gt; specifiedTypeElements =new LinkedHashSet&lt;&gt;();</span>
<span class="udiff-line-modified-added">+     private Set&lt;TypeElement&gt; specifiedTypeElements = new LinkedHashSet&lt;&gt;();</span>
  
      // included elements
      private Set&lt;ModuleElement&gt; includedModuleElements = null;
      private Set&lt;PackageElement&gt; includedPackageElements = null;
      private Set&lt;TypeElement&gt; includedTypeElements = null;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -199,19 +199,19 @@</span>
  
      /**
       * Creates the table to manage included and excluded elements.
       *
       * @param context the context to locate commonly used objects
<span class="udiff-line-modified-removed">-      * @param location the location used to locate source files</span>
<span class="udiff-line-modified-added">+      * @param options the tool options</span>
       */
<span class="udiff-line-modified-removed">-     ElementsTable(Context context, Map&lt;ToolOption, Object&gt; opts) {</span>
<span class="udiff-line-modified-added">+     ElementsTable(Context context, ToolOptions options) {</span>
          this.toolEnv = ToolEnvironment.instance(context);
          this.syms = Symtab.instance(context);
          this.names = Names.instance(context);
          this.fm = toolEnv.fileManager;
          this.modules = Modules.instance(context);
<span class="udiff-line-modified-removed">-         this.opts = opts;</span>
<span class="udiff-line-modified-added">+         this.options = options;</span>
          this.messager = Messager.instance0(context);
          this.compiler = JavaCompiler.instance(context);
          Source source = Source.instance(context);
  
          List&lt;Location&gt; locs = new ArrayList&lt;&gt;();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -227,13 +227,13 @@</span>
              locs.add(StandardLocation.PATCH_MODULE_PATH);
          this.locations = Collections.unmodifiableList(locs);
  
          getEntry(&quot;&quot;).excluded = false;
  
<span class="udiff-line-modified-removed">-         accessFilter = new ModifierFilter(opts);</span>
<span class="udiff-line-modified-removed">-         xclasses = (boolean)opts.getOrDefault(ToolOption.XCLASSES, false);</span>
<span class="udiff-line-modified-removed">-         expandRequires = (AccessKind)opts.get(ToolOption.EXPAND_REQUIRES);</span>
<span class="udiff-line-modified-added">+         accessFilter = new ModifierFilter(options);</span>
<span class="udiff-line-modified-added">+         xclasses = options.xclasses();</span>
<span class="udiff-line-modified-added">+         expandRequires = options.expandRequires();</span>
      }
  
      /**
       * Returns the module documentation level mode.
       * @return the module documentation level mode
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -316,13 +316,11 @@</span>
       * A member (constructor, method, field) is included if
       *  - it is visible in a fully included type (--show-members)
       *
       * @param e the element in question
       *
<span class="udiff-line-modified-removed">-      * @see getIncludedModuleElements</span>
<span class="udiff-line-removed">-      * @see getIncludedPackageElements</span>
<span class="udiff-line-removed">-      * @see getIncludedTypeElements</span>
<span class="udiff-line-modified-added">+      * @see #getIncludedElements()</span>
       *
       * @return true if included
       */
      public boolean isIncluded(Element e) {
          if (e == null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -405,53 +403,48 @@</span>
              throw new ToolException(SYSERR, text, ioe);
          }
          return null;
      }
  
<span class="udiff-line-removed">-     @SuppressWarnings(&quot;unchecked&quot;)</span>
      ElementsTable scanSpecifiedItems() throws ToolException {
  
          // scan modules specified on the command line
<span class="udiff-line-modified-removed">-         List&lt;String&gt; moduleNames = (List&lt;String&gt;) opts.computeIfAbsent(ToolOption.MODULE,</span>
<span class="udiff-line-removed">-                 s -&gt; Collections.EMPTY_LIST);</span>
<span class="udiff-line-modified-added">+         List&lt;String&gt; modules = options.modules();</span>
          List&lt;String&gt; mlist = new ArrayList&lt;&gt;();
<span class="udiff-line-modified-removed">-         for (String m : moduleNames) {</span>
<span class="udiff-line-modified-added">+         for (String m : modules) {</span>
              List&lt;Location&gt; moduleLocations = getModuleLocation(locations, m);
              if (moduleLocations.isEmpty()) {
                  String text = messager.getText(&quot;main.module_not_found&quot;, m);
                  throw new ToolException(CMDERR, text);
              }
              if (moduleLocations.contains(StandardLocation.SOURCE_PATH)) {
<span class="udiff-line-modified-removed">-                 sanityCheckSourcePathModules(moduleNames);</span>
<span class="udiff-line-modified-added">+                 sanityCheckSourcePathModules(modules);</span>
              }
              mlist.add(m);
              ModuleSymbol msym = syms.enterModule(names.fromString(m));
<span class="udiff-line-modified-removed">-             specifiedModuleElements.add((ModuleElement) msym);</span>
<span class="udiff-line-modified-added">+             specifiedModuleElements.add(msym);</span>
          }
  
          // scan for modules with qualified packages
          cmdLinePackages.stream()
<span class="udiff-line-modified-removed">-                 .filter((mpkg) -&gt; (mpkg.hasModule()))</span>
<span class="udiff-line-modified-removed">-                 .forEachOrdered((mpkg) -&gt; {</span>
<span class="udiff-line-removed">-                     mlist.add(mpkg.moduleName);</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-modified-added">+                 .filter(ModulePackage::hasModule)</span>
<span class="udiff-line-modified-added">+                 .forEachOrdered(mpkg -&gt; mlist.add(mpkg.moduleName));</span>
  
          // scan for modules with qualified subpackages
<span class="udiff-line-modified-removed">-         ((List&lt;String&gt;)opts.computeIfAbsent(ToolOption.SUBPACKAGES, v -&gt; Collections.EMPTY_LIST))</span>
<span class="udiff-line-removed">-             .stream()</span>
<span class="udiff-line-modified-added">+         options.subpackages().stream()</span>
              .map(ModulePackage::new)
<span class="udiff-line-modified-removed">-             .forEachOrdered((mpkg) -&gt; {</span>
<span class="udiff-line-modified-added">+             .forEachOrdered(mpkg -&gt; {</span>
                  subPackages.add(mpkg);
                  if (mpkg.hasModule()) {
                      mlist.add(mpkg.moduleName);
                  }
              });
  
          // all the modules specified on the command line have been scraped
          // init the module systems
<span class="udiff-line-modified-removed">-         modules.addExtraAddModules(mlist.toArray(new String[mlist.size()]));</span>
<span class="udiff-line-modified-removed">-         modules.initModules(this.classTreeList);</span>
<span class="udiff-line-modified-added">+         this.modules.addExtraAddModules(mlist.toArray(new String[mlist.size()]));</span>
<span class="udiff-line-modified-added">+         this.modules.initModules(this.classTreeList);</span>
  
          return this;
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -484,11 +477,11 @@</span>
       * names
       */
      ElementsTable packages(Collection&lt;String&gt; packageNames) {
          packageNames.stream()
              .map(ModulePackage::new)
<span class="udiff-line-modified-removed">-             .forEachOrdered((mpkg) -&gt; cmdLinePackages.add(mpkg));</span>
<span class="udiff-line-modified-added">+             .forEachOrdered(mpkg -&gt; cmdLinePackages.add(mpkg));</span>
          return this;
      }
  
      /**
       * Returns the aggregate set of included packages and specified
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -502,20 +495,16 @@</span>
          result.addAll(cmdLinePackages);
          result.addAll(subPackages);
          return result;
      }
  
<span class="udiff-line-removed">-     @SuppressWarnings(&quot;unchecked&quot;)</span>
      private void computeSubpackages() throws ToolException {
<span class="udiff-line-modified-removed">-         ((List&lt;String&gt;) opts.computeIfAbsent(ToolOption.EXCLUDE, v -&gt; Collections.EMPTY_LIST))</span>
<span class="udiff-line-removed">-                 .stream()</span>
<span class="udiff-line-modified-added">+         options.excludes().stream()</span>
                  .map(ModulePackage::new)
<span class="udiff-line-modified-removed">-                 .forEachOrdered((mpkg) -&gt; excludePackages.add(mpkg));</span>
<span class="udiff-line-modified-added">+                 .forEachOrdered(mpkg -&gt; excludePackages.add(mpkg));</span>
  
<span class="udiff-line-modified-removed">-         excludePackages.forEach((p) -&gt; {</span>
<span class="udiff-line-removed">-             getEntry(p).excluded = true;</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-modified-added">+         excludePackages.forEach(p -&gt; getEntry(p).excluded = true);</span>
  
          for (ModulePackage modpkg : subPackages) {
              List&lt;Location&gt; locs = getLocation(modpkg);
              for (Location loc : locs) {
                  addPackagesFromLocations(loc, modpkg);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -726,15 +715,13 @@</span>
          });
  
          // process types
          Set&lt;TypeElement&gt; iclasses = new LinkedHashSet&lt;&gt;();
          // add all types enclosed in expanded modules and packages
<span class="udiff-line-modified-removed">-         ipackages.forEach((pkg) -&gt; {</span>
<span class="udiff-line-removed">-             addAllClasses(iclasses, pkg);</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-modified-added">+         ipackages.forEach(pkg -&gt; addAllClasses(iclasses, pkg));</span>
          // add all types and its nested types
<span class="udiff-line-modified-removed">-         specifiedTypeElements.forEach((klass) -&gt; {</span>
<span class="udiff-line-modified-added">+         specifiedTypeElements.forEach(klass -&gt; {</span>
              ModuleElement mdle = toolEnv.elements.getModuleOf(klass);
              if (mdle != null &amp;&amp; !mdle.isUnnamed())
                  imodules.add(mdle);
              PackageElement pkg = toolEnv.elements.getPackageOf(klass);
              ipackages.add(pkg);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -753,11 +740,11 @@</span>
      private void computeSpecifiedPackages() throws ToolException {
  
          computeSubpackages();
  
          Set&lt;PackageElement&gt; packlist = new LinkedHashSet&lt;&gt;();
<span class="udiff-line-modified-removed">-         cmdLinePackages.forEach((modpkg) -&gt; {</span>
<span class="udiff-line-modified-added">+         cmdLinePackages.forEach(modpkg -&gt; {</span>
              PackageElement pkg;
              if (modpkg.hasModule()) {
                  ModuleElement mdle = toolEnv.elements.getModuleElement(modpkg.moduleName);
                  pkg = toolEnv.elements.getPackageElement(mdle, modpkg.packageName);
              } else {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -777,12 +764,12 @@</span>
       * Adds all classes as well as inner classes, to the specified
       * list.
       */
      private void computeSpecifiedTypes() throws ToolException {
          Set&lt;TypeElement&gt; classes = new LinkedHashSet&lt;&gt;();
<span class="udiff-line-modified-removed">-           classDecList.forEach((def) -&gt; {</span>
<span class="udiff-line-modified-removed">-             TypeElement te = (TypeElement) def.sym;</span>
<span class="udiff-line-modified-added">+           classDecList.forEach(def -&gt; {</span>
<span class="udiff-line-modified-added">+             TypeElement te = def.sym;</span>
              if (te != null) {
                  addAllClasses(classes, te, true);
              }
          });
          for (String className : classArgList) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -828,11 +815,11 @@</span>
      }
  
      /**
       * Returns the set of source files for a package.
       *
<span class="udiff-line-modified-removed">-      * @param packageName the specified package</span>
<span class="udiff-line-modified-added">+      * @param modpkg the specified package</span>
       * @return the set of file objects for the specified package
       * @throws ToolException if an error occurs while accessing the files
       */
      private List&lt;JavaFileObject&gt; getFiles(ModulePackage modpkg,
              boolean recurse) throws ToolException {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -983,27 +970,29 @@</span>
  
      private boolean isTypeElementSelected(TypeElement te) {
          return (xclasses || toolEnv.getFileKind(te) == SOURCE) &amp;&amp; isSelected(te);
      }
  
<span class="udiff-line-modified-removed">-     SimpleElementVisitor9&lt;Boolean, Void&gt; visibleElementVisitor = null;</span>
<span class="udiff-line-modified-added">+     @SuppressWarnings(&quot;preview&quot;)</span>
<span class="udiff-line-added">+     SimpleElementVisitor14&lt;Boolean, Void&gt; visibleElementVisitor = null;</span>
      /**
       * Returns true if the element is selected, by applying
       * the access filter checks. Special treatment is applied to
       * types, for a top level type the access filter applies completely,
       * however if is a nested type then it is allowed either  if
       * the enclosing is a static or the enclosing is also selected.
       *
       * @param e the element to be checked
       * @return true if the element is visible
       */
<span class="udiff-line-added">+     @SuppressWarnings(&quot;preview&quot;)</span>
      public boolean isSelected(Element e) {
          if (toolEnv.isSynthetic((Symbol) e)) {
              return false;
          }
          if (visibleElementVisitor == null) {
<span class="udiff-line-modified-removed">-             visibleElementVisitor = new SimpleElementVisitor9&lt;Boolean, Void&gt;() {</span>
<span class="udiff-line-modified-added">+             visibleElementVisitor = new SimpleElementVisitor14&lt;Boolean, Void&gt;() {</span>
                  @Override
                  public Boolean visitType(TypeElement e, Void p) {
                      if (!accessFilter.checkModifier(e)) {
                          return false; // it is not allowed
                      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1026,19 +1015,20 @@</span>
                      return accessFilter.checkModifier(e);
                  }
  
                  @Override
                  public Boolean visitUnknown(Element e, Void p) {
<span class="udiff-line-modified-removed">-                     throw new AssertionError(&quot;unkown element: &quot; + p);</span>
<span class="udiff-line-modified-added">+                     throw new AssertionError(&quot;unknown element: &quot; + e);</span>
                  }
              };
          }
          return visibleElementVisitor.visit(e);
      }
  
<span class="udiff-line-modified-removed">-     private class IncludedVisitor extends SimpleElementVisitor9&lt;Boolean, Void&gt; {</span>
<span class="udiff-line-modified-removed">-         final private Set&lt;Element&gt; includedCache;</span>
<span class="udiff-line-modified-added">+     @SuppressWarnings(&quot;preview&quot;)</span>
<span class="udiff-line-modified-added">+     private class IncludedVisitor extends SimpleElementVisitor14&lt;Boolean, Void&gt; {</span>
<span class="udiff-line-added">+         private final Set&lt;Element&gt; includedCache;</span>
  
          public IncludedVisitor() {
              includedCache = new LinkedHashSet&lt;&gt;();
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1198,51 +1188,51 @@</span>
          static final EnumSet&lt;ElementKind&gt; ALLOWED_KINDS = EnumSet.of(ElementKind.METHOD,
                                                      ElementKind.CLASS,
                                                      ElementKind.PACKAGE,
                                                      ElementKind.MODULE);
  
<span class="udiff-line-modified-removed">-         // all possible accesss levels allowed for each element</span>
<span class="udiff-line-modified-added">+         // all possible access levels allowed for each element</span>
          private final EnumMap&lt;ElementKind, EnumSet&lt;AccessKind&gt;&gt; filterMap =
                  new EnumMap&lt;&gt;(ElementKind.class);
  
          // the specified access level for each element
          private final EnumMap&lt;ElementKind, AccessKind&gt; accessMap =
                  new EnumMap&lt;&gt;(ElementKind.class);
  
          /**
           * Constructor - Specify a filter.
           *
<span class="udiff-line-modified-removed">-          * @param accessSet an Access filter.</span>
<span class="udiff-line-modified-added">+          * @param options the tool options</span>
           */
<span class="udiff-line-modified-removed">-         ModifierFilter(Map&lt;ToolOption, Object&gt; opts) {</span>
<span class="udiff-line-modified-added">+         ModifierFilter(ToolOptions options) {</span>
  
              AccessKind accessValue = null;
              for (ElementKind kind : ALLOWED_KINDS) {
                  switch (kind) {
                      case METHOD:
<span class="udiff-line-modified-removed">-                         accessValue  = (AccessKind)opts.get(ToolOption.SHOW_MEMBERS);</span>
<span class="udiff-line-modified-added">+                         accessValue  = options.showMembersAccess();</span>
                          break;
                      case CLASS:
<span class="udiff-line-modified-removed">-                         accessValue  = (AccessKind)opts.get(ToolOption.SHOW_TYPES);</span>
<span class="udiff-line-modified-added">+                         accessValue  = options.showTypesAccess();</span>
                          break;
                      case PACKAGE:
<span class="udiff-line-modified-removed">-                         accessValue  = (AccessKind)opts.get(ToolOption.SHOW_PACKAGES);</span>
<span class="udiff-line-modified-added">+                         accessValue  = options.showPackagesAccess();</span>
                          break;
                      case MODULE:
<span class="udiff-line-modified-removed">-                         accessValue  = (AccessKind)opts.get(ToolOption.SHOW_MODULE_CONTENTS);</span>
<span class="udiff-line-modified-added">+                         accessValue  = options.showModuleContents();</span>
                          break;
                      default:
                          throw new AssertionError(&quot;unknown element: &quot; + kind);
  
                  }
                  accessMap.put(kind, accessValue);
                  filterMap.put(kind, getFilterSet(accessValue));
              }
          }
  
<span class="udiff-line-modified-removed">-         static EnumSet&lt;AccessKind&gt; getFilterSet(AccessKind acccessValue) {</span>
<span class="udiff-line-modified-removed">-             switch (acccessValue) {</span>
<span class="udiff-line-modified-added">+         static EnumSet&lt;AccessKind&gt; getFilterSet(AccessKind accessValue) {</span>
<span class="udiff-line-modified-added">+             switch (accessValue) {</span>
                  case PUBLIC:
                      return EnumSet.of(AccessKind.PUBLIC);
                  case PROTECTED:
                  default:
                      return EnumSet.of(AccessKind.PUBLIC, AccessKind.PROTECTED);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1283,11 +1273,11 @@</span>
          // convert a requested element kind to an allowed access kind
          private ElementKind getAllowedKind(ElementKind kind) {
              switch (kind) {
                  case CLASS: case METHOD: case MODULE: case PACKAGE:
                      return kind;
<span class="udiff-line-modified-removed">-                 case ANNOTATION_TYPE: case ENUM: case INTERFACE:</span>
<span class="udiff-line-modified-added">+                 case RECORD: case ANNOTATION_TYPE: case ENUM: case INTERFACE:</span>
                      return ElementKind.CLASS;
                  case CONSTRUCTOR: case ENUM_CONSTANT: case EXCEPTION_PARAMETER:
                  case FIELD: case INSTANCE_INIT: case LOCAL_VARIABLE: case PARAMETER:
                  case RESOURCE_VARIABLE: case STATIC_INIT: case TYPE_PARAMETER:
                      return ElementKind.METHOD;
</pre>
<center><a href="DocEnvImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IllegalOptionValue.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>