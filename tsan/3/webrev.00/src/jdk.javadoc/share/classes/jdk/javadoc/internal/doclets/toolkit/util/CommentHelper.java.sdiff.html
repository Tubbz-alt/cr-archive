<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.javadoc/share/classes/jdk/javadoc/internal/doclets/toolkit/util/CommentHelper.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ClassUseMapper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DeprecatedAPIListBuilder.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.javadoc/share/classes/jdk/javadoc/internal/doclets/toolkit/util/CommentHelper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.javadoc.internal.doclets.toolkit.util;
 27 
 28 import java.util.ArrayList;
 29 import java.util.Collections;
 30 import java.util.List;

 31 
 32 import javax.lang.model.element.Element;
 33 import javax.lang.model.element.ExecutableElement;
<span class="line-removed"> 34 import javax.lang.model.element.ModuleElement;</span>
 35 import javax.lang.model.element.PackageElement;
 36 import javax.lang.model.element.TypeElement;
 37 import javax.lang.model.type.TypeMirror;
 38 
 39 import com.sun.source.doctree.AttributeTree;
 40 import com.sun.source.doctree.AttributeTree.ValueKind;
 41 import com.sun.source.doctree.AuthorTree;
 42 import com.sun.source.doctree.BlockTagTree;
 43 import com.sun.source.doctree.CommentTree;
 44 import com.sun.source.doctree.DeprecatedTree;
 45 import com.sun.source.doctree.DocCommentTree;
 46 import com.sun.source.doctree.DocTree;
 47 import com.sun.source.doctree.EndElementTree;
 48 import com.sun.source.doctree.EntityTree;
 49 import com.sun.source.doctree.IdentifierTree;
 50 import com.sun.source.doctree.InlineTagTree;
 51 import com.sun.source.doctree.LinkTree;
 52 import com.sun.source.doctree.LiteralTree;
 53 import com.sun.source.doctree.ParamTree;
 54 import com.sun.source.doctree.ProvidesTree;
</pre>
<hr />
<pre>
 66 import com.sun.source.doctree.UsesTree;
 67 import com.sun.source.doctree.ValueTree;
 68 import com.sun.source.doctree.VersionTree;
 69 import com.sun.source.util.DocTreePath;
 70 import com.sun.source.util.DocTrees;
 71 import com.sun.source.util.SimpleDocTreeVisitor;
 72 import com.sun.source.util.TreePath;
 73 import jdk.javadoc.internal.doclets.toolkit.BaseConfiguration;
 74 
 75 import static com.sun.source.doctree.DocTree.Kind.*;
 76 
 77 /**
 78  *  A utility class.
 79  *
 80  *  &lt;p&gt;&lt;b&gt;This is NOT part of any supported API.
 81  *  If you write code that depends on this, you do so at your own risk.
 82  *  This code and its internal interfaces are subject to change or
 83  *  deletion without notice.&lt;/b&gt;
 84  */
 85 public class CommentHelper {

 86     public final TreePath path;
<span class="line-modified"> 87     public final DocCommentTree dctree;</span>
 88     public final Element element;
 89     private Element overriddenElement;
 90 
 91     public static final String SPACER = &quot; &quot;;
 92 
<span class="line-modified"> 93     public CommentHelper(BaseConfiguration configuration, Element element, TreePath path, DocCommentTree dctree) {</span>
<span class="line-modified"> 94         //this.configuration = configuration;</span>








 95         this.element = element;
 96         this.path = path;
<span class="line-modified"> 97         this.dctree = dctree;</span>
 98     }
 99 
100     public void setOverrideElement(Element ove) {
101         if (this.element == ove) {
<span class="line-modified">102             throw new AssertionError(&quot;cannot set given element as overriden element&quot;);</span>
103         }
104         overriddenElement = ove;
105     }
106 
<span class="line-removed">107     @SuppressWarnings(&quot;fallthrough&quot;)</span>
108     public String getTagName(DocTree dtree) {
109         switch (dtree.getKind()) {
110             case AUTHOR:
111             case DEPRECATED:
112             case PARAM:
113             case PROVIDES:
114             case RETURN:
115             case SEE:
116             case SERIAL_DATA:
117             case SERIAL_FIELD:
118             case THROWS:
119             case UNKNOWN_BLOCK_TAG:
120             case USES:
121             case VERSION:
<span class="line-modified">122                 return ((BlockTagTree)dtree).getTagName();</span>
123             case UNKNOWN_INLINE_TAG:
<span class="line-modified">124                 return ((InlineTagTree)dtree).getTagName();</span>
125             case ERRONEOUS:
126                 return &quot;erroneous&quot;;
127             default:
128                 return dtree.getKind().tagName;
129         }
130     }
131 
132     public boolean isTypeParameter(DocTree dtree) {
133         if (dtree.getKind() == PARAM) {
134             return ((ParamTree)dtree).isTypeParameter();
135         }
136         return false;
137     }
138 
139     public String getParameterName(DocTree dtree) {
140         if (dtree.getKind() == PARAM) {
141             return ((ParamTree) dtree).getName().toString();
142         } else {
143             return null;
144         }
145     }
146 
<span class="line-modified">147     Element getElement(BaseConfiguration c, ReferenceTree rtree) {</span>

148         // likely a synthesized tree
149         if (path == null) {
<span class="line-modified">150             TypeMirror symbol = c.utils.getSymbol(rtree.getSignature());</span>



151             if (symbol == null) {
152                 return null;
153             }
<span class="line-modified">154             return  c.docEnv.getTypeUtils().asElement(symbol);</span>
155         }
156         // case A: the element contains no comments associated and
157         // the comments need to be copied from ancestor
158         // case B: the element has @inheritDoc, then the ancestral comment
159         // as appropriate has to be copied over.
160 
161         // Case A.
<span class="line-modified">162         if (dctree == null &amp;&amp; overriddenElement != null) {</span>
<span class="line-modified">163             CommentHelper ovch = c.utils.getCommentHelper(overriddenElement);</span>
<span class="line-modified">164             return ovch.getElement(c, rtree);</span>
165         }
<span class="line-modified">166         if (dctree == null) {</span>
167             return null;
168         }
<span class="line-modified">169         DocTreePath docTreePath = DocTreePath.getPath(path, dctree, rtree);</span>
170         if (docTreePath == null) {
171             // Case B.
172             if (overriddenElement != null) {
<span class="line-modified">173                 CommentHelper ovch = c.utils.getCommentHelper(overriddenElement);</span>
<span class="line-modified">174                 return ovch.getElement(c, rtree);</span>
175             }
176             return null;
177         }
<span class="line-modified">178         DocTrees doctrees = c.docEnv.getDocTrees();</span>
179         return doctrees.getElement(docTreePath);
180     }
181 
<span class="line-modified">182     public Element getException(BaseConfiguration c, DocTree dtree) {</span>
183         if (dtree.getKind() == THROWS || dtree.getKind() == EXCEPTION) {
184             ThrowsTree tt = (ThrowsTree)dtree;
185             ReferenceTree exceptionName = tt.getExceptionName();
<span class="line-modified">186             return getElement(c, exceptionName);</span>
187         }
188         return null;
189     }
190 
<span class="line-modified">191     public List&lt;? extends DocTree&gt; getDescription(BaseConfiguration c, DocTree dtree) {</span>
<span class="line-modified">192         return getTags(c, dtree);</span>
193     }
194 
195     public String getText(List&lt;? extends DocTree&gt; list) {
196         StringBuilder sb = new StringBuilder();
197         for (DocTree dt : list) {
198             sb.append(getText0(dt));
199         }
200         return sb.toString();
201     }
202 
203     public String getText(DocTree dt) {
204         return getText0(dt).toString();
205     }
206 
207     private StringBuilder getText0(DocTree dt) {
208         final StringBuilder sb = new StringBuilder();
209         new SimpleDocTreeVisitor&lt;Void, Void&gt;() {
210             @Override
211             public Void visitAttribute(AttributeTree node, Void p) {
212                 sb.append(SPACER).append(node.getName());
213                 if (node.getValueKind() == ValueKind.EMPTY) {
214                     return null;
215                 }
216 
217                 sb.append(&quot;=&quot;);
218                 String quote;
219                 switch (node.getValueKind()) {
220                     case DOUBLE:
221                         quote = &quot;\&quot;&quot;;
222                         break;
223                     case SINGLE:
<span class="line-modified">224                         quote = &quot;\&#39;&quot;;</span>
225                         break;
226                     default:
227                         quote = &quot;&quot;;
228                         break;
229                 }
230                 sb.append(quote);
<span class="line-modified">231                 node.getValue().stream().forEach((dt) -&gt; {</span>
<span class="line-removed">232                     dt.accept(this, null);</span>
<span class="line-removed">233                 });</span>
234                 sb.append(quote);
235                 return null;
236             }
237 
238             @Override
239             public Void visitEndElement(EndElementTree node, Void p) {
240                 sb.append(&quot;&lt;/&quot;)
241                         .append(node.getName())
242                         .append(&quot;&gt;&quot;);
243                 return null;
244             }
245 
246             @Override
247             public Void visitEntity(EntityTree node, Void p) {
248                 sb.append(node.toString());
249                 return null;
250             }
251 
252             @Override
253             public Void visitLink(LinkTree node, Void p) {
254                 if (node.getReference() == null) {
255                     return null;
256                 }
257 
258                 node.getReference().accept(this, null);
<span class="line-modified">259                 node.getLabel().stream().forEach((dt) -&gt; {</span>
<span class="line-removed">260                     dt.accept(this, null);</span>
<span class="line-removed">261                 });</span>
262                 return null;
263             }
264 
265             @Override
266             public Void visitLiteral(LiteralTree node, Void p) {
267                 if (node.getKind() == CODE) {
268                     sb.append(&quot;&lt;&quot;).append(node.getKind().tagName).append(&quot;&gt;&quot;);
269                 }
270                 sb.append(node.getBody().toString());
271                 if (node.getKind() == CODE) {
272                     sb.append(&quot;&lt;/&quot;).append(node.getKind().tagName).append(&quot;&gt;&quot;);
273                 }
274                 return null;
275             }
276 
277             @Override
278             public Void visitReference(ReferenceTree node, Void p) {
279                 sb.append(node.getSignature());
280                 return null;
281             }
282 
283             @Override
284             public Void visitSee(SeeTree node, Void p) {
<span class="line-modified">285                 node.getReference().stream().forEach((dt) -&gt; {</span>
<span class="line-removed">286                     dt.accept(this, null);</span>
<span class="line-removed">287                 });</span>
288                 return null;
289             }
290 
291             @Override
292             public Void visitSerial(SerialTree node, Void p) {
<span class="line-modified">293                 node.getDescription().stream().forEach((dt) -&gt; {</span>
<span class="line-removed">294                     dt.accept(this, null);</span>
<span class="line-removed">295                 });</span>
296                 return null;
297             }
298 
299             @Override
300             public Void visitStartElement(StartElementTree node, Void p) {
301                 sb.append(&quot;&lt;&quot;);
302                 sb.append(node.getName());
<span class="line-modified">303                 node.getAttributes().stream().forEach((dt) -&gt; {</span>
<span class="line-modified">304                     dt.accept(this, null);</span>
<span class="line-removed">305                 });</span>
<span class="line-removed">306                 sb.append((node.isSelfClosing() ? &quot;/&gt;&quot; : &quot;&gt;&quot;));</span>
307                 return null;
308             }
309 
310             @Override
311             public Void visitText(TextTree node, Void p) {
312                 sb.append(node.getBody());
313                 return null;
314             }
315 
316             @Override
317             public Void visitUnknownBlockTag(UnknownBlockTagTree node, Void p) {
<span class="line-modified">318                 node.getContent().stream().forEach((dt) -&gt; {</span>
<span class="line-removed">319                     dt.accept(this, null);</span>
<span class="line-removed">320                 });</span>
321                 return null;
322             }
323 
324             @Override
325             public Void visitValue(ValueTree node, Void p) {
326                 return node.getReference().accept(this, null);
327             }
328 
329             @Override
330             protected Void defaultAction(DocTree node, Void p) {
331                 sb.append(node.toString());
332                 return null;
333             }
334         }.visit(dt, null);
335         return sb;
336     }
337 
<span class="line-modified">338     public String getLabel(BaseConfiguration c, DocTree dtree) {</span>
339         return new SimpleDocTreeVisitor&lt;String, Void&gt;() {
340             @Override
341             public String visitLink(LinkTree node, Void p) {
<span class="line-modified">342                 StringBuilder sb = new StringBuilder();</span>
<span class="line-modified">343                 node.getLabel().stream().forEach((dt) -&gt; {</span>
<span class="line-modified">344                     sb.append(getText(dt));</span>
<span class="line-removed">345                 });</span>
<span class="line-removed">346                 return sb.toString();</span>
347             }
348 
349             @Override
350             public String visitSee(SeeTree node, Void p) {
<span class="line-modified">351                 StringBuilder sb = new StringBuilder();</span>
<span class="line-modified">352                 node.getReference().stream().filter((dt) -&gt; (c.utils.isText(dt))).forEach((dt) -&gt; {</span>
<span class="line-modified">353                     sb.append(((TextTree)dt).getBody());</span>
<span class="line-modified">354                 });</span>
<span class="line-modified">355                 return sb.toString();</span>
356             }
357 
358             @Override
359             protected String defaultAction(DocTree node, Void p) {
360                 return &quot;&quot;;
361             }
362         }.visit(dtree, null);
363     }
364 
<span class="line-modified">365     public TypeElement getReferencedClass(BaseConfiguration c, DocTree dtree) {</span>
<span class="line-modified">366         Element e = getReferencedElement(c, dtree);</span>

367         if (e == null) {
368             return null;
<span class="line-modified">369         } else if (c.utils.isTypeElement(e)) {</span>
370             return (TypeElement) e;
<span class="line-modified">371         } else if (!c.utils.isPackage(e)) {</span>
<span class="line-modified">372             return c.utils.getEnclosingTypeElement(e);</span>
373         }
374         return null;
375     }
376 
<span class="line-modified">377     public String getReferencedClassName(BaseConfiguration c, DocTree dtree) {</span>
<span class="line-modified">378         Element e = getReferencedClass(c, dtree);</span>

379         if (e != null) {
<span class="line-modified">380             return c.utils.isTypeElement(e) ? c.utils.getSimpleName(e) : null;</span>
381         }
382         String s = getReferencedSignature(dtree);
383         if (s == null) {
384             return null;
385         }
386         int n = s.indexOf(&quot;#&quot;);
387         return (n == -1) ? s : s.substring(0, n);
388     }
389 
<span class="line-modified">390     public Element getReferencedMember(BaseConfiguration c, DocTree dtree) {</span>
<span class="line-modified">391         Element e = getReferencedElement(c, dtree);</span>

392         if (e == null) {
393             return null;
394         }
<span class="line-modified">395         return (c.utils.isExecutableElement(e) || c.utils.isVariableElement(e)) ? e : null;</span>
396     }
397 
398     public String getReferencedMemberName(DocTree dtree) {
399         String s = getReferencedSignature(dtree);
400         if (s == null) {
401             return null;
402         }
403         int n = s.indexOf(&quot;#&quot;);
404         return (n == -1) ? null : s.substring(n + 1);
405     }
406 
<span class="line-modified">407     public String getReferencedMemberName(BaseConfiguration c, Element e) {</span>
408         if (e == null) {
409             return null;
410         }
<span class="line-modified">411         return c.utils.isExecutableElement(e)</span>
<span class="line-modified">412                 ? c.utils.getSimpleName(e) + c.utils.makeSignature((ExecutableElement) e, true, true)</span>
<span class="line-modified">413                 : c.utils.getSimpleName(e);</span>

414     }
415 
<span class="line-modified">416     public PackageElement getReferencedPackage(BaseConfiguration c, DocTree dtree) {</span>
<span class="line-modified">417         Element e = getReferencedElement(c, dtree);</span>
418         if (e != null) {
<span class="line-modified">419             return c.utils.containingPackage(e);</span>

420         }
421         return null;
422     }
423 
<span class="line-modified">424     public List&lt;? extends DocTree&gt; getFirstSentenceTrees(BaseConfiguration c, List&lt;? extends DocTree&gt; body) {</span>
<span class="line-modified">425         List&lt;DocTree&gt; firstSentence = c.docEnv.getDocTrees().getFirstSentence(body);</span>
<span class="line-removed">426         return firstSentence;</span>
427     }
428 
<span class="line-modified">429     public List&lt;? extends DocTree&gt; getFirstSentenceTrees(BaseConfiguration c, DocTree dtree) {</span>
<span class="line-modified">430         return getFirstSentenceTrees(c, getBody(c, dtree));</span>
431     }
432 
<span class="line-modified">433     private Element getReferencedElement(BaseConfiguration c, DocTree dtree) {</span>
434         return new SimpleDocTreeVisitor&lt;Element, Void&gt;() {
435             @Override
436             public Element visitSee(SeeTree node, Void p) {
437                 for (DocTree dt : node.getReference()) {
438                     return visit(dt, null);
439                 }
440                 return null;
441             }
442 
443             @Override
444             public Element visitLink(LinkTree node, Void p) {
445                 return visit(node.getReference(), null);
446             }
447 
448             @Override
449             public Element visitProvides(ProvidesTree node, Void p) {
450                 return visit(node.getServiceType(), null);
451             }
452 
453             @Override
454             public Element visitValue(ValueTree node, Void p) {
455                 return visit(node.getReference(), null);
456             }
457 
458             @Override
459             public Element visitReference(ReferenceTree node, Void p) {
<span class="line-modified">460                 return getElement(c, node);</span>
461             }
462 
463             @Override
464             public Element visitSerialField(SerialFieldTree node, Void p) {
465                 return visit(node.getType(), null);
466             }
467 
468             @Override
469             public Element visitUses(UsesTree node, Void p) {
470                 return visit(node.getServiceType(), null);
471             }
472 
473             @Override
474             protected Element defaultAction(DocTree node, Void p) {
475                return null;
476             }
477         }.visit(dtree, null);
478     }
479 
<span class="line-modified">480     public TypeElement getServiceType(BaseConfiguration c, DocTree dtree) {</span>
<span class="line-modified">481         Element e = getReferencedElement(c, dtree);</span>
482         if (e != null) {
<span class="line-modified">483             return c.utils.isTypeElement(e) ? (TypeElement) e : null;</span>

484         }
485         return null;
486     }
487 
488     public  String getReferencedSignature(DocTree dtree) {
489         return new SimpleDocTreeVisitor&lt;String, Void&gt;() {
490             @Override
491             public String visitSee(SeeTree node, Void p) {
492                 for (DocTree dt : node.getReference()) {
493                     return visit(dt, null);
494                 }
495                 return null;
496             }
497 
498             @Override
499             public String visitLink(LinkTree node, Void p) {
500                 return visit(node.getReference(), null);
501             }
502 
503             @Override
</pre>
<hr />
<pre>
526         return dtree.getKind() == SEE ? ((SeeTree)dtree).getReference() : null;
527     }
528 
529     public ReferenceTree getExceptionName(DocTree dtree) {
530         return (dtree.getKind() == THROWS || dtree.getKind() == EXCEPTION)
531                 ? ((ThrowsTree)dtree).getExceptionName()
532                 : null;
533     }
534 
535     public IdentifierTree getName(DocTree dtree) {
536         switch (dtree.getKind()) {
537             case PARAM:
538                 return ((ParamTree)dtree).getName();
539             case SERIAL_FIELD:
540                 return ((SerialFieldTree)dtree).getName();
541             default:
542                 return null;
543             }
544     }
545 
<span class="line-modified">546     public List&lt;? extends DocTree&gt; getTags(BaseConfiguration c, DocTree dtree) {</span>
547         return new SimpleDocTreeVisitor&lt;List&lt;? extends DocTree&gt;, Void&gt;() {
548             List&lt;? extends DocTree&gt; asList(String content) {
549                 List&lt;DocTree&gt; out = new ArrayList&lt;&gt;();
<span class="line-modified">550                 out.add((TextTree)c.cmtUtils.makeTextTree(content));</span>
551                 return out;
552             }
553 
554             @Override
555             public List&lt;? extends DocTree&gt; visitAuthor(AuthorTree node, Void p) {
556                 return node.getName();
557             }
558 
559             @Override
560             public List&lt;? extends DocTree&gt; visitComment(CommentTree node, Void p) {
561                 return asList(node.getBody());
562             }
563 
564             @Override
565             public List&lt;? extends DocTree&gt; visitDeprecated(DeprecatedTree node, Void p) {
566                 return node.getBody();
567             }
568 
569             @Override
570             public List&lt;? extends DocTree&gt; visitDocComment(DocCommentTree node, Void p) {
</pre>
<hr />
<pre>
631                  return node.getDescription();
632             }
633 
634             @Override
635             public List&lt;? extends DocTree&gt; visitUnknownBlockTag(UnknownBlockTagTree node, Void p) {
636                 return node.getContent();
637             }
638 
639             @Override
640             public List&lt;? extends DocTree&gt; visitUses(UsesTree node, Void p) {
641                  return node.getDescription();
642             }
643 
644             @Override
645             protected List&lt;? extends DocTree&gt; defaultAction(DocTree node, Void p) {
646                return Collections.emptyList();
647             }
648         }.visit(dtree, null);
649     }
650 
<span class="line-modified">651     public List&lt;? extends DocTree&gt; getBody(BaseConfiguration c, DocTree dtree) {</span>
<span class="line-modified">652         return getTags(c, dtree);</span>
653     }
654 
655     public ReferenceTree getType(DocTree dtree) {
656         if (dtree.getKind() == SERIAL_FIELD) {
<span class="line-modified">657             return ((SerialFieldTree)dtree).getType();</span>
658         } else {
659             return null;
660         }
661     }
662 
663     public DocTreePath getDocTreePath(DocTree dtree) {
<span class="line-modified">664         if (path == null || dctree == null || dtree == null)</span>
665             return null;
<span class="line-modified">666         return DocTreePath.getPath(path, dctree, dtree);</span>
667     }
668 
669     public Element getOverriddenElement() {
670         return overriddenElement;
671     }
672 
<span class="line-removed">673 </span>
674     /**
675      * For debugging purposes only. Do not rely on this for other things.
676      * @return a string representation.
677      */
678     @Override
679     public String toString() {
<span class="line-modified">680         StringBuilder sb = new StringBuilder(&quot;CommentHelper{&quot; + &quot;path=&quot; + path + &quot;, dctree=&quot; + dctree);</span>
681         sb.append(&quot;, element=&quot;);
682         sb.append(element.getEnclosingElement());
683         sb.append(&quot;::&quot;);
684         sb.append(element);
685         sb.append(&quot;, overriddenElement=&quot;);
686         if (overriddenElement != null) {
687             sb.append(overriddenElement.getEnclosingElement());
688             sb.append(&quot;::&quot;);
689             sb.append(overriddenElement);
690         } else {
691             sb.append(&quot;&lt;none&gt;&quot;);
692         }
693         sb.append(&#39;}&#39;);
694         return sb.toString();
695     }
696 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2020, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.javadoc.internal.doclets.toolkit.util;
 27 
 28 import java.util.ArrayList;
 29 import java.util.Collections;
 30 import java.util.List;
<span class="line-added"> 31 import java.util.stream.Collectors;</span>
 32 
 33 import javax.lang.model.element.Element;
 34 import javax.lang.model.element.ExecutableElement;

 35 import javax.lang.model.element.PackageElement;
 36 import javax.lang.model.element.TypeElement;
 37 import javax.lang.model.type.TypeMirror;
 38 
 39 import com.sun.source.doctree.AttributeTree;
 40 import com.sun.source.doctree.AttributeTree.ValueKind;
 41 import com.sun.source.doctree.AuthorTree;
 42 import com.sun.source.doctree.BlockTagTree;
 43 import com.sun.source.doctree.CommentTree;
 44 import com.sun.source.doctree.DeprecatedTree;
 45 import com.sun.source.doctree.DocCommentTree;
 46 import com.sun.source.doctree.DocTree;
 47 import com.sun.source.doctree.EndElementTree;
 48 import com.sun.source.doctree.EntityTree;
 49 import com.sun.source.doctree.IdentifierTree;
 50 import com.sun.source.doctree.InlineTagTree;
 51 import com.sun.source.doctree.LinkTree;
 52 import com.sun.source.doctree.LiteralTree;
 53 import com.sun.source.doctree.ParamTree;
 54 import com.sun.source.doctree.ProvidesTree;
</pre>
<hr />
<pre>
 66 import com.sun.source.doctree.UsesTree;
 67 import com.sun.source.doctree.ValueTree;
 68 import com.sun.source.doctree.VersionTree;
 69 import com.sun.source.util.DocTreePath;
 70 import com.sun.source.util.DocTrees;
 71 import com.sun.source.util.SimpleDocTreeVisitor;
 72 import com.sun.source.util.TreePath;
 73 import jdk.javadoc.internal.doclets.toolkit.BaseConfiguration;
 74 
 75 import static com.sun.source.doctree.DocTree.Kind.*;
 76 
 77 /**
 78  *  A utility class.
 79  *
 80  *  &lt;p&gt;&lt;b&gt;This is NOT part of any supported API.
 81  *  If you write code that depends on this, you do so at your own risk.
 82  *  This code and its internal interfaces are subject to change or
 83  *  deletion without notice.&lt;/b&gt;
 84  */
 85 public class CommentHelper {
<span class="line-added"> 86     private final BaseConfiguration configuration;</span>
 87     public final TreePath path;
<span class="line-modified"> 88     public final DocCommentTree dcTree;</span>
 89     public final Element element;
 90     private Element overriddenElement;
 91 
 92     public static final String SPACER = &quot; &quot;;
 93 
<span class="line-modified"> 94     /**</span>
<span class="line-modified"> 95      * Creates a utility class to encapsulate the contextual information for a doc comment tree.</span>
<span class="line-added"> 96      *</span>
<span class="line-added"> 97      * @param configuration the configuration</span>
<span class="line-added"> 98      * @param element       the element for which this is a doc comment</span>
<span class="line-added"> 99      * @param path          the path for the element</span>
<span class="line-added">100      * @param dcTree        the doc comment</span>
<span class="line-added">101      */</span>
<span class="line-added">102     public CommentHelper(BaseConfiguration configuration, Element element, TreePath path, DocCommentTree dcTree) {</span>
<span class="line-added">103         this.configuration = configuration;</span>
104         this.element = element;
105         this.path = path;
<span class="line-modified">106         this.dcTree = dcTree;</span>
107     }
108 
109     public void setOverrideElement(Element ove) {
110         if (this.element == ove) {
<span class="line-modified">111             throw new AssertionError(&quot;cannot set given element as overridden element&quot;);</span>
112         }
113         overriddenElement = ove;
114     }
115 

116     public String getTagName(DocTree dtree) {
117         switch (dtree.getKind()) {
118             case AUTHOR:
119             case DEPRECATED:
120             case PARAM:
121             case PROVIDES:
122             case RETURN:
123             case SEE:
124             case SERIAL_DATA:
125             case SERIAL_FIELD:
126             case THROWS:
127             case UNKNOWN_BLOCK_TAG:
128             case USES:
129             case VERSION:
<span class="line-modified">130                 return ((BlockTagTree) dtree).getTagName();</span>
131             case UNKNOWN_INLINE_TAG:
<span class="line-modified">132                 return ((InlineTagTree) dtree).getTagName();</span>
133             case ERRONEOUS:
134                 return &quot;erroneous&quot;;
135             default:
136                 return dtree.getKind().tagName;
137         }
138     }
139 
140     public boolean isTypeParameter(DocTree dtree) {
141         if (dtree.getKind() == PARAM) {
142             return ((ParamTree)dtree).isTypeParameter();
143         }
144         return false;
145     }
146 
147     public String getParameterName(DocTree dtree) {
148         if (dtree.getKind() == PARAM) {
149             return ((ParamTree) dtree).getName().toString();
150         } else {
151             return null;
152         }
153     }
154 
<span class="line-modified">155     Element getElement(ReferenceTree rtree) {</span>
<span class="line-added">156         Utils utils = configuration.utils;</span>
157         // likely a synthesized tree
158         if (path == null) {
<span class="line-modified">159             // NOTE: this code path only supports module/package/type signatures</span>
<span class="line-added">160             //       and not member signatures. For more complete support,</span>
<span class="line-added">161             //       set a suitable path and avoid this branch.</span>
<span class="line-added">162             TypeMirror symbol = utils.getSymbol(rtree.getSignature());</span>
163             if (symbol == null) {
164                 return null;
165             }
<span class="line-modified">166             return configuration.docEnv.getTypeUtils().asElement(symbol);</span>
167         }
168         // case A: the element contains no comments associated and
169         // the comments need to be copied from ancestor
170         // case B: the element has @inheritDoc, then the ancestral comment
171         // as appropriate has to be copied over.
172 
173         // Case A.
<span class="line-modified">174         if (dcTree == null &amp;&amp; overriddenElement != null) {</span>
<span class="line-modified">175             CommentHelper ovch = utils.getCommentHelper(overriddenElement);</span>
<span class="line-modified">176             return ovch.getElement(rtree);</span>
177         }
<span class="line-modified">178         if (dcTree == null) {</span>
179             return null;
180         }
<span class="line-modified">181         DocTreePath docTreePath = DocTreePath.getPath(path, dcTree, rtree);</span>
182         if (docTreePath == null) {
183             // Case B.
184             if (overriddenElement != null) {
<span class="line-modified">185                 CommentHelper ovch = utils.getCommentHelper(overriddenElement);</span>
<span class="line-modified">186                 return ovch.getElement(rtree);</span>
187             }
188             return null;
189         }
<span class="line-modified">190         DocTrees doctrees = configuration.docEnv.getDocTrees();</span>
191         return doctrees.getElement(docTreePath);
192     }
193 
<span class="line-modified">194     public Element getException(DocTree dtree) {</span>
195         if (dtree.getKind() == THROWS || dtree.getKind() == EXCEPTION) {
196             ThrowsTree tt = (ThrowsTree)dtree;
197             ReferenceTree exceptionName = tt.getExceptionName();
<span class="line-modified">198             return getElement(exceptionName);</span>
199         }
200         return null;
201     }
202 
<span class="line-modified">203     public List&lt;? extends DocTree&gt; getDescription(DocTree dtree) {</span>
<span class="line-modified">204         return getTags(dtree);</span>
205     }
206 
207     public String getText(List&lt;? extends DocTree&gt; list) {
208         StringBuilder sb = new StringBuilder();
209         for (DocTree dt : list) {
210             sb.append(getText0(dt));
211         }
212         return sb.toString();
213     }
214 
215     public String getText(DocTree dt) {
216         return getText0(dt).toString();
217     }
218 
219     private StringBuilder getText0(DocTree dt) {
220         final StringBuilder sb = new StringBuilder();
221         new SimpleDocTreeVisitor&lt;Void, Void&gt;() {
222             @Override
223             public Void visitAttribute(AttributeTree node, Void p) {
224                 sb.append(SPACER).append(node.getName());
225                 if (node.getValueKind() == ValueKind.EMPTY) {
226                     return null;
227                 }
228 
229                 sb.append(&quot;=&quot;);
230                 String quote;
231                 switch (node.getValueKind()) {
232                     case DOUBLE:
233                         quote = &quot;\&quot;&quot;;
234                         break;
235                     case SINGLE:
<span class="line-modified">236                         quote = &quot;&#39;&quot;;</span>
237                         break;
238                     default:
239                         quote = &quot;&quot;;
240                         break;
241                 }
242                 sb.append(quote);
<span class="line-modified">243                 node.getValue().forEach(dt -&gt; dt.accept(this, null));</span>


244                 sb.append(quote);
245                 return null;
246             }
247 
248             @Override
249             public Void visitEndElement(EndElementTree node, Void p) {
250                 sb.append(&quot;&lt;/&quot;)
251                         .append(node.getName())
252                         .append(&quot;&gt;&quot;);
253                 return null;
254             }
255 
256             @Override
257             public Void visitEntity(EntityTree node, Void p) {
258                 sb.append(node.toString());
259                 return null;
260             }
261 
262             @Override
263             public Void visitLink(LinkTree node, Void p) {
264                 if (node.getReference() == null) {
265                     return null;
266                 }
267 
268                 node.getReference().accept(this, null);
<span class="line-modified">269                 node.getLabel().forEach(dt -&gt; dt.accept(this, null));</span>


270                 return null;
271             }
272 
273             @Override
274             public Void visitLiteral(LiteralTree node, Void p) {
275                 if (node.getKind() == CODE) {
276                     sb.append(&quot;&lt;&quot;).append(node.getKind().tagName).append(&quot;&gt;&quot;);
277                 }
278                 sb.append(node.getBody().toString());
279                 if (node.getKind() == CODE) {
280                     sb.append(&quot;&lt;/&quot;).append(node.getKind().tagName).append(&quot;&gt;&quot;);
281                 }
282                 return null;
283             }
284 
285             @Override
286             public Void visitReference(ReferenceTree node, Void p) {
287                 sb.append(node.getSignature());
288                 return null;
289             }
290 
291             @Override
292             public Void visitSee(SeeTree node, Void p) {
<span class="line-modified">293                 node.getReference().forEach(dt -&gt; dt.accept(this, null));</span>


294                 return null;
295             }
296 
297             @Override
298             public Void visitSerial(SerialTree node, Void p) {
<span class="line-modified">299                 node.getDescription().forEach(dt -&gt; dt.accept(this, null));</span>


300                 return null;
301             }
302 
303             @Override
304             public Void visitStartElement(StartElementTree node, Void p) {
305                 sb.append(&quot;&lt;&quot;);
306                 sb.append(node.getName());
<span class="line-modified">307                 node.getAttributes().forEach(dt -&gt; dt.accept(this, null));</span>
<span class="line-modified">308                 sb.append(node.isSelfClosing() ? &quot;/&gt;&quot; : &quot;&gt;&quot;);</span>


309                 return null;
310             }
311 
312             @Override
313             public Void visitText(TextTree node, Void p) {
314                 sb.append(node.getBody());
315                 return null;
316             }
317 
318             @Override
319             public Void visitUnknownBlockTag(UnknownBlockTagTree node, Void p) {
<span class="line-modified">320                 node.getContent().forEach(dt -&gt; dt.accept(this, null));</span>


321                 return null;
322             }
323 
324             @Override
325             public Void visitValue(ValueTree node, Void p) {
326                 return node.getReference().accept(this, null);
327             }
328 
329             @Override
330             protected Void defaultAction(DocTree node, Void p) {
331                 sb.append(node.toString());
332                 return null;
333             }
334         }.visit(dt, null);
335         return sb;
336     }
337 
<span class="line-modified">338     public String getLabel(DocTree dtree) {</span>
339         return new SimpleDocTreeVisitor&lt;String, Void&gt;() {
340             @Override
341             public String visitLink(LinkTree node, Void p) {
<span class="line-modified">342                 return node.getLabel().stream()</span>
<span class="line-modified">343                         .map(dt -&gt; getText(dt))</span>
<span class="line-modified">344                         .collect(Collectors.joining());</span>


345             }
346 
347             @Override
348             public String visitSee(SeeTree node, Void p) {
<span class="line-modified">349                 Utils utils = configuration.utils;</span>
<span class="line-modified">350                 return node.getReference().stream()</span>
<span class="line-modified">351                         .filter(utils::isText)</span>
<span class="line-modified">352                         .map(dt -&gt; ((TextTree) dt).getBody())</span>
<span class="line-modified">353                         .collect(Collectors.joining());</span>
354             }
355 
356             @Override
357             protected String defaultAction(DocTree node, Void p) {
358                 return &quot;&quot;;
359             }
360         }.visit(dtree, null);
361     }
362 
<span class="line-modified">363     public TypeElement getReferencedClass(DocTree dtree) {</span>
<span class="line-modified">364         Utils utils = configuration.utils;</span>
<span class="line-added">365         Element e = getReferencedElement(dtree);</span>
366         if (e == null) {
367             return null;
<span class="line-modified">368         } else if (utils.isTypeElement(e)) {</span>
369             return (TypeElement) e;
<span class="line-modified">370         } else if (!utils.isPackage(e)) {</span>
<span class="line-modified">371             return utils.getEnclosingTypeElement(e);</span>
372         }
373         return null;
374     }
375 
<span class="line-modified">376     public String getReferencedClassName(DocTree dtree) {</span>
<span class="line-modified">377         Utils utils = configuration.utils;</span>
<span class="line-added">378         Element e = getReferencedClass(dtree);</span>
379         if (e != null) {
<span class="line-modified">380             return utils.isTypeElement(e) ? utils.getSimpleName(e) : null;</span>
381         }
382         String s = getReferencedSignature(dtree);
383         if (s == null) {
384             return null;
385         }
386         int n = s.indexOf(&quot;#&quot;);
387         return (n == -1) ? s : s.substring(0, n);
388     }
389 
<span class="line-modified">390     public Element getReferencedMember(DocTree dtree) {</span>
<span class="line-modified">391         Utils utils = configuration.utils;</span>
<span class="line-added">392         Element e = getReferencedElement(dtree);</span>
393         if (e == null) {
394             return null;
395         }
<span class="line-modified">396         return (utils.isExecutableElement(e) || utils.isVariableElement(e)) ? e : null;</span>
397     }
398 
399     public String getReferencedMemberName(DocTree dtree) {
400         String s = getReferencedSignature(dtree);
401         if (s == null) {
402             return null;
403         }
404         int n = s.indexOf(&quot;#&quot;);
405         return (n == -1) ? null : s.substring(n + 1);
406     }
407 
<span class="line-modified">408     public String getReferencedMemberName(Element e) {</span>
409         if (e == null) {
410             return null;
411         }
<span class="line-modified">412         Utils utils = configuration.utils;</span>
<span class="line-modified">413         return utils.isExecutableElement(e)</span>
<span class="line-modified">414                 ? utils.getSimpleName(e) + utils.makeSignature((ExecutableElement) e, true, true)</span>
<span class="line-added">415                 : utils.getSimpleName(e);</span>
416     }
417 
<span class="line-modified">418     public PackageElement getReferencedPackage(DocTree dtree) {</span>
<span class="line-modified">419         Element e = getReferencedElement(dtree);</span>
420         if (e != null) {
<span class="line-modified">421             Utils utils = configuration.utils;</span>
<span class="line-added">422             return utils.containingPackage(e);</span>
423         }
424         return null;
425     }
426 
<span class="line-modified">427     public List&lt;? extends DocTree&gt; getFirstSentenceTrees(List&lt;? extends DocTree&gt; body) {</span>
<span class="line-modified">428         return configuration.docEnv.getDocTrees().getFirstSentence(body);</span>

429     }
430 
<span class="line-modified">431     public List&lt;? extends DocTree&gt; getFirstSentenceTrees(DocTree dtree) {</span>
<span class="line-modified">432         return getFirstSentenceTrees(getBody(dtree));</span>
433     }
434 
<span class="line-modified">435     private Element getReferencedElement(DocTree dtree) {</span>
436         return new SimpleDocTreeVisitor&lt;Element, Void&gt;() {
437             @Override
438             public Element visitSee(SeeTree node, Void p) {
439                 for (DocTree dt : node.getReference()) {
440                     return visit(dt, null);
441                 }
442                 return null;
443             }
444 
445             @Override
446             public Element visitLink(LinkTree node, Void p) {
447                 return visit(node.getReference(), null);
448             }
449 
450             @Override
451             public Element visitProvides(ProvidesTree node, Void p) {
452                 return visit(node.getServiceType(), null);
453             }
454 
455             @Override
456             public Element visitValue(ValueTree node, Void p) {
457                 return visit(node.getReference(), null);
458             }
459 
460             @Override
461             public Element visitReference(ReferenceTree node, Void p) {
<span class="line-modified">462                 return getElement(node);</span>
463             }
464 
465             @Override
466             public Element visitSerialField(SerialFieldTree node, Void p) {
467                 return visit(node.getType(), null);
468             }
469 
470             @Override
471             public Element visitUses(UsesTree node, Void p) {
472                 return visit(node.getServiceType(), null);
473             }
474 
475             @Override
476             protected Element defaultAction(DocTree node, Void p) {
477                return null;
478             }
479         }.visit(dtree, null);
480     }
481 
<span class="line-modified">482     public TypeElement getServiceType(DocTree dtree) {</span>
<span class="line-modified">483         Element e = getReferencedElement(dtree);</span>
484         if (e != null) {
<span class="line-modified">485             Utils utils = configuration.utils;</span>
<span class="line-added">486             return utils.isTypeElement(e) ? (TypeElement) e : null;</span>
487         }
488         return null;
489     }
490 
491     public  String getReferencedSignature(DocTree dtree) {
492         return new SimpleDocTreeVisitor&lt;String, Void&gt;() {
493             @Override
494             public String visitSee(SeeTree node, Void p) {
495                 for (DocTree dt : node.getReference()) {
496                     return visit(dt, null);
497                 }
498                 return null;
499             }
500 
501             @Override
502             public String visitLink(LinkTree node, Void p) {
503                 return visit(node.getReference(), null);
504             }
505 
506             @Override
</pre>
<hr />
<pre>
529         return dtree.getKind() == SEE ? ((SeeTree)dtree).getReference() : null;
530     }
531 
532     public ReferenceTree getExceptionName(DocTree dtree) {
533         return (dtree.getKind() == THROWS || dtree.getKind() == EXCEPTION)
534                 ? ((ThrowsTree)dtree).getExceptionName()
535                 : null;
536     }
537 
538     public IdentifierTree getName(DocTree dtree) {
539         switch (dtree.getKind()) {
540             case PARAM:
541                 return ((ParamTree)dtree).getName();
542             case SERIAL_FIELD:
543                 return ((SerialFieldTree)dtree).getName();
544             default:
545                 return null;
546             }
547     }
548 
<span class="line-modified">549     public List&lt;? extends DocTree&gt; getTags(DocTree dtree) {</span>
550         return new SimpleDocTreeVisitor&lt;List&lt;? extends DocTree&gt;, Void&gt;() {
551             List&lt;? extends DocTree&gt; asList(String content) {
552                 List&lt;DocTree&gt; out = new ArrayList&lt;&gt;();
<span class="line-modified">553                 out.add(configuration.cmtUtils.makeTextTree(content));</span>
554                 return out;
555             }
556 
557             @Override
558             public List&lt;? extends DocTree&gt; visitAuthor(AuthorTree node, Void p) {
559                 return node.getName();
560             }
561 
562             @Override
563             public List&lt;? extends DocTree&gt; visitComment(CommentTree node, Void p) {
564                 return asList(node.getBody());
565             }
566 
567             @Override
568             public List&lt;? extends DocTree&gt; visitDeprecated(DeprecatedTree node, Void p) {
569                 return node.getBody();
570             }
571 
572             @Override
573             public List&lt;? extends DocTree&gt; visitDocComment(DocCommentTree node, Void p) {
</pre>
<hr />
<pre>
634                  return node.getDescription();
635             }
636 
637             @Override
638             public List&lt;? extends DocTree&gt; visitUnknownBlockTag(UnknownBlockTagTree node, Void p) {
639                 return node.getContent();
640             }
641 
642             @Override
643             public List&lt;? extends DocTree&gt; visitUses(UsesTree node, Void p) {
644                  return node.getDescription();
645             }
646 
647             @Override
648             protected List&lt;? extends DocTree&gt; defaultAction(DocTree node, Void p) {
649                return Collections.emptyList();
650             }
651         }.visit(dtree, null);
652     }
653 
<span class="line-modified">654     public List&lt;? extends DocTree&gt; getBody(DocTree dtree) {</span>
<span class="line-modified">655         return getTags(dtree);</span>
656     }
657 
658     public ReferenceTree getType(DocTree dtree) {
659         if (dtree.getKind() == SERIAL_FIELD) {
<span class="line-modified">660             return ((SerialFieldTree) dtree).getType();</span>
661         } else {
662             return null;
663         }
664     }
665 
666     public DocTreePath getDocTreePath(DocTree dtree) {
<span class="line-modified">667         if (path == null || dcTree == null || dtree == null)</span>
668             return null;
<span class="line-modified">669         return DocTreePath.getPath(path, dcTree, dtree);</span>
670     }
671 
672     public Element getOverriddenElement() {
673         return overriddenElement;
674     }
675 

676     /**
677      * For debugging purposes only. Do not rely on this for other things.
678      * @return a string representation.
679      */
680     @Override
681     public String toString() {
<span class="line-modified">682         StringBuilder sb = new StringBuilder(&quot;CommentHelper{&quot; + &quot;path=&quot; + path + &quot;, dcTree=&quot; + dcTree);</span>
683         sb.append(&quot;, element=&quot;);
684         sb.append(element.getEnclosingElement());
685         sb.append(&quot;::&quot;);
686         sb.append(element);
687         sb.append(&quot;, overriddenElement=&quot;);
688         if (overriddenElement != null) {
689             sb.append(overriddenElement.getEnclosingElement());
690             sb.append(&quot;::&quot;);
691             sb.append(overriddenElement);
692         } else {
693             sb.append(&quot;&lt;none&gt;&quot;);
694         }
695         sb.append(&#39;}&#39;);
696         return sb.toString();
697     }
698 }
</pre>
</td>
</tr>
</table>
<center><a href="ClassUseMapper.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="DeprecatedAPIListBuilder.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>