<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.compiler/share/classes/com/sun/tools/javac/file/FSInfo.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CacheFSInfo.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JavacFileManager.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/file/FSInfo.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2008, 2016, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2008, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,13 ***</span>
<span class="line-new-header">--- 23,18 ---</span>
   * questions.
   */
  
  package com.sun.tools.javac.file;
  
<span class="line-added">+ import java.io.IOError;</span>
  import java.io.IOException;
<span class="line-added">+ import java.net.MalformedURLException;</span>
<span class="line-added">+ import java.net.URISyntaxException;</span>
<span class="line-added">+ import java.net.URL;</span>
  import java.nio.file.FileSystems;
  import java.nio.file.Files;
<span class="line-added">+ import java.nio.file.InvalidPathException;</span>
  import java.nio.file.Path;
  import java.nio.file.spi.FileSystemProvider;
  import java.util.ArrayList;
  import java.util.Collections;
  import java.util.List;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 88,11 ***</span>
      public boolean isFile(Path file) {
          return Files.isRegularFile(file);
      }
  
      public List&lt;Path&gt; getJarClassPath(Path file) throws IOException {
<span class="line-removed">-         Path parent = file.getParent();</span>
          try (JarFile jarFile = new JarFile(file.toFile())) {
              Manifest man = jarFile.getManifest();
              if (man == null)
                  return Collections.emptyList();
  
<span class="line-new-header">--- 93,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 103,24 ***</span>
              String path = attr.getValue(Attributes.Name.CLASS_PATH);
              if (path == null)
                  return Collections.emptyList();
  
              List&lt;Path&gt; list = new ArrayList&lt;&gt;();
  
              for (StringTokenizer st = new StringTokenizer(path);
                   st.hasMoreTokens(); ) {
                  String elt = st.nextToken();
<span class="line-modified">!                 Path f = FileSystems.getDefault().getPath(elt);</span>
<span class="line-modified">!                 if (!f.isAbsolute() &amp;&amp; parent != null)</span>
<span class="line-modified">!                     f = parent.resolve(f).toAbsolutePath();</span>
<span class="line-modified">!                 list.add(f);</span>
              }
  
              return list;
          }
      }
  
      private FileSystemProvider jarFSProvider;
  
      public synchronized FileSystemProvider getJarFSProvider() {
          if (jarFSProvider != null) {
              return jarFSProvider;
<span class="line-new-header">--- 107,48 ---</span>
              String path = attr.getValue(Attributes.Name.CLASS_PATH);
              if (path == null)
                  return Collections.emptyList();
  
              List&lt;Path&gt; list = new ArrayList&lt;&gt;();
<span class="line-added">+             URL base = file.toUri().toURL();</span>
  
              for (StringTokenizer st = new StringTokenizer(path);
                   st.hasMoreTokens(); ) {
                  String elt = st.nextToken();
<span class="line-modified">!                 try {</span>
<span class="line-modified">!                     URL url = tryResolveFile(base, elt);</span>
<span class="line-modified">!                     if (url != null) {</span>
<span class="line-modified">!                         list.add(Path.of(url.toURI()));</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 } catch (URISyntaxException ex) {</span>
<span class="line-added">+                     throw new IOException(ex);</span>
<span class="line-added">+                 }</span>
              }
  
              return list;
          }
      }
  
<span class="line-added">+     /**</span>
<span class="line-added">+      * Attempt to return a file URL by resolving input against a base file</span>
<span class="line-added">+      * URL.</span>
<span class="line-added">+      *</span>
<span class="line-added">+      * @return the resolved URL or null if the input is an absolute URL with</span>
<span class="line-added">+      *         a scheme other than file (ignoring case)</span>
<span class="line-added">+      * @throws MalformedURLException</span>
<span class="line-added">+      */</span>
<span class="line-added">+     static URL tryResolveFile(URL base, String input) throws MalformedURLException {</span>
<span class="line-added">+         URL retVal = new URL(base, input);</span>
<span class="line-added">+         if (input.indexOf(&#39;:&#39;) &gt;= 0 &amp;&amp; !&quot;file&quot;.equalsIgnoreCase(retVal.getProtocol())) {</span>
<span class="line-added">+             // &#39;input&#39; contains a &#39;:&#39;, which might be a scheme, or might be</span>
<span class="line-added">+             // a Windows drive letter.  If the resolved file has a protocol</span>
<span class="line-added">+             // that isn&#39;t &quot;file:&quot;, it should be ignored.</span>
<span class="line-added">+             return null;</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return retVal;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      private FileSystemProvider jarFSProvider;
  
      public synchronized FileSystemProvider getJarFSProvider() {
          if (jarFSProvider != null) {
              return jarFSProvider;
</pre>
<center><a href="CacheFSInfo.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JavacFileManager.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>