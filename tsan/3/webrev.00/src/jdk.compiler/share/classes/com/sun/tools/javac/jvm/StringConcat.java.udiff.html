<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/StringConcat.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Profile.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Target.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/StringConcat.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -24,11 +24,13 @@</span>
   */
  
  package com.sun.tools.javac.jvm;
  
  import com.sun.tools.javac.code.*;
<span class="udiff-line-added">+ import com.sun.tools.javac.code.Symbol.MethodSymbol;</span>
  import com.sun.tools.javac.comp.Resolve;
<span class="udiff-line-added">+ import com.sun.tools.javac.jvm.PoolConstant.LoadableConstant;</span>
  import com.sun.tools.javac.tree.JCTree;
  import com.sun.tools.javac.tree.TreeInfo;
  import com.sun.tools.javac.tree.TreeMaker;
  import com.sun.tools.javac.util.*;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -220,11 +222,11 @@</span>
              return gen.getItems().makeStackItem(syms.stringType);
          }
  
          private JCDiagnostic.DiagnosticPosition newStringBuilder(JCTree tree) {
              JCDiagnostic.DiagnosticPosition pos = tree.pos();
<span class="udiff-line-modified-removed">-             gen.getCode().emitop2(new_, gen.makeRef(pos, syms.stringBuilderType));</span>
<span class="udiff-line-modified-added">+             gen.getCode().emitop2(new_, gen.makeRef(pos, syms.stringBuilderType), syms.stringBuilderType);</span>
              gen.getCode().emitop0(dup);
              gen.callMethod(pos, syms.stringBuilderType, names.init, List.nil(), false);
              return pos;
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -376,14 +378,13 @@</span>
                          bsm_staticArgs,
                          null);
  
                  Symbol.DynamicMethodSymbol dynSym = new Symbol.DynamicMethodSymbol(names.makeConcat,
                          syms.noSymbol,
<span class="udiff-line-modified-removed">-                         ClassFile.REF_invokeStatic,</span>
<span class="udiff-line-removed">-                         (Symbol.MethodSymbol)bsm,</span>
<span class="udiff-line-modified-added">+                         ((MethodSymbol)bsm).asHandle(),</span>
                          indyType,
<span class="udiff-line-modified-removed">-                         List.nil().toArray());</span>
<span class="udiff-line-modified-added">+                         List.nil().toArray(new LoadableConstant[0]));</span>
  
                  Items.Item item = gen.getItems().makeDynamicItem(dynSym);
                  item.invoke();
              } finally {
                  make.at(prevPos);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -414,11 +415,11 @@</span>
              for (List&lt;JCTree&gt; t : split) {
                  Assert.check(!t.isEmpty(), &quot;Arguments list is empty&quot;);
  
                  StringBuilder recipe = new StringBuilder(t.size());
                  ListBuffer&lt;Type&gt; dynamicArgs = new ListBuffer&lt;&gt;();
<span class="udiff-line-modified-removed">-                 ListBuffer&lt;Object&gt; staticArgs = new ListBuffer&lt;&gt;();</span>
<span class="udiff-line-modified-added">+                 ListBuffer&lt;LoadableConstant&gt; staticArgs = new ListBuffer&lt;&gt;();</span>
  
                  for (JCTree arg : t) {
                      Object constVal = arg.type.constValue();
                      if (&quot;&quot;.equals(constVal)) continue;
                      if (arg.type == syms.botType) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -429,11 +430,11 @@</span>
                          // for the case it contains special tags, which requires us
                          // to expose it as detached constant.
                          String a = arg.type.stringValue();
                          if (a.indexOf(TAG_CONST) != -1 || a.indexOf(TAG_ARG) != -1) {
                              recipe.append(TAG_CONST);
<span class="udiff-line-modified-removed">-                             staticArgs.add(a);</span>
<span class="udiff-line-modified-added">+                             staticArgs.add(LoadableConstant.String(a));</span>
                          } else {
                              recipe.append(a);
                          }
                      } else {
                          // Ordinary arguments come through the dynamic arguments.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -461,23 +462,23 @@</span>
                  doCall(type, pos, recipe.toString(), List.nil(), argTypes.toList());
              }
          }
  
          /** Produce the actual invokedynamic call to StringConcatFactory */
<span class="udiff-line-modified-removed">-         private void doCall(Type type, JCDiagnostic.DiagnosticPosition pos, String recipe, List&lt;Object&gt; staticArgs, List&lt;Type&gt; dynamicArgTypes) {</span>
<span class="udiff-line-modified-added">+         private void doCall(Type type, JCDiagnostic.DiagnosticPosition pos, String recipe, List&lt;LoadableConstant&gt; staticArgs, List&lt;Type&gt; dynamicArgTypes) {</span>
              Type.MethodType indyType = new Type.MethodType(dynamicArgTypes,
                      type,
                      List.nil(),
                      syms.methodClass);
  
              int prevPos = make.pos;
              try {
                  make.at(pos);
  
                  ListBuffer&lt;Type&gt; constTypes = new ListBuffer&lt;&gt;();
<span class="udiff-line-modified-removed">-                 ListBuffer&lt;Object&gt; constants = new ListBuffer&lt;&gt;();</span>
<span class="udiff-line-modified-removed">-                 for (Object t : staticArgs) {</span>
<span class="udiff-line-modified-added">+                 ListBuffer&lt;LoadableConstant&gt; constants = new ListBuffer&lt;&gt;();</span>
<span class="udiff-line-modified-added">+                 for (LoadableConstant t : staticArgs) {</span>
                      constants.add(t);
                      constTypes.add(syms.stringType);
                  }
  
                  List&lt;Type&gt; bsm_staticArgs = List.of(syms.methodHandleLookupType,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -493,14 +494,14 @@</span>
                          bsm_staticArgs,
                          null);
  
                  Symbol.DynamicMethodSymbol dynSym = new Symbol.DynamicMethodSymbol(names.makeConcatWithConstants,
                          syms.noSymbol,
<span class="udiff-line-modified-removed">-                         ClassFile.REF_invokeStatic,</span>
<span class="udiff-line-removed">-                         (Symbol.MethodSymbol)bsm,</span>
<span class="udiff-line-modified-added">+                         ((MethodSymbol)bsm).asHandle(),</span>
                          indyType,
<span class="udiff-line-modified-removed">-                         List.&lt;Object&gt;of(recipe).appendList(constants).toArray());</span>
<span class="udiff-line-modified-added">+                         List.of(LoadableConstant.String(recipe))</span>
<span class="udiff-line-added">+                                 .appendList(constants).toArray(new LoadableConstant[constants.size()]));</span>
  
                  Items.Item item = gen.getItems().makeDynamicItem(dynSym);
                  item.invoke();
              } finally {
                  make.at(prevPos);
</pre>
<center><a href="Profile.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Target.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>