<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/ModuleNameReader.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JNIWriter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Profile.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/ModuleNameReader.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1999, 2016, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,10 +22,13 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package com.sun.tools.javac.jvm;
  
<span class="udiff-line-added">+ import com.sun.tools.javac.util.ByteBuffer;</span>
<span class="udiff-line-added">+ import com.sun.tools.javac.util.Name.NameMapper;</span>
<span class="udiff-line-added">+ </span>
  import java.io.IOException;
  import java.io.InputStream;
  import java.nio.file.Files;
  import java.nio.file.Path;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -53,20 +56,19 @@</span>
  
      private static final int INITIAL_BUFFER_SIZE = 0x0fff0;
  
      /** The buffer containing the currently read class file.
       */
<span class="udiff-line-modified-removed">-     private byte[] buf = new byte[INITIAL_BUFFER_SIZE];</span>
<span class="udiff-line-modified-added">+     private ByteBuffer buf = new ByteBuffer(INITIAL_BUFFER_SIZE);</span>
  
      /** The current input pointer.
       */
      private int bp;
  
<span class="udiff-line-modified-removed">-     /** For every constant pool entry, an index into buf where the</span>
<span class="udiff-line-removed">-      *  defining section of the entry is found.</span>
<span class="udiff-line-modified-added">+     /** The constant pool reader.</span>
       */
<span class="udiff-line-modified-removed">-     private int[] poolIdx;</span>
<span class="udiff-line-modified-added">+     private PoolReader reader;</span>
  
      public ModuleNameReader() {
      }
  
      public String readModuleName(Path p) throws IOException, BadClassFile {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -81,39 +83,41 @@</span>
          }
      }
  
      public String readModuleName(InputStream in) throws IOException, BadClassFile {
          bp = 0;
<span class="udiff-line-modified-removed">-         buf = readInputStream(buf, in);</span>
<span class="udiff-line-modified-added">+         buf.reset();</span>
<span class="udiff-line-added">+         buf.appendStream(in);</span>
  
          int magic = nextInt();
          if (magic != JAVA_MAGIC)
              throw new BadClassFile(&quot;illegal.start.of.class.file&quot;);
  
          int minorVersion = nextChar();
          int majorVersion = nextChar();
          if (majorVersion &lt; 53)
              throw new BadClassFile(&quot;bad major version number for module: &quot; + majorVersion);
  
<span class="udiff-line-modified-removed">-         indexPool();</span>
<span class="udiff-line-modified-added">+         reader = new PoolReader(buf);</span>
<span class="udiff-line-added">+         bp = reader.readPool(buf, bp);</span>
  
          int access_flags = nextChar();
          if (access_flags != 0x8000)
              throw new BadClassFile(&quot;invalid access flags for module: 0x&quot; + Integer.toHexString(access_flags));
  
          int this_class = nextChar();
<span class="udiff-line-modified-removed">-         // could, should, check this_class == CONSTANT_Class(&quot;mdoule-info&quot;)</span>
<span class="udiff-line-modified-added">+         // could, should, check this_class == CONSTANT_Class(&quot;module-info&quot;)</span>
          checkZero(nextChar(), &quot;super_class&quot;);
          checkZero(nextChar(), &quot;interface_count&quot;);
          checkZero(nextChar(), &quot;fields_count&quot;);
          checkZero(nextChar(), &quot;methods_count&quot;);
          int attributes_count = nextChar();
          for (int i = 0; i &lt; attributes_count; i++) {
              int attr_name = nextChar();
              int attr_length = nextInt();
<span class="udiff-line-modified-removed">-             if (getUtf8Value(attr_name, false).equals(&quot;Module&quot;) &amp;&amp; attr_length &gt; 2) {</span>
<span class="udiff-line-modified-removed">-                 return getModuleName(nextChar());</span>
<span class="udiff-line-modified-added">+             if (reader.peekName(attr_name, utf8Mapper(false)).equals(&quot;Module&quot;) &amp;&amp; attr_length &gt; 2) {</span>
<span class="udiff-line-modified-added">+                 return reader.peekModuleName(nextChar(), utf8Mapper(true));</span>
              } else {
                  // skip over unknown attributes
                  bp += attr_length;
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,134 +127,28 @@</span>
      void checkZero(int count, String name) throws BadClassFile {
          if (count != 0)
              throw new BadClassFile(&quot;invalid &quot; + name + &quot; for module: &quot; + count);
      }
  
<span class="udiff-line-removed">-     /** Extract a character at position bp from buf.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     char getChar(int bp) {</span>
<span class="udiff-line-removed">-         return</span>
<span class="udiff-line-removed">-             (char)(((buf[bp] &amp; 0xFF) &lt;&lt; 8) + (buf[bp+1] &amp; 0xFF));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      /** Read a character.
       */
      char nextChar() {
<span class="udiff-line-modified-removed">-         return (char)(((buf[bp++] &amp; 0xFF) &lt;&lt; 8) + (buf[bp++] &amp; 0xFF));</span>
<span class="udiff-line-modified-added">+         char res = buf.getChar(bp);</span>
<span class="udiff-line-added">+         bp += 2;</span>
<span class="udiff-line-added">+         return res;</span>
      }
  
      /** Read an integer.
       */
      int nextInt() {
<span class="udiff-line-modified-removed">-         return</span>
<span class="udiff-line-modified-removed">-             ((buf[bp++] &amp; 0xFF) &lt;&lt; 24) +</span>
<span class="udiff-line-modified-removed">-             ((buf[bp++] &amp; 0xFF) &lt;&lt; 16) +</span>
<span class="udiff-line-removed">-             ((buf[bp++] &amp; 0xFF) &lt;&lt; 8) +</span>
<span class="udiff-line-removed">-             (buf[bp++] &amp; 0xFF);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /** Index all constant pool entries, writing their start addresses into</span>
<span class="udiff-line-removed">-      *  poolIdx.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     void indexPool() throws BadClassFile {</span>
<span class="udiff-line-removed">-         poolIdx = new int[nextChar()];</span>
<span class="udiff-line-removed">-         int i = 1;</span>
<span class="udiff-line-removed">-         while (i &lt; poolIdx.length) {</span>
<span class="udiff-line-removed">-             poolIdx[i++] = bp;</span>
<span class="udiff-line-removed">-             byte tag = buf[bp++];</span>
<span class="udiff-line-removed">-             switch (tag) {</span>
<span class="udiff-line-removed">-             case CONSTANT_Utf8: case CONSTANT_Unicode: {</span>
<span class="udiff-line-removed">-                 int len = nextChar();</span>
<span class="udiff-line-removed">-                 bp = bp + len;</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             case CONSTANT_Class:</span>
<span class="udiff-line-removed">-             case CONSTANT_String:</span>
<span class="udiff-line-removed">-             case CONSTANT_MethodType:</span>
<span class="udiff-line-removed">-             case CONSTANT_Module:</span>
<span class="udiff-line-removed">-             case CONSTANT_Package:</span>
<span class="udiff-line-removed">-                 bp = bp + 2;</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             case CONSTANT_MethodHandle:</span>
<span class="udiff-line-removed">-                 bp = bp + 3;</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             case CONSTANT_Fieldref:</span>
<span class="udiff-line-removed">-             case CONSTANT_Methodref:</span>
<span class="udiff-line-removed">-             case CONSTANT_InterfaceMethodref:</span>
<span class="udiff-line-removed">-             case CONSTANT_NameandType:</span>
<span class="udiff-line-removed">-             case CONSTANT_Integer:</span>
<span class="udiff-line-removed">-             case CONSTANT_Float:</span>
<span class="udiff-line-removed">-             case CONSTANT_InvokeDynamic:</span>
<span class="udiff-line-removed">-                 bp = bp + 4;</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             case CONSTANT_Long:</span>
<span class="udiff-line-removed">-             case CONSTANT_Double:</span>
<span class="udiff-line-removed">-                 bp = bp + 8;</span>
<span class="udiff-line-removed">-                 i++;</span>
<span class="udiff-line-removed">-                 break;</span>
<span class="udiff-line-removed">-             default:</span>
<span class="udiff-line-removed">-                 throw new BadClassFile(&quot;malformed constant pool&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     String getUtf8Value(int index, boolean internalize) throws BadClassFile {</span>
<span class="udiff-line-removed">-         int utf8Index = poolIdx[index];</span>
<span class="udiff-line-removed">-         if (buf[utf8Index] == CONSTANT_Utf8) {</span>
<span class="udiff-line-removed">-             int len = getChar(utf8Index + 1);</span>
<span class="udiff-line-removed">-             int start = utf8Index + 3;</span>
<span class="udiff-line-removed">-             if (internalize) {</span>
<span class="udiff-line-removed">-                 return new String(ClassFile.internalize(buf, start, len));</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 return new String(buf, start, len);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         throw new BadClassFile(&quot;bad name at index &quot; + index);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     String getModuleName(int index) throws BadClassFile {</span>
<span class="udiff-line-removed">-         int infoIndex = poolIdx[index];</span>
<span class="udiff-line-removed">-         if (buf[infoIndex] == CONSTANT_Module) {</span>
<span class="udiff-line-removed">-             return getUtf8Value(getChar(infoIndex + 1), true);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             throw new BadClassFile(&quot;bad module name at index &quot; + index);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         int res = buf.getInt(bp);</span>
<span class="udiff-line-modified-added">+         bp += 4;</span>
<span class="udiff-line-modified-added">+         return res;</span>
      }
  
<span class="udiff-line-modified-removed">-     private static byte[] readInputStream(byte[] buf, InputStream s) throws IOException {</span>
<span class="udiff-line-modified-removed">-         try {</span>
<span class="udiff-line-modified-removed">-             buf = ensureCapacity(buf, s.available());</span>
<span class="udiff-line-modified-removed">-             int r = s.read(buf);</span>
<span class="udiff-line-removed">-             int bp = 0;</span>
<span class="udiff-line-removed">-             while (r != -1) {</span>
<span class="udiff-line-removed">-                 bp += r;</span>
<span class="udiff-line-removed">-                 buf = ensureCapacity(buf, bp);</span>
<span class="udiff-line-removed">-                 r = s.read(buf, bp, buf.length - bp);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return buf;</span>
<span class="udiff-line-removed">-         } finally {</span>
<span class="udiff-line-removed">-             try {</span>
<span class="udiff-line-removed">-                 s.close();</span>
<span class="udiff-line-removed">-             } catch (IOException e) {</span>
<span class="udiff-line-removed">-                 /* Ignore any errors, as this stream may have already</span>
<span class="udiff-line-removed">-                  * thrown a related exception which is the one that</span>
<span class="udiff-line-removed">-                  * should be reported.</span>
<span class="udiff-line-removed">-                  */</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+     NameMapper&lt;String&gt; utf8Mapper(boolean internalize) {</span>
<span class="udiff-line-modified-added">+         return internalize ?</span>
<span class="udiff-line-modified-added">+                 (buf, offset, len) -&gt; new String(ClassFile.internalize(buf, offset, len)) :</span>
<span class="udiff-line-modified-added">+                 String::new;</span>
      }
  
<span class="udiff-line-removed">-     /*</span>
<span class="udiff-line-removed">-      * ensureCapacity will increase the buffer as needed, taking note that</span>
<span class="udiff-line-removed">-      * the new buffer will always be greater than the needed and never</span>
<span class="udiff-line-removed">-      * exactly equal to the needed size or bp. If equal then the read (above)</span>
<span class="udiff-line-removed">-      * will infinitely loop as buf.length - bp == 0.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     private static byte[] ensureCapacity(byte[] buf, int needed) {</span>
<span class="udiff-line-removed">-         if (buf.length &lt;= needed) {</span>
<span class="udiff-line-removed">-             byte[] old = buf;</span>
<span class="udiff-line-removed">-             buf = new byte[Integer.highestOneBit(needed) &lt;&lt; 1];</span>
<span class="udiff-line-removed">-             System.arraycopy(old, 0, buf, 0, old.length);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return buf;</span>
<span class="udiff-line-removed">-     }</span>
  }
</pre>
<center><a href="JNIWriter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Profile.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>