<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.compiler/share/classes/com/sun/tools/javac/code/Preview.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Lint.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Printer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/code/Preview.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.tools.javac.code;
 27 
 28 import com.sun.tools.javac.code.Lint.LintCategory;
 29 import com.sun.tools.javac.code.Source.Feature;
<span class="line-removed"> 30 import com.sun.tools.javac.comp.Infer;</span>
 31 import com.sun.tools.javac.jvm.Target;
 32 import com.sun.tools.javac.resources.CompilerProperties.Errors;
 33 import com.sun.tools.javac.resources.CompilerProperties.Warnings;
 34 import com.sun.tools.javac.util.Assert;
 35 import com.sun.tools.javac.util.Context;
 36 import com.sun.tools.javac.util.JCDiagnostic.DiagnosticPosition;
 37 import com.sun.tools.javac.util.JCDiagnostic.Error;
 38 import com.sun.tools.javac.util.JCDiagnostic.SimpleDiagnosticPosition;

 39 import com.sun.tools.javac.util.Log;
 40 import com.sun.tools.javac.util.MandatoryWarningHandler;
<span class="line-removed"> 41 import com.sun.tools.javac.util.Name;</span>
 42 import com.sun.tools.javac.util.Options;
 43 
 44 import javax.tools.JavaFileObject;
 45 import java.util.HashMap;
<span class="line-removed"> 46 import java.util.HashSet;</span>
 47 import java.util.Map;
<span class="line-removed"> 48 import java.util.Optional;</span>
<span class="line-removed"> 49 import java.util.Set;</span>
 50 
 51 import static com.sun.tools.javac.main.Option.PREVIEW;
 52 
 53 /**
 54  * Helper class to handle preview language features. This class maps certain language features
 55  * (see {@link Feature} into &#39;preview&#39; features; the mapping is completely ad-hoc, so as to allow
 56  * for maximum flexibility, which allows to migrate preview feature into supported features with ease.
 57  *
 58  * This class acts as a centralized point against which usages of preview features are reported by
 59  * clients (e.g. other javac classes). Internally, this class collects all such usages and generates
 60  * diagnostics to inform the user of such usages. Such diagnostics can be enabled using the
 61  * {@link LintCategory#PREVIEW} lint category, and are suppressible by usual means.
 62  */
 63 public class Preview {
 64 
<span class="line-modified"> 65     /** flag: are preview featutres enabled */</span>
 66     private final boolean enabled;
 67 
 68     /** the diag handler to manage preview feature usage diagnostics */
 69     private final MandatoryWarningHandler previewHandler;
 70 
 71     /** test flag: should all features be considered as preview features? */
 72     private final boolean forcePreview;
 73 
 74     /** a mapping from classfile numbers to Java SE versions */
 75     private final Map&lt;Integer, Source&gt; majorVersionToSource;
 76 
 77 
 78     private final Lint lint;
 79     private final Log log;
 80 
 81     private static final Context.Key&lt;Preview&gt; previewKey = new Context.Key&lt;&gt;();
 82 
 83     public static Preview instance(Context context) {
 84         Preview instance = context.get(previewKey);
 85         if (instance == null) {
</pre>
<hr />
<pre>
134         if (!lint.isSuppressed(LintCategory.PREVIEW)) {
135             previewHandler.report(pos, feature.isPlural() ?
136                     Warnings.PreviewFeatureUsePlural(feature.nameFragment()) :
137                     Warnings.PreviewFeatureUse(feature.nameFragment()));
138         }
139     }
140 
141     /**
142      * Report usage of a preview feature in classfile.
143      * @param classfile the name of the classfile with preview features enabled
144      * @param majorVersion the major version found in the classfile.
145      */
146     public void warnPreview(JavaFileObject classfile, int majorVersion) {
147         Assert.check(isEnabled());
148         if (!lint.isSuppressed(LintCategory.PREVIEW)) {
149             previewHandler.report(null,
150                     Warnings.PreviewFeatureUseClassfile(classfile, majorVersionToSource.get(majorVersion).name));
151         }
152     }
153 




154     /**
155      * Are preview features enabled?
156      * @return true, if preview features are enabled.
157      */
158     public boolean isEnabled() {
159         return enabled;
160     }
161 
162     /**
163      * Is given feature a preview feature?
164      * @param feature the feature to be tested.
165      * @return true, if given feature is a preview feature.
166      */
167     public boolean isPreview(Feature feature) {
<span class="line-modified">168         if (feature == Feature.SWITCH_EXPRESSION ||</span>
<span class="line-modified">169             feature == Feature.SWITCH_MULTIPLE_CASE_LABELS ||</span>
<span class="line-modified">170             feature == Feature.SWITCH_RULE)</span>

171             return true;
172         //Note: this is a backdoor which allows to optionally treat all features as &#39;preview&#39; (for testing).
173         //When real preview features will be added, this method can be implemented to return &#39;true&#39;
174         //for those selected features, and &#39;false&#39; for all the others.
175         return forcePreview;
176     }
177 
178     /**
179      * Generate an error key which captures the fact that a given preview feature could not be used
180      * due to the preview feature support being disabled.
181      * @param feature the feature for which the diagnostic has to be generated.
182      * @return the diagnostic.
183      */
184     public Error disabledError(Feature feature) {
185         Assert.check(!isEnabled());
186         return feature.isPlural() ?
187                 Errors.PreviewFeatureDisabledPlural(feature.nameFragment()) :
188                 Errors.PreviewFeatureDisabled(feature.nameFragment());
189     }
190 
191     /**
192      * Generate an error key which captures the fact that a preview classfile cannot be loaded
193      * due to the preview feature support being disabled.
194      * @param classfile the name of the classfile with preview features enabled
195      * @param majorVersion the major version found in the classfile.
196      */
197     public Error disabledError(JavaFileObject classfile, int majorVersion) {
198         Assert.check(!isEnabled());
199         return Errors.PreviewFeatureDisabledClassfile(classfile, majorVersionToSource.get(majorVersion).name);
200     }
201 
202     /**
203      * Report any deferred diagnostics.
204      */
205     public void reportDeferredDiagnostics() {
206         previewHandler.reportDeferredDiagnostic();
207     }





208 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package com.sun.tools.javac.code;
 27 
 28 import com.sun.tools.javac.code.Lint.LintCategory;
 29 import com.sun.tools.javac.code.Source.Feature;

 30 import com.sun.tools.javac.jvm.Target;
 31 import com.sun.tools.javac.resources.CompilerProperties.Errors;
 32 import com.sun.tools.javac.resources.CompilerProperties.Warnings;
 33 import com.sun.tools.javac.util.Assert;
 34 import com.sun.tools.javac.util.Context;
 35 import com.sun.tools.javac.util.JCDiagnostic.DiagnosticPosition;
 36 import com.sun.tools.javac.util.JCDiagnostic.Error;
 37 import com.sun.tools.javac.util.JCDiagnostic.SimpleDiagnosticPosition;
<span class="line-added"> 38 import com.sun.tools.javac.util.JCDiagnostic.Warning;</span>
 39 import com.sun.tools.javac.util.Log;
 40 import com.sun.tools.javac.util.MandatoryWarningHandler;

 41 import com.sun.tools.javac.util.Options;
 42 
 43 import javax.tools.JavaFileObject;
 44 import java.util.HashMap;

 45 import java.util.Map;


 46 
 47 import static com.sun.tools.javac.main.Option.PREVIEW;
 48 
 49 /**
 50  * Helper class to handle preview language features. This class maps certain language features
 51  * (see {@link Feature} into &#39;preview&#39; features; the mapping is completely ad-hoc, so as to allow
 52  * for maximum flexibility, which allows to migrate preview feature into supported features with ease.
 53  *
 54  * This class acts as a centralized point against which usages of preview features are reported by
 55  * clients (e.g. other javac classes). Internally, this class collects all such usages and generates
 56  * diagnostics to inform the user of such usages. Such diagnostics can be enabled using the
 57  * {@link LintCategory#PREVIEW} lint category, and are suppressible by usual means.
 58  */
 59 public class Preview {
 60 
<span class="line-modified"> 61     /** flag: are preview features enabled */</span>
 62     private final boolean enabled;
 63 
 64     /** the diag handler to manage preview feature usage diagnostics */
 65     private final MandatoryWarningHandler previewHandler;
 66 
 67     /** test flag: should all features be considered as preview features? */
 68     private final boolean forcePreview;
 69 
 70     /** a mapping from classfile numbers to Java SE versions */
 71     private final Map&lt;Integer, Source&gt; majorVersionToSource;
 72 
 73 
 74     private final Lint lint;
 75     private final Log log;
 76 
 77     private static final Context.Key&lt;Preview&gt; previewKey = new Context.Key&lt;&gt;();
 78 
 79     public static Preview instance(Context context) {
 80         Preview instance = context.get(previewKey);
 81         if (instance == null) {
</pre>
<hr />
<pre>
130         if (!lint.isSuppressed(LintCategory.PREVIEW)) {
131             previewHandler.report(pos, feature.isPlural() ?
132                     Warnings.PreviewFeatureUsePlural(feature.nameFragment()) :
133                     Warnings.PreviewFeatureUse(feature.nameFragment()));
134         }
135     }
136 
137     /**
138      * Report usage of a preview feature in classfile.
139      * @param classfile the name of the classfile with preview features enabled
140      * @param majorVersion the major version found in the classfile.
141      */
142     public void warnPreview(JavaFileObject classfile, int majorVersion) {
143         Assert.check(isEnabled());
144         if (!lint.isSuppressed(LintCategory.PREVIEW)) {
145             previewHandler.report(null,
146                     Warnings.PreviewFeatureUseClassfile(classfile, majorVersionToSource.get(majorVersion).name));
147         }
148     }
149 
<span class="line-added">150     public void reportPreviewWarning(DiagnosticPosition pos, Warning warnKey) {</span>
<span class="line-added">151         previewHandler.report(pos, warnKey);</span>
<span class="line-added">152     }</span>
<span class="line-added">153 </span>
154     /**
155      * Are preview features enabled?
156      * @return true, if preview features are enabled.
157      */
158     public boolean isEnabled() {
159         return enabled;
160     }
161 
162     /**
163      * Is given feature a preview feature?
164      * @param feature the feature to be tested.
165      * @return true, if given feature is a preview feature.
166      */
167     public boolean isPreview(Feature feature) {
<span class="line-modified">168         if (feature == Feature.PATTERN_MATCHING_IN_INSTANCEOF ||</span>
<span class="line-modified">169             feature == Feature.REIFIABLE_TYPES_INSTANCEOF ||</span>
<span class="line-modified">170             feature == Feature.TEXT_BLOCKS ||</span>
<span class="line-added">171             feature == Feature.RECORDS)</span>
172             return true;
173         //Note: this is a backdoor which allows to optionally treat all features as &#39;preview&#39; (for testing).
174         //When real preview features will be added, this method can be implemented to return &#39;true&#39;
175         //for those selected features, and &#39;false&#39; for all the others.
176         return forcePreview;
177     }
178 
179     /**
180      * Generate an error key which captures the fact that a given preview feature could not be used
181      * due to the preview feature support being disabled.
182      * @param feature the feature for which the diagnostic has to be generated.
183      * @return the diagnostic.
184      */
185     public Error disabledError(Feature feature) {
186         Assert.check(!isEnabled());
187         return feature.isPlural() ?
188                 Errors.PreviewFeatureDisabledPlural(feature.nameFragment()) :
189                 Errors.PreviewFeatureDisabled(feature.nameFragment());
190     }
191 
192     /**
193      * Generate an error key which captures the fact that a preview classfile cannot be loaded
194      * due to the preview feature support being disabled.
195      * @param classfile the name of the classfile with preview features enabled
196      * @param majorVersion the major version found in the classfile.
197      */
198     public Error disabledError(JavaFileObject classfile, int majorVersion) {
199         Assert.check(!isEnabled());
200         return Errors.PreviewFeatureDisabledClassfile(classfile, majorVersionToSource.get(majorVersion).name);
201     }
202 
203     /**
204      * Report any deferred diagnostics.
205      */
206     public void reportDeferredDiagnostics() {
207         previewHandler.reportDeferredDiagnostic();
208     }
<span class="line-added">209 </span>
<span class="line-added">210     public void clear() {</span>
<span class="line-added">211         previewHandler.clear();</span>
<span class="line-added">212     }</span>
<span class="line-added">213 </span>
214 }
</pre>
</td>
</tr>
</table>
<center><a href="Lint.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="Printer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>