<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.compiler/share/classes/com/sun/tools/javac/code/TypeAnnotations.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Type.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="TypeMetadata.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/code/TypeAnnotations.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2009, 2015, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2009, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -198,11 +198,11 @@</span>
      private AnnotationType targetToAnnotationType(Attribute a, Symbol s) {
          Attribute.Enum e = (Attribute.Enum)a;
          if (e.value.name == names.TYPE) {
              if (s.kind == TYP)
                  return AnnotationType.DECLARATION;
<span class="udiff-line-modified-removed">-         } else if (e.value.name == names.FIELD) {</span>
<span class="udiff-line-modified-added">+         } else if (e.value.name == names.FIELD || e.value.name == names.RECORD_COMPONENT) {</span>
              if (s.kind == VAR &amp;&amp;
                      s.owner.kind != MTH)
                  return AnnotationType.DECLARATION;
          } else if (e.value.name == names.METHOD) {
              if (s.kind == MTH &amp;&amp;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -388,26 +388,30 @@</span>
  
              if (sym.getKind() == ElementKind.PARAMETER ||
                  sym.getKind() == ElementKind.LOCAL_VARIABLE ||
                  sym.getKind() == ElementKind.RESOURCE_VARIABLE ||
                  sym.getKind() == ElementKind.EXCEPTION_PARAMETER) {
<span class="udiff-line-modified-removed">-                 // Make sure all type annotations from the symbol are also</span>
<span class="udiff-line-modified-removed">-                 // on the owner. If the owner is an initializer block, propagate</span>
<span class="udiff-line-modified-removed">-                 // to the type.</span>
<span class="udiff-line-modified-removed">-                 final long ownerFlags = sym.owner.flags();</span>
<span class="udiff-line-modified-removed">-                 if ((ownerFlags &amp; Flags.BLOCK) != 0) {</span>
<span class="udiff-line-modified-removed">-                     // Store init and clinit type annotations with the ClassSymbol</span>
<span class="udiff-line-modified-removed">-                     // to allow output in Gen.normalizeDefs.</span>
<span class="udiff-line-modified-removed">-                     ClassSymbol cs = (ClassSymbol) sym.owner.owner;</span>
<span class="udiff-line-modified-removed">-                     if ((ownerFlags &amp; Flags.STATIC) != 0) {</span>
<span class="udiff-line-modified-removed">-                         cs.appendClassInitTypeAttributes(typeAnnotations);</span>
<span class="udiff-line-modified-removed">-                     } else {</span>
<span class="udiff-line-modified-removed">-                         cs.appendInitTypeAttributes(typeAnnotations);</span>
<span class="udiff-line-modified-removed">-                     }</span>
<span class="udiff-line-modified-added">+                 appendTypeAnnotationsToOwner(sym, typeAnnotations);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         private void appendTypeAnnotationsToOwner(Symbol sym, List&lt;Attribute.TypeCompound&gt; typeAnnotations) {</span>
<span class="udiff-line-modified-added">+             // Make sure all type annotations from the symbol are also</span>
<span class="udiff-line-modified-added">+             // on the owner. If the owner is an initializer block, propagate</span>
<span class="udiff-line-modified-added">+             // to the type.</span>
<span class="udiff-line-modified-added">+             final long ownerFlags = sym.owner.flags();</span>
<span class="udiff-line-modified-added">+             if ((ownerFlags &amp; Flags.BLOCK) != 0) {</span>
<span class="udiff-line-modified-added">+                 // Store init and clinit type annotations with the ClassSymbol</span>
<span class="udiff-line-modified-added">+                 // to allow output in Gen.normalizeDefs.</span>
<span class="udiff-line-modified-added">+                 ClassSymbol cs = (ClassSymbol) sym.owner.owner;</span>
<span class="udiff-line-added">+                 if ((ownerFlags &amp; Flags.STATIC) != 0) {</span>
<span class="udiff-line-added">+                     cs.appendClassInitTypeAttributes(typeAnnotations);</span>
                  } else {
<span class="udiff-line-modified-removed">-                     sym.owner.appendUniqueTypeAttributes(sym.getRawTypeAttributes());</span>
<span class="udiff-line-modified-added">+                     cs.appendInitTypeAttributes(typeAnnotations);</span>
                  }
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 sym.owner.appendUniqueTypeAttributes(typeAnnotations);</span>
              }
          }
  
          // This method has a similar purpose as
          // {@link com.sun.tools.javac.parser.JavacParser.insertAnnotationsToMostInner(JCExpression, List&lt;JCTypeAnnotation&gt;, boolean)}
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -764,10 +768,11 @@</span>
  
                  case ANNOTATION_TYPE:
                  case CLASS:
                  case ENUM:
                  case INTERFACE:
<span class="udiff-line-added">+                 case RECORD:</span>
                      if (((JCClassDecl)frame).extending == tree) {
                          return TypeAnnotationPosition
                              .classExtends(location.toList(), currentLambda,
                                            frame.pos);
                      } else if (((JCClassDecl)frame).implementing.contains(tree)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -941,16 +946,18 @@</span>
                      } else {
                          throw new AssertionError(&quot;Could not determine position of tree &quot; + tree +
                                                   &quot; within frame &quot; + frame);
                      }
  
<span class="udiff-line-added">+                 case BINDING_PATTERN:</span>
                  case VARIABLE:
<span class="udiff-line-modified-removed">-                     VarSymbol v = ((JCVariableDecl)frame).sym;</span>
<span class="udiff-line-modified-added">+                     VarSymbol v = frame.hasTag(Tag.BINDINGPATTERN) ? ((JCBindingPattern) frame).symbol : ((JCVariableDecl) frame).sym;</span>
                      if (v.getKind() != ElementKind.FIELD) {
<span class="udiff-line-modified-removed">-                         v.owner.appendUniqueTypeAttributes(v.getRawTypeAttributes());</span>
<span class="udiff-line-modified-added">+                         appendTypeAnnotationsToOwner(v, v.getRawTypeAttributes());</span>
                      }
                      switch (v.getKind()) {
<span class="udiff-line-added">+                         case BINDING_VARIABLE:</span>
                          case LOCAL_VARIABLE:
                              return TypeAnnotationPosition
                                  .localVariable(location.toList(), currentLambda,
                                                 frame.pos);
                          case FIELD:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1120,10 +1127,13 @@</span>
                  scan(tree.typarams);
                  scan(tree.extending);
                  scan(tree.implementing);
              }
              scan(tree.defs);
<span class="udiff-line-added">+             if (tree.sym.isRecord()) {</span>
<span class="udiff-line-added">+                 tree.sym.getRecordComponents().stream().forEach(rc -&gt; scan(rc.accessorMeth));</span>
<span class="udiff-line-added">+             }</span>
          }
  
          /**
           * Resolve declaration vs. type annotations in methods and
           * then determine the positions.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1264,11 +1274,11 @@</span>
                  separateAnnotationsKinds(tree.vartype, tree.sym.type, tree.sym, pos);
              } else if (tree.sym.getKind() == ElementKind.ENUM_CONSTANT) {
                  // No type annotations can occur here.
              } else {
                  // There is nothing else in a variable declaration that needs separation.
<span class="udiff-line-modified-removed">-                 Assert.error(&quot;Unhandled variable kind&quot;);</span>
<span class="udiff-line-modified-added">+                 Assert.error(&quot;Unhandled variable kind: &quot; + tree.sym.getKind());</span>
              }
  
              scan(tree.mods);
              scan(tree.vartype);
              if (!sigOnly) {
</pre>
<center><a href="Type.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="TypeMetadata.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>