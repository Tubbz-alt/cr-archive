<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/Items.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="Gen.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JNIWriter.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.compiler/share/classes/com/sun/tools/javac/jvm/Items.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 1999, 2013, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,10 +27,12 @@</span>
  
  import com.sun.tools.javac.code.*;
  import com.sun.tools.javac.code.Symbol.*;
  import com.sun.tools.javac.code.Type.*;
  import com.sun.tools.javac.jvm.Code.*;
<span class="udiff-line-added">+ import com.sun.tools.javac.jvm.PoolConstant.LoadableConstant;</span>
<span class="udiff-line-added">+ import com.sun.tools.javac.jvm.PoolConstant.LoadableConstant.BasicConstant;</span>
  import com.sun.tools.javac.tree.JCTree;
  import com.sun.tools.javac.util.Assert;
  
  import static com.sun.tools.javac.jvm.ByteCodes.*;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,13 +50,13 @@</span>
   *  This code and its internal interfaces are subject to change or
   *  deletion without notice.&lt;/b&gt;
   */
  public class Items {
  
<span class="udiff-line-modified-removed">-     /** The current constant pool.</span>
<span class="udiff-line-modified-added">+     /** The current constant pool writer.</span>
       */
<span class="udiff-line-modified-removed">-     Pool pool;</span>
<span class="udiff-line-modified-added">+     PoolWriter poolWriter;</span>
  
      /** The current code buffer.
       */
      Code code;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -70,13 +72,13 @@</span>
      private final Item voidItem;
      private final Item thisItem;
      private final Item superItem;
      private final Item[] stackItem = new Item[TypeCodeCount];
  
<span class="udiff-line-modified-removed">-     public Items(Pool pool, Code code, Symtab syms, Types types) {</span>
<span class="udiff-line-modified-added">+     public Items(PoolWriter poolWriter, Code code, Symtab syms, Types types) {</span>
          this.code = code;
<span class="udiff-line-modified-removed">-         this.pool = pool;</span>
<span class="udiff-line-modified-added">+         this.poolWriter = poolWriter;</span>
          this.types = types;
          voidItem = new Item(VOIDcode) {
                  public String toString() { return &quot;void&quot;; }
              };
          thisItem = new SelfItem(false);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,13 +172,13 @@</span>
          return new AssignItem(lhs);
      }
  
      /** Make an item representing a conditional or unconditional jump.
       *  @param opcode      The jump&#39;s opcode.
<span class="udiff-line-modified-removed">-      *  @param trueJumps   A chain encomassing all jumps that can be taken</span>
<span class="udiff-line-modified-added">+      *  @param trueJumps   A chain encompassing all jumps that can be taken</span>
       *                     if the condition evaluates to true.
<span class="udiff-line-modified-removed">-      *  @param falseJumps  A chain encomassing all jumps that can be taken</span>
<span class="udiff-line-modified-added">+      *  @param falseJumps  A chain encompassing all jumps that can be taken</span>
       *                     if the condition evaluates to false.
       */
      CondItem makeCondItem(int opcode, Chain trueJumps, Chain falseJumps) {
          return new CondItem(opcode, trueJumps, falseJumps);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -442,22 +444,22 @@</span>
              super(Code.typecode(member.erasure(types)));
              this.member = member;
          }
  
          Item load() {
<span class="udiff-line-modified-removed">-             code.emitop2(getstatic, pool.put(member));</span>
<span class="udiff-line-modified-added">+             code.emitop2(getstatic, member, PoolWriter::putMember);</span>
              return stackItem[typecode];
          }
  
          void store() {
<span class="udiff-line-modified-removed">-             code.emitop2(putstatic, pool.put(member));</span>
<span class="udiff-line-modified-added">+             code.emitop2(putstatic, member, PoolWriter::putMember);</span>
          }
  
          Item invoke() {
              MethodType mtype = (MethodType)member.erasure(types);
              int rescode = Code.typecode(mtype.restype);
<span class="udiff-line-modified-removed">-             code.emitInvokestatic(pool.put(member), mtype);</span>
<span class="udiff-line-modified-added">+             code.emitInvokestatic(member, mtype);</span>
              return stackItem[rescode];
          }
  
          public String toString() {
              return &quot;static(&quot; + member + &quot;)&quot;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -470,23 +472,24 @@</span>
          DynamicItem(Symbol member) {
              super(member);
          }
  
          Item load() {
<span class="udiff-line-modified-removed">-             assert false;</span>
<span class="udiff-line-modified-removed">-             return null;</span>
<span class="udiff-line-modified-added">+             Assert.check(member.kind == Kinds.Kind.VAR);</span>
<span class="udiff-line-modified-added">+             Type type = member.erasure(types);</span>
<span class="udiff-line-added">+             int rescode = Code.typecode(type);</span>
<span class="udiff-line-added">+             code.emitLdc((DynamicVarSymbol)member);</span>
<span class="udiff-line-added">+             return stackItem[rescode];</span>
          }
  
<span class="udiff-line-modified-removed">-         void store() {</span>
<span class="udiff-line-removed">-             assert false;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         void store() { Assert.error(&quot;this method shouldn&#39;t be invoked&quot;); }</span>
  
          Item invoke() {
<span class="udiff-line-modified-removed">-             // assert target.hasNativeInvokeDynamic();</span>
<span class="udiff-line-modified-added">+             Assert.check(member.kind == Kinds.Kind.MTH);</span>
              MethodType mtype = (MethodType)member.erasure(types);
              int rescode = Code.typecode(mtype.restype);
<span class="udiff-line-modified-removed">-             code.emitInvokedynamic(pool.put(member), mtype);</span>
<span class="udiff-line-modified-added">+             code.emitInvokedynamic((DynamicMethodSymbol)member, mtype);</span>
              return stackItem[rescode];
          }
  
          public String toString() {
              return &quot;dynamic(&quot; + member + &quot;)&quot;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -510,27 +513,27 @@</span>
              this.member = member;
              this.nonvirtual = nonvirtual;
          }
  
          Item load() {
<span class="udiff-line-modified-removed">-             code.emitop2(getfield, pool.put(member));</span>
<span class="udiff-line-modified-added">+             code.emitop2(getfield, member, PoolWriter::putMember);</span>
              return stackItem[typecode];
          }
  
          void store() {
<span class="udiff-line-modified-removed">-             code.emitop2(putfield, pool.put(member));</span>
<span class="udiff-line-modified-added">+             code.emitop2(putfield, member, PoolWriter::putMember);</span>
          }
  
          Item invoke() {
              MethodType mtype = (MethodType)member.externalType(types);
              int rescode = Code.typecode(mtype.restype);
              if ((member.owner.flags() &amp; Flags.INTERFACE) != 0 &amp;&amp; !nonvirtual) {
<span class="udiff-line-modified-removed">-                 code.emitInvokeinterface(pool.put(member), mtype);</span>
<span class="udiff-line-modified-added">+                 code.emitInvokeinterface(member, mtype);</span>
              } else if (nonvirtual) {
<span class="udiff-line-modified-removed">-                 code.emitInvokespecial(pool.put(member), mtype);</span>
<span class="udiff-line-modified-added">+                 code.emitInvokespecial(member, mtype);</span>
              } else {
<span class="udiff-line-modified-removed">-                 code.emitInvokevirtual(pool.put(member), mtype);</span>
<span class="udiff-line-modified-added">+                 code.emitInvokevirtual(member, mtype);</span>
              }
              return stackItem[rescode];
          }
  
          void duplicate() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -558,56 +561,80 @@</span>
       */
      class ImmediateItem extends Item {
  
          /** The literal&#39;s value.
           */
<span class="udiff-line-modified-removed">-         Object value;</span>
<span class="udiff-line-modified-added">+         final LoadableConstant value;</span>
  
          ImmediateItem(Type type, Object value) {
              super(Code.typecode(type));
<span class="udiff-line-modified-removed">-             this.value = value;</span>
<span class="udiff-line-modified-added">+             switch (typecode) {</span>
<span class="udiff-line-added">+                 case BYTEcode:</span>
<span class="udiff-line-added">+                 case SHORTcode:</span>
<span class="udiff-line-added">+                 case CHARcode:</span>
<span class="udiff-line-added">+                 case INTcode:</span>
<span class="udiff-line-added">+                     this.value = LoadableConstant.Int((int)value);</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 case LONGcode:</span>
<span class="udiff-line-added">+                     this.value = LoadableConstant.Long((long)value);</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 case FLOATcode:</span>
<span class="udiff-line-added">+                     this.value = LoadableConstant.Float((float)value);</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 case DOUBLEcode:</span>
<span class="udiff-line-added">+                     this.value = LoadableConstant.Double((double)value);</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 case OBJECTcode:</span>
<span class="udiff-line-added">+                     this.value = LoadableConstant.String((String)value);</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 default:</span>
<span class="udiff-line-added">+                     throw new UnsupportedOperationException(&quot;unsupported tag: &quot; + typecode);</span>
<span class="udiff-line-added">+             }</span>
          }
  
          private void ldc() {
<span class="udiff-line-removed">-             int idx = pool.put(value);</span>
              if (typecode == LONGcode || typecode == DOUBLEcode) {
<span class="udiff-line-modified-removed">-                 code.emitop2(ldc2w, idx);</span>
<span class="udiff-line-modified-added">+                 code.emitop2(ldc2w, value, PoolWriter::putConstant);</span>
              } else {
<span class="udiff-line-modified-removed">-                 code.emitLdc(idx);</span>
<span class="udiff-line-modified-added">+                 code.emitLdc(value);</span>
              }
          }
  
<span class="udiff-line-added">+         private Number numericValue() {</span>
<span class="udiff-line-added">+             return (Number)((BasicConstant)value).data;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          Item load() {
              switch (typecode) {
              case INTcode: case BYTEcode: case SHORTcode: case CHARcode:
<span class="udiff-line-modified-removed">-                 int ival = ((Number)value).intValue();</span>
<span class="udiff-line-modified-added">+                 int ival = numericValue().intValue();</span>
                  if (-1 &lt;= ival &amp;&amp; ival &lt;= 5)
                      code.emitop0(iconst_0 + ival);
                  else if (Byte.MIN_VALUE &lt;= ival &amp;&amp; ival &lt;= Byte.MAX_VALUE)
                      code.emitop1(bipush, ival);
                  else if (Short.MIN_VALUE &lt;= ival &amp;&amp; ival &lt;= Short.MAX_VALUE)
                      code.emitop2(sipush, ival);
                  else
                      ldc();
                  break;
              case LONGcode:
<span class="udiff-line-modified-removed">-                 long lval = ((Number)value).longValue();</span>
<span class="udiff-line-modified-added">+                 long lval = numericValue().longValue();</span>
                  if (lval == 0 || lval == 1)
                      code.emitop0(lconst_0 + (int)lval);
                  else
                      ldc();
                  break;
              case FLOATcode:
<span class="udiff-line-modified-removed">-                 float fval = ((Number)value).floatValue();</span>
<span class="udiff-line-modified-added">+                 float fval = numericValue().floatValue();</span>
                  if (isPosZero(fval) || fval == 1.0 || fval == 2.0)
                      code.emitop0(fconst_0 + (int)fval);
                  else {
                      ldc();
                  }
                  break;
              case DOUBLEcode:
<span class="udiff-line-modified-removed">-                 double dval = ((Number)value).doubleValue();</span>
<span class="udiff-line-modified-added">+                 double dval = numericValue().doubleValue();</span>
                  if (isPosZero(dval) || dval == 1.0)
                      code.emitop0(dconst_0 + (int)dval);
                  else
                      ldc();
                  break;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -630,11 +657,11 @@</span>
              private boolean isPosZero(double x) {
                  return x == 0.0d &amp;&amp; 1.0d / x &gt; 0.0d;
              }
  
          CondItem mkCond() {
<span class="udiff-line-modified-removed">-             int ival = ((Number)value).intValue();</span>
<span class="udiff-line-modified-added">+             int ival = numericValue().intValue();</span>
              return makeCondItem(ival != 0 ? goto_ : dontgoto);
          }
  
          Item coerce(int targetcode) {
              if (typecode == targetcode) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -645,35 +672,35 @@</span>
                      if (Code.truncate(typecode) == INTcode)
                          return this;
                      else
                          return new ImmediateItem(
                              syms.intType,
<span class="udiff-line-modified-removed">-                             ((Number)value).intValue());</span>
<span class="udiff-line-modified-added">+                             numericValue().intValue());</span>
                  case LONGcode:
                      return new ImmediateItem(
                          syms.longType,
<span class="udiff-line-modified-removed">-                         ((Number)value).longValue());</span>
<span class="udiff-line-modified-added">+                             numericValue().longValue());</span>
                  case FLOATcode:
                      return new ImmediateItem(
                          syms.floatType,
<span class="udiff-line-modified-removed">-                         ((Number)value).floatValue());</span>
<span class="udiff-line-modified-added">+                         numericValue().floatValue());</span>
                  case DOUBLEcode:
                      return new ImmediateItem(
                          syms.doubleType,
<span class="udiff-line-modified-removed">-                         ((Number)value).doubleValue());</span>
<span class="udiff-line-modified-added">+                         numericValue().doubleValue());</span>
                  case BYTEcode:
                      return new ImmediateItem(
                          syms.byteType,
<span class="udiff-line-modified-removed">-                         (int)(byte)((Number)value).intValue());</span>
<span class="udiff-line-modified-added">+                         (int)(byte)numericValue().intValue());</span>
                  case CHARcode:
                      return new ImmediateItem(
                          syms.charType,
<span class="udiff-line-modified-removed">-                         (int)(char)((Number)value).intValue());</span>
<span class="udiff-line-modified-added">+                         (int)(char)numericValue().intValue());</span>
                  case SHORTcode:
                      return new ImmediateItem(
                          syms.shortType,
<span class="udiff-line-modified-removed">-                         (int)(short)((Number)value).intValue());</span>
<span class="udiff-line-modified-added">+                         (int)(short)numericValue().intValue());</span>
                  default:
                      return super.coerce(targetcode);
                  }
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -725,16 +752,16 @@</span>
  
      /** An item representing a conditional or unconditional jump.
       */
      class CondItem extends Item {
  
<span class="udiff-line-modified-removed">-         /** A chain encomassing all jumps that can be taken</span>
<span class="udiff-line-modified-added">+         /** A chain encompassing all jumps that can be taken</span>
           *  if the condition evaluates to true.
           */
          Chain trueJumps;
  
<span class="udiff-line-modified-removed">-         /** A chain encomassing all jumps that can be taken</span>
<span class="udiff-line-modified-added">+         /** A chain encompassing all jumps that can be taken</span>
           *  if the condition evaluates to false.
           */
          Chain falseJumps;
  
          /** The jump&#39;s opcode.
</pre>
<center><a href="Gen.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JNIWriter.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>