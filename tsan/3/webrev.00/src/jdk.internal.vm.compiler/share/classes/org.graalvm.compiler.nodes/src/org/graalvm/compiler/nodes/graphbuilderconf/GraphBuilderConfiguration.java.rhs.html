<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.nodes/src/org/graalvm/compiler/nodes/graphbuilderconf/GraphBuilderConfiguration.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.nodes.graphbuilderconf;
 26 
 27 import java.util.Arrays;
 28 import java.util.Collections;
 29 import java.util.List;
 30 
 31 import org.graalvm.compiler.core.common.type.StampPair;
 32 
 33 import jdk.vm.ci.meta.JavaType;
 34 import jdk.vm.ci.meta.ResolvedJavaType;
 35 
 36 public final class GraphBuilderConfiguration {
 37 
 38     public static class Plugins {
 39         private final InvocationPlugins invocationPlugins;
 40         private NodePlugin[] nodePlugins;
 41         private ParameterPlugin[] parameterPlugins;
 42         private TypePlugin[] typePlugins;
 43         private InlineInvokePlugin[] inlineInvokePlugins;
 44         private ClassInitializationPlugin classInitializationPlugin;
 45         private InvokeDynamicPlugin invokeDynamicPlugin;
 46         private ProfilingPlugin profilingPlugin;
 47 
 48         /**
 49          * Creates a copy of a given set of plugins. The {@link InvocationPlugins} in
 50          * {@code copyFrom} become the {@linkplain InvocationPlugins#getParent() default}
 51          * {@linkplain #getInvocationPlugins() invocation plugins} in this object.
 52          */
 53         public Plugins(Plugins copyFrom, InvocationPlugins invocationPlugins) {
 54             this.invocationPlugins = invocationPlugins != null ? invocationPlugins : new InvocationPlugins(copyFrom.invocationPlugins);
 55             this.nodePlugins = copyFrom.nodePlugins;
 56             this.parameterPlugins = copyFrom.parameterPlugins;
 57             this.typePlugins = copyFrom.typePlugins;
 58             this.inlineInvokePlugins = copyFrom.inlineInvokePlugins;
 59             this.classInitializationPlugin = copyFrom.classInitializationPlugin;
 60             this.invokeDynamicPlugin = copyFrom.invokeDynamicPlugin;
 61             this.profilingPlugin = copyFrom.profilingPlugin;
 62         }
 63 
 64         public Plugins(Plugins copyFrom) {
 65             this(copyFrom, null);
 66         }
 67 
 68         /**
 69          * Creates a new set of plugins.
 70          *
 71          * @param invocationPlugins the {@linkplain #getInvocationPlugins() invocation plugins} in
 72          *            this object
 73          */
 74         public Plugins(InvocationPlugins invocationPlugins) {
 75             this.invocationPlugins = invocationPlugins;
 76             this.nodePlugins = new NodePlugin[0];
 77             this.parameterPlugins = new ParameterPlugin[0];
 78             this.typePlugins = new TypePlugin[0];
 79             this.inlineInvokePlugins = new InlineInvokePlugin[0];
 80         }
 81 
 82         public InvocationPlugins getInvocationPlugins() {
 83             return invocationPlugins;
 84         }
 85 
 86         public NodePlugin[] getNodePlugins() {
 87             return nodePlugins;
 88         }
 89 
 90         public void appendNodePlugin(NodePlugin plugin) {
 91             nodePlugins = Arrays.copyOf(nodePlugins, nodePlugins.length + 1);
 92             nodePlugins[nodePlugins.length - 1] = plugin;
 93         }
 94 
 95         public void prependNodePlugin(NodePlugin plugin) {
 96             NodePlugin[] newPlugins = new NodePlugin[nodePlugins.length + 1];
 97             System.arraycopy(nodePlugins, 0, newPlugins, 1, nodePlugins.length);
 98             newPlugins[0] = plugin;
 99             nodePlugins = newPlugins;
100         }
101 
102         public void clearNodePlugin() {
103             nodePlugins = new NodePlugin[0];
104         }
105 
106         public ParameterPlugin[] getParameterPlugins() {
107             return parameterPlugins;
108         }
109 
110         public void appendParameterPlugin(ParameterPlugin plugin) {
111             parameterPlugins = Arrays.copyOf(parameterPlugins, parameterPlugins.length + 1);
112             parameterPlugins[parameterPlugins.length - 1] = plugin;
113         }
114 
115         public void prependParameterPlugin(ParameterPlugin plugin) {
116             ParameterPlugin[] newPlugins = new ParameterPlugin[parameterPlugins.length + 1];
117             System.arraycopy(parameterPlugins, 0, newPlugins, 1, parameterPlugins.length);
118             newPlugins[0] = plugin;
119             parameterPlugins = newPlugins;
120         }
121 
122         public TypePlugin[] getTypePlugins() {
123             return typePlugins;
124         }
125 
126         public void appendTypePlugin(TypePlugin plugin) {
127             typePlugins = Arrays.copyOf(typePlugins, typePlugins.length + 1);
128             typePlugins[typePlugins.length - 1] = plugin;
129         }
130 
131         public void prependTypePlugin(TypePlugin plugin) {
132             TypePlugin[] newPlugins = new TypePlugin[typePlugins.length + 1];
133             System.arraycopy(typePlugins, 0, newPlugins, 1, typePlugins.length);
134             newPlugins[0] = plugin;
135             typePlugins = newPlugins;
136         }
137 
138         public void clearParameterPlugin() {
139             parameterPlugins = new ParameterPlugin[0];
140         }
141 
142         public InlineInvokePlugin[] getInlineInvokePlugins() {
143             return inlineInvokePlugins;
144         }
145 
146         public void appendInlineInvokePlugin(InlineInvokePlugin plugin) {
147             inlineInvokePlugins = Arrays.copyOf(inlineInvokePlugins, inlineInvokePlugins.length + 1);
148             inlineInvokePlugins[inlineInvokePlugins.length - 1] = plugin;
149         }
150 
151         public void prependInlineInvokePlugin(InlineInvokePlugin plugin) {
152             InlineInvokePlugin[] newPlugins = new InlineInvokePlugin[inlineInvokePlugins.length + 1];
153             System.arraycopy(inlineInvokePlugins, 0, newPlugins, 1, inlineInvokePlugins.length);
154             newPlugins[0] = plugin;
155             inlineInvokePlugins = newPlugins;
156         }
157 
158         public void clearInlineInvokePlugins() {
159             inlineInvokePlugins = new InlineInvokePlugin[0];
160         }
161 
162         public ClassInitializationPlugin getClassInitializationPlugin() {
163             return classInitializationPlugin;
164         }
165 
166         public void setClassInitializationPlugin(ClassInitializationPlugin plugin) {
167             this.classInitializationPlugin = plugin;
168         }
169 
170         public InvokeDynamicPlugin getInvokeDynamicPlugin() {
171             return invokeDynamicPlugin;
172         }
173 
174         public void setInvokeDynamicPlugin(InvokeDynamicPlugin plugin) {
175             this.invokeDynamicPlugin = plugin;
176         }
177 
178         public ProfilingPlugin getProfilingPlugin() {
179             return profilingPlugin;
180         }
181 
182         public void setProfilingPlugin(ProfilingPlugin plugin) {
183             this.profilingPlugin = plugin;
184         }
185 
186         public StampPair getOverridingStamp(GraphBuilderTool b, JavaType type, boolean nonNull) {
187             for (TypePlugin plugin : getTypePlugins()) {
188                 StampPair stamp = plugin.interceptType(b, type, nonNull);
189                 if (stamp != null) {
190                     return stamp;
191                 }
192             }
193             return null;
194         }
195     }
196 
197     private final boolean eagerResolving;
198     private final boolean unresolvedIsError;
199     private final BytecodeExceptionMode bytecodeExceptionMode;
200     private final boolean omitAssertions;
201     private final List&lt;ResolvedJavaType&gt; skippedExceptionTypes;
202     private final boolean insertFullInfopoints;
203     private final boolean trackNodeSourcePosition;
<a name="2" id="anc2"></a><span class="line-added">204     private final boolean retainLocalVariables;</span>
205     private final Plugins plugins;
<a name="3" id="anc3"></a><span class="line-added">206     private final boolean replaceLocalsWithConstants;</span>
207 
208     public enum BytecodeExceptionMode {
209         /**
210          * This mode always explicitly checks for exceptions.
211          */
212         CheckAll,
213         /**
214          * This mode omits all explicit exception edges.
215          */
216         OmitAll,
217         /**
218          * This mode omits exception edges at invokes, but not for implicit null checks or bounds
219          * checks.
220          */
221         ExplicitOnly,
222         /**
223          * This mode uses profiling information to decide whether to use explicit exception edges.
224          */
225         Profile
226     }
227 
228     private GraphBuilderConfiguration(boolean eagerResolving,
229                     boolean unresolvedIsError,
230                     BytecodeExceptionMode bytecodeExceptionMode,
231                     boolean omitAssertions,
232                     boolean insertFullInfopoints,
233                     boolean trackNodeSourcePosition,
<a name="4" id="anc4"></a><span class="line-added">234                     boolean retainLocalVariables,</span>
<span class="line-added">235                     boolean replaceLocalsWithConstants,</span>
236                     List&lt;ResolvedJavaType&gt; skippedExceptionTypes,
237                     Plugins plugins) {
238         this.eagerResolving = eagerResolving;
239         this.unresolvedIsError = unresolvedIsError;
240         this.bytecodeExceptionMode = bytecodeExceptionMode;
241         this.omitAssertions = omitAssertions;
242         this.insertFullInfopoints = insertFullInfopoints;
243         this.trackNodeSourcePosition = trackNodeSourcePosition;
<a name="5" id="anc5"></a><span class="line-added">244         this.retainLocalVariables = retainLocalVariables;</span>
<span class="line-added">245         this.replaceLocalsWithConstants = replaceLocalsWithConstants;</span>
246         this.skippedExceptionTypes = skippedExceptionTypes;
247         this.plugins = plugins;
248     }
249 
250     /**
251      * Creates a copy of this configuration with all its plugins. The {@link InvocationPlugins} in
252      * this configuration become the {@linkplain InvocationPlugins#getParent() parent} of the
253      * {@link InvocationPlugins} in the copy.
254      */
255     public GraphBuilderConfiguration copy() {
256         Plugins newPlugins = new Plugins(plugins);
257         GraphBuilderConfiguration result = new GraphBuilderConfiguration(
258                         eagerResolving,
259                         unresolvedIsError,
260                         bytecodeExceptionMode,
261                         omitAssertions,
262                         insertFullInfopoints,
263                         trackNodeSourcePosition,
<a name="6" id="anc6"></a><span class="line-added">264                         retainLocalVariables,</span>
<span class="line-added">265                         replaceLocalsWithConstants,</span>
266                         skippedExceptionTypes,
267                         newPlugins);
268         return result;
269     }
270 
271     /**
272      * Set the {@link #unresolvedIsError} flag. This flag can be set independently from
273      * {@link #eagerResolving}, i.e., even if eager resolving fails execution is assumed to be
274      * valid. This allows us for example to process unresolved types/methods/fields even when
275      * eagerly resolving elements.
276      */
277     public GraphBuilderConfiguration withUnresolvedIsError(boolean newUnresolvedIsError) {
278         return new GraphBuilderConfiguration(
279                         eagerResolving,
280                         newUnresolvedIsError,
281                         bytecodeExceptionMode,
282                         omitAssertions,
283                         insertFullInfopoints,
284                         trackNodeSourcePosition,
<a name="7" id="anc7"></a><span class="line-added">285                         retainLocalVariables,</span>
<span class="line-added">286                         replaceLocalsWithConstants,</span>
287                         skippedExceptionTypes,
288                         plugins);
289     }
290 
291     public GraphBuilderConfiguration withEagerResolving(boolean newEagerResolving) {
292         return new GraphBuilderConfiguration(
293                         newEagerResolving,
294                         unresolvedIsError,
295                         bytecodeExceptionMode,
296                         omitAssertions,
297                         insertFullInfopoints,
298                         trackNodeSourcePosition,
<a name="8" id="anc8"></a><span class="line-added">299                         retainLocalVariables,</span>
<span class="line-added">300                         replaceLocalsWithConstants,</span>
301                         skippedExceptionTypes,
302                         plugins);
303     }
304 
305     public GraphBuilderConfiguration withSkippedExceptionTypes(ResolvedJavaType[] newSkippedExceptionTypes) {
306         return new GraphBuilderConfiguration(
307                         eagerResolving,
308                         unresolvedIsError,
309                         bytecodeExceptionMode,
310                         omitAssertions,
311                         insertFullInfopoints,
312                         trackNodeSourcePosition,
<a name="9" id="anc9"></a><span class="line-added">313                         retainLocalVariables,</span>
<span class="line-added">314                         replaceLocalsWithConstants,</span>
315                         Collections.unmodifiableList(Arrays.asList(newSkippedExceptionTypes)),
316                         plugins);
317     }
318 
319     public GraphBuilderConfiguration withBytecodeExceptionMode(BytecodeExceptionMode newBytecodeExceptionMode) {
320         return new GraphBuilderConfiguration(eagerResolving,
321                         unresolvedIsError,
322                         newBytecodeExceptionMode,
323                         omitAssertions,
324                         insertFullInfopoints,
325                         trackNodeSourcePosition,
<a name="10" id="anc10"></a><span class="line-added">326                         retainLocalVariables,</span>
<span class="line-added">327                         replaceLocalsWithConstants,</span>
328                         skippedExceptionTypes,
329                         plugins);
330     }
331 
332     public GraphBuilderConfiguration withOmitAssertions(boolean newOmitAssertions) {
333         return new GraphBuilderConfiguration(
334                         eagerResolving,
335                         unresolvedIsError,
336                         bytecodeExceptionMode,
337                         newOmitAssertions,
338                         insertFullInfopoints,
339                         trackNodeSourcePosition,
<a name="11" id="anc11"></a><span class="line-added">340                         retainLocalVariables,</span>
<span class="line-added">341                         replaceLocalsWithConstants,</span>
342                         skippedExceptionTypes,
343                         plugins);
344     }
345 
346     public GraphBuilderConfiguration withFullInfopoints(boolean newInsertFullInfopoints) {
347         return new GraphBuilderConfiguration(
348                         eagerResolving,
349                         unresolvedIsError,
350                         bytecodeExceptionMode,
351                         omitAssertions,
352                         newInsertFullInfopoints,
353                         trackNodeSourcePosition,
<a name="12" id="anc12"></a><span class="line-added">354                         retainLocalVariables,</span>
<span class="line-added">355                         replaceLocalsWithConstants,</span>
356                         skippedExceptionTypes,
357                         plugins);
358     }
359 
360     public GraphBuilderConfiguration withNodeSourcePosition(boolean newTrackNodeSourcePosition) {
361         return new GraphBuilderConfiguration(
362                         eagerResolving,
363                         unresolvedIsError,
364                         bytecodeExceptionMode,
365                         omitAssertions,
366                         insertFullInfopoints,
367                         newTrackNodeSourcePosition,
<a name="13" id="anc13"></a><span class="line-added">368                         retainLocalVariables,</span>
<span class="line-added">369                         replaceLocalsWithConstants,</span>
<span class="line-added">370                         skippedExceptionTypes,</span>
<span class="line-added">371                         plugins);</span>
<span class="line-added">372     }</span>
<span class="line-added">373 </span>
<span class="line-added">374     public GraphBuilderConfiguration withRetainLocalVariables(boolean newRetainLocalVariables) {</span>
<span class="line-added">375         return new GraphBuilderConfiguration(</span>
<span class="line-added">376                         eagerResolving,</span>
<span class="line-added">377                         unresolvedIsError,</span>
<span class="line-added">378                         bytecodeExceptionMode,</span>
<span class="line-added">379                         omitAssertions,</span>
<span class="line-added">380                         insertFullInfopoints,</span>
<span class="line-added">381                         trackNodeSourcePosition,</span>
<span class="line-added">382                         newRetainLocalVariables,</span>
<span class="line-added">383                         replaceLocalsWithConstants,</span>
<span class="line-added">384                         skippedExceptionTypes,</span>
<span class="line-added">385                         plugins);</span>
<span class="line-added">386     }</span>
<span class="line-added">387 </span>
<span class="line-added">388     public GraphBuilderConfiguration withReplaceLocalsWithConstants(boolean newReplaceLocalsWithConstants) {</span>
<span class="line-added">389         return new GraphBuilderConfiguration(</span>
<span class="line-added">390                         eagerResolving,</span>
<span class="line-added">391                         unresolvedIsError,</span>
<span class="line-added">392                         bytecodeExceptionMode,</span>
<span class="line-added">393                         omitAssertions,</span>
<span class="line-added">394                         insertFullInfopoints,</span>
<span class="line-added">395                         trackNodeSourcePosition,</span>
<span class="line-added">396                         retainLocalVariables,</span>
<span class="line-added">397                         newReplaceLocalsWithConstants,</span>
398                         skippedExceptionTypes,
399                         plugins);
400     }
401 
402     public List&lt;ResolvedJavaType&gt; getSkippedExceptionTypes() {
403         return skippedExceptionTypes;
404     }
405 
406     public boolean eagerResolving() {
407         return eagerResolving;
408     }
409 
410     public BytecodeExceptionMode getBytecodeExceptionMode() {
411         return bytecodeExceptionMode;
412     }
413 
414     public boolean omitAssertions() {
415         return omitAssertions;
416     }
417 
418     public boolean trackNodeSourcePosition() {
419         return trackNodeSourcePosition;
420     }
421 
<a name="14" id="anc14"></a><span class="line-added">422     public boolean retainLocalVariables() {</span>
<span class="line-added">423         return retainLocalVariables;</span>
<span class="line-added">424     }</span>
<span class="line-added">425 </span>
426     public boolean insertFullInfopoints() {
427         return insertFullInfopoints;
428     }
429 
<a name="15" id="anc15"></a><span class="line-added">430     public boolean replaceLocalsWithConstants() {</span>
<span class="line-added">431         return this.replaceLocalsWithConstants;</span>
<span class="line-added">432     }</span>
<span class="line-added">433 </span>
434     public static GraphBuilderConfiguration getDefault(Plugins plugins) {
435         return new GraphBuilderConfiguration(
436                         /* eagerResolving: */ false,
437                         /* unresolvedIsError: */ false,
438                         BytecodeExceptionMode.Profile,
439                         /* omitAssertions: */ false,
440                         /* insertFullInfopoints: */ false,
441                         /* trackNodeSourcePosition: */ false,
<a name="16" id="anc16"></a><span class="line-added">442                         /* retainLocalVariables */ false,</span>
<span class="line-added">443                         /* replaceLocalsWithConstants */ false,</span>
444                         Collections.emptyList(),
445                         plugins);
446     }
447 
448     public static GraphBuilderConfiguration getSnippetDefault(Plugins plugins) {
449         return new GraphBuilderConfiguration(
450                         /* eagerResolving: */ true,
451                         /* unresolvedIsError: */ true,
452                         BytecodeExceptionMode.OmitAll,
453                         /* omitAssertions: */ false,
454                         /* insertFullInfopoints: */ false,
455                         /* trackNodeSourcePosition: */ false,
<a name="17" id="anc17"></a><span class="line-added">456                         /* retainLocalVariables */ false,</span>
<span class="line-added">457                         /* replaceLocalsWithConstants */ false,</span>
458                         Collections.emptyList(),
459                         plugins);
460     }
461 
462     /** Returns {@code true} if it is an error for a class/field/method resolution to fail. */
463     public boolean unresolvedIsError() {
464         return unresolvedIsError;
465     }
466 
467     public Plugins getPlugins() {
468         return plugins;
469     }
470 }
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>