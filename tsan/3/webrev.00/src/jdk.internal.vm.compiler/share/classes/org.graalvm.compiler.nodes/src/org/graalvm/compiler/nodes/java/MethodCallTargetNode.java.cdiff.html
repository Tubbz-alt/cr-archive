<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.nodes/src/org/graalvm/compiler/nodes/java/MethodCallTargetNode.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LoweredAtomicReadAndWriteNode.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="MonitorEnterNode.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.nodes/src/org/graalvm/compiler/nodes/java/MethodCallTargetNode.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 33,19 ***</span>
  import org.graalvm.compiler.graph.NodeClass;
  import org.graalvm.compiler.graph.spi.Simplifiable;
  import org.graalvm.compiler.graph.spi.SimplifierTool;
  import org.graalvm.compiler.nodeinfo.NodeInfo;
  import org.graalvm.compiler.nodeinfo.Verbosity;
  import org.graalvm.compiler.nodes.CallTargetNode;
  import org.graalvm.compiler.nodes.FixedGuardNode;
  import org.graalvm.compiler.nodes.Invoke;
  import org.graalvm.compiler.nodes.LogicNode;
  import org.graalvm.compiler.nodes.NodeView;
  import org.graalvm.compiler.nodes.PiNode;
  import org.graalvm.compiler.nodes.StructuredGraph;
  import org.graalvm.compiler.nodes.ValueNode;
<span class="line-modified">! import org.graalvm.compiler.nodes.extended.ValueAnchorNode;</span>
  import org.graalvm.compiler.nodes.spi.UncheckedInterfaceProvider;
  import org.graalvm.compiler.nodes.type.StampTool;
  
  import jdk.vm.ci.code.BytecodeFrame;
  import jdk.vm.ci.meta.Assumptions;
<span class="line-new-header">--- 33,20 ---</span>
  import org.graalvm.compiler.graph.NodeClass;
  import org.graalvm.compiler.graph.spi.Simplifiable;
  import org.graalvm.compiler.graph.spi.SimplifierTool;
  import org.graalvm.compiler.nodeinfo.NodeInfo;
  import org.graalvm.compiler.nodeinfo.Verbosity;
<span class="line-added">+ import org.graalvm.compiler.nodes.BeginNode;</span>
  import org.graalvm.compiler.nodes.CallTargetNode;
  import org.graalvm.compiler.nodes.FixedGuardNode;
  import org.graalvm.compiler.nodes.Invoke;
  import org.graalvm.compiler.nodes.LogicNode;
  import org.graalvm.compiler.nodes.NodeView;
  import org.graalvm.compiler.nodes.PiNode;
  import org.graalvm.compiler.nodes.StructuredGraph;
  import org.graalvm.compiler.nodes.ValueNode;
<span class="line-modified">! import org.graalvm.compiler.nodes.extended.AnchoringNode;</span>
  import org.graalvm.compiler.nodes.spi.UncheckedInterfaceProvider;
  import org.graalvm.compiler.nodes.type.StampTool;
  
  import jdk.vm.ci.code.BytecodeFrame;
  import jdk.vm.ci.meta.Assumptions;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 93,14 ***</span>
  
      public JavaKind returnKind() {
          return targetMethod().getSignature().getReturnKind();
      }
  
<span class="line-removed">-     public Invoke invoke() {</span>
<span class="line-removed">-         return (Invoke) this.usages().first();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      @Override
      public boolean verify() {
          assert getUsageCount() &lt;= 1 : &quot;call target may only be used by a single invoke&quot;;
          for (Node n : usages()) {
              assertTrue(n instanceof Invoke, &quot;call target can only be used from an invoke (%s)&quot;, n);
<span class="line-new-header">--- 94,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 234,15 ***</span>
                   * dynamic check. 2) we need to ensure that there is still only one implementor of
                   * this interface, i.e. that we are calling the right method. We could do this with
                   * an assumption but as we need an instanceof check anyway we can verify both
                   * properties by checking of the receiver is an instance of the single implementor.
                   */
<span class="line-modified">!                 ValueAnchorNode anchor = new ValueAnchorNode(null);</span>
<span class="line-removed">-                 if (anchor != null) {</span>
<span class="line-removed">-                     graph().add(anchor);</span>
<span class="line-removed">-                     graph().addBeforeFixed(invoke().asNode(), anchor);</span>
<span class="line-removed">-                 }</span>
                  LogicNode condition = graph().addOrUniqueWithInputs(InstanceOfNode.create(speculatedType, receiver, getProfile(), anchor));
                  FixedGuardNode guard = graph().add(new FixedGuardNode(condition, DeoptimizationReason.OptimizedTypeCheckViolated, DeoptimizationAction.InvalidateRecompile, false));
                  graph().addBeforeFixed(invoke().asNode(), guard);
                  ValueNode valueNode = graph().addOrUnique(new PiNode(receiver, StampFactory.objectNonNull(speculatedType), guard));
                  arguments().set(0, valueNode);
<span class="line-new-header">--- 231,11 ---</span>
                   * dynamic check. 2) we need to ensure that there is still only one implementor of
                   * this interface, i.e. that we are calling the right method. We could do this with
                   * an assumption but as we need an instanceof check anyway we can verify both
                   * properties by checking of the receiver is an instance of the single implementor.
                   */
<span class="line-modified">!                 AnchoringNode anchor = BeginNode.prevBegin(invoke().asNode());</span>
                  LogicNode condition = graph().addOrUniqueWithInputs(InstanceOfNode.create(speculatedType, receiver, getProfile(), anchor));
                  FixedGuardNode guard = graph().add(new FixedGuardNode(condition, DeoptimizationReason.OptimizedTypeCheckViolated, DeoptimizationAction.InvalidateRecompile, false));
                  graph().addBeforeFixed(invoke().asNode(), guard);
                  ValueNode valueNode = graph().addOrUnique(new PiNode(receiver, StampFactory.objectNonNull(speculatedType), guard));
                  arguments().set(0, valueNode);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 276,6 ***</span>
<span class="line-new-header">--- 269,10 ---</span>
                  return target;
              }
          }
          return null;
      }
<span class="line-added">+ </span>
<span class="line-added">+     public void setJavaTypeProfile(JavaTypeProfile profile) {</span>
<span class="line-added">+         this.profile = profile;</span>
<span class="line-added">+     }</span>
  }
</pre>
<center><a href="LoweredAtomicReadAndWriteNode.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="MonitorEnterNode.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>