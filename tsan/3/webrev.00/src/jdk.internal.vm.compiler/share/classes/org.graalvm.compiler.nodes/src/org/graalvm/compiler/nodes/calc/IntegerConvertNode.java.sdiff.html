<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.nodes/src/org/graalvm/compiler/nodes/calc/IntegerConvertNode.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FloatEqualsNode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="IntegerDivRemNode.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.nodes/src/org/graalvm/compiler/nodes/calc/IntegerConvertNode.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.nodes.calc;
 26 
<span class="line-modified"> 27 import java.io.Serializable;</span>
<span class="line-removed"> 28 import java.util.function.Function;</span>
 29 
 30 import org.graalvm.compiler.core.common.type.ArithmeticOpTable;
 31 import org.graalvm.compiler.core.common.type.ArithmeticOpTable.IntegerConvertOp;
 32 import org.graalvm.compiler.core.common.type.IntegerStamp;
 33 import org.graalvm.compiler.core.common.type.PrimitiveStamp;
 34 import org.graalvm.compiler.core.common.type.Stamp;
 35 import org.graalvm.compiler.graph.NodeClass;
 36 import org.graalvm.compiler.graph.spi.CanonicalizerTool;
 37 import org.graalvm.compiler.nodeinfo.NodeInfo;
 38 import org.graalvm.compiler.nodes.ArithmeticOperation;
 39 import org.graalvm.compiler.nodes.ConstantNode;
 40 import org.graalvm.compiler.nodes.NodeView;
 41 import org.graalvm.compiler.nodes.StructuredGraph;
 42 import org.graalvm.compiler.nodes.ValueNode;
 43 import org.graalvm.compiler.nodes.spi.ArithmeticLIRLowerable;
 44 import org.graalvm.compiler.nodes.spi.StampInverter;
 45 
 46 import jdk.vm.ci.meta.Constant;
 47 import jdk.vm.ci.meta.ConstantReflectionProvider;
 48 
 49 /**
 50  * An {@code IntegerConvert} converts an integer to an integer of different width.
 51  */
 52 @NodeInfo
 53 public abstract class IntegerConvertNode&lt;OP, REV&gt; extends UnaryNode implements ArithmeticOperation, ConvertNode, ArithmeticLIRLowerable, StampInverter {
 54     @SuppressWarnings(&quot;rawtypes&quot;) public static final NodeClass&lt;IntegerConvertNode&gt; TYPE = NodeClass.create(IntegerConvertNode.class);
 55 
<span class="line-removed"> 56     protected final SerializableIntegerConvertFunction&lt;OP&gt; getOp;</span>
<span class="line-removed"> 57     protected final SerializableIntegerConvertFunction&lt;REV&gt; getReverseOp;</span>
<span class="line-removed"> 58 </span>
 59     protected final int inputBits;
 60     protected final int resultBits;
 61 
<span class="line-modified"> 62     protected interface SerializableIntegerConvertFunction&lt;T&gt; extends Function&lt;ArithmeticOpTable, IntegerConvertOp&lt;T&gt;&gt;, Serializable {</span>
<span class="line-modified"> 63     }</span>
<span class="line-removed"> 64 </span>
<span class="line-removed"> 65     protected IntegerConvertNode(NodeClass&lt;? extends IntegerConvertNode&lt;OP, REV&gt;&gt; c, SerializableIntegerConvertFunction&lt;OP&gt; getOp, SerializableIntegerConvertFunction&lt;REV&gt; getReverseOp, int inputBits,</span>
<span class="line-removed"> 66                     int resultBits, ValueNode input) {</span>
<span class="line-removed"> 67         super(c, getOp.apply(ArithmeticOpTable.forStamp(input.stamp(NodeView.DEFAULT))).foldStamp(inputBits, resultBits, input.stamp(NodeView.DEFAULT)), input);</span>
<span class="line-removed"> 68         this.getOp = getOp;</span>
<span class="line-removed"> 69         this.getReverseOp = getReverseOp;</span>
 70         this.inputBits = inputBits;
 71         this.resultBits = resultBits;
<span class="line-modified"> 72         assert ((PrimitiveStamp) input.stamp(NodeView.DEFAULT)).getBits() == inputBits;</span>
 73     }
 74 
 75     public int getInputBits() {
 76         return inputBits;
 77     }
 78 
 79     public int getResultBits() {
 80         return resultBits;
 81     }
 82 
<span class="line-modified"> 83     protected final IntegerConvertOp&lt;OP&gt; getOp(ValueNode forValue) {</span>
<span class="line-modified"> 84         return getOp.apply(ArithmeticOpTable.forStamp(forValue.stamp(NodeView.DEFAULT)));</span>
<span class="line-modified"> 85     }</span>
 86 
 87     @Override
 88     public final IntegerConvertOp&lt;OP&gt; getArithmeticOp() {
<span class="line-modified"> 89         return getOp(getValue());</span>
 90     }
 91 
 92     @Override
 93     public Constant convert(Constant c, ConstantReflectionProvider constantReflection) {
 94         return getArithmeticOp().foldConstant(getInputBits(), getResultBits(), c);
 95     }
 96 
 97     @Override
 98     public Constant reverse(Constant c, ConstantReflectionProvider constantReflection) {
<span class="line-modified"> 99         IntegerConvertOp&lt;REV&gt; reverse = getReverseOp.apply(ArithmeticOpTable.forStamp(stamp(NodeView.DEFAULT)));</span>
100         return reverse.foldConstant(getResultBits(), getInputBits(), c);
101     }
102 
103     @Override
104     public Stamp foldStamp(Stamp newStamp) {
105         assert newStamp.isCompatible(getValue().stamp(NodeView.DEFAULT));
106         return getArithmeticOp().foldStamp(inputBits, resultBits, newStamp);
107     }
108 
109     @Override
110     public ValueNode canonical(CanonicalizerTool tool, ValueNode forValue) {
<span class="line-modified">111         ValueNode synonym = findSynonym(getOp(forValue), forValue, inputBits, resultBits, stamp(NodeView.DEFAULT));</span>
112         if (synonym != null) {
113             return synonym;
114         }
115         return this;
116     }
117 
118     protected static &lt;T&gt; ValueNode findSynonym(IntegerConvertOp&lt;T&gt; operation, ValueNode value, int inputBits, int resultBits, Stamp stamp) {
119         if (inputBits == resultBits) {
120             return value;
121         } else if (value.isConstant()) {
122             return ConstantNode.forPrimitive(stamp, operation.foldConstant(inputBits, resultBits, value.asConstant()));
123         }
124         return null;
125     }
126 
127     public static ValueNode convert(ValueNode input, Stamp stamp, NodeView view) {
128         return convert(input, stamp, false, view);
129     }
130 
131     public static ValueNode convert(ValueNode input, Stamp stamp, StructuredGraph graph, NodeView view) {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.nodes.calc;
 26 
<span class="line-modified"> 27 import static org.graalvm.compiler.nodes.calc.BinaryArithmeticNode.getArithmeticOpTable;</span>

 28 
 29 import org.graalvm.compiler.core.common.type.ArithmeticOpTable;
 30 import org.graalvm.compiler.core.common.type.ArithmeticOpTable.IntegerConvertOp;
 31 import org.graalvm.compiler.core.common.type.IntegerStamp;
 32 import org.graalvm.compiler.core.common.type.PrimitiveStamp;
 33 import org.graalvm.compiler.core.common.type.Stamp;
 34 import org.graalvm.compiler.graph.NodeClass;
 35 import org.graalvm.compiler.graph.spi.CanonicalizerTool;
 36 import org.graalvm.compiler.nodeinfo.NodeInfo;
 37 import org.graalvm.compiler.nodes.ArithmeticOperation;
 38 import org.graalvm.compiler.nodes.ConstantNode;
 39 import org.graalvm.compiler.nodes.NodeView;
 40 import org.graalvm.compiler.nodes.StructuredGraph;
 41 import org.graalvm.compiler.nodes.ValueNode;
 42 import org.graalvm.compiler.nodes.spi.ArithmeticLIRLowerable;
 43 import org.graalvm.compiler.nodes.spi.StampInverter;
 44 
 45 import jdk.vm.ci.meta.Constant;
 46 import jdk.vm.ci.meta.ConstantReflectionProvider;
 47 
 48 /**
 49  * An {@code IntegerConvert} converts an integer to an integer of different width.
 50  */
 51 @NodeInfo
 52 public abstract class IntegerConvertNode&lt;OP, REV&gt; extends UnaryNode implements ArithmeticOperation, ConvertNode, ArithmeticLIRLowerable, StampInverter {
 53     @SuppressWarnings(&quot;rawtypes&quot;) public static final NodeClass&lt;IntegerConvertNode&gt; TYPE = NodeClass.create(IntegerConvertNode.class);
 54 



 55     protected final int inputBits;
 56     protected final int resultBits;
 57 
<span class="line-modified"> 58     protected IntegerConvertNode(NodeClass&lt;? extends IntegerConvertNode&lt;OP, REV&gt;&gt; c, IntegerConvertOp&lt;OP&gt; opForStampComputation, int inputBits, int resultBits, ValueNode input) {</span>
<span class="line-modified"> 59         super(c, opForStampComputation.foldStamp(inputBits, resultBits, input.stamp(NodeView.DEFAULT)), input);</span>






 60         this.inputBits = inputBits;
 61         this.resultBits = resultBits;
<span class="line-modified"> 62         assert PrimitiveStamp.getBits(input.stamp(NodeView.DEFAULT)) == 0 || PrimitiveStamp.getBits(input.stamp(NodeView.DEFAULT)) == inputBits;</span>
 63     }
 64 
 65     public int getInputBits() {
 66         return inputBits;
 67     }
 68 
 69     public int getResultBits() {
 70         return resultBits;
 71     }
 72 
<span class="line-modified"> 73     protected abstract IntegerConvertOp&lt;OP&gt; getOp(ArithmeticOpTable table);</span>
<span class="line-modified"> 74 </span>
<span class="line-modified"> 75     protected abstract IntegerConvertOp&lt;REV&gt; getReverseOp(ArithmeticOpTable table);</span>
 76 
 77     @Override
 78     public final IntegerConvertOp&lt;OP&gt; getArithmeticOp() {
<span class="line-modified"> 79         return getOp(getArithmeticOpTable(getValue()));</span>
 80     }
 81 
 82     @Override
 83     public Constant convert(Constant c, ConstantReflectionProvider constantReflection) {
 84         return getArithmeticOp().foldConstant(getInputBits(), getResultBits(), c);
 85     }
 86 
 87     @Override
 88     public Constant reverse(Constant c, ConstantReflectionProvider constantReflection) {
<span class="line-modified"> 89         IntegerConvertOp&lt;REV&gt; reverse = getReverseOp(ArithmeticOpTable.forStamp(stamp(NodeView.DEFAULT)));</span>
 90         return reverse.foldConstant(getResultBits(), getInputBits(), c);
 91     }
 92 
 93     @Override
 94     public Stamp foldStamp(Stamp newStamp) {
 95         assert newStamp.isCompatible(getValue().stamp(NodeView.DEFAULT));
 96         return getArithmeticOp().foldStamp(inputBits, resultBits, newStamp);
 97     }
 98 
 99     @Override
100     public ValueNode canonical(CanonicalizerTool tool, ValueNode forValue) {
<span class="line-modified">101         ValueNode synonym = findSynonym(getOp(getArithmeticOpTable(forValue)), forValue, inputBits, resultBits, stamp(NodeView.DEFAULT));</span>
102         if (synonym != null) {
103             return synonym;
104         }
105         return this;
106     }
107 
108     protected static &lt;T&gt; ValueNode findSynonym(IntegerConvertOp&lt;T&gt; operation, ValueNode value, int inputBits, int resultBits, Stamp stamp) {
109         if (inputBits == resultBits) {
110             return value;
111         } else if (value.isConstant()) {
112             return ConstantNode.forPrimitive(stamp, operation.foldConstant(inputBits, resultBits, value.asConstant()));
113         }
114         return null;
115     }
116 
117     public static ValueNode convert(ValueNode input, Stamp stamp, NodeView view) {
118         return convert(input, stamp, false, view);
119     }
120 
121     public static ValueNode convert(ValueNode input, Stamp stamp, StructuredGraph graph, NodeView view) {
</pre>
</td>
</tr>
</table>
<center><a href="FloatEqualsNode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="IntegerDivRemNode.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>