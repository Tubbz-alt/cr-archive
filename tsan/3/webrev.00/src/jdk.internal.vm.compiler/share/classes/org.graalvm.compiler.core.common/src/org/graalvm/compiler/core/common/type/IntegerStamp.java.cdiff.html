<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.common/src/org/graalvm/compiler/core/common/type/IntegerStamp.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IllegalStamp.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="PrimitiveStamp.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.common/src/org/graalvm/compiler/core/common/type/IntegerStamp.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 165,12 ***</span>
      }
  
      @Override
      public Stamp constant(Constant c, MetaAccessProvider meta) {
          if (c instanceof PrimitiveConstant) {
<span class="line-modified">!             long value = ((PrimitiveConstant) c).asLong();</span>
<span class="line-modified">!             return StampFactory.forInteger(getBits(), value, value);</span>
          }
          return this;
      }
  
      @Override
<span class="line-new-header">--- 165,19 ---</span>
      }
  
      @Override
      public Stamp constant(Constant c, MetaAccessProvider meta) {
          if (c instanceof PrimitiveConstant) {
<span class="line-modified">!             PrimitiveConstant primitiveConstant = (PrimitiveConstant) c;</span>
<span class="line-modified">!             long value = primitiveConstant.asLong();</span>
<span class="line-added">+             if (primitiveConstant.getJavaKind() == JavaKind.Boolean &amp;&amp; value == 1) {</span>
<span class="line-added">+                 // Need to special case booleans as integer stamps are always signed values.</span>
<span class="line-added">+                 value = -1;</span>
<span class="line-added">+             }</span>
<span class="line-added">+             Stamp returnedStamp = StampFactory.forInteger(getBits(), value, value);</span>
<span class="line-added">+             assert returnedStamp.hasValues();</span>
<span class="line-added">+             return returnedStamp;</span>
          }
          return this;
      }
  
      @Override
</pre>
<hr />
<pre>
<span class="line-old-header">*** 641,11 ***</span>
                              }
                              IntegerStamp a = (IntegerStamp) stamp1;
                              IntegerStamp b = (IntegerStamp) stamp2;
  
                              int bits = a.getBits();
<span class="line-modified">!                             assert bits == b.getBits();</span>
  
                              if (a.lowerBound == a.upperBound &amp;&amp; b.lowerBound == b.upperBound) {
                                  long value = CodeUtil.convert(a.lowerBound() + b.lowerBound(), a.getBits(), false);
                                  return StampFactory.forInteger(a.getBits(), value, value);
                              }
<span class="line-new-header">--- 648,11 ---</span>
                              }
                              IntegerStamp a = (IntegerStamp) stamp1;
                              IntegerStamp b = (IntegerStamp) stamp2;
  
                              int bits = a.getBits();
<span class="line-modified">!                             assert bits == b.getBits() : String.format(&quot;stamp1.bits=%d, stamp2.bits=%d&quot;, bits, b.getBits());</span>
  
                              if (a.lowerBound == a.upperBound &amp;&amp; b.lowerBound == b.upperBound) {
                                  long value = CodeUtil.convert(a.lowerBound() + b.lowerBound(), a.getBits(), false);
                                  return StampFactory.forInteger(a.getBits(), value, value);
                              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1296,10 ***</span>
<span class="line-new-header">--- 1303,19 ---</span>
                                  default:
                                      throw GraalError.shouldNotReachHere();
                              }
                          }
  
<span class="line-added">+                         private boolean testNoSignChangeAfterShifting(int bits, long value, int shiftAmount) {</span>
<span class="line-added">+                             long removedBits = -1L &lt;&lt; (bits - shiftAmount - 1);</span>
<span class="line-added">+                             if (value &lt; 0) {</span>
<span class="line-added">+                                 return (value &amp; removedBits) == removedBits;</span>
<span class="line-added">+                             } else {</span>
<span class="line-added">+                                 return (value &amp; removedBits) == 0;</span>
<span class="line-added">+                             }</span>
<span class="line-added">+                         }</span>
<span class="line-added">+ </span>
                          @Override
                          public Stamp foldStamp(Stamp stamp, IntegerStamp shift) {
                              IntegerStamp value = (IntegerStamp) stamp;
                              int bits = value.getBits();
                              if (value.isEmpty()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1316,17 ***</span>
                                  int shiftAmount = (int) (shift.lowerBound() &amp; shiftMask);
                                  if (shiftAmount == 0) {
                                      return value;
                                  }
                                  // the mask of bits that will be lost or shifted into the sign bit
<span class="line-modified">!                                 long removedBits = -1L &lt;&lt; (bits - shiftAmount - 1);</span>
<span class="line-removed">-                                 if ((value.lowerBound() &amp; removedBits) == 0 &amp;&amp; (value.upperBound() &amp; removedBits) == 0) {</span>
                                      /*
                                       * use a better stamp if neither lower nor upper bound can lose
                                       * bits
                                       */
<span class="line-modified">!                                     return new IntegerStamp(bits, value.lowerBound() &lt;&lt; shiftAmount, value.upperBound() &lt;&lt; shiftAmount, value.downMask() &lt;&lt; shiftAmount, value.upMask() &lt;&lt; shiftAmount);</span>
                                  }
                              }
                              if ((shift.lowerBound() &gt;&gt;&gt; shiftBits) == (shift.upperBound() &gt;&gt;&gt; shiftBits)) {
                                  long defaultMask = CodeUtil.mask(bits);
                                  long downMask = defaultMask;
<span class="line-new-header">--- 1332,19 ---</span>
                                  int shiftAmount = (int) (shift.lowerBound() &amp; shiftMask);
                                  if (shiftAmount == 0) {
                                      return value;
                                  }
                                  // the mask of bits that will be lost or shifted into the sign bit
<span class="line-modified">!                                 if (testNoSignChangeAfterShifting(bits, value.lowerBound(), shiftAmount) &amp;&amp; testNoSignChangeAfterShifting(bits, value.upperBound(), shiftAmount)) {</span>
                                      /*
                                       * use a better stamp if neither lower nor upper bound can lose
                                       * bits
                                       */
<span class="line-modified">!                                     IntegerStamp result = new IntegerStamp(bits, value.lowerBound() &lt;&lt; shiftAmount, value.upperBound() &lt;&lt; shiftAmount,</span>
<span class="line-added">+                                                     (value.downMask() &lt;&lt; shiftAmount) &amp; CodeUtil.mask(bits),</span>
<span class="line-added">+                                                     (value.upMask() &lt;&lt; shiftAmount) &amp; CodeUtil.mask(bits));</span>
<span class="line-added">+                                     return result;</span>
                                  }
                              }
                              if ((shift.lowerBound() &gt;&gt;&gt; shiftBits) == (shift.upperBound() &gt;&gt;&gt; shiftBits)) {
                                  long defaultMask = CodeUtil.mask(bits);
                                  long downMask = defaultMask;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1592,11 ***</span>
                              long defaultMask = CodeUtil.mask(resultBits);
                              long newDownMask = stamp.downMask() &amp; defaultMask;
                              long newUpMask = stamp.upMask() &amp; defaultMask;
                              long newLowerBound = CodeUtil.signExtend((lowerBound | newDownMask) &amp; newUpMask, resultBits);
                              long newUpperBound = CodeUtil.signExtend((upperBound | newDownMask) &amp; newUpMask, resultBits);
<span class="line-modified">!                             return new IntegerStamp(resultBits, newLowerBound, newUpperBound, newDownMask, newUpMask);</span>
                          }
                      },
  
                      new FloatConvertOp(I2F) {
  
<span class="line-new-header">--- 1610,14 ---</span>
                              long defaultMask = CodeUtil.mask(resultBits);
                              long newDownMask = stamp.downMask() &amp; defaultMask;
                              long newUpMask = stamp.upMask() &amp; defaultMask;
                              long newLowerBound = CodeUtil.signExtend((lowerBound | newDownMask) &amp; newUpMask, resultBits);
                              long newUpperBound = CodeUtil.signExtend((upperBound | newDownMask) &amp; newUpMask, resultBits);
<span class="line-modified">! </span>
<span class="line-added">+                             IntegerStamp result = new IntegerStamp(resultBits, newLowerBound, newUpperBound, newDownMask, newUpMask);</span>
<span class="line-added">+                             assert result.hasValues();</span>
<span class="line-added">+                             return result;</span>
                          }
                      },
  
                      new FloatConvertOp(I2F) {
  
</pre>
<center><a href="IllegalStamp.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="PrimitiveStamp.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>