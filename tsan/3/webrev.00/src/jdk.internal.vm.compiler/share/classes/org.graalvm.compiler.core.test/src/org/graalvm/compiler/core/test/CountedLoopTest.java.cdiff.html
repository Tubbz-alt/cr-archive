<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/CountedLoopTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CopyOfVirtualizationTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CustomizedBytecodePatternTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/CountedLoopTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 41,12 ***</span>
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
  import org.graalvm.compiler.nodes.spi.LIRLowerable;
  import org.graalvm.compiler.nodes.spi.NodeLIRBuilderTool;
  import org.graalvm.compiler.phases.OptimisticOptimizations;
<span class="line-removed">- import org.graalvm.compiler.phases.tiers.HighTierContext;</span>
  import org.junit.Test;
  
  import jdk.vm.ci.meta.JavaKind;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
  
<span class="line-new-header">--- 41,12 ---</span>
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
  import org.graalvm.compiler.nodes.spi.LIRLowerable;
  import org.graalvm.compiler.nodes.spi.NodeLIRBuilderTool;
<span class="line-added">+ import org.graalvm.compiler.nodes.util.GraphUtil;</span>
  import org.graalvm.compiler.phases.OptimisticOptimizations;
  import org.junit.Test;
  
  import jdk.vm.ci.meta.JavaKind;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 68,25 ***</span>
      }
  
      /**
       * Get a property of an induction variable.
       */
<span class="line-modified">!     private static int get(@SuppressWarnings(&quot;unused&quot;) IVProperty property, @SuppressWarnings(&quot;unused&quot;) StaticIVProperty staticProperty, @SuppressWarnings(&quot;unused&quot;) IVPredicate constantCheck,</span>
<span class="line-modified">!                     int iv) {</span>
          return iv;
      }
  
<span class="line-modified">!     private static int get(@SuppressWarnings(&quot;unused&quot;) IVProperty property, int iv) {</span>
          return iv;
      }
  
<span class="line-modified">!     private static long get(@SuppressWarnings(&quot;unused&quot;) IVProperty property, @SuppressWarnings(&quot;unused&quot;) StaticIVProperty staticProperty, @SuppressWarnings(&quot;unused&quot;) IVPredicate constantCheck,</span>
                      long iv) {
          return iv;
      }
  
<span class="line-modified">!     private static long get(@SuppressWarnings(&quot;unused&quot;) IVProperty property, long iv) {</span>
          return iv;
      }
  
      private static class Result {
          public long extremum;
<span class="line-new-header">--- 68,28 ---</span>
      }
  
      /**
       * Get a property of an induction variable.
       */
<span class="line-modified">!     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-modified">!     private static int get(IVProperty property, StaticIVProperty staticProperty, IVPredicate constantCheck, int iv) {</span>
          return iv;
      }
  
<span class="line-modified">!     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-added">+     private static int get(IVProperty property, int iv) {</span>
          return iv;
      }
  
<span class="line-modified">!     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-added">+     private static long get(IVProperty property, StaticIVProperty staticProperty, IVPredicate constantCheck,</span>
                      long iv) {
          return iv;
      }
  
<span class="line-modified">!     @SuppressWarnings(&quot;unused&quot;)</span>
<span class="line-added">+     private static long get(IVProperty property, long iv) {</span>
          return iv;
      }
  
      private static class Result {
          public long extremum;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 148,16 ***</span>
          testCounted(&quot;incrementSnippet&quot;, -10, 1, Integer.MAX_VALUE);
      }
  
      @Test
      public void increment5() {
<span class="line-modified">!         testCounted(&quot;incrementSnippet&quot;, 256, 256, 1);</span>
      }
  
      @Test
      public void increment6() {
<span class="line-modified">!         testCounted(&quot;incrementSnippet&quot;, 257, 256, 1);</span>
      }
  
      @Test
      public void increment7() {
          testCounted(&quot;incrementSnippet&quot;, -10, Integer.MAX_VALUE, 1);
<span class="line-new-header">--- 151,16 ---</span>
          testCounted(&quot;incrementSnippet&quot;, -10, 1, Integer.MAX_VALUE);
      }
  
      @Test
      public void increment5() {
<span class="line-modified">!         testRemovableCounted(&quot;incrementSnippet&quot;, 256, 256, 1);</span>
      }
  
      @Test
      public void increment6() {
<span class="line-modified">!         testRemovableCounted(&quot;incrementSnippet&quot;, 257, 256, 1);</span>
      }
  
      @Test
      public void increment7() {
          testCounted(&quot;incrementSnippet&quot;, -10, Integer.MAX_VALUE, 1);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 205,11 ***</span>
          testCounted(&quot;incrementEqSnippet&quot;, 256, 256, 1);
      }
  
      @Test
      public void incrementEq6() {
<span class="line-modified">!         testCounted(&quot;incrementEqSnippet&quot;, 257, 256, 1);</span>
      }
  
      @Test
      public void incrementEq7() {
          testCounted(&quot;incrementEqSnippet&quot;, -10, Integer.MAX_VALUE - 1, 1);
<span class="line-new-header">--- 208,11 ---</span>
          testCounted(&quot;incrementEqSnippet&quot;, 256, 256, 1);
      }
  
      @Test
      public void incrementEq6() {
<span class="line-modified">!         testRemovableCounted(&quot;incrementEqSnippet&quot;, 257, 256, 1);</span>
      }
  
      @Test
      public void incrementEq7() {
          testCounted(&quot;incrementEqSnippet&quot;, -10, Integer.MAX_VALUE - 1, 1);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 218,10 ***</span>
<span class="line-new-header">--- 221,20 ---</span>
      @Test
      public void incrementEq8() {
          testCounted(&quot;incrementEqSnippet&quot;, -10, Integer.MAX_VALUE - 2, 2);
      }
  
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementEq9() {</span>
<span class="line-added">+         testCounted(&quot;incrementEqSnippet&quot;, 0, 0, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementEq10() {</span>
<span class="line-added">+         testCounted(&quot;incrementEqSnippet&quot;, 0, 0, 3);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      public static Result decrementSnippet(int start, int limit, int step) {
          int i;
          int dec = ((step - 1) &amp; 0xFFFF) + 1; // make sure this value is always strictly positive
          Result ret = new Result();
          for (i = start; i &gt; limit; i -= dec) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 284,11 ***</span>
          testCounted(&quot;decrementEqSnippet&quot;, 256, 0, 3);
      }
  
      @Test
      public void decrementEq4() {
<span class="line-modified">!         testCounted(&quot;decrementEqSnippet&quot;, -10, 0, Integer.MAX_VALUE);</span>
      }
  
      @Test
      public void decrementEq5() {
          testCounted(&quot;decrementEqSnippet&quot;, Integer.MAX_VALUE, -10, 1);
<span class="line-new-header">--- 297,11 ---</span>
          testCounted(&quot;decrementEqSnippet&quot;, 256, 0, 3);
      }
  
      @Test
      public void decrementEq4() {
<span class="line-modified">!         testRemovableCounted(&quot;decrementEqSnippet&quot;, -10, 0, Integer.MAX_VALUE);</span>
      }
  
      @Test
      public void decrementEq5() {
          testCounted(&quot;decrementEqSnippet&quot;, Integer.MAX_VALUE, -10, 1);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 297,10 ***</span>
<span class="line-new-header">--- 310,20 ---</span>
      @Test
      public void decrementEq6() {
          testCounted(&quot;decrementEqSnippet&quot;, Integer.MAX_VALUE, -10, 2);
      }
  
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementEq7() {</span>
<span class="line-added">+         testCounted(&quot;decrementEqSnippet&quot;, 10, 10, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementEq8() {</span>
<span class="line-added">+         testCounted(&quot;decrementEqSnippet&quot;, 10, 10, 3);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      public static Result twoVariablesSnippet() {
          Result ret = new Result();
          int j = 0;
          for (int i = 0; i &lt; 1024; i++) {
              j += 5;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 382,49 ***</span>
          testCounted(&quot;incrementLongSnippet&quot;, -10L, 1L, Long.MAX_VALUE);
      }
  
      @Test
      public void incrementLong5() {
<span class="line-modified">!         testCounted(&quot;incrementLongSnippet&quot;, 256L, 256L, 1L);</span>
      }
  
      @Test
      public void incrementLong6() {
<span class="line-modified">!         testCounted(&quot;incrementLongSnippet&quot;, 257L, 256L, 1L);</span>
      }
  
      @NodeInfo(cycles = CYCLES_IGNORED, size = SIZE_IGNORED)
      private static class IVPropertyNode extends FloatingNode implements LIRLowerable {
<span class="line-removed">- </span>
          public static final NodeClass&lt;IVPropertyNode&gt; TYPE = NodeClass.create(IVPropertyNode.class);
  
          private final IVProperty property;
          private final StaticIVProperty staticProperty;
          private final IVPredicate staticCheck;
          @Input private ValueNode iv;
  
<span class="line-modified">!         protected IVPropertyNode(IVProperty property, StaticIVProperty staticProperty, IVPredicate staticCheck, ValueNode iv) {</span>
              super(TYPE, iv.stamp(NodeView.DEFAULT).unrestricted());
              this.property = property;
              this.staticProperty = staticProperty;
              this.staticCheck = staticCheck;
              this.iv = iv;
          }
  
          public void rewrite(LoopsData loops) {
<span class="line-modified">!             InductionVariable inductionVariable = loops.getInductionVariable(iv);</span>
<span class="line-removed">-             assert inductionVariable != null;</span>
<span class="line-removed">-             assertTrue(inductionVariable.getLoop().isCounted(), &quot;must be counted&quot;);</span>
              ValueNode node = null;
<span class="line-modified">!             if (staticCheck != null) {</span>
<span class="line-modified">!                 assert staticProperty != null;</span>
<span class="line-modified">!                 if (staticCheck.test(inductionVariable)) {</span>
<span class="line-modified">!                     node = ConstantNode.forLong(staticProperty.get(inductionVariable), graph());</span>
                  }
<span class="line-removed">-             }</span>
<span class="line-removed">-             if (node == null) {</span>
<span class="line-removed">-                 node = property.get(inductionVariable);</span>
              }
              replaceAtUsagesAndDelete(node);
          }
  
          @Override
<span class="line-new-header">--- 405,179 ---</span>
          testCounted(&quot;incrementLongSnippet&quot;, -10L, 1L, Long.MAX_VALUE);
      }
  
      @Test
      public void incrementLong5() {
<span class="line-modified">!         testRemovableCounted(&quot;incrementLongSnippet&quot;, 256L, 256L, 1L);</span>
      }
  
      @Test
      public void incrementLong6() {
<span class="line-modified">!         testRemovableCounted(&quot;incrementLongSnippet&quot;, 257L, 256L, 1L);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public static Result incrementUnsignedSnippet(int start, int limit, int step) {</span>
<span class="line-added">+         int i;</span>
<span class="line-added">+         int inc = ((step - 1) &amp; 0xFFFF) + 1; // make sure this value is always strictly positive</span>
<span class="line-added">+         Result ret = new Result();</span>
<span class="line-added">+         for (i = start; Integer.compareUnsigned(i, limit) &lt; 0; i += inc) {</span>
<span class="line-added">+             GraalDirectives.controlFlowAnchor();</span>
<span class="line-added">+             ret.extremum = get(InductionVariable::extremumNode, InductionVariable::constantExtremum, InductionVariable::isConstantExtremum, i);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         ret.exitValue = get(InductionVariable::exitValueNode, i);</span>
<span class="line-added">+         return ret;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned1() {</span>
<span class="line-added">+         testCounted(&quot;incrementUnsignedSnippet&quot;, 0, 256, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned2() {</span>
<span class="line-added">+         testCounted(&quot;incrementUnsignedSnippet&quot;, 0, 256, 2);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned3() {</span>
<span class="line-added">+         testCounted(&quot;incrementUnsignedSnippet&quot;, 0, 256, 3);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned4() {</span>
<span class="line-added">+         testCounted(&quot;incrementUnsignedSnippet&quot;, 1, Integer.MAX_VALUE + 10, Integer.MAX_VALUE);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned5() {</span>
<span class="line-added">+         testRemovableCounted(&quot;incrementUnsignedSnippet&quot;, 256, 256, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned6() {</span>
<span class="line-added">+         testRemovableCounted(&quot;incrementUnsignedSnippet&quot;, 257, 256, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned7() {</span>
<span class="line-added">+         testCounted(&quot;incrementUnsignedSnippet&quot;, 0, Integer.MAX_VALUE + 10, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned8a() {</span>
<span class="line-added">+         testCounted(&quot;incrementUnsignedSnippet&quot;, 0, Integer.MAX_VALUE + 11, 2);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned8b() {</span>
<span class="line-added">+         testCounted(&quot;incrementUnsignedSnippet&quot;, 0, Integer.MAX_VALUE + 10, 2);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned9() {</span>
<span class="line-added">+         testCounted(&quot;incrementUnsignedSnippet&quot;, Integer.MAX_VALUE - 1, Integer.MAX_VALUE + 10, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void incrementUnsigned10() {</span>
<span class="line-added">+         testCounted(&quot;incrementUnsignedSnippet&quot;, Integer.MAX_VALUE - 1, Integer.MAX_VALUE + 10, 2);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public static Result decrementUnsignedSnippet(int start, int limit, int step) {</span>
<span class="line-added">+         int dec = ((step - 1) &amp; 0xFFFF) + 1; // make sure this value is always strictly positive</span>
<span class="line-added">+         Result ret = new Result();</span>
<span class="line-added">+         int i;</span>
<span class="line-added">+         for (i = start; Integer.compareUnsigned(i, limit) &gt; 0; i -= dec) {</span>
<span class="line-added">+             GraalDirectives.controlFlowAnchor();</span>
<span class="line-added">+             ret.extremum = get(InductionVariable::extremumNode, InductionVariable::constantExtremum, InductionVariable::isConstantExtremum, i);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         ret.exitValue = get(InductionVariable::exitValueNode, i);</span>
<span class="line-added">+         return ret;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementUnsigned1() {</span>
<span class="line-added">+         testCounted(&quot;decrementUnsignedSnippet&quot;, 256, 0, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementUnsigned2() {</span>
<span class="line-added">+         testCounted(&quot;decrementUnsignedSnippet&quot;, 256, 0, 2);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementUnsigned3() {</span>
<span class="line-added">+         testCounted(&quot;decrementUnsignedSnippet&quot;, 256, 2, 3);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementUnsigned5() {</span>
<span class="line-added">+         testRemovableCounted(&quot;decrementUnsignedSnippet&quot;, 256, 256, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementUnsigned6() {</span>
<span class="line-added">+         testRemovableCounted(&quot;decrementUnsignedSnippet&quot;, 256, 257, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementUnsigned7() {</span>
<span class="line-added">+         testCounted(&quot;decrementUnsignedSnippet&quot;, Integer.MAX_VALUE + 10, 0, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementUnsigned8() {</span>
<span class="line-added">+         testCounted(&quot;decrementUnsignedSnippet&quot;, Integer.MAX_VALUE + 11, 0, 2);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementUnsigned9() {</span>
<span class="line-added">+         testCounted(&quot;decrementUnsignedSnippet&quot;, Integer.MAX_VALUE + 10, Integer.MAX_VALUE - 1, 1);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Test</span>
<span class="line-added">+     public void decrementUnsigned10() {</span>
<span class="line-added">+         testCounted(&quot;decrementUnsignedSnippet&quot;, Integer.MAX_VALUE + 10, Integer.MAX_VALUE - 1, 2);</span>
      }
  
      @NodeInfo(cycles = CYCLES_IGNORED, size = SIZE_IGNORED)
      private static class IVPropertyNode extends FloatingNode implements LIRLowerable {
          public static final NodeClass&lt;IVPropertyNode&gt; TYPE = NodeClass.create(IVPropertyNode.class);
  
          private final IVProperty property;
          private final StaticIVProperty staticProperty;
          private final IVPredicate staticCheck;
<span class="line-added">+         private final boolean loopCanBeRemoved;</span>
          @Input private ValueNode iv;
  
<span class="line-modified">!         protected IVPropertyNode(IVProperty property, StaticIVProperty staticProperty, IVPredicate staticCheck, ValueNode iv, boolean loopCanBeRemoved) {</span>
              super(TYPE, iv.stamp(NodeView.DEFAULT).unrestricted());
              this.property = property;
              this.staticProperty = staticProperty;
              this.staticCheck = staticCheck;
              this.iv = iv;
<span class="line-added">+             this.loopCanBeRemoved = loopCanBeRemoved;</span>
          }
  
          public void rewrite(LoopsData loops) {
<span class="line-modified">!             InductionVariable inductionVariable = loops.getInductionVariable(GraphUtil.unproxify(iv));</span>
              ValueNode node = null;
<span class="line-modified">!             if (inductionVariable == null) {</span>
<span class="line-modified">!                 assert loopCanBeRemoved;</span>
<span class="line-modified">!                 assert loops.loops().isEmpty();</span>
<span class="line-modified">!                 node = iv;</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 assertTrue(inductionVariable.getLoop().isCounted(), &quot;must be counted&quot;);</span>
<span class="line-added">+                 if (staticCheck != null) {</span>
<span class="line-added">+                     assert staticProperty != null;</span>
<span class="line-added">+                     if (staticCheck.test(inductionVariable)) {</span>
<span class="line-added">+                         node = ConstantNode.forLong(staticProperty.get(inductionVariable), graph());</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 if (node == null) {</span>
<span class="line-added">+                     node = property.get(inductionVariable);</span>
                  }
              }
              replaceAtUsagesAndDelete(node);
          }
  
          @Override
</pre>
<hr />
<pre>
<span class="line-old-header">*** 448,11 ***</span>
                  IVProperty property = null;
                  if (arg1.isConstant()) {
                      property = getSnippetReflection().asObject(IVProperty.class, arg1.asJavaConstant());
                  }
                  if (property != null) {
<span class="line-modified">!                     b.addPush(ivKind, new IVPropertyNode(property, null, null, arg2));</span>
                      return true;
                  } else {
                      return false;
                  }
              }
<span class="line-new-header">--- 601,11 ---</span>
                  IVProperty property = null;
                  if (arg1.isConstant()) {
                      property = getSnippetReflection().asObject(IVProperty.class, arg1.asJavaConstant());
                  }
                  if (property != null) {
<span class="line-modified">!                     b.addPush(ivKind, new IVPropertyNode(property, null, null, arg2, loopCanBeRemoved));</span>
                      return true;
                  } else {
                      return false;
                  }
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 471,45 ***</span>
                  }
                  if (arg3.isConstant()) {
                      staticCheck = getSnippetReflection().asObject(IVPredicate.class, arg3.asJavaConstant());
                  }
                  if (property != null &amp;&amp; staticProperty != null &amp;&amp; staticCheck != null) {
<span class="line-modified">!                     b.addPush(ivKind, new IVPropertyNode(property, staticProperty, staticCheck, arg4));</span>
                      return true;
                  } else {
                      return false;
                  }
              }
          });
      }
  
      @Override
<span class="line-modified">!     protected boolean checkHighTierGraph(StructuredGraph graph) {</span>
          LoopsData loops = new LoopsData(graph);
          loops.detectedCountedLoops();
          for (IVPropertyNode node : graph.getNodes().filter(IVPropertyNode.class)) {
              node.rewrite(loops);
          }
          assert graph.getNodes().filter(IVPropertyNode.class).isEmpty();
<span class="line-removed">-         return true;</span>
      }
  
      @Override
<span class="line-modified">!     protected HighTierContext getDefaultHighTierContext() {</span>
          // Don&#39;t convert unreached paths into Guard
<span class="line-modified">!         return new HighTierContext(getProviders(), getDefaultGraphBuilderSuite(), OptimisticOptimizations.NONE);</span>
      }
  
      private Object[] argsToBind;
  
      @Override
      protected Object[] getArgumentToBind() {
          return argsToBind;
      }
  
      public void testCounted(String snippetName, Object... args) {
          test(snippetName, args);
<span class="line-modified">!         argsToBind = args;</span>
          test(snippetName, args);
<span class="line-modified">!         argsToBind = null;</span>
      }
  }
<span class="line-new-header">--- 624,68 ---</span>
                  }
                  if (arg3.isConstant()) {
                      staticCheck = getSnippetReflection().asObject(IVPredicate.class, arg3.asJavaConstant());
                  }
                  if (property != null &amp;&amp; staticProperty != null &amp;&amp; staticCheck != null) {
<span class="line-modified">!                     b.addPush(ivKind, new IVPropertyNode(property, staticProperty, staticCheck, arg4, loopCanBeRemoved));</span>
                      return true;
                  } else {
                      return false;
                  }
              }
          });
      }
  
      @Override
<span class="line-modified">!     protected void checkHighTierGraph(StructuredGraph graph) {</span>
          LoopsData loops = new LoopsData(graph);
          loops.detectedCountedLoops();
          for (IVPropertyNode node : graph.getNodes().filter(IVPropertyNode.class)) {
              node.rewrite(loops);
          }
          assert graph.getNodes().filter(IVPropertyNode.class).isEmpty();
      }
  
      @Override
<span class="line-modified">!     protected OptimisticOptimizations getOptimisticOptimizations() {</span>
          // Don&#39;t convert unreached paths into Guard
<span class="line-modified">!         return OptimisticOptimizations.ALL.remove(OptimisticOptimizations.Optimization.RemoveNeverExecutedCode);</span>
      }
  
      private Object[] argsToBind;
<span class="line-added">+     private boolean loopCanBeRemoved;</span>
  
      @Override
      protected Object[] getArgumentToBind() {
          return argsToBind;
      }
  
      public void testCounted(String snippetName, Object... args) {
<span class="line-added">+         this.loopCanBeRemoved = false;</span>
<span class="line-added">+         test(snippetName, args);</span>
<span class="line-added">+         this.argsToBind = args;</span>
<span class="line-added">+         test(snippetName, args);</span>
<span class="line-added">+         this.argsToBind = null;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public void testCounted(String snippetName, Object start, Object limit, Object step) {</span>
<span class="line-added">+         testCounted(false, snippetName, start, limit, step);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public void testRemovableCounted(String snippetName, Object start, Object limit, Object step) {</span>
<span class="line-added">+         testCounted(true, snippetName, start, limit, step);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public void testCounted(boolean removable, String snippetName, Object start, Object limit, Object step) {</span>
<span class="line-added">+         this.loopCanBeRemoved = removable;</span>
<span class="line-added">+         Object[] args = {start, limit, step};</span>
<span class="line-added">+         test(snippetName, args);</span>
<span class="line-added">+         this.argsToBind = args;</span>
<span class="line-added">+         test(snippetName, args);</span>
<span class="line-added">+         this.argsToBind = new Object[]{NO_BIND, NO_BIND, step};</span>
          test(snippetName, args);
<span class="line-modified">!         this.argsToBind = new Object[]{start, NO_BIND, step};</span>
          test(snippetName, args);
<span class="line-modified">!         this.argsToBind = null;</span>
<span class="line-added">+         this.loopCanBeRemoved = false;</span>
      }
  }
</pre>
<center><a href="CopyOfVirtualizationTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CustomizedBytecodePatternTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>