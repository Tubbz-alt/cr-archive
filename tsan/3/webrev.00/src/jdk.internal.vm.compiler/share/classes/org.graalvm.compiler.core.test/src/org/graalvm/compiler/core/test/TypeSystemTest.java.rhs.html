<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/TypeSystemTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.core.test;
 26 
 27 import java.io.BufferedInputStream;
 28 import java.io.ByteArrayInputStream;
 29 import java.io.FileInputStream;
 30 import java.io.IOException;
 31 import java.io.InputStream;
 32 
 33 import org.graalvm.compiler.debug.DebugContext;
 34 import org.graalvm.compiler.debug.TTY;
 35 import org.graalvm.compiler.graph.Node;
 36 import org.graalvm.compiler.nodeinfo.Verbosity;
 37 import org.graalvm.compiler.nodes.AbstractMergeNode;
 38 import org.graalvm.compiler.nodes.PhiNode;
 39 import org.graalvm.compiler.nodes.StructuredGraph;
 40 import org.graalvm.compiler.nodes.StructuredGraph.AllowAssumptions;
 41 import org.graalvm.compiler.nodes.StructuredGraph.ScheduleResult;
 42 import org.graalvm.compiler.nodes.cfg.Block;
 43 import org.graalvm.compiler.nodes.java.InstanceOfNode;
<a name="2" id="anc2"></a>
 44 import org.graalvm.compiler.phases.common.ConditionalEliminationPhase;
 45 import org.graalvm.compiler.phases.schedule.SchedulePhase;
<a name="3" id="anc3"></a>
 46 import org.junit.Assert;
 47 import org.junit.Ignore;
 48 import org.junit.Test;
 49 
 50 /**
 51  * In the following tests, the scalar type system of the compiler should be complete enough to see
 52  * the relation between the different conditions.
 53  */
 54 public class TypeSystemTest extends GraalCompilerTest {
 55 
 56     @Test
 57     public void test3() {
 58         test(&quot;test3Snippet&quot;, &quot;referenceSnippet3&quot;);
 59     }
 60 
 61     public static int referenceSnippet3(Object o) {
 62         if (o == null) {
 63             return 1;
 64         } else {
 65             return 2;
 66         }
 67     }
 68 
 69     @SuppressWarnings(&quot;unused&quot;)
 70     public static int test3Snippet(Object o) {
 71         if (o == null) {
 72             if (o != null) {
 73                 return 3;
 74             } else {
 75                 return 1;
 76             }
 77         } else {
 78             return 2;
 79         }
 80     }
 81 
 82     @Test
 83     public void test4() {
 84         test(&quot;test4Snippet&quot;, &quot;referenceSnippet3&quot;);
 85     }
 86 
 87     @SuppressWarnings(&quot;unused&quot;)
 88     public static int test4Snippet(Object o) {
 89         if (o == null) {
 90             Object o2 = Integer.class;
 91             if (o == o2) {
 92                 return 3;
 93             } else {
 94                 return 1;
 95             }
 96         } else {
 97             return 2;
 98         }
 99     }
100 
101     @Test
102     @Ignore
103     public void test5() {
104         test(&quot;test5Snippet&quot;, &quot;referenceSnippet5&quot;);
105     }
106 
107     public static int referenceSnippet5(Object o, Object a) {
108         if (o == null) {
109             if (a == Integer.class) {
110                 return 1;
111             }
112         } else {
113             if (a == Double.class) {
114                 return 11;
115             }
116         }
117         if (a == Integer.class) {
118             return 3;
119         }
120         return 5;
121     }
122 
123     @SuppressWarnings(&quot;unused&quot;)
124     public static int test5Snippet(Object o, Object a) {
125         if (o == null) {
126             if (a == Integer.class) {
127                 if (a == null) {
128                     return 10;
129                 }
130                 return 1;
131             }
132         } else {
133             if (a == Double.class) {
134                 if (a != null) {
135                     return 11;
136                 }
137                 return 2;
138             }
139         }
140         if (a == Integer.class) {
141             return 3;
142         }
143         return 5;
144     }
145 
146     @Test
147     public void test6() {
148         testHelper(&quot;test6Snippet&quot;, InstanceOfNode.class);
149     }
150 
151     public static int test6Snippet(int i) throws IOException {
152         Object o = null;
153 
154         if (i == 5) {
155             o = new FileInputStream(&quot;asdf&quot;);
156         }
157         if (i &lt; 10) {
158             o = new ByteArrayInputStream(new byte[]{1, 2, 3});
159         }
160         if (i &gt; 0) {
161             o = new BufferedInputStream(null);
162         }
163 
164         return ((InputStream) o).available();
165     }
166 
167     @Test
168     public void test7() {
169         test(&quot;test7Snippet&quot;, &quot;referenceSnippet7&quot;);
170     }
171 
172     public static int test7Snippet(int x) {
173         return ((x &amp; 0xff) &lt;&lt; 10) == ((x &amp; 0x1f) + 1) ? 0 : x;
174     }
175 
176     public static int referenceSnippet7(int x) {
177         return x;
178     }
179 
180     private void test(String snippet, String referenceSnippet) {
181         StructuredGraph graph = parseEager(snippet, AllowAssumptions.NO);
182         DebugContext debug = graph.getDebug();
183         debug.dump(DebugContext.BASIC_LEVEL, graph, &quot;Graph&quot;);
184         /*
185          * When using FlowSensitiveReductionPhase instead of ConditionalEliminationPhase,
186          * tail-duplication gets activated thus resulting in a graph with more nodes than the
187          * reference graph.
188          */
<a name="4" id="anc4"></a><span class="line-modified">189         new ConditionalEliminationPhase(false).apply(graph, getProviders());</span>
<span class="line-modified">190         createCanonicalizerPhase().apply(graph, getProviders());</span>
191         // a second canonicalizer is needed to process nested MaterializeNodes
<a name="5" id="anc5"></a><span class="line-modified">192         createCanonicalizerPhase().apply(graph, getProviders());</span>
193         StructuredGraph referenceGraph = parseEager(referenceSnippet, AllowAssumptions.NO);
<a name="6" id="anc6"></a><span class="line-modified">194         new ConditionalEliminationPhase(false).apply(referenceGraph, getProviders());</span>
<span class="line-modified">195         this.createCanonicalizerPhase().apply(referenceGraph, getProviders());</span>
<span class="line-modified">196         this.createCanonicalizerPhase().apply(referenceGraph, getProviders());</span>
197         assertEquals(referenceGraph, graph);
198     }
199 
200     @Override
201     protected void assertEquals(StructuredGraph expected, StructuredGraph graph) {
202         DebugContext debug = graph.getDebug();
203         if (getNodeCountExcludingUnusedConstants(expected) != getNodeCountExcludingUnusedConstants(graph)) {
204             debug.dump(DebugContext.BASIC_LEVEL, expected, &quot;expected (node count)&quot;);
205             debug.dump(DebugContext.BASIC_LEVEL, graph, &quot;graph (node count)&quot;);
206             Assert.fail(&quot;Graphs do not have the same number of nodes: &quot; + expected.getNodeCount() + &quot; vs. &quot; + graph.getNodeCount());
207         }
208     }
209 
210     public static void outputGraph(StructuredGraph graph, String message) {
211         TTY.println(&quot;========================= &quot; + message);
212         SchedulePhase schedulePhase = new SchedulePhase(graph.getOptions());
213         schedulePhase.apply(graph);
214         ScheduleResult schedule = graph.getLastSchedule();
215         for (Block block : schedule.getCFG().getBlocks()) {
216             TTY.print(&quot;Block &quot; + block + &quot; &quot;);
217             if (block == schedule.getCFG().getStartBlock()) {
218                 TTY.print(&quot;* &quot;);
219             }
220             TTY.print(&quot;-&gt; &quot;);
221             for (Block succ : block.getSuccessors()) {
222                 TTY.print(succ + &quot; &quot;);
223             }
224             TTY.println();
225             for (Node node : schedule.getBlockToNodesMap().get(block)) {
226                 outputNode(node);
227             }
228         }
229     }
230 
231     private static void outputNode(Node node) {
232         TTY.print(&quot;  &quot; + node + &quot;    (usage count: &quot; + node.getUsageCount() + &quot;) (inputs:&quot;);
233         for (Node input : node.inputs()) {
234             TTY.print(&quot; &quot; + input.toString(Verbosity.Id));
235         }
236         TTY.println(&quot;)&quot;);
237         if (node instanceof AbstractMergeNode) {
238             for (PhiNode phi : ((AbstractMergeNode) node).phis()) {
239                 outputNode(phi);
240             }
241         }
242     }
243 
244     private &lt;T extends Node&gt; void testHelper(String snippet, Class&lt;T&gt; clazz) {
245         StructuredGraph graph = parseEager(snippet, AllowAssumptions.NO);
<a name="7" id="anc7"></a><span class="line-modified">246         createCanonicalizerPhase().apply(graph, getProviders());</span>
<span class="line-modified">247         createCanonicalizerPhase().apply(graph, getProviders());</span>
248         DebugContext debug = graph.getDebug();
249         debug.dump(DebugContext.BASIC_LEVEL, graph, &quot;Graph &quot; + snippet);
250         Assert.assertFalse(&quot;shouldn&#39;t have nodes of type &quot; + clazz, graph.getNodes().filter(clazz).iterator().hasNext());
251     }
252 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>