<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/ea/UnsafeEATest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="UnsafeCompareAndSwapVirtualizationTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="../inlining/InliningTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/ea/UnsafeEATest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -35,11 +35,10 @@</span>
  import org.graalvm.compiler.nodes.calc.UnpackEndianHalfNode;
  import org.graalvm.compiler.nodes.extended.RawLoadNode;
  import org.graalvm.compiler.nodes.extended.RawStoreNode;
  import org.graalvm.compiler.nodes.extended.UnsafeAccessNode;
  import org.graalvm.compiler.nodes.java.LoadFieldNode;
<span class="udiff-line-removed">- import org.graalvm.compiler.phases.common.CanonicalizerPhase;</span>
  import org.junit.Assert;
  import org.junit.Test;
  
  import jdk.vm.ci.meta.JavaConstant;
  import jdk.vm.ci.meta.JavaKind;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -47,31 +46,10 @@</span>
  
  public class UnsafeEATest extends EATestBase {
  
      public static int zero = 0;
  
<span class="udiff-line-removed">-     private static final long fieldOffset1;</span>
<span class="udiff-line-removed">-     private static final long fieldOffset2;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static {</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             long localFieldOffset1 = UNSAFE.objectFieldOffset(TestClassInt.class.getField(&quot;x&quot;));</span>
<span class="udiff-line-removed">-             // Make the fields 8 byte aligned (Required for testing setLong on Architectures which</span>
<span class="udiff-line-removed">-             // does not support unaligned memory access</span>
<span class="udiff-line-removed">-             if (localFieldOffset1 % 8 == 0) {</span>
<span class="udiff-line-removed">-                 fieldOffset1 = localFieldOffset1;</span>
<span class="udiff-line-removed">-                 fieldOffset2 = UNSAFE.objectFieldOffset(TestClassInt.class.getField(&quot;y&quot;));</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 fieldOffset1 = UNSAFE.objectFieldOffset(TestClassInt.class.getField(&quot;y&quot;));</span>
<span class="udiff-line-removed">-                 fieldOffset2 = UNSAFE.objectFieldOffset(TestClassInt.class.getField(&quot;z&quot;));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             assert fieldOffset2 == fieldOffset1 + 4;</span>
<span class="udiff-line-removed">-         } catch (Exception e) {</span>
<span class="udiff-line-removed">-             throw new RuntimeException(e);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      @Override
      protected void testEscapeAnalysis(String snippet, JavaConstant expectedConstantResult, boolean iterativeEscapeAnalysis) {
          // Exercise both a graph containing UnsafeAccessNodes and one which has been possibly been
          // canonicalized into AccessFieldNodes.
          testingUnsafe = true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -121,11 +99,11 @@</span>
          // Simplify any UnpackEndianHalfNode so we end up with constants.
          Graph.Mark mark = graph.getMark();
          for (UnpackEndianHalfNode node : graph.getNodes().filter(UnpackEndianHalfNode.class)) {
              node.lower(getTarget().arch.getByteOrder());
          }
<span class="udiff-line-modified-removed">-         new CanonicalizerPhase().applyIncremental(graph, context, mark);</span>
<span class="udiff-line-modified-added">+         createCanonicalizerPhase().applyIncremental(graph, context, mark);</span>
      }
  
      private boolean testingUnsafe;
  
      @Test
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -133,46 +111,46 @@</span>
          testEscapeAnalysis(&quot;testSimpleIntSnippet&quot;, JavaConstant.forInt(101), false);
      }
  
      public static int testSimpleIntSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putInt(x, fieldOffset1, 101);</span>
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(x, fieldOffset1);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putInt(x, TestClassInt.fieldOffset1, 101);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(x, TestClassInt.fieldOffset1);</span>
      }
  
      @Test
      public void testMaterializedInt() {
          test(&quot;testMaterializedIntSnippet&quot;);
      }
  
      public static TestClassInt testMaterializedIntSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putInt(x, fieldOffset1, 101);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putInt(x, TestClassInt.fieldOffset1, 101);</span>
          return x;
      }
  
      @Test
      public void testSimpleDouble() {
          testEscapeAnalysis(&quot;testSimpleDoubleSnippet&quot;, JavaConstant.forDouble(10.1), false);
      }
  
      public static double testSimpleDoubleSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putDouble(x, fieldOffset1, 10.1);</span>
<span class="udiff-line-modified-removed">-         return UNSAFE.getDouble(x, fieldOffset1);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putDouble(x, TestClassInt.fieldOffset1, 10.1);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getDouble(x, TestClassInt.fieldOffset1);</span>
      }
  
      @Test
      public void testSimpleDoubleOverwriteWithInt() {
          testEscapeAnalysis(&quot;testSimpleDoubleOverwriteWithIntSnippet&quot;, JavaConstant.forInt(10), false);
      }
  
      public static int testSimpleDoubleOverwriteWithIntSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putDouble(x, fieldOffset1, 10.1);</span>
<span class="udiff-line-modified-removed">-         UNSAFE.putInt(x, fieldOffset1, 10);</span>
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(x, fieldOffset1);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putDouble(x, TestClassInt.fieldOffset1, 10.1);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putInt(x, TestClassInt.fieldOffset1, 10);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(x, TestClassInt.fieldOffset1);</span>
      }
  
      @Test
      public void testSimpleDoubleOverwriteWithSecondInt() {
          ByteBuffer bb = ByteBuffer.allocate(8).order(getTarget().arch.getByteOrder());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -182,13 +160,13 @@</span>
          testEscapeAnalysis(&quot;testSimpleDoubleOverwriteWithSecondIntSnippet&quot;, JavaConstant.forInt(value), false);
      }
  
      public static int testSimpleDoubleOverwriteWithSecondIntSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putDouble(x, fieldOffset1, 10.1);</span>
<span class="udiff-line-modified-removed">-         UNSAFE.putInt(x, fieldOffset1, 10);</span>
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(x, fieldOffset2);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putDouble(x, TestClassInt.fieldOffset1, 10.1);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putInt(x, TestClassInt.fieldOffset1, 10);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(x, TestClassInt.fieldOffset2);</span>
      }
  
      @Test
      public void testSimpleDoubleOverwriteWithFirstInt() {
          ByteBuffer bb = ByteBuffer.allocate(8).order(getTarget().arch.getByteOrder());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -198,13 +176,13 @@</span>
          testEscapeAnalysis(&quot;testSimpleDoubleOverwriteWithFirstIntSnippet&quot;, JavaConstant.forInt(value), false);
      }
  
      public static int testSimpleDoubleOverwriteWithFirstIntSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putDouble(x, fieldOffset1, 10.1);</span>
<span class="udiff-line-modified-removed">-         UNSAFE.putInt(x, fieldOffset2, 10);</span>
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(x, fieldOffset1);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putDouble(x, TestClassInt.fieldOffset1, 10.1);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putInt(x, TestClassInt.fieldOffset2, 10);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(x, TestClassInt.fieldOffset1);</span>
      }
  
      @Test
      public void testSimpleLongOverwriteWithSecondInt() {
          ByteBuffer bb = ByteBuffer.allocate(8).order(getTarget().arch.getByteOrder());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -214,13 +192,13 @@</span>
          testEscapeAnalysis(&quot;testSimpleLongOverwriteWithSecondIntSnippet&quot;, JavaConstant.forInt(value), false);
      }
  
      public static int testSimpleLongOverwriteWithSecondIntSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putLong(x, fieldOffset1, 0x1122334455667788L);</span>
<span class="udiff-line-modified-removed">-         UNSAFE.putInt(x, fieldOffset1, 10);</span>
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(x, fieldOffset2);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putLong(x, TestClassInt.fieldOffset1, 0x1122334455667788L);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putInt(x, TestClassInt.fieldOffset1, 10);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(x, TestClassInt.fieldOffset2);</span>
      }
  
      @Test
      public void testSimpleLongOverwriteWithFirstInt() {
          ByteBuffer bb = ByteBuffer.allocate(8).order(getTarget().arch.getByteOrder());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,13 +208,13 @@</span>
          testEscapeAnalysis(&quot;testSimpleLongOverwriteWithFirstIntSnippet&quot;, JavaConstant.forInt(value), false);
      }
  
      public static int testSimpleLongOverwriteWithFirstIntSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putLong(x, fieldOffset1, 0x1122334455667788L);</span>
<span class="udiff-line-modified-removed">-         UNSAFE.putInt(x, fieldOffset2, 10);</span>
<span class="udiff-line-modified-removed">-         return UNSAFE.getInt(x, fieldOffset1);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putLong(x, TestClassInt.fieldOffset1, 0x1122334455667788L);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putInt(x, TestClassInt.fieldOffset2, 10);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getInt(x, TestClassInt.fieldOffset1);</span>
      }
  
      @Test
      public void testMergedDouble() {
          testEscapeAnalysis(&quot;testMergedDoubleSnippet&quot;, null, false);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -249,16 +227,16 @@</span>
  
      public static double testMergedDoubleSnippet(boolean a) {
          TestClassInt x;
          if (a) {
              x = new TestClassInt(0, 0);
<span class="udiff-line-modified-removed">-             UNSAFE.putDouble(x, fieldOffset1, doubleField);</span>
<span class="udiff-line-modified-added">+             UNSAFE.putDouble(x, TestClassInt.fieldOffset1, doubleField);</span>
          } else {
              x = new TestClassInt();
<span class="udiff-line-modified-removed">-             UNSAFE.putDouble(x, fieldOffset1, doubleField2);</span>
<span class="udiff-line-modified-added">+             UNSAFE.putDouble(x, TestClassInt.fieldOffset1, doubleField2);</span>
          }
<span class="udiff-line-modified-removed">-         return UNSAFE.getDouble(x, fieldOffset1);</span>
<span class="udiff-line-modified-added">+         return UNSAFE.getDouble(x, TestClassInt.fieldOffset1);</span>
      }
  
      static class ExtendedTestClassInt extends TestClassInt {
          public long l;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -270,18 +248,18 @@</span>
  
      public static TestClassInt testMergedVirtualObjectsSnippet(int value) {
          TestClassInt x;
          if (value == 1) {
              x = new TestClassInt();
<span class="udiff-line-modified-removed">-             UNSAFE.putDouble(x, fieldOffset1, 10);</span>
<span class="udiff-line-modified-added">+             UNSAFE.putDouble(x, TestClassInt.fieldOffset1, 10);</span>
          } else {
              x = new TestClassInt();
<span class="udiff-line-modified-removed">-             UNSAFE.putInt(x, fieldOffset1, 0);</span>
<span class="udiff-line-modified-added">+             UNSAFE.putInt(x, TestClassInt.fieldOffset1, 0);</span>
          }
<span class="udiff-line-modified-removed">-         UNSAFE.putInt(x, fieldOffset1, 0);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putInt(x, TestClassInt.fieldOffset1, 0);</span>
          if (value == 2) {
<span class="udiff-line-modified-removed">-             UNSAFE.putInt(x, fieldOffset2, 0);</span>
<span class="udiff-line-modified-added">+             UNSAFE.putInt(x, TestClassInt.fieldOffset2, 0);</span>
          }
          GraalDirectives.deoptimizeAndInvalidate();
          return x;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -290,11 +268,11 @@</span>
          test(&quot;testMaterializedDoubleSnippet&quot;);
      }
  
      public static TestClassInt testMaterializedDoubleSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putDouble(x, fieldOffset1, 10.1);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putDouble(x, TestClassInt.fieldOffset1, 10.1);</span>
          return x;
      }
  
      @Test
      public void testDeoptDoubleVar() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -304,14 +282,14 @@</span>
      public static double doubleField = 10.1e99;
      public static double doubleField2;
  
      public static TestClassInt testDeoptDoubleVarSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putDouble(x, fieldOffset1, doubleField);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putDouble(x, TestClassInt.fieldOffset1, doubleField);</span>
          doubleField2 = 123;
          try {
<span class="udiff-line-modified-removed">-             doubleField = ((int) UNSAFE.getDouble(x, fieldOffset1)) / zero;</span>
<span class="udiff-line-modified-added">+             doubleField = ((int) UNSAFE.getDouble(x, TestClassInt.fieldOffset1)) / zero;</span>
          } catch (RuntimeException e) {
              return x;
          }
          return x;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -321,14 +299,14 @@</span>
          test(&quot;testDeoptDoubleConstantSnippet&quot;);
      }
  
      public static TestClassInt testDeoptDoubleConstantSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putDouble(x, fieldOffset1, 10.123);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putDouble(x, TestClassInt.fieldOffset1, 10.123);</span>
          doubleField2 = 123;
          try {
<span class="udiff-line-modified-removed">-             doubleField = ((int) UNSAFE.getDouble(x, fieldOffset1)) / zero;</span>
<span class="udiff-line-modified-added">+             doubleField = ((int) UNSAFE.getDouble(x, TestClassInt.fieldOffset1)) / zero;</span>
          } catch (RuntimeException e) {
              return x;
          }
          return x;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -341,14 +319,14 @@</span>
      public static long longField = 0x133443218aaaffffL;
      public static long longField2;
  
      public static TestClassInt testDeoptLongVarSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putLong(x, fieldOffset1, longField);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putLong(x, TestClassInt.fieldOffset1, longField);</span>
          longField2 = 123;
          try {
<span class="udiff-line-modified-removed">-             longField = UNSAFE.getLong(x, fieldOffset1) / zero;</span>
<span class="udiff-line-modified-added">+             longField = UNSAFE.getLong(x, TestClassInt.fieldOffset1) / zero;</span>
          } catch (RuntimeException e) {
              return x;
          }
          return x;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -358,14 +336,14 @@</span>
          test(&quot;testDeoptLongConstantSnippet&quot;);
      }
  
      public static TestClassInt testDeoptLongConstantSnippet() {
          TestClassInt x = new TestClassInt();
<span class="udiff-line-modified-removed">-         UNSAFE.putLong(x, fieldOffset1, 0x2222222210123L);</span>
<span class="udiff-line-modified-added">+         UNSAFE.putLong(x, TestClassInt.fieldOffset1, 0x2222222210123L);</span>
          longField2 = 123;
          try {
<span class="udiff-line-modified-removed">-             longField = UNSAFE.getLong(x, fieldOffset1) / zero;</span>
<span class="udiff-line-modified-added">+             longField = UNSAFE.getLong(x, TestClassInt.fieldOffset1) / zero;</span>
          } catch (RuntimeException e) {
              return x;
          }
          return x;
      }
</pre>
<center><a href="UnsafeCompareAndSwapVirtualizationTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="../inlining/InliningTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>