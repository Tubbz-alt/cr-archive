<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/OptionsVerifierTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="NodePropertiesTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="PushNodesThroughPiTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/OptionsVerifierTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.core.test;
 26 
 27 import static java.lang.String.format;
 28 
<span class="line-removed"> 29 import java.io.ByteArrayOutputStream;</span>
<span class="line-removed"> 30 import java.io.File;</span>
 31 import java.io.IOException;
<span class="line-removed"> 32 import java.io.InputStream;</span>
 33 import java.lang.reflect.Constructor;
 34 import java.lang.reflect.Executable;
 35 import java.lang.reflect.Method;
<span class="line-removed"> 36 import java.net.URL;</span>
<span class="line-removed"> 37 import java.net.URLClassLoader;</span>
<span class="line-removed"> 38 import java.nio.file.Files;</span>
<span class="line-removed"> 39 import java.util.ArrayList;</span>
 40 import java.util.Arrays;
 41 import java.util.HashSet;
<span class="line-removed"> 42 import java.util.LinkedHashMap;</span>
<span class="line-removed"> 43 import java.util.List;</span>
<span class="line-removed"> 44 import java.util.Map;</span>
<span class="line-removed"> 45 import java.util.Objects;</span>
 46 import java.util.Set;

 47 
 48 import org.graalvm.compiler.options.OptionDescriptor;
 49 import org.graalvm.compiler.options.OptionDescriptors;
 50 import org.graalvm.compiler.options.OptionKey;
 51 import org.graalvm.compiler.options.OptionsParser;
<span class="line-modified"> 52 import org.graalvm.compiler.test.GraalTest;</span>
 53 import org.junit.Test;
 54 import org.objectweb.asm.ClassReader;
 55 import org.objectweb.asm.ClassVisitor;
 56 import org.objectweb.asm.Label;
 57 import org.objectweb.asm.MethodVisitor;
 58 import org.objectweb.asm.Opcodes;
 59 import org.objectweb.asm.Type;
 60 
 61 /**
 62  * Verifies a class declaring one or more {@linkplain OptionKey options} has a class initializer
 63  * that only initializes the option(s). This sanity check mitigates the possibility of an option
 64  * value being used before being set.
 65  */
 66 public class OptionsVerifierTest {
 67 




 68     @Test
 69     public void verifyOptions() throws IOException {
<span class="line-modified"> 70         try (Classpath cp = new Classpath()) {</span>
<span class="line-modified"> 71             HashSet&lt;Class&lt;?&gt;&gt; checked = new HashSet&lt;&gt;();</span>
<span class="line-modified"> 72             for (OptionDescriptors opts : OptionsParser.getOptionsLoader()) {</span>
<span class="line-modified"> 73                 for (OptionDescriptor desc : opts) {</span>
<span class="line-modified"> 74                     OptionsVerifier.checkClass(desc.getDeclaringClass(), desc, checked, cp);</span>
<span class="line-modified"> 75                 }</span>
<span class="line-removed"> 76             }</span>
<span class="line-removed"> 77         }</span>
<span class="line-removed"> 78     }</span>
<span class="line-removed"> 79 </span>
<span class="line-removed"> 80     static class Classpath implements AutoCloseable {</span>
<span class="line-removed"> 81         private final Map&lt;String, Object&gt; entries = new LinkedHashMap&lt;&gt;();</span>
<span class="line-removed"> 82 </span>
<span class="line-removed"> 83         Classpath() throws IOException {</span>
<span class="line-removed"> 84             List&lt;String&gt; names = new ArrayList&lt;&gt;(Arrays.asList(System.getProperty(&quot;java.class.path&quot;).split(File.pathSeparator)));</span>
<span class="line-removed"> 85             if (GraalTest.Java8OrEarlier) {</span>
<span class="line-removed"> 86                 names.addAll(Arrays.asList(System.getProperty(&quot;sun.boot.class.path&quot;).split(File.pathSeparator)));</span>
<span class="line-removed"> 87             } else {</span>
<span class="line-removed"> 88                 names.addAll(Arrays.asList(System.getProperty(&quot;jdk.module.path&quot;).split(File.pathSeparator)));</span>
<span class="line-removed"> 89             }</span>
<span class="line-removed"> 90             for (String n : names) {</span>
<span class="line-removed"> 91                 File path = new File(n);</span>
<span class="line-removed"> 92                 if (path.exists()) {</span>
<span class="line-removed"> 93                     if (path.isDirectory()) {</span>
<span class="line-removed"> 94                         entries.put(n, path);</span>
<span class="line-removed"> 95                     } else if (n.endsWith(&quot;.jar&quot;) || n.endsWith(&quot;.zip&quot;)) {</span>
<span class="line-removed"> 96                         URL url = new URL(&quot;jar&quot;, &quot;&quot;, &quot;file:&quot; + n + &quot;!/&quot;);</span>
<span class="line-removed"> 97                         entries.put(n, new URLClassLoader(new URL[]{url}));</span>
<span class="line-removed"> 98                     }</span>
<span class="line-removed"> 99                 }</span>
<span class="line-removed">100             }</span>
<span class="line-removed">101         }</span>
<span class="line-removed">102 </span>
<span class="line-removed">103         @Override</span>
<span class="line-removed">104         public void close() throws IOException {</span>
<span class="line-removed">105             for (Object e : entries.values()) {</span>
<span class="line-removed">106                 if (e instanceof URLClassLoader) {</span>
<span class="line-removed">107                     ((URLClassLoader) e).close();</span>
<span class="line-removed">108                 }</span>
<span class="line-removed">109             }</span>
<span class="line-removed">110         }</span>
<span class="line-removed">111 </span>
<span class="line-removed">112         public byte[] getInputStream(String classFilePath) throws IOException {</span>
<span class="line-removed">113             for (Object e : entries.values()) {</span>
<span class="line-removed">114                 if (e instanceof File) {</span>
<span class="line-removed">115                     File path = new File((File) e, classFilePath.replace(&#39;/&#39;, File.separatorChar));</span>
<span class="line-removed">116                     if (path.exists()) {</span>
<span class="line-removed">117                         return Files.readAllBytes(path.toPath());</span>
<span class="line-removed">118                     }</span>
<span class="line-removed">119                 } else {</span>
<span class="line-removed">120                     assert e instanceof URLClassLoader;</span>
<span class="line-removed">121                     URLClassLoader ucl = (URLClassLoader) e;</span>
<span class="line-removed">122                     try (InputStream in = ucl.getResourceAsStream(classFilePath)) {</span>
<span class="line-removed">123                         if (in != null) {</span>
<span class="line-removed">124                             ByteArrayOutputStream buffer = new ByteArrayOutputStream();</span>
<span class="line-removed">125                             int nRead;</span>
<span class="line-removed">126                             byte[] data = new byte[1024];</span>
<span class="line-removed">127                             while ((nRead = in.read(data, 0, data.length)) != -1) {</span>
<span class="line-removed">128                                 buffer.write(data, 0, nRead);</span>
<span class="line-removed">129                             }</span>
<span class="line-removed">130                             return buffer.toByteArray();</span>
<span class="line-removed">131                         }</span>
<span class="line-removed">132                     }</span>
133                 }
134             }
<span class="line-removed">135             return null;</span>
136         }
137     }
138 
139     static final class OptionsVerifier extends ClassVisitor {
140 
<span class="line-modified">141         public static void checkClass(Class&lt;?&gt; cls, OptionDescriptor option, Set&lt;Class&lt;?&gt;&gt; checked, Classpath cp) throws IOException {</span>
142             if (!checked.contains(cls)) {
143                 checked.add(cls);
144                 Class&lt;?&gt; superclass = cls.getSuperclass();
145                 if (superclass != null &amp;&amp; !superclass.equals(Object.class)) {
<span class="line-modified">146                     checkClass(superclass, option, checked, cp);</span>
147                 }
148 
<span class="line-modified">149                 String classFilePath = cls.getName().replace(&#39;.&#39;, &#39;/&#39;) + &quot;.class&quot;;</span>
<span class="line-modified">150                 ClassReader cr = new ClassReader(Objects.requireNonNull(cp.getInputStream(classFilePath), &quot;Could not find class file for &quot; + cls.getName()));</span>
151 
152                 ClassVisitor cv = new OptionsVerifier(cls, option);
153                 cr.accept(cv, 0);
154             }
155         }
156 
157         /**
158          * The option field context of the verification.
159          */
160         private final OptionDescriptor option;
161 
162         /**
163          * The class in which {@link #option} is declared or a super-class of that class. This is
164          * the class whose {@code &lt;clinit&gt;} method is being verified.
165          */
166         private final Class&lt;?&gt; cls;
167 
168         /**
169          * Source file context for error reporting.
170          */
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.core.test;
 26 
 27 import static java.lang.String.format;
 28 


 29 import java.io.IOException;

 30 import java.lang.reflect.Constructor;
 31 import java.lang.reflect.Executable;
 32 import java.lang.reflect.Method;




 33 import java.util.Arrays;
 34 import java.util.HashSet;




 35 import java.util.Set;
<span class="line-added"> 36 import java.util.TreeSet;</span>
 37 
 38 import org.graalvm.compiler.options.OptionDescriptor;
 39 import org.graalvm.compiler.options.OptionDescriptors;
 40 import org.graalvm.compiler.options.OptionKey;
 41 import org.graalvm.compiler.options.OptionsParser;
<span class="line-modified"> 42 import org.graalvm.compiler.serviceprovider.GraalServices;</span>
 43 import org.junit.Test;
 44 import org.objectweb.asm.ClassReader;
 45 import org.objectweb.asm.ClassVisitor;
 46 import org.objectweb.asm.Label;
 47 import org.objectweb.asm.MethodVisitor;
 48 import org.objectweb.asm.Opcodes;
 49 import org.objectweb.asm.Type;
 50 
 51 /**
 52  * Verifies a class declaring one or more {@linkplain OptionKey options} has a class initializer
 53  * that only initializes the option(s). This sanity check mitigates the possibility of an option
 54  * value being used before being set.
 55  */
 56 public class OptionsVerifierTest {
 57 
<span class="line-added"> 58     private static Set&lt;String&gt; WHITELIST = new TreeSet&lt;&gt;(Arrays.asList(//</span>
<span class="line-added"> 59                     // Generated options delegating default values to PolyglotCompilerOptions</span>
<span class="line-added"> 60                     &quot;org.graalvm.compiler.truffle.compiler.SharedTruffleCompilerOptions&quot;));</span>
<span class="line-added"> 61 </span>
 62     @Test
 63     public void verifyOptions() throws IOException {
<span class="line-modified"> 64         HashSet&lt;Class&lt;?&gt;&gt; checked = new HashSet&lt;&gt;();</span>
<span class="line-modified"> 65         for (OptionDescriptors opts : OptionsParser.getOptionsLoader()) {</span>
<span class="line-modified"> 66             for (OptionDescriptor desc : opts) {</span>
<span class="line-modified"> 67                 Class&lt;?&gt; descDeclaringClass = desc.getDeclaringClass();</span>
<span class="line-modified"> 68                 if (!WHITELIST.contains(descDeclaringClass.getName())) {</span>
<span class="line-modified"> 69                     OptionsVerifier.checkClass(descDeclaringClass, desc, checked);</span>

























































 70                 }
 71             }

 72         }
 73     }
 74 
 75     static final class OptionsVerifier extends ClassVisitor {
 76 
<span class="line-modified"> 77         public static void checkClass(Class&lt;?&gt; cls, OptionDescriptor option, Set&lt;Class&lt;?&gt;&gt; checked) throws IOException {</span>
 78             if (!checked.contains(cls)) {
 79                 checked.add(cls);
 80                 Class&lt;?&gt; superclass = cls.getSuperclass();
 81                 if (superclass != null &amp;&amp; !superclass.equals(Object.class)) {
<span class="line-modified"> 82                     checkClass(superclass, option, checked);</span>
 83                 }
 84 
<span class="line-modified"> 85                 GraalServices.getClassfileAsStream(cls);</span>
<span class="line-modified"> 86                 ClassReader cr = new ClassReader(GraalServices.getClassfileAsStream(cls));</span>
 87 
 88                 ClassVisitor cv = new OptionsVerifier(cls, option);
 89                 cr.accept(cv, 0);
 90             }
 91         }
 92 
 93         /**
 94          * The option field context of the verification.
 95          */
 96         private final OptionDescriptor option;
 97 
 98         /**
 99          * The class in which {@link #option} is declared or a super-class of that class. This is
100          * the class whose {@code &lt;clinit&gt;} method is being verified.
101          */
102         private final Class&lt;?&gt; cls;
103 
104         /**
105          * Source file context for error reporting.
106          */
</pre>
</td>
</tr>
</table>
<center><a href="NodePropertiesTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="PushNodesThroughPiTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>