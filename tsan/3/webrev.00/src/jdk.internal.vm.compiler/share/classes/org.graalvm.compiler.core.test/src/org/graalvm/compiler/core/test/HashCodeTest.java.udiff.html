<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/HashCodeTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GuardPrioritiesTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="HashMapGetTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/HashCodeTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,26 +22,18 @@</span>
   */
  
  
  package org.graalvm.compiler.core.test;
  
<span class="udiff-line-removed">- import java.util.HashMap;</span>
<span class="udiff-line-removed">- import java.util.List;</span>
<span class="udiff-line-removed">- </span>
  import org.graalvm.compiler.core.phases.HighTier;
  import org.graalvm.compiler.core.phases.MidTier;
  import org.graalvm.compiler.nodes.InvokeNode;
<span class="udiff-line-removed">- import org.graalvm.compiler.nodes.InvokeWithExceptionNode;</span>
  import org.graalvm.compiler.nodes.StructuredGraph;
<span class="udiff-line-removed">- import org.graalvm.compiler.nodes.extended.LoadHubNode;</span>
<span class="udiff-line-removed">- import org.graalvm.compiler.nodes.extended.LoadMethodNode;</span>
  import org.graalvm.compiler.options.OptionValues;
  import org.graalvm.compiler.phases.OptimisticOptimizations;
  import org.graalvm.compiler.phases.tiers.MidTierContext;
<span class="udiff-line-removed">- import org.graalvm.compiler.test.SubprocessUtil;</span>
  import org.junit.Assert;
<span class="udiff-line-removed">- import org.junit.Assume;</span>
  import org.junit.Test;
  
  public class HashCodeTest extends GraalCompilerTest {
  
      static class OverrideHashCode {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -79,14 +71,10 @@</span>
  
      public static final int identityHashCodeFoldSnippet01() {
          return System.identityHashCode(NonOverridingConstant);
      }
  
<span class="udiff-line-removed">-     public static final int hashCodeNoFoldOverridingSnippet01(Object o) {</span>
<span class="udiff-line-removed">-         return o.hashCode();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      public static final int identityHashCodeFoldOverridingSnippet01() {
          return System.identityHashCode(OverridingConstant);
      }
  
      public static final int dontOverrideHashCodeFinalClass(DontOverrideHashCode o) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -115,60 +103,21 @@</span>
          Assert.assertEquals(0, g.getNodes().filter(InvokeNode.class).count());
      }
  
      @Test
      public void test05() {
<span class="udiff-line-removed">-         checkForGuardedIntrinsicPattern(&quot;hashCodeNoFoldOverridingSnippet01&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         Object nullObject = null;</span>
<span class="udiff-line-removed">-         test(&quot;hashCodeNoFoldOverridingSnippet01&quot;, nullObject);</span>
<span class="udiff-line-removed">-         test(&quot;hashCodeNoFoldOverridingSnippet01&quot;, new Object());</span>
<span class="udiff-line-removed">-         test(&quot;hashCodeNoFoldOverridingSnippet01&quot;, new DontOverrideHashCode());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     public void test06() {</span>
          StructuredGraph g = buildGraphAfterMidTier(&quot;identityHashCodeFoldOverridingSnippet01&quot;);
          Assert.assertEquals(0, g.getNodes().filter(InvokeNode.class).count());
      }
  
      @Test
<span class="udiff-line-modified-removed">-     public void test07() {</span>
<span class="udiff-line-modified-added">+     public void test06() {</span>
          initialize(DontOverrideHashCode.class);
          StructuredGraph g = buildGraphAfterMidTier(&quot;dontOverrideHashCodeFinalClass&quot;);
          Assert.assertEquals(0, g.getNodes().filter(InvokeNode.class).count());
      }
  
<span class="udiff-line-removed">-     public static final int hashCodeInterface(Appendable o) {</span>
<span class="udiff-line-removed">-         return o.hashCode();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Test</span>
<span class="udiff-line-removed">-     public void test08() {</span>
<span class="udiff-line-removed">-         // This test requires profiling information which does not work reliable across platforms</span>
<span class="udiff-line-removed">-         // when running with -Xcomp</span>
<span class="udiff-line-removed">-         List&lt;String&gt; commandLine = SubprocessUtil.getVMCommandLine();</span>
<span class="udiff-line-removed">-         Assume.assumeTrue(commandLine != null);</span>
<span class="udiff-line-removed">-         Assume.assumeFalse(commandLine.contains(&quot;-Xcomp&quot;));</span>
<span class="udiff-line-removed">-         initialize(Appendable.class);</span>
<span class="udiff-line-removed">-         checkForGuardedIntrinsicPattern(&quot;hashCodeInterface&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         // Ensure the profile for the dispatch in hashCodeSnippet01</span>
<span class="udiff-line-removed">-         // has a receiver type that does not select Object.hashCode intrinsic</span>
<span class="udiff-line-removed">-         hashCodeSnippet01(new HashMap&lt;&gt;());</span>
<span class="udiff-line-removed">-         checkForGuardedIntrinsicPattern(&quot;hashCodeSnippet01&quot;);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private void checkForGuardedIntrinsicPattern(String name) {</span>
<span class="udiff-line-removed">-         StructuredGraph g = parseForCompile(getResolvedJavaMethod(name));</span>
<span class="udiff-line-removed">-         int invokeNodeCount = g.getNodes().filter(InvokeNode.class).count();</span>
<span class="udiff-line-removed">-         int invokeWithExceptionNodeCount = g.getNodes().filter(InvokeWithExceptionNode.class).count();</span>
<span class="udiff-line-removed">-         Assert.assertEquals(1, invokeNodeCount + invokeWithExceptionNodeCount);</span>
<span class="udiff-line-removed">-         Assert.assertEquals(1, g.getNodes().filter(LoadHubNode.class).count());</span>
<span class="udiff-line-removed">-         Assert.assertEquals(1, g.getNodes().filter(LoadMethodNode.class).count());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      @SuppressWarnings(&quot;try&quot;)
      private StructuredGraph buildGraphAfterMidTier(String name) {
          StructuredGraph g = parseForCompile(getResolvedJavaMethod(name));
          OptionValues options = getInitialOptions();
          new HighTier(options).apply(g, getDefaultHighTierContext());
</pre>
<center><a href="GuardPrioritiesTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="HashMapGetTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>