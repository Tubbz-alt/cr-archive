<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.test/src/org/graalvm/compiler/core/test/IfCanonicalizerTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.core.test;
 26 
 27 import org.graalvm.compiler.debug.DebugContext;
 28 import org.graalvm.compiler.graph.Node;
 29 import org.graalvm.compiler.nodes.ConstantNode;
 30 import org.graalvm.compiler.nodes.FrameState;
 31 import org.graalvm.compiler.nodes.IfNode;
 32 import org.graalvm.compiler.nodes.ParameterNode;
 33 import org.graalvm.compiler.nodes.StructuredGraph;
 34 import org.graalvm.compiler.nodes.StructuredGraph.AllowAssumptions;
 35 import org.graalvm.compiler.nodes.spi.CoreProviders;
 36 import org.graalvm.compiler.nodes.spi.LoweringTool;
 37 import org.graalvm.compiler.phases.OptimisticOptimizations;
 38 import org.graalvm.compiler.phases.common.FloatingReadPhase;
 39 import org.graalvm.compiler.phases.common.GuardLoweringPhase;
 40 import org.graalvm.compiler.phases.common.LoweringPhase;
 41 import org.graalvm.compiler.phases.tiers.MidTierContext;
 42 import org.junit.Test;
 43 
 44 /**
 45  * In the following tests, the usages of local variable &quot;a&quot; are replaced with the integer constant
 46  * 0. Then canonicalization is applied and it is verified that the resulting graph is equal to the
 47  * graph of the method that just has a &quot;return 1&quot; statement in it.
 48  */
 49 public class IfCanonicalizerTest extends GraalCompilerTest {
 50 
 51     private static final String REFERENCE_SNIPPET = &quot;referenceSnippet&quot;;
 52 
 53     @SuppressWarnings(&quot;all&quot;)
 54     public static int referenceSnippet(int a) {
 55         return 1;
 56     }
 57 
 58     @Test
 59     public void test1() {
 60         test(&quot;test1Snippet&quot;);
 61     }
 62 
 63     @SuppressWarnings(&quot;all&quot;)
 64     public static int test1Snippet(int a) {
 65         if (a == 0) {
 66             return 1;
 67         } else {
 68             return 2;
 69         }
 70     }
 71 
 72     @Test
 73     public void test2() {
 74         test(&quot;test2Snippet&quot;);
 75     }
 76 
 77     @SuppressWarnings(&quot;all&quot;)
 78     public static int test2Snippet(int a) {
 79         if (a == 0) {
 80             if (a == 0) {
 81                 if (a == 0) {
 82                     return 1;
 83                 }
 84             }
 85         } else {
 86             return 2;
 87         }
 88         return 3;
 89     }
 90 
 91     @Test
 92     public void test3() {
 93         test(&quot;test3Snippet&quot;);
 94     }
 95 
 96     @SuppressWarnings(&quot;all&quot;)
 97     public static int test3Snippet(int a) {
 98         if (a == 0) {
 99             if (a != 1) {
100                 if (a == 1) {
101                     return 3;
102                 } else {
103                     if (a &gt;= 0) {
104                         if (a &lt;= 0) {
105                             if (a &gt; -1) {
106                                 if (a &lt; 1) {
107                                     return 1;
108                                 }
109                             }
110                         }
111                     }
112                 }
113             }
114         } else {
115             return 2;
116         }
117         return 3;
118     }
119 
120     @Test
121     public void test4() {
122         test(&quot;test4Snippet&quot;);
123     }
124 
125     public static int test4Snippet(int a) {
126         if (a == 0) {
127             return 1;
128         }
129         return 1;
130     }
131 
132     @Test
133     public void test5() {
134         test(&quot;test5Snippet&quot;);
135     }
136 
137     public static int test5Snippet(int a) {
138         int val = 2;
139         if (a == 0) {
140             val = 1;
141         }
142         if (a * (3 + val) == 0) {
143             return 1;
144         }
145         return 1;
146     }
147 
148     @Test
149     public void test6() {
150         testCombinedIf(&quot;test6Snippet&quot;, 4);
151         test(&quot;test6Snippet&quot;, new int[]{0});
152     }
153 
154     public static int test6Snippet(int[] a) {
155         int i = a[0];
156         if (i &gt;= 0 &amp;&amp; i &lt; a.length) {
157             return a[i];
158         }
159         return 1;
160     }
161 
162     @Test
163     public void test7() {
164         testCombinedIf(&quot;test7Snippet&quot;, 1);
165         test(&quot;test7Snippet&quot;, -1);
166     }
167 
168     public static int test7Snippet(int v) {
169         if (v &gt;= 0 &amp;&amp; v &lt; 1024) {
170             return v + 1;
171         }
172         return v - 1;
173     }
174 
175     @Test
176     public void test8() {
177         testCombinedIf(&quot;test8Snippet&quot;, 1);
178         test(&quot;test8Snippet&quot;, -1);
179     }
180 
181     public static int test8Snippet(int v) {
182         if (v &gt;= 0 &amp;&amp; v &lt;= 1024) {
183             return v + 1;
184         }
185         return v - 1;
186     }
187 
188     @Test
189     public void test9() {
190         testCombinedIf(&quot;test9Snippet&quot;, 2);
191         test(&quot;test9Snippet&quot;, -1);
192         test(&quot;test9Snippet&quot;, 1025);
193     }
194 
195     public static int test9Snippet(int n) {
196         return (n &lt; 0) ? 1 : (n &gt;= 1024) ? 1024 : n + 1;
197     }
198 
199     @Test
200     public void test10() {
201         // Exercise NormalizeCompareNode with long values
202         test(&quot;test10Snippet&quot;, 0, 1);
203     }
204 
205     public static long test10Snippet(int x, int y) {
206         return (x &lt; y) ? -1L : ((x == y) ? 0L : 1L);
207     }
208 
209     @Test
210     public void test11() {
211         test(&quot;test11Snippet&quot;, 0, 1);
212     }
213 
214     public static long test11Snippet(int x, int y) {
215         long normalizeCompare = normalizeCompareLong(x, y);
216         if (normalizeCompare == 0) {
217             return 5;
218         }
219         return 1;
220     }
221 
222     private static Long normalizeCompareLong(int x, int y) {
223         return (x &lt; y) ? -1L : ((x == y) ? 0L : 1L);
224     }
225 
226     private void testCombinedIf(String snippet, int count) {
227         StructuredGraph graph = parseEager(snippet, AllowAssumptions.YES);
228         CoreProviders context = getProviders();
229         new LoweringPhase(createCanonicalizerPhase(), LoweringTool.StandardLoweringStage.HIGH_TIER).apply(graph, context);
230         new FloatingReadPhase().apply(graph);
231         MidTierContext midContext = new MidTierContext(getProviders(), getTargetProvider(), OptimisticOptimizations.ALL, graph.getProfilingInfo());
232         new GuardLoweringPhase().apply(graph, midContext);
233         new LoweringPhase(createCanonicalizerPhase(), LoweringTool.StandardLoweringStage.MID_TIER).apply(graph, midContext);
234         createCanonicalizerPhase().apply(graph, context);
235         assertDeepEquals(count, graph.getNodes().filter(IfNode.class).count());
236     }
237 
238     private void test(String snippet) {
239         StructuredGraph graph = parseEager(snippet, AllowAssumptions.YES);
240         DebugContext debug = graph.getDebug();
241         ParameterNode param = graph.getNodes(ParameterNode.TYPE).iterator().next();
242         ConstantNode constant = ConstantNode.forInt(0, graph);
243         for (Node n : param.usages().snapshot()) {
244             if (!(n instanceof FrameState)) {
245                 n.replaceFirstInput(param, constant);
246             }
247         }
248         debug.dump(DebugContext.BASIC_LEVEL, graph, &quot;Graph&quot;);
249         createCanonicalizerPhase().apply(graph, getProviders());
250         for (FrameState fs : param.usages().filter(FrameState.class).snapshot()) {
251             fs.replaceFirstInput(param, null);
252             param.safeDelete();
253         }
254         StructuredGraph referenceGraph = parseEager(REFERENCE_SNIPPET, AllowAssumptions.YES);
255         assertEquals(referenceGraph, graph);
256     }
257 }
    </pre>
  </body>
</html>