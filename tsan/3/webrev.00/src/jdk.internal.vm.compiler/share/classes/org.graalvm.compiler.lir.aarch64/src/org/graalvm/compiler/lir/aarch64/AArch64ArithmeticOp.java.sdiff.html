<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.lir.aarch64/src/org/graalvm/compiler/lir/aarch64/AArch64ArithmeticOp.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AArch64ArithmeticLIRGeneratorTool.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="AArch64BitManipulationOp.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.lir.aarch64/src/org/graalvm/compiler/lir/aarch64/AArch64ArithmeticOp.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 41 import org.graalvm.compiler.lir.asm.CompilationResultBuilder;
 42 
 43 import jdk.vm.ci.code.Register;
 44 import jdk.vm.ci.meta.AllocatableValue;
 45 import jdk.vm.ci.meta.JavaConstant;
 46 
 47 public enum AArch64ArithmeticOp {
 48     // TODO At least add and sub *can* be used with SP, so this should be supported
 49     NEG,
 50     NOT,
 51     ADD(ARITHMETIC),
 52     ADDS(ARITHMETIC),
 53     SUB(ARITHMETIC),
 54     SUBS(ARITHMETIC),
 55     MUL,
 56     MULVS,
 57     MNEG,
 58     DIV,
 59     SMULH,
 60     UMULH,







 61     REM,
 62     UDIV,
 63     UREM,
 64     AND(LOGICAL),
 65     ANDS(LOGICAL),
 66     OR(LOGICAL),
 67     XOR(LOGICAL),
 68     SHL(SHIFT),
 69     LSHR(SHIFT),
 70     ASHR(SHIFT),
 71     ABS,
 72 
 73     FADD,
 74     FSUB,
 75     FMUL,
 76     FDIV,
 77     FREM,
 78     FNEG,
 79     FABS,
 80     FRINTM,
</pre>
<hr />
<pre>
262                     masm.adds(size, dst, src1, src2);
263                     break;
264                 case SUB:
265                     masm.sub(size, dst, src1, src2);
266                     break;
267                 case SUBS:
268                     masm.subs(size, dst, src1, src2);
269                     break;
270                 case MUL:
271                     masm.mul(size, dst, src1, src2);
272                     break;
273                 case UMULH:
274                     masm.umulh(size, dst, src1, src2);
275                     break;
276                 case SMULH:
277                     masm.smulh(size, dst, src1, src2);
278                     break;
279                 case MNEG:
280                     masm.mneg(size, dst, src1, src2);
281                     break;






282                 case DIV:
283                     masm.sdiv(size, dst, src1, src2);
284                     break;
285                 case UDIV:
286                     masm.udiv(size, dst, src1, src2);
287                     break;
288                 case AND:
289                     masm.and(size, dst, src1, src2);
290                     break;
291                 case ANDS:
292                     masm.ands(size, dst, src1, src2);
293                     break;
294                 case OR:
295                     masm.or(size, dst, src1, src2);
296                     break;
297                 case XOR:
298                     masm.eor(size, dst, src1, src2);
299                     break;
300                 case SHL:
301                     masm.shl(size, dst, src1, src2);
</pre>
<hr />
<pre>
460             this.shiftAmt = shiftAmt;
461         }
462 
463         @Override
464         public void emitCode(CompilationResultBuilder crb, AArch64MacroAssembler masm) {
465             int size = result.getPlatformKind().getSizeInBytes() * Byte.SIZE;
466             masm.add(size, asRegister(result), asRegister(src1), asRegister(src2), extendType, shiftAmt);
467         }
468     }
469 
470     public static class MultiplyAddSubOp extends AArch64LIRInstruction {
471         private static final LIRInstructionClass&lt;MultiplyAddSubOp&gt; TYPE = LIRInstructionClass.create(MultiplyAddSubOp.class);
472 
473         @Opcode private final AArch64ArithmeticOp op;
474         @Def(REG) protected AllocatableValue result;
475         @Use(REG) protected AllocatableValue src1;
476         @Use(REG) protected AllocatableValue src2;
477         @Use(REG) protected AllocatableValue src3;
478 
479         /**
<span class="line-modified">480          * Computes &lt;code&gt;result = src3 &lt;op&gt; src1 * src2&lt;/code&gt;.</span>
481          */
482         public MultiplyAddSubOp(AArch64ArithmeticOp op, AllocatableValue result, AllocatableValue src1, AllocatableValue src2, AllocatableValue src3) {
483             super(TYPE);
<span class="line-removed">484             assert op == ADD || op == SUB;</span>
485             this.op = op;
486             this.result = result;
487             this.src1 = src1;
488             this.src2 = src2;
489             this.src3 = src3;
490         }
491 
492         @Override
493         public void emitCode(CompilationResultBuilder crb, AArch64MacroAssembler masm) {
494             int size = result.getPlatformKind().getSizeInBytes() * Byte.SIZE;
495             switch (op) {
<span class="line-modified">496                 case ADD:</span>
497                     masm.madd(size, asRegister(result), asRegister(src1), asRegister(src2), asRegister(src3));
498                     break;
<span class="line-modified">499                 case SUB:</span>
500                     masm.msub(size, asRegister(result), asRegister(src1), asRegister(src2), asRegister(src3));
501                     break;











502                 default:
503                     throw GraalError.shouldNotReachHere();
504             }
505         }
506     }
507 
508 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 41 import org.graalvm.compiler.lir.asm.CompilationResultBuilder;
 42 
 43 import jdk.vm.ci.code.Register;
 44 import jdk.vm.ci.meta.AllocatableValue;
 45 import jdk.vm.ci.meta.JavaConstant;
 46 
 47 public enum AArch64ArithmeticOp {
 48     // TODO At least add and sub *can* be used with SP, so this should be supported
 49     NEG,
 50     NOT,
 51     ADD(ARITHMETIC),
 52     ADDS(ARITHMETIC),
 53     SUB(ARITHMETIC),
 54     SUBS(ARITHMETIC),
 55     MUL,
 56     MULVS,
 57     MNEG,
 58     DIV,
 59     SMULH,
 60     UMULH,
<span class="line-added"> 61     SMULL,</span>
<span class="line-added"> 62     SMNEGL,</span>
<span class="line-added"> 63     MADD,</span>
<span class="line-added"> 64     MSUB,</span>
<span class="line-added"> 65     FMADD,</span>
<span class="line-added"> 66     SMADDL,</span>
<span class="line-added"> 67     SMSUBL,</span>
 68     REM,
 69     UDIV,
 70     UREM,
 71     AND(LOGICAL),
 72     ANDS(LOGICAL),
 73     OR(LOGICAL),
 74     XOR(LOGICAL),
 75     SHL(SHIFT),
 76     LSHR(SHIFT),
 77     ASHR(SHIFT),
 78     ABS,
 79 
 80     FADD,
 81     FSUB,
 82     FMUL,
 83     FDIV,
 84     FREM,
 85     FNEG,
 86     FABS,
 87     FRINTM,
</pre>
<hr />
<pre>
269                     masm.adds(size, dst, src1, src2);
270                     break;
271                 case SUB:
272                     masm.sub(size, dst, src1, src2);
273                     break;
274                 case SUBS:
275                     masm.subs(size, dst, src1, src2);
276                     break;
277                 case MUL:
278                     masm.mul(size, dst, src1, src2);
279                     break;
280                 case UMULH:
281                     masm.umulh(size, dst, src1, src2);
282                     break;
283                 case SMULH:
284                     masm.smulh(size, dst, src1, src2);
285                     break;
286                 case MNEG:
287                     masm.mneg(size, dst, src1, src2);
288                     break;
<span class="line-added">289                 case SMULL:</span>
<span class="line-added">290                     masm.smull(size, dst, src1, src2);</span>
<span class="line-added">291                     break;</span>
<span class="line-added">292                 case SMNEGL:</span>
<span class="line-added">293                     masm.smnegl(size, dst, src1, src2);</span>
<span class="line-added">294                     break;</span>
295                 case DIV:
296                     masm.sdiv(size, dst, src1, src2);
297                     break;
298                 case UDIV:
299                     masm.udiv(size, dst, src1, src2);
300                     break;
301                 case AND:
302                     masm.and(size, dst, src1, src2);
303                     break;
304                 case ANDS:
305                     masm.ands(size, dst, src1, src2);
306                     break;
307                 case OR:
308                     masm.or(size, dst, src1, src2);
309                     break;
310                 case XOR:
311                     masm.eor(size, dst, src1, src2);
312                     break;
313                 case SHL:
314                     masm.shl(size, dst, src1, src2);
</pre>
<hr />
<pre>
473             this.shiftAmt = shiftAmt;
474         }
475 
476         @Override
477         public void emitCode(CompilationResultBuilder crb, AArch64MacroAssembler masm) {
478             int size = result.getPlatformKind().getSizeInBytes() * Byte.SIZE;
479             masm.add(size, asRegister(result), asRegister(src1), asRegister(src2), extendType, shiftAmt);
480         }
481     }
482 
483     public static class MultiplyAddSubOp extends AArch64LIRInstruction {
484         private static final LIRInstructionClass&lt;MultiplyAddSubOp&gt; TYPE = LIRInstructionClass.create(MultiplyAddSubOp.class);
485 
486         @Opcode private final AArch64ArithmeticOp op;
487         @Def(REG) protected AllocatableValue result;
488         @Use(REG) protected AllocatableValue src1;
489         @Use(REG) protected AllocatableValue src2;
490         @Use(REG) protected AllocatableValue src3;
491 
492         /**
<span class="line-modified">493          * Computes &lt;code&gt;result = src3 +/- src1 * src2&lt;/code&gt;.</span>
494          */
495         public MultiplyAddSubOp(AArch64ArithmeticOp op, AllocatableValue result, AllocatableValue src1, AllocatableValue src2, AllocatableValue src3) {
496             super(TYPE);

497             this.op = op;
498             this.result = result;
499             this.src1 = src1;
500             this.src2 = src2;
501             this.src3 = src3;
502         }
503 
504         @Override
505         public void emitCode(CompilationResultBuilder crb, AArch64MacroAssembler masm) {
506             int size = result.getPlatformKind().getSizeInBytes() * Byte.SIZE;
507             switch (op) {
<span class="line-modified">508                 case MADD:</span>
509                     masm.madd(size, asRegister(result), asRegister(src1), asRegister(src2), asRegister(src3));
510                     break;
<span class="line-modified">511                 case MSUB:</span>
512                     masm.msub(size, asRegister(result), asRegister(src1), asRegister(src2), asRegister(src3));
513                     break;
<span class="line-added">514                 case FMADD:</span>
<span class="line-added">515                     masm.fmadd(size, asRegister(result), asRegister(src1), asRegister(src2), asRegister(src3));</span>
<span class="line-added">516                     break;</span>
<span class="line-added">517                 case SMADDL:</span>
<span class="line-added">518                     assert size == 64;</span>
<span class="line-added">519                     masm.smaddl(size, asRegister(result), asRegister(src1), asRegister(src2), asRegister(src3));</span>
<span class="line-added">520                     break;</span>
<span class="line-added">521                 case SMSUBL:</span>
<span class="line-added">522                     assert size == 64;</span>
<span class="line-added">523                     masm.smsubl(size, asRegister(result), asRegister(src1), asRegister(src2), asRegister(src3));</span>
<span class="line-added">524                     break;</span>
525                 default:
526                     throw GraalError.shouldNotReachHere();
527             }
528         }
529     }
530 
531 }
</pre>
</td>
</tr>
</table>
<center><a href="AArch64ArithmeticLIRGeneratorTool.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="AArch64BitManipulationOp.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>