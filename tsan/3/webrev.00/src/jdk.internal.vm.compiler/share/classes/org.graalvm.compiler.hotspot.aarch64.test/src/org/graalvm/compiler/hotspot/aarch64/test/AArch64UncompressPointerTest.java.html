<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.aarch64.test/src/org/graalvm/compiler/hotspot/aarch64/test/AArch64UncompressPointerTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * Copyright (c) 2019, Arm Limited and affiliates. All rights reserved.
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
 23  */
 24 
 25 
 26 
 27 package org.graalvm.compiler.hotspot.aarch64.test;
 28 
 29 import jdk.vm.ci.aarch64.AArch64;
 30 import jdk.vm.ci.code.Register;
 31 import jdk.vm.ci.code.TargetDescription;
 32 import jdk.vm.ci.runtime.JVMCI;
 33 import org.graalvm.compiler.asm.aarch64.AArch64Assembler;
 34 import org.graalvm.compiler.asm.aarch64.AArch64MacroAssembler;
 35 import org.graalvm.compiler.core.test.GraalCompilerTest;
 36 import org.graalvm.compiler.hotspot.aarch64.AArch64HotSpotMove;
 37 import org.junit.Before;
 38 import org.junit.Test;
 39 
 40 import static org.junit.Assert.assertArrayEquals;
 41 import static org.junit.Assume.assumeTrue;
 42 
 43 public class AArch64UncompressPointerTest extends GraalCompilerTest {
 44 
 45     private AArch64MacroAssembler masm1;
 46     private AArch64MacroAssembler masm2;
 47     private Register input;
 48     private Register result;
 49 
 50     @Before
 51     public void checkAArch64() {
 52         assumeTrue(&quot;skipping AArch64 specific test&quot;, JVMCI.getRuntime().getHostJVMCIBackend().getTarget().arch instanceof AArch64);
 53     }
 54 
 55     @Before
 56     public void setupEnvironment() {
 57         TargetDescription target = JVMCI.getRuntime().getHostJVMCIBackend().getTarget();
 58         masm1 = new AArch64MacroAssembler(target);
 59         masm2 = new AArch64MacroAssembler(target);
 60         input = AArch64.r10;
 61         result = AArch64.r11;
 62     }
 63 
 64     private void emitUncompressPointer(Register base, int shift) {
 65         AArch64HotSpotMove.UncompressPointer.emitUncompressCode(masm2, input, result, base, shift, true);
 66     }
 67 
 68     private void compareAssembly() {
 69         byte[] expected = masm1.close(false);
 70         byte[] actual = masm2.close(false);
 71         assertArrayEquals(expected, actual);
 72     }
 73 
 74     @Test
 75     public void testUncompressPointerWithBase() {
 76         Register base = AArch64.r12;
 77         int shift = 3;
 78         masm1.add(64, result, base, input, AArch64Assembler.ShiftType.LSL, shift);
 79         emitUncompressPointer(base, shift);
 80         compareAssembly();
 81     }
 82 
 83     @Test
 84     public void testUncompressPointerWithZeroBase() {
 85         int shift = 3;
 86         masm1.shl(64, result, input, shift);
 87         emitUncompressPointer(null, shift);
 88         compareAssembly();
 89     }
 90 
 91     @Test
 92     public void testUncompressPointerWithZeroBaseAndShift() {
 93         masm1.or(64, result, AArch64.zr, input);
 94         emitUncompressPointer(null, 0);
 95         compareAssembly();
 96     }
 97 
 98     static class A {
 99         String str;
100 
101         A(String str) {
102             this.str = str;
103         }
104     }
105 
106     public static String getObjectField(A a) {
107         return a.str;
108     }
109 
110     @Test
111     public void testGetObjectField() {
112         test(&quot;getObjectField&quot;, new A(&quot;asfghjkjhgfd&quot;));
113     }
114 
115     static String[] strings = {&quot;asf&quot;, &quot;egfda&quot;, &quot;fsdasere&quot;, &quot;eqwred&quot;, &quot;fgdadgtre&quot;, &quot;qwrrtreety&quot;};
116 
117     public static String getArrayMember(int index) {
118         return strings[index];
119     }
120 
121     @Test
122     public void testGetArrayMember() {
123         test(&quot;getArrayMember&quot;, 4);
124     }
125 }
    </pre>
  </body>
</html>