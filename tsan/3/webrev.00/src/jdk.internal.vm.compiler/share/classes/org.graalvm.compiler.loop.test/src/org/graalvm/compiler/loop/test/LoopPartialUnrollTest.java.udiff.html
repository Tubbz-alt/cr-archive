<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.loop.test/src/org/graalvm/compiler/loop/test/LoopPartialUnrollTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../org.graalvm.compiler.loop.phases/src/org/graalvm/compiler/loop/phases/LoopTransformations.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../org.graalvm.compiler.loop/src/org/graalvm/compiler/loop/CountedLoopInfo.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.loop.test/src/org/graalvm/compiler/loop/test/LoopPartialUnrollTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -24,11 +24,13 @@</span>
  
  package org.graalvm.compiler.loop.test;
  
  import java.util.ListIterator;
  
<span class="udiff-line-added">+ import org.graalvm.compiler.api.directives.GraalDirectives;</span>
  import org.graalvm.compiler.core.common.CompilationIdentifier;
<span class="udiff-line-added">+ import org.graalvm.compiler.core.common.GraalOptions;</span>
  import org.graalvm.compiler.core.test.GraalCompilerTest;
  import org.graalvm.compiler.debug.DebugContext;
  import org.graalvm.compiler.graph.iterators.NodeIterable;
  import org.graalvm.compiler.java.ComputeLoopFrequenciesClosure;
  import org.graalvm.compiler.loop.DefaultLoopPolicies;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -60,18 +62,18 @@</span>
  import jdk.vm.ci.meta.ResolvedJavaMethod;
  
  public class LoopPartialUnrollTest extends GraalCompilerTest {
  
      @Override
<span class="udiff-line-modified-removed">-     protected boolean checkMidTierGraph(StructuredGraph graph) {</span>
<span class="udiff-line-modified-added">+     protected void checkMidTierGraph(StructuredGraph graph) {</span>
          NodeIterable&lt;LoopBeginNode&gt; loops = graph.getNodes().filter(LoopBeginNode.class);
          for (LoopBeginNode loop : loops) {
              if (loop.isMainLoop()) {
<span class="udiff-line-modified-removed">-                 return true;</span>
<span class="udiff-line-modified-added">+                 return;</span>
              }
          }
<span class="udiff-line-modified-removed">-         return false;</span>
<span class="udiff-line-modified-added">+         fail(&quot;expected a main loop&quot;);</span>
      }
  
      public static long sumWithEqualityLimit(int[] text) {
          long sum = 0;
          for (int i = 0; branchProbability(0.99, i != text.length); ++i) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -138,10 +140,39 @@</span>
          }
  
          return c;
      }
  
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     @Ignore</span>
<span class="udiff-line-added">+     public void testUnsignedLoopCarried() {</span>
<span class="udiff-line-added">+         for (int i = -1; i &lt; 64; i++) {</span>
<span class="udiff-line-added">+             for (int j = 0; j &lt; 64; j++) {</span>
<span class="udiff-line-added">+                 test(&quot;testUnsignedLoopCarriedSnippet&quot;, i, j);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         test(&quot;testUnsignedLoopCarriedSnippet&quot;, -1 - 32, -1);</span>
<span class="udiff-line-added">+         test(&quot;testUnsignedLoopCarriedSnippet&quot;, -1 - 4, -1);</span>
<span class="udiff-line-added">+         test(&quot;testUnsignedLoopCarriedSnippet&quot;, -1 - 32, 0);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static int testUnsignedLoopCarriedSnippet(int start, int end) {</span>
<span class="udiff-line-added">+         int a = 0;</span>
<span class="udiff-line-added">+         int b = 0;</span>
<span class="udiff-line-added">+         int c = 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         for (int i = start; branchProbability(0.99, Integer.compareUnsigned(i, end) &lt; 0); i++) {</span>
<span class="udiff-line-added">+             int t1 = volatileInt;</span>
<span class="udiff-line-added">+             int t2 = a + b;</span>
<span class="udiff-line-added">+             c = b;</span>
<span class="udiff-line-added">+             b = a;</span>
<span class="udiff-line-added">+             a = t1 + t2;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return c;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      @Test
      public void testLoopCarried2() {
          for (int i = -1; i &lt; 64; i++) {
              for (int j = -1; j &lt; 64; j++) {
                  test(&quot;testLoopCarried2Snippet&quot;, i, j);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -214,10 +245,29 @@</span>
      @Test
      public void testSignExtension() {
          test(&quot;testSignExtensionSnippet&quot;, 9L);
      }
  
<span class="udiff-line-added">+     public static Object objectPhi(int n) {</span>
<span class="udiff-line-added">+         Integer v = Integer.valueOf(200);</span>
<span class="udiff-line-added">+         GraalDirectives.blackhole(v); // Prevents PEA</span>
<span class="udiff-line-added">+         Integer r = 1;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         for (int i = 0; iterationCount(100, i &lt; n); i++) {</span>
<span class="udiff-line-added">+             GraalDirectives.blackhole(r); // Create a phi of two loop invariants</span>
<span class="udiff-line-added">+             r = v;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return r;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testObjectPhi() {</span>
<span class="udiff-line-added">+         OptionValues options = new OptionValues(getInitialOptions(), GraalOptions.LoopPeeling, false);</span>
<span class="udiff-line-added">+         test(options, &quot;objectPhi&quot;, 1);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      @Override
      protected Suites createSuites(OptionValues opts) {
          Suites suites = super.createSuites(opts).copy();
          PhaseSuite&lt;MidTierContext&gt; mid = suites.getMidTier();
          ListIterator&lt;BasePhase&lt;? super MidTierContext&gt;&gt; iter = mid.findPhase(LoopPartialUnrollPhase.class);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -250,11 +300,11 @@</span>
          OptionValues options = new OptionValues(getInitialOptions(), DefaultLoopPolicies.Options.UnrollMaxIterations, 2);
          StructuredGraph graph = parse(builder(method, StructuredGraph.AllowAssumptions.YES, id, options), getEagerGraphBuilderSuite());
          try (DebugContext.Scope buildScope = graph.getDebug().scope(name, method, graph)) {
              MidTierContext context = new MidTierContext(getProviders(), getTargetProvider(), OptimisticOptimizations.ALL, null);
  
<span class="udiff-line-modified-removed">-             CanonicalizerPhase canonicalizer = new CanonicalizerPhase();</span>
<span class="udiff-line-modified-added">+             CanonicalizerPhase canonicalizer = this.createCanonicalizerPhase();</span>
              canonicalizer.apply(graph, context);
              new RemoveValueProxyPhase().apply(graph);
              new LoweringPhase(canonicalizer, LoweringTool.StandardLoweringStage.HIGH_TIER).apply(graph, context);
              new FloatingReadPhase().apply(graph);
              new DeadCodeEliminationPhase().apply(graph);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -286,11 +336,11 @@</span>
  
      public void testDuplicateBody(String reference, String test) {
  
          StructuredGraph referenceGraph = buildGraph(reference, false);
          StructuredGraph testGraph = buildGraph(test, true);
<span class="udiff-line-modified-removed">-         CanonicalizerPhase canonicalizer = new CanonicalizerPhase();</span>
<span class="udiff-line-modified-added">+         CanonicalizerPhase canonicalizer = createCanonicalizerPhase();</span>
          canonicalizer.apply(testGraph, getDefaultMidTierContext());
          canonicalizer.apply(referenceGraph, getDefaultMidTierContext());
          assertEquals(referenceGraph, testGraph);
      }
  }
</pre>
<center><a href="../../../../../../../org.graalvm.compiler.loop.phases/src/org/graalvm/compiler/loop/phases/LoopTransformations.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../org.graalvm.compiler.loop/src/org/graalvm/compiler/loop/CountedLoopInfo.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>