<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.loop.test/src/org/graalvm/compiler/loop/test/LoopPartialUnrollTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../org.graalvm.compiler.loop.phases/src/org/graalvm/compiler/loop/phases/LoopTransformations.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../org.graalvm.compiler.loop/src/org/graalvm/compiler/loop/CountedLoopInfo.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.loop.test/src/org/graalvm/compiler/loop/test/LoopPartialUnrollTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.loop.test;
 26 
 27 import java.util.ListIterator;
 28 

 29 import org.graalvm.compiler.core.common.CompilationIdentifier;

 30 import org.graalvm.compiler.core.test.GraalCompilerTest;
 31 import org.graalvm.compiler.debug.DebugContext;
 32 import org.graalvm.compiler.graph.iterators.NodeIterable;
 33 import org.graalvm.compiler.java.ComputeLoopFrequenciesClosure;
 34 import org.graalvm.compiler.loop.DefaultLoopPolicies;
 35 import org.graalvm.compiler.loop.LoopEx;
 36 import org.graalvm.compiler.loop.LoopFragmentInside;
 37 import org.graalvm.compiler.loop.LoopsData;
 38 import org.graalvm.compiler.loop.phases.LoopPartialUnrollPhase;
 39 import org.graalvm.compiler.nodes.LoopBeginNode;
 40 import org.graalvm.compiler.nodes.StructuredGraph;
 41 import org.graalvm.compiler.nodes.spi.LoweringTool;
 42 import org.graalvm.compiler.options.OptionValues;
 43 import org.graalvm.compiler.phases.BasePhase;
 44 import org.graalvm.compiler.phases.OptimisticOptimizations;
 45 import org.graalvm.compiler.phases.PhaseSuite;
 46 import org.graalvm.compiler.phases.common.CanonicalizerPhase;
 47 import org.graalvm.compiler.phases.common.ConditionalEliminationPhase;
 48 import org.graalvm.compiler.phases.common.DeadCodeEliminationPhase;
 49 import org.graalvm.compiler.phases.common.DeoptimizationGroupingPhase;
 50 import org.graalvm.compiler.phases.common.FloatingReadPhase;
 51 import org.graalvm.compiler.phases.common.FrameStateAssignmentPhase;
 52 import org.graalvm.compiler.phases.common.GuardLoweringPhase;
 53 import org.graalvm.compiler.phases.common.LoweringPhase;
 54 import org.graalvm.compiler.phases.common.RemoveValueProxyPhase;
 55 import org.graalvm.compiler.phases.tiers.MidTierContext;
 56 import org.graalvm.compiler.phases.tiers.Suites;
 57 import org.junit.Ignore;
 58 import org.junit.Test;
 59 
 60 import jdk.vm.ci.meta.ResolvedJavaMethod;
 61 
 62 public class LoopPartialUnrollTest extends GraalCompilerTest {
 63 
 64     @Override
<span class="line-modified"> 65     protected boolean checkMidTierGraph(StructuredGraph graph) {</span>
 66         NodeIterable&lt;LoopBeginNode&gt; loops = graph.getNodes().filter(LoopBeginNode.class);
 67         for (LoopBeginNode loop : loops) {
 68             if (loop.isMainLoop()) {
<span class="line-modified"> 69                 return true;</span>
 70             }
 71         }
<span class="line-modified"> 72         return false;</span>
 73     }
 74 
 75     public static long sumWithEqualityLimit(int[] text) {
 76         long sum = 0;
 77         for (int i = 0; branchProbability(0.99, i != text.length); ++i) {
 78             sum += volatileInt;
 79         }
 80         return sum;
 81     }
 82 
 83     @Ignore(&quot;equality limits aren&#39;t working properly&quot;)
 84     @Test
 85     public void testSumWithEqualityLimit() {
 86         for (int i = -1; i &lt; 128; i++) {
 87             int[] data = new int[i];
 88             test(&quot;sumWithEqualityLimit&quot;, data);
 89         }
 90     }
 91 
 92     @Test
</pre>
<hr />
<pre>
123         int a = 0;
124         int b = 0;
125         int c = 0;
126 
127         for (int i = 0; branchProbability(0.99, i &lt; iterations); i += 2) {
128             int t1 = volatileInt;
129             int t2 = a + b;
130             c = b;
131             b = a;
132             a = t1 + t2;
133             t1 = volatileInt;
134             t2 = a + b;
135             c = b;
136             b = a;
137             a = t1 + t2;
138         }
139 
140         return c;
141     }
142 





























143     @Test
144     public void testLoopCarried2() {
145         for (int i = -1; i &lt; 64; i++) {
146             for (int j = -1; j &lt; 64; j++) {
147                 test(&quot;testLoopCarried2Snippet&quot;, i, j);
148             }
149         }
150         test(&quot;testLoopCarried2Snippet&quot;, Integer.MAX_VALUE - 32, Integer.MAX_VALUE);
151         test(&quot;testLoopCarried2Snippet&quot;, Integer.MAX_VALUE - 4, Integer.MAX_VALUE);
152         test(&quot;testLoopCarried2Snippet&quot;, Integer.MAX_VALUE, 0);
153         test(&quot;testLoopCarried2Snippet&quot;, Integer.MIN_VALUE, Integer.MIN_VALUE + 32);
154         test(&quot;testLoopCarried2Snippet&quot;, Integer.MIN_VALUE, Integer.MIN_VALUE + 4);
155         test(&quot;testLoopCarried2Snippet&quot;, 0, Integer.MIN_VALUE);
156     }
157 
158     public static int testLoopCarried2Snippet(int start, int end) {
159         int a = 0;
160         int b = 0;
161         int c = 0;
162 
</pre>
<hr />
<pre>
199             test(&quot;testComplexSnippet&quot;, i);
200         }
201         test(&quot;testComplexSnippet&quot;, 10);
202         test(&quot;testComplexSnippet&quot;, 100);
203         test(&quot;testComplexSnippet&quot;, 1000);
204     }
205 
206     public static long testSignExtensionSnippet(long arg) {
207         long r = 1;
208         for (int i = 0; branchProbability(0.99, i &lt; arg); i++) {
209             r *= i;
210         }
211         return r;
212     }
213 
214     @Test
215     public void testSignExtension() {
216         test(&quot;testSignExtensionSnippet&quot;, 9L);
217     }
218 



















219     @Override
220     protected Suites createSuites(OptionValues opts) {
221         Suites suites = super.createSuites(opts).copy();
222         PhaseSuite&lt;MidTierContext&gt; mid = suites.getMidTier();
223         ListIterator&lt;BasePhase&lt;? super MidTierContext&gt;&gt; iter = mid.findPhase(LoopPartialUnrollPhase.class);
224         BasePhase&lt;? super MidTierContext&gt; partialUnoll = iter.previous();
225         if (iter.previous().getClass() != FrameStateAssignmentPhase.class) {
226             // Ensure LoopPartialUnrollPhase runs immediately after FrameStateAssignment, so it gets
227             // priority over other optimizations in these tests.
228             mid.findPhase(LoopPartialUnrollPhase.class).remove();
229             ListIterator&lt;BasePhase&lt;? super MidTierContext&gt;&gt; fsa = mid.findPhase(FrameStateAssignmentPhase.class);
230             fsa.add(partialUnoll);
231         }
232         return suites;
233     }
234 
235     public void testGraph(String reference, String test) {
236         StructuredGraph referenceGraph = buildGraph(reference, false);
237         StructuredGraph testGraph = buildGraph(test, true);
238         assertEquals(referenceGraph, testGraph, false, false);
239     }
240 
241     @SuppressWarnings(&quot;try&quot;)
242     public StructuredGraph buildGraph(String name, boolean partialUnroll) {
243         CompilationIdentifier id = new CompilationIdentifier() {
244             @Override
245             public String toString(Verbosity verbosity) {
246                 return name;
247             }
248         };
249         ResolvedJavaMethod method = getResolvedJavaMethod(name);
250         OptionValues options = new OptionValues(getInitialOptions(), DefaultLoopPolicies.Options.UnrollMaxIterations, 2);
251         StructuredGraph graph = parse(builder(method, StructuredGraph.AllowAssumptions.YES, id, options), getEagerGraphBuilderSuite());
252         try (DebugContext.Scope buildScope = graph.getDebug().scope(name, method, graph)) {
253             MidTierContext context = new MidTierContext(getProviders(), getTargetProvider(), OptimisticOptimizations.ALL, null);
254 
<span class="line-modified">255             CanonicalizerPhase canonicalizer = new CanonicalizerPhase();</span>
256             canonicalizer.apply(graph, context);
257             new RemoveValueProxyPhase().apply(graph);
258             new LoweringPhase(canonicalizer, LoweringTool.StandardLoweringStage.HIGH_TIER).apply(graph, context);
259             new FloatingReadPhase().apply(graph);
260             new DeadCodeEliminationPhase().apply(graph);
261             new ConditionalEliminationPhase(true).apply(graph, context);
262             ComputeLoopFrequenciesClosure.compute(graph);
263             new GuardLoweringPhase().apply(graph, context);
264             new LoweringPhase(canonicalizer, LoweringTool.StandardLoweringStage.MID_TIER).apply(graph, context);
265             new FrameStateAssignmentPhase().apply(graph);
266             new DeoptimizationGroupingPhase().apply(graph, context);
267             canonicalizer.apply(graph, context);
268             new ConditionalEliminationPhase(true).apply(graph, context);
269             if (partialUnroll) {
270                 LoopsData dataCounted = new LoopsData(graph);
271                 dataCounted.detectedCountedLoops();
272                 for (LoopEx loop : dataCounted.countedLoops()) {
273                     LoopFragmentInside newSegment = loop.inside().duplicate();
274                     newSegment.insertWithinAfter(loop, null);
275                 }
276                 canonicalizer.apply(graph, getDefaultMidTierContext());
277             }
278             new DeadCodeEliminationPhase().apply(graph);
279             canonicalizer.apply(graph, context);
280             graph.getDebug().dump(DebugContext.BASIC_LEVEL, graph, &quot;before compare&quot;);
281             return graph;
282         } catch (Throwable e) {
283             throw getDebugContext().handle(e);
284         }
285     }
286 
287     public void testDuplicateBody(String reference, String test) {
288 
289         StructuredGraph referenceGraph = buildGraph(reference, false);
290         StructuredGraph testGraph = buildGraph(test, true);
<span class="line-modified">291         CanonicalizerPhase canonicalizer = new CanonicalizerPhase();</span>
292         canonicalizer.apply(testGraph, getDefaultMidTierContext());
293         canonicalizer.apply(referenceGraph, getDefaultMidTierContext());
294         assertEquals(referenceGraph, testGraph);
295     }
296 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.loop.test;
 26 
 27 import java.util.ListIterator;
 28 
<span class="line-added"> 29 import org.graalvm.compiler.api.directives.GraalDirectives;</span>
 30 import org.graalvm.compiler.core.common.CompilationIdentifier;
<span class="line-added"> 31 import org.graalvm.compiler.core.common.GraalOptions;</span>
 32 import org.graalvm.compiler.core.test.GraalCompilerTest;
 33 import org.graalvm.compiler.debug.DebugContext;
 34 import org.graalvm.compiler.graph.iterators.NodeIterable;
 35 import org.graalvm.compiler.java.ComputeLoopFrequenciesClosure;
 36 import org.graalvm.compiler.loop.DefaultLoopPolicies;
 37 import org.graalvm.compiler.loop.LoopEx;
 38 import org.graalvm.compiler.loop.LoopFragmentInside;
 39 import org.graalvm.compiler.loop.LoopsData;
 40 import org.graalvm.compiler.loop.phases.LoopPartialUnrollPhase;
 41 import org.graalvm.compiler.nodes.LoopBeginNode;
 42 import org.graalvm.compiler.nodes.StructuredGraph;
 43 import org.graalvm.compiler.nodes.spi.LoweringTool;
 44 import org.graalvm.compiler.options.OptionValues;
 45 import org.graalvm.compiler.phases.BasePhase;
 46 import org.graalvm.compiler.phases.OptimisticOptimizations;
 47 import org.graalvm.compiler.phases.PhaseSuite;
 48 import org.graalvm.compiler.phases.common.CanonicalizerPhase;
 49 import org.graalvm.compiler.phases.common.ConditionalEliminationPhase;
 50 import org.graalvm.compiler.phases.common.DeadCodeEliminationPhase;
 51 import org.graalvm.compiler.phases.common.DeoptimizationGroupingPhase;
 52 import org.graalvm.compiler.phases.common.FloatingReadPhase;
 53 import org.graalvm.compiler.phases.common.FrameStateAssignmentPhase;
 54 import org.graalvm.compiler.phases.common.GuardLoweringPhase;
 55 import org.graalvm.compiler.phases.common.LoweringPhase;
 56 import org.graalvm.compiler.phases.common.RemoveValueProxyPhase;
 57 import org.graalvm.compiler.phases.tiers.MidTierContext;
 58 import org.graalvm.compiler.phases.tiers.Suites;
 59 import org.junit.Ignore;
 60 import org.junit.Test;
 61 
 62 import jdk.vm.ci.meta.ResolvedJavaMethod;
 63 
 64 public class LoopPartialUnrollTest extends GraalCompilerTest {
 65 
 66     @Override
<span class="line-modified"> 67     protected void checkMidTierGraph(StructuredGraph graph) {</span>
 68         NodeIterable&lt;LoopBeginNode&gt; loops = graph.getNodes().filter(LoopBeginNode.class);
 69         for (LoopBeginNode loop : loops) {
 70             if (loop.isMainLoop()) {
<span class="line-modified"> 71                 return;</span>
 72             }
 73         }
<span class="line-modified"> 74         fail(&quot;expected a main loop&quot;);</span>
 75     }
 76 
 77     public static long sumWithEqualityLimit(int[] text) {
 78         long sum = 0;
 79         for (int i = 0; branchProbability(0.99, i != text.length); ++i) {
 80             sum += volatileInt;
 81         }
 82         return sum;
 83     }
 84 
 85     @Ignore(&quot;equality limits aren&#39;t working properly&quot;)
 86     @Test
 87     public void testSumWithEqualityLimit() {
 88         for (int i = -1; i &lt; 128; i++) {
 89             int[] data = new int[i];
 90             test(&quot;sumWithEqualityLimit&quot;, data);
 91         }
 92     }
 93 
 94     @Test
</pre>
<hr />
<pre>
125         int a = 0;
126         int b = 0;
127         int c = 0;
128 
129         for (int i = 0; branchProbability(0.99, i &lt; iterations); i += 2) {
130             int t1 = volatileInt;
131             int t2 = a + b;
132             c = b;
133             b = a;
134             a = t1 + t2;
135             t1 = volatileInt;
136             t2 = a + b;
137             c = b;
138             b = a;
139             a = t1 + t2;
140         }
141 
142         return c;
143     }
144 
<span class="line-added">145     @Test</span>
<span class="line-added">146     @Ignore</span>
<span class="line-added">147     public void testUnsignedLoopCarried() {</span>
<span class="line-added">148         for (int i = -1; i &lt; 64; i++) {</span>
<span class="line-added">149             for (int j = 0; j &lt; 64; j++) {</span>
<span class="line-added">150                 test(&quot;testUnsignedLoopCarriedSnippet&quot;, i, j);</span>
<span class="line-added">151             }</span>
<span class="line-added">152         }</span>
<span class="line-added">153         test(&quot;testUnsignedLoopCarriedSnippet&quot;, -1 - 32, -1);</span>
<span class="line-added">154         test(&quot;testUnsignedLoopCarriedSnippet&quot;, -1 - 4, -1);</span>
<span class="line-added">155         test(&quot;testUnsignedLoopCarriedSnippet&quot;, -1 - 32, 0);</span>
<span class="line-added">156     }</span>
<span class="line-added">157 </span>
<span class="line-added">158     public static int testUnsignedLoopCarriedSnippet(int start, int end) {</span>
<span class="line-added">159         int a = 0;</span>
<span class="line-added">160         int b = 0;</span>
<span class="line-added">161         int c = 0;</span>
<span class="line-added">162 </span>
<span class="line-added">163         for (int i = start; branchProbability(0.99, Integer.compareUnsigned(i, end) &lt; 0); i++) {</span>
<span class="line-added">164             int t1 = volatileInt;</span>
<span class="line-added">165             int t2 = a + b;</span>
<span class="line-added">166             c = b;</span>
<span class="line-added">167             b = a;</span>
<span class="line-added">168             a = t1 + t2;</span>
<span class="line-added">169         }</span>
<span class="line-added">170 </span>
<span class="line-added">171         return c;</span>
<span class="line-added">172     }</span>
<span class="line-added">173 </span>
174     @Test
175     public void testLoopCarried2() {
176         for (int i = -1; i &lt; 64; i++) {
177             for (int j = -1; j &lt; 64; j++) {
178                 test(&quot;testLoopCarried2Snippet&quot;, i, j);
179             }
180         }
181         test(&quot;testLoopCarried2Snippet&quot;, Integer.MAX_VALUE - 32, Integer.MAX_VALUE);
182         test(&quot;testLoopCarried2Snippet&quot;, Integer.MAX_VALUE - 4, Integer.MAX_VALUE);
183         test(&quot;testLoopCarried2Snippet&quot;, Integer.MAX_VALUE, 0);
184         test(&quot;testLoopCarried2Snippet&quot;, Integer.MIN_VALUE, Integer.MIN_VALUE + 32);
185         test(&quot;testLoopCarried2Snippet&quot;, Integer.MIN_VALUE, Integer.MIN_VALUE + 4);
186         test(&quot;testLoopCarried2Snippet&quot;, 0, Integer.MIN_VALUE);
187     }
188 
189     public static int testLoopCarried2Snippet(int start, int end) {
190         int a = 0;
191         int b = 0;
192         int c = 0;
193 
</pre>
<hr />
<pre>
230             test(&quot;testComplexSnippet&quot;, i);
231         }
232         test(&quot;testComplexSnippet&quot;, 10);
233         test(&quot;testComplexSnippet&quot;, 100);
234         test(&quot;testComplexSnippet&quot;, 1000);
235     }
236 
237     public static long testSignExtensionSnippet(long arg) {
238         long r = 1;
239         for (int i = 0; branchProbability(0.99, i &lt; arg); i++) {
240             r *= i;
241         }
242         return r;
243     }
244 
245     @Test
246     public void testSignExtension() {
247         test(&quot;testSignExtensionSnippet&quot;, 9L);
248     }
249 
<span class="line-added">250     public static Object objectPhi(int n) {</span>
<span class="line-added">251         Integer v = Integer.valueOf(200);</span>
<span class="line-added">252         GraalDirectives.blackhole(v); // Prevents PEA</span>
<span class="line-added">253         Integer r = 1;</span>
<span class="line-added">254 </span>
<span class="line-added">255         for (int i = 0; iterationCount(100, i &lt; n); i++) {</span>
<span class="line-added">256             GraalDirectives.blackhole(r); // Create a phi of two loop invariants</span>
<span class="line-added">257             r = v;</span>
<span class="line-added">258         }</span>
<span class="line-added">259 </span>
<span class="line-added">260         return r;</span>
<span class="line-added">261     }</span>
<span class="line-added">262 </span>
<span class="line-added">263     @Test</span>
<span class="line-added">264     public void testObjectPhi() {</span>
<span class="line-added">265         OptionValues options = new OptionValues(getInitialOptions(), GraalOptions.LoopPeeling, false);</span>
<span class="line-added">266         test(options, &quot;objectPhi&quot;, 1);</span>
<span class="line-added">267     }</span>
<span class="line-added">268 </span>
269     @Override
270     protected Suites createSuites(OptionValues opts) {
271         Suites suites = super.createSuites(opts).copy();
272         PhaseSuite&lt;MidTierContext&gt; mid = suites.getMidTier();
273         ListIterator&lt;BasePhase&lt;? super MidTierContext&gt;&gt; iter = mid.findPhase(LoopPartialUnrollPhase.class);
274         BasePhase&lt;? super MidTierContext&gt; partialUnoll = iter.previous();
275         if (iter.previous().getClass() != FrameStateAssignmentPhase.class) {
276             // Ensure LoopPartialUnrollPhase runs immediately after FrameStateAssignment, so it gets
277             // priority over other optimizations in these tests.
278             mid.findPhase(LoopPartialUnrollPhase.class).remove();
279             ListIterator&lt;BasePhase&lt;? super MidTierContext&gt;&gt; fsa = mid.findPhase(FrameStateAssignmentPhase.class);
280             fsa.add(partialUnoll);
281         }
282         return suites;
283     }
284 
285     public void testGraph(String reference, String test) {
286         StructuredGraph referenceGraph = buildGraph(reference, false);
287         StructuredGraph testGraph = buildGraph(test, true);
288         assertEquals(referenceGraph, testGraph, false, false);
289     }
290 
291     @SuppressWarnings(&quot;try&quot;)
292     public StructuredGraph buildGraph(String name, boolean partialUnroll) {
293         CompilationIdentifier id = new CompilationIdentifier() {
294             @Override
295             public String toString(Verbosity verbosity) {
296                 return name;
297             }
298         };
299         ResolvedJavaMethod method = getResolvedJavaMethod(name);
300         OptionValues options = new OptionValues(getInitialOptions(), DefaultLoopPolicies.Options.UnrollMaxIterations, 2);
301         StructuredGraph graph = parse(builder(method, StructuredGraph.AllowAssumptions.YES, id, options), getEagerGraphBuilderSuite());
302         try (DebugContext.Scope buildScope = graph.getDebug().scope(name, method, graph)) {
303             MidTierContext context = new MidTierContext(getProviders(), getTargetProvider(), OptimisticOptimizations.ALL, null);
304 
<span class="line-modified">305             CanonicalizerPhase canonicalizer = this.createCanonicalizerPhase();</span>
306             canonicalizer.apply(graph, context);
307             new RemoveValueProxyPhase().apply(graph);
308             new LoweringPhase(canonicalizer, LoweringTool.StandardLoweringStage.HIGH_TIER).apply(graph, context);
309             new FloatingReadPhase().apply(graph);
310             new DeadCodeEliminationPhase().apply(graph);
311             new ConditionalEliminationPhase(true).apply(graph, context);
312             ComputeLoopFrequenciesClosure.compute(graph);
313             new GuardLoweringPhase().apply(graph, context);
314             new LoweringPhase(canonicalizer, LoweringTool.StandardLoweringStage.MID_TIER).apply(graph, context);
315             new FrameStateAssignmentPhase().apply(graph);
316             new DeoptimizationGroupingPhase().apply(graph, context);
317             canonicalizer.apply(graph, context);
318             new ConditionalEliminationPhase(true).apply(graph, context);
319             if (partialUnroll) {
320                 LoopsData dataCounted = new LoopsData(graph);
321                 dataCounted.detectedCountedLoops();
322                 for (LoopEx loop : dataCounted.countedLoops()) {
323                     LoopFragmentInside newSegment = loop.inside().duplicate();
324                     newSegment.insertWithinAfter(loop, null);
325                 }
326                 canonicalizer.apply(graph, getDefaultMidTierContext());
327             }
328             new DeadCodeEliminationPhase().apply(graph);
329             canonicalizer.apply(graph, context);
330             graph.getDebug().dump(DebugContext.BASIC_LEVEL, graph, &quot;before compare&quot;);
331             return graph;
332         } catch (Throwable e) {
333             throw getDebugContext().handle(e);
334         }
335     }
336 
337     public void testDuplicateBody(String reference, String test) {
338 
339         StructuredGraph referenceGraph = buildGraph(reference, false);
340         StructuredGraph testGraph = buildGraph(test, true);
<span class="line-modified">341         CanonicalizerPhase canonicalizer = createCanonicalizerPhase();</span>
342         canonicalizer.apply(testGraph, getDefaultMidTierContext());
343         canonicalizer.apply(referenceGraph, getDefaultMidTierContext());
344         assertEquals(referenceGraph, testGraph);
345     }
346 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../org.graalvm.compiler.loop.phases/src/org/graalvm/compiler/loop/phases/LoopTransformations.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../org.graalvm.compiler.loop/src/org/graalvm/compiler/loop/CountedLoopInfo.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>