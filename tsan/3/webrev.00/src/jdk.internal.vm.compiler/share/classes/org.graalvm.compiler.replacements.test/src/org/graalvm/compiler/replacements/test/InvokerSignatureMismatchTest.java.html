<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/InvokerSignatureMismatchTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.replacements.test;
 26 
 27 import static org.graalvm.compiler.test.SubprocessUtil.getVMCommandLine;
 28 import static org.graalvm.compiler.test.SubprocessUtil.withoutDebuggerArguments;
 29 
 30 import java.nio.file.Files;
 31 import java.nio.file.Path;
 32 import java.nio.file.Paths;
 33 import java.util.List;
 34 
 35 import org.graalvm.compiler.core.test.CustomizedBytecodePatternTest;
 36 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;
 37 import org.graalvm.compiler.test.SubprocessUtil;
 38 import org.graalvm.compiler.test.SubprocessUtil.Subprocess;
 39 import org.junit.Test;
 40 import org.objectweb.asm.ClassWriter;
 41 import org.objectweb.asm.MethodVisitor;
 42 import org.objectweb.asm.Type;
 43 
 44 public class InvokerSignatureMismatchTest extends CustomizedBytecodePatternTest {
 45 
 46     @SuppressWarnings(&quot;try&quot;)
 47     @Test
 48     public void test() throws Throwable {
 49         List&lt;String&gt; args = withoutDebuggerArguments(getVMCommandLine());
 50         try (TemporaryDirectory temp = new TemporaryDirectory(null, getClass().getSimpleName())) {
 51             if (JavaVersionUtil.JAVA_SPEC &gt; 8) {
 52                 args.add(&quot;--class-path=&quot; + temp);
 53                 args.add(&quot;--patch-module=java.base=&quot; + temp);
 54             } else {
 55                 args.add(&quot;-Xbootclasspath/a:&quot; + temp);
 56             }
 57             args.add(&quot;-XX:-TieredCompilation&quot;);
 58             args.add(&quot;-XX:+UnlockExperimentalVMOptions&quot;);
 59             args.add(&quot;-XX:+EnableJVMCI&quot;);
 60             args.add(&quot;-XX:+UseJVMCICompiler&quot;);
 61 
 62             Path invokeDir = Files.createDirectories(temp.path.resolve(Paths.get(&quot;java&quot;, &quot;lang&quot;, &quot;invoke&quot;)));
 63             Files.write(temp.path.resolve(&quot;ISMTest.class&quot;), generateClass(&quot;ISMTest&quot;));
 64             Files.write(invokeDir.resolve(&quot;MethodHandleHelper.class&quot;), generateClass(&quot;java/lang/invoke/MethodHandleHelper&quot;));
 65 
 66             args.add(&quot;ISMTest&quot;);
 67             Subprocess proc = SubprocessUtil.java(args);
 68             if (proc.exitCode != 0) {
 69                 throw new AssertionError(proc.toString());
 70             }
 71         }
 72     }
 73 
 74     @Override
 75     protected byte[] generateClass(String className) {
 76         String[] exceptions = new String[]{&quot;java/lang/Throwable&quot;};
 77         ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
 78         cw.visit(52, ACC_SUPER | ACC_PUBLIC, className, null, &quot;java/lang/Object&quot;, null);
 79 
 80         if (className.equals(&quot;java/lang/invoke/MethodHandleHelper&quot;)) {
 81             MethodVisitor internalMemberName = cw.visitMethod(ACC_PUBLIC | ACC_STATIC, &quot;internalMemberName&quot;, &quot;(Ljava/lang/invoke/MethodHandle;)Ljava/lang/Object;&quot;, null, exceptions);
 82             internalMemberName.visitCode();
 83             internalMemberName.visitVarInsn(ALOAD, 0);
 84             internalMemberName.visitMethodInsn(INVOKEVIRTUAL, &quot;java/lang/invoke/MethodHandle&quot;, &quot;internalMemberName&quot;, &quot;()Ljava/lang/invoke/MemberName;&quot;, false);
 85             internalMemberName.visitInsn(ARETURN);
 86             internalMemberName.visitMaxs(1, 1);
 87             internalMemberName.visitEnd();
 88 
 89             MethodVisitor linkToStatic = cw.visitMethod(ACC_PUBLIC | ACC_STATIC, &quot;linkToStatic&quot;, &quot;(FLjava/lang/Object;)I&quot;, null, exceptions);
 90             linkToStatic.visitCode();
 91             linkToStatic.visitVarInsn(FLOAD, 0);
 92             linkToStatic.visitVarInsn(ALOAD, 1);
 93             linkToStatic.visitMethodInsn(INVOKESTATIC, &quot;java/lang/invoke/MethodHandle&quot;, &quot;linkToStatic&quot;, &quot;(FLjava/lang/Object;)I&quot;, false);
 94             linkToStatic.visitInsn(IRETURN);
 95             linkToStatic.visitMaxs(1, 1);
 96             linkToStatic.visitEnd();
 97 
 98             MethodVisitor invokeBasicI = cw.visitMethod(ACC_PUBLIC | ACC_STATIC, &quot;invokeBasicI&quot;, &quot;(Ljava/lang/invoke/MethodHandle;F)I&quot;, null, exceptions);
 99             invokeBasicI.visitCode();
100             invokeBasicI.visitVarInsn(ALOAD, 0);
101             invokeBasicI.visitVarInsn(FLOAD, 1);
102             invokeBasicI.visitMethodInsn(INVOKEVIRTUAL, &quot;java/lang/invoke/MethodHandle&quot;, &quot;invokeBasic&quot;, &quot;(F)I&quot;, false);
103             invokeBasicI.visitInsn(IRETURN);
104             invokeBasicI.visitMaxs(1, 1);
105             invokeBasicI.visitEnd();
106 
107         } else {
108             assert className.equals(&quot;ISMTest&quot;) : className;
109             cw.visitField(ACC_FINAL | ACC_STATIC, &quot;INT_MH&quot;, &quot;Ljava/lang/invoke/MethodHandle;&quot;, null, null).visitAnnotation(&quot;Ljava/lang/invoke/Stable.class;&quot;, true).visitEnd();
110             MethodVisitor clinit = cw.visitMethod(ACC_STATIC, &quot;&lt;clinit&gt;&quot;, &quot;()V&quot;, null, exceptions);
111             clinit.visitCode();
112             clinit.visitInsn(ACONST_NULL);
113             clinit.visitVarInsn(ASTORE, 0);
114             clinit.visitMethodInsn(INVOKESTATIC, &quot;java/lang/invoke/MethodHandles&quot;, &quot;lookup&quot;, &quot;()Ljava/lang/invoke/MethodHandles$Lookup;&quot;, false);
115             clinit.visitLdcInsn(Type.getObjectType(className));
116             clinit.visitLdcInsn(&quot;bodyI&quot;);
117             clinit.visitFieldInsn(GETSTATIC, &quot;java/lang/Integer&quot;, &quot;TYPE&quot;, &quot;Ljava/lang/Class;&quot;);
118             clinit.visitFieldInsn(GETSTATIC, &quot;java/lang/Integer&quot;, &quot;TYPE&quot;, &quot;Ljava/lang/Class;&quot;);
119             clinit.visitMethodInsn(INVOKESTATIC, &quot;java/lang/invoke/MethodType&quot;, &quot;methodType&quot;, &quot;(Ljava/lang/Class;Ljava/lang/Class;)Ljava/lang/invoke/MethodType;&quot;, false);
120             clinit.visitMethodInsn(INVOKEVIRTUAL, &quot;java/lang/invoke/MethodHandles$Lookup&quot;, &quot;findStatic&quot;,
121                             &quot;(Ljava/lang/Class;Ljava/lang/String;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/MethodHandle;&quot;, false);
122             clinit.visitFieldInsn(PUTSTATIC, className, &quot;INT_MH&quot;, &quot;Ljava/lang/invoke/MethodHandle;&quot;);
123             clinit.visitInsn(RETURN);
124             clinit.visitMaxs(1, 1);
125             clinit.visitEnd();
126 
127             MethodVisitor mainLink = cw.visitMethod(ACC_PUBLIC | ACC_STATIC, &quot;mainLink&quot;, &quot;(I)I&quot;, null, exceptions);
128             mainLink.visitCode();
129             mainLink.visitFieldInsn(GETSTATIC, className, &quot;INT_MH&quot;, &quot;Ljava/lang/invoke/MethodHandle;&quot;);
130             mainLink.visitMethodInsn(INVOKESTATIC, &quot;java/lang/invoke/MethodHandleHelper&quot;, &quot;internalMemberName&quot;, &quot;(Ljava/lang/invoke/MethodHandle;)Ljava/lang/Object;&quot;, false);
131             mainLink.visitVarInsn(ASTORE, 1);
132             mainLink.visitVarInsn(ILOAD, 0);
133             mainLink.visitInsn(I2F);
134             mainLink.visitVarInsn(ALOAD, 1);
135             mainLink.visitMethodInsn(INVOKESTATIC, &quot;java/lang/invoke/MethodHandleHelper&quot;, &quot;linkToStatic&quot;, &quot;(FLjava/lang/Object;)I&quot;, false);
136             mainLink.visitInsn(IRETURN);
137             mainLink.visitMaxs(1, 1);
138             mainLink.visitEnd();
139 
140             MethodVisitor mainInvoke = cw.visitMethod(ACC_PUBLIC | ACC_STATIC, &quot;mainInvoke&quot;, &quot;(I)I&quot;, null, exceptions);
141             mainInvoke.visitCode();
142             mainInvoke.visitFieldInsn(GETSTATIC, className, &quot;INT_MH&quot;, &quot;Ljava/lang/invoke/MethodHandle;&quot;);
143             mainInvoke.visitVarInsn(ILOAD, 0);
144             mainInvoke.visitInsn(I2F);
145             mainInvoke.visitMethodInsn(INVOKESTATIC, &quot;java/lang/invoke/MethodHandleHelper&quot;, &quot;invokeBasicI&quot;, &quot;(Ljava/lang/invoke/MethodHandle;F)I&quot;, false);
146             mainInvoke.visitInsn(IRETURN);
147             mainInvoke.visitMaxs(1, 1);
148             mainInvoke.visitEnd();
149 
150             MethodVisitor bodyI = cw.visitMethod(ACC_PUBLIC | ACC_STATIC, &quot;bodyI&quot;, &quot;(I)I&quot;, null, null);
151             bodyI.visitCode();
152             bodyI.visitVarInsn(ILOAD, 0);
153             bodyI.visitIntInsn(SIPUSH, 1023);
154             bodyI.visitInsn(IAND);
155             bodyI.visitInsn(IRETURN);
156             bodyI.visitMaxs(1, 1);
157             bodyI.visitEnd();
158 
159             MethodVisitor main = cw.visitMethod(ACC_PUBLIC | ACC_STATIC, &quot;main&quot;, &quot;([Ljava/lang/String;)V&quot;, null, exceptions);
160             main.visitCode();
161             main.visitIntInsn(SIPUSH, 100);
162             main.visitMethodInsn(INVOKESTATIC, &quot;ISMTest&quot;, &quot;mainLink&quot;, &quot;(I)I&quot;, false);
163             main.visitInsn(POP);
164             main.visitIntInsn(SIPUSH, 100);
165             main.visitMethodInsn(INVOKESTATIC, &quot;ISMTest&quot;, &quot;mainInvoke&quot;, &quot;(I)I&quot;, false);
166             main.visitInsn(POP);
167             main.visitInsn(RETURN);
168             main.visitMaxs(1, 1);
169             main.visitEnd();
170 
171         }
172         cw.visitEnd();
173         return cw.toByteArray();
174     }
175 }
    </pre>
  </body>
</html>