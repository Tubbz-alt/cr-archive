<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/ClassCastBytecodeExceptionTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="BytecodeExceptionTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="DeoptimizeOnExceptionTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/ClassCastBytecodeExceptionTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 25,75 ***</span>
  package org.graalvm.compiler.replacements.test;
  
  import java.util.ArrayList;
  import java.util.Collection;
  
  import org.junit.Assert;
  import org.junit.Test;
  import org.junit.runner.RunWith;
  import org.junit.runners.Parameterized;
  import org.junit.runners.Parameterized.Parameter;
  import org.junit.runners.Parameterized.Parameters;
  
<span class="line-removed">- import org.graalvm.compiler.api.directives.GraalDirectives;</span>
<span class="line-removed">- import org.graalvm.compiler.core.common.type.Stamp;</span>
<span class="line-removed">- import org.graalvm.compiler.core.common.type.StampFactory;</span>
<span class="line-removed">- import org.graalvm.compiler.core.common.type.TypeReference;</span>
<span class="line-removed">- import org.graalvm.compiler.nodes.ConstantNode;</span>
<span class="line-removed">- import org.graalvm.compiler.nodes.ValueNode;</span>
<span class="line-removed">- import org.graalvm.compiler.nodes.extended.BytecodeExceptionNode.BytecodeExceptionKind;</span>
<span class="line-removed">- import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;</span>
<span class="line-removed">- import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;</span>
<span class="line-removed">- import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;</span>
<span class="line-removed">- </span>
<span class="line-removed">- import jdk.vm.ci.meta.Constant;</span>
<span class="line-removed">- import jdk.vm.ci.meta.ResolvedJavaMethod;</span>
<span class="line-removed">- import jdk.vm.ci.meta.ResolvedJavaType;</span>
<span class="line-removed">- </span>
  @RunWith(Parameterized.class)
  public class ClassCastBytecodeExceptionTest extends BytecodeExceptionTest {
  
<span class="line-removed">-     private static class Exceptions {</span>
<span class="line-removed">- </span>
<span class="line-removed">-         public static void throwClassCast(Object obj, Class&lt;?&gt; cls) {</span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * We don&#39;t use cls.cast(obj) here because that gives a different exception message than</span>
<span class="line-removed">-              * the checkcast bytecode.</span>
<span class="line-removed">-              */</span>
<span class="line-removed">-             if (cls == Double.class) {</span>
<span class="line-removed">-                 Double cast = (Double) obj;</span>
<span class="line-removed">-                 GraalDirectives.blackhole(cast);</span>
<span class="line-removed">-             } else if (cls == byte[].class) {</span>
<span class="line-removed">-                 byte[] cast = (byte[]) obj;</span>
<span class="line-removed">-                 GraalDirectives.blackhole(cast);</span>
<span class="line-removed">-             } else if (cls == String[].class) {</span>
<span class="line-removed">-                 String[] cast = (String[]) obj;</span>
<span class="line-removed">-                 GraalDirectives.blackhole(cast);</span>
<span class="line-removed">-             } else if (cls == Object[][].class) {</span>
<span class="line-removed">-                 Object[][] cast = (Object[][]) obj;</span>
<span class="line-removed">-                 GraalDirectives.blackhole(cast);</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 Assert.fail(&quot;unexpected class argument&quot;);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     @Override</span>
<span class="line-removed">-     protected void registerInvocationPlugins(InvocationPlugins invocationPlugins) {</span>
<span class="line-removed">-         invocationPlugins.register(new InvocationPlugin() {</span>
<span class="line-removed">-             @Override</span>
<span class="line-removed">-             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode obj, ValueNode classNode) {</span>
<span class="line-removed">-                 ResolvedJavaType type = b.getConstantReflection().asJavaType(classNode.asConstant());</span>
<span class="line-removed">-                 Constant hub = b.getConstantReflection().asObjectHub(type);</span>
<span class="line-removed">-                 Stamp hubStamp = b.getStampProvider().createHubStamp(StampFactory.object(TypeReference.createExactTrusted(type)));</span>
<span class="line-removed">-                 ConstantNode hubConst = b.add(ConstantNode.forConstant(hubStamp, hub, b.getMetaAccess()));</span>
<span class="line-removed">-                 return throwBytecodeException(b, BytecodeExceptionKind.CLASS_CAST, obj, hubConst);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }, Exceptions.class, &quot;throwClassCast&quot;, Object.class, Class.class);</span>
<span class="line-removed">-         super.registerInvocationPlugins(invocationPlugins);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      @Parameter(0) public Object object;
      @Parameter(1) public Class&lt;?&gt; cls;
  
      @Parameters(name = &quot;{1}&quot;)
      public static Collection&lt;Object[]&gt; data() {
<span class="line-new-header">--- 25,21 ---</span>
  package org.graalvm.compiler.replacements.test;
  
  import java.util.ArrayList;
  import java.util.Collection;
  
<span class="line-added">+ import org.graalvm.compiler.api.directives.GraalDirectives;</span>
  import org.junit.Assert;
  import org.junit.Test;
  import org.junit.runner.RunWith;
  import org.junit.runners.Parameterized;
  import org.junit.runners.Parameterized.Parameter;
  import org.junit.runners.Parameterized.Parameters;
  
  @RunWith(Parameterized.class)
  public class ClassCastBytecodeExceptionTest extends BytecodeExceptionTest {
  
      @Parameter(0) public Object object;
      @Parameter(1) public Class&lt;?&gt; cls;
  
      @Parameters(name = &quot;{1}&quot;)
      public static Collection&lt;Object[]&gt; data() {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 105,38 ***</span>
          }
          return ret;
      }
  
      public static void castToDouble(Object obj) {
<span class="line-modified">!         Exceptions.throwClassCast(obj, Double.class);</span>
      }
  
      @Test
      public void testCastToDouble() {
          test(&quot;castToDouble&quot;, object);
      }
  
      public static void castToByteArray(Object obj) {
<span class="line-modified">!         Exceptions.throwClassCast(obj, byte[].class);</span>
      }
  
      @Test
      public void testCastToByteArray() {
          test(&quot;castToByteArray&quot;, object);
      }
  
      public static void castToStringArray(Object obj) {
<span class="line-modified">!         Exceptions.throwClassCast(obj, String[].class);</span>
      }
  
      @Test
      public void testCastToStringArray() {
          test(&quot;castToStringArray&quot;, object);
      }
  
      public static void castToArrayArray(Object obj) {
<span class="line-modified">!         Exceptions.throwClassCast(obj, Object[][].class);</span>
      }
  
      @Test
      public void testCastToArrayArray() {
          test(&quot;castToArrayArray&quot;, object);
<span class="line-new-header">--- 51,110 ---</span>
          }
          return ret;
      }
  
      public static void castToDouble(Object obj) {
<span class="line-modified">!         /*</span>
<span class="line-added">+          * We don&#39;t use cls.cast(obj) here because that gives a different exception message than the</span>
<span class="line-added">+          * checkcast bytecode.</span>
<span class="line-added">+          */</span>
<span class="line-added">+         if (Double.class == Double.class) {</span>
<span class="line-added">+             Double cast = (Double) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if ((Class&lt;?&gt;) Double.class == byte[].class) {</span>
<span class="line-added">+             byte[] cast = (byte[]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if ((Class&lt;?&gt;) Double.class == String[].class) {</span>
<span class="line-added">+             String[] cast = (String[]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if ((Class&lt;?&gt;) Double.class == Object[][].class) {</span>
<span class="line-added">+             Object[][] cast = (Object[][]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             Assert.fail(&quot;unexpected class argument&quot;);</span>
<span class="line-added">+         }</span>
      }
  
      @Test
      public void testCastToDouble() {
          test(&quot;castToDouble&quot;, object);
      }
  
      public static void castToByteArray(Object obj) {
<span class="line-modified">!         /*</span>
<span class="line-added">+          * We don&#39;t use cls.cast(obj) here because that gives a different exception message than the</span>
<span class="line-added">+          * checkcast bytecode.</span>
<span class="line-added">+          */</span>
<span class="line-added">+         if ((Class&lt;?&gt;) byte[].class == Double.class) {</span>
<span class="line-added">+             Double cast = (Double) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if (byte[].class == byte[].class) {</span>
<span class="line-added">+             byte[] cast = (byte[]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if ((Class&lt;?&gt;) byte[].class == String[].class) {</span>
<span class="line-added">+             String[] cast = (String[]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if ((Class&lt;?&gt;) byte[].class == Object[][].class) {</span>
<span class="line-added">+             Object[][] cast = (Object[][]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             Assert.fail(&quot;unexpected class argument&quot;);</span>
<span class="line-added">+         }</span>
      }
  
      @Test
      public void testCastToByteArray() {
          test(&quot;castToByteArray&quot;, object);
      }
  
      public static void castToStringArray(Object obj) {
<span class="line-modified">!         /*</span>
<span class="line-added">+          * We don&#39;t use cls.cast(obj) here because that gives a different exception message than the</span>
<span class="line-added">+          * checkcast bytecode.</span>
<span class="line-added">+          */</span>
<span class="line-added">+         if ((Class&lt;?&gt;) String[].class == Double.class) {</span>
<span class="line-added">+             Double cast = (Double) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if ((Class&lt;?&gt;) String[].class == byte[].class) {</span>
<span class="line-added">+             byte[] cast = (byte[]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if (String[].class == String[].class) {</span>
<span class="line-added">+             String[] cast = (String[]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if ((Class&lt;?&gt;) String[].class == Object[][].class) {</span>
<span class="line-added">+             Object[][] cast = (Object[][]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             Assert.fail(&quot;unexpected class argument&quot;);</span>
<span class="line-added">+         }</span>
      }
  
      @Test
      public void testCastToStringArray() {
          test(&quot;castToStringArray&quot;, object);
      }
  
      public static void castToArrayArray(Object obj) {
<span class="line-modified">!         /*</span>
<span class="line-added">+          * We don&#39;t use cls.cast(obj) here because that gives a different exception message than the</span>
<span class="line-added">+          * checkcast bytecode.</span>
<span class="line-added">+          */</span>
<span class="line-added">+         if ((Class&lt;?&gt;) Object[][].class == Double.class) {</span>
<span class="line-added">+             Double cast = (Double) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if ((Class&lt;?&gt;) Object[][].class == byte[].class) {</span>
<span class="line-added">+             byte[] cast = (byte[]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if ((Class&lt;?&gt;) Object[][].class == String[].class) {</span>
<span class="line-added">+             String[] cast = (String[]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else if (Object[][].class == Object[][].class) {</span>
<span class="line-added">+             Object[][] cast = (Object[][]) obj;</span>
<span class="line-added">+             GraalDirectives.blackhole(cast);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             Assert.fail(&quot;unexpected class argument&quot;);</span>
<span class="line-added">+         }</span>
      }
  
      @Test
      public void testCastToArrayArray() {
          test(&quot;castToArrayArray&quot;, object);
</pre>
<center><a href="BytecodeExceptionTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="DeoptimizeOnExceptionTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>