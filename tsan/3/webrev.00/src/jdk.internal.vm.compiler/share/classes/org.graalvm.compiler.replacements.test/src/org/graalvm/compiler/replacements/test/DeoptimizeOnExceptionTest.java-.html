<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/DeoptimizeOnExceptionTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.replacements.test;
 26 
 27 import java.util.Random;
 28 
 29 import org.graalvm.compiler.api.directives.GraalDirectives;
 30 import org.graalvm.compiler.core.phases.HighTier;
 31 import org.graalvm.compiler.core.test.GraalCompilerTest;
 32 import org.graalvm.compiler.nodes.ValueNode;
 33 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;
 34 import org.graalvm.compiler.nodes.graphbuilderconf.InlineInvokePlugin;
 35 import org.graalvm.compiler.options.OptionValues;
 36 import org.graalvm.compiler.phases.common.AbstractInliningPhase;
 37 import org.graalvm.compiler.test.ExportingClassLoader;
 38 import org.junit.Assert;
 39 import org.junit.Assume;
 40 import org.junit.Test;
 41 import org.objectweb.asm.ClassWriter;
 42 import org.objectweb.asm.Label;
 43 import org.objectweb.asm.MethodVisitor;
 44 import org.objectweb.asm.Opcodes;
 45 
 46 import jdk.vm.ci.code.InstalledCode;
 47 import jdk.vm.ci.meta.DeoptimizationReason;
 48 import jdk.vm.ci.meta.ResolvedJavaMethod;
 49 
 50 /**
 51  * Tests that deoptimization upon exception handling works.
 52  */
 53 public class DeoptimizeOnExceptionTest extends GraalCompilerTest {
 54 
 55     public DeoptimizeOnExceptionTest() {
 56         createSuites(getInitialOptions()).getHighTier().findPhase(AbstractInliningPhase.class).remove();
 57     }
 58 
 59     private static void raiseException(String m1, String m2, String m3, String m4, String m5) {
 60         throw new RuntimeException(m1 + m2 + m3 + m4 + m5);
 61     }
 62 
 63     @Test
 64     public void test1() {
 65         test(&quot;test1Snippet&quot;, &quot;m1&quot;, &quot;m2&quot;, &quot;m3&quot;, &quot;m4&quot;, &quot;m5&quot;);
 66     }
 67 
 68     // no local exception handler - will deopt
 69     public static String test1Snippet(String m1, String m2, String m3, String m4, String m5) {
 70         if (m1 != null) {
 71             raiseException(m1, m2, m3, m4, m5);
 72         }
 73         return m1 + m2 + m3 + m4 + m5;
 74     }
 75 
 76     @Test
 77     public void test2() {
 78         test(&quot;test2Snippet&quot;);
 79     }
 80 
 81     public String test2Snippet() throws Exception {
 82         try {
 83             ClassLoader testCl = new MyClassLoader();
 84             @SuppressWarnings(&quot;unchecked&quot;)
 85             Class&lt;Runnable&gt; c = (Class&lt;Runnable&gt;) testCl.loadClass(name);
 86             Runnable r = c.getDeclaredConstructor().newInstance();
 87             ct = Long.MAX_VALUE;
 88             // warmup
 89             for (int i = 0; i &lt; 100; i++) {
 90                 r.run();
 91             }
 92             // compile
 93             ResolvedJavaMethod method = getResolvedJavaMethod(c, &quot;run&quot;);
 94             getCode(method);
 95             ct = 0;
 96             r.run();
 97         } catch (Throwable e) {
 98             e.printStackTrace(System.out);
 99             Assert.fail();
100         }
101         return &quot;SUCCESS&quot;;
102     }
103 
104     @Test
105     public void test3() {
106         Assume.assumeTrue(&quot;Only works on jdk8 right now&quot;, Java8OrEarlier);
107         ResolvedJavaMethod method = getResolvedJavaMethod(&quot;test3Snippet&quot;);
108 
109         for (int i = 0; i &lt; 2; i++) {
110             Result actual;
111             boolean expectedCompiledCode = (method.getProfilingInfo().getDeoptimizationCount(DeoptimizationReason.NotCompiledExceptionHandler) != 0);
112             InstalledCode code = getCode(method, null, false, true, new OptionValues(getInitialOptions(), HighTier.Options.Inline, false));
113             assertTrue(code.isValid());
114 
115             try {
116                 actual = new Result(code.executeVarargs(false), null);
117             } catch (Exception e) {
118                 actual = new Result(null, e);
119             }
120 
121             assertTrue(i &gt; 0 == expectedCompiledCode, &quot;expect compiled code to stay around after the first iteration&quot;);
122             assertEquals(new Result(expectedCompiledCode, null), actual);
123             assertTrue(expectedCompiledCode == code.isValid());
124         }
125     }
126 
127     @Override
128     protected InlineInvokePlugin.InlineInfo bytecodeParserShouldInlineInvoke(GraphBuilderContext b, ResolvedJavaMethod method, ValueNode[] args) {
129         if (method.getName().equals(&quot;throwException&quot;)) {
130             if (b.getMethod().getProfilingInfo().getDeoptimizationCount(DeoptimizationReason.NotCompiledExceptionHandler) != 0) {
131                 return InlineInvokePlugin.InlineInfo.DO_NOT_INLINE_WITH_EXCEPTION;
132             } else {
133                 return InlineInvokePlugin.InlineInfo.DO_NOT_INLINE_NO_EXCEPTION;
134             }
135         }
136         return super.bytecodeParserShouldInlineInvoke(b, method, args);
137     }
138 
139     private static void throwException() throws Exception {
140         throw new Exception();
141     }
142 
143     static int footprint;
144 
145     public static boolean test3Snippet(boolean rethrowException) throws Exception {
146         try {
147             footprint = 1;
148             throwException();
149         } catch (Exception e) {
150             footprint = 2;
151             if (rethrowException) {
152                 throw e;
153             }
154         }
155 
156         return GraalDirectives.inCompiledCode();
157     }
158 
159     public static class MyClassLoader extends ExportingClassLoader {
160         @Override
161         protected Class&lt;?&gt; findClass(String className) throws ClassNotFoundException {
162             return defineClass(name.replace(&#39;/&#39;, &#39;.&#39;), clazz, 0, clazz.length);
163         }
164     }
165 
166     public static void methodB() {
167         Random r = new Random(System.currentTimeMillis());
168         while (r.nextFloat() &gt; .03f) {
169             // Empty
170         }
171 
172         return;
173     }
174 
175     public static void methodA() {
176         Random r = new Random(System.currentTimeMillis());
177         while (r.nextDouble() &gt; .05) {
178             // Empty
179         }
180         return;
181     }
182 
183     private static Object m = new Object();
184     static long ct = Long.MAX_VALUE;
185 
186     public static Object getM() {
187         if (ct-- &gt; 0) {
188             return m;
189         } else {
190             return null;
191         }
192     }
193 
194     private static String name = &quot;t/TestJSR&quot;;
195 
196     private static final byte[] clazz = makeClazz();
197 
198     private static byte[] makeClazz() {
199         // Code generated the class below using asm.
200         String clazzName = DeoptimizeOnExceptionTest.class.getName().replace(&#39;.&#39;, &#39;/&#39;);
201         final ClassWriter w = new ClassWriter(0);
202         w.visit(Opcodes.V1_5, Opcodes.ACC_PUBLIC,
203                         &quot;t/TestJSR&quot;, null, &quot;java/lang/Object&quot;,
204                         new String[]{&quot;java/lang/Runnable&quot;});
205         MethodVisitor mv = w.visitMethod(Opcodes.ACC_PUBLIC, &quot;&lt;init&gt;&quot;, &quot;()V&quot;, null, new String[]{});
206         mv.visitCode();
207         mv.visitVarInsn(Opcodes.ALOAD, 0);
208         mv.visitMethodInsn(Opcodes.INVOKESPECIAL, &quot;java/lang/Object&quot;, &quot;&lt;init&gt;&quot;, &quot;()V&quot;, false);
209         mv.visitInsn(Opcodes.RETURN);
210         mv.visitMaxs(10, 10);
211         mv.visitEnd();
212 
213         mv = w.visitMethod(Opcodes.ACC_PUBLIC, &quot;run&quot;, &quot;()V&quot;, null, null);
214         mv.visitCode();
215         mv.visitMethodInsn(Opcodes.INVOKESTATIC, clazzName, &quot;getM&quot;, &quot;()Ljava/lang/Object;&quot;, false);
216         Label l1 = new Label();
217         mv.visitJumpInsn(Opcodes.JSR, l1);
218         mv.visitInsn(Opcodes.RETURN);
219 
220         mv.visitLabel(l1);
221         mv.visitVarInsn(Opcodes.ASTORE, 1);
222 
223         Label lElse = new Label();
224         Label lEnd = new Label();
225         mv.visitMethodInsn(Opcodes.INVOKESTATIC, &quot;java/lang/System&quot;, &quot;currentTimeMillis&quot;, &quot;()J&quot;, false);
226         mv.visitInsn(Opcodes.POP2);
227         mv.visitMethodInsn(Opcodes.INVOKESTATIC, clazzName, &quot;getM&quot;, &quot;()Ljava/lang/Object;&quot;, false);
228         mv.visitInsn(Opcodes.DUP);
229         mv.visitJumpInsn(Opcodes.IFNULL, lElse);
230         mv.visitMethodInsn(Opcodes.INVOKESTATIC, clazzName, &quot;methodA&quot;, &quot;()V&quot;, false);
231         mv.visitJumpInsn(Opcodes.GOTO, lEnd);
232         mv.visitLabel(lElse);
233         mv.visitMethodInsn(Opcodes.INVOKESTATIC, clazzName, &quot;methodB&quot;, &quot;()V&quot;, false);
234         mv.visitLabel(lEnd);
235 
236         mv.visitVarInsn(Opcodes.RET, 1);
237         mv.visitMaxs(10, 10);
238         mv.visitEnd();
239         return w.toByteArray();
240     }
241 }
    </pre>
  </body>
</html>