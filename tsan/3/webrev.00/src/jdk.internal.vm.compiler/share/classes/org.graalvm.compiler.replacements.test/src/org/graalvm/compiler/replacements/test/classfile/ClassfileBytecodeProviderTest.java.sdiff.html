<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/classfile/ClassfileBytecodeProviderTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../SubstitutionsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="RedefineIntrinsicTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/classfile/ClassfileBytecodeProviderTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 70 import static org.graalvm.compiler.bytecode.Bytecodes.LOOKUPSWITCH;
 71 import static org.graalvm.compiler.bytecode.Bytecodes.LSTORE;
 72 import static org.graalvm.compiler.bytecode.Bytecodes.MULTIANEWARRAY;
 73 import static org.graalvm.compiler.bytecode.Bytecodes.NEW;
 74 import static org.graalvm.compiler.bytecode.Bytecodes.NEWARRAY;
 75 import static org.graalvm.compiler.bytecode.Bytecodes.PUTFIELD;
 76 import static org.graalvm.compiler.bytecode.Bytecodes.PUTSTATIC;
 77 import static org.graalvm.compiler.bytecode.Bytecodes.RET;
 78 import static org.graalvm.compiler.bytecode.Bytecodes.SIPUSH;
 79 import static org.graalvm.compiler.bytecode.Bytecodes.TABLESWITCH;
 80 
 81 import java.io.File;
 82 import java.io.IOException;
 83 import java.lang.reflect.Executable;
 84 import java.lang.reflect.Method;
 85 import java.util.Enumeration;
 86 import java.util.Formatter;
 87 import java.util.zip.ZipEntry;
 88 import java.util.zip.ZipFile;
 89 
<span class="line-removed"> 90 import org.graalvm.compiler.test.SubprocessUtil;</span>
<span class="line-removed"> 91 import org.junit.Assert;</span>
<span class="line-removed"> 92 import org.junit.Assume;</span>
<span class="line-removed"> 93 import org.junit.Before;</span>
<span class="line-removed"> 94 import org.junit.Test;</span>
<span class="line-removed"> 95 </span>
 96 import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
 97 import org.graalvm.compiler.api.test.Graal;
 98 import org.graalvm.compiler.bytecode.Bytecode;
 99 import org.graalvm.compiler.bytecode.BytecodeDisassembler;
100 import org.graalvm.compiler.bytecode.BytecodeLookupSwitch;
101 import org.graalvm.compiler.bytecode.BytecodeStream;
102 import org.graalvm.compiler.bytecode.BytecodeSwitch;
103 import org.graalvm.compiler.bytecode.BytecodeTableSwitch;
104 import org.graalvm.compiler.bytecode.Bytecodes;
105 import org.graalvm.compiler.bytecode.ResolvedJavaMethodBytecode;
106 import org.graalvm.compiler.core.test.GraalCompilerTest;
107 import org.graalvm.compiler.phases.VerifyPhase;
108 import org.graalvm.compiler.phases.util.Providers;
109 import org.graalvm.compiler.replacements.classfile.ClassfileBytecode;
110 import org.graalvm.compiler.replacements.classfile.ClassfileBytecodeProvider;
111 import org.graalvm.compiler.runtime.RuntimeProvider;







112 
113 import jdk.vm.ci.meta.ConstantPool;
114 import jdk.vm.ci.meta.JavaField;
115 import jdk.vm.ci.meta.JavaMethodProfile.ProfiledMethod;
116 import jdk.vm.ci.meta.JavaType;
117 import jdk.vm.ci.meta.MetaAccessProvider;
118 import jdk.vm.ci.meta.ResolvedJavaField;
119 import jdk.vm.ci.meta.ResolvedJavaMethod;
120 import jdk.vm.ci.meta.ResolvedJavaType;
121 
122 /**
123  * Tests that bytecode exposed via {@link ClassfileBytecode} objects is the same as the bytecode
124  * (modulo minor differences in constant pool resolution) obtained directly from
125  * {@link ResolvedJavaMethod} objects.
126  */
127 public class ClassfileBytecodeProviderTest extends GraalCompilerTest {
128 
129     @Before
130     public void checkJavaAgent() {
131         assumeManagementLibraryIsLoadable();
132         Assume.assumeFalse(&quot;Java Agent found -&gt; skipping&quot;, SubprocessUtil.isJavaAgentAttached());
133     }
134 
135     private static boolean shouldProcess(String classpathEntry) {
136         if (classpathEntry.endsWith(&quot;.jar&quot;)) {
137             String name = new File(classpathEntry).getName();
138             return name.contains(&quot;jvmci&quot;) || name.contains(&quot;graal&quot;);
139         }
140         return false;
141     }
142 











143     @Test
144     public void test() {
145         RuntimeProvider rt = Graal.getRequiredCapability(RuntimeProvider.class);
146         Providers providers = rt.getHostBackend().getProviders();
147         MetaAccessProvider metaAccess = providers.getMetaAccess();
148 
149         Assume.assumeTrue(VerifyPhase.class.desiredAssertionStatus());
<span class="line-modified">150 </span>
<span class="line-modified">151         String propertyName = Java8OrEarlier ? &quot;sun.boot.class.path&quot; : &quot;jdk.module.path&quot;;</span>
<span class="line-modified">152         String bootclasspath = System.getProperty(propertyName);</span>
<span class="line-modified">153         Assert.assertNotNull(&quot;Cannot find value of &quot; + propertyName, bootclasspath);</span>




154 
155         for (String path : bootclasspath.split(File.pathSeparator)) {
156             if (shouldProcess(path)) {
157                 try {
<span class="line-modified">158                     final ZipFile zipFile = new ZipFile(new File(path));</span>
<span class="line-modified">159                     for (final Enumeration&lt;? extends ZipEntry&gt; entry = zipFile.entries(); entry.hasMoreElements();) {</span>
<span class="line-modified">160                         final ZipEntry zipEntry = entry.nextElement();</span>
<span class="line-removed">161                         String name = zipEntry.getName();</span>
<span class="line-removed">162                         if (name.endsWith(&quot;.class&quot;) &amp;&amp; !name.equals(&quot;module-info.class&quot;) &amp;&amp; !name.startsWith(&quot;META-INF/versions/&quot;)) {</span>
<span class="line-removed">163                             String className = name.substring(0, name.length() - &quot;.class&quot;.length()).replace(&#39;/&#39;, &#39;.&#39;);</span>
<span class="line-removed">164                             if (isInNativeImage(className)) {</span>
165                                 /*
<span class="line-modified">166                                  * Native image requires non-graalsdk classes to be present in the</span>
<span class="line-removed">167                                  * classpath.</span>
168                                  */
169                                 continue;
170                             }
<span class="line-removed">171                             if (isGSON(className)) {</span>
<span class="line-removed">172                                 /* uses old class format */</span>
<span class="line-removed">173                                 continue;</span>
<span class="line-removed">174                             }</span>
175                             try {
176                                 checkClass(metaAccess, getSnippetReflection(), className);
177                             } catch (ClassNotFoundException e) {
178                                 throw new AssertionError(e);
179                             }
180                         }









































181                     }
182                 } catch (IOException ex) {
183                     Assert.fail(ex.toString());
184                 }
185             }
186         }
187     }
188 
189     private static boolean isInNativeImage(String className) {
190         return className.startsWith(&quot;org.graalvm.nativeimage&quot;);
191     }
192 
193     private static boolean isGSON(String className) {
194         return className.contains(&quot;com.google.gson&quot;);
195     }
196 
197     protected void checkClass(MetaAccessProvider metaAccess, SnippetReflectionProvider snippetReflection, String className) throws ClassNotFoundException {
198         if (className.equals(&quot;jdk.vm.ci.services.JVMCIClassLoaderFactory&quot;)) {
199             // JVMCIClassLoaderFactory must only be initialized by the VM
200             return;
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 70 import static org.graalvm.compiler.bytecode.Bytecodes.LOOKUPSWITCH;
 71 import static org.graalvm.compiler.bytecode.Bytecodes.LSTORE;
 72 import static org.graalvm.compiler.bytecode.Bytecodes.MULTIANEWARRAY;
 73 import static org.graalvm.compiler.bytecode.Bytecodes.NEW;
 74 import static org.graalvm.compiler.bytecode.Bytecodes.NEWARRAY;
 75 import static org.graalvm.compiler.bytecode.Bytecodes.PUTFIELD;
 76 import static org.graalvm.compiler.bytecode.Bytecodes.PUTSTATIC;
 77 import static org.graalvm.compiler.bytecode.Bytecodes.RET;
 78 import static org.graalvm.compiler.bytecode.Bytecodes.SIPUSH;
 79 import static org.graalvm.compiler.bytecode.Bytecodes.TABLESWITCH;
 80 
 81 import java.io.File;
 82 import java.io.IOException;
 83 import java.lang.reflect.Executable;
 84 import java.lang.reflect.Method;
 85 import java.util.Enumeration;
 86 import java.util.Formatter;
 87 import java.util.zip.ZipEntry;
 88 import java.util.zip.ZipFile;
 89 






 90 import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
 91 import org.graalvm.compiler.api.test.Graal;
 92 import org.graalvm.compiler.bytecode.Bytecode;
 93 import org.graalvm.compiler.bytecode.BytecodeDisassembler;
 94 import org.graalvm.compiler.bytecode.BytecodeLookupSwitch;
 95 import org.graalvm.compiler.bytecode.BytecodeStream;
 96 import org.graalvm.compiler.bytecode.BytecodeSwitch;
 97 import org.graalvm.compiler.bytecode.BytecodeTableSwitch;
 98 import org.graalvm.compiler.bytecode.Bytecodes;
 99 import org.graalvm.compiler.bytecode.ResolvedJavaMethodBytecode;
100 import org.graalvm.compiler.core.test.GraalCompilerTest;
101 import org.graalvm.compiler.phases.VerifyPhase;
102 import org.graalvm.compiler.phases.util.Providers;
103 import org.graalvm.compiler.replacements.classfile.ClassfileBytecode;
104 import org.graalvm.compiler.replacements.classfile.ClassfileBytecodeProvider;
105 import org.graalvm.compiler.runtime.RuntimeProvider;
<span class="line-added">106 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;</span>
<span class="line-added">107 import org.graalvm.compiler.api.test.ModuleSupport;</span>
<span class="line-added">108 import org.graalvm.compiler.test.SubprocessUtil;</span>
<span class="line-added">109 import org.junit.Assert;</span>
<span class="line-added">110 import org.junit.Assume;</span>
<span class="line-added">111 import org.junit.Before;</span>
<span class="line-added">112 import org.junit.Test;</span>
113 
114 import jdk.vm.ci.meta.ConstantPool;
115 import jdk.vm.ci.meta.JavaField;
116 import jdk.vm.ci.meta.JavaMethodProfile.ProfiledMethod;
117 import jdk.vm.ci.meta.JavaType;
118 import jdk.vm.ci.meta.MetaAccessProvider;
119 import jdk.vm.ci.meta.ResolvedJavaField;
120 import jdk.vm.ci.meta.ResolvedJavaMethod;
121 import jdk.vm.ci.meta.ResolvedJavaType;
122 
123 /**
124  * Tests that bytecode exposed via {@link ClassfileBytecode} objects is the same as the bytecode
125  * (modulo minor differences in constant pool resolution) obtained directly from
126  * {@link ResolvedJavaMethod} objects.
127  */
128 public class ClassfileBytecodeProviderTest extends GraalCompilerTest {
129 
130     @Before
131     public void checkJavaAgent() {
132         assumeManagementLibraryIsLoadable();
133         Assume.assumeFalse(&quot;Java Agent found -&gt; skipping&quot;, SubprocessUtil.isJavaAgentAttached());
134     }
135 
136     private static boolean shouldProcess(String classpathEntry) {
137         if (classpathEntry.endsWith(&quot;.jar&quot;)) {
138             String name = new File(classpathEntry).getName();
139             return name.contains(&quot;jvmci&quot;) || name.contains(&quot;graal&quot;);
140         }
141         return false;
142     }
143 
<span class="line-added">144     /**</span>
<span class="line-added">145      * Keep test time down by only sampling a limited number of class files per jar.</span>
<span class="line-added">146      */</span>
<span class="line-added">147     private static final int CLASSES_PER_JAR = 250;</span>
<span class="line-added">148 </span>
<span class="line-added">149     /**</span>
<span class="line-added">150      * Magic token to denote the classes in the Java runtime image (i.e. in the {@code jrt:/} file</span>
<span class="line-added">151      * system).</span>
<span class="line-added">152      */</span>
<span class="line-added">153     public static final String JRT_CLASS_PATH_ENTRY = &quot;&lt;jrt&gt;&quot;;</span>
<span class="line-added">154 </span>
155     @Test
156     public void test() {
157         RuntimeProvider rt = Graal.getRequiredCapability(RuntimeProvider.class);
158         Providers providers = rt.getHostBackend().getProviders();
159         MetaAccessProvider metaAccess = providers.getMetaAccess();
160 
161         Assume.assumeTrue(VerifyPhase.class.desiredAssertionStatus());
<span class="line-modified">162         String bootclasspath;</span>
<span class="line-modified">163         if (JavaVersionUtil.JAVA_SPEC &lt;= 8) {</span>
<span class="line-modified">164             String propertyName = &quot;sun.boot.class.path&quot;;</span>
<span class="line-modified">165             bootclasspath = System.getProperty(propertyName);</span>
<span class="line-added">166             Assert.assertNotNull(&quot;Cannot find value of &quot; + propertyName, bootclasspath);</span>
<span class="line-added">167         } else {</span>
<span class="line-added">168             bootclasspath = JRT_CLASS_PATH_ENTRY;</span>
<span class="line-added">169         }</span>
170 
171         for (String path : bootclasspath.split(File.pathSeparator)) {
172             if (shouldProcess(path)) {
173                 try {
<span class="line-modified">174                     if (path.equals(JRT_CLASS_PATH_ENTRY)) {</span>
<span class="line-modified">175                         for (String className : ModuleSupport.getJRTGraalClassNames()) {</span>
<span class="line-modified">176                             if (isGSON(className)) {</span>




177                                 /*
<span class="line-modified">178                                  * GSON classes are compiled with old JDK</span>

179                                  */
180                                 continue;
181                             }




182                             try {
183                                 checkClass(metaAccess, getSnippetReflection(), className);
184                             } catch (ClassNotFoundException e) {
185                                 throw new AssertionError(e);
186                             }
187                         }
<span class="line-added">188                     } else {</span>
<span class="line-added">189                         final ZipFile zipFile = new ZipFile(new File(path));</span>
<span class="line-added">190                         int index = 0;</span>
<span class="line-added">191                         int step = zipFile.size() &gt; CLASSES_PER_JAR ? zipFile.size() / CLASSES_PER_JAR : 1;</span>
<span class="line-added">192                         for (final Enumeration&lt;? extends ZipEntry&gt; entry = zipFile.entries(); entry.hasMoreElements();) {</span>
<span class="line-added">193                             final ZipEntry zipEntry = entry.nextElement();</span>
<span class="line-added">194                             if ((index % step) == 0) {</span>
<span class="line-added">195                                 String name = zipEntry.getName();</span>
<span class="line-added">196                                 if (name.endsWith(&quot;.class&quot;) &amp;&amp; !name.equals(&quot;module-info.class&quot;) &amp;&amp; !name.startsWith(&quot;META-INF/versions/&quot;)) {</span>
<span class="line-added">197                                     String className = name.substring(0, name.length() - &quot;.class&quot;.length()).replace(&#39;/&#39;, &#39;.&#39;);</span>
<span class="line-added">198                                     if (isInNativeImage(className)) {</span>
<span class="line-added">199                                         /*</span>
<span class="line-added">200                                          * Native image requires non-graalsdk classes to be present</span>
<span class="line-added">201                                          * in the classpath.</span>
<span class="line-added">202                                          */</span>
<span class="line-added">203                                         continue;</span>
<span class="line-added">204                                     }</span>
<span class="line-added">205                                     if (isGSON(className)) {</span>
<span class="line-added">206                                         /* uses old class format */</span>
<span class="line-added">207                                         continue;</span>
<span class="line-added">208                                     }</span>
<span class="line-added">209                                     try {</span>
<span class="line-added">210                                         checkClass(metaAccess, getSnippetReflection(), className);</span>
<span class="line-added">211                                     } catch (UnsupportedClassVersionError e) {</span>
<span class="line-added">212                                         // graal-test.jar can contain classes compiled for different</span>
<span class="line-added">213                                         // Java versions</span>
<span class="line-added">214                                     } catch (NoClassDefFoundError e) {</span>
<span class="line-added">215                                         if (!e.getMessage().contains(&quot;Could not initialize class&quot;)) {</span>
<span class="line-added">216                                             throw e;</span>
<span class="line-added">217                                         } else {</span>
<span class="line-added">218                                             // A second or later attempt to initialize a class</span>
<span class="line-added">219                                             // results in this confusing error where the</span>
<span class="line-added">220                                             // original cause of initialization failure is lost</span>
<span class="line-added">221                                         }</span>
<span class="line-added">222                                     } catch (ClassNotFoundException e) {</span>
<span class="line-added">223                                         throw new AssertionError(e);</span>
<span class="line-added">224                                     }</span>
<span class="line-added">225                                 }</span>
<span class="line-added">226                             }</span>
<span class="line-added">227                             index++;</span>
<span class="line-added">228                         }</span>
229                     }
230                 } catch (IOException ex) {
231                     Assert.fail(ex.toString());
232                 }
233             }
234         }
235     }
236 
237     private static boolean isInNativeImage(String className) {
238         return className.startsWith(&quot;org.graalvm.nativeimage&quot;);
239     }
240 
241     private static boolean isGSON(String className) {
242         return className.contains(&quot;com.google.gson&quot;);
243     }
244 
245     protected void checkClass(MetaAccessProvider metaAccess, SnippetReflectionProvider snippetReflection, String className) throws ClassNotFoundException {
246         if (className.equals(&quot;jdk.vm.ci.services.JVMCIClassLoaderFactory&quot;)) {
247             // JVMCIClassLoaderFactory must only be initialized by the VM
248             return;
</pre>
</td>
</tr>
</table>
<center><a href="../SubstitutionsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="RedefineIntrinsicTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>