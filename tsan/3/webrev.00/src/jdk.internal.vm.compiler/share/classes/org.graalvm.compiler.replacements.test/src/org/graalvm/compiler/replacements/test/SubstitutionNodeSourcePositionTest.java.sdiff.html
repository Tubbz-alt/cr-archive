<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/SubstitutionNodeSourcePositionTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="StringSubstitutionsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="SubstitutionsTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/SubstitutionNodeSourcePositionTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.replacements.test;
 26 
 27 import static org.graalvm.compiler.core.GraalCompiler.compileGraph;
 28 import static org.graalvm.compiler.core.common.GraalOptions.TrackNodeSourcePosition;

 29 
 30 import java.util.List;
 31 
 32 import org.graalvm.compiler.api.directives.GraalDirectives;
 33 import org.graalvm.compiler.api.replacements.ClassSubstitution;
 34 import org.graalvm.compiler.api.replacements.MethodSubstitution;
 35 import org.graalvm.compiler.code.CompilationResult;
 36 import org.graalvm.compiler.code.SourceMapping;
 37 import org.graalvm.compiler.graph.Node;
 38 import org.graalvm.compiler.graph.NodeSourcePosition;
 39 import org.graalvm.compiler.lir.asm.CompilationResultBuilderFactory;
 40 import org.graalvm.compiler.nodes.StructuredGraph;
 41 import org.graalvm.compiler.nodes.debug.BlackholeNode;
 42 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 43 import org.graalvm.compiler.options.OptionValues;
 44 import org.graalvm.compiler.phases.OptimisticOptimizations;
 45 import org.graalvm.compiler.replacements.classfile.ClassfileBytecodeProvider;
 46 import org.junit.Assert;

 47 import org.junit.Test;
 48 
 49 import jdk.vm.ci.meta.ResolvedJavaMethod;
 50 import jdk.vm.ci.meta.ResolvedJavaType;
 51 
 52 /**
 53  * Test that various substitution implementations produce the expected
 54  * {@link org.graalvm.compiler.graph.NodeSourcePosition} structure. Method substitutions and method
 55  * plugins should leave behind a frame for the substitution. Method substitutions should have
 56  * bytecodes below the substitution. Snippet lowerings should just have the bytecodes without a
 57  * marker frame.
 58  */
 59 public class SubstitutionNodeSourcePositionTest extends ReplacementsTest {
 60 
 61     private static class TestMethod {
 62 
 63         public static int test(int i) {
 64             return i;
 65         }
 66     }
 67 
 68     @ClassSubstitution(TestMethod.class)
 69     public static class TestMethodSubstitution {
 70 
 71         @MethodSubstitution
 72         public static int test(int i) {
 73             blackhole(i);
 74             return i;
 75         }
 76 
 77         @Node.NodeIntrinsic(BlackholeNode.class)
 78         private static native void blackhole(int i);
 79     }
 80 
 81     @Override
 82     protected void registerInvocationPlugins(InvocationPlugins invocationPlugins) {
 83         new PluginFactory_SubstitutionNodeSourcePositionTest().registerPlugins(invocationPlugins, null);
 84         ClassfileBytecodeProvider bytecodeProvider = getSystemClassLoaderBytecodeProvider();
<span class="line-modified"> 85         InvocationPlugins.Registration r = new InvocationPlugins.Registration(invocationPlugins, TestMethod.class, bytecodeProvider);</span>
 86         r.registerMethodSubstitution(TestMethodSubstitution.class, &quot;test&quot;, int.class);
 87         super.registerInvocationPlugins(invocationPlugins);
 88     }
 89 
 90     public int methodSubstitution() {
 91         return TestMethod.test(42);
 92     }
 93 
 94     @Test
 95     public void testMethodSubstitution() {
 96         // @formatter:off
 97         // Expect mappings of the form:
 98         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest$TestMethodSubstitution.blackhole(int) [bci: -1]
 99         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest$TestMethodSubstitution.test(SubstitutionNodeSourcePositionTest.java:71) [bci: 1] Substitution
100         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest$TestMethod.test(int) [bci: -1]
101         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest.methodSubstitution(SubstitutionNodeSourcePositionTest.java:89) [bci: 2]
102         // @formatter:on

103         checkMappings(&quot;methodSubstitution&quot;, true, TestMethod.class, &quot;test&quot;);
104     }
105 
106     public void snippetLowering(String[] array, String value) {
107         array[0] = value;
108     }
109 
110     @Test
111     public void testSnippetLowering() {
112         // @formatter:off
113         // Expect mappings of the form:
114         //   at org.graalvm.compiler.hotspot.replacements.WriteBarrierSnippets.serialWriteBarrier(WriteBarrierSnippets.java:140) [bci: 18]
115         //   at org.graalvm.compiler.hotspot.replacements.WriteBarrierSnippets.serialPreciseWriteBarrier(WriteBarrierSnippets.java:158) [bci: 5] Substitution
116         //   at org.graalvm.compiler.hotspot.replacements.WriteBarrierSnippets.serialPreciseWriteBarrier(AddressNode$Address, WriteBarrierSnippets$Counters) [bci: -1] Substitution
117         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest.snippetLowering(SubstitutionNodeSourcePositionTest.java:99) [bci: 3]
118         // @formatter:on
119         //
120         // The precise snippet bytecodes don&#39;t matter, just ensure that some actually appear after
121         // lowering.

122         checkMappings(&quot;snippetLowering&quot;, true, SubstitutionNodeSourcePositionTest.class, &quot;snippetLowering&quot;);
123     }
124 
125     public int methodPlugin(int i) {
126         GraalDirectives.blackhole(i);
127         return i;
128     }
129 
130     @Test
131     public void testMethodPlugin() {
132         // @formatter:off
133         // Expect mappings of the form:
134         //   at org.graalvm.compiler.api.directives.GraalDirectives.blackhole(int) [bci: -1]
135         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest.methodPlugin(SubstitutionNodeSourcePositionTest.java:109) [bci: 1]
136         // @formatter:on
137         checkMappings(&quot;methodPlugin&quot;, false, GraalDirectives.class, &quot;blackhole&quot;);
138     }
139 
140     private void checkMappings(String snippetMethod, boolean hasBytecodes, Class&lt;?&gt; boundaryClass, String boundaryMethod) {
141         List&lt;SourceMapping&gt; mappings = getSourceMappings(snippetMethod);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.replacements.test;
 26 
 27 import static org.graalvm.compiler.core.GraalCompiler.compileGraph;
 28 import static org.graalvm.compiler.core.common.GraalOptions.TrackNodeSourcePosition;
<span class="line-added"> 29 import static org.graalvm.compiler.core.common.GraalOptions.UseEncodedGraphs;</span>
 30 
 31 import java.util.List;
 32 
 33 import org.graalvm.compiler.api.directives.GraalDirectives;
 34 import org.graalvm.compiler.api.replacements.ClassSubstitution;
 35 import org.graalvm.compiler.api.replacements.MethodSubstitution;
 36 import org.graalvm.compiler.code.CompilationResult;
 37 import org.graalvm.compiler.code.SourceMapping;
 38 import org.graalvm.compiler.graph.Node;
 39 import org.graalvm.compiler.graph.NodeSourcePosition;
 40 import org.graalvm.compiler.lir.asm.CompilationResultBuilderFactory;
 41 import org.graalvm.compiler.nodes.StructuredGraph;
 42 import org.graalvm.compiler.nodes.debug.BlackholeNode;
 43 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 44 import org.graalvm.compiler.options.OptionValues;
 45 import org.graalvm.compiler.phases.OptimisticOptimizations;
 46 import org.graalvm.compiler.replacements.classfile.ClassfileBytecodeProvider;
 47 import org.junit.Assert;
<span class="line-added"> 48 import org.junit.Assume;</span>
 49 import org.junit.Test;
 50 
 51 import jdk.vm.ci.meta.ResolvedJavaMethod;
 52 import jdk.vm.ci.meta.ResolvedJavaType;
 53 
 54 /**
 55  * Test that various substitution implementations produce the expected
 56  * {@link org.graalvm.compiler.graph.NodeSourcePosition} structure. Method substitutions and method
 57  * plugins should leave behind a frame for the substitution. Method substitutions should have
 58  * bytecodes below the substitution. Snippet lowerings should just have the bytecodes without a
 59  * marker frame.
 60  */
 61 public class SubstitutionNodeSourcePositionTest extends ReplacementsTest {
 62 
 63     private static class TestMethod {
 64 
 65         public static int test(int i) {
 66             return i;
 67         }
 68     }
 69 
 70     @ClassSubstitution(TestMethod.class)
 71     public static class TestMethodSubstitution {
 72 
 73         @MethodSubstitution
 74         public static int test(int i) {
 75             blackhole(i);
 76             return i;
 77         }
 78 
 79         @Node.NodeIntrinsic(BlackholeNode.class)
 80         private static native void blackhole(int i);
 81     }
 82 
 83     @Override
 84     protected void registerInvocationPlugins(InvocationPlugins invocationPlugins) {
 85         new PluginFactory_SubstitutionNodeSourcePositionTest().registerPlugins(invocationPlugins, null);
 86         ClassfileBytecodeProvider bytecodeProvider = getSystemClassLoaderBytecodeProvider();
<span class="line-modified"> 87         InvocationPlugins.Registration r = new InvocationPlugins.Registration(invocationPlugins, TestMethod.class, getReplacements(), bytecodeProvider);</span>
 88         r.registerMethodSubstitution(TestMethodSubstitution.class, &quot;test&quot;, int.class);
 89         super.registerInvocationPlugins(invocationPlugins);
 90     }
 91 
 92     public int methodSubstitution() {
 93         return TestMethod.test(42);
 94     }
 95 
 96     @Test
 97     public void testMethodSubstitution() {
 98         // @formatter:off
 99         // Expect mappings of the form:
100         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest$TestMethodSubstitution.blackhole(int) [bci: -1]
101         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest$TestMethodSubstitution.test(SubstitutionNodeSourcePositionTest.java:71) [bci: 1] Substitution
102         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest$TestMethod.test(int) [bci: -1]
103         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest.methodSubstitution(SubstitutionNodeSourcePositionTest.java:89) [bci: 2]
104         // @formatter:on
<span class="line-added">105         Assume.assumeFalse(UseEncodedGraphs.getValue(getInitialOptions()));</span>
106         checkMappings(&quot;methodSubstitution&quot;, true, TestMethod.class, &quot;test&quot;);
107     }
108 
109     public void snippetLowering(String[] array, String value) {
110         array[0] = value;
111     }
112 
113     @Test
114     public void testSnippetLowering() {
115         // @formatter:off
116         // Expect mappings of the form:
117         //   at org.graalvm.compiler.hotspot.replacements.WriteBarrierSnippets.serialWriteBarrier(WriteBarrierSnippets.java:140) [bci: 18]
118         //   at org.graalvm.compiler.hotspot.replacements.WriteBarrierSnippets.serialPreciseWriteBarrier(WriteBarrierSnippets.java:158) [bci: 5] Substitution
119         //   at org.graalvm.compiler.hotspot.replacements.WriteBarrierSnippets.serialPreciseWriteBarrier(AddressNode$Address, WriteBarrierSnippets$Counters) [bci: -1] Substitution
120         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest.snippetLowering(SubstitutionNodeSourcePositionTest.java:99) [bci: 3]
121         // @formatter:on
122         //
123         // The precise snippet bytecodes don&#39;t matter, just ensure that some actually appear after
124         // lowering.
<span class="line-added">125         Assume.assumeFalse(UseEncodedGraphs.getValue(getInitialOptions()));</span>
126         checkMappings(&quot;snippetLowering&quot;, true, SubstitutionNodeSourcePositionTest.class, &quot;snippetLowering&quot;);
127     }
128 
129     public int methodPlugin(int i) {
130         GraalDirectives.blackhole(i);
131         return i;
132     }
133 
134     @Test
135     public void testMethodPlugin() {
136         // @formatter:off
137         // Expect mappings of the form:
138         //   at org.graalvm.compiler.api.directives.GraalDirectives.blackhole(int) [bci: -1]
139         //   at org.graalvm.compiler.replacements.test.SubstitutionNodeSourcePositionTest.methodPlugin(SubstitutionNodeSourcePositionTest.java:109) [bci: 1]
140         // @formatter:on
141         checkMappings(&quot;methodPlugin&quot;, false, GraalDirectives.class, &quot;blackhole&quot;);
142     }
143 
144     private void checkMappings(String snippetMethod, boolean hasBytecodes, Class&lt;?&gt; boundaryClass, String boundaryMethod) {
145         List&lt;SourceMapping&gt; mappings = getSourceMappings(snippetMethod);
</pre>
</td>
</tr>
</table>
<center><a href="StringSubstitutionsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="SubstitutionsTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>