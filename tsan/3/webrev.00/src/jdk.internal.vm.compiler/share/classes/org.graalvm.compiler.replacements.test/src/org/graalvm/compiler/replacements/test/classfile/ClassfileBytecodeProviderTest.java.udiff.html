<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/classfile/ClassfileBytecodeProviderTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../SubstitutionsTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="RedefineIntrinsicTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.test/src/org/graalvm/compiler/replacements/test/classfile/ClassfileBytecodeProviderTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -85,16 +85,10 @@</span>
  import java.util.Enumeration;
  import java.util.Formatter;
  import java.util.zip.ZipEntry;
  import java.util.zip.ZipFile;
  
<span class="udiff-line-removed">- import org.graalvm.compiler.test.SubprocessUtil;</span>
<span class="udiff-line-removed">- import org.junit.Assert;</span>
<span class="udiff-line-removed">- import org.junit.Assume;</span>
<span class="udiff-line-removed">- import org.junit.Before;</span>
<span class="udiff-line-removed">- import org.junit.Test;</span>
<span class="udiff-line-removed">- </span>
  import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
  import org.graalvm.compiler.api.test.Graal;
  import org.graalvm.compiler.bytecode.Bytecode;
  import org.graalvm.compiler.bytecode.BytecodeDisassembler;
  import org.graalvm.compiler.bytecode.BytecodeLookupSwitch;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -107,10 +101,17 @@</span>
  import org.graalvm.compiler.phases.VerifyPhase;
  import org.graalvm.compiler.phases.util.Providers;
  import org.graalvm.compiler.replacements.classfile.ClassfileBytecode;
  import org.graalvm.compiler.replacements.classfile.ClassfileBytecodeProvider;
  import org.graalvm.compiler.runtime.RuntimeProvider;
<span class="udiff-line-added">+ import org.graalvm.compiler.serviceprovider.JavaVersionUtil;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.api.test.ModuleSupport;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.test.SubprocessUtil;</span>
<span class="udiff-line-added">+ import org.junit.Assert;</span>
<span class="udiff-line-added">+ import org.junit.Assume;</span>
<span class="udiff-line-added">+ import org.junit.Before;</span>
<span class="udiff-line-added">+ import org.junit.Test;</span>
  
  import jdk.vm.ci.meta.ConstantPool;
  import jdk.vm.ci.meta.JavaField;
  import jdk.vm.ci.meta.JavaMethodProfile.ProfiledMethod;
  import jdk.vm.ci.meta.JavaType;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -138,48 +139,95 @@</span>
              return name.contains(&quot;jvmci&quot;) || name.contains(&quot;graal&quot;);
          }
          return false;
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Keep test time down by only sampling a limited number of class files per jar.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static final int CLASSES_PER_JAR = 250;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Magic token to denote the classes in the Java runtime image (i.e. in the {@code jrt:/} file</span>
<span class="udiff-line-added">+      * system).</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public static final String JRT_CLASS_PATH_ENTRY = &quot;&lt;jrt&gt;&quot;;</span>
<span class="udiff-line-added">+ </span>
      @Test
      public void test() {
          RuntimeProvider rt = Graal.getRequiredCapability(RuntimeProvider.class);
          Providers providers = rt.getHostBackend().getProviders();
          MetaAccessProvider metaAccess = providers.getMetaAccess();
  
          Assume.assumeTrue(VerifyPhase.class.desiredAssertionStatus());
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         String propertyName = Java8OrEarlier ? &quot;sun.boot.class.path&quot; : &quot;jdk.module.path&quot;;</span>
<span class="udiff-line-modified-removed">-         String bootclasspath = System.getProperty(propertyName);</span>
<span class="udiff-line-modified-removed">-         Assert.assertNotNull(&quot;Cannot find value of &quot; + propertyName, bootclasspath);</span>
<span class="udiff-line-modified-added">+         String bootclasspath;</span>
<span class="udiff-line-modified-added">+         if (JavaVersionUtil.JAVA_SPEC &lt;= 8) {</span>
<span class="udiff-line-modified-added">+             String propertyName = &quot;sun.boot.class.path&quot;;</span>
<span class="udiff-line-modified-added">+             bootclasspath = System.getProperty(propertyName);</span>
<span class="udiff-line-added">+             Assert.assertNotNull(&quot;Cannot find value of &quot; + propertyName, bootclasspath);</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             bootclasspath = JRT_CLASS_PATH_ENTRY;</span>
<span class="udiff-line-added">+         }</span>
  
          for (String path : bootclasspath.split(File.pathSeparator)) {
              if (shouldProcess(path)) {
                  try {
<span class="udiff-line-modified-removed">-                     final ZipFile zipFile = new ZipFile(new File(path));</span>
<span class="udiff-line-modified-removed">-                     for (final Enumeration&lt;? extends ZipEntry&gt; entry = zipFile.entries(); entry.hasMoreElements();) {</span>
<span class="udiff-line-modified-removed">-                         final ZipEntry zipEntry = entry.nextElement();</span>
<span class="udiff-line-removed">-                         String name = zipEntry.getName();</span>
<span class="udiff-line-removed">-                         if (name.endsWith(&quot;.class&quot;) &amp;&amp; !name.equals(&quot;module-info.class&quot;) &amp;&amp; !name.startsWith(&quot;META-INF/versions/&quot;)) {</span>
<span class="udiff-line-removed">-                             String className = name.substring(0, name.length() - &quot;.class&quot;.length()).replace(&#39;/&#39;, &#39;.&#39;);</span>
<span class="udiff-line-removed">-                             if (isInNativeImage(className)) {</span>
<span class="udiff-line-modified-added">+                     if (path.equals(JRT_CLASS_PATH_ENTRY)) {</span>
<span class="udiff-line-modified-added">+                         for (String className : ModuleSupport.getJRTGraalClassNames()) {</span>
<span class="udiff-line-modified-added">+                             if (isGSON(className)) {</span>
                                  /*
<span class="udiff-line-modified-removed">-                                  * Native image requires non-graalsdk classes to be present in the</span>
<span class="udiff-line-removed">-                                  * classpath.</span>
<span class="udiff-line-modified-added">+                                  * GSON classes are compiled with old JDK</span>
                                   */
                                  continue;
                              }
<span class="udiff-line-removed">-                             if (isGSON(className)) {</span>
<span class="udiff-line-removed">-                                 /* uses old class format */</span>
<span class="udiff-line-removed">-                                 continue;</span>
<span class="udiff-line-removed">-                             }</span>
                              try {
                                  checkClass(metaAccess, getSnippetReflection(), className);
                              } catch (ClassNotFoundException e) {
                                  throw new AssertionError(e);
                              }
                          }
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         final ZipFile zipFile = new ZipFile(new File(path));</span>
<span class="udiff-line-added">+                         int index = 0;</span>
<span class="udiff-line-added">+                         int step = zipFile.size() &gt; CLASSES_PER_JAR ? zipFile.size() / CLASSES_PER_JAR : 1;</span>
<span class="udiff-line-added">+                         for (final Enumeration&lt;? extends ZipEntry&gt; entry = zipFile.entries(); entry.hasMoreElements();) {</span>
<span class="udiff-line-added">+                             final ZipEntry zipEntry = entry.nextElement();</span>
<span class="udiff-line-added">+                             if ((index % step) == 0) {</span>
<span class="udiff-line-added">+                                 String name = zipEntry.getName();</span>
<span class="udiff-line-added">+                                 if (name.endsWith(&quot;.class&quot;) &amp;&amp; !name.equals(&quot;module-info.class&quot;) &amp;&amp; !name.startsWith(&quot;META-INF/versions/&quot;)) {</span>
<span class="udiff-line-added">+                                     String className = name.substring(0, name.length() - &quot;.class&quot;.length()).replace(&#39;/&#39;, &#39;.&#39;);</span>
<span class="udiff-line-added">+                                     if (isInNativeImage(className)) {</span>
<span class="udiff-line-added">+                                         /*</span>
<span class="udiff-line-added">+                                          * Native image requires non-graalsdk classes to be present</span>
<span class="udiff-line-added">+                                          * in the classpath.</span>
<span class="udiff-line-added">+                                          */</span>
<span class="udiff-line-added">+                                         continue;</span>
<span class="udiff-line-added">+                                     }</span>
<span class="udiff-line-added">+                                     if (isGSON(className)) {</span>
<span class="udiff-line-added">+                                         /* uses old class format */</span>
<span class="udiff-line-added">+                                         continue;</span>
<span class="udiff-line-added">+                                     }</span>
<span class="udiff-line-added">+                                     try {</span>
<span class="udiff-line-added">+                                         checkClass(metaAccess, getSnippetReflection(), className);</span>
<span class="udiff-line-added">+                                     } catch (UnsupportedClassVersionError e) {</span>
<span class="udiff-line-added">+                                         // graal-test.jar can contain classes compiled for different</span>
<span class="udiff-line-added">+                                         // Java versions</span>
<span class="udiff-line-added">+                                     } catch (NoClassDefFoundError e) {</span>
<span class="udiff-line-added">+                                         if (!e.getMessage().contains(&quot;Could not initialize class&quot;)) {</span>
<span class="udiff-line-added">+                                             throw e;</span>
<span class="udiff-line-added">+                                         } else {</span>
<span class="udiff-line-added">+                                             // A second or later attempt to initialize a class</span>
<span class="udiff-line-added">+                                             // results in this confusing error where the</span>
<span class="udiff-line-added">+                                             // original cause of initialization failure is lost</span>
<span class="udiff-line-added">+                                         }</span>
<span class="udiff-line-added">+                                     } catch (ClassNotFoundException e) {</span>
<span class="udiff-line-added">+                                         throw new AssertionError(e);</span>
<span class="udiff-line-added">+                                     }</span>
<span class="udiff-line-added">+                                 }</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                             index++;</span>
<span class="udiff-line-added">+                         }</span>
                      }
                  } catch (IOException ex) {
                      Assert.fail(ex.toString());
                  }
              }
</pre>
<center><a href="../SubstitutionsTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="RedefineIntrinsicTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>