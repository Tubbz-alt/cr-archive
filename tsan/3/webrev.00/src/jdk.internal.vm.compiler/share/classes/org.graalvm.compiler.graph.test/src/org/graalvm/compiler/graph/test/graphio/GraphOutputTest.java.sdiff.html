<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.graph.test/src/org/graalvm/compiler/graph/test/graphio/GraphOutputTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../org.graalvm.compiler.debug/src/org/graalvm/compiler/debug/Versions.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../org.graalvm.compiler.graph/src/org/graalvm/compiler/graph/Edges.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.graph.test/src/org/graalvm/compiler/graph/test/graphio/GraphOutputTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 23 
 24 
 25 package org.graalvm.compiler.graph.test.graphio;
 26 
 27 import static org.junit.Assert.assertArrayEquals;
 28 import static org.junit.Assert.assertFalse;
 29 import static org.junit.Assert.assertTrue;
 30 import static org.junit.Assert.fail;
 31 
 32 import java.io.ByteArrayOutputStream;
 33 import java.io.IOException;
 34 import java.nio.ByteBuffer;
 35 import java.nio.channels.Channels;
 36 import java.nio.channels.WritableByteChannel;
 37 import java.util.Collection;
 38 import java.util.Collections;
 39 import java.util.Map;
 40 import java.util.Objects;
 41 import org.graalvm.graphio.GraphOutput;
 42 import org.graalvm.graphio.GraphStructure;


 43 import org.junit.Test;

 44 
 45 public final class GraphOutputTest {
 46 
 47     @Test
 48     @SuppressWarnings(&quot;static-method&quot;)
 49     public void testWritableByteChannel() throws IOException {
 50         ByteArrayOutputStream out = new ByteArrayOutputStream();
 51         WritableByteChannel channel = Channels.newChannel(out);
 52         ByteBuffer data = generateData(1 &lt;&lt; 17);
 53         GraphOutput&lt;?, ?&gt; graphOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).embedded(true).build(channel);
 54         try (GraphOutput&lt;?, ?&gt; closable = graphOutput) {
 55             assertTrue(closable.isOpen());
 56             closable.write(data);
 57         }
 58         assertFalse(graphOutput.isOpen());
 59         assertArrayEquals(data.array(), out.toByteArray());
 60     }
 61 
 62     @Test
 63     @SuppressWarnings(&quot;static-method&quot;)
</pre>
<hr />
<pre>
 99         try (GraphOutput&lt;MockGraph, ?&gt; graphOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).build(expectedChannel)) {
100             graphOutput.print(new MockGraph(), properties, 1, &quot;Graph 1&quot;);
101             graphOutput.write(ByteBuffer.allocate(0));
102             graphOutput.print(new MockGraph(), properties, 2, &quot;Graph 1&quot;);
103         }
104         ByteArrayOutputStream embedded = new ByteArrayOutputStream();
105         SharedWritableByteChannel embeddChannel = new SharedWritableByteChannel(Channels.newChannel(embedded));
106         try {
107             try (GraphOutput&lt;MockGraph, ?&gt; baseOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).build(embeddChannel)) {
108                 try (GraphOutput&lt;MockGraph, ?&gt; embeddedOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).embedded(true).build((WritableByteChannel) baseOutput)) {
109                     embeddedOutput.print(new MockGraph(), properties, 1, &quot;Graph 1&quot;);
110                     baseOutput.print(new MockGraph(), properties, 2, &quot;Graph 1&quot;);
111                 }
112             }
113         } finally {
114             embeddChannel.realClose();
115         }
116         assertArrayEquals(expected.toByteArray(), embedded.toByteArray());
117     }
118 












119     private static ByteBuffer generateData(int size) {
120         ByteBuffer buffer = ByteBuffer.allocate(size);
121         for (int i = 0; i &lt; size; i++) {
122             buffer.put(i, (byte) i);
123         }
124         buffer.limit(size);
125         return buffer;
126     }
127 
128     private static final class SharedWritableByteChannel implements WritableByteChannel {
129 
130         private final WritableByteChannel delegate;
131 
132         SharedWritableByteChannel(WritableByteChannel delegate) {
133             Objects.requireNonNull(delegate, &quot;Delegate must be non null.&quot;);
134             this.delegate = delegate;
135         }
136 
137         @Override
138         public int write(ByteBuffer bb) throws IOException {
</pre>
<hr />
<pre>
264         public Object edgeType(Void port, int index) {
265             onEnter();
266             return null;
267         }
268 
269         @Override
270         public Collection&lt;? extends Void&gt; edgeNodes(MockGraph graph, Void node, Void port, int index) {
271             onEnter();
272             return null;
273         }
274 
275         private void onEnter() {
276             if (enterAction != null) {
277                 enterAction.run();
278             }
279         }
280     }
281 
282     private static final class MockGraph {
283     }
















284 }
</pre>
</td>
<td>
<hr />
<pre>
 23 
 24 
 25 package org.graalvm.compiler.graph.test.graphio;
 26 
 27 import static org.junit.Assert.assertArrayEquals;
 28 import static org.junit.Assert.assertFalse;
 29 import static org.junit.Assert.assertTrue;
 30 import static org.junit.Assert.fail;
 31 
 32 import java.io.ByteArrayOutputStream;
 33 import java.io.IOException;
 34 import java.nio.ByteBuffer;
 35 import java.nio.channels.Channels;
 36 import java.nio.channels.WritableByteChannel;
 37 import java.util.Collection;
 38 import java.util.Collections;
 39 import java.util.Map;
 40 import java.util.Objects;
 41 import org.graalvm.graphio.GraphOutput;
 42 import org.graalvm.graphio.GraphStructure;
<span class="line-added"> 43 import org.graalvm.graphio.GraphTypes;</span>
<span class="line-added"> 44 import static org.junit.Assert.assertSame;</span>
 45 import org.junit.Test;
<span class="line-added"> 46 import java.lang.reflect.Field;</span>
 47 
 48 public final class GraphOutputTest {
 49 
 50     @Test
 51     @SuppressWarnings(&quot;static-method&quot;)
 52     public void testWritableByteChannel() throws IOException {
 53         ByteArrayOutputStream out = new ByteArrayOutputStream();
 54         WritableByteChannel channel = Channels.newChannel(out);
 55         ByteBuffer data = generateData(1 &lt;&lt; 17);
 56         GraphOutput&lt;?, ?&gt; graphOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).embedded(true).build(channel);
 57         try (GraphOutput&lt;?, ?&gt; closable = graphOutput) {
 58             assertTrue(closable.isOpen());
 59             closable.write(data);
 60         }
 61         assertFalse(graphOutput.isOpen());
 62         assertArrayEquals(data.array(), out.toByteArray());
 63     }
 64 
 65     @Test
 66     @SuppressWarnings(&quot;static-method&quot;)
</pre>
<hr />
<pre>
102         try (GraphOutput&lt;MockGraph, ?&gt; graphOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).build(expectedChannel)) {
103             graphOutput.print(new MockGraph(), properties, 1, &quot;Graph 1&quot;);
104             graphOutput.write(ByteBuffer.allocate(0));
105             graphOutput.print(new MockGraph(), properties, 2, &quot;Graph 1&quot;);
106         }
107         ByteArrayOutputStream embedded = new ByteArrayOutputStream();
108         SharedWritableByteChannel embeddChannel = new SharedWritableByteChannel(Channels.newChannel(embedded));
109         try {
110             try (GraphOutput&lt;MockGraph, ?&gt; baseOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).build(embeddChannel)) {
111                 try (GraphOutput&lt;MockGraph, ?&gt; embeddedOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).embedded(true).build((WritableByteChannel) baseOutput)) {
112                     embeddedOutput.print(new MockGraph(), properties, 1, &quot;Graph 1&quot;);
113                     baseOutput.print(new MockGraph(), properties, 2, &quot;Graph 1&quot;);
114                 }
115             }
116         } finally {
117             embeddChannel.realClose();
118         }
119         assertArrayEquals(expected.toByteArray(), embedded.toByteArray());
120     }
121 
<span class="line-added">122     @Test</span>
<span class="line-added">123     @SuppressWarnings({&quot;static-method&quot;, &quot;unchecked&quot;})</span>
<span class="line-added">124     public void testClassOfEnumValueWithImplementation() throws ClassNotFoundException, ReflectiveOperationException {</span>
<span class="line-added">125         Class&lt;? extends GraphTypes&gt; defaultTypesClass = (Class&lt;? extends GraphTypes&gt;) Class.forName(&quot;org.graalvm.graphio.DefaultGraphTypes&quot;);</span>
<span class="line-added">126         Field f = defaultTypesClass.getDeclaredField(&quot;DEFAULT&quot;);</span>
<span class="line-added">127         f.setAccessible(true);</span>
<span class="line-added">128         GraphTypes types = (GraphTypes) f.get(null);</span>
<span class="line-added">129 </span>
<span class="line-added">130         Object clazz = types.enumClass(CustomEnum.ONE);</span>
<span class="line-added">131         assertSame(CustomEnum.class, clazz);</span>
<span class="line-added">132     }</span>
<span class="line-added">133 </span>
134     private static ByteBuffer generateData(int size) {
135         ByteBuffer buffer = ByteBuffer.allocate(size);
136         for (int i = 0; i &lt; size; i++) {
137             buffer.put(i, (byte) i);
138         }
139         buffer.limit(size);
140         return buffer;
141     }
142 
143     private static final class SharedWritableByteChannel implements WritableByteChannel {
144 
145         private final WritableByteChannel delegate;
146 
147         SharedWritableByteChannel(WritableByteChannel delegate) {
148             Objects.requireNonNull(delegate, &quot;Delegate must be non null.&quot;);
149             this.delegate = delegate;
150         }
151 
152         @Override
153         public int write(ByteBuffer bb) throws IOException {
</pre>
<hr />
<pre>
279         public Object edgeType(Void port, int index) {
280             onEnter();
281             return null;
282         }
283 
284         @Override
285         public Collection&lt;? extends Void&gt; edgeNodes(MockGraph graph, Void node, Void port, int index) {
286             onEnter();
287             return null;
288         }
289 
290         private void onEnter() {
291             if (enterAction != null) {
292                 enterAction.run();
293             }
294         }
295     }
296 
297     private static final class MockGraph {
298     }
<span class="line-added">299 </span>
<span class="line-added">300     private enum CustomEnum {</span>
<span class="line-added">301         ONE() {</span>
<span class="line-added">302             @Override</span>
<span class="line-added">303             public String toString() {</span>
<span class="line-added">304                 return &quot;one&quot;;</span>
<span class="line-added">305             }</span>
<span class="line-added">306         },</span>
<span class="line-added">307 </span>
<span class="line-added">308         TWO() {</span>
<span class="line-added">309             @Override</span>
<span class="line-added">310             public String toString() {</span>
<span class="line-added">311                 return &quot;two&quot;;</span>
<span class="line-added">312             }</span>
<span class="line-added">313         }</span>
<span class="line-added">314     }</span>
315 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../org.graalvm.compiler.debug/src/org/graalvm/compiler/debug/Versions.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../org.graalvm.compiler.graph/src/org/graalvm/compiler/graph/Edges.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>