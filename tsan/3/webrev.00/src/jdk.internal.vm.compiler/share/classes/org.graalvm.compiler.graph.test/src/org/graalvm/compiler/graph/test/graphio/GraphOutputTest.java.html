<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.graph.test/src/org/graalvm/compiler/graph/test/graphio/GraphOutputTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.graph.test.graphio;
 26 
 27 import static org.junit.Assert.assertArrayEquals;
 28 import static org.junit.Assert.assertFalse;
 29 import static org.junit.Assert.assertTrue;
 30 import static org.junit.Assert.fail;
 31 
 32 import java.io.ByteArrayOutputStream;
 33 import java.io.IOException;
 34 import java.nio.ByteBuffer;
 35 import java.nio.channels.Channels;
 36 import java.nio.channels.WritableByteChannel;
 37 import java.util.Collection;
 38 import java.util.Collections;
 39 import java.util.Map;
 40 import java.util.Objects;
 41 import org.graalvm.graphio.GraphOutput;
 42 import org.graalvm.graphio.GraphStructure;
 43 import org.graalvm.graphio.GraphTypes;
 44 import static org.junit.Assert.assertSame;
 45 import org.junit.Test;
 46 import java.lang.reflect.Field;
 47 
 48 public final class GraphOutputTest {
 49 
 50     @Test
 51     @SuppressWarnings(&quot;static-method&quot;)
 52     public void testWritableByteChannel() throws IOException {
 53         ByteArrayOutputStream out = new ByteArrayOutputStream();
 54         WritableByteChannel channel = Channels.newChannel(out);
 55         ByteBuffer data = generateData(1 &lt;&lt; 17);
 56         GraphOutput&lt;?, ?&gt; graphOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).embedded(true).build(channel);
 57         try (GraphOutput&lt;?, ?&gt; closable = graphOutput) {
 58             assertTrue(closable.isOpen());
 59             closable.write(data);
 60         }
 61         assertFalse(graphOutput.isOpen());
 62         assertArrayEquals(data.array(), out.toByteArray());
 63     }
 64 
 65     @Test
 66     @SuppressWarnings(&quot;static-method&quot;)
 67     public void testWriteDuringPrint() throws IOException {
 68         ByteArrayOutputStream out = new ByteArrayOutputStream();
 69         WritableByteChannel channel = Channels.newChannel(out);
 70         class Action implements Runnable {
 71             GraphOutput&lt;MockGraph, ?&gt; out;
 72 
 73             @Override
 74             public void run() {
 75                 try {
 76                     ByteBuffer data = ByteBuffer.allocate(16);
 77                     data.limit(16);
 78                     out.write(data);
 79                 } catch (IOException ioe) {
 80                     throw new RuntimeException(ioe);
 81                 }
 82             }
 83         }
 84         Action action = new Action();
 85         try (GraphOutput&lt;MockGraph, ?&gt; graphOutput = GraphOutput.newBuilder(new MockGraphStructure(action)).protocolVersion(6, 0).build(channel)) {
 86             action.out = graphOutput;
 87             try {
 88                 graphOutput.print(new MockGraph(), Collections.emptyMap(), 0, &quot;Mock Graph&quot;);
 89                 fail(&quot;Expected IllegalStateException&quot;);
 90             } catch (IllegalStateException ise) {
 91                 // expected exception
 92             }
 93         }
 94     }
 95 
 96     @Test
 97     @SuppressWarnings(&quot;static-method&quot;)
 98     public void testEmbeddedWritableByteChannel() throws IOException {
 99         ByteArrayOutputStream expected = new ByteArrayOutputStream();
100         WritableByteChannel expectedChannel = Channels.newChannel(expected);
101         Map&lt;Object, Object&gt; properties = Collections.singletonMap(&quot;version.id&quot;, 1);
102         try (GraphOutput&lt;MockGraph, ?&gt; graphOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).build(expectedChannel)) {
103             graphOutput.print(new MockGraph(), properties, 1, &quot;Graph 1&quot;);
104             graphOutput.write(ByteBuffer.allocate(0));
105             graphOutput.print(new MockGraph(), properties, 2, &quot;Graph 1&quot;);
106         }
107         ByteArrayOutputStream embedded = new ByteArrayOutputStream();
108         SharedWritableByteChannel embeddChannel = new SharedWritableByteChannel(Channels.newChannel(embedded));
109         try {
110             try (GraphOutput&lt;MockGraph, ?&gt; baseOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).build(embeddChannel)) {
111                 try (GraphOutput&lt;MockGraph, ?&gt; embeddedOutput = GraphOutput.newBuilder(new MockGraphStructure()).protocolVersion(6, 0).embedded(true).build((WritableByteChannel) baseOutput)) {
112                     embeddedOutput.print(new MockGraph(), properties, 1, &quot;Graph 1&quot;);
113                     baseOutput.print(new MockGraph(), properties, 2, &quot;Graph 1&quot;);
114                 }
115             }
116         } finally {
117             embeddChannel.realClose();
118         }
119         assertArrayEquals(expected.toByteArray(), embedded.toByteArray());
120     }
121 
122     @Test
123     @SuppressWarnings({&quot;static-method&quot;, &quot;unchecked&quot;})
124     public void testClassOfEnumValueWithImplementation() throws ClassNotFoundException, ReflectiveOperationException {
125         Class&lt;? extends GraphTypes&gt; defaultTypesClass = (Class&lt;? extends GraphTypes&gt;) Class.forName(&quot;org.graalvm.graphio.DefaultGraphTypes&quot;);
126         Field f = defaultTypesClass.getDeclaredField(&quot;DEFAULT&quot;);
127         f.setAccessible(true);
128         GraphTypes types = (GraphTypes) f.get(null);
129 
130         Object clazz = types.enumClass(CustomEnum.ONE);
131         assertSame(CustomEnum.class, clazz);
132     }
133 
134     private static ByteBuffer generateData(int size) {
135         ByteBuffer buffer = ByteBuffer.allocate(size);
136         for (int i = 0; i &lt; size; i++) {
137             buffer.put(i, (byte) i);
138         }
139         buffer.limit(size);
140         return buffer;
141     }
142 
143     private static final class SharedWritableByteChannel implements WritableByteChannel {
144 
145         private final WritableByteChannel delegate;
146 
147         SharedWritableByteChannel(WritableByteChannel delegate) {
148             Objects.requireNonNull(delegate, &quot;Delegate must be non null.&quot;);
149             this.delegate = delegate;
150         }
151 
152         @Override
153         public int write(ByteBuffer bb) throws IOException {
154             return delegate.write(bb);
155         }
156 
157         @Override
158         public boolean isOpen() {
159             return delegate.isOpen();
160         }
161 
162         @Override
163         public void close() throws IOException {
164         }
165 
166         void realClose() throws IOException {
167             delegate.close();
168         }
169     }
170 
171     private static final class MockGraphStructure implements GraphStructure&lt;MockGraph, Void, Void, Void&gt; {
172 
173         private final Runnable enterAction;
174 
175         MockGraphStructure() {
176             this.enterAction = null;
177         }
178 
179         MockGraphStructure(Runnable enterAction) {
180             this.enterAction = enterAction;
181         }
182 
183         @Override
184         public MockGraph graph(MockGraph currentGraph, Object obj) {
185             onEnter();
186             return null;
187         }
188 
189         @Override
190         public Iterable&lt;? extends Void&gt; nodes(MockGraph graph) {
191             onEnter();
192             return Collections.emptySet();
193         }
194 
195         @Override
196         public int nodesCount(MockGraph graph) {
197             onEnter();
198             return 0;
199         }
200 
201         @Override
202         public int nodeId(Void node) {
203             onEnter();
204             return 0;
205         }
206 
207         @Override
208         public boolean nodeHasPredecessor(Void node) {
209             onEnter();
210             return false;
211         }
212 
213         @Override
214         public void nodeProperties(MockGraph graph, Void node, Map&lt;String, ? super Object&gt; properties) {
215             onEnter();
216         }
217 
218         @Override
219         public Void node(Object obj) {
220             onEnter();
221             return null;
222         }
223 
224         @Override
225         public Void nodeClass(Object obj) {
226             onEnter();
227             return null;
228         }
229 
230         @Override
231         public Void classForNode(Void node) {
232             onEnter();
233             return null;
234         }
235 
236         @Override
237         public String nameTemplate(Void nodeClass) {
238             onEnter();
239             return null;
240         }
241 
242         @Override
243         public Object nodeClassType(Void nodeClass) {
244             onEnter();
245             return null;
246         }
247 
248         @Override
249         public Void portInputs(Void nodeClass) {
250             onEnter();
251             return null;
252         }
253 
254         @Override
255         public Void portOutputs(Void nodeClass) {
256             onEnter();
257             return null;
258         }
259 
260         @Override
261         public int portSize(Void port) {
262             onEnter();
263             return 0;
264         }
265 
266         @Override
267         public boolean edgeDirect(Void port, int index) {
268             onEnter();
269             return false;
270         }
271 
272         @Override
273         public String edgeName(Void port, int index) {
274             onEnter();
275             return null;
276         }
277 
278         @Override
279         public Object edgeType(Void port, int index) {
280             onEnter();
281             return null;
282         }
283 
284         @Override
285         public Collection&lt;? extends Void&gt; edgeNodes(MockGraph graph, Void node, Void port, int index) {
286             onEnter();
287             return null;
288         }
289 
290         private void onEnter() {
291             if (enterAction != null) {
292                 enterAction.run();
293             }
294         }
295     }
296 
297     private static final class MockGraph {
298     }
299 
300     private enum CustomEnum {
301         ONE() {
302             @Override
303             public String toString() {
304                 return &quot;one&quot;;
305             }
306         },
307 
308         TWO() {
309             @Override
310             public String toString() {
311                 return &quot;two&quot;;
312             }
313         }
314     }
315 }
    </pre>
  </body>
</html>