<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.aarch64/src/org/graalvm/compiler/hotspot/aarch64/AArch64HotSpotRegisterAllocationConfig.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot.aarch64;
 26 
 27 import static jdk.vm.ci.aarch64.AArch64.r0;
 28 import static jdk.vm.ci.aarch64.AArch64.r1;
 29 import static jdk.vm.ci.aarch64.AArch64.r10;
 30 import static jdk.vm.ci.aarch64.AArch64.r11;
 31 import static jdk.vm.ci.aarch64.AArch64.r12;
 32 import static jdk.vm.ci.aarch64.AArch64.r13;
 33 import static jdk.vm.ci.aarch64.AArch64.r14;
 34 import static jdk.vm.ci.aarch64.AArch64.r15;
 35 import static jdk.vm.ci.aarch64.AArch64.r16;
 36 import static jdk.vm.ci.aarch64.AArch64.r17;
 37 import static jdk.vm.ci.aarch64.AArch64.r18;
 38 import static jdk.vm.ci.aarch64.AArch64.r19;
 39 import static jdk.vm.ci.aarch64.AArch64.r2;
 40 import static jdk.vm.ci.aarch64.AArch64.r20;
 41 import static jdk.vm.ci.aarch64.AArch64.r21;
 42 import static jdk.vm.ci.aarch64.AArch64.r22;
 43 import static jdk.vm.ci.aarch64.AArch64.r23;
 44 import static jdk.vm.ci.aarch64.AArch64.r24;
 45 import static jdk.vm.ci.aarch64.AArch64.r25;
 46 import static jdk.vm.ci.aarch64.AArch64.r26;
 47 import static jdk.vm.ci.aarch64.AArch64.r28;
<a name="2" id="anc2"></a><span class="line-added"> 48 import static jdk.vm.ci.aarch64.AArch64.r29;</span>
 49 import static jdk.vm.ci.aarch64.AArch64.r3;
<a name="3" id="anc3"></a><span class="line-added"> 50 import static jdk.vm.ci.aarch64.AArch64.r30;</span>
<span class="line-added"> 51 import static jdk.vm.ci.aarch64.AArch64.r31;</span>
 52 import static jdk.vm.ci.aarch64.AArch64.r4;
 53 import static jdk.vm.ci.aarch64.AArch64.r5;
 54 import static jdk.vm.ci.aarch64.AArch64.r6;
 55 import static jdk.vm.ci.aarch64.AArch64.r7;
 56 import static jdk.vm.ci.aarch64.AArch64.r8;
 57 import static jdk.vm.ci.aarch64.AArch64.r9;
 58 import static jdk.vm.ci.aarch64.AArch64.v0;
 59 import static jdk.vm.ci.aarch64.AArch64.v1;
 60 import static jdk.vm.ci.aarch64.AArch64.v10;
 61 import static jdk.vm.ci.aarch64.AArch64.v11;
 62 import static jdk.vm.ci.aarch64.AArch64.v12;
 63 import static jdk.vm.ci.aarch64.AArch64.v13;
 64 import static jdk.vm.ci.aarch64.AArch64.v14;
 65 import static jdk.vm.ci.aarch64.AArch64.v15;
 66 import static jdk.vm.ci.aarch64.AArch64.v16;
 67 import static jdk.vm.ci.aarch64.AArch64.v17;
 68 import static jdk.vm.ci.aarch64.AArch64.v18;
 69 import static jdk.vm.ci.aarch64.AArch64.v19;
 70 import static jdk.vm.ci.aarch64.AArch64.v2;
 71 import static jdk.vm.ci.aarch64.AArch64.v20;
 72 import static jdk.vm.ci.aarch64.AArch64.v21;
 73 import static jdk.vm.ci.aarch64.AArch64.v22;
 74 import static jdk.vm.ci.aarch64.AArch64.v23;
 75 import static jdk.vm.ci.aarch64.AArch64.v24;
 76 import static jdk.vm.ci.aarch64.AArch64.v25;
 77 import static jdk.vm.ci.aarch64.AArch64.v26;
 78 import static jdk.vm.ci.aarch64.AArch64.v27;
 79 import static jdk.vm.ci.aarch64.AArch64.v28;
 80 import static jdk.vm.ci.aarch64.AArch64.v29;
 81 import static jdk.vm.ci.aarch64.AArch64.v3;
 82 import static jdk.vm.ci.aarch64.AArch64.v30;
 83 import static jdk.vm.ci.aarch64.AArch64.v31;
 84 import static jdk.vm.ci.aarch64.AArch64.v4;
 85 import static jdk.vm.ci.aarch64.AArch64.v5;
 86 import static jdk.vm.ci.aarch64.AArch64.v6;
 87 import static jdk.vm.ci.aarch64.AArch64.v7;
 88 import static jdk.vm.ci.aarch64.AArch64.v8;
 89 import static jdk.vm.ci.aarch64.AArch64.v9;
 90 
 91 import java.util.ArrayList;
 92 import java.util.BitSet;
 93 
 94 import org.graalvm.compiler.core.common.alloc.RegisterAllocationConfig;
 95 
 96 import jdk.vm.ci.code.Register;
 97 import jdk.vm.ci.code.RegisterArray;
 98 import jdk.vm.ci.code.RegisterConfig;
 99 
100 public class AArch64HotSpotRegisterAllocationConfig extends RegisterAllocationConfig {
101 
<a name="4" id="anc4"></a><span class="line-added">102     /**</span>
<span class="line-added">103      * Excluding r27 is a temporary solution until we exclude r27 unconditionally at</span>
<span class="line-added">104      * {@link jdk.vm.ci.hotspot.aarch64.AArch64HotSpotRegisterConfig}.</span>
<span class="line-added">105      *</span>
<span class="line-added">106      * The underlying reason is that HotSpot does not intend to support r27 as an allocatable</span>
<span class="line-added">107      * register. This register is excluded from callee-saved register at</span>
<span class="line-added">108      * cpu/aarch64/sharedRuntime_aarch64.cpp:RegisterSaver::save_live_registers, and may lead to</span>
<span class="line-added">109      * dereferencing unknown value from the stack at</span>
<span class="line-added">110      * share/runtime/stackValue.cpp:StackValue::create_stack_value during deoptimization.</span>
<span class="line-added">111      */</span>
112     // @formatter:off
113     static final Register[] registerAllocationOrder = {
114         r0,  r1,  r2,  r3,  r4,  r5,  r6,  r7,
115         r8,  r9,  r10, r11, r12, r13, r14, r15,
116         r16, r17, r18, r19, r20, r21, r22, r23,
<a name="5" id="anc5"></a><span class="line-modified">117         r24, r25, r26, /* r27, */ r28, r29, r30, r31,</span>
118 
119         v0,  v1,  v2,  v3,  v4,  v5,  v6,  v7,
120         v8,  v9,  v10, v11, v12, v13, v14, v15,
121         v16, v17, v18, v19, v20, v21, v22, v23,
122         v24, v25, v26, v27, v28, v29, v30, v31
123     };
124     // @formatter:on
125 
126     public AArch64HotSpotRegisterAllocationConfig(RegisterConfig registerConfig, String[] allocationRestrictedTo) {
127         super(registerConfig, allocationRestrictedTo);
128     }
129 
130     @Override
131     protected RegisterArray initAllocatable(RegisterArray registers) {
132         BitSet regMap = new BitSet(registerConfig.getAllocatableRegisters().size());
133         for (Register reg : registers) {
134             regMap.set(reg.number);
135         }
136 
137         ArrayList&lt;Register&gt; allocatableRegisters = new ArrayList&lt;&gt;(registers.size());
138         for (Register reg : registerAllocationOrder) {
139             if (regMap.get(reg.number)) {
140                 allocatableRegisters.add(reg);
141             }
142         }
143 
144         return super.initAllocatable(new RegisterArray(allocatableRegisters));
145     }
146 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>