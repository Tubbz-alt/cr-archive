<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/replacements/HotSpotReplacementsUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotClassSubstitutions.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="IdentityHashCodeNode.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/replacements/HotSpotReplacementsUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -49,10 +49,11 @@</span>
  import org.graalvm.compiler.nodes.NamedLocationIdentity;
  import org.graalvm.compiler.nodes.NodeView;
  import org.graalvm.compiler.nodes.ValueNode;
  import org.graalvm.compiler.nodes.extended.ForeignCallNode;
  import org.graalvm.compiler.nodes.extended.LoadHubNode;
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.extended.LoadHubOrNullNode;</span>
  import org.graalvm.compiler.nodes.extended.RawLoadNode;
  import org.graalvm.compiler.nodes.extended.StoreHubNode;
  import org.graalvm.compiler.nodes.graphbuilderconf.IntrinsicContext;
  import org.graalvm.compiler.nodes.memory.Access;
  import org.graalvm.compiler.nodes.memory.address.AddressNode;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -152,17 +153,17 @@</span>
              throw new GraalError(e);
          }
      }
  
      @Fold
<span class="udiff-line-modified-removed">-     static int getFieldOffset(ResolvedJavaType type, String fieldName) {</span>
<span class="udiff-line-modified-added">+     public static int getFieldOffset(ResolvedJavaType type, String fieldName) {</span>
          for (ResolvedJavaField field : type.getInstanceFields(true)) {
              if (field.getName().equals(fieldName)) {
                  return field.getOffset();
              }
          }
<span class="udiff-line-modified-removed">-         throw new GraalError(&quot;missing field &quot; + fieldName);</span>
<span class="udiff-line-modified-added">+         throw new GraalError(&quot;missing field &quot; + fieldName + &quot; in type &quot; + type);</span>
      }
  
      public static HotSpotJVMCIRuntime runtime() {
          return HotSpotJVMCIRuntime.runtime();
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -185,10 +186,18 @@</span>
      @Fold
      public static boolean verifyOops(@InjectedParameter GraalHotSpotVMConfig config) {
          return config.verifyOops;
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * @see GraalHotSpotVMConfig#doingUnsafeAccessOffset</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     @Fold</span>
<span class="udiff-line-added">+     public static int doingUnsafeAccessOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
<span class="udiff-line-added">+         return config.doingUnsafeAccessOffset;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public static final LocationIdentity EXCEPTION_OOP_LOCATION = NamedLocationIdentity.mutable(&quot;ExceptionOop&quot;);
  
      /**
       * @see GraalHotSpotVMConfig#threadExceptionOopOffset
       */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -297,15 +306,17 @@</span>
  
      public static final LocationIdentity JAVA_THREAD_OSTHREAD_LOCATION = NamedLocationIdentity.mutable(&quot;JavaThread::_osthread&quot;);
  
      @Fold
      public static int osThreadOffset(@InjectedParameter GraalHotSpotVMConfig config) {
<span class="udiff-line-added">+         assert config.osThreadOffset != Integer.MAX_VALUE;</span>
          return config.osThreadOffset;
      }
  
      @Fold
      public static int osThreadInterruptedOffset(@InjectedParameter GraalHotSpotVMConfig config) {
<span class="udiff-line-added">+         assert config.osThreadInterruptedOffset != Integer.MAX_VALUE;</span>
          return config.osThreadInterruptedOffset;
      }
  
      @Fold
      public static JavaKind getWordKind() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -514,10 +525,15 @@</span>
      @Fold
      public static int objectMonitorEntryListOffset(@InjectedParameter GraalHotSpotVMConfig config) {
          return config.objectMonitorEntryList;
      }
  
<span class="udiff-line-added">+     @Fold</span>
<span class="udiff-line-added">+     public static int objectMonitorSuccOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
<span class="udiff-line-added">+         return config.objectMonitorSucc;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       * Mask for a biasable, locked or unlocked mark word.
       *
       * &lt;pre&gt;
       * +----------------------------------+-+-+
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -683,10 +699,12 @@</span>
  
      public static final LocationIdentity OBJECT_MONITOR_CXQ_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_cxq&quot;);
  
      public static final LocationIdentity OBJECT_MONITOR_ENTRY_LIST_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_EntryList&quot;);
  
<span class="udiff-line-added">+     public static final LocationIdentity OBJECT_MONITOR_SUCC_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_succ&quot;);</span>
<span class="udiff-line-added">+ </span>
      @Fold
      public static int lockDisplacedMarkOffset(@InjectedParameter GraalHotSpotVMConfig config) {
          return config.basicLockDisplacedHeaderOffset;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -760,33 +778,54 @@</span>
      private static native KlassPointer loadKlassFromObjectIntrinsic(Object object, long offset, @ConstantNodeParameter LocationIdentity locationIdentity, @ConstantNodeParameter JavaKind wordKind);
  
      @NodeIntrinsic(value = LoadHubNode.class)
      public static native KlassPointer loadHubIntrinsic(Object object);
  
<span class="udiff-line-modified-removed">-     public static final LocationIdentity CLASS_STATE_LOCATION = NamedLocationIdentity.mutable(&quot;ClassState&quot;);</span>
<span class="udiff-line-modified-added">+     @NodeIntrinsic(value = LoadHubOrNullNode.class)</span>
<span class="udiff-line-added">+     public static native KlassPointer loadHubOrNullIntrinsic(Object object);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static final LocationIdentity CLASS_INIT_STATE_LOCATION = NamedLocationIdentity.mutable(&quot;ClassInitState&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static final LocationIdentity CLASS_INIT_THREAD_LOCATION = NamedLocationIdentity.mutable(&quot;ClassInitThread&quot;);</span>
  
      @Fold
<span class="udiff-line-modified-removed">-     public static int instanceKlassInitStateOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
<span class="udiff-line-modified-added">+     static int instanceKlassInitStateOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
          return config.instanceKlassInitStateOffset;
      }
  
<span class="udiff-line-added">+     @Fold</span>
<span class="udiff-line-added">+     static int instanceKlassInitThreadOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
<span class="udiff-line-added">+         assert config.instanceKlassInitThreadOffset != -1;</span>
<span class="udiff-line-added">+         return config.instanceKlassInitThreadOffset;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      @Fold
      public static int instanceKlassStateFullyInitialized(@InjectedParameter GraalHotSpotVMConfig config) {
          return config.instanceKlassStateFullyInitialized;
      }
  
<span class="udiff-line-added">+     @Fold</span>
<span class="udiff-line-added">+     public static int instanceKlassStateBeingInitialized(@InjectedParameter GraalHotSpotVMConfig config) {</span>
<span class="udiff-line-added">+         assert config.instanceKlassStateBeingInitialized != -1;</span>
<span class="udiff-line-added">+         return config.instanceKlassStateBeingInitialized;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /**
       *
       * @param hub the hub of an InstanceKlass
       * @return true is the InstanceKlass represented by hub is fully initialized
       */
      public static boolean isInstanceKlassFullyInitialized(KlassPointer hub) {
<span class="udiff-line-modified-removed">-         return readInstanceKlassState(hub) == instanceKlassStateFullyInitialized(INJECTED_VMCONFIG);</span>
<span class="udiff-line-modified-added">+         return readInstanceKlassInitState(hub) == instanceKlassStateFullyInitialized(INJECTED_VMCONFIG);</span>
      }
  
<span class="udiff-line-modified-removed">-     private static byte readInstanceKlassState(KlassPointer hub) {</span>
<span class="udiff-line-modified-removed">-         return hub.readByte(instanceKlassInitStateOffset(INJECTED_VMCONFIG), CLASS_STATE_LOCATION);</span>
<span class="udiff-line-modified-added">+     static byte readInstanceKlassInitState(KlassPointer hub) {</span>
<span class="udiff-line-modified-added">+         return hub.readByte(instanceKlassInitStateOffset(INJECTED_VMCONFIG), CLASS_INIT_STATE_LOCATION);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static Word readInstanceKlassInitThread(KlassPointer hub) {</span>
<span class="udiff-line-added">+         return hub.readWord(instanceKlassInitThreadOffset(INJECTED_VMCONFIG), CLASS_INIT_THREAD_LOCATION);</span>
      }
  
      public static final LocationIdentity KLASS_MODIFIER_FLAGS_LOCATION = NamedLocationIdentity.immutable(&quot;Klass::_modifier_flags&quot;);
  
      @Fold
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -848,10 +887,15 @@</span>
      @Fold
      public static long referentOffset(@InjectedParameter MetaAccessProvider metaAccessProvider) {
          return getFieldOffset(metaAccessProvider.lookupJavaType(Reference.class), &quot;referent&quot;);
      }
  
<span class="udiff-line-added">+     @Fold</span>
<span class="udiff-line-added">+     public static ResolvedJavaType referenceType(@InjectedParameter MetaAccessProvider metaAccessProvider) {</span>
<span class="udiff-line-added">+         return metaAccessProvider.lookupJavaType(Reference.class);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public static final LocationIdentity OBJ_ARRAY_KLASS_ELEMENT_KLASS_LOCATION = new HotSpotOptimizingLocationIdentity(&quot;ObjArrayKlass::_element_klass&quot;) {
          @Override
          public ValueNode canonicalizeRead(ValueNode read, AddressNode location, ValueNode object, CanonicalizerTool tool) {
              ValueNode javaObject = findReadHub(object);
              if (javaObject != null) {
</pre>
<center><a href="HotSpotClassSubstitutions.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="IdentityHashCodeNode.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>