<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/CompilationStatistics.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CompilationCounters.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CompilationTask.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/CompilationStatistics.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 31 import java.lang.annotation.Retention;
 32 import java.lang.annotation.RetentionPolicy;
 33 import java.lang.annotation.Target;
 34 import java.lang.reflect.Field;
 35 import java.lang.reflect.Modifier;
 36 import java.util.ArrayDeque;
 37 import java.util.ArrayList;
 38 import java.util.Date;
 39 import java.util.Deque;
 40 import java.util.Locale;
 41 import java.util.concurrent.ConcurrentLinkedDeque;
 42 
 43 import org.graalvm.compiler.debug.CSVUtil;
 44 import org.graalvm.compiler.options.Option;
 45 import org.graalvm.compiler.options.OptionKey;
 46 import org.graalvm.compiler.options.OptionValues;
 47 import org.graalvm.compiler.serviceprovider.GraalServices;
 48 
 49 import jdk.vm.ci.hotspot.HotSpotInstalledCode;
 50 import jdk.vm.ci.hotspot.HotSpotResolvedJavaMethod;

 51 
 52 @SuppressWarnings(&quot;unused&quot;)
 53 public final class CompilationStatistics {
 54 
 55     public static class Options {
 56         // @formatter:off
 57         @Option(help = &quot;Enables CompilationStatistics.&quot;)
 58         public static final OptionKey&lt;Boolean&gt; UseCompilationStatistics = new OptionKey&lt;&gt;(false);
 59         // @formatter:on
 60     }
 61 
 62     private static final long RESOLUTION = 100000000;
 63 
 64     private static final CompilationStatistics DUMMY = new CompilationStatistics(null, false);
 65 
 66     private static ConcurrentLinkedDeque&lt;CompilationStatistics&gt; list = new ConcurrentLinkedDeque&lt;&gt;();
 67 
 68     private static final ThreadLocal&lt;Deque&lt;CompilationStatistics&gt;&gt; current = new ThreadLocal&lt;Deque&lt;CompilationStatistics&gt;&gt;() {
 69 
 70         @Override
</pre>
<hr />
<pre>
172                     long start = stats.startTime - snapshotZeroTime;
173                     long duration = stats.duration;
174                     if (start &lt; 0) {
175                         duration -= -start;
176                         start = 0;
177                     }
178 
179                     int tick = (int) (start / RESOLUTION);
180                     long timeLeft = RESOLUTION - (start % RESOLUTION);
181 
182                     while (tick &lt; timeSpent.length &amp;&amp; duration &gt; 0) {
183                         if (tick &gt; maxTick) {
184                             maxTick = tick;
185                         }
186                         timeSpent[tick] += Math.min(timeLeft, duration);
187                         duration -= timeLeft;
188                         tick++;
189                         timeLeft = RESOLUTION;
190                     }
191                 }
<span class="line-modified">192                 String timelineName = System.getProperty(&quot;stats.timeline.name&quot;);</span>
193                 if (timelineName != null &amp;&amp; !timelineName.isEmpty()) {
194                     out.printf(&quot;%s%c&quot;, CSVUtil.Escape.escape(timelineName), CSVUtil.SEPARATOR);
195                 }
196                 for (int i = 0; i &lt; maxTick; i++) {
197                     out.printf(&quot;%d%c&quot;, normalize(timeSpent[i]), CSVUtil.SEPARATOR);
198                 }
199                 // print last column
200                 out.printf(&quot;%d&quot;, normalize(timeSpent[maxTick]));
201                 out.println();
202             }
203         } catch (Exception e) {
204             throw new RuntimeException(e);
205         }
206     }
207 
208     private static long normalize(long time) {
209         return time * 100 / RESOLUTION;
210     }
211 
212     protected static void dumpCompilations(ConcurrentLinkedDeque&lt;CompilationStatistics&gt; snapshot, String dumpName, String dateString) throws IllegalAccessException, FileNotFoundException {
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 31 import java.lang.annotation.Retention;
 32 import java.lang.annotation.RetentionPolicy;
 33 import java.lang.annotation.Target;
 34 import java.lang.reflect.Field;
 35 import java.lang.reflect.Modifier;
 36 import java.util.ArrayDeque;
 37 import java.util.ArrayList;
 38 import java.util.Date;
 39 import java.util.Deque;
 40 import java.util.Locale;
 41 import java.util.concurrent.ConcurrentLinkedDeque;
 42 
 43 import org.graalvm.compiler.debug.CSVUtil;
 44 import org.graalvm.compiler.options.Option;
 45 import org.graalvm.compiler.options.OptionKey;
 46 import org.graalvm.compiler.options.OptionValues;
 47 import org.graalvm.compiler.serviceprovider.GraalServices;
 48 
 49 import jdk.vm.ci.hotspot.HotSpotInstalledCode;
 50 import jdk.vm.ci.hotspot.HotSpotResolvedJavaMethod;
<span class="line-added"> 51 import jdk.vm.ci.services.Services;</span>
 52 
 53 @SuppressWarnings(&quot;unused&quot;)
 54 public final class CompilationStatistics {
 55 
 56     public static class Options {
 57         // @formatter:off
 58         @Option(help = &quot;Enables CompilationStatistics.&quot;)
 59         public static final OptionKey&lt;Boolean&gt; UseCompilationStatistics = new OptionKey&lt;&gt;(false);
 60         // @formatter:on
 61     }
 62 
 63     private static final long RESOLUTION = 100000000;
 64 
 65     private static final CompilationStatistics DUMMY = new CompilationStatistics(null, false);
 66 
 67     private static ConcurrentLinkedDeque&lt;CompilationStatistics&gt; list = new ConcurrentLinkedDeque&lt;&gt;();
 68 
 69     private static final ThreadLocal&lt;Deque&lt;CompilationStatistics&gt;&gt; current = new ThreadLocal&lt;Deque&lt;CompilationStatistics&gt;&gt;() {
 70 
 71         @Override
</pre>
<hr />
<pre>
173                     long start = stats.startTime - snapshotZeroTime;
174                     long duration = stats.duration;
175                     if (start &lt; 0) {
176                         duration -= -start;
177                         start = 0;
178                     }
179 
180                     int tick = (int) (start / RESOLUTION);
181                     long timeLeft = RESOLUTION - (start % RESOLUTION);
182 
183                     while (tick &lt; timeSpent.length &amp;&amp; duration &gt; 0) {
184                         if (tick &gt; maxTick) {
185                             maxTick = tick;
186                         }
187                         timeSpent[tick] += Math.min(timeLeft, duration);
188                         duration -= timeLeft;
189                         tick++;
190                         timeLeft = RESOLUTION;
191                     }
192                 }
<span class="line-modified">193                 String timelineName = Services.getSavedProperties().get(&quot;stats.timeline.name&quot;);</span>
194                 if (timelineName != null &amp;&amp; !timelineName.isEmpty()) {
195                     out.printf(&quot;%s%c&quot;, CSVUtil.Escape.escape(timelineName), CSVUtil.SEPARATOR);
196                 }
197                 for (int i = 0; i &lt; maxTick; i++) {
198                     out.printf(&quot;%d%c&quot;, normalize(timeSpent[i]), CSVUtil.SEPARATOR);
199                 }
200                 // print last column
201                 out.printf(&quot;%d&quot;, normalize(timeSpent[maxTick]));
202                 out.println();
203             }
204         } catch (Exception e) {
205             throw new RuntimeException(e);
206         }
207     }
208 
209     private static long normalize(long time) {
210         return time * 100 / RESOLUTION;
211     }
212 
213     protected static void dumpCompilations(ConcurrentLinkedDeque&lt;CompilationStatistics&gt; snapshot, String dumpName, String dateString) throws IllegalAccessException, FileNotFoundException {
</pre>
</td>
</tr>
</table>
<center><a href="CompilationCounters.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CompilationTask.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>