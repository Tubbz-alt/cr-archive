<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/CompilerConfigurationFactory.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CompilationWatchDog.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="GraalHotSpotVMConfig.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/CompilerConfigurationFactory.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -24,11 +24,10 @@</span>
  
  package org.graalvm.compiler.hotspot;
  
  import static jdk.vm.ci.common.InitTimer.timer;
  
<span class="udiff-line-removed">- import java.net.URL;</span>
  import java.util.ArrayList;
  import java.util.Collection;
  import java.util.Collections;
  import java.util.List;
  import java.util.stream.Collectors;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -40,24 +39,26 @@</span>
  import org.graalvm.compiler.lir.phases.LIRPhase;
  import org.graalvm.compiler.lir.phases.LIRPhaseSuite;
  import org.graalvm.compiler.options.EnumOptionKey;
  import org.graalvm.compiler.options.Option;
  import org.graalvm.compiler.options.OptionKey;
<span class="udiff-line-added">+ import org.graalvm.compiler.options.OptionStability;</span>
  import org.graalvm.compiler.options.OptionType;
  import org.graalvm.compiler.options.OptionValues;
  import org.graalvm.compiler.phases.BasePhase;
  import org.graalvm.compiler.phases.PhaseSuite;
  import org.graalvm.compiler.phases.tiers.CompilerConfiguration;
  import org.graalvm.compiler.serviceprovider.GraalServices;
  
  import jdk.vm.ci.code.Architecture;
  import jdk.vm.ci.common.InitTimer;
<span class="udiff-line-added">+ import jdk.vm.ci.services.Services;</span>
  
  /**
<span class="udiff-line-modified-removed">-  * A factory that creates the {@link CompilerConfiguration} the Graal compiler will use. Each</span>
<span class="udiff-line-modified-removed">-  * factory must have a unique {@link #name} and {@link #autoSelectionPriority}. The latter imposes a</span>
<span class="udiff-line-modified-removed">-  * total ordering between factories for the purpose of auto-selecting the factory to use.</span>
<span class="udiff-line-modified-added">+  * A factory that creates the {@link CompilerConfiguration} the compiler will use. Each factory must</span>
<span class="udiff-line-modified-added">+  * have a unique {@link #name} and {@link #autoSelectionPriority}. The latter imposes a total</span>
<span class="udiff-line-modified-added">+  * ordering between factories for the purpose of auto-selecting the factory to use.</span>
   */
  public abstract class CompilerConfigurationFactory implements Comparable&lt;CompilerConfigurationFactory&gt; {
  
      enum ShowConfigurationLevel {
          none,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -65,15 +66,15 @@</span>
          verbose
      }
  
      static class Options {
          // @formatter:off
<span class="udiff-line-modified-removed">-         @Option(help = &quot;Names the Graal compiler configuration to use. If omitted, the compiler configuration &quot; +</span>
<span class="udiff-line-modified-added">+         @Option(help = &quot;Names the compiler configuration to use. If omitted, the compiler configuration &quot; +</span>
                         &quot;with the highest auto-selection priority is used. To see the set of available configurations, &quot; +
<span class="udiff-line-modified-removed">-                        &quot;supply the value &#39;help&#39; to this option.&quot;, type = OptionType.Expert)</span>
<span class="udiff-line-modified-added">+                        &quot;supply the value &#39;help&#39; to this option.&quot;, type = OptionType.Expert, stability = OptionStability.STABLE)</span>
          public static final OptionKey&lt;String&gt; CompilerConfiguration = new OptionKey&lt;&gt;(null);
<span class="udiff-line-modified-removed">-         @Option(help = &quot;Writes to the VM log information about the Graal compiler configuration selected.&quot;, type = OptionType.User)</span>
<span class="udiff-line-modified-added">+         @Option(help = &quot;Writes to the VM log information about the compiler configuration selected.&quot;, type = OptionType.User, stability = OptionStability.STABLE)</span>
          public static final OptionKey&lt;ShowConfigurationLevel&gt; ShowConfiguration = new EnumOptionKey&lt;&gt;(ShowConfigurationLevel.none);
          // @formatter:on
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -193,34 +194,36 @@</span>
      public static CompilerConfigurationFactory selectFactory(String name, OptionValues options) {
          CompilerConfigurationFactory factory = null;
          try (InitTimer t = timer(&quot;CompilerConfigurationFactory.selectFactory&quot;)) {
              String value = name == null ? Options.CompilerConfiguration.getValue(options) : name;
              if (&quot;help&quot;.equals(value)) {
<span class="udiff-line-modified-removed">-                 System.out.println(&quot;The available Graal compiler configurations are:&quot;);</span>
<span class="udiff-line-modified-added">+                 System.out.println(&quot;The available compiler configurations are:&quot;);</span>
                  for (CompilerConfigurationFactory candidate : getAllCandidates()) {
                      System.out.println(&quot;    &quot; + candidate.name);
                  }
<span class="udiff-line-modified-removed">-                 System.exit(0);</span>
<span class="udiff-line-modified-added">+                 HotSpotGraalServices.exit(0);</span>
              } else if (value != null) {
                  for (CompilerConfigurationFactory candidate : GraalServices.load(CompilerConfigurationFactory.class)) {
                      if (candidate.name.equals(value)) {
                          factory = candidate;
                          break;
                      }
                  }
                  if (factory == null) {
<span class="udiff-line-modified-removed">-                     throw new GraalError(&quot;Graal compiler configuration &#39;%s&#39; not found. Available configurations are: %s&quot;, value,</span>
<span class="udiff-line-modified-added">+                     throw new GraalError(&quot;Compiler configuration &#39;%s&#39; not found. Available configurations are: %s&quot;, value,</span>
                                      getAllCandidates().stream().map(c -&gt; c.name).collect(Collectors.joining(&quot;, &quot;)));
                  }
              } else {
                  List&lt;CompilerConfigurationFactory&gt; candidates = getAllCandidates();
                  if (candidates.isEmpty()) {
                      throw new GraalError(&quot;No %s providers found&quot;, CompilerConfigurationFactory.class.getName());
                  }
                  factory = candidates.get(0);
              }
          }
<span class="udiff-line-added">+         assert factory != null;</span>
<span class="udiff-line-added">+ </span>
          ShowConfigurationLevel level = Options.ShowConfiguration.getValue(options);
          if (level != ShowConfigurationLevel.none) {
              switch (level) {
                  case info: {
                      printConfigInfo(factory);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -242,12 +245,12 @@</span>
          }
          return factory;
      }
  
      private static void printConfigInfo(CompilerConfigurationFactory factory) {
<span class="udiff-line-modified-removed">-         URL location = factory.getClass().getResource(factory.getClass().getSimpleName() + &quot;.class&quot;);</span>
<span class="udiff-line-modified-removed">-         TTY.printf(&quot;Using Graal compiler configuration &#39;%s&#39; provided by %s loaded from %s%n&quot;, factory.name, factory.getClass().getName(), location);</span>
<span class="udiff-line-modified-added">+         Object location = Services.IS_IN_NATIVE_IMAGE ? &quot;JVMCI native library&quot; : factory.getClass().getResource(factory.getClass().getSimpleName() + &quot;.class&quot;);</span>
<span class="udiff-line-modified-added">+         TTY.printf(&quot;Using compiler configuration &#39;%s&#39; provided by %s loaded from %s%n&quot;, factory.name, factory.getClass().getName(), location);</span>
      }
  
      private static &lt;C&gt; List&lt;String&gt; phaseNames(PhaseSuite&lt;C&gt; suite) {
          Collection&lt;BasePhase&lt;? super C&gt;&gt; phases = suite.getPhases();
          List&lt;String&gt; res = new ArrayList&lt;&gt;(phases.size());
</pre>
<center><a href="CompilationWatchDog.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="GraalHotSpotVMConfig.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>