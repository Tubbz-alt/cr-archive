<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/debug/BenchmarkCounters.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../SymbolicSnippetEncoder.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../lir/HotSpotZapRegistersPhase.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/debug/BenchmarkCounters.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot.debug;
 26 
 27 import java.io.File;
 28 import java.io.IOException;
 29 import java.io.OutputStream;
 30 import java.io.PrintStream;
 31 import java.util.Iterator;
 32 import java.util.Locale;
 33 import java.util.Map;
 34 import java.util.Map.Entry;
 35 import java.util.Set;
 36 import java.util.TreeMap;
 37 import java.util.TreeSet;
 38 import java.util.concurrent.ConcurrentHashMap;
 39 import java.util.concurrent.atomic.AtomicLong;
 40 

 41 import org.graalvm.compiler.core.common.SuppressFBWarnings;
 42 import org.graalvm.compiler.debug.CSVUtil;
 43 import org.graalvm.compiler.debug.GraalError;
 44 import org.graalvm.compiler.debug.TTY;
 45 import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
 46 import org.graalvm.compiler.nodes.debug.DynamicCounterNode;
 47 import org.graalvm.compiler.options.Option;
 48 import org.graalvm.compiler.options.OptionKey;
 49 import org.graalvm.compiler.options.OptionType;
 50 import org.graalvm.compiler.options.OptionValues;
 51 
 52 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
 53 
 54 //JaCoCo Exclude
 55 
 56 /**
 57  * This class contains infrastructure to maintain counters based on {@link DynamicCounterNode}s. The
 58  * infrastructure is enabled by specifying either the GenericDynamicCounters or
 59  * BenchmarkDynamicCounters option.
 60  * &lt;p&gt;
</pre>
<hr />
<pre>
399                 super(delegate, new String[]{&quot;\n&quot;, end, start});
400             }
401 
402             @Override
403             protected void patternFound(int index) {
404                 switch (index) {
405                     case 2:
406                         startTime = System.nanoTime();
407                         BenchmarkCounters.clear(jvmciRuntime.collectCounters());
408                         running = true;
409                         break;
410                     case 1:
411                         if (running) {
412                             waitingForEnd = true;
413                         }
414                         break;
415                     case 0:
416                         if (waitingForEnd) {
417                             waitingForEnd = false;
418                             running = false;
<span class="line-modified">419                             BenchmarkCounters.dump(options, getPrintStream(options), (System.nanoTime() - startTime) / 1000000000d, jvmciRuntime.collectCounters(), 100);</span>


420                         }
421                         break;
422                 }
423             }
424         }
425 
426         if (Options.BenchmarkDynamicCounters.getValue(options) != null) {
427             String[] arguments = Options.BenchmarkDynamicCounters.getValue(options).split(&quot;,&quot;);
428             if (arguments.length == 0 || (arguments.length % 3) != 0) {
429                 throw new GraalError(&quot;invalid arguments to BenchmarkDynamicCounters: (err|out),start,end,(err|out),start,end,... (~ matches multiple digits)&quot;);
430             }
431             for (int i = 0; i &lt; arguments.length; i += 3) {
432                 if (arguments[i].equals(&quot;err&quot;)) {
433                     System.setErr(new PrintStream(new BenchmarkCountersOutputStream(System.err, arguments[i + 1], arguments[i + 2])));
434                 } else if (arguments[i].equals(&quot;out&quot;)) {
435                     System.setOut(new PrintStream(new BenchmarkCountersOutputStream(System.out, arguments[i + 1], arguments[i + 2])));
436                 } else {
437                     throw new GraalError(&quot;invalid arguments to BenchmarkDynamicCounters: err|out&quot;);
438                 }
439             }
440             enabled = true;
441         }
442         if (Options.GenericDynamicCounters.getValue(options)) {
443             enabled = true;
444         }
445         if (Options.TimedDynamicCounters.getValue(options) &gt; 0) {
<span class="line-modified">446             Thread thread = new Thread() {</span>
447                 long lastTime = System.nanoTime();
<span class="line-removed">448                 PrintStream out = getPrintStream(options);</span>
449 
450                 @Override
451                 public void run() {
<span class="line-modified">452                     while (true) {</span>
<span class="line-modified">453                         try {</span>
<span class="line-modified">454                             Thread.sleep(Options.TimedDynamicCounters.getValue(options));</span>
<span class="line-modified">455                         } catch (InterruptedException e) {</span>





456                         }
<span class="line-removed">457                         long time = System.nanoTime();</span>
<span class="line-removed">458                         dump(options, out, (time - lastTime) / 1000000000d, jvmciRuntime.collectCounters(), 10);</span>
<span class="line-removed">459                         lastTime = time;</span>
460                     }
461                 }
<span class="line-modified">462             };</span>
463             thread.setDaemon(true);
464             thread.setPriority(Thread.MAX_PRIORITY);
465             thread.start();
466             enabled = true;
467         }
468         if (enabled) {
469             clear(jvmciRuntime.collectCounters());
470         }
471     }
472 
473     public static void shutdown(HotSpotJVMCIRuntime jvmciRuntime, OptionValues options, long compilerStartTime) {
474         if (Options.GenericDynamicCounters.getValue(options)) {
<span class="line-modified">475             dump(options, getPrintStream(options), (System.nanoTime() - compilerStartTime) / 1000000000d, jvmciRuntime.collectCounters(), 100);</span>


476         }
477     }
478 
<span class="line-modified">479     private static PrintStream getPrintStream(OptionValues options) {</span>
<span class="line-modified">480         if (Options.BenchmarkCountersFile.getValue(options) != null) {</span>
<span class="line-modified">481             try {</span>














482 
<span class="line-modified">483                 File file = new File(Options.BenchmarkCountersFile.getValue(options));</span>
<span class="line-modified">484                 TTY.println(&quot;Writing benchmark counters to &#39;%s&#39;&quot;, file.getAbsolutePath());</span>
<span class="line-modified">485                 return new PrintStream(file);</span>
<span class="line-modified">486             } catch (IOException e) {</span>
<span class="line-removed">487                 TTY.out().println(e.getMessage());</span>
<span class="line-removed">488                 TTY.out().println(&quot;Fallback to default&quot;);</span>
489             }
490         }
<span class="line-modified">491         return TTY.out;</span>



492     }
493 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot.debug;
 26 
 27 import java.io.File;
 28 import java.io.IOException;
 29 import java.io.OutputStream;
 30 import java.io.PrintStream;
 31 import java.util.Iterator;
 32 import java.util.Locale;
 33 import java.util.Map;
 34 import java.util.Map.Entry;
 35 import java.util.Set;
 36 import java.util.TreeMap;
 37 import java.util.TreeSet;
 38 import java.util.concurrent.ConcurrentHashMap;
 39 import java.util.concurrent.atomic.AtomicLong;
 40 
<span class="line-added"> 41 import org.graalvm.compiler.core.GraalServiceThread;</span>
 42 import org.graalvm.compiler.core.common.SuppressFBWarnings;
 43 import org.graalvm.compiler.debug.CSVUtil;
 44 import org.graalvm.compiler.debug.GraalError;
 45 import org.graalvm.compiler.debug.TTY;
 46 import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
 47 import org.graalvm.compiler.nodes.debug.DynamicCounterNode;
 48 import org.graalvm.compiler.options.Option;
 49 import org.graalvm.compiler.options.OptionKey;
 50 import org.graalvm.compiler.options.OptionType;
 51 import org.graalvm.compiler.options.OptionValues;
 52 
 53 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
 54 
 55 //JaCoCo Exclude
 56 
 57 /**
 58  * This class contains infrastructure to maintain counters based on {@link DynamicCounterNode}s. The
 59  * infrastructure is enabled by specifying either the GenericDynamicCounters or
 60  * BenchmarkDynamicCounters option.
 61  * &lt;p&gt;
</pre>
<hr />
<pre>
400                 super(delegate, new String[]{&quot;\n&quot;, end, start});
401             }
402 
403             @Override
404             protected void patternFound(int index) {
405                 switch (index) {
406                     case 2:
407                         startTime = System.nanoTime();
408                         BenchmarkCounters.clear(jvmciRuntime.collectCounters());
409                         running = true;
410                         break;
411                     case 1:
412                         if (running) {
413                             waitingForEnd = true;
414                         }
415                         break;
416                     case 0:
417                         if (waitingForEnd) {
418                             waitingForEnd = false;
419                             running = false;
<span class="line-modified">420                             try (PrintStreamScope scope = getPrintStream(options)) {</span>
<span class="line-added">421                                 BenchmarkCounters.dump(options, scope.out, (System.nanoTime() - startTime) / 1000000000d, jvmciRuntime.collectCounters(), 100);</span>
<span class="line-added">422                             }</span>
423                         }
424                         break;
425                 }
426             }
427         }
428 
429         if (Options.BenchmarkDynamicCounters.getValue(options) != null) {
430             String[] arguments = Options.BenchmarkDynamicCounters.getValue(options).split(&quot;,&quot;);
431             if (arguments.length == 0 || (arguments.length % 3) != 0) {
432                 throw new GraalError(&quot;invalid arguments to BenchmarkDynamicCounters: (err|out),start,end,(err|out),start,end,... (~ matches multiple digits)&quot;);
433             }
434             for (int i = 0; i &lt; arguments.length; i += 3) {
435                 if (arguments[i].equals(&quot;err&quot;)) {
436                     System.setErr(new PrintStream(new BenchmarkCountersOutputStream(System.err, arguments[i + 1], arguments[i + 2])));
437                 } else if (arguments[i].equals(&quot;out&quot;)) {
438                     System.setOut(new PrintStream(new BenchmarkCountersOutputStream(System.out, arguments[i + 1], arguments[i + 2])));
439                 } else {
440                     throw new GraalError(&quot;invalid arguments to BenchmarkDynamicCounters: err|out&quot;);
441                 }
442             }
443             enabled = true;
444         }
445         if (Options.GenericDynamicCounters.getValue(options)) {
446             enabled = true;
447         }
448         if (Options.TimedDynamicCounters.getValue(options) &gt; 0) {
<span class="line-modified">449             Thread thread = new GraalServiceThread(new Runnable() {</span>
450                 long lastTime = System.nanoTime();

451 
452                 @Override
453                 public void run() {
<span class="line-modified">454                     try (PrintStreamScope scope = getPrintStream(options)) {</span>
<span class="line-modified">455                         while (true) {</span>
<span class="line-modified">456                             try {</span>
<span class="line-modified">457                                 Thread.sleep(Options.TimedDynamicCounters.getValue(options));</span>
<span class="line-added">458                             } catch (InterruptedException e) {</span>
<span class="line-added">459                             }</span>
<span class="line-added">460                             long time = System.nanoTime();</span>
<span class="line-added">461                             dump(options, scope.out, (time - lastTime) / 1000000000d, jvmciRuntime.collectCounters(), 10);</span>
<span class="line-added">462                             lastTime = time;</span>
463                         }



464                     }
465                 }
<span class="line-modified">466             });</span>
467             thread.setDaemon(true);
468             thread.setPriority(Thread.MAX_PRIORITY);
469             thread.start();
470             enabled = true;
471         }
472         if (enabled) {
473             clear(jvmciRuntime.collectCounters());
474         }
475     }
476 
477     public static void shutdown(HotSpotJVMCIRuntime jvmciRuntime, OptionValues options, long compilerStartTime) {
478         if (Options.GenericDynamicCounters.getValue(options)) {
<span class="line-modified">479             try (PrintStreamScope scope = getPrintStream(options)) {</span>
<span class="line-added">480                 dump(options, scope.out, (System.nanoTime() - compilerStartTime) / 1000000000d, jvmciRuntime.collectCounters(), 100);</span>
<span class="line-added">481             }</span>
482         }
483     }
484 
<span class="line-modified">485     static class PrintStreamScope implements AutoCloseable {</span>
<span class="line-modified">486         final PrintStream out;</span>
<span class="line-modified">487 </span>
<span class="line-added">488         PrintStreamScope(OptionValues options) {</span>
<span class="line-added">489             PrintStream ps = TTY.out;</span>
<span class="line-added">490             if (Options.BenchmarkCountersFile.getValue(options) != null) {</span>
<span class="line-added">491                 try {</span>
<span class="line-added">492                     File file = new File(Options.BenchmarkCountersFile.getValue(options));</span>
<span class="line-added">493                     TTY.println(&quot;Writing benchmark counters to &#39;%s&#39;&quot;, file.getAbsolutePath());</span>
<span class="line-added">494                     ps = new PrintStream(file);</span>
<span class="line-added">495                 } catch (IOException e) {</span>
<span class="line-added">496                     TTY.out().println(e.getMessage());</span>
<span class="line-added">497                     TTY.out().println(&quot;Fallback to default&quot;);</span>
<span class="line-added">498                 }</span>
<span class="line-added">499             }</span>
<span class="line-added">500             this.out = ps;</span>
<span class="line-added">501         }</span>
502 
<span class="line-modified">503         @Override</span>
<span class="line-modified">504         public void close() {</span>
<span class="line-modified">505             if (out != TTY.out) {</span>
<span class="line-modified">506                 this.out.close();</span>


507             }
508         }
<span class="line-modified">509     }</span>
<span class="line-added">510 </span>
<span class="line-added">511     private static PrintStreamScope getPrintStream(OptionValues options) {</span>
<span class="line-added">512         return new PrintStreamScope(options);</span>
513     }
514 }
</pre>
</td>
</tr>
</table>
<center><a href="../SymbolicSnippetEncoder.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../lir/HotSpotZapRegistersPhase.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>