<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotGraalRuntime.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotGraalOptionValues.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotGraalRuntimeProvider.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotGraalRuntime.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -33,10 +33,11 @@</span>
  import java.util.ArrayList;
  import java.util.EnumMap;
  import java.util.List;
  import java.util.Map;
  import java.util.concurrent.atomic.AtomicReference;
<span class="udiff-line-added">+ import java.util.function.Supplier;</span>
  
  import jdk.internal.vm.compiler.collections.EconomicMap;
  import jdk.internal.vm.compiler.collections.EconomicSet;
  import jdk.internal.vm.compiler.collections.Equivalence;
  import jdk.internal.vm.compiler.collections.UnmodifiableMapCursor;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -85,19 +86,24 @@</span>
  import jdk.vm.ci.meta.MetaAccessProvider;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
  import jdk.vm.ci.meta.ResolvedJavaType;
  import jdk.vm.ci.runtime.JVMCI;
  import jdk.vm.ci.runtime.JVMCIBackend;
<span class="udiff-line-added">+ import jdk.vm.ci.services.Services;</span>
  
  //JaCoCo Exclude
  
  /**
   * Singleton class holding the instance of the {@link GraalRuntime}.
   */
  public final class HotSpotGraalRuntime implements HotSpotGraalRuntimeProvider {
  
<span class="udiff-line-modified-removed">-     private static final boolean IS_AOT = Boolean.getBoolean(&quot;com.oracle.graalvm.isaot&quot;);</span>
<span class="udiff-line-modified-added">+     private static final boolean IS_AOT = Boolean.parseBoolean(Services.getSavedProperties().get(&quot;com.oracle.graalvm.isaot&quot;));</span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * A factory for {@link HotSpotGraalManagementRegistration} injected by {@code LibGraalFeature}.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static final Supplier&lt;HotSpotGraalManagementRegistration&gt; AOT_INJECTED_MANAGEMENT = null;</span>
  
      private static boolean checkArrayIndexScaleInvariants(MetaAccessProvider metaAccess) {
          assert metaAccess.getArrayIndexScale(JavaKind.Byte) == 1;
          assert metaAccess.getArrayIndexScale(JavaKind.Boolean) == 1;
          assert metaAccess.getArrayIndexScale(JavaKind.Char) == 2;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -110,10 +116,15 @@</span>
      }
  
      private final String runtimeName;
      private final String compilerConfigurationName;
      private final HotSpotBackend hostBackend;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public GlobalMetrics getMetricValues() {</span>
<span class="udiff-line-added">+         return metricValues;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private final GlobalMetrics metricValues = new GlobalMetrics();
      private final List&lt;SnippetCounter.Group&gt; snippetCounterGroups;
      private final HotSpotGC garbageCollector;
  
      private final EconomicMap&lt;Class&lt;? extends Architecture&gt;, HotSpotBackend&gt; backends = EconomicMap.create(Equivalence.IDENTITY);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -126,12 +137,10 @@</span>
       * {@link OptionValues} object can be cached by various parts of Graal instead of always
       * obtaining them from this object. However, concurrent updates are never lost.
       */
      private AtomicReference&lt;OptionValues&gt; optionsRef = new AtomicReference&lt;&gt;();
  
<span class="udiff-line-removed">-     private final HotSpotGraalCompiler compiler;</span>
<span class="udiff-line-removed">- </span>
      private final DiagnosticsOutputDirectory outputDirectory;
      private final Map&lt;ExceptionAction, Integer&gt; compilationProblemsPerAction;
  
      /**
       * @param nameQualifier a qualifier to be added to this runtime&#39;s {@linkplain #getName() name}
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -158,18 +167,17 @@</span>
          compilationProblemsPerAction = new EnumMap&lt;&gt;(ExceptionAction.class);
          snippetCounterGroups = GraalOptions.SnippetCounters.getValue(options) ? new ArrayList&lt;&gt;() : null;
          CompilerConfiguration compilerConfiguration = compilerConfigurationFactory.createCompilerConfiguration();
          compilerConfigurationName = compilerConfigurationFactory.getName();
  
<span class="udiff-line-removed">-         compiler = new HotSpotGraalCompiler(jvmciRuntime, this, options);</span>
          if (IS_AOT) {
<span class="udiff-line-modified-removed">-             management = null;</span>
<span class="udiff-line-modified-added">+             management = AOT_INJECTED_MANAGEMENT == null ? null : AOT_INJECTED_MANAGEMENT.get();</span>
          } else {
              management = GraalServices.loadSingle(HotSpotGraalManagementRegistration.class, false);
<span class="udiff-line-modified-removed">-             if (management != null) {</span>
<span class="udiff-line-modified-removed">-                 management.initialize(this);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         if (management != null) {</span>
<span class="udiff-line-modified-added">+             management.initialize(this, config);</span>
          }
  
          BackendMap backendMap = compilerConfigurationFactory.createBackendMap();
  
          JVMCIBackend hostJvmciBackend = jvmciRuntime.getHostJVMCIBackend();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -287,17 +295,19 @@</span>
          if (management != null &amp;&amp; management.poll(false) != null) {
              if (compilable instanceof HotSpotResolvedJavaMethod) {
                  HotSpotResolvedObjectType type = ((HotSpotResolvedJavaMethod) compilable).getDeclaringClass();
                  if (type instanceof HotSpotResolvedJavaType) {
                      Class&lt;?&gt; clazz = runtime().getMirror(type);
<span class="udiff-line-modified-removed">-                     try {</span>
<span class="udiff-line-modified-removed">-                         ClassLoader cl = clazz.getClassLoader();</span>
<span class="udiff-line-modified-removed">-                         if (cl != null) {</span>
<span class="udiff-line-modified-removed">-                             loaders.add(cl);</span>
<span class="udiff-line-modified-added">+                     if (clazz != null) {</span>
<span class="udiff-line-modified-added">+                         try {</span>
<span class="udiff-line-modified-added">+                             ClassLoader cl = clazz.getClassLoader();</span>
<span class="udiff-line-modified-added">+                             if (cl != null) {</span>
<span class="udiff-line-added">+                                 loaders.add(cl);</span>
<span class="udiff-line-added">+                             }</span>
<span class="udiff-line-added">+                         } catch (SecurityException e) {</span>
<span class="udiff-line-added">+                             // This loader can obviously not be used for resolving class names</span>
                          }
<span class="udiff-line-removed">-                     } catch (SecurityException e) {</span>
<span class="udiff-line-removed">-                         // This loader can obviously not be used for resolving class names</span>
                      }
                  }
              }
          }
          Description description = new Description(compilable, compilationId.toString(CompilationIdentifier.Verbosity.ID));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -343,10 +353,11 @@</span>
              return (T) getHostProviders().getForeignCalls();
          }
          return null;
      }
  
<span class="udiff-line-added">+     @Override</span>
      public HotSpotGC getGarbageCollector() {
          return garbageCollector;
      }
  
      @Override
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -364,11 +375,15 @@</span>
      public String getCompilerConfigurationName() {
          return compilerConfigurationName;
      }
  
      private long runtimeStartTime;
<span class="udiff-line-modified-removed">-     private boolean shutdown;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Called from compiler threads to check whether to bail out of a compilation.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private volatile boolean shutdown;</span>
  
      /**
       * Take action related to entering a new execution phase.
       *
       * @param phase the execution phase being entered
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -391,10 +406,20 @@</span>
              }
          }
          BenchmarkCounters.shutdown(runtime(), optionsRef.get(), runtimeStartTime);
  
          outputDirectory.close();
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         shutdownLibGraal();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Substituted by</span>
<span class="udiff-line-added">+      * {@code com.oracle.svm.graal.hotspot.libgraal.Target_org_graalvm_compiler_hotspot_HotSpotGraalRuntime}</span>
<span class="udiff-line-added">+      * to call {@code org.graalvm.nativeimage.VMRuntime.shutdown()}.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static void shutdownLibGraal() {</span>
      }
  
      void clearMetrics() {
          metricValues.clear();
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -577,10 +602,11 @@</span>
          EconomicMap&lt;OptionKey&lt;?&gt;, Object&gt; extra = EconomicMap.create();
          extra.put(DebugOptions.Dump, filter);
          extra.put(DebugOptions.PrintGraphHost, host);
          extra.put(DebugOptions.PrintGraphPort, port);
          OptionValues compileOptions = new OptionValues(getOptions(), extra);
<span class="udiff-line-added">+         HotSpotGraalCompiler compiler = (HotSpotGraalCompiler) runtime().getCompiler();</span>
          compiler.compileMethod(new HotSpotCompilationRequest(hotSpotMethod, -1, 0L), false, compileOptions);
      }
  
      public Object invokeManagementAction(String actionName, Object[] params) throws Exception {
          if (&quot;dumpMethod&quot;.equals(actionName)) {
</pre>
<center><a href="HotSpotGraalOptionValues.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotGraalRuntimeProvider.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>