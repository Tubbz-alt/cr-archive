<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/phases/OnStackReplacementPhase.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LoadJavaMirrorWithKlassPhase.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="aot/AOTInliningPolicy.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/phases/OnStackReplacementPhase.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 39,11 ***</span>
  import org.graalvm.compiler.loop.LoopEx;
  import org.graalvm.compiler.loop.LoopsData;
  import org.graalvm.compiler.loop.phases.LoopTransformations;
  import org.graalvm.compiler.nodeinfo.InputType;
  import org.graalvm.compiler.nodeinfo.Verbosity;
<span class="line-removed">- import org.graalvm.compiler.nodes.AbstractBeginNode;</span>
  import org.graalvm.compiler.nodes.EntryMarkerNode;
  import org.graalvm.compiler.nodes.EntryProxyNode;
  import org.graalvm.compiler.nodes.FixedGuardNode;
  import org.graalvm.compiler.nodes.FixedNode;
  import org.graalvm.compiler.nodes.FrameState;
<span class="line-new-header">--- 39,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 157,15 ***</span>
              }
  
              LoopEx loop = loops.loop(l);
              loop.loopBegin().markOsrLoop();
              LoopTransformations.peel(loop);
<span class="line-modified">!             osr.replaceAtUsages(InputType.Guard, AbstractBeginNode.prevBegin((FixedNode) osr.predecessor()));</span>
<span class="line-modified">!             for (Node usage : osr.usages().snapshot()) {</span>
<span class="line-removed">-                 EntryProxyNode proxy = (EntryProxyNode) usage;</span>
<span class="line-removed">-                 proxy.replaceAndDelete(proxy.value());</span>
<span class="line-removed">-             }</span>
              GraphUtil.removeFixedWithUnusedInputs(osr);
              debug.dump(DebugContext.DETAILED_LEVEL, graph, &quot;OnStackReplacement loop peeling result&quot;);
          } while (true);
  
          StartNode start = graph.start();
<span class="line-new-header">--- 156,12 ---</span>
              }
  
              LoopEx loop = loops.loop(l);
              loop.loopBegin().markOsrLoop();
              LoopTransformations.peel(loop);
<span class="line-modified">! </span>
<span class="line-modified">!             osr.prepareDelete();</span>
              GraphUtil.removeFixedWithUnusedInputs(osr);
              debug.dump(DebugContext.DETAILED_LEVEL, graph, &quot;OnStackReplacement loop peeling result&quot;);
          } while (true);
  
          StartNode start = graph.start();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 226,10 ***</span>
<span class="line-new-header">--- 222,11 ---</span>
                      assert value == null || value instanceof OSRLocalNode;
                  }
              }
  
              osr.replaceAtUsages(InputType.Guard, osrStart);
<span class="line-added">+             osr.replaceAtUsages(InputType.Anchor, osrStart);</span>
          }
          debug.dump(DebugContext.DETAILED_LEVEL, graph, &quot;OnStackReplacement after replacing entry proxies&quot;);
          GraphUtil.killCFG(start);
          debug.dump(DebugContext.DETAILED_LEVEL, graph, &quot;OnStackReplacement result&quot;);
          new DeadCodeEliminationPhase(Required).apply(graph);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 280,11 ***</span>
  
      private static EntryMarkerNode getEntryMarker(StructuredGraph graph) {
          NodeIterable&lt;EntryMarkerNode&gt; osrNodes = graph.getNodes(EntryMarkerNode.TYPE);
          EntryMarkerNode osr = osrNodes.first();
          if (osr == null) {
<span class="line-modified">!             throw new PermanentBailoutException(&quot;No OnStackReplacementNode generated&quot;);</span>
          }
          if (osrNodes.count() &gt; 1) {
              throw new GraalError(&quot;Multiple OnStackReplacementNodes generated&quot;);
          }
          if (osr.stateAfter().stackSize() != 0) {
<span class="line-new-header">--- 277,11 ---</span>
  
      private static EntryMarkerNode getEntryMarker(StructuredGraph graph) {
          NodeIterable&lt;EntryMarkerNode&gt; osrNodes = graph.getNodes(EntryMarkerNode.TYPE);
          EntryMarkerNode osr = osrNodes.first();
          if (osr == null) {
<span class="line-modified">!             throw new GraalError(&quot;No OnStackReplacementNode generated&quot;);</span>
          }
          if (osrNodes.count() &gt; 1) {
              throw new GraalError(&quot;Multiple OnStackReplacementNodes generated&quot;);
          }
          if (osr.stateAfter().stackSize() != 0) {
</pre>
<center><a href="LoadJavaMirrorWithKlassPhase.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="aot/AOTInliningPolicy.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>