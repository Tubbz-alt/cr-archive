<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/meta/DefaultHotSpotLoweringProvider.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AddressLoweringHotSpotSuitesProvider.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotForeignCallsProviderImpl.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/meta/DefaultHotSpotLoweringProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -57,43 +57,42 @@</span>
  import org.graalvm.compiler.debug.GraalError;
  import org.graalvm.compiler.graph.Node;
  import org.graalvm.compiler.graph.NodeInputList;
  import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
  import org.graalvm.compiler.hotspot.HotSpotGraalRuntimeProvider;
<span class="udiff-line-removed">- import org.graalvm.compiler.hotspot.gc.g1.G1ArrayRangePostWriteBarrier;</span>
<span class="udiff-line-removed">- import org.graalvm.compiler.hotspot.gc.g1.G1ArrayRangePreWriteBarrier;</span>
<span class="udiff-line-removed">- import org.graalvm.compiler.hotspot.gc.g1.G1PostWriteBarrier;</span>
<span class="udiff-line-removed">- import org.graalvm.compiler.hotspot.gc.g1.G1PreWriteBarrier;</span>
<span class="udiff-line-removed">- import org.graalvm.compiler.hotspot.gc.g1.G1ReferentFieldReadBarrier;</span>
<span class="udiff-line-removed">- import org.graalvm.compiler.hotspot.gc.shared.SerialArrayRangeWriteBarrier;</span>
<span class="udiff-line-removed">- import org.graalvm.compiler.hotspot.gc.shared.SerialWriteBarrier;</span>
  import org.graalvm.compiler.hotspot.nodes.BeginLockScopeNode;
  import org.graalvm.compiler.hotspot.nodes.HotSpotCompressionNode;
  import org.graalvm.compiler.hotspot.nodes.HotSpotDirectCallTargetNode;
  import org.graalvm.compiler.hotspot.nodes.HotSpotIndirectCallTargetNode;
<span class="udiff-line-added">+ import org.graalvm.compiler.hotspot.nodes.KlassBeingInitializedCheckNode;</span>
  import org.graalvm.compiler.hotspot.nodes.aot.InitializeKlassNode;
  import org.graalvm.compiler.hotspot.nodes.aot.ResolveConstantNode;
  import org.graalvm.compiler.hotspot.nodes.aot.ResolveDynamicConstantNode;
  import org.graalvm.compiler.hotspot.nodes.aot.ResolveMethodAndLoadCountersNode;
  import org.graalvm.compiler.hotspot.nodes.profiling.ProfileNode;
  import org.graalvm.compiler.hotspot.nodes.type.HotSpotNarrowOopStamp;
  import org.graalvm.compiler.hotspot.nodes.type.KlassPointerStamp;
  import org.graalvm.compiler.hotspot.nodes.type.MethodPointerStamp;
  import org.graalvm.compiler.hotspot.replacements.AssertionSnippets;
  import org.graalvm.compiler.hotspot.replacements.ClassGetHubNode;
<span class="udiff-line-added">+ import org.graalvm.compiler.hotspot.replacements.FastNotifyNode;</span>
  import org.graalvm.compiler.hotspot.replacements.HashCodeSnippets;
<span class="udiff-line-added">+ import org.graalvm.compiler.hotspot.replacements.HotSpotG1WriteBarrierSnippets;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.hotspot.replacements.HotSpotSerialWriteBarrierSnippets;</span>
  import org.graalvm.compiler.hotspot.replacements.HubGetClassNode;
  import org.graalvm.compiler.hotspot.replacements.IdentityHashCodeNode;
  import org.graalvm.compiler.hotspot.replacements.InstanceOfSnippets;
  import org.graalvm.compiler.hotspot.replacements.KlassLayoutHelperNode;
  import org.graalvm.compiler.hotspot.replacements.LoadExceptionObjectSnippets;
  import org.graalvm.compiler.hotspot.replacements.MonitorSnippets;
  import org.graalvm.compiler.hotspot.replacements.NewObjectSnippets;
  import org.graalvm.compiler.hotspot.replacements.ObjectCloneSnippets;
<span class="udiff-line-added">+ import org.graalvm.compiler.hotspot.replacements.ObjectSnippets;</span>
  import org.graalvm.compiler.hotspot.replacements.StringToBytesSnippets;
<span class="udiff-line-added">+ import org.graalvm.compiler.hotspot.replacements.UnsafeCopyMemoryNode;</span>
  import org.graalvm.compiler.hotspot.replacements.UnsafeLoadSnippets;
<span class="udiff-line-modified-removed">- import org.graalvm.compiler.hotspot.replacements.WriteBarrierSnippets;</span>
<span class="udiff-line-modified-added">+ import org.graalvm.compiler.hotspot.replacements.UnsafeSnippets;</span>
  import org.graalvm.compiler.hotspot.replacements.aot.ResolveConstantSnippets;
  import org.graalvm.compiler.hotspot.replacements.arraycopy.HotSpotArraycopySnippets;
  import org.graalvm.compiler.hotspot.replacements.profiling.ProfileSnippets;
  import org.graalvm.compiler.hotspot.stubs.ForeignCallSnippets;
  import org.graalvm.compiler.hotspot.word.KlassPointer;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -110,10 +109,11 @@</span>
  import org.graalvm.compiler.nodes.NodeView;
  import org.graalvm.compiler.nodes.ParameterNode;
  import org.graalvm.compiler.nodes.SafepointNode;
  import org.graalvm.compiler.nodes.StartNode;
  import org.graalvm.compiler.nodes.StructuredGraph;
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.StructuredGraph.GuardsStage;</span>
  import org.graalvm.compiler.nodes.UnwindNode;
  import org.graalvm.compiler.nodes.ValueNode;
  import org.graalvm.compiler.nodes.calc.AddNode;
  import org.graalvm.compiler.nodes.calc.FloatingNode;
  import org.graalvm.compiler.nodes.calc.IntegerDivRemNode;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -123,19 +123,24 @@</span>
  import org.graalvm.compiler.nodes.debug.VerifyHeapNode;
  import org.graalvm.compiler.nodes.extended.BytecodeExceptionNode;
  import org.graalvm.compiler.nodes.extended.BytecodeExceptionNode.BytecodeExceptionKind;
  import org.graalvm.compiler.nodes.extended.ForeignCallNode;
  import org.graalvm.compiler.nodes.extended.GetClassNode;
<span class="udiff-line-removed">- import org.graalvm.compiler.nodes.extended.GuardedUnsafeLoadNode;</span>
  import org.graalvm.compiler.nodes.extended.LoadHubNode;
  import org.graalvm.compiler.nodes.extended.LoadMethodNode;
  import org.graalvm.compiler.nodes.extended.OSRLocalNode;
  import org.graalvm.compiler.nodes.extended.OSRLockNode;
  import org.graalvm.compiler.nodes.extended.OSRMonitorEnterNode;
  import org.graalvm.compiler.nodes.extended.OSRStartNode;
<span class="udiff-line-removed">- import org.graalvm.compiler.nodes.extended.RawLoadNode;</span>
  import org.graalvm.compiler.nodes.extended.StoreHubNode;
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.gc.G1ArrayRangePostWriteBarrier;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.gc.G1ArrayRangePreWriteBarrier;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.gc.G1PostWriteBarrier;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.gc.G1PreWriteBarrier;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.gc.G1ReferentFieldReadBarrier;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.gc.SerialArrayRangeWriteBarrier;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.gc.SerialWriteBarrier;</span>
  import org.graalvm.compiler.nodes.java.ClassIsAssignableFromNode;
  import org.graalvm.compiler.nodes.java.DynamicNewArrayNode;
  import org.graalvm.compiler.nodes.java.DynamicNewInstanceNode;
  import org.graalvm.compiler.nodes.java.InstanceOfDynamicNode;
  import org.graalvm.compiler.nodes.java.InstanceOfNode;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -159,11 +164,11 @@</span>
  import org.graalvm.compiler.nodes.util.GraphUtil;
  import org.graalvm.compiler.options.OptionValues;
  import org.graalvm.compiler.replacements.DefaultJavaLoweringProvider;
  import org.graalvm.compiler.replacements.arraycopy.ArrayCopyNode;
  import org.graalvm.compiler.replacements.arraycopy.ArrayCopySnippets;
<span class="udiff-line-modified-removed">- import org.graalvm.compiler.replacements.arraycopy.ArrayCopyWithSlowPathNode;</span>
<span class="udiff-line-modified-added">+ import org.graalvm.compiler.replacements.arraycopy.ArrayCopyWithDelayedLoweringNode;</span>
  import org.graalvm.compiler.replacements.nodes.AssertionNode;
  import org.graalvm.compiler.serviceprovider.JavaVersionUtil;
  import jdk.internal.vm.compiler.word.LocationIdentity;
  
  import jdk.vm.ci.code.TargetDescription;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -179,61 +184,74 @@</span>
  import jdk.vm.ci.meta.ResolvedJavaType;
  
  /**
   * HotSpot implementation of {@link LoweringProvider}.
   */
<span class="udiff-line-modified-removed">- public class DefaultHotSpotLoweringProvider extends DefaultJavaLoweringProvider implements HotSpotLoweringProvider {</span>
<span class="udiff-line-modified-added">+ public abstract class DefaultHotSpotLoweringProvider extends DefaultJavaLoweringProvider implements HotSpotLoweringProvider {</span>
  
      protected final HotSpotGraalRuntimeProvider runtime;
      protected final HotSpotRegistersProvider registers;
      protected final HotSpotConstantReflectionProvider constantReflection;
  
      protected InstanceOfSnippets.Templates instanceofSnippets;
      protected NewObjectSnippets.Templates newObjectSnippets;
      protected MonitorSnippets.Templates monitorSnippets;
<span class="udiff-line-modified-removed">-     protected WriteBarrierSnippets.Templates writeBarrierSnippets;</span>
<span class="udiff-line-modified-added">+     protected HotSpotSerialWriteBarrierSnippets.Templates serialWriteBarrierSnippets;</span>
<span class="udiff-line-added">+     protected HotSpotG1WriteBarrierSnippets.Templates g1WriteBarrierSnippets;</span>
      protected LoadExceptionObjectSnippets.Templates exceptionObjectSnippets;
      protected UnsafeLoadSnippets.Templates unsafeLoadSnippets;
      protected AssertionSnippets.Templates assertionSnippets;
      protected ArrayCopySnippets.Templates arraycopySnippets;
      protected StringToBytesSnippets.Templates stringToBytesSnippets;
      protected HashCodeSnippets.Templates hashCodeSnippets;
      protected ResolveConstantSnippets.Templates resolveConstantSnippets;
      protected ProfileSnippets.Templates profileSnippets;
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+     protected ObjectSnippets.Templates objectSnippets;</span>
<span class="udiff-line-added">+     protected UnsafeSnippets.Templates unsafeSnippets;</span>
      protected ObjectCloneSnippets.Templates objectCloneSnippets;
      protected ForeignCallSnippets.Templates foreignCallSnippets;
  
      public DefaultHotSpotLoweringProvider(HotSpotGraalRuntimeProvider runtime, MetaAccessProvider metaAccess, ForeignCallsProvider foreignCalls, HotSpotRegistersProvider registers,
                      HotSpotConstantReflectionProvider constantReflection, TargetDescription target) {
          super(metaAccess, foreignCalls, target, runtime.getVMConfig().useCompressedOops);
          this.runtime = runtime;
          this.registers = registers;
          this.constantReflection = constantReflection;
<span class="udiff-line-added">+ </span>
      }
  
      @Override
      public void initialize(OptionValues options, Iterable&lt;DebugHandlersFactory&gt; factories, HotSpotProviders providers, GraalHotSpotVMConfig config) {
          super.initialize(options, factories, runtime, providers, providers.getSnippetReflection());
  
          assert target == providers.getCodeCache().getTarget();
          instanceofSnippets = new InstanceOfSnippets.Templates(options, factories, runtime, providers, target);
          newObjectSnippets = new NewObjectSnippets.Templates(options, factories, runtime, providers, target, config);
          monitorSnippets = new MonitorSnippets.Templates(options, factories, runtime, providers, target, config.useFastLocking);
<span class="udiff-line-modified-removed">-         writeBarrierSnippets = new WriteBarrierSnippets.Templates(options, factories, runtime, providers, target, config);</span>
<span class="udiff-line-modified-added">+         g1WriteBarrierSnippets = new HotSpotG1WriteBarrierSnippets.Templates(options, factories, runtime, providers, target, config);</span>
<span class="udiff-line-added">+         serialWriteBarrierSnippets = new HotSpotSerialWriteBarrierSnippets.Templates(options, factories, runtime, providers, target, config);</span>
          exceptionObjectSnippets = new LoadExceptionObjectSnippets.Templates(options, factories, providers, target);
          unsafeLoadSnippets = new UnsafeLoadSnippets.Templates(options, factories, providers, target);
          assertionSnippets = new AssertionSnippets.Templates(options, factories, providers, target);
          arraycopySnippets = new ArrayCopySnippets.Templates(new HotSpotArraycopySnippets(), options, factories, runtime, providers, providers.getSnippetReflection(), target);
          stringToBytesSnippets = new StringToBytesSnippets.Templates(options, factories, providers, target);
          hashCodeSnippets = new HashCodeSnippets.Templates(options, factories, providers, target);
          resolveConstantSnippets = new ResolveConstantSnippets.Templates(options, factories, providers, target);
<span class="udiff-line-removed">-         if (!JavaVersionUtil.Java8OrEarlier) {</span>
<span class="udiff-line-removed">-             profileSnippets = new ProfileSnippets.Templates(options, factories, providers, target);</span>
<span class="udiff-line-removed">-         }</span>
          objectCloneSnippets = new ObjectCloneSnippets.Templates(options, factories, providers, target);
          foreignCallSnippets = new ForeignCallSnippets.Templates(options, factories, providers, target);
<span class="udiff-line-added">+         objectSnippets = new ObjectSnippets.Templates(options, factories, providers, target);</span>
<span class="udiff-line-added">+         unsafeSnippets = new UnsafeSnippets.Templates(options, factories, providers, target);</span>
<span class="udiff-line-added">+         if (JavaVersionUtil.JAVA_SPEC &lt;= 8) {</span>
<span class="udiff-line-added">+             // AOT only introduced in JDK 9</span>
<span class="udiff-line-added">+             profileSnippets = null;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             profileSnippets = new ProfileSnippets.Templates(options, factories, providers, target);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public ArrayCopySnippets.Templates getArraycopySnippets() {</span>
<span class="udiff-line-added">+         return arraycopySnippets;</span>
      }
  
      public MonitorSnippets.Templates getMonitorSnippets() {
          return monitorSnippets;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -330,26 +348,26 @@</span>
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
                      monitorSnippets.lower((MonitorExitNode) n, registers, tool);
                  }
              } else if (n instanceof ArrayCopyNode) {
                  arraycopySnippets.lower((ArrayCopyNode) n, tool);
<span class="udiff-line-modified-removed">-             } else if (n instanceof ArrayCopyWithSlowPathNode) {</span>
<span class="udiff-line-modified-removed">-                 arraycopySnippets.lower((ArrayCopyWithSlowPathNode) n, tool);</span>
<span class="udiff-line-modified-added">+             } else if (n instanceof ArrayCopyWithDelayedLoweringNode) {</span>
<span class="udiff-line-modified-added">+                 arraycopySnippets.lower((ArrayCopyWithDelayedLoweringNode) n, tool);</span>
              } else if (n instanceof G1PreWriteBarrier) {
<span class="udiff-line-modified-removed">-                 writeBarrierSnippets.lower((G1PreWriteBarrier) n, registers, tool);</span>
<span class="udiff-line-modified-added">+                 g1WriteBarrierSnippets.lower((G1PreWriteBarrier) n, tool);</span>
              } else if (n instanceof G1PostWriteBarrier) {
<span class="udiff-line-modified-removed">-                 writeBarrierSnippets.lower((G1PostWriteBarrier) n, registers, tool);</span>
<span class="udiff-line-modified-added">+                 g1WriteBarrierSnippets.lower((G1PostWriteBarrier) n, tool);</span>
              } else if (n instanceof G1ReferentFieldReadBarrier) {
<span class="udiff-line-modified-removed">-                 writeBarrierSnippets.lower((G1ReferentFieldReadBarrier) n, registers, tool);</span>
<span class="udiff-line-modified-added">+                 g1WriteBarrierSnippets.lower((G1ReferentFieldReadBarrier) n, tool);</span>
              } else if (n instanceof SerialWriteBarrier) {
<span class="udiff-line-modified-removed">-                 writeBarrierSnippets.lower((SerialWriteBarrier) n, tool);</span>
<span class="udiff-line-modified-added">+                 serialWriteBarrierSnippets.lower((SerialWriteBarrier) n, tool);</span>
              } else if (n instanceof SerialArrayRangeWriteBarrier) {
<span class="udiff-line-modified-removed">-                 writeBarrierSnippets.lower((SerialArrayRangeWriteBarrier) n, tool);</span>
<span class="udiff-line-modified-added">+                 serialWriteBarrierSnippets.lower((SerialArrayRangeWriteBarrier) n, tool);</span>
              } else if (n instanceof G1ArrayRangePreWriteBarrier) {
<span class="udiff-line-modified-removed">-                 writeBarrierSnippets.lower((G1ArrayRangePreWriteBarrier) n, registers, tool);</span>
<span class="udiff-line-modified-added">+                 g1WriteBarrierSnippets.lower((G1ArrayRangePreWriteBarrier) n, tool);</span>
              } else if (n instanceof G1ArrayRangePostWriteBarrier) {
<span class="udiff-line-modified-removed">-                 writeBarrierSnippets.lower((G1ArrayRangePostWriteBarrier) n, registers, tool);</span>
<span class="udiff-line-modified-added">+                 g1WriteBarrierSnippets.lower((G1ArrayRangePostWriteBarrier) n, tool);</span>
              } else if (n instanceof NewMultiArrayNode) {
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
                      newObjectSnippets.lower((NewMultiArrayNode) n, tool);
                  }
              } else if (n instanceof LoadExceptionObjectNode) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -393,14 +411,25 @@</span>
                  if (graph.getGuardsStage().areFrameStatesAtDeopts()) {
                      resolveConstantSnippets.lower((InitializeKlassNode) n, tool);
                  }
              } else if (n instanceof ProfileNode) {
                  profileSnippets.lower((ProfileNode) n, tool);
<span class="udiff-line-added">+             } else if (n instanceof KlassBeingInitializedCheckNode) {</span>
<span class="udiff-line-added">+                 newObjectSnippets.lower((KlassBeingInitializedCheckNode) n, registers, tool);</span>
<span class="udiff-line-added">+             } else if (n instanceof FastNotifyNode) {</span>
<span class="udiff-line-added">+                 if (graph.getGuardsStage() == GuardsStage.AFTER_FSA) {</span>
<span class="udiff-line-added">+                     objectSnippets.lower(n, tool);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else if (n instanceof UnsafeCopyMemoryNode) {</span>
<span class="udiff-line-added">+                 if (graph.getGuardsStage() == GuardsStage.AFTER_FSA) {</span>
<span class="udiff-line-added">+                     unsafeSnippets.lower((UnsafeCopyMemoryNode) n, tool);</span>
<span class="udiff-line-added">+                 }</span>
              } else {
                  super.lower(n, tool);
              }
          }
<span class="udiff-line-added">+ </span>
      }
  
      private static void lowerComputeObjectAddressNode(ComputeObjectAddressNode n) {
          /*
           * Lower the node into a ComputeObjectAddress node and an Add but ensure that it&#39;s below any
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -466,15 +495,19 @@</span>
  
      private void lowerInvoke(Invoke invoke, LoweringTool tool, StructuredGraph graph) {
          if (invoke.callTarget() instanceof MethodCallTargetNode) {
              MethodCallTargetNode callTarget = (MethodCallTargetNode) invoke.callTarget();
              NodeInputList&lt;ValueNode&gt; parameters = callTarget.arguments();
<span class="udiff-line-modified-removed">-             ValueNode receiver = parameters.size() &lt;= 0 ? null : parameters.get(0);</span>
<span class="udiff-line-modified-removed">-             if (!callTarget.isStatic() &amp;&amp; receiver.stamp(NodeView.DEFAULT) instanceof ObjectStamp &amp;&amp; !StampTool.isPointerNonNull(receiver)) {</span>
<span class="udiff-line-modified-removed">-                 ValueNode nonNullReceiver = createNullCheckedValue(receiver, invoke.asNode(), tool);</span>
<span class="udiff-line-modified-removed">-                 parameters.set(0, nonNullReceiver);</span>
<span class="udiff-line-modified-removed">-                 receiver = nonNullReceiver;</span>
<span class="udiff-line-modified-added">+             ValueNode receiver = parameters.isEmpty() ? null : parameters.get(0);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+             if (!callTarget.isStatic()) {</span>
<span class="udiff-line-modified-added">+                 assert receiver != null : &quot;non-static call must have a receiver&quot;;</span>
<span class="udiff-line-modified-added">+                 if (receiver.stamp(NodeView.DEFAULT) instanceof ObjectStamp &amp;&amp; !StampTool.isPointerNonNull(receiver)) {</span>
<span class="udiff-line-added">+                     ValueNode nonNullReceiver = createNullCheckedValue(receiver, invoke.asNode(), tool);</span>
<span class="udiff-line-added">+                     parameters.set(0, nonNullReceiver);</span>
<span class="udiff-line-added">+                     receiver = nonNullReceiver;</span>
<span class="udiff-line-added">+                 }</span>
              }
              JavaType[] signature = callTarget.targetMethod().getSignature().toParameterTypes(callTarget.isStatic() ? null : callTarget.targetMethod().getDeclaringClass());
  
              LoweredCallTargetNode loweredCallTarget = null;
              OptionValues options = graph.getOptions();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -541,20 +574,10 @@</span>
           */
          AddressNode address = createOffsetAddress(graph, arrayHub, runtime.getVMConfig().arrayClassElementOffset);
          return graph.unique(new FloatingReadNode(address, OBJ_ARRAY_KLASS_ELEMENT_KLASS_LOCATION, null, KlassPointerStamp.klassNonNull(), AbstractBeginNode.prevBegin(anchor)));
      }
  
<span class="udiff-line-removed">-     @Override</span>
<span class="udiff-line-removed">-     protected void lowerUnsafeLoadNode(RawLoadNode load, LoweringTool tool) {</span>
<span class="udiff-line-removed">-         StructuredGraph graph = load.graph();</span>
<span class="udiff-line-removed">-         if (!(load instanceof GuardedUnsafeLoadNode) &amp;&amp; !graph.getGuardsStage().allowsFloatingGuards() &amp;&amp; addReadBarrier(load)) {</span>
<span class="udiff-line-removed">-             unsafeLoadSnippets.lower(load, tool);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             super.lowerUnsafeLoadNode(load, tool);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      private void lowerLoadMethodNode(LoadMethodNode loadMethodNode) {
          StructuredGraph graph = loadMethodNode.graph();
          HotSpotResolvedJavaMethod method = (HotSpotResolvedJavaMethod) loadMethodNode.getMethod();
          ReadNode metaspaceMethod = createReadVirtualMethod(graph, loadMethodNode.getHub(), method, loadMethodNode.getReceiverType());
          graph.replaceFixed(loadMethodNode, metaspaceMethod);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -572,20 +595,10 @@</span>
      private void lowerStoreHubNode(StoreHubNode storeHub, StructuredGraph graph) {
          WriteNode hub = createWriteHub(graph, storeHub.getObject(), storeHub.getValue());
          graph.replaceFixed(storeHub, hub);
      }
  
<span class="udiff-line-removed">-     @Override</span>
<span class="udiff-line-removed">-     public BarrierType fieldInitializationBarrier(JavaKind entryKind) {</span>
<span class="udiff-line-removed">-         return (entryKind == JavaKind.Object &amp;&amp; !runtime.getVMConfig().useDeferredInitBarriers) ? BarrierType.IMPRECISE : BarrierType.NONE;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @Override</span>
<span class="udiff-line-removed">-     public BarrierType arrayInitializationBarrier(JavaKind entryKind) {</span>
<span class="udiff-line-removed">-         return (entryKind == JavaKind.Object &amp;&amp; !runtime.getVMConfig().useDeferredInitBarriers) ? BarrierType.PRECISE : BarrierType.NONE;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      private void lowerOSRStartNode(OSRStartNode osrStart) {
          StructuredGraph graph = osrStart.graph();
          if (graph.getGuardsStage() == StructuredGraph.GuardsStage.FIXED_DEOPTS) {
              StartNode newStart = graph.add(new StartNode());
              ParameterNode buffer = graph.addWithoutUnique(new ParameterNode(0, StampPair.createSingle(StampFactory.forKind(runtime.getTarget().wordJavaKind))));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -637,11 +650,11 @@</span>
                  BeginLockScopeNode beginLockScope = graph.add(new BeginLockScopeNode(lock.getStackKind(), monitorID.getLockDepth()));
                  graph.addBeforeFixed(migrationEnd, beginLockScope);
  
                  // write the displaced mark to the correct stack slot
                  AddressNode addressDisplacedMark = createOffsetAddress(graph, beginLockScope, runtime.getVMConfig().basicLockDisplacedHeaderOffset);
<span class="udiff-line-modified-removed">-                 WriteNode writeStackSlot = graph.add(new WriteNode(addressDisplacedMark, DISPLACED_MARK_WORD_LOCATION, loadDisplacedHeader, BarrierType.NONE));</span>
<span class="udiff-line-modified-added">+                 WriteNode writeStackSlot = graph.add(new WriteNode(addressDisplacedMark, DISPLACED_MARK_WORD_LOCATION, loadDisplacedHeader, BarrierType.NONE, false));</span>
                  graph.addBeforeFixed(migrationEnd, writeStackSlot);
  
                  // load the lock object from the osr buffer
                  AddressNode addressLockObject = createOffsetAddress(graph, buffer, offsetLockObject);
                  ReadNode loadObject = graph.add(new ReadNode(addressLockObject, any(), lock.stamp(NodeView.DEFAULT), BarrierType.NONE));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -707,24 +720,20 @@</span>
          ForeignCallDescriptor descriptor = RuntimeCalls.runtimeCalls.get(node.getExceptionKind());
          assert descriptor != null;
  
          StructuredGraph graph = node.graph();
          ForeignCallNode foreignCallNode = graph.add(new ForeignCallNode(foreignCalls, descriptor, node.stamp(NodeView.DEFAULT), node.getArguments()));
<span class="udiff-line-added">+         /*</span>
<span class="udiff-line-added">+          * The original BytecodeExceptionNode has a rethrowException FrameState which isn&#39;t suitable</span>
<span class="udiff-line-added">+          * for deopt because the exception to be thrown come from this call so it&#39;s not available in</span>
<span class="udiff-line-added">+          * the debug info. The foreign call needs a stateDuring instead so it can deopt with a</span>
<span class="udiff-line-added">+          * pending exception.</span>
<span class="udiff-line-added">+          */</span>
<span class="udiff-line-added">+         foreignCallNode.setStateAfter(node.createStateDuring());</span>
          graph.replaceFixedWithFixed(node, foreignCallNode);
      }
  
<span class="udiff-line-removed">-     private boolean addReadBarrier(RawLoadNode load) {</span>
<span class="udiff-line-removed">-         if (runtime.getVMConfig().useG1GC &amp;&amp; load.graph().getGuardsStage() == StructuredGraph.GuardsStage.FIXED_DEOPTS &amp;&amp; load.object().getStackKind() == JavaKind.Object &amp;&amp;</span>
<span class="udiff-line-removed">-                         load.accessKind() == JavaKind.Object &amp;&amp; !StampTool.isPointerAlwaysNull(load.object())) {</span>
<span class="udiff-line-removed">-             ResolvedJavaType type = StampTool.typeOrNull(load.object());</span>
<span class="udiff-line-removed">-             if (type != null &amp;&amp; !type.isArray()) {</span>
<span class="udiff-line-removed">-                 return true;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return false;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      private ReadNode createReadVirtualMethod(StructuredGraph graph, ValueNode hub, HotSpotResolvedJavaMethod method, ResolvedJavaType receiverType) {
          return createReadVirtualMethod(graph, hub, method.vtableEntryOffset(receiverType));
      }
  
      private ReadNode createReadVirtualMethod(StructuredGraph graph, ValueNode hub, int vtableEntryOffset) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -766,22 +775,21 @@</span>
          if (runtime.getVMConfig().useCompressedClassPointers) {
              writeValue = HotSpotCompressionNode.compress(value, runtime.getVMConfig().getKlassEncoding());
          }
  
          AddressNode address = createOffsetAddress(graph, object, runtime.getVMConfig().hubOffset);
<span class="udiff-line-modified-removed">-         return graph.add(new WriteNode(address, HUB_WRITE_LOCATION, writeValue, BarrierType.NONE));</span>
<span class="udiff-line-modified-added">+         return graph.add(new WriteNode(address, HUB_WRITE_LOCATION, writeValue, BarrierType.NONE, false));</span>
      }
  
      @Override
      protected BarrierType fieldLoadBarrierType(ResolvedJavaField f) {
          HotSpotResolvedJavaField loadField = (HotSpotResolvedJavaField) f;
<span class="udiff-line-modified-removed">-         BarrierType barrierType = BarrierType.NONE;</span>
<span class="udiff-line-removed">-         if (runtime.getVMConfig().useG1GC &amp;&amp; loadField.getJavaKind() == JavaKind.Object &amp;&amp; metaAccess.lookupJavaType(Reference.class).equals(loadField.getDeclaringClass()) &amp;&amp;</span>
<span class="udiff-line-modified-added">+         if (loadField.getJavaKind() == JavaKind.Object &amp;&amp; metaAccess.lookupJavaType(Reference.class).equals(loadField.getDeclaringClass()) &amp;&amp;</span>
                          loadField.getName().equals(&quot;referent&quot;)) {
<span class="udiff-line-modified-removed">-             barrierType = BarrierType.PRECISE;</span>
<span class="udiff-line-modified-added">+             return BarrierType.WEAK_FIELD;</span>
          }
<span class="udiff-line-modified-removed">-         return barrierType;</span>
<span class="udiff-line-modified-added">+         return super.fieldLoadBarrierType(f);</span>
      }
  
      @Override
      public int fieldOffset(ResolvedJavaField f) {
          return f.getOffset();
</pre>
<center><a href="AddressLoweringHotSpotSuitesProvider.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotForeignCallsProviderImpl.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>