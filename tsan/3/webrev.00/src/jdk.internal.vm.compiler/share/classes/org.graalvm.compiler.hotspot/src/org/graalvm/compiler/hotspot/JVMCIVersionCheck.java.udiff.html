<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/JVMCIVersionCheck.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IsGraalPredicate.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SymbolicSnippetEncoder.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/JVMCIVersionCheck.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,10 +23,15 @@</span>
  
  
  package org.graalvm.compiler.hotspot;
  
  import java.util.Formatter;
<span class="udiff-line-added">+ import java.util.HashMap;</span>
<span class="udiff-line-added">+ import java.util.Map;</span>
<span class="udiff-line-added">+ import java.util.Properties;</span>
<span class="udiff-line-added">+ import java.util.regex.Matcher;</span>
<span class="udiff-line-added">+ import java.util.regex.Pattern;</span>
  
  /**
   * Mechanism for checking that the current Java runtime environment supports the minimum JVMCI API
   * required by Graal. The {@code JVMCI_VERSION_CHECK} environment variable can be used to ignore a
   * failed check ({@code JVMCI_VERSION_CHECK=ignore}) or print a warning (
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -34,28 +39,130 @@</span>
   * {@link InternalError} being raised or, if called from {@link #main(String[])}, the VM exiting
   * with a result code of {@code -1}
   *
   * This class only depends on the JDK so that it can be used without building Graal.
   */
<span class="udiff-line-modified-removed">- class JVMCIVersionCheck {</span>
<span class="udiff-line-modified-added">+ public final class JVMCIVersionCheck {</span>
  
<span class="udiff-line-modified-removed">-     // 0.55 introduces new HotSpotSpeculationLog API</span>
<span class="udiff-line-removed">-     private static final int JVMCI8_MIN_MAJOR_VERSION = 0;</span>
<span class="udiff-line-removed">-     private static final int JVMCI8_MIN_MINOR_VERSION = 55;</span>
<span class="udiff-line-modified-added">+     private static final Version JVMCI_MIN_VERSION = new Version3(19, 3, 4);</span>
  
<span class="udiff-line-modified-removed">-     private static void failVersionCheck(boolean exit, String reason, Object... args) {</span>
<span class="udiff-line-modified-added">+     public interface Version {</span>
<span class="udiff-line-added">+         boolean isLessThan(Version other);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static Version parse(String vmVersion) {</span>
<span class="udiff-line-added">+             Matcher m = Pattern.compile(&quot;.*-jvmci-(\\d+)\\.(\\d+)-b(\\d+).*&quot;).matcher(vmVersion);</span>
<span class="udiff-line-added">+             if (m.matches()) {</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     int major = Integer.parseInt(m.group(1));</span>
<span class="udiff-line-added">+                     int minor = Integer.parseInt(m.group(2));</span>
<span class="udiff-line-added">+                     int build = Integer.parseInt(m.group(3));</span>
<span class="udiff-line-added">+                     return new Version3(major, minor, build);</span>
<span class="udiff-line-added">+                 } catch (NumberFormatException e) {</span>
<span class="udiff-line-added">+                     // ignore</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             m = Pattern.compile(&quot;.*-jvmci-(\\d+)(?:\\.|-b)(\\d+).*&quot;).matcher(vmVersion);</span>
<span class="udiff-line-added">+             if (m.matches()) {</span>
<span class="udiff-line-added">+                 try {</span>
<span class="udiff-line-added">+                     int major = Integer.parseInt(m.group(1));</span>
<span class="udiff-line-added">+                     int minor = Integer.parseInt(m.group(2));</span>
<span class="udiff-line-added">+                     return new Version2(major, minor);</span>
<span class="udiff-line-added">+                 } catch (NumberFormatException e) {</span>
<span class="udiff-line-added">+                     // ignore</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return null;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static class Version2 implements Version {</span>
<span class="udiff-line-added">+         private final int major;</span>
<span class="udiff-line-added">+         private final int minor;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public Version2(int major, int minor) {</span>
<span class="udiff-line-added">+             this.major = major;</span>
<span class="udiff-line-added">+             this.minor = minor;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public boolean isLessThan(Version other) {</span>
<span class="udiff-line-added">+             if (other.getClass() == Version3.class) {</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             Version2 o = (Version2) other;</span>
<span class="udiff-line-added">+             if (this.major &lt; o.major) {</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (this.major == o.major &amp;&amp; this.minor &lt; o.minor) {</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public String toString() {</span>
<span class="udiff-line-added">+             if (major &gt;= 19) {</span>
<span class="udiff-line-added">+                 return String.format(&quot;%d-b%02d&quot;, major, minor);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 return String.format(&quot;%d.%d&quot;, major, minor);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static class Version3 implements Version {</span>
<span class="udiff-line-added">+         private final int major;</span>
<span class="udiff-line-added">+         private final int minor;</span>
<span class="udiff-line-added">+         private final int build;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         public Version3(int major, int minor, int build) {</span>
<span class="udiff-line-added">+             this.major = major;</span>
<span class="udiff-line-added">+             this.minor = minor;</span>
<span class="udiff-line-added">+             this.build = build;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public boolean isLessThan(Version other) {</span>
<span class="udiff-line-added">+             if (other.getClass() == Version2.class) {</span>
<span class="udiff-line-added">+                 return false;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             Version3 o = (Version3) other;</span>
<span class="udiff-line-added">+             if (this.major &lt; o.major) {</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (this.major == o.major) {</span>
<span class="udiff-line-added">+                 if (this.minor &lt; o.minor) {</span>
<span class="udiff-line-added">+                     return true;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (this.minor == o.minor &amp;&amp; this.build &lt; o.build) {</span>
<span class="udiff-line-added">+                     return true;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public String toString() {</span>
<span class="udiff-line-added">+             return String.format(&quot;%d.%d-b%02d&quot;, major, minor, build);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void failVersionCheck(boolean exit, String reason, Object... args) {</span>
          Formatter errorMessage = new Formatter().format(reason, args);
<span class="udiff-line-modified-removed">-         String javaHome = System.getProperty(&quot;java.home&quot;);</span>
<span class="udiff-line-modified-removed">-         String vmName = System.getProperty(&quot;java.vm.name&quot;);</span>
<span class="udiff-line-modified-added">+         String javaHome = props.get(&quot;java.home&quot;);</span>
<span class="udiff-line-modified-added">+         String vmName = props.get(&quot;java.vm.name&quot;);</span>
          errorMessage.format(&quot;Set the JVMCI_VERSION_CHECK environment variable to \&quot;ignore\&quot; to suppress &quot;);
          errorMessage.format(&quot;this error or to \&quot;warn\&quot; to emit a warning and continue execution.%n&quot;);
          errorMessage.format(&quot;Currently used Java home directory is %s.%n&quot;, javaHome);
          errorMessage.format(&quot;Currently used VM configuration is: %s%n&quot;, vmName);
<span class="udiff-line-modified-removed">-         if (System.getProperty(&quot;java.specification.version&quot;).compareTo(&quot;1.9&quot;) &lt; 0) {</span>
<span class="udiff-line-modified-removed">-             errorMessage.format(&quot;Download the latest JVMCI JDK 8 from http://www.oracle.com/technetwork/oracle-labs/program-languages/downloads/index.html&quot;);</span>
<span class="udiff-line-modified-added">+         if (javaSpecVersion.compareTo(&quot;1.9&quot;) &lt; 0) {</span>
<span class="udiff-line-modified-added">+             errorMessage.format(&quot;Download the latest JVMCI JDK 8 from https://github.com/graalvm/openjdk8-jvmci-builder/releases&quot;);</span>
          } else {
<span class="udiff-line-modified-removed">-             errorMessage.format(&quot;Download JDK 11 or later.&quot;);</span>
<span class="udiff-line-modified-added">+             if (javaSpecVersion.compareTo(&quot;11&quot;) == 0 &amp;&amp; vmVersion.contains(&quot;-jvmci-&quot;)) {</span>
<span class="udiff-line-added">+                 errorMessage.format(&quot;Download the latest Labs OpenJDK 11 from https://github.com/graalvm/labs-openjdk-11/releases&quot;);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 errorMessage.format(&quot;Download JDK 11 or later.&quot;);</span>
<span class="udiff-line-added">+             }</span>
          }
          String value = System.getenv(&quot;JVMCI_VERSION_CHECK&quot;);
          if (&quot;warn&quot;.equals(value)) {
              System.err.println(errorMessage.toString());
          } else if (&quot;ignore&quot;.equals(value)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -66,48 +173,44 @@</span>
          } else {
              throw new InternalError(errorMessage.toString());
          }
      }
  
<span class="udiff-line-modified-removed">-     static void check(boolean exitOnFailure) {</span>
<span class="udiff-line-modified-removed">-         // Don&#39;t use regular expressions to minimize Graal startup time</span>
<span class="udiff-line-modified-removed">-         String javaSpecVersion = System.getProperty(&quot;java.specification.version&quot;);</span>
<span class="udiff-line-modified-removed">-         String vmVersion = System.getProperty(&quot;java.vm.version&quot;);</span>
<span class="udiff-line-modified-added">+     private final String javaSpecVersion;</span>
<span class="udiff-line-modified-added">+     private final String vmVersion;</span>
<span class="udiff-line-modified-added">+     private final Map&lt;String, String&gt; props;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     private JVMCIVersionCheck(Map&lt;String, String&gt; props, String javaSpecVersion, String vmVersion) {</span>
<span class="udiff-line-added">+         this.props = props;</span>
<span class="udiff-line-added">+         this.javaSpecVersion = javaSpecVersion;</span>
<span class="udiff-line-added">+         this.vmVersion = vmVersion;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static void check(Map&lt;String, String&gt; props, boolean exitOnFailure) {</span>
<span class="udiff-line-added">+         JVMCIVersionCheck checker = new JVMCIVersionCheck(props, props.get(&quot;java.specification.version&quot;), props.get(&quot;java.vm.version&quot;));</span>
<span class="udiff-line-added">+         checker.run(exitOnFailure, JVMCI_MIN_VERSION);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Entry point for testing.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public static void check(Map&lt;String, String&gt; props,</span>
<span class="udiff-line-added">+                     Version minVersion,</span>
<span class="udiff-line-added">+                     String javaSpecVersion,</span>
<span class="udiff-line-added">+                     String javaVmVersion, boolean exitOnFailure) {</span>
<span class="udiff-line-added">+         JVMCIVersionCheck checker = new JVMCIVersionCheck(props, javaSpecVersion, javaVmVersion);</span>
<span class="udiff-line-added">+         checker.run(exitOnFailure, minVersion);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void run(boolean exitOnFailure, Version minVersion) {</span>
          if (javaSpecVersion.compareTo(&quot;1.9&quot;) &lt; 0) {
<span class="udiff-line-modified-removed">-             int start = vmVersion.indexOf(&quot;-jvmci-&quot;);</span>
<span class="udiff-line-modified-removed">-             if (start &gt;= 0) {</span>
<span class="udiff-line-modified-removed">-                 start += &quot;-jvmci-&quot;.length();</span>
<span class="udiff-line-modified-removed">-                 int end = vmVersion.indexOf(&#39;.&#39;, start);</span>
<span class="udiff-line-removed">-                 if (end &gt; 0) {</span>
<span class="udiff-line-removed">-                     int major;</span>
<span class="udiff-line-removed">-                     try {</span>
<span class="udiff-line-removed">-                         major = Integer.parseInt(vmVersion.substring(start, end));</span>
<span class="udiff-line-removed">-                     } catch (NumberFormatException e) {</span>
<span class="udiff-line-removed">-                         failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal.%n&quot; +</span>
<span class="udiff-line-removed">-                                         &quot;Cannot read JVMCI major version from java.vm.version property: %s.%n&quot;, vmVersion);</span>
<span class="udiff-line-removed">-                         return;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     start = end + 1;</span>
<span class="udiff-line-removed">-                     end = start;</span>
<span class="udiff-line-removed">-                     while (end &lt; vmVersion.length() &amp;&amp; Character.isDigit(vmVersion.charAt(end))) {</span>
<span class="udiff-line-removed">-                         end++;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     int minor;</span>
<span class="udiff-line-removed">-                     try {</span>
<span class="udiff-line-removed">-                         minor = Integer.parseInt(vmVersion.substring(start, end));</span>
<span class="udiff-line-removed">-                     } catch (NumberFormatException e) {</span>
<span class="udiff-line-removed">-                         failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal.%n&quot; +</span>
<span class="udiff-line-removed">-                                         &quot;Cannot read JVMCI minor version from java.vm.version property: %s.%n&quot;, vmVersion);</span>
<span class="udiff-line-removed">-                         return;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     if (major &gt;= JVMCI8_MIN_MAJOR_VERSION &amp;&amp; minor &gt;= JVMCI8_MIN_MINOR_VERSION) {</span>
<span class="udiff-line-removed">-                         return;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal: %d.%d &lt; %d.%d.%n&quot;,</span>
<span class="udiff-line-removed">-                                     major, minor, JVMCI8_MIN_MAJOR_VERSION, JVMCI8_MIN_MINOR_VERSION);</span>
<span class="udiff-line-removed">-                     return;</span>
<span class="udiff-line-modified-added">+             Version v = Version.parse(vmVersion);</span>
<span class="udiff-line-modified-added">+             if (v != null) {</span>
<span class="udiff-line-modified-added">+                 if (v.isLessThan(minVersion)) {</span>
<span class="udiff-line-modified-added">+                     failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal: %s &lt; %s.%n&quot;, v, minVersion);</span>
                  }
<span class="udiff-line-added">+                 return;</span>
              }
              failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal.%n&quot; +
                              &quot;Cannot read JVMCI version from java.vm.version property: %s.%n&quot;, vmVersion);
          } else if (javaSpecVersion.compareTo(&quot;11&quot;) &lt; 0) {
              failVersionCheck(exitOnFailure, &quot;Graal is not compatible with the JVMCI API in JDK 9 and 10.%n&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -117,30 +220,34 @@</span>
              }
              if (vmVersion.contains(&quot;internal&quot;)) {
                  // Allow local builds
                  return;
              }
<span class="udiff-line-modified-removed">-             if (vmVersion.startsWith(&quot;11-ea+&quot;)) {</span>
<span class="udiff-line-modified-removed">-                 String buildString = vmVersion.substring(&quot;11-ea+&quot;.length());</span>
<span class="udiff-line-modified-removed">-                 try {</span>
<span class="udiff-line-modified-removed">-                     int build = Integer.parseInt(buildString);</span>
<span class="udiff-line-modified-removed">-                     if (build &lt; 20) {</span>
<span class="udiff-line-modified-removed">-                         failVersionCheck(exitOnFailure, &quot;Graal requires build 20 or later of JDK 11 early access binary, got build %d.%n&quot;, build);</span>
<span class="udiff-line-removed">-                         return;</span>
<span class="udiff-line-modified-added">+             if (vmVersion.contains(&quot;-jvmci-&quot;)) {</span>
<span class="udiff-line-modified-added">+                 // A &quot;labsjdk&quot;</span>
<span class="udiff-line-modified-added">+                 Version v = Version.parse(vmVersion);</span>
<span class="udiff-line-modified-added">+                 if (v != null) {</span>
<span class="udiff-line-modified-added">+                     if (v.isLessThan(minVersion)) {</span>
<span class="udiff-line-modified-added">+                         failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal: %s &lt; %s.%n&quot;, v, minVersion);</span>
                      }
<span class="udiff-line-removed">-                 } catch (NumberFormatException e) {</span>
<span class="udiff-line-removed">-                     failVersionCheck(exitOnFailure, &quot;Could not parse the JDK 11 early access build number from java.vm.version property: %s.%n&quot;, vmVersion);</span>
                      return;
                  }
<span class="udiff-line-added">+                 failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal.%n&quot; +</span>
<span class="udiff-line-added">+                                 &quot;Cannot read JVMCI version from java.vm.version property: %s.%n&quot;, vmVersion);</span>
              } else {
                  // Graal is compatible with all JDK versions as of 11 GA.
              }
          }
      }
  
      /**
       * Command line interface for performing the check.
       */
      public static void main(String[] args) {
<span class="udiff-line-modified-removed">-         check(true);</span>
<span class="udiff-line-modified-added">+         Properties sprops = System.getProperties();</span>
<span class="udiff-line-added">+         Map&lt;String, String&gt; props = new HashMap&lt;&gt;(sprops.size());</span>
<span class="udiff-line-added">+         for (String name : sprops.stringPropertyNames()) {</span>
<span class="udiff-line-added">+             props.put(name, sprops.getProperty(name));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         check(props, true);</span>
      }
  }
</pre>
<center><a href="IsGraalPredicate.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SymbolicSnippetEncoder.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>