<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/CompilationTask.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot;
 26 
 27 import static org.graalvm.compiler.core.CompilationWrapper.ExceptionAction.Diagnose;
 28 import static org.graalvm.compiler.core.CompilationWrapper.ExceptionAction.ExitVM;
<a name="2" id="anc2"></a><span class="line-modified"> 29 import static org.graalvm.compiler.core.GraalCompilerOptions.CompilationBailoutAsFailure;</span>
 30 import static org.graalvm.compiler.core.GraalCompilerOptions.CompilationFailureAction;
 31 import static org.graalvm.compiler.core.phases.HighTier.Options.Inline;
 32 import static org.graalvm.compiler.java.BytecodeParserOptions.InlineDuringParsing;
 33 
 34 import java.io.PrintStream;
<a name="3" id="anc3"></a><span class="line-added"> 35 import java.util.Collections;</span>
 36 import java.util.List;
 37 
 38 import jdk.internal.vm.compiler.collections.EconomicMap;
 39 import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
 40 import org.graalvm.compiler.code.CompilationResult;
 41 import org.graalvm.compiler.core.CompilationPrinter;
 42 import org.graalvm.compiler.core.CompilationWrapper;
 43 import org.graalvm.compiler.core.common.CompilationIdentifier;
<a name="4" id="anc4"></a>
 44 import org.graalvm.compiler.debug.CounterKey;
 45 import org.graalvm.compiler.debug.DebugCloseable;
 46 import org.graalvm.compiler.debug.DebugContext;
<a name="5" id="anc5"></a><span class="line-added"> 47 import org.graalvm.compiler.debug.DebugContext.Description;</span>
 48 import org.graalvm.compiler.debug.DebugDumpScope;
<a name="6" id="anc6"></a><span class="line-modified"> 49 import org.graalvm.compiler.debug.DebugHandlersFactory;</span>
 50 import org.graalvm.compiler.debug.TimerKey;
<a name="7" id="anc7"></a>
 51 import org.graalvm.compiler.options.OptionKey;
 52 import org.graalvm.compiler.options.OptionValues;
 53 import org.graalvm.compiler.printer.GraalDebugHandlersFactory;
 54 
 55 import jdk.vm.ci.code.BailoutException;
 56 import jdk.vm.ci.code.CodeCacheProvider;
<a name="8" id="anc8"></a>
 57 import jdk.vm.ci.hotspot.HotSpotCompilationRequest;
 58 import jdk.vm.ci.hotspot.HotSpotCompilationRequestResult;
 59 import jdk.vm.ci.hotspot.HotSpotInstalledCode;
<a name="9" id="anc9"></a>
 60 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
 61 import jdk.vm.ci.hotspot.HotSpotNmethod;
 62 import jdk.vm.ci.hotspot.HotSpotResolvedJavaMethod;
<a name="10" id="anc10"></a><span class="line-added"> 63 import jdk.vm.ci.meta.ResolvedJavaMethod;</span>
 64 import jdk.vm.ci.runtime.JVMCICompiler;
<a name="11" id="anc11"></a>
 65 
 66 public class CompilationTask {
 67 
<a name="12" id="anc12"></a>












 68     private final HotSpotJVMCIRuntime jvmciRuntime;
 69 
 70     private final HotSpotGraalCompiler compiler;
 71     private final HotSpotCompilationIdentifier compilationId;
 72 
 73     private HotSpotInstalledCode installedCode;
 74 
 75     /**
 76      * Specifies whether the compilation result is installed as the
 77      * {@linkplain HotSpotNmethod#isDefault() default} nmethod for the compiled method.
 78      */
 79     private final boolean installAsDefault;
 80 
 81     private final boolean useProfilingInfo;
<a name="13" id="anc13"></a><span class="line-modified"> 82     private final boolean shouldRetainLocalVariables;</span>
 83 
 84     final class HotSpotCompilationWrapper extends CompilationWrapper&lt;HotSpotCompilationRequestResult&gt; {
<a name="14" id="anc14"></a>
 85         CompilationResult result;
 86 
<a name="15" id="anc15"></a><span class="line-modified"> 87         HotSpotCompilationWrapper() {</span>
 88             super(compiler.getGraalRuntime().getOutputDirectory(), compiler.getGraalRuntime().getCompilationProblemsPerAction());
<a name="16" id="anc16"></a>
 89         }
 90 
 91         @Override
<a name="17" id="anc17"></a><span class="line-modified"> 92         protected DebugContext createRetryDebugContext(DebugContext initialDebug, OptionValues retryOptions, PrintStream logStream) {</span>
 93             SnippetReflectionProvider snippetReflection = compiler.getGraalRuntime().getHostProviders().getSnippetReflection();
<a name="18" id="anc18"></a><span class="line-modified"> 94             Description description = initialDebug.getDescription();</span>
<span class="line-added"> 95             List&lt;DebugHandlersFactory&gt; factories = Collections.singletonList(new GraalDebugHandlersFactory(snippetReflection));</span>
<span class="line-added"> 96             return DebugContext.create(retryOptions, description, initialDebug.getGlobalMetrics(), logStream, factories);</span>
<span class="line-added"> 97         }</span>
<span class="line-added"> 98 </span>
<span class="line-added"> 99         @Override</span>
<span class="line-added">100         protected void exitHostVM(int status) {</span>
<span class="line-added">101             HotSpotGraalServices.exit(status);</span>
102         }
103 
104         @Override
105         public String toString() {
<a name="19" id="anc19"></a><span class="line-modified">106             return getMethod().format(&quot;%H.%n(%p) @ &quot; + getEntryBCI());</span>
107         }
108 
109         @Override
110         protected HotSpotCompilationRequestResult handleException(Throwable t) {
111             if (t instanceof BailoutException) {
112                 BailoutException bailout = (BailoutException) t;
113                 /*
114                  * Handling of permanent bailouts: Permanent bailouts that can happen for example
115                  * due to unsupported unstructured control flow in the bytecodes of a method must
116                  * not be retried. Hotspot compile broker will ensure that no recompilation at the
117                  * given tier will happen if retry is false.
118                  */
119                 return HotSpotCompilationRequestResult.failure(bailout.getMessage(), !bailout.isPermanent());
120             }
<a name="20" id="anc20"></a>






121 
122             /*
123              * Treat random exceptions from the compiler as indicating a problem compiling this
124              * method. Report the result of toString instead of getMessage to ensure that the
125              * exception type is included in the output in case there&#39;s no detail mesage.
126              */
127             return HotSpotCompilationRequestResult.failure(t.toString(), false);
128         }
129 
130         @Override
<a name="21" id="anc21"></a><span class="line-modified">131         protected ExceptionAction lookupAction(OptionValues values, Throwable cause) {</span>
<span class="line-modified">132             if (cause instanceof BailoutException) {</span>
<span class="line-modified">133                 BailoutException bailout = (BailoutException) cause;</span>
<span class="line-modified">134                 if (bailout.isPermanent()) {</span>
<span class="line-modified">135                     // Respect current action if it has been explicitly set.</span>
<span class="line-modified">136                     if (!CompilationBailoutAsFailure.hasBeenSet(values)) {</span>
<span class="line-modified">137                         // Get more info for permanent bailouts during bootstrap.</span>
<span class="line-modified">138                         if (compiler.getGraalRuntime().isBootstrapping()) {</span>
<span class="line-modified">139                             return Diagnose;</span>
<span class="line-modified">140                         }</span>
<span class="line-modified">141 </span>




142                     }
143                 }
<a name="22" id="anc22"></a><span class="line-added">144                 if (!CompilationBailoutAsFailure.getValue(values)) {</span>
<span class="line-added">145                     return super.lookupAction(values, cause);</span>
<span class="line-added">146                 }</span>
<span class="line-added">147             }</span>
<span class="line-added">148 </span>
<span class="line-added">149             // Respect current action if it has been explicitly set.</span>
<span class="line-added">150             if (!CompilationFailureAction.hasBeenSet(values)) {</span>
<span class="line-added">151                 // Automatically exit on failure during bootstrap.</span>
<span class="line-added">152                 if (compiler.getGraalRuntime().isBootstrapping()) {</span>
<span class="line-added">153                     return ExitVM;</span>
<span class="line-added">154                 }</span>
155             }
<a name="23" id="anc23"></a><span class="line-modified">156             return super.lookupAction(values, cause);</span>
157         }
158 
159         @SuppressWarnings(&quot;try&quot;)
160         @Override
161         protected HotSpotCompilationRequestResult performCompilation(DebugContext debug) {
162             HotSpotResolvedJavaMethod method = getMethod();
163             int entryBCI = getEntryBCI();
164             final boolean isOSR = entryBCI != JVMCICompiler.INVOCATION_ENTRY_BCI;
<a name="24" id="anc24"></a><span class="line-modified">165             CompilationStatistics stats = CompilationStatistics.create(debug.getOptions(), method, isOSR);</span>
166 
<a name="25" id="anc25"></a><span class="line-modified">167             final CompilationPrinter printer = CompilationPrinter.begin(debug.getOptions(), compilationId, method, entryBCI);</span>
168 
169             try (DebugContext.Scope s = debug.scope(&quot;Compiling&quot;, new DebugDumpScope(getIdString(), true))) {
<a name="26" id="anc26"></a><span class="line-modified">170                 result = compiler.compile(method, entryBCI, useProfilingInfo, shouldRetainLocalVariables, compilationId, debug);</span>


171             } catch (Throwable e) {
172                 throw debug.handle(e);
<a name="27" id="anc27"></a>


173             }
174 
175             if (result != null) {
176                 try (DebugCloseable b = CodeInstallationTime.start(debug)) {
177                     installMethod(debug, result);
178                 }
179                 // Installation is included in compilation time and memory usage reported by printer
180                 printer.finish(result);
181             }
182             stats.finish(method, installedCode);
183             if (result != null) {
<a name="28" id="anc28"></a><span class="line-modified">184                 // For compilation of substitutions the method in the compilation request might be</span>
<span class="line-added">185                 // different than the actual method parsed. The root of the compilation will always</span>
<span class="line-added">186                 // be the first method in the methods list, so use that instead.</span>
<span class="line-added">187                 ResolvedJavaMethod rootMethod = result.getMethods()[0];</span>
<span class="line-added">188                 int inlinedBytecodes = result.getBytecodeSize() - rootMethod.getCodeSize();</span>
<span class="line-added">189                 assert inlinedBytecodes &gt;= 0 : rootMethod + &quot; &quot; + method;</span>
<span class="line-added">190                 return HotSpotCompilationRequestResult.success(inlinedBytecodes);</span>
191             }
192             return null;
193         }
194 
195     }
196 
<a name="29" id="anc29"></a><span class="line-modified">197     public CompilationTask(HotSpotJVMCIRuntime jvmciRuntime,</span>
<span class="line-modified">198                     HotSpotGraalCompiler compiler,</span>
<span class="line-added">199                     HotSpotCompilationRequest request,</span>
<span class="line-added">200                     boolean useProfilingInfo,</span>
<span class="line-added">201                     boolean installAsDefault) {</span>
<span class="line-added">202         this(jvmciRuntime, compiler, request, useProfilingInfo, false, installAsDefault);</span>
<span class="line-added">203     }</span>
<span class="line-added">204 </span>
<span class="line-added">205     public CompilationTask(HotSpotJVMCIRuntime jvmciRuntime,</span>
<span class="line-added">206                     HotSpotGraalCompiler compiler,</span>
<span class="line-added">207                     HotSpotCompilationRequest request,</span>
<span class="line-added">208                     boolean useProfilingInfo,</span>
<span class="line-added">209                     boolean shouldRetainLocalVariables,</span>
<span class="line-added">210                     boolean installAsDefault) {</span>
211         this.jvmciRuntime = jvmciRuntime;
212         this.compiler = compiler;
213         this.compilationId = new HotSpotCompilationIdentifier(request);
214         this.useProfilingInfo = useProfilingInfo;
<a name="30" id="anc30"></a><span class="line-added">215         this.shouldRetainLocalVariables = shouldRetainLocalVariables;</span>
216         this.installAsDefault = installAsDefault;
<a name="31" id="anc31"></a><span class="line-added">217     }</span>
218 
<a name="32" id="anc32"></a><span class="line-added">219     public OptionValues filterOptions(OptionValues options) {</span>
220         /*
221          * Disable inlining if HotSpot has it disabled unless it&#39;s been explicitly set in Graal.
222          */
223         HotSpotGraalRuntimeProvider graalRuntime = compiler.getGraalRuntime();
224         GraalHotSpotVMConfig config = graalRuntime.getVMConfig();
225         OptionValues newOptions = options;
226         if (!config.inline) {
227             EconomicMap&lt;OptionKey&lt;?&gt;, Object&gt; m = OptionValues.newOptionMap();
228             if (Inline.getValue(options) &amp;&amp; !Inline.hasBeenSet(options)) {
229                 m.put(Inline, false);
230             }
231             if (InlineDuringParsing.getValue(options) &amp;&amp; !InlineDuringParsing.hasBeenSet(options)) {
232                 m.put(InlineDuringParsing, false);
233             }
234             if (!m.isEmpty()) {
235                 newOptions = new OptionValues(options, m);
236             }
237         }
<a name="33" id="anc33"></a><span class="line-modified">238         return newOptions;</span>
239     }
240 
241     public HotSpotResolvedJavaMethod getMethod() {
242         return getRequest().getMethod();
243     }
244 
245     CompilationIdentifier getCompilationIdentifier() {
246         return compilationId;
247     }
248 
249     /**
250      * Returns the HotSpot id of this compilation.
251      *
252      * @return HotSpot compile id
253      */
254     public int getId() {
255         return getRequest().getId();
256     }
257 
258     public int getEntryBCI() {
259         return getRequest().getEntryBCI();
260     }
261 
262     /**
263      * @return the compilation id plus a trailing &#39;%&#39; if the compilation is an OSR to match
264      *         PrintCompilation style output
265      */
266     public String getIdString() {
267         if (getEntryBCI() != JVMCICompiler.INVOCATION_ENTRY_BCI) {
268             return getId() + &quot;%&quot;;
269         } else {
270             return Integer.toString(getId());
271         }
272     }
273 
274     public HotSpotInstalledCode getInstalledCode() {
275         return installedCode;
276     }
277 
278     /**
279      * Time spent in compilation.
280      */
<a name="34" id="anc34"></a><span class="line-modified">281     public static final TimerKey CompilationTime = DebugContext.timer(&quot;CompilationTime&quot;).doc(&quot;Time spent in compilation and code installation.&quot;);</span>
282 
283     /**
284      * Counts the number of compiled {@linkplain CompilationResult#getBytecodeSize() bytecodes}.
285      */
286     private static final CounterKey CompiledBytecodes = DebugContext.counter(&quot;CompiledBytecodes&quot;);
287 
288     /**
289      * Counts the number of compiled {@linkplain CompilationResult#getBytecodeSize() bytecodes} for
290      * which {@linkplain CompilationResult#getTargetCode()} code was installed.
291      */
<a name="35" id="anc35"></a><span class="line-modified">292     public static final CounterKey CompiledAndInstalledBytecodes = DebugContext.counter(&quot;CompiledAndInstalledBytecodes&quot;);</span>
293 
294     /**
295      * Counts the number of installed {@linkplain CompilationResult#getTargetCodeSize()} bytes.
296      */
297     private static final CounterKey InstalledCodeSize = DebugContext.counter(&quot;InstalledCodeSize&quot;);
298 
299     /**
300      * Time spent in code installation.
301      */
302     public static final TimerKey CodeInstallationTime = DebugContext.timer(&quot;CodeInstallation&quot;);
303 
<a name="36" id="anc36"></a><span class="line-modified">304     public HotSpotCompilationRequestResult runCompilation(OptionValues initialOptions) {</span>
<span class="line-modified">305         OptionValues options = filterOptions(initialOptions);</span>
<span class="line-modified">306         HotSpotGraalRuntimeProvider graalRuntime = compiler.getGraalRuntime();</span>
<span class="line-added">307         try (DebugContext debug = graalRuntime.openDebugContext(options, compilationId, getMethod(), compiler.getDebugHandlersFactories(), DebugContext.DEFAULT_LOG_STREAM)) {</span>
308             return runCompilation(debug);
309         }
310     }
311 
312     @SuppressWarnings(&quot;try&quot;)
313     public HotSpotCompilationRequestResult runCompilation(DebugContext debug) {
314         HotSpotGraalRuntimeProvider graalRuntime = compiler.getGraalRuntime();
315         GraalHotSpotVMConfig config = graalRuntime.getVMConfig();
316         int entryBCI = getEntryBCI();
317         boolean isOSR = entryBCI != JVMCICompiler.INVOCATION_ENTRY_BCI;
318         HotSpotResolvedJavaMethod method = getMethod();
319 
<a name="37" id="anc37"></a><span class="line-modified">320         if (installAsDefault || isOSR) {</span>



321             // If there is already compiled code for this method on our level we simply return.
322             // JVMCI compiles are always at the highest compile level, even in non-tiered mode so we
323             // only need to check for that value.
324             if (method.hasCodeAtLevel(entryBCI, config.compilationLevelFullOptimization)) {
325                 return HotSpotCompilationRequestResult.failure(&quot;Already compiled&quot;, false);
326             }
<a name="38" id="anc38"></a><span class="line-modified">327             if (HotSpotGraalCompilerFactory.shouldExclude(method)) {</span>

328                 return HotSpotCompilationRequestResult.failure(&quot;GraalCompileOnly excluded&quot;, false);
329             }
330         }
331 
<a name="39" id="anc39"></a><span class="line-modified">332         HotSpotCompilationWrapper compilation = new HotSpotCompilationWrapper();</span>
333         try (DebugCloseable a = CompilationTime.start(debug)) {
334             return compilation.run(debug);
335         } finally {
336             try {
337                 int compiledBytecodes = 0;
338                 int codeSize = 0;
339 
340                 if (compilation.result != null) {
341                     compiledBytecodes = compilation.result.getBytecodeSize();
342                     CompiledBytecodes.add(debug, compiledBytecodes);
343                     if (installedCode != null) {
344                         codeSize = installedCode.getSize();
345                         CompiledAndInstalledBytecodes.add(debug, compiledBytecodes);
346                         InstalledCodeSize.add(debug, codeSize);
347                     }
348                 }
<a name="40" id="anc40"></a>











349             } catch (Throwable t) {
350                 return compilation.handleException(t);
351             }
352         }
353     }
354 
355     @SuppressWarnings(&quot;try&quot;)
356     private void installMethod(DebugContext debug, final CompilationResult compResult) {
357         final CodeCacheProvider codeCache = jvmciRuntime.getHostJVMCIBackend().getCodeCache();
358         HotSpotBackend backend = compiler.getGraalRuntime().getHostBackend();
359         installedCode = null;
360         Object[] context = {new DebugDumpScope(getIdString(), true), codeCache, getMethod(), compResult};
361         try (DebugContext.Scope s = debug.scope(&quot;CodeInstall&quot;, context)) {
362             HotSpotCompilationRequest request = getRequest();
363             installedCode = (HotSpotInstalledCode) backend.createInstalledCode(debug,
364                             request.getMethod(),
365                             request,
366                             compResult,
367                             null,
368                             installAsDefault,
369                             context);
370         } catch (Throwable e) {
371             throw debug.handle(e);
372         }
373     }
374 
375     @Override
376     public String toString() {
377         return &quot;Compilation[id=&quot; + getId() + &quot;, &quot; + getMethod().format(&quot;%H.%n(%p)&quot;) + (getEntryBCI() == JVMCICompiler.INVOCATION_ENTRY_BCI ? &quot;&quot; : &quot;@&quot; + getEntryBCI()) + &quot;]&quot;;
378     }
379 
380     private HotSpotCompilationRequest getRequest() {
381         return compilationId.getRequest();
382     }
383 }
<a name="41" id="anc41"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="41" type="hidden" />
</body>
</html>