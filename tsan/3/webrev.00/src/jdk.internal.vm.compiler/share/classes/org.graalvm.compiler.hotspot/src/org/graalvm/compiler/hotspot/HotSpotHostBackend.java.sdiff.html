<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotHostBackend.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotGraalRuntimeProvider.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotLIRGenerationResult.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotHostBackend.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot;
 26 
 27 import static jdk.vm.ci.code.CodeUtil.K;
 28 import static jdk.vm.ci.code.CodeUtil.getCallingConvention;
 29 import static jdk.vm.ci.common.InitTimer.timer;
 30 
 31 import java.util.Collections;
 32 

 33 import org.graalvm.compiler.core.common.NumUtil;

 34 import org.graalvm.compiler.core.common.spi.ForeignCallDescriptor;

 35 import org.graalvm.compiler.debug.DebugHandlersFactory;
 36 import org.graalvm.compiler.hotspot.meta.HotSpotHostForeignCallsProvider;
 37 import org.graalvm.compiler.hotspot.meta.HotSpotLoweringProvider;
 38 import org.graalvm.compiler.hotspot.meta.HotSpotProviders;
 39 import org.graalvm.compiler.hotspot.stubs.Stub;

 40 import org.graalvm.compiler.lir.asm.CompilationResultBuilder;

 41 import org.graalvm.compiler.lir.framemap.ReferenceMapBuilder;

 42 import org.graalvm.compiler.nodes.StructuredGraph;
 43 import org.graalvm.compiler.options.OptionValues;
 44 import org.graalvm.compiler.printer.GraalDebugHandlersFactory;
 45 import org.graalvm.compiler.word.Word;
 46 
 47 import jdk.vm.ci.code.CallingConvention;

 48 import jdk.vm.ci.common.InitTimer;
 49 import jdk.vm.ci.hotspot.HotSpotCallingConventionType;
 50 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
 51 import jdk.vm.ci.meta.JavaKind;
 52 import jdk.vm.ci.meta.JavaType;
 53 import jdk.vm.ci.runtime.JVMCICompiler;
 54 
 55 /**
 56  * Common functionality of HotSpot host backends.
 57  */
<span class="line-modified"> 58 public abstract class HotSpotHostBackend extends HotSpotBackend {</span>
 59 
 60     /**
 61      * Descriptor for {@code SharedRuntime::deopt_blob()-&gt;unpack()}.
 62      */
<span class="line-modified"> 63     public static final ForeignCallDescriptor DEOPTIMIZATION_HANDLER = new ForeignCallDescriptor(&quot;deoptHandler&quot;, void.class);</span>





 64 
 65     /**
 66      * Descriptor for {@code SharedRuntime::deopt_blob()-&gt;uncommon_trap()}.
 67      */
<span class="line-modified"> 68     public static final ForeignCallDescriptor UNCOMMON_TRAP_HANDLER = new ForeignCallDescriptor(&quot;uncommonTrapHandler&quot;, void.class);</span>
 69 
 70     public static final ForeignCallDescriptor ENABLE_STACK_RESERVED_ZONE = new ForeignCallDescriptor(&quot;enableStackReservedZoneEntry&quot;, void.class, Word.class);
 71 
 72     public static final ForeignCallDescriptor THROW_DELAYED_STACKOVERFLOW_ERROR = new ForeignCallDescriptor(&quot;throwDelayedStackoverflowError&quot;, void.class);
 73 
 74     protected final GraalHotSpotVMConfig config;
 75 
 76     public HotSpotHostBackend(GraalHotSpotVMConfig config, HotSpotGraalRuntimeProvider runtime, HotSpotProviders providers) {
 77         super(runtime, providers);
 78         this.config = config;
 79     }
 80 
 81     @Override
 82     @SuppressWarnings(&quot;try&quot;)
 83     public void completeInitialization(HotSpotJVMCIRuntime jvmciRuntime, OptionValues options) {
 84         final HotSpotProviders providers = getProviders();
 85         HotSpotHostForeignCallsProvider foreignCalls = (HotSpotHostForeignCallsProvider) providers.getForeignCalls();
 86         final HotSpotLoweringProvider lowerer = (HotSpotLoweringProvider) providers.getLowerer();
 87 
 88         try (InitTimer st = timer(&quot;foreignCalls.initialize&quot;)) {
</pre>
<hr />
<pre>
138             int bangOffset = bangEndSafe;
139             if (bangOffset &lt;= bangEnd) {
140                 crb.blockComment(&quot;[stack overflow check]&quot;);
141             }
142             while (bangOffset &lt;= bangEnd) {
143                 // Need at least one stack bang at end of shadow zone.
144                 bangStackWithOffset(crb, bangOffset);
145                 bangOffset += pageSize;
146             }
147         }
148     }
149 
150     protected abstract void bangStackWithOffset(CompilationResultBuilder crb, int bangOffset);
151 
152     @Override
153     public ReferenceMapBuilder newReferenceMapBuilder(int totalFrameSize) {
154         int uncompressedReferenceSize = getTarget().arch.getPlatformKind(JavaKind.Object).getSizeInBytes();
155         return new HotSpotReferenceMapBuilder(totalFrameSize, config.maxOopMapStackOffset, uncompressedReferenceSize);
156     }
157 








158 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot;
 26 
 27 import static jdk.vm.ci.code.CodeUtil.K;
 28 import static jdk.vm.ci.code.CodeUtil.getCallingConvention;
 29 import static jdk.vm.ci.common.InitTimer.timer;
 30 
 31 import java.util.Collections;
 32 
<span class="line-added"> 33 import org.graalvm.compiler.core.common.CompilationIdentifier;</span>
 34 import org.graalvm.compiler.core.common.NumUtil;
<span class="line-added"> 35 import org.graalvm.compiler.core.common.alloc.RegisterAllocationConfig;</span>
 36 import org.graalvm.compiler.core.common.spi.ForeignCallDescriptor;
<span class="line-added"> 37 import org.graalvm.compiler.core.gen.LIRGenerationProvider;</span>
 38 import org.graalvm.compiler.debug.DebugHandlersFactory;
 39 import org.graalvm.compiler.hotspot.meta.HotSpotHostForeignCallsProvider;
 40 import org.graalvm.compiler.hotspot.meta.HotSpotLoweringProvider;
 41 import org.graalvm.compiler.hotspot.meta.HotSpotProviders;
 42 import org.graalvm.compiler.hotspot.stubs.Stub;
<span class="line-added"> 43 import org.graalvm.compiler.lir.LIR;</span>
 44 import org.graalvm.compiler.lir.asm.CompilationResultBuilder;
<span class="line-added"> 45 import org.graalvm.compiler.lir.framemap.FrameMapBuilder;</span>
 46 import org.graalvm.compiler.lir.framemap.ReferenceMapBuilder;
<span class="line-added"> 47 import org.graalvm.compiler.lir.gen.LIRGenerationResult;</span>
 48 import org.graalvm.compiler.nodes.StructuredGraph;
 49 import org.graalvm.compiler.options.OptionValues;
 50 import org.graalvm.compiler.printer.GraalDebugHandlersFactory;
 51 import org.graalvm.compiler.word.Word;
 52 
 53 import jdk.vm.ci.code.CallingConvention;
<span class="line-added"> 54 import jdk.vm.ci.code.RegisterConfig;</span>
 55 import jdk.vm.ci.common.InitTimer;
 56 import jdk.vm.ci.hotspot.HotSpotCallingConventionType;
 57 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
 58 import jdk.vm.ci.meta.JavaKind;
 59 import jdk.vm.ci.meta.JavaType;
 60 import jdk.vm.ci.runtime.JVMCICompiler;
 61 
 62 /**
 63  * Common functionality of HotSpot host backends.
 64  */
<span class="line-modified"> 65 public abstract class HotSpotHostBackend extends HotSpotBackend implements LIRGenerationProvider {</span>
 66 
 67     /**
 68      * Descriptor for {@code SharedRuntime::deopt_blob()-&gt;unpack()}.
 69      */
<span class="line-modified"> 70     public static final ForeignCallDescriptor DEOPT_BLOB_UNPACK = new ForeignCallDescriptor(&quot;deopt_blob()-&gt;unpack()&quot;, void.class);</span>
<span class="line-added"> 71 </span>
<span class="line-added"> 72     /**</span>
<span class="line-added"> 73      * Descriptor for {@code SharedRuntime::deopt_blob()-&gt;unpack_with_exception_in_tls()}.</span>
<span class="line-added"> 74      */</span>
<span class="line-added"> 75     public static final ForeignCallDescriptor DEOPT_BLOB_UNPACK_WITH_EXCEPTION_IN_TLS = new ForeignCallDescriptor(&quot;deopt_blob()-&gt;unpack_with_exception_in_tls()&quot;, void.class);</span>
 76 
 77     /**
 78      * Descriptor for {@code SharedRuntime::deopt_blob()-&gt;uncommon_trap()}.
 79      */
<span class="line-modified"> 80     public static final ForeignCallDescriptor DEOPT_BLOB_UNCOMMON_TRAP = new ForeignCallDescriptor(&quot;deopt_blob()-&gt;uncommon_trap()&quot;, void.class);</span>
 81 
 82     public static final ForeignCallDescriptor ENABLE_STACK_RESERVED_ZONE = new ForeignCallDescriptor(&quot;enableStackReservedZoneEntry&quot;, void.class, Word.class);
 83 
 84     public static final ForeignCallDescriptor THROW_DELAYED_STACKOVERFLOW_ERROR = new ForeignCallDescriptor(&quot;throwDelayedStackoverflowError&quot;, void.class);
 85 
 86     protected final GraalHotSpotVMConfig config;
 87 
 88     public HotSpotHostBackend(GraalHotSpotVMConfig config, HotSpotGraalRuntimeProvider runtime, HotSpotProviders providers) {
 89         super(runtime, providers);
 90         this.config = config;
 91     }
 92 
 93     @Override
 94     @SuppressWarnings(&quot;try&quot;)
 95     public void completeInitialization(HotSpotJVMCIRuntime jvmciRuntime, OptionValues options) {
 96         final HotSpotProviders providers = getProviders();
 97         HotSpotHostForeignCallsProvider foreignCalls = (HotSpotHostForeignCallsProvider) providers.getForeignCalls();
 98         final HotSpotLoweringProvider lowerer = (HotSpotLoweringProvider) providers.getLowerer();
 99 
100         try (InitTimer st = timer(&quot;foreignCalls.initialize&quot;)) {
</pre>
<hr />
<pre>
150             int bangOffset = bangEndSafe;
151             if (bangOffset &lt;= bangEnd) {
152                 crb.blockComment(&quot;[stack overflow check]&quot;);
153             }
154             while (bangOffset &lt;= bangEnd) {
155                 // Need at least one stack bang at end of shadow zone.
156                 bangStackWithOffset(crb, bangOffset);
157                 bangOffset += pageSize;
158             }
159         }
160     }
161 
162     protected abstract void bangStackWithOffset(CompilationResultBuilder crb, int bangOffset);
163 
164     @Override
165     public ReferenceMapBuilder newReferenceMapBuilder(int totalFrameSize) {
166         int uncompressedReferenceSize = getTarget().arch.getPlatformKind(JavaKind.Object).getSizeInBytes();
167         return new HotSpotReferenceMapBuilder(totalFrameSize, config.maxOopMapStackOffset, uncompressedReferenceSize);
168     }
169 
<span class="line-added">170     @Override</span>
<span class="line-added">171     public LIRGenerationResult newLIRGenerationResult(CompilationIdentifier compilationId, LIR lir, RegisterAllocationConfig registerAllocationConfig, StructuredGraph graph, Object stub) {</span>
<span class="line-added">172         return new HotSpotLIRGenerationResult(compilationId, lir, newFrameMapBuilder(registerAllocationConfig.getRegisterConfig()), registerAllocationConfig, makeCallingConvention(graph, (Stub) stub),</span>
<span class="line-added">173                         stub,</span>
<span class="line-added">174                         config.requiresReservedStackCheck(graph.getMethods()));</span>
<span class="line-added">175     }</span>
<span class="line-added">176 </span>
<span class="line-added">177     protected abstract FrameMapBuilder newFrameMapBuilder(RegisterConfig registerConfig);</span>
178 }
</pre>
</td>
</tr>
</table>
<center><a href="HotSpotGraalRuntimeProvider.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotLIRGenerationResult.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>