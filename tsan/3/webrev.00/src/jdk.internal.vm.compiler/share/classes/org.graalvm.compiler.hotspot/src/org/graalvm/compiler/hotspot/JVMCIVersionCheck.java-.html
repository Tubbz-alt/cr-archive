<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/JVMCIVersionCheck.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot;
 26 
 27 import java.util.Formatter;
 28 
 29 /**
 30  * Mechanism for checking that the current Java runtime environment supports the minimum JVMCI API
 31  * required by Graal. The {@code JVMCI_VERSION_CHECK} environment variable can be used to ignore a
 32  * failed check ({@code JVMCI_VERSION_CHECK=ignore}) or print a warning (
 33  * {@code JVMCI_VERSION_CHECK=warn}) and continue. Otherwise, a failed check results in an
 34  * {@link InternalError} being raised or, if called from {@link #main(String[])}, the VM exiting
 35  * with a result code of {@code -1}
 36  *
 37  * This class only depends on the JDK so that it can be used without building Graal.
 38  */
 39 class JVMCIVersionCheck {
 40 
 41     // 0.55 introduces new HotSpotSpeculationLog API
 42     private static final int JVMCI8_MIN_MAJOR_VERSION = 0;
 43     private static final int JVMCI8_MIN_MINOR_VERSION = 55;
 44 
 45     private static void failVersionCheck(boolean exit, String reason, Object... args) {
 46         Formatter errorMessage = new Formatter().format(reason, args);
 47         String javaHome = System.getProperty(&quot;java.home&quot;);
 48         String vmName = System.getProperty(&quot;java.vm.name&quot;);
 49         errorMessage.format(&quot;Set the JVMCI_VERSION_CHECK environment variable to \&quot;ignore\&quot; to suppress &quot;);
 50         errorMessage.format(&quot;this error or to \&quot;warn\&quot; to emit a warning and continue execution.%n&quot;);
 51         errorMessage.format(&quot;Currently used Java home directory is %s.%n&quot;, javaHome);
 52         errorMessage.format(&quot;Currently used VM configuration is: %s%n&quot;, vmName);
 53         if (System.getProperty(&quot;java.specification.version&quot;).compareTo(&quot;1.9&quot;) &lt; 0) {
 54             errorMessage.format(&quot;Download the latest JVMCI JDK 8 from http://www.oracle.com/technetwork/oracle-labs/program-languages/downloads/index.html&quot;);
 55         } else {
 56             errorMessage.format(&quot;Download JDK 11 or later.&quot;);
 57         }
 58         String value = System.getenv(&quot;JVMCI_VERSION_CHECK&quot;);
 59         if (&quot;warn&quot;.equals(value)) {
 60             System.err.println(errorMessage.toString());
 61         } else if (&quot;ignore&quot;.equals(value)) {
 62             return;
 63         } else if (exit) {
 64             System.err.println(errorMessage.toString());
 65             System.exit(-1);
 66         } else {
 67             throw new InternalError(errorMessage.toString());
 68         }
 69     }
 70 
 71     static void check(boolean exitOnFailure) {
 72         // Don&#39;t use regular expressions to minimize Graal startup time
 73         String javaSpecVersion = System.getProperty(&quot;java.specification.version&quot;);
 74         String vmVersion = System.getProperty(&quot;java.vm.version&quot;);
 75         if (javaSpecVersion.compareTo(&quot;1.9&quot;) &lt; 0) {
 76             int start = vmVersion.indexOf(&quot;-jvmci-&quot;);
 77             if (start &gt;= 0) {
 78                 start += &quot;-jvmci-&quot;.length();
 79                 int end = vmVersion.indexOf(&#39;.&#39;, start);
 80                 if (end &gt; 0) {
 81                     int major;
 82                     try {
 83                         major = Integer.parseInt(vmVersion.substring(start, end));
 84                     } catch (NumberFormatException e) {
 85                         failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal.%n&quot; +
 86                                         &quot;Cannot read JVMCI major version from java.vm.version property: %s.%n&quot;, vmVersion);
 87                         return;
 88                     }
 89                     start = end + 1;
 90                     end = start;
 91                     while (end &lt; vmVersion.length() &amp;&amp; Character.isDigit(vmVersion.charAt(end))) {
 92                         end++;
 93                     }
 94                     int minor;
 95                     try {
 96                         minor = Integer.parseInt(vmVersion.substring(start, end));
 97                     } catch (NumberFormatException e) {
 98                         failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal.%n&quot; +
 99                                         &quot;Cannot read JVMCI minor version from java.vm.version property: %s.%n&quot;, vmVersion);
100                         return;
101                     }
102                     if (major &gt;= JVMCI8_MIN_MAJOR_VERSION &amp;&amp; minor &gt;= JVMCI8_MIN_MINOR_VERSION) {
103                         return;
104                     }
105                     failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal: %d.%d &lt; %d.%d.%n&quot;,
106                                     major, minor, JVMCI8_MIN_MAJOR_VERSION, JVMCI8_MIN_MINOR_VERSION);
107                     return;
108                 }
109             }
110             failVersionCheck(exitOnFailure, &quot;The VM does not support the minimum JVMCI API version required by Graal.%n&quot; +
111                             &quot;Cannot read JVMCI version from java.vm.version property: %s.%n&quot;, vmVersion);
112         } else if (javaSpecVersion.compareTo(&quot;11&quot;) &lt; 0) {
113             failVersionCheck(exitOnFailure, &quot;Graal is not compatible with the JVMCI API in JDK 9 and 10.%n&quot;);
114         } else {
115             if (vmVersion.contains(&quot;SNAPSHOT&quot;)) {
116                 return;
117             }
118             if (vmVersion.contains(&quot;internal&quot;)) {
119                 // Allow local builds
120                 return;
121             }
122             if (vmVersion.startsWith(&quot;11-ea+&quot;)) {
123                 String buildString = vmVersion.substring(&quot;11-ea+&quot;.length());
124                 try {
125                     int build = Integer.parseInt(buildString);
126                     if (build &lt; 20) {
127                         failVersionCheck(exitOnFailure, &quot;Graal requires build 20 or later of JDK 11 early access binary, got build %d.%n&quot;, build);
128                         return;
129                     }
130                 } catch (NumberFormatException e) {
131                     failVersionCheck(exitOnFailure, &quot;Could not parse the JDK 11 early access build number from java.vm.version property: %s.%n&quot;, vmVersion);
132                     return;
133                 }
134             } else {
135                 // Graal is compatible with all JDK versions as of 11 GA.
136             }
137         }
138     }
139 
140     /**
141      * Command line interface for performing the check.
142      */
143     public static void main(String[] args) {
144         check(true);
145     }
146 }
    </pre>
  </body>
</html>