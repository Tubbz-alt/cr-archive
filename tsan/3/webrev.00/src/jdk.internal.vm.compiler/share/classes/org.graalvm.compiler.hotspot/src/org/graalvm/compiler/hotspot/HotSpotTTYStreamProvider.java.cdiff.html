<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotTTYStreamProvider.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotReplacementsImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IsGraalPredicate.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotTTYStreamProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 37,31 ***</span>
  import org.graalvm.compiler.core.common.SuppressFBWarnings;
  import org.graalvm.compiler.debug.TTYStreamProvider;
  import org.graalvm.compiler.options.Option;
  import org.graalvm.compiler.options.OptionKey;
  import org.graalvm.compiler.options.OptionType;
<span class="line-removed">- import org.graalvm.compiler.options.OptionValues;</span>
  import org.graalvm.compiler.serviceprovider.GraalServices;
  import org.graalvm.compiler.serviceprovider.ServiceProvider;
  
  import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
  
  @ServiceProvider(TTYStreamProvider.class)
  public class HotSpotTTYStreamProvider implements TTYStreamProvider {
  
      public static class Options {
  
          // @formatter:off
          @Option(help = &quot;File to which logging is sent.  A %p in the name will be replaced with a string identifying &quot; +
<span class="line-modified">!                        &quot;the process, usually the process id and %t will be replaced by System.currentTimeMillis().&quot;, type = OptionType.Expert)</span>
          public static final LogStreamOptionKey LogFile = new LogStreamOptionKey();
          // @formatter:on
      }
  
      @Override
      public PrintStream getStream() {
<span class="line-modified">!         return Options.LogFile.getStream(defaultOptions());</span>
      }
  
      /**
       * An option for a configurable file name that can also open a {@link PrintStream} on the file.
       * If no value is given for the option, the stream will output to HotSpot&#39;s
<span class="line-new-header">--- 37,33 ---</span>
  import org.graalvm.compiler.core.common.SuppressFBWarnings;
  import org.graalvm.compiler.debug.TTYStreamProvider;
  import org.graalvm.compiler.options.Option;
  import org.graalvm.compiler.options.OptionKey;
  import org.graalvm.compiler.options.OptionType;
  import org.graalvm.compiler.serviceprovider.GraalServices;
  import org.graalvm.compiler.serviceprovider.ServiceProvider;
  
<span class="line-added">+ import jdk.vm.ci.common.NativeImageReinitialize;</span>
  import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
<span class="line-added">+ import jdk.vm.ci.services.Services;</span>
  
  @ServiceProvider(TTYStreamProvider.class)
  public class HotSpotTTYStreamProvider implements TTYStreamProvider {
  
      public static class Options {
  
          // @formatter:off
          @Option(help = &quot;File to which logging is sent.  A %p in the name will be replaced with a string identifying &quot; +
<span class="line-modified">!                        &quot;the process, usually the process id and %t will be replaced by System.currentTimeMillis().  &quot; +</span>
<span class="line-added">+                        &quot;Using %o as filename sends logging to System.out whereas %e sends logging to System.err.&quot;, type = OptionType.Expert)</span>
          public static final LogStreamOptionKey LogFile = new LogStreamOptionKey();
          // @formatter:on
      }
  
      @Override
      public PrintStream getStream() {
<span class="line-modified">!         return Options.LogFile.getStream();</span>
      }
  
      /**
       * An option for a configurable file name that can also open a {@link PrintStream} on the file.
       * If no value is given for the option, the stream will output to HotSpot&#39;s
</pre>
<hr />
<pre>
<span class="line-old-header">*** 74,45 ***</span>
          }
  
          /**
           * @return {@code nameTemplate} with all instances of %p replaced by
           *         {@link GraalServices#getExecutionID()} and %t by
<span class="line-modified">!          *         {@link System#currentTimeMillis()}</span>
           */
          private static String makeFilename(String nameTemplate) {
              String name = nameTemplate;
              if (name.contains(&quot;%p&quot;)) {
                  name = name.replaceAll(&quot;%p&quot;, GraalServices.getExecutionID());
              }
              if (name.contains(&quot;%t&quot;)) {
                  name = name.replaceAll(&quot;%t&quot;, String.valueOf(System.currentTimeMillis()));
              }
              return name;
          }
  
          /**
           * An output stream that redirects to {@link HotSpotJVMCIRuntime#getLogStream()}. The
           * {@link HotSpotJVMCIRuntime#getLogStream()} value is only accessed the first time an IO
           * operation is performed on the stream. This is required to break a deadlock in early JVMCI
           * initialization.
           */
<span class="line-modified">!         static class DelayedOutputStream extends OutputStream {</span>
<span class="line-modified">!             private volatile OutputStream lazy;</span>
  
              private OutputStream lazy() {
                  if (lazy == null) {
                      synchronized (this) {
                          if (lazy == null) {
                              lazy = HotSpotJVMCIRuntime.runtime().getLogStream();
                              PrintStream ps = new PrintStream(lazy);
                              ps.printf(&quot;[Use -D%sLogFile=&lt;path&gt; to redirect Graal log output to a file.]%n&quot;, GRAAL_OPTION_PROPERTY_PREFIX);
                          }
                      }
                  }
                  return lazy;
              }
  
              @Override
              public void write(byte[] b, int off, int len) throws IOException {
                  lazy().write(b, off, len);
              }
  
<span class="line-new-header">--- 76,98 ---</span>
          }
  
          /**
           * @return {@code nameTemplate} with all instances of %p replaced by
           *         {@link GraalServices#getExecutionID()} and %t by
<span class="line-modified">!          *         {@link System#currentTimeMillis()}. Checks %o and %e are not combined with any</span>
<span class="line-added">+          *         other characters.</span>
           */
          private static String makeFilename(String nameTemplate) {
              String name = nameTemplate;
              if (name.contains(&quot;%p&quot;)) {
                  name = name.replaceAll(&quot;%p&quot;, GraalServices.getExecutionID());
              }
              if (name.contains(&quot;%t&quot;)) {
                  name = name.replaceAll(&quot;%t&quot;, String.valueOf(System.currentTimeMillis()));
              }
<span class="line-added">+ </span>
<span class="line-added">+             for (String subst : new String[]{&quot;%o&quot;, &quot;%e&quot;}) {</span>
<span class="line-added">+                 if (name.contains(subst) &amp;&amp; !name.equals(subst)) {</span>
<span class="line-added">+                     throw new IllegalArgumentException(&quot;LogFile substitution &quot; + subst + &quot; cannot be combined with any other characters&quot;);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+ </span>
              return name;
          }
  
          /**
           * An output stream that redirects to {@link HotSpotJVMCIRuntime#getLogStream()}. The
           * {@link HotSpotJVMCIRuntime#getLogStream()} value is only accessed the first time an IO
           * operation is performed on the stream. This is required to break a deadlock in early JVMCI
           * initialization.
           */
<span class="line-modified">!         class DelayedOutputStream extends OutputStream {</span>
<span class="line-modified">!             @NativeImageReinitialize private volatile OutputStream lazy;</span>
  
              private OutputStream lazy() {
                  if (lazy == null) {
                      synchronized (this) {
                          if (lazy == null) {
<span class="line-added">+                             String nameTemplate = LogStreamOptionKey.this.getValue(defaultOptions());</span>
<span class="line-added">+                             if (nameTemplate != null) {</span>
<span class="line-added">+                                 String name = makeFilename(nameTemplate);</span>
<span class="line-added">+                                 switch (name) {</span>
<span class="line-added">+                                     case &quot;%o&quot;:</span>
<span class="line-added">+                                         lazy = System.out;</span>
<span class="line-added">+                                         break;</span>
<span class="line-added">+                                     case &quot;%e&quot;:</span>
<span class="line-added">+                                         lazy = System.err;</span>
<span class="line-added">+                                         break;</span>
<span class="line-added">+                                     default:</span>
<span class="line-added">+                                         try {</span>
<span class="line-added">+                                             final boolean enableAutoflush = true;</span>
<span class="line-added">+                                             FileOutputStream result = new FileOutputStream(name);</span>
<span class="line-added">+                                             if (!Services.IS_IN_NATIVE_IMAGE) {</span>
<span class="line-added">+                                                 printVMConfig(enableAutoflush, result);</span>
<span class="line-added">+                                             } else {</span>
<span class="line-added">+                                                 // There are no VM arguments for the libgraal</span>
<span class="line-added">+                                                 // library.</span>
<span class="line-added">+                                             }</span>
<span class="line-added">+                                             lazy = result;</span>
<span class="line-added">+                                         } catch (FileNotFoundException e) {</span>
<span class="line-added">+                                             throw new RuntimeException(&quot;couldn&#39;t open file: &quot; + name, e);</span>
<span class="line-added">+                                         }</span>
<span class="line-added">+                                 }</span>
<span class="line-added">+                                 return lazy;</span>
<span class="line-added">+                             }</span>
<span class="line-added">+ </span>
                              lazy = HotSpotJVMCIRuntime.runtime().getLogStream();
                              PrintStream ps = new PrintStream(lazy);
                              ps.printf(&quot;[Use -D%sLogFile=&lt;path&gt; to redirect Graal log output to a file.]%n&quot;, GRAAL_OPTION_PROPERTY_PREFIX);
<span class="line-added">+                             ps.flush();</span>
                          }
                      }
                  }
                  return lazy;
              }
  
<span class="line-added">+             @SuppressFBWarnings(value = &quot;DLS_DEAD_LOCAL_STORE&quot;, justification = &quot;false positive on dead store to `ps`&quot;)</span>
<span class="line-added">+             private void printVMConfig(final boolean enableAutoflush, FileOutputStream result) {</span>
<span class="line-added">+                 /*</span>
<span class="line-added">+                  * Add the JVM and Java arguments to the log file to help identity it.</span>
<span class="line-added">+                  */</span>
<span class="line-added">+                 PrintStream ps = new PrintStream(result, enableAutoflush);</span>
<span class="line-added">+                 List&lt;String&gt; inputArguments = GraalServices.getInputArguments();</span>
<span class="line-added">+                 if (inputArguments != null) {</span>
<span class="line-added">+                     ps.println(&quot;VM Arguments: &quot; + String.join(&quot; &quot;, inputArguments));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 String cmd = Services.getSavedProperties().get(&quot;sun.java.command&quot;);</span>
<span class="line-added">+                 if (cmd != null) {</span>
<span class="line-added">+                     ps.println(&quot;sun.java.command=&quot; + cmd);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+ </span>
              @Override
              public void write(byte[] b, int off, int len) throws IOException {
                  lazy().write(b, off, len);
              }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 134,35 ***</span>
  
          /**
           * Gets the print stream configured by this option. If no file is configured, the print
           * stream will output to HotSpot&#39;s {@link HotSpotJVMCIRuntime#getLogStream() log} stream.
           */
<span class="line-modified">!         @SuppressFBWarnings(value = &quot;DLS_DEAD_LOCAL_STORE&quot;, justification = &quot;false positive on dead store to `ps`&quot;)</span>
<span class="line-modified">!         public PrintStream getStream(OptionValues options) {</span>
<span class="line-removed">-             String nameTemplate = getValue(options);</span>
<span class="line-removed">-             if (nameTemplate != null) {</span>
<span class="line-removed">-                 String name = makeFilename(nameTemplate);</span>
<span class="line-removed">-                 try {</span>
<span class="line-removed">-                     final boolean enableAutoflush = true;</span>
<span class="line-removed">-                     PrintStream ps = new PrintStream(new FileOutputStream(name), enableAutoflush);</span>
<span class="line-removed">-                     /*</span>
<span class="line-removed">-                      * Add the JVM and Java arguments to the log file to help identity it.</span>
<span class="line-removed">-                      */</span>
<span class="line-removed">-                     List&lt;String&gt; inputArguments = GraalServices.getInputArguments();</span>
<span class="line-removed">-                     if (inputArguments != null) {</span>
<span class="line-removed">-                         ps.println(&quot;VM Arguments: &quot; + String.join(&quot; &quot;, inputArguments));</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     String cmd = System.getProperty(&quot;sun.java.command&quot;);</span>
<span class="line-removed">-                     if (cmd != null) {</span>
<span class="line-removed">-                         ps.println(&quot;sun.java.command=&quot; + cmd);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     return ps;</span>
<span class="line-removed">-                 } catch (FileNotFoundException e) {</span>
<span class="line-removed">-                     throw new RuntimeException(&quot;couldn&#39;t open file: &quot; + name, e);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 return new PrintStream(new DelayedOutputStream());</span>
<span class="line-removed">-             }</span>
          }
      }
  
  }
<span class="line-new-header">--- 189,11 ---</span>
  
          /**
           * Gets the print stream configured by this option. If no file is configured, the print
           * stream will output to HotSpot&#39;s {@link HotSpotJVMCIRuntime#getLogStream() log} stream.
           */
<span class="line-modified">!         public PrintStream getStream() {</span>
<span class="line-modified">!             return new PrintStream(new DelayedOutputStream());</span>
          }
      }
  
  }
</pre>
<center><a href="HotSpotReplacementsImpl.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IsGraalPredicate.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>