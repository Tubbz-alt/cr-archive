<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/CompilationTask.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot;
 26 
 27 import static org.graalvm.compiler.core.CompilationWrapper.ExceptionAction.Diagnose;
 28 import static org.graalvm.compiler.core.CompilationWrapper.ExceptionAction.ExitVM;
<a name="2" id="anc2"></a><span class="line-modified"> 29 import static org.graalvm.compiler.core.GraalCompilerOptions.CompilationBailoutAction;</span>
 30 import static org.graalvm.compiler.core.GraalCompilerOptions.CompilationFailureAction;
 31 import static org.graalvm.compiler.core.phases.HighTier.Options.Inline;
 32 import static org.graalvm.compiler.java.BytecodeParserOptions.InlineDuringParsing;
 33 
 34 import java.io.PrintStream;
<a name="3" id="anc3"></a>
 35 import java.util.List;
 36 
 37 import jdk.internal.vm.compiler.collections.EconomicMap;
 38 import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
 39 import org.graalvm.compiler.code.CompilationResult;
 40 import org.graalvm.compiler.core.CompilationPrinter;
 41 import org.graalvm.compiler.core.CompilationWrapper;
 42 import org.graalvm.compiler.core.common.CompilationIdentifier;
<a name="4" id="anc4"></a><span class="line-removed"> 43 import org.graalvm.compiler.debug.Assertions;</span>
 44 import org.graalvm.compiler.debug.CounterKey;
 45 import org.graalvm.compiler.debug.DebugCloseable;
 46 import org.graalvm.compiler.debug.DebugContext;
<a name="5" id="anc5"></a>
 47 import org.graalvm.compiler.debug.DebugDumpScope;
<a name="6" id="anc6"></a><span class="line-modified"> 48 import org.graalvm.compiler.debug.GraalError;</span>
 49 import org.graalvm.compiler.debug.TimerKey;
<a name="7" id="anc7"></a><span class="line-removed"> 50 import org.graalvm.compiler.options.EnumOptionKey;</span>
 51 import org.graalvm.compiler.options.OptionKey;
 52 import org.graalvm.compiler.options.OptionValues;
 53 import org.graalvm.compiler.printer.GraalDebugHandlersFactory;
 54 
 55 import jdk.vm.ci.code.BailoutException;
 56 import jdk.vm.ci.code.CodeCacheProvider;
<a name="8" id="anc8"></a><span class="line-removed"> 57 import jdk.vm.ci.hotspot.EventProvider;</span>
 58 import jdk.vm.ci.hotspot.HotSpotCompilationRequest;
 59 import jdk.vm.ci.hotspot.HotSpotCompilationRequestResult;
 60 import jdk.vm.ci.hotspot.HotSpotInstalledCode;
<a name="9" id="anc9"></a><span class="line-removed"> 61 import jdk.vm.ci.hotspot.HotSpotJVMCICompilerFactory;</span>
 62 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
 63 import jdk.vm.ci.hotspot.HotSpotNmethod;
 64 import jdk.vm.ci.hotspot.HotSpotResolvedJavaMethod;
<a name="10" id="anc10"></a>
 65 import jdk.vm.ci.runtime.JVMCICompiler;
<a name="11" id="anc11"></a><span class="line-removed"> 66 import jdk.vm.ci.services.JVMCIServiceLocator;</span>
 67 
 68 public class CompilationTask {
 69 
<a name="12" id="anc12"></a><span class="line-removed"> 70     private static final EventProvider eventProvider;</span>
<span class="line-removed"> 71 </span>
<span class="line-removed"> 72     static {</span>
<span class="line-removed"> 73         List&lt;EventProvider&gt; providers = JVMCIServiceLocator.getProviders(EventProvider.class);</span>
<span class="line-removed"> 74         if (providers.size() &gt; 1) {</span>
<span class="line-removed"> 75             throw new GraalError(&quot;Multiple %s providers found: %s&quot;, EventProvider.class.getName(), providers);</span>
<span class="line-removed"> 76         } else if (providers.isEmpty()) {</span>
<span class="line-removed"> 77             eventProvider = EventProvider.createEmptyEventProvider();</span>
<span class="line-removed"> 78         } else {</span>
<span class="line-removed"> 79             eventProvider = providers.get(0);</span>
<span class="line-removed"> 80         }</span>
<span class="line-removed"> 81     }</span>
<span class="line-removed"> 82 </span>
 83     private final HotSpotJVMCIRuntime jvmciRuntime;
 84 
 85     private final HotSpotGraalCompiler compiler;
 86     private final HotSpotCompilationIdentifier compilationId;
 87 
 88     private HotSpotInstalledCode installedCode;
 89 
 90     /**
 91      * Specifies whether the compilation result is installed as the
 92      * {@linkplain HotSpotNmethod#isDefault() default} nmethod for the compiled method.
 93      */
 94     private final boolean installAsDefault;
 95 
 96     private final boolean useProfilingInfo;
<a name="13" id="anc13"></a><span class="line-modified"> 97     private final OptionValues options;</span>
 98 
 99     final class HotSpotCompilationWrapper extends CompilationWrapper&lt;HotSpotCompilationRequestResult&gt; {
<a name="14" id="anc14"></a><span class="line-removed">100         private final EventProvider.CompilationEvent compilationEvent;</span>
101         CompilationResult result;
102 
<a name="15" id="anc15"></a><span class="line-modified">103         HotSpotCompilationWrapper(EventProvider.CompilationEvent compilationEvent) {</span>
104             super(compiler.getGraalRuntime().getOutputDirectory(), compiler.getGraalRuntime().getCompilationProblemsPerAction());
<a name="16" id="anc16"></a><span class="line-removed">105             this.compilationEvent = compilationEvent;</span>
106         }
107 
108         @Override
<a name="17" id="anc17"></a><span class="line-modified">109         protected DebugContext createRetryDebugContext(OptionValues retryOptions, PrintStream logStream) {</span>
110             SnippetReflectionProvider snippetReflection = compiler.getGraalRuntime().getHostProviders().getSnippetReflection();
<a name="18" id="anc18"></a><span class="line-modified">111             return DebugContext.create(retryOptions, logStream, new GraalDebugHandlersFactory(snippetReflection));</span>







112         }
113 
114         @Override
115         public String toString() {
<a name="19" id="anc19"></a><span class="line-modified">116             return getMethod().format(&quot;%H.%n(%p)&quot;);</span>
117         }
118 
119         @Override
120         protected HotSpotCompilationRequestResult handleException(Throwable t) {
121             if (t instanceof BailoutException) {
122                 BailoutException bailout = (BailoutException) t;
123                 /*
124                  * Handling of permanent bailouts: Permanent bailouts that can happen for example
125                  * due to unsupported unstructured control flow in the bytecodes of a method must
126                  * not be retried. Hotspot compile broker will ensure that no recompilation at the
127                  * given tier will happen if retry is false.
128                  */
129                 return HotSpotCompilationRequestResult.failure(bailout.getMessage(), !bailout.isPermanent());
130             }
<a name="20" id="anc20"></a><span class="line-removed">131             // Log a failure event.</span>
<span class="line-removed">132             EventProvider.CompilerFailureEvent event = eventProvider.newCompilerFailureEvent();</span>
<span class="line-removed">133             if (event.shouldWrite()) {</span>
<span class="line-removed">134                 event.setCompileId(getId());</span>
<span class="line-removed">135                 event.setMessage(t.getMessage());</span>
<span class="line-removed">136                 event.commit();</span>
<span class="line-removed">137             }</span>
138 
139             /*
140              * Treat random exceptions from the compiler as indicating a problem compiling this
141              * method. Report the result of toString instead of getMessage to ensure that the
142              * exception type is included in the output in case there&#39;s no detail mesage.
143              */
144             return HotSpotCompilationRequestResult.failure(t.toString(), false);
145         }
146 
147         @Override
<a name="21" id="anc21"></a><span class="line-modified">148         protected ExceptionAction lookupAction(OptionValues values, EnumOptionKey&lt;ExceptionAction&gt; actionKey, Throwable cause) {</span>
<span class="line-modified">149             // Respect current action if it has been explicitly set.</span>
<span class="line-modified">150             if (!actionKey.hasBeenSet(values)) {</span>
<span class="line-modified">151                 if (actionKey == CompilationFailureAction) {</span>
<span class="line-modified">152                     // Automatically exit on non-bailout during bootstrap</span>
<span class="line-modified">153                     // or when assertions are enabled.</span>
<span class="line-modified">154                     if (Assertions.assertionsEnabled() || compiler.getGraalRuntime().isBootstrapping()) {</span>
<span class="line-modified">155                         return ExitVM;</span>
<span class="line-modified">156                     }</span>
<span class="line-modified">157                 } else if (actionKey == CompilationBailoutAction &amp;&amp; ((BailoutException) cause).isPermanent()) {</span>
<span class="line-modified">158                     // Get more info for permanent bailouts during bootstrap</span>
<span class="line-removed">159                     // or when assertions are enabled.</span>
<span class="line-removed">160                     assert CompilationBailoutAction.getDefaultValue() == ExceptionAction.Silent;</span>
<span class="line-removed">161                     if (Assertions.assertionsEnabled() || compiler.getGraalRuntime().isBootstrapping()) {</span>
<span class="line-removed">162                         return Diagnose;</span>
163                     }
164                 }
<a name="22" id="anc22"></a>










165             }
<a name="23" id="anc23"></a><span class="line-modified">166             return super.lookupAction(values, actionKey, cause);</span>
167         }
168 
169         @SuppressWarnings(&quot;try&quot;)
170         @Override
171         protected HotSpotCompilationRequestResult performCompilation(DebugContext debug) {
172             HotSpotResolvedJavaMethod method = getMethod();
173             int entryBCI = getEntryBCI();
174             final boolean isOSR = entryBCI != JVMCICompiler.INVOCATION_ENTRY_BCI;
<a name="24" id="anc24"></a><span class="line-modified">175             CompilationStatistics stats = CompilationStatistics.create(options, method, isOSR);</span>
176 
<a name="25" id="anc25"></a><span class="line-modified">177             final CompilationPrinter printer = CompilationPrinter.begin(options, compilationId, method, entryBCI);</span>
178 
179             try (DebugContext.Scope s = debug.scope(&quot;Compiling&quot;, new DebugDumpScope(getIdString(), true))) {
<a name="26" id="anc26"></a><span class="line-modified">180                 // Begin the compilation event.</span>
<span class="line-removed">181                 compilationEvent.begin();</span>
<span class="line-removed">182                 result = compiler.compile(method, entryBCI, useProfilingInfo, compilationId, options, debug);</span>
183             } catch (Throwable e) {
184                 throw debug.handle(e);
<a name="27" id="anc27"></a><span class="line-removed">185             } finally {</span>
<span class="line-removed">186                 // End the compilation event.</span>
<span class="line-removed">187                 compilationEvent.end();</span>
188             }
189 
190             if (result != null) {
191                 try (DebugCloseable b = CodeInstallationTime.start(debug)) {
192                     installMethod(debug, result);
193                 }
194                 // Installation is included in compilation time and memory usage reported by printer
195                 printer.finish(result);
196             }
197             stats.finish(method, installedCode);
198             if (result != null) {
<a name="28" id="anc28"></a><span class="line-modified">199                 return HotSpotCompilationRequestResult.success(result.getBytecodeSize() - method.getCodeSize());</span>






200             }
201             return null;
202         }
203 
204     }
205 
<a name="29" id="anc29"></a><span class="line-modified">206     public CompilationTask(HotSpotJVMCIRuntime jvmciRuntime, HotSpotGraalCompiler compiler, HotSpotCompilationRequest request, boolean useProfilingInfo, boolean installAsDefault,</span>
<span class="line-modified">207                     OptionValues options) {</span>












208         this.jvmciRuntime = jvmciRuntime;
209         this.compiler = compiler;
210         this.compilationId = new HotSpotCompilationIdentifier(request);
211         this.useProfilingInfo = useProfilingInfo;
<a name="30" id="anc30"></a>
212         this.installAsDefault = installAsDefault;
<a name="31" id="anc31"></a>
213 
<a name="32" id="anc32"></a>
214         /*
215          * Disable inlining if HotSpot has it disabled unless it&#39;s been explicitly set in Graal.
216          */
217         HotSpotGraalRuntimeProvider graalRuntime = compiler.getGraalRuntime();
218         GraalHotSpotVMConfig config = graalRuntime.getVMConfig();
219         OptionValues newOptions = options;
220         if (!config.inline) {
221             EconomicMap&lt;OptionKey&lt;?&gt;, Object&gt; m = OptionValues.newOptionMap();
222             if (Inline.getValue(options) &amp;&amp; !Inline.hasBeenSet(options)) {
223                 m.put(Inline, false);
224             }
225             if (InlineDuringParsing.getValue(options) &amp;&amp; !InlineDuringParsing.hasBeenSet(options)) {
226                 m.put(InlineDuringParsing, false);
227             }
228             if (!m.isEmpty()) {
229                 newOptions = new OptionValues(options, m);
230             }
231         }
<a name="33" id="anc33"></a><span class="line-modified">232         this.options = newOptions;</span>
233     }
234 
235     public HotSpotResolvedJavaMethod getMethod() {
236         return getRequest().getMethod();
237     }
238 
239     CompilationIdentifier getCompilationIdentifier() {
240         return compilationId;
241     }
242 
243     /**
244      * Returns the HotSpot id of this compilation.
245      *
246      * @return HotSpot compile id
247      */
248     public int getId() {
249         return getRequest().getId();
250     }
251 
252     public int getEntryBCI() {
253         return getRequest().getEntryBCI();
254     }
255 
256     /**
257      * @return the compilation id plus a trailing &#39;%&#39; if the compilation is an OSR to match
258      *         PrintCompilation style output
259      */
260     public String getIdString() {
261         if (getEntryBCI() != JVMCICompiler.INVOCATION_ENTRY_BCI) {
262             return getId() + &quot;%&quot;;
263         } else {
264             return Integer.toString(getId());
265         }
266     }
267 
268     public HotSpotInstalledCode getInstalledCode() {
269         return installedCode;
270     }
271 
272     /**
273      * Time spent in compilation.
274      */
<a name="34" id="anc34"></a><span class="line-modified">275     private static final TimerKey CompilationTime = DebugContext.timer(&quot;CompilationTime&quot;).doc(&quot;Time spent in compilation and code installation.&quot;);</span>
276 
277     /**
278      * Counts the number of compiled {@linkplain CompilationResult#getBytecodeSize() bytecodes}.
279      */
280     private static final CounterKey CompiledBytecodes = DebugContext.counter(&quot;CompiledBytecodes&quot;);
281 
282     /**
283      * Counts the number of compiled {@linkplain CompilationResult#getBytecodeSize() bytecodes} for
284      * which {@linkplain CompilationResult#getTargetCode()} code was installed.
285      */
<a name="35" id="anc35"></a><span class="line-modified">286     private static final CounterKey CompiledAndInstalledBytecodes = DebugContext.counter(&quot;CompiledAndInstalledBytecodes&quot;);</span>
287 
288     /**
289      * Counts the number of installed {@linkplain CompilationResult#getTargetCodeSize()} bytes.
290      */
291     private static final CounterKey InstalledCodeSize = DebugContext.counter(&quot;InstalledCodeSize&quot;);
292 
293     /**
294      * Time spent in code installation.
295      */
296     public static final TimerKey CodeInstallationTime = DebugContext.timer(&quot;CodeInstallation&quot;);
297 
<a name="36" id="anc36"></a><span class="line-modified">298     public HotSpotCompilationRequestResult runCompilation() {</span>
<span class="line-modified">299         SnippetReflectionProvider snippetReflection = compiler.getGraalRuntime().getHostProviders().getSnippetReflection();</span>
<span class="line-modified">300         try (DebugContext debug = DebugContext.create(options, new GraalDebugHandlersFactory(snippetReflection))) {</span>

301             return runCompilation(debug);
302         }
303     }
304 
305     @SuppressWarnings(&quot;try&quot;)
306     public HotSpotCompilationRequestResult runCompilation(DebugContext debug) {
307         HotSpotGraalRuntimeProvider graalRuntime = compiler.getGraalRuntime();
308         GraalHotSpotVMConfig config = graalRuntime.getVMConfig();
309         int entryBCI = getEntryBCI();
310         boolean isOSR = entryBCI != JVMCICompiler.INVOCATION_ENTRY_BCI;
311         HotSpotResolvedJavaMethod method = getMethod();
312 
<a name="37" id="anc37"></a><span class="line-modified">313         // Log a compilation event.</span>
<span class="line-removed">314         EventProvider.CompilationEvent compilationEvent = eventProvider.newCompilationEvent();</span>
<span class="line-removed">315 </span>
<span class="line-removed">316         if (installAsDefault) {</span>
317             // If there is already compiled code for this method on our level we simply return.
318             // JVMCI compiles are always at the highest compile level, even in non-tiered mode so we
319             // only need to check for that value.
320             if (method.hasCodeAtLevel(entryBCI, config.compilationLevelFullOptimization)) {
321                 return HotSpotCompilationRequestResult.failure(&quot;Already compiled&quot;, false);
322             }
<a name="38" id="anc38"></a><span class="line-modified">323             if (HotSpotGraalCompilerFactory.checkGraalCompileOnlyFilter(method.getDeclaringClass().toJavaName(), method.getName(), method.getSignature().toString(),</span>
<span class="line-removed">324                             HotSpotJVMCICompilerFactory.CompilationLevel.FullOptimization) != HotSpotJVMCICompilerFactory.CompilationLevel.FullOptimization) {</span>
325                 return HotSpotCompilationRequestResult.failure(&quot;GraalCompileOnly excluded&quot;, false);
326             }
327         }
328 
<a name="39" id="anc39"></a><span class="line-modified">329         HotSpotCompilationWrapper compilation = new HotSpotCompilationWrapper(compilationEvent);</span>
330         try (DebugCloseable a = CompilationTime.start(debug)) {
331             return compilation.run(debug);
332         } finally {
333             try {
334                 int compiledBytecodes = 0;
335                 int codeSize = 0;
336 
337                 if (compilation.result != null) {
338                     compiledBytecodes = compilation.result.getBytecodeSize();
339                     CompiledBytecodes.add(debug, compiledBytecodes);
340                     if (installedCode != null) {
341                         codeSize = installedCode.getSize();
342                         CompiledAndInstalledBytecodes.add(debug, compiledBytecodes);
343                         InstalledCodeSize.add(debug, codeSize);
344                     }
345                 }
<a name="40" id="anc40"></a><span class="line-removed">346 </span>
<span class="line-removed">347                 // Log a compilation event.</span>
<span class="line-removed">348                 if (compilationEvent.shouldWrite()) {</span>
<span class="line-removed">349                     compilationEvent.setMethod(method.format(&quot;%H.%n(%p)&quot;));</span>
<span class="line-removed">350                     compilationEvent.setCompileId(getId());</span>
<span class="line-removed">351                     compilationEvent.setCompileLevel(config.compilationLevelFullOptimization);</span>
<span class="line-removed">352                     compilationEvent.setSucceeded(compilation.result != null &amp;&amp; installedCode != null);</span>
<span class="line-removed">353                     compilationEvent.setIsOsr(isOSR);</span>
<span class="line-removed">354                     compilationEvent.setCodeSize(codeSize);</span>
<span class="line-removed">355                     compilationEvent.setInlinedBytes(compiledBytecodes);</span>
<span class="line-removed">356                     compilationEvent.commit();</span>
<span class="line-removed">357                 }</span>
358             } catch (Throwable t) {
359                 return compilation.handleException(t);
360             }
361         }
362     }
363 
364     @SuppressWarnings(&quot;try&quot;)
365     private void installMethod(DebugContext debug, final CompilationResult compResult) {
366         final CodeCacheProvider codeCache = jvmciRuntime.getHostJVMCIBackend().getCodeCache();
367         HotSpotBackend backend = compiler.getGraalRuntime().getHostBackend();
368         installedCode = null;
369         Object[] context = {new DebugDumpScope(getIdString(), true), codeCache, getMethod(), compResult};
370         try (DebugContext.Scope s = debug.scope(&quot;CodeInstall&quot;, context)) {
371             HotSpotCompilationRequest request = getRequest();
372             installedCode = (HotSpotInstalledCode) backend.createInstalledCode(debug,
373                             request.getMethod(),
374                             request,
375                             compResult,
376                             null,
377                             installAsDefault,
378                             context);
379         } catch (Throwable e) {
380             throw debug.handle(e);
381         }
382     }
383 
384     @Override
385     public String toString() {
386         return &quot;Compilation[id=&quot; + getId() + &quot;, &quot; + getMethod().format(&quot;%H.%n(%p)&quot;) + (getEntryBCI() == JVMCICompiler.INVOCATION_ENTRY_BCI ? &quot;&quot; : &quot;@&quot; + getEntryBCI()) + &quot;]&quot;;
387     }
388 
389     private HotSpotCompilationRequest getRequest() {
390         return compilationId.getRequest();
391     }
392 }
<a name="41" id="anc41"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="41" type="hidden" />
</body>
</html>