<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotGraalCompiler.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotForeignCallLinkageImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotGraalCompilerFactory.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotGraalCompiler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,20 +46,22 @@</span>
  import org.graalvm.compiler.hotspot.meta.HotSpotProviders;
  import org.graalvm.compiler.hotspot.phases.OnStackReplacementPhase;
  import org.graalvm.compiler.java.GraphBuilderPhase;
  import org.graalvm.compiler.lir.asm.CompilationResultBuilderFactory;
  import org.graalvm.compiler.lir.phases.LIRSuites;
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.Cancellable;</span>
  import org.graalvm.compiler.nodes.StructuredGraph;
  import org.graalvm.compiler.nodes.StructuredGraph.AllowAssumptions;
  import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration;
  import org.graalvm.compiler.options.OptionValues;
  import org.graalvm.compiler.phases.OptimisticOptimizations;
  import org.graalvm.compiler.phases.OptimisticOptimizations.Optimization;
  import org.graalvm.compiler.phases.PhaseSuite;
  import org.graalvm.compiler.phases.tiers.HighTierContext;
  import org.graalvm.compiler.phases.tiers.Suites;
  import org.graalvm.compiler.printer.GraalDebugHandlersFactory;
<span class="udiff-line-added">+ import org.graalvm.compiler.serviceprovider.GraalUnsafeAccess;</span>
  
  import jdk.vm.ci.code.CompilationRequest;
  import jdk.vm.ci.code.CompilationRequestResult;
  import jdk.vm.ci.hotspot.HotSpotCompilationRequest;
  import jdk.vm.ci.hotspot.HotSpotCompilationRequestResult;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -69,23 +71,25 @@</span>
  import jdk.vm.ci.meta.ProfilingInfo;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
  import jdk.vm.ci.meta.SpeculationLog;
  import jdk.vm.ci.meta.TriState;
  import jdk.vm.ci.runtime.JVMCICompiler;
<span class="udiff-line-added">+ import sun.misc.Unsafe;</span>
  
<span class="udiff-line-modified-removed">- public class HotSpotGraalCompiler implements GraalJVMCICompiler {</span>
<span class="udiff-line-modified-added">+ public class HotSpotGraalCompiler implements GraalJVMCICompiler, Cancellable {</span>
  
<span class="udiff-line-added">+     private static final Unsafe UNSAFE = GraalUnsafeAccess.getUnsafe();</span>
      private final HotSpotJVMCIRuntime jvmciRuntime;
      private final HotSpotGraalRuntimeProvider graalRuntime;
      private final CompilationCounters compilationCounters;
      private final BootstrapWatchDog bootstrapWatchDog;
      private List&lt;DebugHandlersFactory&gt; factories;
  
      HotSpotGraalCompiler(HotSpotJVMCIRuntime jvmciRuntime, HotSpotGraalRuntimeProvider graalRuntime, OptionValues options) {
          this.jvmciRuntime = jvmciRuntime;
          this.graalRuntime = graalRuntime;
<span class="udiff-line-modified-removed">-         // It is sufficient to have one compilation counter object per Graal compiler object.</span>
<span class="udiff-line-modified-added">+         // It is sufficient to have one compilation counter object per compiler object.</span>
          this.compilationCounters = Options.CompilationCountLimit.getValue(options) &gt; 0 ? new CompilationCounters(options) : null;
          this.bootstrapWatchDog = graalRuntime.isBootstrapping() &amp;&amp; !DebugOptions.BootstrapInitializeOnly.getValue(options) ? BootstrapWatchDog.maybeCreate(graalRuntime) : null;
      }
  
      public List&lt;DebugHandlersFactory&gt; getDebugHandlersFactories() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -104,66 +108,104 @@</span>
      public CompilationRequestResult compileMethod(CompilationRequest request) {
          return compileMethod(request, true, graalRuntime.getOptions());
      }
  
      @SuppressWarnings(&quot;try&quot;)
<span class="udiff-line-modified-removed">-     CompilationRequestResult compileMethod(CompilationRequest request, boolean installAsDefault, OptionValues options) {</span>
<span class="udiff-line-modified-removed">-         if (graalRuntime.isShutdown()) {</span>
<span class="udiff-line-modified-removed">-             return HotSpotCompilationRequestResult.failure(String.format(&quot;Shutdown entered&quot;), false);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     CompilationRequestResult compileMethod(CompilationRequest request, boolean installAsDefault, OptionValues initialOptions) {</span>
<span class="udiff-line-modified-added">+         try (CompilationContext scope = HotSpotGraalServices.openLocalCompilationContext(request)) {</span>
<span class="udiff-line-modified-added">+             if (graalRuntime.isShutdown()) {</span>
<span class="udiff-line-modified-added">+                 return HotSpotCompilationRequestResult.failure(String.format(&quot;Shutdown entered&quot;), true);</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         ResolvedJavaMethod method = request.getMethod();</span>
<span class="udiff-line-modified-added">+             ResolvedJavaMethod method = request.getMethod();</span>
  
<span class="udiff-line-modified-removed">-         if (graalRuntime.isBootstrapping()) {</span>
<span class="udiff-line-modified-removed">-             if (DebugOptions.BootstrapInitializeOnly.getValue(options)) {</span>
<span class="udiff-line-modified-removed">-                 return HotSpotCompilationRequestResult.failure(String.format(&quot;Skip compilation because %s is enabled&quot;, DebugOptions.BootstrapInitializeOnly.getName()), true);</span>
<span class="udiff-line-modified-added">+             if (graalRuntime.isBootstrapping()) {</span>
<span class="udiff-line-modified-added">+                 if (DebugOptions.BootstrapInitializeOnly.getValue(initialOptions)) {</span>
<span class="udiff-line-modified-added">+                     return HotSpotCompilationRequestResult.failure(String.format(&quot;Skip compilation because %s is enabled&quot;, DebugOptions.BootstrapInitializeOnly.getName()), true);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (bootstrapWatchDog != null) {</span>
<span class="udiff-line-added">+                     if (bootstrapWatchDog.hitCriticalCompilationRateOrTimeout()) {</span>
<span class="udiff-line-added">+                         // Drain the compilation queue to expedite completion of the bootstrap</span>
<span class="udiff-line-added">+                         return HotSpotCompilationRequestResult.failure(&quot;hit critical bootstrap compilation rate or timeout&quot;, true);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
              }
<span class="udiff-line-modified-removed">-             if (bootstrapWatchDog != null) {</span>
<span class="udiff-line-modified-removed">-                 if (bootstrapWatchDog.hitCriticalCompilationRateOrTimeout()) {</span>
<span class="udiff-line-modified-removed">-                     // Drain the compilation queue to expedite completion of the bootstrap</span>
<span class="udiff-line-modified-removed">-                     return HotSpotCompilationRequestResult.failure(&quot;hit critical bootstrap compilation rate or timeout&quot;, true);</span>
<span class="udiff-line-modified-added">+             HotSpotCompilationRequest hsRequest = (HotSpotCompilationRequest) request;</span>
<span class="udiff-line-modified-added">+             CompilationTask task = new CompilationTask(jvmciRuntime, this, hsRequest, true, shouldRetainLocalVariables(hsRequest.getJvmciEnv()), installAsDefault);</span>
<span class="udiff-line-modified-added">+             OptionValues options = task.filterOptions(initialOptions);</span>
<span class="udiff-line-modified-added">+             try (CompilationWatchDog w1 = CompilationWatchDog.watch(method, hsRequest.getId(), options);</span>
<span class="udiff-line-added">+                             BootstrapWatchDog.Watch w2 = bootstrapWatchDog == null ? null : bootstrapWatchDog.watch(request);</span>
<span class="udiff-line-added">+                             CompilationAlarm alarm = CompilationAlarm.trackCompilationPeriod(options);) {</span>
<span class="udiff-line-added">+                 if (compilationCounters != null) {</span>
<span class="udiff-line-added">+                     compilationCounters.countCompilation(method);</span>
                  }
<span class="udiff-line-added">+                 CompilationRequestResult r = null;</span>
<span class="udiff-line-added">+                 try (DebugContext debug = graalRuntime.openDebugContext(options, task.getCompilationIdentifier(), method, getDebugHandlersFactories(), DebugContext.DEFAULT_LOG_STREAM);</span>
<span class="udiff-line-added">+                                 Activation a = debug.activate()) {</span>
<span class="udiff-line-added">+                     r = task.runCompilation(debug);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 assert r != null;</span>
<span class="udiff-line-added">+                 return r;</span>
              }
          }
<span class="udiff-line-modified-removed">-         HotSpotCompilationRequest hsRequest = (HotSpotCompilationRequest) request;</span>
<span class="udiff-line-modified-removed">-         try (CompilationWatchDog w1 = CompilationWatchDog.watch(method, hsRequest.getId(), options);</span>
<span class="udiff-line-modified-removed">-                         BootstrapWatchDog.Watch w2 = bootstrapWatchDog == null ? null : bootstrapWatchDog.watch(request);</span>
<span class="udiff-line-modified-removed">-                         CompilationAlarm alarm = CompilationAlarm.trackCompilationPeriod(options);) {</span>
<span class="udiff-line-modified-removed">-             if (compilationCounters != null) {</span>
<span class="udiff-line-modified-removed">-                 compilationCounters.countCompilation(method);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     private boolean shouldRetainLocalVariables(long envAddress) {</span>
<span class="udiff-line-modified-added">+         GraalHotSpotVMConfig config = graalRuntime.getVMConfig();</span>
<span class="udiff-line-modified-added">+         if (envAddress == 0) {</span>
<span class="udiff-line-modified-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (config.jvmciCompileStateCanPopFrameOffset != Integer.MIN_VALUE) {</span>
<span class="udiff-line-added">+             if ((UNSAFE.getByte(envAddress + config.jvmciCompileStateCanPopFrameOffset) &amp; 0xFF) != 0) {</span>
<span class="udiff-line-added">+                 return true;</span>
              }
<span class="udiff-line-modified-removed">-             CompilationTask task = new CompilationTask(jvmciRuntime, this, hsRequest, true, installAsDefault, options);</span>
<span class="udiff-line-modified-removed">-             CompilationRequestResult r = null;</span>
<span class="udiff-line-modified-removed">-             try (DebugContext debug = graalRuntime.openDebugContext(options, task.getCompilationIdentifier(), method, getDebugHandlersFactories(), DebugContext.DEFAULT_LOG_STREAM);</span>
<span class="udiff-line-modified-removed">-                             Activation a = debug.activate()) {</span>
<span class="udiff-line-removed">-                 r = task.runCompilation(debug);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         if (config.jvmciCompileStateCanAccessLocalVariablesOffset != Integer.MIN_VALUE) {</span>
<span class="udiff-line-modified-added">+             if ((UNSAFE.getByte(envAddress + config.jvmciCompileStateCanAccessLocalVariablesOffset) &amp; 0xFF) != 0) {</span>
<span class="udiff-line-modified-added">+                 return true;</span>
              }
<span class="udiff-line-removed">-             assert r != null;</span>
<span class="udiff-line-removed">-             return r;</span>
          }
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public boolean isCancelled() {</span>
<span class="udiff-line-added">+         return graalRuntime.isShutdown();</span>
      }
  
      public StructuredGraph createGraph(ResolvedJavaMethod method, int entryBCI, boolean useProfilingInfo, CompilationIdentifier compilationId, OptionValues options, DebugContext debug) {
          HotSpotBackend backend = graalRuntime.getHostBackend();
          HotSpotProviders providers = backend.getProviders();
          final boolean isOSR = entryBCI != JVMCICompiler.INVOCATION_ENTRY_BCI;
<span class="udiff-line-modified-removed">-         StructuredGraph graph = method.isNative() || isOSR ? null : providers.getReplacements().getIntrinsicGraph(method, compilationId, debug);</span>
<span class="udiff-line-modified-added">+         StructuredGraph graph = method.isNative() || isOSR ? null : providers.getReplacements().getIntrinsicGraph(method, compilationId, debug, this);</span>
  
          if (graph == null) {
              SpeculationLog speculationLog = method.getSpeculationLog();
              if (speculationLog != null) {
                  speculationLog.collectFailedSpeculations();
              }
<span class="udiff-line-modified-removed">-             graph = new StructuredGraph.Builder(options, debug, AllowAssumptions.ifTrue(OptAssumptions.getValue(options))).method(method).entryBCI(entryBCI).speculationLog(</span>
<span class="udiff-line-modified-removed">-                             speculationLog).useProfilingInfo(useProfilingInfo).compilationId(compilationId).build();</span>
<span class="udiff-line-modified-added">+             // @formatter:off</span>
<span class="udiff-line-modified-added">+             graph = new StructuredGraph.Builder(options, debug, AllowAssumptions.ifTrue(OptAssumptions.getValue(options))).</span>
<span class="udiff-line-added">+                             method(method).</span>
<span class="udiff-line-added">+                             cancellable(this).</span>
<span class="udiff-line-added">+                             entryBCI(entryBCI).</span>
<span class="udiff-line-added">+                             speculationLog(speculationLog).</span>
<span class="udiff-line-added">+                             useProfilingInfo(useProfilingInfo).</span>
<span class="udiff-line-added">+                             compilationId(compilationId).build();</span>
<span class="udiff-line-added">+             // @formatter:on</span>
          }
          return graph;
      }
  
      public CompilationResult compileHelper(CompilationResultBuilderFactory crbf, CompilationResult result, StructuredGraph graph, ResolvedJavaMethod method, int entryBCI, boolean useProfilingInfo,
                      OptionValues options) {
<span class="udiff-line-added">+         return compileHelper(crbf, result, graph, method, entryBCI, useProfilingInfo, false, options);</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-added">+     public CompilationResult compileHelper(CompilationResultBuilderFactory crbf, CompilationResult result, StructuredGraph graph, ResolvedJavaMethod method, int entryBCI, boolean useProfilingInfo,</span>
<span class="udiff-line-added">+                     boolean shouldRetainLocalVariables, OptionValues options) {</span>
<span class="udiff-line-added">+         assert options == graph.getOptions();</span>
          HotSpotBackend backend = graalRuntime.getHostBackend();
          HotSpotProviders providers = backend.getProviders();
          final boolean isOSR = entryBCI != JVMCICompiler.INVOCATION_ENTRY_BCI;
  
          Suites suites = getSuites(providers, options);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -179,25 +221,30 @@</span>
              optimisticOpts.remove(Optimization.RemoveNeverExecutedCode);
          }
  
          result.setEntryBCI(entryBCI);
          boolean shouldDebugNonSafepoints = providers.getCodeCache().shouldDebugNonSafepoints();
<span class="udiff-line-modified-removed">-         PhaseSuite&lt;HighTierContext&gt; graphBuilderSuite = configGraphBuilderSuite(providers.getSuites().getDefaultGraphBuilderSuite(), shouldDebugNonSafepoints, isOSR);</span>
<span class="udiff-line-modified-added">+         PhaseSuite&lt;HighTierContext&gt; graphBuilderSuite = configGraphBuilderSuite(providers.getSuites().getDefaultGraphBuilderSuite(), shouldDebugNonSafepoints, shouldRetainLocalVariables, isOSR);</span>
          GraalCompiler.compileGraph(graph, method, providers, backend, graphBuilderSuite, optimisticOpts, profilingInfo, suites, lirSuites, result, crbf, true);
  
          if (!isOSR &amp;&amp; useProfilingInfo) {
              ProfilingInfo profile = profilingInfo;
              profile.setCompilerIRSize(StructuredGraph.class, graph.getNodeCount());
          }
  
          return result;
      }
  
<span class="udiff-line-modified-removed">-     public CompilationResult compile(ResolvedJavaMethod method, int entryBCI, boolean useProfilingInfo, CompilationIdentifier compilationId, OptionValues options, DebugContext debug) {</span>
<span class="udiff-line-modified-removed">-         StructuredGraph graph = createGraph(method, entryBCI, useProfilingInfo, compilationId, options, debug);</span>
<span class="udiff-line-modified-added">+     public CompilationResult compile(ResolvedJavaMethod method,</span>
<span class="udiff-line-modified-added">+                     int entryBCI,</span>
<span class="udiff-line-added">+                     boolean useProfilingInfo,</span>
<span class="udiff-line-added">+                     boolean shouldRetainLocalVariables,</span>
<span class="udiff-line-added">+                     CompilationIdentifier compilationId,</span>
<span class="udiff-line-added">+                     DebugContext debug) {</span>
<span class="udiff-line-added">+         StructuredGraph graph = createGraph(method, entryBCI, useProfilingInfo, compilationId, debug.getOptions(), debug);</span>
          CompilationResult result = new CompilationResult(compilationId);
<span class="udiff-line-modified-removed">-         return compileHelper(CompilationResultBuilderFactory.Default, result, graph, method, entryBCI, useProfilingInfo, options);</span>
<span class="udiff-line-modified-added">+         return compileHelper(CompilationResultBuilderFactory.Default, result, graph, method, entryBCI, useProfilingInfo, shouldRetainLocalVariables, debug.getOptions());</span>
      }
  
      protected OptimisticOptimizations getOptimisticOpts(ProfilingInfo profilingInfo, OptionValues options) {
          return new OptimisticOptimizations(profilingInfo, options);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -215,31 +262,30 @@</span>
       * not the default.
       *
       * @param suite the graph builder suite
       * @param shouldDebugNonSafepoints specifies if extra debug info should be generated (default is
       *            false)
<span class="udiff-line-added">+      * @param shouldRetainLocalVariables specifies if local variables should be retained for</span>
<span class="udiff-line-added">+      *            debugging purposes (default is false)</span>
       * @param isOSR specifies if extra OSR-specific post-processing is required (default is false)
       * @return a new suite derived from {@code suite} if any of the GBS parameters did not have a
       *         default value otherwise {@code suite}
       */
<span class="udiff-line-modified-removed">-     protected PhaseSuite&lt;HighTierContext&gt; configGraphBuilderSuite(PhaseSuite&lt;HighTierContext&gt; suite, boolean shouldDebugNonSafepoints, boolean isOSR) {</span>
<span class="udiff-line-modified-removed">-         if (shouldDebugNonSafepoints || isOSR) {</span>
<span class="udiff-line-modified-added">+     protected PhaseSuite&lt;HighTierContext&gt; configGraphBuilderSuite(PhaseSuite&lt;HighTierContext&gt; suite, boolean shouldDebugNonSafepoints, boolean shouldRetainLocalVariables, boolean isOSR) {</span>
<span class="udiff-line-modified-added">+         if (shouldDebugNonSafepoints || shouldRetainLocalVariables || isOSR) {</span>
              PhaseSuite&lt;HighTierContext&gt; newGbs = suite.copy();
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-added">+             GraphBuilderPhase graphBuilderPhase = (GraphBuilderPhase) newGbs.findPhase(GraphBuilderPhase.class).previous();</span>
<span class="udiff-line-added">+             GraphBuilderConfiguration graphBuilderConfig = graphBuilderPhase.getGraphBuilderConfig();</span>
              if (shouldDebugNonSafepoints) {
<span class="udiff-line-removed">-                 GraphBuilderPhase graphBuilderPhase = (GraphBuilderPhase) newGbs.findPhase(GraphBuilderPhase.class).previous();</span>
<span class="udiff-line-removed">-                 GraphBuilderConfiguration graphBuilderConfig = graphBuilderPhase.getGraphBuilderConfig();</span>
                  graphBuilderConfig = graphBuilderConfig.withNodeSourcePosition(true);
<span class="udiff-line-removed">-                 GraphBuilderPhase newGraphBuilderPhase = new GraphBuilderPhase(graphBuilderConfig);</span>
<span class="udiff-line-removed">-                 newGbs.findPhase(GraphBuilderPhase.class).set(newGraphBuilderPhase);</span>
              }
<span class="udiff-line-added">+             if (shouldRetainLocalVariables) {</span>
<span class="udiff-line-added">+                 graphBuilderConfig = graphBuilderConfig.withRetainLocalVariables(true);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             GraphBuilderPhase newGraphBuilderPhase = new GraphBuilderPhase(graphBuilderConfig);</span>
<span class="udiff-line-added">+             newGbs.findPhase(GraphBuilderPhase.class).set(newGraphBuilderPhase);</span>
              if (isOSR) {
<span class="udiff-line-removed">-                 // We must not clear non liveness for OSR compilations.</span>
<span class="udiff-line-removed">-                 GraphBuilderPhase graphBuilderPhase = (GraphBuilderPhase) newGbs.findPhase(GraphBuilderPhase.class).previous();</span>
<span class="udiff-line-removed">-                 GraphBuilderConfiguration graphBuilderConfig = graphBuilderPhase.getGraphBuilderConfig();</span>
<span class="udiff-line-removed">-                 GraphBuilderPhase newGraphBuilderPhase = new GraphBuilderPhase(graphBuilderConfig);</span>
<span class="udiff-line-removed">-                 newGbs.findPhase(GraphBuilderPhase.class).set(newGraphBuilderPhase);</span>
                  newGbs.appendPhase(new OnStackReplacementPhase());
              }
              return newGbs;
          }
          return suite;
</pre>
<center><a href="HotSpotForeignCallLinkageImpl.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="HotSpotGraalCompilerFactory.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>