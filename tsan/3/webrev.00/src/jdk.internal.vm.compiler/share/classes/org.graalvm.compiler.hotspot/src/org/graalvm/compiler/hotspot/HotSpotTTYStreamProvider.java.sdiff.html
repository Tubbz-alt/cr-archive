<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotTTYStreamProvider.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotReplacementsImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IsGraalPredicate.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/HotSpotTTYStreamProvider.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot;
 26 
 27 import static org.graalvm.compiler.hotspot.HotSpotGraalOptionValues.GRAAL_OPTION_PROPERTY_PREFIX;
 28 import static org.graalvm.compiler.hotspot.HotSpotGraalOptionValues.defaultOptions;
 29 
 30 import java.io.FileNotFoundException;
 31 import java.io.FileOutputStream;
 32 import java.io.IOException;
 33 import java.io.OutputStream;
 34 import java.io.PrintStream;
 35 import java.util.List;
 36 
 37 import org.graalvm.compiler.core.common.SuppressFBWarnings;
 38 import org.graalvm.compiler.debug.TTYStreamProvider;
 39 import org.graalvm.compiler.options.Option;
 40 import org.graalvm.compiler.options.OptionKey;
 41 import org.graalvm.compiler.options.OptionType;
<span class="line-removed"> 42 import org.graalvm.compiler.options.OptionValues;</span>
 43 import org.graalvm.compiler.serviceprovider.GraalServices;
 44 import org.graalvm.compiler.serviceprovider.ServiceProvider;
 45 

 46 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;

 47 
 48 @ServiceProvider(TTYStreamProvider.class)
 49 public class HotSpotTTYStreamProvider implements TTYStreamProvider {
 50 
 51     public static class Options {
 52 
 53         // @formatter:off
 54         @Option(help = &quot;File to which logging is sent.  A %p in the name will be replaced with a string identifying &quot; +
<span class="line-modified"> 55                        &quot;the process, usually the process id and %t will be replaced by System.currentTimeMillis().&quot;, type = OptionType.Expert)</span>

 56         public static final LogStreamOptionKey LogFile = new LogStreamOptionKey();
 57         // @formatter:on
 58     }
 59 
 60     @Override
 61     public PrintStream getStream() {
<span class="line-modified"> 62         return Options.LogFile.getStream(defaultOptions());</span>
 63     }
 64 
 65     /**
 66      * An option for a configurable file name that can also open a {@link PrintStream} on the file.
 67      * If no value is given for the option, the stream will output to HotSpot&#39;s
 68      * {@link HotSpotJVMCIRuntime#getLogStream() log} stream
 69      */
 70     private static class LogStreamOptionKey extends OptionKey&lt;String&gt; {
 71 
 72         LogStreamOptionKey() {
 73             super(null);
 74         }
 75 
 76         /**
 77          * @return {@code nameTemplate} with all instances of %p replaced by
 78          *         {@link GraalServices#getExecutionID()} and %t by
<span class="line-modified"> 79          *         {@link System#currentTimeMillis()}</span>

 80          */
 81         private static String makeFilename(String nameTemplate) {
 82             String name = nameTemplate;
 83             if (name.contains(&quot;%p&quot;)) {
 84                 name = name.replaceAll(&quot;%p&quot;, GraalServices.getExecutionID());
 85             }
 86             if (name.contains(&quot;%t&quot;)) {
 87                 name = name.replaceAll(&quot;%t&quot;, String.valueOf(System.currentTimeMillis()));
 88             }







 89             return name;
 90         }
 91 
 92         /**
 93          * An output stream that redirects to {@link HotSpotJVMCIRuntime#getLogStream()}. The
 94          * {@link HotSpotJVMCIRuntime#getLogStream()} value is only accessed the first time an IO
 95          * operation is performed on the stream. This is required to break a deadlock in early JVMCI
 96          * initialization.
 97          */
<span class="line-modified"> 98         static class DelayedOutputStream extends OutputStream {</span>
<span class="line-modified"> 99             private volatile OutputStream lazy;</span>
100 
101             private OutputStream lazy() {
102                 if (lazy == null) {
103                     synchronized (this) {
104                         if (lazy == null) {




























105                             lazy = HotSpotJVMCIRuntime.runtime().getLogStream();
106                             PrintStream ps = new PrintStream(lazy);
107                             ps.printf(&quot;[Use -D%sLogFile=&lt;path&gt; to redirect Graal log output to a file.]%n&quot;, GRAAL_OPTION_PROPERTY_PREFIX);

108                         }
109                     }
110                 }
111                 return lazy;
112             }
113 
















114             @Override
115             public void write(byte[] b, int off, int len) throws IOException {
116                 lazy().write(b, off, len);
117             }
118 
119             @Override
120             public void write(int b) throws IOException {
121                 lazy().write(b);
122             }
123 
124             @Override
125             public void flush() throws IOException {
126                 lazy().flush();
127             }
128 
129             @Override
130             public void close() throws IOException {
131                 lazy().close();
132             }
133         }
134 
135         /**
136          * Gets the print stream configured by this option. If no file is configured, the print
137          * stream will output to HotSpot&#39;s {@link HotSpotJVMCIRuntime#getLogStream() log} stream.
138          */
<span class="line-modified">139         @SuppressFBWarnings(value = &quot;DLS_DEAD_LOCAL_STORE&quot;, justification = &quot;false positive on dead store to `ps`&quot;)</span>
<span class="line-modified">140         public PrintStream getStream(OptionValues options) {</span>
<span class="line-removed">141             String nameTemplate = getValue(options);</span>
<span class="line-removed">142             if (nameTemplate != null) {</span>
<span class="line-removed">143                 String name = makeFilename(nameTemplate);</span>
<span class="line-removed">144                 try {</span>
<span class="line-removed">145                     final boolean enableAutoflush = true;</span>
<span class="line-removed">146                     PrintStream ps = new PrintStream(new FileOutputStream(name), enableAutoflush);</span>
<span class="line-removed">147                     /*</span>
<span class="line-removed">148                      * Add the JVM and Java arguments to the log file to help identity it.</span>
<span class="line-removed">149                      */</span>
<span class="line-removed">150                     List&lt;String&gt; inputArguments = GraalServices.getInputArguments();</span>
<span class="line-removed">151                     if (inputArguments != null) {</span>
<span class="line-removed">152                         ps.println(&quot;VM Arguments: &quot; + String.join(&quot; &quot;, inputArguments));</span>
<span class="line-removed">153                     }</span>
<span class="line-removed">154                     String cmd = System.getProperty(&quot;sun.java.command&quot;);</span>
<span class="line-removed">155                     if (cmd != null) {</span>
<span class="line-removed">156                         ps.println(&quot;sun.java.command=&quot; + cmd);</span>
<span class="line-removed">157                     }</span>
<span class="line-removed">158                     return ps;</span>
<span class="line-removed">159                 } catch (FileNotFoundException e) {</span>
<span class="line-removed">160                     throw new RuntimeException(&quot;couldn&#39;t open file: &quot; + name, e);</span>
<span class="line-removed">161                 }</span>
<span class="line-removed">162             } else {</span>
<span class="line-removed">163                 return new PrintStream(new DelayedOutputStream());</span>
<span class="line-removed">164             }</span>
165         }
166     }
167 
168 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot;
 26 
 27 import static org.graalvm.compiler.hotspot.HotSpotGraalOptionValues.GRAAL_OPTION_PROPERTY_PREFIX;
 28 import static org.graalvm.compiler.hotspot.HotSpotGraalOptionValues.defaultOptions;
 29 
 30 import java.io.FileNotFoundException;
 31 import java.io.FileOutputStream;
 32 import java.io.IOException;
 33 import java.io.OutputStream;
 34 import java.io.PrintStream;
 35 import java.util.List;
 36 
 37 import org.graalvm.compiler.core.common.SuppressFBWarnings;
 38 import org.graalvm.compiler.debug.TTYStreamProvider;
 39 import org.graalvm.compiler.options.Option;
 40 import org.graalvm.compiler.options.OptionKey;
 41 import org.graalvm.compiler.options.OptionType;

 42 import org.graalvm.compiler.serviceprovider.GraalServices;
 43 import org.graalvm.compiler.serviceprovider.ServiceProvider;
 44 
<span class="line-added"> 45 import jdk.vm.ci.common.NativeImageReinitialize;</span>
 46 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
<span class="line-added"> 47 import jdk.vm.ci.services.Services;</span>
 48 
 49 @ServiceProvider(TTYStreamProvider.class)
 50 public class HotSpotTTYStreamProvider implements TTYStreamProvider {
 51 
 52     public static class Options {
 53 
 54         // @formatter:off
 55         @Option(help = &quot;File to which logging is sent.  A %p in the name will be replaced with a string identifying &quot; +
<span class="line-modified"> 56                        &quot;the process, usually the process id and %t will be replaced by System.currentTimeMillis().  &quot; +</span>
<span class="line-added"> 57                        &quot;Using %o as filename sends logging to System.out whereas %e sends logging to System.err.&quot;, type = OptionType.Expert)</span>
 58         public static final LogStreamOptionKey LogFile = new LogStreamOptionKey();
 59         // @formatter:on
 60     }
 61 
 62     @Override
 63     public PrintStream getStream() {
<span class="line-modified"> 64         return Options.LogFile.getStream();</span>
 65     }
 66 
 67     /**
 68      * An option for a configurable file name that can also open a {@link PrintStream} on the file.
 69      * If no value is given for the option, the stream will output to HotSpot&#39;s
 70      * {@link HotSpotJVMCIRuntime#getLogStream() log} stream
 71      */
 72     private static class LogStreamOptionKey extends OptionKey&lt;String&gt; {
 73 
 74         LogStreamOptionKey() {
 75             super(null);
 76         }
 77 
 78         /**
 79          * @return {@code nameTemplate} with all instances of %p replaced by
 80          *         {@link GraalServices#getExecutionID()} and %t by
<span class="line-modified"> 81          *         {@link System#currentTimeMillis()}. Checks %o and %e are not combined with any</span>
<span class="line-added"> 82          *         other characters.</span>
 83          */
 84         private static String makeFilename(String nameTemplate) {
 85             String name = nameTemplate;
 86             if (name.contains(&quot;%p&quot;)) {
 87                 name = name.replaceAll(&quot;%p&quot;, GraalServices.getExecutionID());
 88             }
 89             if (name.contains(&quot;%t&quot;)) {
 90                 name = name.replaceAll(&quot;%t&quot;, String.valueOf(System.currentTimeMillis()));
 91             }
<span class="line-added"> 92 </span>
<span class="line-added"> 93             for (String subst : new String[]{&quot;%o&quot;, &quot;%e&quot;}) {</span>
<span class="line-added"> 94                 if (name.contains(subst) &amp;&amp; !name.equals(subst)) {</span>
<span class="line-added"> 95                     throw new IllegalArgumentException(&quot;LogFile substitution &quot; + subst + &quot; cannot be combined with any other characters&quot;);</span>
<span class="line-added"> 96                 }</span>
<span class="line-added"> 97             }</span>
<span class="line-added"> 98 </span>
 99             return name;
100         }
101 
102         /**
103          * An output stream that redirects to {@link HotSpotJVMCIRuntime#getLogStream()}. The
104          * {@link HotSpotJVMCIRuntime#getLogStream()} value is only accessed the first time an IO
105          * operation is performed on the stream. This is required to break a deadlock in early JVMCI
106          * initialization.
107          */
<span class="line-modified">108         class DelayedOutputStream extends OutputStream {</span>
<span class="line-modified">109             @NativeImageReinitialize private volatile OutputStream lazy;</span>
110 
111             private OutputStream lazy() {
112                 if (lazy == null) {
113                     synchronized (this) {
114                         if (lazy == null) {
<span class="line-added">115                             String nameTemplate = LogStreamOptionKey.this.getValue(defaultOptions());</span>
<span class="line-added">116                             if (nameTemplate != null) {</span>
<span class="line-added">117                                 String name = makeFilename(nameTemplate);</span>
<span class="line-added">118                                 switch (name) {</span>
<span class="line-added">119                                     case &quot;%o&quot;:</span>
<span class="line-added">120                                         lazy = System.out;</span>
<span class="line-added">121                                         break;</span>
<span class="line-added">122                                     case &quot;%e&quot;:</span>
<span class="line-added">123                                         lazy = System.err;</span>
<span class="line-added">124                                         break;</span>
<span class="line-added">125                                     default:</span>
<span class="line-added">126                                         try {</span>
<span class="line-added">127                                             final boolean enableAutoflush = true;</span>
<span class="line-added">128                                             FileOutputStream result = new FileOutputStream(name);</span>
<span class="line-added">129                                             if (!Services.IS_IN_NATIVE_IMAGE) {</span>
<span class="line-added">130                                                 printVMConfig(enableAutoflush, result);</span>
<span class="line-added">131                                             } else {</span>
<span class="line-added">132                                                 // There are no VM arguments for the libgraal</span>
<span class="line-added">133                                                 // library.</span>
<span class="line-added">134                                             }</span>
<span class="line-added">135                                             lazy = result;</span>
<span class="line-added">136                                         } catch (FileNotFoundException e) {</span>
<span class="line-added">137                                             throw new RuntimeException(&quot;couldn&#39;t open file: &quot; + name, e);</span>
<span class="line-added">138                                         }</span>
<span class="line-added">139                                 }</span>
<span class="line-added">140                                 return lazy;</span>
<span class="line-added">141                             }</span>
<span class="line-added">142 </span>
143                             lazy = HotSpotJVMCIRuntime.runtime().getLogStream();
144                             PrintStream ps = new PrintStream(lazy);
145                             ps.printf(&quot;[Use -D%sLogFile=&lt;path&gt; to redirect Graal log output to a file.]%n&quot;, GRAAL_OPTION_PROPERTY_PREFIX);
<span class="line-added">146                             ps.flush();</span>
147                         }
148                     }
149                 }
150                 return lazy;
151             }
152 
<span class="line-added">153             @SuppressFBWarnings(value = &quot;DLS_DEAD_LOCAL_STORE&quot;, justification = &quot;false positive on dead store to `ps`&quot;)</span>
<span class="line-added">154             private void printVMConfig(final boolean enableAutoflush, FileOutputStream result) {</span>
<span class="line-added">155                 /*</span>
<span class="line-added">156                  * Add the JVM and Java arguments to the log file to help identity it.</span>
<span class="line-added">157                  */</span>
<span class="line-added">158                 PrintStream ps = new PrintStream(result, enableAutoflush);</span>
<span class="line-added">159                 List&lt;String&gt; inputArguments = GraalServices.getInputArguments();</span>
<span class="line-added">160                 if (inputArguments != null) {</span>
<span class="line-added">161                     ps.println(&quot;VM Arguments: &quot; + String.join(&quot; &quot;, inputArguments));</span>
<span class="line-added">162                 }</span>
<span class="line-added">163                 String cmd = Services.getSavedProperties().get(&quot;sun.java.command&quot;);</span>
<span class="line-added">164                 if (cmd != null) {</span>
<span class="line-added">165                     ps.println(&quot;sun.java.command=&quot; + cmd);</span>
<span class="line-added">166                 }</span>
<span class="line-added">167             }</span>
<span class="line-added">168 </span>
169             @Override
170             public void write(byte[] b, int off, int len) throws IOException {
171                 lazy().write(b, off, len);
172             }
173 
174             @Override
175             public void write(int b) throws IOException {
176                 lazy().write(b);
177             }
178 
179             @Override
180             public void flush() throws IOException {
181                 lazy().flush();
182             }
183 
184             @Override
185             public void close() throws IOException {
186                 lazy().close();
187             }
188         }
189 
190         /**
191          * Gets the print stream configured by this option. If no file is configured, the print
192          * stream will output to HotSpot&#39;s {@link HotSpotJVMCIRuntime#getLogStream() log} stream.
193          */
<span class="line-modified">194         public PrintStream getStream() {</span>
<span class="line-modified">195             return new PrintStream(new DelayedOutputStream());</span>
























196         }
197     }
198 
199 }
</pre>
</td>
</tr>
</table>
<center><a href="HotSpotReplacementsImpl.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="IsGraalPredicate.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>