<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/meta/HotSpotGraphBuilderPlugins.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot.meta;
 26 
 27 import static org.graalvm.compiler.core.common.GraalOptions.GeneratePIC;
<a name="1" id="anc1"></a><span class="line-added"> 28 import static org.graalvm.compiler.hotspot.HotSpotBackend.BASE64_ENCODE_BLOCK;</span>
 29 import static org.graalvm.compiler.hotspot.HotSpotBackend.GHASH_PROCESS_BLOCKS;
 30 import static org.graalvm.compiler.hotspot.meta.HotSpotAOTProfilingPlugin.Options.TieredAOT;
 31 import static org.graalvm.compiler.hotspot.replacements.HotSpotReplacementsUtil.JAVA_THREAD_THREAD_OBJECT_LOCATION;
 32 import static org.graalvm.compiler.java.BytecodeParserOptions.InlineDuringParsing;
<a name="2" id="anc2"></a>
 33 
 34 import java.lang.invoke.ConstantCallSite;
 35 import java.lang.invoke.MutableCallSite;
 36 import java.lang.invoke.VolatileCallSite;
 37 import java.lang.reflect.Array;
<a name="3" id="anc3"></a><span class="line-added"> 38 import java.lang.reflect.Type;</span>
 39 import java.math.BigInteger;
 40 import java.util.zip.CRC32;
 41 
<a name="4" id="anc4"></a><span class="line-added"> 42 import jdk.internal.vm.compiler.collections.Pair;</span>
 43 import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
<a name="5" id="anc5"></a>
 44 import org.graalvm.compiler.core.common.spi.ForeignCallsProvider;
 45 import org.graalvm.compiler.core.common.type.ObjectStamp;
 46 import org.graalvm.compiler.core.common.type.StampFactory;
 47 import org.graalvm.compiler.core.common.type.TypeReference;
<a name="6" id="anc6"></a><span class="line-added"> 48 import org.graalvm.compiler.debug.GraalError;</span>
 49 import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
<a name="7" id="anc7"></a><span class="line-added"> 50 import org.graalvm.compiler.hotspot.HotSpotGraalRuntimeProvider;</span>
 51 import org.graalvm.compiler.hotspot.nodes.CurrentJavaThreadNode;
 52 import org.graalvm.compiler.hotspot.replacements.AESCryptSubstitutions;
 53 import org.graalvm.compiler.hotspot.replacements.ArraysSupportSubstitutions;
 54 import org.graalvm.compiler.hotspot.replacements.BigIntegerSubstitutions;
 55 import org.graalvm.compiler.hotspot.replacements.CRC32CSubstitutions;
 56 import org.graalvm.compiler.hotspot.replacements.CRC32Substitutions;
 57 import org.graalvm.compiler.hotspot.replacements.CallSiteTargetNode;
 58 import org.graalvm.compiler.hotspot.replacements.CipherBlockChainingSubstitutions;
 59 import org.graalvm.compiler.hotspot.replacements.ClassGetHubNode;
 60 import org.graalvm.compiler.hotspot.replacements.CounterModeSubstitutions;
 61 import org.graalvm.compiler.hotspot.replacements.DigestBaseSubstitutions;
<a name="8" id="anc8"></a><span class="line-added"> 62 import org.graalvm.compiler.hotspot.replacements.FastNotifyNode;</span>
 63 import org.graalvm.compiler.hotspot.replacements.HotSpotArraySubstitutions;
 64 import org.graalvm.compiler.hotspot.replacements.HotSpotClassSubstitutions;
 65 import org.graalvm.compiler.hotspot.replacements.IdentityHashCodeNode;
 66 import org.graalvm.compiler.hotspot.replacements.ObjectCloneNode;
<a name="9" id="anc9"></a>
 67 import org.graalvm.compiler.hotspot.replacements.ReflectionGetCallerClassNode;
 68 import org.graalvm.compiler.hotspot.replacements.ReflectionSubstitutions;
 69 import org.graalvm.compiler.hotspot.replacements.SHA2Substitutions;
 70 import org.graalvm.compiler.hotspot.replacements.SHA5Substitutions;
 71 import org.graalvm.compiler.hotspot.replacements.SHASubstitutions;
 72 import org.graalvm.compiler.hotspot.replacements.StringUTF16Substitutions;
 73 import org.graalvm.compiler.hotspot.replacements.ThreadSubstitutions;
 74 import org.graalvm.compiler.hotspot.word.HotSpotWordTypes;
 75 import org.graalvm.compiler.nodes.ComputeObjectAddressNode;
 76 import org.graalvm.compiler.nodes.ConstantNode;
 77 import org.graalvm.compiler.nodes.NamedLocationIdentity;
 78 import org.graalvm.compiler.nodes.NodeView;
 79 import org.graalvm.compiler.nodes.ValueNode;
 80 import org.graalvm.compiler.nodes.calc.AddNode;
 81 import org.graalvm.compiler.nodes.calc.IntegerConvertNode;
 82 import org.graalvm.compiler.nodes.calc.LeftShiftNode;
 83 import org.graalvm.compiler.nodes.extended.ForeignCallNode;
 84 import org.graalvm.compiler.nodes.graphbuilderconf.ForeignCallPlugin;
 85 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
 86 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;
 87 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
 88 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin.Receiver;
 89 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 90 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
 91 import org.graalvm.compiler.nodes.graphbuilderconf.NodeIntrinsicPluginFactory;
 92 import org.graalvm.compiler.nodes.memory.HeapAccess.BarrierType;
 93 import org.graalvm.compiler.nodes.memory.ReadNode;
 94 import org.graalvm.compiler.nodes.memory.address.AddressNode;
 95 import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;
<a name="10" id="anc10"></a><span class="line-added"> 96 import org.graalvm.compiler.nodes.spi.Replacements;</span>
 97 import org.graalvm.compiler.nodes.util.GraphUtil;
 98 import org.graalvm.compiler.options.OptionValues;
 99 import org.graalvm.compiler.phases.tiers.CompilerConfiguration;
100 import org.graalvm.compiler.replacements.InlineDuringParsingPlugin;
101 import org.graalvm.compiler.replacements.MethodHandlePlugin;
102 import org.graalvm.compiler.replacements.NodeIntrinsificationProvider;
103 import org.graalvm.compiler.replacements.ReplacementsImpl;
104 import org.graalvm.compiler.replacements.StandardGraphBuilderPlugins;
105 import org.graalvm.compiler.replacements.arraycopy.ArrayCopyNode;
106 import org.graalvm.compiler.serviceprovider.GraalServices;
<a name="11" id="anc11"></a><span class="line-added">107 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;</span>
108 import org.graalvm.compiler.word.WordOperationPlugin;
109 import org.graalvm.compiler.word.WordTypes;
110 import jdk.internal.vm.compiler.word.LocationIdentity;
111 
112 import jdk.vm.ci.code.CodeUtil;
<a name="12" id="anc12"></a><span class="line-added">113 import jdk.vm.ci.code.TargetDescription;</span>
<span class="line-added">114 import jdk.vm.ci.hotspot.VMIntrinsicMethod;</span>
115 import jdk.vm.ci.meta.ConstantReflectionProvider;
116 import jdk.vm.ci.meta.DeoptimizationAction;
117 import jdk.vm.ci.meta.JavaKind;
118 import jdk.vm.ci.meta.MetaAccessProvider;
119 import jdk.vm.ci.meta.ResolvedJavaMethod;
<a name="13" id="anc13"></a><span class="line-added">120 import jdk.vm.ci.services.Services;</span>
121 import sun.misc.Unsafe;
122 
123 /**
124  * Defines the {@link Plugins} used when running on HotSpot.
125  */
126 public class HotSpotGraphBuilderPlugins {
127 
128     /**
129      * Creates a {@link Plugins} object that should be used when running on HotSpot.
130      *
131      * @param constantReflection
132      * @param snippetReflection
133      * @param foreignCalls
<a name="14" id="anc14"></a><span class="line-added">134      * @param options</span>
<span class="line-added">135      * @param target</span>
136      */
<a name="15" id="anc15"></a><span class="line-modified">137     public static Plugins create(HotSpotGraalRuntimeProvider graalRuntime,</span>
<span class="line-modified">138                     CompilerConfiguration compilerConfiguration,</span>
<span class="line-modified">139                     GraalHotSpotVMConfig config,</span>
<span class="line-added">140                     HotSpotWordTypes wordTypes,</span>
<span class="line-added">141                     MetaAccessProvider metaAccess,</span>
<span class="line-added">142                     ConstantReflectionProvider constantReflection,</span>
<span class="line-added">143                     SnippetReflectionProvider snippetReflection,</span>
<span class="line-added">144                     ForeignCallsProvider foreignCalls,</span>
<span class="line-added">145                     ReplacementsImpl replacements,</span>
<span class="line-added">146                     OptionValues options, TargetDescription target) {</span>
<span class="line-added">147         InvocationPlugins invocationPlugins = new HotSpotInvocationPlugins(graalRuntime, config, compilerConfiguration);</span>
148 
149         Plugins plugins = new Plugins(invocationPlugins);
<a name="16" id="anc16"></a><span class="line-modified">150         NodeIntrinsificationProvider nodeIntrinsificationProvider = new NodeIntrinsificationProvider(metaAccess, snippetReflection, foreignCalls, wordTypes, target);</span>
151         HotSpotWordOperationPlugin wordOperationPlugin = new HotSpotWordOperationPlugin(snippetReflection, wordTypes);
152         HotSpotNodePlugin nodePlugin = new HotSpotNodePlugin(wordOperationPlugin, config, wordTypes);
153 
154         plugins.appendTypePlugin(nodePlugin);
155         plugins.appendNodePlugin(nodePlugin);
<a name="17" id="anc17"></a>
156         if (!GeneratePIC.getValue(options)) {
157             plugins.appendNodePlugin(new MethodHandlePlugin(constantReflection.getMethodHandleAccess(), true));
158         }
159         plugins.appendInlineInvokePlugin(replacements);
160         if (InlineDuringParsing.getValue(options)) {
161             plugins.appendInlineInvokePlugin(new InlineDuringParsingPlugin());
162         }
163 
164         if (GeneratePIC.getValue(options)) {
<a name="18" id="anc18"></a><span class="line-modified">165             plugins.setClassInitializationPlugin(new HotSpotAOTClassInitializationPlugin());</span>
166             if (TieredAOT.getValue(options)) {
167                 plugins.setProfilingPlugin(new HotSpotAOTProfilingPlugin());
168             }
<a name="19" id="anc19"></a><span class="line-added">169         } else {</span>
<span class="line-added">170             if (config.instanceKlassInitThreadOffset != -1) {</span>
<span class="line-added">171                 plugins.setClassInitializationPlugin(new HotSpotJITClassInitializationPlugin());</span>
<span class="line-added">172             }</span>
173         }
174 
175         invocationPlugins.defer(new Runnable() {
176 
177             @Override
178             public void run() {
<a name="20" id="anc20"></a><span class="line-modified">179                 registerObjectPlugins(invocationPlugins, options, config, replacements);</span>
<span class="line-modified">180                 registerClassPlugins(plugins, config, replacements);</span>

181                 registerSystemPlugins(invocationPlugins, foreignCalls);
<a name="21" id="anc21"></a><span class="line-modified">182                 registerThreadPlugins(invocationPlugins, metaAccess, wordTypes, config, replacements);</span>
183                 if (!GeneratePIC.getValue(options)) {
184                     registerCallSitePlugins(invocationPlugins);
185                 }
<a name="22" id="anc22"></a><span class="line-modified">186                 registerReflectionPlugins(invocationPlugins, replacements);</span>
<span class="line-modified">187                 registerConstantPoolPlugins(invocationPlugins, wordTypes, config, replacements);</span>
<span class="line-modified">188                 registerAESPlugins(invocationPlugins, config, replacements);</span>
<span class="line-modified">189                 registerCRC32Plugins(invocationPlugins, config, replacements);</span>
<span class="line-modified">190                 registerCRC32CPlugins(invocationPlugins, config, replacements);</span>
<span class="line-modified">191                 registerBigIntegerPlugins(invocationPlugins, config, replacements);</span>
<span class="line-modified">192                 registerSHAPlugins(invocationPlugins, config, replacements);</span>
193                 registerGHASHPlugins(invocationPlugins, config, metaAccess, foreignCalls);
<a name="23" id="anc23"></a><span class="line-modified">194                 registerCounterModePlugins(invocationPlugins, config, replacements);</span>
<span class="line-modified">195                 registerBase64Plugins(invocationPlugins, config, metaAccess, foreignCalls);</span>
<span class="line-modified">196                 registerUnsafePlugins(invocationPlugins, config, replacements);</span>
<span class="line-modified">197                 StandardGraphBuilderPlugins.registerInvocationPlugins(metaAccess, snippetReflection, invocationPlugins, replacements, true, false, true);</span>
<span class="line-modified">198                 registerArrayPlugins(invocationPlugins, replacements);</span>
<span class="line-modified">199                 registerStringPlugins(invocationPlugins, replacements);</span>
<span class="line-added">200                 registerArraysSupportPlugins(invocationPlugins, config, replacements);</span>
201 
202                 for (NodeIntrinsicPluginFactory factory : GraalServices.load(NodeIntrinsicPluginFactory.class)) {
203                     factory.registerPlugins(invocationPlugins, nodeIntrinsificationProvider);
204                 }
205             }
206         });
207         return plugins;
208     }
209 
<a name="24" id="anc24"></a><span class="line-modified">210     private static void registerObjectPlugins(InvocationPlugins plugins, OptionValues options, GraalHotSpotVMConfig config, Replacements replacements) {</span>
<span class="line-modified">211         Registration r = new Registration(plugins, Object.class, replacements);</span>
212         if (!GeneratePIC.getValue(options)) {
213             // FIXME: clone() requires speculation and requires a fix in here (to check that
214             // b.getAssumptions() != null), and in ReplacementImpl.getSubstitution() where there is
215             // an instantiation of IntrinsicGraphBuilder using a constructor that sets
216             // AllowAssumptions to YES automatically. The former has to inherit the assumptions
217             // settings from the root compile instead. So, for now, I&#39;m disabling it for
218             // GeneratePIC.
219             r.register1(&quot;clone&quot;, Receiver.class, new InvocationPlugin() {
220                 @Override
221                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver) {
222                     ValueNode object = receiver.get();
223                     b.addPush(JavaKind.Object, new ObjectCloneNode(b.getInvokeKind(), targetMethod, b.bci(), b.getInvokeReturnStamp(b.getAssumptions()), object));
224                     return true;
225                 }
226 
227                 @Override
228                 public boolean inlineOnly() {
229                     return true;
230                 }
231             });
232         }
<a name="25" id="anc25"></a><span class="line-modified">233         r.register1(&quot;hashCode&quot;, Receiver.class, new InvocationPlugin() {</span>
<span class="line-added">234             @Override</span>
<span class="line-added">235             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver) {</span>
<span class="line-added">236                 ValueNode object = receiver.get();</span>
<span class="line-added">237                 b.addPush(JavaKind.Int, new IdentityHashCodeNode(object));</span>
<span class="line-added">238                 return true;</span>
<span class="line-added">239             }</span>
<span class="line-added">240 </span>
<span class="line-added">241             @Override</span>
<span class="line-added">242             public boolean inlineOnly() {</span>
<span class="line-added">243                 return true;</span>
<span class="line-added">244             }</span>
<span class="line-added">245         });</span>
246         if (config.inlineNotify()) {
<a name="26" id="anc26"></a><span class="line-modified">247             r.register1(&quot;notify&quot;, Receiver.class, new InvocationPlugin() {</span>
<span class="line-added">248                 @Override</span>
<span class="line-added">249                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver) {</span>
<span class="line-added">250                     ValueNode object = receiver.get();</span>
<span class="line-added">251                     b.add(new FastNotifyNode(object, false, b.bci()));</span>
<span class="line-added">252                     return true;</span>
<span class="line-added">253                 }</span>
<span class="line-added">254 </span>
<span class="line-added">255                 @Override</span>
<span class="line-added">256                 public boolean inlineOnly() {</span>
<span class="line-added">257                     return true;</span>
<span class="line-added">258                 }</span>
<span class="line-added">259             });</span>
260         }
261         if (config.inlineNotifyAll()) {
<a name="27" id="anc27"></a><span class="line-modified">262             r.register1(&quot;notifyAll&quot;, Receiver.class, new InvocationPlugin() {</span>
<span class="line-added">263                 @Override</span>
<span class="line-added">264                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver) {</span>
<span class="line-added">265                     ValueNode object = receiver.get();</span>
<span class="line-added">266                     b.add(new FastNotifyNode(object, true, b.bci()));</span>
<span class="line-added">267                     return true;</span>
<span class="line-added">268                 }</span>
<span class="line-added">269 </span>
<span class="line-added">270                 @Override</span>
<span class="line-added">271                 public boolean inlineOnly() {</span>
<span class="line-added">272                     return true;</span>
<span class="line-added">273                 }</span>
<span class="line-added">274             });</span>
275         }
276     }
277 
<a name="28" id="anc28"></a><span class="line-modified">278     private static void registerClassPlugins(Plugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {</span>
<span class="line-modified">279         Registration r = new Registration(plugins.getInvocationPlugins(), Class.class, replacements);</span>
280 
281         r.registerMethodSubstitution(HotSpotClassSubstitutions.class, &quot;getModifiers&quot;, Receiver.class);
282         r.registerMethodSubstitution(HotSpotClassSubstitutions.class, &quot;isInterface&quot;, Receiver.class);
283         r.registerMethodSubstitution(HotSpotClassSubstitutions.class, &quot;isArray&quot;, Receiver.class);
284         r.registerMethodSubstitution(HotSpotClassSubstitutions.class, &quot;isPrimitive&quot;, Receiver.class);
285         r.registerMethodSubstitution(HotSpotClassSubstitutions.class, &quot;getSuperclass&quot;, Receiver.class);
286 
287         if (config.getFieldOffset(&quot;ArrayKlass::_component_mirror&quot;, Integer.class, &quot;oop&quot;, Integer.MAX_VALUE) != Integer.MAX_VALUE) {
288             r.registerMethodSubstitution(HotSpotClassSubstitutions.class, &quot;getComponentType&quot;, Receiver.class);
289         }
290     }
291 
292     private static void registerCallSitePlugins(InvocationPlugins plugins) {
293         InvocationPlugin plugin = new InvocationPlugin() {
294             @Override
295             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver) {
296                 ValueNode callSite = receiver.get();
<a name="29" id="anc29"></a><span class="line-modified">297                 ValueNode folded = CallSiteTargetNode.tryFold(GraphUtil.originalValue(callSite, true), b.getMetaAccess(), b.getAssumptions());</span>
298                 if (folded != null) {
299                     b.addPush(JavaKind.Object, folded);
300                 } else {
301                     b.addPush(JavaKind.Object, new CallSiteTargetNode(b.getInvokeKind(), targetMethod, b.bci(), b.getInvokeReturnStamp(b.getAssumptions()), callSite));
302                 }
303                 return true;
304             }
305 
306             @Override
307             public boolean inlineOnly() {
308                 return true;
309             }
310         };
311         plugins.register(plugin, ConstantCallSite.class, &quot;getTarget&quot;, Receiver.class);
312         plugins.register(plugin, MutableCallSite.class, &quot;getTarget&quot;, Receiver.class);
313         plugins.register(plugin, VolatileCallSite.class, &quot;getTarget&quot;, Receiver.class);
314     }
315 
<a name="30" id="anc30"></a><span class="line-modified">316     private static void registerReflectionPlugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">317         Registration r = new Registration(plugins, reflectionClass, replacements);</span>
318         r.register0(&quot;getCallerClass&quot;, new InvocationPlugin() {
319             @Override
320             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver) {
321                 b.addPush(JavaKind.Object, new ReflectionGetCallerClassNode(b.getInvokeKind(), targetMethod, b.bci(), b.getInvokeReturnStamp(b.getAssumptions())));
322                 return true;
323             }
324 
325             @Override
326             public boolean inlineOnly() {
327                 return true;
328             }
329         });
330         r.registerMethodSubstitution(ReflectionSubstitutions.class, &quot;getClassAccessFlags&quot;, Class.class);
331     }
332 
<a name="31" id="anc31"></a><span class="line-modified">333     private static void registerUnsafePlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {</span>
334         Registration r;
<a name="32" id="anc32"></a><span class="line-modified">335         if (JavaVersionUtil.JAVA_SPEC &lt;= 8) {</span>
<span class="line-modified">336             r = new Registration(plugins, Unsafe.class, replacements);</span>
337         } else {
<a name="33" id="anc33"></a><span class="line-modified">338             r = new Registration(plugins, &quot;jdk.internal.misc.Unsafe&quot;, replacements);</span>
339         }
<a name="34" id="anc34"></a><span class="line-modified">340         String substituteMethodName = config.doingUnsafeAccessOffset != Integer.MAX_VALUE ? &quot;copyMemoryGuarded&quot; : &quot;copyMemory&quot;;</span>
<span class="line-modified">341         r.registerMethodSubstitution(HotSpotUnsafeSubstitutions.class, HotSpotUnsafeSubstitutions.copyMemoryName, substituteMethodName, Receiver.class, Object.class, long.class, Object.class,</span>
<span class="line-added">342                         long.class, long.class);</span>
343     }
344 
345     private static final LocationIdentity INSTANCE_KLASS_CONSTANTS = NamedLocationIdentity.immutable(&quot;InstanceKlass::_constants&quot;);
346     private static final LocationIdentity CONSTANT_POOL_LENGTH = NamedLocationIdentity.immutable(&quot;ConstantPool::_length&quot;);
347 
348     /**
349      * Emits a node to get the metaspace {@code ConstantPool} pointer given the value of the
350      * {@code constantPoolOop} field in a ConstantPool value.
351      *
352      * @param constantPoolOop value of the {@code constantPoolOop} field in a ConstantPool value
353      * @return a node representing the metaspace {@code ConstantPool} pointer associated with
354      *         {@code constantPoolOop}
355      */
356     private static ValueNode getMetaspaceConstantPool(GraphBuilderContext b, ValueNode constantPoolOop, WordTypes wordTypes, GraalHotSpotVMConfig config) {
357         // ConstantPool.constantPoolOop is in fact the holder class.
358         ValueNode value = b.nullCheckedValue(constantPoolOop, DeoptimizationAction.None);
359         ValueNode klass = b.add(ClassGetHubNode.create(value, b.getMetaAccess(), b.getConstantReflection(), false));
360 
361         boolean notCompressible = false;
362         AddressNode constantsAddress = b.add(new OffsetAddressNode(klass, b.add(ConstantNode.forLong(config.instanceKlassConstantsOffset))));
363         return WordOperationPlugin.readOp(b, wordTypes.getWordKind(), constantsAddress, INSTANCE_KLASS_CONSTANTS, BarrierType.NONE, notCompressible);
364     }
365 
366     /**
367      * Emits a node representing an element in a metaspace {@code ConstantPool}.
368      *
369      * @param constantPoolOop value of the {@code constantPoolOop} field in a ConstantPool value
370      */
371     private static boolean readMetaspaceConstantPoolElement(GraphBuilderContext b, ValueNode constantPoolOop, ValueNode index, JavaKind elementKind, WordTypes wordTypes, GraalHotSpotVMConfig config) {
372         ValueNode constants = getMetaspaceConstantPool(b, constantPoolOop, wordTypes, config);
373         int shift = CodeUtil.log2(wordTypes.getWordKind().getByteCount());
374         ValueNode scaledIndex = b.add(new LeftShiftNode(IntegerConvertNode.convert(index, StampFactory.forKind(JavaKind.Long), NodeView.DEFAULT), b.add(ConstantNode.forInt(shift))));
375         ValueNode offset = b.add(new AddNode(scaledIndex, b.add(ConstantNode.forLong(config.constantPoolSize))));
376         AddressNode elementAddress = b.add(new OffsetAddressNode(constants, offset));
377         boolean notCompressible = false;
378         ValueNode elementValue = WordOperationPlugin.readOp(b, elementKind, elementAddress, NamedLocationIdentity.getArrayLocation(elementKind), BarrierType.NONE, notCompressible);
379         b.addPush(elementKind, elementValue);
380         return true;
381     }
382 
<a name="35" id="anc35"></a><span class="line-modified">383     private static void registerConstantPoolPlugins(InvocationPlugins plugins, WordTypes wordTypes, GraalHotSpotVMConfig config, Replacements replacements) {</span>
<span class="line-modified">384         Registration r = new Registration(plugins, constantPoolClass, replacements);</span>
385 
386         r.register2(&quot;getSize0&quot;, Receiver.class, Object.class, new InvocationPlugin() {
387             @Override
388             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode constantPoolOop) {
389                 boolean notCompressible = false;
390                 ValueNode constants = getMetaspaceConstantPool(b, constantPoolOop, wordTypes, config);
391                 AddressNode lengthAddress = b.add(new OffsetAddressNode(constants, b.add(ConstantNode.forLong(config.constantPoolLengthOffset))));
392                 ValueNode length = WordOperationPlugin.readOp(b, JavaKind.Int, lengthAddress, CONSTANT_POOL_LENGTH, BarrierType.NONE, notCompressible);
393                 b.addPush(JavaKind.Int, length);
394                 return true;
395             }
396         });
397 
398         r.register3(&quot;getIntAt0&quot;, Receiver.class, Object.class, int.class, new InvocationPlugin() {
399             @Override
400             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode constantPoolOop, ValueNode index) {
401                 return readMetaspaceConstantPoolElement(b, constantPoolOop, index, JavaKind.Int, wordTypes, config);
402             }
403         });
404         r.register3(&quot;getLongAt0&quot;, Receiver.class, Object.class, int.class, new InvocationPlugin() {
405             @Override
406             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode constantPoolOop, ValueNode index) {
407                 return readMetaspaceConstantPoolElement(b, constantPoolOop, index, JavaKind.Long, wordTypes, config);
408             }
409         });
410         r.register3(&quot;getFloatAt0&quot;, Receiver.class, Object.class, int.class, new InvocationPlugin() {
411             @Override
412             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode constantPoolOop, ValueNode index) {
413                 return readMetaspaceConstantPoolElement(b, constantPoolOop, index, JavaKind.Float, wordTypes, config);
414             }
415         });
416         r.register3(&quot;getDoubleAt0&quot;, Receiver.class, Object.class, int.class, new InvocationPlugin() {
417             @Override
418             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode constantPoolOop, ValueNode index) {
419                 return readMetaspaceConstantPoolElement(b, constantPoolOop, index, JavaKind.Double, wordTypes, config);
420             }
421         });
422     }
423 
424     private static void registerSystemPlugins(InvocationPlugins plugins, ForeignCallsProvider foreignCalls) {
425         Registration r = new Registration(plugins, System.class);
426         r.register0(&quot;currentTimeMillis&quot;, new ForeignCallPlugin(foreignCalls, HotSpotHostForeignCallsProvider.JAVA_TIME_MILLIS));
427         r.register0(&quot;nanoTime&quot;, new ForeignCallPlugin(foreignCalls, HotSpotHostForeignCallsProvider.JAVA_TIME_NANOS));
428         r.register1(&quot;identityHashCode&quot;, Object.class, new InvocationPlugin() {
429             @Override
430             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode object) {
431                 b.addPush(JavaKind.Int, new IdentityHashCodeNode(object));
432                 return true;
433             }
434 
435             @Override
436             public boolean inlineOnly() {
437                 return true;
438             }
439         });
440         r.register5(&quot;arraycopy&quot;, Object.class, int.class, Object.class, int.class, int.class, new InvocationPlugin() {
441             @Override
442             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode src, ValueNode srcPos, ValueNode dst, ValueNode dstPos, ValueNode length) {
443                 b.add(new ArrayCopyNode(b.bci(), src, srcPos, dst, dstPos, length));
444                 return true;
445             }
446 
447             @Override
448             public boolean inlineOnly() {
449                 return true;
450             }
451         });
452     }
453 
<a name="36" id="anc36"></a><span class="line-modified">454     private static void registerArrayPlugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">455         Registration r = new Registration(plugins, Array.class, replacements);</span>
456         r.setAllowOverwrite(true);
457         r.registerMethodSubstitution(HotSpotArraySubstitutions.class, &quot;newInstance&quot;, Class.class, int.class);
458     }
459 
<a name="37" id="anc37"></a><span class="line-modified">460     private static void registerStringPlugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">461         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-modified">462             final Registration utf16r = new Registration(plugins, &quot;java.lang.StringUTF16&quot;, replacements);</span>
463             utf16r.registerMethodSubstitution(StringUTF16Substitutions.class, &quot;toBytes&quot;, char[].class, int.class, int.class);
464             utf16r.registerMethodSubstitution(StringUTF16Substitutions.class, &quot;getChars&quot;, byte[].class, int.class, int.class, char[].class, int.class);
465         }
466     }
467 
<a name="38" id="anc38"></a><span class="line-modified">468     private static void registerThreadPlugins(InvocationPlugins plugins, MetaAccessProvider metaAccess, WordTypes wordTypes, GraalHotSpotVMConfig config, Replacements replacements) {</span>
<span class="line-modified">469         Registration r = new Registration(plugins, Thread.class, replacements);</span>
470         r.register0(&quot;currentThread&quot;, new InvocationPlugin() {
471             @Override
472             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver) {
473                 CurrentJavaThreadNode thread = b.add(new CurrentJavaThreadNode(wordTypes.getWordKind()));
474                 ValueNode offset = b.add(ConstantNode.forLong(config.threadObjectOffset));
475                 AddressNode address = b.add(new OffsetAddressNode(thread, offset));
476                 // JavaThread::_threadObj is never compressed
477                 ObjectStamp stamp = StampFactory.objectNonNull(TypeReference.create(b.getAssumptions(), metaAccess.lookupJavaType(Thread.class)));
478                 b.addPush(JavaKind.Object, new ReadNode(address, JAVA_THREAD_THREAD_OBJECT_LOCATION, stamp, BarrierType.NONE));
479                 return true;
480             }
481         });
482 
<a name="39" id="anc39"></a><span class="line-modified">483         if (config.osThreadInterruptedOffset != Integer.MAX_VALUE) {</span>
<span class="line-modified">484             r.registerMethodSubstitution(ThreadSubstitutions.class, &quot;isInterrupted&quot;, Receiver.class, boolean.class);</span>
<span class="line-added">485         }</span>
486 
<a name="40" id="anc40"></a><span class="line-modified">487     }</span>



488 
489     public static final String reflectionClass;
490     public static final String constantPoolClass;
491 
492     static {
<a name="41" id="anc41"></a><span class="line-modified">493         if (JavaVersionUtil.JAVA_SPEC &lt;= 8) {</span>




494             reflectionClass = &quot;sun.reflect.Reflection&quot;;
495             constantPoolClass = &quot;sun.reflect.ConstantPool&quot;;
496         } else {
<a name="42" id="anc42"></a>



497             reflectionClass = &quot;jdk.internal.reflect.Reflection&quot;;
498             constantPoolClass = &quot;jdk.internal.reflect.ConstantPool&quot;;
499         }
500     }
501 
<a name="43" id="anc43"></a><span class="line-modified">502     public static String lookupIntrinsicName(GraalHotSpotVMConfig config, String className, String name1, String name2) {</span>
<span class="line-added">503         return selectIntrinsicName(config, className, name1, name2).getLeft();</span>
<span class="line-added">504     }</span>
<span class="line-added">505 </span>
<span class="line-added">506     /**</span>
<span class="line-added">507      * Returns a pair of Strings where the left one represents the matched intrinsic name and the</span>
<span class="line-added">508      * right one represents the mismatched intrinsic name.</span>
<span class="line-added">509      */</span>
<span class="line-added">510     public static Pair&lt;String, String&gt; selectIntrinsicName(GraalHotSpotVMConfig config, String className, String name1, String name2) {</span>
<span class="line-added">511         boolean foundName1 = false;</span>
<span class="line-added">512         boolean foundName2 = false;</span>
<span class="line-added">513         for (VMIntrinsicMethod intrinsic : config.getStore().getIntrinsics()) {</span>
<span class="line-added">514             if (className.equals(intrinsic.declaringClass)) {</span>
<span class="line-added">515                 if (name1.equals(intrinsic.name)) {</span>
<span class="line-added">516                     foundName1 = true;</span>
<span class="line-added">517                 } else if (name2.equals(intrinsic.name)) {</span>
<span class="line-added">518                     foundName2 = true;</span>
<span class="line-added">519                 }</span>
<span class="line-added">520             }</span>
<span class="line-added">521         }</span>
<span class="line-added">522         if (foundName1 &amp;&amp; !foundName2) {</span>
<span class="line-added">523             return Pair.create(name1, name2);</span>
<span class="line-added">524         } else if (foundName2 &amp;&amp; !foundName1) {</span>
<span class="line-added">525             return Pair.create(name2, name1);</span>
<span class="line-added">526         }</span>
<span class="line-added">527         throw GraalError.shouldNotReachHere();</span>
<span class="line-added">528     }</span>
<span class="line-added">529 </span>
<span class="line-added">530     public static boolean isIntrinsicName(GraalHotSpotVMConfig config, String className, String name) {</span>
<span class="line-added">531         for (VMIntrinsicMethod intrinsic : config.getStore().getIntrinsics()) {</span>
<span class="line-added">532             if (className.equals(intrinsic.declaringClass)) {</span>
<span class="line-added">533                 if (name.equals(intrinsic.name)) {</span>
<span class="line-added">534                     return true;</span>
<span class="line-added">535                 }</span>
<span class="line-added">536             }</span>
<span class="line-added">537         }</span>
<span class="line-added">538         return false;</span>
<span class="line-added">539     }</span>
<span class="line-added">540 </span>
<span class="line-added">541     private static void registerAESPlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {</span>
542         if (config.useAESIntrinsics) {
543             assert config.aescryptEncryptBlockStub != 0L;
544             assert config.aescryptDecryptBlockStub != 0L;
545             assert config.cipherBlockChainingEncryptAESCryptStub != 0L;
546             assert config.cipherBlockChainingDecryptAESCryptStub != 0L;
547             String arch = config.osArch;
548             String decryptSuffix = arch.equals(&quot;sparc&quot;) ? &quot;WithOriginalKey&quot; : &quot;&quot;;
<a name="44" id="anc44"></a><span class="line-modified">549 </span>
<span class="line-modified">550             Registration r = new Registration(plugins, &quot;com.sun.crypto.provider.CipherBlockChaining&quot;, replacements);</span>
<span class="line-modified">551 </span>
<span class="line-modified">552             Pair&lt;String, String&gt; cbcEncryptName = selectIntrinsicName(config, &quot;com/sun/crypto/provider/CipherBlockChaining&quot;, &quot;implEncrypt&quot;, &quot;encrypt&quot;);</span>
<span class="line-modified">553             registerAndCheckMismatch(r, CipherBlockChainingSubstitutions.class, cbcEncryptName, Receiver.class, byte[].class, int.class, int.class,</span>
<span class="line-modified">554                             byte[].class, int.class);</span>
<span class="line-modified">555 </span>
<span class="line-added">556             Pair&lt;String, String&gt; cbcDecryptName = selectIntrinsicName(config, &quot;com/sun/crypto/provider/CipherBlockChaining&quot;, &quot;implDecrypt&quot;, &quot;decrypt&quot;);</span>
<span class="line-added">557             registerAndCheckMismatch(r, CipherBlockChainingSubstitutions.class, cbcDecryptName, cbcDecryptName.getLeft() + decryptSuffix, Receiver.class, byte[].class, int.class, int.class,</span>
<span class="line-added">558                             byte[].class, int.class);</span>
<span class="line-added">559 </span>
<span class="line-added">560             r = new Registration(plugins, &quot;com.sun.crypto.provider.AESCrypt&quot;, replacements);</span>
<span class="line-added">561 </span>
<span class="line-added">562             Pair&lt;String, String&gt; aesEncryptName = selectIntrinsicName(config, &quot;com/sun/crypto/provider/AESCrypt&quot;, &quot;implEncryptBlock&quot;, &quot;encryptBlock&quot;);</span>
<span class="line-added">563             registerAndCheckMismatch(r, AESCryptSubstitutions.class, aesEncryptName, Receiver.class, byte[].class, int.class, byte[].class, int.class);</span>
<span class="line-added">564 </span>
<span class="line-added">565             Pair&lt;String, String&gt; aesDecryptName = selectIntrinsicName(config, &quot;com/sun/crypto/provider/AESCrypt&quot;, &quot;implDecryptBlock&quot;, &quot;decryptBlock&quot;);</span>
<span class="line-added">566             registerAndCheckMismatch(r, AESCryptSubstitutions.class, aesDecryptName, aesDecryptName.getLeft() + decryptSuffix, Receiver.class, byte[].class, int.class, byte[].class, int.class);</span>
567         }
568     }
569 
<a name="45" id="anc45"></a><span class="line-modified">570     private static void registerAndCheckMismatch(Registration r, Class&lt;?&gt; substitutionClass, Pair&lt;String, String&gt; intrinsicNames, Type... argumentTypes) {</span>
<span class="line-modified">571         try {</span>
<span class="line-modified">572             r.registerMethodSubstitution(substitutionClass, intrinsicNames.getLeft(), argumentTypes);</span>
<span class="line-modified">573         } catch (NoSuchMethodError e) {</span>
<span class="line-modified">574             throw new GraalError(e, &quot;Found method named &#39;%s&#39; instead of &#39;%s&#39; in class &#39;%s&#39;. This is most likely because the JVMCI JDK in %s was built on an incompatible base JDK.&quot;,</span>
<span class="line-modified">575                             intrinsicNames.getRight(), intrinsicNames.getLeft(), r.getDeclaringType().getTypeName(), Services.getSavedProperties().get(&quot;java.home&quot;));</span>





576         }
<a name="46" id="anc46"></a><span class="line-modified">577     }</span>
<span class="line-modified">578 </span>
<span class="line-modified">579     private static void registerAndCheckMismatch(Registration r, Class&lt;?&gt; substitutionClass, Pair&lt;String, String&gt; intrinsicNames, String substituteName, Type... argumentTypes) {</span>
<span class="line-modified">580         try {</span>
<span class="line-modified">581             r.registerMethodSubstitution(substitutionClass, intrinsicNames.getLeft(), substituteName, argumentTypes);</span>
<span class="line-modified">582         } catch (NoSuchMethodError e) {</span>
<span class="line-modified">583             throw new GraalError(e, &quot;Found method named &#39;%s&#39; instead of &#39;%s&#39; in class &#39;%s&#39;. This is most likely because the JVMCI JDK in %s was built on an incompatible base JDK.&quot;,</span>
<span class="line-modified">584                             intrinsicNames.getRight(), intrinsicNames.getLeft(), r.getDeclaringType().getTypeName(), Services.getSavedProperties().get(&quot;java.home&quot;));</span>
585         }
<a name="47" id="anc47"></a><span class="line-modified">586     }</span>
<span class="line-modified">587 </span>
<span class="line-added">588     private static void registerBigIntegerPlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {</span>
<span class="line-added">589         Registration r = new Registration(plugins, BigInteger.class, replacements);</span>
<span class="line-added">590         assert !config.useMultiplyToLenIntrinsic() || config.multiplyToLen != 0L;</span>
<span class="line-added">591         if (JavaVersionUtil.JAVA_SPEC &lt;= 8) {</span>
<span class="line-added">592             r.registerConditionalMethodSubstitution(config.useMultiplyToLenIntrinsic(), BigIntegerSubstitutions.class, &quot;multiplyToLen&quot;, &quot;multiplyToLenStatic&quot;, int[].class, int.class, int[].class,</span>
<span class="line-added">593                             int.class, int[].class);</span>
<span class="line-added">594         } else {</span>
<span class="line-added">595             r.registerConditionalMethodSubstitution(config.useMultiplyToLenIntrinsic(), BigIntegerSubstitutions.class, &quot;implMultiplyToLen&quot;, &quot;multiplyToLenStatic&quot;, int[].class, int.class, int[].class,</span>
<span class="line-added">596                             int.class, int[].class);</span>
597         }
<a name="48" id="anc48"></a><span class="line-added">598         r.registerConditionalMethodSubstitution(config.useMulAddIntrinsic(), BigIntegerSubstitutions.class, &quot;implMulAdd&quot;, int[].class, int[].class, int.class, int.class, int.class);</span>
<span class="line-added">599         r.registerConditionalMethodSubstitution(config.useMontgomeryMultiplyIntrinsic(), BigIntegerSubstitutions.class, &quot;implMontgomeryMultiply&quot;, int[].class, int[].class, int[].class, int.class,</span>
<span class="line-added">600                         long.class, int[].class);</span>
<span class="line-added">601         r.registerConditionalMethodSubstitution(config.useMontgomerySquareIntrinsic(), BigIntegerSubstitutions.class, &quot;implMontgomerySquare&quot;, int[].class, int[].class, int.class, long.class,</span>
<span class="line-added">602                         int[].class);</span>
<span class="line-added">603         r.registerConditionalMethodSubstitution(config.useSquareToLenIntrinsic(), BigIntegerSubstitutions.class, &quot;implSquareToLen&quot;, int[].class, int.class, int[].class, int.class);</span>
604     }
605 
<a name="49" id="anc49"></a><span class="line-modified">606     private static void registerSHAPlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {</span>
607         boolean useSha1 = config.useSHA1Intrinsics();
608         boolean useSha256 = config.useSHA256Intrinsics();
609         boolean useSha512 = config.useSHA512Intrinsics();
610 
<a name="50" id="anc50"></a><span class="line-modified">611         if (isIntrinsicName(config, &quot;sun/security/provider/DigestBase&quot;, &quot;implCompressMultiBlock0&quot;) &amp;&amp; (useSha1 || useSha256 || useSha512)) {</span>
<span class="line-modified">612             Registration r = new Registration(plugins, &quot;sun.security.provider.DigestBase&quot;, replacements);</span>
613             r.registerMethodSubstitution(DigestBaseSubstitutions.class, &quot;implCompressMultiBlock0&quot;, Receiver.class, byte[].class, int.class, int.class);
614         }
615 
<a name="51" id="anc51"></a><span class="line-added">616         Pair&lt;String, String&gt; implCompressName = selectIntrinsicName(config, &quot;sun/security/provider/SHA&quot;, &quot;implCompress&quot;, &quot;implCompress0&quot;);</span>
617         if (useSha1) {
618             assert config.sha1ImplCompress != 0L;
<a name="52" id="anc52"></a><span class="line-modified">619             Registration r = new Registration(plugins, &quot;sun.security.provider.SHA&quot;, replacements);</span>
<span class="line-modified">620             registerAndCheckMismatch(r, SHASubstitutions.class, implCompressName, &quot;implCompress0&quot;, Receiver.class, byte[].class, int.class);</span>
621         }
622         if (useSha256) {
623             assert config.sha256ImplCompress != 0L;
<a name="53" id="anc53"></a><span class="line-modified">624             Registration r = new Registration(plugins, &quot;sun.security.provider.SHA2&quot;, replacements);</span>
<span class="line-modified">625             registerAndCheckMismatch(r, SHA2Substitutions.class, implCompressName, &quot;implCompress0&quot;, Receiver.class, byte[].class, int.class);</span>
626         }
627         if (useSha512) {
628             assert config.sha512ImplCompress != 0L;
<a name="54" id="anc54"></a><span class="line-modified">629             Registration r = new Registration(plugins, &quot;sun.security.provider.SHA5&quot;, replacements);</span>
<span class="line-modified">630             registerAndCheckMismatch(r, SHA5Substitutions.class, implCompressName, &quot;implCompress0&quot;, Receiver.class, byte[].class, int.class);</span>
631         }
632     }
633 
634     private static void registerGHASHPlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, MetaAccessProvider metaAccess, ForeignCallsProvider foreignCalls) {
635         if (config.useGHASHIntrinsics()) {
636             assert config.ghashProcessBlocks != 0L;
637             Registration r = new Registration(plugins, &quot;com.sun.crypto.provider.GHASH&quot;);
638             r.register5(&quot;processBlocks&quot;,
639                             byte[].class,
640                             int.class,
641                             int.class,
642                             long[].class,
643                             long[].class,
644                             new InvocationPlugin() {
645                                 @Override
646                                 public boolean apply(GraphBuilderContext b,
647                                                 ResolvedJavaMethod targetMethod,
648                                                 Receiver receiver,
649                                                 ValueNode data,
650                                                 ValueNode inOffset,
651                                                 ValueNode blocks,
652                                                 ValueNode state,
653                                                 ValueNode hashSubkey) {
654                                     int longArrayBaseOffset = metaAccess.getArrayBaseOffset(JavaKind.Long);
655                                     int byteArrayBaseOffset = metaAccess.getArrayBaseOffset(JavaKind.Byte);
656                                     ValueNode dataOffset = AddNode.create(ConstantNode.forInt(byteArrayBaseOffset), inOffset, NodeView.DEFAULT);
657                                     ComputeObjectAddressNode dataAddress = b.add(new ComputeObjectAddressNode(data, dataOffset));
658                                     ComputeObjectAddressNode stateAddress = b.add(new ComputeObjectAddressNode(state, ConstantNode.forInt(longArrayBaseOffset)));
659                                     ComputeObjectAddressNode hashSubkeyAddress = b.add(new ComputeObjectAddressNode(hashSubkey, ConstantNode.forInt(longArrayBaseOffset)));
660                                     b.add(new ForeignCallNode(foreignCalls, GHASH_PROCESS_BLOCKS, stateAddress, hashSubkeyAddress, dataAddress, blocks));
661                                     return true;
662                                 }
663                             });
664         }
665     }
666 
<a name="55" id="anc55"></a><span class="line-modified">667     private static void registerCounterModePlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {</span>
<span class="line-modified">668         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-modified">669             assert !config.useAESCTRIntrinsics || config.counterModeAESCrypt != 0L;</span>
<span class="line-modified">670             Registration r = new Registration(plugins, &quot;com.sun.crypto.provider.CounterMode&quot;, replacements);</span>
<span class="line-modified">671             r.registerConditionalMethodSubstitution(config.useAESCTRIntrinsics, CounterModeSubstitutions.class, &quot;implCrypt&quot;, Receiver.class, byte[].class, int.class, int.class, byte[].class,</span>
<span class="line-added">672                             int.class);</span>
673         }
674     }
675 
<a name="56" id="anc56"></a><span class="line-modified">676     private static void registerBase64Plugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, MetaAccessProvider metaAccess, ForeignCallsProvider foreignCalls) {</span>
<span class="line-modified">677         if (config.useBase64Intrinsics()) {</span>
<span class="line-modified">678             Registration r = new Registration(plugins, &quot;java.util.Base64$Encoder&quot;);</span>
<span class="line-modified">679             r.register7(&quot;encodeBlock&quot;,</span>
<span class="line-modified">680                             Receiver.class,</span>
<span class="line-modified">681                             byte[].class,</span>
<span class="line-modified">682                             int.class,</span>
<span class="line-modified">683                             int.class,</span>
<span class="line-modified">684                             byte[].class,</span>
<span class="line-modified">685                             int.class,</span>
<span class="line-modified">686                             boolean.class,</span>
<span class="line-added">687                             new InvocationPlugin() {</span>
<span class="line-added">688                                 @Override</span>
<span class="line-added">689                                 public boolean apply(GraphBuilderContext b,</span>
<span class="line-added">690                                                 ResolvedJavaMethod targetMethod,</span>
<span class="line-added">691                                                 Receiver receiver,</span>
<span class="line-added">692                                                 ValueNode src,</span>
<span class="line-added">693                                                 ValueNode sp,</span>
<span class="line-added">694                                                 ValueNode sl,</span>
<span class="line-added">695                                                 ValueNode dst,</span>
<span class="line-added">696                                                 ValueNode dp,</span>
<span class="line-added">697                                                 ValueNode isURL) {</span>
<span class="line-added">698                                     int byteArrayBaseOffset = metaAccess.getArrayBaseOffset(JavaKind.Byte);</span>
<span class="line-added">699                                     ComputeObjectAddressNode srcAddress = b.add(new ComputeObjectAddressNode(src, ConstantNode.forInt(byteArrayBaseOffset)));</span>
<span class="line-added">700                                     ComputeObjectAddressNode dstAddress = b.add(new ComputeObjectAddressNode(dst, ConstantNode.forInt(byteArrayBaseOffset)));</span>
<span class="line-added">701                                     b.add(new ForeignCallNode(foreignCalls, BASE64_ENCODE_BLOCK, srcAddress, sp, sl, dstAddress, dp, isURL));</span>
<span class="line-added">702                                     return true;</span>
<span class="line-added">703                                 }</span>
<span class="line-added">704                             });</span>
<span class="line-added">705         }</span>
<span class="line-added">706     }</span>
<span class="line-added">707 </span>
<span class="line-added">708     private static void registerCRC32Plugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {</span>
<span class="line-added">709         Registration r = new Registration(plugins, CRC32.class, replacements);</span>
<span class="line-added">710         r.registerConditionalMethodSubstitution(config.useCRC32Intrinsics, CRC32Substitutions.class, &quot;update&quot;, int.class, int.class);</span>
<span class="line-added">711         if (JavaVersionUtil.JAVA_SPEC &lt;= 8) {</span>
<span class="line-added">712             r.registerConditionalMethodSubstitution(config.useCRC32Intrinsics, CRC32Substitutions.class, &quot;updateBytes&quot;, int.class, byte[].class, int.class, int.class);</span>
<span class="line-added">713             r.registerConditionalMethodSubstitution(config.useCRC32Intrinsics, CRC32Substitutions.class, &quot;updateByteBuffer&quot;, int.class, long.class, int.class, int.class);</span>
<span class="line-added">714         } else {</span>
<span class="line-added">715             r.registerConditionalMethodSubstitution(config.useCRC32Intrinsics, CRC32Substitutions.class, &quot;updateBytes0&quot;, int.class, byte[].class, int.class, int.class);</span>
<span class="line-added">716             r.registerConditionalMethodSubstitution(config.useCRC32Intrinsics, CRC32Substitutions.class, &quot;updateByteBuffer0&quot;, int.class, long.class, int.class, int.class);</span>
717         }
718     }
719 
<a name="57" id="anc57"></a><span class="line-modified">720     private static void registerCRC32CPlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {</span>
<span class="line-modified">721         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-modified">722             Registration r = new Registration(plugins, &quot;java.util.zip.CRC32C&quot;, replacements);</span>
<span class="line-modified">723             r.registerConditionalMethodSubstitution(config.useCRC32CIntrinsics, CRC32CSubstitutions.class, &quot;updateBytes&quot;, int.class, byte[].class, int.class, int.class);</span>
<span class="line-modified">724             r.registerConditionalMethodSubstitution(config.useCRC32CIntrinsics, CRC32CSubstitutions.class, &quot;updateDirectByteBuffer&quot;, int.class, long.class, int.class, int.class);</span>
725         }
726     }
727 
<a name="58" id="anc58"></a><span class="line-modified">728     private static void registerArraysSupportPlugins(InvocationPlugins plugins, GraalHotSpotVMConfig config, Replacements replacements) {</span>
<span class="line-modified">729         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-modified">730             Registration r = new Registration(plugins, &quot;jdk.internal.util.ArraysSupport&quot;, replacements);</span>
<span class="line-modified">731             r.registerConditionalMethodSubstitution(config.useVectorizedMismatchIntrinsic, ArraysSupportSubstitutions.class, &quot;vectorizedMismatch&quot;, Object.class, long.class, Object.class, long.class,</span>
<span class="line-added">732                             int.class, int.class);</span>
733         }
734     }
735 }
<a name="59" id="anc59"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="59" type="hidden" />
</body>
</html>