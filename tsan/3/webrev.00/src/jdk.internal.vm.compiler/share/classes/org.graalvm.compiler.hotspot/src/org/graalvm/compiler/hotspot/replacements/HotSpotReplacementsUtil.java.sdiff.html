<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/replacements/HotSpotReplacementsUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HotSpotClassSubstitutions.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="IdentityHashCodeNode.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot/src/org/graalvm/compiler/hotspot/replacements/HotSpotReplacementsUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 34 import org.graalvm.compiler.api.replacements.Fold.InjectedParameter;
 35 import org.graalvm.compiler.core.common.SuppressFBWarnings;
 36 import org.graalvm.compiler.core.common.spi.ForeignCallDescriptor;
 37 import org.graalvm.compiler.core.common.type.ObjectStamp;
 38 import org.graalvm.compiler.core.common.type.TypeReference;
 39 import org.graalvm.compiler.debug.GraalError;
 40 import org.graalvm.compiler.graph.Node.ConstantNodeParameter;
 41 import org.graalvm.compiler.graph.Node.NodeIntrinsic;
 42 import org.graalvm.compiler.graph.spi.CanonicalizerTool;
 43 import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
 44 import org.graalvm.compiler.hotspot.word.KlassPointer;
 45 import org.graalvm.compiler.nodes.CanonicalizableLocation;
 46 import org.graalvm.compiler.nodes.CompressionNode;
 47 import org.graalvm.compiler.nodes.ComputeObjectAddressNode;
 48 import org.graalvm.compiler.nodes.ConstantNode;
 49 import org.graalvm.compiler.nodes.NamedLocationIdentity;
 50 import org.graalvm.compiler.nodes.NodeView;
 51 import org.graalvm.compiler.nodes.ValueNode;
 52 import org.graalvm.compiler.nodes.extended.ForeignCallNode;
 53 import org.graalvm.compiler.nodes.extended.LoadHubNode;

 54 import org.graalvm.compiler.nodes.extended.RawLoadNode;
 55 import org.graalvm.compiler.nodes.extended.StoreHubNode;
 56 import org.graalvm.compiler.nodes.graphbuilderconf.IntrinsicContext;
 57 import org.graalvm.compiler.nodes.memory.Access;
 58 import org.graalvm.compiler.nodes.memory.address.AddressNode;
 59 import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;
 60 import org.graalvm.compiler.nodes.type.StampTool;
 61 import org.graalvm.compiler.replacements.ReplacementsUtil;
 62 import org.graalvm.compiler.replacements.nodes.ReadRegisterNode;
 63 import org.graalvm.compiler.replacements.nodes.WriteRegisterNode;
 64 import org.graalvm.compiler.word.Word;
 65 import jdk.internal.vm.compiler.word.LocationIdentity;
 66 import jdk.internal.vm.compiler.word.WordFactory;
 67 
 68 import jdk.vm.ci.code.Register;
 69 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
 70 import jdk.vm.ci.hotspot.HotSpotMetaspaceConstant;
 71 import jdk.vm.ci.hotspot.HotSpotResolvedObjectType;
 72 import jdk.vm.ci.meta.Assumptions;
 73 import jdk.vm.ci.meta.Assumptions.AssumptionResult;
</pre>
<hr />
<pre>
137             return read;
138         }
139     }
140 
141     @Fold
142     public static ResolvedJavaType methodHolderClass(@InjectedParameter IntrinsicContext context) {
143         return context.getOriginalMethod().getDeclaringClass();
144     }
145 
146     @Fold
147     static ResolvedJavaType getType(@Fold.InjectedParameter IntrinsicContext context, String typeName) {
148         try {
149             UnresolvedJavaType unresolved = UnresolvedJavaType.create(typeName);
150             return unresolved.resolve(methodHolderClass(context));
151         } catch (LinkageError e) {
152             throw new GraalError(e);
153         }
154     }
155 
156     @Fold
<span class="line-modified">157     static int getFieldOffset(ResolvedJavaType type, String fieldName) {</span>
158         for (ResolvedJavaField field : type.getInstanceFields(true)) {
159             if (field.getName().equals(fieldName)) {
160                 return field.getOffset();
161             }
162         }
<span class="line-modified">163         throw new GraalError(&quot;missing field &quot; + fieldName);</span>
164     }
165 
166     public static HotSpotJVMCIRuntime runtime() {
167         return HotSpotJVMCIRuntime.runtime();
168     }
169 
170     @Fold
171     public static int getHeapWordSize(@InjectedParameter GraalHotSpotVMConfig injectedVMConfig) {
172         return injectedVMConfig.heapWordSize;
173     }
174 
175     @Fold
176     public static int klassLayoutHelperNeutralValue(@InjectedParameter GraalHotSpotVMConfig config) {
177         return config.klassLayoutHelperNeutralValue;
178     }
179 
180     @Fold
181     public static boolean useTLAB(@InjectedParameter GraalHotSpotVMConfig config) {
182         return config.useTLAB;
183     }
184 
185     @Fold
186     public static boolean verifyOops(@InjectedParameter GraalHotSpotVMConfig config) {
187         return config.verifyOops;
188     }
189 








190     public static final LocationIdentity EXCEPTION_OOP_LOCATION = NamedLocationIdentity.mutable(&quot;ExceptionOop&quot;);
191 
192     /**
193      * @see GraalHotSpotVMConfig#threadExceptionOopOffset
194      */
195     @Fold
196     public static int threadExceptionOopOffset(@InjectedParameter GraalHotSpotVMConfig config) {
197         return config.threadExceptionOopOffset;
198     }
199 
200     public static final LocationIdentity EXCEPTION_PC_LOCATION = NamedLocationIdentity.mutable(&quot;ExceptionPc&quot;);
201 
202     @Fold
203     public static int threadExceptionPcOffset(@InjectedParameter GraalHotSpotVMConfig config) {
204         return config.threadExceptionPcOffset;
205     }
206 
207     public static final LocationIdentity TLAB_TOP_LOCATION = NamedLocationIdentity.mutable(&quot;TlabTop&quot;);
208 
209     @Fold
</pre>
<hr />
<pre>
282     @SuppressFBWarnings(value = &quot;NP_NULL_PARAM_DEREF_NONVIRTUAL&quot;, justification = &quot;foldable method parameters are injected&quot;)
283     public static Object getPendingException(Word thread) {
284         return thread.readObject(threadPendingExceptionOffset(INJECTED_VMCONFIG), PENDING_EXCEPTION_LOCATION);
285     }
286 
287     /*
288      * As far as Java code is concerned this can be considered immutable: it is set just after the
289      * JavaThread is created, before it is published. After that, it is never changed.
290      */
291     public static final LocationIdentity JAVA_THREAD_THREAD_OBJECT_LOCATION = NamedLocationIdentity.immutable(&quot;JavaThread::_threadObj&quot;);
292 
293     @Fold
294     public static int threadObjectOffset(@InjectedParameter GraalHotSpotVMConfig config) {
295         return config.threadObjectOffset;
296     }
297 
298     public static final LocationIdentity JAVA_THREAD_OSTHREAD_LOCATION = NamedLocationIdentity.mutable(&quot;JavaThread::_osthread&quot;);
299 
300     @Fold
301     public static int osThreadOffset(@InjectedParameter GraalHotSpotVMConfig config) {

302         return config.osThreadOffset;
303     }
304 
305     @Fold
306     public static int osThreadInterruptedOffset(@InjectedParameter GraalHotSpotVMConfig config) {

307         return config.osThreadInterruptedOffset;
308     }
309 
310     @Fold
311     public static JavaKind getWordKind() {
312         return runtime().getHostJVMCIBackend().getCodeCache().getTarget().wordJavaKind;
313     }
314 
315     @Fold
316     public static int wordSize() {
317         return runtime().getHostJVMCIBackend().getCodeCache().getTarget().wordSize;
318     }
319 
320     @Fold
321     public static int pageSize(@InjectedParameter GraalHotSpotVMConfig config) {
322         return config.vmPageSize;
323     }
324 
325     public static final LocationIdentity PROTOTYPE_MARK_WORD_LOCATION = NamedLocationIdentity.mutable(&quot;PrototypeMarkWord&quot;);
326 
</pre>
<hr />
<pre>
499     @Fold
500     public static int objectMonitorOwnerOffset(@InjectedParameter GraalHotSpotVMConfig config) {
501         return config.objectMonitorOwner;
502     }
503 
504     @Fold
505     public static int objectMonitorRecursionsOffset(@InjectedParameter GraalHotSpotVMConfig config) {
506         return config.objectMonitorRecursions;
507     }
508 
509     @Fold
510     public static int objectMonitorCxqOffset(@InjectedParameter GraalHotSpotVMConfig config) {
511         return config.objectMonitorCxq;
512     }
513 
514     @Fold
515     public static int objectMonitorEntryListOffset(@InjectedParameter GraalHotSpotVMConfig config) {
516         return config.objectMonitorEntryList;
517     }
518 





519     /**
520      * Mask for a biasable, locked or unlocked mark word.
521      *
522      * &lt;pre&gt;
523      * +----------------------------------+-+-+
524      * |                                 1|1|1|
525      * +----------------------------------+-+-+
526      * &lt;/pre&gt;
527      *
528      */
529     @Fold
530     public static int biasedLockMaskInPlace(@InjectedParameter GraalHotSpotVMConfig config) {
531         return config.biasedLockMaskInPlace;
532     }
533 
534     @Fold
535     public static int epochMaskInPlace(@InjectedParameter GraalHotSpotVMConfig config) {
536         return config.epochMaskInPlace;
537     }
538 
</pre>
<hr />
<pre>
668         return config.secondarySuperCacheOffset;
669     }
670 
671     public static final LocationIdentity SECONDARY_SUPERS_LOCATION = NamedLocationIdentity.immutable(&quot;SecondarySupers&quot;);
672 
673     @Fold
674     public static int secondarySupersOffset(@InjectedParameter GraalHotSpotVMConfig config) {
675         return config.secondarySupersOffset;
676     }
677 
678     public static final LocationIdentity DISPLACED_MARK_WORD_LOCATION = NamedLocationIdentity.mutable(&quot;DisplacedMarkWord&quot;);
679 
680     public static final LocationIdentity OBJECT_MONITOR_OWNER_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_owner&quot;);
681 
682     public static final LocationIdentity OBJECT_MONITOR_RECURSION_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_recursions&quot;);
683 
684     public static final LocationIdentity OBJECT_MONITOR_CXQ_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_cxq&quot;);
685 
686     public static final LocationIdentity OBJECT_MONITOR_ENTRY_LIST_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_EntryList&quot;);
687 


688     @Fold
689     public static int lockDisplacedMarkOffset(@InjectedParameter GraalHotSpotVMConfig config) {
690         return config.basicLockDisplacedHeaderOffset;
691     }
692 
693     @Fold
694     public static boolean useBiasedLocking(@InjectedParameter GraalHotSpotVMConfig config) {
695         return config.useBiasedLocking;
696     }
697 
698     @Fold
699     static int uninitializedIdentityHashCodeValue(@InjectedParameter GraalHotSpotVMConfig config) {
700         return config.uninitializedIdentityHashCodeValue;
701     }
702 
703     @Fold
704     static int identityHashCodeShift(@InjectedParameter GraalHotSpotVMConfig config) {
705         return config.identityHashCodeShift;
706     }
707 
</pre>
<hr />
<pre>
745      */
746     public static Word registerAsWord(@ConstantNodeParameter Register register) {
747         return registerAsWord(register, true, false);
748     }
749 
750     @NodeIntrinsic(value = ReadRegisterNode.class)
751     public static native Word registerAsWord(@ConstantNodeParameter Register register, @ConstantNodeParameter boolean directUse, @ConstantNodeParameter boolean incoming);
752 
753     @NodeIntrinsic(value = WriteRegisterNode.class)
754     public static native void writeRegisterAsWord(@ConstantNodeParameter Register register, Word value);
755 
756     @NodeIntrinsic(value = RawLoadNode.class)
757     private static native Word loadWordFromObjectIntrinsic(Object object, long offset, @ConstantNodeParameter LocationIdentity locationIdentity, @ConstantNodeParameter JavaKind wordKind);
758 
759     @NodeIntrinsic(value = RawLoadNode.class)
760     private static native KlassPointer loadKlassFromObjectIntrinsic(Object object, long offset, @ConstantNodeParameter LocationIdentity locationIdentity, @ConstantNodeParameter JavaKind wordKind);
761 
762     @NodeIntrinsic(value = LoadHubNode.class)
763     public static native KlassPointer loadHubIntrinsic(Object object);
764 
<span class="line-modified">765     public static final LocationIdentity CLASS_STATE_LOCATION = NamedLocationIdentity.mutable(&quot;ClassState&quot;);</span>





766 
767     @Fold
<span class="line-modified">768     public static int instanceKlassInitStateOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
769         return config.instanceKlassInitStateOffset;
770     }
771 






772     @Fold
773     public static int instanceKlassStateFullyInitialized(@InjectedParameter GraalHotSpotVMConfig config) {
774         return config.instanceKlassStateFullyInitialized;
775     }
776 






777     /**
778      *
779      * @param hub the hub of an InstanceKlass
780      * @return true is the InstanceKlass represented by hub is fully initialized
781      */
782     public static boolean isInstanceKlassFullyInitialized(KlassPointer hub) {
<span class="line-modified">783         return readInstanceKlassState(hub) == instanceKlassStateFullyInitialized(INJECTED_VMCONFIG);</span>
784     }
785 
<span class="line-modified">786     private static byte readInstanceKlassState(KlassPointer hub) {</span>
<span class="line-modified">787         return hub.readByte(instanceKlassInitStateOffset(INJECTED_VMCONFIG), CLASS_STATE_LOCATION);</span>




788     }
789 
790     public static final LocationIdentity KLASS_MODIFIER_FLAGS_LOCATION = NamedLocationIdentity.immutable(&quot;Klass::_modifier_flags&quot;);
791 
792     @Fold
793     public static int klassModifierFlagsOffset(@InjectedParameter GraalHotSpotVMConfig config) {
794         return config.klassModifierFlagsOffset;
795     }
796 
797     public static final LocationIdentity CLASS_KLASS_LOCATION = new HotSpotOptimizingLocationIdentity(&quot;Class._klass&quot;) {
798         @Override
799         public ValueNode canonicalizeRead(ValueNode read, AddressNode location, ValueNode object, CanonicalizerTool tool) {
800             return foldIndirection(read, object, CLASS_MIRROR_LOCATION);
801         }
802     };
803 
804     public static final LocationIdentity CLASS_ARRAY_KLASS_LOCATION = new HotSpotOptimizingLocationIdentity(&quot;Class._array_klass&quot;) {
805         @Override
806         public ValueNode canonicalizeRead(ValueNode read, AddressNode location, ValueNode object, CanonicalizerTool tool) {
807             return foldIndirection(read, object, ARRAY_KLASS_COMPONENT_MIRROR);
</pre>
<hr />
<pre>
833     }
834 
835     @Fold
836     public static int layoutHelperLog2ElementSizeMask(@InjectedParameter GraalHotSpotVMConfig config) {
837         return config.layoutHelperLog2ElementSizeMask;
838     }
839 
840     @NodeIntrinsic(ForeignCallNode.class)
841     public static native int identityHashCode(@ConstantNodeParameter ForeignCallDescriptor descriptor, Object object);
842 
843     @Fold
844     public static long gcTotalCollectionsAddress(@InjectedParameter GraalHotSpotVMConfig config) {
845         return config.gcTotalCollectionsAddress();
846     }
847 
848     @Fold
849     public static long referentOffset(@InjectedParameter MetaAccessProvider metaAccessProvider) {
850         return getFieldOffset(metaAccessProvider.lookupJavaType(Reference.class), &quot;referent&quot;);
851     }
852 





853     public static final LocationIdentity OBJ_ARRAY_KLASS_ELEMENT_KLASS_LOCATION = new HotSpotOptimizingLocationIdentity(&quot;ObjArrayKlass::_element_klass&quot;) {
854         @Override
855         public ValueNode canonicalizeRead(ValueNode read, AddressNode location, ValueNode object, CanonicalizerTool tool) {
856             ValueNode javaObject = findReadHub(object);
857             if (javaObject != null) {
858                 ResolvedJavaType type = StampTool.typeOrNull(javaObject);
859                 if (type != null &amp;&amp; type.isArray()) {
860                     ResolvedJavaType element = type.getComponentType();
861                     if (element != null &amp;&amp; !element.isPrimitive() &amp;&amp; !element.getElementalType().isInterface()) {
862                         Assumptions assumptions = object.graph().getAssumptions();
863                         AssumptionResult&lt;ResolvedJavaType&gt; leafType = element.findLeafConcreteSubtype();
864                         if (leafType != null &amp;&amp; leafType.canRecordTo(assumptions)) {
865                             leafType.recordTo(assumptions);
866                             return ConstantNode.forConstant(read.stamp(NodeView.DEFAULT), tool.getConstantReflection().asObjectHub(leafType.getResult()), tool.getMetaAccess());
867                         }
868                     }
869                 }
870             }
871             return read;
872         }
</pre>
</td>
<td>
<hr />
<pre>
 34 import org.graalvm.compiler.api.replacements.Fold.InjectedParameter;
 35 import org.graalvm.compiler.core.common.SuppressFBWarnings;
 36 import org.graalvm.compiler.core.common.spi.ForeignCallDescriptor;
 37 import org.graalvm.compiler.core.common.type.ObjectStamp;
 38 import org.graalvm.compiler.core.common.type.TypeReference;
 39 import org.graalvm.compiler.debug.GraalError;
 40 import org.graalvm.compiler.graph.Node.ConstantNodeParameter;
 41 import org.graalvm.compiler.graph.Node.NodeIntrinsic;
 42 import org.graalvm.compiler.graph.spi.CanonicalizerTool;
 43 import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
 44 import org.graalvm.compiler.hotspot.word.KlassPointer;
 45 import org.graalvm.compiler.nodes.CanonicalizableLocation;
 46 import org.graalvm.compiler.nodes.CompressionNode;
 47 import org.graalvm.compiler.nodes.ComputeObjectAddressNode;
 48 import org.graalvm.compiler.nodes.ConstantNode;
 49 import org.graalvm.compiler.nodes.NamedLocationIdentity;
 50 import org.graalvm.compiler.nodes.NodeView;
 51 import org.graalvm.compiler.nodes.ValueNode;
 52 import org.graalvm.compiler.nodes.extended.ForeignCallNode;
 53 import org.graalvm.compiler.nodes.extended.LoadHubNode;
<span class="line-added"> 54 import org.graalvm.compiler.nodes.extended.LoadHubOrNullNode;</span>
 55 import org.graalvm.compiler.nodes.extended.RawLoadNode;
 56 import org.graalvm.compiler.nodes.extended.StoreHubNode;
 57 import org.graalvm.compiler.nodes.graphbuilderconf.IntrinsicContext;
 58 import org.graalvm.compiler.nodes.memory.Access;
 59 import org.graalvm.compiler.nodes.memory.address.AddressNode;
 60 import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;
 61 import org.graalvm.compiler.nodes.type.StampTool;
 62 import org.graalvm.compiler.replacements.ReplacementsUtil;
 63 import org.graalvm.compiler.replacements.nodes.ReadRegisterNode;
 64 import org.graalvm.compiler.replacements.nodes.WriteRegisterNode;
 65 import org.graalvm.compiler.word.Word;
 66 import jdk.internal.vm.compiler.word.LocationIdentity;
 67 import jdk.internal.vm.compiler.word.WordFactory;
 68 
 69 import jdk.vm.ci.code.Register;
 70 import jdk.vm.ci.hotspot.HotSpotJVMCIRuntime;
 71 import jdk.vm.ci.hotspot.HotSpotMetaspaceConstant;
 72 import jdk.vm.ci.hotspot.HotSpotResolvedObjectType;
 73 import jdk.vm.ci.meta.Assumptions;
 74 import jdk.vm.ci.meta.Assumptions.AssumptionResult;
</pre>
<hr />
<pre>
138             return read;
139         }
140     }
141 
142     @Fold
143     public static ResolvedJavaType methodHolderClass(@InjectedParameter IntrinsicContext context) {
144         return context.getOriginalMethod().getDeclaringClass();
145     }
146 
147     @Fold
148     static ResolvedJavaType getType(@Fold.InjectedParameter IntrinsicContext context, String typeName) {
149         try {
150             UnresolvedJavaType unresolved = UnresolvedJavaType.create(typeName);
151             return unresolved.resolve(methodHolderClass(context));
152         } catch (LinkageError e) {
153             throw new GraalError(e);
154         }
155     }
156 
157     @Fold
<span class="line-modified">158     public static int getFieldOffset(ResolvedJavaType type, String fieldName) {</span>
159         for (ResolvedJavaField field : type.getInstanceFields(true)) {
160             if (field.getName().equals(fieldName)) {
161                 return field.getOffset();
162             }
163         }
<span class="line-modified">164         throw new GraalError(&quot;missing field &quot; + fieldName + &quot; in type &quot; + type);</span>
165     }
166 
167     public static HotSpotJVMCIRuntime runtime() {
168         return HotSpotJVMCIRuntime.runtime();
169     }
170 
171     @Fold
172     public static int getHeapWordSize(@InjectedParameter GraalHotSpotVMConfig injectedVMConfig) {
173         return injectedVMConfig.heapWordSize;
174     }
175 
176     @Fold
177     public static int klassLayoutHelperNeutralValue(@InjectedParameter GraalHotSpotVMConfig config) {
178         return config.klassLayoutHelperNeutralValue;
179     }
180 
181     @Fold
182     public static boolean useTLAB(@InjectedParameter GraalHotSpotVMConfig config) {
183         return config.useTLAB;
184     }
185 
186     @Fold
187     public static boolean verifyOops(@InjectedParameter GraalHotSpotVMConfig config) {
188         return config.verifyOops;
189     }
190 
<span class="line-added">191     /**</span>
<span class="line-added">192      * @see GraalHotSpotVMConfig#doingUnsafeAccessOffset</span>
<span class="line-added">193      */</span>
<span class="line-added">194     @Fold</span>
<span class="line-added">195     public static int doingUnsafeAccessOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
<span class="line-added">196         return config.doingUnsafeAccessOffset;</span>
<span class="line-added">197     }</span>
<span class="line-added">198 </span>
199     public static final LocationIdentity EXCEPTION_OOP_LOCATION = NamedLocationIdentity.mutable(&quot;ExceptionOop&quot;);
200 
201     /**
202      * @see GraalHotSpotVMConfig#threadExceptionOopOffset
203      */
204     @Fold
205     public static int threadExceptionOopOffset(@InjectedParameter GraalHotSpotVMConfig config) {
206         return config.threadExceptionOopOffset;
207     }
208 
209     public static final LocationIdentity EXCEPTION_PC_LOCATION = NamedLocationIdentity.mutable(&quot;ExceptionPc&quot;);
210 
211     @Fold
212     public static int threadExceptionPcOffset(@InjectedParameter GraalHotSpotVMConfig config) {
213         return config.threadExceptionPcOffset;
214     }
215 
216     public static final LocationIdentity TLAB_TOP_LOCATION = NamedLocationIdentity.mutable(&quot;TlabTop&quot;);
217 
218     @Fold
</pre>
<hr />
<pre>
291     @SuppressFBWarnings(value = &quot;NP_NULL_PARAM_DEREF_NONVIRTUAL&quot;, justification = &quot;foldable method parameters are injected&quot;)
292     public static Object getPendingException(Word thread) {
293         return thread.readObject(threadPendingExceptionOffset(INJECTED_VMCONFIG), PENDING_EXCEPTION_LOCATION);
294     }
295 
296     /*
297      * As far as Java code is concerned this can be considered immutable: it is set just after the
298      * JavaThread is created, before it is published. After that, it is never changed.
299      */
300     public static final LocationIdentity JAVA_THREAD_THREAD_OBJECT_LOCATION = NamedLocationIdentity.immutable(&quot;JavaThread::_threadObj&quot;);
301 
302     @Fold
303     public static int threadObjectOffset(@InjectedParameter GraalHotSpotVMConfig config) {
304         return config.threadObjectOffset;
305     }
306 
307     public static final LocationIdentity JAVA_THREAD_OSTHREAD_LOCATION = NamedLocationIdentity.mutable(&quot;JavaThread::_osthread&quot;);
308 
309     @Fold
310     public static int osThreadOffset(@InjectedParameter GraalHotSpotVMConfig config) {
<span class="line-added">311         assert config.osThreadOffset != Integer.MAX_VALUE;</span>
312         return config.osThreadOffset;
313     }
314 
315     @Fold
316     public static int osThreadInterruptedOffset(@InjectedParameter GraalHotSpotVMConfig config) {
<span class="line-added">317         assert config.osThreadInterruptedOffset != Integer.MAX_VALUE;</span>
318         return config.osThreadInterruptedOffset;
319     }
320 
321     @Fold
322     public static JavaKind getWordKind() {
323         return runtime().getHostJVMCIBackend().getCodeCache().getTarget().wordJavaKind;
324     }
325 
326     @Fold
327     public static int wordSize() {
328         return runtime().getHostJVMCIBackend().getCodeCache().getTarget().wordSize;
329     }
330 
331     @Fold
332     public static int pageSize(@InjectedParameter GraalHotSpotVMConfig config) {
333         return config.vmPageSize;
334     }
335 
336     public static final LocationIdentity PROTOTYPE_MARK_WORD_LOCATION = NamedLocationIdentity.mutable(&quot;PrototypeMarkWord&quot;);
337 
</pre>
<hr />
<pre>
510     @Fold
511     public static int objectMonitorOwnerOffset(@InjectedParameter GraalHotSpotVMConfig config) {
512         return config.objectMonitorOwner;
513     }
514 
515     @Fold
516     public static int objectMonitorRecursionsOffset(@InjectedParameter GraalHotSpotVMConfig config) {
517         return config.objectMonitorRecursions;
518     }
519 
520     @Fold
521     public static int objectMonitorCxqOffset(@InjectedParameter GraalHotSpotVMConfig config) {
522         return config.objectMonitorCxq;
523     }
524 
525     @Fold
526     public static int objectMonitorEntryListOffset(@InjectedParameter GraalHotSpotVMConfig config) {
527         return config.objectMonitorEntryList;
528     }
529 
<span class="line-added">530     @Fold</span>
<span class="line-added">531     public static int objectMonitorSuccOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
<span class="line-added">532         return config.objectMonitorSucc;</span>
<span class="line-added">533     }</span>
<span class="line-added">534 </span>
535     /**
536      * Mask for a biasable, locked or unlocked mark word.
537      *
538      * &lt;pre&gt;
539      * +----------------------------------+-+-+
540      * |                                 1|1|1|
541      * +----------------------------------+-+-+
542      * &lt;/pre&gt;
543      *
544      */
545     @Fold
546     public static int biasedLockMaskInPlace(@InjectedParameter GraalHotSpotVMConfig config) {
547         return config.biasedLockMaskInPlace;
548     }
549 
550     @Fold
551     public static int epochMaskInPlace(@InjectedParameter GraalHotSpotVMConfig config) {
552         return config.epochMaskInPlace;
553     }
554 
</pre>
<hr />
<pre>
684         return config.secondarySuperCacheOffset;
685     }
686 
687     public static final LocationIdentity SECONDARY_SUPERS_LOCATION = NamedLocationIdentity.immutable(&quot;SecondarySupers&quot;);
688 
689     @Fold
690     public static int secondarySupersOffset(@InjectedParameter GraalHotSpotVMConfig config) {
691         return config.secondarySupersOffset;
692     }
693 
694     public static final LocationIdentity DISPLACED_MARK_WORD_LOCATION = NamedLocationIdentity.mutable(&quot;DisplacedMarkWord&quot;);
695 
696     public static final LocationIdentity OBJECT_MONITOR_OWNER_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_owner&quot;);
697 
698     public static final LocationIdentity OBJECT_MONITOR_RECURSION_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_recursions&quot;);
699 
700     public static final LocationIdentity OBJECT_MONITOR_CXQ_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_cxq&quot;);
701 
702     public static final LocationIdentity OBJECT_MONITOR_ENTRY_LIST_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_EntryList&quot;);
703 
<span class="line-added">704     public static final LocationIdentity OBJECT_MONITOR_SUCC_LOCATION = NamedLocationIdentity.mutable(&quot;ObjectMonitor::_succ&quot;);</span>
<span class="line-added">705 </span>
706     @Fold
707     public static int lockDisplacedMarkOffset(@InjectedParameter GraalHotSpotVMConfig config) {
708         return config.basicLockDisplacedHeaderOffset;
709     }
710 
711     @Fold
712     public static boolean useBiasedLocking(@InjectedParameter GraalHotSpotVMConfig config) {
713         return config.useBiasedLocking;
714     }
715 
716     @Fold
717     static int uninitializedIdentityHashCodeValue(@InjectedParameter GraalHotSpotVMConfig config) {
718         return config.uninitializedIdentityHashCodeValue;
719     }
720 
721     @Fold
722     static int identityHashCodeShift(@InjectedParameter GraalHotSpotVMConfig config) {
723         return config.identityHashCodeShift;
724     }
725 
</pre>
<hr />
<pre>
763      */
764     public static Word registerAsWord(@ConstantNodeParameter Register register) {
765         return registerAsWord(register, true, false);
766     }
767 
768     @NodeIntrinsic(value = ReadRegisterNode.class)
769     public static native Word registerAsWord(@ConstantNodeParameter Register register, @ConstantNodeParameter boolean directUse, @ConstantNodeParameter boolean incoming);
770 
771     @NodeIntrinsic(value = WriteRegisterNode.class)
772     public static native void writeRegisterAsWord(@ConstantNodeParameter Register register, Word value);
773 
774     @NodeIntrinsic(value = RawLoadNode.class)
775     private static native Word loadWordFromObjectIntrinsic(Object object, long offset, @ConstantNodeParameter LocationIdentity locationIdentity, @ConstantNodeParameter JavaKind wordKind);
776 
777     @NodeIntrinsic(value = RawLoadNode.class)
778     private static native KlassPointer loadKlassFromObjectIntrinsic(Object object, long offset, @ConstantNodeParameter LocationIdentity locationIdentity, @ConstantNodeParameter JavaKind wordKind);
779 
780     @NodeIntrinsic(value = LoadHubNode.class)
781     public static native KlassPointer loadHubIntrinsic(Object object);
782 
<span class="line-modified">783     @NodeIntrinsic(value = LoadHubOrNullNode.class)</span>
<span class="line-added">784     public static native KlassPointer loadHubOrNullIntrinsic(Object object);</span>
<span class="line-added">785 </span>
<span class="line-added">786     static final LocationIdentity CLASS_INIT_STATE_LOCATION = NamedLocationIdentity.mutable(&quot;ClassInitState&quot;);</span>
<span class="line-added">787 </span>
<span class="line-added">788     static final LocationIdentity CLASS_INIT_THREAD_LOCATION = NamedLocationIdentity.mutable(&quot;ClassInitThread&quot;);</span>
789 
790     @Fold
<span class="line-modified">791     static int instanceKlassInitStateOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
792         return config.instanceKlassInitStateOffset;
793     }
794 
<span class="line-added">795     @Fold</span>
<span class="line-added">796     static int instanceKlassInitThreadOffset(@InjectedParameter GraalHotSpotVMConfig config) {</span>
<span class="line-added">797         assert config.instanceKlassInitThreadOffset != -1;</span>
<span class="line-added">798         return config.instanceKlassInitThreadOffset;</span>
<span class="line-added">799     }</span>
<span class="line-added">800 </span>
801     @Fold
802     public static int instanceKlassStateFullyInitialized(@InjectedParameter GraalHotSpotVMConfig config) {
803         return config.instanceKlassStateFullyInitialized;
804     }
805 
<span class="line-added">806     @Fold</span>
<span class="line-added">807     public static int instanceKlassStateBeingInitialized(@InjectedParameter GraalHotSpotVMConfig config) {</span>
<span class="line-added">808         assert config.instanceKlassStateBeingInitialized != -1;</span>
<span class="line-added">809         return config.instanceKlassStateBeingInitialized;</span>
<span class="line-added">810     }</span>
<span class="line-added">811 </span>
812     /**
813      *
814      * @param hub the hub of an InstanceKlass
815      * @return true is the InstanceKlass represented by hub is fully initialized
816      */
817     public static boolean isInstanceKlassFullyInitialized(KlassPointer hub) {
<span class="line-modified">818         return readInstanceKlassInitState(hub) == instanceKlassStateFullyInitialized(INJECTED_VMCONFIG);</span>
819     }
820 
<span class="line-modified">821     static byte readInstanceKlassInitState(KlassPointer hub) {</span>
<span class="line-modified">822         return hub.readByte(instanceKlassInitStateOffset(INJECTED_VMCONFIG), CLASS_INIT_STATE_LOCATION);</span>
<span class="line-added">823     }</span>
<span class="line-added">824 </span>
<span class="line-added">825     static Word readInstanceKlassInitThread(KlassPointer hub) {</span>
<span class="line-added">826         return hub.readWord(instanceKlassInitThreadOffset(INJECTED_VMCONFIG), CLASS_INIT_THREAD_LOCATION);</span>
827     }
828 
829     public static final LocationIdentity KLASS_MODIFIER_FLAGS_LOCATION = NamedLocationIdentity.immutable(&quot;Klass::_modifier_flags&quot;);
830 
831     @Fold
832     public static int klassModifierFlagsOffset(@InjectedParameter GraalHotSpotVMConfig config) {
833         return config.klassModifierFlagsOffset;
834     }
835 
836     public static final LocationIdentity CLASS_KLASS_LOCATION = new HotSpotOptimizingLocationIdentity(&quot;Class._klass&quot;) {
837         @Override
838         public ValueNode canonicalizeRead(ValueNode read, AddressNode location, ValueNode object, CanonicalizerTool tool) {
839             return foldIndirection(read, object, CLASS_MIRROR_LOCATION);
840         }
841     };
842 
843     public static final LocationIdentity CLASS_ARRAY_KLASS_LOCATION = new HotSpotOptimizingLocationIdentity(&quot;Class._array_klass&quot;) {
844         @Override
845         public ValueNode canonicalizeRead(ValueNode read, AddressNode location, ValueNode object, CanonicalizerTool tool) {
846             return foldIndirection(read, object, ARRAY_KLASS_COMPONENT_MIRROR);
</pre>
<hr />
<pre>
872     }
873 
874     @Fold
875     public static int layoutHelperLog2ElementSizeMask(@InjectedParameter GraalHotSpotVMConfig config) {
876         return config.layoutHelperLog2ElementSizeMask;
877     }
878 
879     @NodeIntrinsic(ForeignCallNode.class)
880     public static native int identityHashCode(@ConstantNodeParameter ForeignCallDescriptor descriptor, Object object);
881 
882     @Fold
883     public static long gcTotalCollectionsAddress(@InjectedParameter GraalHotSpotVMConfig config) {
884         return config.gcTotalCollectionsAddress();
885     }
886 
887     @Fold
888     public static long referentOffset(@InjectedParameter MetaAccessProvider metaAccessProvider) {
889         return getFieldOffset(metaAccessProvider.lookupJavaType(Reference.class), &quot;referent&quot;);
890     }
891 
<span class="line-added">892     @Fold</span>
<span class="line-added">893     public static ResolvedJavaType referenceType(@InjectedParameter MetaAccessProvider metaAccessProvider) {</span>
<span class="line-added">894         return metaAccessProvider.lookupJavaType(Reference.class);</span>
<span class="line-added">895     }</span>
<span class="line-added">896 </span>
897     public static final LocationIdentity OBJ_ARRAY_KLASS_ELEMENT_KLASS_LOCATION = new HotSpotOptimizingLocationIdentity(&quot;ObjArrayKlass::_element_klass&quot;) {
898         @Override
899         public ValueNode canonicalizeRead(ValueNode read, AddressNode location, ValueNode object, CanonicalizerTool tool) {
900             ValueNode javaObject = findReadHub(object);
901             if (javaObject != null) {
902                 ResolvedJavaType type = StampTool.typeOrNull(javaObject);
903                 if (type != null &amp;&amp; type.isArray()) {
904                     ResolvedJavaType element = type.getComponentType();
905                     if (element != null &amp;&amp; !element.isPrimitive() &amp;&amp; !element.getElementalType().isInterface()) {
906                         Assumptions assumptions = object.graph().getAssumptions();
907                         AssumptionResult&lt;ResolvedJavaType&gt; leafType = element.findLeafConcreteSubtype();
908                         if (leafType != null &amp;&amp; leafType.canRecordTo(assumptions)) {
909                             leafType.recordTo(assumptions);
910                             return ConstantNode.forConstant(read.stamp(NodeView.DEFAULT), tool.getConstantReflection().asObjectHub(leafType.getResult()), tool.getMetaAccess());
911                         }
912                     }
913                 }
914             }
915             return read;
916         }
</pre>
</td>
</tr>
</table>
<center><a href="HotSpotClassSubstitutions.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="IdentityHashCodeNode.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>