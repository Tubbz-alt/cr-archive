<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.serviceprovider/src/org/graalvm/compiler/serviceprovider/GraalServices.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../org.graalvm.compiler.replacements/src/org/graalvm/compiler/replacements/nodes/arithmetic/UnsignedMulHighNode.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JavaVersionUtil.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.serviceprovider/src/org/graalvm/compiler/serviceprovider/GraalServices.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -27,37 +27,107 @@</span>
  import static java.lang.Thread.currentThread;
  
  import java.io.IOException;
  import java.io.InputStream;
  import java.util.Arrays;
<span class="udiff-line-added">+ import java.util.ArrayList;</span>
<span class="udiff-line-added">+ import java.util.HashMap;</span>
  import java.util.Iterator;
  import java.util.List;
<span class="udiff-line-added">+ import java.util.Map;</span>
  import java.util.ServiceConfigurationError;
  import java.util.ServiceLoader;
  import java.util.concurrent.atomic.AtomicLong;
<span class="udiff-line-added">+ import java.util.function.Supplier;</span>
  
<span class="udiff-line-added">+ import org.graalvm.compiler.serviceprovider.SpeculationReasonGroup.SpeculationContextObject;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ import jdk.vm.ci.code.BytecodePosition;</span>
<span class="udiff-line-added">+ import jdk.vm.ci.code.VirtualObject;</span>
<span class="udiff-line-added">+ import jdk.vm.ci.meta.ResolvedJavaField;</span>
<span class="udiff-line-added">+ import jdk.vm.ci.meta.ResolvedJavaMethod;</span>
<span class="udiff-line-added">+ import jdk.vm.ci.meta.ResolvedJavaType;</span>
  import jdk.vm.ci.meta.SpeculationLog.SpeculationReason;
<span class="udiff-line-added">+ import jdk.vm.ci.meta.SpeculationLog.SpeculationReasonEncoding;</span>
  import jdk.vm.ci.runtime.JVMCI;
  import jdk.vm.ci.services.JVMCIPermission;
  import jdk.vm.ci.services.Services;
  
<span class="udiff-line-added">+ import static jdk.vm.ci.services.Services.IS_IN_NATIVE_IMAGE;</span>
<span class="udiff-line-added">+ import static jdk.vm.ci.services.Services.IS_BUILDING_NATIVE_IMAGE;</span>
<span class="udiff-line-added">+ </span>
  /**
<span class="udiff-line-modified-removed">-  * Interface to functionality that abstracts over which JDK version Graal is running on.</span>
<span class="udiff-line-modified-added">+  * JDK 13+ version of {@link GraalServices}.</span>
   */
  public final class GraalServices {
  
<span class="udiff-line-added">+     private static final Map&lt;Class&lt;?&gt;, List&lt;?&gt;&gt; servicesCache = IS_BUILDING_NATIVE_IMAGE ? new HashMap&lt;&gt;() : null;</span>
<span class="udiff-line-added">+ </span>
      private GraalServices() {
      }
  
      /**
       * Gets an {@link Iterable} of the providers available for a given service.
       *
       * @throws SecurityException if on JDK8 and a security manager is present and it denies
       *             {@link JVMCIPermission}
       */
<span class="udiff-line-added">+     @SuppressWarnings(&quot;unchecked&quot;)</span>
      public static &lt;S&gt; Iterable&lt;S&gt; load(Class&lt;S&gt; service) {
<span class="udiff-line-modified-removed">-         Iterable&lt;S&gt; iterable = ServiceLoader.load(service);</span>
<span class="udiff-line-modified-added">+         if (IS_IN_NATIVE_IMAGE || IS_BUILDING_NATIVE_IMAGE) {</span>
<span class="udiff-line-added">+             List&lt;?&gt; list = servicesCache.get(service);</span>
<span class="udiff-line-added">+             if (list != null) {</span>
<span class="udiff-line-added">+                 return (Iterable&lt;S&gt;) list;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (IS_IN_NATIVE_IMAGE) {</span>
<span class="udiff-line-added">+                 throw new InternalError(String.format(&quot;No %s providers found when building native image&quot;, service.getName()));</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Iterable&lt;S&gt; providers = load0(service);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (IS_BUILDING_NATIVE_IMAGE) {</span>
<span class="udiff-line-added">+             synchronized (servicesCache) {</span>
<span class="udiff-line-added">+                 ArrayList&lt;S&gt; providersList = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-added">+                 for (S provider : providers) {</span>
<span class="udiff-line-added">+                     Module module = provider.getClass().getModule();</span>
<span class="udiff-line-added">+                     if (isHotSpotGraalModule(module.getName())) {</span>
<span class="udiff-line-added">+                         providersList.add(provider);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 providers = providersList;</span>
<span class="udiff-line-added">+                 servicesCache.put(service, providersList);</span>
<span class="udiff-line-added">+                 return providers;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return providers;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Determines if the module named by {@code name} is part of Graal when it is configured as a</span>
<span class="udiff-line-added">+      * HotSpot JIT compiler.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     private static boolean isHotSpotGraalModule(String name) {</span>
<span class="udiff-line-added">+         if (name != null) {</span>
<span class="udiff-line-added">+             return name.equals(&quot;jdk.internal.vm.compiler&quot;) ||</span>
<span class="udiff-line-added">+                             name.equals(&quot;jdk.internal.vm.compiler.management&quot;) ||</span>
<span class="udiff-line-added">+                             name.equals(&quot;com.oracle.graal.graal_enterprise&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     protected static &lt;S&gt; Iterable&lt;S&gt; load0(Class&lt;S&gt; service) {</span>
<span class="udiff-line-added">+         Module module = GraalServices.class.getModule();</span>
<span class="udiff-line-added">+         // Graal cannot know all the services used by another module</span>
<span class="udiff-line-added">+         // (e.g. enterprise) so dynamically register the service use now.</span>
<span class="udiff-line-added">+         if (!module.canUse(service)) {</span>
<span class="udiff-line-added">+             module.addUses(service);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         ModuleLayer layer = module.getLayer();</span>
<span class="udiff-line-added">+         Iterable&lt;S&gt; iterable = ServiceLoader.load(layer, service);</span>
          return new Iterable&lt;&gt;() {
              @Override
              public Iterator&lt;S&gt; iterator() {
                  Iterator&lt;S&gt; iterator = iterable.iterator();
                  return new Iterator&lt;&gt;() {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -88,19 +158,23 @@</span>
       * opened all its packages to the module defining {@link GraalServices}.
       *
       * @param other all JVMCI packages will be opened to the module defining this class
       */
      static void openJVMCITo(Class&lt;?&gt; other) {
<span class="udiff-line-added">+         if (IS_IN_NATIVE_IMAGE) {</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          Module jvmciModule = JVMCI_MODULE;
          Module otherModule = other.getModule();
          if (jvmciModule != otherModule) {
              for (String pkg : jvmciModule.getPackages()) {
                  if (!jvmciModule.isOpen(pkg, otherModule)) {
                      // JVMCI initialization opens all JVMCI packages
                      // to Graal which is a prerequisite for Graal to
                      // open JVMCI packages to other modules.
<span class="udiff-line-modified-removed">-                     JVMCI.initialize();</span>
<span class="udiff-line-modified-added">+                     JVMCI.getRuntime();</span>
  
                      jvmciModule.addOpens(pkg, otherModule);
                  }
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -160,10 +234,14 @@</span>
      /**
       * Determines if invoking {@link Object#toString()} on an instance of {@code c} will only run
       * trusted code.
       */
      public static boolean isToStringTrusted(Class&lt;?&gt; c) {
<span class="udiff-line-added">+         if (IS_IN_NATIVE_IMAGE) {</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          Module module = c.getModule();
          Module jvmciModule = JVMCI_MODULE;
          assert jvmciModule.getPackages().contains(&quot;jdk.vm.ci.runtime&quot;);
          if (module == jvmciModule || jvmciModule.isOpen(JVMCI_RUNTIME_PACKAGE, module)) {
              // Can access non-statically-exported package in JVMCI
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -177,10 +255,11 @@</span>
       */
      static final class DirectSpeculationReason implements SpeculationReason {
          final int groupId;
          final String groupName;
          final Object[] context;
<span class="udiff-line-added">+         private SpeculationReasonEncoding encoding;</span>
  
          DirectSpeculationReason(int groupId, String groupName, Object[] context) {
              this.groupId = groupId;
              this.groupName = groupName;
              this.context = context;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -202,10 +281,127 @@</span>
  
          @Override
          public String toString() {
              return String.format(&quot;%s@%d%s&quot;, groupName, groupId, Arrays.toString(context));
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public SpeculationReasonEncoding encode(Supplier&lt;SpeculationReasonEncoding&gt; encodingSupplier) {</span>
<span class="udiff-line-added">+             if (encoding == null) {</span>
<span class="udiff-line-added">+                 encoding = encodingSupplier.get();</span>
<span class="udiff-line-added">+                 encoding.addInt(groupId);</span>
<span class="udiff-line-added">+                 for (Object o : context) {</span>
<span class="udiff-line-added">+                     if (o == null) {</span>
<span class="udiff-line-added">+                         encoding.addInt(0);</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         addNonNullObject(encoding, o);</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return encoding;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         static void addNonNullObject(SpeculationReasonEncoding encoding, Object o) {</span>
<span class="udiff-line-added">+             Class&lt;? extends Object&gt; c = o.getClass();</span>
<span class="udiff-line-added">+             if (c == String.class) {</span>
<span class="udiff-line-added">+                 encoding.addString((String) o);</span>
<span class="udiff-line-added">+             } else if (c == Byte.class) {</span>
<span class="udiff-line-added">+                 encoding.addByte((Byte) o);</span>
<span class="udiff-line-added">+             } else if (c == Short.class) {</span>
<span class="udiff-line-added">+                 encoding.addShort((Short) o);</span>
<span class="udiff-line-added">+             } else if (c == Character.class) {</span>
<span class="udiff-line-added">+                 encoding.addShort((Character) o);</span>
<span class="udiff-line-added">+             } else if (c == Integer.class) {</span>
<span class="udiff-line-added">+                 encoding.addInt((Integer) o);</span>
<span class="udiff-line-added">+             } else if (c == Long.class) {</span>
<span class="udiff-line-added">+                 encoding.addLong((Long) o);</span>
<span class="udiff-line-added">+             } else if (c == Float.class) {</span>
<span class="udiff-line-added">+                 encoding.addInt(Float.floatToRawIntBits((Float) o));</span>
<span class="udiff-line-added">+             } else if (c == Double.class) {</span>
<span class="udiff-line-added">+                 encoding.addLong(Double.doubleToRawLongBits((Double) o));</span>
<span class="udiff-line-added">+             } else if (o instanceof Enum) {</span>
<span class="udiff-line-added">+                 encoding.addInt(((Enum&lt;?&gt;) o).ordinal());</span>
<span class="udiff-line-added">+             } else if (o instanceof ResolvedJavaMethod) {</span>
<span class="udiff-line-added">+                 encoding.addMethod((ResolvedJavaMethod) o);</span>
<span class="udiff-line-added">+             } else if (o instanceof ResolvedJavaType) {</span>
<span class="udiff-line-added">+                 encoding.addType((ResolvedJavaType) o);</span>
<span class="udiff-line-added">+             } else if (o instanceof ResolvedJavaField) {</span>
<span class="udiff-line-added">+                 encoding.addField((ResolvedJavaField) o);</span>
<span class="udiff-line-added">+             } else if (o instanceof SpeculationContextObject) {</span>
<span class="udiff-line-added">+                 SpeculationContextObject sco = (SpeculationContextObject) o;</span>
<span class="udiff-line-added">+                 // These are compiler objects which all have the same class</span>
<span class="udiff-line-added">+                 // loader so the class name uniquely identifies the class.</span>
<span class="udiff-line-added">+                 encoding.addString(o.getClass().getName());</span>
<span class="udiff-line-added">+                 sco.accept(new EncodingAdapter(encoding));</span>
<span class="udiff-line-added">+             } else if (o.getClass() == BytecodePosition.class) {</span>
<span class="udiff-line-added">+                 BytecodePosition p = (BytecodePosition) o;</span>
<span class="udiff-line-added">+                 while (p != null) {</span>
<span class="udiff-line-added">+                     encoding.addInt(p.getBCI());</span>
<span class="udiff-line-added">+                     encoding.addMethod(p.getMethod());</span>
<span class="udiff-line-added">+                     p = p.getCaller();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 throw new IllegalArgumentException(&quot;Unsupported type for encoding: &quot; + c.getName());</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static class EncodingAdapter implements SpeculationContextObject.Visitor {</span>
<span class="udiff-line-added">+         private final SpeculationReasonEncoding encoding;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         EncodingAdapter(SpeculationReasonEncoding encoding) {</span>
<span class="udiff-line-added">+             this.encoding = encoding;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void visitBoolean(boolean v) {</span>
<span class="udiff-line-added">+             encoding.addByte(v ? 1 : 0);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void visitByte(byte v) {</span>
<span class="udiff-line-added">+             encoding.addByte(v);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void visitChar(char v) {</span>
<span class="udiff-line-added">+             encoding.addShort(v);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void visitShort(short v) {</span>
<span class="udiff-line-added">+             encoding.addInt(v);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void visitInt(int v) {</span>
<span class="udiff-line-added">+             encoding.addInt(v);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void visitLong(long v) {</span>
<span class="udiff-line-added">+             encoding.addLong(v);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void visitFloat(float v) {</span>
<span class="udiff-line-added">+             encoding.addInt(Float.floatToRawIntBits(v));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void visitDouble(double v) {</span>
<span class="udiff-line-added">+             encoding.addLong(Double.doubleToRawLongBits(v));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public void visitObject(Object v) {</span>
<span class="udiff-line-added">+             if (v == null) {</span>
<span class="udiff-line-added">+                 encoding.addInt(0);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 DirectSpeculationReason.addNonNullObject(encoding, v);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
      }
  
      static SpeculationReason createSpeculationReason(int groupId, String groupName, Object... context) {
          return new DirectSpeculationReason(groupId, groupName, context);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -334,6 +530,28 @@</span>
          if (jmx == null) {
              return null;
          }
          return jmx.getInputArguments();
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Returns the fused multiply add of the three arguments; that is, returns the exact product of</span>
<span class="udiff-line-added">+      * the first two arguments summed with the third argument and then rounded once to the nearest</span>
<span class="udiff-line-added">+      * {@code float}.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public static float fma(float a, float b, float c) {</span>
<span class="udiff-line-added">+         return Math.fma(a, b, c);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Returns the fused multiply add of the three arguments; that is, returns the exact product of</span>
<span class="udiff-line-added">+      * the first two arguments summed with the third argument and then rounded once to the nearest</span>
<span class="udiff-line-added">+      * {@code double}.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public static double fma(double a, double b, double c) {</span>
<span class="udiff-line-added">+         return Math.fma(a, b, c);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static VirtualObject createVirtualObject(ResolvedJavaType type, int id, boolean isAutoBox) {</span>
<span class="udiff-line-added">+         return VirtualObject.get(type, id, isAutoBox);</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../../../../../../org.graalvm.compiler.replacements/src/org/graalvm/compiler/replacements/nodes/arithmetic/UnsignedMulHighNode.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="JavaVersionUtil.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>