<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/GraphPrinterDumpHandler.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GraphPrinter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../org.graalvm.compiler.replacements.aarch64/src/org/graalvm/compiler/replacements/aarch64/AArch64GraphBuilderPlugins.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/GraphPrinterDumpHandler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -35,25 +35,27 @@</span>
  import java.util.HashMap;
  import java.util.List;
  import java.util.Map;
  import java.util.WeakHashMap;
  
<span class="udiff-line-added">+ import org.graalvm.compiler.core.common.CompilationIdentifier;</span>
  import org.graalvm.compiler.debug.DebugContext;
  import org.graalvm.compiler.debug.DebugDumpHandler;
  import org.graalvm.compiler.debug.DebugDumpScope;
  import org.graalvm.compiler.debug.DebugOptions;
<span class="udiff-line-added">+ import org.graalvm.compiler.debug.DebugOptions.PrintGraphTarget;</span>
  import org.graalvm.compiler.debug.GraalError;
  import org.graalvm.compiler.debug.TTY;
<span class="udiff-line-removed">- import org.graalvm.compiler.debug.DebugOptions.PrintGraphTarget;</span>
  import org.graalvm.compiler.graph.Graph;
  import org.graalvm.compiler.nodes.StructuredGraph;
  import org.graalvm.compiler.options.OptionValues;
  import org.graalvm.compiler.phases.contract.NodeCostUtil;
  import org.graalvm.compiler.serviceprovider.GraalServices;
  
  import jdk.vm.ci.meta.JavaMethod;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
<span class="udiff-line-added">+ import jdk.vm.ci.services.Services;</span>
  
  //JaCoCo Exclude
  
  /**
   * Observes compilation events and uses {@link BinaryGraphPrinter} to generate a graph
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -63,10 +65,11 @@</span>
  
      private static final int FAILURE_LIMIT = 8;
      private final GraphPrinterSupplier printerSupplier;
      protected GraphPrinter printer;
      private List&lt;String&gt; previousInlineContext;
<span class="udiff-line-added">+     private CompilationIdentifier previousCompilationID = CompilationIdentifier.INVALID_COMPILATION_ID;</span>
      private int[] dumpIds = {};
      private int failuresCount;
      private Map&lt;Graph, List&lt;String&gt;&gt; inlineContextMap;
      private final String jvmArguments;
      private final String sunJavaCommand;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -84,11 +87,11 @@</span>
       */
      public GraphPrinterDumpHandler(GraphPrinterSupplier printerSupplier) {
          this.printerSupplier = printerSupplier;
          /* Add the JVM and Java arguments to the graph properties to help identify it. */
          this.jvmArguments = jvmArguments();
<span class="udiff-line-modified-removed">-         this.sunJavaCommand = System.getProperty(&quot;sun.java.command&quot;);</span>
<span class="udiff-line-modified-added">+         this.sunJavaCommand = Services.getSavedProperties().get(&quot;sun.java.command&quot;);</span>
      }
  
      private static String jvmArguments() {
          List&lt;String&gt; inputArguments = GraalServices.getInputArguments();
          if (inputArguments != null) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -133,40 +136,46 @@</span>
              }
  
              // Get all current JavaMethod instances in the context.
              List&lt;String&gt; inlineContext = getInlineContext(graph);
  
<span class="udiff-line-modified-removed">-             if (inlineContext != previousInlineContext) {</span>
<span class="udiff-line-modified-added">+             if (graph instanceof StructuredGraph) {</span>
<span class="udiff-line-added">+                 CompilationIdentifier compilationID = ((StructuredGraph) graph).compilationId();</span>
<span class="udiff-line-added">+                 // If the graph to be dumped is with an invalid compilation id, it is likely derived</span>
<span class="udiff-line-added">+                 // from inlining.</span>
<span class="udiff-line-added">+                 if (compilationID != CompilationIdentifier.INVALID_COMPILATION_ID) {</span>
<span class="udiff-line-added">+                     if (previousCompilationID != CompilationIdentifier.INVALID_COMPILATION_ID &amp;&amp; !compilationID.equals(previousCompilationID)) {</span>
<span class="udiff-line-added">+                         // Compilation ID does not match, close existing scopes.</span>
<span class="udiff-line-added">+                         for (int inlineDepth = previousInlineContext.size() - 1; inlineDepth &gt;= 0; --inlineDepth) {</span>
<span class="udiff-line-added">+                             closeScope(debug, inlineDepth);</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         previousInlineContext = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     previousCompilationID = compilationID;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (!inlineContext.equals(previousInlineContext)) {</span>
                  Map&lt;Object, Object&gt; properties = new HashMap&lt;&gt;();
                  properties.put(&quot;graph&quot;, graph.toString());
                  addCompilationId(properties, graph);
<span class="udiff-line-modified-removed">-                 if (inlineContext.equals(previousInlineContext)) {</span>
<span class="udiff-line-modified-removed">-                     /*</span>
<span class="udiff-line-modified-removed">-                      * two different graphs have the same inline context, so make sure they appear</span>
<span class="udiff-line-modified-removed">-                      * in different folders by closing and reopening the top scope.</span>
<span class="udiff-line-modified-removed">-                      */</span>
<span class="udiff-line-removed">-                     int inlineDepth = previousInlineContext.size() - 1;</span>
<span class="udiff-line-removed">-                     closeScope(debug, inlineDepth);</span>
<span class="udiff-line-removed">-                     openScope(debug, inlineContext.get(inlineDepth), inlineDepth, properties);</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     // Check for method scopes that must be closed since the previous dump.</span>
<span class="udiff-line-removed">-                     for (int i = 0; i &lt; previousInlineContext.size(); ++i) {</span>
<span class="udiff-line-removed">-                         if (i &gt;= inlineContext.size() || !inlineContext.get(i).equals(previousInlineContext.get(i))) {</span>
<span class="udiff-line-removed">-                             for (int inlineDepth = previousInlineContext.size() - 1; inlineDepth &gt;= i; --inlineDepth) {</span>
<span class="udiff-line-removed">-                                 closeScope(debug, inlineDepth);</span>
<span class="udiff-line-removed">-                             }</span>
<span class="udiff-line-removed">-                             break;</span>
<span class="udiff-line-modified-added">+                 // Check for method scopes that must be closed since the previous dump.</span>
<span class="udiff-line-modified-added">+                 for (int i = 0; i &lt; previousInlineContext.size(); ++i) {</span>
<span class="udiff-line-modified-added">+                     if (i &gt;= inlineContext.size() || !inlineContext.get(i).equals(previousInlineContext.get(i))) {</span>
<span class="udiff-line-modified-added">+                         for (int inlineDepth = previousInlineContext.size() - 1; inlineDepth &gt;= i; --inlineDepth) {</span>
<span class="udiff-line-modified-added">+                             closeScope(debug, inlineDepth);</span>
                          }
<span class="udiff-line-added">+                         break;</span>
                      }
<span class="udiff-line-modified-removed">-                     // Check for method scopes that must be opened since the previous dump.</span>
<span class="udiff-line-modified-removed">-                     for (int i = 0; i &lt; inlineContext.size(); ++i) {</span>
<span class="udiff-line-modified-removed">-                         if (i &gt;= previousInlineContext.size() || !inlineContext.get(i).equals(previousInlineContext.get(i))) {</span>
<span class="udiff-line-modified-removed">-                             for (int inlineDepth = i; inlineDepth &lt; inlineContext.size(); ++inlineDepth) {</span>
<span class="udiff-line-modified-removed">-                                 openScope(debug, inlineContext.get(inlineDepth), inlineDepth, inlineDepth == inlineContext.size() - 1 ? properties : null);</span>
<span class="udiff-line-modified-removed">-                             }</span>
<span class="udiff-line-removed">-                             break;</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-modified-added">+                 // Check for method scopes that must be opened since the previous dump.</span>
<span class="udiff-line-modified-added">+                 for (int i = 0; i &lt; inlineContext.size(); ++i) {</span>
<span class="udiff-line-modified-added">+                     if (i &gt;= previousInlineContext.size() || !inlineContext.get(i).equals(previousInlineContext.get(i))) {</span>
<span class="udiff-line-modified-added">+                         for (int inlineDepth = i; inlineDepth &lt; inlineContext.size(); ++inlineDepth) {</span>
<span class="udiff-line-modified-added">+                             openScope(debug, inlineContext.get(inlineDepth), inlineDepth, inlineDepth == inlineContext.size() - 1 ? properties : null);</span>
                          }
<span class="udiff-line-added">+                         break;</span>
                      }
                  }
              }
  
              // Save inline context for next dump.
</pre>
<center><a href="GraphPrinter.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../org.graalvm.compiler.replacements.aarch64/src/org/graalvm/compiler/replacements/aarch64/AArch64GraphBuilderPlugins.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>