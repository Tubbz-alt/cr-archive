<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/CFGPrinterObserver.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="BinaryGraphPrinter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="GraalDebugHandlersFactory.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/CFGPrinterObserver.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 47 import org.graalvm.compiler.debug.DebugContext;
 48 import org.graalvm.compiler.debug.DebugDumpHandler;
 49 import org.graalvm.compiler.debug.DebugDumpScope;
 50 import org.graalvm.compiler.debug.GraalError;
 51 import org.graalvm.compiler.debug.TTY;
 52 import org.graalvm.compiler.graph.Graph;
 53 import org.graalvm.compiler.java.BciBlockMapping;
 54 import org.graalvm.compiler.lir.LIR;
 55 import org.graalvm.compiler.lir.debug.IntervalDumper;
 56 import org.graalvm.compiler.lir.gen.LIRGenerationResult;
 57 import org.graalvm.compiler.nodes.StructuredGraph;
 58 import org.graalvm.compiler.nodes.StructuredGraph.ScheduleResult;
 59 import org.graalvm.compiler.nodes.cfg.ControlFlowGraph;
 60 import org.graalvm.compiler.options.OptionValues;
 61 import org.graalvm.compiler.serviceprovider.GraalServices;
 62 
 63 import jdk.vm.ci.code.CodeCacheProvider;
 64 import jdk.vm.ci.code.InstalledCode;
 65 import jdk.vm.ci.meta.JavaMethod;
 66 import jdk.vm.ci.meta.ResolvedJavaMethod;

 67 
 68 /**
 69  * Observes compilation events and uses {@link CFGPrinter} to produce a control flow graph for the
 70  * &lt;a href=&quot;http://java.net/projects/c1visualizer/&quot;&gt;C1 Visualizer&lt;/a&gt;.
 71  */
 72 public class CFGPrinterObserver implements DebugDumpHandler {
 73 
 74     private CFGPrinter cfgPrinter;
 75     private File cfgFile;
 76     private JavaMethod curMethod;
 77     private CompilationIdentifier curCompilation;
 78     private List&lt;String&gt; curDecorators = Collections.emptyList();
 79 
 80     @Override
 81     public void dump(DebugContext debug, Object object, String format, Object... arguments) {
 82         String message = String.format(format, arguments);
 83         try {
 84             dumpSandboxed(debug, object, message);
 85         } catch (Throwable ex) {
 86             TTY.println(&quot;CFGPrinter: Exception during output of &quot; + message + &quot;: &quot; + ex);
</pre>
<hr />
<pre>
193             if (object instanceof BciBlockMapping) {
194                 BciBlockMapping blockMap = (BciBlockMapping) object;
195                 cfgPrinter.printCFG(message, blockMap);
196                 if (blockMap.code.getCode() != null) {
197                     cfgPrinter.printBytecodes(new BytecodeDisassembler(false).disassemble(blockMap.code));
198                 }
199 
200             } else if (object instanceof LIR) {
201                 // Currently no node printing for lir
202                 cfgPrinter.printCFG(message, cfgPrinter.lir.codeEmittingOrder(), false);
203                 lastLIR = (LIR) object;
204                 if (delayedIntervals != null) {
205                     cfgPrinter.printIntervals(message, delayedIntervals);
206                     delayedIntervals = null;
207                 }
208             } else if (object instanceof ScheduleResult) {
209                 cfgPrinter.printSchedule(message, (ScheduleResult) object);
210             } else if (object instanceof StructuredGraph) {
211                 if (cfgPrinter.cfg == null) {
212                     StructuredGraph graph = (StructuredGraph) object;
<span class="line-modified">213                     cfgPrinter.cfg = ControlFlowGraph.compute(graph, true, true, true, false);</span>
<span class="line-modified">214                     cfgPrinter.printCFG(message, cfgPrinter.cfg.getBlocks(), true);</span>
<span class="line-modified">215                 } else {</span>



216                     cfgPrinter.printCFG(message, cfgPrinter.cfg.getBlocks(), true);
217                 }
<span class="line-removed">218 </span>
219             } else if (object instanceof CompilationResult) {
220                 final CompilationResult compResult = (CompilationResult) object;
221                 cfgPrinter.printMachineCode(disassemble(codeCache, compResult, null), message);
222             } else if (object instanceof InstalledCode) {
223                 CompilationResult compResult = debug.contextLookup(CompilationResult.class);
224                 if (compResult != null) {
225                     cfgPrinter.printMachineCode(disassemble(codeCache, compResult, (InstalledCode) object), message);
226                 }
227             } else if (object instanceof IntervalDumper) {
228                 if (lastLIR == cfgPrinter.lir) {
229                     cfgPrinter.printIntervals(message, (IntervalDumper) object);
230                 } else {
231                     if (delayedIntervals != null) {
232                         debug.log(&quot;Some delayed intervals were dropped (%s)&quot;, delayedIntervals);
233                     }
234                     delayedIntervals = (IntervalDumper) object;
235                 }
236             } else if (object instanceof AbstractBlockBase&lt;?&gt;[]) {
237                 cfgPrinter.printCFG(message, (AbstractBlockBase&lt;?&gt;[]) object, false);
238             } else if (object instanceof Trace) {
239                 cfgPrinter.printCFG(message, ((Trace) object).getBlocks(), false);
240             } else if (object instanceof TraceBuilderResult) {
241                 cfgPrinter.printTraces(message, (TraceBuilderResult) object);
242             }
243         } finally {
244             cfgPrinter.target = null;
245             cfgPrinter.lir = null;
246             cfgPrinter.res = null;
247             cfgPrinter.nodeLirGenerator = null;
248             cfgPrinter.cfg = null;
249             cfgPrinter.flush();
250         }
251     }
252 
253     /** Lazy initialization to delay service lookup until disassembler is actually needed. */
254     static class DisassemblerHolder {
255         private static final DisassemblerProvider disassembler;
256 
257         static {
258             DisassemblerProvider selected = null;

259             for (DisassemblerProvider d : GraalServices.load(DisassemblerProvider.class)) {
260                 String name = d.getName().toLowerCase();
<span class="line-modified">261                 if (name.contains(&quot;hcf&quot;) || name.contains(&quot;hexcodefile&quot;)) {</span>
<span class="line-modified">262                     selected = d;</span>
<span class="line-modified">263                     break;</span>







264                 }
265             }
266             if (selected == null) {
267                 selected = new DisassemblerProvider() {
268                     @Override
269                     public String getName() {
270                         return &quot;nop&quot;;
271                     }
272                 };
273             }
274             disassembler = selected;
275         }
276     }
277 
278     private static String disassemble(CodeCacheProvider codeCache, CompilationResult compResult, InstalledCode installedCode) {
279         DisassemblerProvider dis = DisassemblerHolder.disassembler;
280         if (installedCode != null) {
281             return dis.disassembleInstalledCode(codeCache, compResult, installedCode);
282         }
283         return dis.disassembleCompiledCode(codeCache, compResult);
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 47 import org.graalvm.compiler.debug.DebugContext;
 48 import org.graalvm.compiler.debug.DebugDumpHandler;
 49 import org.graalvm.compiler.debug.DebugDumpScope;
 50 import org.graalvm.compiler.debug.GraalError;
 51 import org.graalvm.compiler.debug.TTY;
 52 import org.graalvm.compiler.graph.Graph;
 53 import org.graalvm.compiler.java.BciBlockMapping;
 54 import org.graalvm.compiler.lir.LIR;
 55 import org.graalvm.compiler.lir.debug.IntervalDumper;
 56 import org.graalvm.compiler.lir.gen.LIRGenerationResult;
 57 import org.graalvm.compiler.nodes.StructuredGraph;
 58 import org.graalvm.compiler.nodes.StructuredGraph.ScheduleResult;
 59 import org.graalvm.compiler.nodes.cfg.ControlFlowGraph;
 60 import org.graalvm.compiler.options.OptionValues;
 61 import org.graalvm.compiler.serviceprovider.GraalServices;
 62 
 63 import jdk.vm.ci.code.CodeCacheProvider;
 64 import jdk.vm.ci.code.InstalledCode;
 65 import jdk.vm.ci.meta.JavaMethod;
 66 import jdk.vm.ci.meta.ResolvedJavaMethod;
<span class="line-added"> 67 import jdk.vm.ci.services.Services;</span>
 68 
 69 /**
 70  * Observes compilation events and uses {@link CFGPrinter} to produce a control flow graph for the
 71  * &lt;a href=&quot;http://java.net/projects/c1visualizer/&quot;&gt;C1 Visualizer&lt;/a&gt;.
 72  */
 73 public class CFGPrinterObserver implements DebugDumpHandler {
 74 
 75     private CFGPrinter cfgPrinter;
 76     private File cfgFile;
 77     private JavaMethod curMethod;
 78     private CompilationIdentifier curCompilation;
 79     private List&lt;String&gt; curDecorators = Collections.emptyList();
 80 
 81     @Override
 82     public void dump(DebugContext debug, Object object, String format, Object... arguments) {
 83         String message = String.format(format, arguments);
 84         try {
 85             dumpSandboxed(debug, object, message);
 86         } catch (Throwable ex) {
 87             TTY.println(&quot;CFGPrinter: Exception during output of &quot; + message + &quot;: &quot; + ex);
</pre>
<hr />
<pre>
194             if (object instanceof BciBlockMapping) {
195                 BciBlockMapping blockMap = (BciBlockMapping) object;
196                 cfgPrinter.printCFG(message, blockMap);
197                 if (blockMap.code.getCode() != null) {
198                     cfgPrinter.printBytecodes(new BytecodeDisassembler(false).disassemble(blockMap.code));
199                 }
200 
201             } else if (object instanceof LIR) {
202                 // Currently no node printing for lir
203                 cfgPrinter.printCFG(message, cfgPrinter.lir.codeEmittingOrder(), false);
204                 lastLIR = (LIR) object;
205                 if (delayedIntervals != null) {
206                     cfgPrinter.printIntervals(message, delayedIntervals);
207                     delayedIntervals = null;
208                 }
209             } else if (object instanceof ScheduleResult) {
210                 cfgPrinter.printSchedule(message, (ScheduleResult) object);
211             } else if (object instanceof StructuredGraph) {
212                 if (cfgPrinter.cfg == null) {
213                     StructuredGraph graph = (StructuredGraph) object;
<span class="line-modified">214                     ScheduleResult scheduleResult = GraalDebugHandlersFactory.tryGetSchedule(debug, graph);</span>
<span class="line-modified">215                     if (scheduleResult != null) {</span>
<span class="line-modified">216                         cfgPrinter.cfg = scheduleResult.getCFG();</span>
<span class="line-added">217                     }</span>
<span class="line-added">218                 }</span>
<span class="line-added">219                 if (cfgPrinter.cfg != null) {</span>
220                     cfgPrinter.printCFG(message, cfgPrinter.cfg.getBlocks(), true);
221                 }

222             } else if (object instanceof CompilationResult) {
223                 final CompilationResult compResult = (CompilationResult) object;
224                 cfgPrinter.printMachineCode(disassemble(codeCache, compResult, null), message);
225             } else if (object instanceof InstalledCode) {
226                 CompilationResult compResult = debug.contextLookup(CompilationResult.class);
227                 if (compResult != null) {
228                     cfgPrinter.printMachineCode(disassemble(codeCache, compResult, (InstalledCode) object), message);
229                 }
230             } else if (object instanceof IntervalDumper) {
231                 if (lastLIR == cfgPrinter.lir) {
232                     cfgPrinter.printIntervals(message, (IntervalDumper) object);
233                 } else {
234                     if (delayedIntervals != null) {
235                         debug.log(&quot;Some delayed intervals were dropped (%s)&quot;, delayedIntervals);
236                     }
237                     delayedIntervals = (IntervalDumper) object;
238                 }
239             } else if (object instanceof AbstractBlockBase&lt;?&gt;[]) {
240                 cfgPrinter.printCFG(message, (AbstractBlockBase&lt;?&gt;[]) object, false);
241             } else if (object instanceof Trace) {
242                 cfgPrinter.printCFG(message, ((Trace) object).getBlocks(), false);
243             } else if (object instanceof TraceBuilderResult) {
244                 cfgPrinter.printTraces(message, (TraceBuilderResult) object);
245             }
246         } finally {
247             cfgPrinter.target = null;
248             cfgPrinter.lir = null;
249             cfgPrinter.res = null;
250             cfgPrinter.nodeLirGenerator = null;
251             cfgPrinter.cfg = null;
252             cfgPrinter.flush();
253         }
254     }
255 
256     /** Lazy initialization to delay service lookup until disassembler is actually needed. */
257     static class DisassemblerHolder {
258         private static final DisassemblerProvider disassembler;
259 
260         static {
261             DisassemblerProvider selected = null;
<span class="line-added">262             String arch = Services.getSavedProperties().get(&quot;os.arch&quot;);</span>
263             for (DisassemblerProvider d : GraalServices.load(DisassemblerProvider.class)) {
264                 String name = d.getName().toLowerCase();
<span class="line-modified">265                 if (arch.equals(&quot;aarch64&quot;)) {</span>
<span class="line-modified">266                     if (name.contains(&quot;hsdis-objdump&quot;)) {</span>
<span class="line-modified">267                         selected = d;</span>
<span class="line-added">268                         break;</span>
<span class="line-added">269                     }</span>
<span class="line-added">270                 } else {</span>
<span class="line-added">271                     if (name.contains(&quot;hcf&quot;) || name.contains(&quot;hexcodefile&quot;)) {</span>
<span class="line-added">272                         selected = d;</span>
<span class="line-added">273                         break;</span>
<span class="line-added">274                     }</span>
275                 }
276             }
277             if (selected == null) {
278                 selected = new DisassemblerProvider() {
279                     @Override
280                     public String getName() {
281                         return &quot;nop&quot;;
282                     }
283                 };
284             }
285             disassembler = selected;
286         }
287     }
288 
289     private static String disassemble(CodeCacheProvider codeCache, CompilationResult compResult, InstalledCode installedCode) {
290         DisassemblerProvider dis = DisassemblerHolder.disassembler;
291         if (installedCode != null) {
292             return dis.disassembleInstalledCode(codeCache, compResult, installedCode);
293         }
294         return dis.disassembleCompiledCode(codeCache, compResult);
</pre>
</td>
</tr>
</table>
<center><a href="BinaryGraphPrinter.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="GraalDebugHandlersFactory.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>