<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/BinaryGraphPrinter.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../org.graalvm.compiler.phases/src/org/graalvm/compiler/phases/util/Providers.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CFGPrinterObserver.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/BinaryGraphPrinter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 25 package org.graalvm.compiler.printer;
 26 
 27 import static org.graalvm.compiler.graph.Edges.Type.Inputs;
 28 import static org.graalvm.compiler.graph.Edges.Type.Successors;
 29 
 30 import java.io.IOException;
 31 import java.net.URI;
 32 import java.net.URISyntaxException;
 33 import java.util.ArrayList;
 34 import java.util.Arrays;
 35 import java.util.Collection;
 36 import java.util.Collections;
 37 import java.util.LinkedList;
 38 import java.util.List;
 39 import java.util.Map;
 40 
 41 import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
 42 import org.graalvm.compiler.bytecode.Bytecode;
 43 import org.graalvm.compiler.core.common.cfg.BlockMap;
 44 import org.graalvm.compiler.debug.DebugContext;
<span class="line-removed"> 45 import org.graalvm.compiler.debug.DebugOptions;</span>
 46 import org.graalvm.compiler.graph.CachedGraph;
 47 import org.graalvm.compiler.graph.Edges;
 48 import org.graalvm.compiler.graph.Graph;
 49 import org.graalvm.compiler.graph.InputEdges;
 50 import org.graalvm.compiler.graph.Node;
 51 import org.graalvm.compiler.graph.NodeClass;
 52 import org.graalvm.compiler.graph.NodeMap;
 53 import org.graalvm.compiler.graph.NodeSourcePosition;
 54 import org.graalvm.compiler.graph.SourceLanguagePosition;
 55 import org.graalvm.compiler.nodes.AbstractBeginNode;
 56 import org.graalvm.compiler.nodes.AbstractEndNode;
 57 import org.graalvm.compiler.nodes.AbstractMergeNode;
 58 import org.graalvm.compiler.nodes.ConstantNode;
 59 import org.graalvm.compiler.nodes.ControlSinkNode;
 60 import org.graalvm.compiler.nodes.ControlSplitNode;
 61 import org.graalvm.compiler.nodes.FixedNode;
 62 import org.graalvm.compiler.nodes.PhiNode;
 63 import org.graalvm.compiler.nodes.ProxyNode;
 64 import org.graalvm.compiler.nodes.StructuredGraph;
 65 import org.graalvm.compiler.nodes.VirtualState;
 66 import org.graalvm.compiler.nodes.cfg.Block;
 67 import org.graalvm.compiler.nodes.cfg.ControlFlowGraph;
 68 import org.graalvm.compiler.nodes.util.JavaConstantFormattable;
<span class="line-removed"> 69 import org.graalvm.compiler.phases.schedule.SchedulePhase;</span>
 70 import org.graalvm.graphio.GraphBlocks;
 71 import org.graalvm.graphio.GraphElements;

 72 import org.graalvm.graphio.GraphOutput;
 73 import org.graalvm.graphio.GraphStructure;
 74 import org.graalvm.graphio.GraphTypes;
 75 
 76 import jdk.vm.ci.meta.JavaType;
 77 import jdk.vm.ci.meta.ResolvedJavaField;
 78 import jdk.vm.ci.meta.ResolvedJavaMethod;
 79 import jdk.vm.ci.meta.Signature;
<span class="line-removed"> 80 import org.graalvm.graphio.GraphLocations;</span>
 81 
 82 public class BinaryGraphPrinter implements
 83                 GraphStructure&lt;BinaryGraphPrinter.GraphInfo, Node, NodeClass&lt;?&gt;, Edges&gt;,
 84                 GraphBlocks&lt;BinaryGraphPrinter.GraphInfo, Block, Node&gt;,
 85                 GraphElements&lt;ResolvedJavaMethod, ResolvedJavaField, Signature, NodeSourcePosition&gt;,
 86                 GraphLocations&lt;ResolvedJavaMethod, NodeSourcePosition, SourceLanguagePosition&gt;,
 87                 GraphTypes, GraphPrinter {
 88     private final SnippetReflectionProvider snippetReflection;
 89     private final GraphOutput&lt;BinaryGraphPrinter.GraphInfo, ResolvedJavaMethod&gt; output;
 90 
 91     public BinaryGraphPrinter(DebugContext ctx, SnippetReflectionProvider snippetReflection) throws IOException {
 92         // @formatter:off
 93         this.output = ctx.buildOutput(GraphOutput.newBuilder(this).
<span class="line-modified"> 94                         protocolVersion(6, 0).</span>
 95                         blocks(this).
 96                         elementsAndLocations(this, this).
 97                         types(this)
 98         );
 99         // @formatter:on
100         this.snippetReflection = snippetReflection;
101     }
102 
103     @Override
104     public SnippetReflectionProvider getSnippetReflectionProvider() {
105         return snippetReflection;
106     }
107 
108     @Override
109     public void beginGroup(DebugContext debug, String name, String shortName, ResolvedJavaMethod method, int bci, Map&lt;Object, Object&gt; properties) throws IOException {
110         output.beginGroup(new GraphInfo(debug, null), name, shortName, method, bci, DebugContext.addVersionProperties(properties));
111     }
112 
113     @Override
114     public void endGroup() throws IOException {
</pre>
<hr />
<pre>
511 
512             @Override
513             public int getOffsetEnd() {
514                 return -1;
515             }
516 
517             @Override
518             public int getOffsetStart() {
519                 return -1;
520             }
521 
522             @Override
523             public int getLineNumber() {
524                 return e.getLineNumber();
525             }
526 
527             @Override
528             public URI getURI() {
529                 String path = e.getFileName();
530                 try {
<span class="line-modified">531                     return path == null ? null : new URI(null, null, path, null);</span>
532                 } catch (URISyntaxException ex) {
533                     throw new IllegalArgumentException(ex);
534                 }
535             }
536 
537             @Override
538             public String getLanguage() {
539                 return &quot;Java&quot;;
540             }
541         }
542 
543         List&lt;SourceLanguagePosition&gt; arr = new ArrayList&lt;&gt;();
544         arr.add(new JavaSourcePosition());
545         NodeSourcePosition at = pos;
546         while (at != null) {
547             SourceLanguagePosition cur = at.getSourceLanguage();
548             if (cur != null) {
549                 arr.add(cur);
550             }
551             at = at.getCaller();
</pre>
<hr />
<pre>
574     }
575 
576     @Override
577     public int locationOffsetEnd(SourceLanguagePosition location) {
578         return location.getOffsetEnd();
579     }
580 
581     static final class GraphInfo {
582         final DebugContext debug;
583         final Graph graph;
584         final ControlFlowGraph cfg;
585         final BlockMap&lt;List&lt;Node&gt;&gt; blockToNodes;
586         final NodeMap&lt;Block&gt; nodeToBlocks;
587         final List&lt;Block&gt; blocks;
588 
589         private GraphInfo(DebugContext debug, Graph graph) {
590             this.debug = debug;
591             this.graph = graph;
592             StructuredGraph.ScheduleResult scheduleResult = null;
593             if (graph instanceof StructuredGraph) {
<span class="line-removed">594 </span>
595                 StructuredGraph structuredGraph = (StructuredGraph) graph;
<span class="line-modified">596                 scheduleResult = structuredGraph.getLastSchedule();</span>
<span class="line-removed">597                 if (scheduleResult == null) {</span>
<span class="line-removed">598 </span>
<span class="line-removed">599                     // Also provide a schedule when an error occurs</span>
<span class="line-removed">600                     if (DebugOptions.PrintGraphWithSchedule.getValue(graph.getOptions()) || debug.contextLookup(Throwable.class) != null) {</span>
<span class="line-removed">601                         try {</span>
<span class="line-removed">602                             SchedulePhase schedule = new SchedulePhase(graph.getOptions());</span>
<span class="line-removed">603                             schedule.apply(structuredGraph);</span>
<span class="line-removed">604                             scheduleResult = structuredGraph.getLastSchedule();</span>
<span class="line-removed">605                         } catch (Throwable t) {</span>
<span class="line-removed">606                         }</span>
<span class="line-removed">607                     }</span>
<span class="line-removed">608 </span>
<span class="line-removed">609                 }</span>
610             }
611             cfg = scheduleResult == null ? debug.contextLookup(ControlFlowGraph.class) : scheduleResult.getCFG();
612             blockToNodes = scheduleResult == null ? null : scheduleResult.getBlockToNodesMap();
613             nodeToBlocks = scheduleResult == null ? null : scheduleResult.getNodeToBlockMap();
614             blocks = cfg == null ? null : Arrays.asList(cfg.getBlocks());
615         }
616     }
617 
618 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
</pre>
<hr />
<pre>
 25 package org.graalvm.compiler.printer;
 26 
 27 import static org.graalvm.compiler.graph.Edges.Type.Inputs;
 28 import static org.graalvm.compiler.graph.Edges.Type.Successors;
 29 
 30 import java.io.IOException;
 31 import java.net.URI;
 32 import java.net.URISyntaxException;
 33 import java.util.ArrayList;
 34 import java.util.Arrays;
 35 import java.util.Collection;
 36 import java.util.Collections;
 37 import java.util.LinkedList;
 38 import java.util.List;
 39 import java.util.Map;
 40 
 41 import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
 42 import org.graalvm.compiler.bytecode.Bytecode;
 43 import org.graalvm.compiler.core.common.cfg.BlockMap;
 44 import org.graalvm.compiler.debug.DebugContext;

 45 import org.graalvm.compiler.graph.CachedGraph;
 46 import org.graalvm.compiler.graph.Edges;
 47 import org.graalvm.compiler.graph.Graph;
 48 import org.graalvm.compiler.graph.InputEdges;
 49 import org.graalvm.compiler.graph.Node;
 50 import org.graalvm.compiler.graph.NodeClass;
 51 import org.graalvm.compiler.graph.NodeMap;
 52 import org.graalvm.compiler.graph.NodeSourcePosition;
 53 import org.graalvm.compiler.graph.SourceLanguagePosition;
 54 import org.graalvm.compiler.nodes.AbstractBeginNode;
 55 import org.graalvm.compiler.nodes.AbstractEndNode;
 56 import org.graalvm.compiler.nodes.AbstractMergeNode;
 57 import org.graalvm.compiler.nodes.ConstantNode;
 58 import org.graalvm.compiler.nodes.ControlSinkNode;
 59 import org.graalvm.compiler.nodes.ControlSplitNode;
 60 import org.graalvm.compiler.nodes.FixedNode;
 61 import org.graalvm.compiler.nodes.PhiNode;
 62 import org.graalvm.compiler.nodes.ProxyNode;
 63 import org.graalvm.compiler.nodes.StructuredGraph;
 64 import org.graalvm.compiler.nodes.VirtualState;
 65 import org.graalvm.compiler.nodes.cfg.Block;
 66 import org.graalvm.compiler.nodes.cfg.ControlFlowGraph;
 67 import org.graalvm.compiler.nodes.util.JavaConstantFormattable;

 68 import org.graalvm.graphio.GraphBlocks;
 69 import org.graalvm.graphio.GraphElements;
<span class="line-added"> 70 import org.graalvm.graphio.GraphLocations;</span>
 71 import org.graalvm.graphio.GraphOutput;
 72 import org.graalvm.graphio.GraphStructure;
 73 import org.graalvm.graphio.GraphTypes;
 74 
 75 import jdk.vm.ci.meta.JavaType;
 76 import jdk.vm.ci.meta.ResolvedJavaField;
 77 import jdk.vm.ci.meta.ResolvedJavaMethod;
 78 import jdk.vm.ci.meta.Signature;

 79 
 80 public class BinaryGraphPrinter implements
 81                 GraphStructure&lt;BinaryGraphPrinter.GraphInfo, Node, NodeClass&lt;?&gt;, Edges&gt;,
 82                 GraphBlocks&lt;BinaryGraphPrinter.GraphInfo, Block, Node&gt;,
 83                 GraphElements&lt;ResolvedJavaMethod, ResolvedJavaField, Signature, NodeSourcePosition&gt;,
 84                 GraphLocations&lt;ResolvedJavaMethod, NodeSourcePosition, SourceLanguagePosition&gt;,
 85                 GraphTypes, GraphPrinter {
 86     private final SnippetReflectionProvider snippetReflection;
 87     private final GraphOutput&lt;BinaryGraphPrinter.GraphInfo, ResolvedJavaMethod&gt; output;
 88 
 89     public BinaryGraphPrinter(DebugContext ctx, SnippetReflectionProvider snippetReflection) throws IOException {
 90         // @formatter:off
 91         this.output = ctx.buildOutput(GraphOutput.newBuilder(this).
<span class="line-modified"> 92                         protocolVersion(6, 1).</span>
 93                         blocks(this).
 94                         elementsAndLocations(this, this).
 95                         types(this)
 96         );
 97         // @formatter:on
 98         this.snippetReflection = snippetReflection;
 99     }
100 
101     @Override
102     public SnippetReflectionProvider getSnippetReflectionProvider() {
103         return snippetReflection;
104     }
105 
106     @Override
107     public void beginGroup(DebugContext debug, String name, String shortName, ResolvedJavaMethod method, int bci, Map&lt;Object, Object&gt; properties) throws IOException {
108         output.beginGroup(new GraphInfo(debug, null), name, shortName, method, bci, DebugContext.addVersionProperties(properties));
109     }
110 
111     @Override
112     public void endGroup() throws IOException {
</pre>
<hr />
<pre>
509 
510             @Override
511             public int getOffsetEnd() {
512                 return -1;
513             }
514 
515             @Override
516             public int getOffsetStart() {
517                 return -1;
518             }
519 
520             @Override
521             public int getLineNumber() {
522                 return e.getLineNumber();
523             }
524 
525             @Override
526             public URI getURI() {
527                 String path = e.getFileName();
528                 try {
<span class="line-modified">529                     return new URI(null, null, path == null ? &quot;(Unknown Source)&quot; : path, null);</span>
530                 } catch (URISyntaxException ex) {
531                     throw new IllegalArgumentException(ex);
532                 }
533             }
534 
535             @Override
536             public String getLanguage() {
537                 return &quot;Java&quot;;
538             }
539         }
540 
541         List&lt;SourceLanguagePosition&gt; arr = new ArrayList&lt;&gt;();
542         arr.add(new JavaSourcePosition());
543         NodeSourcePosition at = pos;
544         while (at != null) {
545             SourceLanguagePosition cur = at.getSourceLanguage();
546             if (cur != null) {
547                 arr.add(cur);
548             }
549             at = at.getCaller();
</pre>
<hr />
<pre>
572     }
573 
574     @Override
575     public int locationOffsetEnd(SourceLanguagePosition location) {
576         return location.getOffsetEnd();
577     }
578 
579     static final class GraphInfo {
580         final DebugContext debug;
581         final Graph graph;
582         final ControlFlowGraph cfg;
583         final BlockMap&lt;List&lt;Node&gt;&gt; blockToNodes;
584         final NodeMap&lt;Block&gt; nodeToBlocks;
585         final List&lt;Block&gt; blocks;
586 
587         private GraphInfo(DebugContext debug, Graph graph) {
588             this.debug = debug;
589             this.graph = graph;
590             StructuredGraph.ScheduleResult scheduleResult = null;
591             if (graph instanceof StructuredGraph) {

592                 StructuredGraph structuredGraph = (StructuredGraph) graph;
<span class="line-modified">593                 scheduleResult = GraalDebugHandlersFactory.tryGetSchedule(debug, structuredGraph);</span>













594             }
595             cfg = scheduleResult == null ? debug.contextLookup(ControlFlowGraph.class) : scheduleResult.getCFG();
596             blockToNodes = scheduleResult == null ? null : scheduleResult.getBlockToNodesMap();
597             nodeToBlocks = scheduleResult == null ? null : scheduleResult.getNodeToBlockMap();
598             blocks = cfg == null ? null : Arrays.asList(cfg.getBlocks());
599         }
600     }
601 
602 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../org.graalvm.compiler.phases/src/org/graalvm/compiler/phases/util/Providers.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CFGPrinterObserver.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>