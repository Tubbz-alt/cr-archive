<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/GraphPrinter.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GraalDebugHandlersFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="GraphPrinterDumpHandler.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/GraphPrinter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.printer;
 26 
 27 import java.io.Closeable;
 28 import java.io.IOException;
 29 import java.lang.reflect.Array;
 30 import java.util.Arrays;


 31 import java.util.List;
 32 import java.util.Map;

 33 
 34 import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
 35 import org.graalvm.compiler.debug.DebugContext;
 36 import org.graalvm.compiler.debug.DebugContext.Scope;
 37 import org.graalvm.compiler.graph.Graph;
 38 import org.graalvm.compiler.nodes.ConstantNode;
 39 import org.graalvm.compiler.nodes.StructuredGraph;
 40 import org.graalvm.compiler.nodes.util.JavaConstantFormatter;
 41 import org.graalvm.compiler.phases.schedule.SchedulePhase;
 42 import org.graalvm.compiler.serviceprovider.GraalServices;
 43 
 44 import jdk.vm.ci.meta.JavaConstant;
 45 import jdk.vm.ci.meta.JavaKind;
 46 import jdk.vm.ci.meta.JavaType;
 47 import jdk.vm.ci.meta.MetaUtil;
 48 import jdk.vm.ci.meta.ResolvedJavaMethod;
 49 
 50 interface GraphPrinter extends Closeable, JavaConstantFormatter {
 51 
 52     /**
</pre>
<hr />
<pre>
 89 
 90     /**
 91      * Determines if invoking {@link Object#toString()} on an instance of {@code c} will only run
 92      * trusted code.
 93      */
 94     static boolean isToStringTrusted(Class&lt;?&gt; c) {
 95         if (TRUSTED_CLASSES.contains(c)) {
 96             return true;
 97         }
 98         if (GraalServices.isToStringTrusted(c)) {
 99             return true;
100         }
101         if (c.getClassLoader() == GraphPrinter.class.getClassLoader()) {
102             return true;
103         }
104         return false;
105     }
106 
107     /**
108      * Use the real {@link Object#toString()} method for {@link JavaConstant JavaConstants} that are
<span class="line-modified">109      * wrapping trusted types, other just return the results of {@link JavaConstant#toString()}.</span>
110      */
111     @Override
112     default String format(JavaConstant constant) {
113         SnippetReflectionProvider snippetReflection = getSnippetReflectionProvider();
114         if (snippetReflection != null) {
115             if (constant.getJavaKind() == JavaKind.Object) {
116                 Object obj = null;
117                 /*
118                  * Ignore any exceptions on unknown JavaConstant implementations in debugging code.
119                  */
120                 try {
121                     obj = snippetReflection.asObject(Object.class, constant);
122                 } catch (Throwable ex) {
123                 }
124                 if (obj != null) {
<span class="line-modified">125                     return GraphPrinter.constantToString(obj);</span>

126                 }
127             }
128         }
129         return constant.toString();
130     }
131 
132     /**
133      * Sets or updates the {@code &quot;rawvalue&quot;} and {@code &quot;toString&quot;} properties in {@code props} for
134      * {@code cn} if it&#39;s a boxed Object value and {@code snippetReflection} can access the raw
135      * value.
136      */
137     default void updateStringPropertiesForConstant(Map&lt;Object, Object&gt; props, ConstantNode cn) {
138         if (cn.isJavaConstant() &amp;&amp; cn.getStackKind().isObject()) {
139             String toString = format(cn.asJavaConstant());
140             String rawvalue = GraphPrinter.truncate(toString);
141             // Overwrite the value inserted by
142             // ConstantNode.getDebugProperties()
143             props.put(&quot;rawvalue&quot;, rawvalue);
144             if (!rawvalue.equals(toString)) {
145                 props.put(&quot;toString&quot;, toString);
</pre>
<hr />
<pre>
163                     res = new Object[args.length];
164                     for (int a = 0; a &lt; i; a++) {
165                         res[a] = args[a];
166                     }
167                 }
168                 res[i] = ((JavaType) arg).getUnqualifiedName();
169             } else {
170                 res[i] = arg;
171             }
172         }
173         return res;
174     }
175 
176     static String truncate(String s) {
177         if (s.length() &gt; MAX_CONSTANT_TO_STRING_LENGTH) {
178             return s.substring(0, MAX_CONSTANT_TO_STRING_LENGTH - 3) + &quot;...&quot;;
179         }
180         return s;
181     }
182 
<span class="line-modified">183     static String constantToString(Object value) {</span>
<span class="line-modified">184         Class&lt;?&gt; c = value.getClass();</span>
<span class="line-modified">185         String suffix = &quot;&quot;;</span>
<span class="line-modified">186         if (c.isArray()) {</span>
<span class="line-modified">187             return constantArrayToString(value);</span>
<span class="line-modified">188         } else if (value instanceof Enum) {</span>
<span class="line-modified">189             return ((Enum&lt;?&gt;) value).name();</span>
<span class="line-modified">190         } else if (isToStringTrusted(c)) {</span>
<span class="line-modified">191             try {</span>
<span class="line-modified">192                 return value.toString();</span>
<span class="line-modified">193             } catch (Throwable t) {</span>
<span class="line-modified">194                 suffix = &quot;[toString error: &quot; + t.getClass().getName() + &quot;]&quot;;</span>
<span class="line-modified">195                 if (isToStringTrusted(t.getClass())) {</span>
<span class="line-modified">196                     try {</span>
<span class="line-modified">197                         suffix = &quot;[toString error: &quot; + t + &quot;]&quot;;</span>
<span class="line-modified">198                     } catch (Throwable t2) {</span>
<span class="line-modified">199                         // No point in going further</span>




200                     }
201                 }
202             }



203         }
<span class="line-modified">204         return MetaUtil.getSimpleName(c, true) + &quot;@&quot; + Integer.toHexString(System.identityHashCode(value)) + suffix;</span>
205     }
206 
<span class="line-modified">207     static String constantArrayToString(Object array) {</span>
<span class="line-modified">208         Class&lt;?&gt; componentType = array.getClass().getComponentType();</span>
<span class="line-modified">209         assert componentType != null;</span>
<span class="line-modified">210         int arrayLength = Array.getLength(array);</span>
<span class="line-modified">211         StringBuilder buf = new StringBuilder(MetaUtil.getSimpleName(componentType, true)).append(&#39;[&#39;).append(arrayLength).append(&quot;]{&quot;);</span>
<span class="line-modified">212         int length = arrayLength;</span>
<span class="line-modified">213         boolean primitive = componentType.isPrimitive();</span>
<span class="line-modified">214         for (int i = 0; i &lt; length; i++) {</span>
<span class="line-modified">215             if (primitive) {</span>
<span class="line-modified">216                 buf.append(Array.get(array, i));</span>
<span class="line-modified">217             } else {</span>
<span class="line-modified">218                 Object o = ((Object[]) array)[i];</span>
<span class="line-modified">219                 buf.append(o == null ? &quot;null&quot; : constantToString(o));</span>
<span class="line-modified">220             }</span>
<span class="line-modified">221             if (i != length - 1) {</span>
<span class="line-modified">222                 buf.append(&quot;, &quot;);</span>



223             }



224         }
<span class="line-removed">225         return buf.append(&#39;}&#39;).toString();</span>
226     }
227 
228     @SuppressWarnings(&quot;try&quot;)
229     static StructuredGraph.ScheduleResult getScheduleOrNull(Graph graph) {
230         if (graph instanceof StructuredGraph) {
231             StructuredGraph sgraph = (StructuredGraph) graph;
232             StructuredGraph.ScheduleResult scheduleResult = sgraph.getLastSchedule();
233             if (scheduleResult == null) {
234                 DebugContext debug = graph.getDebug();
235                 try (Scope scope = debug.disable()) {
236                     SchedulePhase schedule = new SchedulePhase(graph.getOptions());
237                     schedule.apply(sgraph);
238                     scheduleResult = sgraph.getLastSchedule();
239                 } catch (Throwable t) {
240                 }
241             }
242             return scheduleResult;
243         }
244         return null;
245     }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.printer;
 26 
 27 import java.io.Closeable;
 28 import java.io.IOException;
 29 import java.lang.reflect.Array;
 30 import java.util.Arrays;
<span class="line-added"> 31 import java.util.Collections;</span>
<span class="line-added"> 32 import java.util.IdentityHashMap;</span>
 33 import java.util.List;
 34 import java.util.Map;
<span class="line-added"> 35 import java.util.Set;</span>
 36 
 37 import org.graalvm.compiler.api.replacements.SnippetReflectionProvider;
 38 import org.graalvm.compiler.debug.DebugContext;
 39 import org.graalvm.compiler.debug.DebugContext.Scope;
 40 import org.graalvm.compiler.graph.Graph;
 41 import org.graalvm.compiler.nodes.ConstantNode;
 42 import org.graalvm.compiler.nodes.StructuredGraph;
 43 import org.graalvm.compiler.nodes.util.JavaConstantFormatter;
 44 import org.graalvm.compiler.phases.schedule.SchedulePhase;
 45 import org.graalvm.compiler.serviceprovider.GraalServices;
 46 
 47 import jdk.vm.ci.meta.JavaConstant;
 48 import jdk.vm.ci.meta.JavaKind;
 49 import jdk.vm.ci.meta.JavaType;
 50 import jdk.vm.ci.meta.MetaUtil;
 51 import jdk.vm.ci.meta.ResolvedJavaMethod;
 52 
 53 interface GraphPrinter extends Closeable, JavaConstantFormatter {
 54 
 55     /**
</pre>
<hr />
<pre>
 92 
 93     /**
 94      * Determines if invoking {@link Object#toString()} on an instance of {@code c} will only run
 95      * trusted code.
 96      */
 97     static boolean isToStringTrusted(Class&lt;?&gt; c) {
 98         if (TRUSTED_CLASSES.contains(c)) {
 99             return true;
100         }
101         if (GraalServices.isToStringTrusted(c)) {
102             return true;
103         }
104         if (c.getClassLoader() == GraphPrinter.class.getClassLoader()) {
105             return true;
106         }
107         return false;
108     }
109 
110     /**
111      * Use the real {@link Object#toString()} method for {@link JavaConstant JavaConstants} that are
<span class="line-modified">112      * wrapping trusted types, otherwise just return the result of {@link JavaConstant#toString()}.</span>
113      */
114     @Override
115     default String format(JavaConstant constant) {
116         SnippetReflectionProvider snippetReflection = getSnippetReflectionProvider();
117         if (snippetReflection != null) {
118             if (constant.getJavaKind() == JavaKind.Object) {
119                 Object obj = null;
120                 /*
121                  * Ignore any exceptions on unknown JavaConstant implementations in debugging code.
122                  */
123                 try {
124                     obj = snippetReflection.asObject(Object.class, constant);
125                 } catch (Throwable ex) {
126                 }
127                 if (obj != null) {
<span class="line-modified">128                     Set&lt;Object&gt; visited = Collections.newSetFromMap(new IdentityHashMap&lt;&gt;());</span>
<span class="line-added">129                     return GraphPrinter.constantToString(obj, visited);</span>
130                 }
131             }
132         }
133         return constant.toString();
134     }
135 
136     /**
137      * Sets or updates the {@code &quot;rawvalue&quot;} and {@code &quot;toString&quot;} properties in {@code props} for
138      * {@code cn} if it&#39;s a boxed Object value and {@code snippetReflection} can access the raw
139      * value.
140      */
141     default void updateStringPropertiesForConstant(Map&lt;Object, Object&gt; props, ConstantNode cn) {
142         if (cn.isJavaConstant() &amp;&amp; cn.getStackKind().isObject()) {
143             String toString = format(cn.asJavaConstant());
144             String rawvalue = GraphPrinter.truncate(toString);
145             // Overwrite the value inserted by
146             // ConstantNode.getDebugProperties()
147             props.put(&quot;rawvalue&quot;, rawvalue);
148             if (!rawvalue.equals(toString)) {
149                 props.put(&quot;toString&quot;, toString);
</pre>
<hr />
<pre>
167                     res = new Object[args.length];
168                     for (int a = 0; a &lt; i; a++) {
169                         res[a] = args[a];
170                     }
171                 }
172                 res[i] = ((JavaType) arg).getUnqualifiedName();
173             } else {
174                 res[i] = arg;
175             }
176         }
177         return res;
178     }
179 
180     static String truncate(String s) {
181         if (s.length() &gt; MAX_CONSTANT_TO_STRING_LENGTH) {
182             return s.substring(0, MAX_CONSTANT_TO_STRING_LENGTH - 3) + &quot;...&quot;;
183         }
184         return s;
185     }
186 
<span class="line-modified">187     static String constantToString(Object value, Set&lt;Object&gt; visited) {</span>
<span class="line-modified">188         if (!visited.contains(value)) {</span>
<span class="line-modified">189             Class&lt;?&gt; c = value.getClass();</span>
<span class="line-modified">190             String suffix = &quot;&quot;;</span>
<span class="line-modified">191             if (c.isArray()) {</span>
<span class="line-modified">192                 return constantArrayToString(value, visited);</span>
<span class="line-modified">193             }</span>
<span class="line-modified">194             visited.add(value);</span>
<span class="line-modified">195             if (value instanceof Enum) {</span>
<span class="line-modified">196                 return ((Enum&lt;?&gt;) value).name();</span>
<span class="line-modified">197             } else if (isToStringTrusted(c)) {</span>
<span class="line-modified">198                 try {</span>
<span class="line-modified">199                     return value.toString();</span>
<span class="line-modified">200                 } catch (Throwable t) {</span>
<span class="line-modified">201                     suffix = &quot;[toString error: &quot; + t.getClass().getName() + &quot;]&quot;;</span>
<span class="line-modified">202                     if (isToStringTrusted(t.getClass())) {</span>
<span class="line-modified">203                         try {</span>
<span class="line-added">204                             suffix = &quot;[toString error: &quot; + t + &quot;]&quot;;</span>
<span class="line-added">205                         } catch (Throwable t2) {</span>
<span class="line-added">206                             // No point in going further</span>
<span class="line-added">207                         }</span>
208                     }
209                 }
210             }
<span class="line-added">211             return MetaUtil.getSimpleName(c, true) + &quot;@&quot; + Integer.toHexString(System.identityHashCode(value)) + suffix;</span>
<span class="line-added">212         } else {</span>
<span class="line-added">213             return &quot;...&quot;;</span>
214         }
<span class="line-modified">215 </span>
216     }
217 
<span class="line-modified">218     static String constantArrayToString(Object array, Set&lt;Object&gt; visited) {</span>
<span class="line-modified">219         if (!visited.contains(array)) {</span>
<span class="line-modified">220             visited.add(array);</span>
<span class="line-modified">221             Class&lt;?&gt; componentType = array.getClass().getComponentType();</span>
<span class="line-modified">222             assert componentType != null;</span>
<span class="line-modified">223             int arrayLength = Array.getLength(array);</span>
<span class="line-modified">224             StringBuilder buf = new StringBuilder(MetaUtil.getSimpleName(componentType, true)).append(&#39;[&#39;).append(arrayLength).append(&quot;]{&quot;);</span>
<span class="line-modified">225             int length = arrayLength;</span>
<span class="line-modified">226             boolean primitive = componentType.isPrimitive();</span>
<span class="line-modified">227             for (int i = 0; i &lt; length; i++) {</span>
<span class="line-modified">228                 if (primitive) {</span>
<span class="line-modified">229                     buf.append(Array.get(array, i));</span>
<span class="line-modified">230                 } else {</span>
<span class="line-modified">231                     Object o = ((Object[]) array)[i];</span>
<span class="line-modified">232                     buf.append(o == null ? &quot;null&quot; : constantToString(o, visited));</span>
<span class="line-modified">233                 }</span>
<span class="line-added">234                 if (i != length - 1) {</span>
<span class="line-added">235                     buf.append(&quot;, &quot;);</span>
<span class="line-added">236                 }</span>
237             }
<span class="line-added">238             return buf.append(&#39;}&#39;).toString();</span>
<span class="line-added">239         } else {</span>
<span class="line-added">240             return &quot;...&quot;;</span>
241         }

242     }
243 
244     @SuppressWarnings(&quot;try&quot;)
245     static StructuredGraph.ScheduleResult getScheduleOrNull(Graph graph) {
246         if (graph instanceof StructuredGraph) {
247             StructuredGraph sgraph = (StructuredGraph) graph;
248             StructuredGraph.ScheduleResult scheduleResult = sgraph.getLastSchedule();
249             if (scheduleResult == null) {
250                 DebugContext debug = graph.getDebug();
251                 try (Scope scope = debug.disable()) {
252                     SchedulePhase schedule = new SchedulePhase(graph.getOptions());
253                     schedule.apply(sgraph);
254                     scheduleResult = sgraph.getLastSchedule();
255                 } catch (Throwable t) {
256                 }
257             }
258             return scheduleResult;
259         }
260         return null;
261     }
</pre>
</td>
</tr>
</table>
<center><a href="GraalDebugHandlersFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="GraphPrinterDumpHandler.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>