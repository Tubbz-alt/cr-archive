<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.virtual/src/org/graalvm/compiler/virtual/phases/ea/EffectsPhase.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="EffectsClosure.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="GraphEffectList.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.virtual/src/org/graalvm/compiler/virtual/phases/ea/EffectsPhase.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 29,23 ***</span>
  import jdk.internal.vm.compiler.collections.EconomicSet;
  import org.graalvm.compiler.core.common.util.CompilationAlarm;
  import org.graalvm.compiler.debug.DebugContext;
  import org.graalvm.compiler.graph.Graph.NodeEventScope;
  import org.graalvm.compiler.graph.Node;
<span class="line-removed">- import org.graalvm.compiler.graph.spi.Simplifiable;</span>
  import org.graalvm.compiler.nodes.StructuredGraph;
  import org.graalvm.compiler.nodes.StructuredGraph.ScheduleResult;
  import org.graalvm.compiler.nodes.cfg.ControlFlowGraph;
  import org.graalvm.compiler.phases.BasePhase;
  import org.graalvm.compiler.phases.common.CanonicalizerPhase;
  import org.graalvm.compiler.phases.common.DeadCodeEliminationPhase;
  import org.graalvm.compiler.phases.common.util.EconomicSetNodeEventListener;
  import org.graalvm.compiler.phases.graph.ReentrantBlockIterator;
  import org.graalvm.compiler.phases.schedule.SchedulePhase;
<span class="line-removed">- import org.graalvm.compiler.phases.tiers.PhaseContext;</span>
  
<span class="line-modified">! public abstract class EffectsPhase&lt;PhaseContextT extends PhaseContext&gt; extends BasePhase&lt;PhaseContextT&gt; {</span>
  
      public abstract static class Closure&lt;T&gt; extends ReentrantBlockIterator.BlockIteratorClosure&lt;T&gt; {
  
          public abstract boolean hasChanged();
  
<span class="line-new-header">--- 29,22 ---</span>
  import jdk.internal.vm.compiler.collections.EconomicSet;
  import org.graalvm.compiler.core.common.util.CompilationAlarm;
  import org.graalvm.compiler.debug.DebugContext;
  import org.graalvm.compiler.graph.Graph.NodeEventScope;
  import org.graalvm.compiler.graph.Node;
  import org.graalvm.compiler.nodes.StructuredGraph;
  import org.graalvm.compiler.nodes.StructuredGraph.ScheduleResult;
  import org.graalvm.compiler.nodes.cfg.ControlFlowGraph;
<span class="line-added">+ import org.graalvm.compiler.nodes.spi.CoreProviders;</span>
  import org.graalvm.compiler.phases.BasePhase;
  import org.graalvm.compiler.phases.common.CanonicalizerPhase;
  import org.graalvm.compiler.phases.common.DeadCodeEliminationPhase;
  import org.graalvm.compiler.phases.common.util.EconomicSetNodeEventListener;
  import org.graalvm.compiler.phases.graph.ReentrantBlockIterator;
  import org.graalvm.compiler.phases.schedule.SchedulePhase;
  
<span class="line-modified">! public abstract class EffectsPhase&lt;CoreProvidersT extends CoreProviders&gt; extends BasePhase&lt;CoreProvidersT&gt; {</span>
  
      public abstract static class Closure&lt;T&gt; extends ReentrantBlockIterator.BlockIteratorClosure&lt;T&gt; {
  
          public abstract boolean hasChanged();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 67,16 ***</span>
          this.canonicalizer = canonicalizer;
          this.unscheduled = unscheduled;
      }
  
      @Override
<span class="line-modified">!     protected void run(StructuredGraph graph, PhaseContextT context) {</span>
          runAnalysis(graph, context);
      }
  
      @SuppressWarnings(&quot;try&quot;)
<span class="line-modified">!     public boolean runAnalysis(StructuredGraph graph, PhaseContextT context) {</span>
          boolean changed = false;
          CompilationAlarm compilationAlarm = CompilationAlarm.current();
          DebugContext debug = graph.getDebug();
          for (int iteration = 0; iteration &lt; maxIterations &amp;&amp; !compilationAlarm.hasExpired(); iteration++) {
              try (DebugContext.Scope s = debug.scope(debug.areScopesEnabled() ? &quot;iteration &quot; + iteration : null)) {
<span class="line-new-header">--- 66,16 ---</span>
          this.canonicalizer = canonicalizer;
          this.unscheduled = unscheduled;
      }
  
      @Override
<span class="line-modified">!     protected void run(StructuredGraph graph, CoreProvidersT context) {</span>
          runAnalysis(graph, context);
      }
  
      @SuppressWarnings(&quot;try&quot;)
<span class="line-modified">!     public boolean runAnalysis(StructuredGraph graph, CoreProvidersT context) {</span>
          boolean changed = false;
          CompilationAlarm compilationAlarm = CompilationAlarm.current();
          DebugContext debug = graph.getDebug();
          for (int iteration = 0; iteration &lt; maxIterations &amp;&amp; !compilationAlarm.hasExpired(); iteration++) {
              try (DebugContext.Scope s = debug.scope(debug.areScopesEnabled() ? &quot;iteration &quot; + iteration : null)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 97,25 ***</span>
                      if (closure.needsApplyEffects()) {
                          // apply the effects collected during this iteration
                          EconomicSetNodeEventListener listener = new EconomicSetNodeEventListener();
                          try (NodeEventScope nes = graph.trackNodeEvents(listener)) {
                              closure.applyEffects();
<span class="line-removed">-                         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-                         if (debug.isDumpEnabled(DebugContext.VERBOSE_LEVEL)) {</span>
<span class="line-removed">-                             debug.dump(DebugContext.VERBOSE_LEVEL, graph, &quot;%s iteration&quot;, getName());</span>
<span class="line-removed">-                         }</span>
  
<span class="line-modified">!                         new DeadCodeEliminationPhase(Required).apply(graph);</span>
<span class="line-modified">! </span>
<span class="line-removed">-                         EconomicSet&lt;Node&gt; changedNodes = listener.getNodes();</span>
<span class="line-removed">-                         for (Node node : graph.getNodes()) {</span>
<span class="line-removed">-                             if (node instanceof Simplifiable) {</span>
<span class="line-removed">-                                 changedNodes.add(node);</span>
                              }
                          }
<span class="line-modified">!                         postIteration(graph, context, changedNodes);</span>
                      }
  
                      if (closure.hasChanged()) {
                          changed = true;
                      } else {
<span class="line-new-header">--- 96,19 ---</span>
                      if (closure.needsApplyEffects()) {
                          // apply the effects collected during this iteration
                          EconomicSetNodeEventListener listener = new EconomicSetNodeEventListener();
                          try (NodeEventScope nes = graph.trackNodeEvents(listener)) {
                              closure.applyEffects();
  
<span class="line-modified">!                             if (debug.isDumpEnabled(DebugContext.VERBOSE_LEVEL)) {</span>
<span class="line-modified">!                                 debug.dump(DebugContext.VERBOSE_LEVEL, graph, &quot;%s iteration&quot;, getName());</span>
                              }
<span class="line-added">+ </span>
<span class="line-added">+                             new DeadCodeEliminationPhase(Required).apply(graph);</span>
                          }
<span class="line-modified">! </span>
<span class="line-added">+                         postIteration(graph, context, listener.getNodes());</span>
                      }
  
                      if (closure.hasChanged()) {
                          changed = true;
                      } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 127,13 ***</span>
              }
          }
          return changed;
      }
  
<span class="line-modified">!     protected void postIteration(final StructuredGraph graph, final PhaseContextT context, EconomicSet&lt;Node&gt; changedNodes) {</span>
          if (canonicalizer != null) {
              canonicalizer.applyIncremental(graph, context, changedNodes);
          }
      }
  
<span class="line-modified">!     protected abstract Closure&lt;?&gt; createEffectsClosure(PhaseContextT context, ScheduleResult schedule, ControlFlowGraph cfg);</span>
  }
<span class="line-new-header">--- 120,13 ---</span>
              }
          }
          return changed;
      }
  
<span class="line-modified">!     protected void postIteration(final StructuredGraph graph, final CoreProvidersT context, EconomicSet&lt;Node&gt; changedNodes) {</span>
          if (canonicalizer != null) {
              canonicalizer.applyIncremental(graph, context, changedNodes);
          }
      }
  
<span class="line-modified">!     protected abstract Closure&lt;?&gt; createEffectsClosure(CoreProvidersT context, ScheduleResult schedule, ControlFlowGraph cfg);</span>
  }
</pre>
<center><a href="EffectsClosure.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="GraphEffectList.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>