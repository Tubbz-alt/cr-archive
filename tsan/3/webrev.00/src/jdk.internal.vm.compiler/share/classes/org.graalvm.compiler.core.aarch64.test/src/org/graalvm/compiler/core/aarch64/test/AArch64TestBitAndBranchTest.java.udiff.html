<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.aarch64.test/src/org/graalvm/compiler/core/aarch64/test/AArch64TestBitAndBranchTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AArch64CbzTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../org.graalvm.compiler.core.aarch64/src/org/graalvm/compiler/core/aarch64/AArch64ArithmeticLIRGenerator.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core.aarch64.test/src/org/graalvm/compiler/core/aarch64/test/AArch64TestBitAndBranchTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,14 +22,13 @@</span>
   */
  
  
  package org.graalvm.compiler.core.aarch64.test;
  
<span class="udiff-line-modified-removed">- import static org.junit.Assume.assumeTrue;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">- import java.util.function.Predicate;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+ import jdk.vm.ci.aarch64.AArch64;</span>
<span class="udiff-line-modified-added">+ import jdk.vm.ci.code.TargetDescription;</span>
<span class="udiff-line-modified-added">+ import jdk.vm.ci.meta.Value;</span>
  import org.graalvm.compiler.api.directives.GraalDirectives;
  import org.graalvm.compiler.asm.aarch64.AArch64MacroAssembler;
  import org.graalvm.compiler.lir.LIR;
  import org.graalvm.compiler.lir.LIRInstruction;
  import org.graalvm.compiler.lir.LIRInstructionClass;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -46,13 +45,13 @@</span>
  import org.graalvm.compiler.options.OptionValues;
  import org.junit.Assert;
  import org.junit.Before;
  import org.junit.Test;
  
<span class="udiff-line-modified-removed">- import jdk.vm.ci.aarch64.AArch64;</span>
<span class="udiff-line-modified-removed">- import jdk.vm.ci.code.TargetDescription;</span>
<span class="udiff-line-modified-removed">- import jdk.vm.ci.meta.Value;</span>
<span class="udiff-line-modified-added">+ import java.util.function.Predicate;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ import static org.junit.Assume.assumeTrue;</span>
  
  public class AArch64TestBitAndBranchTest extends LIRTest {
      private static final Predicate&lt;LIRInstruction&gt; checkForBitTestAndBranchOp = op -&gt; (op instanceof AArch64ControlFlow.BitTestAndBranchOp);
      private LIR lir;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -60,25 +59,25 @@</span>
      public void checkAArch64() {
          assumeTrue(&quot;skipping AArch64 specific test&quot;, getTarget().arch instanceof AArch64);
      }
  
      public static long testBit42Snippet(long a, long b, long c) {
<span class="udiff-line-modified-removed">-         if ((a &amp; (1 &lt;&lt; 42)) == 0) {</span>
<span class="udiff-line-modified-added">+         if ((a &amp; (1L &lt;&lt; 42)) == 0) {</span>
              return b;
          } else {
              return c;
          }
      }
  
      @Test
      public void testBit42() {
<span class="udiff-line-modified-removed">-         test(&quot;testBit42Snippet&quot;, 1L &lt;&lt; 42L, Long.MAX_VALUE, Long.MIN_VALUE);</span>
<span class="udiff-line-modified-removed">-         test(&quot;testBit42Snippet&quot;, ~(1L &lt;&lt; 42L), Long.MAX_VALUE, Long.MIN_VALUE);</span>
<span class="udiff-line-modified-added">+         test(&quot;testBit42Snippet&quot;, 1L &lt;&lt; 42, Long.MAX_VALUE, Long.MIN_VALUE);</span>
<span class="udiff-line-modified-added">+         test(&quot;testBit42Snippet&quot;, ~(1L &lt;&lt; 42), Long.MAX_VALUE, Long.MIN_VALUE);</span>
          checkLIR(&quot;testBit42Snippet&quot;, checkForBitTestAndBranchOp, 1);
      }
  
<span class="udiff-line-modified-removed">-     private static final LargeOpSpec largeOpSingleNop = new LargeOpSpec((1 &lt;&lt; 14 - 2), 2);</span>
<span class="udiff-line-modified-added">+     private static final LargeOpSpec largeOpSingleNop = new LargeOpSpec((1 &lt;&lt; 14 - 2) - 10, 2);</span>
  
      /**
       * Tests the graceful case, where the estimation for
       * {@link CompilationResultBuilder#labelWithinRange(LIRInstruction, org.graalvm.compiler.asm.Label, int)}
       * holds.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -97,11 +96,11 @@</span>
      public void testBitTestAndBranchSingle() {
          runTest(&quot;testBitTestAndBranchSingleSnippet&quot;, 1);
          checkLIR(&quot;testBitTestAndBranchSingleSnippet&quot;, checkForBitTestAndBranchOp, 1);
      }
  
<span class="udiff-line-modified-removed">-     private static final LargeOpSpec largeOpFourNop = new LargeOpSpec((1 &lt;&lt; 14 - 2), 8);</span>
<span class="udiff-line-modified-added">+     private static final LargeOpSpec largeOpFourNop = new LargeOpSpec((1 &lt;&lt; 14 - 2) - 10, 8);</span>
  
      /**
       * Tests the case, where the estimation for
       * {@link CompilationResultBuilder#labelWithinRange(LIRInstruction, org.graalvm.compiler.asm.Label, int)}
       * does not hold and the code generation must be redone with large branches.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -120,10 +119,77 @@</span>
      public void testBitTestAndBranchFour() {
          runTest(&quot;testBitTestAndBranchFourSnippet&quot;, 1);
          checkLIR(&quot;testBitTestAndBranchFourSnippet&quot;, checkForBitTestAndBranchOp, 1);
      }
  
<span class="udiff-line-added">+     private static final float trueTarget = Float.MAX_VALUE;</span>
<span class="udiff-line-added">+     private static final float falseTarget = Float.MIN_VALUE;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static float testLessThanZeroSnippet(long a, long b) {</span>
<span class="udiff-line-added">+         if (b + a - b &lt; 0) {</span>
<span class="udiff-line-added">+             return trueTarget - a;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return falseTarget + a;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testLessThanZero() {</span>
<span class="udiff-line-added">+         test(&quot;testLessThanZeroSnippet&quot;, 1L, 777L);</span>
<span class="udiff-line-added">+         test(&quot;testLessThanZeroSnippet&quot;, 0L, 777L);</span>
<span class="udiff-line-added">+         test(&quot;testLessThanZeroSnippet&quot;, -1L, 777L);</span>
<span class="udiff-line-added">+         checkLIR(&quot;testLessThanZeroSnippet&quot;, checkForBitTestAndBranchOp, 1);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static float testLessThanEqualZeroSnippet(long a) {</span>
<span class="udiff-line-added">+         if (a &lt;= 0) {</span>
<span class="udiff-line-added">+             return trueTarget - a;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return falseTarget + a;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testLessThanEqualZero() {</span>
<span class="udiff-line-added">+         test(&quot;testLessThanEqualZeroSnippet&quot;, 1L);</span>
<span class="udiff-line-added">+         test(&quot;testLessThanEqualZeroSnippet&quot;, 0L);</span>
<span class="udiff-line-added">+         test(&quot;testLessThanEqualZeroSnippet&quot;, -1L);</span>
<span class="udiff-line-added">+         checkLIR(&quot;testLessThanEqualZeroSnippet&quot;, checkForBitTestAndBranchOp, 0);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static float testGreaterThanZeroSnippet(int a) {</span>
<span class="udiff-line-added">+         if (a &gt; 0) {</span>
<span class="udiff-line-added">+             return trueTarget - a;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return falseTarget + a;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testGreaterThanZero() {</span>
<span class="udiff-line-added">+         test(&quot;testGreaterThanZeroSnippet&quot;, 1);</span>
<span class="udiff-line-added">+         test(&quot;testGreaterThanZeroSnippet&quot;, 0);</span>
<span class="udiff-line-added">+         test(&quot;testGreaterThanZeroSnippet&quot;, -1);</span>
<span class="udiff-line-added">+         checkLIR(&quot;testGreaterThanZeroSnippet&quot;, checkForBitTestAndBranchOp, 0);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public static float testGreaterThanEqualZeroSnippet(int a) {</span>
<span class="udiff-line-added">+         if (a &gt;= 0) {</span>
<span class="udiff-line-added">+             return trueTarget - a;</span>
<span class="udiff-line-added">+         } else {</span>
<span class="udiff-line-added">+             return falseTarget + a;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     public void testGreaterThanEqualZero() {</span>
<span class="udiff-line-added">+         test(&quot;testGreaterThanEqualZeroSnippet&quot;, 1);</span>
<span class="udiff-line-added">+         test(&quot;testGreaterThanEqualZeroSnippet&quot;, 0);</span>
<span class="udiff-line-added">+         test(&quot;testGreaterThanEqualZeroSnippet&quot;, -1);</span>
<span class="udiff-line-added">+         checkLIR(&quot;testGreaterThanEqualZeroSnippet&quot;, checkForBitTestAndBranchOp, 1);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private static class LargeOpSpec extends LIRTestSpecification {
          private final int n;
          private final int nopCount;
  
          LargeOpSpec(int n, int nopCount) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,11 +236,13 @@</span>
          return suites;
      }
  
      public class CheckPhase extends LIRPhase&lt;PreAllocationOptimizationContext&gt; {
          @Override
<span class="udiff-line-modified-removed">-         protected void run(TargetDescription target, LIRGenerationResult lirGenRes, PreAllocationOptimizationContext context) {</span>
<span class="udiff-line-modified-added">+         protected void run(</span>
<span class="udiff-line-added">+                         TargetDescription target, LIRGenerationResult lirGenRes,</span>
<span class="udiff-line-added">+                         PreAllocationOptimizationContext context) {</span>
              lir = lirGenRes.getLIR();
          }
      }
  
      protected void checkLIR(String methodName, Predicate&lt;LIRInstruction&gt; predicate, int expected) {
</pre>
<center><a href="AArch64CbzTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../org.graalvm.compiler.core.aarch64/src/org/graalvm/compiler/core/aarch64/AArch64ArithmeticLIRGenerator.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>