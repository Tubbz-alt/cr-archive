<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements/src/org/graalvm/compiler/replacements/PEGraphDecoder.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="NodeIntrinsificationProvider.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ReplacementsImpl.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements/src/org/graalvm/compiler/replacements/PEGraphDecoder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -93,10 +93,11 @@</span>
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.InvocationPluginReceiver;
  import org.graalvm.compiler.nodes.graphbuilderconf.LoopExplosionPlugin;
  import org.graalvm.compiler.nodes.graphbuilderconf.LoopExplosionPlugin.LoopExplosionKind;
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.graphbuilderconf.MethodSubstitutionPlugin;</span>
  import org.graalvm.compiler.nodes.graphbuilderconf.NodePlugin;
  import org.graalvm.compiler.nodes.graphbuilderconf.ParameterPlugin;
  import org.graalvm.compiler.nodes.java.LoadFieldNode;
  import org.graalvm.compiler.nodes.java.LoadIndexedNode;
  import org.graalvm.compiler.nodes.java.MethodCallTargetNode;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -104,10 +105,12 @@</span>
  import org.graalvm.compiler.nodes.java.NewArrayNode;
  import org.graalvm.compiler.nodes.java.NewInstanceNode;
  import org.graalvm.compiler.nodes.java.NewMultiArrayNode;
  import org.graalvm.compiler.nodes.java.StoreFieldNode;
  import org.graalvm.compiler.nodes.java.StoreIndexedNode;
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.spi.CoreProviders;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.nodes.spi.Replacements;</span>
  import org.graalvm.compiler.nodes.spi.StampProvider;
  import org.graalvm.compiler.nodes.type.StampTool;
  import org.graalvm.compiler.nodes.util.GraphUtil;
  import org.graalvm.compiler.options.Option;
  import org.graalvm.compiler.options.OptionKey;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -269,11 +272,11 @@</span>
                  @Override
                  public int getInlinedDepth() {
                      int count = 0;
                      PEGraphDecoder.PEMethodScope scope = methodScope;
                      while (scope != null) {
<span class="udiff-line-modified-removed">-                         if (scope.method.equals(callInlinedMethod)) {</span>
<span class="udiff-line-modified-added">+                         if (scope.method.equals(callInlinedMethod) || scope.method.equals(callInlinedAgnosticMethod)) {</span>
                              count++;
                          }
                          scope = scope.caller;
                      }
                      return count;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -296,37 +299,42 @@</span>
           * the plugins are run during the decoding process. If they aren&#39;t handled at this point
           * then they will never be handled.
           */
          @Override
          public boolean canDeferPlugin(GeneratedInvocationPlugin plugin) {
<span class="udiff-line-modified-removed">-             return plugin.getSource().equals(Fold.class) || plugin.getSource().equals(Node.NodeIntrinsic.class);</span>
<span class="udiff-line-modified-added">+             return plugin.isGeneratedFromFoldOrNodeIntrinsic();</span>
          }
  
          @Override
          public BailoutException bailout(String string) {
              BailoutException bailout = new PermanentBailoutException(string);
              throw GraphUtil.createBailoutException(string, bailout, GraphUtil.approxSourceStackTraceElement(methodScope.getCallerBytecodePosition()));
          }
  
          @Override
          public StampProvider getStampProvider() {
<span class="udiff-line-modified-removed">-             return stampProvider;</span>
<span class="udiff-line-modified-added">+             return providers.getStampProvider();</span>
          }
  
          @Override
          public MetaAccessProvider getMetaAccess() {
<span class="udiff-line-modified-removed">-             return metaAccess;</span>
<span class="udiff-line-modified-added">+             return providers.getMetaAccess();</span>
          }
  
          @Override
          public ConstantReflectionProvider getConstantReflection() {
<span class="udiff-line-modified-removed">-             return constantReflection;</span>
<span class="udiff-line-modified-added">+             return providers.getConstantReflection();</span>
          }
  
          @Override
          public ConstantFieldProvider getConstantFieldProvider() {
<span class="udiff-line-modified-removed">-             return constantFieldProvider;</span>
<span class="udiff-line-modified-added">+             return providers.getConstantFieldProvider();</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public Replacements getReplacements() {</span>
<span class="udiff-line-added">+             return providers.getReplacements();</span>
          }
  
          @Override
          public StructuredGraph getGraph() {
              return graph;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -337,11 +345,11 @@</span>
              return methodScope.inliningDepth;
          }
  
          @Override
          public IntrinsicContext getIntrinsic() {
<span class="udiff-line-modified-removed">-             return null;</span>
<span class="udiff-line-modified-added">+             return PEGraphDecoder.this.getIntrinsic();</span>
          }
  
          @Override
          public &lt;T extends ValueNode&gt; T append(T value) {
              throw unimplemented();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -365,10 +373,15 @@</span>
          @Override
          public boolean intrinsify(BytecodeProvider bytecodeProvider, ResolvedJavaMethod targetMethod, ResolvedJavaMethod substitute, InvocationPlugin.Receiver receiver, ValueNode[] args) {
              return false;
          }
  
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public boolean intrinsify(ResolvedJavaMethod targetMethod, StructuredGraph substituteGraph, InvocationPlugin.Receiver receiver, ValueNode[] argsIncludingReceiver) {</span>
<span class="udiff-line-added">+             return false;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          @Override
          public void setStateAfter(StateSplit stateSplit) {
              throw unimplemented();
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -413,10 +426,14 @@</span>
              }
              return fmt.toString();
          }
      }
  
<span class="udiff-line-added">+     protected IntrinsicContext getIntrinsic() {</span>
<span class="udiff-line-added">+         return null;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      protected class PEAppendGraphBuilderContext extends PENonAppendGraphBuilderContext {
          protected FixedWithNextNode lastInstr;
          protected ValueNode pushedNode;
          protected boolean invokeConsumed;
          protected final InvokeKind invokeKind;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -514,10 +531,15 @@</span>
              invokeConsumed = true;
  
              appendInvoke(methodScope.caller, methodScope.callerLoopScope, methodScope.invokeData, callTarget);
              updateLastInstruction(invoke.asNode());
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public GraphBuilderContext getNonIntrinsicAncestor() {</span>
<span class="udiff-line-added">+             return null;</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @NodeInfo(cycles = CYCLES_IGNORED, size = SIZE_IGNORED)
      static class ExceptionPlaceholderNode extends ValueNode {
          public static final NodeClass&lt;ExceptionPlaceholderNode&gt; TYPE = NodeClass.create(ExceptionPlaceholderNode.class);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -561,22 +583,24 @@</span>
      private final ParameterPlugin parameterPlugin;
      private final NodePlugin[] nodePlugins;
      private final EconomicMap&lt;SpecialCallTargetCacheKey, Object&gt; specialCallTargetCache;
      private final EconomicMap&lt;ResolvedJavaMethod, Object&gt; invocationPluginCache;
      private final ResolvedJavaMethod callInlinedMethod;
<span class="udiff-line-added">+     private final ResolvedJavaMethod callInlinedAgnosticMethod;</span>
      protected final SourceLanguagePositionProvider sourceLanguagePositionProvider;
  
<span class="udiff-line-modified-removed">-     public PEGraphDecoder(Architecture architecture, StructuredGraph graph, MetaAccessProvider metaAccess, ConstantReflectionProvider constantReflection, ConstantFieldProvider constantFieldProvider,</span>
<span class="udiff-line-modified-removed">-                     StampProvider stampProvider, LoopExplosionPlugin loopExplosionPlugin, InvocationPlugins invocationPlugins, InlineInvokePlugin[] inlineInvokePlugins,</span>
<span class="udiff-line-modified-added">+     public PEGraphDecoder(Architecture architecture, StructuredGraph graph, CoreProviders providers, LoopExplosionPlugin loopExplosionPlugin, InvocationPlugins invocationPlugins,</span>
<span class="udiff-line-modified-added">+                     InlineInvokePlugin[] inlineInvokePlugins,</span>
                      ParameterPlugin parameterPlugin,
<span class="udiff-line-modified-removed">-                     NodePlugin[] nodePlugins, ResolvedJavaMethod callInlinedMethod, SourceLanguagePositionProvider sourceLanguagePositionProvider) {</span>
<span class="udiff-line-modified-removed">-         super(architecture, graph, metaAccess, constantReflection, constantFieldProvider, stampProvider, true);</span>
<span class="udiff-line-modified-added">+                     NodePlugin[] nodePlugins, ResolvedJavaMethod callInlinedMethod, ResolvedJavaMethod callInlinedAgnosticMethod, SourceLanguagePositionProvider sourceLanguagePositionProvider) {</span>
<span class="udiff-line-modified-added">+         super(architecture, graph, providers, true);</span>
          this.loopExplosionPlugin = loopExplosionPlugin;
          this.invocationPlugins = invocationPlugins;
          this.inlineInvokePlugins = inlineInvokePlugins;
          this.parameterPlugin = parameterPlugin;
          this.nodePlugins = nodePlugins;
<span class="udiff-line-added">+         this.callInlinedAgnosticMethod = callInlinedAgnosticMethod;</span>
          this.specialCallTargetCache = EconomicMap.create(Equivalence.DEFAULT);
          this.invocationPluginCache = EconomicMap.create(Equivalence.DEFAULT);
          this.callInlinedMethod = callInlinedMethod;
          this.sourceLanguagePositionProvider = sourceLanguagePositionProvider;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -820,14 +844,14 @@</span>
          GraphBuilderContext graphBuilderContext = new PENonAppendGraphBuilderContext(methodScope, invokeData.invoke);
  
          for (InlineInvokePlugin plugin : inlineInvokePlugins) {
              InlineInfo inlineInfo = plugin.shouldInlineInvoke(graphBuilderContext, targetMethod, arguments);
              if (inlineInfo != null) {
<span class="udiff-line-modified-removed">-                 if (inlineInfo.getMethodToInline() == null) {</span>
<span class="udiff-line-removed">-                     return null;</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-modified-added">+                 if (inlineInfo.allowsInlining()) {</span>
                      return doInline(methodScope, loopScope, invokeData, inlineInfo, arguments);
<span class="udiff-line-added">+                 } else {</span>
<span class="udiff-line-added">+                     return null;</span>
                  }
              }
          }
          return null;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -835,13 +859,11 @@</span>
      protected LoopScope doInline(PEMethodScope methodScope, LoopScope loopScope, InvokeData invokeData, InlineInfo inlineInfo, ValueNode[] arguments) {
          if (!invokeData.invoke.useForInlining()) {
              return null;
          }
          ResolvedJavaMethod inlineMethod = inlineInfo.getMethodToInline();
<span class="udiff-line-modified-removed">-         ResolvedJavaMethod originalMethod = inlineInfo.getOriginalMethod();</span>
<span class="udiff-line-removed">-         boolean isSubstitution = originalMethod != null &amp;&amp; !originalMethod.equals(inlineMethod);</span>
<span class="udiff-line-removed">-         EncodedGraph graphToInline = lookupEncodedGraph(inlineMethod, originalMethod, inlineInfo.getIntrinsicBytecodeProvider(), isSubstitution, graph.trackNodeSourcePosition());</span>
<span class="udiff-line-modified-added">+         EncodedGraph graphToInline = lookupEncodedGraph(inlineMethod, inlineInfo.getPlugin(), inlineInfo.getIntrinsicBytecodeProvider(), inlineInfo.isSubstitution(), graph.trackNodeSourcePosition());</span>
          if (graphToInline == null) {
              return null;
          }
  
          assert !graph.trackNodeSourcePosition() || graphToInline.trackNodeSourcePosition() : graph + &quot; &quot; + graphToInline;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1106,11 +1128,11 @@</span>
          if (frameState != null &amp;&amp; frameState.hasNoUsages()) {
              frameState.safeDelete();
          }
      }
  
<span class="udiff-line-modified-removed">-     protected abstract EncodedGraph lookupEncodedGraph(ResolvedJavaMethod method, ResolvedJavaMethod originalMethod, BytecodeProvider intrinsicBytecodeProvider, boolean isSubstitution,</span>
<span class="udiff-line-modified-added">+     protected abstract EncodedGraph lookupEncodedGraph(ResolvedJavaMethod method, MethodSubstitutionPlugin plugin, BytecodeProvider intrinsicBytecodeProvider, boolean isSubstitution,</span>
                      boolean trackNodeSourcePosition);
  
      @Override
      protected void handleFixedNode(MethodScope s, LoopScope loopScope, int nodeOrderId, FixedNode node) {
          PEMethodScope methodScope = (PEMethodScope) s;
</pre>
<center><a href="NodeIntrinsificationProvider.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ReplacementsImpl.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>