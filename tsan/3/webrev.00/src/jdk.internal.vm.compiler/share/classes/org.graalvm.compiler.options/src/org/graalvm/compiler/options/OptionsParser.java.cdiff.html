<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.options/src/org/graalvm/compiler/options/OptionsParser.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="OptionValues.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../org.graalvm.compiler.phases.common/src/org/graalvm/compiler/phases/common/AddressLoweringByUsePhase.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.options/src/org/graalvm/compiler/options/OptionsParser.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 49,33 ***</span>
       */
      public static Iterable&lt;OptionDescriptors&gt; getOptionsLoader() {
          if (IS_IN_NATIVE_IMAGE || cachedOptionDescriptors != null) {
              return cachedOptionDescriptors;
          }
<span class="line-modified">!         boolean java8OrEarlier = System.getProperty(&quot;java.specification.version&quot;).compareTo(&quot;1.9&quot;) &lt; 0;</span>
<span class="line-modified">!         ClassLoader loader;</span>
<span class="line-modified">!         if (java8OrEarlier) {</span>
<span class="line-modified">!             // On JDK 8, Graal and its extensions are loaded by same class loader.</span>
<span class="line-modified">!             loader = OptionDescriptors.class.getClassLoader();</span>
<span class="line-modified">!         } else {</span>
<span class="line-removed">-             /*</span>
<span class="line-removed">-              * The Graal module (i.e., jdk.internal.vm.compiler) is loaded by the platform class</span>
<span class="line-removed">-              * loader as of JDK 9. Modules that depend on and extend Graal are loaded by the app</span>
<span class="line-removed">-              * class loader. As such, we need to start the provider search at the app class loader</span>
<span class="line-removed">-              * instead of the platform class loader.</span>
<span class="line-removed">-              */</span>
<span class="line-removed">-             loader = ClassLoader.getSystemClassLoader();</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         Iterable&lt;OptionDescriptors&gt; result = ServiceLoader.load(OptionDescriptors.class, loader);</span>
<span class="line-removed">-         if (IS_BUILDING_NATIVE_IMAGE) {</span>
<span class="line-removed">-             ArrayList&lt;OptionDescriptors&gt; optionDescriptors = new ArrayList&lt;&gt;();</span>
<span class="line-removed">-             for (OptionDescriptors descriptors : result) {</span>
<span class="line-removed">-                 optionDescriptors.add(descriptors);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             OptionsParser.cachedOptionDescriptors = optionDescriptors;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return result;</span>
      }
  
      /**
       * Parses a map representing assignments of values to options.
       *
<span class="line-new-header">--- 49,16 ---</span>
       */
      public static Iterable&lt;OptionDescriptors&gt; getOptionsLoader() {
          if (IS_IN_NATIVE_IMAGE || cachedOptionDescriptors != null) {
              return cachedOptionDescriptors;
          }
<span class="line-modified">!         return ModuleSupport.getOptionsLoader();</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     public static void setCachedOptionDescriptors(List&lt;OptionDescriptors&gt; list) {</span>
<span class="line-modified">!         assert IS_BUILDING_NATIVE_IMAGE : &quot;Used to pre-initialize the option descriptors during native image generation&quot;;</span>
<span class="line-modified">!         OptionsParser.cachedOptionDescriptors = list;</span>
      }
  
      /**
       * Parses a map representing assignments of values to options.
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 147,35 ***</span>
                  }
              }
              throw new IllegalArgumentException(msg.toString());
          }
  
          Class&lt;?&gt; optionType = desc.getOptionValueType();
          Object value;
          if (!(uncheckedValue instanceof String)) {
              if (optionType != uncheckedValue.getClass()) {
                  String type = optionType.getSimpleName();
<span class="line-modified">!                 throw new IllegalArgumentException(type + &quot; option &#39;&quot; + name + &quot;&#39; must have &quot; + type + &quot; value, not &quot; + uncheckedValue.getClass() + &quot; [toString: &quot; + uncheckedValue + &quot;]&quot;);</span>
              }
              value = uncheckedValue;
          } else {
              String valueString = (String) uncheckedValue;
              if (optionType == Boolean.class) {
                  if (&quot;true&quot;.equals(valueString)) {
                      value = Boolean.TRUE;
                  } else if (&quot;false&quot;.equals(valueString)) {
                      value = Boolean.FALSE;
                  } else {
<span class="line-modified">!                     throw new IllegalArgumentException(&quot;Boolean option &#39;&quot; + name + &quot;&#39; must have value \&quot;true\&quot; or \&quot;false\&quot;, not \&quot;&quot; + uncheckedValue + &quot;\&quot;&quot;);</span>
                  }
              } else if (optionType == String.class) {
                  value = valueString;
              } else if (Enum.class.isAssignableFrom(optionType)) {
                  value = ((EnumOptionKey&lt;?&gt;) desc.getOptionKey()).valueOf(valueString);
              } else {
                  if (valueString.isEmpty()) {
<span class="line-modified">!                     throw new IllegalArgumentException(&quot;Non empty value required for option &#39;&quot; + name + &quot;&#39;&quot;);</span>
                  }
                  try {
                      if (optionType == Float.class) {
                          value = Float.parseFloat(valueString);
                      } else if (optionType == Double.class) {
<span class="line-new-header">--- 130,42 ---</span>
                  }
              }
              throw new IllegalArgumentException(msg.toString());
          }
  
<span class="line-added">+         Object value = parseOptionValue(desc, uncheckedValue);</span>
<span class="line-added">+ </span>
<span class="line-added">+         desc.getOptionKey().update(values, value);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     /** Parses a given option value with a known descriptor. */</span>
<span class="line-added">+     public static Object parseOptionValue(OptionDescriptor desc, Object uncheckedValue) {</span>
          Class&lt;?&gt; optionType = desc.getOptionValueType();
          Object value;
          if (!(uncheckedValue instanceof String)) {
              if (optionType != uncheckedValue.getClass()) {
                  String type = optionType.getSimpleName();
<span class="line-modified">!                 throw new IllegalArgumentException(type + &quot; option &#39;&quot; + desc.getName() + &quot;&#39; must have &quot; + type + &quot; value, not &quot; + uncheckedValue.getClass() + &quot; [toString: &quot; + uncheckedValue + &quot;]&quot;);</span>
              }
              value = uncheckedValue;
          } else {
              String valueString = (String) uncheckedValue;
              if (optionType == Boolean.class) {
                  if (&quot;true&quot;.equals(valueString)) {
                      value = Boolean.TRUE;
                  } else if (&quot;false&quot;.equals(valueString)) {
                      value = Boolean.FALSE;
                  } else {
<span class="line-modified">!                     throw new IllegalArgumentException(&quot;Boolean option &#39;&quot; + desc.getName() + &quot;&#39; must have value \&quot;true\&quot; or \&quot;false\&quot;, not \&quot;&quot; + uncheckedValue + &quot;\&quot;&quot;);</span>
                  }
              } else if (optionType == String.class) {
                  value = valueString;
              } else if (Enum.class.isAssignableFrom(optionType)) {
                  value = ((EnumOptionKey&lt;?&gt;) desc.getOptionKey()).valueOf(valueString);
              } else {
                  if (valueString.isEmpty()) {
<span class="line-modified">!                     throw new IllegalArgumentException(&quot;Non empty value required for option &#39;&quot; + desc.getName() + &quot;&#39;&quot;);</span>
                  }
                  try {
                      if (optionType == Float.class) {
                          value = Float.parseFloat(valueString);
                      } else if (optionType == Double.class) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 183,19 ***</span>
                      } else if (optionType == Integer.class) {
                          value = Integer.valueOf((int) parseLong(valueString));
                      } else if (optionType == Long.class) {
                          value = Long.valueOf(parseLong(valueString));
                      } else {
<span class="line-modified">!                         throw new IllegalArgumentException(&quot;Wrong value for option &#39;&quot; + name + &quot;&#39;&quot;);</span>
                      }
                  } catch (NumberFormatException nfe) {
<span class="line-modified">!                     throw new IllegalArgumentException(&quot;Value for option &#39;&quot; + name + &quot;&#39; has invalid number format: &quot; + valueString);</span>
                  }
              }
          }
<span class="line-modified">! </span>
<span class="line-removed">-         desc.getOptionKey().update(values, value);</span>
      }
  
      private static long parseLong(String v) {
          String valueString = v.toLowerCase();
          long scale = 1;
<span class="line-new-header">--- 173,18 ---</span>
                      } else if (optionType == Integer.class) {
                          value = Integer.valueOf((int) parseLong(valueString));
                      } else if (optionType == Long.class) {
                          value = Long.valueOf(parseLong(valueString));
                      } else {
<span class="line-modified">!                         throw new IllegalArgumentException(&quot;Wrong value for option &#39;&quot; + desc.getName() + &quot;&#39;&quot;);</span>
                      }
                  } catch (NumberFormatException nfe) {
<span class="line-modified">!                     throw new IllegalArgumentException(&quot;Value for option &#39;&quot; + desc.getName() + &quot;&#39; has invalid number format: &quot; + valueString);</span>
                  }
              }
          }
<span class="line-modified">!         return value;</span>
      }
  
      private static long parseLong(String v) {
          String valueString = v.toLowerCase();
          long scale = 1;
</pre>
<center><a href="OptionValues.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../org.graalvm.compiler.phases.common/src/org/graalvm/compiler/phases/common/AddressLoweringByUsePhase.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>