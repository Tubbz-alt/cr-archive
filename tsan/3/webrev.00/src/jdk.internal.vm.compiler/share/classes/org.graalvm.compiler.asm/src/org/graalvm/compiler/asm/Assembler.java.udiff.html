<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.asm/src/org/graalvm/compiler/asm/Assembler.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../org.graalvm.compiler.asm.test/src/org/graalvm/compiler/asm/test/AssemblerTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="Buffer.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.asm/src/org/graalvm/compiler/asm/Assembler.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2009, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2009, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,10 +28,12 @@</span>
  import java.util.HashMap;
  import java.util.List;
  import java.util.Map;
  import java.util.function.Consumer;
  
<span class="udiff-line-added">+ import org.graalvm.compiler.debug.GraalError;</span>
<span class="udiff-line-added">+ </span>
  import jdk.vm.ci.code.Register;
  import jdk.vm.ci.code.StackSlot;
  import jdk.vm.ci.code.TargetDescription;
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -51,10 +53,15 @@</span>
      }
  
      public final TargetDescription target;
      private List&lt;LabelHint&gt; jumpDisplacementHints;
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Labels with instructions to be patched when it is {@linkplain Label#bind bound}.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     Label labelsWithPatches;</span>
<span class="udiff-line-added">+ </span>
      /**
       * Backing code buffer.
       */
      private final Buffer codeBuffer;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -121,11 +128,11 @@</span>
  
      public final int getInt(int pos) {
          return codeBuffer.getInt(pos);
      }
  
<span class="udiff-line-modified-removed">-     private static final String NEWLINE = System.getProperty(&quot;line.separator&quot;);</span>
<span class="udiff-line-modified-added">+     private static final String NEWLINE = System.lineSeparator();</span>
  
      /**
       * Some GPU architectures have a text based encoding.
       */
      public final void emitString(String x) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -149,17 +156,34 @@</span>
       * @param trimmedCopy if {@code true}, then a copy of the underlying byte array up to (but not
       *            including) {@code position()} is returned
       * @return the data in this buffer or a trimmed copy if {@code trimmedCopy} is {@code true}
       */
      public byte[] close(boolean trimmedCopy) {
<span class="udiff-line-added">+         checkAndClearLabelsWithPatches();</span>
          return codeBuffer.close(trimmedCopy);
      }
  
<span class="udiff-line-added">+     public byte[] copy(int start, int end) {</span>
<span class="udiff-line-added">+         return codeBuffer.copyData(start, end);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private void checkAndClearLabelsWithPatches() throws InternalError {</span>
<span class="udiff-line-added">+         Label label = labelsWithPatches;</span>
<span class="udiff-line-added">+         while (label != null) {</span>
<span class="udiff-line-added">+             if (label.patchPositions != null) {</span>
<span class="udiff-line-added">+                 throw new GraalError(&quot;Label used by instructions at following offsets has not been bound: %s&quot;, label.patchPositions);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             Label next = label.nextWithPatches;</span>
<span class="udiff-line-added">+             label.nextWithPatches = null;</span>
<span class="udiff-line-added">+             label = next;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         labelsWithPatches = null;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public void bind(Label l) {
          assert !l.isBound() : &quot;can bind label only once&quot;;
<span class="udiff-line-modified-removed">-         l.bind(position());</span>
<span class="udiff-line-removed">-         l.patchInstructions(this);</span>
<span class="udiff-line-modified-added">+         l.bind(position(), this);</span>
      }
  
      public abstract void align(int modulus);
  
      public abstract void jmp(Label l);
</pre>
<center><a href="../../../../../../org.graalvm.compiler.asm.test/src/org/graalvm/compiler/asm/test/AssemblerTest.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="Buffer.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>