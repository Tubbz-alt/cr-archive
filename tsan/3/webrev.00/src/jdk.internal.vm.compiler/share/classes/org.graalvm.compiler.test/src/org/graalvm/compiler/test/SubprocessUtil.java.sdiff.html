<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.test/src/org/graalvm/compiler/test/SubprocessUtil.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GraalTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../org.graalvm.compiler.virtual/src/org/graalvm/compiler/virtual/phases/ea/EarlyReadEliminationPhase.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.test/src/org/graalvm/compiler/test/SubprocessUtil.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.test;
 26 
 27 import java.io.BufferedReader;
 28 import java.io.File;
 29 import java.io.IOException;
 30 import java.io.InputStreamReader;
 31 import java.nio.file.Files;


 32 import java.util.ArrayList;
 33 import java.util.Arrays;
 34 import java.util.Formatter;
 35 import java.util.List;
 36 import java.util.Map;

 37 import java.util.regex.Matcher;
 38 import java.util.regex.Pattern;
 39 
 40 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;
 41 import org.graalvm.util.CollectionsUtil;
 42 import org.junit.Assume;
 43 
 44 /**
 45  * Utility methods for spawning a VM in a subprocess during unit tests.
 46  */
 47 public final class SubprocessUtil {
 48 








 49     private SubprocessUtil() {
 50     }
 51 
 52     /**
 53      * Gets the command line for the current process.
 54      *
 55      * @return the command line arguments for the current process or {@code null} if they are not
 56      *         available
 57      */
 58     public static List&lt;String&gt; getProcessCommandLine() {
 59         String processArgsFile = System.getenv().get(&quot;MX_SUBPROCESS_COMMAND_FILE&quot;);
 60         if (processArgsFile != null) {
 61             try {
 62                 return Files.readAllLines(new File(processArgsFile).toPath());
 63             } catch (IOException e) {
 64             }
 65         } else {
 66             Assume.assumeTrue(&quot;Process command line unavailable&quot;, false);
 67         }
 68         return null;
</pre>
<hr />
<pre>
 84         if (m.matches()) {
 85             return arg;
 86         }
 87         // See http://stackoverflow.com/a/1250279
 88         return &quot;&#39;&quot; + arg.replace(&quot;&#39;&quot;, &quot;&#39;\&quot;&#39;\&quot;&#39;&quot;) + &quot;&#39;&quot;;
 89     }
 90 
 91     /**
 92      * Returns a new copy {@code args} with debugger arguments removed.
 93      */
 94     public static List&lt;String&gt; withoutDebuggerArguments(List&lt;String&gt; args) {
 95         List&lt;String&gt; result = new ArrayList&lt;&gt;(args.size());
 96         for (String arg : args) {
 97             if (!(arg.equals(&quot;-Xdebug&quot;) || arg.startsWith(&quot;-Xrunjdwp:&quot;))) {
 98                 result.add(arg);
 99             }
100         }
101         return result;
102     }
103 




















104     /**
105      * Gets the command line used to start the current Java VM, including all VM arguments, but not
106      * including the main class or any Java arguments. This can be used to spawn an identical VM,
107      * but running different Java code.
108      */
109     public static List&lt;String&gt; getVMCommandLine() {
110         List&lt;String&gt; args = getProcessCommandLine();
111         if (args == null) {
112             return null;
113         } else {
114             int index = findMainClassIndex(args);
115             return args.subList(0, index);
116         }
117     }
118 
119     /**
<span class="line-modified">120      * Detects whether a java agent is attached.</span>













121      */
122     public static boolean isJavaAgentAttached() {
<span class="line-modified">123         return SubprocessUtil.getVMCommandLine().stream().anyMatch(args -&gt; args.startsWith(&quot;-javaagent&quot;));</span>







124     }
125 
126     /**
127      * The details of a subprocess execution.
128      */
129     public static class Subprocess {
130 
131         /**
132          * The command line of the subprocess.
133          */
134         public final List&lt;String&gt; command;
135 
136         /**
137          * Exit code of the subprocess.
138          */
139         public final int exitCode;
140 
141         /**
142          * Output from the subprocess broken into lines.
143          */
144         public final List&lt;String&gt; output;
145 
<span class="line-modified">146         public Subprocess(List&lt;String&gt; command, int exitCode, List&lt;String&gt; output) {</span>





147             this.command = command;

148             this.exitCode = exitCode;
149             this.output = output;
150         }
151 
152         public static final String DASHES_DELIMITER = &quot;-------------------------------------------------------&quot;;
153 
154         /**
155          * Returns the command followed by the output as a string.
156          *
157          * @param delimiter if non-null, the returned string has this value as a prefix and suffix
158          */
159         public String toString(String delimiter) {
160             Formatter msg = new Formatter();
161             if (delimiter != null) {
162                 msg.format(&quot;%s%n&quot;, delimiter);
163             }







164             msg.format(&quot;%s%n&quot;, CollectionsUtil.mapAndJoin(command, e -&gt; quoteShellArg(String.valueOf(e)), &quot; &quot;));
165             for (String line : output) {
166                 msg.format(&quot;%s%n&quot;, line);
167             }
168             if (delimiter != null) {
169                 msg.format(&quot;%s%n&quot;, delimiter);
170             }
171             return msg.toString();
172         }
173 
174         /**
175          * Returns the command followed by the output as a string delimited by
176          * {@value #DASHES_DELIMITER}.
177          */
178         @Override
179         public String toString() {
180             return toString(DASHES_DELIMITER);
181         }
182     }
183 








184     /**
185      * Executes a Java subprocess.
186      *
187      * @param vmArgs the VM arguments
188      * @param mainClassAndArgs the main class and its arguments
189      */
190     public static Subprocess java(List&lt;String&gt; vmArgs, String... mainClassAndArgs) throws IOException, InterruptedException {
191         return java(vmArgs, Arrays.asList(mainClassAndArgs));
192     }
193 
194     /**
195      * Executes a Java subprocess.
196      *
197      * @param vmArgs the VM arguments
198      * @param mainClassAndArgs the main class and its arguments
199      */
200     public static Subprocess java(List&lt;String&gt; vmArgs, List&lt;String&gt; mainClassAndArgs) throws IOException, InterruptedException {
201         return javaHelper(vmArgs, null, mainClassAndArgs);
202     }
203 
</pre>
<hr />
<pre>
214 
215     /**
216      * Executes a Java subprocess.
217      *
218      * @param vmArgs the VM arguments
219      * @param env the environment variables
220      * @param mainClassAndArgs the main class and its arguments
221      */
222     public static Subprocess java(List&lt;String&gt; vmArgs, Map&lt;String, String&gt; env, List&lt;String&gt; mainClassAndArgs) throws IOException, InterruptedException {
223         return javaHelper(vmArgs, env, mainClassAndArgs);
224     }
225 
226     /**
227      * Executes a Java subprocess.
228      *
229      * @param vmArgs the VM arguments
230      * @param env the environment variables
231      * @param mainClassAndArgs the main class and its arguments
232      */
233     private static Subprocess javaHelper(List&lt;String&gt; vmArgs, Map&lt;String, String&gt; env, List&lt;String&gt; mainClassAndArgs) throws IOException, InterruptedException {
<span class="line-modified">234         List&lt;String&gt; command = new ArrayList&lt;&gt;(vmArgs);</span>















235         command.addAll(mainClassAndArgs);
236         ProcessBuilder processBuilder = new ProcessBuilder(command);
237         if (env != null) {
238             Map&lt;String, String&gt; processBuilderEnv = processBuilder.environment();
239             processBuilderEnv.putAll(env);
240         }
241         processBuilder.redirectErrorStream(true);
<span class="line-modified">242         Process process = processBuilder.start();</span>
<span class="line-modified">243         BufferedReader stdout = new BufferedReader(new InputStreamReader(process.getInputStream()));</span>
<span class="line-modified">244         String line;</span>
<span class="line-modified">245         List&lt;String&gt; output = new ArrayList&lt;&gt;();</span>
<span class="line-modified">246         while ((line = stdout.readLine()) != null) {</span>
<span class="line-modified">247             output.add(line);</span>









248         }
<span class="line-removed">249         return new Subprocess(command, process.waitFor(), output);</span>
250     }
251 
<span class="line-modified">252     private static final boolean isJava8OrEarlier = JavaVersionUtil.Java8OrEarlier;</span>
253 
254     private static boolean hasArg(String optionName) {
255         if (optionName.equals(&quot;-cp&quot;) || optionName.equals(&quot;-classpath&quot;)) {
256             return true;
257         }
258         if (!isJava8OrEarlier) {
259             if (optionName.equals(&quot;--version&quot;) ||
260                             optionName.equals(&quot;--show-version&quot;) ||
261                             optionName.equals(&quot;--dry-run&quot;) ||
262                             optionName.equals(&quot;--disable-@files&quot;) ||
263                             optionName.equals(&quot;--dry-run&quot;) ||
264                             optionName.equals(&quot;--help&quot;) ||
265                             optionName.equals(&quot;--help-extra&quot;)) {
266                 return false;
267             }
268             if (optionName.startsWith(&quot;--&quot;)) {
269                 return optionName.indexOf(&#39;=&#39;) == -1;
270             }
271         }
272         return false;
273     }
274 
275     private static int findMainClassIndex(List&lt;String&gt; commandLine) {
276         int i = 1; // Skip the java executable
277 
278         while (i &lt; commandLine.size()) {
279             String s = commandLine.get(i);
280             if (s.charAt(0) != &#39;-&#39;) {
<span class="line-modified">281                 return i;</span>




282             } else if (hasArg(s)) {
283                 i += 2;
284             } else {
285                 i++;
286             }
287         }
288         throw new InternalError();
289     }
290 
291 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.test;
 26 
 27 import java.io.BufferedReader;
 28 import java.io.File;
 29 import java.io.IOException;
 30 import java.io.InputStreamReader;
 31 import java.nio.file.Files;
<span class="line-added"> 32 import java.nio.file.Path;</span>
<span class="line-added"> 33 import java.nio.file.Paths;</span>
 34 import java.util.ArrayList;
 35 import java.util.Arrays;
 36 import java.util.Formatter;
 37 import java.util.List;
 38 import java.util.Map;
<span class="line-added"> 39 import java.util.function.Predicate;</span>
 40 import java.util.regex.Matcher;
 41 import java.util.regex.Pattern;
 42 
 43 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;
 44 import org.graalvm.util.CollectionsUtil;
 45 import org.junit.Assume;
 46 
 47 /**
 48  * Utility methods for spawning a VM in a subprocess during unit tests.
 49  */
 50 public final class SubprocessUtil {
 51 
<span class="line-added"> 52     /**</span>
<span class="line-added"> 53      * The name of the boolean system property that can be set to preserve temporary files created</span>
<span class="line-added"> 54      * as arguments files passed to the java launcher.</span>
<span class="line-added"> 55      *</span>
<span class="line-added"> 56      * @see &quot;https://docs.oracle.com/javase/9/tools/java.htm#JSWOR-GUID-4856361B-8BFD-4964-AE84-121F5F6CF111&quot;</span>
<span class="line-added"> 57      */</span>
<span class="line-added"> 58     public static final String KEEP_TEMPORARY_ARGUMENT_FILES_PROPERTY_NAME = &quot;test.&quot; + SubprocessUtil.class.getSimpleName() + &quot;.keepTempArgumentFiles&quot;;</span>
<span class="line-added"> 59 </span>
 60     private SubprocessUtil() {
 61     }
 62 
 63     /**
 64      * Gets the command line for the current process.
 65      *
 66      * @return the command line arguments for the current process or {@code null} if they are not
 67      *         available
 68      */
 69     public static List&lt;String&gt; getProcessCommandLine() {
 70         String processArgsFile = System.getenv().get(&quot;MX_SUBPROCESS_COMMAND_FILE&quot;);
 71         if (processArgsFile != null) {
 72             try {
 73                 return Files.readAllLines(new File(processArgsFile).toPath());
 74             } catch (IOException e) {
 75             }
 76         } else {
 77             Assume.assumeTrue(&quot;Process command line unavailable&quot;, false);
 78         }
 79         return null;
</pre>
<hr />
<pre>
 95         if (m.matches()) {
 96             return arg;
 97         }
 98         // See http://stackoverflow.com/a/1250279
 99         return &quot;&#39;&quot; + arg.replace(&quot;&#39;&quot;, &quot;&#39;\&quot;&#39;\&quot;&#39;&quot;) + &quot;&#39;&quot;;
100     }
101 
102     /**
103      * Returns a new copy {@code args} with debugger arguments removed.
104      */
105     public static List&lt;String&gt; withoutDebuggerArguments(List&lt;String&gt; args) {
106         List&lt;String&gt; result = new ArrayList&lt;&gt;(args.size());
107         for (String arg : args) {
108             if (!(arg.equals(&quot;-Xdebug&quot;) || arg.startsWith(&quot;-Xrunjdwp:&quot;))) {
109                 result.add(arg);
110             }
111         }
112         return result;
113     }
114 
<span class="line-added">115     /**</span>
<span class="line-added">116      * Gets the command line options to do the same package opening and exporting specified by the</span>
<span class="line-added">117      * {@code --open-packages} option to the {@code mx unittest} command.</span>
<span class="line-added">118      *</span>
<span class="line-added">119      * Properties defined in {@code com.oracle.mxtool.junit.MxJUnitWrapper}.</span>
<span class="line-added">120      */</span>
<span class="line-added">121     public static List&lt;String&gt; getPackageOpeningOptions() {</span>
<span class="line-added">122         List&lt;String&gt; result = new ArrayList&lt;&gt;();</span>
<span class="line-added">123         String[] actions = {&quot;opens&quot;, &quot;exports&quot;};</span>
<span class="line-added">124         for (String action : actions) {</span>
<span class="line-added">125             String opens = System.getProperty(&quot;com.oracle.mxtool.junit.&quot; + action);</span>
<span class="line-added">126             if (opens != null &amp;&amp; !opens.isEmpty()) {</span>
<span class="line-added">127                 for (String value : opens.split(System.lineSeparator())) {</span>
<span class="line-added">128                     result.add(&quot;--add-&quot; + action + &quot;=&quot; + value);</span>
<span class="line-added">129                 }</span>
<span class="line-added">130             }</span>
<span class="line-added">131         }</span>
<span class="line-added">132         return result;</span>
<span class="line-added">133     }</span>
<span class="line-added">134 </span>
135     /**
136      * Gets the command line used to start the current Java VM, including all VM arguments, but not
137      * including the main class or any Java arguments. This can be used to spawn an identical VM,
138      * but running different Java code.
139      */
140     public static List&lt;String&gt; getVMCommandLine() {
141         List&lt;String&gt; args = getProcessCommandLine();
142         if (args == null) {
143             return null;
144         } else {
145             int index = findMainClassIndex(args);
146             return args.subList(0, index);
147         }
148     }
149 
150     /**
<span class="line-modified">151      * Detects whether a Java agent matching {@code agentPredicate} is specified in the VM</span>
<span class="line-added">152      * arguments.</span>
<span class="line-added">153      *</span>
<span class="line-added">154      * @param agentPredicate a predicate that is given the value of a {@code -javaagent} VM argument</span>
<span class="line-added">155      */</span>
<span class="line-added">156     public static boolean isJavaAgentAttached(Predicate&lt;String&gt; agentPredicate) {</span>
<span class="line-added">157         return SubprocessUtil.getVMCommandLine().stream().//</span>
<span class="line-added">158                         filter(args -&gt; args.startsWith(&quot;-javaagent:&quot;)).//</span>
<span class="line-added">159                         map(s -&gt; s.substring(&quot;-javaagent:&quot;.length())).//</span>
<span class="line-added">160                         anyMatch(agentPredicate);</span>
<span class="line-added">161     }</span>
<span class="line-added">162 </span>
<span class="line-added">163     /**</span>
<span class="line-added">164      * Detects whether a Java agent is specified in the VM arguments.</span>
165      */
166     public static boolean isJavaAgentAttached() {
<span class="line-modified">167         return isJavaAgentAttached(javaAgentValue -&gt; true);</span>
<span class="line-added">168     }</span>
<span class="line-added">169 </span>
<span class="line-added">170     /**</span>
<span class="line-added">171      * Detects whether the JaCoCo Java agent is specified in the VM arguments.</span>
<span class="line-added">172      */</span>
<span class="line-added">173     public static boolean isJaCoCoAttached() {</span>
<span class="line-added">174         return isJavaAgentAttached(s -&gt; s.toLowerCase().contains(&quot;jacoco&quot;));</span>
175     }
176 
177     /**
178      * The details of a subprocess execution.
179      */
180     public static class Subprocess {
181 
182         /**
183          * The command line of the subprocess.
184          */
185         public final List&lt;String&gt; command;
186 
187         /**
188          * Exit code of the subprocess.
189          */
190         public final int exitCode;
191 
192         /**
193          * Output from the subprocess broken into lines.
194          */
195         public final List&lt;String&gt; output;
196 
<span class="line-modified">197         /**</span>
<span class="line-added">198          * Explicit environment variables.</span>
<span class="line-added">199          */</span>
<span class="line-added">200         private Map&lt;String, String&gt; env;</span>
<span class="line-added">201 </span>
<span class="line-added">202         public Subprocess(List&lt;String&gt; command, Map&lt;String, String&gt; env, int exitCode, List&lt;String&gt; output) {</span>
203             this.command = command;
<span class="line-added">204             this.env = env;</span>
205             this.exitCode = exitCode;
206             this.output = output;
207         }
208 
209         public static final String DASHES_DELIMITER = &quot;-------------------------------------------------------&quot;;
210 
211         /**
212          * Returns the command followed by the output as a string.
213          *
214          * @param delimiter if non-null, the returned string has this value as a prefix and suffix
215          */
216         public String toString(String delimiter) {
217             Formatter msg = new Formatter();
218             if (delimiter != null) {
219                 msg.format(&quot;%s%n&quot;, delimiter);
220             }
<span class="line-added">221             if (env != null &amp;&amp; !env.isEmpty()) {</span>
<span class="line-added">222                 msg.format(&quot;env&quot;);</span>
<span class="line-added">223                 for (Map.Entry&lt;String, String&gt; e : env.entrySet()) {</span>
<span class="line-added">224                     msg.format(&quot; %s=%s&quot;, e.getKey(), quoteShellArg(e.getValue()));</span>
<span class="line-added">225                 }</span>
<span class="line-added">226                 msg.format(&quot;\\%n&quot;);</span>
<span class="line-added">227             }</span>
228             msg.format(&quot;%s%n&quot;, CollectionsUtil.mapAndJoin(command, e -&gt; quoteShellArg(String.valueOf(e)), &quot; &quot;));
229             for (String line : output) {
230                 msg.format(&quot;%s%n&quot;, line);
231             }
232             if (delimiter != null) {
233                 msg.format(&quot;%s%n&quot;, delimiter);
234             }
235             return msg.toString();
236         }
237 
238         /**
239          * Returns the command followed by the output as a string delimited by
240          * {@value #DASHES_DELIMITER}.
241          */
242         @Override
243         public String toString() {
244             return toString(DASHES_DELIMITER);
245         }
246     }
247 
<span class="line-added">248     /**</span>
<span class="line-added">249      * A sentinel value which when present in the {@code vmArgs} parameter for any of the</span>
<span class="line-added">250      * {@code java(...)} methods in this class is replaced with a temporary argument file containing</span>
<span class="line-added">251      * the contents of {@link #getPackageOpeningOptions}. The argument file is preserved if the</span>
<span class="line-added">252      * {@link #KEEP_TEMPORARY_ARGUMENT_FILES_PROPERTY_NAME} system property is true.</span>
<span class="line-added">253      */</span>
<span class="line-added">254     public static final String PACKAGE_OPENING_OPTIONS = &quot;;:PACKAGE_OPENING_OPTIONS_IN_TEMPORARY_ARGUMENTS_FILE:;&quot;;</span>
<span class="line-added">255 </span>
256     /**
257      * Executes a Java subprocess.
258      *
259      * @param vmArgs the VM arguments
260      * @param mainClassAndArgs the main class and its arguments
261      */
262     public static Subprocess java(List&lt;String&gt; vmArgs, String... mainClassAndArgs) throws IOException, InterruptedException {
263         return java(vmArgs, Arrays.asList(mainClassAndArgs));
264     }
265 
266     /**
267      * Executes a Java subprocess.
268      *
269      * @param vmArgs the VM arguments
270      * @param mainClassAndArgs the main class and its arguments
271      */
272     public static Subprocess java(List&lt;String&gt; vmArgs, List&lt;String&gt; mainClassAndArgs) throws IOException, InterruptedException {
273         return javaHelper(vmArgs, null, mainClassAndArgs);
274     }
275 
</pre>
<hr />
<pre>
286 
287     /**
288      * Executes a Java subprocess.
289      *
290      * @param vmArgs the VM arguments
291      * @param env the environment variables
292      * @param mainClassAndArgs the main class and its arguments
293      */
294     public static Subprocess java(List&lt;String&gt; vmArgs, Map&lt;String, String&gt; env, List&lt;String&gt; mainClassAndArgs) throws IOException, InterruptedException {
295         return javaHelper(vmArgs, env, mainClassAndArgs);
296     }
297 
298     /**
299      * Executes a Java subprocess.
300      *
301      * @param vmArgs the VM arguments
302      * @param env the environment variables
303      * @param mainClassAndArgs the main class and its arguments
304      */
305     private static Subprocess javaHelper(List&lt;String&gt; vmArgs, Map&lt;String, String&gt; env, List&lt;String&gt; mainClassAndArgs) throws IOException, InterruptedException {
<span class="line-modified">306         List&lt;String&gt; command = new ArrayList&lt;&gt;(vmArgs.size());</span>
<span class="line-added">307         Path packageOpeningOptionsArgumentsFile = null;</span>
<span class="line-added">308         for (String vmArg : vmArgs) {</span>
<span class="line-added">309             if (vmArg == PACKAGE_OPENING_OPTIONS) {</span>
<span class="line-added">310                 if (packageOpeningOptionsArgumentsFile == null) {</span>
<span class="line-added">311                     List&lt;String&gt; packageOpeningOptions = getPackageOpeningOptions();</span>
<span class="line-added">312                     if (!packageOpeningOptions.isEmpty()) {</span>
<span class="line-added">313                         packageOpeningOptionsArgumentsFile = Files.createTempFile(Paths.get(&quot;.&quot;), &quot;package-opening-options-arguments-file&quot;, &quot;.txt&quot;).toAbsolutePath();</span>
<span class="line-added">314                         Files.write(packageOpeningOptionsArgumentsFile, packageOpeningOptions);</span>
<span class="line-added">315                         command.add(&quot;@&quot; + packageOpeningOptionsArgumentsFile);</span>
<span class="line-added">316                     }</span>
<span class="line-added">317                 }</span>
<span class="line-added">318             } else {</span>
<span class="line-added">319                 command.add(vmArg);</span>
<span class="line-added">320             }</span>
<span class="line-added">321         }</span>
322         command.addAll(mainClassAndArgs);
323         ProcessBuilder processBuilder = new ProcessBuilder(command);
324         if (env != null) {
325             Map&lt;String, String&gt; processBuilderEnv = processBuilder.environment();
326             processBuilderEnv.putAll(env);
327         }
328         processBuilder.redirectErrorStream(true);
<span class="line-modified">329         try {</span>
<span class="line-modified">330             Process process = processBuilder.start();</span>
<span class="line-modified">331             BufferedReader stdout = new BufferedReader(new InputStreamReader(process.getInputStream()));</span>
<span class="line-modified">332             String line;</span>
<span class="line-modified">333             List&lt;String&gt; output = new ArrayList&lt;&gt;();</span>
<span class="line-modified">334             while ((line = stdout.readLine()) != null) {</span>
<span class="line-added">335                 output.add(line);</span>
<span class="line-added">336             }</span>
<span class="line-added">337             return new Subprocess(command, env, process.waitFor(), output);</span>
<span class="line-added">338         } finally {</span>
<span class="line-added">339             if (packageOpeningOptionsArgumentsFile != null) {</span>
<span class="line-added">340                 if (!Boolean.getBoolean(KEEP_TEMPORARY_ARGUMENT_FILES_PROPERTY_NAME)) {</span>
<span class="line-added">341                     Files.delete(packageOpeningOptionsArgumentsFile);</span>
<span class="line-added">342                 }</span>
<span class="line-added">343             }</span>
344         }

345     }
346 
<span class="line-modified">347     private static final boolean isJava8OrEarlier = JavaVersionUtil.JAVA_SPEC &lt;= 8;</span>
348 
349     private static boolean hasArg(String optionName) {
350         if (optionName.equals(&quot;-cp&quot;) || optionName.equals(&quot;-classpath&quot;)) {
351             return true;
352         }
353         if (!isJava8OrEarlier) {
354             if (optionName.equals(&quot;--version&quot;) ||
355                             optionName.equals(&quot;--show-version&quot;) ||
356                             optionName.equals(&quot;--dry-run&quot;) ||
357                             optionName.equals(&quot;--disable-@files&quot;) ||
358                             optionName.equals(&quot;--dry-run&quot;) ||
359                             optionName.equals(&quot;--help&quot;) ||
360                             optionName.equals(&quot;--help-extra&quot;)) {
361                 return false;
362             }
363             if (optionName.startsWith(&quot;--&quot;)) {
364                 return optionName.indexOf(&#39;=&#39;) == -1;
365             }
366         }
367         return false;
368     }
369 
370     private static int findMainClassIndex(List&lt;String&gt; commandLine) {
371         int i = 1; // Skip the java executable
372 
373         while (i &lt; commandLine.size()) {
374             String s = commandLine.get(i);
375             if (s.charAt(0) != &#39;-&#39;) {
<span class="line-modified">376                 // https://bugs.openjdk.java.net/browse/JDK-8027634</span>
<span class="line-added">377                 if (isJava8OrEarlier || s.charAt(0) != &#39;@&#39;) {</span>
<span class="line-added">378                     return i;</span>
<span class="line-added">379                 }</span>
<span class="line-added">380                 i++;</span>
381             } else if (hasArg(s)) {
382                 i += 2;
383             } else {
384                 i++;
385             }
386         }
387         throw new InternalError();
388     }
389 
390 }
</pre>
</td>
</tr>
</table>
<center><a href="GraalTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../org.graalvm.compiler.virtual/src/org/graalvm/compiler/virtual/phases/ea/EarlyReadEliminationPhase.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>