<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.lir/src/org/graalvm/compiler/lir/asm/CompilationResultBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../alloc/lsra/LinearScanWalker.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CompilationResultBuilderFactory.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.lir/src/org/graalvm/compiler/lir/asm/CompilationResultBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -39,10 +39,11 @@</span>
  import org.graalvm.compiler.asm.AbstractAddress;
  import org.graalvm.compiler.asm.Assembler;
  import org.graalvm.compiler.asm.Label;
  import org.graalvm.compiler.code.CompilationResult;
  import org.graalvm.compiler.code.CompilationResult.CodeAnnotation;
<span class="udiff-line-added">+ import org.graalvm.compiler.code.CompilationResult.JumpTable;</span>
  import org.graalvm.compiler.code.DataSection.Data;
  import org.graalvm.compiler.code.DataSection.RawData;
  import org.graalvm.compiler.core.common.NumUtil;
  import org.graalvm.compiler.core.common.cfg.AbstractBlockBase;
  import org.graalvm.compiler.core.common.spi.ForeignCallsProvider;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -51,26 +52,29 @@</span>
  import org.graalvm.compiler.debug.GraalError;
  import org.graalvm.compiler.graph.NodeSourcePosition;
  import org.graalvm.compiler.lir.LIR;
  import org.graalvm.compiler.lir.LIRFrameState;
  import org.graalvm.compiler.lir.LIRInstruction;
<span class="udiff-line-added">+ import org.graalvm.compiler.lir.LIRInstructionVerifier;</span>
  import org.graalvm.compiler.lir.LabelRef;
  import org.graalvm.compiler.lir.StandardOp.LabelHoldingOp;
  import org.graalvm.compiler.lir.framemap.FrameMap;
  import org.graalvm.compiler.options.Option;
  import org.graalvm.compiler.options.OptionKey;
  import org.graalvm.compiler.options.OptionType;
  import org.graalvm.compiler.options.OptionValues;
<span class="udiff-line-added">+ import org.graalvm.compiler.serviceprovider.GraalServices;</span>
  
  import jdk.vm.ci.code.BailoutException;
  import jdk.vm.ci.code.CodeCacheProvider;
  import jdk.vm.ci.code.DebugInfo;
  import jdk.vm.ci.code.Register;
  import jdk.vm.ci.code.StackSlot;
  import jdk.vm.ci.code.TargetDescription;
  import jdk.vm.ci.code.site.ConstantReference;
  import jdk.vm.ci.code.site.DataSectionReference;
<span class="udiff-line-added">+ import jdk.vm.ci.code.site.Infopoint;</span>
  import jdk.vm.ci.code.site.InfopointReason;
  import jdk.vm.ci.code.site.Mark;
  import jdk.vm.ci.meta.Constant;
  import jdk.vm.ci.meta.InvokeTarget;
  import jdk.vm.ci.meta.JavaConstant;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,10 +87,20 @@</span>
   *
   * @see CompilationResultBuilderFactory
   */
  public class CompilationResultBuilder {
  
<span class="udiff-line-added">+     private static final List&lt;LIRInstructionVerifier&gt; LIR_INSTRUCTION_VERIFIERS = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     static {</span>
<span class="udiff-line-added">+         for (LIRInstructionVerifier verifier : GraalServices.load(LIRInstructionVerifier.class)) {</span>
<span class="udiff-line-added">+             if (verifier.isEnabled()) {</span>
<span class="udiff-line-added">+                 LIR_INSTRUCTION_VERIFIERS.add(verifier);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public static class Options {
          @Option(help = &quot;Include the LIR as comments with the final assembly.&quot;, type = OptionType.Debug) //
          public static final OptionKey&lt;Boolean&gt; PrintLIRWithAssembly = new OptionKey&lt;&gt;(false);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -125,11 +139,11 @@</span>
      }
  
      public final Assembler asm;
      public final DataBuilder dataBuilder;
      public final CompilationResult compilationResult;
<span class="udiff-line-modified-removed">-     public final Register nullRegister;</span>
<span class="udiff-line-modified-added">+     public final Register uncompressedNullRegister;</span>
      public final TargetDescription target;
      public final CodeCacheProvider codeCache;
      public final ForeignCallsProvider foreignCalls;
      public final FrameMap frameMap;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -169,29 +183,56 @@</span>
       * {@link CompilationResultBuilder#labelWithinRange(LIRInstruction, Label, int)} into a
       * conservative mode and always answering false.
       */
      private boolean conservativeLabelOffsets = false;
  
<span class="udiff-line-modified-removed">-     public final boolean mustReplaceWithNullRegister(JavaConstant nullConstant) {</span>
<span class="udiff-line-modified-removed">-         return !nullRegister.equals(Register.None) &amp;&amp; JavaConstant.NULL_POINTER.equals(nullConstant);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     public CompilationResultBuilder(CodeCacheProvider codeCache, ForeignCallsProvider foreignCalls, FrameMap frameMap, Assembler asm, DataBuilder dataBuilder, FrameContext frameContext,</span>
<span class="udiff-line-modified-removed">-                     OptionValues options, DebugContext debug, CompilationResult compilationResult, Register nullRegister) {</span>
<span class="udiff-line-modified-removed">-         this(codeCache, foreignCalls, frameMap, asm, dataBuilder, frameContext, options, debug, compilationResult, nullRegister, EconomicMap.create(Equivalence.DEFAULT));</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     public CompilationResultBuilder(CodeCacheProvider codeCache, ForeignCallsProvider foreignCalls, FrameMap frameMap, Assembler asm, DataBuilder dataBuilder, FrameContext frameContext,</span>
<span class="udiff-line-modified-removed">-                     OptionValues options, DebugContext debug, CompilationResult compilationResult, Register nullRegister, EconomicMap&lt;Constant, Data&gt; dataCache) {</span>
<span class="udiff-line-modified-added">+     public final boolean mustReplaceWithUncompressedNullRegister(JavaConstant nullConstant) {</span>
<span class="udiff-line-modified-added">+         return !uncompressedNullRegister.equals(Register.None) &amp;&amp; JavaConstant.NULL_POINTER.equals(nullConstant);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     public CompilationResultBuilder(CodeCacheProvider codeCache,</span>
<span class="udiff-line-modified-added">+                     ForeignCallsProvider foreignCalls,</span>
<span class="udiff-line-modified-added">+                     FrameMap frameMap,</span>
<span class="udiff-line-modified-added">+                     Assembler asm,</span>
<span class="udiff-line-modified-added">+                     DataBuilder dataBuilder,</span>
<span class="udiff-line-modified-added">+                     FrameContext frameContext,</span>
<span class="udiff-line-modified-added">+                     OptionValues options,</span>
<span class="udiff-line-added">+                     DebugContext debug,</span>
<span class="udiff-line-added">+                     CompilationResult compilationResult,</span>
<span class="udiff-line-added">+                     Register uncompressedNullRegister) {</span>
<span class="udiff-line-added">+         this(codeCache,</span>
<span class="udiff-line-added">+                         foreignCalls,</span>
<span class="udiff-line-added">+                         frameMap,</span>
<span class="udiff-line-added">+                         asm,</span>
<span class="udiff-line-added">+                         dataBuilder,</span>
<span class="udiff-line-added">+                         frameContext,</span>
<span class="udiff-line-added">+                         options,</span>
<span class="udiff-line-added">+                         debug,</span>
<span class="udiff-line-added">+                         compilationResult,</span>
<span class="udiff-line-added">+                         uncompressedNullRegister,</span>
<span class="udiff-line-added">+                         EconomicMap.create(Equivalence.DEFAULT));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public CompilationResultBuilder(CodeCacheProvider codeCache,</span>
<span class="udiff-line-added">+                     ForeignCallsProvider foreignCalls,</span>
<span class="udiff-line-added">+                     FrameMap frameMap,</span>
<span class="udiff-line-added">+                     Assembler asm,</span>
<span class="udiff-line-added">+                     DataBuilder dataBuilder,</span>
<span class="udiff-line-added">+                     FrameContext frameContext,</span>
<span class="udiff-line-added">+                     OptionValues options,</span>
<span class="udiff-line-added">+                     DebugContext debug,</span>
<span class="udiff-line-added">+                     CompilationResult compilationResult,</span>
<span class="udiff-line-added">+                     Register uncompressedNullRegister,</span>
<span class="udiff-line-added">+                     EconomicMap&lt;Constant, Data&gt; dataCache) {</span>
          this.target = codeCache.getTarget();
          this.codeCache = codeCache;
          this.foreignCalls = foreignCalls;
          this.frameMap = frameMap;
          this.asm = asm;
          this.dataBuilder = dataBuilder;
          this.compilationResult = compilationResult;
<span class="udiff-line-modified-removed">-         this.nullRegister = nullRegister;</span>
<span class="udiff-line-modified-added">+         this.uncompressedNullRegister = uncompressedNullRegister;</span>
          this.frameContext = frameContext;
          this.options = options;
          this.debug = debug;
          assert frameContext != null;
          this.dataCache = dataCache;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -253,10 +294,20 @@</span>
      public void recordImplicitException(int pcOffset, LIRFrameState info) {
          compilationResult.recordInfopoint(pcOffset, info.debugInfo(), InfopointReason.IMPLICIT_EXCEPTION);
          assert info.exceptionEdge == null;
      }
  
<span class="udiff-line-added">+     public boolean isImplicitExceptionExist(int pcOffset) {</span>
<span class="udiff-line-added">+         List&lt;Infopoint&gt; infopoints = compilationResult.getInfopoints();</span>
<span class="udiff-line-added">+         for (Infopoint infopoint : infopoints) {</span>
<span class="udiff-line-added">+             if (infopoint.pcOffset == pcOffset &amp;&amp; infopoint.reason == InfopointReason.IMPLICIT_EXCEPTION) {</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      public void recordDirectCall(int posBefore, int posAfter, InvokeTarget callTarget, LIRFrameState info) {
          DebugInfo debugInfo = info != null ? info.debugInfo() : null;
          compilationResult.recordCall(posBefore, posAfter - posBefore, callTarget, debugInfo, true);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -532,26 +583,43 @@</span>
  
              try {
                  if (beforeOp != null) {
                      beforeOp.accept(op);
                  }
<span class="udiff-line-modified-removed">-                 emitOp(this, op);</span>
<span class="udiff-line-modified-added">+                 emitOp(op);</span>
                  if (afterOp != null) {
                      afterOp.accept(op);
                  }
              } catch (GraalError e) {
                  throw e.addContext(&quot;lir instruction&quot;, block + &quot;@&quot; + op.id() + &quot; &quot; + op.getClass().getName() + &quot; &quot; + op + &quot;\n&quot; + Arrays.toString(lir.codeEmittingOrder()));
              }
          }
      }
  
<span class="udiff-line-modified-removed">-     private static void emitOp(CompilationResultBuilder crb, LIRInstruction op) {</span>
<span class="udiff-line-modified-added">+     private void emitOp(LIRInstruction op) {</span>
          try {
<span class="udiff-line-modified-removed">-             int start = crb.asm.position();</span>
<span class="udiff-line-modified-removed">-             op.emitCode(crb);</span>
<span class="udiff-line-modified-added">+             int start = asm.position();</span>
<span class="udiff-line-modified-added">+             op.emitCode(this);</span>
              if (op.getPosition() != null) {
<span class="udiff-line-modified-removed">-                 crb.recordSourceMapping(start, crb.asm.position(), op.getPosition());</span>
<span class="udiff-line-modified-added">+                 recordSourceMapping(start, asm.position(), op.getPosition());</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (LIR_INSTRUCTION_VERIFIERS.size() &gt; 0 &amp;&amp; start &lt; asm.position()) {</span>
<span class="udiff-line-added">+                 int end = asm.position();</span>
<span class="udiff-line-added">+                 for (CodeAnnotation codeAnnotation : compilationResult.getCodeAnnotations()) {</span>
<span class="udiff-line-added">+                     if (codeAnnotation instanceof JumpTable) {</span>
<span class="udiff-line-added">+                         // Skip jump table. Here we assume the jump table is at the tail of the</span>
<span class="udiff-line-added">+                         // emitted code.</span>
<span class="udiff-line-added">+                         int jumpTableStart = codeAnnotation.position;</span>
<span class="udiff-line-added">+                         if (jumpTableStart &gt;= start &amp;&amp; jumpTableStart &lt; end) {</span>
<span class="udiff-line-added">+                             end = jumpTableStart;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 byte[] emittedCode = asm.copy(start, end);</span>
<span class="udiff-line-added">+                 for (LIRInstructionVerifier verifier : LIR_INSTRUCTION_VERIFIERS) {</span>
<span class="udiff-line-added">+                     verifier.verify(op, emittedCode);</span>
<span class="udiff-line-added">+                 }</span>
              }
          } catch (BailoutException e) {
              throw e;
          } catch (AssertionError t) {
              throw new GraalError(t);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -596,12 +664,12 @@</span>
                      if (op instanceof LabelHoldingOp) {
                          Label label = ((LabelHoldingOp) op).getLabel();
                          if (label != null) {
                              labelBindLirPositions.put(label, instructionPosition);
                          }
<span class="udiff-line-removed">-                         lirPositions.put(op, instructionPosition);</span>
                      }
<span class="udiff-line-added">+                     lirPositions.put(op, instructionPosition);</span>
                      instructionPosition++;
                  }
              }
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -633,6 +701,20 @@</span>
       * false.
       */
      public void setConservativeLabelRanges() {
          this.conservativeLabelOffsets = true;
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public final boolean needsClearUpperVectorRegisters() {</span>
<span class="udiff-line-added">+         for (AbstractBlockBase&lt;?&gt; block : lir.codeEmittingOrder()) {</span>
<span class="udiff-line-added">+             if (block == null) {</span>
<span class="udiff-line-added">+                 continue;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             for (LIRInstruction op : lir.getLIRforBlock(block)) {</span>
<span class="udiff-line-added">+                 if (op.needsClearUpperVectorRegisters()) {</span>
<span class="udiff-line-added">+                     return true;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return false;</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../alloc/lsra/LinearScanWalker.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CompilationResultBuilderFactory.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>