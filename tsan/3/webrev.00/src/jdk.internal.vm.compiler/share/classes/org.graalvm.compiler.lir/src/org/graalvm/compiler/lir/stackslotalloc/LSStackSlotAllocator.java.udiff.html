<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.lir/src/org/graalvm/compiler/lir/stackslotalloc/LSStackSlotAllocator.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../ssa/SSAVerifier.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="SimpleStackSlotAllocator.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.lir/src/org/graalvm/compiler/lir/stackslotalloc/LSStackSlotAllocator.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2014, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2014, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -31,15 +31,16 @@</span>
  
  import java.util.ArrayDeque;
  import java.util.ArrayList;
  import java.util.Arrays;
  import java.util.Deque;
<span class="udiff-line-removed">- import java.util.EnumMap;</span>
  import java.util.EnumSet;
  import java.util.PriorityQueue;
<span class="udiff-line-added">+ import java.util.function.Predicate;</span>
  
  import jdk.internal.vm.compiler.collections.EconomicSet;
<span class="udiff-line-added">+ import org.graalvm.compiler.core.common.LIRKind;</span>
  import org.graalvm.compiler.core.common.cfg.AbstractBlockBase;
  import org.graalvm.compiler.debug.DebugCloseable;
  import org.graalvm.compiler.debug.DebugContext;
  import org.graalvm.compiler.debug.Indent;
  import org.graalvm.compiler.debug.TimerKey;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -47,19 +48,21 @@</span>
  import org.graalvm.compiler.lir.LIRInstruction;
  import org.graalvm.compiler.lir.LIRInstruction.OperandFlag;
  import org.graalvm.compiler.lir.LIRInstruction.OperandMode;
  import org.graalvm.compiler.lir.ValueProcedure;
  import org.graalvm.compiler.lir.VirtualStackSlot;
<span class="udiff-line-added">+ import org.graalvm.compiler.lir.framemap.FrameMap;</span>
  import org.graalvm.compiler.lir.framemap.FrameMapBuilderTool;
  import org.graalvm.compiler.lir.framemap.SimpleVirtualStackSlot;
  import org.graalvm.compiler.lir.framemap.VirtualStackSlotRange;
  import org.graalvm.compiler.lir.gen.LIRGenerationResult;
  import org.graalvm.compiler.lir.phases.AllocationPhase;
  import org.graalvm.compiler.options.NestedBooleanOptionKey;
  import org.graalvm.compiler.options.Option;
  import org.graalvm.compiler.options.OptionType;
  
<span class="udiff-line-added">+ import jdk.vm.ci.code.CodeUtil;</span>
  import jdk.vm.ci.code.StackSlot;
  import jdk.vm.ci.code.TargetDescription;
  import jdk.vm.ci.meta.Value;
  import jdk.vm.ci.meta.ValueKind;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -154,11 +157,19 @@</span>
              if (debug.isDumpEnabled(DebugContext.VERBOSE_LEVEL)) {
                  dumpIntervals(&quot;Before stack slot allocation&quot;);
              }
              // step 4: allocate stack slots
              try (DebugCloseable t = AllocateSlotsTimer.start(debug)) {
<span class="udiff-line-modified-removed">-                 allocateStackSlots();</span>
<span class="udiff-line-modified-added">+                 /*</span>
<span class="udiff-line-added">+                  * Allocate primitive spill slots before reference spill slots. This ensures a</span>
<span class="udiff-line-added">+                  * ReferenceMap will be as compact as possible and only exceed the encoding limit of</span>
<span class="udiff-line-added">+                  * a stack offset if there are really too many objects live on the stack at an</span>
<span class="udiff-line-added">+                  * instruction with a ReferenceMap (as opposed to the method simply having a very</span>
<span class="udiff-line-added">+                  * large frame).</span>
<span class="udiff-line-added">+                  */</span>
<span class="udiff-line-added">+                 allocateStackSlots(IS_PRIMITIVE_INTERVAL);</span>
<span class="udiff-line-added">+                 allocateStackSlots(IS_REFERENCE_INTERVAL);</span>
              }
              if (debug.isDumpEnabled(DebugContext.VERBOSE_LEVEL)) {
                  dumpIntervals(&quot;After stack slot allocation&quot;);
              }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -224,33 +235,48 @@</span>
          // ====================
          // step 4: allocate stack slots
          // ====================
  
          @SuppressWarnings(&quot;try&quot;)
<span class="udiff-line-modified-removed">-         private void allocateStackSlots() {</span>
<span class="udiff-line-removed">-             // create unhandled lists</span>
<span class="udiff-line-modified-added">+         private void allocateStackSlots(Predicate&lt;StackInterval&gt; predicate) {</span>
              for (StackInterval interval : stackSlotMap) {
<span class="udiff-line-modified-removed">-                 if (interval != null) {</span>
<span class="udiff-line-modified-added">+                 if (interval != null &amp;&amp; (predicate == null || predicate.test(interval))) {</span>
                      unhandled.add(interval);
                  }
              }
<span class="udiff-line-removed">- </span>
              for (StackInterval current = activateNext(); current != null; current = activateNext()) {
                  try (Indent indent = debug.logAndIndent(&quot;allocate %s&quot;, current)) {
                      allocateSlot(current);
                  }
              }
  
<span class="udiff-line-added">+             // Cannot re-use free slots between rounds of slot allocation</span>
<span class="udiff-line-added">+             freeSlots = null;</span>
<span class="udiff-line-added">+             active.clear();</span>
          }
  
<span class="udiff-line-added">+         private static final Predicate&lt;StackInterval&gt; IS_REFERENCE_INTERVAL = new Predicate&lt;StackInterval&gt;() {</span>
<span class="udiff-line-added">+             @Override</span>
<span class="udiff-line-added">+             public boolean test(StackInterval interval) {</span>
<span class="udiff-line-added">+                 return !((LIRKind) interval.kind()).isValue();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         private static final Predicate&lt;StackInterval&gt; IS_PRIMITIVE_INTERVAL = new Predicate&lt;StackInterval&gt;() {</span>
<span class="udiff-line-added">+             @Override</span>
<span class="udiff-line-added">+             public boolean test(StackInterval interval) {</span>
<span class="udiff-line-added">+                 return ((LIRKind) interval.kind()).isValue();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         };</span>
<span class="udiff-line-added">+ </span>
          private void allocateSlot(StackInterval current) {
              VirtualStackSlot virtualSlot = current.getOperand();
              final StackSlot location;
              if (virtualSlot instanceof VirtualStackSlotRange) {
                  // No reuse of ranges (yet).
                  VirtualStackSlotRange slotRange = (VirtualStackSlotRange) virtualSlot;
<span class="udiff-line-modified-removed">-                 location = frameMapBuilder.getFrameMap().allocateStackSlots(slotRange.getSlots(), slotRange.getObjects());</span>
<span class="udiff-line-modified-added">+                 location = frameMapBuilder.getFrameMap().allocateStackSlots(slotRange.getSlots());</span>
                  StackSlotAllocatorUtil.virtualFramesize.add(debug, frameMapBuilder.getFrameMap().spillSlotRangeSize(slotRange.getSlots()));
                  StackSlotAllocatorUtil.allocatedSlots.increment(debug);
              } else {
                  assert virtualSlot instanceof SimpleVirtualStackSlot : &quot;Unexpected VirtualStackSlot type: &quot; + virtualSlot;
                  StackSlot slot = findFreeSlot((SimpleVirtualStackSlot) virtualSlot);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -272,93 +298,78 @@</span>
              }
              debug.log(&quot;Allocate location %s for interval %s&quot;, location, current);
              current.setLocation(location);
          }
  
<span class="udiff-line-modified-removed">-         private enum SlotSize {</span>
<span class="udiff-line-modified-removed">-             Size1,</span>
<span class="udiff-line-modified-removed">-             Size2,</span>
<span class="udiff-line-modified-removed">-             Size4,</span>
<span class="udiff-line-modified-removed">-             Size8,</span>
<span class="udiff-line-removed">-             Illegal;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         private SlotSize forKind(ValueKind&lt;?&gt; kind) {</span>
<span class="udiff-line-removed">-             switch (frameMapBuilder.getFrameMap().spillSlotSize(kind)) {</span>
<span class="udiff-line-removed">-                 case 1:</span>
<span class="udiff-line-removed">-                     return SlotSize.Size1;</span>
<span class="udiff-line-removed">-                 case 2:</span>
<span class="udiff-line-removed">-                     return SlotSize.Size2;</span>
<span class="udiff-line-removed">-                 case 4:</span>
<span class="udiff-line-removed">-                     return SlotSize.Size4;</span>
<span class="udiff-line-removed">-                 case 8:</span>
<span class="udiff-line-removed">-                     return SlotSize.Size8;</span>
<span class="udiff-line-removed">-                 default:</span>
<span class="udiff-line-removed">-                     return SlotSize.Illegal;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         private EnumMap&lt;SlotSize, Deque&lt;StackSlot&gt;&gt; freeSlots;</span>
<span class="udiff-line-modified-added">+         /**</span>
<span class="udiff-line-modified-added">+          * Map from log2 of {@link FrameMap#spillSlotSize(ValueKind) a spill slot size} to a list of</span>
<span class="udiff-line-modified-added">+          * free stack slots.</span>
<span class="udiff-line-modified-added">+          */</span>
<span class="udiff-line-modified-added">+         private ArrayList&lt;Deque&lt;StackSlot&gt;&gt; freeSlots;</span>
  
          /**
<span class="udiff-line-modified-removed">-          * @return The list of free stack slots for {@code size} or {@code null} if there is none.</span>
<span class="udiff-line-modified-added">+          * @return The list of free stack slots for {@code index} or {@code null} if there is none.</span>
           */
<span class="udiff-line-modified-removed">-         private Deque&lt;StackSlot&gt; getOrNullFreeSlots(SlotSize size) {</span>
<span class="udiff-line-modified-added">+         private Deque&lt;StackSlot&gt; getNullOrFreeSlots(int index) {</span>
              if (freeSlots == null) {
                  return null;
              }
<span class="udiff-line-modified-removed">-             return freeSlots.get(size);</span>
<span class="udiff-line-modified-added">+             if (index &lt; freeSlots.size()) {</span>
<span class="udiff-line-added">+                 return freeSlots.get(index);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return null;</span>
          }
  
          /**
<span class="udiff-line-modified-removed">-          * @return the list of free stack slots for {@code size}. If there is none a list is</span>
<span class="udiff-line-modified-added">+          * @return the list of free stack slots for {@code index}. If there is none a list is</span>
           *         created.
           */
<span class="udiff-line-modified-removed">-         private Deque&lt;StackSlot&gt; getOrInitFreeSlots(SlotSize size) {</span>
<span class="udiff-line-modified-removed">-             assert size != SlotSize.Illegal;</span>
<span class="udiff-line-modified-removed">-             Deque&lt;StackSlot&gt; freeList;</span>
<span class="udiff-line-modified-removed">-             if (freeSlots != null) {</span>
<span class="udiff-line-modified-removed">-                 freeList = freeSlots.get(size);</span>
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-removed">-                 freeSlots = new EnumMap&lt;&gt;(SlotSize.class);</span>
<span class="udiff-line-removed">-                 freeList = null;</span>
<span class="udiff-line-modified-added">+         private Deque&lt;StackSlot&gt; getOrInitFreeSlots(int index) {</span>
<span class="udiff-line-modified-added">+             Deque&lt;StackSlot&gt; freeList = null;</span>
<span class="udiff-line-modified-added">+             if (freeSlots == null) {</span>
<span class="udiff-line-modified-added">+                 freeSlots = new ArrayList&lt;&gt;(6);</span>
<span class="udiff-line-modified-added">+             } else if (index &lt; freeSlots.size()) {</span>
<span class="udiff-line-modified-added">+                 freeList = freeSlots.get(index);</span>
              }
              if (freeList == null) {
<span class="udiff-line-added">+                 int requiredSize = index + 1;</span>
<span class="udiff-line-added">+                 for (int i = freeSlots.size(); i &lt; requiredSize; i++) {</span>
<span class="udiff-line-added">+                     freeSlots.add(null);</span>
<span class="udiff-line-added">+                 }</span>
                  freeList = new ArrayDeque&lt;&gt;();
<span class="udiff-line-modified-removed">-                 freeSlots.put(size, freeList);</span>
<span class="udiff-line-modified-added">+                 freeSlots.set(index, freeList);</span>
              }
<span class="udiff-line-removed">-             assert freeList != null;</span>
              return freeList;
          }
  
          /**
           * Gets a free stack slot for {@code slot} or {@code null} if there is none.
           */
          private StackSlot findFreeSlot(SimpleVirtualStackSlot slot) {
              assert slot != null;
<span class="udiff-line-modified-removed">-             SlotSize size = forKind(slot.getValueKind());</span>
<span class="udiff-line-modified-removed">-             if (size == SlotSize.Illegal) {</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             Deque&lt;StackSlot&gt; freeList = getOrNullFreeSlots(size);</span>
<span class="udiff-line-modified-added">+             int size = log2SpillSlotSize(slot.getValueKind());</span>
<span class="udiff-line-modified-added">+             Deque&lt;StackSlot&gt; freeList = getNullOrFreeSlots(size);</span>
              if (freeList == null) {
                  return null;
              }
              return freeList.pollLast();
          }
  
          /**
           * Adds a stack slot to the list of free slots.
           */
          private void freeSlot(StackSlot slot) {
<span class="udiff-line-modified-removed">-             SlotSize size = forKind(slot.getValueKind());</span>
<span class="udiff-line-removed">-             if (size == SlotSize.Illegal) {</span>
<span class="udiff-line-removed">-                 return;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+             int size = log2SpillSlotSize(slot.getValueKind());</span>
              getOrInitFreeSlots(size).addLast(slot);
          }
  
<span class="udiff-line-added">+         private int log2SpillSlotSize(ValueKind&lt;?&gt; kind) {</span>
<span class="udiff-line-added">+             int size = frameMapBuilder.getFrameMap().spillSlotSize(kind);</span>
<span class="udiff-line-added">+             assert CodeUtil.isPowerOf2(size);</span>
<span class="udiff-line-added">+             return CodeUtil.log2(size);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          /**
           * Gets the next unhandled interval and finishes handled intervals.
           */
          private StackInterval activateNext() {
              if (unhandled.isEmpty()) {
</pre>
<center><a href="../ssa/SSAVerifier.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="SimpleStackSlotAllocator.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>