<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.lir/src/org/graalvm/compiler/lir/framemap/FrameMap.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../dfa/LocationMarkerPhase.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="FrameMapBuilder.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.lir/src/org/graalvm/compiler/lir/framemap/FrameMap.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2009, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2009, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,32 +22,27 @@</span>
   */
  
  
  package org.graalvm.compiler.lir.framemap;
  
<span class="udiff-line-modified-removed">- import java.util.ArrayList;</span>
<span class="udiff-line-removed">- import java.util.BitSet;</span>
<span class="udiff-line-removed">- import java.util.List;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+ import org.graalvm.compiler.core.common.LIRKind;</span>
  import org.graalvm.compiler.core.common.NumUtil;
  import org.graalvm.compiler.core.common.PermanentBailoutException;
<span class="udiff-line-removed">- import org.graalvm.compiler.core.common.LIRKind;</span>
  
  import jdk.vm.ci.code.Architecture;
  import jdk.vm.ci.code.CallingConvention;
  import jdk.vm.ci.code.CodeCacheProvider;
  import jdk.vm.ci.code.RegisterConfig;
  import jdk.vm.ci.code.StackSlot;
  import jdk.vm.ci.code.TargetDescription;
<span class="udiff-line-removed">- import jdk.vm.ci.meta.Value;</span>
  import jdk.vm.ci.meta.ValueKind;
  
  /**
   * This class is used to build the stack frame layout for a compiled method. A {@link StackSlot} is
   * used to index slots of the frame relative to the stack pointer. The frame size is only fixed
   * after register allocation when all spill slots have been allocated. Both the outgoing argument
<span class="udiff-line-modified-removed">-  * area and the spill are can grow until then. Therefore, outgoing arguments are indexed from the</span>
<span class="udiff-line-modified-added">+  * area and the spill area can grow until then. Therefore, outgoing arguments are indexed from the</span>
   * stack pointer, while spill slots are indexed from the beginning of the frame (and the total frame
   * size has to be added to get the actual offset from the stack pointer).
   */
  public abstract class FrameMap {
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -88,15 +83,10 @@</span>
      /**
       * Determines if this frame has values on the stack for outgoing calls.
       */
      protected boolean hasOutgoingStackArguments;
  
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * The list of stack slots allocated in this frame that are present in every reference map.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     private final List&lt;StackSlot&gt; objectStackSlots;</span>
<span class="udiff-line-removed">- </span>
      /**
       * Records whether an offset to an incoming stack argument was ever returned by
       * {@link #offsetForStackSlot(StackSlot)}.
       */
      private boolean accessesCallerFrame;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -108,11 +98,10 @@</span>
      public FrameMap(CodeCacheProvider codeCache, RegisterConfig registerConfig, ReferenceMapBuilderFactory referenceMapFactory) {
          this.target = codeCache.getTarget();
          this.registerConfig = registerConfig == null ? codeCache.getRegisterConfig() : registerConfig;
          this.frameSize = -1;
          this.outgoingSize = codeCache.getMinimumOutgoingSize();
<span class="udiff-line-removed">-         this.objectStackSlots = new ArrayList&lt;&gt;();</span>
          this.referenceMapFactory = referenceMapFactory;
      }
  
      public RegisterConfig getRegisterConfig() {
          return registerConfig;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -120,16 +109,10 @@</span>
  
      public TargetDescription getTarget() {
          return target;
      }
  
<span class="udiff-line-removed">-     public void addLiveValues(ReferenceMapBuilder refMap) {</span>
<span class="udiff-line-removed">-         for (Value value : objectStackSlots) {</span>
<span class="udiff-line-removed">-             refMap.addLiveValue(value);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      protected int returnAddressSize() {
          return getTarget().arch.getReturnAddressSize();
      }
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -232,23 +215,10 @@</span>
          assert frameSize == -1 : &quot;frame size must not yet be fixed&quot;;
          outgoingSize = Math.max(outgoingSize, argsSize);
          hasOutgoingStackArguments = hasOutgoingStackArguments || argsSize &gt; 0;
      }
  
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Reserves a new spill slot in the frame of the method being compiled. The returned slot is</span>
<span class="udiff-line-removed">-      * aligned on its natural alignment, i.e., an 8-byte spill slot is aligned at an 8-byte</span>
<span class="udiff-line-removed">-      * boundary.</span>
<span class="udiff-line-removed">-      *</span>
<span class="udiff-line-removed">-      * @param kind The kind of the spill slot to be reserved.</span>
<span class="udiff-line-removed">-      * @param additionalOffset</span>
<span class="udiff-line-removed">-      * @return A spill slot denoting the reserved memory area.</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     protected StackSlot allocateNewSpillSlot(ValueKind&lt;?&gt; kind, int additionalOffset) {</span>
<span class="udiff-line-removed">-         return StackSlot.get(kind, -spillSize + additionalOffset, true);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      /**
       * Returns the spill slot size for the given {@link ValueKind}. The default value is the size in
       * bytes for the target architecture.
       *
       * @param kind the {@link ValueKind} to be stored in the spill slot.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -268,11 +238,15 @@</span>
       */
      public StackSlot allocateSpillSlot(ValueKind&lt;?&gt; kind) {
          assert frameSize == -1 : &quot;frame size must not yet be fixed&quot;;
          int size = spillSlotSize(kind);
          spillSize = NumUtil.roundUp(spillSize + size, size);
<span class="udiff-line-modified-removed">-         return allocateNewSpillSlot(kind, 0);</span>
<span class="udiff-line-modified-added">+         return newStackSlot(kind);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private StackSlot newStackSlot(ValueKind&lt;?&gt; kind) {</span>
<span class="udiff-line-added">+         return StackSlot.get(kind, -spillSize, true);</span>
      }
  
      /**
       * Returns the size of the stack slot range for {@code slots} objects.
       *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -286,50 +260,19 @@</span>
      /**
       * Reserves a number of contiguous slots in the frame of the method being compiled. If the
       * requested number of slots is 0, this method returns {@code null}.
       *
       * @param slots the number of slots to reserve
<span class="udiff-line-removed">-      * @param objects specifies the indexes of the object pointer slots. The caller is responsible</span>
<span class="udiff-line-removed">-      *            for guaranteeing that each such object pointer slot is initialized before any</span>
<span class="udiff-line-removed">-      *            instruction that uses a reference map. Without this guarantee, the garbage</span>
<span class="udiff-line-removed">-      *            collector could see garbage object values.</span>
       * @return the first reserved stack slot (i.e., at the lowest address)
       */
<span class="udiff-line-modified-removed">-     public StackSlot allocateStackSlots(int slots, BitSet objects) {</span>
<span class="udiff-line-modified-added">+     public StackSlot allocateStackSlots(int slots) {</span>
          assert frameSize == -1 : &quot;frame size must not yet be fixed&quot;;
          if (slots == 0) {
              return null;
          }
<span class="udiff-line-modified-removed">-         spillSize += spillSlotRangeSize(slots);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-removed">-         if (!objects.isEmpty()) {</span>
<span class="udiff-line-removed">-             assert objects.length() &lt;= slots;</span>
<span class="udiff-line-removed">-             StackSlot result = null;</span>
<span class="udiff-line-removed">-             for (int slotIndex = 0; slotIndex &lt; slots; slotIndex++) {</span>
<span class="udiff-line-removed">-                 StackSlot objectSlot = null;</span>
<span class="udiff-line-removed">-                 if (objects.get(slotIndex)) {</span>
<span class="udiff-line-removed">-                     objectSlot = allocateNewSpillSlot(LIRKind.reference(getTarget().arch.getWordKind()), slotIndex * getTarget().wordSize);</span>
<span class="udiff-line-removed">-                     addObjectStackSlot(objectSlot);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 if (slotIndex == 0) {</span>
<span class="udiff-line-removed">-                     if (objectSlot != null) {</span>
<span class="udiff-line-removed">-                         result = objectSlot;</span>
<span class="udiff-line-removed">-                     } else {</span>
<span class="udiff-line-removed">-                         result = allocateNewSpillSlot(LIRKind.value(getTarget().arch.getWordKind()), 0);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             assert result != null;</span>
<span class="udiff-line-removed">-             return result;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             return allocateNewSpillSlot(LIRKind.value(getTarget().arch.getWordKind()), 0);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     protected void addObjectStackSlot(StackSlot objectSlot) {</span>
<span class="udiff-line-removed">-         objectStackSlots.add(objectSlot);</span>
<span class="udiff-line-modified-added">+         spillSize = NumUtil.roundUp(spillSize + spillSlotRangeSize(slots), getTarget().wordSize);</span>
<span class="udiff-line-modified-added">+         return newStackSlot(LIRKind.value(getTarget().arch.getWordKind()));</span>
      }
  
      public ReferenceMapBuilder newReferenceMapBuilder() {
          return referenceMapFactory.newReferenceMapBuilder(totalFrameSize());
      }
</pre>
<center><a href="../dfa/LocationMarkerPhase.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="FrameMapBuilder.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>