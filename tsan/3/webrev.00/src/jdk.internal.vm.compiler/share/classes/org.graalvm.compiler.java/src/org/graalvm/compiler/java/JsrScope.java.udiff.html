<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.java/src/org/graalvm/compiler/java/JsrScope.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GraphBuilderPhase.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../org.graalvm.compiler.jtt/src/org/graalvm/compiler/jtt/backend/LargeConstantSectionTest.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.java/src/org/graalvm/compiler/java/JsrScope.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -22,68 +22,164 @@</span>
   */
  
  
  package org.graalvm.compiler.java;
  
<span class="udiff-line-modified-removed">- public class JsrScope {</span>
<span class="udiff-line-modified-added">+ import org.graalvm.compiler.bytecode.Bytecodes;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.java.BciBlockMapping.BciBlock;</span>
  
<span class="udiff-line-added">+ /**</span>
<span class="udiff-line-added">+  * Represents a subroutine entered via {@link Bytecodes#JSR} and exited via {@link Bytecodes#RET}.</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ public final class JsrScope {</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * The scope outside of any JSR/RET subroutine.</span>
<span class="udiff-line-added">+      */</span>
      public static final JsrScope EMPTY_SCOPE = new JsrScope();
  
<span class="udiff-line-modified-removed">-     private final long scope;</span>
<span class="udiff-line-modified-added">+     private final char returnAddress;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private final JsrScope parent;</span>
  
<span class="udiff-line-modified-removed">-     private JsrScope(long scope) {</span>
<span class="udiff-line-modified-removed">-         this.scope = scope;</span>
<span class="udiff-line-modified-added">+     private final BciBlock jsrEntryBlock;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     private JsrScope(int returnBci, BciBlock jsrEntryBlock, JsrScope parent) {</span>
<span class="udiff-line-added">+         this.returnAddress = (char) returnBci;</span>
<span class="udiff-line-added">+         this.parent = parent;</span>
<span class="udiff-line-added">+         this.jsrEntryBlock = jsrEntryBlock;</span>
      }
  
<span class="udiff-line-modified-removed">-     public JsrScope() {</span>
<span class="udiff-line-modified-removed">-         this.scope = 0;</span>
<span class="udiff-line-modified-added">+     private JsrScope() {</span>
<span class="udiff-line-modified-added">+         this.returnAddress = 0;</span>
<span class="udiff-line-added">+         this.parent = null;</span>
<span class="udiff-line-added">+         this.jsrEntryBlock = null;</span>
      }
  
      public int nextReturnAddress() {
<span class="udiff-line-modified-removed">-         return (int) (scope &amp; 0xffff);</span>
<span class="udiff-line-modified-added">+         return returnAddress;</span>
      }
  
<span class="udiff-line-modified-removed">-     public JsrScope push(int jsrReturnBci) {</span>
<span class="udiff-line-modified-removed">-         if ((scope &amp; 0xffff000000000000L) != 0) {</span>
<span class="udiff-line-modified-removed">-             throw new JsrNotSupportedBailout(&quot;only four jsr nesting levels are supported&quot;);</span>
<span class="udiff-line-modified-added">+     public BciBlock getJsrEntryBlock() {</span>
<span class="udiff-line-modified-added">+         return jsrEntryBlock;</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Enters a new subroutine from the current scope represented by this object.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @param returnBci the bytecode address returned to when leaving the new scope</span>
<span class="udiff-line-added">+      * @return an object representing the newly entered scope</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public JsrScope push(int returnBci, BciBlock newJsrEntryBlock) {</span>
<span class="udiff-line-added">+         if (returnBci == 0) {</span>
<span class="udiff-line-added">+             throw new IllegalArgumentException(&quot;A bytecode subroutine cannot have a return address of 0&quot;);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (returnBci &lt; 1 || returnBci &gt; 0xFFFF) {</span>
<span class="udiff-line-added">+             throw new IllegalArgumentException(&quot;Bytecode subroutine return address cannot be encoded as a char: &quot; + returnBci);</span>
          }
<span class="udiff-line-modified-removed">-         return new JsrScope((scope &lt;&lt; 16) | jsrReturnBci);</span>
<span class="udiff-line-modified-added">+         return new JsrScope(returnBci, newJsrEntryBlock, this);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     public JsrScope push(int returnBci) {</span>
<span class="udiff-line-added">+         return push(returnBci, null);</span>
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Determines if this is the scope outside of any JSR/RET subroutine.</span>
<span class="udiff-line-added">+      */</span>
      public boolean isEmpty() {
<span class="udiff-line-modified-removed">-         return scope == 0;</span>
<span class="udiff-line-modified-added">+         return returnAddress == 0;</span>
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Gets the ancestry of this scope starting with the {@link #returnAddress} of this scope&#39;s most</span>
<span class="udiff-line-added">+      * distant ancestor and ending with the {@link #returnAddress} of this object.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @return a String where each character is a 16-bit BCI. This value can be converted to an</span>
<span class="udiff-line-added">+      *         {@code int[]} with {@code value.chars().toArray()}.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     public String getAncestry() {</span>
<span class="udiff-line-added">+         String result = &quot;&quot;;</span>
<span class="udiff-line-added">+         for (JsrScope s = this; s != null; s = s.parent) {</span>
<span class="udiff-line-added">+             if (!s.isEmpty()) {</span>
<span class="udiff-line-added">+                 result = s.returnAddress + result;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return result;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Determines if the {@linkplain #getAncestry() ancestry} of this scope is a prefix of the</span>
<span class="udiff-line-added">+      * ancestry of {@code other}.</span>
<span class="udiff-line-added">+      */</span>
      public boolean isPrefixOf(JsrScope other) {
<span class="udiff-line-modified-removed">-         return (scope &amp; other.scope) == scope;</span>
<span class="udiff-line-modified-added">+         if (isEmpty()) {</span>
<span class="udiff-line-added">+             return true;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         String ancestry = getAncestry();</span>
<span class="udiff-line-added">+         String otherAncestry = other.getAncestry();</span>
<span class="udiff-line-added">+         return otherAncestry.startsWith(ancestry);</span>
      }
  
<span class="udiff-line-added">+     /**</span>
<span class="udiff-line-added">+      * Gets this scope&#39;s parent.</span>
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * @return this scope&#39;s parent or {@link #EMPTY_SCOPE} if this is the {@link #EMPTY_SCOPE}</span>
<span class="udiff-line-added">+      */</span>
      public JsrScope pop() {
<span class="udiff-line-modified-removed">-         return new JsrScope(scope &gt;&gt;&gt; 16);</span>
<span class="udiff-line-modified-added">+         if (isEmpty()) {</span>
<span class="udiff-line-added">+             return this;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return parent;</span>
      }
  
      @Override
      public int hashCode() {
<span class="udiff-line-modified-removed">-         return (int) (scope ^ (scope &gt;&gt;&gt; 32));</span>
<span class="udiff-line-modified-added">+         int hc = returnAddress;</span>
<span class="udiff-line-added">+         JsrScope ancestor = parent;</span>
<span class="udiff-line-added">+         while (ancestor != null) {</span>
<span class="udiff-line-added">+             hc = hc ^ ancestor.returnAddress;</span>
<span class="udiff-line-added">+             ancestor = ancestor.parent;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return hc;</span>
      }
  
      @Override
      public boolean equals(Object obj) {
          if (this == obj) {
              return true;
          }
<span class="udiff-line-modified-removed">-         return obj != null &amp;&amp; getClass() == obj.getClass() &amp;&amp; scope == ((JsrScope) obj).scope;</span>
<span class="udiff-line-modified-added">+         if (obj != null &amp;&amp; getClass() == obj.getClass()) {</span>
<span class="udiff-line-added">+             JsrScope ancestor = this;</span>
<span class="udiff-line-added">+             JsrScope otherAncestor = (JsrScope) obj;</span>
<span class="udiff-line-added">+             while (ancestor != null) {</span>
<span class="udiff-line-added">+                 if (otherAncestor == null) {</span>
<span class="udiff-line-added">+                     return false;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 if (otherAncestor.returnAddress != ancestor.returnAddress) {</span>
<span class="udiff-line-added">+                     return false;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 ancestor = ancestor.parent;</span>
<span class="udiff-line-added">+                 otherAncestor = otherAncestor.parent;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (otherAncestor == null) {</span>
<span class="udiff-line-added">+                 return true;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         return false;</span>
      }
  
      @Override
      public String toString() {
          StringBuilder sb = new StringBuilder();
<span class="udiff-line-modified-removed">-         long tmp = scope;</span>
<span class="udiff-line-modified-removed">-         sb.append(&quot; [&quot;);</span>
<span class="udiff-line-modified-removed">-         while (tmp != 0) {</span>
<span class="udiff-line-modified-removed">-             sb.append(&quot;, &quot;).append(tmp &amp; 0xffff);</span>
<span class="udiff-line-modified-removed">-             tmp = tmp &gt;&gt;&gt; 16;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         for (JsrScope ancestor = this; ancestor != null; ancestor = ancestor.parent) {</span>
<span class="udiff-line-modified-added">+             if (!ancestor.isEmpty()) {</span>
<span class="udiff-line-modified-added">+                 if (sb.length() != 0) {</span>
<span class="udiff-line-modified-added">+                     sb.append(&quot;, &quot;);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 sb.append((int) ancestor.returnAddress);</span>
<span class="udiff-line-added">+             }</span>
          }
<span class="udiff-line-modified-removed">-         sb.append(&#39;]&#39;);</span>
<span class="udiff-line-removed">-         return sb.toString();</span>
<span class="udiff-line-modified-added">+         return &quot;[&quot; + sb + &quot;]&quot;;</span>
      }
  }
</pre>
<center><a href="GraphBuilderPhase.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../org.graalvm.compiler.jtt/src/org/graalvm/compiler/jtt/backend/LargeConstantSectionTest.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>