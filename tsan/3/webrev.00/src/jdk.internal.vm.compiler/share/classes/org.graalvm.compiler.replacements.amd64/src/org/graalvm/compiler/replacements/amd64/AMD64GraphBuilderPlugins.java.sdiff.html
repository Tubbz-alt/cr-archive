<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.amd64/src/org/graalvm/compiler/replacements/amd64/AMD64GraphBuilderPlugins.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AMD64FloatConvertNode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="AMD64StringLatin1InflateNode.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.amd64/src/org/graalvm/compiler/replacements/amd64/AMD64GraphBuilderPlugins.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.replacements.amd64;
 26 
 27 import static org.graalvm.compiler.replacements.StandardGraphBuilderPlugins.registerPlatformSpecificUnsafePlugins;
 28 import static org.graalvm.compiler.replacements.nodes.BinaryMathIntrinsicNode.BinaryOperation.POW;
 29 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.COS;
 30 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.EXP;
 31 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.LOG;
 32 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.LOG10;
 33 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.SIN;
 34 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.TAN;
<span class="line-removed"> 35 import static org.graalvm.compiler.serviceprovider.JavaVersionUtil.JAVA_SPECIFICATION_VERSION;</span>
<span class="line-removed"> 36 import static org.graalvm.compiler.serviceprovider.JavaVersionUtil.Java11OrEarlier;</span>
<span class="line-removed"> 37 import static org.graalvm.compiler.serviceprovider.JavaVersionUtil.Java8OrEarlier;</span>
 38 
 39 import java.util.Arrays;
 40 
<span class="line-removed"> 41 import org.graalvm.compiler.bytecode.BytecodeProvider;</span>
 42 import org.graalvm.compiler.lir.amd64.AMD64ArithmeticLIRGeneratorTool.RoundingMode;
 43 import org.graalvm.compiler.nodes.PauseNode;
 44 import org.graalvm.compiler.nodes.ValueNode;
 45 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
 46 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;
 47 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
 48 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin.Receiver;
 49 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 50 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
 51 import org.graalvm.compiler.nodes.java.AtomicReadAndAddNode;
 52 import org.graalvm.compiler.nodes.java.AtomicReadAndWriteNode;
 53 import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;

 54 import org.graalvm.compiler.replacements.ArraysSubstitutions;
<span class="line-removed"> 55 import org.graalvm.compiler.replacements.IntegerSubstitutions;</span>
<span class="line-removed"> 56 import org.graalvm.compiler.replacements.LongSubstitutions;</span>
 57 import org.graalvm.compiler.replacements.StandardGraphBuilderPlugins.UnsafeAccessPlugin;
 58 import org.graalvm.compiler.replacements.StandardGraphBuilderPlugins.UnsafeGetPlugin;
 59 import org.graalvm.compiler.replacements.StandardGraphBuilderPlugins.UnsafePutPlugin;

 60 import org.graalvm.compiler.replacements.nodes.BinaryMathIntrinsicNode;
 61 import org.graalvm.compiler.replacements.nodes.BinaryMathIntrinsicNode.BinaryOperation;
 62 import org.graalvm.compiler.replacements.nodes.BitCountNode;

 63 import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode;
 64 import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation;

 65 
 66 import jdk.vm.ci.amd64.AMD64;
 67 import jdk.vm.ci.amd64.AMD64.CPUFeature;

 68 import jdk.vm.ci.meta.JavaKind;
 69 import jdk.vm.ci.meta.ResolvedJavaMethod;
 70 import sun.misc.Unsafe;
 71 
<span class="line-modified"> 72 public class AMD64GraphBuilderPlugins {</span>





 73 
<span class="line-modified"> 74     public static void register(Plugins plugins, BytecodeProvider replacementsBytecodeProvider, AMD64 arch, boolean explicitUnsafeNullChecks) {</span>


 75         InvocationPlugins invocationPlugins = plugins.getInvocationPlugins();
 76         invocationPlugins.defer(new Runnable() {
 77             @Override
 78             public void run() {
 79                 registerThreadPlugins(invocationPlugins, arch);
<span class="line-modified"> 80                 registerIntegerLongPlugins(invocationPlugins, IntegerSubstitutions.class, JavaKind.Int, arch, replacementsBytecodeProvider);</span>
<span class="line-modified"> 81                 registerIntegerLongPlugins(invocationPlugins, LongSubstitutions.class, JavaKind.Long, arch, replacementsBytecodeProvider);</span>
<span class="line-modified"> 82                 registerPlatformSpecificUnsafePlugins(invocationPlugins, replacementsBytecodeProvider, explicitUnsafeNullChecks,</span>
 83                                 new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object, JavaKind.Boolean, JavaKind.Byte, JavaKind.Short, JavaKind.Char, JavaKind.Float, JavaKind.Double});
<span class="line-modified"> 84                 registerUnsafePlugins(invocationPlugins, replacementsBytecodeProvider, explicitUnsafeNullChecks);</span>
<span class="line-modified"> 85                 registerStringPlugins(invocationPlugins, replacementsBytecodeProvider);</span>
<span class="line-modified"> 86                 registerStringLatin1Plugins(invocationPlugins, replacementsBytecodeProvider);</span>
<span class="line-modified"> 87                 registerStringUTF16Plugins(invocationPlugins, replacementsBytecodeProvider);</span>
<span class="line-modified"> 88                 registerMathPlugins(invocationPlugins, arch, replacementsBytecodeProvider);</span>
<span class="line-modified"> 89                 registerArraysEqualsPlugins(invocationPlugins, replacementsBytecodeProvider);</span>


 90             }
 91         });
 92     }
 93 
 94     private static void registerThreadPlugins(InvocationPlugins plugins, AMD64 arch) {
<span class="line-modified"> 95         if (!Java8OrEarlier) {</span>
 96             // Pause instruction introduced with SSE2
<span class="line-modified"> 97             if (arch.getFeatures().contains(AMD64.CPUFeature.SSE2)) {</span>
<span class="line-modified"> 98                 Registration r = new Registration(plugins, Thread.class);</span>
<span class="line-modified"> 99                 r.register0(&quot;onSpinWait&quot;, new InvocationPlugin() {</span>
<span class="line-removed">100                     @Override</span>
<span class="line-removed">101                     public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver) {</span>
<span class="line-removed">102                         b.append(new PauseNode());</span>
<span class="line-removed">103                         return true;</span>
<span class="line-removed">104                     }</span>
<span class="line-removed">105                 });</span>
<span class="line-removed">106             }</span>
<span class="line-removed">107         }</span>
<span class="line-removed">108     }</span>
<span class="line-removed">109 </span>
<span class="line-removed">110     private static void registerIntegerLongPlugins(InvocationPlugins plugins, Class&lt;?&gt; substituteDeclaringClass, JavaKind kind, AMD64 arch, BytecodeProvider bytecodeProvider) {</span>
<span class="line-removed">111         Class&lt;?&gt; declaringClass = kind.toBoxedJavaClass();</span>
<span class="line-removed">112         Class&lt;?&gt; type = kind.toJavaClass();</span>
<span class="line-removed">113         Registration r = new Registration(plugins, declaringClass, bytecodeProvider);</span>
<span class="line-removed">114         if (arch.getFeatures().contains(AMD64.CPUFeature.LZCNT) &amp;&amp; arch.getFlags().contains(AMD64.Flag.UseCountLeadingZerosInstruction)) {</span>
<span class="line-removed">115             r.register1(&quot;numberOfLeadingZeros&quot;, type, new InvocationPlugin() {</span>
<span class="line-removed">116                 @Override</span>
<span class="line-removed">117                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {</span>
<span class="line-removed">118                     ValueNode folded = AMD64CountLeadingZerosNode.tryFold(value);</span>
<span class="line-removed">119                     if (folded != null) {</span>
<span class="line-removed">120                         b.addPush(JavaKind.Int, folded);</span>
<span class="line-removed">121                     } else {</span>
<span class="line-removed">122                         b.addPush(JavaKind.Int, new AMD64CountLeadingZerosNode(value));</span>
<span class="line-removed">123                     }</span>
<span class="line-removed">124                     return true;</span>
<span class="line-removed">125                 }</span>
<span class="line-removed">126             });</span>
<span class="line-removed">127         } else {</span>
<span class="line-removed">128             r.registerMethodSubstitution(substituteDeclaringClass, &quot;numberOfLeadingZeros&quot;, type);</span>
<span class="line-removed">129         }</span>
<span class="line-removed">130         if (arch.getFeatures().contains(AMD64.CPUFeature.BMI1) &amp;&amp; arch.getFlags().contains(AMD64.Flag.UseCountTrailingZerosInstruction)) {</span>
<span class="line-removed">131             r.register1(&quot;numberOfTrailingZeros&quot;, type, new InvocationPlugin() {</span>
132                 @Override
<span class="line-modified">133                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {</span>
<span class="line-modified">134                     ValueNode folded = AMD64CountTrailingZerosNode.tryFold(value);</span>
<span class="line-removed">135                     if (folded != null) {</span>
<span class="line-removed">136                         b.addPush(JavaKind.Int, folded);</span>
<span class="line-removed">137                     } else {</span>
<span class="line-removed">138                         b.addPush(JavaKind.Int, new AMD64CountTrailingZerosNode(value));</span>
<span class="line-removed">139                     }</span>
140                     return true;
141                 }
142             });
<span class="line-removed">143         } else {</span>
<span class="line-removed">144             r.registerMethodSubstitution(substituteDeclaringClass, &quot;numberOfTrailingZeros&quot;, type);</span>
145         }

146 
<span class="line-modified">147         if (arch.getFeatures().contains(AMD64.CPUFeature.POPCNT)) {</span>
<span class="line-modified">148             r.register1(&quot;bitCount&quot;, type, new InvocationPlugin() {</span>
<span class="line-modified">149                 @Override</span>
<span class="line-modified">150                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {</span>
<span class="line-modified">151                     b.push(JavaKind.Int, b.append(new BitCountNode(value).canonical(null)));</span>
<span class="line-modified">152                     return true;</span>
<span class="line-modified">153                 }</span>
<span class="line-modified">154             });</span>
<span class="line-modified">155         }</span>






156     }
157 
<span class="line-modified">158     private static void registerMathPlugins(InvocationPlugins plugins, AMD64 arch, BytecodeProvider bytecodeProvider) {</span>
<span class="line-modified">159         Registration r = new Registration(plugins, Math.class, bytecodeProvider);</span>
160         registerUnaryMath(r, &quot;log&quot;, LOG);
161         registerUnaryMath(r, &quot;log10&quot;, LOG10);
162         registerUnaryMath(r, &quot;exp&quot;, EXP);
163         registerBinaryMath(r, &quot;pow&quot;, POW);
164         registerUnaryMath(r, &quot;sin&quot;, SIN);
165         registerUnaryMath(r, &quot;cos&quot;, COS);
166         registerUnaryMath(r, &quot;tan&quot;, TAN);
167 
<span class="line-modified">168         if (arch.getFeatures().contains(CPUFeature.SSE4_1)) {</span>
<span class="line-modified">169             registerRound(r, &quot;rint&quot;, RoundingMode.NEAREST);</span>
<span class="line-modified">170             registerRound(r, &quot;ceil&quot;, RoundingMode.UP);</span>
<span class="line-modified">171             registerRound(r, &quot;floor&quot;, RoundingMode.DOWN);</span>



172         }
173     }
174 



































175     private static void registerUnaryMath(Registration r, String name, UnaryOperation operation) {
176         r.register1(name, Double.TYPE, new InvocationPlugin() {
177             @Override
178             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {
179                 b.push(JavaKind.Double, b.append(UnaryMathIntrinsicNode.create(value, operation)));
180                 return true;
181             }
182         });
183     }
184 
185     private static void registerBinaryMath(Registration r, String name, BinaryOperation operation) {
186         r.register2(name, Double.TYPE, Double.TYPE, new InvocationPlugin() {
187             @Override
188             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode x, ValueNode y) {
189                 b.push(JavaKind.Double, b.append(BinaryMathIntrinsicNode.create(x, y, operation)));
190                 return true;
191             }
192         });
193     }
194 
<span class="line-modified">195     private static void registerRound(Registration r, String name, RoundingMode mode) {</span>
<span class="line-modified">196         r.register1(name, Double.TYPE, new InvocationPlugin() {</span>
197             @Override
198             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode arg) {
199                 b.push(JavaKind.Double, b.append(new AMD64RoundNode(arg, mode)));
200                 return true;
201             }
202         });
203     }
204 
<span class="line-modified">205     private static void registerStringPlugins(InvocationPlugins plugins, BytecodeProvider replacementsBytecodeProvider) {</span>
<span class="line-modified">206         if (Java8OrEarlier) {</span>
207             Registration r;
<span class="line-modified">208             r = new Registration(plugins, String.class, replacementsBytecodeProvider);</span>
209             r.setAllowOverwrite(true);
210             r.registerMethodSubstitution(AMD64StringSubstitutions.class, &quot;indexOf&quot;, char[].class, int.class,
211                             int.class, char[].class, int.class, int.class, int.class);
212             r.registerMethodSubstitution(AMD64StringSubstitutions.class, &quot;indexOf&quot;, Receiver.class, int.class, int.class);
213             r.registerMethodSubstitution(AMD64StringSubstitutions.class, &quot;compareTo&quot;, Receiver.class, String.class);
214         }
215     }
216 
<span class="line-modified">217     private static void registerStringLatin1Plugins(InvocationPlugins plugins, BytecodeProvider replacementsBytecodeProvider) {</span>
<span class="line-modified">218         if (JAVA_SPECIFICATION_VERSION &gt;= 9) {</span>
<span class="line-modified">219             Registration r = new Registration(plugins, &quot;java.lang.StringLatin1&quot;, replacementsBytecodeProvider);</span>
<span class="line-modified">220             r.setAllowOverwrite(true);</span>
<span class="line-modified">221             r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);</span>
<span class="line-modified">222             r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;compareToUTF16&quot;, byte[].class, byte[].class);</span>
<span class="line-modified">223             r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;inflate&quot;, byte[].class, int.class, char[].class, int.class, int.class);</span>
<span class="line-modified">224             r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;inflate&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-modified">225             r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;indexOf&quot;, byte[].class, int.class, int.class);</span>
<span class="line-removed">226             r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;indexOf&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-removed">227         }</span>
228     }
229 
<span class="line-modified">230     private static void registerStringUTF16Plugins(InvocationPlugins plugins, BytecodeProvider replacementsBytecodeProvider) {</span>
<span class="line-modified">231         if (JAVA_SPECIFICATION_VERSION &gt;= 9) {</span>
<span class="line-modified">232             Registration r = new Registration(plugins, &quot;java.lang.StringUTF16&quot;, replacementsBytecodeProvider);</span>
<span class="line-modified">233             r.setAllowOverwrite(true);</span>
<span class="line-modified">234             r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);</span>
<span class="line-modified">235             r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;compareToLatin1&quot;, byte[].class, byte[].class);</span>
<span class="line-modified">236             r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;compress&quot;, char[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-modified">237             r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;compress&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-modified">238             r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;indexOfCharUnsafe&quot;, byte[].class, int.class, int.class, int.class);</span>
<span class="line-modified">239             r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;indexOfUnsafe&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-removed">240             r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;indexOfLatin1Unsafe&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-removed">241         }</span>
242     }
243 
<span class="line-modified">244     private static void registerUnsafePlugins(InvocationPlugins plugins, BytecodeProvider replacementsBytecodeProvider, boolean explicitUnsafeNullChecks) {</span>
245         registerUnsafePlugins(new Registration(plugins, Unsafe.class), explicitUnsafeNullChecks, new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object}, true);
<span class="line-modified">246         if (!Java8OrEarlier) {</span>
<span class="line-modified">247             registerUnsafePlugins(new Registration(plugins, &quot;jdk.internal.misc.Unsafe&quot;, replacementsBytecodeProvider), explicitUnsafeNullChecks,</span>
<span class="line-modified">248                             new JavaKind[]{JavaKind.Boolean, JavaKind.Byte, JavaKind.Char, JavaKind.Short, JavaKind.Int, JavaKind.Long, JavaKind.Object}, Java11OrEarlier);</span>

249         }
250     }
251 
252     private static void registerUnsafePlugins(Registration r, boolean explicitUnsafeNullChecks, JavaKind[] unsafeJavaKinds, boolean java11OrEarlier) {
253         for (JavaKind kind : unsafeJavaKinds) {
254             Class&lt;?&gt; javaClass = kind == JavaKind.Object ? Object.class : kind.toJavaClass();
255             String kindName = (kind == JavaKind.Object &amp;&amp; !java11OrEarlier) ? &quot;Reference&quot; : kind.name();
256             r.register4(&quot;getAndSet&quot; + kindName, Receiver.class, Object.class, long.class, javaClass, new UnsafeAccessPlugin(kind, explicitUnsafeNullChecks) {
257                 @Override
258                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver unsafe, ValueNode object, ValueNode offset, ValueNode value) {
259                     // Emits a null-check for the otherwise unused receiver
260                     unsafe.get();
261                     createUnsafeAccess(object, b, (obj, loc) -&gt; new AtomicReadAndWriteNode(obj, offset, value, kind, loc));
262                     return true;
263                 }
264             });
265             if (kind != JavaKind.Boolean &amp;&amp; kind.isNumericInteger()) {
266                 r.register4(&quot;getAndAdd&quot; + kindName, Receiver.class, Object.class, long.class, javaClass, new UnsafeAccessPlugin(kind, explicitUnsafeNullChecks) {
267                     @Override
268                     public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver unsafe, ValueNode object, ValueNode offset, ValueNode delta) {
269                         // Emits a null-check for the otherwise unused receiver
270                         unsafe.get();
271                         createUnsafeAccess(object, b, (obj, loc) -&gt; new AtomicReadAndAddNode(b.add(new OffsetAddressNode(obj, offset)), delta, kind, loc));
272                         return true;
273                     }
274                 });
275             }
276         }
277 
278         for (JavaKind kind : new JavaKind[]{JavaKind.Char, JavaKind.Short, JavaKind.Int, JavaKind.Long}) {
279             Class&lt;?&gt; javaClass = kind.toJavaClass();
280             r.registerOptional3(&quot;get&quot; + kind.name() + &quot;Unaligned&quot;, Receiver.class, Object.class, long.class, new UnsafeGetPlugin(kind, explicitUnsafeNullChecks));
281             r.registerOptional4(&quot;put&quot; + kind.name() + &quot;Unaligned&quot;, Receiver.class, Object.class, long.class, javaClass, new UnsafePutPlugin(kind, explicitUnsafeNullChecks));
282         }
283     }
284 
<span class="line-modified">285     private static void registerArraysEqualsPlugins(InvocationPlugins plugins, BytecodeProvider bytecodeProvider) {</span>
<span class="line-modified">286         Registration r = new Registration(plugins, Arrays.class, bytecodeProvider);</span>
287         r.registerMethodSubstitution(ArraysSubstitutions.class, &quot;equals&quot;, float[].class, float[].class);
288         r.registerMethodSubstitution(ArraysSubstitutions.class, &quot;equals&quot;, double[].class, double[].class);
289     }
290 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.replacements.amd64;
 26 
 27 import static org.graalvm.compiler.replacements.StandardGraphBuilderPlugins.registerPlatformSpecificUnsafePlugins;
 28 import static org.graalvm.compiler.replacements.nodes.BinaryMathIntrinsicNode.BinaryOperation.POW;
 29 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.COS;
 30 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.EXP;
 31 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.LOG;
 32 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.LOG10;
 33 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.SIN;
 34 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.TAN;



 35 
 36 import java.util.Arrays;
 37 

 38 import org.graalvm.compiler.lir.amd64.AMD64ArithmeticLIRGeneratorTool.RoundingMode;
 39 import org.graalvm.compiler.nodes.PauseNode;
 40 import org.graalvm.compiler.nodes.ValueNode;
 41 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
 42 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;
 43 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
 44 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin.Receiver;
 45 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 46 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
 47 import org.graalvm.compiler.nodes.java.AtomicReadAndAddNode;
 48 import org.graalvm.compiler.nodes.java.AtomicReadAndWriteNode;
 49 import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;
<span class="line-added"> 50 import org.graalvm.compiler.nodes.spi.Replacements;</span>
 51 import org.graalvm.compiler.replacements.ArraysSubstitutions;


 52 import org.graalvm.compiler.replacements.StandardGraphBuilderPlugins.UnsafeAccessPlugin;
 53 import org.graalvm.compiler.replacements.StandardGraphBuilderPlugins.UnsafeGetPlugin;
 54 import org.graalvm.compiler.replacements.StandardGraphBuilderPlugins.UnsafePutPlugin;
<span class="line-added"> 55 import org.graalvm.compiler.replacements.TargetGraphBuilderPlugins;</span>
 56 import org.graalvm.compiler.replacements.nodes.BinaryMathIntrinsicNode;
 57 import org.graalvm.compiler.replacements.nodes.BinaryMathIntrinsicNode.BinaryOperation;
 58 import org.graalvm.compiler.replacements.nodes.BitCountNode;
<span class="line-added"> 59 import org.graalvm.compiler.replacements.nodes.FusedMultiplyAddNode;</span>
 60 import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode;
 61 import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation;
<span class="line-added"> 62 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;</span>
 63 
 64 import jdk.vm.ci.amd64.AMD64;
 65 import jdk.vm.ci.amd64.AMD64.CPUFeature;
<span class="line-added"> 66 import jdk.vm.ci.code.Architecture;</span>
 67 import jdk.vm.ci.meta.JavaKind;
 68 import jdk.vm.ci.meta.ResolvedJavaMethod;
 69 import sun.misc.Unsafe;
 70 
<span class="line-modified"> 71 public class AMD64GraphBuilderPlugins implements TargetGraphBuilderPlugins {</span>
<span class="line-added"> 72     @Override</span>
<span class="line-added"> 73     public void register(Plugins plugins, Replacements replacements, Architecture architecture, boolean explicitUnsafeNullChecks,</span>
<span class="line-added"> 74                     boolean registerMathPlugins, boolean emitJDK9StringSubstitutions, boolean useFMAIntrinsics) {</span>
<span class="line-added"> 75         register(plugins, replacements, (AMD64) architecture, explicitUnsafeNullChecks, emitJDK9StringSubstitutions, useFMAIntrinsics);</span>
<span class="line-added"> 76     }</span>
 77 
<span class="line-modified"> 78     public static void register(Plugins plugins, Replacements replacements, AMD64 arch, boolean explicitUnsafeNullChecks,</span>
<span class="line-added"> 79                     boolean emitJDK9StringSubstitutions,</span>
<span class="line-added"> 80                     boolean useFMAIntrinsics) {</span>
 81         InvocationPlugins invocationPlugins = plugins.getInvocationPlugins();
 82         invocationPlugins.defer(new Runnable() {
 83             @Override
 84             public void run() {
 85                 registerThreadPlugins(invocationPlugins, arch);
<span class="line-modified"> 86                 registerIntegerLongPlugins(invocationPlugins, AMD64IntegerSubstitutions.class, JavaKind.Int, arch, replacements);</span>
<span class="line-modified"> 87                 registerIntegerLongPlugins(invocationPlugins, AMD64LongSubstitutions.class, JavaKind.Long, arch, replacements);</span>
<span class="line-modified"> 88                 registerPlatformSpecificUnsafePlugins(invocationPlugins, replacements, explicitUnsafeNullChecks,</span>
 89                                 new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object, JavaKind.Boolean, JavaKind.Byte, JavaKind.Short, JavaKind.Char, JavaKind.Float, JavaKind.Double});
<span class="line-modified"> 90                 registerUnsafePlugins(invocationPlugins, replacements, explicitUnsafeNullChecks);</span>
<span class="line-modified"> 91                 registerStringPlugins(invocationPlugins, replacements);</span>
<span class="line-modified"> 92                 if (emitJDK9StringSubstitutions) {</span>
<span class="line-modified"> 93                     registerStringLatin1Plugins(invocationPlugins, replacements);</span>
<span class="line-modified"> 94                     registerStringUTF16Plugins(invocationPlugins, replacements);</span>
<span class="line-modified"> 95                 }</span>
<span class="line-added"> 96                 registerMathPlugins(invocationPlugins, useFMAIntrinsics, arch, replacements);</span>
<span class="line-added"> 97                 registerArraysEqualsPlugins(invocationPlugins, replacements);</span>
 98             }
 99         });
100     }
101 
102     private static void registerThreadPlugins(InvocationPlugins plugins, AMD64 arch) {
<span class="line-modified">103         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
104             // Pause instruction introduced with SSE2
<span class="line-modified">105             assert (arch.getFeatures().contains(AMD64.CPUFeature.SSE2));</span>
<span class="line-modified">106             Registration r = new Registration(plugins, Thread.class);</span>
<span class="line-modified">107             r.register0(&quot;onSpinWait&quot;, new InvocationPlugin() {</span>
































108                 @Override
<span class="line-modified">109                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver) {</span>
<span class="line-modified">110                     b.append(new PauseNode());</span>





111                     return true;
112                 }
113             });


114         }
<span class="line-added">115     }</span>
116 
<span class="line-modified">117     private static void registerIntegerLongPlugins(InvocationPlugins plugins, Class&lt;?&gt; substituteDeclaringClass, JavaKind kind, AMD64 arch, Replacements replacements) {</span>
<span class="line-modified">118         Class&lt;?&gt; declaringClass = kind.toBoxedJavaClass();</span>
<span class="line-modified">119         Class&lt;?&gt; type = kind.toJavaClass();</span>
<span class="line-modified">120         Registration r = new Registration(plugins, declaringClass, replacements);</span>
<span class="line-modified">121         r.registerMethodSubstitution(substituteDeclaringClass, &quot;numberOfLeadingZeros&quot;, type);</span>
<span class="line-modified">122         r.registerMethodSubstitution(substituteDeclaringClass, &quot;numberOfTrailingZeros&quot;, type);</span>
<span class="line-modified">123 </span>
<span class="line-modified">124         r.registerConditional1(arch.getFeatures().contains(AMD64.CPUFeature.POPCNT),</span>
<span class="line-modified">125                         &quot;bitCount&quot;, type, new InvocationPlugin() {</span>
<span class="line-added">126                             @Override</span>
<span class="line-added">127                             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {</span>
<span class="line-added">128                                 b.push(JavaKind.Int, b.append(new BitCountNode(value).canonical(null)));</span>
<span class="line-added">129                                 return true;</span>
<span class="line-added">130                             }</span>
<span class="line-added">131                         });</span>
132     }
133 
<span class="line-modified">134     private static void registerMathPlugins(InvocationPlugins plugins, boolean useFMAIntrinsics, AMD64 arch, Replacements replacements) {</span>
<span class="line-modified">135         Registration r = new Registration(plugins, Math.class, replacements);</span>
136         registerUnaryMath(r, &quot;log&quot;, LOG);
137         registerUnaryMath(r, &quot;log10&quot;, LOG10);
138         registerUnaryMath(r, &quot;exp&quot;, EXP);
139         registerBinaryMath(r, &quot;pow&quot;, POW);
140         registerUnaryMath(r, &quot;sin&quot;, SIN);
141         registerUnaryMath(r, &quot;cos&quot;, COS);
142         registerUnaryMath(r, &quot;tan&quot;, TAN);
143 
<span class="line-modified">144         boolean roundEnabled = arch.getFeatures().contains(CPUFeature.SSE4_1);</span>
<span class="line-modified">145         registerRound(roundEnabled, r, &quot;rint&quot;, RoundingMode.NEAREST);</span>
<span class="line-modified">146         registerRound(roundEnabled, r, &quot;ceil&quot;, RoundingMode.UP);</span>
<span class="line-modified">147         registerRound(roundEnabled, r, &quot;floor&quot;, RoundingMode.DOWN);</span>
<span class="line-added">148 </span>
<span class="line-added">149         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-added">150             registerFMA(r, useFMAIntrinsics &amp;&amp; arch.getFeatures().contains(CPUFeature.FMA));</span>
151         }
152     }
153 
<span class="line-added">154     private static void registerFMA(Registration r, boolean isEnabled) {</span>
<span class="line-added">155         r.registerConditional3(isEnabled, &quot;fma&quot;,</span>
<span class="line-added">156                         Double.TYPE,</span>
<span class="line-added">157                         Double.TYPE,</span>
<span class="line-added">158                         Double.TYPE,</span>
<span class="line-added">159                         new InvocationPlugin() {</span>
<span class="line-added">160                             @Override</span>
<span class="line-added">161                             public boolean apply(GraphBuilderContext b,</span>
<span class="line-added">162                                             ResolvedJavaMethod targetMethod,</span>
<span class="line-added">163                                             Receiver receiver,</span>
<span class="line-added">164                                             ValueNode na,</span>
<span class="line-added">165                                             ValueNode nb,</span>
<span class="line-added">166                                             ValueNode nc) {</span>
<span class="line-added">167                                 b.push(JavaKind.Double, b.append(new FusedMultiplyAddNode(na, nb, nc)));</span>
<span class="line-added">168                                 return true;</span>
<span class="line-added">169                             }</span>
<span class="line-added">170                         });</span>
<span class="line-added">171         r.registerConditional3(isEnabled, &quot;fma&quot;,</span>
<span class="line-added">172                         Float.TYPE,</span>
<span class="line-added">173                         Float.TYPE,</span>
<span class="line-added">174                         Float.TYPE,</span>
<span class="line-added">175                         new InvocationPlugin() {</span>
<span class="line-added">176                             @Override</span>
<span class="line-added">177                             public boolean apply(GraphBuilderContext b,</span>
<span class="line-added">178                                             ResolvedJavaMethod targetMethod,</span>
<span class="line-added">179                                             Receiver receiver,</span>
<span class="line-added">180                                             ValueNode na,</span>
<span class="line-added">181                                             ValueNode nb,</span>
<span class="line-added">182                                             ValueNode nc) {</span>
<span class="line-added">183                                 b.push(JavaKind.Float, b.append(new FusedMultiplyAddNode(na, nb, nc)));</span>
<span class="line-added">184                                 return true;</span>
<span class="line-added">185                             }</span>
<span class="line-added">186                         });</span>
<span class="line-added">187     }</span>
<span class="line-added">188 </span>
189     private static void registerUnaryMath(Registration r, String name, UnaryOperation operation) {
190         r.register1(name, Double.TYPE, new InvocationPlugin() {
191             @Override
192             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {
193                 b.push(JavaKind.Double, b.append(UnaryMathIntrinsicNode.create(value, operation)));
194                 return true;
195             }
196         });
197     }
198 
199     private static void registerBinaryMath(Registration r, String name, BinaryOperation operation) {
200         r.register2(name, Double.TYPE, Double.TYPE, new InvocationPlugin() {
201             @Override
202             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode x, ValueNode y) {
203                 b.push(JavaKind.Double, b.append(BinaryMathIntrinsicNode.create(x, y, operation)));
204                 return true;
205             }
206         });
207     }
208 
<span class="line-modified">209     private static void registerRound(boolean isEnabled, Registration r, String name, RoundingMode mode) {</span>
<span class="line-modified">210         r.registerConditional1(isEnabled, name, Double.TYPE, new InvocationPlugin() {</span>
211             @Override
212             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode arg) {
213                 b.push(JavaKind.Double, b.append(new AMD64RoundNode(arg, mode)));
214                 return true;
215             }
216         });
217     }
218 
<span class="line-modified">219     private static void registerStringPlugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">220         if (JavaVersionUtil.JAVA_SPEC &lt;= 8) {</span>
221             Registration r;
<span class="line-modified">222             r = new Registration(plugins, String.class, replacements);</span>
223             r.setAllowOverwrite(true);
224             r.registerMethodSubstitution(AMD64StringSubstitutions.class, &quot;indexOf&quot;, char[].class, int.class,
225                             int.class, char[].class, int.class, int.class, int.class);
226             r.registerMethodSubstitution(AMD64StringSubstitutions.class, &quot;indexOf&quot;, Receiver.class, int.class, int.class);
227             r.registerMethodSubstitution(AMD64StringSubstitutions.class, &quot;compareTo&quot;, Receiver.class, String.class);
228         }
229     }
230 
<span class="line-modified">231     private static void registerStringLatin1Plugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">232         Registration r = new Registration(plugins, &quot;java.lang.StringLatin1&quot;, replacements);</span>
<span class="line-modified">233         r.setAllowOverwrite(true);</span>
<span class="line-modified">234         r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);</span>
<span class="line-modified">235         r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;compareToUTF16&quot;, byte[].class, byte[].class);</span>
<span class="line-modified">236         r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;inflate&quot;, byte[].class, int.class, char[].class, int.class, int.class);</span>
<span class="line-modified">237         r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;inflate&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-modified">238         r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;indexOf&quot;, byte[].class, int.class, int.class);</span>
<span class="line-modified">239         r.registerMethodSubstitution(AMD64StringLatin1Substitutions.class, &quot;indexOf&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>


240     }
241 
<span class="line-modified">242     private static void registerStringUTF16Plugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">243         Registration r = new Registration(plugins, &quot;java.lang.StringUTF16&quot;, replacements);</span>
<span class="line-modified">244         r.setAllowOverwrite(true);</span>
<span class="line-modified">245         r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);</span>
<span class="line-modified">246         r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;compareToLatin1&quot;, byte[].class, byte[].class);</span>
<span class="line-modified">247         r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;compress&quot;, char[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-modified">248         r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;compress&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-modified">249         r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;indexOfCharUnsafe&quot;, byte[].class, int.class, int.class, int.class);</span>
<span class="line-modified">250         r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;indexOfUnsafe&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>
<span class="line-modified">251         r.registerMethodSubstitution(AMD64StringUTF16Substitutions.class, &quot;indexOfLatin1Unsafe&quot;, byte[].class, int.class, byte[].class, int.class, int.class);</span>


252     }
253 
<span class="line-modified">254     private static void registerUnsafePlugins(InvocationPlugins plugins, Replacements replacements, boolean explicitUnsafeNullChecks) {</span>
255         registerUnsafePlugins(new Registration(plugins, Unsafe.class), explicitUnsafeNullChecks, new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object}, true);
<span class="line-modified">256         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-modified">257             registerUnsafePlugins(new Registration(plugins, &quot;jdk.internal.misc.Unsafe&quot;, replacements), explicitUnsafeNullChecks,</span>
<span class="line-modified">258                             new JavaKind[]{JavaKind.Boolean, JavaKind.Byte, JavaKind.Char, JavaKind.Short, JavaKind.Int, JavaKind.Long, JavaKind.Object},</span>
<span class="line-added">259                             JavaVersionUtil.JAVA_SPEC &lt;= 11);</span>
260         }
261     }
262 
263     private static void registerUnsafePlugins(Registration r, boolean explicitUnsafeNullChecks, JavaKind[] unsafeJavaKinds, boolean java11OrEarlier) {
264         for (JavaKind kind : unsafeJavaKinds) {
265             Class&lt;?&gt; javaClass = kind == JavaKind.Object ? Object.class : kind.toJavaClass();
266             String kindName = (kind == JavaKind.Object &amp;&amp; !java11OrEarlier) ? &quot;Reference&quot; : kind.name();
267             r.register4(&quot;getAndSet&quot; + kindName, Receiver.class, Object.class, long.class, javaClass, new UnsafeAccessPlugin(kind, explicitUnsafeNullChecks) {
268                 @Override
269                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver unsafe, ValueNode object, ValueNode offset, ValueNode value) {
270                     // Emits a null-check for the otherwise unused receiver
271                     unsafe.get();
272                     createUnsafeAccess(object, b, (obj, loc) -&gt; new AtomicReadAndWriteNode(obj, offset, value, kind, loc));
273                     return true;
274                 }
275             });
276             if (kind != JavaKind.Boolean &amp;&amp; kind.isNumericInteger()) {
277                 r.register4(&quot;getAndAdd&quot; + kindName, Receiver.class, Object.class, long.class, javaClass, new UnsafeAccessPlugin(kind, explicitUnsafeNullChecks) {
278                     @Override
279                     public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver unsafe, ValueNode object, ValueNode offset, ValueNode delta) {
280                         // Emits a null-check for the otherwise unused receiver
281                         unsafe.get();
282                         createUnsafeAccess(object, b, (obj, loc) -&gt; new AtomicReadAndAddNode(b.add(new OffsetAddressNode(obj, offset)), delta, kind, loc));
283                         return true;
284                     }
285                 });
286             }
287         }
288 
289         for (JavaKind kind : new JavaKind[]{JavaKind.Char, JavaKind.Short, JavaKind.Int, JavaKind.Long}) {
290             Class&lt;?&gt; javaClass = kind.toJavaClass();
291             r.registerOptional3(&quot;get&quot; + kind.name() + &quot;Unaligned&quot;, Receiver.class, Object.class, long.class, new UnsafeGetPlugin(kind, explicitUnsafeNullChecks));
292             r.registerOptional4(&quot;put&quot; + kind.name() + &quot;Unaligned&quot;, Receiver.class, Object.class, long.class, javaClass, new UnsafePutPlugin(kind, explicitUnsafeNullChecks));
293         }
294     }
295 
<span class="line-modified">296     private static void registerArraysEqualsPlugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">297         Registration r = new Registration(plugins, Arrays.class, replacements);</span>
298         r.registerMethodSubstitution(ArraysSubstitutions.class, &quot;equals&quot;, float[].class, float[].class);
299         r.registerMethodSubstitution(ArraysSubstitutions.class, &quot;equals&quot;, double[].class, double[].class);
300     }
301 }
</pre>
</td>
</tr>
</table>
<center><a href="AMD64FloatConvertNode.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="AMD64StringLatin1InflateNode.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>