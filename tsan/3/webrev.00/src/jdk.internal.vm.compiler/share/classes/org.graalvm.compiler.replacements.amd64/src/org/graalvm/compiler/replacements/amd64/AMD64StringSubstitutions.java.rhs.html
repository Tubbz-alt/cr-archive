<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.amd64/src/org/graalvm/compiler/replacements/amd64/AMD64StringSubstitutions.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2013, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.replacements.amd64;
 26 
 27 import org.graalvm.compiler.api.replacements.ClassSubstitution;
 28 import org.graalvm.compiler.api.replacements.Fold;
 29 import org.graalvm.compiler.api.replacements.Fold.InjectedParameter;
 30 import org.graalvm.compiler.api.replacements.MethodSubstitution;
 31 import org.graalvm.compiler.core.common.SuppressFBWarnings;
 32 import org.graalvm.compiler.graph.Node.ConstantNodeParameter;
 33 import org.graalvm.compiler.replacements.StringSubstitutions;
 34 import org.graalvm.compiler.replacements.nodes.ArrayCompareToNode;
 35 import org.graalvm.compiler.replacements.nodes.ArrayRegionEqualsNode;
 36 import org.graalvm.compiler.word.Word;
 37 import jdk.internal.vm.compiler.word.Pointer;
 38 
 39 import jdk.vm.ci.meta.JavaKind;
 40 import jdk.vm.ci.meta.MetaAccessProvider;
 41 
 42 // JaCoCo Exclude
 43 
 44 /**
 45  * Substitutions for {@link java.lang.String} methods.
 46  */
 47 @ClassSubstitution(String.class)
 48 public class AMD64StringSubstitutions {
 49 
 50     @Fold
 51     static int charArrayBaseOffset(@InjectedParameter MetaAccessProvider metaAccess) {
 52         return metaAccess.getArrayBaseOffset(JavaKind.Char);
 53     }
 54 
 55     @Fold
 56     static int charArrayIndexScale(@InjectedParameter MetaAccessProvider metaAccess) {
 57         return metaAccess.getArrayIndexScale(JavaKind.Char);
 58     }
 59 
 60     /** Marker value for the {@link InjectedParameter} injected parameter. */
 61     static final MetaAccessProvider INJECTED = null;
 62 
 63     // Only exists in JDK &lt;= 8
 64     @MethodSubstitution(isStatic = true, optional = true)
 65     public static int indexOf(char[] source, int sourceOffset, int sourceCount,
 66                     @ConstantNodeParameter char[] target, int targetOffset, int targetCount,
 67                     int origFromIndex) {
 68         int fromIndex = origFromIndex;
 69         if (fromIndex &gt;= sourceCount) {
 70             return (targetCount == 0 ? sourceCount : -1);
 71         }
 72         if (fromIndex &lt; 0) {
 73             fromIndex = 0;
 74         }
 75         if (targetCount == 0) {
 76             // The empty string is in every string.
 77             return fromIndex;
 78         }
 79 
 80         int totalOffset = sourceOffset + fromIndex;
 81         if (sourceCount - fromIndex &lt; targetCount) {
 82             // The empty string contains nothing except the empty string.
 83             return -1;
 84         }
 85 
 86         if (targetCount == 1) {
<a name="2" id="anc2"></a><span class="line-modified"> 87             return AMD64ArrayIndexOf.indexOf1Char(source, sourceCount, totalOffset, target[targetOffset]);</span>












 88         } else {
<a name="3" id="anc3"></a><span class="line-modified"> 89             int haystackLength = sourceCount - (targetCount - 2);</span>
<span class="line-modified"> 90             while (totalOffset &lt; haystackLength) {</span>
<span class="line-modified"> 91                 int indexOfResult = AMD64ArrayIndexOf.indexOfTwoConsecutiveChars(source, haystackLength, totalOffset, target[targetOffset], target[targetOffset + 1]);</span>

 92                 if (indexOfResult &lt; 0) {
 93                     return -1;
 94                 }
<a name="4" id="anc4"></a><span class="line-modified"> 95                 totalOffset = indexOfResult;</span>
<span class="line-modified"> 96                 if (targetCount == 2) {</span>



 97                     return totalOffset;
<a name="5" id="anc5"></a><span class="line-added"> 98                 } else {</span>
<span class="line-added"> 99                     Pointer cmpSourcePointer = Word.objectToTrackedPointer(source).add(charArrayBaseOffset(INJECTED)).add(totalOffset * charArrayIndexScale(INJECTED));</span>
<span class="line-added">100                     Pointer targetPointer = Word.objectToTrackedPointer(target).add(charArrayBaseOffset(INJECTED)).add(targetOffset * charArrayIndexScale(INJECTED));</span>
<span class="line-added">101                     if (ArrayRegionEqualsNode.regionEquals(cmpSourcePointer, targetPointer, targetCount, JavaKind.Char)) {</span>
<span class="line-added">102                         return totalOffset;</span>
<span class="line-added">103                     }</span>
104                 }
105                 totalOffset++;
106             }
107             return -1;
108         }
109     }
110 
111     // Only exists in JDK &lt;= 8
112     @MethodSubstitution(isStatic = false, optional = true)
113     public static int indexOf(String source, int ch, int origFromIndex) {
114         int fromIndex = origFromIndex;
115         final int sourceCount = source.length();
116         if (fromIndex &gt;= sourceCount) {
117             // Note: fromIndex might be near -1&gt;&gt;&gt;1.
118             return -1;
119         }
120         if (fromIndex &lt; 0) {
121             fromIndex = 0;
122         }
123 
124         if (ch &lt; Character.MIN_SUPPLEMENTARY_CODE_POINT) {
125             char[] sourceArray = StringSubstitutions.getValue(source);
<a name="6" id="anc6"></a><span class="line-modified">126             return AMD64ArrayIndexOf.indexOf1Char(sourceArray, sourceCount, fromIndex, (char) ch);</span>






127         } else {
128             return indexOf(source, ch, origFromIndex);
129         }
130     }
131 
132     @MethodSubstitution(isStatic = false)
133     @SuppressFBWarnings(value = &quot;ES_COMPARING_PARAMETER_STRING_WITH_EQ&quot;, justification = &quot;reference equality on the receiver is what we want&quot;)
134     public static int compareTo(String receiver, String anotherString) {
135         if (receiver == anotherString) {
136             return 0;
137         }
138         char[] value = StringSubstitutions.getValue(receiver);
139         char[] other = StringSubstitutions.getValue(anotherString);
140         return ArrayCompareToNode.compareTo(value, other, value.length &lt;&lt; 1, other.length &lt;&lt; 1, JavaKind.Char, JavaKind.Char);
141     }
142 
143 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>