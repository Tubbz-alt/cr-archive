<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.amd64/src/org/graalvm/compiler/hotspot/amd64/AMD64HotSpotNodeLIRBuilder.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AMD64HotSpotLoweringProvider.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="AMD64HotSpotRegisterAllocationConfig.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.amd64/src/org/graalvm/compiler/hotspot/amd64/AMD64HotSpotNodeLIRBuilder.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -26,13 +26,15 @@</span>
  
  import static jdk.vm.ci.amd64.AMD64.rbp;
  import static jdk.vm.ci.code.ValueUtil.isStackSlot;
  import static org.graalvm.compiler.hotspot.HotSpotBackend.EXCEPTION_HANDLER_IN_CALLER;
  
<span class="udiff-line-added">+ import org.graalvm.compiler.api.replacements.Snippet;</span>
  import org.graalvm.compiler.core.amd64.AMD64NodeLIRBuilder;
  import org.graalvm.compiler.core.amd64.AMD64NodeMatchRules;
  import org.graalvm.compiler.core.common.LIRKind;
<span class="udiff-line-added">+ import org.graalvm.compiler.core.common.spi.ForeignCallDescriptor;</span>
  import org.graalvm.compiler.core.common.spi.ForeignCallLinkage;
  import org.graalvm.compiler.core.gen.DebugInfoBuilder;
  import org.graalvm.compiler.hotspot.HotSpotDebugInfoBuilder;
  import org.graalvm.compiler.hotspot.HotSpotLIRGenerator;
  import org.graalvm.compiler.hotspot.HotSpotLockStack;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -52,10 +54,12 @@</span>
  import org.graalvm.compiler.nodes.ParameterNode;
  import org.graalvm.compiler.nodes.SafepointNode;
  import org.graalvm.compiler.nodes.StructuredGraph;
  import org.graalvm.compiler.nodes.ValueNode;
  import org.graalvm.compiler.nodes.spi.NodeValueMap;
<span class="udiff-line-added">+ import org.graalvm.compiler.replacements.nodes.ArrayCompareToNode;</span>
<span class="udiff-line-added">+ import org.graalvm.compiler.replacements.nodes.ArrayEqualsNode;</span>
  
  import jdk.vm.ci.amd64.AMD64;
  import jdk.vm.ci.amd64.AMD64Kind;
  import jdk.vm.ci.code.BytecodeFrame;
  import jdk.vm.ci.code.CallingConvention;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -64,12 +68,15 @@</span>
  import jdk.vm.ci.code.StackSlot;
  import jdk.vm.ci.code.ValueUtil;
  import jdk.vm.ci.hotspot.HotSpotCallingConventionType;
  import jdk.vm.ci.hotspot.HotSpotResolvedJavaMethod;
  import jdk.vm.ci.meta.AllocatableValue;
<span class="udiff-line-added">+ import jdk.vm.ci.meta.JavaKind;</span>
  import jdk.vm.ci.meta.JavaType;
<span class="udiff-line-added">+ import jdk.vm.ci.meta.ResolvedJavaMethod;</span>
  import jdk.vm.ci.meta.Value;
<span class="udiff-line-added">+ import org.graalvm.compiler.replacements.nodes.ArrayRegionEqualsNode;</span>
  
  /**
   * LIR generator specialized for AMD64 HotSpot.
   */
  public class AMD64HotSpotNodeLIRBuilder extends AMD64NodeLIRBuilder implements HotSpotNodeLIRBuilder {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -194,6 +201,100 @@</span>
          }
  
          Value[] parameters = visitInvokeArguments(gen.getRegisterConfig().getCallingConvention(HotSpotCallingConventionType.JavaCall, null, sig, gen), node.arguments());
          append(new AMD64BreakpointOp(parameters));
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private ForeignCallLinkage lookupForeignCall(ForeignCallDescriptor descriptor) {</span>
<span class="udiff-line-added">+         return getGen().getForeignCalls().lookupForeignCall(descriptor);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Override</span>
<span class="udiff-line-added">+     public ForeignCallLinkage lookupGraalStub(ValueNode valueNode) {</span>
<span class="udiff-line-added">+         ResolvedJavaMethod method = valueNode.graph().method();</span>
<span class="udiff-line-added">+         if (method == null || method.getAnnotation(Snippet.class) != null) {</span>
<span class="udiff-line-added">+             // Emit assembly for snippet stubs</span>
<span class="udiff-line-added">+             return null;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (valueNode instanceof ArrayEqualsNode) {</span>
<span class="udiff-line-added">+             ArrayEqualsNode arrayEqualsNode = (ArrayEqualsNode) valueNode;</span>
<span class="udiff-line-added">+             JavaKind kind = arrayEqualsNode.getKind();</span>
<span class="udiff-line-added">+             ValueNode length = arrayEqualsNode.getLength();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (length.isConstant()) {</span>
<span class="udiff-line-added">+                 int constantLength = length.asJavaConstant().asInt();</span>
<span class="udiff-line-added">+                 if (constantLength &gt;= 0 &amp;&amp; constantLength * kind.getByteCount() &lt; 2 * getGen().getMaxVectorSize()) {</span>
<span class="udiff-line-added">+                     // Yield constant-length arrays comparison assembly</span>
<span class="udiff-line-added">+                     return null;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             switch (kind) {</span>
<span class="udiff-line-added">+                 case Boolean:</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayEqualsStub.STUB_BOOLEAN_ARRAY_EQUALS);</span>
<span class="udiff-line-added">+                 case Byte:</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayEqualsStub.STUB_BYTE_ARRAY_EQUALS);</span>
<span class="udiff-line-added">+                 case Char:</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayEqualsStub.STUB_CHAR_ARRAY_EQUALS);</span>
<span class="udiff-line-added">+                 case Short:</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayEqualsStub.STUB_SHORT_ARRAY_EQUALS);</span>
<span class="udiff-line-added">+                 case Int:</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayEqualsStub.STUB_INT_ARRAY_EQUALS);</span>
<span class="udiff-line-added">+                 case Long:</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayEqualsStub.STUB_LONG_ARRAY_EQUALS);</span>
<span class="udiff-line-added">+                 case Float:</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayEqualsStub.STUB_FLOAT_ARRAY_EQUALS);</span>
<span class="udiff-line-added">+                 case Double:</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayEqualsStub.STUB_DOUBLE_ARRAY_EQUALS);</span>
<span class="udiff-line-added">+                 default:</span>
<span class="udiff-line-added">+                     return null;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } else if (valueNode instanceof ArrayCompareToNode) {</span>
<span class="udiff-line-added">+             ArrayCompareToNode arrayCompareToNode = (ArrayCompareToNode) valueNode;</span>
<span class="udiff-line-added">+             JavaKind kind1 = arrayCompareToNode.getKind1();</span>
<span class="udiff-line-added">+             JavaKind kind2 = arrayCompareToNode.getKind2();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (kind1 == JavaKind.Byte) {</span>
<span class="udiff-line-added">+                 if (kind2 == JavaKind.Byte) {</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayCompareToStub.STUB_BYTE_ARRAY_COMPARE_TO_BYTE_ARRAY);</span>
<span class="udiff-line-added">+                 } else if (kind2 == JavaKind.Char) {</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayCompareToStub.STUB_BYTE_ARRAY_COMPARE_TO_CHAR_ARRAY);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else if (kind1 == JavaKind.Char) {</span>
<span class="udiff-line-added">+                 if (kind2 == JavaKind.Byte) {</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayCompareToStub.STUB_CHAR_ARRAY_COMPARE_TO_BYTE_ARRAY);</span>
<span class="udiff-line-added">+                 } else if (kind2 == JavaKind.Char) {</span>
<span class="udiff-line-added">+                     return lookupForeignCall(AMD64ArrayCompareToStub.STUB_CHAR_ARRAY_COMPARE_TO_CHAR_ARRAY);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         } else if (valueNode instanceof ArrayRegionEqualsNode) {</span>
<span class="udiff-line-added">+             ArrayRegionEqualsNode arrayRegionEqualsNode = (ArrayRegionEqualsNode) valueNode;</span>
<span class="udiff-line-added">+             JavaKind kind1 = arrayRegionEqualsNode.getKind1();</span>
<span class="udiff-line-added">+             JavaKind kind2 = arrayRegionEqualsNode.getKind2();</span>
<span class="udiff-line-added">+             ValueNode length = arrayRegionEqualsNode.getLength();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (length.isConstant()) {</span>
<span class="udiff-line-added">+                 int constantLength = length.asJavaConstant().asInt();</span>
<span class="udiff-line-added">+                 if (constantLength &gt;= 0 &amp;&amp; constantLength * (Math.max(kind1.getByteCount(), kind2.getByteCount())) &lt; 2 * getGen().getMaxVectorSize()) {</span>
<span class="udiff-line-added">+                     // Yield constant-length arrays comparison assembly</span>
<span class="udiff-line-added">+                     return null;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (kind1 == kind2) {</span>
<span class="udiff-line-added">+                 switch (kind1) {</span>
<span class="udiff-line-added">+                     case Byte:</span>
<span class="udiff-line-added">+                         return lookupForeignCall(AMD64ArrayEqualsStub.STUB_BYTE_ARRAY_EQUALS_DIRECT);</span>
<span class="udiff-line-added">+                     case Char:</span>
<span class="udiff-line-added">+                         return lookupForeignCall(AMD64ArrayEqualsStub.STUB_CHAR_ARRAY_EQUALS_DIRECT);</span>
<span class="udiff-line-added">+                     default:</span>
<span class="udiff-line-added">+                         return null;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             } else if (kind1 == JavaKind.Char &amp;&amp; kind2 == JavaKind.Byte) {</span>
<span class="udiff-line-added">+                 return lookupForeignCall(AMD64ArrayEqualsStub.STUB_CHAR_ARRAY_EQUALS_BYTE_ARRAY);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return null;</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="AMD64HotSpotLoweringProvider.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="AMD64HotSpotRegisterAllocationConfig.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>