<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/JVMCIVersionCheckTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot.test;
 26 
 27 import java.util.HashMap;
 28 import java.util.Map;
 29 import java.util.Properties;
 30 import java.util.Random;
 31 
 32 import org.graalvm.compiler.core.test.GraalCompilerTest;
 33 import org.graalvm.compiler.hotspot.JVMCIVersionCheck;
 34 import org.graalvm.compiler.hotspot.JVMCIVersionCheck.Version;
 35 import org.graalvm.compiler.hotspot.JVMCIVersionCheck.Version2;
 36 import org.graalvm.compiler.hotspot.JVMCIVersionCheck.Version3;
 37 import org.junit.Assert;
 38 import org.junit.Test;
 39 
 40 public class JVMCIVersionCheckTest extends GraalCompilerTest {
 41 
 42     @Test
 43     public void test01() {
 44         Properties sprops = System.getProperties();
 45         Map&lt;String, String&gt; props = new HashMap&lt;&gt;(sprops.size());
 46         for (String name : sprops.stringPropertyNames()) {
 47             props.put(name, sprops.getProperty(name));
 48         }
 49 
 50         long seed = Long.getLong(&quot;test.seed&quot;, System.nanoTime());
 51         Random random = new Random(seed);
 52 
 53         for (int i = 0; i &lt; 50; i++) {
 54             int minMajor = i;
 55             int minMinor = 50 - i;
 56             for (int j = 0; j &lt; 50; j++) {
 57                 int major = j;
 58                 int minor = 50 - j;
 59 
 60                 for (int k = 0; k &lt; 30; k++) {
 61                     int minBuild = random.nextInt(100);
 62                     int build = random.nextInt(100);
 63 
 64                     for (Version version : new Version[]{new Version2(major, minor), new Version3(major, minor, build)}) {
 65                         for (Version minVersion : new Version[]{new Version2(minMajor, minMinor), new Version3(minMajor, minMinor, minBuild)}) {
 66                             String javaVmVersion = String.format(&quot;prefix-jvmci-%s-suffix&quot;, version);
 67                             if (!version.isLessThan(minVersion)) {
 68                                 try {
 69                                     JVMCIVersionCheck.check(props, minVersion, &quot;1.8&quot;, javaVmVersion, false);
 70                                 } catch (InternalError e) {
 71                                     throw new AssertionError(&quot;Failed &quot; + JVMCIVersionCheckTest.class.getSimpleName() + &quot; with -Dtest.seed=&quot; + seed, e);
 72                                 }
 73                             } else {
 74                                 try {
 75                                     JVMCIVersionCheck.check(props, minVersion, &quot;1.8&quot;, javaVmVersion, false);
 76                                     Assert.fail(&quot;expected to fail checking &quot; + javaVmVersion + &quot; against &quot; + minVersion + &quot; (-Dtest.seed=&quot; + seed + &quot;)&quot;);
 77                                 } catch (InternalError e) {
 78                                     // pass
 79                                 }
 80                             }
 81                         }
 82                     }
 83                 }
 84             }
 85         }
 86 
 87         // Test handling of version components bigger than Integer.MAX_VALUE
 88         for (String sep : new String[]{&quot;.&quot;, &quot;-b&quot;}) {
 89             for (String version : new String[]{&quot;0&quot; + sep + Long.MAX_VALUE, Long.MAX_VALUE + sep + 0}) {
 90                 String javaVmVersion = String.format(&quot;prefix-jvmci-%s-suffix&quot;, version);
 91                 try {
 92                     Version2 minVersion = new Version2(0, 59);
 93                     JVMCIVersionCheck.check(props, minVersion, &quot;1.8&quot;, javaVmVersion, false);
 94                     Assert.fail(&quot;expected to fail checking &quot; + javaVmVersion + &quot; against &quot; + minVersion);
 95                 } catch (InternalError e) {
 96                     // pass
 97                 }
 98             }
 99         }
100     }
101 }
    </pre>
  </body>
</html>