<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/CheckGraalIntrinsics.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CRC32CSubstitutionsTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CompilationWrapperTest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/CheckGraalIntrinsics.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 39,10 ***</span>
<span class="line-new-header">--- 39,11 ---</span>
  import jdk.internal.vm.compiler.collections.EconomicMap;
  import jdk.internal.vm.compiler.collections.MapCursor;
  import org.graalvm.compiler.api.test.Graal;
  import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
  import org.graalvm.compiler.hotspot.HotSpotGraalRuntimeProvider;
<span class="line-added">+ import org.graalvm.compiler.hotspot.meta.HotSpotGraphBuilderPlugins;</span>
  import org.graalvm.compiler.hotspot.meta.HotSpotProviders;
  import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Binding;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 58,10 ***</span>
<span class="line-new-header">--- 59,11 ---</span>
  import jdk.vm.ci.hotspot.VMIntrinsicMethod;
  import jdk.vm.ci.meta.MetaAccessProvider;
  import jdk.vm.ci.meta.MetaUtil;
  import jdk.vm.ci.meta.MethodHandleAccessProvider.IntrinsicMethod;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
<span class="line-added">+ import jdk.vm.ci.sparc.SPARC;</span>
  
  /**
   * Checks the intrinsics implemented by Graal against the set of intrinsics declared by HotSpot. The
   * purpose of this test is to detect when new intrinsics are added to HotSpot and process them
   * appropriately in Graal. This will be achieved by working through {@link #toBeInvestigated} and
</pre>
<hr />
<pre>
<span class="line-old-header">*** 154,15 ***</span>
      public final Set&lt;String&gt; toBeInvestigated = new TreeSet&lt;&gt;();
  
      private static Collection&lt;String&gt; add(Collection&lt;String&gt; c, String... elements) {
          String[] sorted = elements.clone();
          Arrays.sort(sorted);
<span class="line-modified">!         for (int i = 0; i &lt; elements.length; i++) {</span>
<span class="line-modified">!             if (!elements[i].equals(sorted[i])) {</span>
<span class="line-modified">!                 // Let&#39;s keep the list sorted for easier visual inspection</span>
<span class="line-modified">!                 fail(&quot;Element %d is out of order, \&quot;%s\&quot;&quot;, i, elements[i]);</span>
              }
          }
          c.addAll(Arrays.asList(elements));
          return c;
      }
  
<span class="line-new-header">--- 156,19 ---</span>
      public final Set&lt;String&gt; toBeInvestigated = new TreeSet&lt;&gt;();
  
      private static Collection&lt;String&gt; add(Collection&lt;String&gt; c, String... elements) {
          String[] sorted = elements.clone();
          Arrays.sort(sorted);
<span class="line-modified">!         if (!Arrays.equals(elements, sorted)) {</span>
<span class="line-modified">!             int width = 2 + Arrays.asList(elements).stream().map(String::length).reduce(0, Integer::max);</span>
<span class="line-modified">!             Formatter fmt = new Formatter();</span>
<span class="line-modified">!             fmt.format(&quot;%-&quot; + width + &quot;s | sorted%n&quot;, &quot;original&quot;);</span>
<span class="line-added">+             fmt.format(&quot;%s%n&quot;, new String(new char[width * 2 + 2]).replace(&#39;\0&#39;, &#39;=&#39;));</span>
<span class="line-added">+             for (int i = 0; i &lt; elements.length; i++) {</span>
<span class="line-added">+                 fmt.format(&quot;%-&quot; + width + &quot;s | %s%n&quot;, elements[i], sorted[i]);</span>
              }
<span class="line-added">+             fail(&quot;Elements not sorted alphabetically:%n%s&quot;, fmt);</span>
          }
          c.addAll(Arrays.asList(elements));
          return c;
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 270,14 ***</span>
                              &quot;jdk/jfr/internal/JVM.counterTime()J&quot;,
                              &quot;jdk/jfr/internal/JVM.getBufferWriter()Ljava/lang/Object;&quot;,
                              &quot;jdk/jfr/internal/JVM.getClassId(Ljava/lang/Class;)J&quot;);
  
              add(toBeInvestigated,
<span class="line-removed">-                             // HotSpot MacroAssembler-based intrinsic</span>
<span class="line-removed">-                             &quot;java/lang/Math.fma(DDD)D&quot;,</span>
<span class="line-removed">-                             // HotSpot MacroAssembler-based intrinsic</span>
<span class="line-removed">-                             &quot;java/lang/Math.fma(FFF)F&quot;,</span>
                              // Just check if the argument is a compile time constant
                              &quot;java/lang/invoke/MethodHandleImpl.isCompileConstant(Ljava/lang/Object;)Z&quot;,
                              // Only used as a marker for vectorization?
                              &quot;java/util/stream/Streams$RangeIntSpliterator.forEachRemaining(Ljava/util/function/IntConsumer;)V&quot;,
                              // Only implemented on non-AMD64 platforms (some logic and runtime call)
<span class="line-new-header">--- 276,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 365,42 ***</span>
              }
              if (!config.useGHASHIntrinsics()) {
                  add(ignore,
                                  &quot;com/sun/crypto/provider/GHASH.processBlocks([BII[J[J)V&quot;);
              }
<span class="line-modified">!             if (!(config.useSHA1Intrinsics() || config.useSHA256Intrinsics() || config.useSHA512Intrinsics())) {</span>
                  add(ignore,
<span class="line-modified">!                                 &quot;sun/security/provider/DigestBase.implCompressMultiBlock0([BII)I&quot;);</span>
              }
          }
  
          if (isJDK10OrHigher()) {
              add(toBeInvestigated,
                              &quot;java/lang/Math.multiplyHigh(JJ)J&quot;);
          }
  
          if (isJDK11OrHigher()) {
              // Relevant for Java flight recorder
<span class="line-removed">-             add(toBeInvestigated,</span>
<span class="line-removed">-                             &quot;java/util/Base64$Encoder.encodeBlock([BII[BIZ)V&quot;,</span>
<span class="line-removed">-                             &quot;jdk/jfr/internal/JVM.getEventWriter()Ljava/lang/Object;&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (isJDK12OrHigher()) {</span>
              add(toBeInvestigated,
                              &quot;java/lang/CharacterDataLatin1.isDigit(I)Z&quot;,
                              &quot;java/lang/CharacterDataLatin1.isLowerCase(I)Z&quot;,
                              &quot;java/lang/CharacterDataLatin1.isUpperCase(I)Z&quot;,
<span class="line-modified">!                             &quot;java/lang/CharacterDataLatin1.isWhitespace(I)Z&quot;);</span>
          }
  
          if (isJDK13OrHigher()) {
              add(toBeInvestigated,
                              &quot;java/lang/Math.max(DD)D&quot;,
                              &quot;java/lang/Math.max(FF)F&quot;,
                              &quot;java/lang/Math.min(DD)D&quot;,
                              &quot;java/lang/Math.min(FF)F&quot;);
          }
  
          if (!config.inlineNotify()) {
              add(ignore, &quot;java/lang/Object.notify()V&quot;);
          }
<span class="line-new-header">--- 367,60 ---</span>
              }
              if (!config.useGHASHIntrinsics()) {
                  add(ignore,
                                  &quot;com/sun/crypto/provider/GHASH.processBlocks([BII[J[J)V&quot;);
              }
<span class="line-modified">!             if (!config.useFMAIntrinsics) {</span>
                  add(ignore,
<span class="line-modified">!                                 &quot;java/lang/Math.fma(DDD)D&quot;,</span>
<span class="line-added">+                                 &quot;java/lang/Math.fma(FFF)F&quot;);</span>
<span class="line-added">+             } else if (arch instanceof SPARC) {</span>
<span class="line-added">+                 add(toBeInvestigated,</span>
<span class="line-added">+                                 &quot;java/lang/Math.fma(DDD)D&quot;,</span>
<span class="line-added">+                                 &quot;java/lang/Math.fma(FFF)F&quot;);</span>
              }
          }
  
          if (isJDK10OrHigher()) {
              add(toBeInvestigated,
                              &quot;java/lang/Math.multiplyHigh(JJ)J&quot;);
          }
  
          if (isJDK11OrHigher()) {
              // Relevant for Java flight recorder
              add(toBeInvestigated,
                              &quot;java/lang/CharacterDataLatin1.isDigit(I)Z&quot;,
                              &quot;java/lang/CharacterDataLatin1.isLowerCase(I)Z&quot;,
                              &quot;java/lang/CharacterDataLatin1.isUpperCase(I)Z&quot;,
<span class="line-modified">!                             &quot;java/lang/CharacterDataLatin1.isWhitespace(I)Z&quot;,</span>
<span class="line-added">+                             &quot;jdk/jfr/internal/JVM.getEventWriter()Ljava/lang/Object;&quot;);</span>
<span class="line-added">+             if (!config.useBase64Intrinsics()) {</span>
<span class="line-added">+                 add(ignore,</span>
<span class="line-added">+                                 &quot;java/util/Base64$Encoder.encodeBlock([BII[BIZ)V&quot;);</span>
<span class="line-added">+             }</span>
          }
  
          if (isJDK13OrHigher()) {
              add(toBeInvestigated,
<span class="line-added">+                             &quot;java/lang/Math.abs(I)I&quot;,</span>
<span class="line-added">+                             &quot;java/lang/Math.abs(J)J&quot;,</span>
                              &quot;java/lang/Math.max(DD)D&quot;,
                              &quot;java/lang/Math.max(FF)F&quot;,
                              &quot;java/lang/Math.min(DD)D&quot;,
                              &quot;java/lang/Math.min(FF)F&quot;);
<span class="line-added">+             add(toBeInvestigated,</span>
<span class="line-added">+                             &quot;jdk/internal/misc/Unsafe.writeback0(J)V&quot;,</span>
<span class="line-added">+                             &quot;jdk/internal/misc/Unsafe.writebackPostSync0()V&quot;,</span>
<span class="line-added">+                             &quot;jdk/internal/misc/Unsafe.writebackPreSync0()V&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (isJDK14OrHigher()) {</span>
<span class="line-added">+             add(toBeInvestigated,</span>
<span class="line-added">+                             &quot;com/sun/crypto/provider/ElectronicCodeBook.implECBDecrypt([BII[BI)I&quot;,</span>
<span class="line-added">+                             &quot;com/sun/crypto/provider/ElectronicCodeBook.implECBEncrypt([BII[BI)I&quot;,</span>
<span class="line-added">+                             &quot;java/math/BigInteger.shiftLeftImplWorker([I[IIII)V&quot;,</span>
<span class="line-added">+                             &quot;java/math/BigInteger.shiftRightImplWorker([I[IIII)V&quot;);</span>
          }
  
          if (!config.inlineNotify()) {
              add(ignore, &quot;java/lang/Object.notify()V&quot;);
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 493,25 ***</span>
              add(ignore,
                              &quot;java/util/zip/CRC32C.updateBytes(I[BII)I&quot;,
                              &quot;java/util/zip/CRC32C.updateDirectByteBuffer(IJII)I&quot;);
          }
  
          // AES intrinsics
          if (!config.useAESIntrinsics) {
<span class="line-modified">!             if (isJDK9OrHigher()) {</span>
<span class="line-modified">!                 add(ignore,</span>
<span class="line-modified">!                                 &quot;com/sun/crypto/provider/AESCrypt.implDecryptBlock([BI[BI)V&quot;,</span>
<span class="line-modified">!                                 &quot;com/sun/crypto/provider/AESCrypt.implEncryptBlock([BI[BI)V&quot;,</span>
<span class="line-modified">!                                 &quot;com/sun/crypto/provider/CipherBlockChaining.implDecrypt([BII[BI)I&quot;,</span>
<span class="line-removed">-                                 &quot;com/sun/crypto/provider/CipherBlockChaining.implEncrypt([BII[BI)I&quot;);</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 add(ignore,</span>
<span class="line-removed">-                                 &quot;com/sun/crypto/provider/AESCrypt.decryptBlock([BI[BI)V&quot;,</span>
<span class="line-removed">-                                 &quot;com/sun/crypto/provider/AESCrypt.encryptBlock([BI[BI)V&quot;,</span>
<span class="line-removed">-                                 &quot;com/sun/crypto/provider/CipherBlockChaining.decrypt([BII[BI)I&quot;,</span>
<span class="line-removed">-                                 &quot;com/sun/crypto/provider/CipherBlockChaining.encrypt([BII[BI)I&quot;);</span>
<span class="line-removed">-             }</span>
          }
  
          // BigInteger intrinsics
          if (!config.useMultiplyToLenIntrinsic()) {
              if (isJDK9OrHigher()) {
<span class="line-new-header">--- 513,22 ---</span>
              add(ignore,
                              &quot;java/util/zip/CRC32C.updateBytes(I[BII)I&quot;,
                              &quot;java/util/zip/CRC32C.updateDirectByteBuffer(IJII)I&quot;);
          }
  
<span class="line-added">+         String cbcEncryptName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;com/sun/crypto/provider/CipherBlockChaining&quot;, &quot;implEncrypt&quot;, &quot;encrypt&quot;);</span>
<span class="line-added">+         String cbcDecryptName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;com/sun/crypto/provider/CipherBlockChaining&quot;, &quot;implDecrypt&quot;, &quot;decrypt&quot;);</span>
<span class="line-added">+         String aesEncryptName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;com/sun/crypto/provider/AESCrypt&quot;, &quot;implEncryptBlock&quot;, &quot;encryptBlock&quot;);</span>
<span class="line-added">+         String aesDecryptName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;com/sun/crypto/provider/AESCrypt&quot;, &quot;implDecryptBlock&quot;, &quot;decryptBlock&quot;);</span>
<span class="line-added">+ </span>
          // AES intrinsics
          if (!config.useAESIntrinsics) {
<span class="line-modified">!             add(ignore,</span>
<span class="line-modified">!                             &quot;com/sun/crypto/provider/AESCrypt.&quot; + aesDecryptName + &quot;([BI[BI)V&quot;,</span>
<span class="line-modified">!                             &quot;com/sun/crypto/provider/AESCrypt.&quot; + aesEncryptName + &quot;([BI[BI)V&quot;,</span>
<span class="line-modified">!                             &quot;com/sun/crypto/provider/CipherBlockChaining.&quot; + cbcDecryptName + &quot;([BII[BI)I&quot;,</span>
<span class="line-modified">!                             &quot;com/sun/crypto/provider/CipherBlockChaining.&quot; + cbcEncryptName + &quot;([BII[BI)I&quot;);</span>
          }
  
          // BigInteger intrinsics
          if (!config.useMultiplyToLenIntrinsic()) {
              if (isJDK9OrHigher()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 530,53 ***</span>
              add(ignore, &quot;java/math/BigInteger.implMontgomerySquare([I[IIJ[I)[I&quot;);
          }
          if (!config.useSquareToLenIntrinsic()) {
              add(ignore, &quot;java/math/BigInteger.implSquareToLen([II[II)[I&quot;);
          }
<span class="line-modified">! </span>
          // SHA intrinsics
          if (!config.useSHA1Intrinsics()) {
<span class="line-modified">!             if (isJDK9OrHigher()) {</span>
<span class="line-removed">-                 add(ignore, &quot;sun/security/provider/SHA.implCompress0([BI)V&quot;);</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 add(ignore, &quot;sun/security/provider/SHA.implCompress([BI)V&quot;);</span>
<span class="line-removed">-             }</span>
          }
          if (!config.useSHA256Intrinsics()) {
<span class="line-modified">!             if (isJDK9OrHigher()) {</span>
<span class="line-removed">-                 add(ignore, &quot;sun/security/provider/SHA2.implCompress0([BI)V&quot;);</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 add(ignore, &quot;sun/security/provider/SHA2.implCompress([BI)V&quot;);</span>
<span class="line-removed">-             }</span>
          }
          if (!config.useSHA512Intrinsics()) {
<span class="line-modified">!             if (isJDK9OrHigher()) {</span>
<span class="line-removed">-                 add(ignore, &quot;sun/security/provider/SHA5.implCompress0([BI)V&quot;);</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 add(ignore, &quot;sun/security/provider/SHA5.implCompress([BI)V&quot;);</span>
<span class="line-removed">-             }</span>
          }
      }
  
      private static boolean isJDK9OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 9;</span>
      }
  
      private static boolean isJDK10OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 10;</span>
      }
  
      private static boolean isJDK11OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 11;</span>
      }
  
      private static boolean isJDK12OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 12;</span>
      }
  
      private static boolean isJDK13OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 13;</span>
      }
  
      public interface Refiner {
          void refine(CheckGraalIntrinsics checker);
      }
<span class="line-new-header">--- 547,50 ---</span>
              add(ignore, &quot;java/math/BigInteger.implMontgomerySquare([I[IIJ[I)[I&quot;);
          }
          if (!config.useSquareToLenIntrinsic()) {
              add(ignore, &quot;java/math/BigInteger.implSquareToLen([II[II)[I&quot;);
          }
<span class="line-modified">!         // DigestBase intrinsics</span>
<span class="line-added">+         if (HotSpotGraphBuilderPlugins.isIntrinsicName(config, &quot;sun/security/provider/DigestBase&quot;, &quot;implCompressMultiBlock0&quot;) &amp;&amp;</span>
<span class="line-added">+                         !(config.useSHA1Intrinsics() || config.useSHA256Intrinsics() || config.useSHA512Intrinsics())) {</span>
<span class="line-added">+             add(ignore, &quot;sun/security/provider/DigestBase.implCompressMultiBlock0([BII)I&quot;);</span>
<span class="line-added">+         }</span>
          // SHA intrinsics
<span class="line-added">+         String shaCompressName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;sun/security/provider/SHA&quot;, &quot;implCompress0&quot;, &quot;implCompress&quot;);</span>
          if (!config.useSHA1Intrinsics()) {
<span class="line-modified">!             add(ignore, &quot;sun/security/provider/SHA.&quot; + shaCompressName + &quot;([BI)V&quot;);</span>
          }
          if (!config.useSHA256Intrinsics()) {
<span class="line-modified">!             add(ignore, &quot;sun/security/provider/SHA2.&quot; + shaCompressName + &quot;([BI)V&quot;);</span>
          }
          if (!config.useSHA512Intrinsics()) {
<span class="line-modified">!             add(ignore, &quot;sun/security/provider/SHA5.&quot; + shaCompressName + &quot;([BI)V&quot;);</span>
          }
      }
  
      private static boolean isJDK9OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPEC &gt;= 9;</span>
      }
  
      private static boolean isJDK10OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPEC &gt;= 10;</span>
      }
  
      private static boolean isJDK11OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPEC &gt;= 11;</span>
      }
  
      private static boolean isJDK12OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPEC &gt;= 12;</span>
      }
  
      private static boolean isJDK13OrHigher() {
<span class="line-modified">!         return JavaVersionUtil.JAVA_SPEC &gt;= 13;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static boolean isJDK14OrHigher() {</span>
<span class="line-added">+         return JavaVersionUtil.JAVA_SPEC &gt;= 14;</span>
      }
  
      public interface Refiner {
          void refine(CheckGraalIntrinsics checker);
      }
</pre>
<center><a href="CRC32CSubstitutionsTest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CompilationWrapperTest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>