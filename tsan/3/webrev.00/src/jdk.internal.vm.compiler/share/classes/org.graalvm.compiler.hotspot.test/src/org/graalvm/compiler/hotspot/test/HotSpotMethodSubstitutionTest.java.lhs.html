<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/HotSpotMethodSubstitutionTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2012, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot.test;
 26 
 27 import java.lang.invoke.ConstantCallSite;
 28 import java.lang.invoke.MethodHandles;
 29 import java.lang.invoke.MethodType;
 30 
<a name="2" id="anc2"></a><span class="line-removed"> 31 import org.junit.Test;</span>
<span class="line-removed"> 32 </span>
 33 import org.graalvm.compiler.api.directives.GraalDirectives;
 34 import org.graalvm.compiler.api.replacements.MethodSubstitution;
<a name="3" id="anc3"></a>


 35 import org.graalvm.compiler.replacements.test.MethodSubstitutionTest;
<a name="4" id="anc4"></a>
 36 
 37 /**
 38  * Tests HotSpot specific {@link MethodSubstitution}s.
 39  */
 40 public class HotSpotMethodSubstitutionTest extends MethodSubstitutionTest {
 41 
 42     @Test
 43     public void testObjectSubstitutions() {
 44         TestClassA obj = new TestClassA();
 45 
 46         testGraph(&quot;getClass0&quot;);
 47         testGraph(&quot;objectHashCode&quot;);
 48 
 49         test(&quot;getClass0&quot;, &quot;a string&quot;);
 50         test(&quot;objectHashCode&quot;, obj);
 51 
 52         testGraph(&quot;objectNotify&quot;, &quot;Object.notify&quot;);
 53         testGraph(&quot;objectNotifyAll&quot;, &quot;Object.notifyAll&quot;);
 54 
 55         synchronized (obj) {
 56             test(&quot;objectNotify&quot;, obj);
 57             test(&quot;objectNotifyAll&quot;, obj);
 58         }
 59         // Test with IllegalMonitorStateException (no synchronized block)
 60         test(&quot;objectNotify&quot;, obj);
 61         test(&quot;objectNotifyAll&quot;, obj);
 62     }
 63 
 64     @SuppressWarnings(&quot;all&quot;)
 65     public static Class&lt;?&gt; getClass0(Object obj) {
 66         return obj.getClass();
 67     }
 68 
 69     @SuppressWarnings(&quot;all&quot;)
 70     public static int objectHashCode(TestClassA obj) {
 71         return obj.hashCode();
 72     }
 73 
 74     @SuppressWarnings(&quot;all&quot;)
 75     public static void objectNotify(Object obj) {
 76         obj.notify();
 77     }
 78 
 79     @SuppressWarnings(&quot;all&quot;)
 80     public static void objectNotifyAll(Object obj) {
 81         obj.notifyAll();
 82     }
 83 
 84     @Test
 85     public void testClassSubstitutions() {
 86         testGraph(&quot;getModifiers&quot;);
 87         testGraph(&quot;isInterface&quot;);
 88         testGraph(&quot;isArray&quot;);
 89         testGraph(&quot;isPrimitive&quot;);
 90         testGraph(&quot;getSuperClass&quot;);
 91         testGraph(&quot;getComponentType&quot;);
 92 
 93         for (Class&lt;?&gt; c : new Class&lt;?&gt;[]{getClass(), Cloneable.class, int[].class, String[][].class}) {
 94             test(&quot;getModifiers&quot;, c);
 95             test(&quot;isInterface&quot;, c);
 96             test(&quot;isArray&quot;, c);
 97             test(&quot;isPrimitive&quot;, c);
 98             test(&quot;getSuperClass&quot;, c);
 99             test(&quot;getComponentType&quot;, c);
100         }
101     }
102 
103     @SuppressWarnings(&quot;all&quot;)
104     public static int getModifiers(Class&lt;?&gt; clazz) {
105         return clazz.getModifiers();
106     }
107 
108     @SuppressWarnings(&quot;all&quot;)
109     public static boolean isInterface(Class&lt;?&gt; clazz) {
110         return clazz.isInterface();
111     }
112 
113     @SuppressWarnings(&quot;all&quot;)
114     public static boolean isArray(Class&lt;?&gt; clazz) {
115         return clazz.isArray();
116     }
117 
118     @SuppressWarnings(&quot;all&quot;)
119     public static boolean isPrimitive(Class&lt;?&gt; clazz) {
120         return clazz.isPrimitive();
121     }
122 
123     @SuppressWarnings(&quot;all&quot;)
124     public static Class&lt;?&gt; getSuperClass(Class&lt;?&gt; clazz) {
125         return clazz.getSuperclass();
126     }
127 
128     @SuppressWarnings(&quot;all&quot;)
129     public static Class&lt;?&gt; getComponentType(Class&lt;?&gt; clazz) {
130         return clazz.getComponentType();
131     }
132 
133     @Test
134     public void testThreadSubstitutions() {
<a name="5" id="anc5"></a>
135         testGraph(&quot;currentThread&quot;);
<a name="6" id="anc6"></a><span class="line-modified">136         testGraph(&quot;threadIsInterrupted&quot;);</span>
<span class="line-modified">137         testGraph(&quot;threadInterrupted&quot;);</span>


138 
139         Thread currentThread = Thread.currentThread();
140         test(&quot;currentThread&quot;, currentThread);
<a name="7" id="anc7"></a><span class="line-modified">141         test(&quot;threadIsInterrupted&quot;, currentThread);</span>


142     }
143 
144     @SuppressWarnings(&quot;all&quot;)
145     public static boolean currentThread(Thread other) {
146         return Thread.currentThread() == other;
147     }
148 
149     @SuppressWarnings(&quot;all&quot;)
150     public static boolean threadIsInterrupted(Thread thread) {
151         return thread.isInterrupted();
152     }
153 
154     @SuppressWarnings(&quot;all&quot;)
155     public static boolean threadInterrupted() {
156         return Thread.interrupted();
157     }
158 
159     @Test
160     public void testSystemSubstitutions() {
161         testGraph(&quot;systemTime&quot;);
162         testGraph(&quot;systemIdentityHashCode&quot;);
163 
164         for (Object o : new Object[]{this, new int[5], new String[2][], new Object()}) {
165             test(&quot;systemIdentityHashCode&quot;, o);
166         }
167     }
168 
169     @SuppressWarnings(&quot;all&quot;)
170     public static long systemTime() {
171         return System.currentTimeMillis() + System.nanoTime();
172     }
173 
174     @SuppressWarnings(&quot;all&quot;)
175     public static int systemIdentityHashCode(Object obj) {
176         return System.identityHashCode(obj);
177     }
178 
179     private static class TestClassA {
180     }
181 
182     public static String testCallSiteGetTargetSnippet(int i) throws Exception {
183         ConstantCallSite site;
184         MethodHandles.Lookup lookup = MethodHandles.lookup();
185         switch (i) {
186             case 1:
187                 site = GraalDirectives.opaque(new ConstantCallSite(lookup.findVirtual(String.class, &quot;replace&quot;, MethodType.methodType(String.class, char.class, char.class))));
188                 break;
189             default:
190                 site = GraalDirectives.opaque(new ConstantCallSite(lookup.findStatic(java.util.Arrays.class, &quot;asList&quot;, MethodType.methodType(java.util.List.class, Object[].class))));
191         }
192         return site.getTarget().toString();
193     }
194 
195     public static String testCastSnippet(int i, Object obj) throws Exception {
196         Class&lt;?&gt; c;
197         switch (i) {
198             case 1:
199                 c = GraalDirectives.opaque(Number.class);
200                 break;
201             default:
202                 c = GraalDirectives.opaque(Integer.class);
203                 break;
204         }
205         return c.cast(obj).toString();
206     }
207 
208     public static String testGetClassSnippet(int i) {
209         Object c;
210         switch (i) {
211             case 1:
212                 c = GraalDirectives.opaque(new Object());
213                 break;
214             default:
215                 c = GraalDirectives.opaque(&quot;TEST&quot;);
216                 break;
217         }
218         return c.getClass().toString();
219     }
220 
221     /**
222      * Tests ambiguous receiver of CallSite.getTarget.
223      */
224     @Test
225     public void testCallSiteGetTarget() {
226         test(&quot;testCallSiteGetTargetSnippet&quot;, 1);
227     }
228 
229     /**
230      * Tests ambiguous receiver of Class.cast.
231      */
232     @Test
233     public void testCast() {
234         test(&quot;testCastSnippet&quot;, 1, Integer.valueOf(1));
235     }
236 
237     /**
238      * Tests ambiguous receiver of Object.getClass.
239      */
240     @Test
241     public void testGetClass() {
242         test(&quot;testGetClassSnippet&quot;, 1);
243     }
244 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>