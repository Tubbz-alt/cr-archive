<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/ReservedStackAccessTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ReplaceConstantNodesPhaseTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="TestIntrinsicCompiles.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/ReservedStackAccessTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot.test;
 26 
 27 import java.io.IOException;
<span class="line-removed"> 28 import java.util.concurrent.locks.ReentrantLock;</span>
 29 import java.util.List;

 30 
 31 import org.graalvm.compiler.test.SubprocessUtil;
 32 import org.graalvm.compiler.test.SubprocessUtil.Subprocess;
<span class="line-removed"> 33 </span>
 34 import org.junit.Assume;
 35 import org.junit.Before;
 36 import org.junit.Test;
 37 
 38 public class ReservedStackAccessTest extends HotSpotGraalCompilerTest {
 39     @Before
 40     public void check() {
 41         Assume.assumeTrue(runtime().getVMConfig().enableStackReservedZoneAddress != 0);
 42     }
 43 
 44     public void stackAccessTest() {
 45         Assume.assumeTrue(runtime().getVMConfig().enableStackReservedZoneAddress != 0);
 46 
 47         int passed = 0;
 48         for (int i = 0; i &lt; 1000; i++) {
 49             // Each iteration has to be executed by a new thread. The test
 50             // relies on the random size area pushed by the VM at the beginning
 51             // of the stack of each Java thread it creates.
 52             RunWithSOEContext r = new RunWithSOEContext(new ReentrantLockTest(), 256);
 53             Thread thread = new Thread(r);
 54             thread.start();
 55             try {
 56                 thread.join();
 57                 assertTrue(r.result.equals(&quot;PASSED&quot;), r.result);
 58                 ++passed;
 59             } catch (InterruptedException ex) {
 60             }
 61         }
 62         System.out.println(&quot;RESULT: &quot; + (passed == 1000 ? &quot;PASSED&quot; : &quot;FAILED&quot;));
 63     }
 64 
 65     public static void main(String[] args) {
 66         new ReservedStackAccessTest().stackAccessTest();
 67     }
 68 
 69     @Test
 70     public void run() throws IOException, InterruptedException {

 71         Assume.assumeTrue(runtime().getVMConfig().enableStackReservedZoneAddress != 0);
 72         List&lt;String&gt; vmArgs = SubprocessUtil.withoutDebuggerArguments(SubprocessUtil.getVMCommandLine());
 73         vmArgs.add(&quot;-XX:+UseJVMCICompiler&quot;);
 74         vmArgs.add(&quot;-Dgraal.Inline=false&quot;);
 75         vmArgs.add(&quot;-XX:CompileCommand=exclude,java/util/concurrent/locks/AbstractOwnableSynchronizer.setExclusiveOwnerThread&quot;);

 76 
 77         // Avoid SOE in HotSpotJVMCIRuntime.adjustCompilationLevel
 78         vmArgs.add(&quot;-Dgraal.CompileGraalWithC1Only=false&quot;);
 79 
 80         Subprocess proc = SubprocessUtil.java(vmArgs, ReservedStackAccessTest.class.getName());
 81         boolean passed = false;
 82         for (String line : proc.output) {
 83             if (line.equals(&quot;RESULT: PASSED&quot;)) {
 84                 passed = true;
 85             }
 86         }
 87         if (!passed) {
 88             System.err.println(proc);
 89         }
 90         assertTrue(passed);
 91     }
 92 
 93     static class ReentrantLockTest {
 94 
 95         private ReentrantLock[] lockArray;
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.hotspot.test;
 26 
 27 import java.io.IOException;

 28 import java.util.List;
<span class="line-added"> 29 import java.util.concurrent.locks.ReentrantLock;</span>
 30 
 31 import org.graalvm.compiler.test.SubprocessUtil;
 32 import org.graalvm.compiler.test.SubprocessUtil.Subprocess;

 33 import org.junit.Assume;
 34 import org.junit.Before;
 35 import org.junit.Test;
 36 
 37 public class ReservedStackAccessTest extends HotSpotGraalCompilerTest {
 38     @Before
 39     public void check() {
 40         Assume.assumeTrue(runtime().getVMConfig().enableStackReservedZoneAddress != 0);
 41     }
 42 
 43     public void stackAccessTest() {
 44         Assume.assumeTrue(runtime().getVMConfig().enableStackReservedZoneAddress != 0);
 45 
 46         int passed = 0;
 47         for (int i = 0; i &lt; 1000; i++) {
 48             // Each iteration has to be executed by a new thread. The test
 49             // relies on the random size area pushed by the VM at the beginning
 50             // of the stack of each Java thread it creates.
 51             RunWithSOEContext r = new RunWithSOEContext(new ReentrantLockTest(), 256);
 52             Thread thread = new Thread(r);
 53             thread.start();
 54             try {
 55                 thread.join();
 56                 assertTrue(r.result.equals(&quot;PASSED&quot;), r.result);
 57                 ++passed;
 58             } catch (InterruptedException ex) {
 59             }
 60         }
 61         System.out.println(&quot;RESULT: &quot; + (passed == 1000 ? &quot;PASSED&quot; : &quot;FAILED&quot;));
 62     }
 63 
 64     public static void main(String[] args) {
 65         new ReservedStackAccessTest().stackAccessTest();
 66     }
 67 
 68     @Test
 69     public void run() throws IOException, InterruptedException {
<span class="line-added"> 70         Assume.assumeFalse(&quot;GR-19833&quot;, runtime().getVMConfig().osName.equals(&quot;windows&quot;));</span>
 71         Assume.assumeTrue(runtime().getVMConfig().enableStackReservedZoneAddress != 0);
 72         List&lt;String&gt; vmArgs = SubprocessUtil.withoutDebuggerArguments(SubprocessUtil.getVMCommandLine());
 73         vmArgs.add(&quot;-XX:+UseJVMCICompiler&quot;);
 74         vmArgs.add(&quot;-Dgraal.Inline=false&quot;);
 75         vmArgs.add(&quot;-XX:CompileCommand=exclude,java/util/concurrent/locks/AbstractOwnableSynchronizer.setExclusiveOwnerThread&quot;);
<span class="line-added"> 76         vmArgs.add(SubprocessUtil.PACKAGE_OPENING_OPTIONS);</span>
 77 
 78         // Avoid SOE in HotSpotJVMCIRuntime.adjustCompilationLevel
 79         vmArgs.add(&quot;-Dgraal.CompileGraalWithC1Only=false&quot;);
 80 
 81         Subprocess proc = SubprocessUtil.java(vmArgs, ReservedStackAccessTest.class.getName());
 82         boolean passed = false;
 83         for (String line : proc.output) {
 84             if (line.equals(&quot;RESULT: PASSED&quot;)) {
 85                 passed = true;
 86             }
 87         }
 88         if (!passed) {
 89             System.err.println(proc);
 90         }
 91         assertTrue(passed);
 92     }
 93 
 94     static class ReentrantLockTest {
 95 
 96         private ReentrantLock[] lockArray;
</pre>
</td>
</tr>
</table>
<center><a href="ReplaceConstantNodesPhaseTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="TestIntrinsicCompiles.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>