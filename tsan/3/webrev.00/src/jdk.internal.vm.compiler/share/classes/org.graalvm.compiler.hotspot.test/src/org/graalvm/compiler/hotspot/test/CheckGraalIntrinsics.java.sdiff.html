<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/CheckGraalIntrinsics.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CRC32CSubstitutionsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CompilationWrapperTest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.hotspot.test/src/org/graalvm/compiler/hotspot/test/CheckGraalIntrinsics.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 24 
 25 package org.graalvm.compiler.hotspot.test;
 26 
 27 import java.lang.reflect.Method;
 28 import java.util.ArrayList;
 29 import java.util.Arrays;
 30 import java.util.Collection;
 31 import java.util.Collections;
 32 import java.util.Formatter;
 33 import java.util.List;
 34 import java.util.ServiceLoader;
 35 import java.util.Set;
 36 import java.util.TreeSet;
 37 import java.util.stream.Collectors;
 38 
 39 import jdk.internal.vm.compiler.collections.EconomicMap;
 40 import jdk.internal.vm.compiler.collections.MapCursor;
 41 import org.graalvm.compiler.api.test.Graal;
 42 import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
 43 import org.graalvm.compiler.hotspot.HotSpotGraalRuntimeProvider;

 44 import org.graalvm.compiler.hotspot.meta.HotSpotProviders;
 45 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
 46 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
 47 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 48 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Binding;
 49 import org.graalvm.compiler.runtime.RuntimeProvider;
 50 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;
 51 import org.graalvm.compiler.test.GraalTest;
 52 import org.junit.Test;
 53 
 54 import jdk.vm.ci.aarch64.AArch64;
 55 import jdk.vm.ci.amd64.AMD64;
 56 import jdk.vm.ci.code.Architecture;
 57 import jdk.vm.ci.hotspot.HotSpotVMConfigStore;
 58 import jdk.vm.ci.hotspot.VMIntrinsicMethod;
 59 import jdk.vm.ci.meta.MetaAccessProvider;
 60 import jdk.vm.ci.meta.MetaUtil;
 61 import jdk.vm.ci.meta.MethodHandleAccessProvider.IntrinsicMethod;
 62 import jdk.vm.ci.meta.ResolvedJavaMethod;

 63 
 64 /**
 65  * Checks the intrinsics implemented by Graal against the set of intrinsics declared by HotSpot. The
 66  * purpose of this test is to detect when new intrinsics are added to HotSpot and process them
 67  * appropriately in Graal. This will be achieved by working through {@link #toBeInvestigated} and
 68  * either implementing the intrinsic or moving it to {@link #ignore} .
 69  */
 70 public class CheckGraalIntrinsics extends GraalTest {
 71 
 72     public static boolean match(String type, Binding binding, VMIntrinsicMethod intrinsic) {
 73         if (intrinsic.name.equals(binding.name)) {
 74             if (intrinsic.descriptor.startsWith(binding.argumentsDescriptor)) {
 75                 if (type.equals(intrinsic.declaringClass)) {
 76                     return true;
 77                 }
 78             }
 79         }
 80         return false;
 81     }
 82 
</pre>
<hr />
<pre>
139      * The HotSpot intrinsics whose {@link InvocationPlugin} registration is guarded by a condition
140      * too complex to duplicate here.
141      * &lt;/ul&gt;
142      */
143     public final Set&lt;String&gt; complexGuard = new TreeSet&lt;&gt;();
144 
145     /**
146      * The HotSpot intrinsics implemented downstream.
147      * &lt;/ul&gt;
148      */
149     public final Set&lt;String&gt; downstream = new TreeSet&lt;&gt;();
150 
151     /**
152      * The HotSpot intrinsics yet to be implemented or moved to {@link #ignore}.
153      */
154     public final Set&lt;String&gt; toBeInvestigated = new TreeSet&lt;&gt;();
155 
156     private static Collection&lt;String&gt; add(Collection&lt;String&gt; c, String... elements) {
157         String[] sorted = elements.clone();
158         Arrays.sort(sorted);
<span class="line-modified">159         for (int i = 0; i &lt; elements.length; i++) {</span>
<span class="line-modified">160             if (!elements[i].equals(sorted[i])) {</span>
<span class="line-modified">161                 // Let&#39;s keep the list sorted for easier visual inspection</span>
<span class="line-modified">162                 fail(&quot;Element %d is out of order, \&quot;%s\&quot;&quot;, i, elements[i]);</span>



163             }

164         }
165         c.addAll(Arrays.asList(elements));
166         return c;
167     }
168 
169     public final HotSpotGraalRuntimeProvider rt = (HotSpotGraalRuntimeProvider) Graal.getRequiredCapability(RuntimeProvider.class);
170     public final Architecture arch = rt.getHostBackend().getTarget().arch;
171     public final GraalHotSpotVMConfig config = rt.getVMConfig();
172 
173     public CheckGraalIntrinsics() {
174         // These are dead
175         add(ignore,
176                         &quot;java/lang/Math.atan2(DD)D&quot;,
177                         &quot;jdk/internal/misc/Unsafe.park(ZJ)V&quot;,
178                         &quot;jdk/internal/misc/Unsafe.unpark(Ljava/lang/Object;)V&quot;,
179                         &quot;sun/misc/Unsafe.park(ZJ)V&quot;,
180                         &quot;sun/misc/Unsafe.prefetchRead(Ljava/lang/Object;J)V&quot;,
181                         &quot;sun/misc/Unsafe.prefetchReadStatic(Ljava/lang/Object;J)V&quot;,
182                         &quot;sun/misc/Unsafe.prefetchWrite(Ljava/lang/Object;J)V&quot;,
183                         &quot;sun/misc/Unsafe.prefetchWriteStatic(Ljava/lang/Object;J)V&quot;,
</pre>
<hr />
<pre>
255                         // Can share most implementation parts with with
256                         // Unsafe.allocateUninitializedArray0
257                         &quot;java/lang/reflect/Array.newArray(Ljava/lang/Class;I)Ljava/lang/Object;&quot;,
258                         // HotSpot MacroAssembler-based intrinsic
259                         &quot;sun/nio/cs/ISO_8859_1$Encoder.encodeISOArray([CI[BII)I&quot;,
260                         // We have implemented implCompressMultiBlock0 on JDK9+. Does it worth
261                         // backporting as corresponding HotSpot stubs are only generated on SPARC?
262                         &quot;sun/security/provider/DigestBase.implCompressMultiBlock([BII)I&quot;);
263 
264         // See JDK-8207146.
265         String oopName = isJDK12OrHigher() ? &quot;Reference&quot; : &quot;Object&quot;;
266 
267         if (isJDK9OrHigher()) {
268             // Relevant for Java flight recorder
269             add(toBeInvestigated,
270                             &quot;jdk/jfr/internal/JVM.counterTime()J&quot;,
271                             &quot;jdk/jfr/internal/JVM.getBufferWriter()Ljava/lang/Object;&quot;,
272                             &quot;jdk/jfr/internal/JVM.getClassId(Ljava/lang/Class;)J&quot;);
273 
274             add(toBeInvestigated,
<span class="line-removed">275                             // HotSpot MacroAssembler-based intrinsic</span>
<span class="line-removed">276                             &quot;java/lang/Math.fma(DDD)D&quot;,</span>
<span class="line-removed">277                             // HotSpot MacroAssembler-based intrinsic</span>
<span class="line-removed">278                             &quot;java/lang/Math.fma(FFF)F&quot;,</span>
279                             // Just check if the argument is a compile time constant
280                             &quot;java/lang/invoke/MethodHandleImpl.isCompileConstant(Ljava/lang/Object;)Z&quot;,
281                             // Only used as a marker for vectorization?
282                             &quot;java/util/stream/Streams$RangeIntSpliterator.forEachRemaining(Ljava/util/function/IntConsumer;)V&quot;,
283                             // Only implemented on non-AMD64 platforms (some logic and runtime call)
284                             &quot;java/util/zip/Adler32.updateByteBuffer(IJII)I&quot;,
285                             // Only implemented on non-AMD64 platforms (some logic and runtime call)
286                             &quot;java/util/zip/Adler32.updateBytes(I[BII)I&quot;,
287                             // Emits a slow and a fast path and some dispatching logic
288                             &quot;jdk/internal/misc/Unsafe.allocateUninitializedArray0(Ljava/lang/Class;I)Ljava/lang/Object;&quot;,
289 
290                             // Control flow, deopts, and a cast
291                             &quot;jdk/internal/util/Preconditions.checkIndex(IILjava/util/function/BiFunction;)I&quot;,
292                             // HotSpot MacroAssembler-based intrinsic
293                             &quot;sun/nio/cs/ISO_8859_1$Encoder.implEncodeISOArray([CI[BII)I&quot;);
294 
295             /*
296              * Per default, all these operations are mapped to some generic method for which we
297              * already have compiler intrinsics. Performance-wise it would be better to support them
298              * explicitly as the more generic method might be more restrictive and therefore slower
</pre>
<hr />
<pre>
350 
351                             // handled by an intrinsic for StringUTF16.indexOfUnsafe
352                             &quot;java/lang/StringUTF16.indexOf([BI[BII)I&quot;,
353                             &quot;java/lang/StringUTF16.indexOf([B[B)I&quot;,
354 
355                             // handled by an intrinsic for StringUTF16.indexOfCharUnsafe
356                             &quot;java/lang/StringUTF16.indexOfChar([BIII)I&quot;,
357 
358                             // handled by an intrinsic for StringUTF16.indexOfLatin1Unsafe
359                             &quot;java/lang/StringUTF16.indexOfLatin1([BI[BII)I&quot;,
360                             &quot;java/lang/StringUTF16.indexOfLatin1([B[B)I&quot;);
361 
362             if (!config.useAESCTRIntrinsics) {
363                 add(ignore,
364                                 &quot;com/sun/crypto/provider/CounterMode.implCrypt([BII[BI)I&quot;);
365             }
366             if (!config.useGHASHIntrinsics()) {
367                 add(ignore,
368                                 &quot;com/sun/crypto/provider/GHASH.processBlocks([BII[J[J)V&quot;);
369             }
<span class="line-modified">370             if (!(config.useSHA1Intrinsics() || config.useSHA256Intrinsics() || config.useSHA512Intrinsics())) {</span>
371                 add(ignore,
<span class="line-modified">372                                 &quot;sun/security/provider/DigestBase.implCompressMultiBlock0([BII)I&quot;);</span>





373             }
374         }
375 
376         if (isJDK10OrHigher()) {
377             add(toBeInvestigated,
378                             &quot;java/lang/Math.multiplyHigh(JJ)J&quot;);
379         }
380 
381         if (isJDK11OrHigher()) {
382             // Relevant for Java flight recorder
<span class="line-removed">383             add(toBeInvestigated,</span>
<span class="line-removed">384                             &quot;java/util/Base64$Encoder.encodeBlock([BII[BIZ)V&quot;,</span>
<span class="line-removed">385                             &quot;jdk/jfr/internal/JVM.getEventWriter()Ljava/lang/Object;&quot;);</span>
<span class="line-removed">386         }</span>
<span class="line-removed">387 </span>
<span class="line-removed">388         if (isJDK12OrHigher()) {</span>
389             add(toBeInvestigated,
390                             &quot;java/lang/CharacterDataLatin1.isDigit(I)Z&quot;,
391                             &quot;java/lang/CharacterDataLatin1.isLowerCase(I)Z&quot;,
392                             &quot;java/lang/CharacterDataLatin1.isUpperCase(I)Z&quot;,
<span class="line-modified">393                             &quot;java/lang/CharacterDataLatin1.isWhitespace(I)Z&quot;);</span>





394         }
395 
396         if (isJDK13OrHigher()) {
397             add(toBeInvestigated,


398                             &quot;java/lang/Math.max(DD)D&quot;,
399                             &quot;java/lang/Math.max(FF)F&quot;,
400                             &quot;java/lang/Math.min(DD)D&quot;,
401                             &quot;java/lang/Math.min(FF)F&quot;);












402         }
403 
404         if (!config.inlineNotify()) {
405             add(ignore, &quot;java/lang/Object.notify()V&quot;);
406         }
407         if (!config.inlineNotifyAll()) {
408             add(ignore, &quot;java/lang/Object.notifyAll()V&quot;);
409         }
410 
411         if (!(arch instanceof AMD64)) {
412             // Can we implement these on non-AMD64 platforms? C2 seems to.
413             add(toBeInvestigated,
414                             &quot;java/lang/String.compareTo(Ljava/lang/String;)I&quot;,
415                             &quot;java/lang/StringLatin1.indexOf([B[B)I&quot;,
416                             &quot;java/lang/StringLatin1.inflate([BI[BII)V&quot;,
417                             &quot;java/lang/StringLatin1.inflate([BI[CII)V&quot;,
418                             &quot;java/lang/StringUTF16.compress([BI[BII)I&quot;,
419                             &quot;java/lang/StringUTF16.compress([CI[BII)I&quot;,
420                             &quot;java/lang/StringUTF16.indexOf([BI[BII)I&quot;,
421                             &quot;java/lang/StringUTF16.indexOf([B[B)I&quot;,
</pre>
<hr />
<pre>
478         if (!config.useCRC32Intrinsics) {
479             add(ignore, &quot;java/util/zip/CRC32.update(II)I&quot;);
480             if (isJDK9OrHigher()) {
481                 add(ignore,
482                                 &quot;java/util/zip/CRC32.updateByteBuffer0(IJII)I&quot;,
483                                 &quot;java/util/zip/CRC32.updateBytes0(I[BII)I&quot;);
484             } else {
485                 add(ignore,
486                                 &quot;java/util/zip/CRC32.updateByteBuffer(IJII)I&quot;,
487                                 &quot;java/util/zip/CRC32.updateBytes(I[BII)I&quot;);
488             }
489         }
490 
491         // CRC32C intrinsics
492         if (!config.useCRC32CIntrinsics) {
493             add(ignore,
494                             &quot;java/util/zip/CRC32C.updateBytes(I[BII)I&quot;,
495                             &quot;java/util/zip/CRC32C.updateDirectByteBuffer(IJII)I&quot;);
496         }
497 





498         // AES intrinsics
499         if (!config.useAESIntrinsics) {
<span class="line-modified">500             if (isJDK9OrHigher()) {</span>
<span class="line-modified">501                 add(ignore,</span>
<span class="line-modified">502                                 &quot;com/sun/crypto/provider/AESCrypt.implDecryptBlock([BI[BI)V&quot;,</span>
<span class="line-modified">503                                 &quot;com/sun/crypto/provider/AESCrypt.implEncryptBlock([BI[BI)V&quot;,</span>
<span class="line-modified">504                                 &quot;com/sun/crypto/provider/CipherBlockChaining.implDecrypt([BII[BI)I&quot;,</span>
<span class="line-removed">505                                 &quot;com/sun/crypto/provider/CipherBlockChaining.implEncrypt([BII[BI)I&quot;);</span>
<span class="line-removed">506             } else {</span>
<span class="line-removed">507                 add(ignore,</span>
<span class="line-removed">508                                 &quot;com/sun/crypto/provider/AESCrypt.decryptBlock([BI[BI)V&quot;,</span>
<span class="line-removed">509                                 &quot;com/sun/crypto/provider/AESCrypt.encryptBlock([BI[BI)V&quot;,</span>
<span class="line-removed">510                                 &quot;com/sun/crypto/provider/CipherBlockChaining.decrypt([BII[BI)I&quot;,</span>
<span class="line-removed">511                                 &quot;com/sun/crypto/provider/CipherBlockChaining.encrypt([BII[BI)I&quot;);</span>
<span class="line-removed">512             }</span>
513         }
514 
515         // BigInteger intrinsics
516         if (!config.useMultiplyToLenIntrinsic()) {
517             if (isJDK9OrHigher()) {
518                 add(ignore, &quot;java/math/BigInteger.implMultiplyToLen([II[II[I)[I&quot;);
519             } else {
520                 add(ignore, &quot;java/math/BigInteger.multiplyToLen([II[II[I)[I&quot;);
521             }
522         }
523         if (!config.useMulAddIntrinsic()) {
524             add(ignore, &quot;java/math/BigInteger.implMulAdd([I[IIII)I&quot;);
525         }
526         if (!config.useMontgomeryMultiplyIntrinsic()) {
527             add(ignore, &quot;java/math/BigInteger.implMontgomeryMultiply([I[I[IIJ[I)[I&quot;);
528         }
529         if (!config.useMontgomerySquareIntrinsic()) {
530             add(ignore, &quot;java/math/BigInteger.implMontgomerySquare([I[IIJ[I)[I&quot;);
531         }
532         if (!config.useSquareToLenIntrinsic()) {
533             add(ignore, &quot;java/math/BigInteger.implSquareToLen([II[II)[I&quot;);
534         }
<span class="line-modified">535 </span>




536         // SHA intrinsics

537         if (!config.useSHA1Intrinsics()) {
<span class="line-modified">538             if (isJDK9OrHigher()) {</span>
<span class="line-removed">539                 add(ignore, &quot;sun/security/provider/SHA.implCompress0([BI)V&quot;);</span>
<span class="line-removed">540             } else {</span>
<span class="line-removed">541                 add(ignore, &quot;sun/security/provider/SHA.implCompress([BI)V&quot;);</span>
<span class="line-removed">542             }</span>
543         }
544         if (!config.useSHA256Intrinsics()) {
<span class="line-modified">545             if (isJDK9OrHigher()) {</span>
<span class="line-removed">546                 add(ignore, &quot;sun/security/provider/SHA2.implCompress0([BI)V&quot;);</span>
<span class="line-removed">547             } else {</span>
<span class="line-removed">548                 add(ignore, &quot;sun/security/provider/SHA2.implCompress([BI)V&quot;);</span>
<span class="line-removed">549             }</span>
550         }
551         if (!config.useSHA512Intrinsics()) {
<span class="line-modified">552             if (isJDK9OrHigher()) {</span>
<span class="line-removed">553                 add(ignore, &quot;sun/security/provider/SHA5.implCompress0([BI)V&quot;);</span>
<span class="line-removed">554             } else {</span>
<span class="line-removed">555                 add(ignore, &quot;sun/security/provider/SHA5.implCompress([BI)V&quot;);</span>
<span class="line-removed">556             }</span>
557         }
558     }
559 
560     private static boolean isJDK9OrHigher() {
<span class="line-modified">561         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 9;</span>
562     }
563 
564     private static boolean isJDK10OrHigher() {
<span class="line-modified">565         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 10;</span>
566     }
567 
568     private static boolean isJDK11OrHigher() {
<span class="line-modified">569         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 11;</span>
570     }
571 
572     private static boolean isJDK12OrHigher() {
<span class="line-modified">573         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 12;</span>
574     }
575 
576     private static boolean isJDK13OrHigher() {
<span class="line-modified">577         return JavaVersionUtil.JAVA_SPECIFICATION_VERSION &gt;= 13;</span>




578     }
579 
580     public interface Refiner {
581         void refine(CheckGraalIntrinsics checker);
582     }
583 
584     @Test
585     @SuppressWarnings(&quot;try&quot;)
586     public void test() throws ClassNotFoundException {
587         HotSpotProviders providers = rt.getHostBackend().getProviders();
588         Plugins graphBuilderPlugins = providers.getGraphBuilderPlugins();
589         InvocationPlugins invocationPlugins = graphBuilderPlugins.getInvocationPlugins();
590 
591         HotSpotVMConfigStore store = config.getStore();
592         List&lt;VMIntrinsicMethod&gt; intrinsics = store.getIntrinsics();
593 
594         for (Refiner refiner : ServiceLoader.load(Refiner.class)) {
595             refiner.refine(this);
596         }
597 
</pre>
</td>
<td>
<hr />
<pre>
 24 
 25 package org.graalvm.compiler.hotspot.test;
 26 
 27 import java.lang.reflect.Method;
 28 import java.util.ArrayList;
 29 import java.util.Arrays;
 30 import java.util.Collection;
 31 import java.util.Collections;
 32 import java.util.Formatter;
 33 import java.util.List;
 34 import java.util.ServiceLoader;
 35 import java.util.Set;
 36 import java.util.TreeSet;
 37 import java.util.stream.Collectors;
 38 
 39 import jdk.internal.vm.compiler.collections.EconomicMap;
 40 import jdk.internal.vm.compiler.collections.MapCursor;
 41 import org.graalvm.compiler.api.test.Graal;
 42 import org.graalvm.compiler.hotspot.GraalHotSpotVMConfig;
 43 import org.graalvm.compiler.hotspot.HotSpotGraalRuntimeProvider;
<span class="line-added"> 44 import org.graalvm.compiler.hotspot.meta.HotSpotGraphBuilderPlugins;</span>
 45 import org.graalvm.compiler.hotspot.meta.HotSpotProviders;
 46 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
 47 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
 48 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 49 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Binding;
 50 import org.graalvm.compiler.runtime.RuntimeProvider;
 51 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;
 52 import org.graalvm.compiler.test.GraalTest;
 53 import org.junit.Test;
 54 
 55 import jdk.vm.ci.aarch64.AArch64;
 56 import jdk.vm.ci.amd64.AMD64;
 57 import jdk.vm.ci.code.Architecture;
 58 import jdk.vm.ci.hotspot.HotSpotVMConfigStore;
 59 import jdk.vm.ci.hotspot.VMIntrinsicMethod;
 60 import jdk.vm.ci.meta.MetaAccessProvider;
 61 import jdk.vm.ci.meta.MetaUtil;
 62 import jdk.vm.ci.meta.MethodHandleAccessProvider.IntrinsicMethod;
 63 import jdk.vm.ci.meta.ResolvedJavaMethod;
<span class="line-added"> 64 import jdk.vm.ci.sparc.SPARC;</span>
 65 
 66 /**
 67  * Checks the intrinsics implemented by Graal against the set of intrinsics declared by HotSpot. The
 68  * purpose of this test is to detect when new intrinsics are added to HotSpot and process them
 69  * appropriately in Graal. This will be achieved by working through {@link #toBeInvestigated} and
 70  * either implementing the intrinsic or moving it to {@link #ignore} .
 71  */
 72 public class CheckGraalIntrinsics extends GraalTest {
 73 
 74     public static boolean match(String type, Binding binding, VMIntrinsicMethod intrinsic) {
 75         if (intrinsic.name.equals(binding.name)) {
 76             if (intrinsic.descriptor.startsWith(binding.argumentsDescriptor)) {
 77                 if (type.equals(intrinsic.declaringClass)) {
 78                     return true;
 79                 }
 80             }
 81         }
 82         return false;
 83     }
 84 
</pre>
<hr />
<pre>
141      * The HotSpot intrinsics whose {@link InvocationPlugin} registration is guarded by a condition
142      * too complex to duplicate here.
143      * &lt;/ul&gt;
144      */
145     public final Set&lt;String&gt; complexGuard = new TreeSet&lt;&gt;();
146 
147     /**
148      * The HotSpot intrinsics implemented downstream.
149      * &lt;/ul&gt;
150      */
151     public final Set&lt;String&gt; downstream = new TreeSet&lt;&gt;();
152 
153     /**
154      * The HotSpot intrinsics yet to be implemented or moved to {@link #ignore}.
155      */
156     public final Set&lt;String&gt; toBeInvestigated = new TreeSet&lt;&gt;();
157 
158     private static Collection&lt;String&gt; add(Collection&lt;String&gt; c, String... elements) {
159         String[] sorted = elements.clone();
160         Arrays.sort(sorted);
<span class="line-modified">161         if (!Arrays.equals(elements, sorted)) {</span>
<span class="line-modified">162             int width = 2 + Arrays.asList(elements).stream().map(String::length).reduce(0, Integer::max);</span>
<span class="line-modified">163             Formatter fmt = new Formatter();</span>
<span class="line-modified">164             fmt.format(&quot;%-&quot; + width + &quot;s | sorted%n&quot;, &quot;original&quot;);</span>
<span class="line-added">165             fmt.format(&quot;%s%n&quot;, new String(new char[width * 2 + 2]).replace(&#39;\0&#39;, &#39;=&#39;));</span>
<span class="line-added">166             for (int i = 0; i &lt; elements.length; i++) {</span>
<span class="line-added">167                 fmt.format(&quot;%-&quot; + width + &quot;s | %s%n&quot;, elements[i], sorted[i]);</span>
168             }
<span class="line-added">169             fail(&quot;Elements not sorted alphabetically:%n%s&quot;, fmt);</span>
170         }
171         c.addAll(Arrays.asList(elements));
172         return c;
173     }
174 
175     public final HotSpotGraalRuntimeProvider rt = (HotSpotGraalRuntimeProvider) Graal.getRequiredCapability(RuntimeProvider.class);
176     public final Architecture arch = rt.getHostBackend().getTarget().arch;
177     public final GraalHotSpotVMConfig config = rt.getVMConfig();
178 
179     public CheckGraalIntrinsics() {
180         // These are dead
181         add(ignore,
182                         &quot;java/lang/Math.atan2(DD)D&quot;,
183                         &quot;jdk/internal/misc/Unsafe.park(ZJ)V&quot;,
184                         &quot;jdk/internal/misc/Unsafe.unpark(Ljava/lang/Object;)V&quot;,
185                         &quot;sun/misc/Unsafe.park(ZJ)V&quot;,
186                         &quot;sun/misc/Unsafe.prefetchRead(Ljava/lang/Object;J)V&quot;,
187                         &quot;sun/misc/Unsafe.prefetchReadStatic(Ljava/lang/Object;J)V&quot;,
188                         &quot;sun/misc/Unsafe.prefetchWrite(Ljava/lang/Object;J)V&quot;,
189                         &quot;sun/misc/Unsafe.prefetchWriteStatic(Ljava/lang/Object;J)V&quot;,
</pre>
<hr />
<pre>
261                         // Can share most implementation parts with with
262                         // Unsafe.allocateUninitializedArray0
263                         &quot;java/lang/reflect/Array.newArray(Ljava/lang/Class;I)Ljava/lang/Object;&quot;,
264                         // HotSpot MacroAssembler-based intrinsic
265                         &quot;sun/nio/cs/ISO_8859_1$Encoder.encodeISOArray([CI[BII)I&quot;,
266                         // We have implemented implCompressMultiBlock0 on JDK9+. Does it worth
267                         // backporting as corresponding HotSpot stubs are only generated on SPARC?
268                         &quot;sun/security/provider/DigestBase.implCompressMultiBlock([BII)I&quot;);
269 
270         // See JDK-8207146.
271         String oopName = isJDK12OrHigher() ? &quot;Reference&quot; : &quot;Object&quot;;
272 
273         if (isJDK9OrHigher()) {
274             // Relevant for Java flight recorder
275             add(toBeInvestigated,
276                             &quot;jdk/jfr/internal/JVM.counterTime()J&quot;,
277                             &quot;jdk/jfr/internal/JVM.getBufferWriter()Ljava/lang/Object;&quot;,
278                             &quot;jdk/jfr/internal/JVM.getClassId(Ljava/lang/Class;)J&quot;);
279 
280             add(toBeInvestigated,




281                             // Just check if the argument is a compile time constant
282                             &quot;java/lang/invoke/MethodHandleImpl.isCompileConstant(Ljava/lang/Object;)Z&quot;,
283                             // Only used as a marker for vectorization?
284                             &quot;java/util/stream/Streams$RangeIntSpliterator.forEachRemaining(Ljava/util/function/IntConsumer;)V&quot;,
285                             // Only implemented on non-AMD64 platforms (some logic and runtime call)
286                             &quot;java/util/zip/Adler32.updateByteBuffer(IJII)I&quot;,
287                             // Only implemented on non-AMD64 platforms (some logic and runtime call)
288                             &quot;java/util/zip/Adler32.updateBytes(I[BII)I&quot;,
289                             // Emits a slow and a fast path and some dispatching logic
290                             &quot;jdk/internal/misc/Unsafe.allocateUninitializedArray0(Ljava/lang/Class;I)Ljava/lang/Object;&quot;,
291 
292                             // Control flow, deopts, and a cast
293                             &quot;jdk/internal/util/Preconditions.checkIndex(IILjava/util/function/BiFunction;)I&quot;,
294                             // HotSpot MacroAssembler-based intrinsic
295                             &quot;sun/nio/cs/ISO_8859_1$Encoder.implEncodeISOArray([CI[BII)I&quot;);
296 
297             /*
298              * Per default, all these operations are mapped to some generic method for which we
299              * already have compiler intrinsics. Performance-wise it would be better to support them
300              * explicitly as the more generic method might be more restrictive and therefore slower
</pre>
<hr />
<pre>
352 
353                             // handled by an intrinsic for StringUTF16.indexOfUnsafe
354                             &quot;java/lang/StringUTF16.indexOf([BI[BII)I&quot;,
355                             &quot;java/lang/StringUTF16.indexOf([B[B)I&quot;,
356 
357                             // handled by an intrinsic for StringUTF16.indexOfCharUnsafe
358                             &quot;java/lang/StringUTF16.indexOfChar([BIII)I&quot;,
359 
360                             // handled by an intrinsic for StringUTF16.indexOfLatin1Unsafe
361                             &quot;java/lang/StringUTF16.indexOfLatin1([BI[BII)I&quot;,
362                             &quot;java/lang/StringUTF16.indexOfLatin1([B[B)I&quot;);
363 
364             if (!config.useAESCTRIntrinsics) {
365                 add(ignore,
366                                 &quot;com/sun/crypto/provider/CounterMode.implCrypt([BII[BI)I&quot;);
367             }
368             if (!config.useGHASHIntrinsics()) {
369                 add(ignore,
370                                 &quot;com/sun/crypto/provider/GHASH.processBlocks([BII[J[J)V&quot;);
371             }
<span class="line-modified">372             if (!config.useFMAIntrinsics) {</span>
373                 add(ignore,
<span class="line-modified">374                                 &quot;java/lang/Math.fma(DDD)D&quot;,</span>
<span class="line-added">375                                 &quot;java/lang/Math.fma(FFF)F&quot;);</span>
<span class="line-added">376             } else if (arch instanceof SPARC) {</span>
<span class="line-added">377                 add(toBeInvestigated,</span>
<span class="line-added">378                                 &quot;java/lang/Math.fma(DDD)D&quot;,</span>
<span class="line-added">379                                 &quot;java/lang/Math.fma(FFF)F&quot;);</span>
380             }
381         }
382 
383         if (isJDK10OrHigher()) {
384             add(toBeInvestigated,
385                             &quot;java/lang/Math.multiplyHigh(JJ)J&quot;);
386         }
387 
388         if (isJDK11OrHigher()) {
389             // Relevant for Java flight recorder






390             add(toBeInvestigated,
391                             &quot;java/lang/CharacterDataLatin1.isDigit(I)Z&quot;,
392                             &quot;java/lang/CharacterDataLatin1.isLowerCase(I)Z&quot;,
393                             &quot;java/lang/CharacterDataLatin1.isUpperCase(I)Z&quot;,
<span class="line-modified">394                             &quot;java/lang/CharacterDataLatin1.isWhitespace(I)Z&quot;,</span>
<span class="line-added">395                             &quot;jdk/jfr/internal/JVM.getEventWriter()Ljava/lang/Object;&quot;);</span>
<span class="line-added">396             if (!config.useBase64Intrinsics()) {</span>
<span class="line-added">397                 add(ignore,</span>
<span class="line-added">398                                 &quot;java/util/Base64$Encoder.encodeBlock([BII[BIZ)V&quot;);</span>
<span class="line-added">399             }</span>
400         }
401 
402         if (isJDK13OrHigher()) {
403             add(toBeInvestigated,
<span class="line-added">404                             &quot;java/lang/Math.abs(I)I&quot;,</span>
<span class="line-added">405                             &quot;java/lang/Math.abs(J)J&quot;,</span>
406                             &quot;java/lang/Math.max(DD)D&quot;,
407                             &quot;java/lang/Math.max(FF)F&quot;,
408                             &quot;java/lang/Math.min(DD)D&quot;,
409                             &quot;java/lang/Math.min(FF)F&quot;);
<span class="line-added">410             add(toBeInvestigated,</span>
<span class="line-added">411                             &quot;jdk/internal/misc/Unsafe.writeback0(J)V&quot;,</span>
<span class="line-added">412                             &quot;jdk/internal/misc/Unsafe.writebackPostSync0()V&quot;,</span>
<span class="line-added">413                             &quot;jdk/internal/misc/Unsafe.writebackPreSync0()V&quot;);</span>
<span class="line-added">414         }</span>
<span class="line-added">415 </span>
<span class="line-added">416         if (isJDK14OrHigher()) {</span>
<span class="line-added">417             add(toBeInvestigated,</span>
<span class="line-added">418                             &quot;com/sun/crypto/provider/ElectronicCodeBook.implECBDecrypt([BII[BI)I&quot;,</span>
<span class="line-added">419                             &quot;com/sun/crypto/provider/ElectronicCodeBook.implECBEncrypt([BII[BI)I&quot;,</span>
<span class="line-added">420                             &quot;java/math/BigInteger.shiftLeftImplWorker([I[IIII)V&quot;,</span>
<span class="line-added">421                             &quot;java/math/BigInteger.shiftRightImplWorker([I[IIII)V&quot;);</span>
422         }
423 
424         if (!config.inlineNotify()) {
425             add(ignore, &quot;java/lang/Object.notify()V&quot;);
426         }
427         if (!config.inlineNotifyAll()) {
428             add(ignore, &quot;java/lang/Object.notifyAll()V&quot;);
429         }
430 
431         if (!(arch instanceof AMD64)) {
432             // Can we implement these on non-AMD64 platforms? C2 seems to.
433             add(toBeInvestigated,
434                             &quot;java/lang/String.compareTo(Ljava/lang/String;)I&quot;,
435                             &quot;java/lang/StringLatin1.indexOf([B[B)I&quot;,
436                             &quot;java/lang/StringLatin1.inflate([BI[BII)V&quot;,
437                             &quot;java/lang/StringLatin1.inflate([BI[CII)V&quot;,
438                             &quot;java/lang/StringUTF16.compress([BI[BII)I&quot;,
439                             &quot;java/lang/StringUTF16.compress([CI[BII)I&quot;,
440                             &quot;java/lang/StringUTF16.indexOf([BI[BII)I&quot;,
441                             &quot;java/lang/StringUTF16.indexOf([B[B)I&quot;,
</pre>
<hr />
<pre>
498         if (!config.useCRC32Intrinsics) {
499             add(ignore, &quot;java/util/zip/CRC32.update(II)I&quot;);
500             if (isJDK9OrHigher()) {
501                 add(ignore,
502                                 &quot;java/util/zip/CRC32.updateByteBuffer0(IJII)I&quot;,
503                                 &quot;java/util/zip/CRC32.updateBytes0(I[BII)I&quot;);
504             } else {
505                 add(ignore,
506                                 &quot;java/util/zip/CRC32.updateByteBuffer(IJII)I&quot;,
507                                 &quot;java/util/zip/CRC32.updateBytes(I[BII)I&quot;);
508             }
509         }
510 
511         // CRC32C intrinsics
512         if (!config.useCRC32CIntrinsics) {
513             add(ignore,
514                             &quot;java/util/zip/CRC32C.updateBytes(I[BII)I&quot;,
515                             &quot;java/util/zip/CRC32C.updateDirectByteBuffer(IJII)I&quot;);
516         }
517 
<span class="line-added">518         String cbcEncryptName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;com/sun/crypto/provider/CipherBlockChaining&quot;, &quot;implEncrypt&quot;, &quot;encrypt&quot;);</span>
<span class="line-added">519         String cbcDecryptName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;com/sun/crypto/provider/CipherBlockChaining&quot;, &quot;implDecrypt&quot;, &quot;decrypt&quot;);</span>
<span class="line-added">520         String aesEncryptName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;com/sun/crypto/provider/AESCrypt&quot;, &quot;implEncryptBlock&quot;, &quot;encryptBlock&quot;);</span>
<span class="line-added">521         String aesDecryptName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;com/sun/crypto/provider/AESCrypt&quot;, &quot;implDecryptBlock&quot;, &quot;decryptBlock&quot;);</span>
<span class="line-added">522 </span>
523         // AES intrinsics
524         if (!config.useAESIntrinsics) {
<span class="line-modified">525             add(ignore,</span>
<span class="line-modified">526                             &quot;com/sun/crypto/provider/AESCrypt.&quot; + aesDecryptName + &quot;([BI[BI)V&quot;,</span>
<span class="line-modified">527                             &quot;com/sun/crypto/provider/AESCrypt.&quot; + aesEncryptName + &quot;([BI[BI)V&quot;,</span>
<span class="line-modified">528                             &quot;com/sun/crypto/provider/CipherBlockChaining.&quot; + cbcDecryptName + &quot;([BII[BI)I&quot;,</span>
<span class="line-modified">529                             &quot;com/sun/crypto/provider/CipherBlockChaining.&quot; + cbcEncryptName + &quot;([BII[BI)I&quot;);</span>








530         }
531 
532         // BigInteger intrinsics
533         if (!config.useMultiplyToLenIntrinsic()) {
534             if (isJDK9OrHigher()) {
535                 add(ignore, &quot;java/math/BigInteger.implMultiplyToLen([II[II[I)[I&quot;);
536             } else {
537                 add(ignore, &quot;java/math/BigInteger.multiplyToLen([II[II[I)[I&quot;);
538             }
539         }
540         if (!config.useMulAddIntrinsic()) {
541             add(ignore, &quot;java/math/BigInteger.implMulAdd([I[IIII)I&quot;);
542         }
543         if (!config.useMontgomeryMultiplyIntrinsic()) {
544             add(ignore, &quot;java/math/BigInteger.implMontgomeryMultiply([I[I[IIJ[I)[I&quot;);
545         }
546         if (!config.useMontgomerySquareIntrinsic()) {
547             add(ignore, &quot;java/math/BigInteger.implMontgomerySquare([I[IIJ[I)[I&quot;);
548         }
549         if (!config.useSquareToLenIntrinsic()) {
550             add(ignore, &quot;java/math/BigInteger.implSquareToLen([II[II)[I&quot;);
551         }
<span class="line-modified">552         // DigestBase intrinsics</span>
<span class="line-added">553         if (HotSpotGraphBuilderPlugins.isIntrinsicName(config, &quot;sun/security/provider/DigestBase&quot;, &quot;implCompressMultiBlock0&quot;) &amp;&amp;</span>
<span class="line-added">554                         !(config.useSHA1Intrinsics() || config.useSHA256Intrinsics() || config.useSHA512Intrinsics())) {</span>
<span class="line-added">555             add(ignore, &quot;sun/security/provider/DigestBase.implCompressMultiBlock0([BII)I&quot;);</span>
<span class="line-added">556         }</span>
557         // SHA intrinsics
<span class="line-added">558         String shaCompressName = HotSpotGraphBuilderPlugins.lookupIntrinsicName(config, &quot;sun/security/provider/SHA&quot;, &quot;implCompress0&quot;, &quot;implCompress&quot;);</span>
559         if (!config.useSHA1Intrinsics()) {
<span class="line-modified">560             add(ignore, &quot;sun/security/provider/SHA.&quot; + shaCompressName + &quot;([BI)V&quot;);</span>




561         }
562         if (!config.useSHA256Intrinsics()) {
<span class="line-modified">563             add(ignore, &quot;sun/security/provider/SHA2.&quot; + shaCompressName + &quot;([BI)V&quot;);</span>




564         }
565         if (!config.useSHA512Intrinsics()) {
<span class="line-modified">566             add(ignore, &quot;sun/security/provider/SHA5.&quot; + shaCompressName + &quot;([BI)V&quot;);</span>




567         }
568     }
569 
570     private static boolean isJDK9OrHigher() {
<span class="line-modified">571         return JavaVersionUtil.JAVA_SPEC &gt;= 9;</span>
572     }
573 
574     private static boolean isJDK10OrHigher() {
<span class="line-modified">575         return JavaVersionUtil.JAVA_SPEC &gt;= 10;</span>
576     }
577 
578     private static boolean isJDK11OrHigher() {
<span class="line-modified">579         return JavaVersionUtil.JAVA_SPEC &gt;= 11;</span>
580     }
581 
582     private static boolean isJDK12OrHigher() {
<span class="line-modified">583         return JavaVersionUtil.JAVA_SPEC &gt;= 12;</span>
584     }
585 
586     private static boolean isJDK13OrHigher() {
<span class="line-modified">587         return JavaVersionUtil.JAVA_SPEC &gt;= 13;</span>
<span class="line-added">588     }</span>
<span class="line-added">589 </span>
<span class="line-added">590     private static boolean isJDK14OrHigher() {</span>
<span class="line-added">591         return JavaVersionUtil.JAVA_SPEC &gt;= 14;</span>
592     }
593 
594     public interface Refiner {
595         void refine(CheckGraalIntrinsics checker);
596     }
597 
598     @Test
599     @SuppressWarnings(&quot;try&quot;)
600     public void test() throws ClassNotFoundException {
601         HotSpotProviders providers = rt.getHostBackend().getProviders();
602         Plugins graphBuilderPlugins = providers.getGraphBuilderPlugins();
603         InvocationPlugins invocationPlugins = graphBuilderPlugins.getInvocationPlugins();
604 
605         HotSpotVMConfigStore store = config.getStore();
606         List&lt;VMIntrinsicMethod&gt; intrinsics = store.getIntrinsics();
607 
608         for (Refiner refiner : ServiceLoader.load(Refiner.class)) {
609             refiner.refine(this);
610         }
611 
</pre>
</td>
</tr>
</table>
<center><a href="CRC32CSubstitutionsTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="CompilationWrapperTest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>