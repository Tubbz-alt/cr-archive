<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.aarch64/src/org/graalvm/compiler/replacements/aarch64/AArch64GraphBuilderPlugins.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/GraphPrinterDumpHandler.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="AArch64IntegerArithmeticSnippets.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.aarch64/src/org/graalvm/compiler/replacements/aarch64/AArch64GraphBuilderPlugins.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 29,15 ***</span>
  import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.EXP;
  import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.LOG;
  import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.LOG10;
  import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.SIN;
  import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.TAN;
<span class="line-removed">- import static org.graalvm.compiler.serviceprovider.JavaVersionUtil.JAVA_SPECIFICATION_VERSION;</span>
<span class="line-removed">- import static org.graalvm.compiler.serviceprovider.JavaVersionUtil.Java11OrEarlier;</span>
<span class="line-removed">- import static org.graalvm.compiler.serviceprovider.JavaVersionUtil.Java8OrEarlier;</span>
  
<span class="line-removed">- import org.graalvm.compiler.bytecode.BytecodeProvider;</span>
  import org.graalvm.compiler.lir.aarch64.AArch64ArithmeticLIRGeneratorTool.RoundingMode;
  import org.graalvm.compiler.nodes.ValueNode;
  import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
  import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
<span class="line-new-header">--- 29,11 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,44 ***</span>
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
  import org.graalvm.compiler.nodes.java.AtomicReadAndAddNode;
  import org.graalvm.compiler.nodes.java.AtomicReadAndWriteNode;
  import org.graalvm.compiler.nodes.memory.address.AddressNode;
  import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;
  import org.graalvm.compiler.replacements.nodes.BinaryMathIntrinsicNode;
  import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode;
  import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation;
  import jdk.internal.vm.compiler.word.LocationIdentity;
  
  import jdk.vm.ci.meta.JavaKind;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
  import sun.misc.Unsafe;
  
<span class="line-modified">! public class AArch64GraphBuilderPlugins {</span>
  
<span class="line-modified">!     public static void register(Plugins plugins, BytecodeProvider bytecodeProvider, boolean explicitUnsafeNullChecks) {</span>
          InvocationPlugins invocationPlugins = plugins.getInvocationPlugins();
          invocationPlugins.defer(new Runnable() {
              @Override
              public void run() {
<span class="line-modified">!                 registerIntegerLongPlugins(invocationPlugins, AArch64IntegerSubstitutions.class, JavaKind.Int, bytecodeProvider);</span>
<span class="line-modified">!                 registerIntegerLongPlugins(invocationPlugins, AArch64LongSubstitutions.class, JavaKind.Long, bytecodeProvider);</span>
<span class="line-modified">!                 registerMathPlugins(invocationPlugins);</span>
<span class="line-modified">!                 registerStringLatin1Plugins(invocationPlugins, bytecodeProvider);</span>
<span class="line-modified">!                 registerStringUTF16Plugins(invocationPlugins, bytecodeProvider);</span>
<span class="line-modified">!                 registerUnsafePlugins(invocationPlugins, bytecodeProvider);</span>
                  // This is temporarily disabled until we implement correct emitting of the CAS
                  // instructions of the proper width.
<span class="line-modified">!                 registerPlatformSpecificUnsafePlugins(invocationPlugins, bytecodeProvider, explicitUnsafeNullChecks,</span>
                                  new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object});
              }
          });
      }
  
<span class="line-modified">!     private static void registerIntegerLongPlugins(InvocationPlugins plugins, Class&lt;?&gt; substituteDeclaringClass, JavaKind kind, BytecodeProvider bytecodeProvider) {</span>
          Class&lt;?&gt; declaringClass = kind.toBoxedJavaClass();
          Class&lt;?&gt; type = kind.toJavaClass();
<span class="line-modified">!         Registration r = new Registration(plugins, declaringClass, bytecodeProvider);</span>
          r.register1(&quot;numberOfLeadingZeros&quot;, type, new InvocationPlugin() {
              @Override
              public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {
                  ValueNode folded = AArch64CountLeadingZerosNode.tryFold(value);
                  if (folded != null) {
<span class="line-new-header">--- 42,59 ---</span>
  import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
  import org.graalvm.compiler.nodes.java.AtomicReadAndAddNode;
  import org.graalvm.compiler.nodes.java.AtomicReadAndWriteNode;
  import org.graalvm.compiler.nodes.memory.address.AddressNode;
  import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;
<span class="line-added">+ import org.graalvm.compiler.nodes.spi.Replacements;</span>
<span class="line-added">+ import org.graalvm.compiler.replacements.TargetGraphBuilderPlugins;</span>
  import org.graalvm.compiler.replacements.nodes.BinaryMathIntrinsicNode;
<span class="line-added">+ import org.graalvm.compiler.replacements.nodes.FusedMultiplyAddNode;</span>
  import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode;
  import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation;
<span class="line-added">+ import org.graalvm.compiler.serviceprovider.JavaVersionUtil;</span>
  import jdk.internal.vm.compiler.word.LocationIdentity;
  
<span class="line-added">+ import jdk.vm.ci.code.Architecture;</span>
  import jdk.vm.ci.meta.JavaKind;
  import jdk.vm.ci.meta.ResolvedJavaMethod;
  import sun.misc.Unsafe;
  
<span class="line-modified">! public class AArch64GraphBuilderPlugins implements TargetGraphBuilderPlugins {</span>
<span class="line-added">+     @Override</span>
<span class="line-added">+     public void register(Plugins plugins, Replacements replacements, Architecture arch, boolean explicitUnsafeNullChecks, boolean registerMathPlugins,</span>
<span class="line-added">+                     boolean emitJDK9StringSubstitutions, boolean useFMAIntrinsics) {</span>
<span class="line-added">+         register(plugins, replacements, explicitUnsafeNullChecks, registerMathPlugins, emitJDK9StringSubstitutions, useFMAIntrinsics);</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     public static void register(Plugins plugins, Replacements replacements, boolean explicitUnsafeNullChecks,</span>
<span class="line-added">+                     boolean registerMathPlugins, boolean emitJDK9StringSubstitutions, boolean useFMAIntrinsics) {</span>
          InvocationPlugins invocationPlugins = plugins.getInvocationPlugins();
          invocationPlugins.defer(new Runnable() {
              @Override
              public void run() {
<span class="line-modified">!                 registerIntegerLongPlugins(invocationPlugins, JavaKind.Int, replacements);</span>
<span class="line-modified">!                 registerIntegerLongPlugins(invocationPlugins, JavaKind.Long, replacements);</span>
<span class="line-modified">!                 if (registerMathPlugins) {</span>
<span class="line-modified">!                     registerMathPlugins(invocationPlugins, useFMAIntrinsics);</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 if (emitJDK9StringSubstitutions) {</span>
<span class="line-added">+                     registerStringLatin1Plugins(invocationPlugins, replacements);</span>
<span class="line-added">+                     registerStringUTF16Plugins(invocationPlugins, replacements);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 registerUnsafePlugins(invocationPlugins, replacements);</span>
                  // This is temporarily disabled until we implement correct emitting of the CAS
                  // instructions of the proper width.
<span class="line-modified">!                 registerPlatformSpecificUnsafePlugins(invocationPlugins, replacements, explicitUnsafeNullChecks,</span>
                                  new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object});
              }
          });
      }
  
<span class="line-modified">!     private static void registerIntegerLongPlugins(InvocationPlugins plugins, JavaKind kind, Replacements replacements) {</span>
          Class&lt;?&gt; declaringClass = kind.toBoxedJavaClass();
          Class&lt;?&gt; type = kind.toJavaClass();
<span class="line-modified">!         Registration r = new Registration(plugins, declaringClass, replacements);</span>
          r.register1(&quot;numberOfLeadingZeros&quot;, type, new InvocationPlugin() {
              @Override
              public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {
                  ValueNode folded = AArch64CountLeadingZerosNode.tryFold(value);
                  if (folded != null) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 104,14 ***</span>
                      b.addPush(JavaKind.Int, new AArch64CountTrailingZerosNode(value));
                  }
                  return true;
              }
          });
<span class="line-modified">!         r.registerMethodSubstitution(substituteDeclaringClass, &quot;bitCount&quot;, type);</span>
      }
  
<span class="line-modified">!     private static void registerMathPlugins(InvocationPlugins plugins) {</span>
          Registration r = new Registration(plugins, Math.class);
          registerUnaryMath(r, &quot;sin&quot;, SIN);
          registerUnaryMath(r, &quot;cos&quot;, COS);
          registerUnaryMath(r, &quot;tan&quot;, TAN);
          registerUnaryMath(r, &quot;exp&quot;, EXP);
<span class="line-new-header">--- 115,20 ---</span>
                      b.addPush(JavaKind.Int, new AArch64CountTrailingZerosNode(value));
                  }
                  return true;
              }
          });
<span class="line-modified">!         r.register1(&quot;bitCount&quot;, type, new InvocationPlugin() {</span>
<span class="line-added">+             @Override</span>
<span class="line-added">+             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {</span>
<span class="line-added">+                 b.push(JavaKind.Int, b.append(new AArch64BitCountNode(value).canonical(null)));</span>
<span class="line-added">+                 return true;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         });</span>
      }
  
<span class="line-modified">!     private static void registerMathPlugins(InvocationPlugins plugins, boolean useFMAIntrinsics) {</span>
          Registration r = new Registration(plugins, Math.class);
          registerUnaryMath(r, &quot;sin&quot;, SIN);
          registerUnaryMath(r, &quot;cos&quot;, COS);
          registerUnaryMath(r, &quot;tan&quot;, TAN);
          registerUnaryMath(r, &quot;exp&quot;, EXP);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 125,10 ***</span>
<span class="line-new-header">--- 142,40 ---</span>
              }
          });
          registerRound(r, &quot;rint&quot;, RoundingMode.NEAREST);
          registerRound(r, &quot;ceil&quot;, RoundingMode.UP);
          registerRound(r, &quot;floor&quot;, RoundingMode.DOWN);
<span class="line-added">+         if (useFMAIntrinsics &amp;&amp; JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-added">+             registerFMA(r);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static void registerFMA(Registration r) {</span>
<span class="line-added">+         r.register3(&quot;fma&quot;, Double.TYPE, Double.TYPE, Double.TYPE, new InvocationPlugin() {</span>
<span class="line-added">+             @Override</span>
<span class="line-added">+             public boolean apply(GraphBuilderContext b,</span>
<span class="line-added">+                             ResolvedJavaMethod targetMethod,</span>
<span class="line-added">+                             Receiver receiver,</span>
<span class="line-added">+                             ValueNode na,</span>
<span class="line-added">+                             ValueNode nb,</span>
<span class="line-added">+                             ValueNode nc) {</span>
<span class="line-added">+                 b.push(JavaKind.Double, b.append(new FusedMultiplyAddNode(na, nb, nc)));</span>
<span class="line-added">+                 return true;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         });</span>
<span class="line-added">+         r.register3(&quot;fma&quot;, Float.TYPE, Float.TYPE, Float.TYPE, new InvocationPlugin() {</span>
<span class="line-added">+             @Override</span>
<span class="line-added">+             public boolean apply(GraphBuilderContext b,</span>
<span class="line-added">+                             ResolvedJavaMethod targetMethod,</span>
<span class="line-added">+                             Receiver receiver,</span>
<span class="line-added">+                             ValueNode na,</span>
<span class="line-added">+                             ValueNode nb,</span>
<span class="line-added">+                             ValueNode nc) {</span>
<span class="line-added">+                 b.push(JavaKind.Float, b.append(new FusedMultiplyAddNode(na, nb, nc)));</span>
<span class="line-added">+                 return true;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         });</span>
      }
  
      private static void registerUnaryMath(Registration r, String name, UnaryOperation operation) {
          r.register1(name, Double.TYPE, new InvocationPlugin() {
              @Override
</pre>
<hr />
<pre>
<span class="line-old-header">*** 147,35 ***</span>
                  return true;
              }
          });
      }
  
<span class="line-modified">!     private static void registerStringLatin1Plugins(InvocationPlugins plugins, BytecodeProvider replacementsBytecodeProvider) {</span>
<span class="line-modified">!         if (JAVA_SPECIFICATION_VERSION &gt;= 9) {</span>
<span class="line-modified">!             Registration r = new Registration(plugins, &quot;java.lang.StringLatin1&quot;, replacementsBytecodeProvider);</span>
              r.setAllowOverwrite(true);
              r.registerMethodSubstitution(AArch64StringLatin1Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);
              r.registerMethodSubstitution(AArch64StringLatin1Substitutions.class, &quot;compareToUTF16&quot;, byte[].class, byte[].class);
          }
      }
  
<span class="line-modified">!     private static void registerStringUTF16Plugins(InvocationPlugins plugins, BytecodeProvider replacementsBytecodeProvider) {</span>
<span class="line-modified">!         if (JAVA_SPECIFICATION_VERSION &gt;= 9) {</span>
<span class="line-modified">!             Registration r = new Registration(plugins, &quot;java.lang.StringUTF16&quot;, replacementsBytecodeProvider);</span>
              r.setAllowOverwrite(true);
              r.registerMethodSubstitution(AArch64StringUTF16Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);
              r.registerMethodSubstitution(AArch64StringUTF16Substitutions.class, &quot;compareToLatin1&quot;, byte[].class, byte[].class);
          }
      }
  
<span class="line-modified">!     private static void registerUnsafePlugins(InvocationPlugins plugins, BytecodeProvider replacementsBytecodeProvider) {</span>
          registerUnsafePlugins(new Registration(plugins, Unsafe.class),
                          new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object}, &quot;Object&quot;);
<span class="line-modified">!         if (!Java8OrEarlier) {</span>
<span class="line-modified">!             registerUnsafePlugins(new Registration(plugins, &quot;jdk.internal.misc.Unsafe&quot;, replacementsBytecodeProvider),</span>
                              new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object},
<span class="line-modified">!                             Java11OrEarlier ? &quot;Object&quot; : &quot;Reference&quot;);</span>
          }
      }
  
      private static void registerUnsafePlugins(Registration r, JavaKind[] unsafeJavaKinds, String objectKindName) {
  
<span class="line-new-header">--- 194,35 ---</span>
                  return true;
              }
          });
      }
  
<span class="line-modified">!     private static void registerStringLatin1Plugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">!         if (JavaVersionUtil.JAVA_SPEC &gt;= 9) {</span>
<span class="line-modified">!             Registration r = new Registration(plugins, &quot;java.lang.StringLatin1&quot;, replacements);</span>
              r.setAllowOverwrite(true);
              r.registerMethodSubstitution(AArch64StringLatin1Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);
              r.registerMethodSubstitution(AArch64StringLatin1Substitutions.class, &quot;compareToUTF16&quot;, byte[].class, byte[].class);
          }
      }
  
<span class="line-modified">!     private static void registerStringUTF16Plugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">!         if (JavaVersionUtil.JAVA_SPEC &gt;= 9) {</span>
<span class="line-modified">!             Registration r = new Registration(plugins, &quot;java.lang.StringUTF16&quot;, replacements);</span>
              r.setAllowOverwrite(true);
              r.registerMethodSubstitution(AArch64StringUTF16Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);
              r.registerMethodSubstitution(AArch64StringUTF16Substitutions.class, &quot;compareToLatin1&quot;, byte[].class, byte[].class);
          }
      }
  
<span class="line-modified">!     private static void registerUnsafePlugins(InvocationPlugins plugins, Replacements replacements) {</span>
          registerUnsafePlugins(new Registration(plugins, Unsafe.class),
                          new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object}, &quot;Object&quot;);
<span class="line-modified">!         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-modified">!             registerUnsafePlugins(new Registration(plugins, &quot;jdk.internal.misc.Unsafe&quot;, replacements),</span>
                              new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object},
<span class="line-modified">!                             JavaVersionUtil.JAVA_SPEC &lt;= 11 ? &quot;Object&quot; : &quot;Reference&quot;);</span>
          }
      }
  
      private static void registerUnsafePlugins(Registration r, JavaKind[] unsafeJavaKinds, String objectKindName) {
  
</pre>
<center><a href="../../../../../../../org.graalvm.compiler.printer/src/org/graalvm/compiler/printer/GraphPrinterDumpHandler.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="AArch64IntegerArithmeticSnippets.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>