<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.replacements.aarch64/src/org/graalvm/compiler/replacements/aarch64/AArch64GraphBuilderPlugins.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 
 24 
 25 package org.graalvm.compiler.replacements.aarch64;
 26 
 27 import static org.graalvm.compiler.replacements.StandardGraphBuilderPlugins.registerPlatformSpecificUnsafePlugins;
 28 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.COS;
 29 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.EXP;
 30 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.LOG;
 31 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.LOG10;
 32 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.SIN;
 33 import static org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation.TAN;
<a name="2" id="anc2"></a>


 34 
<a name="3" id="anc3"></a>
 35 import org.graalvm.compiler.lir.aarch64.AArch64ArithmeticLIRGeneratorTool.RoundingMode;
 36 import org.graalvm.compiler.nodes.ValueNode;
 37 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderConfiguration.Plugins;
 38 import org.graalvm.compiler.nodes.graphbuilderconf.GraphBuilderContext;
 39 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin;
 40 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugin.Receiver;
 41 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins;
 42 import org.graalvm.compiler.nodes.graphbuilderconf.InvocationPlugins.Registration;
 43 import org.graalvm.compiler.nodes.java.AtomicReadAndAddNode;
 44 import org.graalvm.compiler.nodes.java.AtomicReadAndWriteNode;
 45 import org.graalvm.compiler.nodes.memory.address.AddressNode;
 46 import org.graalvm.compiler.nodes.memory.address.OffsetAddressNode;
<a name="4" id="anc4"></a><span class="line-added"> 47 import org.graalvm.compiler.nodes.spi.Replacements;</span>
<span class="line-added"> 48 import org.graalvm.compiler.replacements.TargetGraphBuilderPlugins;</span>
 49 import org.graalvm.compiler.replacements.nodes.BinaryMathIntrinsicNode;
<a name="5" id="anc5"></a><span class="line-added"> 50 import org.graalvm.compiler.replacements.nodes.FusedMultiplyAddNode;</span>
 51 import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode;
 52 import org.graalvm.compiler.replacements.nodes.UnaryMathIntrinsicNode.UnaryOperation;
<a name="6" id="anc6"></a><span class="line-added"> 53 import org.graalvm.compiler.serviceprovider.JavaVersionUtil;</span>
 54 import jdk.internal.vm.compiler.word.LocationIdentity;
 55 
<a name="7" id="anc7"></a><span class="line-added"> 56 import jdk.vm.ci.code.Architecture;</span>
 57 import jdk.vm.ci.meta.JavaKind;
 58 import jdk.vm.ci.meta.ResolvedJavaMethod;
 59 import sun.misc.Unsafe;
 60 
<a name="8" id="anc8"></a><span class="line-modified"> 61 public class AArch64GraphBuilderPlugins implements TargetGraphBuilderPlugins {</span>
<span class="line-added"> 62     @Override</span>
<span class="line-added"> 63     public void register(Plugins plugins, Replacements replacements, Architecture arch, boolean explicitUnsafeNullChecks, boolean registerMathPlugins,</span>
<span class="line-added"> 64                     boolean emitJDK9StringSubstitutions, boolean useFMAIntrinsics) {</span>
<span class="line-added"> 65         register(plugins, replacements, explicitUnsafeNullChecks, registerMathPlugins, emitJDK9StringSubstitutions, useFMAIntrinsics);</span>
<span class="line-added"> 66     }</span>
 67 
<a name="9" id="anc9"></a><span class="line-modified"> 68     public static void register(Plugins plugins, Replacements replacements, boolean explicitUnsafeNullChecks,</span>
<span class="line-added"> 69                     boolean registerMathPlugins, boolean emitJDK9StringSubstitutions, boolean useFMAIntrinsics) {</span>
 70         InvocationPlugins invocationPlugins = plugins.getInvocationPlugins();
 71         invocationPlugins.defer(new Runnable() {
 72             @Override
 73             public void run() {
<a name="10" id="anc10"></a><span class="line-modified"> 74                 registerIntegerLongPlugins(invocationPlugins, JavaKind.Int, replacements);</span>
<span class="line-modified"> 75                 registerIntegerLongPlugins(invocationPlugins, JavaKind.Long, replacements);</span>
<span class="line-modified"> 76                 if (registerMathPlugins) {</span>
<span class="line-modified"> 77                     registerMathPlugins(invocationPlugins, useFMAIntrinsics);</span>
<span class="line-modified"> 78                 }</span>
<span class="line-modified"> 79                 if (emitJDK9StringSubstitutions) {</span>
<span class="line-added"> 80                     registerStringLatin1Plugins(invocationPlugins, replacements);</span>
<span class="line-added"> 81                     registerStringUTF16Plugins(invocationPlugins, replacements);</span>
<span class="line-added"> 82                 }</span>
<span class="line-added"> 83                 registerUnsafePlugins(invocationPlugins, replacements);</span>
 84                 // This is temporarily disabled until we implement correct emitting of the CAS
 85                 // instructions of the proper width.
<a name="11" id="anc11"></a><span class="line-modified"> 86                 registerPlatformSpecificUnsafePlugins(invocationPlugins, replacements, explicitUnsafeNullChecks,</span>
 87                                 new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object});
 88             }
 89         });
 90     }
 91 
<a name="12" id="anc12"></a><span class="line-modified"> 92     private static void registerIntegerLongPlugins(InvocationPlugins plugins, JavaKind kind, Replacements replacements) {</span>
 93         Class&lt;?&gt; declaringClass = kind.toBoxedJavaClass();
 94         Class&lt;?&gt; type = kind.toJavaClass();
<a name="13" id="anc13"></a><span class="line-modified"> 95         Registration r = new Registration(plugins, declaringClass, replacements);</span>
 96         r.register1(&quot;numberOfLeadingZeros&quot;, type, new InvocationPlugin() {
 97             @Override
 98             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {
 99                 ValueNode folded = AArch64CountLeadingZerosNode.tryFold(value);
100                 if (folded != null) {
101                     b.addPush(JavaKind.Int, folded);
102                 } else {
103                     b.addPush(JavaKind.Int, new AArch64CountLeadingZerosNode(value));
104                 }
105                 return true;
106             }
107         });
108         r.register1(&quot;numberOfTrailingZeros&quot;, type, new InvocationPlugin() {
109             @Override
110             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {
111                 ValueNode folded = AArch64CountTrailingZerosNode.tryFold(value);
112                 if (folded != null) {
113                     b.addPush(JavaKind.Int, folded);
114                 } else {
115                     b.addPush(JavaKind.Int, new AArch64CountTrailingZerosNode(value));
116                 }
117                 return true;
118             }
119         });
<a name="14" id="anc14"></a><span class="line-modified">120         r.register1(&quot;bitCount&quot;, type, new InvocationPlugin() {</span>
<span class="line-added">121             @Override</span>
<span class="line-added">122             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {</span>
<span class="line-added">123                 b.push(JavaKind.Int, b.append(new AArch64BitCountNode(value).canonical(null)));</span>
<span class="line-added">124                 return true;</span>
<span class="line-added">125             }</span>
<span class="line-added">126         });</span>
127     }
128 
<a name="15" id="anc15"></a><span class="line-modified">129     private static void registerMathPlugins(InvocationPlugins plugins, boolean useFMAIntrinsics) {</span>
130         Registration r = new Registration(plugins, Math.class);
131         registerUnaryMath(r, &quot;sin&quot;, SIN);
132         registerUnaryMath(r, &quot;cos&quot;, COS);
133         registerUnaryMath(r, &quot;tan&quot;, TAN);
134         registerUnaryMath(r, &quot;exp&quot;, EXP);
135         registerUnaryMath(r, &quot;log&quot;, LOG);
136         registerUnaryMath(r, &quot;log10&quot;, LOG10);
137         r.register2(&quot;pow&quot;, Double.TYPE, Double.TYPE, new InvocationPlugin() {
138             @Override
139             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode x, ValueNode y) {
140                 b.push(JavaKind.Double, b.append(BinaryMathIntrinsicNode.create(x, y, BinaryMathIntrinsicNode.BinaryOperation.POW)));
141                 return true;
142             }
143         });
144         registerRound(r, &quot;rint&quot;, RoundingMode.NEAREST);
145         registerRound(r, &quot;ceil&quot;, RoundingMode.UP);
146         registerRound(r, &quot;floor&quot;, RoundingMode.DOWN);
<a name="16" id="anc16"></a><span class="line-added">147         if (useFMAIntrinsics &amp;&amp; JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-added">148             registerFMA(r);</span>
<span class="line-added">149         }</span>
<span class="line-added">150     }</span>
<span class="line-added">151 </span>
<span class="line-added">152     private static void registerFMA(Registration r) {</span>
<span class="line-added">153         r.register3(&quot;fma&quot;, Double.TYPE, Double.TYPE, Double.TYPE, new InvocationPlugin() {</span>
<span class="line-added">154             @Override</span>
<span class="line-added">155             public boolean apply(GraphBuilderContext b,</span>
<span class="line-added">156                             ResolvedJavaMethod targetMethod,</span>
<span class="line-added">157                             Receiver receiver,</span>
<span class="line-added">158                             ValueNode na,</span>
<span class="line-added">159                             ValueNode nb,</span>
<span class="line-added">160                             ValueNode nc) {</span>
<span class="line-added">161                 b.push(JavaKind.Double, b.append(new FusedMultiplyAddNode(na, nb, nc)));</span>
<span class="line-added">162                 return true;</span>
<span class="line-added">163             }</span>
<span class="line-added">164         });</span>
<span class="line-added">165         r.register3(&quot;fma&quot;, Float.TYPE, Float.TYPE, Float.TYPE, new InvocationPlugin() {</span>
<span class="line-added">166             @Override</span>
<span class="line-added">167             public boolean apply(GraphBuilderContext b,</span>
<span class="line-added">168                             ResolvedJavaMethod targetMethod,</span>
<span class="line-added">169                             Receiver receiver,</span>
<span class="line-added">170                             ValueNode na,</span>
<span class="line-added">171                             ValueNode nb,</span>
<span class="line-added">172                             ValueNode nc) {</span>
<span class="line-added">173                 b.push(JavaKind.Float, b.append(new FusedMultiplyAddNode(na, nb, nc)));</span>
<span class="line-added">174                 return true;</span>
<span class="line-added">175             }</span>
<span class="line-added">176         });</span>
177     }
178 
179     private static void registerUnaryMath(Registration r, String name, UnaryOperation operation) {
180         r.register1(name, Double.TYPE, new InvocationPlugin() {
181             @Override
182             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode value) {
183                 b.push(JavaKind.Double, b.append(UnaryMathIntrinsicNode.create(value, operation)));
184                 return true;
185             }
186         });
187     }
188 
189     private static void registerRound(Registration r, String name, RoundingMode mode) {
190         r.register1(name, Double.TYPE, new InvocationPlugin() {
191             @Override
192             public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver receiver, ValueNode arg) {
193                 b.push(JavaKind.Double, b.append(new AArch64RoundNode(arg, mode)));
194                 return true;
195             }
196         });
197     }
198 
<a name="17" id="anc17"></a><span class="line-modified">199     private static void registerStringLatin1Plugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">200         if (JavaVersionUtil.JAVA_SPEC &gt;= 9) {</span>
<span class="line-modified">201             Registration r = new Registration(plugins, &quot;java.lang.StringLatin1&quot;, replacements);</span>
202             r.setAllowOverwrite(true);
203             r.registerMethodSubstitution(AArch64StringLatin1Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);
204             r.registerMethodSubstitution(AArch64StringLatin1Substitutions.class, &quot;compareToUTF16&quot;, byte[].class, byte[].class);
205         }
206     }
207 
<a name="18" id="anc18"></a><span class="line-modified">208     private static void registerStringUTF16Plugins(InvocationPlugins plugins, Replacements replacements) {</span>
<span class="line-modified">209         if (JavaVersionUtil.JAVA_SPEC &gt;= 9) {</span>
<span class="line-modified">210             Registration r = new Registration(plugins, &quot;java.lang.StringUTF16&quot;, replacements);</span>
211             r.setAllowOverwrite(true);
212             r.registerMethodSubstitution(AArch64StringUTF16Substitutions.class, &quot;compareTo&quot;, byte[].class, byte[].class);
213             r.registerMethodSubstitution(AArch64StringUTF16Substitutions.class, &quot;compareToLatin1&quot;, byte[].class, byte[].class);
214         }
215     }
216 
<a name="19" id="anc19"></a><span class="line-modified">217     private static void registerUnsafePlugins(InvocationPlugins plugins, Replacements replacements) {</span>
218         registerUnsafePlugins(new Registration(plugins, Unsafe.class),
219                         new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object}, &quot;Object&quot;);
<a name="20" id="anc20"></a><span class="line-modified">220         if (JavaVersionUtil.JAVA_SPEC &gt; 8) {</span>
<span class="line-modified">221             registerUnsafePlugins(new Registration(plugins, &quot;jdk.internal.misc.Unsafe&quot;, replacements),</span>
222                             new JavaKind[]{JavaKind.Int, JavaKind.Long, JavaKind.Object},
<a name="21" id="anc21"></a><span class="line-modified">223                             JavaVersionUtil.JAVA_SPEC &lt;= 11 ? &quot;Object&quot; : &quot;Reference&quot;);</span>
224         }
225     }
226 
227     private static void registerUnsafePlugins(Registration r, JavaKind[] unsafeJavaKinds, String objectKindName) {
228 
229         for (JavaKind kind : unsafeJavaKinds) {
230             Class&lt;?&gt; javaClass = kind == JavaKind.Object ? Object.class : kind.toJavaClass();
231             String kindName = kind == JavaKind.Object ? objectKindName : kind.name();
232             r.register4(&quot;getAndSet&quot; + kindName, Receiver.class, Object.class, long.class, javaClass, new InvocationPlugin() {
233                 @Override
234                 public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver unsafe, ValueNode object, ValueNode offset, ValueNode value) {
235                     // Emits a null-check for the otherwise unused receiver
236                     unsafe.get();
237                     b.addPush(kind, new AtomicReadAndWriteNode(object, offset, value, kind, LocationIdentity.any()));
238                     b.getGraph().markUnsafeAccess();
239                     return true;
240                 }
241             });
242 
243             if (kind != JavaKind.Boolean &amp;&amp; kind.isNumericInteger()) {
244                 r.register4(&quot;getAndAdd&quot; + kindName, Receiver.class, Object.class, long.class, javaClass, new InvocationPlugin() {
245                     @Override
246                     public boolean apply(GraphBuilderContext b, ResolvedJavaMethod targetMethod, Receiver unsafe, ValueNode object, ValueNode offset, ValueNode delta) {
247                         // Emits a null-check for the otherwise unused receiver
248                         unsafe.get();
249                         AddressNode address = b.add(new OffsetAddressNode(object, offset));
250                         b.addPush(kind, new AtomicReadAndAddNode(address, delta, kind, LocationIdentity.any()));
251                         b.getGraph().markUnsafeAccess();
252                         return true;
253                     }
254                 });
255             }
256         }
257     }
258 }
<a name="22" id="anc22"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="22" type="hidden" />
</body>
</html>