<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core/src/org/graalvm/compiler/core/CompilationWrapper.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CompilationPrinter.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="GraalCompilerOptions.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.internal.vm.compiler/share/classes/org.graalvm.compiler.core/src/org/graalvm/compiler/core/CompilationWrapper.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2018, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 23,14 ***</span>
  
  
  package org.graalvm.compiler.core;
  
  import static org.graalvm.compiler.core.CompilationWrapper.ExceptionAction.ExitVM;
<span class="line-modified">! import static org.graalvm.compiler.core.GraalCompilerOptions.CompilationBailoutAction;</span>
  import static org.graalvm.compiler.core.GraalCompilerOptions.CompilationFailureAction;
  import static org.graalvm.compiler.core.GraalCompilerOptions.ExitVMOnException;
  import static org.graalvm.compiler.core.GraalCompilerOptions.MaxCompilationProblemsPerAction;
  import static org.graalvm.compiler.debug.DebugContext.VERBOSE_LEVEL;
  import static org.graalvm.compiler.debug.DebugOptions.Dump;
  import static org.graalvm.compiler.debug.DebugOptions.DumpPath;
  import static org.graalvm.compiler.debug.DebugOptions.MethodFilter;
  
<span class="line-new-header">--- 23,15 ---</span>
  
  
  package org.graalvm.compiler.core;
  
  import static org.graalvm.compiler.core.CompilationWrapper.ExceptionAction.ExitVM;
<span class="line-modified">! import static org.graalvm.compiler.core.GraalCompilerOptions.CompilationBailoutAsFailure;</span>
  import static org.graalvm.compiler.core.GraalCompilerOptions.CompilationFailureAction;
  import static org.graalvm.compiler.core.GraalCompilerOptions.ExitVMOnException;
  import static org.graalvm.compiler.core.GraalCompilerOptions.MaxCompilationProblemsPerAction;
<span class="line-added">+ import static org.graalvm.compiler.core.common.GraalOptions.TrackNodeSourcePosition;</span>
  import static org.graalvm.compiler.debug.DebugContext.VERBOSE_LEVEL;
  import static org.graalvm.compiler.debug.DebugOptions.Dump;
  import static org.graalvm.compiler.debug.DebugOptions.DumpPath;
  import static org.graalvm.compiler.debug.DebugOptions.MethodFilter;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 43,18 ***</span>
  
  import org.graalvm.compiler.debug.DebugContext;
  import org.graalvm.compiler.debug.DiagnosticsOutputDirectory;
  import org.graalvm.compiler.debug.PathUtilities;
  import org.graalvm.compiler.debug.TTY;
<span class="line-removed">- import org.graalvm.compiler.options.EnumOptionKey;</span>
  import org.graalvm.compiler.options.OptionValues;
  
  import jdk.vm.ci.code.BailoutException;
  
  /**
   * Wrapper for a compilation that centralizes what action to take based on
<span class="line-modified">!  * {@link GraalCompilerOptions#CompilationBailoutAction} and</span>
   * {@link GraalCompilerOptions#CompilationFailureAction} when an uncaught exception occurs during
   * compilation.
   */
  public abstract class CompilationWrapper&lt;T&gt; {
  
<span class="line-new-header">--- 44,17 ---</span>
  
  import org.graalvm.compiler.debug.DebugContext;
  import org.graalvm.compiler.debug.DiagnosticsOutputDirectory;
  import org.graalvm.compiler.debug.PathUtilities;
  import org.graalvm.compiler.debug.TTY;
  import org.graalvm.compiler.options.OptionValues;
  
  import jdk.vm.ci.code.BailoutException;
  
  /**
   * Wrapper for a compilation that centralizes what action to take based on
<span class="line-modified">!  * {@link GraalCompilerOptions#CompilationBailoutAsFailure} and</span>
   * {@link GraalCompilerOptions#CompilationFailureAction} when an uncaught exception occurs during
   * compilation.
   */
  public abstract class CompilationWrapper&lt;T&gt; {
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 69,18 ***</span>
<span class="line-new-header">--- 69,21 ---</span>
      public enum ExceptionAction {
          /**
           * Print nothing to the console.
           */
          Silent,
<span class="line-added">+ </span>
          /**
           * Print a stack trace to the console.
           */
          Print,
<span class="line-added">+ </span>
          /**
           * An exception causes the compilation to be retried with extra diagnostics enabled.
           */
          Diagnose,
<span class="line-added">+ </span>
          /**
           * Same as {@link #Diagnose} except that the VM process is exited after retrying.
           */
          ExitVM;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 120,31 ***</span>
       * @return a value representing the result of a failed compilation (may be {@code null})
       */
      protected abstract T handleException(Throwable t);
  
      /**
<span class="line-modified">!      * Gets the action to take based on the value of {@code actionKey} in {@code options}.</span>
       *
<span class="line-modified">!      * Subclasses can override this to choose a different action based on factors such as whether</span>
<span class="line-removed">-      * {@code actionKey} has been explicitly set in {@code options} for example.</span>
       *
       * @param cause the cause of the bailout or failure
       */
<span class="line-modified">!     protected ExceptionAction lookupAction(OptionValues options, EnumOptionKey&lt;ExceptionAction&gt; actionKey, Throwable cause) {</span>
<span class="line-modified">!         if (actionKey == CompilationFailureAction) {</span>
<span class="line-modified">!             if (ExitVMOnException.getValue(options)) {</span>
<span class="line-modified">!                 assert CompilationFailureAction.getDefaultValue() != ExceptionAction.ExitVM;</span>
<span class="line-modified">!                 assert ExitVMOnException.getDefaultValue() != true;</span>
<span class="line-modified">!                 if (CompilationFailureAction.hasBeenSet(options) &amp;&amp; CompilationFailureAction.getValue(options) != ExceptionAction.ExitVM) {</span>
<span class="line-modified">!                     TTY.printf(&quot;WARNING: Ignoring %s=%s since %s=true has been explicitly specified.%n&quot;,</span>
<span class="line-modified">!                                     CompilationFailureAction.getName(), CompilationFailureAction.getValue(options),</span>
<span class="line-modified">!                                     ExitVMOnException.getName());</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 return ExceptionAction.ExitVM;</span>
              }
          }
<span class="line-modified">!         return actionKey.getValue(options);</span>
      }
  
      /**
       * Perform the compilation wrapped by this object.
       *
<span class="line-new-header">--- 123,34 ---</span>
       * @return a value representing the result of a failed compilation (may be {@code null})
       */
      protected abstract T handleException(Throwable t);
  
      /**
<span class="line-modified">!      * Gets the action to take based on the value of</span>
<span class="line-added">+      * {@link GraalCompilerOptions#CompilationBailoutAsFailure},</span>
<span class="line-added">+      * {@link GraalCompilerOptions#CompilationFailureAction} and</span>
<span class="line-added">+      * {@link GraalCompilerOptions#ExitVMOnException} in {@code options}.</span>
       *
<span class="line-modified">!      * Subclasses can override this to choose a different action.</span>
       *
       * @param cause the cause of the bailout or failure
       */
<span class="line-modified">!     protected ExceptionAction lookupAction(OptionValues options, Throwable cause) {</span>
<span class="line-modified">!         if (cause instanceof BailoutException &amp;&amp; !CompilationBailoutAsFailure.getValue(options)) {</span>
<span class="line-modified">!             return ExceptionAction.Silent;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         if (ExitVMOnException.getValue(options)) {</span>
<span class="line-modified">!             assert CompilationFailureAction.getDefaultValue() != ExceptionAction.ExitVM;</span>
<span class="line-modified">!             assert ExitVMOnException.getDefaultValue() != true;</span>
<span class="line-modified">!             if (CompilationFailureAction.hasBeenSet(options) &amp;&amp; CompilationFailureAction.getValue(options) != ExceptionAction.ExitVM) {</span>
<span class="line-modified">!                 TTY.printf(&quot;WARNING: Ignoring %s=%s since %s=true has been explicitly specified.%n&quot;,</span>
<span class="line-modified">!                                 CompilationFailureAction.getName(), CompilationFailureAction.getValue(options),</span>
<span class="line-modified">!                                 ExitVMOnException.getName());</span>
              }
<span class="line-added">+             return ExceptionAction.ExitVM;</span>
          }
<span class="line-modified">!         return CompilationFailureAction.getValue(options);</span>
      }
  
      /**
       * Perform the compilation wrapped by this object.
       *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 159,63 ***</span>
      public abstract String toString();
  
      /**
       * Creates the {@link DebugContext} to use when retrying a compilation.
       *
       * @param options the options for configuring the debug context
       * @param logStream the log stream to use in the debug context
       */
<span class="line-modified">!     protected abstract DebugContext createRetryDebugContext(OptionValues options, PrintStream logStream);</span>
  
      @SuppressWarnings(&quot;try&quot;)
      public final T run(DebugContext initialDebug) {
          try {
              return performCompilation(initialDebug);
          } catch (Throwable cause) {
              OptionValues initialOptions = initialDebug.getOptions();
  
<span class="line-removed">-             String causeType = &quot;failure&quot;;</span>
<span class="line-removed">-             EnumOptionKey&lt;ExceptionAction&gt; actionKey;</span>
<span class="line-removed">-             if (cause instanceof BailoutException) {</span>
<span class="line-removed">-                 actionKey = CompilationBailoutAction;</span>
<span class="line-removed">-                 causeType = &quot;bailout&quot;;</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 actionKey = CompilationFailureAction;</span>
<span class="line-removed">-                 causeType = &quot;failure&quot;;</span>
<span class="line-removed">-             }</span>
              synchronized (CompilationFailureAction) {
                  // Serialize all compilation failure handling.
                  // This prevents retry compilation storms and interleaving
                  // of compilation exception messages.
                  // It also allows for reliable testing of CompilationWrapper
                  // by avoiding a race whereby retry compilation output from a
                  // forced crash (i.e., use of GraalCompilerOptions.CrashAt)
                  // is truncated.
  
<span class="line-modified">!                 ExceptionAction action = lookupAction(initialOptions, actionKey, cause);</span>
  
<span class="line-modified">!                 action = adjustAction(initialOptions, actionKey, action);</span>
  
                  if (action == ExceptionAction.Silent) {
                      return handleException(cause);
                  }
  
                  if (action == ExceptionAction.Print) {
                      ByteArrayOutputStream baos = new ByteArrayOutputStream();
                      try (PrintStream ps = new PrintStream(baos)) {
                          ps.printf(&quot;%s: Compilation of %s failed: &quot;, Thread.currentThread(), this);
                          cause.printStackTrace(ps);
<span class="line-modified">!                         ps.printf(&quot;To disable compilation %s notifications, set %s to %s (e.g., -Dgraal.%s=%s).%n&quot;,</span>
<span class="line-modified">!                                         causeType,</span>
<span class="line-modified">!                                         actionKey.getName(), ExceptionAction.Silent,</span>
<span class="line-modified">!                                         actionKey.getName(), ExceptionAction.Silent);</span>
<span class="line-removed">-                         ps.printf(&quot;To capture more information for diagnosing or reporting a compilation %s, &quot; +</span>
                                          &quot;set %s to %s or %s (e.g., -Dgraal.%s=%s).%n&quot;,
<span class="line-modified">!                                         causeType,</span>
<span class="line-removed">-                                         actionKey.getName(), ExceptionAction.Diagnose,</span>
                                          ExceptionAction.ExitVM,
<span class="line-modified">!                                         actionKey.getName(), ExceptionAction.Diagnose);</span>
                      }
                      TTY.print(baos.toString());
                      return handleException(cause);
                  }
  
<span class="line-new-header">--- 165,53 ---</span>
      public abstract String toString();
  
      /**
       * Creates the {@link DebugContext} to use when retrying a compilation.
       *
<span class="line-added">+      * @param initialDebug the debug context used in the failing compilation</span>
       * @param options the options for configuring the debug context
       * @param logStream the log stream to use in the debug context
       */
<span class="line-modified">!     protected abstract DebugContext createRetryDebugContext(DebugContext initialDebug, OptionValues options, PrintStream logStream);</span>
  
      @SuppressWarnings(&quot;try&quot;)
      public final T run(DebugContext initialDebug) {
          try {
              return performCompilation(initialDebug);
          } catch (Throwable cause) {
              OptionValues initialOptions = initialDebug.getOptions();
  
              synchronized (CompilationFailureAction) {
                  // Serialize all compilation failure handling.
                  // This prevents retry compilation storms and interleaving
                  // of compilation exception messages.
                  // It also allows for reliable testing of CompilationWrapper
                  // by avoiding a race whereby retry compilation output from a
                  // forced crash (i.e., use of GraalCompilerOptions.CrashAt)
                  // is truncated.
  
<span class="line-modified">!                 ExceptionAction action = lookupAction(initialOptions, cause);</span>
  
<span class="line-modified">!                 action = adjustAction(initialOptions, action);</span>
  
                  if (action == ExceptionAction.Silent) {
                      return handleException(cause);
                  }
  
                  if (action == ExceptionAction.Print) {
                      ByteArrayOutputStream baos = new ByteArrayOutputStream();
                      try (PrintStream ps = new PrintStream(baos)) {
                          ps.printf(&quot;%s: Compilation of %s failed: &quot;, Thread.currentThread(), this);
                          cause.printStackTrace(ps);
<span class="line-modified">!                         ps.printf(&quot;To disable compilation failure notifications, set %s to %s (e.g., -Dgraal.%s=%s).%n&quot;,</span>
<span class="line-modified">!                                         CompilationFailureAction.getName(), ExceptionAction.Silent,</span>
<span class="line-modified">!                                         CompilationFailureAction.getName(), ExceptionAction.Silent);</span>
<span class="line-modified">!                         ps.printf(&quot;To capture more information for diagnosing or reporting a compilation failure, &quot; +</span>
                                          &quot;set %s to %s or %s (e.g., -Dgraal.%s=%s).%n&quot;,
<span class="line-modified">!                                         CompilationFailureAction.getName(), ExceptionAction.Diagnose,</span>
                                          ExceptionAction.ExitVM,
<span class="line-modified">!                                         CompilationFailureAction.getName(), ExceptionAction.Diagnose);</span>
                      }
                      TTY.print(baos.toString());
                      return handleException(cause);
                  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 245,21 ***</span>
                  }
  
                  String message;
                  ByteArrayOutputStream baos = new ByteArrayOutputStream();
                  try (PrintStream ps = new PrintStream(baos)) {
                      ps.printf(&quot;%s: Compilation of %s failed:%n&quot;, Thread.currentThread(), this);
                      cause.printStackTrace(ps);
<span class="line-modified">!                     ps.printf(&quot;To disable compilation %s notifications, set %s to %s (e.g., -Dgraal.%s=%s).%n&quot;,</span>
<span class="line-modified">!                                     causeType,</span>
<span class="line-modified">!                                     actionKey.getName(), ExceptionAction.Silent,</span>
<span class="line-modified">!                                     actionKey.getName(), ExceptionAction.Silent);</span>
<span class="line-removed">-                     ps.printf(&quot;To print a message for a compilation %s without retrying the compilation, &quot; +</span>
                                      &quot;set %s to %s (e.g., -Dgraal.%s=%s).%n&quot;,
<span class="line-modified">!                                     causeType,</span>
<span class="line-modified">!                                     actionKey.getName(), ExceptionAction.Print,</span>
<span class="line-removed">-                                     actionKey.getName(), ExceptionAction.Print);</span>
                      if (dumpPath != null) {
                          ps.println(&quot;Retrying compilation of &quot; + this);
                      } else {
                          ps.println(&quot;Not retrying compilation of &quot; + this + &quot; as the dump path could not be created.&quot;);
                      }
<span class="line-new-header">--- 241,22 ---</span>
                  }
  
                  String message;
                  ByteArrayOutputStream baos = new ByteArrayOutputStream();
                  try (PrintStream ps = new PrintStream(baos)) {
<span class="line-added">+                     // This output is used by external tools to detect compilation failures.</span>
<span class="line-added">+                     ps.println(&quot;[[[Graal compilation failure]]]&quot;);</span>
<span class="line-added">+ </span>
                      ps.printf(&quot;%s: Compilation of %s failed:%n&quot;, Thread.currentThread(), this);
                      cause.printStackTrace(ps);
<span class="line-modified">!                     ps.printf(&quot;To disable compilation failure notifications, set %s to %s (e.g., -Dgraal.%s=%s).%n&quot;,</span>
<span class="line-modified">!                                     CompilationFailureAction.getName(), ExceptionAction.Silent,</span>
<span class="line-modified">!                                     CompilationFailureAction.getName(), ExceptionAction.Silent);</span>
<span class="line-modified">!                     ps.printf(&quot;To print a message for a compilation failure without retrying the compilation, &quot; +</span>
                                      &quot;set %s to %s (e.g., -Dgraal.%s=%s).%n&quot;,
<span class="line-modified">!                                     CompilationFailureAction.getName(), ExceptionAction.Print,</span>
<span class="line-modified">!                                     CompilationFailureAction.getName(), ExceptionAction.Print);</span>
                      if (dumpPath != null) {
                          ps.println(&quot;Retrying compilation of &quot; + this);
                      } else {
                          ps.println(&quot;Not retrying compilation of &quot; + this + &quot; as the dump path could not be created.&quot;);
                      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 279,15 ***</span>
                  }
  
                  OptionValues retryOptions = new OptionValues(initialOptions,
                                  Dump, &quot;:&quot; + VERBOSE_LEVEL,
                                  MethodFilter, null,
<span class="line-modified">!                                 DumpPath, dumpPath.getPath());</span>
  
                  ByteArrayOutputStream logBaos = new ByteArrayOutputStream();
                  PrintStream ps = new PrintStream(logBaos);
<span class="line-modified">!                 try (DebugContext retryDebug = createRetryDebugContext(retryOptions, ps)) {</span>
                      T res = performCompilation(retryDebug);
                      ps.println(&quot;There was no exception during retry.&quot;);
                      maybeExitVM(action);
                      return res;
                  } catch (Throwable e) {
<span class="line-new-header">--- 276,16 ---</span>
                  }
  
                  OptionValues retryOptions = new OptionValues(initialOptions,
                                  Dump, &quot;:&quot; + VERBOSE_LEVEL,
                                  MethodFilter, null,
<span class="line-modified">!                                 DumpPath, dumpPath.getPath(),</span>
<span class="line-added">+                                 TrackNodeSourcePosition, true);</span>
  
                  ByteArrayOutputStream logBaos = new ByteArrayOutputStream();
                  PrintStream ps = new PrintStream(logBaos);
<span class="line-modified">!                 try (DebugContext retryDebug = createRetryDebugContext(initialDebug, retryOptions, ps)) {</span>
                      T res = performCompilation(retryDebug);
                      ps.println(&quot;There was no exception during retry.&quot;);
                      maybeExitVM(action);
                      return res;
                  } catch (Throwable e) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 307,31 ***</span>
                  }
              }
          }
      }
  
      private void maybeExitVM(ExceptionAction action) {
          if (action == ExitVM) {
              TTY.println(&quot;Exiting VM after retry compilation of &quot; + this);
<span class="line-modified">!             System.exit(-1);</span>
          }
      }
  
      /**
       * Adjusts {@code initialAction} if necessary based on
       * {@link GraalCompilerOptions#MaxCompilationProblemsPerAction}.
       */
<span class="line-modified">!     private ExceptionAction adjustAction(OptionValues initialOptions, EnumOptionKey&lt;ExceptionAction&gt; actionKey, ExceptionAction initialAction) {</span>
          ExceptionAction action = initialAction;
          int maxProblems = MaxCompilationProblemsPerAction.getValue(initialOptions);
          if (action != ExceptionAction.ExitVM) {
              synchronized (problemsHandledPerAction) {
                  while (action != ExceptionAction.Silent) {
                      int problems = problemsHandledPerAction.getOrDefault(action, 0);
                      if (problems &gt;= maxProblems) {
                          if (problems == maxProblems) {
<span class="line-modified">!                             TTY.printf(&quot;Warning: adjusting %s from %s to %s after %s (%d) failed compilations%n&quot;, actionKey, action, action.quieter(),</span>
                                              MaxCompilationProblemsPerAction, maxProblems);
                              // Ensure that the message above is only printed once
                              problemsHandledPerAction.put(action, problems + 1);
                          }
                          action = action.quieter();
<span class="line-new-header">--- 305,37 ---</span>
                  }
              }
          }
      }
  
<span class="line-added">+     /**</span>
<span class="line-added">+      * Calls {@link System#exit(int)} in the runtime embedding the Graal compiler. This will be a</span>
<span class="line-added">+      * different runtime than Graal&#39;s runtime in the case of libgraal.</span>
<span class="line-added">+      */</span>
<span class="line-added">+     protected abstract void exitHostVM(int status);</span>
<span class="line-added">+ </span>
      private void maybeExitVM(ExceptionAction action) {
          if (action == ExitVM) {
              TTY.println(&quot;Exiting VM after retry compilation of &quot; + this);
<span class="line-modified">!             exitHostVM(-1);</span>
          }
      }
  
      /**
       * Adjusts {@code initialAction} if necessary based on
       * {@link GraalCompilerOptions#MaxCompilationProblemsPerAction}.
       */
<span class="line-modified">!     private ExceptionAction adjustAction(OptionValues initialOptions, ExceptionAction initialAction) {</span>
          ExceptionAction action = initialAction;
          int maxProblems = MaxCompilationProblemsPerAction.getValue(initialOptions);
          if (action != ExceptionAction.ExitVM) {
              synchronized (problemsHandledPerAction) {
                  while (action != ExceptionAction.Silent) {
                      int problems = problemsHandledPerAction.getOrDefault(action, 0);
                      if (problems &gt;= maxProblems) {
                          if (problems == maxProblems) {
<span class="line-modified">!                             TTY.printf(&quot;Warning: adjusting %s from %s to %s after %s (%d) failed compilations%n&quot;, CompilationFailureAction, action, action.quieter(),</span>
                                              MaxCompilationProblemsPerAction, maxProblems);
                              // Ensure that the message above is only printed once
                              problemsHandledPerAction.put(action, problems + 1);
                          }
                          action = action.quieter();
</pre>
<center><a href="CompilationPrinter.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="GraalCompilerOptions.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>