<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/os/aix/os_aix.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * Copyright (c) 2012, 2018 SAP SE. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 // According to the AIX OS doc #pragma alloca must be used
  27 // with C++ compiler before referencing the function alloca()
  28 #pragma alloca
  29 
  30 // no precompiled headers
  31 #include &quot;jvm.h&quot;
  32 #include &quot;classfile/classLoader.hpp&quot;
  33 #include &quot;classfile/systemDictionary.hpp&quot;
  34 #include &quot;classfile/vmSymbols.hpp&quot;
  35 #include &quot;code/icBuffer.hpp&quot;
  36 #include &quot;code/vtableStubs.hpp&quot;
  37 #include &quot;compiler/compileBroker.hpp&quot;
  38 #include &quot;interpreter/interpreter.hpp&quot;
  39 #include &quot;logging/log.hpp&quot;
  40 #include &quot;libo4.hpp&quot;
  41 #include &quot;libperfstat_aix.hpp&quot;
  42 #include &quot;libodm_aix.hpp&quot;
  43 #include &quot;loadlib_aix.hpp&quot;
  44 #include &quot;memory/allocation.inline.hpp&quot;
  45 #include &quot;memory/filemap.hpp&quot;
  46 #include &quot;misc_aix.hpp&quot;
  47 #include &quot;oops/oop.inline.hpp&quot;
  48 #include &quot;os_aix.inline.hpp&quot;
  49 #include &quot;os_share_aix.hpp&quot;
  50 #include &quot;porting_aix.hpp&quot;
  51 #include &quot;prims/jniFastGetField.hpp&quot;
  52 #include &quot;prims/jvm_misc.hpp&quot;
  53 #include &quot;runtime/arguments.hpp&quot;
  54 #include &quot;runtime/atomic.hpp&quot;
  55 #include &quot;runtime/extendedPC.hpp&quot;
  56 #include &quot;runtime/globals.hpp&quot;
  57 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  58 #include &quot;runtime/java.hpp&quot;
  59 #include &quot;runtime/javaCalls.hpp&quot;
  60 #include &quot;runtime/mutexLocker.hpp&quot;
  61 #include &quot;runtime/objectMonitor.hpp&quot;
  62 #include &quot;runtime/orderAccess.hpp&quot;
  63 #include &quot;runtime/os.hpp&quot;
  64 #include &quot;runtime/osThread.hpp&quot;
  65 #include &quot;runtime/perfMemory.hpp&quot;
  66 #include &quot;runtime/sharedRuntime.hpp&quot;
  67 #include &quot;runtime/statSampler.hpp&quot;
  68 #include &quot;runtime/stubRoutines.hpp&quot;
  69 #include &quot;runtime/thread.inline.hpp&quot;
  70 #include &quot;runtime/threadCritical.hpp&quot;
  71 #include &quot;runtime/timer.hpp&quot;
  72 #include &quot;runtime/vm_version.hpp&quot;
  73 #include &quot;services/attachListener.hpp&quot;
  74 #include &quot;services/runtimeService.hpp&quot;
  75 #include &quot;utilities/align.hpp&quot;
  76 #include &quot;utilities/decoder.hpp&quot;
  77 #include &quot;utilities/defaultStream.hpp&quot;
  78 #include &quot;utilities/events.hpp&quot;
  79 #include &quot;utilities/growableArray.hpp&quot;
  80 #include &quot;utilities/vmError.hpp&quot;
  81 
  82 // put OS-includes here (sorted alphabetically)
  83 #include &lt;errno.h&gt;
  84 #include &lt;fcntl.h&gt;
  85 #include &lt;inttypes.h&gt;
  86 #include &lt;poll.h&gt;
  87 #include &lt;procinfo.h&gt;
  88 #include &lt;pthread.h&gt;
  89 #include &lt;pwd.h&gt;
  90 #include &lt;semaphore.h&gt;
  91 #include &lt;signal.h&gt;
  92 #include &lt;stdint.h&gt;
  93 #include &lt;stdio.h&gt;
  94 #include &lt;string.h&gt;
  95 #include &lt;unistd.h&gt;
  96 #include &lt;sys/ioctl.h&gt;
  97 #include &lt;sys/ipc.h&gt;
  98 #include &lt;sys/mman.h&gt;
  99 #include &lt;sys/resource.h&gt;
 100 #include &lt;sys/select.h&gt;
 101 #include &lt;sys/shm.h&gt;
 102 #include &lt;sys/socket.h&gt;
 103 #include &lt;sys/stat.h&gt;
 104 #include &lt;sys/sysinfo.h&gt;
 105 #include &lt;sys/systemcfg.h&gt;
 106 #include &lt;sys/time.h&gt;
 107 #include &lt;sys/times.h&gt;
 108 #include &lt;sys/types.h&gt;
 109 #include &lt;sys/utsname.h&gt;
 110 #include &lt;sys/vminfo.h&gt;
 111 #include &lt;sys/wait.h&gt;
 112 
 113 // Missing prototypes for various system APIs.
 114 extern &quot;C&quot;
 115 int mread_real_time(timebasestruct_t *t, size_t size_of_timebasestruct_t);
 116 
 117 #if !defined(_AIXVERSION_610)
 118 extern &quot;C&quot; int getthrds64(pid_t, struct thrdentry64*, int, tid64_t*, int);
 119 extern &quot;C&quot; int getprocs64(procentry64*, int, fdsinfo*, int, pid_t*, int);
 120 extern &quot;C&quot; int getargs(procsinfo*, int, char*, int);
 121 #endif
 122 
 123 #define MAX_PATH (2 * K)
 124 
 125 // for timer info max values which include all bits
 126 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 127 // for multipage initialization error analysis (in &#39;g_multipage_error&#39;)
 128 #define ERROR_MP_OS_TOO_OLD                          100
 129 #define ERROR_MP_EXTSHM_ACTIVE                       101
 130 #define ERROR_MP_VMGETINFO_FAILED                    102
 131 #define ERROR_MP_VMGETINFO_CLAIMS_NO_SUPPORT_FOR_64K 103
 132 
 133 // excerpts from systemcfg.h that might be missing on older os levels
 134 #ifndef PV_5_Compat
 135   #define PV_5_Compat 0x0F8000   /* Power PC 5 */
 136 #endif
 137 #ifndef PV_6
 138   #define PV_6 0x100000          /* Power PC 6 */
 139 #endif
 140 #ifndef PV_6_1
 141   #define PV_6_1 0x100001        /* Power PC 6 DD1.x */
 142 #endif
 143 #ifndef PV_6_Compat
 144   #define PV_6_Compat 0x108000   /* Power PC 6 */
 145 #endif
 146 #ifndef PV_7
 147   #define PV_7 0x200000          /* Power PC 7 */
 148 #endif
 149 #ifndef PV_7_Compat
 150   #define PV_7_Compat 0x208000   /* Power PC 7 */
 151 #endif
 152 #ifndef PV_8
 153   #define PV_8 0x300000          /* Power PC 8 */
 154 #endif
 155 #ifndef PV_8_Compat
 156   #define PV_8_Compat 0x308000   /* Power PC 8 */
 157 #endif
 158 
 159 static address resolve_function_descriptor_to_code_pointer(address p);
 160 
 161 static void vmembk_print_on(outputStream* os);
 162 
 163 ////////////////////////////////////////////////////////////////////////////////
 164 // global variables (for a description see os_aix.hpp)
 165 
 166 julong    os::Aix::_physical_memory = 0;
 167 
 168 pthread_t os::Aix::_main_thread = ((pthread_t)0);
 169 int       os::Aix::_page_size = -1;
 170 
 171 // -1 = uninitialized, 0 if AIX, 1 if OS/400 pase
 172 int       os::Aix::_on_pase = -1;
 173 
 174 // 0 = uninitialized, otherwise 32 bit number:
 175 //  0xVVRRTTSS
 176 //  VV - major version
 177 //  RR - minor version
 178 //  TT - tech level, if known, 0 otherwise
 179 //  SS - service pack, if known, 0 otherwise
 180 uint32_t  os::Aix::_os_version = 0;
 181 
 182 // -1 = uninitialized, 0 - no, 1 - yes
 183 int       os::Aix::_xpg_sus_mode = -1;
 184 
 185 // -1 = uninitialized, 0 - no, 1 - yes
 186 int       os::Aix::_extshm = -1;
 187 
 188 ////////////////////////////////////////////////////////////////////////////////
 189 // local variables
 190 
 191 static volatile jlong max_real_time = 0;
 192 static jlong    initial_time_count = 0;
 193 static int      clock_tics_per_sec = 100;
 194 static sigset_t check_signal_done;         // For diagnostics to print a message once (see run_periodic_checks)
 195 static bool     check_signals      = true;
 196 static int      SR_signum          = SIGUSR2; // Signal used to suspend/resume a thread (must be &gt; SIGSEGV, see 4355769)
 197 static sigset_t SR_sigset;
 198 
 199 // Process break recorded at startup.
 200 static address g_brk_at_startup = NULL;
 201 
 202 // This describes the state of multipage support of the underlying
 203 // OS. Note that this is of no interest to the outsize world and
 204 // therefore should not be defined in AIX class.
 205 //
 206 // AIX supports four different page sizes - 4K, 64K, 16MB, 16GB. The
 207 // latter two (16M &quot;large&quot; resp. 16G &quot;huge&quot; pages) require special
 208 // setup and are normally not available.
 209 //
 210 // AIX supports multiple page sizes per process, for:
 211 //  - Stack (of the primordial thread, so not relevant for us)
 212 //  - Data - data, bss, heap, for us also pthread stacks
 213 //  - Text - text code
 214 //  - shared memory
 215 //
 216 // Default page sizes can be set via linker options (-bdatapsize, -bstacksize, ...)
 217 // and via environment variable LDR_CNTRL (DATAPSIZE, STACKPSIZE, ...).
 218 //
 219 // For shared memory, page size can be set dynamically via
 220 // shmctl(). Different shared memory regions can have different page
 221 // sizes.
 222 //
 223 // More information can be found at AIBM info center:
 224 //   http://publib.boulder.ibm.com/infocenter/aix/v6r1/index.jsp?topic=/com.ibm.aix.prftungd/doc/prftungd/multiple_page_size_app_support.htm
 225 //
 226 static struct {
 227   size_t pagesize;            // sysconf _SC_PAGESIZE (4K)
 228   size_t datapsize;           // default data page size (LDR_CNTRL DATAPSIZE)
 229   size_t shmpsize;            // default shared memory page size (LDR_CNTRL SHMPSIZE)
 230   size_t pthr_stack_pagesize; // stack page size of pthread threads
 231   size_t textpsize;           // default text page size (LDR_CNTRL STACKPSIZE)
 232   bool can_use_64K_pages;     // True if we can alloc 64K pages dynamically with Sys V shm.
 233   bool can_use_16M_pages;     // True if we can alloc 16M pages dynamically with Sys V shm.
 234   int error;                  // Error describing if something went wrong at multipage init.
 235 } g_multipage_support = {
 236   (size_t) -1,
 237   (size_t) -1,
 238   (size_t) -1,
 239   (size_t) -1,
 240   (size_t) -1,
 241   false, false,
 242   0
 243 };
 244 
 245 // We must not accidentally allocate memory close to the BRK - even if
 246 // that would work - because then we prevent the BRK segment from
 247 // growing which may result in a malloc OOM even though there is
 248 // enough memory. The problem only arises if we shmat() or mmap() at
 249 // a specific wish address, e.g. to place the heap in a
 250 // compressed-oops-friendly way.
 251 static bool is_close_to_brk(address a) {
 252   assert0(g_brk_at_startup != NULL);
 253   if (a &gt;= g_brk_at_startup &amp;&amp;
 254       a &lt; (g_brk_at_startup + MaxExpectedDataSegmentSize)) {
 255     return true;
 256   }
 257   return false;
 258 }
 259 
 260 julong os::available_memory() {
 261   return Aix::available_memory();
 262 }
 263 
 264 julong os::Aix::available_memory() {
 265   // Avoid expensive API call here, as returned value will always be null.
 266   if (os::Aix::on_pase()) {
 267     return 0x0LL;
 268   }
 269   os::Aix::meminfo_t mi;
 270   if (os::Aix::get_meminfo(&amp;mi)) {
 271     return mi.real_free;
 272   } else {
 273     return ULONG_MAX;
 274   }
 275 }
 276 
 277 julong os::physical_memory() {
 278   return Aix::physical_memory();
 279 }
 280 
 281 // Return true if user is running as root.
 282 
 283 bool os::have_special_privileges() {
 284   static bool init = false;
 285   static bool privileges = false;
 286   if (!init) {
 287     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 288     init = true;
 289   }
 290   return privileges;
 291 }
 292 
 293 // Helper function, emulates disclaim64 using multiple 32bit disclaims
 294 // because we cannot use disclaim64() on AS/400 and old AIX releases.
 295 static bool my_disclaim64(char* addr, size_t size) {
 296 
 297   if (size == 0) {
 298     return true;
 299   }
 300 
 301   // Maximum size 32bit disclaim() accepts. (Theoretically 4GB, but I just do not trust that.)
 302   const unsigned int maxDisclaimSize = 0x40000000;
 303 
 304   const unsigned int numFullDisclaimsNeeded = (size / maxDisclaimSize);
 305   const unsigned int lastDisclaimSize = (size % maxDisclaimSize);
 306 
 307   char* p = addr;
 308 
 309   for (int i = 0; i &lt; numFullDisclaimsNeeded; i ++) {
 310     if (::disclaim(p, maxDisclaimSize, DISCLAIM_ZEROMEM) != 0) {
 311       trcVerbose(&quot;Cannot disclaim %p - %p (errno %d)\n&quot;, p, p + maxDisclaimSize, errno);
 312       return false;
 313     }
 314     p += maxDisclaimSize;
 315   }
 316 
 317   if (lastDisclaimSize &gt; 0) {
 318     if (::disclaim(p, lastDisclaimSize, DISCLAIM_ZEROMEM) != 0) {
 319       trcVerbose(&quot;Cannot disclaim %p - %p (errno %d)\n&quot;, p, p + lastDisclaimSize, errno);
 320       return false;
 321     }
 322   }
 323 
 324   return true;
 325 }
 326 
 327 // Cpu architecture string
 328 #if defined(PPC32)
 329 static char cpu_arch[] = &quot;ppc&quot;;
 330 #elif defined(PPC64)
 331 static char cpu_arch[] = &quot;ppc64&quot;;
 332 #else
 333 #error Add appropriate cpu_arch setting
 334 #endif
 335 
 336 // Wrap the function &quot;vmgetinfo&quot; which is not available on older OS releases.
 337 static int checked_vmgetinfo(void *out, int command, int arg) {
 338   if (os::Aix::on_pase() &amp;&amp; os::Aix::os_version_short() &lt; 0x0601) {
 339     guarantee(false, &quot;cannot call vmgetinfo on AS/400 older than V6R1&quot;);
 340   }
 341   return ::vmgetinfo(out, command, arg);
 342 }
 343 
 344 // Given an address, returns the size of the page backing that address.
 345 size_t os::Aix::query_pagesize(void* addr) {
 346 
 347   if (os::Aix::on_pase() &amp;&amp; os::Aix::os_version_short() &lt; 0x0601) {
 348     // AS/400 older than V6R1: no vmgetinfo here, default to 4K
 349     return 4*K;
 350   }
 351 
 352   vm_page_info pi;
 353   pi.addr = (uint64_t)addr;
 354   if (checked_vmgetinfo(&amp;pi, VM_PAGE_INFO, sizeof(pi)) == 0) {
 355     return pi.pagesize;
 356   } else {
 357     assert(false, &quot;vmgetinfo failed to retrieve page size&quot;);
 358     return 4*K;
 359   }
 360 }
 361 
 362 void os::Aix::initialize_system_info() {
 363 
 364   // Get the number of online(logical) cpus instead of configured.
 365   os::_processor_count = sysconf(_SC_NPROCESSORS_ONLN);
 366   assert(_processor_count &gt; 0, &quot;_processor_count must be &gt; 0&quot;);
 367 
 368   // Retrieve total physical storage.
 369   os::Aix::meminfo_t mi;
 370   if (!os::Aix::get_meminfo(&amp;mi)) {
 371     assert(false, &quot;os::Aix::get_meminfo failed.&quot;);
 372   }
 373   _physical_memory = (julong) mi.real_total;
 374 }
 375 
 376 // Helper function for tracing page sizes.
 377 static const char* describe_pagesize(size_t pagesize) {
 378   switch (pagesize) {
 379     case 4*K : return &quot;4K&quot;;
 380     case 64*K: return &quot;64K&quot;;
 381     case 16*M: return &quot;16M&quot;;
 382     case 16*G: return &quot;16G&quot;;
 383     default:
 384       assert(false, &quot;surprise&quot;);
 385       return &quot;??&quot;;
 386   }
 387 }
 388 
 389 // Probe OS for multipage support.
 390 // Will fill the global g_multipage_support structure.
 391 // Must be called before calling os::large_page_init().
 392 static void query_multipage_support() {
 393 
 394   guarantee(g_multipage_support.pagesize == -1,
 395             &quot;do not call twice&quot;);
 396 
 397   g_multipage_support.pagesize = ::sysconf(_SC_PAGESIZE);
 398 
 399   // This really would surprise me.
 400   assert(g_multipage_support.pagesize == 4*K, &quot;surprise!&quot;);
 401 
 402   // Query default data page size (default page size for C-Heap, pthread stacks and .bss).
 403   // Default data page size is defined either by linker options (-bdatapsize)
 404   // or by environment variable LDR_CNTRL (suboption DATAPSIZE). If none is given,
 405   // default should be 4K.
 406   {
 407     void* p = ::malloc(16*M);
 408     g_multipage_support.datapsize = os::Aix::query_pagesize(p);
 409     ::free(p);
 410   }
 411 
 412   // Query default shm page size (LDR_CNTRL SHMPSIZE).
 413   // Note that this is pure curiosity. We do not rely on default page size but set
 414   // our own page size after allocated.
 415   {
 416     const int shmid = ::shmget(IPC_PRIVATE, 1, IPC_CREAT | S_IRUSR | S_IWUSR);
 417     guarantee(shmid != -1, &quot;shmget failed&quot;);
 418     void* p = ::shmat(shmid, NULL, 0);
 419     ::shmctl(shmid, IPC_RMID, NULL);
 420     guarantee(p != (void*) -1, &quot;shmat failed&quot;);
 421     g_multipage_support.shmpsize = os::Aix::query_pagesize(p);
 422     ::shmdt(p);
 423   }
 424 
 425   // Before querying the stack page size, make sure we are not running as primordial
 426   // thread (because primordial thread&#39;s stack may have different page size than
 427   // pthread thread stacks). Running a VM on the primordial thread won&#39;t work for a
 428   // number of reasons so we may just as well guarantee it here.
 429   guarantee0(!os::is_primordial_thread());
 430 
 431   // Query pthread stack page size. Should be the same as data page size because
 432   // pthread stacks are allocated from C-Heap.
 433   {
 434     int dummy = 0;
 435     g_multipage_support.pthr_stack_pagesize = os::Aix::query_pagesize(&amp;dummy);
 436   }
 437 
 438   // Query default text page size (LDR_CNTRL TEXTPSIZE).
 439   {
 440     address any_function =
 441       resolve_function_descriptor_to_code_pointer((address)describe_pagesize);
 442     g_multipage_support.textpsize = os::Aix::query_pagesize(any_function);
 443   }
 444 
 445   // Now probe for support of 64K pages and 16M pages.
 446 
 447   // Before OS/400 V6R1, there is no support for pages other than 4K.
 448   if (os::Aix::on_pase_V5R4_or_older()) {
 449     trcVerbose(&quot;OS/400 &lt; V6R1 - no large page support.&quot;);
 450     g_multipage_support.error = ERROR_MP_OS_TOO_OLD;
 451     goto query_multipage_support_end;
 452   }
 453 
 454   // Now check which page sizes the OS claims it supports, and of those, which actually can be used.
 455   {
 456     const int MAX_PAGE_SIZES = 4;
 457     psize_t sizes[MAX_PAGE_SIZES];
 458     const int num_psizes = checked_vmgetinfo(sizes, VMINFO_GETPSIZES, MAX_PAGE_SIZES);
 459     if (num_psizes == -1) {
 460       trcVerbose(&quot;vmgetinfo(VMINFO_GETPSIZES) failed (errno: %d)&quot;, errno);
 461       trcVerbose(&quot;disabling multipage support.&quot;);
 462       g_multipage_support.error = ERROR_MP_VMGETINFO_FAILED;
 463       goto query_multipage_support_end;
 464     }
 465     guarantee(num_psizes &gt; 0, &quot;vmgetinfo(.., VMINFO_GETPSIZES, ...) failed.&quot;);
 466     assert(num_psizes &lt;= MAX_PAGE_SIZES, &quot;Surprise! more than 4 page sizes?&quot;);
 467     trcVerbose(&quot;vmgetinfo(.., VMINFO_GETPSIZES, ...) returns %d supported page sizes: &quot;, num_psizes);
 468     for (int i = 0; i &lt; num_psizes; i ++) {
 469       trcVerbose(&quot; %s &quot;, describe_pagesize(sizes[i]));
 470     }
 471 
 472     // Can we use 64K, 16M pages?
 473     for (int i = 0; i &lt; num_psizes; i ++) {
 474       const size_t pagesize = sizes[i];
 475       if (pagesize != 64*K &amp;&amp; pagesize != 16*M) {
 476         continue;
 477       }
 478       bool can_use = false;
 479       trcVerbose(&quot;Probing support for %s pages...&quot;, describe_pagesize(pagesize));
 480       const int shmid = ::shmget(IPC_PRIVATE, pagesize,
 481         IPC_CREAT | S_IRUSR | S_IWUSR);
 482       guarantee0(shmid != -1); // Should always work.
 483       // Try to set pagesize.
 484       struct shmid_ds shm_buf = { 0 };
 485       shm_buf.shm_pagesize = pagesize;
 486       if (::shmctl(shmid, SHM_PAGESIZE, &amp;shm_buf) != 0) {
 487         const int en = errno;
 488         ::shmctl(shmid, IPC_RMID, NULL); // As early as possible!
 489         trcVerbose(&quot;shmctl(SHM_PAGESIZE) failed with errno=%n&quot;,
 490           errno);
 491       } else {
 492         // Attach and double check pageisze.
 493         void* p = ::shmat(shmid, NULL, 0);
 494         ::shmctl(shmid, IPC_RMID, NULL); // As early as possible!
 495         guarantee0(p != (void*) -1); // Should always work.
 496         const size_t real_pagesize = os::Aix::query_pagesize(p);
 497         if (real_pagesize != pagesize) {
 498           trcVerbose(&quot;real page size (0x%llX) differs.&quot;, real_pagesize);
 499         } else {
 500           can_use = true;
 501         }
 502         ::shmdt(p);
 503       }
 504       trcVerbose(&quot;Can use: %s&quot;, (can_use ? &quot;yes&quot; : &quot;no&quot;));
 505       if (pagesize == 64*K) {
 506         g_multipage_support.can_use_64K_pages = can_use;
 507       } else if (pagesize == 16*M) {
 508         g_multipage_support.can_use_16M_pages = can_use;
 509       }
 510     }
 511 
 512   } // end: check which pages can be used for shared memory
 513 
 514 query_multipage_support_end:
 515 
 516   trcVerbose(&quot;base page size (sysconf _SC_PAGESIZE): %s&quot;,
 517       describe_pagesize(g_multipage_support.pagesize));
 518   trcVerbose(&quot;Data page size (C-Heap, bss, etc): %s&quot;,
 519       describe_pagesize(g_multipage_support.datapsize));
 520   trcVerbose(&quot;Text page size: %s&quot;,
 521       describe_pagesize(g_multipage_support.textpsize));
 522   trcVerbose(&quot;Thread stack page size (pthread): %s&quot;,
 523       describe_pagesize(g_multipage_support.pthr_stack_pagesize));
 524   trcVerbose(&quot;Default shared memory page size: %s&quot;,
 525       describe_pagesize(g_multipage_support.shmpsize));
 526   trcVerbose(&quot;Can use 64K pages dynamically with shared meory: %s&quot;,
 527       (g_multipage_support.can_use_64K_pages ? &quot;yes&quot; :&quot;no&quot;));
 528   trcVerbose(&quot;Can use 16M pages dynamically with shared memory: %s&quot;,
 529       (g_multipage_support.can_use_16M_pages ? &quot;yes&quot; :&quot;no&quot;));
 530   trcVerbose(&quot;Multipage error details: %d&quot;,
 531       g_multipage_support.error);
 532 
 533   // sanity checks
 534   assert0(g_multipage_support.pagesize == 4*K);
 535   assert0(g_multipage_support.datapsize == 4*K || g_multipage_support.datapsize == 64*K);
 536   assert0(g_multipage_support.textpsize == 4*K || g_multipage_support.textpsize == 64*K);
 537   assert0(g_multipage_support.pthr_stack_pagesize == g_multipage_support.datapsize);
 538   assert0(g_multipage_support.shmpsize == 4*K || g_multipage_support.shmpsize == 64*K);
 539 
 540 }
 541 
 542 void os::init_system_properties_values() {
 543 
 544 #ifndef OVERRIDE_LIBPATH
 545   #define DEFAULT_LIBPATH &quot;/lib:/usr/lib&quot;
 546 #else
 547   #define DEFAULT_LIBPATH OVERRIDE_LIBPATH
 548 #endif
 549 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 550 
 551   // Buffer that fits several sprintfs.
 552   // Note that the space for the trailing null is provided
 553   // by the nulls included by the sizeof operator.
 554   const size_t bufsize =
 555     MAX2((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 556          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR)); // extensions dir
 557   char *buf = (char *)NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 558 
 559   // sysclasspath, java_home, dll_dir
 560   {
 561     char *pslash;
 562     os::jvm_path(buf, bufsize);
 563 
 564     // Found the full path to libjvm.so.
 565     // Now cut the path to &lt;java_home&gt;/jre if we can.
 566     pslash = strrchr(buf, &#39;/&#39;);
 567     if (pslash != NULL) {
 568       *pslash = &#39;\0&#39;;            // Get rid of /libjvm.so.
 569     }
 570     pslash = strrchr(buf, &#39;/&#39;);
 571     if (pslash != NULL) {
 572       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 573     }
 574     Arguments::set_dll_dir(buf);
 575 
 576     if (pslash != NULL) {
 577       pslash = strrchr(buf, &#39;/&#39;);
 578       if (pslash != NULL) {
 579         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 580       }
 581     }
 582     Arguments::set_java_home(buf);
 583     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 584       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 585     }
 586   }
 587 
 588   // Where to look for native libraries.
 589 
 590   // On Aix we get the user setting of LIBPATH.
 591   // Eventually, all the library path setting will be done here.
 592   // Get the user setting of LIBPATH.
 593   const char *v = ::getenv(&quot;LIBPATH&quot;);
 594   const char *v_colon = &quot;:&quot;;
 595   if (v == NULL) { v = &quot;&quot;; v_colon = &quot;&quot;; }
 596 
 597   // Concatenate user and invariant part of ld_library_path.
 598   // That&#39;s +1 for the colon and +1 for the trailing &#39;\0&#39;.
 599   char *ld_library_path = (char *)NEW_C_HEAP_ARRAY(char, strlen(v) + 1 + sizeof(DEFAULT_LIBPATH) + 1, mtInternal);
 600   sprintf(ld_library_path, &quot;%s%s&quot; DEFAULT_LIBPATH, v, v_colon);
 601   Arguments::set_library_path(ld_library_path);
 602   FREE_C_HEAP_ARRAY(char, ld_library_path);
 603 
 604   // Extensions directories.
 605   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR, Arguments::get_java_home());
 606   Arguments::set_ext_dirs(buf);
 607 
 608   FREE_C_HEAP_ARRAY(char, buf);
 609 
 610 #undef DEFAULT_LIBPATH
 611 #undef EXTENSIONS_DIR
 612 }
 613 
 614 ////////////////////////////////////////////////////////////////////////////////
 615 // breakpoint support
 616 
 617 void os::breakpoint() {
 618   BREAKPOINT;
 619 }
 620 
 621 extern &quot;C&quot; void breakpoint() {
 622   // use debugger to set breakpoint here
 623 }
 624 
 625 ////////////////////////////////////////////////////////////////////////////////
 626 // signal support
 627 
 628 debug_only(static bool signal_sets_initialized = false);
 629 static sigset_t unblocked_sigs, vm_sigs;
 630 
 631 void os::Aix::signal_sets_init() {
 632   // Should also have an assertion stating we are still single-threaded.
 633   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 634   // Fill in signals that are necessarily unblocked for all threads in
 635   // the VM. Currently, we unblock the following signals:
 636   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 637   //                         by -Xrs (=ReduceSignalUsage));
 638   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 639   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 640   // the dispositions or masks wrt these signals.
 641   // Programs embedding the VM that want to use the above signals for their
 642   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 643   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 644   // (See bug 4345157, and other related bugs).
 645   // In reality, though, unblocking these signals is really a nop, since
 646   // these signals are not blocked by default.
 647   sigemptyset(&amp;unblocked_sigs);
 648   sigaddset(&amp;unblocked_sigs, SIGILL);
 649   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 650   sigaddset(&amp;unblocked_sigs, SIGBUS);
 651   sigaddset(&amp;unblocked_sigs, SIGFPE);
 652   sigaddset(&amp;unblocked_sigs, SIGTRAP);
 653   sigaddset(&amp;unblocked_sigs, SR_signum);
 654 
 655   if (!ReduceSignalUsage) {
 656    if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 657      sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 658    }
 659    if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 660      sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 661    }
 662    if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 663      sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 664    }
 665   }
 666   // Fill in signals that are blocked by all but the VM thread.
 667   sigemptyset(&amp;vm_sigs);
 668   if (!ReduceSignalUsage)
 669     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 670   debug_only(signal_sets_initialized = true);
 671 }
 672 
 673 // These are signals that are unblocked while a thread is running Java.
 674 // (For some reason, they get blocked by default.)
 675 sigset_t* os::Aix::unblocked_signals() {
 676   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 677   return &amp;unblocked_sigs;
 678 }
 679 
 680 // These are the signals that are blocked while a (non-VM) thread is
 681 // running Java. Only the VM thread handles these signals.
 682 sigset_t* os::Aix::vm_signals() {
 683   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 684   return &amp;vm_sigs;
 685 }
 686 
 687 void os::Aix::hotspot_sigmask(Thread* thread) {
 688 
 689   //Save caller&#39;s signal mask before setting VM signal mask
 690   sigset_t caller_sigmask;
 691   pthread_sigmask(SIG_BLOCK, NULL, &amp;caller_sigmask);
 692 
 693   OSThread* osthread = thread-&gt;osthread();
 694   osthread-&gt;set_caller_sigmask(caller_sigmask);
 695 
 696   pthread_sigmask(SIG_UNBLOCK, os::Aix::unblocked_signals(), NULL);
 697 
 698   if (!ReduceSignalUsage) {
 699     if (thread-&gt;is_VM_thread()) {
 700       // Only the VM thread handles BREAK_SIGNAL ...
 701       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 702     } else {
 703       // ... all other threads block BREAK_SIGNAL
 704       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 705     }
 706   }
 707 }
 708 
 709 // retrieve memory information.
 710 // Returns false if something went wrong;
 711 // content of pmi undefined in this case.
 712 bool os::Aix::get_meminfo(meminfo_t* pmi) {
 713 
 714   assert(pmi, &quot;get_meminfo: invalid parameter&quot;);
 715 
 716   memset(pmi, 0, sizeof(meminfo_t));
 717 
 718   if (os::Aix::on_pase()) {
 719     // On PASE, use the libo4 porting library.
 720 
 721     unsigned long long virt_total = 0;
 722     unsigned long long real_total = 0;
 723     unsigned long long real_free = 0;
 724     unsigned long long pgsp_total = 0;
 725     unsigned long long pgsp_free = 0;
 726     if (libo4::get_memory_info(&amp;virt_total, &amp;real_total, &amp;real_free, &amp;pgsp_total, &amp;pgsp_free)) {
 727       pmi-&gt;virt_total = virt_total;
 728       pmi-&gt;real_total = real_total;
 729       pmi-&gt;real_free = real_free;
 730       pmi-&gt;pgsp_total = pgsp_total;
 731       pmi-&gt;pgsp_free = pgsp_free;
 732       return true;
 733     }
 734     return false;
 735 
 736   } else {
 737 
 738     // On AIX, I use the (dynamically loaded) perfstat library to retrieve memory statistics
 739     // See:
 740     // http://publib.boulder.ibm.com/infocenter/systems/index.jsp
 741     //        ?topic=/com.ibm.aix.basetechref/doc/basetrf1/perfstat_memtot.htm
 742     // http://publib.boulder.ibm.com/infocenter/systems/index.jsp
 743     //        ?topic=/com.ibm.aix.files/doc/aixfiles/libperfstat.h.htm
 744 
 745     perfstat_memory_total_t psmt;
 746     memset (&amp;psmt, &#39;\0&#39;, sizeof(psmt));
 747     const int rc = libperfstat::perfstat_memory_total(NULL, &amp;psmt, sizeof(psmt), 1);
 748     if (rc == -1) {
 749       trcVerbose(&quot;perfstat_memory_total() failed (errno=%d)&quot;, errno);
 750       assert(0, &quot;perfstat_memory_total() failed&quot;);
 751       return false;
 752     }
 753 
 754     assert(rc == 1, &quot;perfstat_memory_total() - weird return code&quot;);
 755 
 756     // excerpt from
 757     // http://publib.boulder.ibm.com/infocenter/systems/index.jsp
 758     //        ?topic=/com.ibm.aix.files/doc/aixfiles/libperfstat.h.htm
 759     // The fields of perfstat_memory_total_t:
 760     // u_longlong_t virt_total         Total virtual memory (in 4 KB pages).
 761     // u_longlong_t real_total         Total real memory (in 4 KB pages).
 762     // u_longlong_t real_free          Free real memory (in 4 KB pages).
 763     // u_longlong_t pgsp_total         Total paging space (in 4 KB pages).
 764     // u_longlong_t pgsp_free          Free paging space (in 4 KB pages).
 765 
 766     pmi-&gt;virt_total = psmt.virt_total * 4096;
 767     pmi-&gt;real_total = psmt.real_total * 4096;
 768     pmi-&gt;real_free = psmt.real_free * 4096;
 769     pmi-&gt;pgsp_total = psmt.pgsp_total * 4096;
 770     pmi-&gt;pgsp_free = psmt.pgsp_free * 4096;
 771 
 772     return true;
 773 
 774   }
 775 } // end os::Aix::get_meminfo
 776 
 777 //////////////////////////////////////////////////////////////////////////////
 778 // create new thread
 779 
 780 // Thread start routine for all newly created threads
 781 static void *thread_native_entry(Thread *thread) {
 782 
 783   thread-&gt;record_stack_base_and_size();
 784 
 785   const pthread_t pthread_id = ::pthread_self();
 786   const tid_t kernel_thread_id = ::thread_self();
 787 
 788   LogTarget(Info, os, thread) lt;
 789   if (lt.is_enabled()) {
 790     address low_address = thread-&gt;stack_end();
 791     address high_address = thread-&gt;stack_base();
 792     lt.print(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;, kernel thread id: &quot; UINTX_FORMAT
 793              &quot;, stack [&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot; (&quot; SIZE_FORMAT &quot;k using %uk pages)).&quot;,
 794              os::current_thread_id(), (uintx) kernel_thread_id, low_address, high_address,
 795              (high_address - low_address) / K, os::Aix::query_pagesize(low_address) / K);
 796   }
 797 
 798   // Normally, pthread stacks on AIX live in the data segment (are allocated with malloc()
 799   // by the pthread library). In rare cases, this may not be the case, e.g. when third-party
 800   // tools hook pthread_create(). In this case, we may run into problems establishing
 801   // guard pages on those stacks, because the stacks may reside in memory which is not
 802   // protectable (shmated).
 803   if (thread-&gt;stack_base() &gt; ::sbrk(0)) {
 804     log_warning(os, thread)(&quot;Thread stack not in data segment.&quot;);
 805   }
 806 
 807   // Try to randomize the cache line index of hot stack frames.
 808   // This helps when threads of the same stack traces evict each other&#39;s
 809   // cache lines. The threads can be either from the same JVM instance, or
 810   // from different JVM instances. The benefit is especially true for
 811   // processors with hyperthreading technology.
 812 
 813   static int counter = 0;
 814   int pid = os::current_process_id();
 815   alloca(((pid ^ counter++) &amp; 7) * 128);
 816 
 817   thread-&gt;initialize_thread_current();
 818 
 819   OSThread* osthread = thread-&gt;osthread();
 820 
 821   // Thread_id is pthread id.
 822   osthread-&gt;set_thread_id(pthread_id);
 823 
 824   // .. but keep kernel thread id too for diagnostics
 825   osthread-&gt;set_kernel_thread_id(kernel_thread_id);
 826 
 827   // Initialize signal mask for this thread.
 828   os::Aix::hotspot_sigmask(thread);
 829 
 830   // Initialize floating point control register.
 831   os::Aix::init_thread_fpu_state();
 832 
 833   assert(osthread-&gt;get_state() == RUNNABLE, &quot;invalid os thread state&quot;);
 834 
 835   // Call one more level start routine.
 836   thread-&gt;call_run();
 837 
 838   // Note: at this point the thread object may already have deleted itself.
 839   // Prevent dereferencing it from here on out.
 840   thread = NULL;
 841 
 842   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;, kernel thread id: &quot; UINTX_FORMAT &quot;).&quot;,
 843     os::current_thread_id(), (uintx) kernel_thread_id);
 844 
 845   return 0;
 846 }
 847 
 848 bool os::create_thread(Thread* thread, ThreadType thr_type,
 849                        size_t req_stack_size) {
 850 
 851   assert(thread-&gt;osthread() == NULL, &quot;caller responsible&quot;);
 852 
 853   // Allocate the OSThread object.
 854   OSThread* osthread = new OSThread(NULL, NULL);
 855   if (osthread == NULL) {
 856     return false;
 857   }
 858 
 859   // Set the correct thread state.
 860   osthread-&gt;set_thread_type(thr_type);
 861 
 862   // Initial state is ALLOCATED but not INITIALIZED
 863   osthread-&gt;set_state(ALLOCATED);
 864 
 865   thread-&gt;set_osthread(osthread);
 866 
 867   // Init thread attributes.
 868   pthread_attr_t attr;
 869   pthread_attr_init(&amp;attr);
 870   guarantee(pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED) == 0, &quot;???&quot;);
 871 
 872   // Make sure we run in 1:1 kernel-user-thread mode.
 873   if (os::Aix::on_aix()) {
 874     guarantee(pthread_attr_setscope(&amp;attr, PTHREAD_SCOPE_SYSTEM) == 0, &quot;???&quot;);
 875     guarantee(pthread_attr_setinheritsched(&amp;attr, PTHREAD_EXPLICIT_SCHED) == 0, &quot;???&quot;);
 876   }
 877 
 878   // Start in suspended state, and in os::thread_start, wake the thread up.
 879   guarantee(pthread_attr_setsuspendstate_np(&amp;attr, PTHREAD_CREATE_SUSPENDED_NP) == 0, &quot;???&quot;);
 880 
 881   // Calculate stack size if it&#39;s not specified by caller.
 882   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 883 
 884   // JDK-8187028: It was observed that on some configurations (4K backed thread stacks)
 885   // the real thread stack size may be smaller than the requested stack size, by as much as 64K.
 886   // This very much looks like a pthread lib error. As a workaround, increase the stack size
 887   // by 64K for small thread stacks (arbitrarily choosen to be &lt; 4MB)
 888   if (stack_size &lt; 4096 * K) {
 889     stack_size += 64 * K;
 890   }
 891 
 892   // On Aix, pthread_attr_setstacksize fails with huge values and leaves the
 893   // thread size in attr unchanged. If this is the minimal stack size as set
 894   // by pthread_attr_init this leads to crashes after thread creation. E.g. the
 895   // guard pages might not fit on the tiny stack created.
 896   int ret = pthread_attr_setstacksize(&amp;attr, stack_size);
 897   if (ret != 0) {
 898     log_warning(os, thread)(&quot;The %sthread stack size specified is invalid: &quot; SIZE_FORMAT &quot;k&quot;,
 899                             (thr_type == compiler_thread) ? &quot;compiler &quot; : ((thr_type == java_thread) ? &quot;&quot; : &quot;VM &quot;),
 900                             stack_size / K);
 901     thread-&gt;set_osthread(NULL);
 902     delete osthread;
 903     return false;
 904   }
 905 
 906   // Save some cycles and a page by disabling OS guard pages where we have our own
 907   // VM guard pages (in java threads). For other threads, keep system default guard
 908   // pages in place.
 909   if (thr_type == java_thread || thr_type == compiler_thread) {
 910     ret = pthread_attr_setguardsize(&amp;attr, 0);
 911   }
 912 
 913   pthread_t tid = 0;
 914   if (ret == 0) {
 915     ret = pthread_create(&amp;tid, &amp;attr, (void* (*)(void*)) thread_native_entry, thread);
 916   }
 917 
 918   if (ret == 0) {
 919     char buf[64];
 920     log_info(os, thread)(&quot;Thread started (pthread id: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 921       (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 922   } else {
 923     char buf[64];
 924     log_warning(os, thread)(&quot;Failed to start thread - pthread_create failed (%d=%s) for attributes: %s.&quot;,
 925       ret, os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 926   }
 927 
 928   pthread_attr_destroy(&amp;attr);
 929 
 930   if (ret != 0) {
 931     // Need to clean up stuff we&#39;ve allocated so far.
 932     thread-&gt;set_osthread(NULL);
 933     delete osthread;
 934     return false;
 935   }
 936 
 937   // OSThread::thread_id is the pthread id.
 938   osthread-&gt;set_thread_id(tid);
 939 
 940   return true;
 941 }
 942 
 943 /////////////////////////////////////////////////////////////////////////////
 944 // attach existing thread
 945 
 946 // bootstrap the main thread
 947 bool os::create_main_thread(JavaThread* thread) {
 948   assert(os::Aix::_main_thread == pthread_self(), &quot;should be called inside main thread&quot;);
 949   return create_attached_thread(thread);
 950 }
 951 
 952 bool os::create_attached_thread(JavaThread* thread) {
 953 #ifdef ASSERT
 954     thread-&gt;verify_not_published();
 955 #endif
 956 
 957   // Allocate the OSThread object
 958   OSThread* osthread = new OSThread(NULL, NULL);
 959 
 960   if (osthread == NULL) {
 961     return false;
 962   }
 963 
 964   const pthread_t pthread_id = ::pthread_self();
 965   const tid_t kernel_thread_id = ::thread_self();
 966 
 967   // OSThread::thread_id is the pthread id.
 968   osthread-&gt;set_thread_id(pthread_id);
 969 
 970   // .. but keep kernel thread id too for diagnostics
 971   osthread-&gt;set_kernel_thread_id(kernel_thread_id);
 972 
 973   // initialize floating point control register
 974   os::Aix::init_thread_fpu_state();
 975 
 976   // Initial thread state is RUNNABLE
 977   osthread-&gt;set_state(RUNNABLE);
 978 
 979   thread-&gt;set_osthread(osthread);
 980 
 981   if (UseNUMA) {
 982     int lgrp_id = os::numa_get_group_id();
 983     if (lgrp_id != -1) {
 984       thread-&gt;set_lgrp_id(lgrp_id);
 985     }
 986   }
 987 
 988   // initialize signal mask for this thread
 989   // and save the caller&#39;s signal mask
 990   os::Aix::hotspot_sigmask(thread);
 991 
 992   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;, kernel thread id: &quot; UINTX_FORMAT &quot;).&quot;,
 993     os::current_thread_id(), (uintx) kernel_thread_id);
 994 
 995   return true;
 996 }
 997 
 998 void os::pd_start_thread(Thread* thread) {
 999   int status = pthread_continue_np(thread-&gt;osthread()-&gt;pthread_id());
1000   assert(status == 0, &quot;thr_continue failed&quot;);
1001 }
1002 
1003 // Free OS resources related to the OSThread
1004 void os::free_thread(OSThread* osthread) {
1005   assert(osthread != NULL, &quot;osthread not set&quot;);
1006 
1007   // We are told to free resources of the argument thread,
1008   // but we can only really operate on the current thread.
1009   assert(Thread::current()-&gt;osthread() == osthread,
1010          &quot;os::free_thread but not current thread&quot;);
1011 
1012   // Restore caller&#39;s signal mask
1013   sigset_t sigmask = osthread-&gt;caller_sigmask();
1014   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
1015 
1016   delete osthread;
1017 }
1018 
1019 ////////////////////////////////////////////////////////////////////////////////
1020 // time support
1021 
1022 // Time since start-up in seconds to a fine granularity.
1023 // Used by VMSelfDestructTimer and the MemProfiler.
1024 double os::elapsedTime() {
1025   return (double)(os::elapsed_counter()) * 0.000001;
1026 }
1027 
1028 jlong os::elapsed_counter() {
1029   timeval time;
1030   int status = gettimeofday(&amp;time, NULL);
1031   return jlong(time.tv_sec) * 1000 * 1000 + jlong(time.tv_usec) - initial_time_count;
1032 }
1033 
1034 jlong os::elapsed_frequency() {
1035   return (1000 * 1000);
1036 }
1037 
1038 bool os::supports_vtime() { return true; }
1039 bool os::enable_vtime()   { return false; }
1040 bool os::vtime_enabled()  { return false; }
1041 
1042 double os::elapsedVTime() {
1043   struct rusage usage;
1044   int retval = getrusage(RUSAGE_THREAD, &amp;usage);
1045   if (retval == 0) {
1046     return usage.ru_utime.tv_sec + usage.ru_stime.tv_sec + (usage.ru_utime.tv_usec + usage.ru_stime.tv_usec) / (1000.0 * 1000);
1047   } else {
1048     // better than nothing, but not much
1049     return elapsedTime();
1050   }
1051 }
1052 
1053 jlong os::javaTimeMillis() {
1054   timeval time;
1055   int status = gettimeofday(&amp;time, NULL);
1056   assert(status != -1, &quot;aix error at gettimeofday()&quot;);
1057   return jlong(time.tv_sec) * 1000 + jlong(time.tv_usec / 1000);
1058 }
1059 
1060 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1061   timeval time;
1062   int status = gettimeofday(&amp;time, NULL);
1063   assert(status != -1, &quot;aix error at gettimeofday()&quot;);
1064   seconds = jlong(time.tv_sec);
1065   nanos = jlong(time.tv_usec) * 1000;
1066 }
1067 
1068 // We use mread_real_time here.
1069 // On AIX: If the CPU has a time register, the result will be RTC_POWER and
1070 // it has to be converted to real time. AIX documentations suggests to do
1071 // this unconditionally, so we do it.
1072 //
1073 // See: https://www.ibm.com/support/knowledgecenter/ssw_aix_61/com.ibm.aix.basetrf2/read_real_time.htm
1074 //
1075 // On PASE: mread_real_time will always return RTC_POWER_PC data, so no
1076 // conversion is necessary. However, mread_real_time will not return
1077 // monotonic results but merely matches read_real_time. So we need a tweak
1078 // to ensure monotonic results.
1079 //
1080 // For PASE no public documentation exists, just word by IBM
1081 jlong os::javaTimeNanos() {
1082   timebasestruct_t time;
1083   int rc = mread_real_time(&amp;time, TIMEBASE_SZ);
1084   if (os::Aix::on_pase()) {
1085     assert(rc == RTC_POWER, &quot;expected time format RTC_POWER from mread_real_time in PASE&quot;);
1086     jlong now = jlong(time.tb_high) * NANOSECS_PER_SEC + jlong(time.tb_low);
1087     jlong prev = max_real_time;
1088     if (now &lt;= prev) {
1089       return prev;   // same or retrograde time;
1090     }
1091     jlong obsv = Atomic::cmpxchg(now, &amp;max_real_time, prev);
1092     assert(obsv &gt;= prev, &quot;invariant&quot;);   // Monotonicity
1093     // If the CAS succeeded then we&#39;re done and return &quot;now&quot;.
1094     // If the CAS failed and the observed value &quot;obsv&quot; is &gt;= now then
1095     // we should return &quot;obsv&quot;.  If the CAS failed and now &gt; obsv &gt; prv then
1096     // some other thread raced this thread and installed a new value, in which case
1097     // we could either (a) retry the entire operation, (b) retry trying to install now
1098     // or (c) just return obsv.  We use (c).   No loop is required although in some cases
1099     // we might discard a higher &quot;now&quot; value in deference to a slightly lower but freshly
1100     // installed obsv value.   That&#39;s entirely benign -- it admits no new orderings compared
1101     // to (a) or (b) -- and greatly reduces coherence traffic.
1102     // We might also condition (c) on the magnitude of the delta between obsv and now.
1103     // Avoiding excessive CAS operations to hot RW locations is critical.
1104     // See https://blogs.oracle.com/dave/entry/cas_and_cache_trivia_invalidate
1105     return (prev == obsv) ? now : obsv;
1106   } else {
1107     if (rc != RTC_POWER) {
1108       rc = time_base_to_time(&amp;time, TIMEBASE_SZ);
1109       assert(rc != -1, &quot;error calling time_base_to_time()&quot;);
1110     }
1111     return jlong(time.tb_high) * NANOSECS_PER_SEC + jlong(time.tb_low);
1112   }
1113 }
1114 
1115 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1116   info_ptr-&gt;max_value = ALL_64_BITS;
1117   // mread_real_time() is monotonic (see &#39;os::javaTimeNanos()&#39;)
1118   info_ptr-&gt;may_skip_backward = false;
1119   info_ptr-&gt;may_skip_forward = false;
1120   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;    // elapsed not CPU time
1121 }
1122 
1123 // Return the real, user, and system times in seconds from an
1124 // arbitrary fixed point in the past.
1125 bool os::getTimesSecs(double* process_real_time,
1126                       double* process_user_time,
1127                       double* process_system_time) {
1128   struct tms ticks;
1129   clock_t real_ticks = times(&amp;ticks);
1130 
1131   if (real_ticks == (clock_t) (-1)) {
1132     return false;
1133   } else {
1134     double ticks_per_second = (double) clock_tics_per_sec;
1135     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1136     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1137     *process_real_time = ((double) real_ticks) / ticks_per_second;
1138 
1139     return true;
1140   }
1141 }
1142 
1143 char * os::local_time_string(char *buf, size_t buflen) {
1144   struct tm t;
1145   time_t long_time;
1146   time(&amp;long_time);
1147   localtime_r(&amp;long_time, &amp;t);
1148   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1149                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1150                t.tm_hour, t.tm_min, t.tm_sec);
1151   return buf;
1152 }
1153 
1154 struct tm* os::localtime_pd(const time_t* clock, struct tm* res) {
1155   return localtime_r(clock, res);
1156 }
1157 
1158 ////////////////////////////////////////////////////////////////////////////////
1159 // runtime exit support
1160 
1161 // Note: os::shutdown() might be called very early during initialization, or
1162 // called from signal handler. Before adding something to os::shutdown(), make
1163 // sure it is async-safe and can handle partially initialized VM.
1164 void os::shutdown() {
1165 
1166   // allow PerfMemory to attempt cleanup of any persistent resources
1167   perfMemory_exit();
1168 
1169   // needs to remove object in file system
1170   AttachListener::abort();
1171 
1172   // flush buffered output, finish log files
1173   ostream_abort();
1174 
1175   // Check for abort hook
1176   abort_hook_t abort_hook = Arguments::abort_hook();
1177   if (abort_hook != NULL) {
1178     abort_hook();
1179   }
1180 }
1181 
1182 // Note: os::abort() might be called very early during initialization, or
1183 // called from signal handler. Before adding something to os::abort(), make
1184 // sure it is async-safe and can handle partially initialized VM.
1185 void os::abort(bool dump_core, void* siginfo, const void* context) {
1186   os::shutdown();
1187   if (dump_core) {
1188 #ifndef PRODUCT
1189     fdStream out(defaultStream::output_fd());
1190     out.print_raw(&quot;Current thread is &quot;);
1191     char buf[16];
1192     jio_snprintf(buf, sizeof(buf), UINTX_FORMAT, os::current_thread_id());
1193     out.print_raw_cr(buf);
1194     out.print_raw_cr(&quot;Dumping core ...&quot;);
1195 #endif
1196     ::abort(); // dump core
1197   }
1198 
1199   ::exit(1);
1200 }
1201 
1202 // Die immediately, no exit hook, no abort hook, no cleanup.
1203 void os::die() {
1204   ::abort();
1205 }
1206 
1207 intx os::current_thread_id() {
1208   return (intx)pthread_self();
1209 }
1210 
1211 int os::current_process_id() {
1212   return getpid();
1213 }
1214 
1215 // DLL functions
1216 
1217 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1218 
1219 // This must be hard coded because it&#39;s the system&#39;s temporary
1220 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1221 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1222 
1223 // Check if addr is inside libjvm.so.
1224 bool os::address_is_in_vm(address addr) {
1225 
1226   // Input could be a real pc or a function pointer literal. The latter
1227   // would be a function descriptor residing in the data segment of a module.
1228   loaded_module_t lm;
1229   if (LoadedLibraries::find_for_text_address(addr, &amp;lm) != NULL) {
1230     return lm.is_in_vm;
1231   } else if (LoadedLibraries::find_for_data_address(addr, &amp;lm) != NULL) {
1232     return lm.is_in_vm;
1233   } else {
1234     return false;
1235   }
1236 
1237 }
1238 
1239 // Resolve an AIX function descriptor literal to a code pointer.
1240 // If the input is a valid code pointer to a text segment of a loaded module,
1241 //   it is returned unchanged.
1242 // If the input is a valid AIX function descriptor, it is resolved to the
1243 //   code entry point.
1244 // If the input is neither a valid function descriptor nor a valid code pointer,
1245 //   NULL is returned.
1246 static address resolve_function_descriptor_to_code_pointer(address p) {
1247 
1248   if (LoadedLibraries::find_for_text_address(p, NULL) != NULL) {
1249     // It is a real code pointer.
1250     return p;
1251   } else if (LoadedLibraries::find_for_data_address(p, NULL) != NULL) {
1252     // Pointer to data segment, potential function descriptor.
1253     address code_entry = (address)(((FunctionDescriptor*)p)-&gt;entry());
1254     if (LoadedLibraries::find_for_text_address(code_entry, NULL) != NULL) {
1255       // It is a function descriptor.
1256       return code_entry;
1257     }
1258   }
1259 
1260   return NULL;
1261 }
1262 
1263 bool os::dll_address_to_function_name(address addr, char *buf,
1264                                       int buflen, int *offset,
1265                                       bool demangle) {
1266   if (offset) {
1267     *offset = -1;
1268   }
1269   // Buf is not optional, but offset is optional.
1270   assert(buf != NULL, &quot;sanity check&quot;);
1271   buf[0] = &#39;\0&#39;;
1272 
1273   // Resolve function ptr literals first.
1274   addr = resolve_function_descriptor_to_code_pointer(addr);
1275   if (!addr) {
1276     return false;
1277   }
1278 
1279   return AixSymbols::get_function_name(addr, buf, buflen, offset, NULL, demangle);
1280 }
1281 
1282 bool os::dll_address_to_library_name(address addr, char* buf,
1283                                      int buflen, int* offset) {
1284   if (offset) {
1285     *offset = -1;
1286   }
1287   // Buf is not optional, but offset is optional.
1288   assert(buf != NULL, &quot;sanity check&quot;);
1289   buf[0] = &#39;\0&#39;;
1290 
1291   // Resolve function ptr literals first.
1292   addr = resolve_function_descriptor_to_code_pointer(addr);
1293   if (!addr) {
1294     return false;
1295   }
1296 
1297   return AixSymbols::get_module_name(addr, buf, buflen);
1298 }
1299 
1300 // Loads .dll/.so and in case of error it checks if .dll/.so was built
1301 // for the same architecture as Hotspot is running on.
1302 void *os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1303 
1304   if (ebuf &amp;&amp; ebuflen &gt; 0) {
1305     ebuf[0] = &#39;\0&#39;;
1306     ebuf[ebuflen - 1] = &#39;\0&#39;;
1307   }
1308 
1309   if (!filename || strlen(filename) == 0) {
1310     ::strncpy(ebuf, &quot;dll_load: empty filename specified&quot;, ebuflen - 1);
1311     return NULL;
1312   }
1313 
1314   // RTLD_LAZY is currently not implemented. The dl is loaded immediately with all its dependants.
1315   void * result= ::dlopen(filename, RTLD_LAZY);
1316   if (result != NULL) {
1317     // Reload dll cache. Don&#39;t do this in signal handling.
1318     LoadedLibraries::reload();
1319     return result;
1320   } else {
1321     // error analysis when dlopen fails
1322     const char* const error_report = ::dlerror();
1323     if (error_report &amp;&amp; ebuf &amp;&amp; ebuflen &gt; 0) {
1324       snprintf(ebuf, ebuflen - 1, &quot;%s, LIBPATH=%s, LD_LIBRARY_PATH=%s : %s&quot;,
1325                filename, ::getenv(&quot;LIBPATH&quot;), ::getenv(&quot;LD_LIBRARY_PATH&quot;), error_report);
1326     }
1327   }
1328   return NULL;
1329 }
1330 
1331 void* os::dll_lookup(void* handle, const char* name) {
1332   void* res = dlsym(handle, name);
1333   return res;
1334 }
1335 
1336 void* os::get_default_process_handle() {
1337   return (void*)::dlopen(NULL, RTLD_LAZY);
1338 }
1339 
1340 void os::print_dll_info(outputStream *st) {
1341   st-&gt;print_cr(&quot;Dynamic libraries:&quot;);
1342   LoadedLibraries::print(st);
1343 }
1344 
1345 void os::get_summary_os_info(char* buf, size_t buflen) {
1346   // There might be something more readable than uname results for AIX.
1347   struct utsname name;
1348   uname(&amp;name);
1349   snprintf(buf, buflen, &quot;%s %s&quot;, name.release, name.version);
1350 }
1351 
1352 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
1353   // Not yet implemented.
1354   return 0;
1355 }
1356 
1357 void os::print_os_info_brief(outputStream* st) {
1358   uint32_t ver = os::Aix::os_version();
1359   st-&gt;print_cr(&quot;AIX kernel version %u.%u.%u.%u&quot;,
1360                (ver &gt;&gt; 24) &amp; 0xFF, (ver &gt;&gt; 16) &amp; 0xFF, (ver &gt;&gt; 8) &amp; 0xFF, ver &amp; 0xFF);
1361 
1362   os::Posix::print_uname_info(st);
1363 
1364   // Linux uses print_libversion_info(st); here.
1365 }
1366 
1367 void os::print_os_info(outputStream* st) {
1368   st-&gt;print(&quot;OS:&quot;);
1369 
1370   st-&gt;print(&quot;uname:&quot;);
1371   struct utsname name;
1372   uname(&amp;name);
1373   st-&gt;print(name.sysname); st-&gt;print(&quot; &quot;);
1374   st-&gt;print(name.nodename); st-&gt;print(&quot; &quot;);
1375   st-&gt;print(name.release); st-&gt;print(&quot; &quot;);
1376   st-&gt;print(name.version); st-&gt;print(&quot; &quot;);
1377   st-&gt;print(name.machine);
1378   st-&gt;cr();
1379 
1380   uint32_t ver = os::Aix::os_version();
1381   st-&gt;print_cr(&quot;AIX kernel version %u.%u.%u.%u&quot;,
1382                (ver &gt;&gt; 24) &amp; 0xFF, (ver &gt;&gt; 16) &amp; 0xFF, (ver &gt;&gt; 8) &amp; 0xFF, ver &amp; 0xFF);
1383 
1384   os::Posix::print_rlimit_info(st);
1385 
1386   // load average
1387   st-&gt;print(&quot;load average:&quot;);
1388   double loadavg[3] = {-1.L, -1.L, -1.L};
1389   os::loadavg(loadavg, 3);
1390   st-&gt;print(&quot;%0.02f %0.02f %0.02f&quot;, loadavg[0], loadavg[1], loadavg[2]);
1391   st-&gt;cr();
1392 
1393   // print wpar info
1394   libperfstat::wparinfo_t wi;
1395   if (libperfstat::get_wparinfo(&amp;wi)) {
1396     st-&gt;print_cr(&quot;wpar info&quot;);
1397     st-&gt;print_cr(&quot;name: %s&quot;, wi.name);
1398     st-&gt;print_cr(&quot;id:   %d&quot;, wi.wpar_id);
1399     st-&gt;print_cr(&quot;type: %s&quot;, (wi.app_wpar ? &quot;application&quot; : &quot;system&quot;));
1400   }
1401 
1402   // print partition info
1403   libperfstat::partitioninfo_t pi;
1404   if (libperfstat::get_partitioninfo(&amp;pi)) {
1405     st-&gt;print_cr(&quot;partition info&quot;);
1406     st-&gt;print_cr(&quot; name: %s&quot;, pi.name);
1407   }
1408 
1409 }
1410 
1411 void os::print_memory_info(outputStream* st) {
1412 
1413   st-&gt;print_cr(&quot;Memory:&quot;);
1414 
1415   st-&gt;print_cr(&quot;  Base page size (sysconf _SC_PAGESIZE):  %s&quot;,
1416     describe_pagesize(g_multipage_support.pagesize));
1417   st-&gt;print_cr(&quot;  Data page size (C-Heap, bss, etc):      %s&quot;,
1418     describe_pagesize(g_multipage_support.datapsize));
1419   st-&gt;print_cr(&quot;  Text page size:                         %s&quot;,
1420     describe_pagesize(g_multipage_support.textpsize));
1421   st-&gt;print_cr(&quot;  Thread stack page size (pthread):       %s&quot;,
1422     describe_pagesize(g_multipage_support.pthr_stack_pagesize));
1423   st-&gt;print_cr(&quot;  Default shared memory page size:        %s&quot;,
1424     describe_pagesize(g_multipage_support.shmpsize));
1425   st-&gt;print_cr(&quot;  Can use 64K pages dynamically with shared meory:  %s&quot;,
1426     (g_multipage_support.can_use_64K_pages ? &quot;yes&quot; :&quot;no&quot;));
1427   st-&gt;print_cr(&quot;  Can use 16M pages dynamically with shared memory: %s&quot;,
1428     (g_multipage_support.can_use_16M_pages ? &quot;yes&quot; :&quot;no&quot;));
1429   st-&gt;print_cr(&quot;  Multipage error: %d&quot;,
1430     g_multipage_support.error);
1431   st-&gt;cr();
1432   st-&gt;print_cr(&quot;  os::vm_page_size:       %s&quot;, describe_pagesize(os::vm_page_size()));
1433 
1434   // print out LDR_CNTRL because it affects the default page sizes
1435   const char* const ldr_cntrl = ::getenv(&quot;LDR_CNTRL&quot;);
1436   st-&gt;print_cr(&quot;  LDR_CNTRL=%s.&quot;, ldr_cntrl ? ldr_cntrl : &quot;&lt;unset&gt;&quot;);
1437 
1438   // Print out EXTSHM because it is an unsupported setting.
1439   const char* const extshm = ::getenv(&quot;EXTSHM&quot;);
1440   st-&gt;print_cr(&quot;  EXTSHM=%s.&quot;, extshm ? extshm : &quot;&lt;unset&gt;&quot;);
1441   if ( (strcmp(extshm, &quot;on&quot;) == 0) || (strcmp(extshm, &quot;ON&quot;) == 0) ) {
1442     st-&gt;print_cr(&quot;  *** Unsupported! Please remove EXTSHM from your environment! ***&quot;);
1443   }
1444 
1445   // Print out AIXTHREAD_GUARDPAGES because it affects the size of pthread stacks.
1446   const char* const aixthread_guardpages = ::getenv(&quot;AIXTHREAD_GUARDPAGES&quot;);
1447   st-&gt;print_cr(&quot;  AIXTHREAD_GUARDPAGES=%s.&quot;,
1448       aixthread_guardpages ? aixthread_guardpages : &quot;&lt;unset&gt;&quot;);
1449   st-&gt;cr();
1450 
1451   os::Aix::meminfo_t mi;
1452   if (os::Aix::get_meminfo(&amp;mi)) {
1453     if (os::Aix::on_aix()) {
1454       st-&gt;print_cr(&quot;physical total : &quot; SIZE_FORMAT, mi.real_total);
1455       st-&gt;print_cr(&quot;physical free  : &quot; SIZE_FORMAT, mi.real_free);
1456       st-&gt;print_cr(&quot;swap total     : &quot; SIZE_FORMAT, mi.pgsp_total);
1457       st-&gt;print_cr(&quot;swap free      : &quot; SIZE_FORMAT, mi.pgsp_free);
1458     } else {
1459       // PASE - Numbers are result of QWCRSSTS; they mean:
1460       // real_total: Sum of all system pools
1461       // real_free: always 0
1462       // pgsp_total: we take the size of the system ASP
1463       // pgsp_free: size of system ASP times percentage of system ASP unused
1464       st-&gt;print_cr(&quot;physical total     : &quot; SIZE_FORMAT, mi.real_total);
1465       st-&gt;print_cr(&quot;system asp total   : &quot; SIZE_FORMAT, mi.pgsp_total);
1466       st-&gt;print_cr(&quot;%% system asp used : %.2f&quot;,
1467         mi.pgsp_total ? (100.0f * (mi.pgsp_total - mi.pgsp_free) / mi.pgsp_total) : -1.0f);
1468     }
1469   }
1470   st-&gt;cr();
1471 
1472   // Print program break.
1473   st-&gt;print_cr(&quot;Program break at VM startup: &quot; PTR_FORMAT &quot;.&quot;, p2i(g_brk_at_startup));
1474   address brk_now = (address)::sbrk(0);
1475   if (brk_now != (address)-1) {
1476     st-&gt;print_cr(&quot;Program break now          : &quot; PTR_FORMAT &quot; (distance: &quot; SIZE_FORMAT &quot;k).&quot;,
1477                  p2i(brk_now), (size_t)((brk_now - g_brk_at_startup) / K));
1478   }
1479   st-&gt;print_cr(&quot;MaxExpectedDataSegmentSize    : &quot; SIZE_FORMAT &quot;k.&quot;, MaxExpectedDataSegmentSize / K);
1480   st-&gt;cr();
1481 
1482   // Print segments allocated with os::reserve_memory.
1483   st-&gt;print_cr(&quot;internal virtual memory regions used by vm:&quot;);
1484   vmembk_print_on(st);
1485 }
1486 
1487 // Get a string for the cpuinfo that is a summary of the cpu type
1488 void os::get_summary_cpu_info(char* buf, size_t buflen) {
1489   // read _system_configuration.version
1490   switch (_system_configuration.version) {
1491   case PV_8:
1492     strncpy(buf, &quot;Power PC 8&quot;, buflen);
1493     break;
1494   case PV_7:
1495     strncpy(buf, &quot;Power PC 7&quot;, buflen);
1496     break;
1497   case PV_6_1:
1498     strncpy(buf, &quot;Power PC 6 DD1.x&quot;, buflen);
1499     break;
1500   case PV_6:
1501     strncpy(buf, &quot;Power PC 6&quot;, buflen);
1502     break;
1503   case PV_5:
1504     strncpy(buf, &quot;Power PC 5&quot;, buflen);
1505     break;
1506   case PV_5_2:
1507     strncpy(buf, &quot;Power PC 5_2&quot;, buflen);
1508     break;
1509   case PV_5_3:
1510     strncpy(buf, &quot;Power PC 5_3&quot;, buflen);
1511     break;
1512   case PV_5_Compat:
1513     strncpy(buf, &quot;PV_5_Compat&quot;, buflen);
1514     break;
1515   case PV_6_Compat:
1516     strncpy(buf, &quot;PV_6_Compat&quot;, buflen);
1517     break;
1518   case PV_7_Compat:
1519     strncpy(buf, &quot;PV_7_Compat&quot;, buflen);
1520     break;
1521   case PV_8_Compat:
1522     strncpy(buf, &quot;PV_8_Compat&quot;, buflen);
1523     break;
1524   default:
1525     strncpy(buf, &quot;unknown&quot;, buflen);
1526   }
1527 }
1528 
1529 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
1530   // Nothing to do beyond of what os::print_cpu_info() does.
1531 }
1532 
1533 static void print_signal_handler(outputStream* st, int sig,
1534                                  char* buf, size_t buflen);
1535 
1536 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
1537   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
1538   print_signal_handler(st, SIGSEGV, buf, buflen);
1539   print_signal_handler(st, SIGBUS , buf, buflen);
1540   print_signal_handler(st, SIGFPE , buf, buflen);
1541   print_signal_handler(st, SIGPIPE, buf, buflen);
1542   print_signal_handler(st, SIGXFSZ, buf, buflen);
1543   print_signal_handler(st, SIGILL , buf, buflen);
1544   print_signal_handler(st, SR_signum, buf, buflen);
1545   print_signal_handler(st, SHUTDOWN1_SIGNAL, buf, buflen);
1546   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
1547   print_signal_handler(st, SHUTDOWN3_SIGNAL , buf, buflen);
1548   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
1549   print_signal_handler(st, SIGTRAP, buf, buflen);
1550   // We also want to know if someone else adds a SIGDANGER handler because
1551   // that will interfere with OOM killling.
1552   print_signal_handler(st, SIGDANGER, buf, buflen);
1553 }
1554 
1555 static char saved_jvm_path[MAXPATHLEN] = {0};
1556 
1557 // Find the full path to the current module, libjvm.so.
1558 void os::jvm_path(char *buf, jint buflen) {
1559   // Error checking.
1560   if (buflen &lt; MAXPATHLEN) {
1561     assert(false, &quot;must use a large-enough buffer&quot;);
1562     buf[0] = &#39;\0&#39;;
1563     return;
1564   }
1565   // Lazy resolve the path to current module.
1566   if (saved_jvm_path[0] != 0) {
1567     strcpy(buf, saved_jvm_path);
1568     return;
1569   }
1570 
1571   Dl_info dlinfo;
1572   int ret = dladdr(CAST_FROM_FN_PTR(void *, os::jvm_path), &amp;dlinfo);
1573   assert(ret != 0, &quot;cannot locate libjvm&quot;);
1574   char* rp = os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen);
1575   assert(rp != NULL, &quot;error in realpath(): maybe the &#39;path&#39; argument is too long?&quot;);
1576 
1577   if (Arguments::sun_java_launcher_is_altjvm()) {
1578     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
1579     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;vmtype&gt;/libjvm.so&quot;.
1580     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
1581     // assume we are installed in a JDK and we&#39;re done. Otherwise, check
1582     // for a JAVA_HOME environment variable and fix up the path so it
1583     // looks like libjvm.so is installed there (append a fake suffix
1584     // hotspot/libjvm.so).
1585     const char *p = buf + strlen(buf) - 1;
1586     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 4; ++count) {
1587       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
1588         /* empty */ ;
1589     }
1590 
1591     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
1592       // Look for JAVA_HOME in the environment.
1593       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
1594       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
1595         char* jrelib_p;
1596         int len;
1597 
1598         // Check the current module name &quot;libjvm.so&quot;.
1599         p = strrchr(buf, &#39;/&#39;);
1600         if (p == NULL) {
1601           return;
1602         }
1603         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
1604 
1605         rp = os::Posix::realpath(java_home_var, buf, buflen);
1606         if (rp == NULL) {
1607           return;
1608         }
1609 
1610         // determine if this is a legacy image or modules image
1611         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
1612         len = strlen(buf);
1613         assert(len &lt; buflen, &quot;Ran out of buffer room&quot;);
1614         jrelib_p = buf + len;
1615         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
1616         if (0 != access(buf, F_OK)) {
1617           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
1618         }
1619 
1620         if (0 == access(buf, F_OK)) {
1621           // Use current module name &quot;libjvm.so&quot;
1622           len = strlen(buf);
1623           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
1624         } else {
1625           // Go back to path of .so
1626           rp = os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen);
1627           if (rp == NULL) {
1628             return;
1629           }
1630         }
1631       }
1632     }
1633   }
1634 
1635   strncpy(saved_jvm_path, buf, sizeof(saved_jvm_path));
1636   saved_jvm_path[sizeof(saved_jvm_path) - 1] = &#39;\0&#39;;
1637 }
1638 
1639 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
1640   // no prefix required, not even &quot;_&quot;
1641 }
1642 
1643 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
1644   // no suffix required
1645 }
1646 
1647 ////////////////////////////////////////////////////////////////////////////////
1648 // sun.misc.Signal support
1649 
1650 static volatile jint sigint_count = 0;
1651 
1652 static void
1653 UserHandler(int sig, void *siginfo, void *context) {
1654   // 4511530 - sem_post is serialized and handled by the manager thread. When
1655   // the program is interrupted by Ctrl-C, SIGINT is sent to every thread. We
1656   // don&#39;t want to flood the manager thread with sem_post requests.
1657   if (sig == SIGINT &amp;&amp; Atomic::add(1, &amp;sigint_count) &gt; 1)
1658     return;
1659 
1660   // Ctrl-C is pressed during error reporting, likely because the error
1661   // handler fails to abort. Let VM die immediately.
1662   if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
1663     os::die();
1664   }
1665 
1666   os::signal_notify(sig);
1667 }
1668 
1669 void* os::user_handler() {
1670   return CAST_FROM_FN_PTR(void*, UserHandler);
1671 }
1672 
1673 extern &quot;C&quot; {
1674   typedef void (*sa_handler_t)(int);
1675   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
1676 }
1677 
1678 void* os::signal(int signal_number, void* handler) {
1679   struct sigaction sigAct, oldSigAct;
1680 
1681   sigfillset(&amp;(sigAct.sa_mask));
1682 
1683   // Do not block out synchronous signals in the signal handler.
1684   // Blocking synchronous signals only makes sense if you can really
1685   // be sure that those signals won&#39;t happen during signal handling,
1686   // when the blocking applies. Normal signal handlers are lean and
1687   // do not cause signals. But our signal handlers tend to be &quot;risky&quot;
1688   // - secondary SIGSEGV, SIGILL, SIGBUS&#39; may and do happen.
1689   // On AIX, PASE there was a case where a SIGSEGV happened, followed
1690   // by a SIGILL, which was blocked due to the signal mask. The process
1691   // just hung forever. Better to crash from a secondary signal than to hang.
1692   sigdelset(&amp;(sigAct.sa_mask), SIGSEGV);
1693   sigdelset(&amp;(sigAct.sa_mask), SIGBUS);
1694   sigdelset(&amp;(sigAct.sa_mask), SIGILL);
1695   sigdelset(&amp;(sigAct.sa_mask), SIGFPE);
1696   sigdelset(&amp;(sigAct.sa_mask), SIGTRAP);
1697 
1698   sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;
1699 
1700   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
1701 
1702   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
1703     // -1 means registration failed
1704     return (void *)-1;
1705   }
1706 
1707   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
1708 }
1709 
1710 void os::signal_raise(int signal_number) {
1711   ::raise(signal_number);
1712 }
1713 
1714 //
1715 // The following code is moved from os.cpp for making this
1716 // code platform specific, which it is by its very nature.
1717 //
1718 
1719 // Will be modified when max signal is changed to be dynamic
1720 int os::sigexitnum_pd() {
1721   return NSIG;
1722 }
1723 
1724 // a counter for each possible signal value
1725 static volatile jint pending_signals[NSIG+1] = { 0 };
1726 
1727 // Wrapper functions for: sem_init(), sem_post(), sem_wait()
1728 // On AIX, we use sem_init(), sem_post(), sem_wait()
1729 // On Pase, we need to use msem_lock() and msem_unlock(), because Posix Semaphores
1730 // do not seem to work at all on PASE (unimplemented, will cause SIGILL).
1731 // Note that just using msem_.. APIs for both PASE and AIX is not an option either, as
1732 // on AIX, msem_..() calls are suspected of causing problems.
1733 static sem_t sig_sem;
1734 static msemaphore* p_sig_msem = 0;
1735 
1736 static void local_sem_init() {
1737   if (os::Aix::on_aix()) {
1738     int rc = ::sem_init(&amp;sig_sem, 0, 0);
1739     guarantee(rc != -1, &quot;sem_init failed&quot;);
1740   } else {
1741     // Memory semaphores must live in shared mem.
1742     guarantee0(p_sig_msem == NULL);
1743     p_sig_msem = (msemaphore*)os::reserve_memory(sizeof(msemaphore), NULL);
1744     guarantee(p_sig_msem, &quot;Cannot allocate memory for memory semaphore&quot;);
1745     guarantee(::msem_init(p_sig_msem, 0) == p_sig_msem, &quot;msem_init failed&quot;);
1746   }
1747 }
1748 
1749 static void local_sem_post() {
1750   static bool warn_only_once = false;
1751   if (os::Aix::on_aix()) {
1752     int rc = ::sem_post(&amp;sig_sem);
1753     if (rc == -1 &amp;&amp; !warn_only_once) {
1754       trcVerbose(&quot;sem_post failed (errno = %d, %s)&quot;, errno, os::errno_name(errno));
1755       warn_only_once = true;
1756     }
1757   } else {
1758     guarantee0(p_sig_msem != NULL);
1759     int rc = ::msem_unlock(p_sig_msem, 0);
1760     if (rc == -1 &amp;&amp; !warn_only_once) {
1761       trcVerbose(&quot;msem_unlock failed (errno = %d, %s)&quot;, errno, os::errno_name(errno));
1762       warn_only_once = true;
1763     }
1764   }
1765 }
1766 
1767 static void local_sem_wait() {
1768   static bool warn_only_once = false;
1769   if (os::Aix::on_aix()) {
1770     int rc = ::sem_wait(&amp;sig_sem);
1771     if (rc == -1 &amp;&amp; !warn_only_once) {
1772       trcVerbose(&quot;sem_wait failed (errno = %d, %s)&quot;, errno, os::errno_name(errno));
1773       warn_only_once = true;
1774     }
1775   } else {
1776     guarantee0(p_sig_msem != NULL); // must init before use
1777     int rc = ::msem_lock(p_sig_msem, 0);
1778     if (rc == -1 &amp;&amp; !warn_only_once) {
1779       trcVerbose(&quot;msem_lock failed (errno = %d, %s)&quot;, errno, os::errno_name(errno));
1780       warn_only_once = true;
1781     }
1782   }
1783 }
1784 
1785 static void jdk_misc_signal_init() {
1786   // Initialize signal structures
1787   ::memset((void*)pending_signals, 0, sizeof(pending_signals));
1788 
1789   // Initialize signal semaphore
1790   local_sem_init();
1791 }
1792 
1793 void os::signal_notify(int sig) {
1794   Atomic::inc(&amp;pending_signals[sig]);
1795   local_sem_post();
1796 }
1797 
1798 static int check_pending_signals() {
1799   Atomic::store(0, &amp;sigint_count);
1800   for (;;) {
1801     for (int i = 0; i &lt; NSIG + 1; i++) {
1802       jint n = pending_signals[i];
1803       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(n - 1, &amp;pending_signals[i], n)) {
1804         return i;
1805       }
1806     }
1807     JavaThread *thread = JavaThread::current();
1808     ThreadBlockInVM tbivm(thread);
1809 
1810     bool threadIsSuspended;
1811     do {
1812       thread-&gt;set_suspend_equivalent();
1813       // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
1814 
1815       local_sem_wait();
1816 
1817       // were we externally suspended while we were waiting?
1818       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
1819       if (threadIsSuspended) {
1820         //
1821         // The semaphore has been incremented, but while we were waiting
1822         // another thread suspended us. We don&#39;t want to continue running
1823         // while suspended because that would surprise the thread that
1824         // suspended us.
1825         //
1826 
1827         local_sem_post();
1828 
1829         thread-&gt;java_suspend_self();
1830       }
1831     } while (threadIsSuspended);
1832   }
1833 }
1834 
1835 int os::signal_wait() {
1836   return check_pending_signals();
1837 }
1838 
1839 ////////////////////////////////////////////////////////////////////////////////
1840 // Virtual Memory
1841 
1842 // We need to keep small simple bookkeeping for os::reserve_memory and friends.
1843 
1844 #define VMEM_MAPPED  1
1845 #define VMEM_SHMATED 2
1846 
1847 struct vmembk_t {
1848   int type;         // 1 - mmap, 2 - shmat
1849   char* addr;
1850   size_t size;      // Real size, may be larger than usersize.
1851   size_t pagesize;  // page size of area
1852   vmembk_t* next;
1853 
1854   bool contains_addr(char* p) const {
1855     return p &gt;= addr &amp;&amp; p &lt; (addr + size);
1856   }
1857 
1858   bool contains_range(char* p, size_t s) const {
1859     return contains_addr(p) &amp;&amp; contains_addr(p + s - 1);
1860   }
1861 
1862   void print_on(outputStream* os) const {
1863     os-&gt;print(&quot;[&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot;] (&quot; UINTX_FORMAT
1864       &quot; bytes, %d %s pages), %s&quot;,
1865       addr, addr + size - 1, size, size / pagesize, describe_pagesize(pagesize),
1866       (type == VMEM_SHMATED ? &quot;shmat&quot; : &quot;mmap&quot;)
1867     );
1868   }
1869 
1870   // Check that range is a sub range of memory block (or equal to memory block);
1871   // also check that range is fully page aligned to the page size if the block.
1872   void assert_is_valid_subrange(char* p, size_t s) const {
1873     if (!contains_range(p, s)) {
1874       trcVerbose(&quot;[&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot;] is not a sub &quot;
1875               &quot;range of [&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot;].&quot;,
1876               p, p + s, addr, addr + size);
1877       guarantee0(false);
1878     }
1879     if (!is_aligned_to(p, pagesize) || !is_aligned_to(p + s, pagesize)) {
1880       trcVerbose(&quot;range [&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot;] is not&quot;
1881               &quot; aligned to pagesize (%lu)&quot;, p, p + s, (unsigned long) pagesize);
1882       guarantee0(false);
1883     }
1884   }
1885 };
1886 
1887 static struct {
1888   vmembk_t* first;
1889   MiscUtils::CritSect cs;
1890 } vmem;
1891 
1892 static void vmembk_add(char* addr, size_t size, size_t pagesize, int type) {
1893   vmembk_t* p = (vmembk_t*) ::malloc(sizeof(vmembk_t));
1894   assert0(p);
1895   if (p) {
1896     MiscUtils::AutoCritSect lck(&amp;vmem.cs);
1897     p-&gt;addr = addr; p-&gt;size = size;
1898     p-&gt;pagesize = pagesize;
1899     p-&gt;type = type;
1900     p-&gt;next = vmem.first;
1901     vmem.first = p;
1902   }
1903 }
1904 
1905 static vmembk_t* vmembk_find(char* addr) {
1906   MiscUtils::AutoCritSect lck(&amp;vmem.cs);
1907   for (vmembk_t* p = vmem.first; p; p = p-&gt;next) {
1908     if (p-&gt;addr &lt;= addr &amp;&amp; (p-&gt;addr + p-&gt;size) &gt; addr) {
1909       return p;
1910     }
1911   }
1912   return NULL;
1913 }
1914 
1915 static void vmembk_remove(vmembk_t* p0) {
1916   MiscUtils::AutoCritSect lck(&amp;vmem.cs);
1917   assert0(p0);
1918   assert0(vmem.first); // List should not be empty.
1919   for (vmembk_t** pp = &amp;(vmem.first); *pp; pp = &amp;((*pp)-&gt;next)) {
1920     if (*pp == p0) {
1921       *pp = p0-&gt;next;
1922       ::free(p0);
1923       return;
1924     }
1925   }
1926   assert0(false); // Not found?
1927 }
1928 
1929 static void vmembk_print_on(outputStream* os) {
1930   MiscUtils::AutoCritSect lck(&amp;vmem.cs);
1931   for (vmembk_t* vmi = vmem.first; vmi; vmi = vmi-&gt;next) {
1932     vmi-&gt;print_on(os);
1933     os-&gt;cr();
1934   }
1935 }
1936 
1937 // Reserve and attach a section of System V memory.
1938 // If &lt;requested_addr&gt; is not NULL, function will attempt to attach the memory at the given
1939 // address. Failing that, it will attach the memory anywhere.
1940 // If &lt;requested_addr&gt; is NULL, function will attach the memory anywhere.
1941 //
1942 // &lt;alignment_hint&gt; is being ignored by this function. It is very probable however that the
1943 // alignment requirements are met anyway, because shmat() attaches at 256M boundaries.
1944 // Should this be not enogh, we can put more work into it.
1945 static char* reserve_shmated_memory (
1946   size_t bytes,
1947   char* requested_addr,
1948   size_t alignment_hint) {
1949 
1950   trcVerbose(&quot;reserve_shmated_memory &quot; UINTX_FORMAT &quot; bytes, wishaddress &quot;
1951     PTR_FORMAT &quot;, alignment_hint &quot; UINTX_FORMAT &quot;...&quot;,
1952     bytes, requested_addr, alignment_hint);
1953 
1954   // Either give me wish address or wish alignment but not both.
1955   assert0(!(requested_addr != NULL &amp;&amp; alignment_hint != 0));
1956 
1957   // We must prevent anyone from attaching too close to the
1958   // BRK because that may cause malloc OOM.
1959   if (requested_addr != NULL &amp;&amp; is_close_to_brk((address)requested_addr)) {
1960     trcVerbose(&quot;Wish address &quot; PTR_FORMAT &quot; is too close to the BRK segment. &quot;
1961       &quot;Will attach anywhere.&quot;, requested_addr);
1962     // Act like the OS refused to attach there.
1963     requested_addr = NULL;
1964   }
1965 
1966   // For old AS/400&#39;s (V5R4 and older) we should not even be here - System V shared memory is not
1967   // really supported (max size 4GB), so reserve_mmapped_memory should have been used instead.
1968   if (os::Aix::on_pase_V5R4_or_older()) {
1969     ShouldNotReachHere();
1970   }
1971 
1972   // Align size of shm up to 64K to avoid errors if we later try to change the page size.
1973   const size_t size = align_up(bytes, 64*K);
1974 
1975   // Reserve the shared segment.
1976   int shmid = shmget(IPC_PRIVATE, size, IPC_CREAT | S_IRUSR | S_IWUSR);
1977   if (shmid == -1) {
1978     trcVerbose(&quot;shmget(.., &quot; UINTX_FORMAT &quot;, ..) failed (errno: %d).&quot;, size, errno);
1979     return NULL;
1980   }
1981 
1982   // Important note:
1983   // It is very important that we, upon leaving this function, do not leave a shm segment alive.
1984   // We must right after attaching it remove it from the system. System V shm segments are global and
1985   // survive the process.
1986   // So, from here on: Do not assert, do not return, until we have called shmctl(IPC_RMID) (A).
1987 
1988   struct shmid_ds shmbuf;
1989   memset(&amp;shmbuf, 0, sizeof(shmbuf));
1990   shmbuf.shm_pagesize = 64*K;
1991   if (shmctl(shmid, SHM_PAGESIZE, &amp;shmbuf) != 0) {
1992     trcVerbose(&quot;Failed to set page size (need &quot; UINTX_FORMAT &quot; 64K pages) - shmctl failed with %d.&quot;,
1993                size / (64*K), errno);
1994     // I want to know if this ever happens.
1995     assert(false, &quot;failed to set page size for shmat&quot;);
1996   }
1997 
1998   // Now attach the shared segment.
1999   // Note that I attach with SHM_RND - which means that the requested address is rounded down, if
2000   // needed, to the next lowest segment boundary. Otherwise the attach would fail if the address
2001   // were not a segment boundary.
2002   char* const addr = (char*) shmat(shmid, requested_addr, SHM_RND);
2003   const int errno_shmat = errno;
2004 
2005   // (A) Right after shmat and before handing shmat errors delete the shm segment.
2006   if (::shmctl(shmid, IPC_RMID, NULL) == -1) {
2007     trcVerbose(&quot;shmctl(%u, IPC_RMID) failed (%d)\n&quot;, shmid, errno);
2008     assert(false, &quot;failed to remove shared memory segment!&quot;);
2009   }
2010 
2011   // Handle shmat error. If we failed to attach, just return.
2012   if (addr == (char*)-1) {
2013     trcVerbose(&quot;Failed to attach segment at &quot; PTR_FORMAT &quot; (%d).&quot;, requested_addr, errno_shmat);
2014     return NULL;
2015   }
2016 
2017   // Just for info: query the real page size. In case setting the page size did not
2018   // work (see above), the system may have given us something other then 4K (LDR_CNTRL).
2019   const size_t real_pagesize = os::Aix::query_pagesize(addr);
2020   if (real_pagesize != shmbuf.shm_pagesize) {
2021     trcVerbose(&quot;pagesize is, surprisingly, %h.&quot;, real_pagesize);
2022   }
2023 
2024   if (addr) {
2025     trcVerbose(&quot;shm-allocated &quot; PTR_FORMAT &quot; .. &quot; PTR_FORMAT &quot; (&quot; UINTX_FORMAT &quot; bytes, &quot; UINTX_FORMAT &quot; %s pages)&quot;,
2026       addr, addr + size - 1, size, size/real_pagesize, describe_pagesize(real_pagesize));
2027   } else {
2028     if (requested_addr != NULL) {
2029       trcVerbose(&quot;failed to shm-allocate &quot; UINTX_FORMAT &quot; bytes at with address &quot; PTR_FORMAT &quot;.&quot;, size, requested_addr);
2030     } else {
2031       trcVerbose(&quot;failed to shm-allocate &quot; UINTX_FORMAT &quot; bytes at any address.&quot;, size);
2032     }
2033   }
2034 
2035   // book-keeping
2036   vmembk_add(addr, size, real_pagesize, VMEM_SHMATED);
2037   assert0(is_aligned_to(addr, os::vm_page_size()));
2038 
2039   return addr;
2040 }
2041 
2042 static bool release_shmated_memory(char* addr, size_t size) {
2043 
2044   trcVerbose(&quot;release_shmated_memory [&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot;].&quot;,
2045     addr, addr + size - 1);
2046 
2047   bool rc = false;
2048 
2049   // TODO: is there a way to verify shm size without doing bookkeeping?
2050   if (::shmdt(addr) != 0) {
2051     trcVerbose(&quot;error (%d).&quot;, errno);
2052   } else {
2053     trcVerbose(&quot;ok.&quot;);
2054     rc = true;
2055   }
2056   return rc;
2057 }
2058 
2059 static bool uncommit_shmated_memory(char* addr, size_t size) {
2060   trcVerbose(&quot;uncommit_shmated_memory [&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot;].&quot;,
2061     addr, addr + size - 1);
2062 
2063   const bool rc = my_disclaim64(addr, size);
2064 
2065   if (!rc) {
2066     trcVerbose(&quot;my_disclaim64(&quot; PTR_FORMAT &quot;, &quot; UINTX_FORMAT &quot;) failed.\n&quot;, addr, size);
2067     return false;
2068   }
2069   return true;
2070 }
2071 
2072 ////////////////////////////////  mmap-based routines /////////////////////////////////
2073 
2074 // Reserve memory via mmap.
2075 // If &lt;requested_addr&gt; is given, an attempt is made to attach at the given address.
2076 // Failing that, memory is allocated at any address.
2077 // If &lt;alignment_hint&gt; is given and &lt;requested_addr&gt; is NULL, an attempt is made to
2078 // allocate at an address aligned with the given alignment. Failing that, memory
2079 // is aligned anywhere.
2080 static char* reserve_mmaped_memory(size_t bytes, char* requested_addr, size_t alignment_hint) {
2081   trcVerbose(&quot;reserve_mmaped_memory &quot; UINTX_FORMAT &quot; bytes, wishaddress &quot; PTR_FORMAT &quot;, &quot;
2082     &quot;alignment_hint &quot; UINTX_FORMAT &quot;...&quot;,
2083     bytes, requested_addr, alignment_hint);
2084 
2085   // If a wish address is given, but not aligned to 4K page boundary, mmap will fail.
2086   if (requested_addr &amp;&amp; !is_aligned_to(requested_addr, os::vm_page_size()) != 0) {
2087     trcVerbose(&quot;Wish address &quot; PTR_FORMAT &quot; not aligned to page boundary.&quot;, requested_addr);
2088     return NULL;
2089   }
2090 
2091   // We must prevent anyone from attaching too close to the
2092   // BRK because that may cause malloc OOM.
2093   if (requested_addr != NULL &amp;&amp; is_close_to_brk((address)requested_addr)) {
2094     trcVerbose(&quot;Wish address &quot; PTR_FORMAT &quot; is too close to the BRK segment. &quot;
2095       &quot;Will attach anywhere.&quot;, requested_addr);
2096     // Act like the OS refused to attach there.
2097     requested_addr = NULL;
2098   }
2099 
2100   // Specify one or the other but not both.
2101   assert0(!(requested_addr != NULL &amp;&amp; alignment_hint &gt; 0));
2102 
2103   // In 64K mode, we claim the global page size (os::vm_page_size())
2104   // is 64K. This is one of the few points where that illusion may
2105   // break, because mmap() will always return memory aligned to 4K. So
2106   // we must ensure we only ever return memory aligned to 64k.
2107   if (alignment_hint) {
2108     alignment_hint = lcm(alignment_hint, os::vm_page_size());
2109   } else {
2110     alignment_hint = os::vm_page_size();
2111   }
2112 
2113   // Size shall always be a multiple of os::vm_page_size (esp. in 64K mode).
2114   const size_t size = align_up(bytes, os::vm_page_size());
2115 
2116   // alignment: Allocate memory large enough to include an aligned range of the right size and
2117   // cut off the leading and trailing waste pages.
2118   assert0(alignment_hint != 0 &amp;&amp; is_aligned_to(alignment_hint, os::vm_page_size())); // see above
2119   const size_t extra_size = size + alignment_hint;
2120 
2121   // Note: MAP_SHARED (instead of MAP_PRIVATE) needed to be able to
2122   // later use msync(MS_INVALIDATE) (see os::uncommit_memory).
2123   int flags = MAP_ANONYMOUS | MAP_SHARED;
2124 
2125   // MAP_FIXED is needed to enforce requested_addr - manpage is vague about what
2126   // it means if wishaddress is given but MAP_FIXED is not set.
2127   //
2128   // Important! Behaviour differs depending on whether SPEC1170 mode is active or not.
2129   // SPEC1170 mode active: behaviour like POSIX, MAP_FIXED will clobber existing mappings.
2130   // SPEC1170 mode not active: behaviour, unlike POSIX, is that no existing mappings will
2131   // get clobbered.
2132   if (requested_addr != NULL) {
2133     if (!os::Aix::xpg_sus_mode()) {  // not SPEC1170 Behaviour
2134       flags |= MAP_FIXED;
2135     }
2136   }
2137 
2138   char* addr = (char*)::mmap(requested_addr, extra_size,
2139       PROT_READ|PROT_WRITE|PROT_EXEC, flags, -1, 0);
2140 
2141   if (addr == MAP_FAILED) {
2142     trcVerbose(&quot;mmap(&quot; PTR_FORMAT &quot;, &quot; UINTX_FORMAT &quot;, ..) failed (%d)&quot;, requested_addr, size, errno);
2143     return NULL;
2144   }
2145 
2146   // Handle alignment.
2147   char* const addr_aligned = align_up(addr, alignment_hint);
2148   const size_t waste_pre = addr_aligned - addr;
2149   char* const addr_aligned_end = addr_aligned + size;
2150   const size_t waste_post = extra_size - waste_pre - size;
2151   if (waste_pre &gt; 0) {
2152     ::munmap(addr, waste_pre);
2153   }
2154   if (waste_post &gt; 0) {
2155     ::munmap(addr_aligned_end, waste_post);
2156   }
2157   addr = addr_aligned;
2158 
2159   if (addr) {
2160     trcVerbose(&quot;mmap-allocated &quot; PTR_FORMAT &quot; .. &quot; PTR_FORMAT &quot; (&quot; UINTX_FORMAT &quot; bytes)&quot;,
2161       addr, addr + bytes, bytes);
2162   } else {
2163     if (requested_addr != NULL) {
2164       trcVerbose(&quot;failed to mmap-allocate &quot; UINTX_FORMAT &quot; bytes at wish address &quot; PTR_FORMAT &quot;.&quot;, bytes, requested_addr);
2165     } else {
2166       trcVerbose(&quot;failed to mmap-allocate &quot; UINTX_FORMAT &quot; bytes at any address.&quot;, bytes);
2167     }
2168   }
2169 
2170   // bookkeeping
2171   vmembk_add(addr, size, 4*K, VMEM_MAPPED);
2172 
2173   // Test alignment, see above.
2174   assert0(is_aligned_to(addr, os::vm_page_size()));
2175 
2176   return addr;
2177 }
2178 
2179 static bool release_mmaped_memory(char* addr, size_t size) {
2180   assert0(is_aligned_to(addr, os::vm_page_size()));
2181   assert0(is_aligned_to(size, os::vm_page_size()));
2182 
2183   trcVerbose(&quot;release_mmaped_memory [&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot;].&quot;,
2184     addr, addr + size - 1);
2185   bool rc = false;
2186 
2187   if (::munmap(addr, size) != 0) {
2188     trcVerbose(&quot;failed (%d)\n&quot;, errno);
2189     rc = false;
2190   } else {
2191     trcVerbose(&quot;ok.&quot;);
2192     rc = true;
2193   }
2194 
2195   return rc;
2196 }
2197 
2198 static bool uncommit_mmaped_memory(char* addr, size_t size) {
2199 
2200   assert0(is_aligned_to(addr, os::vm_page_size()));
2201   assert0(is_aligned_to(size, os::vm_page_size()));
2202 
2203   trcVerbose(&quot;uncommit_mmaped_memory [&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot;].&quot;,
2204     addr, addr + size - 1);
2205   bool rc = false;
2206 
2207   // Uncommit mmap memory with msync MS_INVALIDATE.
2208   if (::msync(addr, size, MS_INVALIDATE) != 0) {
2209     trcVerbose(&quot;failed (%d)\n&quot;, errno);
2210     rc = false;
2211   } else {
2212     trcVerbose(&quot;ok.&quot;);
2213     rc = true;
2214   }
2215 
2216   return rc;
2217 }
2218 
2219 int os::vm_page_size() {
2220   // Seems redundant as all get out.
2221   assert(os::Aix::page_size() != -1, &quot;must call os::init&quot;);
2222   return os::Aix::page_size();
2223 }
2224 
2225 // Aix allocates memory by pages.
2226 int os::vm_allocation_granularity() {
2227   assert(os::Aix::page_size() != -1, &quot;must call os::init&quot;);
2228   return os::Aix::page_size();
2229 }
2230 
2231 #ifdef PRODUCT
2232 static void warn_fail_commit_memory(char* addr, size_t size, bool exec,
2233                                     int err) {
2234   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2235           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, size, exec,
2236           os::errno_name(err), err);
2237 }
2238 #endif
2239 
2240 void os::pd_commit_memory_or_exit(char* addr, size_t size, bool exec,
2241                                   const char* mesg) {
2242   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2243   if (!pd_commit_memory(addr, size, exec)) {
2244     // Add extra info in product mode for vm_exit_out_of_memory():
2245     PRODUCT_ONLY(warn_fail_commit_memory(addr, size, exec, errno);)
2246     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2247   }
2248 }
2249 
2250 bool os::pd_commit_memory(char* addr, size_t size, bool exec) {
2251 
2252   assert(is_aligned_to(addr, os::vm_page_size()),
2253     &quot;addr &quot; PTR_FORMAT &quot; not aligned to vm_page_size (&quot; PTR_FORMAT &quot;)&quot;,
2254     p2i(addr), os::vm_page_size());
2255   assert(is_aligned_to(size, os::vm_page_size()),
2256     &quot;size &quot; PTR_FORMAT &quot; not aligned to vm_page_size (&quot; PTR_FORMAT &quot;)&quot;,
2257     size, os::vm_page_size());
2258 
2259   vmembk_t* const vmi = vmembk_find(addr);
2260   guarantee0(vmi);
2261   vmi-&gt;assert_is_valid_subrange(addr, size);
2262 
2263   trcVerbose(&quot;commit_memory [&quot; PTR_FORMAT &quot; - &quot; PTR_FORMAT &quot;].&quot;, addr, addr + size - 1);
2264 
2265   if (UseExplicitCommit) {
2266     // AIX commits memory on touch. So, touch all pages to be committed.
2267     for (char* p = addr; p &lt; (addr + size); p += 4*K) {
2268       *p = &#39;\0&#39;;
2269     }
2270   }
2271 
2272   return true;
2273 }
2274 
2275 bool os::pd_commit_memory(char* addr, size_t size, size_t alignment_hint, bool exec) {
2276   return pd_commit_memory(addr, size, exec);
2277 }
2278 
2279 void os::pd_commit_memory_or_exit(char* addr, size_t size,
2280                                   size_t alignment_hint, bool exec,
2281                                   const char* mesg) {
2282   // Alignment_hint is ignored on this OS.
2283   pd_commit_memory_or_exit(addr, size, exec, mesg);
2284 }
2285 
2286 bool os::pd_uncommit_memory(char* addr, size_t size) {
2287   assert(is_aligned_to(addr, os::vm_page_size()),
2288     &quot;addr &quot; PTR_FORMAT &quot; not aligned to vm_page_size (&quot; PTR_FORMAT &quot;)&quot;,
2289     p2i(addr), os::vm_page_size());
2290   assert(is_aligned_to(size, os::vm_page_size()),
2291     &quot;size &quot; PTR_FORMAT &quot; not aligned to vm_page_size (&quot; PTR_FORMAT &quot;)&quot;,
2292     size, os::vm_page_size());
2293 
2294   // Dynamically do different things for mmap/shmat.
2295   const vmembk_t* const vmi = vmembk_find(addr);
2296   guarantee0(vmi);
2297   vmi-&gt;assert_is_valid_subrange(addr, size);
2298 
2299   if (vmi-&gt;type == VMEM_SHMATED) {
2300     return uncommit_shmated_memory(addr, size);
2301   } else {
2302     return uncommit_mmaped_memory(addr, size);
2303   }
2304 }
2305 
2306 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
2307   // Do not call this; no need to commit stack pages on AIX.
2308   ShouldNotReachHere();
2309   return true;
2310 }
2311 
2312 bool os::remove_stack_guard_pages(char* addr, size_t size) {
2313   // Do not call this; no need to commit stack pages on AIX.
2314   ShouldNotReachHere();
2315   return true;
2316 }
2317 
2318 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
2319 }
2320 
2321 void os::pd_free_memory(char *addr, size_t bytes, size_t alignment_hint) {
2322 }
2323 
2324 void os::numa_make_global(char *addr, size_t bytes) {
2325 }
2326 
2327 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
2328 }
2329 
2330 bool os::numa_topology_changed() {
2331   return false;
2332 }
2333 
2334 size_t os::numa_get_groups_num() {
2335   return 1;
2336 }
2337 
2338 int os::numa_get_group_id() {
2339   return 0;
2340 }
2341 
2342 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
2343   if (size &gt; 0) {
2344     ids[0] = 0;
2345     return 1;
2346   }
2347   return 0;
2348 }
2349 
2350 bool os::get_page_info(char *start, page_info* info) {
2351   return false;
2352 }
2353 
2354 char *os::scan_pages(char *start, char* end, page_info* page_expected, page_info* page_found) {
2355   return end;
2356 }
2357 
2358 // Reserves and attaches a shared memory segment.
2359 // Will assert if a wish address is given and could not be obtained.
2360 char* os::pd_reserve_memory(size_t bytes, char* requested_addr, size_t alignment_hint) {
2361 
2362   // All other Unices do a mmap(MAP_FIXED) if the addr is given,
2363   // thereby clobbering old mappings at that place. That is probably
2364   // not intended, never used and almost certainly an error were it
2365   // ever be used this way (to try attaching at a specified address
2366   // without clobbering old mappings an alternate API exists,
2367   // os::attempt_reserve_memory_at()).
2368   // Instead of mimicking the dangerous coding of the other platforms, here I
2369   // just ignore the request address (release) or assert(debug).
2370   assert0(requested_addr == NULL);
2371 
2372   // Always round to os::vm_page_size(), which may be larger than 4K.
2373   bytes = align_up(bytes, os::vm_page_size());
2374   const size_t alignment_hint0 =
2375     alignment_hint ? align_up(alignment_hint, os::vm_page_size()) : 0;
2376 
2377   // In 4K mode always use mmap.
2378   // In 64K mode allocate small sizes with mmap, large ones with 64K shmatted.
2379   if (os::vm_page_size() == 4*K) {
2380     return reserve_mmaped_memory(bytes, requested_addr, alignment_hint);
2381   } else {
2382     if (bytes &gt;= Use64KPagesThreshold) {
2383       return reserve_shmated_memory(bytes, requested_addr, alignment_hint);
2384     } else {
2385       return reserve_mmaped_memory(bytes, requested_addr, alignment_hint);
2386     }
2387   }
2388 }
2389 
2390 bool os::pd_release_memory(char* addr, size_t size) {
2391 
2392   // Dynamically do different things for mmap/shmat.
2393   vmembk_t* const vmi = vmembk_find(addr);
2394   guarantee0(vmi);
2395 
2396   // Always round to os::vm_page_size(), which may be larger than 4K.
2397   size = align_up(size, os::vm_page_size());
2398   addr = align_up(addr, os::vm_page_size());
2399 
2400   bool rc = false;
2401   bool remove_bookkeeping = false;
2402   if (vmi-&gt;type == VMEM_SHMATED) {
2403     // For shmatted memory, we do:
2404     // - If user wants to release the whole range, release the memory (shmdt).
2405     // - If user only wants to release a partial range, uncommit (disclaim) that
2406     //   range. That way, at least, we do not use memory anymore (bust still page
2407     //   table space).
2408     vmi-&gt;assert_is_valid_subrange(addr, size);
2409     if (addr == vmi-&gt;addr &amp;&amp; size == vmi-&gt;size) {
2410       rc = release_shmated_memory(addr, size);
2411       remove_bookkeeping = true;
2412     } else {
2413       rc = uncommit_shmated_memory(addr, size);
2414     }
2415   } else {
2416     // User may unmap partial regions but region has to be fully contained.
2417 #ifdef ASSERT
2418     vmi-&gt;assert_is_valid_subrange(addr, size);
2419 #endif
2420     rc = release_mmaped_memory(addr, size);
2421     remove_bookkeeping = true;
2422   }
2423 
2424   // update bookkeeping
2425   if (rc &amp;&amp; remove_bookkeeping) {
2426     vmembk_remove(vmi);
2427   }
2428 
2429   return rc;
2430 }
2431 
2432 static bool checked_mprotect(char* addr, size_t size, int prot) {
2433 
2434   // Little problem here: if SPEC1170 behaviour is off, mprotect() on AIX will
2435   // not tell me if protection failed when trying to protect an un-protectable range.
2436   //
2437   // This means if the memory was allocated using shmget/shmat, protection wont work
2438   // but mprotect will still return 0:
2439   //
2440   // See http://publib.boulder.ibm.com/infocenter/pseries/v5r3/index.jsp?topic=/com.ibm.aix.basetechref/doc/basetrf1/mprotect.htm
2441 
2442   bool rc = ::mprotect(addr, size, prot) == 0 ? true : false;
2443 
2444   if (!rc) {
2445     const char* const s_errno = os::errno_name(errno);
2446     warning(&quot;mprotect(&quot; PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;, 0x%X) failed (%s).&quot;, addr, addr + size, prot, s_errno);
2447     return false;
2448   }
2449 
2450   // mprotect success check
2451   //
2452   // Mprotect said it changed the protection but can I believe it?
2453   //
2454   // To be sure I need to check the protection afterwards. Try to
2455   // read from protected memory and check whether that causes a segfault.
2456   //
2457   if (!os::Aix::xpg_sus_mode()) {
2458 
2459     if (CanUseSafeFetch32()) {
2460 
2461       const bool read_protected =
2462         (SafeFetch32((int*)addr, 0x12345678) == 0x12345678 &amp;&amp;
2463          SafeFetch32((int*)addr, 0x76543210) == 0x76543210) ? true : false;
2464 
2465       if (prot &amp; PROT_READ) {
2466         rc = !read_protected;
2467       } else {
2468         rc = read_protected;
2469       }
2470 
2471       if (!rc) {
2472         if (os::Aix::on_pase()) {
2473           // There is an issue on older PASE systems where mprotect() will return success but the
2474           // memory will not be protected.
2475           // This has nothing to do with the problem of using mproect() on SPEC1170 incompatible
2476           // machines; we only see it rarely, when using mprotect() to protect the guard page of
2477           // a stack. It is an OS error.
2478           //
2479           // A valid strategy is just to try again. This usually works. :-/
2480 
2481           ::usleep(1000);
2482           if (::mprotect(addr, size, prot) == 0) {
2483             const bool read_protected_2 =
2484               (SafeFetch32((int*)addr, 0x12345678) == 0x12345678 &amp;&amp;
2485               SafeFetch32((int*)addr, 0x76543210) == 0x76543210) ? true : false;
2486             rc = true;
2487           }
2488         }
2489       }
2490     }
2491   }
2492 
2493   assert(rc == true, &quot;mprotect failed.&quot;);
2494 
2495   return rc;
2496 }
2497 
2498 // Set protections specified
2499 bool os::protect_memory(char* addr, size_t size, ProtType prot, bool is_committed) {
2500   unsigned int p = 0;
2501   switch (prot) {
2502   case MEM_PROT_NONE: p = PROT_NONE; break;
2503   case MEM_PROT_READ: p = PROT_READ; break;
2504   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
2505   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
2506   default:
2507     ShouldNotReachHere();
2508   }
2509   // is_committed is unused.
2510   return checked_mprotect(addr, size, p);
2511 }
2512 
2513 bool os::guard_memory(char* addr, size_t size) {
2514   return checked_mprotect(addr, size, PROT_NONE);
2515 }
2516 
2517 bool os::unguard_memory(char* addr, size_t size) {
2518   return checked_mprotect(addr, size, PROT_READ|PROT_WRITE|PROT_EXEC);
2519 }
2520 
2521 // Large page support
2522 
2523 static size_t _large_page_size = 0;
2524 
2525 // Enable large page support if OS allows that.
2526 void os::large_page_init() {
2527   return; // Nothing to do. See query_multipage_support and friends.
2528 }
2529 
2530 char* os::reserve_memory_special(size_t bytes, size_t alignment, char* req_addr, bool exec) {
2531   // reserve_memory_special() is used to allocate large paged memory. On AIX, we implement
2532   // 64k paged memory reservation using the normal memory allocation paths (os::reserve_memory()),
2533   // so this is not needed.
2534   assert(false, &quot;should not be called on AIX&quot;);
2535   return NULL;
2536 }
2537 
2538 bool os::release_memory_special(char* base, size_t bytes) {
2539   // Detaching the SHM segment will also delete it, see reserve_memory_special().
2540   Unimplemented();
2541   return false;
2542 }
2543 
2544 size_t os::large_page_size() {
2545   return _large_page_size;
2546 }
2547 
2548 bool os::can_commit_large_page_memory() {
2549   // Does not matter, we do not support huge pages.
2550   return false;
2551 }
2552 
2553 bool os::can_execute_large_page_memory() {
2554   // Does not matter, we do not support huge pages.
2555   return false;
2556 }
2557 
2558 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
2559   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
2560   char* result = NULL;
2561 
2562   // Always round to os::vm_page_size(), which may be larger than 4K.
2563   bytes = align_up(bytes, os::vm_page_size());
2564   result = reserve_mmaped_memory(bytes, requested_addr, 0);
2565 
2566   if (result != NULL) {
2567     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
2568       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
2569     }
2570   }
2571   return result;
2572 }
2573 
2574 // Reserve memory at an arbitrary address, only if that area is
2575 // available (and not reserved for something else).
2576 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
2577   char* addr = NULL;
2578 
2579   // Always round to os::vm_page_size(), which may be larger than 4K.
2580   bytes = align_up(bytes, os::vm_page_size());
2581 
2582   // In 4K mode always use mmap.
2583   // In 64K mode allocate small sizes with mmap, large ones with 64K shmatted.
2584   if (os::vm_page_size() == 4*K) {
2585     return reserve_mmaped_memory(bytes, requested_addr, 0);
2586   } else {
2587     if (bytes &gt;= Use64KPagesThreshold) {
2588       return reserve_shmated_memory(bytes, requested_addr, 0);
2589     } else {
2590       return reserve_mmaped_memory(bytes, requested_addr, 0);
2591     }
2592   }
2593 
2594   return addr;
2595 }
2596 
2597 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
2598 void os::infinite_sleep() {
2599   while (true) {    // sleep forever ...
2600     ::sleep(100);   // ... 100 seconds at a time
2601   }
2602 }
2603 
2604 // Used to convert frequent JVM_Yield() to nops
2605 bool os::dont_yield() {
2606   return DontYieldALot;
2607 }
2608 
2609 void os::naked_yield() {
2610   sched_yield();
2611 }
2612 
2613 ////////////////////////////////////////////////////////////////////////////////
2614 // thread priority support
2615 
2616 // From AIX manpage to pthread_setschedparam
2617 // (see: http://publib.boulder.ibm.com/infocenter/pseries/v5r3/index.jsp?
2618 //    topic=/com.ibm.aix.basetechref/doc/basetrf1/pthread_setschedparam.htm):
2619 //
2620 // &quot;If schedpolicy is SCHED_OTHER, then sched_priority must be in the
2621 // range from 40 to 80, where 40 is the least favored priority and 80
2622 // is the most favored.&quot;
2623 //
2624 // (Actually, I doubt this even has an impact on AIX, as we do kernel
2625 // scheduling there; however, this still leaves iSeries.)
2626 //
2627 // We use the same values for AIX and PASE.
2628 int os::java_to_os_priority[CriticalPriority + 1] = {
2629   54,             // 0 Entry should never be used
2630 
2631   55,             // 1 MinPriority
2632   55,             // 2
2633   56,             // 3
2634 
2635   56,             // 4
2636   57,             // 5 NormPriority
2637   57,             // 6
2638 
2639   58,             // 7
2640   58,             // 8
2641   59,             // 9 NearMaxPriority
2642 
2643   60,             // 10 MaxPriority
2644 
2645   60              // 11 CriticalPriority
2646 };
2647 
2648 OSReturn os::set_native_priority(Thread* thread, int newpri) {
2649   if (!UseThreadPriorities) return OS_OK;
2650   pthread_t thr = thread-&gt;osthread()-&gt;pthread_id();
2651   int policy = SCHED_OTHER;
2652   struct sched_param param;
2653   param.sched_priority = newpri;
2654   int ret = pthread_setschedparam(thr, policy, &amp;param);
2655 
2656   if (ret != 0) {
2657     trcVerbose(&quot;Could not change priority for thread %d to %d (error %d, %s)&quot;,
2658         (int)thr, newpri, ret, os::errno_name(ret));
2659   }
2660   return (ret == 0) ? OS_OK : OS_ERR;
2661 }
2662 
2663 OSReturn os::get_native_priority(const Thread* const thread, int *priority_ptr) {
2664   if (!UseThreadPriorities) {
2665     *priority_ptr = java_to_os_priority[NormPriority];
2666     return OS_OK;
2667   }
2668   pthread_t thr = thread-&gt;osthread()-&gt;pthread_id();
2669   int policy = SCHED_OTHER;
2670   struct sched_param param;
2671   int ret = pthread_getschedparam(thr, &amp;policy, &amp;param);
2672   *priority_ptr = param.sched_priority;
2673 
2674   return (ret == 0) ? OS_OK : OS_ERR;
2675 }
2676 
2677 ////////////////////////////////////////////////////////////////////////////////
2678 // suspend/resume support
2679 
2680 //  The low-level signal-based suspend/resume support is a remnant from the
2681 //  old VM-suspension that used to be for java-suspension, safepoints etc,
2682 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
2683 //
2684 //  The remaining code is greatly simplified from the more general suspension
2685 //  code that used to be used.
2686 //
2687 //  The protocol is quite simple:
2688 //  - suspend:
2689 //      - sends a signal to the target thread
2690 //      - polls the suspend state of the osthread using a yield loop
2691 //      - target thread signal handler (SR_handler) sets suspend state
2692 //        and blocks in sigsuspend until continued
2693 //  - resume:
2694 //      - sets target osthread state to continue
2695 //      - sends signal to end the sigsuspend loop in the SR_handler
2696 //
2697 //  Note that the SR_lock plays no role in this suspend/resume protocol,
2698 //  but is checked for NULL in SR_handler as a thread termination indicator.
2699 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
2700 //
2701 //  Note that resume_clear_context() and suspend_save_context() are needed
2702 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
2703 //  which in part is used by:
2704 //    - Forte Analyzer: AsyncGetCallTrace()
2705 //    - StackBanging: get_frame_at_stack_banging_point()
2706 
2707 static void resume_clear_context(OSThread *osthread) {
2708   osthread-&gt;set_ucontext(NULL);
2709   osthread-&gt;set_siginfo(NULL);
2710 }
2711 
2712 static void suspend_save_context(OSThread *osthread, siginfo_t* siginfo, ucontext_t* context) {
2713   osthread-&gt;set_ucontext(context);
2714   osthread-&gt;set_siginfo(siginfo);
2715 }
2716 
2717 //
2718 // Handler function invoked when a thread&#39;s execution is suspended or
2719 // resumed. We have to be careful that only async-safe functions are
2720 // called here (Note: most pthread functions are not async safe and
2721 // should be avoided.)
2722 //
2723 // Note: sigwait() is a more natural fit than sigsuspend() from an
2724 // interface point of view, but sigwait() prevents the signal hander
2725 // from being run. libpthread would get very confused by not having
2726 // its signal handlers run and prevents sigwait()&#39;s use with the
2727 // mutex granting granting signal.
2728 //
2729 // Currently only ever called on the VMThread and JavaThreads (PC sampling).
2730 //
2731 static void SR_handler(int sig, siginfo_t* siginfo, ucontext_t* context) {
2732   // Save and restore errno to avoid confusing native code with EINTR
2733   // after sigsuspend.
2734   int old_errno = errno;
2735 
2736   Thread* thread = Thread::current_or_null_safe();
2737   assert(thread != NULL, &quot;Missing current thread in SR_handler&quot;);
2738 
2739   // On some systems we have seen signal delivery get &quot;stuck&quot; until the signal
2740   // mask is changed as part of thread termination. Check that the current thread
2741   // has not already terminated (via SR_lock()) - else the following assertion
2742   // will fail because the thread is no longer a JavaThread as the ~JavaThread
2743   // destructor has completed.
2744 
2745   if (thread-&gt;SR_lock() == NULL) {
2746     return;
2747   }
2748 
2749   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
2750 
2751   OSThread* osthread = thread-&gt;osthread();
2752 
2753   os::SuspendResume::State current = osthread-&gt;sr.state();
2754   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
2755     suspend_save_context(osthread, siginfo, context);
2756 
2757     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
2758     os::SuspendResume::State state = osthread-&gt;sr.suspended();
2759     if (state == os::SuspendResume::SR_SUSPENDED) {
2760       sigset_t suspend_set;  // signals for sigsuspend()
2761 
2762       // get current set of blocked signals and unblock resume signal
2763       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
2764       sigdelset(&amp;suspend_set, SR_signum);
2765 
2766       // wait here until we are resumed
2767       while (1) {
2768         sigsuspend(&amp;suspend_set);
2769 
2770         os::SuspendResume::State result = osthread-&gt;sr.running();
2771         if (result == os::SuspendResume::SR_RUNNING) {
2772           break;
2773         }
2774       }
2775 
2776     } else if (state == os::SuspendResume::SR_RUNNING) {
2777       // request was cancelled, continue
2778     } else {
2779       ShouldNotReachHere();
2780     }
2781 
2782     resume_clear_context(osthread);
2783   } else if (current == os::SuspendResume::SR_RUNNING) {
2784     // request was cancelled, continue
2785   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
2786     // ignore
2787   } else {
2788     ShouldNotReachHere();
2789   }
2790 
2791   errno = old_errno;
2792 }
2793 
2794 static int SR_initialize() {
2795   struct sigaction act;
2796   char *s;
2797   // Get signal number to use for suspend/resume
2798   if ((s = ::getenv(&quot;_JAVA_SR_SIGNUM&quot;)) != 0) {
2799     int sig = ::strtol(s, 0, 10);
2800     if (sig &gt; MAX2(SIGSEGV, SIGBUS) &amp;&amp;  // See 4355769.
2801         sig &lt; NSIG) {                   // Must be legal signal and fit into sigflags[].
2802       SR_signum = sig;
2803     } else {
2804       warning(&quot;You set _JAVA_SR_SIGNUM=%d. It must be in range [%d, %d]. Using %d instead.&quot;,
2805               sig, MAX2(SIGSEGV, SIGBUS)+1, NSIG-1, SR_signum);
2806     }
2807   }
2808 
2809   assert(SR_signum &gt; SIGSEGV &amp;&amp; SR_signum &gt; SIGBUS,
2810         &quot;SR_signum must be greater than max(SIGSEGV, SIGBUS), see 4355769&quot;);
2811 
2812   sigemptyset(&amp;SR_sigset);
2813   sigaddset(&amp;SR_sigset, SR_signum);
2814 
2815   // Set up signal handler for suspend/resume.
2816   act.sa_flags = SA_RESTART|SA_SIGINFO;
2817   act.sa_handler = (void (*)(int)) SR_handler;
2818 
2819   // SR_signum is blocked by default.
2820   pthread_sigmask(SIG_BLOCK, NULL, &amp;act.sa_mask);
2821 
2822   if (sigaction(SR_signum, &amp;act, 0) == -1) {
2823     return -1;
2824   }
2825 
2826   // Save signal flag
2827   os::Aix::set_our_sigflags(SR_signum, act.sa_flags);
2828   return 0;
2829 }
2830 
2831 static int SR_finalize() {
2832   return 0;
2833 }
2834 
2835 static int sr_notify(OSThread* osthread) {
2836   int status = pthread_kill(osthread-&gt;pthread_id(), SR_signum);
2837   assert_status(status == 0, status, &quot;pthread_kill&quot;);
2838   return status;
2839 }
2840 
2841 // &quot;Randomly&quot; selected value for how long we want to spin
2842 // before bailing out on suspending a thread, also how often
2843 // we send a signal to a thread we want to resume
2844 static const int RANDOMLY_LARGE_INTEGER = 1000000;
2845 static const int RANDOMLY_LARGE_INTEGER2 = 100;
2846 
2847 // returns true on success and false on error - really an error is fatal
2848 // but this seems the normal response to library errors
2849 static bool do_suspend(OSThread* osthread) {
2850   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
2851   // mark as suspended and send signal
2852 
2853   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
2854     // failed to switch, state wasn&#39;t running?
2855     ShouldNotReachHere();
2856     return false;
2857   }
2858 
2859   if (sr_notify(osthread) != 0) {
2860     // try to cancel, switch to running
2861 
2862     os::SuspendResume::State result = osthread-&gt;sr.cancel_suspend();
2863     if (result == os::SuspendResume::SR_RUNNING) {
2864       // cancelled
2865       return false;
2866     } else if (result == os::SuspendResume::SR_SUSPENDED) {
2867       // somehow managed to suspend
2868       return true;
2869     } else {
2870       ShouldNotReachHere();
2871       return false;
2872     }
2873   }
2874 
2875   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
2876 
2877   for (int n = 0; !osthread-&gt;sr.is_suspended(); n++) {
2878     for (int i = 0; i &lt; RANDOMLY_LARGE_INTEGER2 &amp;&amp; !osthread-&gt;sr.is_suspended(); i++) {
2879       os::naked_yield();
2880     }
2881 
2882     // timeout, try to cancel the request
2883     if (n &gt;= RANDOMLY_LARGE_INTEGER) {
2884       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
2885       if (cancelled == os::SuspendResume::SR_RUNNING) {
2886         return false;
2887       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
2888         return true;
2889       } else {
2890         ShouldNotReachHere();
2891         return false;
2892       }
2893     }
2894   }
2895 
2896   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
2897   return true;
2898 }
2899 
2900 static void do_resume(OSThread* osthread) {
2901   //assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
2902 
2903   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
2904     // failed to switch to WAKEUP_REQUEST
2905     ShouldNotReachHere();
2906     return;
2907   }
2908 
2909   while (!osthread-&gt;sr.is_running()) {
2910     if (sr_notify(osthread) == 0) {
2911       for (int n = 0; n &lt; RANDOMLY_LARGE_INTEGER &amp;&amp; !osthread-&gt;sr.is_running(); n++) {
2912         for (int i = 0; i &lt; 100 &amp;&amp; !osthread-&gt;sr.is_running(); i++) {
2913           os::naked_yield();
2914         }
2915       }
2916     } else {
2917       ShouldNotReachHere();
2918     }
2919   }
2920 
2921   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
2922 }
2923 
2924 ///////////////////////////////////////////////////////////////////////////////////
2925 // signal handling (except suspend/resume)
2926 
2927 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
2928 // The user-defined signal handler must pass unrecognized signals to this
2929 // routine, and if it returns true (non-zero), then the signal handler must
2930 // return immediately. If the flag &quot;abort_if_unrecognized&quot; is true, then this
2931 // routine will never retun false (zero), but instead will execute a VM panic
2932 // routine kill the process.
2933 //
2934 // If this routine returns false, it is OK to call it again. This allows
2935 // the user-defined signal handler to perform checks either before or after
2936 // the VM performs its own checks. Naturally, the user code would be making
2937 // a serious error if it tried to handle an exception (such as a null check
2938 // or breakpoint) that the VM was generating for its own correct operation.
2939 //
2940 // This routine may recognize any of the following kinds of signals:
2941 //   SIGBUS, SIGSEGV, SIGILL, SIGFPE, SIGQUIT, SIGPIPE, SIGXFSZ, SIGUSR1.
2942 // It should be consulted by handlers for any of those signals.
2943 //
2944 // The caller of this routine must pass in the three arguments supplied
2945 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
2946 // field of the structure passed to sigaction(). This routine assumes that
2947 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
2948 //
2949 // Note that the VM will print warnings if it detects conflicting signal
2950 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
2951 //
2952 extern &quot;C&quot; JNIEXPORT int
2953 JVM_handle_aix_signal(int signo, siginfo_t* siginfo, void* ucontext, int abort_if_unrecognized);
2954 
2955 // Set thread signal mask (for some reason on AIX sigthreadmask() seems
2956 // to be the thing to call; documentation is not terribly clear about whether
2957 // pthread_sigmask also works, and if it does, whether it does the same.
2958 bool set_thread_signal_mask(int how, const sigset_t* set, sigset_t* oset) {
2959   const int rc = ::pthread_sigmask(how, set, oset);
2960   // return value semantics differ slightly for error case:
2961   // pthread_sigmask returns error number, sigthreadmask -1 and sets global errno
2962   // (so, pthread_sigmask is more theadsafe for error handling)
2963   // But success is always 0.
2964   return rc == 0 ? true : false;
2965 }
2966 
2967 // Function to unblock all signals which are, according
2968 // to POSIX, typical program error signals. If they happen while being blocked,
2969 // they typically will bring down the process immediately.
2970 bool unblock_program_error_signals() {
2971   sigset_t set;
2972   ::sigemptyset(&amp;set);
2973   ::sigaddset(&amp;set, SIGILL);
2974   ::sigaddset(&amp;set, SIGBUS);
2975   ::sigaddset(&amp;set, SIGFPE);
2976   ::sigaddset(&amp;set, SIGSEGV);
2977   return set_thread_signal_mask(SIG_UNBLOCK, &amp;set, NULL);
2978 }
2979 
2980 // Renamed from &#39;signalHandler&#39; to avoid collision with other shared libs.
2981 static void javaSignalHandler(int sig, siginfo_t* info, void* uc) {
2982   assert(info != NULL &amp;&amp; uc != NULL, &quot;it must be old kernel&quot;);
2983 
2984   // Never leave program error signals blocked;
2985   // on all our platforms they would bring down the process immediately when
2986   // getting raised while being blocked.
2987   unblock_program_error_signals();
2988 
2989   int orig_errno = errno;  // Preserve errno value over signal handler.
2990   JVM_handle_aix_signal(sig, info, uc, true);
2991   errno = orig_errno;
2992 }
2993 
2994 // This boolean allows users to forward their own non-matching signals
2995 // to JVM_handle_aix_signal, harmlessly.
2996 bool os::Aix::signal_handlers_are_installed = false;
2997 
2998 // For signal-chaining
2999 bool os::Aix::libjsig_is_loaded = false;
3000 typedef struct sigaction *(*get_signal_t)(int);
3001 get_signal_t os::Aix::get_signal_action = NULL;
3002 
3003 struct sigaction* os::Aix::get_chained_signal_action(int sig) {
3004   struct sigaction *actp = NULL;
3005 
3006   if (libjsig_is_loaded) {
3007     // Retrieve the old signal handler from libjsig
3008     actp = (*get_signal_action)(sig);
3009   }
3010   if (actp == NULL) {
3011     // Retrieve the preinstalled signal handler from jvm
3012     actp = os::Posix::get_preinstalled_handler(sig);
3013   }
3014 
3015   return actp;
3016 }
3017 
3018 static bool call_chained_handler(struct sigaction *actp, int sig,
3019                                  siginfo_t *siginfo, void *context) {
3020   // Call the old signal handler
3021   if (actp-&gt;sa_handler == SIG_DFL) {
3022     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
3023     // instead of taking the default action.
3024     return false;
3025   } else if (actp-&gt;sa_handler != SIG_IGN) {
3026     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
3027       // automaticlly block the signal
3028       sigaddset(&amp;(actp-&gt;sa_mask), sig);
3029     }
3030 
3031     sa_handler_t hand = NULL;
3032     sa_sigaction_t sa = NULL;
3033     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
3034     // retrieve the chained handler
3035     if (siginfo_flag_set) {
3036       sa = actp-&gt;sa_sigaction;
3037     } else {
3038       hand = actp-&gt;sa_handler;
3039     }
3040 
3041     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
3042       actp-&gt;sa_handler = SIG_DFL;
3043     }
3044 
3045     // try to honor the signal mask
3046     sigset_t oset;
3047     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
3048 
3049     // call into the chained handler
3050     if (siginfo_flag_set) {
3051       (*sa)(sig, siginfo, context);
3052     } else {
3053       (*hand)(sig);
3054     }
3055 
3056     // restore the signal mask
3057     pthread_sigmask(SIG_SETMASK, &amp;oset, 0);
3058   }
3059   // Tell jvm&#39;s signal handler the signal is taken care of.
3060   return true;
3061 }
3062 
3063 bool os::Aix::chained_handler(int sig, siginfo_t* siginfo, void* context) {
3064   bool chained = false;
3065   // signal-chaining
3066   if (UseSignalChaining) {
3067     struct sigaction *actp = get_chained_signal_action(sig);
3068     if (actp != NULL) {
3069       chained = call_chained_handler(actp, sig, siginfo, context);
3070     }
3071   }
3072   return chained;
3073 }
3074 
3075 // for diagnostic
3076 int sigflags[NSIG];
3077 
3078 int os::Aix::get_our_sigflags(int sig) {
3079   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
3080   return sigflags[sig];
3081 }
3082 
3083 void os::Aix::set_our_sigflags(int sig, int flags) {
3084   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
3085   if (sig &gt; 0 &amp;&amp; sig &lt; NSIG) {
3086     sigflags[sig] = flags;
3087   }
3088 }
3089 
3090 void os::Aix::set_signal_handler(int sig, bool set_installed) {
3091   // Check for overwrite.
3092   struct sigaction oldAct;
3093   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
3094 
3095   void* oldhand = oldAct.sa_sigaction
3096     ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
3097     : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
3098   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
3099       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
3100       oldhand != CAST_FROM_FN_PTR(void*, (sa_sigaction_t)javaSignalHandler)) {
3101     if (AllowUserSignalHandlers || !set_installed) {
3102       // Do not overwrite; user takes responsibility to forward to us.
3103       return;
3104     } else if (UseSignalChaining) {
3105       // save the old handler in jvm
3106       os::Posix::save_preinstalled_handler(sig, oldAct);
3107       // libjsig also interposes the sigaction() call below and saves the
3108       // old sigaction on it own.
3109     } else {
3110       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
3111             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
3112     }
3113   }
3114 
3115   struct sigaction sigAct;
3116   sigfillset(&amp;(sigAct.sa_mask));
3117   if (!set_installed) {
3118     sigAct.sa_handler = SIG_DFL;
3119     sigAct.sa_flags = SA_RESTART;
3120   } else {
3121     sigAct.sa_sigaction = javaSignalHandler;
3122     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
3123   }
3124   // Save flags, which are set by ours
3125   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
3126   sigflags[sig] = sigAct.sa_flags;
3127 
3128   int ret = sigaction(sig, &amp;sigAct, &amp;oldAct);
3129   assert(ret == 0, &quot;check&quot;);
3130 
3131   void* oldhand2 = oldAct.sa_sigaction
3132                  ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
3133                  : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
3134   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
3135 }
3136 
3137 // install signal handlers for signals that HotSpot needs to
3138 // handle in order to support Java-level exception handling.
3139 void os::Aix::install_signal_handlers() {
3140   if (!signal_handlers_are_installed) {
3141     signal_handlers_are_installed = true;
3142 
3143     // signal-chaining
3144     typedef void (*signal_setting_t)();
3145     signal_setting_t begin_signal_setting = NULL;
3146     signal_setting_t end_signal_setting = NULL;
3147     begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3148                              dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
3149     if (begin_signal_setting != NULL) {
3150       end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3151                              dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
3152       get_signal_action = CAST_TO_FN_PTR(get_signal_t,
3153                             dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
3154       libjsig_is_loaded = true;
3155       assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
3156     }
3157     if (libjsig_is_loaded) {
3158       // Tell libjsig jvm is setting signal handlers.
3159       (*begin_signal_setting)();
3160     }
3161 
3162     set_signal_handler(SIGSEGV, true);
3163     set_signal_handler(SIGPIPE, true);
3164     set_signal_handler(SIGBUS, true);
3165     set_signal_handler(SIGILL, true);
3166     set_signal_handler(SIGFPE, true);
3167     set_signal_handler(SIGTRAP, true);
3168     set_signal_handler(SIGXFSZ, true);
3169 
3170     if (libjsig_is_loaded) {
3171       // Tell libjsig jvm finishes setting signal handlers.
3172       (*end_signal_setting)();
3173     }
3174 
3175     // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
3176     // and if UserSignalHandler is installed all bets are off.
3177     // Log that signal checking is off only if -verbose:jni is specified.
3178     if (CheckJNICalls) {
3179       if (libjsig_is_loaded) {
3180         tty-&gt;print_cr(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
3181         check_signals = false;
3182       }
3183       if (AllowUserSignalHandlers) {
3184         tty-&gt;print_cr(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
3185         check_signals = false;
3186       }
3187       // Need to initialize check_signal_done.
3188       ::sigemptyset(&amp;check_signal_done);
3189     }
3190   }
3191 }
3192 
3193 static const char* get_signal_handler_name(address handler,
3194                                            char* buf, int buflen) {
3195   int offset;
3196   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
3197   if (found) {
3198     // skip directory names
3199     const char *p1, *p2;
3200     p1 = buf;
3201     size_t len = strlen(os::file_separator());
3202     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
3203     // The way os::dll_address_to_library_name is implemented on Aix
3204     // right now, it always returns -1 for the offset which is not
3205     // terribly informative.
3206     // Will fix that. For now, omit the offset.
3207     jio_snprintf(buf, buflen, &quot;%s&quot;, p1);
3208   } else {
3209     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
3210   }
3211   return buf;
3212 }
3213 
3214 static void print_signal_handler(outputStream* st, int sig,
3215                                  char* buf, size_t buflen) {
3216   struct sigaction sa;
3217   sigaction(sig, NULL, &amp;sa);
3218 
3219   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
3220 
3221   address handler = (sa.sa_flags &amp; SA_SIGINFO)
3222     ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
3223     : CAST_FROM_FN_PTR(address, sa.sa_handler);
3224 
3225   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
3226     st-&gt;print(&quot;SIG_DFL&quot;);
3227   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
3228     st-&gt;print(&quot;SIG_IGN&quot;);
3229   } else {
3230     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
3231   }
3232 
3233   // Print readable mask.
3234   st-&gt;print(&quot;, sa_mask[0]=&quot;);
3235   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
3236 
3237   address rh = VMError::get_resetted_sighandler(sig);
3238   // May be, handler was resetted by VMError?
3239   if (rh != NULL) {
3240     handler = rh;
3241     sa.sa_flags = VMError::get_resetted_sigflags(sig);
3242   }
3243 
3244   // Print textual representation of sa_flags.
3245   st-&gt;print(&quot;, sa_flags=&quot;);
3246   os::Posix::print_sa_flags(st, sa.sa_flags);
3247 
3248   // Check: is it our handler?
3249   if (handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)javaSignalHandler) ||
3250       handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler)) {
3251     // It is our signal handler.
3252     // Check for flags, reset system-used one!
3253     if ((int)sa.sa_flags != os::Aix::get_our_sigflags(sig)) {
3254       st-&gt;print(&quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
3255                 os::Aix::get_our_sigflags(sig));
3256     }
3257   }
3258   st-&gt;cr();
3259 }
3260 
3261 #define DO_SIGNAL_CHECK(sig) \
3262   if (!sigismember(&amp;check_signal_done, sig)) \
3263     os::Aix::check_signal_handler(sig)
3264 
3265 // This method is a periodic task to check for misbehaving JNI applications
3266 // under CheckJNI, we can add any periodic checks here
3267 
3268 void os::run_periodic_checks() {
3269 
3270   if (check_signals == false) return;
3271 
3272   // SEGV and BUS if overridden could potentially prevent
3273   // generation of hs*.log in the event of a crash, debugging
3274   // such a case can be very challenging, so we absolutely
3275   // check the following for a good measure:
3276   DO_SIGNAL_CHECK(SIGSEGV);
3277   DO_SIGNAL_CHECK(SIGILL);
3278   DO_SIGNAL_CHECK(SIGFPE);
3279   DO_SIGNAL_CHECK(SIGBUS);
3280   DO_SIGNAL_CHECK(SIGPIPE);
3281   DO_SIGNAL_CHECK(SIGXFSZ);
3282   if (UseSIGTRAP) {
3283     DO_SIGNAL_CHECK(SIGTRAP);
3284   }
3285 
3286   // ReduceSignalUsage allows the user to override these handlers
3287   // see comments at the very top and jvm_md.h
3288   if (!ReduceSignalUsage) {
3289     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
3290     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
3291     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
3292     DO_SIGNAL_CHECK(BREAK_SIGNAL);
3293   }
3294 
3295   DO_SIGNAL_CHECK(SR_signum);
3296 }
3297 
3298 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
3299 
3300 static os_sigaction_t os_sigaction = NULL;
3301 
3302 void os::Aix::check_signal_handler(int sig) {
3303   char buf[O_BUFLEN];
3304   address jvmHandler = NULL;
3305 
3306   struct sigaction act;
3307   if (os_sigaction == NULL) {
3308     // only trust the default sigaction, in case it has been interposed
3309     os_sigaction = CAST_TO_FN_PTR(os_sigaction_t, dlsym(RTLD_DEFAULT, &quot;sigaction&quot;));
3310     if (os_sigaction == NULL) return;
3311   }
3312 
3313   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
3314 
3315   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
3316     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
3317     : CAST_FROM_FN_PTR(address, act.sa_handler);
3318 
3319   switch(sig) {
3320   case SIGSEGV:
3321   case SIGBUS:
3322   case SIGFPE:
3323   case SIGPIPE:
3324   case SIGILL:
3325   case SIGXFSZ:
3326     jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)javaSignalHandler);
3327     break;
3328 
3329   case SHUTDOWN1_SIGNAL:
3330   case SHUTDOWN2_SIGNAL:
3331   case SHUTDOWN3_SIGNAL:
3332   case BREAK_SIGNAL:
3333     jvmHandler = (address)user_handler();
3334     break;
3335 
3336   default:
3337     if (sig == SR_signum) {
3338       jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler);
3339     } else {
3340       return;
3341     }
3342     break;
3343   }
3344 
3345   if (thisHandler != jvmHandler) {
3346     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
3347     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
3348     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
3349     // No need to check this sig any longer
3350     sigaddset(&amp;check_signal_done, sig);
3351     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
3352     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
3353       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
3354                     exception_name(sig, buf, O_BUFLEN));
3355     }
3356   } else if (os::Aix::get_our_sigflags(sig) != 0 &amp;&amp; (int)act.sa_flags != os::Aix::get_our_sigflags(sig)) {
3357     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
3358     tty-&gt;print(&quot;expected:&quot;);
3359     os::Posix::print_sa_flags(tty, os::Aix::get_our_sigflags(sig));
3360     tty-&gt;cr();
3361     tty-&gt;print(&quot;  found:&quot;);
3362     os::Posix::print_sa_flags(tty, act.sa_flags);
3363     tty-&gt;cr();
3364     // No need to check this sig any longer
3365     sigaddset(&amp;check_signal_done, sig);
3366   }
3367 
3368   // Dump all the signal
3369   if (sigismember(&amp;check_signal_done, sig)) {
3370     print_signal_handlers(tty, buf, O_BUFLEN);
3371   }
3372 }
3373 
3374 // To install functions for atexit system call
3375 extern &quot;C&quot; {
3376   static void perfMemory_exit_helper() {
3377     perfMemory_exit();
3378   }
3379 }
3380 
3381 // This is called _before_ the most of global arguments have been parsed.
3382 void os::init(void) {
3383   // This is basic, we want to know if that ever changes.
3384   // (Shared memory boundary is supposed to be a 256M aligned.)
3385   assert(SHMLBA == ((uint64_t)0x10000000ULL)/*256M*/, &quot;unexpected&quot;);
3386 
3387   // Record process break at startup.
3388   g_brk_at_startup = (address) ::sbrk(0);
3389   assert(g_brk_at_startup != (address) -1, &quot;sbrk failed&quot;);
3390 
3391   // First off, we need to know whether we run on AIX or PASE, and
3392   // the OS level we run on.
3393   os::Aix::initialize_os_info();
3394 
3395   // Scan environment (SPEC1170 behaviour, etc).
3396   os::Aix::scan_environment();
3397 
3398   // Probe multipage support.
3399   query_multipage_support();
3400 
3401   // Act like we only have one page size by eliminating corner cases which
3402   // we did not support very well anyway.
3403   // We have two input conditions:
3404   // 1) Data segment page size. This is controlled by linker setting (datapsize) on the
3405   //    launcher, and/or by LDR_CNTRL environment variable. The latter overrules the linker
3406   //    setting.
3407   //    Data segment page size is important for us because it defines the thread stack page
3408   //    size, which is needed for guard page handling, stack banging etc.
3409   // 2) The ability to allocate 64k pages dynamically. If this is a given, java heap can
3410   //    and should be allocated with 64k pages.
3411   //
3412   // So, we do the following:
3413   // LDR_CNTRL    can_use_64K_pages_dynamically       what we do                      remarks
3414   // 4K           no                                  4K                              old systems (aix 5.2, as/400 v5r4) or new systems with AME activated
3415   // 4k           yes                                 64k (treat 4k stacks as 64k)    different loader than java and standard settings
3416   // 64k          no              --- AIX 5.2 ? ---
3417   // 64k          yes                                 64k                             new systems and standard java loader (we set datapsize=64k when linking)
3418 
3419   // We explicitly leave no option to change page size, because only upgrading would work,
3420   // not downgrading (if stack page size is 64k you cannot pretend its 4k).
3421 
3422   if (g_multipage_support.datapsize == 4*K) {
3423     // datapsize = 4K. Data segment, thread stacks are 4K paged.
3424     if (g_multipage_support.can_use_64K_pages) {
3425       // .. but we are able to use 64K pages dynamically.
3426       // This would be typical for java launchers which are not linked
3427       // with datapsize=64K (like, any other launcher but our own).
3428       //
3429       // In this case it would be smart to allocate the java heap with 64K
3430       // to get the performance benefit, and to fake 64k pages for the
3431       // data segment (when dealing with thread stacks).
3432       //
3433       // However, leave a possibility to downgrade to 4K, using
3434       // -XX:-Use64KPages.
3435       if (Use64KPages) {
3436         trcVerbose(&quot;64K page mode (faked for data segment)&quot;);
3437         Aix::_page_size = 64*K;
3438       } else {
3439         trcVerbose(&quot;4K page mode (Use64KPages=off)&quot;);
3440         Aix::_page_size = 4*K;
3441       }
3442     } else {
3443       // .. and not able to allocate 64k pages dynamically. Here, just
3444       // fall back to 4K paged mode and use mmap for everything.
3445       trcVerbose(&quot;4K page mode&quot;);
3446       Aix::_page_size = 4*K;
3447       FLAG_SET_ERGO(bool, Use64KPages, false);
3448     }
3449   } else {
3450     // datapsize = 64k. Data segment, thread stacks are 64k paged.
3451     // This normally means that we can allocate 64k pages dynamically.
3452     // (There is one special case where this may be false: EXTSHM=on.
3453     // but we decided to not support that mode).
3454     assert0(g_multipage_support.can_use_64K_pages);
3455     Aix::_page_size = 64*K;
3456     trcVerbose(&quot;64K page mode&quot;);
3457     FLAG_SET_ERGO(bool, Use64KPages, true);
3458   }
3459 
3460   // For now UseLargePages is just ignored.
3461   FLAG_SET_ERGO(bool, UseLargePages, false);
3462   _page_sizes[0] = 0;
3463 
3464   // debug trace
3465   trcVerbose(&quot;os::vm_page_size %s&quot;, describe_pagesize(os::vm_page_size()));
3466 
3467   // Next, we need to initialize libo4 and libperfstat libraries.
3468   if (os::Aix::on_pase()) {
3469     os::Aix::initialize_libo4();
3470   } else {
3471     os::Aix::initialize_libperfstat();
3472   }
3473 
3474   // Reset the perfstat information provided by ODM.
3475   if (os::Aix::on_aix()) {
3476     libperfstat::perfstat_reset();
3477   }
3478 
3479   // Now initialze basic system properties. Note that for some of the values we
3480   // need libperfstat etc.
3481   os::Aix::initialize_system_info();
3482 
3483   clock_tics_per_sec = sysconf(_SC_CLK_TCK);
3484 
3485   init_random(1234567);
3486 
3487   // _main_thread points to the thread that created/loaded the JVM.
3488   Aix::_main_thread = pthread_self();
3489 
3490   initial_time_count = os::elapsed_counter();
3491 
3492   os::Posix::init();
3493 }
3494 
3495 // This is called _after_ the global arguments have been parsed.
3496 jint os::init_2(void) {
3497 
3498   // This could be set after os::Posix::init() but all platforms
3499   // have to set it the same so we have to mirror Solaris.
3500   DEBUG_ONLY(os::set_mutex_init_done();)
3501 
3502   os::Posix::init_2();
3503 
3504   if (os::Aix::on_pase()) {
3505     trcVerbose(&quot;Running on PASE.&quot;);
3506   } else {
3507     trcVerbose(&quot;Running on AIX (not PASE).&quot;);
3508   }
3509 
3510   trcVerbose(&quot;processor count: %d&quot;, os::_processor_count);
3511   trcVerbose(&quot;physical memory: %lu&quot;, Aix::_physical_memory);
3512 
3513   // Initially build up the loaded dll map.
3514   LoadedLibraries::reload();
3515   if (Verbose) {
3516     trcVerbose(&quot;Loaded Libraries: &quot;);
3517     LoadedLibraries::print(tty);
3518   }
3519 
3520   // initialize suspend/resume support - must do this before signal_sets_init()
3521   if (SR_initialize() != 0) {
3522     perror(&quot;SR_initialize failed&quot;);
3523     return JNI_ERR;
3524   }
3525 
3526   Aix::signal_sets_init();
3527   Aix::install_signal_handlers();
3528   // Initialize data for jdk.internal.misc.Signal
3529   if (!ReduceSignalUsage) {
3530     jdk_misc_signal_init();
3531   }
3532 
3533   // Check and sets minimum stack sizes against command line options
3534   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
3535     return JNI_ERR;
3536   }
3537 
3538   if (UseNUMA) {
3539     UseNUMA = false;
3540     warning(&quot;NUMA optimizations are not available on this OS.&quot;);
3541   }
3542 
3543   if (MaxFDLimit) {
3544     // Set the number of file descriptors to max. print out error
3545     // if getrlimit/setrlimit fails but continue regardless.
3546     struct rlimit nbr_files;
3547     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3548     if (status != 0) {
3549       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
3550     } else {
3551       nbr_files.rlim_cur = nbr_files.rlim_max;
3552       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
3553       if (status != 0) {
3554         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
3555       }
3556     }
3557   }
3558 
3559   if (PerfAllowAtExitRegistration) {
3560     // Only register atexit functions if PerfAllowAtExitRegistration is set.
3561     // At exit functions can be delayed until process exit time, which
3562     // can be problematic for embedded VM situations. Embedded VMs should
3563     // call DestroyJavaVM() to assure that VM resources are released.
3564 
3565     // Note: perfMemory_exit_helper atexit function may be removed in
3566     // the future if the appropriate cleanup code can be added to the
3567     // VM_Exit VMOperation&#39;s doit method.
3568     if (atexit(perfMemory_exit_helper) != 0) {
3569       warning(&quot;os::init_2 atexit(perfMemory_exit_helper) failed&quot;);
3570     }
3571   }
3572 
3573   return JNI_OK;
3574 }
3575 
3576 // Mark the polling page as unreadable
3577 void os::make_polling_page_unreadable(void) {
3578   if (!guard_memory((char*)_polling_page, Aix::page_size())) {
3579     fatal(&quot;Could not disable polling page&quot;);
3580   }
3581 };
3582 
3583 // Mark the polling page as readable
3584 void os::make_polling_page_readable(void) {
3585   // Changed according to os_linux.cpp.
3586   if (!checked_mprotect((char *)_polling_page, Aix::page_size(), PROT_READ)) {
3587     fatal(&quot;Could not enable polling page at &quot; PTR_FORMAT, _polling_page);
3588   }
3589 };
3590 
3591 int os::active_processor_count() {
3592   // User has overridden the number of active processors
3593   if (ActiveProcessorCount &gt; 0) {
3594     log_trace(os)(&quot;active_processor_count: &quot;
3595                   &quot;active processor count set by user : %d&quot;,
3596                   ActiveProcessorCount);
3597     return ActiveProcessorCount;
3598   }
3599 
3600   int online_cpus = ::sysconf(_SC_NPROCESSORS_ONLN);
3601   assert(online_cpus &gt; 0 &amp;&amp; online_cpus &lt;= processor_count(), &quot;sanity check&quot;);
3602   return online_cpus;
3603 }
3604 
3605 void os::set_native_thread_name(const char *name) {
3606   // Not yet implemented.
3607   return;
3608 }
3609 
3610 bool os::distribute_processes(uint length, uint* distribution) {
3611   // Not yet implemented.
3612   return false;
3613 }
3614 
3615 bool os::bind_to_processor(uint processor_id) {
3616   // Not yet implemented.
3617   return false;
3618 }
3619 
3620 void os::SuspendedThreadTask::internal_do_task() {
3621   if (do_suspend(_thread-&gt;osthread())) {
3622     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
3623     do_task(context);
3624     do_resume(_thread-&gt;osthread());
3625   }
3626 }
3627 
3628 ////////////////////////////////////////////////////////////////////////////////
3629 // debug support
3630 
3631 bool os::find(address addr, outputStream* st) {
3632 
3633   st-&gt;print(PTR_FORMAT &quot;: &quot;, addr);
3634 
3635   loaded_module_t lm;
3636   if (LoadedLibraries::find_for_text_address(addr, &amp;lm) != NULL ||
3637       LoadedLibraries::find_for_data_address(addr, &amp;lm) != NULL) {
3638     st-&gt;print_cr(&quot;%s&quot;, lm.path);
3639     return true;
3640   }
3641 
3642   return false;
3643 }
3644 
3645 ////////////////////////////////////////////////////////////////////////////////
3646 // misc
3647 
3648 // This does not do anything on Aix. This is basically a hook for being
3649 // able to use structured exception handling (thread-local exception filters)
3650 // on, e.g., Win32.
3651 void
3652 os::os_exception_wrapper(java_call_t f, JavaValue* value, const methodHandle&amp; method,
3653                          JavaCallArguments* args, Thread* thread) {
3654   f(value, method, args, thread);
3655 }
3656 
3657 void os::print_statistics() {
3658 }
3659 
3660 bool os::message_box(const char* title, const char* message) {
3661   int i;
3662   fdStream err(defaultStream::error_fd());
3663   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3664   err.cr();
3665   err.print_raw_cr(title);
3666   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
3667   err.cr();
3668   err.print_raw_cr(message);
3669   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3670   err.cr();
3671 
3672   char buf[16];
3673   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
3674   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
3675 
3676   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
3677 }
3678 
3679 // Is a (classpath) directory empty?
3680 bool os::dir_is_empty(const char* path) {
3681   DIR *dir = NULL;
3682   struct dirent *ptr;
3683 
3684   dir = opendir(path);
3685   if (dir == NULL) return true;
3686 
3687   /* Scan the directory */
3688   bool result = true;
3689   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
3690     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
3691       result = false;
3692     }
3693   }
3694   closedir(dir);
3695   return result;
3696 }
3697 
3698 // This code originates from JDK&#39;s sysOpen and open64_w
3699 // from src/solaris/hpi/src/system_md.c
3700 
3701 int os::open(const char *path, int oflag, int mode) {
3702 
3703   if (strlen(path) &gt; MAX_PATH - 1) {
3704     errno = ENAMETOOLONG;
3705     return -1;
3706   }
3707   int fd;
3708 
3709   fd = ::open64(path, oflag, mode);
3710   if (fd == -1) return -1;
3711 
3712   // If the open succeeded, the file might still be a directory.
3713   {
3714     struct stat64 buf64;
3715     int ret = ::fstat64(fd, &amp;buf64);
3716     int st_mode = buf64.st_mode;
3717 
3718     if (ret != -1) {
3719       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
3720         errno = EISDIR;
3721         ::close(fd);
3722         return -1;
3723       }
3724     } else {
3725       ::close(fd);
3726       return -1;
3727     }
3728   }
3729 
3730   // All file descriptors that are opened in the JVM and not
3731   // specifically destined for a subprocess should have the
3732   // close-on-exec flag set. If we don&#39;t set it, then careless 3rd
3733   // party native code might fork and exec without closing all
3734   // appropriate file descriptors (e.g. as we do in closeDescriptors in
3735   // UNIXProcess.c), and this in turn might:
3736   //
3737   // - cause end-of-file to fail to be detected on some file
3738   //   descriptors, resulting in mysterious hangs, or
3739   //
3740   // - might cause an fopen in the subprocess to fail on a system
3741   //   suffering from bug 1085341.
3742   //
3743   // (Yes, the default setting of the close-on-exec flag is a Unix
3744   // design flaw.)
3745   //
3746   // See:
3747   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
3748   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
3749   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
3750 #ifdef FD_CLOEXEC
3751   {
3752     int flags = ::fcntl(fd, F_GETFD);
3753     if (flags != -1)
3754       ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
3755   }
3756 #endif
3757 
3758   return fd;
3759 }
3760 
3761 // create binary file, rewriting existing file if required
3762 int os::create_binary_file(const char* path, bool rewrite_existing) {
3763   int oflags = O_WRONLY | O_CREAT;
3764   if (!rewrite_existing) {
3765     oflags |= O_EXCL;
3766   }
3767   return ::open64(path, oflags, S_IREAD | S_IWRITE);
3768 }
3769 
3770 // return current position of file pointer
3771 jlong os::current_file_offset(int fd) {
3772   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
3773 }
3774 
3775 // move file pointer to the specified offset
3776 jlong os::seek_to_file_offset(int fd, jlong offset) {
3777   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
3778 }
3779 
3780 // This code originates from JDK&#39;s sysAvailable
3781 // from src/solaris/hpi/src/native_threads/src/sys_api_td.c
3782 
3783 int os::available(int fd, jlong *bytes) {
3784   jlong cur, end;
3785   int mode;
3786   struct stat64 buf64;
3787 
3788   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
3789     mode = buf64.st_mode;
3790     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
3791       int n;
3792       if (::ioctl(fd, FIONREAD, &amp;n) &gt;= 0) {
3793         *bytes = n;
3794         return 1;
3795       }
3796     }
3797   }
3798   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
3799     return 0;
3800   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
3801     return 0;
3802   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
3803     return 0;
3804   }
3805   *bytes = end - cur;
3806   return 1;
3807 }
3808 
3809 // Map a block of memory.
3810 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
3811                         char *addr, size_t bytes, bool read_only,
3812                         bool allow_exec) {
3813   int prot;
3814   int flags = MAP_PRIVATE;
3815 
3816   if (read_only) {
3817     prot = PROT_READ;
3818     flags = MAP_SHARED;
3819   } else {
3820     prot = PROT_READ | PROT_WRITE;
3821     flags = MAP_PRIVATE;
3822   }
3823 
3824   if (allow_exec) {
3825     prot |= PROT_EXEC;
3826   }
3827 
3828   if (addr != NULL) {
3829     flags |= MAP_FIXED;
3830   }
3831 
3832   // Allow anonymous mappings if &#39;fd&#39; is -1.
3833   if (fd == -1) {
3834     flags |= MAP_ANONYMOUS;
3835   }
3836 
3837   char* mapped_address = (char*)::mmap(addr, (size_t)bytes, prot, flags,
3838                                      fd, file_offset);
3839   if (mapped_address == MAP_FAILED) {
3840     return NULL;
3841   }
3842   return mapped_address;
3843 }
3844 
3845 // Remap a block of memory.
3846 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
3847                           char *addr, size_t bytes, bool read_only,
3848                           bool allow_exec) {
3849   // same as map_memory() on this OS
3850   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
3851                         allow_exec);
3852 }
3853 
3854 // Unmap a block of memory.
3855 bool os::pd_unmap_memory(char* addr, size_t bytes) {
3856   return munmap(addr, bytes) == 0;
3857 }
3858 
3859 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
3860 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
3861 // of a thread.
3862 //
3863 // current_thread_cpu_time() and thread_cpu_time(Thread*) returns
3864 // the fast estimate available on the platform.
3865 
3866 jlong os::current_thread_cpu_time() {
3867   // return user + sys since the cost is the same
3868   const jlong n = os::thread_cpu_time(Thread::current(), true /* user + sys */);
3869   assert(n &gt;= 0, &quot;negative CPU time&quot;);
3870   return n;
3871 }
3872 
3873 jlong os::thread_cpu_time(Thread* thread) {
3874   // consistent with what current_thread_cpu_time() returns
3875   const jlong n = os::thread_cpu_time(thread, true /* user + sys */);
3876   assert(n &gt;= 0, &quot;negative CPU time&quot;);
3877   return n;
3878 }
3879 
3880 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
3881   const jlong n = os::thread_cpu_time(Thread::current(), user_sys_cpu_time);
3882   assert(n &gt;= 0, &quot;negative CPU time&quot;);
3883   return n;
3884 }
3885 
3886 static bool thread_cpu_time_unchecked(Thread* thread, jlong* p_sys_time, jlong* p_user_time) {
3887   bool error = false;
3888 
3889   jlong sys_time = 0;
3890   jlong user_time = 0;
3891 
3892   // Reimplemented using getthrds64().
3893   //
3894   // Works like this:
3895   // For the thread in question, get the kernel thread id. Then get the
3896   // kernel thread statistics using that id.
3897   //
3898   // This only works of course when no pthread scheduling is used,
3899   // i.e. there is a 1:1 relationship to kernel threads.
3900   // On AIX, see AIXTHREAD_SCOPE variable.
3901 
3902   pthread_t pthtid = thread-&gt;osthread()-&gt;pthread_id();
3903 
3904   // retrieve kernel thread id for the pthread:
3905   tid64_t tid = 0;
3906   struct __pthrdsinfo pinfo;
3907   // I just love those otherworldly IBM APIs which force me to hand down
3908   // dummy buffers for stuff I dont care for...
3909   char dummy[1];
3910   int dummy_size = sizeof(dummy);
3911   if (pthread_getthrds_np(&amp;pthtid, PTHRDSINFO_QUERY_TID, &amp;pinfo, sizeof(pinfo),
3912                           dummy, &amp;dummy_size) == 0) {
3913     tid = pinfo.__pi_tid;
3914   } else {
3915     tty-&gt;print_cr(&quot;pthread_getthrds_np failed.&quot;);
3916     error = true;
3917   }
3918 
3919   // retrieve kernel timing info for that kernel thread
3920   if (!error) {
3921     struct thrdentry64 thrdentry;
3922     if (getthrds64(getpid(), &amp;thrdentry, sizeof(thrdentry), &amp;tid, 1) == 1) {
3923       sys_time = thrdentry.ti_ru.ru_stime.tv_sec * 1000000000LL + thrdentry.ti_ru.ru_stime.tv_usec * 1000LL;
3924       user_time = thrdentry.ti_ru.ru_utime.tv_sec * 1000000000LL + thrdentry.ti_ru.ru_utime.tv_usec * 1000LL;
3925     } else {
3926       tty-&gt;print_cr(&quot;pthread_getthrds_np failed.&quot;);
3927       error = true;
3928     }
3929   }
3930 
3931   if (p_sys_time) {
3932     *p_sys_time = sys_time;
3933   }
3934 
3935   if (p_user_time) {
3936     *p_user_time = user_time;
3937   }
3938 
3939   if (error) {
3940     return false;
3941   }
3942 
3943   return true;
3944 }
3945 
3946 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
3947   jlong sys_time;
3948   jlong user_time;
3949 
3950   if (!thread_cpu_time_unchecked(thread, &amp;sys_time, &amp;user_time)) {
3951     return -1;
3952   }
3953 
3954   return user_sys_cpu_time ? sys_time + user_time : user_time;
3955 }
3956 
3957 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
3958   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
3959   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
3960   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
3961   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
3962 }
3963 
3964 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
3965   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
3966   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
3967   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
3968   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
3969 }
3970 
3971 bool os::is_thread_cpu_time_supported() {
3972   return true;
3973 }
3974 
3975 // System loadavg support. Returns -1 if load average cannot be obtained.
3976 // For now just return the system wide load average (no processor sets).
3977 int os::loadavg(double values[], int nelem) {
3978 
3979   guarantee(nelem &gt;= 0 &amp;&amp; nelem &lt;= 3, &quot;argument error&quot;);
3980   guarantee(values, &quot;argument error&quot;);
3981 
3982   if (os::Aix::on_pase()) {
3983 
3984     // AS/400 PASE: use libo4 porting library
3985     double v[3] = { 0.0, 0.0, 0.0 };
3986 
3987     if (libo4::get_load_avg(v, v + 1, v + 2)) {
3988       for (int i = 0; i &lt; nelem; i ++) {
3989         values[i] = v[i];
3990       }
3991       return nelem;
3992     } else {
3993       return -1;
3994     }
3995 
3996   } else {
3997 
3998     // AIX: use libperfstat
3999     libperfstat::cpuinfo_t ci;
4000     if (libperfstat::get_cpuinfo(&amp;ci)) {
4001       for (int i = 0; i &lt; nelem; i++) {
4002         values[i] = ci.loadavg[i];
4003       }
4004     } else {
4005       return -1;
4006     }
4007     return nelem;
4008   }
4009 }
4010 
4011 void os::pause() {
4012   char filename[MAX_PATH];
4013   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
4014     jio_snprintf(filename, MAX_PATH, PauseAtStartupFile);
4015   } else {
4016     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
4017   }
4018 
4019   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
4020   if (fd != -1) {
4021     struct stat buf;
4022     ::close(fd);
4023     while (::stat(filename, &amp;buf) == 0) {
4024       (void)::poll(NULL, 0, 100);
4025     }
4026   } else {
4027     trcVerbose(&quot;Could not open pause file &#39;%s&#39;, continuing immediately.&quot;, filename);
4028   }
4029 }
4030 
4031 bool os::is_primordial_thread(void) {
4032   if (pthread_self() == (pthread_t)1) {
4033     return true;
4034   } else {
4035     return false;
4036   }
4037 }
4038 
4039 // OS recognitions (PASE/AIX, OS level) call this before calling any
4040 // one of Aix::on_pase(), Aix::os_version() static
4041 void os::Aix::initialize_os_info() {
4042 
4043   assert(_on_pase == -1 &amp;&amp; _os_version == 0, &quot;already called.&quot;);
4044 
4045   struct utsname uts;
4046   memset(&amp;uts, 0, sizeof(uts));
4047   strcpy(uts.sysname, &quot;?&quot;);
4048   if (::uname(&amp;uts) == -1) {
4049     trcVerbose(&quot;uname failed (%d)&quot;, errno);
4050     guarantee(0, &quot;Could not determine whether we run on AIX or PASE&quot;);
4051   } else {
4052     trcVerbose(&quot;uname says: sysname \&quot;%s\&quot; version \&quot;%s\&quot; release \&quot;%s\&quot; &quot;
4053                &quot;node \&quot;%s\&quot; machine \&quot;%s\&quot;\n&quot;,
4054                uts.sysname, uts.version, uts.release, uts.nodename, uts.machine);
4055     const int major = atoi(uts.version);
4056     assert(major &gt; 0, &quot;invalid OS version&quot;);
4057     const int minor = atoi(uts.release);
4058     assert(minor &gt; 0, &quot;invalid OS release&quot;);
4059     _os_version = (major &lt;&lt; 24) | (minor &lt;&lt; 16);
4060     char ver_str[20] = {0};
4061     char *name_str = &quot;unknown OS&quot;;
4062     if (strcmp(uts.sysname, &quot;OS400&quot;) == 0) {
4063       // We run on AS/400 PASE. We do not support versions older than V5R4M0.
4064       _on_pase = 1;
4065       if (os_version_short() &lt; 0x0504) {
4066         trcVerbose(&quot;OS/400 releases older than V5R4M0 not supported.&quot;);
4067         assert(false, &quot;OS/400 release too old.&quot;);
4068       }
4069       name_str = &quot;OS/400 (pase)&quot;;
4070       jio_snprintf(ver_str, sizeof(ver_str), &quot;%u.%u&quot;, major, minor);
4071     } else if (strcmp(uts.sysname, &quot;AIX&quot;) == 0) {
4072       // We run on AIX. We do not support versions older than AIX 5.3.
4073       _on_pase = 0;
4074       // Determine detailed AIX version: Version, Release, Modification, Fix Level.
4075       odmWrapper::determine_os_kernel_version(&amp;_os_version);
4076       if (os_version_short() &lt; 0x0503) {
4077         trcVerbose(&quot;AIX release older than AIX 5.3 not supported.&quot;);
4078         assert(false, &quot;AIX release too old.&quot;);
4079       }
4080       name_str = &quot;AIX&quot;;
4081       jio_snprintf(ver_str, sizeof(ver_str), &quot;%u.%u.%u.%u&quot;,
4082                    major, minor, (_os_version &gt;&gt; 8) &amp; 0xFF, _os_version &amp; 0xFF);
4083     } else {
4084       assert(false, name_str);
4085     }
4086     trcVerbose(&quot;We run on %s %s&quot;, name_str, ver_str);
4087   }
4088 
4089   guarantee(_on_pase != -1 &amp;&amp; _os_version, &quot;Could not determine AIX/OS400 release&quot;);
4090 } // end: os::Aix::initialize_os_info()
4091 
4092 // Scan environment for important settings which might effect the VM.
4093 // Trace out settings. Warn about invalid settings and/or correct them.
4094 //
4095 // Must run after os::Aix::initialue_os_info().
4096 void os::Aix::scan_environment() {
4097 
4098   char* p;
4099   int rc;
4100 
4101   // Warn explicity if EXTSHM=ON is used. That switch changes how
4102   // System V shared memory behaves. One effect is that page size of
4103   // shared memory cannot be change dynamically, effectivly preventing
4104   // large pages from working.
4105   // This switch was needed on AIX 32bit, but on AIX 64bit the general
4106   // recommendation is (in OSS notes) to switch it off.
4107   p = ::getenv(&quot;EXTSHM&quot;);
4108   trcVerbose(&quot;EXTSHM=%s.&quot;, p ? p : &quot;&lt;unset&gt;&quot;);
4109   if (p &amp;&amp; strcasecmp(p, &quot;ON&quot;) == 0) {
4110     _extshm = 1;
4111     trcVerbose(&quot;*** Unsupported mode! Please remove EXTSHM from your environment! ***&quot;);
4112     if (!AllowExtshm) {
4113       // We allow under certain conditions the user to continue. However, we want this
4114       // to be a fatal error by default. On certain AIX systems, leaving EXTSHM=ON means
4115       // that the VM is not able to allocate 64k pages for the heap.
4116       // We do not want to run with reduced performance.
4117       vm_exit_during_initialization(&quot;EXTSHM is ON. Please remove EXTSHM from your environment.&quot;);
4118     }
4119   } else {
4120     _extshm = 0;
4121   }
4122 
4123   // SPEC1170 behaviour: will change the behaviour of a number of POSIX APIs.
4124   // Not tested, not supported.
4125   //
4126   // Note that it might be worth the trouble to test and to require it, if only to
4127   // get useful return codes for mprotect.
4128   //
4129   // Note: Setting XPG_SUS_ENV in the process is too late. Must be set earlier (before
4130   // exec() ? before loading the libjvm ? ....)
4131   p = ::getenv(&quot;XPG_SUS_ENV&quot;);
4132   trcVerbose(&quot;XPG_SUS_ENV=%s.&quot;, p ? p : &quot;&lt;unset&gt;&quot;);
4133   if (p &amp;&amp; strcmp(p, &quot;ON&quot;) == 0) {
4134     _xpg_sus_mode = 1;
4135     trcVerbose(&quot;Unsupported setting: XPG_SUS_ENV=ON&quot;);
4136     // This is not supported. Worst of all, it changes behaviour of mmap MAP_FIXED to
4137     // clobber address ranges. If we ever want to support that, we have to do some
4138     // testing first.
4139     guarantee(false, &quot;XPG_SUS_ENV=ON not supported&quot;);
4140   } else {
4141     _xpg_sus_mode = 0;
4142   }
4143 
4144   if (os::Aix::on_pase()) {
4145     p = ::getenv(&quot;QIBM_MULTI_THREADED&quot;);
4146     trcVerbose(&quot;QIBM_MULTI_THREADED=%s.&quot;, p ? p : &quot;&lt;unset&gt;&quot;);
4147   }
4148 
4149   p = ::getenv(&quot;LDR_CNTRL&quot;);
4150   trcVerbose(&quot;LDR_CNTRL=%s.&quot;, p ? p : &quot;&lt;unset&gt;&quot;);
4151   if (os::Aix::on_pase() &amp;&amp; os::Aix::os_version_short() == 0x0701) {
4152     if (p &amp;&amp; ::strstr(p, &quot;TEXTPSIZE&quot;)) {
4153       trcVerbose(&quot;*** WARNING - LDR_CNTRL contains TEXTPSIZE. &quot;
4154         &quot;you may experience hangs or crashes on OS/400 V7R1.&quot;);
4155     }
4156   }
4157 
4158   p = ::getenv(&quot;AIXTHREAD_GUARDPAGES&quot;);
4159   trcVerbose(&quot;AIXTHREAD_GUARDPAGES=%s.&quot;, p ? p : &quot;&lt;unset&gt;&quot;);
4160 
4161 } // end: os::Aix::scan_environment()
4162 
4163 // PASE: initialize the libo4 library (PASE porting library).
4164 void os::Aix::initialize_libo4() {
4165   guarantee(os::Aix::on_pase(), &quot;OS/400 only.&quot;);
4166   if (!libo4::init()) {
4167     trcVerbose(&quot;libo4 initialization failed.&quot;);
4168     assert(false, &quot;libo4 initialization failed&quot;);
4169   } else {
4170     trcVerbose(&quot;libo4 initialized.&quot;);
4171   }
4172 }
4173 
4174 // AIX: initialize the libperfstat library.
4175 void os::Aix::initialize_libperfstat() {
4176   assert(os::Aix::on_aix(), &quot;AIX only&quot;);
4177   if (!libperfstat::init()) {
4178     trcVerbose(&quot;libperfstat initialization failed.&quot;);
4179     assert(false, &quot;libperfstat initialization failed&quot;);
4180   } else {
4181     trcVerbose(&quot;libperfstat initialized.&quot;);
4182   }
4183 }
4184 
4185 /////////////////////////////////////////////////////////////////////////////
4186 // thread stack
4187 
4188 // Get the current stack base from the OS (actually, the pthread library).
4189 // Note: usually not page aligned.
4190 address os::current_stack_base() {
4191   AixMisc::stackbounds_t bounds;
4192   bool rc = AixMisc::query_stack_bounds_for_current_thread(&amp;bounds);
4193   guarantee(rc, &quot;Unable to retrieve stack bounds.&quot;);
4194   return bounds.base;
4195 }
4196 
4197 // Get the current stack size from the OS (actually, the pthread library).
4198 // Returned size is such that (base - size) is always aligned to page size.
4199 size_t os::current_stack_size() {
4200   AixMisc::stackbounds_t bounds;
4201   bool rc = AixMisc::query_stack_bounds_for_current_thread(&amp;bounds);
4202   guarantee(rc, &quot;Unable to retrieve stack bounds.&quot;);
4203   // Align the returned stack size such that the stack low address
4204   // is aligned to page size (Note: base is usually not and we do not care).
4205   // We need to do this because caller code will assume stack low address is
4206   // page aligned and will place guard pages without checking.
4207   address low = bounds.base - bounds.size;
4208   address low_aligned = (address)align_up(low, os::vm_page_size());
4209   size_t s = bounds.base - low_aligned;
4210   return s;
4211 }
4212 
4213 extern char** environ;
4214 
4215 // Run the specified command in a separate process. Return its exit value,
4216 // or -1 on failure (e.g. can&#39;t fork a new process).
4217 // Unlike system(), this function can be called from signal handler. It
4218 // doesn&#39;t block SIGINT et al.
4219 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
4220   char * argv[4] = {&quot;sh&quot;, &quot;-c&quot;, cmd, NULL};
4221 
4222   pid_t pid = fork();
4223 
4224   if (pid &lt; 0) {
4225     // fork failed
4226     return -1;
4227 
4228   } else if (pid == 0) {
4229     // child process
4230 
4231     // Try to be consistent with system(), which uses &quot;/usr/bin/sh&quot; on AIX.
4232     execve(&quot;/usr/bin/sh&quot;, argv, environ);
4233 
4234     // execve failed
4235     _exit(-1);
4236 
4237   } else {
4238     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
4239     // care about the actual exit code, for now.
4240 
4241     int status;
4242 
4243     // Wait for the child process to exit. This returns immediately if
4244     // the child has already exited. */
4245     while (waitpid(pid, &amp;status, 0) &lt; 0) {
4246       switch (errno) {
4247         case ECHILD: return 0;
4248         case EINTR: break;
4249         default: return -1;
4250       }
4251     }
4252 
4253     if (WIFEXITED(status)) {
4254       // The child exited normally; get its exit code.
4255       return WEXITSTATUS(status);
4256     } else if (WIFSIGNALED(status)) {
4257       // The child exited because of a signal.
4258       // The best value to return is 0x80 + signal number,
4259       // because that is what all Unix shells do, and because
4260       // it allows callers to distinguish between process exit and
4261       // process death by signal.
4262       return 0x80 + WTERMSIG(status);
4263     } else {
4264       // Unknown exit code; pass it through.
4265       return status;
4266     }
4267   }
4268   return -1;
4269 }
4270 
4271 // Get the default path to the core file
4272 // Returns the length of the string
4273 int os::get_core_path(char* buffer, size_t bufferSize) {
4274   const char* p = get_current_directory(buffer, bufferSize);
4275 
4276   if (p == NULL) {
4277     assert(p != NULL, &quot;failed to get current directory&quot;);
4278     return 0;
4279   }
4280 
4281   jio_snprintf(buffer, bufferSize, &quot;%s/core or core.%d&quot;,
4282                                                p, current_process_id());
4283 
4284   return strlen(buffer);
4285 }
4286 
4287 #ifndef PRODUCT
4288 void TestReserveMemorySpecial_test() {
4289   // No tests available for this platform
4290 }
4291 #endif
4292 
4293 bool os::start_debugging(char *buf, int buflen) {
4294   int len = (int)strlen(buf);
4295   char *p = &amp;buf[len];
4296 
4297   jio_snprintf(p, buflen -len,
4298                  &quot;\n\n&quot;
4299                  &quot;Do you want to debug the problem?\n\n&quot;
4300                  &quot;To debug, run &#39;dbx -a %d&#39;; then switch to thread tid &quot; INTX_FORMAT &quot;, k-tid &quot; INTX_FORMAT &quot;\n&quot;
4301                  &quot;Enter &#39;yes&#39; to launch dbx automatically (PATH must include dbx)\n&quot;
4302                  &quot;Otherwise, press RETURN to abort...&quot;,
4303                  os::current_process_id(),
4304                  os::current_thread_id(), thread_self());
4305 
4306   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
4307 
4308   if (yes) {
4309     // yes, user asked VM to launch debugger
4310     jio_snprintf(buf, buflen, &quot;dbx -a %d&quot;, os::current_process_id());
4311 
4312     os::fork_and_exec(buf);
4313     yes = false;
4314   }
4315   return yes;
4316 }
4317 
4318 static inline time_t get_mtime(const char* filename) {
4319   struct stat st;
4320   int ret = os::stat(filename, &amp;st);
4321   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
4322   return st.st_mtime;
4323 }
4324 
4325 int os::compare_file_modified_times(const char* file1, const char* file2) {
4326   time_t t1 = get_mtime(file1);
4327   time_t t2 = get_mtime(file2);
4328   return t1 - t2;
4329 }
    </pre>
  </body>
</html>