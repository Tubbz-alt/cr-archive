<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/os/linux/os_linux.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;logging/logStream.hpp&quot;
  37 #include &quot;memory/allocation.inline.hpp&quot;
  38 #include &quot;memory/filemap.hpp&quot;
  39 #include &quot;oops/oop.inline.hpp&quot;
  40 #include &quot;os_linux.inline.hpp&quot;
  41 #include &quot;os_posix.inline.hpp&quot;
  42 #include &quot;os_share_linux.hpp&quot;
  43 #include &quot;osContainer_linux.hpp&quot;
  44 #include &quot;prims/jniFastGetField.hpp&quot;
  45 #include &quot;prims/jvm_misc.hpp&quot;
  46 #include &quot;runtime/arguments.hpp&quot;
  47 #include &quot;runtime/atomic.hpp&quot;
  48 #include &quot;runtime/extendedPC.hpp&quot;
  49 #include &quot;runtime/globals.hpp&quot;
  50 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  51 #include &quot;runtime/init.hpp&quot;
  52 #include &quot;runtime/java.hpp&quot;
  53 #include &quot;runtime/javaCalls.hpp&quot;
  54 #include &quot;runtime/mutexLocker.hpp&quot;
  55 #include &quot;runtime/objectMonitor.hpp&quot;
<a name="2" id="anc2"></a><span class="line-removed">  56 #include &quot;runtime/orderAccess.hpp&quot;</span>
  57 #include &quot;runtime/osThread.hpp&quot;
  58 #include &quot;runtime/perfMemory.hpp&quot;
  59 #include &quot;runtime/sharedRuntime.hpp&quot;
  60 #include &quot;runtime/statSampler.hpp&quot;
  61 #include &quot;runtime/stubRoutines.hpp&quot;
  62 #include &quot;runtime/thread.inline.hpp&quot;
  63 #include &quot;runtime/threadCritical.hpp&quot;
  64 #include &quot;runtime/threadSMR.hpp&quot;
  65 #include &quot;runtime/timer.hpp&quot;
<a name="3" id="anc3"></a>
  66 #include &quot;semaphore_posix.hpp&quot;
  67 #include &quot;services/attachListener.hpp&quot;
  68 #include &quot;services/memTracker.hpp&quot;
  69 #include &quot;services/runtimeService.hpp&quot;
  70 #include &quot;utilities/align.hpp&quot;
  71 #include &quot;utilities/decoder.hpp&quot;
  72 #include &quot;utilities/defaultStream.hpp&quot;
  73 #include &quot;utilities/events.hpp&quot;
  74 #include &quot;utilities/elfFile.hpp&quot;
  75 #include &quot;utilities/growableArray.hpp&quot;
  76 #include &quot;utilities/macros.hpp&quot;
<a name="4" id="anc4"></a>
  77 #include &quot;utilities/vmError.hpp&quot;
  78 
  79 // put OS-includes here
  80 # include &lt;sys/types.h&gt;
  81 # include &lt;sys/mman.h&gt;
  82 # include &lt;sys/stat.h&gt;
  83 # include &lt;sys/select.h&gt;
  84 # include &lt;pthread.h&gt;
  85 # include &lt;signal.h&gt;
<a name="5" id="anc5"></a>
  86 # include &lt;errno.h&gt;
  87 # include &lt;dlfcn.h&gt;
  88 # include &lt;stdio.h&gt;
  89 # include &lt;unistd.h&gt;
  90 # include &lt;sys/resource.h&gt;
  91 # include &lt;pthread.h&gt;
  92 # include &lt;sys/stat.h&gt;
  93 # include &lt;sys/time.h&gt;
  94 # include &lt;sys/times.h&gt;
  95 # include &lt;sys/utsname.h&gt;
  96 # include &lt;sys/socket.h&gt;
  97 # include &lt;sys/wait.h&gt;
  98 # include &lt;pwd.h&gt;
  99 # include &lt;poll.h&gt;
 100 # include &lt;fcntl.h&gt;
 101 # include &lt;string.h&gt;
 102 # include &lt;syscall.h&gt;
 103 # include &lt;sys/sysinfo.h&gt;
 104 # include &lt;gnu/libc-version.h&gt;
 105 # include &lt;sys/ipc.h&gt;
 106 # include &lt;sys/shm.h&gt;
 107 # include &lt;link.h&gt;
 108 # include &lt;stdint.h&gt;
 109 # include &lt;inttypes.h&gt;
 110 # include &lt;sys/ioctl.h&gt;
 111 
 112 #ifndef _GNU_SOURCE
 113   #define _GNU_SOURCE
 114   #include &lt;sched.h&gt;
 115   #undef _GNU_SOURCE
 116 #else
 117   #include &lt;sched.h&gt;
 118 #endif
 119 
 120 // if RUSAGE_THREAD for getrusage() has not been defined, do it here. The code calling
 121 // getrusage() is prepared to handle the associated failure.
 122 #ifndef RUSAGE_THREAD
 123   #define RUSAGE_THREAD   (1)               /* only the calling thread */
 124 #endif
 125 
 126 #define MAX_PATH    (2 * K)
 127 
 128 #define MAX_SECS 100000000
 129 
 130 // for timer info max values which include all bits
 131 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 132 
 133 enum CoredumpFilterBit {
 134   FILE_BACKED_PVT_BIT = 1 &lt;&lt; 2,
 135   FILE_BACKED_SHARED_BIT = 1 &lt;&lt; 3,
 136   LARGEPAGES_BIT = 1 &lt;&lt; 6,
 137   DAX_SHARED_BIT = 1 &lt;&lt; 8
 138 };
 139 
 140 ////////////////////////////////////////////////////////////////////////////////
 141 // global variables
 142 julong os::Linux::_physical_memory = 0;
 143 
 144 address   os::Linux::_initial_thread_stack_bottom = NULL;
 145 uintptr_t os::Linux::_initial_thread_stack_size   = 0;
 146 
 147 int (*os::Linux::_pthread_getcpuclockid)(pthread_t, clockid_t *) = NULL;
 148 int (*os::Linux::_pthread_setname_np)(pthread_t, const char*) = NULL;
<a name="6" id="anc6"></a><span class="line-removed"> 149 Mutex* os::Linux::_createThread_lock = NULL;</span>
 150 pthread_t os::Linux::_main_thread;
 151 int os::Linux::_page_size = -1;
 152 bool os::Linux::_supports_fast_thread_cpu_time = false;
<a name="7" id="anc7"></a><span class="line-removed"> 153 uint32_t os::Linux::_os_version = 0;</span>
 154 const char * os::Linux::_glibc_version = NULL;
 155 const char * os::Linux::_libpthread_version = NULL;
 156 
 157 static jlong initial_time_count=0;
 158 
 159 static int clock_tics_per_sec = 100;
 160 
 161 // If the VM might have been created on the primordial thread, we need to resolve the
 162 // primordial thread stack bounds and check if the current thread might be the
 163 // primordial thread in places. If we know that the primordial thread is never used,
 164 // such as when the VM was created by one of the standard java launchers, we can
 165 // avoid this
 166 static bool suppress_primordial_thread_resolution = false;
 167 
 168 // For diagnostics to print a message once. see run_periodic_checks
 169 static sigset_t check_signal_done;
 170 static bool check_signals = true;
 171 
 172 // Signal number used to suspend/resume a thread
 173 
 174 // do not use any signal number less than SIGSEGV, see 4355769
 175 static int SR_signum = SIGUSR2;
 176 sigset_t SR_sigset;
 177 
 178 // utility functions
 179 
 180 static int SR_initialize();
 181 
 182 julong os::available_memory() {
 183   return Linux::available_memory();
 184 }
 185 
 186 julong os::Linux::available_memory() {
 187   // values in struct sysinfo are &quot;unsigned long&quot;
 188   struct sysinfo si;
 189   julong avail_mem;
 190 
 191   if (OSContainer::is_containerized()) {
 192     jlong mem_limit, mem_usage;
 193     if ((mem_limit = OSContainer::memory_limit_in_bytes()) &lt; 1) {
 194       log_debug(os, container)(&quot;container memory limit %s: &quot; JLONG_FORMAT &quot;, using host value&quot;,
 195                              mem_limit == OSCONTAINER_ERROR ? &quot;failed&quot; : &quot;unlimited&quot;, mem_limit);
 196     }
 197     if (mem_limit &gt; 0 &amp;&amp; (mem_usage = OSContainer::memory_usage_in_bytes()) &lt; 1) {
 198       log_debug(os, container)(&quot;container memory usage failed: &quot; JLONG_FORMAT &quot;, using host value&quot;, mem_usage);
 199     }
 200     if (mem_limit &gt; 0 &amp;&amp; mem_usage &gt; 0 ) {
 201       avail_mem = mem_limit &gt; mem_usage ? (julong)mem_limit - (julong)mem_usage : 0;
 202       log_trace(os)(&quot;available container memory: &quot; JULONG_FORMAT, avail_mem);
 203       return avail_mem;
 204     }
 205   }
 206 
 207   sysinfo(&amp;si);
 208   avail_mem = (julong)si.freeram * si.mem_unit;
 209   log_trace(os)(&quot;available memory: &quot; JULONG_FORMAT, avail_mem);
 210   return avail_mem;
 211 }
 212 
 213 julong os::physical_memory() {
 214   jlong phys_mem = 0;
 215   if (OSContainer::is_containerized()) {
 216     jlong mem_limit;
 217     if ((mem_limit = OSContainer::memory_limit_in_bytes()) &gt; 0) {
 218       log_trace(os)(&quot;total container memory: &quot; JLONG_FORMAT, mem_limit);
 219       return mem_limit;
 220     }
 221     log_debug(os, container)(&quot;container memory limit %s: &quot; JLONG_FORMAT &quot;, using host value&quot;,
 222                             mem_limit == OSCONTAINER_ERROR ? &quot;failed&quot; : &quot;unlimited&quot;, mem_limit);
 223   }
 224 
 225   phys_mem = Linux::physical_memory();
 226   log_trace(os)(&quot;total system memory: &quot; JLONG_FORMAT, phys_mem);
 227   return phys_mem;
 228 }
 229 
<a name="8" id="anc8"></a>











































































 230 // Return true if user is running as root.
 231 
 232 bool os::have_special_privileges() {
 233   static bool init = false;
 234   static bool privileges = false;
 235   if (!init) {
 236     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 237     init = true;
 238   }
 239   return privileges;
 240 }
 241 
 242 
 243 #ifndef SYS_gettid
 244 // i386: 224, ia64: 1105, amd64: 186, sparc 143
 245   #ifdef __ia64__
 246     #define SYS_gettid 1105
 247   #else
 248     #ifdef __i386__
 249       #define SYS_gettid 224
 250     #else
 251       #ifdef __amd64__
 252         #define SYS_gettid 186
 253       #else
 254         #ifdef __sparc__
 255           #define SYS_gettid 143
 256         #else
 257           #error define gettid for the arch
 258         #endif
 259       #endif
 260     #endif
 261   #endif
 262 #endif
 263 
 264 
 265 // pid_t gettid()
 266 //
 267 // Returns the kernel thread id of the currently running thread. Kernel
 268 // thread id is used to access /proc.
 269 pid_t os::Linux::gettid() {
 270   int rslt = syscall(SYS_gettid);
 271   assert(rslt != -1, &quot;must be.&quot;); // old linuxthreads implementation?
 272   return (pid_t)rslt;
 273 }
 274 
 275 // Most versions of linux have a bug where the number of processors are
 276 // determined by looking at the /proc file system.  In a chroot environment,
 277 // the system call returns 1.
 278 static bool unsafe_chroot_detected = false;
 279 static const char *unstable_chroot_error = &quot;/proc file system not found.\n&quot;
 280                      &quot;Java may be unstable running multithreaded in a chroot &quot;
 281                      &quot;environment on Linux when /proc filesystem is not mounted.&quot;;
 282 
 283 void os::Linux::initialize_system_info() {
 284   set_processor_count(sysconf(_SC_NPROCESSORS_CONF));
 285   if (processor_count() == 1) {
 286     pid_t pid = os::Linux::gettid();
 287     char fname[32];
 288     jio_snprintf(fname, sizeof(fname), &quot;/proc/%d&quot;, pid);
 289     FILE *fp = fopen(fname, &quot;r&quot;);
 290     if (fp == NULL) {
 291       unsafe_chroot_detected = true;
 292     } else {
 293       fclose(fp);
 294     }
 295   }
 296   _physical_memory = (julong)sysconf(_SC_PHYS_PAGES) * (julong)sysconf(_SC_PAGESIZE);
 297   assert(processor_count() &gt; 0, &quot;linux error&quot;);
 298 }
 299 
 300 void os::init_system_properties_values() {
 301   // The next steps are taken in the product version:
 302   //
 303   // Obtain the JAVA_HOME value from the location of libjvm.so.
 304   // This library should be located at:
 305   // &lt;JAVA_HOME&gt;/lib/{client|server}/libjvm.so.
 306   //
 307   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 308   // assume libjvm.so is installed in a JDK and we use this path.
 309   //
 310   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 311   //
 312   // The following extra steps are taken in the debugging version:
 313   //
 314   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 315   // instead of exit check for $JAVA_HOME environment variable.
 316   //
 317   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 318   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 319   // it looks like libjvm.so is installed there
 320   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 321   //
 322   // Otherwise exit.
 323   //
 324   // Important note: if the location of libjvm.so changes this
 325   // code needs to be changed accordingly.
 326 
 327   // See ld(1):
 328   //      The linker uses the following search paths to locate required
 329   //      shared libraries:
 330   //        1: ...
 331   //        ...
 332   //        7: The default directories, normally /lib and /usr/lib.
 333 #ifndef OVERRIDE_LIBPATH
 334   #if defined(AMD64) || (defined(_LP64) &amp;&amp; defined(SPARC)) || defined(PPC64) || defined(S390)
 335     #define DEFAULT_LIBPATH &quot;/usr/lib64:/lib64:/lib:/usr/lib&quot;
 336   #else
 337     #define DEFAULT_LIBPATH &quot;/lib:/usr/lib&quot;
 338   #endif
 339 #else
 340   #define DEFAULT_LIBPATH OVERRIDE_LIBPATH
 341 #endif
 342 
 343 // Base path of extensions installed on the system.
 344 #define SYS_EXT_DIR     &quot;/usr/java/packages&quot;
 345 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 346 
 347   // Buffer that fits several sprintfs.
 348   // Note that the space for the colon and the trailing null are provided
 349   // by the nulls included by the sizeof operator.
 350   const size_t bufsize =
 351     MAX2((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 352          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
<a name="9" id="anc9"></a><span class="line-modified"> 353   char *buf = (char *)NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);</span>
 354 
 355   // sysclasspath, java_home, dll_dir
 356   {
 357     char *pslash;
 358     os::jvm_path(buf, bufsize);
 359 
 360     // Found the full path to libjvm.so.
 361     // Now cut the path to &lt;java_home&gt;/jre if we can.
 362     pslash = strrchr(buf, &#39;/&#39;);
 363     if (pslash != NULL) {
 364       *pslash = &#39;\0&#39;;            // Get rid of /libjvm.so.
 365     }
 366     pslash = strrchr(buf, &#39;/&#39;);
 367     if (pslash != NULL) {
 368       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 369     }
 370     Arguments::set_dll_dir(buf);
 371 
 372     if (pslash != NULL) {
 373       pslash = strrchr(buf, &#39;/&#39;);
 374       if (pslash != NULL) {
 375         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 376       }
 377     }
 378     Arguments::set_java_home(buf);
 379     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 380       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 381     }
 382   }
 383 
 384   // Where to look for native libraries.
 385   //
 386   // Note: Due to a legacy implementation, most of the library path
 387   // is set in the launcher. This was to accomodate linking restrictions
 388   // on legacy Linux implementations (which are no longer supported).
 389   // Eventually, all the library path setting will be done here.
 390   //
 391   // However, to prevent the proliferation of improperly built native
 392   // libraries, the new path component /usr/java/packages is added here.
 393   // Eventually, all the library path setting will be done here.
 394   {
 395     // Get the user setting of LD_LIBRARY_PATH, and prepended it. It
 396     // should always exist (until the legacy problem cited above is
 397     // addressed).
 398     const char *v = ::getenv(&quot;LD_LIBRARY_PATH&quot;);
 399     const char *v_colon = &quot;:&quot;;
 400     if (v == NULL) { v = &quot;&quot;; v_colon = &quot;&quot;; }
 401     // That&#39;s +1 for the colon and +1 for the trailing &#39;\0&#39;.
<a name="10" id="anc10"></a><span class="line-modified"> 402     char *ld_library_path = (char *)NEW_C_HEAP_ARRAY(char,</span>
<span class="line-modified"> 403                                                      strlen(v) + 1 +</span>
<span class="line-modified"> 404                                                      sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;) + sizeof(DEFAULT_LIBPATH) + 1,</span>
<span class="line-modified"> 405                                                      mtInternal);</span>
 406     sprintf(ld_library_path, &quot;%s%s&quot; SYS_EXT_DIR &quot;/lib:&quot; DEFAULT_LIBPATH, v, v_colon);
 407     Arguments::set_library_path(ld_library_path);
 408     FREE_C_HEAP_ARRAY(char, ld_library_path);
 409   }
 410 
 411   // Extensions directories.
 412   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 413   Arguments::set_ext_dirs(buf);
 414 
 415   FREE_C_HEAP_ARRAY(char, buf);
 416 
 417 #undef DEFAULT_LIBPATH
 418 #undef SYS_EXT_DIR
 419 #undef EXTENSIONS_DIR
 420 }
 421 
 422 ////////////////////////////////////////////////////////////////////////////////
 423 // breakpoint support
 424 
 425 void os::breakpoint() {
 426   BREAKPOINT;
 427 }
 428 
 429 extern &quot;C&quot; void breakpoint() {
 430   // use debugger to set breakpoint here
 431 }
 432 
 433 ////////////////////////////////////////////////////////////////////////////////
 434 // signal support
 435 
 436 debug_only(static bool signal_sets_initialized = false);
 437 static sigset_t unblocked_sigs, vm_sigs;
 438 
 439 void os::Linux::signal_sets_init() {
 440   // Should also have an assertion stating we are still single-threaded.
 441   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
 442   // Fill in signals that are necessarily unblocked for all threads in
 443   // the VM. Currently, we unblock the following signals:
 444   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
 445   //                         by -Xrs (=ReduceSignalUsage));
 446   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
 447   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
 448   // the dispositions or masks wrt these signals.
 449   // Programs embedding the VM that want to use the above signals for their
 450   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
 451   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
 452   // (See bug 4345157, and other related bugs).
 453   // In reality, though, unblocking these signals is really a nop, since
 454   // these signals are not blocked by default.
 455   sigemptyset(&amp;unblocked_sigs);
 456   sigaddset(&amp;unblocked_sigs, SIGILL);
 457   sigaddset(&amp;unblocked_sigs, SIGSEGV);
 458   sigaddset(&amp;unblocked_sigs, SIGBUS);
 459   sigaddset(&amp;unblocked_sigs, SIGFPE);
 460 #if defined(PPC64)
 461   sigaddset(&amp;unblocked_sigs, SIGTRAP);
 462 #endif
 463   sigaddset(&amp;unblocked_sigs, SR_signum);
 464 
 465   if (!ReduceSignalUsage) {
 466     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
 467       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
 468     }
 469     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
 470       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
 471     }
 472     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
 473       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
 474     }
 475   }
 476   // Fill in signals that are blocked by all but the VM thread.
 477   sigemptyset(&amp;vm_sigs);
 478   if (!ReduceSignalUsage) {
 479     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
 480   }
 481   debug_only(signal_sets_initialized = true);
 482 
 483 }
 484 
 485 // These are signals that are unblocked while a thread is running Java.
 486 // (For some reason, they get blocked by default.)
 487 sigset_t* os::Linux::unblocked_signals() {
 488   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 489   return &amp;unblocked_sigs;
 490 }
 491 
 492 // These are the signals that are blocked while a (non-VM) thread is
 493 // running Java. Only the VM thread handles these signals.
 494 sigset_t* os::Linux::vm_signals() {
 495   assert(signal_sets_initialized, &quot;Not initialized&quot;);
 496   return &amp;vm_sigs;
 497 }
 498 
 499 void os::Linux::hotspot_sigmask(Thread* thread) {
 500 
 501   //Save caller&#39;s signal mask before setting VM signal mask
 502   sigset_t caller_sigmask;
 503   pthread_sigmask(SIG_BLOCK, NULL, &amp;caller_sigmask);
 504 
 505   OSThread* osthread = thread-&gt;osthread();
 506   osthread-&gt;set_caller_sigmask(caller_sigmask);
 507 
 508   pthread_sigmask(SIG_UNBLOCK, os::Linux::unblocked_signals(), NULL);
 509 
 510   if (!ReduceSignalUsage) {
 511     if (thread-&gt;is_VM_thread()) {
 512       // Only the VM thread handles BREAK_SIGNAL ...
 513       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 514     } else {
 515       // ... all other threads block BREAK_SIGNAL
 516       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 517     }
 518   }
 519 }
 520 
 521 //////////////////////////////////////////////////////////////////////////////
 522 // detecting pthread library
 523 
 524 void os::Linux::libpthread_init() {
 525   // Save glibc and pthread version strings.
 526 #if !defined(_CS_GNU_LIBC_VERSION) || \
 527     !defined(_CS_GNU_LIBPTHREAD_VERSION)
 528   #error &quot;glibc too old (&lt; 2.3.2)&quot;
 529 #endif
 530 
 531   size_t n = confstr(_CS_GNU_LIBC_VERSION, NULL, 0);
 532   assert(n &gt; 0, &quot;cannot retrieve glibc version&quot;);
 533   char *str = (char *)malloc(n, mtInternal);
 534   confstr(_CS_GNU_LIBC_VERSION, str, n);
 535   os::Linux::set_glibc_version(str);
 536 
 537   n = confstr(_CS_GNU_LIBPTHREAD_VERSION, NULL, 0);
 538   assert(n &gt; 0, &quot;cannot retrieve pthread version&quot;);
 539   str = (char *)malloc(n, mtInternal);
 540   confstr(_CS_GNU_LIBPTHREAD_VERSION, str, n);
 541   os::Linux::set_libpthread_version(str);
 542 }
 543 
 544 /////////////////////////////////////////////////////////////////////////////
 545 // thread stack expansion
 546 
 547 // os::Linux::manually_expand_stack() takes care of expanding the thread
 548 // stack. Note that this is normally not needed: pthread stacks allocate
 549 // thread stack using mmap() without MAP_NORESERVE, so the stack is already
 550 // committed. Therefore it is not necessary to expand the stack manually.
 551 //
 552 // Manually expanding the stack was historically needed on LinuxThreads
 553 // thread stacks, which were allocated with mmap(MAP_GROWSDOWN). Nowadays
 554 // it is kept to deal with very rare corner cases:
 555 //
 556 // For one, user may run the VM on an own implementation of threads
 557 // whose stacks are - like the old LinuxThreads - implemented using
 558 // mmap(MAP_GROWSDOWN).
 559 //
 560 // Also, this coding may be needed if the VM is running on the primordial
 561 // thread. Normally we avoid running on the primordial thread; however,
 562 // user may still invoke the VM on the primordial thread.
 563 //
 564 // The following historical comment describes the details about running
 565 // on a thread stack allocated with mmap(MAP_GROWSDOWN):
 566 
 567 
 568 // Force Linux kernel to expand current thread stack. If &quot;bottom&quot; is close
 569 // to the stack guard, caller should block all signals.
 570 //
 571 // MAP_GROWSDOWN:
 572 //   A special mmap() flag that is used to implement thread stacks. It tells
 573 //   kernel that the memory region should extend downwards when needed. This
 574 //   allows early versions of LinuxThreads to only mmap the first few pages
 575 //   when creating a new thread. Linux kernel will automatically expand thread
 576 //   stack as needed (on page faults).
 577 //
 578 //   However, because the memory region of a MAP_GROWSDOWN stack can grow on
 579 //   demand, if a page fault happens outside an already mapped MAP_GROWSDOWN
 580 //   region, it&#39;s hard to tell if the fault is due to a legitimate stack
 581 //   access or because of reading/writing non-exist memory (e.g. buffer
 582 //   overrun). As a rule, if the fault happens below current stack pointer,
 583 //   Linux kernel does not expand stack, instead a SIGSEGV is sent to the
 584 //   application (see Linux kernel fault.c).
 585 //
 586 //   This Linux feature can cause SIGSEGV when VM bangs thread stack for
 587 //   stack overflow detection.
 588 //
 589 //   Newer version of LinuxThreads (since glibc-2.2, or, RH-7.x) and NPTL do
 590 //   not use MAP_GROWSDOWN.
 591 //
 592 // To get around the problem and allow stack banging on Linux, we need to
 593 // manually expand thread stack after receiving the SIGSEGV.
 594 //
 595 // There are two ways to expand thread stack to address &quot;bottom&quot;, we used
 596 // both of them in JVM before 1.5:
 597 //   1. adjust stack pointer first so that it is below &quot;bottom&quot;, and then
 598 //      touch &quot;bottom&quot;
 599 //   2. mmap() the page in question
 600 //
 601 // Now alternate signal stack is gone, it&#39;s harder to use 2. For instance,
 602 // if current sp is already near the lower end of page 101, and we need to
 603 // call mmap() to map page 100, it is possible that part of the mmap() frame
 604 // will be placed in page 100. When page 100 is mapped, it is zero-filled.
 605 // That will destroy the mmap() frame and cause VM to crash.
 606 //
 607 // The following code works by adjusting sp first, then accessing the &quot;bottom&quot;
 608 // page to force a page fault. Linux kernel will then automatically expand the
 609 // stack mapping.
 610 //
 611 // _expand_stack_to() assumes its frame size is less than page size, which
 612 // should always be true if the function is not inlined.
 613 
 614 static void NOINLINE _expand_stack_to(address bottom) {
 615   address sp;
 616   size_t size;
 617   volatile char *p;
 618 
 619   // Adjust bottom to point to the largest address within the same page, it
 620   // gives us a one-page buffer if alloca() allocates slightly more memory.
 621   bottom = (address)align_down((uintptr_t)bottom, os::Linux::page_size());
 622   bottom += os::Linux::page_size() - 1;
 623 
 624   // sp might be slightly above current stack pointer; if that&#39;s the case, we
 625   // will alloca() a little more space than necessary, which is OK. Don&#39;t use
 626   // os::current_stack_pointer(), as its result can be slightly below current
 627   // stack pointer, causing us to not alloca enough to reach &quot;bottom&quot;.
 628   sp = (address)&amp;sp;
 629 
 630   if (sp &gt; bottom) {
 631     size = sp - bottom;
 632     p = (volatile char *)alloca(size);
 633     assert(p != NULL &amp;&amp; p &lt;= (volatile char *)bottom, &quot;alloca problem?&quot;);
 634     p[0] = &#39;\0&#39;;
 635   }
 636 }
 637 
 638 void os::Linux::expand_stack_to(address bottom) {
 639   _expand_stack_to(bottom);
 640 }
 641 
 642 bool os::Linux::manually_expand_stack(JavaThread * t, address addr) {
 643   assert(t!=NULL, &quot;just checking&quot;);
 644   assert(t-&gt;osthread()-&gt;expanding_stack(), &quot;expand should be set&quot;);
 645   assert(t-&gt;stack_base() != NULL, &quot;stack_base was not initialized&quot;);
 646 
<a name="11" id="anc11"></a><span class="line-modified"> 647   if (addr &lt;  t-&gt;stack_base() &amp;&amp; addr &gt;= t-&gt;stack_reserved_zone_base()) {</span>
 648     sigset_t mask_all, old_sigset;
 649     sigfillset(&amp;mask_all);
 650     pthread_sigmask(SIG_SETMASK, &amp;mask_all, &amp;old_sigset);
 651     _expand_stack_to(addr);
 652     pthread_sigmask(SIG_SETMASK, &amp;old_sigset, NULL);
 653     return true;
 654   }
 655   return false;
 656 }
 657 
 658 //////////////////////////////////////////////////////////////////////////////
 659 // create new thread
 660 
 661 // Thread start routine for all newly created threads
 662 static void *thread_native_entry(Thread *thread) {
 663 
 664   thread-&gt;record_stack_base_and_size();
 665 
 666   // Try to randomize the cache line index of hot stack frames.
 667   // This helps when threads of the same stack traces evict each other&#39;s
 668   // cache lines. The threads can be either from the same JVM instance, or
 669   // from different JVM instances. The benefit is especially true for
 670   // processors with hyperthreading technology.
 671   static int counter = 0;
 672   int pid = os::current_process_id();
 673   alloca(((pid ^ counter++) &amp; 7) * 128);
 674 
 675   thread-&gt;initialize_thread_current();
 676 
 677   OSThread* osthread = thread-&gt;osthread();
 678   Monitor* sync = osthread-&gt;startThread_lock();
 679 
 680   osthread-&gt;set_thread_id(os::current_thread_id());
 681 
 682   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 683     os::current_thread_id(), (uintx) pthread_self());
 684 
 685   if (UseNUMA) {
 686     int lgrp_id = os::numa_get_group_id();
 687     if (lgrp_id != -1) {
 688       thread-&gt;set_lgrp_id(lgrp_id);
 689     }
 690   }
 691   // initialize signal mask for this thread
 692   os::Linux::hotspot_sigmask(thread);
 693 
 694   // initialize floating point control register
 695   os::Linux::init_thread_fpu_state();
 696 
 697   // handshaking with parent thread
 698   {
<a name="12" id="anc12"></a><span class="line-modified"> 699     MutexLockerEx ml(sync, Mutex::_no_safepoint_check_flag);</span>
 700 
 701     // notify parent thread
 702     osthread-&gt;set_state(INITIALIZED);
 703     sync-&gt;notify_all();
 704 
 705     // wait until os::start_thread()
 706     while (osthread-&gt;get_state() == INITIALIZED) {
<a name="13" id="anc13"></a><span class="line-modified"> 707       sync-&gt;wait(Mutex::_no_safepoint_check_flag);</span>
 708     }
 709   }
 710 
 711   assert(osthread-&gt;pthread_id() != 0, &quot;pthread_id was not set as expected&quot;);
 712 
 713   // call one more level start routine
 714   thread-&gt;call_run();
 715 
 716   // Note: at this point the thread object may already have deleted itself.
 717   // Prevent dereferencing it from here on out.
 718   thread = NULL;
 719 
 720   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 721     os::current_thread_id(), (uintx) pthread_self());
 722 
 723   return 0;
 724 }
 725 
<a name="14" id="anc14"></a>


































































 726 bool os::create_thread(Thread* thread, ThreadType thr_type,
 727                        size_t req_stack_size) {
 728   assert(thread-&gt;osthread() == NULL, &quot;caller responsible&quot;);
 729 
 730   // Allocate the OSThread object
 731   OSThread* osthread = new OSThread(NULL, NULL);
 732   if (osthread == NULL) {
 733     return false;
 734   }
 735 
 736   // set the correct thread state
 737   osthread-&gt;set_thread_type(thr_type);
 738 
 739   // Initial state is ALLOCATED but not INITIALIZED
 740   osthread-&gt;set_state(ALLOCATED);
 741 
 742   thread-&gt;set_osthread(osthread);
 743 
 744   // init thread attributes
 745   pthread_attr_t attr;
 746   pthread_attr_init(&amp;attr);
 747   pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
 748 
 749   // Calculate stack size if it&#39;s not specified by caller.
 750   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
<a name="15" id="anc15"></a><span class="line-modified"> 751   // In the Linux NPTL pthread implementation the guard size mechanism</span>
 752   // is not implemented properly. The posix standard requires adding
 753   // the size of the guard pages to the stack size, instead Linux
 754   // takes the space out of &#39;stacksize&#39;. Thus we adapt the requested
 755   // stack_size by the size of the guard pages to mimick proper
 756   // behaviour. However, be careful not to end up with a size
 757   // of zero due to overflow. Don&#39;t add the guard page in that case.
 758   size_t guard_size = os::Linux::default_guard_size(thr_type);
<a name="16" id="anc16"></a><span class="line-modified"> 759   if (stack_size &lt;= SIZE_MAX - guard_size) {</span>
<span class="line-modified"> 760     stack_size += guard_size;</span>













 761   }
 762   assert(is_aligned(stack_size, os::vm_page_size()), &quot;stack_size not aligned&quot;);
 763 
 764   int status = pthread_attr_setstacksize(&amp;attr, stack_size);
 765   assert_status(status == 0, status, &quot;pthread_attr_setstacksize&quot;);
 766 
<a name="17" id="anc17"></a><span class="line-removed"> 767   // Configure glibc guard page.</span>
<span class="line-removed"> 768   pthread_attr_setguardsize(&amp;attr, os::Linux::default_guard_size(thr_type));</span>
<span class="line-removed"> 769 </span>
 770   ThreadState state;
 771 
 772   {
 773     pthread_t tid;
 774     int ret = pthread_create(&amp;tid, &amp;attr, (void* (*)(void*)) thread_native_entry, thread);
 775 
 776     char buf[64];
 777     if (ret == 0) {
 778       log_info(os, thread)(&quot;Thread started (pthread id: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 779         (uintx) tid, os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
 780     } else {
 781       log_warning(os, thread)(&quot;Failed to start thread - pthread_create failed (%s) for attributes: %s.&quot;,
 782         os::errno_name(ret), os::Posix::describe_pthread_attr(buf, sizeof(buf), &amp;attr));
<a name="18" id="anc18"></a>






 783     }
 784 
 785     pthread_attr_destroy(&amp;attr);
 786 
 787     if (ret != 0) {
 788       // Need to clean up stuff we&#39;ve allocated so far
 789       thread-&gt;set_osthread(NULL);
 790       delete osthread;
 791       return false;
 792     }
 793 
 794     // Store pthread info into the OSThread
 795     osthread-&gt;set_pthread_id(tid);
 796 
 797     // Wait until child thread is either initialized or aborted
 798     {
 799       Monitor* sync_with_child = osthread-&gt;startThread_lock();
<a name="19" id="anc19"></a><span class="line-modified"> 800       MutexLockerEx ml(sync_with_child, Mutex::_no_safepoint_check_flag);</span>
 801       while ((state = osthread-&gt;get_state()) == ALLOCATED) {
<a name="20" id="anc20"></a><span class="line-modified"> 802         sync_with_child-&gt;wait(Mutex::_no_safepoint_check_flag);</span>
 803       }
 804     }
 805   }
 806 
 807   // Aborted due to thread limit being reached
 808   if (state == ZOMBIE) {
 809     thread-&gt;set_osthread(NULL);
 810     delete osthread;
 811     return false;
 812   }
 813 
 814   // The thread is returned suspended (in state INITIALIZED),
 815   // and is started higher up in the call chain
 816   assert(state == INITIALIZED, &quot;race condition&quot;);
 817   return true;
 818 }
 819 
 820 /////////////////////////////////////////////////////////////////////////////
 821 // attach existing thread
 822 
 823 // bootstrap the main thread
 824 bool os::create_main_thread(JavaThread* thread) {
 825   assert(os::Linux::_main_thread == pthread_self(), &quot;should be called inside main thread&quot;);
 826   return create_attached_thread(thread);
 827 }
 828 
 829 bool os::create_attached_thread(JavaThread* thread) {
 830 #ifdef ASSERT
 831   thread-&gt;verify_not_published();
 832 #endif
 833 
 834   // Allocate the OSThread object
 835   OSThread* osthread = new OSThread(NULL, NULL);
 836 
 837   if (osthread == NULL) {
 838     return false;
 839   }
 840 
 841   // Store pthread info into the OSThread
 842   osthread-&gt;set_thread_id(os::Linux::gettid());
 843   osthread-&gt;set_pthread_id(::pthread_self());
 844 
 845   // initialize floating point control register
 846   os::Linux::init_thread_fpu_state();
 847 
 848   // Initial thread state is RUNNABLE
 849   osthread-&gt;set_state(RUNNABLE);
 850 
 851   thread-&gt;set_osthread(osthread);
 852 
 853   if (UseNUMA) {
 854     int lgrp_id = os::numa_get_group_id();
 855     if (lgrp_id != -1) {
 856       thread-&gt;set_lgrp_id(lgrp_id);
 857     }
 858   }
 859 
 860   if (os::is_primordial_thread()) {
 861     // If current thread is primordial thread, its stack is mapped on demand,
 862     // see notes about MAP_GROWSDOWN. Here we try to force kernel to map
 863     // the entire stack region to avoid SEGV in stack banging.
 864     // It is also useful to get around the heap-stack-gap problem on SuSE
 865     // kernel (see 4821821 for details). We first expand stack to the top
 866     // of yellow zone, then enable stack yellow zone (order is significant,
 867     // enabling yellow zone first will crash JVM on SuSE Linux), so there
 868     // is no gap between the last two virtual memory regions.
 869 
 870     JavaThread *jt = (JavaThread *)thread;
 871     address addr = jt-&gt;stack_reserved_zone_base();
 872     assert(addr != NULL, &quot;initialization problem?&quot;);
 873     assert(jt-&gt;stack_available(addr) &gt; 0, &quot;stack guard should not be enabled&quot;);
 874 
 875     osthread-&gt;set_expanding_stack();
 876     os::Linux::manually_expand_stack(jt, addr);
 877     osthread-&gt;clear_expanding_stack();
 878   }
 879 
 880   // initialize signal mask for this thread
 881   // and save the caller&#39;s signal mask
 882   os::Linux::hotspot_sigmask(thread);
 883 
 884   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;, pthread id: &quot; UINTX_FORMAT &quot;).&quot;,
 885     os::current_thread_id(), (uintx) pthread_self());
 886 
 887   return true;
 888 }
 889 
 890 void os::pd_start_thread(Thread* thread) {
 891   OSThread * osthread = thread-&gt;osthread();
 892   assert(osthread-&gt;get_state() != INITIALIZED, &quot;just checking&quot;);
 893   Monitor* sync_with_child = osthread-&gt;startThread_lock();
<a name="21" id="anc21"></a><span class="line-modified"> 894   MutexLockerEx ml(sync_with_child, Mutex::_no_safepoint_check_flag);</span>
 895   sync_with_child-&gt;notify();
 896 }
 897 
 898 // Free Linux resources related to the OSThread
 899 void os::free_thread(OSThread* osthread) {
 900   assert(osthread != NULL, &quot;osthread not set&quot;);
 901 
 902   // We are told to free resources of the argument thread,
 903   // but we can only really operate on the current thread.
 904   assert(Thread::current()-&gt;osthread() == osthread,
 905          &quot;os::free_thread but not current thread&quot;);
 906 
 907 #ifdef ASSERT
 908   sigset_t current;
 909   sigemptyset(&amp;current);
 910   pthread_sigmask(SIG_SETMASK, NULL, &amp;current);
 911   assert(!sigismember(&amp;current, SR_signum), &quot;SR signal should not be blocked!&quot;);
 912 #endif
 913 
 914   // Restore caller&#39;s signal mask
 915   sigset_t sigmask = osthread-&gt;caller_sigmask();
 916   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
 917 
 918   delete osthread;
 919 }
 920 
 921 //////////////////////////////////////////////////////////////////////////////
 922 // primordial thread
 923 
 924 // Check if current thread is the primordial thread, similar to Solaris thr_main.
 925 bool os::is_primordial_thread(void) {
 926   if (suppress_primordial_thread_resolution) {
 927     return false;
 928   }
 929   char dummy;
 930   // If called before init complete, thread stack bottom will be null.
 931   // Can be called if fatal error occurs before initialization.
 932   if (os::Linux::initial_thread_stack_bottom() == NULL) return false;
 933   assert(os::Linux::initial_thread_stack_bottom() != NULL &amp;&amp;
 934          os::Linux::initial_thread_stack_size()   != 0,
 935          &quot;os::init did not locate primordial thread&#39;s stack region&quot;);
 936   if ((address)&amp;dummy &gt;= os::Linux::initial_thread_stack_bottom() &amp;&amp;
 937       (address)&amp;dummy &lt; os::Linux::initial_thread_stack_bottom() +
 938                         os::Linux::initial_thread_stack_size()) {
 939     return true;
 940   } else {
 941     return false;
 942   }
 943 }
 944 
 945 // Find the virtual memory area that contains addr
 946 static bool find_vma(address addr, address* vma_low, address* vma_high) {
 947   FILE *fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);
 948   if (fp) {
 949     address low, high;
 950     while (!feof(fp)) {
 951       if (fscanf(fp, &quot;%p-%p&quot;, &amp;low, &amp;high) == 2) {
 952         if (low &lt;= addr &amp;&amp; addr &lt; high) {
 953           if (vma_low)  *vma_low  = low;
 954           if (vma_high) *vma_high = high;
 955           fclose(fp);
 956           return true;
 957         }
 958       }
 959       for (;;) {
 960         int ch = fgetc(fp);
 961         if (ch == EOF || ch == (int)&#39;\n&#39;) break;
 962       }
 963     }
 964     fclose(fp);
 965   }
 966   return false;
 967 }
 968 
 969 // Locate primordial thread stack. This special handling of primordial thread stack
 970 // is needed because pthread_getattr_np() on most (all?) Linux distros returns
 971 // bogus value for the primordial process thread. While the launcher has created
 972 // the VM in a new thread since JDK 6, we still have to allow for the use of the
 973 // JNI invocation API from a primordial thread.
 974 void os::Linux::capture_initial_stack(size_t max_size) {
 975 
 976   // max_size is either 0 (which means accept OS default for thread stacks) or
 977   // a user-specified value known to be at least the minimum needed. If we
 978   // are actually on the primordial thread we can make it appear that we have a
 979   // smaller max_size stack by inserting the guard pages at that location. But we
 980   // cannot do anything to emulate a larger stack than what has been provided by
 981   // the OS or threading library. In fact if we try to use a stack greater than
 982   // what is set by rlimit then we will crash the hosting process.
 983 
 984   // Maximum stack size is the easy part, get it from RLIMIT_STACK.
 985   // If this is &quot;unlimited&quot; then it will be a huge value.
 986   struct rlimit rlim;
 987   getrlimit(RLIMIT_STACK, &amp;rlim);
 988   size_t stack_size = rlim.rlim_cur;
 989 
 990   // 6308388: a bug in ld.so will relocate its own .data section to the
 991   //   lower end of primordial stack; reduce ulimit -s value a little bit
 992   //   so we won&#39;t install guard page on ld.so&#39;s data section.
 993   //   But ensure we don&#39;t underflow the stack size - allow 1 page spare
 994   if (stack_size &gt;= (size_t)(3 * page_size())) {
 995     stack_size -= 2 * page_size();
 996   }
 997 
 998   // Try to figure out where the stack base (top) is. This is harder.
 999   //
1000   // When an application is started, glibc saves the initial stack pointer in
1001   // a global variable &quot;__libc_stack_end&quot;, which is then used by system
1002   // libraries. __libc_stack_end should be pretty close to stack top. The
1003   // variable is available since the very early days. However, because it is
1004   // a private interface, it could disappear in the future.
1005   //
1006   // Linux kernel saves start_stack information in /proc/&lt;pid&gt;/stat. Similar
1007   // to __libc_stack_end, it is very close to stack top, but isn&#39;t the real
1008   // stack top. Note that /proc may not exist if VM is running as a chroot
1009   // program, so reading /proc/&lt;pid&gt;/stat could fail. Also the contents of
1010   // /proc/&lt;pid&gt;/stat could change in the future (though unlikely).
1011   //
1012   // We try __libc_stack_end first. If that doesn&#39;t work, look for
1013   // /proc/&lt;pid&gt;/stat. If neither of them works, we use current stack pointer
1014   // as a hint, which should work well in most cases.
1015 
1016   uintptr_t stack_start;
1017 
1018   // try __libc_stack_end first
1019   uintptr_t *p = (uintptr_t *)dlsym(RTLD_DEFAULT, &quot;__libc_stack_end&quot;);
1020   if (p &amp;&amp; *p) {
1021     stack_start = *p;
1022   } else {
1023     // see if we can get the start_stack field from /proc/self/stat
1024     FILE *fp;
1025     int pid;
1026     char state;
1027     int ppid;
1028     int pgrp;
1029     int session;
1030     int nr;
1031     int tpgrp;
1032     unsigned long flags;
1033     unsigned long minflt;
1034     unsigned long cminflt;
1035     unsigned long majflt;
1036     unsigned long cmajflt;
1037     unsigned long utime;
1038     unsigned long stime;
1039     long cutime;
1040     long cstime;
1041     long prio;
1042     long nice;
1043     long junk;
1044     long it_real;
1045     uintptr_t start;
1046     uintptr_t vsize;
1047     intptr_t rss;
1048     uintptr_t rsslim;
1049     uintptr_t scodes;
1050     uintptr_t ecode;
1051     int i;
1052 
1053     // Figure what the primordial thread stack base is. Code is inspired
1054     // by email from Hans Boehm. /proc/self/stat begins with current pid,
1055     // followed by command name surrounded by parentheses, state, etc.
1056     char stat[2048];
1057     int statlen;
1058 
1059     fp = fopen(&quot;/proc/self/stat&quot;, &quot;r&quot;);
1060     if (fp) {
1061       statlen = fread(stat, 1, 2047, fp);
1062       stat[statlen] = &#39;\0&#39;;
1063       fclose(fp);
1064 
1065       // Skip pid and the command string. Note that we could be dealing with
1066       // weird command names, e.g. user could decide to rename java launcher
1067       // to &quot;java 1.4.2 :)&quot;, then the stat file would look like
1068       //                1234 (java 1.4.2 :)) R ... ...
1069       // We don&#39;t really need to know the command string, just find the last
1070       // occurrence of &quot;)&quot; and then start parsing from there. See bug 4726580.
1071       char * s = strrchr(stat, &#39;)&#39;);
1072 
1073       i = 0;
1074       if (s) {
1075         // Skip blank chars
1076         do { s++; } while (s &amp;&amp; isspace(*s));
1077 
1078 #define _UFM UINTX_FORMAT
1079 #define _DFM INTX_FORMAT
1080 
1081         //                                     1   1   1   1   1   1   1   1   1   1   2   2    2    2    2    2    2    2    2
1082         //              3  4  5  6  7  8   9   0   1   2   3   4   5   6   7   8   9   0   1    2    3    4    5    6    7    8
1083         i = sscanf(s, &quot;%c %d %d %d %d %d %lu %lu %lu %lu %lu %lu %lu %ld %ld %ld %ld %ld %ld &quot; _UFM _UFM _DFM _UFM _UFM _UFM _UFM,
1084                    &amp;state,          // 3  %c
1085                    &amp;ppid,           // 4  %d
1086                    &amp;pgrp,           // 5  %d
1087                    &amp;session,        // 6  %d
1088                    &amp;nr,             // 7  %d
1089                    &amp;tpgrp,          // 8  %d
1090                    &amp;flags,          // 9  %lu
1091                    &amp;minflt,         // 10 %lu
1092                    &amp;cminflt,        // 11 %lu
1093                    &amp;majflt,         // 12 %lu
1094                    &amp;cmajflt,        // 13 %lu
1095                    &amp;utime,          // 14 %lu
1096                    &amp;stime,          // 15 %lu
1097                    &amp;cutime,         // 16 %ld
1098                    &amp;cstime,         // 17 %ld
1099                    &amp;prio,           // 18 %ld
1100                    &amp;nice,           // 19 %ld
1101                    &amp;junk,           // 20 %ld
1102                    &amp;it_real,        // 21 %ld
1103                    &amp;start,          // 22 UINTX_FORMAT
1104                    &amp;vsize,          // 23 UINTX_FORMAT
1105                    &amp;rss,            // 24 INTX_FORMAT
1106                    &amp;rsslim,         // 25 UINTX_FORMAT
1107                    &amp;scodes,         // 26 UINTX_FORMAT
1108                    &amp;ecode,          // 27 UINTX_FORMAT
1109                    &amp;stack_start);   // 28 UINTX_FORMAT
1110       }
1111 
1112 #undef _UFM
1113 #undef _DFM
1114 
1115       if (i != 28 - 2) {
1116         assert(false, &quot;Bad conversion from /proc/self/stat&quot;);
1117         // product mode - assume we are the primordial thread, good luck in the
1118         // embedded case.
1119         warning(&quot;Can&#39;t detect primordial thread stack location - bad conversion&quot;);
1120         stack_start = (uintptr_t) &amp;rlim;
1121       }
1122     } else {
1123       // For some reason we can&#39;t open /proc/self/stat (for example, running on
1124       // FreeBSD with a Linux emulator, or inside chroot), this should work for
1125       // most cases, so don&#39;t abort:
1126       warning(&quot;Can&#39;t detect primordial thread stack location - no /proc/self/stat&quot;);
1127       stack_start = (uintptr_t) &amp;rlim;
1128     }
1129   }
1130 
1131   // Now we have a pointer (stack_start) very close to the stack top, the
1132   // next thing to do is to figure out the exact location of stack top. We
1133   // can find out the virtual memory area that contains stack_start by
1134   // reading /proc/self/maps, it should be the last vma in /proc/self/maps,
1135   // and its upper limit is the real stack top. (again, this would fail if
1136   // running inside chroot, because /proc may not exist.)
1137 
1138   uintptr_t stack_top;
1139   address low, high;
1140   if (find_vma((address)stack_start, &amp;low, &amp;high)) {
1141     // success, &quot;high&quot; is the true stack top. (ignore &quot;low&quot;, because initial
1142     // thread stack grows on demand, its real bottom is high - RLIMIT_STACK.)
1143     stack_top = (uintptr_t)high;
1144   } else {
1145     // failed, likely because /proc/self/maps does not exist
1146     warning(&quot;Can&#39;t detect primordial thread stack location - find_vma failed&quot;);
1147     // best effort: stack_start is normally within a few pages below the real
1148     // stack top, use it as stack top, and reduce stack size so we won&#39;t put
1149     // guard page outside stack.
1150     stack_top = stack_start;
1151     stack_size -= 16 * page_size();
1152   }
1153 
1154   // stack_top could be partially down the page so align it
1155   stack_top = align_up(stack_top, page_size());
1156 
1157   // Allowed stack value is minimum of max_size and what we derived from rlimit
1158   if (max_size &gt; 0) {
1159     _initial_thread_stack_size = MIN2(max_size, stack_size);
1160   } else {
1161     // Accept the rlimit max, but if stack is unlimited then it will be huge, so
1162     // clamp it at 8MB as we do on Solaris
1163     _initial_thread_stack_size = MIN2(stack_size, 8*M);
1164   }
1165   _initial_thread_stack_size = align_down(_initial_thread_stack_size, page_size());
1166   _initial_thread_stack_bottom = (address)stack_top - _initial_thread_stack_size;
1167 
1168   assert(_initial_thread_stack_bottom &lt; (address)stack_top, &quot;overflow!&quot;);
1169 
1170   if (log_is_enabled(Info, os, thread)) {
1171     // See if we seem to be on primordial process thread
1172     bool primordial = uintptr_t(&amp;rlim) &gt; uintptr_t(_initial_thread_stack_bottom) &amp;&amp;
1173                       uintptr_t(&amp;rlim) &lt; stack_top;
1174 
1175     log_info(os, thread)(&quot;Capturing initial stack in %s thread: req. size: &quot; SIZE_FORMAT &quot;K, actual size: &quot;
1176                          SIZE_FORMAT &quot;K, top=&quot; INTPTR_FORMAT &quot;, bottom=&quot; INTPTR_FORMAT,
1177                          primordial ? &quot;primordial&quot; : &quot;user&quot;, max_size / K,  _initial_thread_stack_size / K,
1178                          stack_top, intptr_t(_initial_thread_stack_bottom));
1179   }
1180 }
1181 
1182 ////////////////////////////////////////////////////////////////////////////////
1183 // time support
1184 
1185 #ifndef SUPPORTS_CLOCK_MONOTONIC
1186 #error &quot;Build platform doesn&#39;t support clock_gettime and related functionality&quot;
1187 #endif
1188 
1189 // Time since start-up in seconds to a fine granularity.
1190 // Used by VMSelfDestructTimer and the MemProfiler.
1191 double os::elapsedTime() {
1192 
1193   return ((double)os::elapsed_counter()) / os::elapsed_frequency(); // nanosecond resolution
1194 }
1195 
1196 jlong os::elapsed_counter() {
1197   return javaTimeNanos() - initial_time_count;
1198 }
1199 
1200 jlong os::elapsed_frequency() {
1201   return NANOSECS_PER_SEC; // nanosecond resolution
1202 }
1203 
1204 bool os::supports_vtime() { return true; }
<a name="22" id="anc22"></a><span class="line-removed">1205 bool os::enable_vtime()   { return false; }</span>
<span class="line-removed">1206 bool os::vtime_enabled()  { return false; }</span>
1207 
1208 double os::elapsedVTime() {
1209   struct rusage usage;
1210   int retval = getrusage(RUSAGE_THREAD, &amp;usage);
1211   if (retval == 0) {
1212     return (double) (usage.ru_utime.tv_sec + usage.ru_stime.tv_sec) + (double) (usage.ru_utime.tv_usec + usage.ru_stime.tv_usec) / (1000 * 1000);
1213   } else {
1214     // better than nothing, but not much
1215     return elapsedTime();
1216   }
1217 }
1218 
1219 jlong os::javaTimeMillis() {
1220   timeval time;
1221   int status = gettimeofday(&amp;time, NULL);
1222   assert(status != -1, &quot;linux error&quot;);
1223   return jlong(time.tv_sec) * 1000  +  jlong(time.tv_usec / 1000);
1224 }
1225 
1226 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1227   timeval time;
1228   int status = gettimeofday(&amp;time, NULL);
1229   assert(status != -1, &quot;linux error&quot;);
1230   seconds = jlong(time.tv_sec);
1231   nanos = jlong(time.tv_usec) * 1000;
1232 }
1233 
1234 void os::Linux::fast_thread_clock_init() {
1235   if (!UseLinuxPosixThreadCPUClocks) {
1236     return;
1237   }
1238   clockid_t clockid;
1239   struct timespec tp;
1240   int (*pthread_getcpuclockid_func)(pthread_t, clockid_t *) =
1241       (int(*)(pthread_t, clockid_t *)) dlsym(RTLD_DEFAULT, &quot;pthread_getcpuclockid&quot;);
1242 
1243   // Switch to using fast clocks for thread cpu time if
1244   // the clock_getres() returns 0 error code.
1245   // Note, that some kernels may support the current thread
1246   // clock (CLOCK_THREAD_CPUTIME_ID) but not the clocks
1247   // returned by the pthread_getcpuclockid().
1248   // If the fast Posix clocks are supported then the clock_getres()
1249   // must return at least tp.tv_sec == 0 which means a resolution
1250   // better than 1 sec. This is extra check for reliability.
1251 
1252   if (pthread_getcpuclockid_func &amp;&amp;
1253       pthread_getcpuclockid_func(_main_thread, &amp;clockid) == 0 &amp;&amp;
1254       os::Posix::clock_getres(clockid, &amp;tp) == 0 &amp;&amp; tp.tv_sec == 0) {
1255     _supports_fast_thread_cpu_time = true;
1256     _pthread_getcpuclockid = pthread_getcpuclockid_func;
1257   }
1258 }
1259 
1260 jlong os::javaTimeNanos() {
1261   if (os::supports_monotonic_clock()) {
1262     struct timespec tp;
1263     int status = os::Posix::clock_gettime(CLOCK_MONOTONIC, &amp;tp);
1264     assert(status == 0, &quot;gettime error&quot;);
1265     jlong result = jlong(tp.tv_sec) * (1000 * 1000 * 1000) + jlong(tp.tv_nsec);
1266     return result;
1267   } else {
1268     timeval time;
1269     int status = gettimeofday(&amp;time, NULL);
1270     assert(status != -1, &quot;linux error&quot;);
1271     jlong usecs = jlong(time.tv_sec) * (1000 * 1000) + jlong(time.tv_usec);
1272     return 1000 * usecs;
1273   }
1274 }
1275 
1276 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1277   if (os::supports_monotonic_clock()) {
1278     info_ptr-&gt;max_value = ALL_64_BITS;
1279 
1280     // CLOCK_MONOTONIC - amount of time since some arbitrary point in the past
1281     info_ptr-&gt;may_skip_backward = false;      // not subject to resetting or drifting
1282     info_ptr-&gt;may_skip_forward = false;       // not subject to resetting or drifting
1283   } else {
1284     // gettimeofday - based on time in seconds since the Epoch thus does not wrap
1285     info_ptr-&gt;max_value = ALL_64_BITS;
1286 
1287     // gettimeofday is a real time clock so it skips
1288     info_ptr-&gt;may_skip_backward = true;
1289     info_ptr-&gt;may_skip_forward = true;
1290   }
1291 
1292   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;                // elapsed not CPU time
1293 }
1294 
1295 // Return the real, user, and system times in seconds from an
1296 // arbitrary fixed point in the past.
1297 bool os::getTimesSecs(double* process_real_time,
1298                       double* process_user_time,
1299                       double* process_system_time) {
1300   struct tms ticks;
1301   clock_t real_ticks = times(&amp;ticks);
1302 
1303   if (real_ticks == (clock_t) (-1)) {
1304     return false;
1305   } else {
1306     double ticks_per_second = (double) clock_tics_per_sec;
1307     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1308     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1309     *process_real_time = ((double) real_ticks) / ticks_per_second;
1310 
1311     return true;
1312   }
1313 }
1314 
1315 
1316 char * os::local_time_string(char *buf, size_t buflen) {
1317   struct tm t;
1318   time_t long_time;
1319   time(&amp;long_time);
1320   localtime_r(&amp;long_time, &amp;t);
1321   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1322                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1323                t.tm_hour, t.tm_min, t.tm_sec);
1324   return buf;
1325 }
1326 
1327 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
1328   return localtime_r(clock, res);
1329 }
1330 
1331 ////////////////////////////////////////////////////////////////////////////////
1332 // runtime exit support
1333 
1334 // Note: os::shutdown() might be called very early during initialization, or
1335 // called from signal handler. Before adding something to os::shutdown(), make
1336 // sure it is async-safe and can handle partially initialized VM.
1337 void os::shutdown() {
1338 
1339   // allow PerfMemory to attempt cleanup of any persistent resources
1340   perfMemory_exit();
1341 
1342   // needs to remove object in file system
1343   AttachListener::abort();
1344 
1345   // flush buffered output, finish log files
1346   ostream_abort();
1347 
1348   // Check for abort hook
1349   abort_hook_t abort_hook = Arguments::abort_hook();
1350   if (abort_hook != NULL) {
1351     abort_hook();
1352   }
1353 
1354 }
1355 
1356 // Note: os::abort() might be called very early during initialization, or
1357 // called from signal handler. Before adding something to os::abort(), make
1358 // sure it is async-safe and can handle partially initialized VM.
1359 void os::abort(bool dump_core, void* siginfo, const void* context) {
1360   os::shutdown();
1361   if (dump_core) {
1362     if (DumpPrivateMappingsInCore) {
1363       ClassLoader::close_jrt_image();
1364     }
1365 #ifndef PRODUCT
1366     fdStream out(defaultStream::output_fd());
1367     out.print_raw(&quot;Current thread is &quot;);
1368     char buf[16];
1369     jio_snprintf(buf, sizeof(buf), UINTX_FORMAT, os::current_thread_id());
1370     out.print_raw_cr(buf);
1371     out.print_raw_cr(&quot;Dumping core ...&quot;);
1372 #endif
1373     ::abort(); // dump core
1374   }
1375 
1376   ::exit(1);
1377 }
1378 
1379 // Die immediately, no exit hook, no abort hook, no cleanup.
<a name="23" id="anc23"></a>
1380 void os::die() {
<a name="24" id="anc24"></a><span class="line-modified">1381   ::abort();</span>






1382 }
1383 
1384 // thread_id is kernel thread id (similar to Solaris LWP id)
1385 intx os::current_thread_id() { return os::Linux::gettid(); }
1386 int os::current_process_id() {
1387   return ::getpid();
1388 }
1389 
1390 // DLL functions
1391 
1392 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1393 
1394 // This must be hard coded because it&#39;s the system&#39;s temporary
1395 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1396 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1397 
1398 static bool file_exists(const char* filename) {
1399   struct stat statbuf;
1400   if (filename == NULL || strlen(filename) == 0) {
1401     return false;
1402   }
1403   return os::stat(filename, &amp;statbuf) == 0;
1404 }
1405 
1406 // check if addr is inside libjvm.so
1407 bool os::address_is_in_vm(address addr) {
1408   static address libjvm_base_addr;
1409   Dl_info dlinfo;
1410 
1411   if (libjvm_base_addr == NULL) {
1412     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1413       libjvm_base_addr = (address)dlinfo.dli_fbase;
1414     }
1415     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1416   }
1417 
1418   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1419     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1420   }
1421 
1422   return false;
1423 }
1424 
1425 bool os::dll_address_to_function_name(address addr, char *buf,
1426                                       int buflen, int *offset,
1427                                       bool demangle) {
1428   // buf is not optional, but offset is optional
1429   assert(buf != NULL, &quot;sanity check&quot;);
1430 
1431   Dl_info dlinfo;
1432 
1433   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1434     // see if we have a matching symbol
1435     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1436       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1437         jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1438       }
1439       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1440       return true;
1441     }
1442     // no matching symbol so try for just file info
1443     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1444       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1445                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1446         return true;
1447       }
1448     }
1449   }
1450 
1451   buf[0] = &#39;\0&#39;;
1452   if (offset != NULL) *offset = -1;
1453   return false;
1454 }
1455 
1456 struct _address_to_library_name {
1457   address addr;          // input : memory address
1458   size_t  buflen;        //         size of fname
1459   char*   fname;         // output: library name
1460   address base;          //         library base addr
1461 };
1462 
1463 static int address_to_library_name_callback(struct dl_phdr_info *info,
1464                                             size_t size, void *data) {
1465   int i;
1466   bool found = false;
1467   address libbase = NULL;
1468   struct _address_to_library_name * d = (struct _address_to_library_name *)data;
1469 
1470   // iterate through all loadable segments
1471   for (i = 0; i &lt; info-&gt;dlpi_phnum; i++) {
1472     address segbase = (address)(info-&gt;dlpi_addr + info-&gt;dlpi_phdr[i].p_vaddr);
1473     if (info-&gt;dlpi_phdr[i].p_type == PT_LOAD) {
1474       // base address of a library is the lowest address of its loaded
1475       // segments.
1476       if (libbase == NULL || libbase &gt; segbase) {
1477         libbase = segbase;
1478       }
1479       // see if &#39;addr&#39; is within current segment
1480       if (segbase &lt;= d-&gt;addr &amp;&amp;
1481           d-&gt;addr &lt; segbase + info-&gt;dlpi_phdr[i].p_memsz) {
1482         found = true;
1483       }
1484     }
1485   }
1486 
1487   // dlpi_name is NULL or empty if the ELF file is executable, return 0
1488   // so dll_address_to_library_name() can fall through to use dladdr() which
1489   // can figure out executable name from argv[0].
1490   if (found &amp;&amp; info-&gt;dlpi_name &amp;&amp; info-&gt;dlpi_name[0]) {
1491     d-&gt;base = libbase;
1492     if (d-&gt;fname) {
1493       jio_snprintf(d-&gt;fname, d-&gt;buflen, &quot;%s&quot;, info-&gt;dlpi_name);
1494     }
1495     return 1;
1496   }
1497   return 0;
1498 }
1499 
1500 bool os::dll_address_to_library_name(address addr, char* buf,
1501                                      int buflen, int* offset) {
1502   // buf is not optional, but offset is optional
1503   assert(buf != NULL, &quot;sanity check&quot;);
1504 
1505   Dl_info dlinfo;
1506   struct _address_to_library_name data;
1507 
1508   // There is a bug in old glibc dladdr() implementation that it could resolve
1509   // to wrong library name if the .so file has a base address != NULL. Here
1510   // we iterate through the program headers of all loaded libraries to find
1511   // out which library &#39;addr&#39; really belongs to. This workaround can be
1512   // removed once the minimum requirement for glibc is moved to 2.3.x.
1513   data.addr = addr;
1514   data.fname = buf;
1515   data.buflen = buflen;
1516   data.base = NULL;
1517   int rslt = dl_iterate_phdr(address_to_library_name_callback, (void *)&amp;data);
1518 
1519   if (rslt) {
1520     // buf already contains library name
1521     if (offset) *offset = addr - data.base;
1522     return true;
1523   }
1524   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1525     if (dlinfo.dli_fname != NULL) {
1526       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1527     }
1528     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1529       *offset = addr - (address)dlinfo.dli_fbase;
1530     }
1531     return true;
1532   }
1533 
1534   buf[0] = &#39;\0&#39;;
1535   if (offset) *offset = -1;
1536   return false;
1537 }
1538 
1539 // Loads .dll/.so and
1540 // in case of error it checks if .dll/.so was built for the
1541 // same architecture as Hotspot is running on
1542 
1543 
1544 // Remember the stack&#39;s state. The Linux dynamic linker will change
1545 // the stack to &#39;executable&#39; at most once, so we must safepoint only once.
1546 bool os::Linux::_stack_is_executable = false;
1547 
1548 // VM operation that loads a library.  This is necessary if stack protection
1549 // of the Java stacks can be lost during loading the library.  If we
1550 // do not stop the Java threads, they can stack overflow before the stacks
1551 // are protected again.
1552 class VM_LinuxDllLoad: public VM_Operation {
1553  private:
1554   const char *_filename;
1555   char *_ebuf;
1556   int _ebuflen;
1557   void *_lib;
1558  public:
1559   VM_LinuxDllLoad(const char *fn, char *ebuf, int ebuflen) :
1560     _filename(fn), _ebuf(ebuf), _ebuflen(ebuflen), _lib(NULL) {}
1561   VMOp_Type type() const { return VMOp_LinuxDllLoad; }
1562   void doit() {
1563     _lib = os::Linux::dll_load_in_vmthread(_filename, _ebuf, _ebuflen);
1564     os::Linux::_stack_is_executable = true;
1565   }
1566   void* loaded_library() { return _lib; }
1567 };
1568 
1569 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1570   void * result = NULL;
1571   bool load_attempted = false;
1572 
<a name="25" id="anc25"></a>

1573   // Check whether the library to load might change execution rights
1574   // of the stack. If they are changed, the protection of the stack
1575   // guard pages will be lost. We need a safepoint to fix this.
1576   //
1577   // See Linux man page execstack(8) for more info.
1578   if (os::uses_stack_guard_pages() &amp;&amp; !os::Linux::_stack_is_executable) {
1579     if (!ElfFile::specifies_noexecstack(filename)) {
1580       if (!is_init_completed()) {
1581         os::Linux::_stack_is_executable = true;
1582         // This is OK - No Java threads have been created yet, and hence no
1583         // stack guard pages to fix.
1584         //
1585         // Dynamic loader will make all stacks executable after
1586         // this function returns, and will not do that again.
1587         assert(Threads::number_of_threads() == 0, &quot;no Java threads should exist yet.&quot;);
1588       } else {
1589         warning(&quot;You have loaded library %s which might have disabled stack guard. &quot;
1590                 &quot;The VM will try to fix the stack guard now.\n&quot;
1591                 &quot;It&#39;s highly recommended that you fix the library with &quot;
1592                 &quot;&#39;execstack -c &lt;libfile&gt;&#39;, or link it with &#39;-z noexecstack&#39;.&quot;,
1593                 filename);
1594 
1595         assert(Thread::current()-&gt;is_Java_thread(), &quot;must be Java thread&quot;);
1596         JavaThread *jt = JavaThread::current();
1597         if (jt-&gt;thread_state() != _thread_in_native) {
1598           // This happens when a compiler thread tries to load a hsdis-&lt;arch&gt;.so file
1599           // that requires ExecStack. Cannot enter safe point. Let&#39;s give up.
1600           warning(&quot;Unable to fix stack guard. Giving up.&quot;);
1601         } else {
1602           if (!LoadExecStackDllInVMThread) {
1603             // This is for the case where the DLL has an static
1604             // constructor function that executes JNI code. We cannot
1605             // load such DLLs in the VMThread.
1606             result = os::Linux::dlopen_helper(filename, ebuf, ebuflen);
1607           }
1608 
1609           ThreadInVMfromNative tiv(jt);
1610           debug_only(VMNativeEntryWrapper vew;)
1611 
1612           VM_LinuxDllLoad op(filename, ebuf, ebuflen);
1613           VMThread::execute(&amp;op);
1614           if (LoadExecStackDllInVMThread) {
1615             result = op.loaded_library();
1616           }
1617           load_attempted = true;
1618         }
1619       }
1620     }
1621   }
1622 
1623   if (!load_attempted) {
1624     result = os::Linux::dlopen_helper(filename, ebuf, ebuflen);
1625   }
1626 
1627   if (result != NULL) {
1628     // Successful loading
1629     return result;
1630   }
1631 
1632   Elf32_Ehdr elf_head;
1633   int diag_msg_max_length=ebuflen-strlen(ebuf);
1634   char* diag_msg_buf=ebuf+strlen(ebuf);
1635 
1636   if (diag_msg_max_length==0) {
1637     // No more space in ebuf for additional diagnostics message
1638     return NULL;
1639   }
1640 
1641 
1642   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1643 
1644   if (file_descriptor &lt; 0) {
1645     // Can&#39;t open library, report dlerror() message
1646     return NULL;
1647   }
1648 
1649   bool failed_to_read_elf_head=
1650     (sizeof(elf_head)!=
1651      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1652 
1653   ::close(file_descriptor);
1654   if (failed_to_read_elf_head) {
1655     // file i/o error - report dlerror() msg
1656     return NULL;
1657   }
1658 
<a name="26" id="anc26"></a>














1659   typedef struct {
1660     Elf32_Half    code;         // Actual value as defined in elf.h
1661     Elf32_Half    compat_class; // Compatibility of archs at VM&#39;s sense
1662     unsigned char elf_class;    // 32 or 64 bit
<a name="27" id="anc27"></a><span class="line-modified">1663     unsigned char endianess;    // MSB or LSB</span>
1664     char*         name;         // String representation
1665   } arch_t;
1666 
1667 #ifndef EM_486
1668   #define EM_486          6               /* Intel 80486 */
1669 #endif
1670 #ifndef EM_AARCH64
1671   #define EM_AARCH64    183               /* ARM AARCH64 */
1672 #endif
1673 
1674   static const arch_t arch_array[]={
1675     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1676     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1677     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1678     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1679     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1680     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1681     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1682     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1683 #if defined(VM_LITTLE_ENDIAN)
1684     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Power PC 64 LE&quot;},
1685     {EM_SH,          EM_SH,      ELFCLASS32, ELFDATA2LSB, (char*)&quot;SuperH&quot;},
1686 #else
1687     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1688     {EM_SH,          EM_SH,      ELFCLASS32, ELFDATA2MSB, (char*)&quot;SuperH BE&quot;},
1689 #endif
<a name="28" id="anc28"></a><span class="line-modified">1690     {EM_ARM,         EM_ARM,     ELFCLASS32,   ELFDATA2LSB, (char*)&quot;ARM&quot;},</span>
<span class="line-modified">1691     {EM_S390,        EM_S390,    ELFCLASSNONE, ELFDATA2MSB, (char*)&quot;IBM System/390&quot;},</span>

1692     {EM_ALPHA,       EM_ALPHA,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;Alpha&quot;},
1693     {EM_MIPS_RS3_LE, EM_MIPS_RS3_LE, ELFCLASS32, ELFDATA2LSB, (char*)&quot;MIPSel&quot;},
1694     {EM_MIPS,        EM_MIPS,    ELFCLASS32, ELFDATA2MSB, (char*)&quot;MIPS&quot;},
1695     {EM_PARISC,      EM_PARISC,  ELFCLASS32, ELFDATA2MSB, (char*)&quot;PARISC&quot;},
1696     {EM_68K,         EM_68K,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;M68k&quot;},
1697     {EM_AARCH64,     EM_AARCH64, ELFCLASS64, ELFDATA2LSB, (char*)&quot;AARCH64&quot;},
1698   };
1699 
1700 #if  (defined IA32)
1701   static  Elf32_Half running_arch_code=EM_386;
1702 #elif   (defined AMD64) || (defined X32)
1703   static  Elf32_Half running_arch_code=EM_X86_64;
1704 #elif  (defined IA64)
1705   static  Elf32_Half running_arch_code=EM_IA_64;
1706 #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1707   static  Elf32_Half running_arch_code=EM_SPARCV9;
1708 #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1709   static  Elf32_Half running_arch_code=EM_SPARC;
1710 #elif  (defined __powerpc64__)
1711   static  Elf32_Half running_arch_code=EM_PPC64;
1712 #elif  (defined __powerpc__)
1713   static  Elf32_Half running_arch_code=EM_PPC;
1714 #elif  (defined AARCH64)
1715   static  Elf32_Half running_arch_code=EM_AARCH64;
1716 #elif  (defined ARM)
1717   static  Elf32_Half running_arch_code=EM_ARM;
1718 #elif  (defined S390)
1719   static  Elf32_Half running_arch_code=EM_S390;
1720 #elif  (defined ALPHA)
1721   static  Elf32_Half running_arch_code=EM_ALPHA;
1722 #elif  (defined MIPSEL)
1723   static  Elf32_Half running_arch_code=EM_MIPS_RS3_LE;
1724 #elif  (defined PARISC)
1725   static  Elf32_Half running_arch_code=EM_PARISC;
1726 #elif  (defined MIPS)
1727   static  Elf32_Half running_arch_code=EM_MIPS;
1728 #elif  (defined M68K)
1729   static  Elf32_Half running_arch_code=EM_68K;
1730 #elif  (defined SH)
1731   static  Elf32_Half running_arch_code=EM_SH;
1732 #else
1733     #error Method os::dll_load requires that one of following is defined:\
1734         AARCH64, ALPHA, ARM, AMD64, IA32, IA64, M68K, MIPS, MIPSEL, PARISC, __powerpc__, __powerpc64__, S390, SH, __sparc
1735 #endif
1736 
<a name="29" id="anc29"></a><span class="line-modified">1737   // Identify compatability class for VM&#39;s architecture and library&#39;s architecture</span>
1738   // Obtain string descriptions for architectures
1739 
1740   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1741   int running_arch_index=-1;
1742 
1743   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1744     if (running_arch_code == arch_array[i].code) {
1745       running_arch_index    = i;
1746     }
1747     if (lib_arch.code == arch_array[i].code) {
1748       lib_arch.compat_class = arch_array[i].compat_class;
1749       lib_arch.name         = arch_array[i].name;
1750     }
1751   }
1752 
1753   assert(running_arch_index != -1,
1754          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1755   if (running_arch_index == -1) {
1756     // Even though running architecture detection failed
1757     // we may still continue with reporting dlerror() message
1758     return NULL;
1759   }
1760 
<a name="30" id="anc30"></a><span class="line-removed">1761   if (lib_arch.endianess != arch_array[running_arch_index].endianess) {</span>
<span class="line-removed">1762     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: endianness mismatch)&quot;);</span>
<span class="line-removed">1763     return NULL;</span>
<span class="line-removed">1764   }</span>
<span class="line-removed">1765 </span>
<span class="line-removed">1766 #ifndef S390</span>
<span class="line-removed">1767   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {</span>
<span class="line-removed">1768     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: architecture word width mismatch)&quot;);</span>
<span class="line-removed">1769     return NULL;</span>
<span class="line-removed">1770   }</span>
<span class="line-removed">1771 #endif // !S390</span>
<span class="line-removed">1772 </span>
1773   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
<a name="31" id="anc31"></a><span class="line-modified">1774     if (lib_arch.name!=NULL) {</span>
1775       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
<a name="32" id="anc32"></a><span class="line-modified">1776                  &quot; (Possible cause: can&#39;t load %s-bit .so on a %s-bit platform)&quot;,</span>
1777                  lib_arch.name, arch_array[running_arch_index].name);
1778     } else {
1779       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
<a name="33" id="anc33"></a><span class="line-modified">1780                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s-bit platform)&quot;,</span>
<span class="line-modified">1781                  lib_arch.code,</span>
<span class="line-removed">1782                  arch_array[running_arch_index].name);</span>
1783     }
<a name="34" id="anc34"></a>


















1784   }
1785 
1786   return NULL;
1787 }
1788 
1789 void * os::Linux::dlopen_helper(const char *filename, char *ebuf,
1790                                 int ebuflen) {
1791   void * result = ::dlopen(filename, RTLD_LAZY);
1792   if (result == NULL) {
<a name="35" id="anc35"></a><span class="line-modified">1793     ::strncpy(ebuf, ::dlerror(), ebuflen - 1);</span>
<span class="line-modified">1794     ebuf[ebuflen-1] = &#39;\0&#39;;</span>











1795   }
1796   return result;
1797 }
1798 
1799 void * os::Linux::dll_load_in_vmthread(const char *filename, char *ebuf,
1800                                        int ebuflen) {
1801   void * result = NULL;
1802   if (LoadExecStackDllInVMThread) {
1803     result = dlopen_helper(filename, ebuf, ebuflen);
1804   }
1805 
1806   // Since 7019808, libjvm.so is linked with -noexecstack. If the VM loads a
1807   // library that requires an executable stack, or which does not have this
1808   // stack attribute set, dlopen changes the stack attribute to executable. The
1809   // read protection of the guard pages gets lost.
1810   //
1811   // Need to check _stack_is_executable again as multiple VM_LinuxDllLoad
1812   // may have been queued at the same time.
1813 
1814   if (!_stack_is_executable) {
1815     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *jt = jtiwh.next(); ) {
1816       if (!jt-&gt;stack_guard_zone_unused() &amp;&amp;     // Stack not yet fully initialized
1817           jt-&gt;stack_guards_enabled()) {         // No pending stack overflow exceptions
1818         if (!os::guard_memory((char *)jt-&gt;stack_end(), jt-&gt;stack_guard_zone_size())) {
1819           warning(&quot;Attempt to reguard stack yellow zone failed.&quot;);
1820         }
1821       }
1822     }
1823   }
1824 
1825   return result;
1826 }
1827 
1828 void* os::dll_lookup(void* handle, const char* name) {
1829   void* res = dlsym(handle, name);
1830   return res;
1831 }
1832 
1833 void* os::get_default_process_handle() {
1834   return (void*)::dlopen(NULL, RTLD_LAZY);
1835 }
1836 
1837 static bool _print_ascii_file(const char* filename, outputStream* st, const char* hdr = NULL) {
1838   int fd = ::open(filename, O_RDONLY);
1839   if (fd == -1) {
1840     return false;
1841   }
1842 
1843   if (hdr != NULL) {
1844     st-&gt;print_cr(&quot;%s&quot;, hdr);
1845   }
1846 
1847   char buf[33];
1848   int bytes;
1849   buf[32] = &#39;\0&#39;;
1850   while ((bytes = ::read(fd, buf, sizeof(buf)-1)) &gt; 0) {
1851     st-&gt;print_raw(buf, bytes);
1852   }
1853 
1854   ::close(fd);
1855 
1856   return true;
1857 }
1858 
<a name="36" id="anc36"></a><span class="line-removed">1859 #if defined(S390) || defined(PPC64)</span>
<span class="line-removed">1860 // keywords_to_match - NULL terminated array of keywords</span>
<span class="line-removed">1861 static bool print_matching_lines_from_file(const char* filename, outputStream* st, const char* keywords_to_match[]) {</span>
<span class="line-removed">1862   char* line = NULL;</span>
<span class="line-removed">1863   size_t length = 0;</span>
<span class="line-removed">1864   FILE* fp = fopen(filename, &quot;r&quot;);</span>
<span class="line-removed">1865   if (fp == NULL) {</span>
<span class="line-removed">1866     return false;</span>
<span class="line-removed">1867   }</span>
<span class="line-removed">1868 </span>
<span class="line-removed">1869   st-&gt;print_cr(&quot;Virtualization information:&quot;);</span>
<span class="line-removed">1870   while (getline(&amp;line, &amp;length, fp) != -1) {</span>
<span class="line-removed">1871     int i = 0;</span>
<span class="line-removed">1872     while (keywords_to_match[i] != NULL) {</span>
<span class="line-removed">1873       if (strncmp(line, keywords_to_match[i], strlen(keywords_to_match[i])) == 0) {</span>
<span class="line-removed">1874         st-&gt;print(&quot;%s&quot;, line);</span>
<span class="line-removed">1875         break;</span>
<span class="line-removed">1876       }</span>
<span class="line-removed">1877       i++;</span>
<span class="line-removed">1878     }</span>
<span class="line-removed">1879   }</span>
<span class="line-removed">1880 </span>
<span class="line-removed">1881   free(line);</span>
<span class="line-removed">1882   fclose(fp);</span>
<span class="line-removed">1883 </span>
<span class="line-removed">1884   return true;</span>
<span class="line-removed">1885 }</span>
<span class="line-removed">1886 #endif</span>
<span class="line-removed">1887 </span>
1888 void os::print_dll_info(outputStream *st) {
1889   st-&gt;print_cr(&quot;Dynamic libraries:&quot;);
1890 
1891   char fname[32];
1892   pid_t pid = os::Linux::gettid();
1893 
1894   jio_snprintf(fname, sizeof(fname), &quot;/proc/%d/maps&quot;, pid);
1895 
1896   if (!_print_ascii_file(fname, st)) {
1897     st-&gt;print(&quot;Can not get library information for pid = %d\n&quot;, pid);
1898   }
1899 }
1900 
1901 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
1902   FILE *procmapsFile = NULL;
1903 
1904   // Open the procfs maps file for the current process
1905   if ((procmapsFile = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;)) != NULL) {
1906     // Allocate PATH_MAX for file name plus a reasonable size for other fields.
1907     char line[PATH_MAX + 100];
1908 
1909     // Read line by line from &#39;file&#39;
1910     while (fgets(line, sizeof(line), procmapsFile) != NULL) {
1911       u8 base, top, offset, inode;
1912       char permissions[5];
1913       char device[6];
<a name="37" id="anc37"></a><span class="line-modified">1914       char name[PATH_MAX + 1];</span>
1915 
1916       // Parse fields from line
<a name="38" id="anc38"></a><span class="line-modified">1917       sscanf(line, UINT64_FORMAT_X &quot;-&quot; UINT64_FORMAT_X &quot; %4s &quot; UINT64_FORMAT_X &quot; %7s &quot; INT64_FORMAT &quot; %s&quot;,</span>
1918              &amp;base, &amp;top, permissions, &amp;offset, device, &amp;inode, name);
<a name="39" id="anc39"></a>


1919 
1920       // Filter by device id &#39;00:00&#39; so that we only get file system mapped files.
1921       if (strcmp(device, &quot;00:00&quot;) != 0) {
1922 
1923         // Call callback with the fields of interest
1924         if(callback(name, (address)base, (address)top, param)) {
1925           // Oops abort, callback aborted
1926           fclose(procmapsFile);
1927           return 1;
1928         }
1929       }
1930     }
1931     fclose(procmapsFile);
1932   }
1933   return 0;
1934 }
1935 
1936 void os::print_os_info_brief(outputStream* st) {
1937   os::Linux::print_distro_info(st);
1938 
1939   os::Posix::print_uname_info(st);
1940 
1941   os::Linux::print_libversion_info(st);
1942 
1943 }
1944 
1945 void os::print_os_info(outputStream* st) {
1946   st-&gt;print(&quot;OS:&quot;);
1947 
1948   os::Linux::print_distro_info(st);
1949 
1950   os::Posix::print_uname_info(st);
1951 
<a name="40" id="anc40"></a>

1952   // Print warning if unsafe chroot environment detected
1953   if (unsafe_chroot_detected) {
1954     st-&gt;print(&quot;WARNING!! &quot;);
1955     st-&gt;print_cr(&quot;%s&quot;, unstable_chroot_error);
1956   }
1957 
1958   os::Linux::print_libversion_info(st);
1959 
1960   os::Posix::print_rlimit_info(st);
1961 
1962   os::Posix::print_load_average(st);
1963 
1964   os::Linux::print_full_memory_info(st);
1965 
1966   os::Linux::print_proc_sys_info(st);
1967 
1968   os::Linux::print_ld_preload_file(st);
1969 
1970   os::Linux::print_container_info(st);
1971 
<a name="41" id="anc41"></a><span class="line-modified">1972   os::Linux::print_virtualization_info(st);</span>


1973 }
1974 
1975 // Try to identify popular distros.
1976 // Most Linux distributions have a /etc/XXX-release file, which contains
1977 // the OS version string. Newer Linux distributions have a /etc/lsb-release
1978 // file that also contains the OS version string. Some have more than one
1979 // /etc/XXX-release file (e.g. Mandrake has both /etc/mandrake-release and
1980 // /etc/redhat-release.), so the order is important.
1981 // Any Linux that is based on Redhat (i.e. Oracle, Mandrake, Sun JDS...) have
1982 // their own specific XXX-release file as well as a redhat-release file.
1983 // Because of this the XXX-release file needs to be searched for before the
1984 // redhat-release file.
1985 // Since Red Hat and SuSE have an lsb-release file that is not very descriptive the
1986 // search for redhat-release / SuSE-release needs to be before lsb-release.
1987 // Since the lsb-release file is the new standard it needs to be searched
1988 // before the older style release files.
1989 // Searching system-release (Red Hat) and os-release (other Linuxes) are a
1990 // next to last resort.  The os-release file is a new standard that contains
1991 // distribution information and the system-release file seems to be an old
1992 // standard that has been replaced by the lsb-release and os-release files.
1993 // Searching for the debian_version file is the last resort.  It contains
1994 // an informative string like &quot;6.0.6&quot; or &quot;wheezy/sid&quot;. Because of this
1995 // &quot;Debian &quot; is printed before the contents of the debian_version file.
1996 
1997 const char* distro_files[] = {
1998   &quot;/etc/oracle-release&quot;,
1999   &quot;/etc/mandriva-release&quot;,
2000   &quot;/etc/mandrake-release&quot;,
2001   &quot;/etc/sun-release&quot;,
2002   &quot;/etc/redhat-release&quot;,
2003   &quot;/etc/SuSE-release&quot;,
2004   &quot;/etc/lsb-release&quot;,
2005   &quot;/etc/turbolinux-release&quot;,
2006   &quot;/etc/gentoo-release&quot;,
2007   &quot;/etc/ltib-release&quot;,
2008   &quot;/etc/angstrom-version&quot;,
2009   &quot;/etc/system-release&quot;,
2010   &quot;/etc/os-release&quot;,
2011   NULL };
2012 
2013 void os::Linux::print_distro_info(outputStream* st) {
2014   for (int i = 0;; i++) {
2015     const char* file = distro_files[i];
2016     if (file == NULL) {
2017       break;  // done
2018     }
2019     // If file prints, we found it.
2020     if (_print_ascii_file(file, st)) {
2021       return;
2022     }
2023   }
2024 
2025   if (file_exists(&quot;/etc/debian_version&quot;)) {
2026     st-&gt;print(&quot;Debian &quot;);
2027     _print_ascii_file(&quot;/etc/debian_version&quot;, st);
2028   } else {
2029     st-&gt;print(&quot;Linux&quot;);
2030   }
2031   st-&gt;cr();
2032 }
2033 
2034 static void parse_os_info_helper(FILE* fp, char* distro, size_t length, bool get_first_line) {
2035   char buf[256];
2036   while (fgets(buf, sizeof(buf), fp)) {
2037     // Edit out extra stuff in expected format
2038     if (strstr(buf, &quot;DISTRIB_DESCRIPTION=&quot;) != NULL || strstr(buf, &quot;PRETTY_NAME=&quot;) != NULL) {
2039       char* ptr = strstr(buf, &quot;\&quot;&quot;);  // the name is in quotes
2040       if (ptr != NULL) {
2041         ptr++; // go beyond first quote
2042         char* nl = strchr(ptr, &#39;\&quot;&#39;);
2043         if (nl != NULL) *nl = &#39;\0&#39;;
2044         strncpy(distro, ptr, length);
2045       } else {
2046         ptr = strstr(buf, &quot;=&quot;);
2047         ptr++; // go beyond equals then
2048         char* nl = strchr(ptr, &#39;\n&#39;);
2049         if (nl != NULL) *nl = &#39;\0&#39;;
2050         strncpy(distro, ptr, length);
2051       }
2052       return;
2053     } else if (get_first_line) {
2054       char* nl = strchr(buf, &#39;\n&#39;);
2055       if (nl != NULL) *nl = &#39;\0&#39;;
2056       strncpy(distro, buf, length);
2057       return;
2058     }
2059   }
2060   // print last line and close
2061   char* nl = strchr(buf, &#39;\n&#39;);
2062   if (nl != NULL) *nl = &#39;\0&#39;;
2063   strncpy(distro, buf, length);
2064 }
2065 
2066 static void parse_os_info(char* distro, size_t length, const char* file) {
2067   FILE* fp = fopen(file, &quot;r&quot;);
2068   if (fp != NULL) {
2069     // if suse format, print out first line
2070     bool get_first_line = (strcmp(file, &quot;/etc/SuSE-release&quot;) == 0);
2071     parse_os_info_helper(fp, distro, length, get_first_line);
2072     fclose(fp);
2073   }
2074 }
2075 
2076 void os::get_summary_os_info(char* buf, size_t buflen) {
2077   for (int i = 0;; i++) {
2078     const char* file = distro_files[i];
2079     if (file == NULL) {
2080       break; // ran out of distro_files
2081     }
2082     if (file_exists(file)) {
2083       parse_os_info(buf, buflen, file);
2084       return;
2085     }
2086   }
2087   // special case for debian
2088   if (file_exists(&quot;/etc/debian_version&quot;)) {
2089     strncpy(buf, &quot;Debian &quot;, buflen);
2090     if (buflen &gt; 7) {
2091       parse_os_info(&amp;buf[7], buflen-7, &quot;/etc/debian_version&quot;);
2092     }
2093   } else {
2094     strncpy(buf, &quot;Linux&quot;, buflen);
2095   }
2096 }
2097 
2098 void os::Linux::print_libversion_info(outputStream* st) {
2099   // libc, pthread
2100   st-&gt;print(&quot;libc:&quot;);
2101   st-&gt;print(&quot;%s &quot;, os::Linux::glibc_version());
2102   st-&gt;print(&quot;%s &quot;, os::Linux::libpthread_version());
2103   st-&gt;cr();
2104 }
2105 
2106 void os::Linux::print_proc_sys_info(outputStream* st) {
2107   st-&gt;cr();
2108   st-&gt;print_cr(&quot;/proc/sys/kernel/threads-max (system-wide limit on the number of threads):&quot;);
2109   _print_ascii_file(&quot;/proc/sys/kernel/threads-max&quot;, st);
2110   st-&gt;cr();
2111   st-&gt;cr();
2112 
2113   st-&gt;print_cr(&quot;/proc/sys/vm/max_map_count (maximum number of memory map areas a process may have):&quot;);
2114   _print_ascii_file(&quot;/proc/sys/vm/max_map_count&quot;, st);
2115   st-&gt;cr();
2116   st-&gt;cr();
2117 
2118   st-&gt;print_cr(&quot;/proc/sys/kernel/pid_max (system-wide limit on number of process identifiers):&quot;);
2119   _print_ascii_file(&quot;/proc/sys/kernel/pid_max&quot;, st);
2120   st-&gt;cr();
2121   st-&gt;cr();
2122 }
2123 
2124 void os::Linux::print_full_memory_info(outputStream* st) {
2125   st-&gt;print(&quot;\n/proc/meminfo:\n&quot;);
2126   _print_ascii_file(&quot;/proc/meminfo&quot;, st);
2127   st-&gt;cr();
2128 }
2129 
2130 void os::Linux::print_ld_preload_file(outputStream* st) {
2131   _print_ascii_file(&quot;/etc/ld.so.preload&quot;, st, &quot;\n/etc/ld.so.preload:&quot;);
2132   st-&gt;cr();
2133 }
2134 
<a name="42" id="anc42"></a>








2135 void os::Linux::print_container_info(outputStream* st) {
2136   if (!OSContainer::is_containerized()) {
2137     return;
2138   }
2139 
2140   st-&gt;print(&quot;container (cgroup) information:\n&quot;);
2141 
2142   const char *p_ct = OSContainer::container_type();
<a name="43" id="anc43"></a><span class="line-modified">2143   st-&gt;print(&quot;container_type: %s\n&quot;, p_ct != NULL ? p_ct : &quot;failed&quot;);</span>
2144 
2145   char *p = OSContainer::cpu_cpuset_cpus();
<a name="44" id="anc44"></a><span class="line-modified">2146   st-&gt;print(&quot;cpu_cpuset_cpus: %s\n&quot;, p != NULL ? p : &quot;failed&quot;);</span>
2147   free(p);
2148 
2149   p = OSContainer::cpu_cpuset_memory_nodes();
<a name="45" id="anc45"></a><span class="line-modified">2150   st-&gt;print(&quot;cpu_memory_nodes: %s\n&quot;, p != NULL ? p : &quot;failed&quot;);</span>
2151   free(p);
2152 
2153   int i = OSContainer::active_processor_count();
<a name="46" id="anc46"></a>
2154   if (i &gt; 0) {
<a name="47" id="anc47"></a><span class="line-modified">2155     st-&gt;print(&quot;active_processor_count: %d\n&quot;, i);</span>
2156   } else {
<a name="48" id="anc48"></a><span class="line-modified">2157     st-&gt;print(&quot;active_processor_count: failed\n&quot;);</span>
2158   }
2159 
2160   i = OSContainer::cpu_quota();
<a name="49" id="anc49"></a><span class="line-modified">2161   st-&gt;print(&quot;cpu_quota: %d\n&quot;, i);</span>





2162 
2163   i = OSContainer::cpu_period();
<a name="50" id="anc50"></a><span class="line-modified">2164   st-&gt;print(&quot;cpu_period: %d\n&quot;, i);</span>





2165 
2166   i = OSContainer::cpu_shares();
<a name="51" id="anc51"></a><span class="line-modified">2167   st-&gt;print(&quot;cpu_shares: %d\n&quot;, i);</span>





2168 
2169   jlong j = OSContainer::memory_limit_in_bytes();
<a name="52" id="anc52"></a><span class="line-modified">2170   st-&gt;print(&quot;memory_limit_in_bytes: &quot; JLONG_FORMAT &quot;\n&quot;, j);</span>





2171 
2172   j = OSContainer::memory_and_swap_limit_in_bytes();
<a name="53" id="anc53"></a><span class="line-modified">2173   st-&gt;print(&quot;memory_and_swap_limit_in_bytes: &quot; JLONG_FORMAT &quot;\n&quot;, j);</span>





2174 
2175   j = OSContainer::memory_soft_limit_in_bytes();
<a name="54" id="anc54"></a><span class="line-modified">2176   st-&gt;print(&quot;memory_soft_limit_in_bytes: &quot; JLONG_FORMAT &quot;\n&quot;, j);</span>





2177 
2178   j = OSContainer::OSContainer::memory_usage_in_bytes();
<a name="55" id="anc55"></a><span class="line-modified">2179   st-&gt;print(&quot;memory_usage_in_bytes: &quot; JLONG_FORMAT &quot;\n&quot;, j);</span>





2180 
2181   j = OSContainer::OSContainer::memory_max_usage_in_bytes();
<a name="56" id="anc56"></a><span class="line-modified">2182   st-&gt;print(&quot;memory_max_usage_in_bytes: &quot; JLONG_FORMAT &quot;\n&quot;, j);</span>





2183   st-&gt;cr();
2184 }
2185 
<a name="57" id="anc57"></a><span class="line-modified">2186 void os::Linux::print_virtualization_info(outputStream* st) {</span>
<span class="line-modified">2187 #if defined(S390)</span>
<span class="line-modified">2188   // /proc/sysinfo contains interesting information about</span>
<span class="line-modified">2189   // - LPAR</span>
<span class="line-removed">2190   // - whole &quot;Box&quot; (CPUs )</span>
<span class="line-removed">2191   // - z/VM / KVM (VM&lt;nn&gt;); this is not available in an LPAR-only setup</span>
<span class="line-removed">2192   const char* kw[] = { &quot;LPAR&quot;, &quot;CPUs&quot;, &quot;VM&quot;, NULL };</span>
<span class="line-removed">2193   const char* info_file = &quot;/proc/sysinfo&quot;;</span>
2194 
<a name="58" id="anc58"></a><span class="line-modified">2195   if (!print_matching_lines_from_file(info_file, st, kw)) {</span>
<span class="line-modified">2196     st-&gt;print_cr(&quot;  &lt;%s Not Available&gt;&quot;, info_file);</span>
<span class="line-modified">2197   }</span>
<span class="line-modified">2198 #elif defined(PPC64)</span>
<span class="line-modified">2199   const char* info_file = &quot;/proc/ppc64/lparcfg&quot;;</span>
<span class="line-modified">2200   const char* kw[] = { &quot;system_type=&quot;, // qemu indicates PowerKVM</span>
<span class="line-modified">2201                        &quot;partition_entitled_capacity=&quot;, // entitled processor capacity percentage</span>
<span class="line-modified">2202                        &quot;partition_max_entitled_capacity=&quot;,</span>
<span class="line-modified">2203                        &quot;capacity_weight=&quot;, // partition CPU weight</span>
<span class="line-modified">2204                        &quot;partition_active_processors=&quot;,</span>
<span class="line-removed">2205                        &quot;partition_potential_processors=&quot;,</span>
<span class="line-removed">2206                        &quot;entitled_proc_capacity_available=&quot;,</span>
<span class="line-removed">2207                        &quot;capped=&quot;, // 0 - uncapped, 1 - vcpus capped at entitled processor capacity percentage</span>
<span class="line-removed">2208                        &quot;shared_processor_mode=&quot;, // (non)dedicated partition</span>
<span class="line-removed">2209                        &quot;system_potential_processors=&quot;,</span>
<span class="line-removed">2210                        &quot;pool=&quot;, // CPU-pool number</span>
<span class="line-removed">2211                        &quot;pool_capacity=&quot;,</span>
<span class="line-removed">2212                        &quot;NumLpars=&quot;, // on non-KVM machines, NumLpars is not found for full partition mode machines</span>
<span class="line-removed">2213                        NULL };</span>
<span class="line-removed">2214   if (!print_matching_lines_from_file(info_file, st, kw)) {</span>
<span class="line-removed">2215     st-&gt;print_cr(&quot;  &lt;%s Not Available&gt;&quot;, info_file);</span>
2216   }
<a name="59" id="anc59"></a><span class="line-removed">2217 #endif</span>
2218 }
2219 
2220 void os::print_memory_info(outputStream* st) {
2221 
2222   st-&gt;print(&quot;Memory:&quot;);
2223   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
2224 
2225   // values in struct sysinfo are &quot;unsigned long&quot;
2226   struct sysinfo si;
2227   sysinfo(&amp;si);
2228 
2229   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;,
2230             os::physical_memory() &gt;&gt; 10);
2231   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
2232             os::available_memory() &gt;&gt; 10);
2233   st-&gt;print(&quot;, swap &quot; UINT64_FORMAT &quot;k&quot;,
2234             ((jlong)si.totalswap * si.mem_unit) &gt;&gt; 10);
2235   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;,
2236             ((jlong)si.freeswap * si.mem_unit) &gt;&gt; 10);
2237   st-&gt;cr();
2238 }
2239 
2240 // Print the first &quot;model name&quot; line and the first &quot;flags&quot; line
2241 // that we find and nothing more. We assume &quot;model name&quot; comes
2242 // before &quot;flags&quot; so if we find a second &quot;model name&quot;, then the
2243 // &quot;flags&quot; field is considered missing.
2244 static bool print_model_name_and_flags(outputStream* st, char* buf, size_t buflen) {
2245 #if defined(IA32) || defined(AMD64)
2246   // Other platforms have less repetitive cpuinfo files
2247   FILE *fp = fopen(&quot;/proc/cpuinfo&quot;, &quot;r&quot;);
2248   if (fp) {
2249     while (!feof(fp)) {
2250       if (fgets(buf, buflen, fp)) {
2251         // Assume model name comes before flags
2252         bool model_name_printed = false;
2253         if (strstr(buf, &quot;model name&quot;) != NULL) {
2254           if (!model_name_printed) {
2255             st-&gt;print_raw(&quot;CPU Model and flags from /proc/cpuinfo:\n&quot;);
2256             st-&gt;print_raw(buf);
2257             model_name_printed = true;
2258           } else {
2259             // model name printed but not flags?  Odd, just return
2260             fclose(fp);
2261             return true;
2262           }
2263         }
2264         // print the flags line too
2265         if (strstr(buf, &quot;flags&quot;) != NULL) {
2266           st-&gt;print_raw(buf);
2267           fclose(fp);
2268           return true;
2269         }
2270       }
2271     }
2272     fclose(fp);
2273   }
2274 #endif // x86 platforms
2275   return false;
2276 }
2277 
2278 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
2279   // Only print the model name if the platform provides this as a summary
2280   if (!print_model_name_and_flags(st, buf, buflen)) {
2281     st-&gt;print(&quot;\n/proc/cpuinfo:\n&quot;);
2282     if (!_print_ascii_file(&quot;/proc/cpuinfo&quot;, st)) {
2283       st-&gt;print_cr(&quot;  &lt;Not Available&gt;&quot;);
2284     }
2285   }
2286 }
2287 
2288 #if defined(AMD64) || defined(IA32) || defined(X32)
2289 const char* search_string = &quot;model name&quot;;
2290 #elif defined(M68K)
2291 const char* search_string = &quot;CPU&quot;;
2292 #elif defined(PPC64)
2293 const char* search_string = &quot;cpu&quot;;
2294 #elif defined(S390)
<a name="60" id="anc60"></a><span class="line-modified">2295 const char* search_string = &quot;processor&quot;;</span>
2296 #elif defined(SPARC)
2297 const char* search_string = &quot;cpu&quot;;
2298 #else
2299 const char* search_string = &quot;Processor&quot;;
2300 #endif
2301 
2302 // Parses the cpuinfo file for string representing the model name.
2303 void os::get_summary_cpu_info(char* cpuinfo, size_t length) {
2304   FILE* fp = fopen(&quot;/proc/cpuinfo&quot;, &quot;r&quot;);
2305   if (fp != NULL) {
2306     while (!feof(fp)) {
2307       char buf[256];
2308       if (fgets(buf, sizeof(buf), fp)) {
2309         char* start = strstr(buf, search_string);
2310         if (start != NULL) {
2311           char *ptr = start + strlen(search_string);
2312           char *end = buf + strlen(buf);
2313           while (ptr != end) {
2314              // skip whitespace and colon for the rest of the name.
2315              if (*ptr != &#39; &#39; &amp;&amp; *ptr != &#39;\t&#39; &amp;&amp; *ptr != &#39;:&#39;) {
2316                break;
2317              }
2318              ptr++;
2319           }
2320           if (ptr != end) {
2321             // reasonable string, get rid of newline and keep the rest
2322             char* nl = strchr(buf, &#39;\n&#39;);
2323             if (nl != NULL) *nl = &#39;\0&#39;;
2324             strncpy(cpuinfo, ptr, length);
2325             fclose(fp);
2326             return;
2327           }
2328         }
2329       }
2330     }
2331     fclose(fp);
2332   }
2333   // cpuinfo not found or parsing failed, just print generic string.  The entire
2334   // /proc/cpuinfo file will be printed later in the file (or enough of it for x86)
2335 #if   defined(AARCH64)
2336   strncpy(cpuinfo, &quot;AArch64&quot;, length);
2337 #elif defined(AMD64)
2338   strncpy(cpuinfo, &quot;x86_64&quot;, length);
2339 #elif defined(ARM)  // Order wrt. AARCH64 is relevant!
2340   strncpy(cpuinfo, &quot;ARM&quot;, length);
2341 #elif defined(IA32)
2342   strncpy(cpuinfo, &quot;x86_32&quot;, length);
2343 #elif defined(IA64)
2344   strncpy(cpuinfo, &quot;IA64&quot;, length);
2345 #elif defined(PPC)
2346   strncpy(cpuinfo, &quot;PPC64&quot;, length);
2347 #elif defined(S390)
2348   strncpy(cpuinfo, &quot;S390&quot;, length);
2349 #elif defined(SPARC)
2350   strncpy(cpuinfo, &quot;sparcv9&quot;, length);
2351 #elif defined(ZERO_LIBARCH)
2352   strncpy(cpuinfo, ZERO_LIBARCH, length);
2353 #else
2354   strncpy(cpuinfo, &quot;unknown&quot;, length);
2355 #endif
2356 }
2357 
2358 static void print_signal_handler(outputStream* st, int sig,
2359                                  char* buf, size_t buflen);
2360 
2361 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
2362   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
2363   print_signal_handler(st, SIGSEGV, buf, buflen);
2364   print_signal_handler(st, SIGBUS , buf, buflen);
2365   print_signal_handler(st, SIGFPE , buf, buflen);
2366   print_signal_handler(st, SIGPIPE, buf, buflen);
2367   print_signal_handler(st, SIGXFSZ, buf, buflen);
2368   print_signal_handler(st, SIGILL , buf, buflen);
2369   print_signal_handler(st, SR_signum, buf, buflen);
2370   print_signal_handler(st, SHUTDOWN1_SIGNAL, buf, buflen);
2371   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
2372   print_signal_handler(st, SHUTDOWN3_SIGNAL , buf, buflen);
2373   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
2374 #if defined(PPC64)
2375   print_signal_handler(st, SIGTRAP, buf, buflen);
2376 #endif
2377 }
2378 
2379 static char saved_jvm_path[MAXPATHLEN] = {0};
2380 
2381 // Find the full path to the current module, libjvm.so
2382 void os::jvm_path(char *buf, jint buflen) {
2383   // Error checking.
2384   if (buflen &lt; MAXPATHLEN) {
2385     assert(false, &quot;must use a large-enough buffer&quot;);
2386     buf[0] = &#39;\0&#39;;
2387     return;
2388   }
2389   // Lazy resolve the path to current module.
2390   if (saved_jvm_path[0] != 0) {
2391     strcpy(buf, saved_jvm_path);
2392     return;
2393   }
2394 
2395   char dli_fname[MAXPATHLEN];
2396   bool ret = dll_address_to_library_name(
2397                                          CAST_FROM_FN_PTR(address, os::jvm_path),
2398                                          dli_fname, sizeof(dli_fname), NULL);
2399   assert(ret, &quot;cannot locate libjvm&quot;);
2400   char *rp = NULL;
2401   if (ret &amp;&amp; dli_fname[0] != &#39;\0&#39;) {
2402     rp = os::Posix::realpath(dli_fname, buf, buflen);
2403   }
2404   if (rp == NULL) {
2405     return;
2406   }
2407 
2408   if (Arguments::sun_java_launcher_is_altjvm()) {
2409     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
2410     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;vmtype&gt;/libjvm.so&quot;.
2411     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
2412     // assume we are installed in a JDK and we&#39;re done. Otherwise, check
2413     // for a JAVA_HOME environment variable and fix up the path so it
2414     // looks like libjvm.so is installed there (append a fake suffix
2415     // hotspot/libjvm.so).
2416     const char *p = buf + strlen(buf) - 1;
2417     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
2418       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
2419         /* empty */ ;
2420     }
2421 
2422     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
2423       // Look for JAVA_HOME in the environment.
2424       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
2425       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
2426         char* jrelib_p;
2427         int len;
2428 
2429         // Check the current module name &quot;libjvm.so&quot;.
2430         p = strrchr(buf, &#39;/&#39;);
2431         if (p == NULL) {
2432           return;
2433         }
2434         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
2435 
2436         rp = os::Posix::realpath(java_home_var, buf, buflen);
2437         if (rp == NULL) {
2438           return;
2439         }
2440 
2441         // determine if this is a legacy image or modules image
2442         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
2443         len = strlen(buf);
2444         assert(len &lt; buflen, &quot;Ran out of buffer room&quot;);
2445         jrelib_p = buf + len;
2446         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
2447         if (0 != access(buf, F_OK)) {
2448           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
2449         }
2450 
2451         if (0 == access(buf, F_OK)) {
2452           // Use current module name &quot;libjvm.so&quot;
2453           len = strlen(buf);
2454           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
2455         } else {
2456           // Go back to path of .so
2457           rp = os::Posix::realpath(dli_fname, buf, buflen);
2458           if (rp == NULL) {
2459             return;
2460           }
2461         }
2462       }
2463     }
2464   }
2465 
2466   strncpy(saved_jvm_path, buf, MAXPATHLEN);
2467   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
2468 }
2469 
2470 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
2471   // no prefix required, not even &quot;_&quot;
2472 }
2473 
2474 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
2475   // no suffix required
2476 }
2477 
2478 ////////////////////////////////////////////////////////////////////////////////
2479 // sun.misc.Signal support
2480 
<a name="61" id="anc61"></a><span class="line-removed">2481 static volatile jint sigint_count = 0;</span>
<span class="line-removed">2482 </span>
2483 static void UserHandler(int sig, void *siginfo, void *context) {
<a name="62" id="anc62"></a><span class="line-removed">2484   // 4511530 - sem_post is serialized and handled by the manager thread. When</span>
<span class="line-removed">2485   // the program is interrupted by Ctrl-C, SIGINT is sent to every thread. We</span>
<span class="line-removed">2486   // don&#39;t want to flood the manager thread with sem_post requests.</span>
<span class="line-removed">2487   if (sig == SIGINT &amp;&amp; Atomic::add(1, &amp;sigint_count) &gt; 1) {</span>
<span class="line-removed">2488     return;</span>
<span class="line-removed">2489   }</span>
<span class="line-removed">2490 </span>
2491   // Ctrl-C is pressed during error reporting, likely because the error
2492   // handler fails to abort. Let VM die immediately.
2493   if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
2494     os::die();
2495   }
2496 
2497   os::signal_notify(sig);
2498 }
2499 
2500 void* os::user_handler() {
2501   return CAST_FROM_FN_PTR(void*, UserHandler);
2502 }
2503 
2504 extern &quot;C&quot; {
2505   typedef void (*sa_handler_t)(int);
2506   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
2507 }
2508 
2509 void* os::signal(int signal_number, void* handler) {
2510   struct sigaction sigAct, oldSigAct;
2511 
2512   sigfillset(&amp;(sigAct.sa_mask));
2513   sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;
2514   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
2515 
2516   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
2517     // -1 means registration failed
2518     return (void *)-1;
2519   }
2520 
2521   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
2522 }
2523 
2524 void os::signal_raise(int signal_number) {
2525   ::raise(signal_number);
2526 }
2527 
2528 // The following code is moved from os.cpp for making this
2529 // code platform specific, which it is by its very nature.
2530 
2531 // Will be modified when max signal is changed to be dynamic
2532 int os::sigexitnum_pd() {
2533   return NSIG;
2534 }
2535 
2536 // a counter for each possible signal value
2537 static volatile jint pending_signals[NSIG+1] = { 0 };
2538 
2539 // Linux(POSIX) specific hand shaking semaphore.
2540 static Semaphore* sig_sem = NULL;
2541 static PosixSemaphore sr_semaphore;
2542 
2543 static void jdk_misc_signal_init() {
2544   // Initialize signal structures
2545   ::memset((void*)pending_signals, 0, sizeof(pending_signals));
2546 
2547   // Initialize signal semaphore
2548   sig_sem = new Semaphore();
2549 }
2550 
2551 void os::signal_notify(int sig) {
2552   if (sig_sem != NULL) {
2553     Atomic::inc(&amp;pending_signals[sig]);
2554     sig_sem-&gt;signal();
2555   } else {
2556     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
2557     // initialization isn&#39;t called.
2558     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
2559   }
2560 }
2561 
2562 static int check_pending_signals() {
<a name="63" id="anc63"></a><span class="line-removed">2563   Atomic::store(0, &amp;sigint_count);</span>
2564   for (;;) {
2565     for (int i = 0; i &lt; NSIG + 1; i++) {
2566       jint n = pending_signals[i];
<a name="64" id="anc64"></a><span class="line-modified">2567       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(n - 1, &amp;pending_signals[i], n)) {</span>
2568         return i;
2569       }
2570     }
2571     JavaThread *thread = JavaThread::current();
2572     ThreadBlockInVM tbivm(thread);
2573 
2574     bool threadIsSuspended;
2575     do {
2576       thread-&gt;set_suspend_equivalent();
2577       // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
2578       sig_sem-&gt;wait();
2579 
2580       // were we externally suspended while we were waiting?
2581       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
2582       if (threadIsSuspended) {
2583         // The semaphore has been incremented, but while we were waiting
2584         // another thread suspended us. We don&#39;t want to continue running
2585         // while suspended because that would surprise the thread that
2586         // suspended us.
2587         sig_sem-&gt;signal();
2588 
2589         thread-&gt;java_suspend_self();
2590       }
2591     } while (threadIsSuspended);
2592   }
2593 }
2594 
2595 int os::signal_wait() {
2596   return check_pending_signals();
2597 }
2598 
2599 ////////////////////////////////////////////////////////////////////////////////
2600 // Virtual Memory
2601 
2602 int os::vm_page_size() {
2603   // Seems redundant as all get out
2604   assert(os::Linux::page_size() != -1, &quot;must call os::init&quot;);
2605   return os::Linux::page_size();
2606 }
2607 
2608 // Solaris allocates memory by pages.
2609 int os::vm_allocation_granularity() {
2610   assert(os::Linux::page_size() != -1, &quot;must call os::init&quot;);
2611   return os::Linux::page_size();
2612 }
2613 
2614 // Rationale behind this function:
2615 //  current (Mon Apr 25 20:12:18 MSD 2005) oprofile drops samples without executable
2616 //  mapping for address (see lookup_dcookie() in the kernel module), thus we cannot get
2617 //  samples for JITted code. Here we create private executable mapping over the code cache
2618 //  and then we can use standard (well, almost, as mapping can change) way to provide
2619 //  info for the reporting script by storing timestamp and location of symbol
2620 void linux_wrap_code(char* base, size_t size) {
2621   static volatile jint cnt = 0;
2622 
2623   if (!UseOprofile) {
2624     return;
2625   }
2626 
2627   char buf[PATH_MAX+1];
<a name="65" id="anc65"></a><span class="line-modified">2628   int num = Atomic::add(1, &amp;cnt);</span>
2629 
2630   snprintf(buf, sizeof(buf), &quot;%s/hs-vm-%d-%d&quot;,
2631            os::get_temp_directory(), os::current_process_id(), num);
2632   unlink(buf);
2633 
2634   int fd = ::open(buf, O_CREAT | O_RDWR, S_IRWXU);
2635 
2636   if (fd != -1) {
2637     off_t rv = ::lseek(fd, size-2, SEEK_SET);
2638     if (rv != (off_t)-1) {
2639       if (::write(fd, &quot;&quot;, 1) == 1) {
2640         mmap(base, size,
2641              PROT_READ|PROT_WRITE|PROT_EXEC,
2642              MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE, fd, 0);
2643       }
2644     }
2645     ::close(fd);
2646     unlink(buf);
2647   }
2648 }
2649 
2650 static bool recoverable_mmap_error(int err) {
2651   // See if the error is one we can let the caller handle. This
2652   // list of errno values comes from JBS-6843484. I can&#39;t find a
2653   // Linux man page that documents this specific set of errno
2654   // values so while this list currently matches Solaris, it may
2655   // change as we gain experience with this failure mode.
2656   switch (err) {
2657   case EBADF:
2658   case EINVAL:
2659   case ENOTSUP:
2660     // let the caller deal with these errors
2661     return true;
2662 
2663   default:
2664     // Any remaining errors on this OS can cause our reserved mapping
2665     // to be lost. That can cause confusion where different data
2666     // structures think they have the same memory mapped. The worst
2667     // scenario is if both the VM and a library think they have the
2668     // same memory mapped.
2669     return false;
2670   }
2671 }
2672 
2673 static void warn_fail_commit_memory(char* addr, size_t size, bool exec,
2674                                     int err) {
2675   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2676           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, p2i(addr), size, exec,
2677           os::strerror(err), err);
2678 }
2679 
2680 static void warn_fail_commit_memory(char* addr, size_t size,
2681                                     size_t alignment_hint, bool exec,
2682                                     int err) {
2683   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2684           &quot;, &quot; SIZE_FORMAT &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, p2i(addr), size,
2685           alignment_hint, exec, os::strerror(err), err);
2686 }
2687 
2688 // NOTE: Linux kernel does not really reserve the pages for us.
2689 //       All it does is to check if there are enough free pages
2690 //       left at the time of mmap(). This could be a potential
2691 //       problem.
2692 int os::Linux::commit_memory_impl(char* addr, size_t size, bool exec) {
2693   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
2694   uintptr_t res = (uintptr_t) ::mmap(addr, size, prot,
2695                                      MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0);
2696   if (res != (uintptr_t) MAP_FAILED) {
2697     if (UseNUMAInterleaving) {
2698       numa_make_global(addr, size);
2699     }
2700     return 0;
2701   }
2702 
2703   int err = errno;  // save errno from mmap() call above
2704 
2705   if (!recoverable_mmap_error(err)) {
2706     warn_fail_commit_memory(addr, size, exec, err);
2707     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;committing reserved memory.&quot;);
2708   }
2709 
2710   return err;
2711 }
2712 
2713 bool os::pd_commit_memory(char* addr, size_t size, bool exec) {
2714   return os::Linux::commit_memory_impl(addr, size, exec) == 0;
2715 }
2716 
2717 void os::pd_commit_memory_or_exit(char* addr, size_t size, bool exec,
2718                                   const char* mesg) {
2719   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2720   int err = os::Linux::commit_memory_impl(addr, size, exec);
2721   if (err != 0) {
2722     // the caller wants all commit errors to exit with the specified mesg:
2723     warn_fail_commit_memory(addr, size, exec, err);
2724     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2725   }
2726 }
2727 
2728 // Define MAP_HUGETLB here so we can build HotSpot on old systems.
2729 #ifndef MAP_HUGETLB
2730   #define MAP_HUGETLB 0x40000
2731 #endif
2732 
2733 // Define MADV_HUGEPAGE here so we can build HotSpot on old systems.
2734 #ifndef MADV_HUGEPAGE
2735   #define MADV_HUGEPAGE 14
2736 #endif
2737 
2738 int os::Linux::commit_memory_impl(char* addr, size_t size,
2739                                   size_t alignment_hint, bool exec) {
2740   int err = os::Linux::commit_memory_impl(addr, size, exec);
2741   if (err == 0) {
2742     realign_memory(addr, size, alignment_hint);
2743   }
2744   return err;
2745 }
2746 
2747 bool os::pd_commit_memory(char* addr, size_t size, size_t alignment_hint,
2748                           bool exec) {
2749   return os::Linux::commit_memory_impl(addr, size, alignment_hint, exec) == 0;
2750 }
2751 
2752 void os::pd_commit_memory_or_exit(char* addr, size_t size,
2753                                   size_t alignment_hint, bool exec,
2754                                   const char* mesg) {
2755   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2756   int err = os::Linux::commit_memory_impl(addr, size, alignment_hint, exec);
2757   if (err != 0) {
2758     // the caller wants all commit errors to exit with the specified mesg:
2759     warn_fail_commit_memory(addr, size, alignment_hint, exec, err);
2760     vm_exit_out_of_memory(size, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2761   }
2762 }
2763 
2764 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
2765   if (UseTransparentHugePages &amp;&amp; alignment_hint &gt; (size_t)vm_page_size()) {
2766     // We don&#39;t check the return value: madvise(MADV_HUGEPAGE) may not
2767     // be supported or the memory may already be backed by huge pages.
2768     ::madvise(addr, bytes, MADV_HUGEPAGE);
2769   }
2770 }
2771 
2772 void os::pd_free_memory(char *addr, size_t bytes, size_t alignment_hint) {
2773   // This method works by doing an mmap over an existing mmaping and effectively discarding
2774   // the existing pages. However it won&#39;t work for SHM-based large pages that cannot be
2775   // uncommitted at all. We don&#39;t do anything in this case to avoid creating a segment with
2776   // small pages on top of the SHM segment. This method always works for small pages, so we
2777   // allow that in any case.
2778   if (alignment_hint &lt;= (size_t)os::vm_page_size() || can_commit_large_page_memory()) {
2779     commit_memory(addr, bytes, alignment_hint, !ExecMem);
2780   }
2781 }
2782 
2783 void os::numa_make_global(char *addr, size_t bytes) {
2784   Linux::numa_interleave_memory(addr, bytes);
2785 }
2786 
2787 // Define for numa_set_bind_policy(int). Setting the argument to 0 will set the
2788 // bind policy to MPOL_PREFERRED for the current thread.
2789 #define USE_MPOL_PREFERRED 0
2790 
2791 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
2792   // To make NUMA and large pages more robust when both enabled, we need to ease
2793   // the requirements on where the memory should be allocated. MPOL_BIND is the
2794   // default policy and it will force memory to be allocated on the specified
2795   // node. Changing this to MPOL_PREFERRED will prefer to allocate the memory on
2796   // the specified node, but will not force it. Using this policy will prevent
2797   // getting SIGBUS when trying to allocate large pages on NUMA nodes with no
2798   // free large pages.
2799   Linux::numa_set_bind_policy(USE_MPOL_PREFERRED);
2800   Linux::numa_tonode_memory(addr, bytes, lgrp_hint);
2801 }
2802 
2803 bool os::numa_topology_changed() { return false; }
2804 
2805 size_t os::numa_get_groups_num() {
2806   // Return just the number of nodes in which it&#39;s possible to allocate memory
2807   // (in numa terminology, configured nodes).
2808   return Linux::numa_num_configured_nodes();
2809 }
2810 
2811 int os::numa_get_group_id() {
2812   int cpu_id = Linux::sched_getcpu();
2813   if (cpu_id != -1) {
2814     int lgrp_id = Linux::get_node_by_cpu(cpu_id);
2815     if (lgrp_id != -1) {
2816       return lgrp_id;
2817     }
2818   }
2819   return 0;
2820 }
2821 
<a name="66" id="anc66"></a>












2822 int os::Linux::get_existing_num_nodes() {
2823   int node;
2824   int highest_node_number = Linux::numa_max_node();
2825   int num_nodes = 0;
2826 
2827   // Get the total number of nodes in the system including nodes without memory.
2828   for (node = 0; node &lt;= highest_node_number; node++) {
2829     if (is_node_in_existing_nodes(node)) {
2830       num_nodes++;
2831     }
2832   }
2833   return num_nodes;
2834 }
2835 
2836 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
2837   int highest_node_number = Linux::numa_max_node();
2838   size_t i = 0;
2839 
2840   // Map all node ids in which it is possible to allocate memory. Also nodes are
2841   // not always consecutively available, i.e. available from 0 to the highest
2842   // node number. If the nodes have been bound explicitly using numactl membind,
2843   // then allocate memory from those nodes only.
2844   for (int node = 0; node &lt;= highest_node_number; node++) {
2845     if (Linux::is_node_in_bound_nodes((unsigned int)node)) {
2846       ids[i++] = node;
2847     }
2848   }
2849   return i;
2850 }
2851 
2852 bool os::get_page_info(char *start, page_info* info) {
2853   return false;
2854 }
2855 
2856 char *os::scan_pages(char *start, char* end, page_info* page_expected,
2857                      page_info* page_found) {
2858   return end;
2859 }
2860 
2861 
2862 int os::Linux::sched_getcpu_syscall(void) {
2863   unsigned int cpu = 0;
2864   int retval = -1;
2865 
2866 #if defined(IA32)
2867   #ifndef SYS_getcpu
2868     #define SYS_getcpu 318
2869   #endif
2870   retval = syscall(SYS_getcpu, &amp;cpu, NULL, NULL);
2871 #elif defined(AMD64)
2872 // Unfortunately we have to bring all these macros here from vsyscall.h
2873 // to be able to compile on old linuxes.
2874   #define __NR_vgetcpu 2
2875   #define VSYSCALL_START (-10UL &lt;&lt; 20)
2876   #define VSYSCALL_SIZE 1024
2877   #define VSYSCALL_ADDR(vsyscall_nr) (VSYSCALL_START+VSYSCALL_SIZE*(vsyscall_nr))
2878   typedef long (*vgetcpu_t)(unsigned int *cpu, unsigned int *node, unsigned long *tcache);
2879   vgetcpu_t vgetcpu = (vgetcpu_t)VSYSCALL_ADDR(__NR_vgetcpu);
2880   retval = vgetcpu(&amp;cpu, NULL, NULL);
2881 #endif
2882 
2883   return (retval == -1) ? retval : cpu;
2884 }
2885 
2886 void os::Linux::sched_getcpu_init() {
2887   // sched_getcpu() should be in libc.
2888   set_sched_getcpu(CAST_TO_FN_PTR(sched_getcpu_func_t,
2889                                   dlsym(RTLD_DEFAULT, &quot;sched_getcpu&quot;)));
2890 
2891   // If it&#39;s not, try a direct syscall.
2892   if (sched_getcpu() == -1) {
2893     set_sched_getcpu(CAST_TO_FN_PTR(sched_getcpu_func_t,
2894                                     (void*)&amp;sched_getcpu_syscall));
2895   }
2896 
2897   if (sched_getcpu() == -1) {
2898     vm_exit_during_initialization(&quot;getcpu(2) system call not supported by kernel&quot;);
2899   }
2900 }
2901 
2902 // Something to do with the numa-aware allocator needs these symbols
2903 extern &quot;C&quot; JNIEXPORT void numa_warn(int number, char *where, ...) { }
2904 extern &quot;C&quot; JNIEXPORT void numa_error(char *where) { }
2905 
2906 // Handle request to load libnuma symbol version 1.1 (API v1). If it fails
2907 // load symbol from base version instead.
2908 void* os::Linux::libnuma_dlsym(void* handle, const char *name) {
2909   void *f = dlvsym(handle, name, &quot;libnuma_1.1&quot;);
2910   if (f == NULL) {
2911     f = dlsym(handle, name);
2912   }
2913   return f;
2914 }
2915 
2916 // Handle request to load libnuma symbol version 1.2 (API v2) only.
2917 // Return NULL if the symbol is not defined in this particular version.
2918 void* os::Linux::libnuma_v2_dlsym(void* handle, const char* name) {
2919   return dlvsym(handle, name, &quot;libnuma_1.2&quot;);
2920 }
2921 
2922 bool os::Linux::libnuma_init() {
2923   if (sched_getcpu() != -1) { // Requires sched_getcpu() support
2924     void *handle = dlopen(&quot;libnuma.so.1&quot;, RTLD_LAZY);
2925     if (handle != NULL) {
2926       set_numa_node_to_cpus(CAST_TO_FN_PTR(numa_node_to_cpus_func_t,
2927                                            libnuma_dlsym(handle, &quot;numa_node_to_cpus&quot;)));
2928       set_numa_max_node(CAST_TO_FN_PTR(numa_max_node_func_t,
2929                                        libnuma_dlsym(handle, &quot;numa_max_node&quot;)));
2930       set_numa_num_configured_nodes(CAST_TO_FN_PTR(numa_num_configured_nodes_func_t,
2931                                                    libnuma_dlsym(handle, &quot;numa_num_configured_nodes&quot;)));
2932       set_numa_available(CAST_TO_FN_PTR(numa_available_func_t,
2933                                         libnuma_dlsym(handle, &quot;numa_available&quot;)));
2934       set_numa_tonode_memory(CAST_TO_FN_PTR(numa_tonode_memory_func_t,
2935                                             libnuma_dlsym(handle, &quot;numa_tonode_memory&quot;)));
2936       set_numa_interleave_memory(CAST_TO_FN_PTR(numa_interleave_memory_func_t,
2937                                                 libnuma_dlsym(handle, &quot;numa_interleave_memory&quot;)));
2938       set_numa_interleave_memory_v2(CAST_TO_FN_PTR(numa_interleave_memory_v2_func_t,
2939                                                 libnuma_v2_dlsym(handle, &quot;numa_interleave_memory&quot;)));
2940       set_numa_set_bind_policy(CAST_TO_FN_PTR(numa_set_bind_policy_func_t,
2941                                               libnuma_dlsym(handle, &quot;numa_set_bind_policy&quot;)));
2942       set_numa_bitmask_isbitset(CAST_TO_FN_PTR(numa_bitmask_isbitset_func_t,
2943                                                libnuma_dlsym(handle, &quot;numa_bitmask_isbitset&quot;)));
2944       set_numa_distance(CAST_TO_FN_PTR(numa_distance_func_t,
2945                                        libnuma_dlsym(handle, &quot;numa_distance&quot;)));
2946       set_numa_get_membind(CAST_TO_FN_PTR(numa_get_membind_func_t,
2947                                           libnuma_v2_dlsym(handle, &quot;numa_get_membind&quot;)));
2948       set_numa_get_interleave_mask(CAST_TO_FN_PTR(numa_get_interleave_mask_func_t,
2949                                                   libnuma_v2_dlsym(handle, &quot;numa_get_interleave_mask&quot;)));
<a name="67" id="anc67"></a>



2950 
2951       if (numa_available() != -1) {
2952         set_numa_all_nodes((unsigned long*)libnuma_dlsym(handle, &quot;numa_all_nodes&quot;));
2953         set_numa_all_nodes_ptr((struct bitmask **)libnuma_dlsym(handle, &quot;numa_all_nodes_ptr&quot;));
2954         set_numa_nodes_ptr((struct bitmask **)libnuma_dlsym(handle, &quot;numa_nodes_ptr&quot;));
2955         set_numa_interleave_bitmask(_numa_get_interleave_mask());
2956         set_numa_membind_bitmask(_numa_get_membind());
2957         // Create an index -&gt; node mapping, since nodes are not always consecutive
2958         _nindex_to_node = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;int&gt;(0, true);
2959         rebuild_nindex_to_node_map();
2960         // Create a cpu -&gt; node mapping
2961         _cpu_to_node = new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;int&gt;(0, true);
2962         rebuild_cpu_to_node_map();
2963         return true;
2964       }
2965     }
2966   }
2967   return false;
2968 }
2969 
2970 size_t os::Linux::default_guard_size(os::ThreadType thr_type) {
2971   // Creating guard page is very expensive. Java thread has HotSpot
2972   // guard pages, only enable glibc guard page for non-Java threads.
2973   // (Remember: compiler thread is a Java thread, too!)
2974   return ((thr_type == java_thread || thr_type == compiler_thread) ? 0 : page_size());
2975 }
2976 
2977 void os::Linux::rebuild_nindex_to_node_map() {
2978   int highest_node_number = Linux::numa_max_node();
2979 
2980   nindex_to_node()-&gt;clear();
2981   for (int node = 0; node &lt;= highest_node_number; node++) {
2982     if (Linux::is_node_in_existing_nodes(node)) {
2983       nindex_to_node()-&gt;append(node);
2984     }
2985   }
2986 }
2987 
2988 // rebuild_cpu_to_node_map() constructs a table mapping cpud id to node id.
2989 // The table is later used in get_node_by_cpu().
2990 void os::Linux::rebuild_cpu_to_node_map() {
2991   const size_t NCPUS = 32768; // Since the buffer size computation is very obscure
2992                               // in libnuma (possible values are starting from 16,
2993                               // and continuing up with every other power of 2, but less
2994                               // than the maximum number of CPUs supported by kernel), and
2995                               // is a subject to change (in libnuma version 2 the requirements
2996                               // are more reasonable) we&#39;ll just hardcode the number they use
2997                               // in the library.
2998   const size_t BitsPerCLong = sizeof(long) * CHAR_BIT;
2999 
3000   size_t cpu_num = processor_count();
3001   size_t cpu_map_size = NCPUS / BitsPerCLong;
3002   size_t cpu_map_valid_size =
3003     MIN2((cpu_num + BitsPerCLong - 1) / BitsPerCLong, cpu_map_size);
3004 
3005   cpu_to_node()-&gt;clear();
3006   cpu_to_node()-&gt;at_grow(cpu_num - 1);
3007 
3008   size_t node_num = get_existing_num_nodes();
3009 
3010   int distance = 0;
3011   int closest_distance = INT_MAX;
3012   int closest_node = 0;
3013   unsigned long *cpu_map = NEW_C_HEAP_ARRAY(unsigned long, cpu_map_size, mtInternal);
3014   for (size_t i = 0; i &lt; node_num; i++) {
3015     // Check if node is configured (not a memory-less node). If it is not, find
3016     // the closest configured node. Check also if node is bound, i.e. it&#39;s allowed
3017     // to allocate memory from the node. If it&#39;s not allowed, map cpus in that node
3018     // to the closest node from which memory allocation is allowed.
3019     if (!is_node_in_configured_nodes(nindex_to_node()-&gt;at(i)) ||
3020         !is_node_in_bound_nodes(nindex_to_node()-&gt;at(i))) {
3021       closest_distance = INT_MAX;
3022       // Check distance from all remaining nodes in the system. Ignore distance
3023       // from itself, from another non-configured node, and from another non-bound
3024       // node.
3025       for (size_t m = 0; m &lt; node_num; m++) {
3026         if (m != i &amp;&amp;
3027             is_node_in_configured_nodes(nindex_to_node()-&gt;at(m)) &amp;&amp;
3028             is_node_in_bound_nodes(nindex_to_node()-&gt;at(m))) {
3029           distance = numa_distance(nindex_to_node()-&gt;at(i), nindex_to_node()-&gt;at(m));
3030           // If a closest node is found, update. There is always at least one
3031           // configured and bound node in the system so there is always at least
3032           // one node close.
3033           if (distance != 0 &amp;&amp; distance &lt; closest_distance) {
3034             closest_distance = distance;
3035             closest_node = nindex_to_node()-&gt;at(m);
3036           }
3037         }
3038       }
3039      } else {
3040        // Current node is already a configured node.
3041        closest_node = nindex_to_node()-&gt;at(i);
3042      }
3043 
3044     // Get cpus from the original node and map them to the closest node. If node
3045     // is a configured node (not a memory-less node), then original node and
3046     // closest node are the same.
3047     if (numa_node_to_cpus(nindex_to_node()-&gt;at(i), cpu_map, cpu_map_size * sizeof(unsigned long)) != -1) {
3048       for (size_t j = 0; j &lt; cpu_map_valid_size; j++) {
3049         if (cpu_map[j] != 0) {
3050           for (size_t k = 0; k &lt; BitsPerCLong; k++) {
3051             if (cpu_map[j] &amp; (1UL &lt;&lt; k)) {
3052               cpu_to_node()-&gt;at_put(j * BitsPerCLong + k, closest_node);
3053             }
3054           }
3055         }
3056       }
3057     }
3058   }
3059   FREE_C_HEAP_ARRAY(unsigned long, cpu_map);
3060 }
3061 
3062 int os::Linux::get_node_by_cpu(int cpu_id) {
3063   if (cpu_to_node() != NULL &amp;&amp; cpu_id &gt;= 0 &amp;&amp; cpu_id &lt; cpu_to_node()-&gt;length()) {
3064     return cpu_to_node()-&gt;at(cpu_id);
3065   }
3066   return -1;
3067 }
3068 
3069 GrowableArray&lt;int&gt;* os::Linux::_cpu_to_node;
3070 GrowableArray&lt;int&gt;* os::Linux::_nindex_to_node;
3071 os::Linux::sched_getcpu_func_t os::Linux::_sched_getcpu;
3072 os::Linux::numa_node_to_cpus_func_t os::Linux::_numa_node_to_cpus;
3073 os::Linux::numa_max_node_func_t os::Linux::_numa_max_node;
3074 os::Linux::numa_num_configured_nodes_func_t os::Linux::_numa_num_configured_nodes;
3075 os::Linux::numa_available_func_t os::Linux::_numa_available;
3076 os::Linux::numa_tonode_memory_func_t os::Linux::_numa_tonode_memory;
3077 os::Linux::numa_interleave_memory_func_t os::Linux::_numa_interleave_memory;
3078 os::Linux::numa_interleave_memory_v2_func_t os::Linux::_numa_interleave_memory_v2;
3079 os::Linux::numa_set_bind_policy_func_t os::Linux::_numa_set_bind_policy;
3080 os::Linux::numa_bitmask_isbitset_func_t os::Linux::_numa_bitmask_isbitset;
3081 os::Linux::numa_distance_func_t os::Linux::_numa_distance;
3082 os::Linux::numa_get_membind_func_t os::Linux::_numa_get_membind;
3083 os::Linux::numa_get_interleave_mask_func_t os::Linux::_numa_get_interleave_mask;
<a name="68" id="anc68"></a>

3084 os::Linux::NumaAllocationPolicy os::Linux::_current_numa_policy;
3085 unsigned long* os::Linux::_numa_all_nodes;
3086 struct bitmask* os::Linux::_numa_all_nodes_ptr;
3087 struct bitmask* os::Linux::_numa_nodes_ptr;
3088 struct bitmask* os::Linux::_numa_interleave_bitmask;
3089 struct bitmask* os::Linux::_numa_membind_bitmask;
3090 
3091 bool os::pd_uncommit_memory(char* addr, size_t size) {
3092   uintptr_t res = (uintptr_t) ::mmap(addr, size, PROT_NONE,
3093                                      MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE|MAP_ANONYMOUS, -1, 0);
3094   return res  != (uintptr_t) MAP_FAILED;
3095 }
3096 
3097 static address get_stack_commited_bottom(address bottom, size_t size) {
3098   address nbot = bottom;
3099   address ntop = bottom + size;
3100 
3101   size_t page_sz = os::vm_page_size();
3102   unsigned pages = size / page_sz;
3103 
3104   unsigned char vec[1];
3105   unsigned imin = 1, imax = pages + 1, imid;
3106   int mincore_return_value = 0;
3107 
3108   assert(imin &lt;= imax, &quot;Unexpected page size&quot;);
3109 
3110   while (imin &lt; imax) {
3111     imid = (imax + imin) / 2;
3112     nbot = ntop - (imid * page_sz);
3113 
3114     // Use a trick with mincore to check whether the page is mapped or not.
3115     // mincore sets vec to 1 if page resides in memory and to 0 if page
3116     // is swapped output but if page we are asking for is unmapped
3117     // it returns -1,ENOMEM
3118     mincore_return_value = mincore(nbot, page_sz, vec);
3119 
3120     if (mincore_return_value == -1) {
3121       // Page is not mapped go up
3122       // to find first mapped page
3123       if (errno != EAGAIN) {
3124         assert(errno == ENOMEM, &quot;Unexpected mincore errno&quot;);
3125         imax = imid;
3126       }
3127     } else {
3128       // Page is mapped go down
3129       // to find first not mapped page
3130       imin = imid + 1;
3131     }
3132   }
3133 
3134   nbot = nbot + page_sz;
3135 
3136   // Adjust stack bottom one page up if last checked page is not mapped
3137   if (mincore_return_value == -1) {
3138     nbot = nbot + page_sz;
3139   }
3140 
3141   return nbot;
3142 }
3143 
3144 bool os::committed_in_range(address start, size_t size, address&amp; committed_start, size_t&amp; committed_size) {
3145   int mincore_return_value;
3146   const size_t stripe = 1024;  // query this many pages each time
3147   unsigned char vec[stripe + 1];
3148   // set a guard
3149   vec[stripe] = &#39;X&#39;;
3150 
3151   const size_t page_sz = os::vm_page_size();
3152   size_t pages = size / page_sz;
3153 
3154   assert(is_aligned(start, page_sz), &quot;Start address must be page aligned&quot;);
3155   assert(is_aligned(size, page_sz), &quot;Size must be page aligned&quot;);
3156 
3157   committed_start = NULL;
3158 
3159   int loops = (pages + stripe - 1) / stripe;
3160   int committed_pages = 0;
3161   address loop_base = start;
3162   bool found_range = false;
3163 
3164   for (int index = 0; index &lt; loops &amp;&amp; !found_range; index ++) {
3165     assert(pages &gt; 0, &quot;Nothing to do&quot;);
3166     int pages_to_query = (pages &gt;= stripe) ? stripe : pages;
3167     pages -= pages_to_query;
3168 
3169     // Get stable read
3170     while ((mincore_return_value = mincore(loop_base, pages_to_query * page_sz, vec)) == -1 &amp;&amp; errno == EAGAIN);
3171 
3172     // During shutdown, some memory goes away without properly notifying NMT,
3173     // E.g. ConcurrentGCThread/WatcherThread can exit without deleting thread object.
3174     // Bailout and return as not committed for now.
3175     if (mincore_return_value == -1 &amp;&amp; errno == ENOMEM) {
3176       return false;
3177     }
3178 
3179     assert(vec[stripe] == &#39;X&#39;, &quot;overflow guard&quot;);
3180     assert(mincore_return_value == 0, &quot;Range must be valid&quot;);
3181     // Process this stripe
3182     for (int vecIdx = 0; vecIdx &lt; pages_to_query; vecIdx ++) {
3183       if ((vec[vecIdx] &amp; 0x01) == 0) { // not committed
3184         // End of current contiguous region
3185         if (committed_start != NULL) {
3186           found_range = true;
3187           break;
3188         }
3189       } else { // committed
3190         // Start of region
3191         if (committed_start == NULL) {
3192           committed_start = loop_base + page_sz * vecIdx;
3193         }
3194         committed_pages ++;
3195       }
3196     }
3197 
3198     loop_base += pages_to_query * page_sz;
3199   }
3200 
3201   if (committed_start != NULL) {
3202     assert(committed_pages &gt; 0, &quot;Must have committed region&quot;);
3203     assert(committed_pages &lt;= int(size / page_sz), &quot;Can not commit more than it has&quot;);
3204     assert(committed_start &gt;= start &amp;&amp; committed_start &lt; start + size, &quot;Out of range&quot;);
3205     committed_size = page_sz * committed_pages;
3206     return true;
3207   } else {
3208     assert(committed_pages == 0, &quot;Should not have committed region&quot;);
3209     return false;
3210   }
3211 }
3212 
3213 
3214 // Linux uses a growable mapping for the stack, and if the mapping for
3215 // the stack guard pages is not removed when we detach a thread the
3216 // stack cannot grow beyond the pages where the stack guard was
3217 // mapped.  If at some point later in the process the stack expands to
3218 // that point, the Linux kernel cannot expand the stack any further
3219 // because the guard pages are in the way, and a segfault occurs.
3220 //
3221 // However, it&#39;s essential not to split the stack region by unmapping
3222 // a region (leaving a hole) that&#39;s already part of the stack mapping,
3223 // so if the stack mapping has already grown beyond the guard pages at
3224 // the time we create them, we have to truncate the stack mapping.
3225 // So, we need to know the extent of the stack mapping when
3226 // create_stack_guard_pages() is called.
3227 
3228 // We only need this for stacks that are growable: at the time of
3229 // writing thread stacks don&#39;t use growable mappings (i.e. those
3230 // creeated with MAP_GROWSDOWN), and aren&#39;t marked &quot;[stack]&quot;, so this
3231 // only applies to the main thread.
3232 
3233 // If the (growable) stack mapping already extends beyond the point
3234 // where we&#39;re going to put our guard pages, truncate the mapping at
3235 // that point by munmap()ping it.  This ensures that when we later
3236 // munmap() the guard pages we don&#39;t leave a hole in the stack
3237 // mapping. This only affects the main/primordial thread
3238 
3239 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
3240   if (os::is_primordial_thread()) {
3241     // As we manually grow stack up to bottom inside create_attached_thread(),
3242     // it&#39;s likely that os::Linux::initial_thread_stack_bottom is mapped and
3243     // we don&#39;t need to do anything special.
3244     // Check it first, before calling heavy function.
3245     uintptr_t stack_extent = (uintptr_t) os::Linux::initial_thread_stack_bottom();
3246     unsigned char vec[1];
3247 
3248     if (mincore((address)stack_extent, os::vm_page_size(), vec) == -1) {
3249       // Fallback to slow path on all errors, including EAGAIN
3250       stack_extent = (uintptr_t) get_stack_commited_bottom(
3251                                                            os::Linux::initial_thread_stack_bottom(),
3252                                                            (size_t)addr - stack_extent);
3253     }
3254 
3255     if (stack_extent &lt; (uintptr_t)addr) {
3256       ::munmap((void*)stack_extent, (uintptr_t)(addr - stack_extent));
3257     }
3258   }
3259 
3260   return os::commit_memory(addr, size, !ExecMem);
3261 }
3262 
3263 // If this is a growable mapping, remove the guard pages entirely by
3264 // munmap()ping them.  If not, just call uncommit_memory(). This only
3265 // affects the main/primordial thread, but guard against future OS changes.
3266 // It&#39;s safe to always unmap guard pages for primordial thread because we
3267 // always place it right after end of the mapped region.
3268 
3269 bool os::remove_stack_guard_pages(char* addr, size_t size) {
3270   uintptr_t stack_extent, stack_base;
3271 
3272   if (os::is_primordial_thread()) {
3273     return ::munmap(addr, size) == 0;
3274   }
3275 
3276   return os::uncommit_memory(addr, size);
3277 }
3278 
3279 // If &#39;fixed&#39; is true, anon_mmap() will attempt to reserve anonymous memory
3280 // at &#39;requested_addr&#39;. If there are existing memory mappings at the same
3281 // location, however, they will be overwritten. If &#39;fixed&#39; is false,
3282 // &#39;requested_addr&#39; is only treated as a hint, the return value may or
3283 // may not start from the requested address. Unlike Linux mmap(), this
3284 // function returns NULL to indicate failure.
3285 static char* anon_mmap(char* requested_addr, size_t bytes, bool fixed) {
3286   char * addr;
3287   int flags;
3288 
3289   flags = MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS;
3290   if (fixed) {
3291     assert((uintptr_t)requested_addr % os::Linux::page_size() == 0, &quot;unaligned address&quot;);
3292     flags |= MAP_FIXED;
3293   }
3294 
3295   // Map reserved/uncommitted pages PROT_NONE so we fail early if we
3296   // touch an uncommitted page. Otherwise, the read/write might
3297   // succeed if we have enough swap space to back the physical page.
3298   addr = (char*)::mmap(requested_addr, bytes, PROT_NONE,
3299                        flags, -1, 0);
3300 
3301   return addr == MAP_FAILED ? NULL : addr;
3302 }
3303 
3304 // Allocate (using mmap, NO_RESERVE, with small pages) at either a given request address
3305 //   (req_addr != NULL) or with a given alignment.
3306 //  - bytes shall be a multiple of alignment.
3307 //  - req_addr can be NULL. If not NULL, it must be a multiple of alignment.
3308 //  - alignment sets the alignment at which memory shall be allocated.
3309 //     It must be a multiple of allocation granularity.
3310 // Returns address of memory or NULL. If req_addr was not NULL, will only return
3311 //  req_addr or NULL.
3312 static char* anon_mmap_aligned(size_t bytes, size_t alignment, char* req_addr) {
3313 
3314   size_t extra_size = bytes;
3315   if (req_addr == NULL &amp;&amp; alignment &gt; 0) {
3316     extra_size += alignment;
3317   }
3318 
3319   char* start = (char*) ::mmap(req_addr, extra_size, PROT_NONE,
3320     MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
3321     -1, 0);
3322   if (start == MAP_FAILED) {
3323     start = NULL;
3324   } else {
3325     if (req_addr != NULL) {
3326       if (start != req_addr) {
3327         ::munmap(start, extra_size);
3328         start = NULL;
3329       }
3330     } else {
3331       char* const start_aligned = align_up(start, alignment);
3332       char* const end_aligned = start_aligned + bytes;
3333       char* const end = start + extra_size;
3334       if (start_aligned &gt; start) {
3335         ::munmap(start, start_aligned - start);
3336       }
3337       if (end_aligned &lt; end) {
3338         ::munmap(end_aligned, end - end_aligned);
3339       }
3340       start = start_aligned;
3341     }
3342   }
3343   return start;
3344 }
3345 
3346 static int anon_munmap(char * addr, size_t size) {
3347   return ::munmap(addr, size) == 0;
3348 }
3349 
3350 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
3351                             size_t alignment_hint) {
3352   return anon_mmap(requested_addr, bytes, (requested_addr != NULL));
3353 }
3354 
3355 bool os::pd_release_memory(char* addr, size_t size) {
3356   return anon_munmap(addr, size);
3357 }
3358 
3359 static bool linux_mprotect(char* addr, size_t size, int prot) {
3360   // Linux wants the mprotect address argument to be page aligned.
3361   char* bottom = (char*)align_down((intptr_t)addr, os::Linux::page_size());
3362 
3363   // According to SUSv3, mprotect() should only be used with mappings
3364   // established by mmap(), and mmap() always maps whole pages. Unaligned
3365   // &#39;addr&#39; likely indicates problem in the VM (e.g. trying to change
3366   // protection of malloc&#39;ed or statically allocated memory). Check the
3367   // caller if you hit this assert.
3368   assert(addr == bottom, &quot;sanity check&quot;);
3369 
3370   size = align_up(pointer_delta(addr, bottom, 1) + size, os::Linux::page_size());
<a name="69" id="anc69"></a>
3371   return ::mprotect(bottom, size, prot) == 0;
3372 }
3373 
3374 // Set protections specified
3375 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
3376                         bool is_committed) {
3377   unsigned int p = 0;
3378   switch (prot) {
3379   case MEM_PROT_NONE: p = PROT_NONE; break;
3380   case MEM_PROT_READ: p = PROT_READ; break;
3381   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
3382   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
3383   default:
3384     ShouldNotReachHere();
3385   }
3386   // is_committed is unused.
3387   return linux_mprotect(addr, bytes, p);
3388 }
3389 
3390 bool os::guard_memory(char* addr, size_t size) {
3391   return linux_mprotect(addr, size, PROT_NONE);
3392 }
3393 
3394 bool os::unguard_memory(char* addr, size_t size) {
3395   return linux_mprotect(addr, size, PROT_READ|PROT_WRITE);
3396 }
3397 
3398 bool os::Linux::transparent_huge_pages_sanity_check(bool warn,
3399                                                     size_t page_size) {
3400   bool result = false;
3401   void *p = mmap(NULL, page_size * 2, PROT_READ|PROT_WRITE,
3402                  MAP_ANONYMOUS|MAP_PRIVATE,
3403                  -1, 0);
3404   if (p != MAP_FAILED) {
3405     void *aligned_p = align_up(p, page_size);
3406 
3407     result = madvise(aligned_p, page_size, MADV_HUGEPAGE) == 0;
3408 
3409     munmap(p, page_size * 2);
3410   }
3411 
3412   if (warn &amp;&amp; !result) {
3413     warning(&quot;TransparentHugePages is not supported by the operating system.&quot;);
3414   }
3415 
3416   return result;
3417 }
3418 
3419 bool os::Linux::hugetlbfs_sanity_check(bool warn, size_t page_size) {
3420   bool result = false;
3421   void *p = mmap(NULL, page_size, PROT_READ|PROT_WRITE,
3422                  MAP_ANONYMOUS|MAP_PRIVATE|MAP_HUGETLB,
3423                  -1, 0);
3424 
3425   if (p != MAP_FAILED) {
3426     // We don&#39;t know if this really is a huge page or not.
3427     FILE *fp = fopen(&quot;/proc/self/maps&quot;, &quot;r&quot;);
3428     if (fp) {
3429       while (!feof(fp)) {
3430         char chars[257];
3431         long x = 0;
3432         if (fgets(chars, sizeof(chars), fp)) {
3433           if (sscanf(chars, &quot;%lx-%*x&quot;, &amp;x) == 1
3434               &amp;&amp; x == (long)p) {
3435             if (strstr (chars, &quot;hugepage&quot;)) {
3436               result = true;
3437               break;
3438             }
3439           }
3440         }
3441       }
3442       fclose(fp);
3443     }
3444     munmap(p, page_size);
3445   }
3446 
3447   if (warn &amp;&amp; !result) {
3448     warning(&quot;HugeTLBFS is not supported by the operating system.&quot;);
3449   }
3450 
3451   return result;
3452 }
3453 
3454 // From the coredump_filter documentation:
3455 //
3456 // - (bit 0) anonymous private memory
3457 // - (bit 1) anonymous shared memory
3458 // - (bit 2) file-backed private memory
3459 // - (bit 3) file-backed shared memory
3460 // - (bit 4) ELF header pages in file-backed private memory areas (it is
3461 //           effective only if the bit 2 is cleared)
3462 // - (bit 5) hugetlb private memory
3463 // - (bit 6) hugetlb shared memory
3464 // - (bit 7) dax private memory
3465 // - (bit 8) dax shared memory
3466 //
3467 static void set_coredump_filter(CoredumpFilterBit bit) {
3468   FILE *f;
3469   long cdm;
3470 
3471   if ((f = fopen(&quot;/proc/self/coredump_filter&quot;, &quot;r+&quot;)) == NULL) {
3472     return;
3473   }
3474 
3475   if (fscanf(f, &quot;%lx&quot;, &amp;cdm) != 1) {
3476     fclose(f);
3477     return;
3478   }
3479 
3480   long saved_cdm = cdm;
3481   rewind(f);
3482   cdm |= bit;
3483 
3484   if (cdm != saved_cdm) {
3485     fprintf(f, &quot;%#lx&quot;, cdm);
3486   }
3487 
3488   fclose(f);
3489 }
3490 
3491 // Large page support
3492 
3493 static size_t _large_page_size = 0;
3494 
3495 size_t os::Linux::find_large_page_size() {
3496   size_t large_page_size = 0;
3497 
3498   // large_page_size on Linux is used to round up heap size. x86 uses either
3499   // 2M or 4M page, depending on whether PAE (Physical Address Extensions)
3500   // mode is enabled. AMD64/EM64T uses 2M page in 64bit mode. IA64 can use
3501   // page as large as 256M.
3502   //
3503   // Here we try to figure out page size by parsing /proc/meminfo and looking
3504   // for a line with the following format:
3505   //    Hugepagesize:     2048 kB
3506   //
3507   // If we can&#39;t determine the value (e.g. /proc is not mounted, or the text
3508   // format has been changed), we&#39;ll use the largest page size supported by
3509   // the processor.
3510 
3511 #ifndef ZERO
3512   large_page_size =
3513     AARCH64_ONLY(2 * M)
3514     AMD64_ONLY(2 * M)
3515     ARM32_ONLY(2 * M)
3516     IA32_ONLY(4 * M)
3517     IA64_ONLY(256 * M)
3518     PPC_ONLY(4 * M)
3519     S390_ONLY(1 * M)
3520     SPARC_ONLY(4 * M);
3521 #endif // ZERO
3522 
3523   FILE *fp = fopen(&quot;/proc/meminfo&quot;, &quot;r&quot;);
3524   if (fp) {
3525     while (!feof(fp)) {
3526       int x = 0;
3527       char buf[16];
3528       if (fscanf(fp, &quot;Hugepagesize: %d&quot;, &amp;x) == 1) {
3529         if (x &amp;&amp; fgets(buf, sizeof(buf), fp) &amp;&amp; strcmp(buf, &quot; kB\n&quot;) == 0) {
3530           large_page_size = x * K;
3531           break;
3532         }
3533       } else {
3534         // skip to next line
3535         for (;;) {
3536           int ch = fgetc(fp);
3537           if (ch == EOF || ch == (int)&#39;\n&#39;) break;
3538         }
3539       }
3540     }
3541     fclose(fp);
3542   }
3543 
3544   if (!FLAG_IS_DEFAULT(LargePageSizeInBytes) &amp;&amp; LargePageSizeInBytes != large_page_size) {
3545     warning(&quot;Setting LargePageSizeInBytes has no effect on this OS. Large page size is &quot;
3546             SIZE_FORMAT &quot;%s.&quot;, byte_size_in_proper_unit(large_page_size),
3547             proper_unit_for_byte_size(large_page_size));
3548   }
3549 
3550   return large_page_size;
3551 }
3552 
3553 size_t os::Linux::setup_large_page_size() {
3554   _large_page_size = Linux::find_large_page_size();
3555   const size_t default_page_size = (size_t)Linux::page_size();
3556   if (_large_page_size &gt; default_page_size) {
3557     _page_sizes[0] = _large_page_size;
3558     _page_sizes[1] = default_page_size;
3559     _page_sizes[2] = 0;
3560   }
3561 
3562   return _large_page_size;
3563 }
3564 
3565 bool os::Linux::setup_large_page_type(size_t page_size) {
3566   if (FLAG_IS_DEFAULT(UseHugeTLBFS) &amp;&amp;
3567       FLAG_IS_DEFAULT(UseSHM) &amp;&amp;
3568       FLAG_IS_DEFAULT(UseTransparentHugePages)) {
3569 
3570     // The type of large pages has not been specified by the user.
3571 
3572     // Try UseHugeTLBFS and then UseSHM.
3573     UseHugeTLBFS = UseSHM = true;
3574 
3575     // Don&#39;t try UseTransparentHugePages since there are known
3576     // performance issues with it turned on. This might change in the future.
3577     UseTransparentHugePages = false;
3578   }
3579 
3580   if (UseTransparentHugePages) {
3581     bool warn_on_failure = !FLAG_IS_DEFAULT(UseTransparentHugePages);
3582     if (transparent_huge_pages_sanity_check(warn_on_failure, page_size)) {
3583       UseHugeTLBFS = false;
3584       UseSHM = false;
3585       return true;
3586     }
3587     UseTransparentHugePages = false;
3588   }
3589 
3590   if (UseHugeTLBFS) {
3591     bool warn_on_failure = !FLAG_IS_DEFAULT(UseHugeTLBFS);
3592     if (hugetlbfs_sanity_check(warn_on_failure, page_size)) {
3593       UseSHM = false;
3594       return true;
3595     }
3596     UseHugeTLBFS = false;
3597   }
3598 
3599   return UseSHM;
3600 }
3601 
3602 void os::large_page_init() {
3603   if (!UseLargePages &amp;&amp;
3604       !UseTransparentHugePages &amp;&amp;
3605       !UseHugeTLBFS &amp;&amp;
3606       !UseSHM) {
3607     // Not using large pages.
3608     return;
3609   }
3610 
3611   if (!FLAG_IS_DEFAULT(UseLargePages) &amp;&amp; !UseLargePages) {
3612     // The user explicitly turned off large pages.
3613     // Ignore the rest of the large pages flags.
3614     UseTransparentHugePages = false;
3615     UseHugeTLBFS = false;
3616     UseSHM = false;
3617     return;
3618   }
3619 
3620   size_t large_page_size = Linux::setup_large_page_size();
3621   UseLargePages          = Linux::setup_large_page_type(large_page_size);
3622 
3623   set_coredump_filter(LARGEPAGES_BIT);
3624 }
3625 
3626 #ifndef SHM_HUGETLB
3627   #define SHM_HUGETLB 04000
3628 #endif
3629 
3630 #define shm_warning_format(format, ...)              \
3631   do {                                               \
3632     if (UseLargePages &amp;&amp;                             \
3633         (!FLAG_IS_DEFAULT(UseLargePages) ||          \
3634          !FLAG_IS_DEFAULT(UseSHM) ||                 \
3635          !FLAG_IS_DEFAULT(LargePageSizeInBytes))) {  \
3636       warning(format, __VA_ARGS__);                  \
3637     }                                                \
3638   } while (0)
3639 
3640 #define shm_warning(str) shm_warning_format(&quot;%s&quot;, str)
3641 
3642 #define shm_warning_with_errno(str)                \
3643   do {                                             \
3644     int err = errno;                               \
3645     shm_warning_format(str &quot; (error = %d)&quot;, err);  \
3646   } while (0)
3647 
3648 static char* shmat_with_alignment(int shmid, size_t bytes, size_t alignment) {
3649   assert(is_aligned(bytes, alignment), &quot;Must be divisible by the alignment&quot;);
3650 
3651   if (!is_aligned(alignment, SHMLBA)) {
3652     assert(false, &quot;Code below assumes that alignment is at least SHMLBA aligned&quot;);
3653     return NULL;
3654   }
3655 
3656   // To ensure that we get &#39;alignment&#39; aligned memory from shmat,
3657   // we pre-reserve aligned virtual memory and then attach to that.
3658 
3659   char* pre_reserved_addr = anon_mmap_aligned(bytes, alignment, NULL);
3660   if (pre_reserved_addr == NULL) {
3661     // Couldn&#39;t pre-reserve aligned memory.
3662     shm_warning(&quot;Failed to pre-reserve aligned memory for shmat.&quot;);
3663     return NULL;
3664   }
3665 
3666   // SHM_REMAP is needed to allow shmat to map over an existing mapping.
3667   char* addr = (char*)shmat(shmid, pre_reserved_addr, SHM_REMAP);
3668 
3669   if ((intptr_t)addr == -1) {
3670     int err = errno;
3671     shm_warning_with_errno(&quot;Failed to attach shared memory.&quot;);
3672 
3673     assert(err != EACCES, &quot;Unexpected error&quot;);
3674     assert(err != EIDRM,  &quot;Unexpected error&quot;);
3675     assert(err != EINVAL, &quot;Unexpected error&quot;);
3676 
3677     // Since we don&#39;t know if the kernel unmapped the pre-reserved memory area
3678     // we can&#39;t unmap it, since that would potentially unmap memory that was
3679     // mapped from other threads.
3680     return NULL;
3681   }
3682 
3683   return addr;
3684 }
3685 
3686 static char* shmat_at_address(int shmid, char* req_addr) {
3687   if (!is_aligned(req_addr, SHMLBA)) {
3688     assert(false, &quot;Requested address needs to be SHMLBA aligned&quot;);
3689     return NULL;
3690   }
3691 
3692   char* addr = (char*)shmat(shmid, req_addr, 0);
3693 
3694   if ((intptr_t)addr == -1) {
3695     shm_warning_with_errno(&quot;Failed to attach shared memory.&quot;);
3696     return NULL;
3697   }
3698 
3699   return addr;
3700 }
3701 
3702 static char* shmat_large_pages(int shmid, size_t bytes, size_t alignment, char* req_addr) {
3703   // If a req_addr has been provided, we assume that the caller has already aligned the address.
3704   if (req_addr != NULL) {
3705     assert(is_aligned(req_addr, os::large_page_size()), &quot;Must be divisible by the large page size&quot;);
3706     assert(is_aligned(req_addr, alignment), &quot;Must be divisible by given alignment&quot;);
3707     return shmat_at_address(shmid, req_addr);
3708   }
3709 
3710   // Since shmid has been setup with SHM_HUGETLB, shmat will automatically
3711   // return large page size aligned memory addresses when req_addr == NULL.
3712   // However, if the alignment is larger than the large page size, we have
3713   // to manually ensure that the memory returned is &#39;alignment&#39; aligned.
3714   if (alignment &gt; os::large_page_size()) {
3715     assert(is_aligned(alignment, os::large_page_size()), &quot;Must be divisible by the large page size&quot;);
3716     return shmat_with_alignment(shmid, bytes, alignment);
3717   } else {
3718     return shmat_at_address(shmid, NULL);
3719   }
3720 }
3721 
3722 char* os::Linux::reserve_memory_special_shm(size_t bytes, size_t alignment,
3723                                             char* req_addr, bool exec) {
3724   // &quot;exec&quot; is passed in but not used.  Creating the shared image for
3725   // the code cache doesn&#39;t have an SHM_X executable permission to check.
3726   assert(UseLargePages &amp;&amp; UseSHM, &quot;only for SHM large pages&quot;);
3727   assert(is_aligned(req_addr, os::large_page_size()), &quot;Unaligned address&quot;);
3728   assert(is_aligned(req_addr, alignment), &quot;Unaligned address&quot;);
3729 
3730   if (!is_aligned(bytes, os::large_page_size())) {
3731     return NULL; // Fallback to small pages.
3732   }
3733 
3734   // Create a large shared memory region to attach to based on size.
3735   // Currently, size is the total size of the heap.
3736   int shmid = shmget(IPC_PRIVATE, bytes, SHM_HUGETLB|IPC_CREAT|SHM_R|SHM_W);
3737   if (shmid == -1) {
3738     // Possible reasons for shmget failure:
3739     // 1. shmmax is too small for Java heap.
3740     //    &gt; check shmmax value: cat /proc/sys/kernel/shmmax
3741     //    &gt; increase shmmax value: echo &quot;0xffffffff&quot; &gt; /proc/sys/kernel/shmmax
3742     // 2. not enough large page memory.
3743     //    &gt; check available large pages: cat /proc/meminfo
3744     //    &gt; increase amount of large pages:
3745     //          echo new_value &gt; /proc/sys/vm/nr_hugepages
3746     //      Note 1: different Linux may use different name for this property,
3747     //            e.g. on Redhat AS-3 it is &quot;hugetlb_pool&quot;.
3748     //      Note 2: it&#39;s possible there&#39;s enough physical memory available but
3749     //            they are so fragmented after a long run that they can&#39;t
3750     //            coalesce into large pages. Try to reserve large pages when
3751     //            the system is still &quot;fresh&quot;.
3752     shm_warning_with_errno(&quot;Failed to reserve shared memory.&quot;);
3753     return NULL;
3754   }
3755 
3756   // Attach to the region.
3757   char* addr = shmat_large_pages(shmid, bytes, alignment, req_addr);
3758 
3759   // Remove shmid. If shmat() is successful, the actual shared memory segment
3760   // will be deleted when it&#39;s detached by shmdt() or when the process
3761   // terminates. If shmat() is not successful this will remove the shared
3762   // segment immediately.
3763   shmctl(shmid, IPC_RMID, NULL);
3764 
3765   return addr;
3766 }
3767 
3768 static void warn_on_large_pages_failure(char* req_addr, size_t bytes,
3769                                         int error) {
3770   assert(error == ENOMEM, &quot;Only expect to fail if no memory is available&quot;);
3771 
3772   bool warn_on_failure = UseLargePages &amp;&amp;
3773       (!FLAG_IS_DEFAULT(UseLargePages) ||
3774        !FLAG_IS_DEFAULT(UseHugeTLBFS) ||
3775        !FLAG_IS_DEFAULT(LargePageSizeInBytes));
3776 
3777   if (warn_on_failure) {
3778     char msg[128];
3779     jio_snprintf(msg, sizeof(msg), &quot;Failed to reserve large pages memory req_addr: &quot;
3780                  PTR_FORMAT &quot; bytes: &quot; SIZE_FORMAT &quot; (errno = %d).&quot;, req_addr, bytes, error);
3781     warning(&quot;%s&quot;, msg);
3782   }
3783 }
3784 
3785 char* os::Linux::reserve_memory_special_huge_tlbfs_only(size_t bytes,
3786                                                         char* req_addr,
3787                                                         bool exec) {
3788   assert(UseLargePages &amp;&amp; UseHugeTLBFS, &quot;only for Huge TLBFS large pages&quot;);
3789   assert(is_aligned(bytes, os::large_page_size()), &quot;Unaligned size&quot;);
3790   assert(is_aligned(req_addr, os::large_page_size()), &quot;Unaligned address&quot;);
3791 
3792   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
3793   char* addr = (char*)::mmap(req_addr, bytes, prot,
3794                              MAP_PRIVATE|MAP_ANONYMOUS|MAP_HUGETLB,
3795                              -1, 0);
3796 
3797   if (addr == MAP_FAILED) {
3798     warn_on_large_pages_failure(req_addr, bytes, errno);
3799     return NULL;
3800   }
3801 
3802   assert(is_aligned(addr, os::large_page_size()), &quot;Must be&quot;);
3803 
3804   return addr;
3805 }
3806 
3807 // Reserve memory using mmap(MAP_HUGETLB).
3808 //  - bytes shall be a multiple of alignment.
3809 //  - req_addr can be NULL. If not NULL, it must be a multiple of alignment.
3810 //  - alignment sets the alignment at which memory shall be allocated.
3811 //     It must be a multiple of allocation granularity.
3812 // Returns address of memory or NULL. If req_addr was not NULL, will only return
3813 //  req_addr or NULL.
3814 char* os::Linux::reserve_memory_special_huge_tlbfs_mixed(size_t bytes,
3815                                                          size_t alignment,
3816                                                          char* req_addr,
3817                                                          bool exec) {
3818   size_t large_page_size = os::large_page_size();
3819   assert(bytes &gt;= large_page_size, &quot;Shouldn&#39;t allocate large pages for small sizes&quot;);
3820 
3821   assert(is_aligned(req_addr, alignment), &quot;Must be&quot;);
3822   assert(is_aligned(bytes, alignment), &quot;Must be&quot;);
3823 
3824   // First reserve - but not commit - the address range in small pages.
3825   char* const start = anon_mmap_aligned(bytes, alignment, req_addr);
3826 
3827   if (start == NULL) {
3828     return NULL;
3829   }
3830 
3831   assert(is_aligned(start, alignment), &quot;Must be&quot;);
3832 
3833   char* end = start + bytes;
3834 
3835   // Find the regions of the allocated chunk that can be promoted to large pages.
3836   char* lp_start = align_up(start, large_page_size);
3837   char* lp_end   = align_down(end, large_page_size);
3838 
3839   size_t lp_bytes = lp_end - lp_start;
3840 
3841   assert(is_aligned(lp_bytes, large_page_size), &quot;Must be&quot;);
3842 
3843   if (lp_bytes == 0) {
3844     // The mapped region doesn&#39;t even span the start and the end of a large page.
3845     // Fall back to allocate a non-special area.
3846     ::munmap(start, end - start);
3847     return NULL;
3848   }
3849 
3850   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
3851 
3852   void* result;
3853 
3854   // Commit small-paged leading area.
3855   if (start != lp_start) {
3856     result = ::mmap(start, lp_start - start, prot,
3857                     MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,
3858                     -1, 0);
3859     if (result == MAP_FAILED) {
3860       ::munmap(lp_start, end - lp_start);
3861       return NULL;
3862     }
3863   }
3864 
3865   // Commit large-paged area.
3866   result = ::mmap(lp_start, lp_bytes, prot,
3867                   MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED|MAP_HUGETLB,
3868                   -1, 0);
3869   if (result == MAP_FAILED) {
3870     warn_on_large_pages_failure(lp_start, lp_bytes, errno);
3871     // If the mmap above fails, the large pages region will be unmapped and we
3872     // have regions before and after with small pages. Release these regions.
3873     //
3874     // |  mapped  |  unmapped  |  mapped  |
3875     // ^          ^            ^          ^
3876     // start      lp_start     lp_end     end
3877     //
3878     ::munmap(start, lp_start - start);
3879     ::munmap(lp_end, end - lp_end);
3880     return NULL;
3881   }
3882 
3883   // Commit small-paged trailing area.
3884   if (lp_end != end) {
3885     result = ::mmap(lp_end, end - lp_end, prot,
3886                     MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED,
3887                     -1, 0);
3888     if (result == MAP_FAILED) {
3889       ::munmap(start, lp_end - start);
3890       return NULL;
3891     }
3892   }
3893 
3894   return start;
3895 }
3896 
3897 char* os::Linux::reserve_memory_special_huge_tlbfs(size_t bytes,
3898                                                    size_t alignment,
3899                                                    char* req_addr,
3900                                                    bool exec) {
3901   assert(UseLargePages &amp;&amp; UseHugeTLBFS, &quot;only for Huge TLBFS large pages&quot;);
3902   assert(is_aligned(req_addr, alignment), &quot;Must be&quot;);
3903   assert(is_aligned(alignment, os::vm_allocation_granularity()), &quot;Must be&quot;);
3904   assert(is_power_of_2(os::large_page_size()), &quot;Must be&quot;);
3905   assert(bytes &gt;= os::large_page_size(), &quot;Shouldn&#39;t allocate large pages for small sizes&quot;);
3906 
3907   if (is_aligned(bytes, os::large_page_size()) &amp;&amp; alignment &lt;= os::large_page_size()) {
3908     return reserve_memory_special_huge_tlbfs_only(bytes, req_addr, exec);
3909   } else {
3910     return reserve_memory_special_huge_tlbfs_mixed(bytes, alignment, req_addr, exec);
3911   }
3912 }
3913 
3914 char* os::reserve_memory_special(size_t bytes, size_t alignment,
3915                                  char* req_addr, bool exec) {
3916   assert(UseLargePages, &quot;only for large pages&quot;);
3917 
3918   char* addr;
3919   if (UseSHM) {
3920     addr = os::Linux::reserve_memory_special_shm(bytes, alignment, req_addr, exec);
3921   } else {
3922     assert(UseHugeTLBFS, &quot;must be&quot;);
3923     addr = os::Linux::reserve_memory_special_huge_tlbfs(bytes, alignment, req_addr, exec);
3924   }
3925 
3926   if (addr != NULL) {
3927     if (UseNUMAInterleaving) {
3928       numa_make_global(addr, bytes);
3929     }
3930 
3931     // The memory is committed
3932     MemTracker::record_virtual_memory_reserve_and_commit((address)addr, bytes, CALLER_PC);
3933   }
3934 
3935   return addr;
3936 }
3937 
3938 bool os::Linux::release_memory_special_shm(char* base, size_t bytes) {
3939   // detaching the SHM segment will also delete it, see reserve_memory_special_shm()
3940   return shmdt(base) == 0;
3941 }
3942 
3943 bool os::Linux::release_memory_special_huge_tlbfs(char* base, size_t bytes) {
3944   return pd_release_memory(base, bytes);
3945 }
3946 
3947 bool os::release_memory_special(char* base, size_t bytes) {
3948   bool res;
3949   if (MemTracker::tracking_level() &gt; NMT_minimal) {
3950     Tracker tkr(Tracker::release);
3951     res = os::Linux::release_memory_special_impl(base, bytes);
3952     if (res) {
3953       tkr.record((address)base, bytes);
3954     }
3955 
3956   } else {
3957     res = os::Linux::release_memory_special_impl(base, bytes);
3958   }
3959   return res;
3960 }
3961 
3962 bool os::Linux::release_memory_special_impl(char* base, size_t bytes) {
3963   assert(UseLargePages, &quot;only for large pages&quot;);
3964   bool res;
3965 
3966   if (UseSHM) {
3967     res = os::Linux::release_memory_special_shm(base, bytes);
3968   } else {
3969     assert(UseHugeTLBFS, &quot;must be&quot;);
3970     res = os::Linux::release_memory_special_huge_tlbfs(base, bytes);
3971   }
3972   return res;
3973 }
3974 
3975 size_t os::large_page_size() {
3976   return _large_page_size;
3977 }
3978 
3979 // With SysV SHM the entire memory region must be allocated as shared
3980 // memory.
3981 // HugeTLBFS allows application to commit large page memory on demand.
3982 // However, when committing memory with HugeTLBFS fails, the region
3983 // that was supposed to be committed will lose the old reservation
3984 // and allow other threads to steal that memory region. Because of this
3985 // behavior we can&#39;t commit HugeTLBFS memory.
3986 bool os::can_commit_large_page_memory() {
3987   return UseTransparentHugePages;
3988 }
3989 
3990 bool os::can_execute_large_page_memory() {
3991   return UseTransparentHugePages || UseHugeTLBFS;
3992 }
3993 
3994 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
3995   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
3996   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
3997   if (result != NULL) {
3998     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
3999       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
4000     }
4001   }
4002   return result;
4003 }
4004 
4005 // Reserve memory at an arbitrary address, only if that area is
4006 // available (and not reserved for something else).
4007 
4008 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
<a name="70" id="anc70"></a><span class="line-removed">4009   const int max_tries = 10;</span>
<span class="line-removed">4010   char* base[max_tries];</span>
<span class="line-removed">4011   size_t size[max_tries];</span>
<span class="line-removed">4012   const size_t gap = 0x000000;</span>
<span class="line-removed">4013 </span>
4014   // Assert only that the size is a multiple of the page size, since
4015   // that&#39;s all that mmap requires, and since that&#39;s all we really know
4016   // about at this low abstraction level.  If we need higher alignment,
4017   // we can either pass an alignment to this method or verify alignment
4018   // in one of the methods further up the call chain.  See bug 5044738.
4019   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
4020 
4021   // Repeatedly allocate blocks until the block is allocated at the
4022   // right spot.
4023 
4024   // Linux mmap allows caller to pass an address as hint; give it a try first,
4025   // if kernel honors the hint then we can return immediately.
4026   char * addr = anon_mmap(requested_addr, bytes, false);
4027   if (addr == requested_addr) {
4028     return requested_addr;
4029   }
4030 
4031   if (addr != NULL) {
4032     // mmap() is successful but it fails to reserve at the requested address
4033     anon_munmap(addr, bytes);
4034   }
4035 
<a name="71" id="anc71"></a><span class="line-modified">4036   int i;</span>
<span class="line-removed">4037   for (i = 0; i &lt; max_tries; ++i) {</span>
<span class="line-removed">4038     base[i] = reserve_memory(bytes);</span>
<span class="line-removed">4039 </span>
<span class="line-removed">4040     if (base[i] != NULL) {</span>
<span class="line-removed">4041       // Is this the block we wanted?</span>
<span class="line-removed">4042       if (base[i] == requested_addr) {</span>
<span class="line-removed">4043         size[i] = bytes;</span>
<span class="line-removed">4044         break;</span>
<span class="line-removed">4045       }</span>
<span class="line-removed">4046 </span>
<span class="line-removed">4047       // Does this overlap the block we wanted? Give back the overlapped</span>
<span class="line-removed">4048       // parts and try again.</span>
<span class="line-removed">4049 </span>
<span class="line-removed">4050       ptrdiff_t top_overlap = requested_addr + (bytes + gap) - base[i];</span>
<span class="line-removed">4051       if (top_overlap &gt;= 0 &amp;&amp; (size_t)top_overlap &lt; bytes) {</span>
<span class="line-removed">4052         unmap_memory(base[i], top_overlap);</span>
<span class="line-removed">4053         base[i] += top_overlap;</span>
<span class="line-removed">4054         size[i] = bytes - top_overlap;</span>
<span class="line-removed">4055       } else {</span>
<span class="line-removed">4056         ptrdiff_t bottom_overlap = base[i] + bytes - requested_addr;</span>
<span class="line-removed">4057         if (bottom_overlap &gt;= 0 &amp;&amp; (size_t)bottom_overlap &lt; bytes) {</span>
<span class="line-removed">4058           unmap_memory(requested_addr, bottom_overlap);</span>
<span class="line-removed">4059           size[i] = bytes - bottom_overlap;</span>
<span class="line-removed">4060         } else {</span>
<span class="line-removed">4061           size[i] = bytes;</span>
<span class="line-removed">4062         }</span>
<span class="line-removed">4063       }</span>
<span class="line-removed">4064     }</span>
<span class="line-removed">4065   }</span>
<span class="line-removed">4066 </span>
<span class="line-removed">4067   // Give back the unused reserved pieces.</span>
<span class="line-removed">4068 </span>
<span class="line-removed">4069   for (int j = 0; j &lt; i; ++j) {</span>
<span class="line-removed">4070     if (base[j] != NULL) {</span>
<span class="line-removed">4071       unmap_memory(base[j], size[j]);</span>
<span class="line-removed">4072     }</span>
<span class="line-removed">4073   }</span>
<span class="line-removed">4074 </span>
<span class="line-removed">4075   if (i &lt; max_tries) {</span>
<span class="line-removed">4076     return requested_addr;</span>
<span class="line-removed">4077   } else {</span>
<span class="line-removed">4078     return NULL;</span>
<span class="line-removed">4079   }</span>
4080 }
4081 
4082 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
4083 void os::infinite_sleep() {
4084   while (true) {    // sleep forever ...
4085     ::sleep(100);   // ... 100 seconds at a time
4086   }
4087 }
4088 
4089 // Used to convert frequent JVM_Yield() to nops
4090 bool os::dont_yield() {
4091   return DontYieldALot;
4092 }
4093 
4094 // Linux CFS scheduler (since 2.6.23) does not guarantee sched_yield(2) will
4095 // actually give up the CPU. Since skip buddy (v2.6.28):
4096 //
4097 // * Sets the yielding task as skip buddy for current CPU&#39;s run queue.
4098 // * Picks next from run queue, if empty, picks a skip buddy (can be the yielding task).
4099 // * Clears skip buddies for this run queue (yielding task no longer a skip buddy).
4100 //
4101 // An alternative is calling os::naked_short_nanosleep with a small number to avoid
4102 // getting re-scheduled immediately.
4103 //
4104 void os::naked_yield() {
4105   sched_yield();
4106 }
4107 
4108 ////////////////////////////////////////////////////////////////////////////////
4109 // thread priority support
4110 
4111 // Note: Normal Linux applications are run with SCHED_OTHER policy. SCHED_OTHER
4112 // only supports dynamic priority, static priority must be zero. For real-time
4113 // applications, Linux supports SCHED_RR which allows static priority (1-99).
4114 // However, for large multi-threaded applications, SCHED_RR is not only slower
4115 // than SCHED_OTHER, but also very unstable (my volano tests hang hard 4 out
4116 // of 5 runs - Sep 2005).
4117 //
4118 // The following code actually changes the niceness of kernel-thread/LWP. It
4119 // has an assumption that setpriority() only modifies one kernel-thread/LWP,
4120 // not the entire user process, and user level threads are 1:1 mapped to kernel
4121 // threads. It has always been the case, but could change in the future. For
4122 // this reason, the code should not be used as default (ThreadPriorityPolicy=0).
4123 // It is only used when ThreadPriorityPolicy=1 and may require system level permission
4124 // (e.g., root privilege or CAP_SYS_NICE capability).
4125 
4126 int os::java_to_os_priority[CriticalPriority + 1] = {
4127   19,              // 0 Entry should never be used
4128 
4129    4,              // 1 MinPriority
4130    3,              // 2
4131    2,              // 3
4132 
4133    1,              // 4
4134    0,              // 5 NormPriority
4135   -1,              // 6
4136 
4137   -2,              // 7
4138   -3,              // 8
4139   -4,              // 9 NearMaxPriority
4140 
4141   -5,              // 10 MaxPriority
4142 
4143   -5               // 11 CriticalPriority
4144 };
4145 
4146 static int prio_init() {
4147   if (ThreadPriorityPolicy == 1) {
4148     if (geteuid() != 0) {
4149       if (!FLAG_IS_DEFAULT(ThreadPriorityPolicy)) {
4150         warning(&quot;-XX:ThreadPriorityPolicy=1 may require system level permission, &quot; \
4151                 &quot;e.g., being the root user. If the necessary permission is not &quot; \
4152                 &quot;possessed, changes to priority will be silently ignored.&quot;);
4153       }
4154     }
4155   }
4156   if (UseCriticalJavaThreadPriority) {
4157     os::java_to_os_priority[MaxPriority] = os::java_to_os_priority[CriticalPriority];
4158   }
4159   return 0;
4160 }
4161 
4162 OSReturn os::set_native_priority(Thread* thread, int newpri) {
4163   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) return OS_OK;
4164 
4165   int ret = setpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id(), newpri);
4166   return (ret == 0) ? OS_OK : OS_ERR;
4167 }
4168 
4169 OSReturn os::get_native_priority(const Thread* const thread,
4170                                  int *priority_ptr) {
4171   if (!UseThreadPriorities || ThreadPriorityPolicy == 0) {
4172     *priority_ptr = java_to_os_priority[NormPriority];
4173     return OS_OK;
4174   }
4175 
4176   errno = 0;
4177   *priority_ptr = getpriority(PRIO_PROCESS, thread-&gt;osthread()-&gt;thread_id());
4178   return (*priority_ptr != -1 || errno == 0 ? OS_OK : OS_ERR);
4179 }
4180 
4181 ////////////////////////////////////////////////////////////////////////////////
4182 // suspend/resume support
4183 
4184 //  The low-level signal-based suspend/resume support is a remnant from the
4185 //  old VM-suspension that used to be for java-suspension, safepoints etc,
4186 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
4187 //
4188 //  The remaining code is greatly simplified from the more general suspension
4189 //  code that used to be used.
4190 //
4191 //  The protocol is quite simple:
4192 //  - suspend:
4193 //      - sends a signal to the target thread
4194 //      - polls the suspend state of the osthread using a yield loop
4195 //      - target thread signal handler (SR_handler) sets suspend state
4196 //        and blocks in sigsuspend until continued
4197 //  - resume:
4198 //      - sets target osthread state to continue
4199 //      - sends signal to end the sigsuspend loop in the SR_handler
4200 //
4201 //  Note that the SR_lock plays no role in this suspend/resume protocol,
4202 //  but is checked for NULL in SR_handler as a thread termination indicator.
4203 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
4204 //
4205 //  Note that resume_clear_context() and suspend_save_context() are needed
4206 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
4207 //  which in part is used by:
4208 //    - Forte Analyzer: AsyncGetCallTrace()
4209 //    - StackBanging: get_frame_at_stack_banging_point()
4210 
4211 static void resume_clear_context(OSThread *osthread) {
4212   osthread-&gt;set_ucontext(NULL);
4213   osthread-&gt;set_siginfo(NULL);
4214 }
4215 
4216 static void suspend_save_context(OSThread *osthread, siginfo_t* siginfo,
4217                                  ucontext_t* context) {
4218   osthread-&gt;set_ucontext(context);
4219   osthread-&gt;set_siginfo(siginfo);
4220 }
4221 
4222 // Handler function invoked when a thread&#39;s execution is suspended or
4223 // resumed. We have to be careful that only async-safe functions are
4224 // called here (Note: most pthread functions are not async safe and
4225 // should be avoided.)
4226 //
4227 // Note: sigwait() is a more natural fit than sigsuspend() from an
4228 // interface point of view, but sigwait() prevents the signal hander
4229 // from being run. libpthread would get very confused by not having
4230 // its signal handlers run and prevents sigwait()&#39;s use with the
4231 // mutex granting granting signal.
4232 //
4233 // Currently only ever called on the VMThread and JavaThreads (PC sampling)
4234 //
4235 static void SR_handler(int sig, siginfo_t* siginfo, ucontext_t* context) {
4236   // Save and restore errno to avoid confusing native code with EINTR
4237   // after sigsuspend.
4238   int old_errno = errno;
4239 
4240   Thread* thread = Thread::current_or_null_safe();
4241   assert(thread != NULL, &quot;Missing current thread in SR_handler&quot;);
4242 
4243   // On some systems we have seen signal delivery get &quot;stuck&quot; until the signal
4244   // mask is changed as part of thread termination. Check that the current thread
4245   // has not already terminated (via SR_lock()) - else the following assertion
4246   // will fail because the thread is no longer a JavaThread as the ~JavaThread
4247   // destructor has completed.
4248 
4249   if (thread-&gt;SR_lock() == NULL) {
4250     return;
4251   }
4252 
4253   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
4254 
4255   OSThread* osthread = thread-&gt;osthread();
4256 
4257   os::SuspendResume::State current = osthread-&gt;sr.state();
4258   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
4259     suspend_save_context(osthread, siginfo, context);
4260 
4261     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
4262     os::SuspendResume::State state = osthread-&gt;sr.suspended();
4263     if (state == os::SuspendResume::SR_SUSPENDED) {
4264       sigset_t suspend_set;  // signals for sigsuspend()
4265       sigemptyset(&amp;suspend_set);
4266       // get current set of blocked signals and unblock resume signal
4267       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
4268       sigdelset(&amp;suspend_set, SR_signum);
4269 
4270       sr_semaphore.signal();
4271       // wait here until we are resumed
4272       while (1) {
4273         sigsuspend(&amp;suspend_set);
4274 
4275         os::SuspendResume::State result = osthread-&gt;sr.running();
4276         if (result == os::SuspendResume::SR_RUNNING) {
4277           sr_semaphore.signal();
4278           break;
4279         }
4280       }
4281 
4282     } else if (state == os::SuspendResume::SR_RUNNING) {
4283       // request was cancelled, continue
4284     } else {
4285       ShouldNotReachHere();
4286     }
4287 
4288     resume_clear_context(osthread);
4289   } else if (current == os::SuspendResume::SR_RUNNING) {
4290     // request was cancelled, continue
4291   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
4292     // ignore
4293   } else {
4294     // ignore
4295   }
4296 
4297   errno = old_errno;
4298 }
4299 
4300 static int SR_initialize() {
4301   struct sigaction act;
4302   char *s;
4303 
4304   // Get signal number to use for suspend/resume
4305   if ((s = ::getenv(&quot;_JAVA_SR_SIGNUM&quot;)) != 0) {
4306     int sig = ::strtol(s, 0, 10);
4307     if (sig &gt; MAX2(SIGSEGV, SIGBUS) &amp;&amp;  // See 4355769.
4308         sig &lt; NSIG) {                   // Must be legal signal and fit into sigflags[].
4309       SR_signum = sig;
4310     } else {
4311       warning(&quot;You set _JAVA_SR_SIGNUM=%d. It must be in range [%d, %d]. Using %d instead.&quot;,
4312               sig, MAX2(SIGSEGV, SIGBUS)+1, NSIG-1, SR_signum);
4313     }
4314   }
4315 
4316   assert(SR_signum &gt; SIGSEGV &amp;&amp; SR_signum &gt; SIGBUS,
4317          &quot;SR_signum must be greater than max(SIGSEGV, SIGBUS), see 4355769&quot;);
4318 
4319   sigemptyset(&amp;SR_sigset);
4320   sigaddset(&amp;SR_sigset, SR_signum);
4321 
4322   // Set up signal handler for suspend/resume
4323   act.sa_flags = SA_RESTART|SA_SIGINFO;
4324   act.sa_handler = (void (*)(int)) SR_handler;
4325 
4326   // SR_signum is blocked by default.
4327   // 4528190 - We also need to block pthread restart signal (32 on all
4328   // supported Linux platforms). Note that LinuxThreads need to block
4329   // this signal for all threads to work properly. So we don&#39;t have
4330   // to use hard-coded signal number when setting up the mask.
4331   pthread_sigmask(SIG_BLOCK, NULL, &amp;act.sa_mask);
4332 
4333   if (sigaction(SR_signum, &amp;act, 0) == -1) {
4334     return -1;
4335   }
4336 
4337   // Save signal flag
4338   os::Linux::set_our_sigflags(SR_signum, act.sa_flags);
4339   return 0;
4340 }
4341 
4342 static int sr_notify(OSThread* osthread) {
4343   int status = pthread_kill(osthread-&gt;pthread_id(), SR_signum);
4344   assert_status(status == 0, status, &quot;pthread_kill&quot;);
4345   return status;
4346 }
4347 
4348 // &quot;Randomly&quot; selected value for how long we want to spin
4349 // before bailing out on suspending a thread, also how often
4350 // we send a signal to a thread we want to resume
4351 static const int RANDOMLY_LARGE_INTEGER = 1000000;
4352 static const int RANDOMLY_LARGE_INTEGER2 = 100;
4353 
4354 // returns true on success and false on error - really an error is fatal
4355 // but this seems the normal response to library errors
4356 static bool do_suspend(OSThread* osthread) {
4357   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
4358   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
4359 
4360   // mark as suspended and send signal
4361   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
4362     // failed to switch, state wasn&#39;t running?
4363     ShouldNotReachHere();
4364     return false;
4365   }
4366 
4367   if (sr_notify(osthread) != 0) {
4368     ShouldNotReachHere();
4369   }
4370 
4371   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
4372   while (true) {
4373     if (sr_semaphore.timedwait(2)) {
4374       break;
4375     } else {
4376       // timeout
4377       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
4378       if (cancelled == os::SuspendResume::SR_RUNNING) {
4379         return false;
4380       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
4381         // make sure that we consume the signal on the semaphore as well
4382         sr_semaphore.wait();
4383         break;
4384       } else {
4385         ShouldNotReachHere();
4386         return false;
4387       }
4388     }
4389   }
4390 
4391   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
4392   return true;
4393 }
4394 
4395 static void do_resume(OSThread* osthread) {
4396   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
4397   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
4398 
4399   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
4400     // failed to switch to WAKEUP_REQUEST
4401     ShouldNotReachHere();
4402     return;
4403   }
4404 
4405   while (true) {
4406     if (sr_notify(osthread) == 0) {
4407       if (sr_semaphore.timedwait(2)) {
4408         if (osthread-&gt;sr.is_running()) {
4409           return;
4410         }
4411       }
4412     } else {
4413       ShouldNotReachHere();
4414     }
4415   }
4416 
4417   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
4418 }
4419 
4420 ///////////////////////////////////////////////////////////////////////////////////
4421 // signal handling (except suspend/resume)
4422 
4423 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
4424 // The user-defined signal handler must pass unrecognized signals to this
4425 // routine, and if it returns true (non-zero), then the signal handler must
4426 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
4427 // routine will never retun false (zero), but instead will execute a VM panic
4428 // routine kill the process.
4429 //
4430 // If this routine returns false, it is OK to call it again.  This allows
4431 // the user-defined signal handler to perform checks either before or after
4432 // the VM performs its own checks.  Naturally, the user code would be making
4433 // a serious error if it tried to handle an exception (such as a null check
4434 // or breakpoint) that the VM was generating for its own correct operation.
4435 //
4436 // This routine may recognize any of the following kinds of signals:
4437 //    SIGBUS, SIGSEGV, SIGILL, SIGFPE, SIGQUIT, SIGPIPE, SIGXFSZ, SIGUSR1.
4438 // It should be consulted by handlers for any of those signals.
4439 //
4440 // The caller of this routine must pass in the three arguments supplied
4441 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
4442 // field of the structure passed to sigaction().  This routine assumes that
4443 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
4444 //
4445 // Note that the VM will print warnings if it detects conflicting signal
4446 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
4447 //
4448 extern &quot;C&quot; JNIEXPORT int JVM_handle_linux_signal(int signo,
4449                                                  siginfo_t* siginfo,
4450                                                  void* ucontext,
4451                                                  int abort_if_unrecognized);
4452 
4453 static void signalHandler(int sig, siginfo_t* info, void* uc) {
4454   assert(info != NULL &amp;&amp; uc != NULL, &quot;it must be old kernel&quot;);
4455   int orig_errno = errno;  // Preserve errno value over signal handler.
4456   JVM_handle_linux_signal(sig, info, uc, true);
4457   errno = orig_errno;
4458 }
4459 
4460 
4461 // This boolean allows users to forward their own non-matching signals
4462 // to JVM_handle_linux_signal, harmlessly.
4463 bool os::Linux::signal_handlers_are_installed = false;
4464 
4465 // For signal-chaining
4466 bool os::Linux::libjsig_is_loaded = false;
4467 typedef struct sigaction *(*get_signal_t)(int);
4468 get_signal_t os::Linux::get_signal_action = NULL;
4469 
4470 struct sigaction* os::Linux::get_chained_signal_action(int sig) {
4471   struct sigaction *actp = NULL;
4472 
4473   if (libjsig_is_loaded) {
4474     // Retrieve the old signal handler from libjsig
4475     actp = (*get_signal_action)(sig);
4476   }
4477   if (actp == NULL) {
4478     // Retrieve the preinstalled signal handler from jvm
4479     actp = os::Posix::get_preinstalled_handler(sig);
4480   }
4481 
4482   return actp;
4483 }
4484 
4485 static bool call_chained_handler(struct sigaction *actp, int sig,
4486                                  siginfo_t *siginfo, void *context) {
4487   // Call the old signal handler
4488   if (actp-&gt;sa_handler == SIG_DFL) {
4489     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
4490     // instead of taking the default action.
4491     return false;
4492   } else if (actp-&gt;sa_handler != SIG_IGN) {
4493     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
4494       // automaticlly block the signal
4495       sigaddset(&amp;(actp-&gt;sa_mask), sig);
4496     }
4497 
4498     sa_handler_t hand = NULL;
4499     sa_sigaction_t sa = NULL;
4500     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
4501     // retrieve the chained handler
4502     if (siginfo_flag_set) {
4503       sa = actp-&gt;sa_sigaction;
4504     } else {
4505       hand = actp-&gt;sa_handler;
4506     }
4507 
4508     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
4509       actp-&gt;sa_handler = SIG_DFL;
4510     }
4511 
4512     // try to honor the signal mask
4513     sigset_t oset;
4514     sigemptyset(&amp;oset);
4515     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
4516 
4517     // call into the chained handler
4518     if (siginfo_flag_set) {
4519       (*sa)(sig, siginfo, context);
4520     } else {
4521       (*hand)(sig);
4522     }
4523 
4524     // restore the signal mask
4525     pthread_sigmask(SIG_SETMASK, &amp;oset, NULL);
4526   }
4527   // Tell jvm&#39;s signal handler the signal is taken care of.
4528   return true;
4529 }
4530 
4531 bool os::Linux::chained_handler(int sig, siginfo_t* siginfo, void* context) {
4532   bool chained = false;
4533   // signal-chaining
4534   if (UseSignalChaining) {
4535     struct sigaction *actp = get_chained_signal_action(sig);
4536     if (actp != NULL) {
4537       chained = call_chained_handler(actp, sig, siginfo, context);
4538     }
4539   }
4540   return chained;
4541 }
4542 
4543 // for diagnostic
4544 int sigflags[NSIG];
4545 
4546 int os::Linux::get_our_sigflags(int sig) {
4547   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4548   return sigflags[sig];
4549 }
4550 
4551 void os::Linux::set_our_sigflags(int sig, int flags) {
4552   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4553   if (sig &gt; 0 &amp;&amp; sig &lt; NSIG) {
4554     sigflags[sig] = flags;
4555   }
4556 }
4557 
4558 void os::Linux::set_signal_handler(int sig, bool set_installed) {
4559   // Check for overwrite.
4560   struct sigaction oldAct;
4561   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
4562 
4563   void* oldhand = oldAct.sa_sigaction
4564                 ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
4565                 : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
4566   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
4567       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
4568       oldhand != CAST_FROM_FN_PTR(void*, (sa_sigaction_t)signalHandler)) {
4569     if (AllowUserSignalHandlers || !set_installed) {
4570       // Do not overwrite; user takes responsibility to forward to us.
4571       return;
4572     } else if (UseSignalChaining) {
4573       // save the old handler in jvm
4574       os::Posix::save_preinstalled_handler(sig, oldAct);
4575       // libjsig also interposes the sigaction() call below and saves the
4576       // old sigaction on it own.
4577     } else {
4578       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
4579             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
4580     }
4581   }
4582 
4583   struct sigaction sigAct;
4584   sigfillset(&amp;(sigAct.sa_mask));
4585   sigAct.sa_handler = SIG_DFL;
4586   if (!set_installed) {
4587     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
4588   } else {
4589     sigAct.sa_sigaction = signalHandler;
4590     sigAct.sa_flags = SA_SIGINFO|SA_RESTART;
4591   }
4592   // Save flags, which are set by ours
4593   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
4594   sigflags[sig] = sigAct.sa_flags;
4595 
4596   int ret = sigaction(sig, &amp;sigAct, &amp;oldAct);
4597   assert(ret == 0, &quot;check&quot;);
4598 
4599   void* oldhand2  = oldAct.sa_sigaction
4600                   ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
4601                   : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
4602   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
4603 }
4604 
4605 // install signal handlers for signals that HotSpot needs to
4606 // handle in order to support Java-level exception handling.
4607 
4608 void os::Linux::install_signal_handlers() {
4609   if (!signal_handlers_are_installed) {
4610     signal_handlers_are_installed = true;
4611 
4612     // signal-chaining
4613     typedef void (*signal_setting_t)();
4614     signal_setting_t begin_signal_setting = NULL;
4615     signal_setting_t end_signal_setting = NULL;
4616     begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
4617                                           dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
4618     if (begin_signal_setting != NULL) {
4619       end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
4620                                           dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
4621       get_signal_action = CAST_TO_FN_PTR(get_signal_t,
4622                                          dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
4623       libjsig_is_loaded = true;
4624       assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
4625     }
4626     if (libjsig_is_loaded) {
4627       // Tell libjsig jvm is setting signal handlers
4628       (*begin_signal_setting)();
4629     }
4630 
4631     set_signal_handler(SIGSEGV, true);
4632     set_signal_handler(SIGPIPE, true);
4633     set_signal_handler(SIGBUS, true);
4634     set_signal_handler(SIGILL, true);
4635     set_signal_handler(SIGFPE, true);
4636 #if defined(PPC64)
4637     set_signal_handler(SIGTRAP, true);
4638 #endif
4639     set_signal_handler(SIGXFSZ, true);
4640 
4641     if (libjsig_is_loaded) {
4642       // Tell libjsig jvm finishes setting signal handlers
4643       (*end_signal_setting)();
4644     }
4645 
4646     // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
4647     // and if UserSignalHandler is installed all bets are off.
4648     // Log that signal checking is off only if -verbose:jni is specified.
4649     if (CheckJNICalls) {
4650       if (libjsig_is_loaded) {
<a name="72" id="anc72"></a><span class="line-modified">4651         if (PrintJNIResolving) {</span>
<span class="line-removed">4652           tty-&gt;print_cr(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);</span>
<span class="line-removed">4653         }</span>
4654         check_signals = false;
4655       }
4656       if (AllowUserSignalHandlers) {
<a name="73" id="anc73"></a><span class="line-modified">4657         if (PrintJNIResolving) {</span>
<span class="line-removed">4658           tty-&gt;print_cr(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);</span>
<span class="line-removed">4659         }</span>
4660         check_signals = false;
4661       }
4662     }
4663   }
4664 }
4665 
4666 // This is the fastest way to get thread cpu time on Linux.
4667 // Returns cpu time (user+sys) for any thread, not only for current.
4668 // POSIX compliant clocks are implemented in the kernels 2.6.16+.
4669 // It might work on 2.6.10+ with a special kernel/glibc patch.
4670 // For reference, please, see IEEE Std 1003.1-2004:
4671 //   http://www.unix.org/single_unix_specification
4672 
4673 jlong os::Linux::fast_thread_cpu_time(clockid_t clockid) {
4674   struct timespec tp;
4675   int rc = os::Posix::clock_gettime(clockid, &amp;tp);
4676   assert(rc == 0, &quot;clock_gettime is expected to return 0 code&quot;);
4677 
4678   return (tp.tv_sec * NANOSECS_PER_SEC) + tp.tv_nsec;
4679 }
4680 
<a name="74" id="anc74"></a><span class="line-removed">4681 void os::Linux::initialize_os_info() {</span>
<span class="line-removed">4682   assert(_os_version == 0, &quot;OS info already initialized&quot;);</span>
<span class="line-removed">4683 </span>
<span class="line-removed">4684   struct utsname _uname;</span>
<span class="line-removed">4685 </span>
<span class="line-removed">4686   uint32_t major;</span>
<span class="line-removed">4687   uint32_t minor;</span>
<span class="line-removed">4688   uint32_t fix;</span>
<span class="line-removed">4689 </span>
<span class="line-removed">4690   int rc;</span>
<span class="line-removed">4691 </span>
<span class="line-removed">4692   // Kernel version is unknown if</span>
<span class="line-removed">4693   // verification below fails.</span>
<span class="line-removed">4694   _os_version = 0x01000000;</span>
<span class="line-removed">4695 </span>
<span class="line-removed">4696   rc = uname(&amp;_uname);</span>
<span class="line-removed">4697   if (rc != -1) {</span>
<span class="line-removed">4698 </span>
<span class="line-removed">4699     rc = sscanf(_uname.release,&quot;%d.%d.%d&quot;, &amp;major, &amp;minor, &amp;fix);</span>
<span class="line-removed">4700     if (rc == 3) {</span>
<span class="line-removed">4701 </span>
<span class="line-removed">4702       if (major &lt; 256 &amp;&amp; minor &lt; 256 &amp;&amp; fix &lt; 256) {</span>
<span class="line-removed">4703         // Kernel version format is as expected,</span>
<span class="line-removed">4704         // set it overriding unknown state.</span>
<span class="line-removed">4705         _os_version = (major &lt;&lt; 16) |</span>
<span class="line-removed">4706                       (minor &lt;&lt; 8 ) |</span>
<span class="line-removed">4707                       (fix   &lt;&lt; 0 ) ;</span>
<span class="line-removed">4708       }</span>
<span class="line-removed">4709     }</span>
<span class="line-removed">4710   }</span>
<span class="line-removed">4711 }</span>
<span class="line-removed">4712 </span>
<span class="line-removed">4713 uint32_t os::Linux::os_version() {</span>
<span class="line-removed">4714   assert(_os_version != 0, &quot;not initialized&quot;);</span>
<span class="line-removed">4715   return _os_version &amp; 0x00FFFFFF;</span>
<span class="line-removed">4716 }</span>
<span class="line-removed">4717 </span>
<span class="line-removed">4718 bool os::Linux::os_version_is_known() {</span>
<span class="line-removed">4719   assert(_os_version != 0, &quot;not initialized&quot;);</span>
<span class="line-removed">4720   return _os_version &amp; 0x01000000 ? false : true;</span>
<span class="line-removed">4721 }</span>
<span class="line-removed">4722 </span>
4723 /////
4724 // glibc on Linux platform uses non-documented flag
4725 // to indicate, that some special sort of signal
4726 // trampoline is used.
4727 // We will never set this flag, and we should
4728 // ignore this flag in our diagnostic
4729 #ifdef SIGNIFICANT_SIGNAL_MASK
4730   #undef SIGNIFICANT_SIGNAL_MASK
4731 #endif
4732 #define SIGNIFICANT_SIGNAL_MASK (~0x04000000)
4733 
4734 static const char* get_signal_handler_name(address handler,
4735                                            char* buf, int buflen) {
4736   int offset = 0;
4737   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
4738   if (found) {
4739     // skip directory names
4740     const char *p1, *p2;
4741     p1 = buf;
4742     size_t len = strlen(os::file_separator());
4743     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
4744     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
4745   } else {
4746     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
4747   }
4748   return buf;
4749 }
4750 
4751 static void print_signal_handler(outputStream* st, int sig,
4752                                  char* buf, size_t buflen) {
4753   struct sigaction sa;
4754 
4755   sigaction(sig, NULL, &amp;sa);
4756 
4757   // See comment for SIGNIFICANT_SIGNAL_MASK define
4758   sa.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
4759 
4760   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
4761 
4762   address handler = (sa.sa_flags &amp; SA_SIGINFO)
4763     ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
4764     : CAST_FROM_FN_PTR(address, sa.sa_handler);
4765 
4766   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
4767     st-&gt;print(&quot;SIG_DFL&quot;);
4768   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
4769     st-&gt;print(&quot;SIG_IGN&quot;);
4770   } else {
4771     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
4772   }
4773 
4774   st-&gt;print(&quot;, sa_mask[0]=&quot;);
4775   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
4776 
4777   address rh = VMError::get_resetted_sighandler(sig);
4778   // May be, handler was resetted by VMError?
4779   if (rh != NULL) {
4780     handler = rh;
4781     sa.sa_flags = VMError::get_resetted_sigflags(sig) &amp; SIGNIFICANT_SIGNAL_MASK;
4782   }
4783 
4784   st-&gt;print(&quot;, sa_flags=&quot;);
4785   os::Posix::print_sa_flags(st, sa.sa_flags);
4786 
4787   // Check: is it our handler?
4788   if (handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler) ||
4789       handler == CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler)) {
4790     // It is our signal handler
4791     // check for flags, reset system-used one!
4792     if ((int)sa.sa_flags != os::Linux::get_our_sigflags(sig)) {
4793       st-&gt;print(
4794                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
4795                 os::Linux::get_our_sigflags(sig));
4796     }
4797   }
4798   st-&gt;cr();
4799 }
4800 
4801 
4802 #define DO_SIGNAL_CHECK(sig)                      \
4803   do {                                            \
4804     if (!sigismember(&amp;check_signal_done, sig)) {  \
4805       os::Linux::check_signal_handler(sig);       \
4806     }                                             \
4807   } while (0)
4808 
4809 // This method is a periodic task to check for misbehaving JNI applications
4810 // under CheckJNI, we can add any periodic checks here
4811 
4812 void os::run_periodic_checks() {
4813   if (check_signals == false) return;
4814 
4815   // SEGV and BUS if overridden could potentially prevent
4816   // generation of hs*.log in the event of a crash, debugging
4817   // such a case can be very challenging, so we absolutely
4818   // check the following for a good measure:
4819   DO_SIGNAL_CHECK(SIGSEGV);
4820   DO_SIGNAL_CHECK(SIGILL);
4821   DO_SIGNAL_CHECK(SIGFPE);
4822   DO_SIGNAL_CHECK(SIGBUS);
4823   DO_SIGNAL_CHECK(SIGPIPE);
4824   DO_SIGNAL_CHECK(SIGXFSZ);
4825 #if defined(PPC64)
4826   DO_SIGNAL_CHECK(SIGTRAP);
4827 #endif
4828 
4829   // ReduceSignalUsage allows the user to override these handlers
4830   // see comments at the very top and jvm_md.h
4831   if (!ReduceSignalUsage) {
4832     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
4833     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
4834     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
4835     DO_SIGNAL_CHECK(BREAK_SIGNAL);
4836   }
4837 
4838   DO_SIGNAL_CHECK(SR_signum);
4839 }
4840 
4841 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
4842 
4843 static os_sigaction_t os_sigaction = NULL;
4844 
4845 void os::Linux::check_signal_handler(int sig) {
4846   char buf[O_BUFLEN];
4847   address jvmHandler = NULL;
4848 
4849 
4850   struct sigaction act;
4851   if (os_sigaction == NULL) {
4852     // only trust the default sigaction, in case it has been interposed
4853     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
4854     if (os_sigaction == NULL) return;
4855   }
4856 
4857   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
4858 
4859 
4860   act.sa_flags &amp;= SIGNIFICANT_SIGNAL_MASK;
4861 
4862   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
4863     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
4864     : CAST_FROM_FN_PTR(address, act.sa_handler);
4865 
4866 
4867   switch (sig) {
4868   case SIGSEGV:
4869   case SIGBUS:
4870   case SIGFPE:
4871   case SIGPIPE:
4872   case SIGILL:
4873   case SIGXFSZ:
4874     jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)signalHandler);
4875     break;
4876 
4877   case SHUTDOWN1_SIGNAL:
4878   case SHUTDOWN2_SIGNAL:
4879   case SHUTDOWN3_SIGNAL:
4880   case BREAK_SIGNAL:
4881     jvmHandler = (address)user_handler();
4882     break;
4883 
4884   default:
4885     if (sig == SR_signum) {
4886       jvmHandler = CAST_FROM_FN_PTR(address, (sa_sigaction_t)SR_handler);
4887     } else {
4888       return;
4889     }
4890     break;
4891   }
4892 
4893   if (thisHandler != jvmHandler) {
4894     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
4895     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
4896     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
4897     // No need to check this sig any longer
4898     sigaddset(&amp;check_signal_done, sig);
4899     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
4900     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
4901       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
4902                     exception_name(sig, buf, O_BUFLEN));
4903     }
4904   } else if(os::Linux::get_our_sigflags(sig) != 0 &amp;&amp; (int)act.sa_flags != os::Linux::get_our_sigflags(sig)) {
4905     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
4906     tty-&gt;print(&quot;expected:&quot;);
4907     os::Posix::print_sa_flags(tty, os::Linux::get_our_sigflags(sig));
4908     tty-&gt;cr();
4909     tty-&gt;print(&quot;  found:&quot;);
4910     os::Posix::print_sa_flags(tty, act.sa_flags);
4911     tty-&gt;cr();
4912     // No need to check this sig any longer
4913     sigaddset(&amp;check_signal_done, sig);
4914   }
4915 
4916   // Dump all the signal
4917   if (sigismember(&amp;check_signal_done, sig)) {
4918     print_signal_handlers(tty, buf, O_BUFLEN);
4919   }
4920 }
4921 
4922 extern void report_error(char* file_name, int line_no, char* title,
4923                          char* format, ...);
4924 
4925 // this is called _before_ most of the global arguments have been parsed
4926 void os::init(void) {
4927   char dummy;   // used to get a guess on initial stack address
4928 
4929   clock_tics_per_sec = sysconf(_SC_CLK_TCK);
4930 
4931   init_random(1234567);
4932 
4933   Linux::set_page_size(sysconf(_SC_PAGESIZE));
4934   if (Linux::page_size() == -1) {
4935     fatal(&quot;os_linux.cpp: os::init: sysconf failed (%s)&quot;,
4936           os::strerror(errno));
4937   }
4938   init_page_sizes((size_t) Linux::page_size());
4939 
4940   Linux::initialize_system_info();
4941 
<a name="75" id="anc75"></a><span class="line-modified">4942   Linux::initialize_os_info();</span>







4943 
4944   // _main_thread points to the thread that created/loaded the JVM.
4945   Linux::_main_thread = pthread_self();
4946 
4947   // retrieve entry point for pthread_setname_np
4948   Linux::_pthread_setname_np =
4949     (int(*)(pthread_t, const char*))dlsym(RTLD_DEFAULT, &quot;pthread_setname_np&quot;);
4950 
4951   os::Posix::init();
4952 
4953   initial_time_count = javaTimeNanos();
4954 
4955   // Always warn if no monotonic clock available
4956   if (!os::Posix::supports_monotonic_clock()) {
4957     warning(&quot;No monotonic clock was available - timed services may &quot;    \
4958             &quot;be adversely affected if the time-of-day clock changes&quot;);
4959   }
4960 }
4961 
4962 // To install functions for atexit system call
4963 extern &quot;C&quot; {
4964   static void perfMemory_exit_helper() {
4965     perfMemory_exit();
4966   }
4967 }
4968 
4969 void os::pd_init_container_support() {
4970   OSContainer::init();
4971 }
4972 
4973 void os::Linux::numa_init() {
4974 
4975   // Java can be invoked as
4976   // 1. Without numactl and heap will be allocated/configured on all nodes as
4977   //    per the system policy.
4978   // 2. With numactl --interleave:
4979   //      Use numa_get_interleave_mask(v2) API to get nodes bitmask. The same
4980   //      API for membind case bitmask is reset.
4981   //      Interleave is only hint and Kernel can fallback to other nodes if
4982   //      no memory is available on the target nodes.
4983   // 3. With numactl --membind:
4984   //      Use numa_get_membind(v2) API to get nodes bitmask. The same API for
4985   //      interleave case returns bitmask of all nodes.
4986   // numa_all_nodes_ptr holds bitmask of all nodes.
4987   // numa_get_interleave_mask(v2) and numa_get_membind(v2) APIs returns correct
4988   // bitmask when externally configured to run on all or fewer nodes.
4989 
4990   if (!Linux::libnuma_init()) {
4991     UseNUMA = false;
4992   } else {
4993     if ((Linux::numa_max_node() &lt; 1) || Linux::is_bound_to_single_node()) {
4994       // If there&#39;s only one node (they start from 0) or if the process
4995       // is bound explicitly to a single node using membind, disable NUMA.
4996       UseNUMA = false;
4997     } else {
4998 
4999       LogTarget(Info,os) log;
5000       LogStream ls(log);
5001 
5002       Linux::set_configured_numa_policy(Linux::identify_numa_policy());
5003 
5004       struct bitmask* bmp = Linux::_numa_membind_bitmask;
5005       const char* numa_mode = &quot;membind&quot;;
5006 
5007       if (Linux::is_running_in_interleave_mode()) {
5008         bmp = Linux::_numa_interleave_bitmask;
5009         numa_mode = &quot;interleave&quot;;
5010       }
5011 
5012       ls.print(&quot;UseNUMA is enabled and invoked in &#39;%s&#39; mode.&quot;
5013                &quot; Heap will be configured using NUMA memory nodes:&quot;, numa_mode);
5014 
5015       for (int node = 0; node &lt;= Linux::numa_max_node(); node++) {
5016         if (Linux::_numa_bitmask_isbitset(bmp, node)) {
5017           ls.print(&quot; %d&quot;, node);
5018         }
5019       }
5020     }
5021   }
5022 
5023   if (UseParallelGC &amp;&amp; UseNUMA &amp;&amp; UseLargePages &amp;&amp; !can_commit_large_page_memory()) {
5024     // With SHM and HugeTLBFS large pages we cannot uncommit a page, so there&#39;s no way
5025     // we can make the adaptive lgrp chunk resizing work. If the user specified both
5026     // UseNUMA and UseLargePages (or UseSHM/UseHugeTLBFS) on the command line - warn
5027     // and disable adaptive resizing.
5028     if (UseAdaptiveSizePolicy || UseAdaptiveNUMAChunkSizing) {
5029       warning(&quot;UseNUMA is not fully compatible with SHM/HugeTLBFS large pages, &quot;
5030               &quot;disabling adaptive resizing (-XX:-UseAdaptiveSizePolicy -XX:-UseAdaptiveNUMAChunkSizing)&quot;);
5031       UseAdaptiveSizePolicy = false;
5032       UseAdaptiveNUMAChunkSizing = false;
5033     }
5034   }
5035 
5036   if (!UseNUMA &amp;&amp; ForceNUMA) {
5037     UseNUMA = true;
5038   }
5039 }
5040 
5041 // this is called _after_ the global arguments have been parsed
5042 jint os::init_2(void) {
5043 
5044   // This could be set after os::Posix::init() but all platforms
5045   // have to set it the same so we have to mirror Solaris.
5046   DEBUG_ONLY(os::set_mutex_init_done();)
5047 
5048   os::Posix::init_2();
5049 
5050   Linux::fast_thread_clock_init();
5051 
5052   // initialize suspend/resume support - must do this before signal_sets_init()
5053   if (SR_initialize() != 0) {
5054     perror(&quot;SR_initialize failed&quot;);
5055     return JNI_ERR;
5056   }
5057 
5058   Linux::signal_sets_init();
5059   Linux::install_signal_handlers();
5060   // Initialize data for jdk.internal.misc.Signal
5061   if (!ReduceSignalUsage) {
5062     jdk_misc_signal_init();
5063   }
5064 
<a name="76" id="anc76"></a>



5065   // Check and sets minimum stack sizes against command line options
5066   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
5067     return JNI_ERR;
5068   }
5069 
<a name="77" id="anc77"></a>





5070   suppress_primordial_thread_resolution = Arguments::created_by_java_launcher();
5071   if (!suppress_primordial_thread_resolution) {
5072     Linux::capture_initial_stack(JavaThread::stack_size_at_create());
5073   }
<a name="78" id="anc78"></a><span class="line-removed">5074 </span>
<span class="line-removed">5075 #if defined(IA32)</span>
<span class="line-removed">5076   workaround_expand_exec_shield_cs_limit();</span>
5077 #endif
5078 
5079   Linux::libpthread_init();
5080   Linux::sched_getcpu_init();
5081   log_info(os)(&quot;HotSpot is running with %s, %s&quot;,
5082                Linux::glibc_version(), Linux::libpthread_version());
5083 
5084   if (UseNUMA) {
5085     Linux::numa_init();
5086   }
5087 
5088   if (MaxFDLimit) {
5089     // set the number of file descriptors to max. print out error
5090     // if getrlimit/setrlimit fails but continue regardless.
5091     struct rlimit nbr_files;
5092     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
5093     if (status != 0) {
5094       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
5095     } else {
5096       nbr_files.rlim_cur = nbr_files.rlim_max;
5097       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
5098       if (status != 0) {
5099         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
5100       }
5101     }
5102   }
5103 
<a name="79" id="anc79"></a><span class="line-removed">5104   // Initialize lock used to serialize thread creation (see os::create_thread)</span>
<span class="line-removed">5105   Linux::set_createThread_lock(new Mutex(Mutex::leaf, &quot;createThread_lock&quot;, false));</span>
<span class="line-removed">5106 </span>
5107   // at-exit methods are called in the reverse order of their registration.
5108   // atexit functions are called on return from main or as a result of a
5109   // call to exit(3C). There can be only 32 of these functions registered
5110   // and atexit() does not set errno.
5111 
5112   if (PerfAllowAtExitRegistration) {
5113     // only register atexit functions if PerfAllowAtExitRegistration is set.
5114     // atexit functions can be delayed until process exit time, which
5115     // can be problematic for embedded VM situations. Embedded VMs should
5116     // call DestroyJavaVM() to assure that VM resources are released.
5117 
5118     // note: perfMemory_exit_helper atexit function may be removed in
5119     // the future if the appropriate cleanup code can be added to the
5120     // VM_Exit VMOperation&#39;s doit method.
5121     if (atexit(perfMemory_exit_helper) != 0) {
5122       warning(&quot;os::init_2 atexit(perfMemory_exit_helper) failed&quot;);
5123     }
5124   }
5125 
5126   // initialize thread priority policy
5127   prio_init();
5128 
5129   if (!FLAG_IS_DEFAULT(AllocateHeapAt) || !FLAG_IS_DEFAULT(AllocateOldGenAt)) {
5130     set_coredump_filter(DAX_SHARED_BIT);
5131   }
5132 
5133   if (DumpPrivateMappingsInCore) {
5134     set_coredump_filter(FILE_BACKED_PVT_BIT);
5135   }
5136 
5137   if (DumpSharedMappingsInCore) {
5138     set_coredump_filter(FILE_BACKED_SHARED_BIT);
5139   }
5140 
5141   return JNI_OK;
5142 }
5143 
5144 // Mark the polling page as unreadable
5145 void os::make_polling_page_unreadable(void) {
5146   if (!guard_memory((char*)_polling_page, Linux::page_size())) {
5147     fatal(&quot;Could not disable polling page&quot;);
5148   }
5149 }
5150 
5151 // Mark the polling page as readable
5152 void os::make_polling_page_readable(void) {
5153   if (!linux_mprotect((char *)_polling_page, Linux::page_size(), PROT_READ)) {
5154     fatal(&quot;Could not enable polling page&quot;);
5155   }
5156 }
5157 
5158 // older glibc versions don&#39;t have this macro (which expands to
5159 // an optimized bit-counting function) so we have to roll our own
5160 #ifndef CPU_COUNT
5161 
5162 static int _cpu_count(const cpu_set_t* cpus) {
5163   int count = 0;
5164   // only look up to the number of configured processors
5165   for (int i = 0; i &lt; os::processor_count(); i++) {
5166     if (CPU_ISSET(i, cpus)) {
5167       count++;
5168     }
5169   }
5170   return count;
5171 }
5172 
5173 #define CPU_COUNT(cpus) _cpu_count(cpus)
5174 
5175 #endif // CPU_COUNT
5176 
5177 // Get the current number of available processors for this process.
5178 // This value can change at any time during a process&#39;s lifetime.
5179 // sched_getaffinity gives an accurate answer as it accounts for cpusets.
5180 // If it appears there may be more than 1024 processors then we do a
5181 // dynamic check - see 6515172 for details.
5182 // If anything goes wrong we fallback to returning the number of online
5183 // processors - which can be greater than the number available to the process.
5184 int os::Linux::active_processor_count() {
5185   cpu_set_t cpus;  // can represent at most 1024 (CPU_SETSIZE) processors
5186   cpu_set_t* cpus_p = &amp;cpus;
5187   int cpus_size = sizeof(cpu_set_t);
5188 
5189   int configured_cpus = os::processor_count();  // upper bound on available cpus
5190   int cpu_count = 0;
5191 
5192 // old build platforms may not support dynamic cpu sets
5193 #ifdef CPU_ALLOC
5194 
5195   // To enable easy testing of the dynamic path on different platforms we
5196   // introduce a diagnostic flag: UseCpuAllocPath
5197   if (configured_cpus &gt;= CPU_SETSIZE || UseCpuAllocPath) {
5198     // kernel may use a mask bigger than cpu_set_t
5199     log_trace(os)(&quot;active_processor_count: using dynamic path %s&quot;
5200                   &quot;- configured processors: %d&quot;,
5201                   UseCpuAllocPath ? &quot;(forced) &quot; : &quot;&quot;,
5202                   configured_cpus);
5203     cpus_p = CPU_ALLOC(configured_cpus);
5204     if (cpus_p != NULL) {
5205       cpus_size = CPU_ALLOC_SIZE(configured_cpus);
5206       // zero it just to be safe
5207       CPU_ZERO_S(cpus_size, cpus_p);
5208     }
5209     else {
5210        // failed to allocate so fallback to online cpus
5211        int online_cpus = ::sysconf(_SC_NPROCESSORS_ONLN);
5212        log_trace(os)(&quot;active_processor_count: &quot;
5213                      &quot;CPU_ALLOC failed (%s) - using &quot;
5214                      &quot;online processor count: %d&quot;,
5215                      os::strerror(errno), online_cpus);
5216        return online_cpus;
5217     }
5218   }
5219   else {
5220     log_trace(os)(&quot;active_processor_count: using static path - configured processors: %d&quot;,
5221                   configured_cpus);
5222   }
5223 #else // CPU_ALLOC
5224 // these stubs won&#39;t be executed
5225 #define CPU_COUNT_S(size, cpus) -1
5226 #define CPU_FREE(cpus)
5227 
5228   log_trace(os)(&quot;active_processor_count: only static path available - configured processors: %d&quot;,
5229                 configured_cpus);
5230 #endif // CPU_ALLOC
5231 
5232   // pid 0 means the current thread - which we have to assume represents the process
5233   if (sched_getaffinity(0, cpus_size, cpus_p) == 0) {
5234     if (cpus_p != &amp;cpus) { // can only be true when CPU_ALLOC used
5235       cpu_count = CPU_COUNT_S(cpus_size, cpus_p);
5236     }
5237     else {
5238       cpu_count = CPU_COUNT(cpus_p);
5239     }
5240     log_trace(os)(&quot;active_processor_count: sched_getaffinity processor count: %d&quot;, cpu_count);
5241   }
5242   else {
5243     cpu_count = ::sysconf(_SC_NPROCESSORS_ONLN);
5244     warning(&quot;sched_getaffinity failed (%s)- using online processor count (%d) &quot;
5245             &quot;which may exceed available processors&quot;, os::strerror(errno), cpu_count);
5246   }
5247 
5248   if (cpus_p != &amp;cpus) { // can only be true when CPU_ALLOC used
5249     CPU_FREE(cpus_p);
5250   }
5251 
5252   assert(cpu_count &gt; 0 &amp;&amp; cpu_count &lt;= os::processor_count(), &quot;sanity check&quot;);
5253   return cpu_count;
5254 }
5255 
5256 // Determine the active processor count from one of
5257 // three different sources:
5258 //
5259 // 1. User option -XX:ActiveProcessorCount
5260 // 2. kernel os calls (sched_getaffinity or sysconf(_SC_NPROCESSORS_ONLN)
5261 // 3. extracted from cgroup cpu subsystem (shares and quotas)
5262 //
5263 // Option 1, if specified, will always override.
5264 // If the cgroup subsystem is active and configured, we
5265 // will return the min of the cgroup and option 2 results.
5266 // This is required since tools, such as numactl, that
5267 // alter cpu affinity do not update cgroup subsystem
5268 // cpuset configuration files.
5269 int os::active_processor_count() {
5270   // User has overridden the number of active processors
5271   if (ActiveProcessorCount &gt; 0) {
5272     log_trace(os)(&quot;active_processor_count: &quot;
5273                   &quot;active processor count set by user : %d&quot;,
5274                   ActiveProcessorCount);
5275     return ActiveProcessorCount;
5276   }
5277 
5278   int active_cpus;
5279   if (OSContainer::is_containerized()) {
5280     active_cpus = OSContainer::active_processor_count();
5281     log_trace(os)(&quot;active_processor_count: determined by OSContainer: %d&quot;,
5282                    active_cpus);
5283   } else {
5284     active_cpus = os::Linux::active_processor_count();
5285   }
5286 
5287   return active_cpus;
5288 }
5289 
5290 uint os::processor_id() {
5291   const int id = Linux::sched_getcpu();
5292   assert(id &gt;= 0 &amp;&amp; id &lt; _processor_count, &quot;Invalid processor id&quot;);
5293   return (uint)id;
5294 }
5295 
5296 void os::set_native_thread_name(const char *name) {
5297   if (Linux::_pthread_setname_np) {
5298     char buf [16]; // according to glibc manpage, 16 chars incl. &#39;/0&#39;
5299     snprintf(buf, sizeof(buf), &quot;%s&quot;, name);
5300     buf[sizeof(buf) - 1] = &#39;\0&#39;;
5301     const int rc = Linux::_pthread_setname_np(pthread_self(), buf);
5302     // ERANGE should not happen; all other errors should just be ignored.
5303     assert(rc != ERANGE, &quot;pthread_setname_np failed&quot;);
5304   }
5305 }
5306 
<a name="80" id="anc80"></a><span class="line-removed">5307 bool os::distribute_processes(uint length, uint* distribution) {</span>
<span class="line-removed">5308   // Not yet implemented.</span>
<span class="line-removed">5309   return false;</span>
<span class="line-removed">5310 }</span>
<span class="line-removed">5311 </span>
5312 bool os::bind_to_processor(uint processor_id) {
5313   // Not yet implemented.
5314   return false;
5315 }
5316 
5317 ///
5318 
5319 void os::SuspendedThreadTask::internal_do_task() {
5320   if (do_suspend(_thread-&gt;osthread())) {
5321     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
5322     do_task(context);
5323     do_resume(_thread-&gt;osthread());
5324   }
5325 }
5326 
5327 ////////////////////////////////////////////////////////////////////////////////
5328 // debug support
5329 
5330 bool os::find(address addr, outputStream* st) {
5331   Dl_info dlinfo;
5332   memset(&amp;dlinfo, 0, sizeof(dlinfo));
5333   if (dladdr(addr, &amp;dlinfo) != 0) {
5334     st-&gt;print(PTR_FORMAT &quot;: &quot;, p2i(addr));
5335     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
5336       st-&gt;print(&quot;%s+&quot; PTR_FORMAT, dlinfo.dli_sname,
5337                 p2i(addr) - p2i(dlinfo.dli_saddr));
5338     } else if (dlinfo.dli_fbase != NULL) {
5339       st-&gt;print(&quot;&lt;offset &quot; PTR_FORMAT &quot;&gt;&quot;, p2i(addr) - p2i(dlinfo.dli_fbase));
5340     } else {
5341       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
5342     }
5343     if (dlinfo.dli_fname != NULL) {
5344       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
5345     }
5346     if (dlinfo.dli_fbase != NULL) {
5347       st-&gt;print(&quot; at &quot; PTR_FORMAT, p2i(dlinfo.dli_fbase));
5348     }
5349     st-&gt;cr();
5350 
5351     if (Verbose) {
5352       // decode some bytes around the PC
5353       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
5354       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
5355       address       lowest = (address) dlinfo.dli_sname;
5356       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
5357       if (begin &lt; lowest)  begin = lowest;
5358       Dl_info dlinfo2;
5359       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
5360           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
5361         end = (address) dlinfo2.dli_saddr;
5362       }
5363       Disassembler::decode(begin, end, st);
5364     }
5365     return true;
5366   }
5367   return false;
5368 }
5369 
5370 ////////////////////////////////////////////////////////////////////////////////
5371 // misc
5372 
5373 // This does not do anything on Linux. This is basically a hook for being
5374 // able to use structured exception handling (thread-local exception filters)
5375 // on, e.g., Win32.
5376 void
5377 os::os_exception_wrapper(java_call_t f, JavaValue* value, const methodHandle&amp; method,
5378                          JavaCallArguments* args, Thread* thread) {
5379   f(value, method, args, thread);
5380 }
5381 
5382 void os::print_statistics() {
5383 }
5384 
5385 bool os::message_box(const char* title, const char* message) {
5386   int i;
5387   fdStream err(defaultStream::error_fd());
5388   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
5389   err.cr();
5390   err.print_raw_cr(title);
5391   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
5392   err.cr();
5393   err.print_raw_cr(message);
5394   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
5395   err.cr();
5396 
5397   char buf[16];
5398   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
5399   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
5400 
5401   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
5402 }
5403 
5404 // Is a (classpath) directory empty?
5405 bool os::dir_is_empty(const char* path) {
5406   DIR *dir = NULL;
5407   struct dirent *ptr;
5408 
5409   dir = opendir(path);
5410   if (dir == NULL) return true;
5411 
5412   // Scan the directory
5413   bool result = true;
5414   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
5415     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
5416       result = false;
5417     }
5418   }
5419   closedir(dir);
5420   return result;
5421 }
5422 
5423 // This code originates from JDK&#39;s sysOpen and open64_w
5424 // from src/solaris/hpi/src/system_md.c
5425 
5426 int os::open(const char *path, int oflag, int mode) {
5427   if (strlen(path) &gt; MAX_PATH - 1) {
5428     errno = ENAMETOOLONG;
5429     return -1;
5430   }
5431 
5432   // All file descriptors that are opened in the Java process and not
5433   // specifically destined for a subprocess should have the close-on-exec
5434   // flag set.  If we don&#39;t set it, then careless 3rd party native code
5435   // might fork and exec without closing all appropriate file descriptors
5436   // (e.g. as we do in closeDescriptors in UNIXProcess.c), and this in
5437   // turn might:
5438   //
5439   // - cause end-of-file to fail to be detected on some file
5440   //   descriptors, resulting in mysterious hangs, or
5441   //
5442   // - might cause an fopen in the subprocess to fail on a system
5443   //   suffering from bug 1085341.
5444   //
5445   // (Yes, the default setting of the close-on-exec flag is a Unix
5446   // design flaw)
5447   //
5448   // See:
5449   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
5450   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
5451   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
5452   //
5453   // Modern Linux kernels (after 2.6.23 2007) support O_CLOEXEC with open().
5454   // O_CLOEXEC is preferable to using FD_CLOEXEC on an open file descriptor
5455   // because it saves a system call and removes a small window where the flag
5456   // is unset.  On ancient Linux kernels the O_CLOEXEC flag will be ignored
5457   // and we fall back to using FD_CLOEXEC (see below).
5458 #ifdef O_CLOEXEC
5459   oflag |= O_CLOEXEC;
5460 #endif
5461 
5462   int fd = ::open64(path, oflag, mode);
5463   if (fd == -1) return -1;
5464 
5465   //If the open succeeded, the file might still be a directory
5466   {
5467     struct stat64 buf64;
5468     int ret = ::fstat64(fd, &amp;buf64);
5469     int st_mode = buf64.st_mode;
5470 
5471     if (ret != -1) {
5472       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
5473         errno = EISDIR;
5474         ::close(fd);
5475         return -1;
5476       }
5477     } else {
5478       ::close(fd);
5479       return -1;
5480     }
5481   }
5482 
5483 #ifdef FD_CLOEXEC
5484   // Validate that the use of the O_CLOEXEC flag on open above worked.
5485   // With recent kernels, we will perform this check exactly once.
5486   static sig_atomic_t O_CLOEXEC_is_known_to_work = 0;
5487   if (!O_CLOEXEC_is_known_to_work) {
5488     int flags = ::fcntl(fd, F_GETFD);
5489     if (flags != -1) {
5490       if ((flags &amp; FD_CLOEXEC) != 0)
5491         O_CLOEXEC_is_known_to_work = 1;
5492       else
5493         ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
5494     }
5495   }
5496 #endif
5497 
5498   return fd;
5499 }
5500 
5501 
5502 // create binary file, rewriting existing file if required
5503 int os::create_binary_file(const char* path, bool rewrite_existing) {
5504   int oflags = O_WRONLY | O_CREAT;
5505   if (!rewrite_existing) {
5506     oflags |= O_EXCL;
5507   }
5508   return ::open64(path, oflags, S_IREAD | S_IWRITE);
5509 }
5510 
5511 // return current position of file pointer
5512 jlong os::current_file_offset(int fd) {
5513   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
5514 }
5515 
5516 // move file pointer to the specified offset
5517 jlong os::seek_to_file_offset(int fd, jlong offset) {
5518   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
5519 }
5520 
5521 // This code originates from JDK&#39;s sysAvailable
5522 // from src/solaris/hpi/src/native_threads/src/sys_api_td.c
5523 
5524 int os::available(int fd, jlong *bytes) {
5525   jlong cur, end;
5526   int mode;
5527   struct stat64 buf64;
5528 
5529   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
5530     mode = buf64.st_mode;
5531     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
5532       int n;
5533       if (::ioctl(fd, FIONREAD, &amp;n) &gt;= 0) {
5534         *bytes = n;
5535         return 1;
5536       }
5537     }
5538   }
5539   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
5540     return 0;
5541   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
5542     return 0;
5543   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
5544     return 0;
5545   }
5546   *bytes = end - cur;
5547   return 1;
5548 }
5549 
5550 // Map a block of memory.
5551 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
5552                         char *addr, size_t bytes, bool read_only,
5553                         bool allow_exec) {
5554   int prot;
5555   int flags = MAP_PRIVATE;
5556 
5557   if (read_only) {
5558     prot = PROT_READ;
5559   } else {
5560     prot = PROT_READ | PROT_WRITE;
5561   }
5562 
5563   if (allow_exec) {
5564     prot |= PROT_EXEC;
5565   }
5566 
5567   if (addr != NULL) {
5568     flags |= MAP_FIXED;
5569   }
5570 
5571   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
5572                                      fd, file_offset);
5573   if (mapped_address == MAP_FAILED) {
5574     return NULL;
5575   }
5576   return mapped_address;
5577 }
5578 
5579 
5580 // Remap a block of memory.
5581 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
5582                           char *addr, size_t bytes, bool read_only,
5583                           bool allow_exec) {
5584   // same as map_memory() on this OS
5585   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
5586                         allow_exec);
5587 }
5588 
5589 
5590 // Unmap a block of memory.
5591 bool os::pd_unmap_memory(char* addr, size_t bytes) {
5592   return munmap(addr, bytes) == 0;
5593 }
5594 
5595 static jlong slow_thread_cpu_time(Thread *thread, bool user_sys_cpu_time);
5596 
5597 static jlong fast_cpu_time(Thread *thread) {
5598     clockid_t clockid;
5599     int rc = os::Linux::pthread_getcpuclockid(thread-&gt;osthread()-&gt;pthread_id(),
5600                                               &amp;clockid);
5601     if (rc == 0) {
5602       return os::Linux::fast_thread_cpu_time(clockid);
5603     } else {
5604       // It&#39;s possible to encounter a terminated native thread that failed
5605       // to detach itself from the VM - which should result in ESRCH.
5606       assert_status(rc == ESRCH, rc, &quot;pthread_getcpuclockid failed&quot;);
5607       return -1;
5608     }
5609 }
5610 
5611 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
5612 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
5613 // of a thread.
5614 //
5615 // current_thread_cpu_time() and thread_cpu_time(Thread*) returns
5616 // the fast estimate available on the platform.
5617 
5618 jlong os::current_thread_cpu_time() {
5619   if (os::Linux::supports_fast_thread_cpu_time()) {
5620     return os::Linux::fast_thread_cpu_time(CLOCK_THREAD_CPUTIME_ID);
5621   } else {
5622     // return user + sys since the cost is the same
5623     return slow_thread_cpu_time(Thread::current(), true /* user + sys */);
5624   }
5625 }
5626 
5627 jlong os::thread_cpu_time(Thread* thread) {
5628   // consistent with what current_thread_cpu_time() returns
5629   if (os::Linux::supports_fast_thread_cpu_time()) {
5630     return fast_cpu_time(thread);
5631   } else {
5632     return slow_thread_cpu_time(thread, true /* user + sys */);
5633   }
5634 }
5635 
5636 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
5637   if (user_sys_cpu_time &amp;&amp; os::Linux::supports_fast_thread_cpu_time()) {
5638     return os::Linux::fast_thread_cpu_time(CLOCK_THREAD_CPUTIME_ID);
5639   } else {
5640     return slow_thread_cpu_time(Thread::current(), user_sys_cpu_time);
5641   }
5642 }
5643 
5644 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
5645   if (user_sys_cpu_time &amp;&amp; os::Linux::supports_fast_thread_cpu_time()) {
5646     return fast_cpu_time(thread);
5647   } else {
5648     return slow_thread_cpu_time(thread, user_sys_cpu_time);
5649   }
5650 }
5651 
5652 //  -1 on error.
5653 static jlong slow_thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
5654   pid_t  tid = thread-&gt;osthread()-&gt;thread_id();
5655   char *s;
5656   char stat[2048];
5657   int statlen;
5658   char proc_name[64];
5659   int count;
5660   long sys_time, user_time;
5661   char cdummy;
5662   int idummy;
5663   long ldummy;
5664   FILE *fp;
5665 
5666   snprintf(proc_name, 64, &quot;/proc/self/task/%d/stat&quot;, tid);
5667   fp = fopen(proc_name, &quot;r&quot;);
5668   if (fp == NULL) return -1;
5669   statlen = fread(stat, 1, 2047, fp);
5670   stat[statlen] = &#39;\0&#39;;
5671   fclose(fp);
5672 
5673   // Skip pid and the command string. Note that we could be dealing with
5674   // weird command names, e.g. user could decide to rename java launcher
5675   // to &quot;java 1.4.2 :)&quot;, then the stat file would look like
5676   //                1234 (java 1.4.2 :)) R ... ...
5677   // We don&#39;t really need to know the command string, just find the last
5678   // occurrence of &quot;)&quot; and then start parsing from there. See bug 4726580.
5679   s = strrchr(stat, &#39;)&#39;);
5680   if (s == NULL) return -1;
5681 
5682   // Skip blank chars
5683   do { s++; } while (s &amp;&amp; isspace(*s));
5684 
5685   count = sscanf(s,&quot;%c %d %d %d %d %d %lu %lu %lu %lu %lu %lu %lu&quot;,
5686                  &amp;cdummy, &amp;idummy, &amp;idummy, &amp;idummy, &amp;idummy, &amp;idummy,
5687                  &amp;ldummy, &amp;ldummy, &amp;ldummy, &amp;ldummy, &amp;ldummy,
5688                  &amp;user_time, &amp;sys_time);
5689   if (count != 13) return -1;
5690   if (user_sys_cpu_time) {
5691     return ((jlong)sys_time + (jlong)user_time) * (1000000000 / clock_tics_per_sec);
5692   } else {
5693     return (jlong)user_time * (1000000000 / clock_tics_per_sec);
5694   }
5695 }
5696 
5697 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
5698   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
5699   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
5700   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
5701   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
5702 }
5703 
5704 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
5705   info_ptr-&gt;max_value = ALL_64_BITS;       // will not wrap in less than 64 bits
5706   info_ptr-&gt;may_skip_backward = false;     // elapsed time not wall time
5707   info_ptr-&gt;may_skip_forward = false;      // elapsed time not wall time
5708   info_ptr-&gt;kind = JVMTI_TIMER_TOTAL_CPU;  // user+system time is returned
5709 }
5710 
5711 bool os::is_thread_cpu_time_supported() {
5712   return true;
5713 }
5714 
5715 // System loadavg support.  Returns -1 if load average cannot be obtained.
5716 // Linux doesn&#39;t yet have a (official) notion of processor sets,
5717 // so just return the system wide load average.
5718 int os::loadavg(double loadavg[], int nelem) {
5719   return ::getloadavg(loadavg, nelem);
5720 }
5721 
5722 void os::pause() {
5723   char filename[MAX_PATH];
5724   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
5725     jio_snprintf(filename, MAX_PATH, &quot;%s&quot;, PauseAtStartupFile);
5726   } else {
5727     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
5728   }
5729 
5730   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
5731   if (fd != -1) {
5732     struct stat buf;
5733     ::close(fd);
5734     while (::stat(filename, &amp;buf) == 0) {
5735       (void)::poll(NULL, 0, 100);
5736     }
5737   } else {
5738     jio_fprintf(stderr,
5739                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
5740   }
5741 }
5742 
5743 extern char** environ;
5744 
5745 // Run the specified command in a separate process. Return its exit value,
5746 // or -1 on failure (e.g. can&#39;t fork a new process).
5747 // Unlike system(), this function can be called from signal handler. It
5748 // doesn&#39;t block SIGINT et al.
5749 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
5750   const char * argv[4] = {&quot;sh&quot;, &quot;-c&quot;, cmd, NULL};
5751 
5752   pid_t pid ;
5753 
5754   if (use_vfork_if_available) {
5755     pid = vfork();
5756   } else {
5757     pid = fork();
5758   }
5759 
5760   if (pid &lt; 0) {
5761     // fork failed
5762     return -1;
5763 
5764   } else if (pid == 0) {
5765     // child process
5766 
5767     execve(&quot;/bin/sh&quot;, (char* const*)argv, environ);
5768 
5769     // execve failed
5770     _exit(-1);
5771 
5772   } else  {
5773     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
5774     // care about the actual exit code, for now.
5775 
5776     int status;
5777 
5778     // Wait for the child process to exit.  This returns immediately if
5779     // the child has already exited. */
5780     while (waitpid(pid, &amp;status, 0) &lt; 0) {
5781       switch (errno) {
5782       case ECHILD: return 0;
5783       case EINTR: break;
5784       default: return -1;
5785       }
5786     }
5787 
5788     if (WIFEXITED(status)) {
5789       // The child exited normally; get its exit code.
5790       return WEXITSTATUS(status);
5791     } else if (WIFSIGNALED(status)) {
5792       // The child exited because of a signal
5793       // The best value to return is 0x80 + signal number,
5794       // because that is what all Unix shells do, and because
5795       // it allows callers to distinguish between process exit and
5796       // process death by signal.
5797       return 0x80 + WTERMSIG(status);
5798     } else {
5799       // Unknown exit code; pass it through
5800       return status;
5801     }
5802   }
5803 }
5804 
5805 // Get the default path to the core file
5806 // Returns the length of the string
5807 int os::get_core_path(char* buffer, size_t bufferSize) {
5808   /*
5809    * Max length of /proc/sys/kernel/core_pattern is 128 characters.
5810    * See https://www.kernel.org/doc/Documentation/sysctl/kernel.txt
5811    */
5812   const int core_pattern_len = 129;
5813   char core_pattern[core_pattern_len] = {0};
5814 
5815   int core_pattern_file = ::open(&quot;/proc/sys/kernel/core_pattern&quot;, O_RDONLY);
5816   if (core_pattern_file == -1) {
5817     return -1;
5818   }
5819 
5820   ssize_t ret = ::read(core_pattern_file, core_pattern, core_pattern_len);
5821   ::close(core_pattern_file);
5822   if (ret &lt;= 0 || ret &gt;= core_pattern_len || core_pattern[0] == &#39;\n&#39;) {
5823     return -1;
5824   }
5825   if (core_pattern[ret-1] == &#39;\n&#39;) {
5826     core_pattern[ret-1] = &#39;\0&#39;;
5827   } else {
5828     core_pattern[ret] = &#39;\0&#39;;
5829   }
5830 
5831   // Replace the %p in the core pattern with the process id. NOTE: we do this
5832   // only if the pattern doesn&#39;t start with &quot;|&quot;, and we support only one %p in
5833   // the pattern.
5834   char *pid_pos = strstr(core_pattern, &quot;%p&quot;);
5835   const char* tail = (pid_pos != NULL) ? (pid_pos + 2) : &quot;&quot;;  // skip over the &quot;%p&quot;
5836   int written;
5837 
5838   if (core_pattern[0] == &#39;/&#39;) {
5839     if (pid_pos != NULL) {
5840       *pid_pos = &#39;\0&#39;;
5841       written = jio_snprintf(buffer, bufferSize, &quot;%s%d%s&quot;, core_pattern,
5842                              current_process_id(), tail);
5843     } else {
5844       written = jio_snprintf(buffer, bufferSize, &quot;%s&quot;, core_pattern);
5845     }
5846   } else {
5847     char cwd[PATH_MAX];
5848 
5849     const char* p = get_current_directory(cwd, PATH_MAX);
5850     if (p == NULL) {
5851       return -1;
5852     }
5853 
5854     if (core_pattern[0] == &#39;|&#39;) {
5855       written = jio_snprintf(buffer, bufferSize,
5856                              &quot;\&quot;%s\&quot; (or dumping to %s/core.%d)&quot;,
5857                              &amp;core_pattern[1], p, current_process_id());
5858     } else if (pid_pos != NULL) {
5859       *pid_pos = &#39;\0&#39;;
5860       written = jio_snprintf(buffer, bufferSize, &quot;%s/%s%d%s&quot;, p, core_pattern,
5861                              current_process_id(), tail);
5862     } else {
5863       written = jio_snprintf(buffer, bufferSize, &quot;%s/%s&quot;, p, core_pattern);
5864     }
5865   }
5866 
5867   if (written &lt; 0) {
5868     return -1;
5869   }
5870 
5871   if (((size_t)written &lt; bufferSize) &amp;&amp; (pid_pos == NULL) &amp;&amp; (core_pattern[0] != &#39;|&#39;)) {
5872     int core_uses_pid_file = ::open(&quot;/proc/sys/kernel/core_uses_pid&quot;, O_RDONLY);
5873 
5874     if (core_uses_pid_file != -1) {
5875       char core_uses_pid = 0;
5876       ssize_t ret = ::read(core_uses_pid_file, &amp;core_uses_pid, 1);
5877       ::close(core_uses_pid_file);
5878 
5879       if (core_uses_pid == &#39;1&#39;) {
5880         jio_snprintf(buffer + written, bufferSize - written,
5881                                           &quot;.%d&quot;, current_process_id());
5882       }
5883     }
5884   }
5885 
5886   return strlen(buffer);
5887 }
5888 
5889 bool os::start_debugging(char *buf, int buflen) {
5890   int len = (int)strlen(buf);
5891   char *p = &amp;buf[len];
5892 
5893   jio_snprintf(p, buflen-len,
5894                &quot;\n\n&quot;
5895                &quot;Do you want to debug the problem?\n\n&quot;
5896                &quot;To debug, run &#39;gdb /proc/%d/exe %d&#39;; then switch to thread &quot; UINTX_FORMAT &quot; (&quot; INTPTR_FORMAT &quot;)\n&quot;
5897                &quot;Enter &#39;yes&#39; to launch gdb automatically (PATH must include gdb)\n&quot;
5898                &quot;Otherwise, press RETURN to abort...&quot;,
5899                os::current_process_id(), os::current_process_id(),
5900                os::current_thread_id(), os::current_thread_id());
5901 
5902   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
5903 
5904   if (yes) {
5905     // yes, user asked VM to launch debugger
5906     jio_snprintf(buf, sizeof(char)*buflen, &quot;gdb /proc/%d/exe %d&quot;,
5907                  os::current_process_id(), os::current_process_id());
5908 
5909     os::fork_and_exec(buf);
5910     yes = false;
5911   }
5912   return yes;
5913 }
5914 
5915 
5916 // Java/Compiler thread:
5917 //
5918 //   Low memory addresses
5919 // P0 +------------------------+
5920 //    |                        |\  Java thread created by VM does not have glibc
5921 //    |    glibc guard page    | - guard page, attached Java thread usually has
5922 //    |                        |/  1 glibc guard page.
5923 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
5924 //    |                        |\
5925 //    |  HotSpot Guard Pages   | - red, yellow and reserved pages
5926 //    |                        |/
5927 //    +------------------------+ JavaThread::stack_reserved_zone_base()
5928 //    |                        |\
5929 //    |      Normal Stack      | -
5930 //    |                        |/
5931 // P2 +------------------------+ Thread::stack_base()
5932 //
5933 // Non-Java thread:
5934 //
5935 //   Low memory addresses
5936 // P0 +------------------------+
5937 //    |                        |\
5938 //    |  glibc guard page      | - usually 1 page
5939 //    |                        |/
5940 // P1 +------------------------+ Thread::stack_base() - Thread::stack_size()
5941 //    |                        |\
5942 //    |      Normal Stack      | -
5943 //    |                        |/
5944 // P2 +------------------------+ Thread::stack_base()
5945 //
5946 // ** P1 (aka bottom) and size (P2 = P1 - size) are the address and stack size
5947 //    returned from pthread_attr_getstack().
5948 // ** Due to NPTL implementation error, linux takes the glibc guard page out
5949 //    of the stack size given in pthread_attr. We work around this for
5950 //    threads created by the VM. (We adapt bottom to be P1 and size accordingly.)
5951 //
5952 #ifndef ZERO
5953 static void current_stack_region(address * bottom, size_t * size) {
5954   if (os::is_primordial_thread()) {
5955     // primordial thread needs special handling because pthread_getattr_np()
5956     // may return bogus value.
5957     *bottom = os::Linux::initial_thread_stack_bottom();
5958     *size   = os::Linux::initial_thread_stack_size();
5959   } else {
5960     pthread_attr_t attr;
5961 
5962     int rslt = pthread_getattr_np(pthread_self(), &amp;attr);
5963 
5964     // JVM needs to know exact stack location, abort if it fails
5965     if (rslt != 0) {
5966       if (rslt == ENOMEM) {
5967         vm_exit_out_of_memory(0, OOM_MMAP_ERROR, &quot;pthread_getattr_np&quot;);
5968       } else {
5969         fatal(&quot;pthread_getattr_np failed with error = %d&quot;, rslt);
5970       }
5971     }
5972 
5973     if (pthread_attr_getstack(&amp;attr, (void **)bottom, size) != 0) {
5974       fatal(&quot;Cannot locate current stack attributes!&quot;);
5975     }
5976 
5977     // Work around NPTL stack guard error.
5978     size_t guard_size = 0;
5979     rslt = pthread_attr_getguardsize(&amp;attr, &amp;guard_size);
5980     if (rslt != 0) {
5981       fatal(&quot;pthread_attr_getguardsize failed with error = %d&quot;, rslt);
5982     }
5983     *bottom += guard_size;
5984     *size   -= guard_size;
5985 
5986     pthread_attr_destroy(&amp;attr);
5987 
5988   }
5989   assert(os::current_stack_pointer() &gt;= *bottom &amp;&amp;
5990          os::current_stack_pointer() &lt; *bottom + *size, &quot;just checking&quot;);
5991 }
5992 
5993 address os::current_stack_base() {
5994   address bottom;
5995   size_t size;
5996   current_stack_region(&amp;bottom, &amp;size);
5997   return (bottom + size);
5998 }
5999 
6000 size_t os::current_stack_size() {
6001   // This stack size includes the usable stack and HotSpot guard pages
6002   // (for the threads that have Hotspot guard pages).
6003   address bottom;
6004   size_t size;
6005   current_stack_region(&amp;bottom, &amp;size);
6006   return size;
6007 }
6008 #endif
6009 
6010 static inline struct timespec get_mtime(const char* filename) {
6011   struct stat st;
6012   int ret = os::stat(filename, &amp;st);
6013   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
6014   return st.st_mtim;
6015 }
6016 
6017 int os::compare_file_modified_times(const char* file1, const char* file2) {
6018   struct timespec filetime1 = get_mtime(file1);
6019   struct timespec filetime2 = get_mtime(file2);
6020   int diff = filetime1.tv_sec - filetime2.tv_sec;
6021   if (diff == 0) {
6022     return filetime1.tv_nsec - filetime2.tv_nsec;
6023   }
6024   return diff;
6025 }
6026 
<a name="81" id="anc81"></a>



6027 /////////////// Unit tests ///////////////
6028 
6029 #ifndef PRODUCT
6030 
6031 class TestReserveMemorySpecial : AllStatic {
6032  public:
6033   static void small_page_write(void* addr, size_t size) {
6034     size_t page_size = os::vm_page_size();
6035 
6036     char* end = (char*)addr + size;
6037     for (char* p = (char*)addr; p &lt; end; p += page_size) {
6038       *p = 1;
6039     }
6040   }
6041 
6042   static void test_reserve_memory_special_huge_tlbfs_only(size_t size) {
6043     if (!UseHugeTLBFS) {
6044       return;
6045     }
6046 
6047     char* addr = os::Linux::reserve_memory_special_huge_tlbfs_only(size, NULL, false);
6048 
6049     if (addr != NULL) {
6050       small_page_write(addr, size);
6051 
6052       os::Linux::release_memory_special_huge_tlbfs(addr, size);
6053     }
6054   }
6055 
6056   static void test_reserve_memory_special_huge_tlbfs_only() {
6057     if (!UseHugeTLBFS) {
6058       return;
6059     }
6060 
6061     size_t lp = os::large_page_size();
6062 
6063     for (size_t size = lp; size &lt;= lp * 10; size += lp) {
6064       test_reserve_memory_special_huge_tlbfs_only(size);
6065     }
6066   }
6067 
6068   static void test_reserve_memory_special_huge_tlbfs_mixed() {
6069     size_t lp = os::large_page_size();
6070     size_t ag = os::vm_allocation_granularity();
6071 
6072     // sizes to test
6073     const size_t sizes[] = {
6074       lp, lp + ag, lp + lp / 2, lp * 2,
6075       lp * 2 + ag, lp * 2 - ag, lp * 2 + lp / 2,
6076       lp * 10, lp * 10 + lp / 2
6077     };
6078     const int num_sizes = sizeof(sizes) / sizeof(size_t);
6079 
6080     // For each size/alignment combination, we test three scenarios:
6081     // 1) with req_addr == NULL
6082     // 2) with a non-null req_addr at which we expect to successfully allocate
6083     // 3) with a non-null req_addr which contains a pre-existing mapping, at which we
6084     //    expect the allocation to either fail or to ignore req_addr
6085 
6086     // Pre-allocate two areas; they shall be as large as the largest allocation
6087     //  and aligned to the largest alignment we will be testing.
6088     const size_t mapping_size = sizes[num_sizes - 1] * 2;
6089     char* const mapping1 = (char*) ::mmap(NULL, mapping_size,
6090       PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
6091       -1, 0);
6092     assert(mapping1 != MAP_FAILED, &quot;should work&quot;);
6093 
6094     char* const mapping2 = (char*) ::mmap(NULL, mapping_size,
6095       PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE,
6096       -1, 0);
6097     assert(mapping2 != MAP_FAILED, &quot;should work&quot;);
6098 
6099     // Unmap the first mapping, but leave the second mapping intact: the first
6100     // mapping will serve as a value for a &quot;good&quot; req_addr (case 2). The second
6101     // mapping, still intact, as &quot;bad&quot; req_addr (case 3).
6102     ::munmap(mapping1, mapping_size);
6103 
6104     // Case 1
6105     for (int i = 0; i &lt; num_sizes; i++) {
6106       const size_t size = sizes[i];
6107       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6108         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, NULL, false);
6109         if (p != NULL) {
6110           assert(is_aligned(p, alignment), &quot;must be&quot;);
6111           small_page_write(p, size);
6112           os::Linux::release_memory_special_huge_tlbfs(p, size);
6113         }
6114       }
6115     }
6116 
6117     // Case 2
6118     for (int i = 0; i &lt; num_sizes; i++) {
6119       const size_t size = sizes[i];
6120       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6121         char* const req_addr = align_up(mapping1, alignment);
6122         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, req_addr, false);
6123         if (p != NULL) {
6124           assert(p == req_addr, &quot;must be&quot;);
6125           small_page_write(p, size);
6126           os::Linux::release_memory_special_huge_tlbfs(p, size);
6127         }
6128       }
6129     }
6130 
6131     // Case 3
6132     for (int i = 0; i &lt; num_sizes; i++) {
6133       const size_t size = sizes[i];
6134       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6135         char* const req_addr = align_up(mapping2, alignment);
6136         char* p = os::Linux::reserve_memory_special_huge_tlbfs_mixed(size, alignment, req_addr, false);
6137         // as the area around req_addr contains already existing mappings, the API should always
6138         // return NULL (as per contract, it cannot return another address)
6139         assert(p == NULL, &quot;must be&quot;);
6140       }
6141     }
6142 
6143     ::munmap(mapping2, mapping_size);
6144 
6145   }
6146 
6147   static void test_reserve_memory_special_huge_tlbfs() {
6148     if (!UseHugeTLBFS) {
6149       return;
6150     }
6151 
6152     test_reserve_memory_special_huge_tlbfs_only();
6153     test_reserve_memory_special_huge_tlbfs_mixed();
6154   }
6155 
6156   static void test_reserve_memory_special_shm(size_t size, size_t alignment) {
6157     if (!UseSHM) {
6158       return;
6159     }
6160 
6161     char* addr = os::Linux::reserve_memory_special_shm(size, alignment, NULL, false);
6162 
6163     if (addr != NULL) {
6164       assert(is_aligned(addr, alignment), &quot;Check&quot;);
6165       assert(is_aligned(addr, os::large_page_size()), &quot;Check&quot;);
6166 
6167       small_page_write(addr, size);
6168 
6169       os::Linux::release_memory_special_shm(addr, size);
6170     }
6171   }
6172 
6173   static void test_reserve_memory_special_shm() {
6174     size_t lp = os::large_page_size();
6175     size_t ag = os::vm_allocation_granularity();
6176 
6177     for (size_t size = ag; size &lt; lp * 3; size += ag) {
6178       for (size_t alignment = ag; is_aligned(size, alignment); alignment *= 2) {
6179         test_reserve_memory_special_shm(size, alignment);
6180       }
6181     }
6182   }
6183 
6184   static void test() {
6185     test_reserve_memory_special_huge_tlbfs();
6186     test_reserve_memory_special_shm();
6187   }
6188 };
6189 
6190 void TestReserveMemorySpecial_test() {
6191   TestReserveMemorySpecial::test();
6192 }
6193 
6194 #endif
<a name="82" id="anc82"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="82" type="hidden" />
</body>
</html>