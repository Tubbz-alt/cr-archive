<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/hotspot/os/windows/os_perf_windows.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="osThread_windows.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="os_windows.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/os/windows/os_perf_windows.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2012, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2012, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -28,12 +28,13 @@</span>
  #include &quot;memory/allocation.inline.hpp&quot;
  #include &quot;memory/resourceArea.hpp&quot;
  #include &quot;pdh_interface.hpp&quot;
  #include &quot;runtime/os_perf.hpp&quot;
  #include &quot;runtime/os.hpp&quot;
<span class="udiff-line-added">+ #include &quot;utilities/globalDefinitions.hpp&quot;</span>
  #include &quot;utilities/macros.hpp&quot;
<span class="udiff-line-modified-removed">- #include &quot;vm_version_ext_x86.hpp&quot;</span>
<span class="udiff-line-modified-added">+ #include CPU_HEADER(vm_version_ext)</span>
  #include &lt;math.h&gt;
  #include &lt;psapi.h&gt;
  #include &lt;TlHelp32.h&gt;
  
  /*
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -94,11 +95,11 @@</span>
  /*
  * Structs for PDH queries.
  */
  typedef struct {
    HQUERY query;
<span class="udiff-line-modified-removed">-   s8     lastUpdate; // Last time query was updated (current millis).</span>
<span class="udiff-line-modified-added">+   s8     lastUpdate; // Last time query was updated.</span>
  } UpdateQueryS, *UpdateQueryP;
  
  
  typedef struct {
    UpdateQueryS query;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -134,19 +135,19 @@</span>
      *query = NULL;
    }
  }
  
  static CounterQueryP create_counter_query() {
<span class="udiff-line-modified-removed">-   CounterQueryP const query = NEW_C_HEAP_ARRAY(CounterQueryS, 1, mtInternal);</span>
<span class="udiff-line-modified-added">+   CounterQueryP const query = NEW_C_HEAP_OBJ(CounterQueryS, mtInternal);</span>
    memset(query, 0, sizeof(CounterQueryS));
    return query;
  }
  
  static void destroy_counter_query(CounterQueryP query) {
    assert(query != NULL, &quot;invariant&quot;);
    pdh_cleanup(&amp;query-&gt;query.query, &amp;query-&gt;counter);
<span class="udiff-line-modified-removed">-   FREE_C_HEAP_ARRAY(CounterQueryS, query);</span>
<span class="udiff-line-modified-added">+   FREE_C_HEAP_OBJ(query);</span>
  }
  
  static MultiCounterQueryP create_multi_counter_query() {
    MultiCounterQueryP const query = NEW_C_HEAP_ARRAY(MultiCounterQueryS, 1, mtInternal);
    memset(query, 0, sizeof(MultiCounterQueryS));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -180,11 +181,11 @@</span>
    FREE_C_HEAP_ARRAY(MultiCounterQuerySetS, counter_query_set);
  }
  
  static void destroy_counter_query(ProcessQueryP process_query) {
    destroy_multi_counter_query(&amp;process_query-&gt;set);
<span class="udiff-line-modified-removed">-   FREE_C_HEAP_ARRAY(ProcessQueryS, process_query);</span>
<span class="udiff-line-modified-added">+   FREE_C_HEAP_OBJ(process_query);</span>
  }
  
  static int open_query(HQUERY* query) {
    return PdhDll::PdhOpenQuery(NULL, 0, query);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -192,46 +193,37 @@</span>
  template &lt;typename QueryP&gt;
  static int open_query(QueryP query) {
    return open_query(&amp;query-&gt;query);
  }
  
<span class="udiff-line-modified-removed">- static int allocate_counters(MultiCounterQueryP query, size_t nofCounters) {</span>
<span class="udiff-line-modified-added">+ static void allocate_counters(MultiCounterQueryP query, size_t nofCounters) {</span>
    assert(query != NULL, &quot;invariant&quot;);
    assert(!query-&gt;initialized, &quot;invariant&quot;);
    assert(0 == query-&gt;noOfCounters, &quot;invariant&quot;);
    assert(query-&gt;counters == NULL, &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   query-&gt;counters = (HCOUNTER*)NEW_C_HEAP_ARRAY(char, nofCounters * sizeof(HCOUNTER), mtInternal);</span>
<span class="udiff-line-removed">-   if (query-&gt;counters == NULL) {</span>
<span class="udiff-line-removed">-     return OS_ERR;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   query-&gt;counters = NEW_C_HEAP_ARRAY(HCOUNTER, nofCounters, mtInternal);</span>
    memset(query-&gt;counters, 0, nofCounters * sizeof(HCOUNTER));
    query-&gt;noOfCounters = (int)nofCounters;
<span class="udiff-line-removed">-   return OS_OK;</span>
  }
  
<span class="udiff-line-modified-removed">- static int allocate_counters(MultiCounterQuerySetP query_set, size_t nofCounters) {</span>
<span class="udiff-line-modified-added">+ static void allocate_counters(MultiCounterQuerySetP query_set, size_t nofCounters) {</span>
    assert(query_set != NULL, &quot;invariant&quot;);
    assert(!query_set-&gt;initialized, &quot;invariant&quot;);
    for (int i = 0; i &lt; query_set-&gt;size; ++i) {
<span class="udiff-line-modified-removed">-     if (allocate_counters(&amp;query_set-&gt;queries[i], nofCounters) != OS_OK) {</span>
<span class="udiff-line-removed">-       return OS_ERR;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     allocate_counters(&amp;query_set-&gt;queries[i], nofCounters);</span>
    }
<span class="udiff-line-removed">-   return OS_OK;</span>
  }
  
<span class="udiff-line-modified-removed">- static int allocate_counters(ProcessQueryP process_query, size_t nofCounters) {</span>
<span class="udiff-line-modified-added">+ static void allocate_counters(ProcessQueryP process_query, size_t nofCounters) {</span>
    assert(process_query != NULL, &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   return allocate_counters(&amp;process_query-&gt;set, nofCounters);</span>
<span class="udiff-line-modified-added">+   allocate_counters(&amp;process_query-&gt;set, nofCounters);</span>
  }
  
  static void deallocate_counters(MultiCounterQueryP query) {
<span class="udiff-line-modified-removed">-   if (query-&gt;counters != NULL) {</span>
<span class="udiff-line-modified-removed">-     FREE_C_HEAP_ARRAY(char, query-&gt;counters);</span>
<span class="udiff-line-modified-removed">-     query-&gt;counters = NULL;</span>
<span class="udiff-line-removed">-     query-&gt;noOfCounters = 0;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   FREE_C_HEAP_ARRAY(char, query-&gt;counters);</span>
<span class="udiff-line-modified-added">+   query-&gt;counters = NULL;</span>
<span class="udiff-line-modified-added">+   query-&gt;noOfCounters = 0;</span>
  }
  
  static OSReturn add_counter(UpdateQueryP query, HCOUNTER* counter, const char* path, bool first_sample_on_init) {
    assert(query != NULL, &quot;invariant&quot;);
    assert(counter != NULL, &quot;invariant&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -293,12 +285,12 @@</span>
    return ret;
  }
  
  static int collect_query_data(UpdateQueryP update_query) {
    assert(update_query != NULL, &quot;invariant&quot;);
<span class="udiff-line-modified-removed">-   const s8 now = os::javaTimeMillis();</span>
<span class="udiff-line-modified-removed">-   if (now - update_query-&gt;lastUpdate &gt; min_update_interval_millis) {</span>
<span class="udiff-line-modified-added">+   const s8 now = os::javaTimeNanos();</span>
<span class="udiff-line-modified-added">+   if (nanos_to_millis(now - update_query-&gt;lastUpdate) &gt; min_update_interval_millis) {</span>
      if (PdhDll::PdhCollectQueryData(update_query-&gt;query) != ERROR_SUCCESS) {
        return OS_ERR;
      }
      update_query-&gt;lastUpdate = now;
    }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -386,11 +378,11 @@</span>
  static ProcessQueryP create_process_query() {
    const int current_process_idx = current_query_index_for_process();
    if (OS_ERR == current_process_idx) {
      return NULL;
    }
<span class="udiff-line-modified-removed">-   ProcessQueryP const process_query = NEW_C_HEAP_ARRAY(ProcessQueryS, 1, mtInternal);</span>
<span class="udiff-line-modified-added">+   ProcessQueryP const process_query = NEW_C_HEAP_OBJ(ProcessQueryS, mtInternal);</span>
    memset(process_query, 0, sizeof(ProcessQueryS));
    process_query-&gt;set.queries = NEW_C_HEAP_ARRAY(MultiCounterQueryS, current_process_idx + 1, mtInternal);
    memset(process_query-&gt;set.queries, 0, sizeof(MultiCounterQueryS) * (current_process_idx + 1));
    process_query-&gt;process_index = current_process_idx;
    process_query-&gt;set.size = current_process_idx + 1;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -600,11 +592,11 @@</span>
  }
  
  static const char* copy_string_to_c_heap(const char* string) {
    assert(string != NULL, &quot;invariant&quot;);
    const size_t len = strlen(string);
<span class="udiff-line-modified-removed">-   char* const cheap_allocated_string = NEW_C_HEAP_ARRAY(char, len + 1, mtInternal);</span>
<span class="udiff-line-modified-added">+   char* const cheap_allocated_string = NEW_C_HEAP_ARRAY_RETURN_NULL(char, len + 1, mtInternal);</span>
    if (NULL == cheap_allocated_string) {
      return NULL;
    }
    strncpy(cheap_allocated_string, string, len + 1);
    return cheap_allocated_string;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -657,18 +649,14 @@</span>
    dot_pos[0] = &#39;\0&#39;;
    return process_image_name;
  }
  
  static void deallocate_pdh_constants() {
<span class="udiff-line-modified-removed">-   if (process_image_name != NULL) {</span>
<span class="udiff-line-modified-removed">-     FREE_C_HEAP_ARRAY(char, process_image_name);</span>
<span class="udiff-line-modified-removed">-     process_image_name = NULL;</span>
<span class="udiff-line-modified-removed">-   }</span>
<span class="udiff-line-removed">-   if (pdh_IDProcess_counter_fmt != NULL) {</span>
<span class="udiff-line-removed">-     FREE_C_HEAP_ARRAY(char, pdh_IDProcess_counter_fmt);</span>
<span class="udiff-line-removed">-     pdh_IDProcess_counter_fmt = NULL;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   FREE_C_HEAP_ARRAY(char, process_image_name);</span>
<span class="udiff-line-modified-added">+   process_image_name = NULL;</span>
<span class="udiff-line-modified-added">+   FREE_C_HEAP_ARRAY(char, pdh_IDProcess_counter_fmt);</span>
<span class="udiff-line-modified-added">+   pdh_IDProcess_counter_fmt = NULL;</span>
  }
  
  static int allocate_pdh_constants() {
    assert(process_image_name == NULL, &quot;invariant&quot;);
    const char* pdh_image_name = pdh_process_image_name();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -853,13 +841,11 @@</span>
    assert(cpu_query != NULL, &quot;invariant&quot;);
    assert(!cpu_query-&gt;initialized, &quot;invariant&quot;);
    const int logical_cpu_count = number_of_logical_cpus();
    assert(logical_cpu_count &gt;= os::processor_count(), &quot;invariant&quot;);
    // we also add another counter for instance &quot;_Total&quot;
<span class="udiff-line-modified-removed">-   if (allocate_counters(cpu_query, logical_cpu_count + 1) != OS_OK) {</span>
<span class="udiff-line-removed">-     return OS_ERR;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   allocate_counters(cpu_query, logical_cpu_count + 1);</span>
    assert(cpu_query-&gt;noOfCounters == logical_cpu_count + 1, &quot;invariant&quot;);
    return initialize_cpu_query_counters(cpu_query, pdh_counter_idx);
  }
  
  static int initialize_process_counter(ProcessQueryP process_query, int slot_index, DWORD pdh_counter_index) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1021,13 +1007,11 @@</span>
    _context_switches = create_counter_query(PDH_SYSTEM_IDX, PDH_CONTEXT_SWITCH_RATE_IDX);
    _process_cpu_load = create_process_query();
    if (_process_cpu_load == NULL) {
      return true;
    }
<span class="udiff-line-modified-removed">-   if (allocate_counters(_process_cpu_load, 2) != OS_OK) {</span>
<span class="udiff-line-removed">-     return true;</span>
<span class="udiff-line-removed">-   }</span>
<span class="udiff-line-modified-added">+   allocate_counters(_process_cpu_load, 2);</span>
    if (initialize_process_counter(_process_cpu_load, 0, PDH_PROCESSOR_TIME_IDX) != OS_OK) {
      return true;
    }
    if (initialize_process_counter(_process_cpu_load, 1, PDH_PRIV_PROCESSOR_TIME_IDX) != OS_OK) {
      return true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1061,11 +1045,11 @@</span>
    _impl = NULL;
  }
  
  bool CPUPerformanceInterface::initialize() {
    _impl = new CPUPerformanceInterface::CPUPerformance();
<span class="udiff-line-modified-removed">-   return _impl != NULL &amp;&amp; _impl-&gt;initialize();</span>
<span class="udiff-line-modified-added">+   return _impl-&gt;initialize();</span>
  }
  
  CPUPerformanceInterface::~CPUPerformanceInterface() {
    if (_impl != NULL) {
      delete _impl;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1267,11 +1251,11 @@</span>
    _iterator = NULL;
  }
  
  bool SystemProcessInterface::SystemProcesses::initialize() {
    _iterator = new SystemProcessInterface::SystemProcesses::ProcessIterator();
<span class="udiff-line-modified-removed">-   return _iterator != NULL &amp;&amp; _iterator-&gt;initialize();</span>
<span class="udiff-line-modified-added">+   return _iterator-&gt;initialize();</span>
  }
  
  SystemProcessInterface::SystemProcesses::~SystemProcesses() {
    if (_iterator != NULL) {
      delete _iterator;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1322,11 +1306,11 @@</span>
    _impl = NULL;
  }
  
  bool SystemProcessInterface::initialize() {
    _impl = new SystemProcessInterface::SystemProcesses();
<span class="udiff-line-modified-removed">-   return _impl != NULL &amp;&amp; _impl-&gt;initialize();</span>
<span class="udiff-line-modified-added">+   return _impl-&gt;initialize();</span>
  }
  
  SystemProcessInterface::~SystemProcessInterface() {
    if (_impl != NULL) {
      delete _impl;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1337,33 +1321,24 @@</span>
    _cpu_info = NULL;
  }
  
  bool CPUInformationInterface::initialize() {
    _cpu_info = new CPUInformation();
<span class="udiff-line-removed">-   if (NULL == _cpu_info) {</span>
<span class="udiff-line-removed">-     return false;</span>
<span class="udiff-line-removed">-   }</span>
    _cpu_info-&gt;set_number_of_hardware_threads(VM_Version_Ext::number_of_threads());
    _cpu_info-&gt;set_number_of_cores(VM_Version_Ext::number_of_cores());
    _cpu_info-&gt;set_number_of_sockets(VM_Version_Ext::number_of_sockets());
    _cpu_info-&gt;set_cpu_name(VM_Version_Ext::cpu_name());
    _cpu_info-&gt;set_cpu_description(VM_Version_Ext::cpu_description());
    return true;
  }
  
  CPUInformationInterface::~CPUInformationInterface() {
    if (_cpu_info != NULL) {
<span class="udiff-line-modified-removed">-     const char* cpu_name = _cpu_info-&gt;cpu_name();</span>
<span class="udiff-line-modified-removed">-     if (cpu_name != NULL) {</span>
<span class="udiff-line-modified-removed">-       FREE_C_HEAP_ARRAY(char, cpu_name);</span>
<span class="udiff-line-modified-removed">-       _cpu_info-&gt;set_cpu_name(NULL);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     const char* cpu_desc = _cpu_info-&gt;cpu_description();</span>
<span class="udiff-line-removed">-     if (cpu_desc != NULL) {</span>
<span class="udiff-line-removed">-       FREE_C_HEAP_ARRAY(char, cpu_desc);</span>
<span class="udiff-line-removed">-       _cpu_info-&gt;set_cpu_description(NULL);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     FREE_C_HEAP_ARRAY(char, _cpu_info-&gt;cpu_name());</span>
<span class="udiff-line-modified-added">+     _cpu_info-&gt;set_cpu_name(NULL);</span>
<span class="udiff-line-modified-added">+     FREE_C_HEAP_ARRAY(char, _cpu_info-&gt;cpu_description());</span>
<span class="udiff-line-modified-added">+     _cpu_info-&gt;set_cpu_description(NULL);</span>
      delete _cpu_info;
      _cpu_info = NULL;
    }
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1379,12 +1354,11 @@</span>
    friend class NetworkPerformanceInterface;
   private:
    bool _iphlp_attached;
  
    NetworkPerformance();
<span class="udiff-line-modified-removed">-   NetworkPerformance(const NetworkPerformance&amp; rhs); // no impl</span>
<span class="udiff-line-removed">-   NetworkPerformance&amp; operator=(const NetworkPerformance&amp; rhs); // no impl</span>
<span class="udiff-line-modified-added">+   NONCOPYABLE(NetworkPerformance);</span>
    bool initialize();
    ~NetworkPerformance();
    int network_utilization(NetworkInterface** network_interfaces) const;
  };
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1441,11 +1415,11 @@</span>
    }
  }
  
  bool NetworkPerformanceInterface::initialize() {
    _impl = new NetworkPerformanceInterface::NetworkPerformance();
<span class="udiff-line-modified-removed">-   return _impl != NULL &amp;&amp; _impl-&gt;initialize();</span>
<span class="udiff-line-modified-added">+   return _impl-&gt;initialize();</span>
  }
  
  int NetworkPerformanceInterface::network_utilization(NetworkInterface** network_interfaces) const {
    return _impl-&gt;network_utilization(network_interfaces);
  }
</pre>
<center><a href="osThread_windows.hpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="os_windows.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>