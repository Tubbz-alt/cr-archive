<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/os/solaris/os_solaris.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 // no precompiled headers
  26 #include &quot;jvm.h&quot;
  27 #include &quot;classfile/classLoader.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;code/vtableStubs.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;interpreter/interpreter.hpp&quot;
  35 #include &quot;logging/log.hpp&quot;
  36 #include &quot;memory/allocation.inline.hpp&quot;
  37 #include &quot;memory/filemap.hpp&quot;
  38 #include &quot;oops/oop.inline.hpp&quot;
  39 #include &quot;os_share_solaris.hpp&quot;
  40 #include &quot;os_solaris.inline.hpp&quot;
  41 #include &quot;prims/jniFastGetField.hpp&quot;
  42 #include &quot;prims/jvm_misc.hpp&quot;
  43 #include &quot;runtime/arguments.hpp&quot;
  44 #include &quot;runtime/atomic.hpp&quot;
  45 #include &quot;runtime/extendedPC.hpp&quot;
  46 #include &quot;runtime/globals.hpp&quot;
  47 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  48 #include &quot;runtime/java.hpp&quot;
  49 #include &quot;runtime/javaCalls.hpp&quot;
  50 #include &quot;runtime/mutexLocker.hpp&quot;
  51 #include &quot;runtime/objectMonitor.hpp&quot;
  52 #include &quot;runtime/orderAccess.hpp&quot;
  53 #include &quot;runtime/osThread.hpp&quot;
  54 #include &quot;runtime/perfMemory.hpp&quot;
  55 #include &quot;runtime/sharedRuntime.hpp&quot;
  56 #include &quot;runtime/statSampler.hpp&quot;
  57 #include &quot;runtime/stubRoutines.hpp&quot;
  58 #include &quot;runtime/thread.inline.hpp&quot;
  59 #include &quot;runtime/threadCritical.hpp&quot;
  60 #include &quot;runtime/timer.hpp&quot;
  61 #include &quot;runtime/vm_version.hpp&quot;
  62 #include &quot;semaphore_posix.hpp&quot;
  63 #include &quot;services/attachListener.hpp&quot;
  64 #include &quot;services/memTracker.hpp&quot;
  65 #include &quot;services/runtimeService.hpp&quot;
  66 #include &quot;utilities/align.hpp&quot;
  67 #include &quot;utilities/decoder.hpp&quot;
  68 #include &quot;utilities/defaultStream.hpp&quot;
  69 #include &quot;utilities/events.hpp&quot;
  70 #include &quot;utilities/growableArray.hpp&quot;
  71 #include &quot;utilities/macros.hpp&quot;
  72 #include &quot;utilities/vmError.hpp&quot;
  73 
  74 // put OS-includes here
  75 # include &lt;dlfcn.h&gt;
  76 # include &lt;errno.h&gt;
  77 # include &lt;exception&gt;
  78 # include &lt;link.h&gt;
  79 # include &lt;poll.h&gt;
  80 # include &lt;pthread.h&gt;
  81 # include &lt;setjmp.h&gt;
  82 # include &lt;signal.h&gt;
  83 # include &lt;stdio.h&gt;
  84 # include &lt;alloca.h&gt;
  85 # include &lt;sys/filio.h&gt;
  86 # include &lt;sys/ipc.h&gt;
  87 # include &lt;sys/lwp.h&gt;
  88 # include &lt;sys/machelf.h&gt;     // for elf Sym structure used by dladdr1
  89 # include &lt;sys/mman.h&gt;
  90 # include &lt;sys/processor.h&gt;
  91 # include &lt;sys/procset.h&gt;
  92 # include &lt;sys/pset.h&gt;
  93 # include &lt;sys/resource.h&gt;
  94 # include &lt;sys/shm.h&gt;
  95 # include &lt;sys/socket.h&gt;
  96 # include &lt;sys/stat.h&gt;
  97 # include &lt;sys/systeminfo.h&gt;
  98 # include &lt;sys/time.h&gt;
  99 # include &lt;sys/times.h&gt;
 100 # include &lt;sys/types.h&gt;
 101 # include &lt;sys/wait.h&gt;
 102 # include &lt;sys/utsname.h&gt;
 103 # include &lt;thread.h&gt;
 104 # include &lt;unistd.h&gt;
 105 # include &lt;sys/priocntl.h&gt;
 106 # include &lt;sys/rtpriocntl.h&gt;
 107 # include &lt;sys/tspriocntl.h&gt;
 108 # include &lt;sys/iapriocntl.h&gt;
 109 # include &lt;sys/fxpriocntl.h&gt;
 110 # include &lt;sys/loadavg.h&gt;
 111 # include &lt;string.h&gt;
 112 # include &lt;stdio.h&gt;
 113 
 114 # define _STRUCTURED_PROC 1  //  this gets us the new structured proc interfaces of 5.6 &amp; later
 115 # include &lt;sys/procfs.h&gt;     //  see comment in &lt;sys/procfs.h&gt;
 116 
 117 #define MAX_PATH (2 * K)
 118 
 119 // for timer info max values which include all bits
 120 #define ALL_64_BITS CONST64(0xFFFFFFFFFFFFFFFF)
 121 
 122 
 123 // Here are some liblgrp types from sys/lgrp_user.h to be able to
 124 // compile on older systems without this header file.
 125 
 126 #ifndef MADV_ACCESS_LWP
 127   #define  MADV_ACCESS_LWP   7       /* next LWP to access heavily */
 128 #endif
 129 #ifndef MADV_ACCESS_MANY
 130   #define  MADV_ACCESS_MANY  8       /* many processes to access heavily */
 131 #endif
 132 
 133 #ifndef LGRP_RSRC_CPU
 134   #define LGRP_RSRC_CPU      0       /* CPU resources */
 135 #endif
 136 #ifndef LGRP_RSRC_MEM
 137   #define LGRP_RSRC_MEM      1       /* memory resources */
 138 #endif
 139 
 140 // Values for ThreadPriorityPolicy == 1
 141 int prio_policy1[CriticalPriority+1] = {
 142   -99999,  0, 16,  32,  48,  64,
 143           80, 96, 112, 124, 127, 127 };
 144 
 145 // System parameters used internally
 146 static clock_t clock_tics_per_sec = 100;
 147 
 148 // Track if we have called enable_extended_FILE_stdio (on Solaris 10u4+)
 149 static bool enabled_extended_FILE_stdio = false;
 150 
 151 // For diagnostics to print a message once. see run_periodic_checks
 152 static bool check_addr0_done = false;
 153 static sigset_t check_signal_done;
 154 static bool check_signals = true;
 155 
 156 address os::Solaris::handler_start;  // start pc of thr_sighndlrinfo
 157 address os::Solaris::handler_end;    // end pc of thr_sighndlrinfo
 158 
 159 address os::Solaris::_main_stack_base = NULL;  // 4352906 workaround
 160 
 161 os::Solaris::pthread_setname_np_func_t os::Solaris::_pthread_setname_np = NULL;
 162 
 163 // &quot;default&quot; initializers for missing libc APIs
 164 extern &quot;C&quot; {
 165   static int lwp_mutex_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 166   static int lwp_mutex_destroy(mutex_t *mx)                 { return 0; }
 167 
 168   static int lwp_cond_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 169   static int lwp_cond_destroy(cond_t *cv)                   { return 0; }
 170 }
 171 
 172 // &quot;default&quot; initializers for pthread-based synchronization
 173 extern &quot;C&quot; {
 174   static int pthread_mutex_default_init(mutex_t *mx, int scope, void *arg) { memset(mx, 0, sizeof(mutex_t)); return 0; }
 175   static int pthread_cond_default_init(cond_t *cv, int scope, void *arg){ memset(cv, 0, sizeof(cond_t)); return 0; }
 176 }
 177 
 178 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time);
 179 
 180 static inline size_t adjust_stack_size(address base, size_t size) {
 181   if ((ssize_t)size &lt; 0) {
 182     // 4759953: Compensate for ridiculous stack size.
 183     size = max_intx;
 184   }
 185   if (size &gt; (size_t)base) {
 186     // 4812466: Make sure size doesn&#39;t allow the stack to wrap the address space.
 187     size = (size_t)base;
 188   }
 189   return size;
 190 }
 191 
 192 static inline stack_t get_stack_info() {
 193   stack_t st;
 194   int retval = thr_stksegment(&amp;st);
 195   st.ss_size = adjust_stack_size((address)st.ss_sp, st.ss_size);
 196   assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
 197   assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
 198   assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
 199   return st;
 200 }
 201 
 202 static void _handle_uncaught_cxx_exception() {
 203   VMError::report_and_die(&quot;An uncaught C++ exception&quot;);
 204 }
 205 
 206 bool os::is_primordial_thread(void) {
 207   int r = thr_main();
 208   guarantee(r == 0 || r == 1, &quot;CR6501650 or CR6493689&quot;);
 209   return r == 1;
 210 }
 211 
 212 address os::current_stack_base() {
 213   bool _is_primordial_thread = is_primordial_thread();
 214 
 215   // Workaround 4352906, avoid calls to thr_stksegment by
 216   // thr_main after the first one (it looks like we trash
 217   // some data, causing the value for ss_sp to be incorrect).
 218   if (!_is_primordial_thread || os::Solaris::_main_stack_base == NULL) {
 219     stack_t st = get_stack_info();
 220     if (_is_primordial_thread) {
 221       // cache initial value of stack base
 222       os::Solaris::_main_stack_base = (address)st.ss_sp;
 223     }
 224     return (address)st.ss_sp;
 225   } else {
 226     guarantee(os::Solaris::_main_stack_base != NULL, &quot;Attempt to use null cached stack base&quot;);
 227     return os::Solaris::_main_stack_base;
 228   }
 229 }
 230 
 231 size_t os::current_stack_size() {
 232   size_t size;
 233 
 234   if (!is_primordial_thread()) {
 235     size = get_stack_info().ss_size;
 236   } else {
 237     struct rlimit limits;
 238     getrlimit(RLIMIT_STACK, &amp;limits);
 239     size = adjust_stack_size(os::Solaris::_main_stack_base, (size_t)limits.rlim_cur);
 240   }
 241   // base may not be page aligned
 242   address base = current_stack_base();
 243   address bottom = align_up(base - size, os::vm_page_size());;
 244   return (size_t)(base - bottom);
 245 }
 246 
 247 struct tm* os::localtime_pd(const time_t* clock, struct tm*  res) {
 248   return localtime_r(clock, res);
 249 }
 250 
 251 void os::Solaris::try_enable_extended_io() {
 252   typedef int (*enable_extended_FILE_stdio_t)(int, int);
 253 
 254   if (!UseExtendedFileIO) {
 255     return;
 256   }
 257 
 258   enable_extended_FILE_stdio_t enabler =
 259     (enable_extended_FILE_stdio_t) dlsym(RTLD_DEFAULT,
 260                                          &quot;enable_extended_FILE_stdio&quot;);
 261   if (enabler) {
 262     enabler(-1, -1);
 263   }
 264 }
 265 
 266 static int _processors_online = 0;
 267 
 268 jint os::Solaris::_os_thread_limit = 0;
 269 volatile jint os::Solaris::_os_thread_count = 0;
 270 
 271 julong os::available_memory() {
 272   return Solaris::available_memory();
 273 }
 274 
 275 julong os::Solaris::available_memory() {
 276   return (julong)sysconf(_SC_AVPHYS_PAGES) * os::vm_page_size();
 277 }
 278 
 279 julong os::Solaris::_physical_memory = 0;
 280 
 281 julong os::physical_memory() {
 282   return Solaris::physical_memory();
 283 }
 284 
 285 static hrtime_t first_hrtime = 0;
 286 static const hrtime_t hrtime_hz = 1000*1000*1000;
 287 static volatile hrtime_t max_hrtime = 0;
 288 
 289 
 290 void os::Solaris::initialize_system_info() {
 291   set_processor_count(sysconf(_SC_NPROCESSORS_CONF));
 292   _processors_online = sysconf(_SC_NPROCESSORS_ONLN);
 293   _physical_memory = (julong)sysconf(_SC_PHYS_PAGES) *
 294                                      (julong)sysconf(_SC_PAGESIZE);
 295 }
 296 
 297 uint os::processor_id() {
 298   const processorid_t id = ::getcpuid();
 299   assert(id &gt;= 0 &amp;&amp; id &lt; _processor_count, &quot;Invalid processor id&quot;);
 300   return (uint)id;
 301 }
 302 
 303 int os::active_processor_count() {
 304   // User has overridden the number of active processors
 305   if (ActiveProcessorCount &gt; 0) {
 306     log_trace(os)(&quot;active_processor_count: &quot;
 307                   &quot;active processor count set by user : %d&quot;,
 308                   ActiveProcessorCount);
 309     return ActiveProcessorCount;
 310   }
 311 
 312   int online_cpus = sysconf(_SC_NPROCESSORS_ONLN);
 313   pid_t pid = getpid();
 314   psetid_t pset = PS_NONE;
 315   // Are we running in a processor set or is there any processor set around?
 316   if (pset_bind(PS_QUERY, P_PID, pid, &amp;pset) == 0) {
 317     uint_t pset_cpus;
 318     // Query the number of cpus available to us.
 319     if (pset_info(pset, NULL, &amp;pset_cpus, NULL) == 0) {
 320       assert(pset_cpus &gt; 0 &amp;&amp; pset_cpus &lt;= online_cpus, &quot;sanity check&quot;);
 321       _processors_online = pset_cpus;
 322       return pset_cpus;
 323     }
 324   }
 325   // Otherwise return number of online cpus
 326   return online_cpus;
 327 }
 328 
 329 static bool find_processors_in_pset(psetid_t        pset,
 330                                     processorid_t** id_array,
 331                                     uint_t*         id_length) {
 332   bool result = false;
 333   // Find the number of processors in the processor set.
 334   if (pset_info(pset, NULL, id_length, NULL) == 0) {
 335     // Make up an array to hold their ids.
 336     *id_array = NEW_C_HEAP_ARRAY(processorid_t, *id_length, mtInternal);
 337     // Fill in the array with their processor ids.
 338     if (pset_info(pset, NULL, id_length, *id_array) == 0) {
 339       result = true;
 340     }
 341   }
 342   return result;
 343 }
 344 
 345 // Callers of find_processors_online() must tolerate imprecise results --
 346 // the system configuration can change asynchronously because of DR
 347 // or explicit psradm operations.
 348 //
 349 // We also need to take care that the loop (below) terminates as the
 350 // number of processors online can change between the _SC_NPROCESSORS_ONLN
 351 // request and the loop that builds the list of processor ids.   Unfortunately
 352 // there&#39;s no reliable way to determine the maximum valid processor id,
 353 // so we use a manifest constant, MAX_PROCESSOR_ID, instead.  See p_online
 354 // man pages, which claim the processor id set is &quot;sparse, but
 355 // not too sparse&quot;.  MAX_PROCESSOR_ID is used to ensure that we eventually
 356 // exit the loop.
 357 //
 358 // In the future we&#39;ll be able to use sysconf(_SC_CPUID_MAX), but that&#39;s
 359 // not available on S8.0.
 360 
 361 static bool find_processors_online(processorid_t** id_array,
 362                                    uint*           id_length) {
 363   const processorid_t MAX_PROCESSOR_ID = 100000;
 364   // Find the number of processors online.
 365   *id_length = sysconf(_SC_NPROCESSORS_ONLN);
 366   // Make up an array to hold their ids.
 367   *id_array = NEW_C_HEAP_ARRAY(processorid_t, *id_length, mtInternal);
 368   // Processors need not be numbered consecutively.
 369   long found = 0;
 370   processorid_t next = 0;
 371   while (found &lt; *id_length &amp;&amp; next &lt; MAX_PROCESSOR_ID) {
 372     processor_info_t info;
 373     if (processor_info(next, &amp;info) == 0) {
 374       // NB, PI_NOINTR processors are effectively online ...
 375       if (info.pi_state == P_ONLINE || info.pi_state == P_NOINTR) {
 376         (*id_array)[found] = next;
 377         found += 1;
 378       }
 379     }
 380     next += 1;
 381   }
 382   if (found &lt; *id_length) {
 383     // The loop above didn&#39;t identify the expected number of processors.
 384     // We could always retry the operation, calling sysconf(_SC_NPROCESSORS_ONLN)
 385     // and re-running the loop, above, but there&#39;s no guarantee of progress
 386     // if the system configuration is in flux.  Instead, we just return what
 387     // we&#39;ve got.  Note that in the worst case find_processors_online() could
 388     // return an empty set.  (As a fall-back in the case of the empty set we
 389     // could just return the ID of the current processor).
 390     *id_length = found;
 391   }
 392 
 393   return true;
 394 }
 395 
 396 static bool assign_distribution(processorid_t* id_array,
 397                                 uint           id_length,
 398                                 uint*          distribution,
 399                                 uint           distribution_length) {
 400   // We assume we can assign processorid_t&#39;s to uint&#39;s.
 401   assert(sizeof(processorid_t) == sizeof(uint),
 402          &quot;can&#39;t convert processorid_t to uint&quot;);
 403   // Quick check to see if we won&#39;t succeed.
 404   if (id_length &lt; distribution_length) {
 405     return false;
 406   }
 407   // Assign processor ids to the distribution.
 408   // Try to shuffle processors to distribute work across boards,
 409   // assuming 4 processors per board.
 410   const uint processors_per_board = ProcessDistributionStride;
 411   // Find the maximum processor id.
 412   processorid_t max_id = 0;
 413   for (uint m = 0; m &lt; id_length; m += 1) {
 414     max_id = MAX2(max_id, id_array[m]);
 415   }
 416   // The next id, to limit loops.
 417   const processorid_t limit_id = max_id + 1;
 418   // Make up markers for available processors.
 419   bool* available_id = NEW_C_HEAP_ARRAY(bool, limit_id, mtInternal);
 420   for (uint c = 0; c &lt; limit_id; c += 1) {
 421     available_id[c] = false;
 422   }
 423   for (uint a = 0; a &lt; id_length; a += 1) {
 424     available_id[id_array[a]] = true;
 425   }
 426   // Step by &quot;boards&quot;, then by &quot;slot&quot;, copying to &quot;assigned&quot;.
 427   // NEEDS_CLEANUP: The assignment of processors should be stateful,
 428   //                remembering which processors have been assigned by
 429   //                previous calls, etc., so as to distribute several
 430   //                independent calls of this method.  What we&#39;d like is
 431   //                It would be nice to have an API that let us ask
 432   //                how many processes are bound to a processor,
 433   //                but we don&#39;t have that, either.
 434   //                In the short term, &quot;board&quot; is static so that
 435   //                subsequent distributions don&#39;t all start at board 0.
 436   static uint board = 0;
 437   uint assigned = 0;
 438   // Until we&#39;ve found enough processors ....
 439   while (assigned &lt; distribution_length) {
 440     // ... find the next available processor in the board.
 441     for (uint slot = 0; slot &lt; processors_per_board; slot += 1) {
 442       uint try_id = board * processors_per_board + slot;
 443       if ((try_id &lt; limit_id) &amp;&amp; (available_id[try_id] == true)) {
 444         distribution[assigned] = try_id;
 445         available_id[try_id] = false;
 446         assigned += 1;
 447         break;
 448       }
 449     }
 450     board += 1;
 451     if (board * processors_per_board + 0 &gt;= limit_id) {
 452       board = 0;
 453     }
 454   }
 455   if (available_id != NULL) {
 456     FREE_C_HEAP_ARRAY(bool, available_id);
 457   }
 458   return true;
 459 }
 460 
 461 void os::set_native_thread_name(const char *name) {
 462   if (Solaris::_pthread_setname_np != NULL) {
 463     // Only the first 31 bytes of &#39;name&#39; are processed by pthread_setname_np
 464     // but we explicitly copy into a size-limited buffer to avoid any
 465     // possible overflow.
 466     char buf[32];
 467     snprintf(buf, sizeof(buf), &quot;%s&quot;, name);
 468     buf[sizeof(buf) - 1] = &#39;\0&#39;;
 469     Solaris::_pthread_setname_np(pthread_self(), buf);
 470   }
 471 }
 472 
 473 bool os::distribute_processes(uint length, uint* distribution) {
 474   bool result = false;
 475   // Find the processor id&#39;s of all the available CPUs.
 476   processorid_t* id_array  = NULL;
 477   uint           id_length = 0;
 478   // There are some races between querying information and using it,
 479   // since processor sets can change dynamically.
 480   psetid_t pset = PS_NONE;
 481   // Are we running in a processor set?
 482   if ((pset_bind(PS_QUERY, P_PID, P_MYID, &amp;pset) == 0) &amp;&amp; pset != PS_NONE) {
 483     result = find_processors_in_pset(pset, &amp;id_array, &amp;id_length);
 484   } else {
 485     result = find_processors_online(&amp;id_array, &amp;id_length);
 486   }
 487   if (result == true) {
 488     if (id_length &gt;= length) {
 489       result = assign_distribution(id_array, id_length, distribution, length);
 490     } else {
 491       result = false;
 492     }
 493   }
 494   if (id_array != NULL) {
 495     FREE_C_HEAP_ARRAY(processorid_t, id_array);
 496   }
 497   return result;
 498 }
 499 
 500 bool os::bind_to_processor(uint processor_id) {
 501   // We assume that a processorid_t can be stored in a uint.
 502   assert(sizeof(uint) == sizeof(processorid_t),
 503          &quot;can&#39;t convert uint to processorid_t&quot;);
 504   int bind_result =
 505     processor_bind(P_LWPID,                       // bind LWP.
 506                    P_MYID,                        // bind current LWP.
 507                    (processorid_t) processor_id,  // id.
 508                    NULL);                         // don&#39;t return old binding.
 509   return (bind_result == 0);
 510 }
 511 
 512 // Return true if user is running as root.
 513 
 514 bool os::have_special_privileges() {
 515   static bool init = false;
 516   static bool privileges = false;
 517   if (!init) {
 518     privileges = (getuid() != geteuid()) || (getgid() != getegid());
 519     init = true;
 520   }
 521   return privileges;
 522 }
 523 
 524 
 525 void os::init_system_properties_values() {
 526   // The next steps are taken in the product version:
 527   //
 528   // Obtain the JAVA_HOME value from the location of libjvm.so.
 529   // This library should be located at:
 530   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/{client|server}/libjvm.so.
 531   //
 532   // If &quot;/jre/lib/&quot; appears at the right place in the path, then we
 533   // assume libjvm.so is installed in a JDK and we use this path.
 534   //
 535   // Otherwise exit with message: &quot;Could not create the Java virtual machine.&quot;
 536   //
 537   // The following extra steps are taken in the debugging version:
 538   //
 539   // If &quot;/jre/lib/&quot; does NOT appear at the right place in the path
 540   // instead of exit check for $JAVA_HOME environment variable.
 541   //
 542   // If it is defined and we are able to locate $JAVA_HOME/jre/lib/&lt;arch&gt;,
 543   // then we append a fake suffix &quot;hotspot/libjvm.so&quot; to this path so
 544   // it looks like libjvm.so is installed there
 545   // &lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/hotspot/libjvm.so.
 546   //
 547   // Otherwise exit.
 548   //
 549   // Important note: if the location of libjvm.so changes this
 550   // code needs to be changed accordingly.
 551 
 552 // Base path of extensions installed on the system.
 553 #define SYS_EXT_DIR     &quot;/usr/jdk/packages&quot;
 554 #define EXTENSIONS_DIR  &quot;/lib/ext&quot;
 555 
 556   // Buffer that fits several sprintfs.
 557   // Note that the space for the colon and the trailing null are provided
 558   // by the nulls included by the sizeof operator.
 559   const size_t bufsize =
 560     MAX3((size_t)MAXPATHLEN,  // For dll_dir &amp; friends.
 561          sizeof(SYS_EXT_DIR) + sizeof(&quot;/lib/&quot;), // invariant ld_library_path
 562          (size_t)MAXPATHLEN + sizeof(EXTENSIONS_DIR) + sizeof(SYS_EXT_DIR) + sizeof(EXTENSIONS_DIR)); // extensions dir
 563   char *buf = (char *)NEW_C_HEAP_ARRAY(char, bufsize, mtInternal);
 564 
 565   // sysclasspath, java_home, dll_dir
 566   {
 567     char *pslash;
 568     os::jvm_path(buf, bufsize);
 569 
 570     // Found the full path to libjvm.so.
 571     // Now cut the path to &lt;java_home&gt;/jre if we can.
 572     *(strrchr(buf, &#39;/&#39;)) = &#39;\0&#39;; // Get rid of /libjvm.so.
 573     pslash = strrchr(buf, &#39;/&#39;);
 574     if (pslash != NULL) {
 575       *pslash = &#39;\0&#39;;            // Get rid of /{client|server|hotspot}.
 576     }
 577     Arguments::set_dll_dir(buf);
 578 
 579     if (pslash != NULL) {
 580       pslash = strrchr(buf, &#39;/&#39;);
 581       if (pslash != NULL) {
 582         *pslash = &#39;\0&#39;;        // Get rid of /lib.
 583       }
 584     }
 585     Arguments::set_java_home(buf);
 586     if (!set_boot_path(&#39;/&#39;, &#39;:&#39;)) {
 587       vm_exit_during_initialization(&quot;Failed setting boot class path.&quot;, NULL);
 588     }
 589   }
 590 
 591   // Where to look for native libraries.
 592   {
 593     // Use dlinfo() to determine the correct java.library.path.
 594     //
 595     // If we&#39;re launched by the Java launcher, and the user
 596     // does not set java.library.path explicitly on the commandline,
 597     // the Java launcher sets LD_LIBRARY_PATH for us and unsets
 598     // LD_LIBRARY_PATH_32 and LD_LIBRARY_PATH_64.  In this case
 599     // dlinfo returns LD_LIBRARY_PATH + crle settings (including
 600     // /usr/lib), which is exactly what we want.
 601     //
 602     // If the user does set java.library.path, it completely
 603     // overwrites this setting, and always has.
 604     //
 605     // If we&#39;re not launched by the Java launcher, we may
 606     // get here with any/all of the LD_LIBRARY_PATH[_32|64]
 607     // settings.  Again, dlinfo does exactly what we want.
 608 
 609     Dl_serinfo     info_sz, *info = &amp;info_sz;
 610     Dl_serpath     *path;
 611     char           *library_path;
 612     char           *common_path = buf;
 613 
 614     // Determine search path count and required buffer size.
 615     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFOSIZE, (void *)info) == -1) {
 616       FREE_C_HEAP_ARRAY(char, buf);
 617       vm_exit_during_initialization(&quot;dlinfo SERINFOSIZE request&quot;, dlerror());
 618     }
 619 
 620     // Allocate new buffer and initialize.
 621     info = (Dl_serinfo*)NEW_C_HEAP_ARRAY(char, info_sz.dls_size, mtInternal);
 622     info-&gt;dls_size = info_sz.dls_size;
 623     info-&gt;dls_cnt = info_sz.dls_cnt;
 624 
 625     // Obtain search path information.
 626     if (dlinfo(RTLD_SELF, RTLD_DI_SERINFO, (void *)info) == -1) {
 627       FREE_C_HEAP_ARRAY(char, buf);
 628       FREE_C_HEAP_ARRAY(char, info);
 629       vm_exit_during_initialization(&quot;dlinfo SERINFO request&quot;, dlerror());
 630     }
 631 
 632     path = &amp;info-&gt;dls_serpath[0];
 633 
 634     // Note: Due to a legacy implementation, most of the library path
 635     // is set in the launcher. This was to accomodate linking restrictions
 636     // on legacy Solaris implementations (which are no longer supported).
 637     // Eventually, all the library path setting will be done here.
 638     //
 639     // However, to prevent the proliferation of improperly built native
 640     // libraries, the new path component /usr/jdk/packages is added here.
 641 
 642     // Construct the invariant part of ld_library_path.
 643     sprintf(common_path, SYS_EXT_DIR &quot;/lib&quot;);
 644 
 645     // Struct size is more than sufficient for the path components obtained
 646     // through the dlinfo() call, so only add additional space for the path
 647     // components explicitly added here.
 648     size_t library_path_size = info-&gt;dls_size + strlen(common_path);
 649     library_path = (char *)NEW_C_HEAP_ARRAY(char, library_path_size, mtInternal);
 650     library_path[0] = &#39;\0&#39;;
 651 
 652     // Construct the desired Java library path from the linker&#39;s library
 653     // search path.
 654     //
 655     // For compatibility, it is optimal that we insert the additional path
 656     // components specific to the Java VM after those components specified
 657     // in LD_LIBRARY_PATH (if any) but before those added by the ld.so
 658     // infrastructure.
 659     if (info-&gt;dls_cnt == 0) { // Not sure this can happen, but allow for it.
 660       strcpy(library_path, common_path);
 661     } else {
 662       int inserted = 0;
 663       int i;
 664       for (i = 0; i &lt; info-&gt;dls_cnt; i++, path++) {
 665         uint_t flags = path-&gt;dls_flags &amp; LA_SER_MASK;
 666         if (((flags &amp; LA_SER_LIBPATH) == 0) &amp;&amp; !inserted) {
 667           strcat(library_path, common_path);
 668           strcat(library_path, os::path_separator());
 669           inserted = 1;
 670         }
 671         strcat(library_path, path-&gt;dls_name);
 672         strcat(library_path, os::path_separator());
 673       }
 674       // Eliminate trailing path separator.
 675       library_path[strlen(library_path)-1] = &#39;\0&#39;;
 676     }
 677 
 678     // happens before argument parsing - can&#39;t use a trace flag
 679     // tty-&gt;print_raw(&quot;init_system_properties_values: native lib path: &quot;);
 680     // tty-&gt;print_raw_cr(library_path);
 681 
 682     // Callee copies into its own buffer.
 683     Arguments::set_library_path(library_path);
 684 
 685     FREE_C_HEAP_ARRAY(char, library_path);
 686     FREE_C_HEAP_ARRAY(char, info);
 687   }
 688 
 689   // Extensions directories.
 690   sprintf(buf, &quot;%s&quot; EXTENSIONS_DIR &quot;:&quot; SYS_EXT_DIR EXTENSIONS_DIR, Arguments::get_java_home());
 691   Arguments::set_ext_dirs(buf);
 692 
 693   FREE_C_HEAP_ARRAY(char, buf);
 694 
 695 #undef SYS_EXT_DIR
 696 #undef EXTENSIONS_DIR
 697 }
 698 
 699 void os::breakpoint() {
 700   BREAKPOINT;
 701 }
 702 
 703 bool os::Solaris::valid_stack_address(Thread* thread, address sp) {
 704   address  stackStart  = (address)thread-&gt;stack_base();
 705   address  stackEnd    = (address)(stackStart - (address)thread-&gt;stack_size());
 706   if (sp &lt; stackStart &amp;&amp; sp &gt;= stackEnd) return true;
 707   return false;
 708 }
 709 
 710 extern &quot;C&quot; void breakpoint() {
 711   // use debugger to set breakpoint here
 712 }
 713 
 714 static thread_t main_thread;
 715 
 716 // Thread start routine for all newly created threads
 717 extern &quot;C&quot; void* thread_native_entry(void* thread_addr) {
 718 
 719   Thread* thread = (Thread*)thread_addr;
 720 
 721   thread-&gt;record_stack_base_and_size();
 722 
 723   // Try to randomize the cache line index of hot stack frames.
 724   // This helps when threads of the same stack traces evict each other&#39;s
 725   // cache lines. The threads can be either from the same JVM instance, or
 726   // from different JVM instances. The benefit is especially true for
 727   // processors with hyperthreading technology.
 728   static int counter = 0;
 729   int pid = os::current_process_id();
 730   alloca(((pid ^ counter++) &amp; 7) * 128);
 731 
 732   int prio;
 733 
 734   thread-&gt;initialize_thread_current();
 735 
 736   OSThread* osthr = thread-&gt;osthread();
 737 
 738   osthr-&gt;set_lwp_id(_lwp_self());  // Store lwp in case we are bound
 739 
 740   log_info(os, thread)(&quot;Thread is alive (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 741     os::current_thread_id());
 742 
 743   if (UseNUMA) {
 744     int lgrp_id = os::numa_get_group_id();
 745     if (lgrp_id != -1) {
 746       thread-&gt;set_lgrp_id(lgrp_id);
 747     }
 748   }
 749 
 750   // Our priority was set when we were created, and stored in the
 751   // osthread, but couldn&#39;t be passed through to our LWP until now.
 752   // So read back the priority and set it again.
 753 
 754   if (osthr-&gt;thread_id() != -1) {
 755     if (UseThreadPriorities) {
 756       int prio = osthr-&gt;native_priority();
 757       if (ThreadPriorityVerbose) {
 758         tty-&gt;print_cr(&quot;Starting Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot;
 759                       INTPTR_FORMAT &quot;, setting priority: %d\n&quot;,
 760                       osthr-&gt;thread_id(), osthr-&gt;lwp_id(), prio);
 761       }
 762       os::set_native_priority(thread, prio);
 763     }
 764   } else if (ThreadPriorityVerbose) {
 765     warning(&quot;Can&#39;t set priority in _start routine, thread id hasn&#39;t been set\n&quot;);
 766   }
 767 
 768   assert(osthr-&gt;get_state() == RUNNABLE, &quot;invalid os thread state&quot;);
 769 
 770   // initialize signal mask for this thread
 771   os::Solaris::hotspot_sigmask(thread);
 772 
 773   os::Solaris::init_thread_fpu_state();
 774   std::set_terminate(_handle_uncaught_cxx_exception);
 775 
 776   thread-&gt;call_run();
 777 
 778   // Note: at this point the thread object may already have deleted itself.
 779   // Do not dereference it from here on out.
 780 
 781   // One less thread is executing
 782   // When the VMThread gets here, the main thread may have already exited
 783   // which frees the CodeHeap containing the Atomic::dec code
 784   if (thread != VMThread::vm_thread() &amp;&amp; VMThread::vm_thread() != NULL) {
 785     Atomic::dec(&amp;os::Solaris::_os_thread_count);
 786   }
 787 
 788   log_info(os, thread)(&quot;Thread finished (tid: &quot; UINTX_FORMAT &quot;).&quot;, os::current_thread_id());
 789 
 790   if (UseDetachedThreads) {
 791     thr_exit(NULL);
 792     ShouldNotReachHere();
 793   }
 794   return NULL;
 795 }
 796 
 797 static OSThread* create_os_thread(Thread* thread, thread_t thread_id) {
 798   // Allocate the OSThread object
 799   OSThread* osthread = new OSThread(NULL, NULL);
 800   if (osthread == NULL) return NULL;
 801 
 802   // Store info on the Solaris thread into the OSThread
 803   osthread-&gt;set_thread_id(thread_id);
 804   osthread-&gt;set_lwp_id(_lwp_self());
 805 
 806   if (UseNUMA) {
 807     int lgrp_id = os::numa_get_group_id();
 808     if (lgrp_id != -1) {
 809       thread-&gt;set_lgrp_id(lgrp_id);
 810     }
 811   }
 812 
 813   if (ThreadPriorityVerbose) {
 814     tty-&gt;print_cr(&quot;In create_os_thread, Thread &quot; INTPTR_FORMAT &quot;, LWP is &quot; INTPTR_FORMAT &quot;\n&quot;,
 815                   osthread-&gt;thread_id(), osthread-&gt;lwp_id());
 816   }
 817 
 818   // Initial thread state is INITIALIZED, not SUSPENDED
 819   osthread-&gt;set_state(INITIALIZED);
 820 
 821   return osthread;
 822 }
 823 
 824 void os::Solaris::hotspot_sigmask(Thread* thread) {
 825   //Save caller&#39;s signal mask
 826   sigset_t sigmask;
 827   pthread_sigmask(SIG_SETMASK, NULL, &amp;sigmask);
 828   OSThread *osthread = thread-&gt;osthread();
 829   osthread-&gt;set_caller_sigmask(sigmask);
 830 
 831   pthread_sigmask(SIG_UNBLOCK, os::Solaris::unblocked_signals(), NULL);
 832   if (!ReduceSignalUsage) {
 833     if (thread-&gt;is_VM_thread()) {
 834       // Only the VM thread handles BREAK_SIGNAL ...
 835       pthread_sigmask(SIG_UNBLOCK, vm_signals(), NULL);
 836     } else {
 837       // ... all other threads block BREAK_SIGNAL
 838       assert(!sigismember(vm_signals(), SIGINT), &quot;SIGINT should not be blocked&quot;);
 839       pthread_sigmask(SIG_BLOCK, vm_signals(), NULL);
 840     }
 841   }
 842 }
 843 
 844 bool os::create_attached_thread(JavaThread* thread) {
 845 #ifdef ASSERT
 846   thread-&gt;verify_not_published();
 847 #endif
 848   OSThread* osthread = create_os_thread(thread, thr_self());
 849   if (osthread == NULL) {
 850     return false;
 851   }
 852 
 853   // Initial thread state is RUNNABLE
 854   osthread-&gt;set_state(RUNNABLE);
 855   thread-&gt;set_osthread(osthread);
 856 
 857   // initialize signal mask for this thread
 858   // and save the caller&#39;s signal mask
 859   os::Solaris::hotspot_sigmask(thread);
 860 
 861   log_info(os, thread)(&quot;Thread attached (tid: &quot; UINTX_FORMAT &quot;).&quot;,
 862     os::current_thread_id());
 863 
 864   return true;
 865 }
 866 
 867 bool os::create_main_thread(JavaThread* thread) {
 868 #ifdef ASSERT
 869   thread-&gt;verify_not_published();
 870 #endif
 871   if (_starting_thread == NULL) {
 872     _starting_thread = create_os_thread(thread, main_thread);
 873     if (_starting_thread == NULL) {
 874       return false;
 875     }
 876   }
 877 
 878   // The primodial thread is runnable from the start
 879   _starting_thread-&gt;set_state(RUNNABLE);
 880 
 881   thread-&gt;set_osthread(_starting_thread);
 882 
 883   // initialize signal mask for this thread
 884   // and save the caller&#39;s signal mask
 885   os::Solaris::hotspot_sigmask(thread);
 886 
 887   return true;
 888 }
 889 
 890 // Helper function to trace thread attributes, similar to os::Posix::describe_pthread_attr()
 891 static char* describe_thr_create_attributes(char* buf, size_t buflen,
 892                                             size_t stacksize, long flags) {
 893   stringStream ss(buf, buflen);
 894   ss.print(&quot;stacksize: &quot; SIZE_FORMAT &quot;k, &quot;, stacksize / 1024);
 895   ss.print(&quot;flags: &quot;);
 896   #define PRINT_FLAG(f) if (flags &amp; f) ss.print( #f &quot; &quot;);
 897   #define ALL(X) \
 898     X(THR_SUSPENDED) \
 899     X(THR_DETACHED) \
 900     X(THR_BOUND) \
 901     X(THR_NEW_LWP) \
 902     X(THR_DAEMON)
 903   ALL(PRINT_FLAG)
 904   #undef ALL
 905   #undef PRINT_FLAG
 906   return buf;
 907 }
 908 
 909 // return default stack size for thr_type
 910 size_t os::Posix::default_stack_size(os::ThreadType thr_type) {
 911   // default stack size when not specified by caller is 1M (2M for LP64)
 912   size_t s = (BytesPerWord &gt;&gt; 2) * K * K;
 913   return s;
 914 }
 915 
 916 bool os::create_thread(Thread* thread, ThreadType thr_type,
 917                        size_t req_stack_size) {
 918   // Allocate the OSThread object
 919   OSThread* osthread = new OSThread(NULL, NULL);
 920   if (osthread == NULL) {
 921     return false;
 922   }
 923 
 924   if (ThreadPriorityVerbose) {
 925     char *thrtyp;
 926     switch (thr_type) {
 927     case vm_thread:
 928       thrtyp = (char *)&quot;vm&quot;;
 929       break;
 930     case cgc_thread:
 931       thrtyp = (char *)&quot;cgc&quot;;
 932       break;
 933     case pgc_thread:
 934       thrtyp = (char *)&quot;pgc&quot;;
 935       break;
 936     case java_thread:
 937       thrtyp = (char *)&quot;java&quot;;
 938       break;
 939     case compiler_thread:
 940       thrtyp = (char *)&quot;compiler&quot;;
 941       break;
 942     case watcher_thread:
 943       thrtyp = (char *)&quot;watcher&quot;;
 944       break;
 945     default:
 946       thrtyp = (char *)&quot;unknown&quot;;
 947       break;
 948     }
 949     tty-&gt;print_cr(&quot;In create_thread, creating a %s thread\n&quot;, thrtyp);
 950   }
 951 
 952   // calculate stack size if it&#39;s not specified by caller
 953   size_t stack_size = os::Posix::get_initial_stack_size(thr_type, req_stack_size);
 954 
 955   // Initial state is ALLOCATED but not INITIALIZED
 956   osthread-&gt;set_state(ALLOCATED);
 957 
 958   if (os::Solaris::_os_thread_count &gt; os::Solaris::_os_thread_limit) {
 959     // We got lots of threads. Check if we still have some address space left.
 960     // Need to be at least 5Mb of unreserved address space. We do check by
 961     // trying to reserve some.
 962     const size_t VirtualMemoryBangSize = 20*K*K;
 963     char* mem = os::reserve_memory(VirtualMemoryBangSize);
 964     if (mem == NULL) {
 965       delete osthread;
 966       return false;
 967     } else {
 968       // Release the memory again
 969       os::release_memory(mem, VirtualMemoryBangSize);
 970     }
 971   }
 972 
 973   // Setup osthread because the child thread may need it.
 974   thread-&gt;set_osthread(osthread);
 975 
 976   // Create the Solaris thread
 977   thread_t tid = 0;
 978   long     flags = (UseDetachedThreads ? THR_DETACHED : 0) | THR_SUSPENDED;
 979   int      status;
 980 
 981   // Mark that we don&#39;t have an lwp or thread id yet.
 982   // In case we attempt to set the priority before the thread starts.
 983   osthread-&gt;set_lwp_id(-1);
 984   osthread-&gt;set_thread_id(-1);
 985 
 986   status = thr_create(NULL, stack_size, thread_native_entry, thread, flags, &amp;tid);
 987 
 988   char buf[64];
 989   if (status == 0) {
 990     log_info(os, thread)(&quot;Thread started (tid: &quot; UINTX_FORMAT &quot;, attributes: %s). &quot;,
 991       (uintx) tid, describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 992   } else {
 993     log_warning(os, thread)(&quot;Failed to start thread - thr_create failed (%s) for attributes: %s.&quot;,
 994       os::errno_name(status), describe_thr_create_attributes(buf, sizeof(buf), stack_size, flags));
 995   }
 996 
 997   if (status != 0) {
 998     thread-&gt;set_osthread(NULL);
 999     // Need to clean up stuff we&#39;ve allocated so far
1000     delete osthread;
1001     return false;
1002   }
1003 
1004   Atomic::inc(&amp;os::Solaris::_os_thread_count);
1005 
1006   // Store info on the Solaris thread into the OSThread
1007   osthread-&gt;set_thread_id(tid);
1008 
1009   // Remember that we created this thread so we can set priority on it
1010   osthread-&gt;set_vm_created();
1011 
1012   // Most thread types will set an explicit priority before starting the thread,
1013   // but for those that don&#39;t we need a valid value to read back in thread_native_entry.
1014   osthread-&gt;set_native_priority(NormPriority);
1015 
1016   // Initial thread state is INITIALIZED, not SUSPENDED
1017   osthread-&gt;set_state(INITIALIZED);
1018 
1019   // The thread is returned suspended (in state INITIALIZED), and is started higher up in the call chain
1020   return true;
1021 }
1022 
1023 debug_only(static bool signal_sets_initialized = false);
1024 static sigset_t unblocked_sigs, vm_sigs;
1025 
1026 void os::Solaris::signal_sets_init() {
1027   // Should also have an assertion stating we are still single-threaded.
1028   assert(!signal_sets_initialized, &quot;Already initialized&quot;);
1029   // Fill in signals that are necessarily unblocked for all threads in
1030   // the VM. Currently, we unblock the following signals:
1031   // SHUTDOWN{1,2,3}_SIGNAL: for shutdown hooks support (unless over-ridden
1032   //                         by -Xrs (=ReduceSignalUsage));
1033   // BREAK_SIGNAL which is unblocked only by the VM thread and blocked by all
1034   // other threads. The &quot;ReduceSignalUsage&quot; boolean tells us not to alter
1035   // the dispositions or masks wrt these signals.
1036   // Programs embedding the VM that want to use the above signals for their
1037   // own purposes must, at this time, use the &quot;-Xrs&quot; option to prevent
1038   // interference with shutdown hooks and BREAK_SIGNAL thread dumping.
1039   // (See bug 4345157, and other related bugs).
1040   // In reality, though, unblocking these signals is really a nop, since
1041   // these signals are not blocked by default.
1042   sigemptyset(&amp;unblocked_sigs);
1043   sigaddset(&amp;unblocked_sigs, SIGILL);
1044   sigaddset(&amp;unblocked_sigs, SIGSEGV);
1045   sigaddset(&amp;unblocked_sigs, SIGBUS);
1046   sigaddset(&amp;unblocked_sigs, SIGFPE);
1047   sigaddset(&amp;unblocked_sigs, ASYNC_SIGNAL);
1048 
1049   if (!ReduceSignalUsage) {
1050     if (!os::Posix::is_sig_ignored(SHUTDOWN1_SIGNAL)) {
1051       sigaddset(&amp;unblocked_sigs, SHUTDOWN1_SIGNAL);
1052     }
1053     if (!os::Posix::is_sig_ignored(SHUTDOWN2_SIGNAL)) {
1054       sigaddset(&amp;unblocked_sigs, SHUTDOWN2_SIGNAL);
1055     }
1056     if (!os::Posix::is_sig_ignored(SHUTDOWN3_SIGNAL)) {
1057       sigaddset(&amp;unblocked_sigs, SHUTDOWN3_SIGNAL);
1058     }
1059   }
1060   // Fill in signals that are blocked by all but the VM thread.
1061   sigemptyset(&amp;vm_sigs);
1062   if (!ReduceSignalUsage) {
1063     sigaddset(&amp;vm_sigs, BREAK_SIGNAL);
1064   }
1065   debug_only(signal_sets_initialized = true);
1066 
1067   // For diagnostics only used in run_periodic_checks
1068   sigemptyset(&amp;check_signal_done);
1069 }
1070 
1071 // These are signals that are unblocked while a thread is running Java.
1072 // (For some reason, they get blocked by default.)
1073 sigset_t* os::Solaris::unblocked_signals() {
1074   assert(signal_sets_initialized, &quot;Not initialized&quot;);
1075   return &amp;unblocked_sigs;
1076 }
1077 
1078 // These are the signals that are blocked while a (non-VM) thread is
1079 // running Java. Only the VM thread handles these signals.
1080 sigset_t* os::Solaris::vm_signals() {
1081   assert(signal_sets_initialized, &quot;Not initialized&quot;);
1082   return &amp;vm_sigs;
1083 }
1084 
1085 // CR 7190089: on Solaris, primordial thread&#39;s stack needs adjusting.
1086 // Without the adjustment, stack size is incorrect if stack is set to unlimited (ulimit -s unlimited).
1087 void os::Solaris::correct_stack_boundaries_for_primordial_thread(Thread* thr) {
1088   assert(is_primordial_thread(), &quot;Call only for primordial thread&quot;);
1089 
1090   JavaThread* jt = (JavaThread *)thr;
1091   assert(jt != NULL, &quot;Sanity check&quot;);
1092   size_t stack_size;
1093   address base = jt-&gt;stack_base();
1094   if (Arguments::created_by_java_launcher()) {
1095     // Use 2MB to allow for Solaris 7 64 bit mode.
1096     stack_size = JavaThread::stack_size_at_create() == 0
1097       ? 2048*K : JavaThread::stack_size_at_create();
1098 
1099     // There are rare cases when we may have already used more than
1100     // the basic stack size allotment before this method is invoked.
1101     // Attempt to allow for a normally sized java_stack.
1102     size_t current_stack_offset = (size_t)(base - (address)&amp;stack_size);
1103     stack_size += ReservedSpace::page_align_size_down(current_stack_offset);
1104   } else {
1105     // 6269555: If we were not created by a Java launcher, i.e. if we are
1106     // running embedded in a native application, treat the primordial thread
1107     // as much like a native attached thread as possible.  This means using
1108     // the current stack size from thr_stksegment(), unless it is too large
1109     // to reliably setup guard pages.  A reasonable max size is 8MB.
1110     size_t current_size = os::current_stack_size();
1111     // This should never happen, but just in case....
1112     if (current_size == 0) current_size = 2 * K * K;
1113     stack_size = current_size &gt; (8 * K * K) ? (8 * K * K) : current_size;
1114   }
1115   address bottom = align_up(base - stack_size, os::vm_page_size());;
1116   stack_size = (size_t)(base - bottom);
1117 
1118   assert(stack_size &gt; 0, &quot;Stack size calculation problem&quot;);
1119 
1120   if (stack_size &gt; jt-&gt;stack_size()) {
1121 #ifndef PRODUCT
1122     struct rlimit limits;
1123     getrlimit(RLIMIT_STACK, &amp;limits);
1124     size_t size = adjust_stack_size(base, (size_t)limits.rlim_cur);
1125     assert(size &gt;= jt-&gt;stack_size(), &quot;Stack size problem in main thread&quot;);
1126 #endif
1127     tty-&gt;print_cr(&quot;Stack size of %d Kb exceeds current limit of %d Kb.\n&quot;
1128                   &quot;(Stack sizes are rounded up to a multiple of the system page size.)\n&quot;
1129                   &quot;See limit(1) to increase the stack size limit.&quot;,
1130                   stack_size / K, jt-&gt;stack_size() / K);
1131     vm_exit(1);
1132   }
1133   assert(jt-&gt;stack_size() &gt;= stack_size,
1134          &quot;Attempt to map more stack than was allocated&quot;);
1135   jt-&gt;set_stack_size(stack_size);
1136 
1137 }
1138 
1139 
1140 
1141 // Free Solaris resources related to the OSThread
1142 void os::free_thread(OSThread* osthread) {
1143   assert(osthread != NULL, &quot;os::free_thread but osthread not set&quot;);
1144 
1145   // We are told to free resources of the argument thread,
1146   // but we can only really operate on the current thread.
1147   assert(Thread::current()-&gt;osthread() == osthread,
1148          &quot;os::free_thread but not current thread&quot;);
1149 
1150   // Restore caller&#39;s signal mask
1151   sigset_t sigmask = osthread-&gt;caller_sigmask();
1152   pthread_sigmask(SIG_SETMASK, &amp;sigmask, NULL);
1153 
1154   delete osthread;
1155 }
1156 
1157 void os::pd_start_thread(Thread* thread) {
1158   int status = thr_continue(thread-&gt;osthread()-&gt;thread_id());
1159   assert_status(status == 0, status, &quot;thr_continue failed&quot;);
1160 }
1161 
1162 
1163 intx os::current_thread_id() {
1164   return (intx)thr_self();
1165 }
1166 
1167 static pid_t _initial_pid = 0;
1168 
1169 int os::current_process_id() {
1170   return (int)(_initial_pid ? _initial_pid : getpid());
1171 }
1172 
1173 // gethrtime() should be monotonic according to the documentation,
1174 // but some virtualized platforms are known to break this guarantee.
1175 // getTimeNanos() must be guaranteed not to move backwards, so we
1176 // are forced to add a check here.
1177 inline hrtime_t getTimeNanos() {
1178   const hrtime_t now = gethrtime();
1179   const hrtime_t prev = max_hrtime;
1180   if (now &lt;= prev) {
1181     return prev;   // same or retrograde time;
1182   }
1183   const hrtime_t obsv = Atomic::cmpxchg(now, &amp;max_hrtime, prev);
1184   assert(obsv &gt;= prev, &quot;invariant&quot;);   // Monotonicity
1185   // If the CAS succeeded then we&#39;re done and return &quot;now&quot;.
1186   // If the CAS failed and the observed value &quot;obsv&quot; is &gt;= now then
1187   // we should return &quot;obsv&quot;.  If the CAS failed and now &gt; obsv &gt; prv then
1188   // some other thread raced this thread and installed a new value, in which case
1189   // we could either (a) retry the entire operation, (b) retry trying to install now
1190   // or (c) just return obsv.  We use (c).   No loop is required although in some cases
1191   // we might discard a higher &quot;now&quot; value in deference to a slightly lower but freshly
1192   // installed obsv value.   That&#39;s entirely benign -- it admits no new orderings compared
1193   // to (a) or (b) -- and greatly reduces coherence traffic.
1194   // We might also condition (c) on the magnitude of the delta between obsv and now.
1195   // Avoiding excessive CAS operations to hot RW locations is critical.
1196   // See https://blogs.oracle.com/dave/entry/cas_and_cache_trivia_invalidate
1197   return (prev == obsv) ? now : obsv;
1198 }
1199 
1200 // Time since start-up in seconds to a fine granularity.
1201 // Used by VMSelfDestructTimer and the MemProfiler.
1202 double os::elapsedTime() {
1203   return (double)(getTimeNanos() - first_hrtime) / (double)hrtime_hz;
1204 }
1205 
1206 jlong os::elapsed_counter() {
1207   return (jlong)(getTimeNanos() - first_hrtime);
1208 }
1209 
1210 jlong os::elapsed_frequency() {
1211   return hrtime_hz;
1212 }
1213 
1214 // Return the real, user, and system times in seconds from an
1215 // arbitrary fixed point in the past.
1216 bool os::getTimesSecs(double* process_real_time,
1217                       double* process_user_time,
1218                       double* process_system_time) {
1219   struct tms ticks;
1220   clock_t real_ticks = times(&amp;ticks);
1221 
1222   if (real_ticks == (clock_t) (-1)) {
1223     return false;
1224   } else {
1225     double ticks_per_second = (double) clock_tics_per_sec;
1226     *process_user_time = ((double) ticks.tms_utime) / ticks_per_second;
1227     *process_system_time = ((double) ticks.tms_stime) / ticks_per_second;
1228     // For consistency return the real time from getTimeNanos()
1229     // converted to seconds.
1230     *process_real_time = ((double) getTimeNanos()) / ((double) NANOUNITS);
1231 
1232     return true;
1233   }
1234 }
1235 
1236 bool os::supports_vtime() { return true; }
1237 bool os::enable_vtime() { return false; }
1238 bool os::vtime_enabled() { return false; }
1239 
1240 double os::elapsedVTime() {
1241   return (double)gethrvtime() / (double)hrtime_hz;
1242 }
1243 
1244 // Must return millis since Jan 1 1970 for JVM_CurrentTimeMillis
1245 jlong os::javaTimeMillis() {
1246   timeval t;
1247   if (gettimeofday(&amp;t, NULL) == -1) {
1248     fatal(&quot;os::javaTimeMillis: gettimeofday (%s)&quot;, os::strerror(errno));
1249   }
1250   return jlong(t.tv_sec) * 1000  +  jlong(t.tv_usec) / 1000;
1251 }
1252 
1253 // Must return seconds+nanos since Jan 1 1970. This must use the same
1254 // time source as javaTimeMillis and can&#39;t use get_nsec_fromepoch as
1255 // we need better than 1ms accuracy
1256 void os::javaTimeSystemUTC(jlong &amp;seconds, jlong &amp;nanos) {
1257   timeval t;
1258   if (gettimeofday(&amp;t, NULL) == -1) {
1259     fatal(&quot;os::javaTimeSystemUTC: gettimeofday (%s)&quot;, os::strerror(errno));
1260   }
1261   seconds = jlong(t.tv_sec);
1262   nanos = jlong(t.tv_usec) * 1000;
1263 }
1264 
1265 
1266 jlong os::javaTimeNanos() {
1267   return (jlong)getTimeNanos();
1268 }
1269 
1270 void os::javaTimeNanos_info(jvmtiTimerInfo *info_ptr) {
1271   info_ptr-&gt;max_value = ALL_64_BITS;      // gethrtime() uses all 64 bits
1272   info_ptr-&gt;may_skip_backward = false;    // not subject to resetting or drifting
1273   info_ptr-&gt;may_skip_forward = false;     // not subject to resetting or drifting
1274   info_ptr-&gt;kind = JVMTI_TIMER_ELAPSED;   // elapsed not CPU time
1275 }
1276 
1277 char * os::local_time_string(char *buf, size_t buflen) {
1278   struct tm t;
1279   time_t long_time;
1280   time(&amp;long_time);
1281   localtime_r(&amp;long_time, &amp;t);
1282   jio_snprintf(buf, buflen, &quot;%d-%02d-%02d %02d:%02d:%02d&quot;,
1283                t.tm_year + 1900, t.tm_mon + 1, t.tm_mday,
1284                t.tm_hour, t.tm_min, t.tm_sec);
1285   return buf;
1286 }
1287 
1288 // Note: os::shutdown() might be called very early during initialization, or
1289 // called from signal handler. Before adding something to os::shutdown(), make
1290 // sure it is async-safe and can handle partially initialized VM.
1291 void os::shutdown() {
1292 
1293   // allow PerfMemory to attempt cleanup of any persistent resources
1294   perfMemory_exit();
1295 
1296   // needs to remove object in file system
1297   AttachListener::abort();
1298 
1299   // flush buffered output, finish log files
1300   ostream_abort();
1301 
1302   // Check for abort hook
1303   abort_hook_t abort_hook = Arguments::abort_hook();
1304   if (abort_hook != NULL) {
1305     abort_hook();
1306   }
1307 }
1308 
1309 // Note: os::abort() might be called very early during initialization, or
1310 // called from signal handler. Before adding something to os::abort(), make
1311 // sure it is async-safe and can handle partially initialized VM.
1312 void os::abort(bool dump_core, void* siginfo, const void* context) {
1313   os::shutdown();
1314   if (dump_core) {
1315 #ifndef PRODUCT
1316     fdStream out(defaultStream::output_fd());
1317     out.print_raw(&quot;Current thread is &quot;);
1318     char buf[16];
1319     jio_snprintf(buf, sizeof(buf), UINTX_FORMAT, os::current_thread_id());
1320     out.print_raw_cr(buf);
1321     out.print_raw_cr(&quot;Dumping core ...&quot;);
1322 #endif
1323     ::abort(); // dump core (for debugging)
1324   }
1325 
1326   ::exit(1);
1327 }
1328 
1329 // Die immediately, no exit hook, no abort hook, no cleanup.
1330 void os::die() {
1331   ::abort(); // dump core (for debugging)
1332 }
1333 
1334 // DLL functions
1335 
1336 const char* os::dll_file_extension() { return &quot;.so&quot;; }
1337 
1338 // This must be hard coded because it&#39;s the system&#39;s temporary
1339 // directory not the java application&#39;s temp directory, ala java.io.tmpdir.
1340 const char* os::get_temp_directory() { return &quot;/tmp&quot;; }
1341 
1342 // check if addr is inside libjvm.so
1343 bool os::address_is_in_vm(address addr) {
1344   static address libjvm_base_addr;
1345   Dl_info dlinfo;
1346 
1347   if (libjvm_base_addr == NULL) {
1348     if (dladdr(CAST_FROM_FN_PTR(void *, os::address_is_in_vm), &amp;dlinfo) != 0) {
1349       libjvm_base_addr = (address)dlinfo.dli_fbase;
1350     }
1351     assert(libjvm_base_addr !=NULL, &quot;Cannot obtain base address for libjvm&quot;);
1352   }
1353 
1354   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1355     if (libjvm_base_addr == (address)dlinfo.dli_fbase) return true;
1356   }
1357 
1358   return false;
1359 }
1360 
1361 typedef int (*dladdr1_func_type)(void *, Dl_info *, void **, int);
1362 static dladdr1_func_type dladdr1_func = NULL;
1363 
1364 bool os::dll_address_to_function_name(address addr, char *buf,
1365                                       int buflen, int * offset,
1366                                       bool demangle) {
1367   // buf is not optional, but offset is optional
1368   assert(buf != NULL, &quot;sanity check&quot;);
1369 
1370   Dl_info dlinfo;
1371 
1372   // dladdr1_func was initialized in os::init()
1373   if (dladdr1_func != NULL) {
1374     // yes, we have dladdr1
1375 
1376     // Support for dladdr1 is checked at runtime; it may be
1377     // available even if the vm is built on a machine that does
1378     // not have dladdr1 support.  Make sure there is a value for
1379     // RTLD_DL_SYMENT.
1380 #ifndef RTLD_DL_SYMENT
1381   #define RTLD_DL_SYMENT 1
1382 #endif
1383 #ifdef _LP64
1384     Elf64_Sym * info;
1385 #else
1386     Elf32_Sym * info;
1387 #endif
1388     if (dladdr1_func((void *)addr, &amp;dlinfo, (void **)&amp;info,
1389                      RTLD_DL_SYMENT) != 0) {
1390       // see if we have a matching symbol that covers our address
1391       if (dlinfo.dli_saddr != NULL &amp;&amp;
1392           (char *)dlinfo.dli_saddr + info-&gt;st_size &gt; (char *)addr) {
1393         if (dlinfo.dli_sname != NULL) {
1394           if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1395             jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_sname);
1396           }
1397           if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1398           return true;
1399         }
1400       }
1401       // no matching symbol so try for just file info
1402       if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1403         if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1404                             buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1405           return true;
1406         }
1407       }
1408     }
1409     buf[0] = &#39;\0&#39;;
1410     if (offset != NULL) *offset  = -1;
1411     return false;
1412   }
1413 
1414   // no, only dladdr is available
1415   if (dladdr((void *)addr, &amp;dlinfo) != 0) {
1416     // see if we have a matching symbol
1417     if (dlinfo.dli_saddr != NULL &amp;&amp; dlinfo.dli_sname != NULL) {
1418       if (!(demangle &amp;&amp; Decoder::demangle(dlinfo.dli_sname, buf, buflen))) {
1419         jio_snprintf(buf, buflen, dlinfo.dli_sname);
1420       }
1421       if (offset != NULL) *offset = addr - (address)dlinfo.dli_saddr;
1422       return true;
1423     }
1424     // no matching symbol so try for just file info
1425     if (dlinfo.dli_fname != NULL &amp;&amp; dlinfo.dli_fbase != NULL) {
1426       if (Decoder::decode((address)(addr - (address)dlinfo.dli_fbase),
1427                           buf, buflen, offset, dlinfo.dli_fname, demangle)) {
1428         return true;
1429       }
1430     }
1431   }
1432   buf[0] = &#39;\0&#39;;
1433   if (offset != NULL) *offset  = -1;
1434   return false;
1435 }
1436 
1437 bool os::dll_address_to_library_name(address addr, char* buf,
1438                                      int buflen, int* offset) {
1439   // buf is not optional, but offset is optional
1440   assert(buf != NULL, &quot;sanity check&quot;);
1441 
1442   Dl_info dlinfo;
1443 
1444   if (dladdr((void*)addr, &amp;dlinfo) != 0) {
1445     if (dlinfo.dli_fname != NULL) {
1446       jio_snprintf(buf, buflen, &quot;%s&quot;, dlinfo.dli_fname);
1447     }
1448     if (dlinfo.dli_fbase != NULL &amp;&amp; offset != NULL) {
1449       *offset = addr - (address)dlinfo.dli_fbase;
1450     }
1451     return true;
1452   }
1453 
1454   buf[0] = &#39;\0&#39;;
1455   if (offset) *offset = -1;
1456   return false;
1457 }
1458 
1459 int os::get_loaded_modules_info(os::LoadedModulesCallbackFunc callback, void *param) {
1460   Dl_info dli;
1461   // Sanity check?
1462   if (dladdr(CAST_FROM_FN_PTR(void *, os::get_loaded_modules_info), &amp;dli) == 0 ||
1463       dli.dli_fname == NULL) {
1464     return 1;
1465   }
1466 
1467   void * handle = dlopen(dli.dli_fname, RTLD_LAZY);
1468   if (handle == NULL) {
1469     return 1;
1470   }
1471 
1472   Link_map *map;
1473   dlinfo(handle, RTLD_DI_LINKMAP, &amp;map);
1474   if (map == NULL) {
1475     dlclose(handle);
1476     return 1;
1477   }
1478 
1479   while (map-&gt;l_prev != NULL) {
1480     map = map-&gt;l_prev;
1481   }
1482 
1483   while (map != NULL) {
1484     // Iterate through all map entries and call callback with fields of interest
1485     if(callback(map-&gt;l_name, (address)map-&gt;l_addr, (address)0, param)) {
1486       dlclose(handle);
1487       return 1;
1488     }
1489     map = map-&gt;l_next;
1490   }
1491 
1492   dlclose(handle);
1493   return 0;
1494 }
1495 
1496 int _print_dll_info_cb(const char * name, address base_address, address top_address, void * param) {
1497   outputStream * out = (outputStream *) param;
1498   out-&gt;print_cr(PTR_FORMAT &quot; \t%s&quot;, base_address, name);
1499   return 0;
1500 }
1501 
1502 void os::print_dll_info(outputStream * st) {
1503   st-&gt;print_cr(&quot;Dynamic libraries:&quot;); st-&gt;flush();
1504   if (get_loaded_modules_info(_print_dll_info_cb, (void *)st)) {
1505     st-&gt;print_cr(&quot;Error: Cannot print dynamic libraries.&quot;);
1506   }
1507 }
1508 
1509 // Loads .dll/.so and
1510 // in case of error it checks if .dll/.so was built for the
1511 // same architecture as Hotspot is running on
1512 
1513 void * os::dll_load(const char *filename, char *ebuf, int ebuflen) {
1514   void * result= ::dlopen(filename, RTLD_LAZY);
1515   if (result != NULL) {
1516     // Successful loading
1517     return result;
1518   }
1519 
1520   Elf32_Ehdr elf_head;
1521 
1522   // Read system error message into ebuf
1523   // It may or may not be overwritten below
1524   ::strncpy(ebuf, ::dlerror(), ebuflen-1);
1525   ebuf[ebuflen-1]=&#39;\0&#39;;
1526   int diag_msg_max_length=ebuflen-strlen(ebuf);
1527   char* diag_msg_buf=ebuf+strlen(ebuf);
1528 
1529   if (diag_msg_max_length==0) {
1530     // No more space in ebuf for additional diagnostics message
1531     return NULL;
1532   }
1533 
1534 
1535   int file_descriptor= ::open(filename, O_RDONLY | O_NONBLOCK);
1536 
1537   if (file_descriptor &lt; 0) {
1538     // Can&#39;t open library, report dlerror() message
1539     return NULL;
1540   }
1541 
1542   bool failed_to_read_elf_head=
1543     (sizeof(elf_head)!=
1544      (::read(file_descriptor, &amp;elf_head,sizeof(elf_head))));
1545 
1546   ::close(file_descriptor);
1547   if (failed_to_read_elf_head) {
1548     // file i/o error - report dlerror() msg
1549     return NULL;
1550   }
1551 
1552   typedef struct {
1553     Elf32_Half    code;         // Actual value as defined in elf.h
1554     Elf32_Half    compat_class; // Compatibility of archs at VM&#39;s sense
1555     unsigned char elf_class;    // 32 or 64 bit
1556     unsigned char endianess;    // MSB or LSB
1557     char*         name;         // String representation
1558   } arch_t;
1559 
1560   static const arch_t arch_array[]={
1561     {EM_386,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1562     {EM_486,         EM_386,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;IA 32&quot;},
1563     {EM_IA_64,       EM_IA_64,   ELFCLASS64, ELFDATA2LSB, (char*)&quot;IA 64&quot;},
1564     {EM_X86_64,      EM_X86_64,  ELFCLASS64, ELFDATA2LSB, (char*)&quot;AMD 64&quot;},
1565     {EM_SPARC,       EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1566     {EM_SPARC32PLUS, EM_SPARC,   ELFCLASS32, ELFDATA2MSB, (char*)&quot;Sparc 32&quot;},
1567     {EM_SPARCV9,     EM_SPARCV9, ELFCLASS64, ELFDATA2MSB, (char*)&quot;Sparc v9 64&quot;},
1568     {EM_PPC,         EM_PPC,     ELFCLASS32, ELFDATA2MSB, (char*)&quot;Power PC 32&quot;},
1569     {EM_PPC64,       EM_PPC64,   ELFCLASS64, ELFDATA2MSB, (char*)&quot;Power PC 64&quot;},
1570     {EM_ARM,         EM_ARM,     ELFCLASS32, ELFDATA2LSB, (char*)&quot;ARM 32&quot;}
1571   };
1572 
1573 #if  (defined IA32)
1574   static  Elf32_Half running_arch_code=EM_386;
1575 #elif   (defined AMD64)
1576   static  Elf32_Half running_arch_code=EM_X86_64;
1577 #elif  (defined IA64)
1578   static  Elf32_Half running_arch_code=EM_IA_64;
1579 #elif  (defined __sparc) &amp;&amp; (defined _LP64)
1580   static  Elf32_Half running_arch_code=EM_SPARCV9;
1581 #elif  (defined __sparc) &amp;&amp; (!defined _LP64)
1582   static  Elf32_Half running_arch_code=EM_SPARC;
1583 #elif  (defined __powerpc64__)
1584   static  Elf32_Half running_arch_code=EM_PPC64;
1585 #elif  (defined __powerpc__)
1586   static  Elf32_Half running_arch_code=EM_PPC;
1587 #elif (defined ARM)
1588   static  Elf32_Half running_arch_code=EM_ARM;
1589 #else
1590   #error Method os::dll_load requires that one of following is defined:\
1591        IA32, AMD64, IA64, __sparc, __powerpc__, ARM, ARM
1592 #endif
1593 
1594   // Identify compatability class for VM&#39;s architecture and library&#39;s architecture
1595   // Obtain string descriptions for architectures
1596 
1597   arch_t lib_arch={elf_head.e_machine,0,elf_head.e_ident[EI_CLASS], elf_head.e_ident[EI_DATA], NULL};
1598   int running_arch_index=-1;
1599 
1600   for (unsigned int i=0; i &lt; ARRAY_SIZE(arch_array); i++) {
1601     if (running_arch_code == arch_array[i].code) {
1602       running_arch_index    = i;
1603     }
1604     if (lib_arch.code == arch_array[i].code) {
1605       lib_arch.compat_class = arch_array[i].compat_class;
1606       lib_arch.name         = arch_array[i].name;
1607     }
1608   }
1609 
1610   assert(running_arch_index != -1,
1611          &quot;Didn&#39;t find running architecture code (running_arch_code) in arch_array&quot;);
1612   if (running_arch_index == -1) {
1613     // Even though running architecture detection failed
1614     // we may still continue with reporting dlerror() message
1615     return NULL;
1616   }
1617 
1618   if (lib_arch.endianess != arch_array[running_arch_index].endianess) {
1619     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: endianness mismatch)&quot;);
1620     return NULL;
1621   }
1622 
1623   if (lib_arch.elf_class != arch_array[running_arch_index].elf_class) {
1624     ::snprintf(diag_msg_buf, diag_msg_max_length-1,&quot; (Possible cause: architecture word width mismatch)&quot;);
1625     return NULL;
1626   }
1627 
1628   if (lib_arch.compat_class != arch_array[running_arch_index].compat_class) {
1629     if (lib_arch.name!=NULL) {
1630       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1631                  &quot; (Possible cause: can&#39;t load %s-bit .so on a %s-bit platform)&quot;,
1632                  lib_arch.name, arch_array[running_arch_index].name);
1633     } else {
1634       ::snprintf(diag_msg_buf, diag_msg_max_length-1,
1635                  &quot; (Possible cause: can&#39;t load this .so (machine code=0x%x) on a %s-bit platform)&quot;,
1636                  lib_arch.code,
1637                  arch_array[running_arch_index].name);
1638     }
1639   }
1640 
1641   return NULL;
1642 }
1643 
1644 void* os::dll_lookup(void* handle, const char* name) {
1645   return dlsym(handle, name);
1646 }
1647 
1648 void* os::get_default_process_handle() {
1649   return (void*)::dlopen(NULL, RTLD_LAZY);
1650 }
1651 
1652 static inline time_t get_mtime(const char* filename) {
1653   struct stat st;
1654   int ret = os::stat(filename, &amp;st);
1655   assert(ret == 0, &quot;failed to stat() file &#39;%s&#39;: %s&quot;, filename, os::strerror(errno));
1656   return st.st_mtime;
1657 }
1658 
1659 int os::compare_file_modified_times(const char* file1, const char* file2) {
1660   time_t t1 = get_mtime(file1);
1661   time_t t2 = get_mtime(file2);
1662   return t1 - t2;
1663 }
1664 
1665 static bool _print_ascii_file(const char* filename, outputStream* st) {
1666   int fd = ::open(filename, O_RDONLY);
1667   if (fd == -1) {
1668     return false;
1669   }
1670 
1671   char buf[32];
1672   int bytes;
1673   while ((bytes = ::read(fd, buf, sizeof(buf))) &gt; 0) {
1674     st-&gt;print_raw(buf, bytes);
1675   }
1676 
1677   ::close(fd);
1678 
1679   return true;
1680 }
1681 
1682 void os::print_os_info_brief(outputStream* st) {
1683   os::Solaris::print_distro_info(st);
1684 
1685   os::Posix::print_uname_info(st);
1686 
1687   os::Solaris::print_libversion_info(st);
1688 }
1689 
1690 void os::print_os_info(outputStream* st) {
1691   st-&gt;print(&quot;OS:&quot;);
1692 
1693   os::Solaris::print_distro_info(st);
1694 
1695   os::Posix::print_uname_info(st);
1696 
1697   os::Solaris::print_libversion_info(st);
1698 
1699   os::Posix::print_rlimit_info(st);
1700 
1701   os::Posix::print_load_average(st);
1702 }
1703 
1704 void os::Solaris::print_distro_info(outputStream* st) {
1705   if (!_print_ascii_file(&quot;/etc/release&quot;, st)) {
1706     st-&gt;print(&quot;Solaris&quot;);
1707   }
1708   st-&gt;cr();
1709 }
1710 
1711 void os::get_summary_os_info(char* buf, size_t buflen) {
1712   strncpy(buf, &quot;Solaris&quot;, buflen);  // default to plain solaris
1713   FILE* fp = fopen(&quot;/etc/release&quot;, &quot;r&quot;);
1714   if (fp != NULL) {
1715     char tmp[256];
1716     // Only get the first line and chop out everything but the os name.
1717     if (fgets(tmp, sizeof(tmp), fp)) {
1718       char* ptr = tmp;
1719       // skip past whitespace characters
1720       while (*ptr != &#39;\0&#39; &amp;&amp; (*ptr == &#39; &#39; || *ptr == &#39;\t&#39; || *ptr == &#39;\n&#39;)) ptr++;
1721       if (*ptr != &#39;\0&#39;) {
1722         char* nl = strchr(ptr, &#39;\n&#39;);
1723         if (nl != NULL) *nl = &#39;\0&#39;;
1724         strncpy(buf, ptr, buflen);
1725       }
1726     }
1727     fclose(fp);
1728   }
1729 }
1730 
1731 void os::Solaris::print_libversion_info(outputStream* st) {
1732   st-&gt;print(&quot;  (T2 libthread)&quot;);
1733   st-&gt;cr();
1734 }
1735 
1736 static bool check_addr0(outputStream* st) {
1737   jboolean status = false;
1738   const int read_chunk = 200;
1739   int ret = 0;
1740   int nmap = 0;
1741   int fd = ::open(&quot;/proc/self/map&quot;,O_RDONLY);
1742   if (fd &gt;= 0) {
1743     prmap_t *p = NULL;
1744     char *mbuff = (char *) calloc(read_chunk, sizeof(prmap_t));
1745     if (NULL == mbuff) {
1746       ::close(fd);
1747       return status;
1748     }
1749     while ((ret = ::read(fd, mbuff, read_chunk*sizeof(prmap_t))) &gt; 0) {
1750       //check if read() has not read partial data
1751       if( 0 != ret % sizeof(prmap_t)){
1752         break;
1753       }
1754       nmap = ret / sizeof(prmap_t);
1755       p = (prmap_t *)mbuff;
1756       for(int i = 0; i &lt; nmap; i++){
1757         if (p-&gt;pr_vaddr == 0x0) {
1758           st-&gt;print(&quot;Warning: Address: &quot; PTR_FORMAT &quot;, Size: &quot; SIZE_FORMAT &quot;K, &quot;,p-&gt;pr_vaddr, p-&gt;pr_size/1024);
1759           st-&gt;print(&quot;Mapped file: %s, &quot;, p-&gt;pr_mapname[0] == &#39;\0&#39; ? &quot;None&quot; : p-&gt;pr_mapname);
1760           st-&gt;print(&quot;Access: &quot;);
1761           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_READ)  ? &quot;r&quot; : &quot;-&quot;);
1762           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_WRITE) ? &quot;w&quot; : &quot;-&quot;);
1763           st-&gt;print(&quot;%s&quot;,(p-&gt;pr_mflags &amp; MA_EXEC)  ? &quot;x&quot; : &quot;-&quot;);
1764           st-&gt;cr();
1765           status = true;
1766         }
1767         p++;
1768       }
1769     }
1770     free(mbuff);
1771     ::close(fd);
1772   }
1773   return status;
1774 }
1775 
1776 void os::get_summary_cpu_info(char* buf, size_t buflen) {
1777   // Get MHz with system call. We don&#39;t seem to already have this.
1778   processor_info_t stats;
1779   processorid_t id = getcpuid();
1780   int clock = 0;
1781   if (processor_info(id, &amp;stats) != -1) {
1782     clock = stats.pi_clock;  // pi_processor_type isn&#39;t more informative than below
1783   }
1784 #ifdef AMD64
1785   snprintf(buf, buflen, &quot;x86 64 bit %d MHz&quot;, clock);
1786 #else
1787   // must be sparc
1788   snprintf(buf, buflen, &quot;Sparcv9 64 bit %d MHz&quot;, clock);
1789 #endif
1790 }
1791 
1792 void os::pd_print_cpu_info(outputStream* st, char* buf, size_t buflen) {
1793   // Nothing to do for now.
1794 }
1795 
1796 void os::print_memory_info(outputStream* st) {
1797   st-&gt;print(&quot;Memory:&quot;);
1798   st-&gt;print(&quot; %dk page&quot;, os::vm_page_size()&gt;&gt;10);
1799   st-&gt;print(&quot;, physical &quot; UINT64_FORMAT &quot;k&quot;, os::physical_memory()&gt;&gt;10);
1800   st-&gt;print(&quot;(&quot; UINT64_FORMAT &quot;k free)&quot;, os::available_memory() &gt;&gt; 10);
1801   st-&gt;cr();
1802   (void) check_addr0(st);
1803 }
1804 
1805 // Moved from whole group, because we need them here for diagnostic
1806 // prints.
1807 static int Maxsignum = 0;
1808 static int *ourSigFlags = NULL;
1809 
1810 int os::Solaris::get_our_sigflags(int sig) {
1811   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1812   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1813   return ourSigFlags[sig];
1814 }
1815 
1816 void os::Solaris::set_our_sigflags(int sig, int flags) {
1817   assert(ourSigFlags!=NULL, &quot;signal data structure not initialized&quot;);
1818   assert(sig &gt; 0 &amp;&amp; sig &lt; Maxsignum, &quot;vm signal out of expected range&quot;);
1819   ourSigFlags[sig] = flags;
1820 }
1821 
1822 
1823 static const char* get_signal_handler_name(address handler,
1824                                            char* buf, int buflen) {
1825   int offset;
1826   bool found = os::dll_address_to_library_name(handler, buf, buflen, &amp;offset);
1827   if (found) {
1828     // skip directory names
1829     const char *p1, *p2;
1830     p1 = buf;
1831     size_t len = strlen(os::file_separator());
1832     while ((p2 = strstr(p1, os::file_separator())) != NULL) p1 = p2 + len;
1833     jio_snprintf(buf, buflen, &quot;%s+0x%x&quot;, p1, offset);
1834   } else {
1835     jio_snprintf(buf, buflen, PTR_FORMAT, handler);
1836   }
1837   return buf;
1838 }
1839 
1840 static void print_signal_handler(outputStream* st, int sig,
1841                                  char* buf, size_t buflen) {
1842   struct sigaction sa;
1843 
1844   sigaction(sig, NULL, &amp;sa);
1845 
1846   st-&gt;print(&quot;%s: &quot;, os::exception_name(sig, buf, buflen));
1847 
1848   address handler = (sa.sa_flags &amp; SA_SIGINFO)
1849                   ? CAST_FROM_FN_PTR(address, sa.sa_sigaction)
1850                   : CAST_FROM_FN_PTR(address, sa.sa_handler);
1851 
1852   if (handler == CAST_FROM_FN_PTR(address, SIG_DFL)) {
1853     st-&gt;print(&quot;SIG_DFL&quot;);
1854   } else if (handler == CAST_FROM_FN_PTR(address, SIG_IGN)) {
1855     st-&gt;print(&quot;SIG_IGN&quot;);
1856   } else {
1857     st-&gt;print(&quot;[%s]&quot;, get_signal_handler_name(handler, buf, buflen));
1858   }
1859 
1860   st-&gt;print(&quot;, sa_mask[0]=&quot;);
1861   os::Posix::print_signal_set_short(st, &amp;sa.sa_mask);
1862 
1863   address rh = VMError::get_resetted_sighandler(sig);
1864   // May be, handler was resetted by VMError?
1865   if (rh != NULL) {
1866     handler = rh;
1867     sa.sa_flags = VMError::get_resetted_sigflags(sig);
1868   }
1869 
1870   st-&gt;print(&quot;, sa_flags=&quot;);
1871   os::Posix::print_sa_flags(st, sa.sa_flags);
1872 
1873   // Check: is it our handler?
1874   if (handler == CAST_FROM_FN_PTR(address, signalHandler)) {
1875     // It is our signal handler
1876     // check for flags
1877     if (sa.sa_flags != os::Solaris::get_our_sigflags(sig)) {
1878       st-&gt;print(
1879                 &quot;, flags was changed from &quot; PTR32_FORMAT &quot;, consider using jsig library&quot;,
1880                 os::Solaris::get_our_sigflags(sig));
1881     }
1882   }
1883   st-&gt;cr();
1884 }
1885 
1886 void os::print_signal_handlers(outputStream* st, char* buf, size_t buflen) {
1887   st-&gt;print_cr(&quot;Signal Handlers:&quot;);
1888   print_signal_handler(st, SIGSEGV, buf, buflen);
1889   print_signal_handler(st, SIGBUS , buf, buflen);
1890   print_signal_handler(st, SIGFPE , buf, buflen);
1891   print_signal_handler(st, SIGPIPE, buf, buflen);
1892   print_signal_handler(st, SIGXFSZ, buf, buflen);
1893   print_signal_handler(st, SIGILL , buf, buflen);
1894   print_signal_handler(st, ASYNC_SIGNAL, buf, buflen);
1895   print_signal_handler(st, BREAK_SIGNAL, buf, buflen);
1896   print_signal_handler(st, SHUTDOWN1_SIGNAL , buf, buflen);
1897   print_signal_handler(st, SHUTDOWN2_SIGNAL , buf, buflen);
1898   print_signal_handler(st, SHUTDOWN3_SIGNAL, buf, buflen);
1899 }
1900 
1901 static char saved_jvm_path[MAXPATHLEN] = { 0 };
1902 
1903 // Find the full path to the current module, libjvm.so
1904 void os::jvm_path(char *buf, jint buflen) {
1905   // Error checking.
1906   if (buflen &lt; MAXPATHLEN) {
1907     assert(false, &quot;must use a large-enough buffer&quot;);
1908     buf[0] = &#39;\0&#39;;
1909     return;
1910   }
1911   // Lazy resolve the path to current module.
1912   if (saved_jvm_path[0] != 0) {
1913     strcpy(buf, saved_jvm_path);
1914     return;
1915   }
1916 
1917   Dl_info dlinfo;
1918   int ret = dladdr(CAST_FROM_FN_PTR(void *, os::jvm_path), &amp;dlinfo);
1919   assert(ret != 0, &quot;cannot locate libjvm&quot;);
1920   if (ret != 0 &amp;&amp; dlinfo.dli_fname != NULL) {
1921     if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1922       return;
1923     }
1924   } else {
1925     buf[0] = &#39;\0&#39;;
1926     return;
1927   }
1928 
1929   if (Arguments::sun_java_launcher_is_altjvm()) {
1930     // Support for the java launcher&#39;s &#39;-XXaltjvm=&lt;path&gt;&#39; option. Typical
1931     // value for buf is &quot;&lt;JAVA_HOME&gt;/jre/lib/&lt;arch&gt;/&lt;vmtype&gt;/libjvm.so&quot;.
1932     // If &quot;/jre/lib/&quot; appears at the right place in the string, then
1933     // assume we are installed in a JDK and we&#39;re done.  Otherwise, check
1934     // for a JAVA_HOME environment variable and fix up the path so it
1935     // looks like libjvm.so is installed there (append a fake suffix
1936     // hotspot/libjvm.so).
1937     const char *p = buf + strlen(buf) - 1;
1938     for (int count = 0; p &gt; buf &amp;&amp; count &lt; 5; ++count) {
1939       for (--p; p &gt; buf &amp;&amp; *p != &#39;/&#39;; --p)
1940         /* empty */ ;
1941     }
1942 
1943     if (strncmp(p, &quot;/jre/lib/&quot;, 9) != 0) {
1944       // Look for JAVA_HOME in the environment.
1945       char* java_home_var = ::getenv(&quot;JAVA_HOME&quot;);
1946       if (java_home_var != NULL &amp;&amp; java_home_var[0] != 0) {
1947         char* jrelib_p;
1948         int   len;
1949 
1950         // Check the current module name &quot;libjvm.so&quot;.
1951         p = strrchr(buf, &#39;/&#39;);
1952         assert(strstr(p, &quot;/libjvm&quot;) == p, &quot;invalid library name&quot;);
1953 
1954         if (os::Posix::realpath(java_home_var, buf, buflen) == NULL) {
1955           return;
1956         }
1957         // determine if this is a legacy image or modules image
1958         // modules image doesn&#39;t have &quot;jre&quot; subdirectory
1959         len = strlen(buf);
1960         assert(len &lt; buflen, &quot;Ran out of buffer space&quot;);
1961         jrelib_p = buf + len;
1962         snprintf(jrelib_p, buflen-len, &quot;/jre/lib&quot;);
1963         if (0 != access(buf, F_OK)) {
1964           snprintf(jrelib_p, buflen-len, &quot;/lib&quot;);
1965         }
1966 
1967         if (0 == access(buf, F_OK)) {
1968           // Use current module name &quot;libjvm.so&quot;
1969           len = strlen(buf);
1970           snprintf(buf + len, buflen-len, &quot;/hotspot/libjvm.so&quot;);
1971         } else {
1972           // Go back to path of .so
1973           if (os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen) == NULL) {
1974             return;
1975           }
1976         }
1977       }
1978     }
1979   }
1980 
1981   strncpy(saved_jvm_path, buf, MAXPATHLEN);
1982   saved_jvm_path[MAXPATHLEN - 1] = &#39;\0&#39;;
1983 }
1984 
1985 
1986 void os::print_jni_name_prefix_on(outputStream* st, int args_size) {
1987   // no prefix required, not even &quot;_&quot;
1988 }
1989 
1990 
1991 void os::print_jni_name_suffix_on(outputStream* st, int args_size) {
1992   // no suffix required
1993 }
1994 
1995 // sun.misc.Signal
1996 
1997 extern &quot;C&quot; {
1998   static void UserHandler(int sig, void *siginfo, void *context) {
1999     // Ctrl-C is pressed during error reporting, likely because the error
2000     // handler fails to abort. Let VM die immediately.
2001     if (sig == SIGINT &amp;&amp; VMError::is_error_reported()) {
2002       os::die();
2003     }
2004 
2005     os::signal_notify(sig);
2006     // We do not need to reinstate the signal handler each time...
2007   }
2008 }
2009 
2010 void* os::user_handler() {
2011   return CAST_FROM_FN_PTR(void*, UserHandler);
2012 }
2013 
2014 extern &quot;C&quot; {
2015   typedef void (*sa_handler_t)(int);
2016   typedef void (*sa_sigaction_t)(int, siginfo_t *, void *);
2017 }
2018 
2019 void* os::signal(int signal_number, void* handler) {
2020   struct sigaction sigAct, oldSigAct;
2021   sigfillset(&amp;(sigAct.sa_mask));
2022   sigAct.sa_flags = SA_RESTART &amp; ~SA_RESETHAND;
2023   sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);
2024 
2025   if (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {
2026     // -1 means registration failed
2027     return (void *)-1;
2028   }
2029 
2030   return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);
2031 }
2032 
2033 void os::signal_raise(int signal_number) {
2034   raise(signal_number);
2035 }
2036 
2037 // The following code is moved from os.cpp for making this
2038 // code platform specific, which it is by its very nature.
2039 
2040 // a counter for each possible signal value
2041 static int Sigexit = 0;
2042 static jint *pending_signals = NULL;
2043 static int *preinstalled_sigs = NULL;
2044 static struct sigaction *chainedsigactions = NULL;
2045 static Semaphore* sig_sem = NULL;
2046 
2047 int os::sigexitnum_pd() {
2048   assert(Sigexit &gt; 0, &quot;signal memory not yet initialized&quot;);
2049   return Sigexit;
2050 }
2051 
2052 void os::Solaris::init_signal_mem() {
2053   // Initialize signal structures
2054   Maxsignum = SIGRTMAX;
2055   Sigexit = Maxsignum+1;
2056   assert(Maxsignum &gt;0, &quot;Unable to obtain max signal number&quot;);
2057 
2058   // Initialize signal structures
2059   // pending_signals has one int per signal
2060   // The additional signal is for SIGEXIT - exit signal to signal_thread
2061   pending_signals = (jint *)os::malloc(sizeof(jint) * (Sigexit+1), mtInternal);
2062   memset(pending_signals, 0, (sizeof(jint) * (Sigexit+1)));
2063 
2064   if (UseSignalChaining) {
2065     chainedsigactions = (struct sigaction *)malloc(sizeof(struct sigaction)
2066                                                    * (Maxsignum + 1), mtInternal);
2067     memset(chainedsigactions, 0, (sizeof(struct sigaction) * (Maxsignum + 1)));
2068     preinstalled_sigs = (int *)os::malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
2069     memset(preinstalled_sigs, 0, (sizeof(int) * (Maxsignum + 1)));
2070   }
2071   ourSigFlags = (int*)malloc(sizeof(int) * (Maxsignum + 1), mtInternal);
2072   memset(ourSigFlags, 0, sizeof(int) * (Maxsignum + 1));
2073 }
2074 
2075 static void jdk_misc_signal_init() {
2076   // Initialize signal semaphore
2077   sig_sem = new Semaphore();
2078 }
2079 
2080 void os::signal_notify(int sig) {
2081   if (sig_sem != NULL) {
2082     Atomic::inc(&amp;pending_signals[sig]);
2083     sig_sem-&gt;signal();
2084   } else {
2085     // Signal thread is not created with ReduceSignalUsage and jdk_misc_signal_init
2086     // initialization isn&#39;t called.
2087     assert(ReduceSignalUsage, &quot;signal semaphore should be created&quot;);
2088   }
2089 }
2090 
2091 static int check_pending_signals() {
2092   int ret;
2093   while (true) {
2094     for (int i = 0; i &lt; Sigexit + 1; i++) {
2095       jint n = pending_signals[i];
2096       if (n &gt; 0 &amp;&amp; n == Atomic::cmpxchg(n - 1, &amp;pending_signals[i], n)) {
2097         return i;
2098       }
2099     }
2100     JavaThread *thread = JavaThread::current();
2101     ThreadBlockInVM tbivm(thread);
2102 
2103     bool threadIsSuspended;
2104     do {
2105       thread-&gt;set_suspend_equivalent();
2106       sig_sem-&gt;wait();
2107 
2108       // were we externally suspended while we were waiting?
2109       threadIsSuspended = thread-&gt;handle_special_suspend_equivalent_condition();
2110       if (threadIsSuspended) {
2111         // The semaphore has been incremented, but while we were waiting
2112         // another thread suspended us. We don&#39;t want to continue running
2113         // while suspended because that would surprise the thread that
2114         // suspended us.
2115         sig_sem-&gt;signal();
2116 
2117         thread-&gt;java_suspend_self();
2118       }
2119     } while (threadIsSuspended);
2120   }
2121 }
2122 
2123 int os::signal_wait() {
2124   return check_pending_signals();
2125 }
2126 
2127 ////////////////////////////////////////////////////////////////////////////////
2128 // Virtual Memory
2129 
2130 static int page_size = -1;
2131 
2132 int os::vm_page_size() {
2133   assert(page_size != -1, &quot;must call os::init&quot;);
2134   return page_size;
2135 }
2136 
2137 // Solaris allocates memory by pages.
2138 int os::vm_allocation_granularity() {
2139   assert(page_size != -1, &quot;must call os::init&quot;);
2140   return page_size;
2141 }
2142 
2143 static bool recoverable_mmap_error(int err) {
2144   // See if the error is one we can let the caller handle. This
2145   // list of errno values comes from the Solaris mmap(2) man page.
2146   switch (err) {
2147   case EBADF:
2148   case EINVAL:
2149   case ENOTSUP:
2150     // let the caller deal with these errors
2151     return true;
2152 
2153   default:
2154     // Any remaining errors on this OS can cause our reserved mapping
2155     // to be lost. That can cause confusion where different data
2156     // structures think they have the same memory mapped. The worst
2157     // scenario is if both the VM and a library think they have the
2158     // same memory mapped.
2159     return false;
2160   }
2161 }
2162 
2163 static void warn_fail_commit_memory(char* addr, size_t bytes, bool exec,
2164                                     int err) {
2165   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2166           &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes, exec,
2167           os::strerror(err), err);
2168 }
2169 
2170 static void warn_fail_commit_memory(char* addr, size_t bytes,
2171                                     size_t alignment_hint, bool exec,
2172                                     int err) {
2173   warning(&quot;INFO: os::commit_memory(&quot; PTR_FORMAT &quot;, &quot; SIZE_FORMAT
2174           &quot;, &quot; SIZE_FORMAT &quot;, %d) failed; error=&#39;%s&#39; (errno=%d)&quot;, addr, bytes,
2175           alignment_hint, exec, os::strerror(err), err);
2176 }
2177 
2178 int os::Solaris::commit_memory_impl(char* addr, size_t bytes, bool exec) {
2179   int prot = exec ? PROT_READ|PROT_WRITE|PROT_EXEC : PROT_READ|PROT_WRITE;
2180   size_t size = bytes;
2181   char *res = Solaris::mmap_chunk(addr, size, MAP_PRIVATE|MAP_FIXED, prot);
2182   if (res != NULL) {
2183     if (UseNUMAInterleaving) {
2184       numa_make_global(addr, bytes);
2185     }
2186     return 0;
2187   }
2188 
2189   int err = errno;  // save errno from mmap() call in mmap_chunk()
2190 
2191   if (!recoverable_mmap_error(err)) {
2192     warn_fail_commit_memory(addr, bytes, exec, err);
2193     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;committing reserved memory.&quot;);
2194   }
2195 
2196   return err;
2197 }
2198 
2199 bool os::pd_commit_memory(char* addr, size_t bytes, bool exec) {
2200   return Solaris::commit_memory_impl(addr, bytes, exec) == 0;
2201 }
2202 
2203 void os::pd_commit_memory_or_exit(char* addr, size_t bytes, bool exec,
2204                                   const char* mesg) {
2205   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2206   int err = os::Solaris::commit_memory_impl(addr, bytes, exec);
2207   if (err != 0) {
2208     // the caller wants all commit errors to exit with the specified mesg:
2209     warn_fail_commit_memory(addr, bytes, exec, err);
2210     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2211   }
2212 }
2213 
2214 size_t os::Solaris::page_size_for_alignment(size_t alignment) {
2215   assert(is_aligned(alignment, (size_t) vm_page_size()),
2216          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT,
2217          alignment, (size_t) vm_page_size());
2218 
2219   for (int i = 0; _page_sizes[i] != 0; i++) {
2220     if (is_aligned(alignment, _page_sizes[i])) {
2221       return _page_sizes[i];
2222     }
2223   }
2224 
2225   return (size_t) vm_page_size();
2226 }
2227 
2228 int os::Solaris::commit_memory_impl(char* addr, size_t bytes,
2229                                     size_t alignment_hint, bool exec) {
2230   int err = Solaris::commit_memory_impl(addr, bytes, exec);
2231   if (err == 0 &amp;&amp; UseLargePages &amp;&amp; alignment_hint &gt; 0) {
2232     assert(is_aligned(bytes, alignment_hint),
2233            SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, alignment_hint);
2234 
2235     // The syscall memcntl requires an exact page size (see man memcntl for details).
2236     size_t page_size = page_size_for_alignment(alignment_hint);
2237     if (page_size &gt; (size_t) vm_page_size()) {
2238       (void)Solaris::setup_large_pages(addr, bytes, page_size);
2239     }
2240   }
2241   return err;
2242 }
2243 
2244 bool os::pd_commit_memory(char* addr, size_t bytes, size_t alignment_hint,
2245                           bool exec) {
2246   return Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec) == 0;
2247 }
2248 
2249 void os::pd_commit_memory_or_exit(char* addr, size_t bytes,
2250                                   size_t alignment_hint, bool exec,
2251                                   const char* mesg) {
2252   assert(mesg != NULL, &quot;mesg must be specified&quot;);
2253   int err = os::Solaris::commit_memory_impl(addr, bytes, alignment_hint, exec);
2254   if (err != 0) {
2255     // the caller wants all commit errors to exit with the specified mesg:
2256     warn_fail_commit_memory(addr, bytes, alignment_hint, exec, err);
2257     vm_exit_out_of_memory(bytes, OOM_MMAP_ERROR, &quot;%s&quot;, mesg);
2258   }
2259 }
2260 
2261 // Uncommit the pages in a specified region.
2262 void os::pd_free_memory(char* addr, size_t bytes, size_t alignment_hint) {
2263   if (madvise(addr, bytes, MADV_FREE) &lt; 0) {
2264     debug_only(warning(&quot;MADV_FREE failed.&quot;));
2265     return;
2266   }
2267 }
2268 
2269 bool os::pd_create_stack_guard_pages(char* addr, size_t size) {
2270   return os::commit_memory(addr, size, !ExecMem);
2271 }
2272 
2273 bool os::remove_stack_guard_pages(char* addr, size_t size) {
2274   return os::uncommit_memory(addr, size);
2275 }
2276 
2277 // Change the page size in a given range.
2278 void os::pd_realign_memory(char *addr, size_t bytes, size_t alignment_hint) {
2279   assert((intptr_t)addr % alignment_hint == 0, &quot;Address should be aligned.&quot;);
2280   assert((intptr_t)(addr + bytes) % alignment_hint == 0, &quot;End should be aligned.&quot;);
2281   if (UseLargePages) {
2282     size_t page_size = Solaris::page_size_for_alignment(alignment_hint);
2283     if (page_size &gt; (size_t) vm_page_size()) {
2284       Solaris::setup_large_pages(addr, bytes, page_size);
2285     }
2286   }
2287 }
2288 
2289 // Tell the OS to make the range local to the first-touching LWP
2290 void os::numa_make_local(char *addr, size_t bytes, int lgrp_hint) {
2291   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2292   if (madvise(addr, bytes, MADV_ACCESS_LWP) &lt; 0) {
2293     debug_only(warning(&quot;MADV_ACCESS_LWP failed.&quot;));
2294   }
2295 }
2296 
2297 // Tell the OS that this range would be accessed from different LWPs.
2298 void os::numa_make_global(char *addr, size_t bytes) {
2299   assert((intptr_t)addr % os::vm_page_size() == 0, &quot;Address should be page-aligned.&quot;);
2300   if (madvise(addr, bytes, MADV_ACCESS_MANY) &lt; 0) {
2301     debug_only(warning(&quot;MADV_ACCESS_MANY failed.&quot;));
2302   }
2303 }
2304 
2305 // Get the number of the locality groups.
2306 size_t os::numa_get_groups_num() {
2307   size_t n = Solaris::lgrp_nlgrps(Solaris::lgrp_cookie());
2308   return n != -1 ? n : 1;
2309 }
2310 
2311 // Get a list of leaf locality groups. A leaf lgroup is group that
2312 // doesn&#39;t have any children. Typical leaf group is a CPU or a CPU/memory
2313 // board. An LWP is assigned to one of these groups upon creation.
2314 size_t os::numa_get_leaf_groups(int *ids, size_t size) {
2315   if ((ids[0] = Solaris::lgrp_root(Solaris::lgrp_cookie())) == -1) {
2316     ids[0] = 0;
2317     return 1;
2318   }
2319   int result_size = 0, top = 1, bottom = 0, cur = 0;
2320   for (int k = 0; k &lt; size; k++) {
2321     int r = Solaris::lgrp_children(Solaris::lgrp_cookie(), ids[cur],
2322                                    (Solaris::lgrp_id_t*)&amp;ids[top], size - top);
2323     if (r == -1) {
2324       ids[0] = 0;
2325       return 1;
2326     }
2327     if (!r) {
2328       // That&#39;s a leaf node.
2329       assert(bottom &lt;= cur, &quot;Sanity check&quot;);
2330       // Check if the node has memory
2331       if (Solaris::lgrp_resources(Solaris::lgrp_cookie(), ids[cur],
2332                                   NULL, 0, LGRP_RSRC_MEM) &gt; 0) {
2333         ids[bottom++] = ids[cur];
2334       }
2335     }
2336     top += r;
2337     cur++;
2338   }
2339   if (bottom == 0) {
2340     // Handle a situation, when the OS reports no memory available.
2341     // Assume UMA architecture.
2342     ids[0] = 0;
2343     return 1;
2344   }
2345   return bottom;
2346 }
2347 
2348 // Detect the topology change. Typically happens during CPU plugging-unplugging.
2349 bool os::numa_topology_changed() {
2350   int is_stale = Solaris::lgrp_cookie_stale(Solaris::lgrp_cookie());
2351   if (is_stale != -1 &amp;&amp; is_stale) {
2352     Solaris::lgrp_fini(Solaris::lgrp_cookie());
2353     Solaris::lgrp_cookie_t c = Solaris::lgrp_init(Solaris::LGRP_VIEW_CALLER);
2354     assert(c != 0, &quot;Failure to initialize LGRP API&quot;);
2355     Solaris::set_lgrp_cookie(c);
2356     return true;
2357   }
2358   return false;
2359 }
2360 
2361 // Get the group id of the current LWP.
2362 int os::numa_get_group_id() {
2363   int lgrp_id = Solaris::lgrp_home(P_LWPID, P_MYID);
2364   if (lgrp_id == -1) {
2365     return 0;
2366   }
2367   const int size = os::numa_get_groups_num();
2368   int *ids = (int*)alloca(size * sizeof(int));
2369 
2370   // Get the ids of all lgroups with memory; r is the count.
2371   int r = Solaris::lgrp_resources(Solaris::lgrp_cookie(), lgrp_id,
2372                                   (Solaris::lgrp_id_t*)ids, size, LGRP_RSRC_MEM);
2373   if (r &lt;= 0) {
2374     return 0;
2375   }
2376   return ids[os::random() % r];
2377 }
2378 
2379 // Request information about the page.
2380 bool os::get_page_info(char *start, page_info* info) {
2381   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2382   uint64_t addr = (uintptr_t)start;
2383   uint64_t outdata[2];
2384   uint_t validity = 0;
2385 
2386   if (meminfo(&amp;addr, 1, info_types, 2, outdata, &amp;validity) &lt; 0) {
2387     return false;
2388   }
2389 
2390   info-&gt;size = 0;
2391   info-&gt;lgrp_id = -1;
2392 
2393   if ((validity &amp; 1) != 0) {
2394     if ((validity &amp; 2) != 0) {
2395       info-&gt;lgrp_id = outdata[0];
2396     }
2397     if ((validity &amp; 4) != 0) {
2398       info-&gt;size = outdata[1];
2399     }
2400     return true;
2401   }
2402   return false;
2403 }
2404 
2405 // Scan the pages from start to end until a page different than
2406 // the one described in the info parameter is encountered.
2407 char *os::scan_pages(char *start, char* end, page_info* page_expected,
2408                      page_info* page_found) {
2409   const uint_t info_types[] = { MEMINFO_VLGRP, MEMINFO_VPAGESIZE };
2410   const size_t types = sizeof(info_types) / sizeof(info_types[0]);
2411   uint64_t addrs[MAX_MEMINFO_CNT], outdata[types * MAX_MEMINFO_CNT + 1];
2412   uint_t validity[MAX_MEMINFO_CNT];
2413 
2414   size_t page_size = MAX2((size_t)os::vm_page_size(), page_expected-&gt;size);
2415   uint64_t p = (uint64_t)start;
2416   while (p &lt; (uint64_t)end) {
2417     addrs[0] = p;
2418     size_t addrs_count = 1;
2419     while (addrs_count &lt; MAX_MEMINFO_CNT &amp;&amp; addrs[addrs_count - 1] + page_size &lt; (uint64_t)end) {
2420       addrs[addrs_count] = addrs[addrs_count - 1] + page_size;
2421       addrs_count++;
2422     }
2423 
2424     if (meminfo(addrs, addrs_count, info_types, types, outdata, validity) &lt; 0) {
2425       return NULL;
2426     }
2427 
2428     size_t i = 0;
2429     for (; i &lt; addrs_count; i++) {
2430       if ((validity[i] &amp; 1) != 0) {
2431         if ((validity[i] &amp; 4) != 0) {
2432           if (outdata[types * i + 1] != page_expected-&gt;size) {
2433             break;
2434           }
2435         } else if (page_expected-&gt;size != 0) {
2436           break;
2437         }
2438 
2439         if ((validity[i] &amp; 2) != 0 &amp;&amp; page_expected-&gt;lgrp_id &gt; 0) {
2440           if (outdata[types * i] != page_expected-&gt;lgrp_id) {
2441             break;
2442           }
2443         }
2444       } else {
2445         return NULL;
2446       }
2447     }
2448 
2449     if (i &lt; addrs_count) {
2450       if ((validity[i] &amp; 2) != 0) {
2451         page_found-&gt;lgrp_id = outdata[types * i];
2452       } else {
2453         page_found-&gt;lgrp_id = -1;
2454       }
2455       if ((validity[i] &amp; 4) != 0) {
2456         page_found-&gt;size = outdata[types * i + 1];
2457       } else {
2458         page_found-&gt;size = 0;
2459       }
2460       return (char*)addrs[i];
2461     }
2462 
2463     p = addrs[addrs_count - 1] + page_size;
2464   }
2465   return end;
2466 }
2467 
2468 bool os::pd_uncommit_memory(char* addr, size_t bytes) {
2469   size_t size = bytes;
2470   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2471   // uncommitted page. Otherwise, the read/write might succeed if we
2472   // have enough swap space to back the physical page.
2473   return
2474     NULL != Solaris::mmap_chunk(addr, size,
2475                                 MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE,
2476                                 PROT_NONE);
2477 }
2478 
2479 char* os::Solaris::mmap_chunk(char *addr, size_t size, int flags, int prot) {
2480   char *b = (char *)mmap(addr, size, prot, flags, os::Solaris::_dev_zero_fd, 0);
2481 
2482   if (b == MAP_FAILED) {
2483     return NULL;
2484   }
2485   return b;
2486 }
2487 
2488 char* os::Solaris::anon_mmap(char* requested_addr, size_t bytes,
2489                              size_t alignment_hint, bool fixed) {
2490   char* addr = requested_addr;
2491   int flags = MAP_PRIVATE | MAP_NORESERVE;
2492 
2493   assert(!(fixed &amp;&amp; (alignment_hint &gt; 0)),
2494          &quot;alignment hint meaningless with fixed mmap&quot;);
2495 
2496   if (fixed) {
2497     flags |= MAP_FIXED;
2498   } else if (alignment_hint &gt; (size_t) vm_page_size()) {
2499     flags |= MAP_ALIGN;
2500     addr = (char*) alignment_hint;
2501   }
2502 
2503   // Map uncommitted pages PROT_NONE so we fail early if we touch an
2504   // uncommitted page. Otherwise, the read/write might succeed if we
2505   // have enough swap space to back the physical page.
2506   return mmap_chunk(addr, bytes, flags, PROT_NONE);
2507 }
2508 
2509 char* os::pd_reserve_memory(size_t bytes, char* requested_addr,
2510                             size_t alignment_hint) {
2511   char* addr = Solaris::anon_mmap(requested_addr, bytes, alignment_hint,
2512                                   (requested_addr != NULL));
2513 
2514   guarantee(requested_addr == NULL || requested_addr == addr,
2515             &quot;OS failed to return requested mmap address.&quot;);
2516   return addr;
2517 }
2518 
2519 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr, int file_desc) {
2520   assert(file_desc &gt;= 0, &quot;file_desc is not valid&quot;);
2521   char* result = pd_attempt_reserve_memory_at(bytes, requested_addr);
2522   if (result != NULL) {
2523     if (replace_existing_mapping_with_file_mapping(result, bytes, file_desc) == NULL) {
2524       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
2525     }
2526   }
2527   return result;
2528 }
2529 
2530 // Reserve memory at an arbitrary address, only if that area is
2531 // available (and not reserved for something else).
2532 
2533 char* os::pd_attempt_reserve_memory_at(size_t bytes, char* requested_addr) {
2534   const int max_tries = 10;
2535   char* base[max_tries];
2536   size_t size[max_tries];
2537 
2538   // Solaris adds a gap between mmap&#39;ed regions.  The size of the gap
2539   // is dependent on the requested size and the MMU.  Our initial gap
2540   // value here is just a guess and will be corrected later.
2541   bool had_top_overlap = false;
2542   bool have_adjusted_gap = false;
2543   size_t gap = 0x400000;
2544 
2545   // Assert only that the size is a multiple of the page size, since
2546   // that&#39;s all that mmap requires, and since that&#39;s all we really know
2547   // about at this low abstraction level.  If we need higher alignment,
2548   // we can either pass an alignment to this method or verify alignment
2549   // in one of the methods further up the call chain.  See bug 5044738.
2550   assert(bytes % os::vm_page_size() == 0, &quot;reserving unexpected size block&quot;);
2551 
2552   // Since snv_84, Solaris attempts to honor the address hint - see 5003415.
2553   // Give it a try, if the kernel honors the hint we can return immediately.
2554   char* addr = Solaris::anon_mmap(requested_addr, bytes, 0, false);
2555 
2556   volatile int err = errno;
2557   if (addr == requested_addr) {
2558     return addr;
2559   } else if (addr != NULL) {
2560     pd_unmap_memory(addr, bytes);
2561   }
2562 
2563   if (log_is_enabled(Warning, os)) {
2564     char buf[256];
2565     buf[0] = &#39;\0&#39;;
2566     if (addr == NULL) {
2567       jio_snprintf(buf, sizeof(buf), &quot;: %s&quot;, os::strerror(err));
2568     }
2569     log_info(os)(&quot;attempt_reserve_memory_at: couldn&#39;t reserve &quot; SIZE_FORMAT &quot; bytes at &quot;
2570             PTR_FORMAT &quot;: reserve_memory_helper returned &quot; PTR_FORMAT
2571             &quot;%s&quot;, bytes, requested_addr, addr, buf);
2572   }
2573 
2574   // Address hint method didn&#39;t work.  Fall back to the old method.
2575   // In theory, once SNV becomes our oldest supported platform, this
2576   // code will no longer be needed.
2577   //
2578   // Repeatedly allocate blocks until the block is allocated at the
2579   // right spot. Give up after max_tries.
2580   int i;
2581   for (i = 0; i &lt; max_tries; ++i) {
2582     base[i] = reserve_memory(bytes);
2583 
2584     if (base[i] != NULL) {
2585       // Is this the block we wanted?
2586       if (base[i] == requested_addr) {
2587         size[i] = bytes;
2588         break;
2589       }
2590 
2591       // check that the gap value is right
2592       if (had_top_overlap &amp;&amp; !have_adjusted_gap) {
2593         size_t actual_gap = base[i-1] - base[i] - bytes;
2594         if (gap != actual_gap) {
2595           // adjust the gap value and retry the last 2 allocations
2596           assert(i &gt; 0, &quot;gap adjustment code problem&quot;);
2597           have_adjusted_gap = true;  // adjust the gap only once, just in case
2598           gap = actual_gap;
2599           log_info(os)(&quot;attempt_reserve_memory_at: adjusted gap to 0x%lx&quot;, gap);
2600           unmap_memory(base[i], bytes);
2601           unmap_memory(base[i-1], size[i-1]);
2602           i-=2;
2603           continue;
2604         }
2605       }
2606 
2607       // Does this overlap the block we wanted? Give back the overlapped
2608       // parts and try again.
2609       //
2610       // There is still a bug in this code: if top_overlap == bytes,
2611       // the overlap is offset from requested region by the value of gap.
2612       // In this case giving back the overlapped part will not work,
2613       // because we&#39;ll give back the entire block at base[i] and
2614       // therefore the subsequent allocation will not generate a new gap.
2615       // This could be fixed with a new algorithm that used larger
2616       // or variable size chunks to find the requested region -
2617       // but such a change would introduce additional complications.
2618       // It&#39;s rare enough that the planets align for this bug,
2619       // so we&#39;ll just wait for a fix for 6204603/5003415 which
2620       // will provide a mmap flag to allow us to avoid this business.
2621 
2622       size_t top_overlap = requested_addr + (bytes + gap) - base[i];
2623       if (top_overlap &gt;= 0 &amp;&amp; top_overlap &lt; bytes) {
2624         had_top_overlap = true;
2625         unmap_memory(base[i], top_overlap);
2626         base[i] += top_overlap;
2627         size[i] = bytes - top_overlap;
2628       } else {
2629         size_t bottom_overlap = base[i] + bytes - requested_addr;
2630         if (bottom_overlap &gt;= 0 &amp;&amp; bottom_overlap &lt; bytes) {
2631           if (bottom_overlap == 0) {
2632             log_info(os)(&quot;attempt_reserve_memory_at: possible alignment bug&quot;);
2633           }
2634           unmap_memory(requested_addr, bottom_overlap);
2635           size[i] = bytes - bottom_overlap;
2636         } else {
2637           size[i] = bytes;
2638         }
2639       }
2640     }
2641   }
2642 
2643   // Give back the unused reserved pieces.
2644 
2645   for (int j = 0; j &lt; i; ++j) {
2646     if (base[j] != NULL) {
2647       unmap_memory(base[j], size[j]);
2648     }
2649   }
2650 
2651   return (i &lt; max_tries) ? requested_addr : NULL;
2652 }
2653 
2654 bool os::pd_release_memory(char* addr, size_t bytes) {
2655   size_t size = bytes;
2656   return munmap(addr, size) == 0;
2657 }
2658 
2659 static bool solaris_mprotect(char* addr, size_t bytes, int prot) {
2660   assert(addr == (char*)align_down((uintptr_t)addr, os::vm_page_size()),
2661          &quot;addr must be page aligned&quot;);
2662   int retVal = mprotect(addr, bytes, prot);
2663   return retVal == 0;
2664 }
2665 
2666 // Protect memory (Used to pass readonly pages through
2667 // JNI GetArray&lt;type&gt;Elements with empty arrays.)
2668 // Also, used for serialization page and for compressed oops null pointer
2669 // checking.
2670 bool os::protect_memory(char* addr, size_t bytes, ProtType prot,
2671                         bool is_committed) {
2672   unsigned int p = 0;
2673   switch (prot) {
2674   case MEM_PROT_NONE: p = PROT_NONE; break;
2675   case MEM_PROT_READ: p = PROT_READ; break;
2676   case MEM_PROT_RW:   p = PROT_READ|PROT_WRITE; break;
2677   case MEM_PROT_RWX:  p = PROT_READ|PROT_WRITE|PROT_EXEC; break;
2678   default:
2679     ShouldNotReachHere();
2680   }
2681   // is_committed is unused.
2682   return solaris_mprotect(addr, bytes, p);
2683 }
2684 
2685 // guard_memory and unguard_memory only happens within stack guard pages.
2686 // Since ISM pertains only to the heap, guard and unguard memory should not
2687 /// happen with an ISM region.
2688 bool os::guard_memory(char* addr, size_t bytes) {
2689   return solaris_mprotect(addr, bytes, PROT_NONE);
2690 }
2691 
2692 bool os::unguard_memory(char* addr, size_t bytes) {
2693   return solaris_mprotect(addr, bytes, PROT_READ|PROT_WRITE);
2694 }
2695 
2696 // Large page support
2697 static size_t _large_page_size = 0;
2698 
2699 // Insertion sort for small arrays (descending order).
2700 static void insertion_sort_descending(size_t* array, int len) {
2701   for (int i = 0; i &lt; len; i++) {
2702     size_t val = array[i];
2703     for (size_t key = i; key &gt; 0 &amp;&amp; array[key - 1] &lt; val; --key) {
2704       size_t tmp = array[key];
2705       array[key] = array[key - 1];
2706       array[key - 1] = tmp;
2707     }
2708   }
2709 }
2710 
2711 bool os::Solaris::mpss_sanity_check(bool warn, size_t* page_size) {
2712   const unsigned int usable_count = VM_Version::page_size_count();
2713   if (usable_count == 1) {
2714     return false;
2715   }
2716 
2717   // Find the right getpagesizes interface.  When solaris 11 is the minimum
2718   // build platform, getpagesizes() (without the &#39;2&#39;) can be called directly.
2719   typedef int (*gps_t)(size_t[], int);
2720   gps_t gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes2&quot;));
2721   if (gps_func == NULL) {
2722     gps_func = CAST_TO_FN_PTR(gps_t, dlsym(RTLD_DEFAULT, &quot;getpagesizes&quot;));
2723     if (gps_func == NULL) {
2724       if (warn) {
2725         warning(&quot;MPSS is not supported by the operating system.&quot;);
2726       }
2727       return false;
2728     }
2729   }
2730 
2731   // Fill the array of page sizes.
2732   int n = (*gps_func)(_page_sizes, page_sizes_max);
2733   assert(n &gt; 0, &quot;Solaris bug?&quot;);
2734 
2735   if (n == page_sizes_max) {
2736     // Add a sentinel value (necessary only if the array was completely filled
2737     // since it is static (zeroed at initialization)).
2738     _page_sizes[--n] = 0;
2739     DEBUG_ONLY(warning(&quot;increase the size of the os::_page_sizes array.&quot;);)
2740   }
2741   assert(_page_sizes[n] == 0, &quot;missing sentinel&quot;);
2742   trace_page_sizes(&quot;available page sizes&quot;, _page_sizes, n);
2743 
2744   if (n == 1) return false;     // Only one page size available.
2745 
2746   // Skip sizes larger than 4M (or LargePageSizeInBytes if it was set) and
2747   // select up to usable_count elements.  First sort the array, find the first
2748   // acceptable value, then copy the usable sizes to the top of the array and
2749   // trim the rest.  Make sure to include the default page size :-).
2750   //
2751   // A better policy could get rid of the 4M limit by taking the sizes of the
2752   // important VM memory regions (java heap and possibly the code cache) into
2753   // account.
2754   insertion_sort_descending(_page_sizes, n);
2755   const size_t size_limit =
2756     FLAG_IS_DEFAULT(LargePageSizeInBytes) ? 4 * M : LargePageSizeInBytes;
2757   int beg;
2758   for (beg = 0; beg &lt; n &amp;&amp; _page_sizes[beg] &gt; size_limit; ++beg) /* empty */;
2759   const int end = MIN2((int)usable_count, n) - 1;
2760   for (int cur = 0; cur &lt; end; ++cur, ++beg) {
2761     _page_sizes[cur] = _page_sizes[beg];
2762   }
2763   _page_sizes[end] = vm_page_size();
2764   _page_sizes[end + 1] = 0;
2765 
2766   if (_page_sizes[end] &gt; _page_sizes[end - 1]) {
2767     // Default page size is not the smallest; sort again.
2768     insertion_sort_descending(_page_sizes, end + 1);
2769   }
2770   *page_size = _page_sizes[0];
2771 
2772   trace_page_sizes(&quot;usable page sizes&quot;, _page_sizes, end + 1);
2773   return true;
2774 }
2775 
2776 void os::large_page_init() {
2777   if (UseLargePages) {
2778     // print a warning if any large page related flag is specified on command line
2779     bool warn_on_failure = !FLAG_IS_DEFAULT(UseLargePages)        ||
2780                            !FLAG_IS_DEFAULT(LargePageSizeInBytes);
2781 
2782     UseLargePages = Solaris::mpss_sanity_check(warn_on_failure, &amp;_large_page_size);
2783   }
2784 }
2785 
2786 bool os::Solaris::is_valid_page_size(size_t bytes) {
2787   for (int i = 0; _page_sizes[i] != 0; i++) {
2788     if (_page_sizes[i] == bytes) {
2789       return true;
2790     }
2791   }
2792   return false;
2793 }
2794 
2795 bool os::Solaris::setup_large_pages(caddr_t start, size_t bytes, size_t align) {
2796   assert(is_valid_page_size(align), SIZE_FORMAT &quot; is not a valid page size&quot;, align);
2797   assert(is_aligned((void*) start, align),
2798          PTR_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, p2i((void*) start), align);
2799   assert(is_aligned(bytes, align),
2800          SIZE_FORMAT &quot; is not aligned to &quot; SIZE_FORMAT, bytes, align);
2801 
2802   // Signal to OS that we want large pages for addresses
2803   // from addr, addr + bytes
2804   struct memcntl_mha mpss_struct;
2805   mpss_struct.mha_cmd = MHA_MAPSIZE_VA;
2806   mpss_struct.mha_pagesize = align;
2807   mpss_struct.mha_flags = 0;
2808   // Upon successful completion, memcntl() returns 0
2809   if (memcntl(start, bytes, MC_HAT_ADVISE, (caddr_t) &amp;mpss_struct, 0, 0)) {
2810     debug_only(warning(&quot;Attempt to use MPSS failed.&quot;));
2811     return false;
2812   }
2813   return true;
2814 }
2815 
2816 char* os::reserve_memory_special(size_t size, size_t alignment, char* addr, bool exec) {
2817   fatal(&quot;os::reserve_memory_special should not be called on Solaris.&quot;);
2818   return NULL;
2819 }
2820 
2821 bool os::release_memory_special(char* base, size_t bytes) {
2822   fatal(&quot;os::release_memory_special should not be called on Solaris.&quot;);
2823   return false;
2824 }
2825 
2826 size_t os::large_page_size() {
2827   return _large_page_size;
2828 }
2829 
2830 // MPSS allows application to commit large page memory on demand; with ISM
2831 // the entire memory region must be allocated as shared memory.
2832 bool os::can_commit_large_page_memory() {
2833   return true;
2834 }
2835 
2836 bool os::can_execute_large_page_memory() {
2837   return true;
2838 }
2839 
2840 // Sleep forever; naked call to OS-specific sleep; use with CAUTION
2841 void os::infinite_sleep() {
2842   while (true) {    // sleep forever ...
2843     ::sleep(100);   // ... 100 seconds at a time
2844   }
2845 }
2846 
2847 // Used to convert frequent JVM_Yield() to nops
2848 bool os::dont_yield() {
2849   if (DontYieldALot) {
2850     static hrtime_t last_time = 0;
2851     hrtime_t diff = getTimeNanos() - last_time;
2852 
2853     if (diff &lt; DontYieldALotInterval * 1000000) {
2854       return true;
2855     }
2856 
2857     last_time += diff;
2858 
2859     return false;
2860   } else {
2861     return false;
2862   }
2863 }
2864 
2865 // Note that yield semantics are defined by the scheduling class to which
2866 // the thread currently belongs.  Typically, yield will _not yield to
2867 // other equal or higher priority threads that reside on the dispatch queues
2868 // of other CPUs.
2869 
2870 void os::naked_yield() {
2871   thr_yield();
2872 }
2873 
2874 // Interface for setting lwp priorities.  We are using T2 libthread,
2875 // which forces the use of bound threads, so all of our threads will
2876 // be assigned to real lwp&#39;s.  Using the thr_setprio function is
2877 // meaningless in this mode so we must adjust the real lwp&#39;s priority.
2878 // The routines below implement the getting and setting of lwp priorities.
2879 //
2880 // Note: There are three priority scales used on Solaris.  Java priotities
2881 //       which range from 1 to 10, libthread &quot;thr_setprio&quot; scale which range
2882 //       from 0 to 127, and the current scheduling class of the process we
2883 //       are running in.  This is typically from -60 to +60.
2884 //       The setting of the lwp priorities in done after a call to thr_setprio
2885 //       so Java priorities are mapped to libthread priorities and we map from
2886 //       the latter to lwp priorities.  We don&#39;t keep priorities stored in
2887 //       Java priorities since some of our worker threads want to set priorities
2888 //       higher than all Java threads.
2889 //
2890 // For related information:
2891 // (1)  man -s 2 priocntl
2892 // (2)  man -s 4 priocntl
2893 // (3)  man dispadmin
2894 // =    librt.so
2895 // =    libthread/common/rtsched.c - thrp_setlwpprio().
2896 // =    ps -cL &lt;pid&gt; ... to validate priority.
2897 // =    sched_get_priority_min and _max
2898 //              pthread_create
2899 //              sched_setparam
2900 //              pthread_setschedparam
2901 //
2902 // Assumptions:
2903 // +    We assume that all threads in the process belong to the same
2904 //              scheduling class.   IE. an homogenous process.
2905 // +    Must be root or in IA group to change change &quot;interactive&quot; attribute.
2906 //              Priocntl() will fail silently.  The only indication of failure is when
2907 //              we read-back the value and notice that it hasn&#39;t changed.
2908 // +    Interactive threads enter the runq at the head, non-interactive at the tail.
2909 // +    For RT, change timeslice as well.  Invariant:
2910 //              constant &quot;priority integral&quot;
2911 //              Konst == TimeSlice * (60-Priority)
2912 //              Given a priority, compute appropriate timeslice.
2913 // +    Higher numerical values have higher priority.
2914 
2915 // sched class attributes
2916 typedef struct {
2917   int   schedPolicy;              // classID
2918   int   maxPrio;
2919   int   minPrio;
2920 } SchedInfo;
2921 
2922 
2923 static SchedInfo tsLimits, iaLimits, rtLimits, fxLimits;
2924 
2925 #ifdef ASSERT
2926 static int  ReadBackValidate = 1;
2927 #endif
2928 static int  myClass     = 0;
2929 static int  myMin       = 0;
2930 static int  myMax       = 0;
2931 static int  myCur       = 0;
2932 static bool priocntl_enable = false;
2933 
2934 static const int criticalPrio = FXCriticalPriority;
2935 static int java_MaxPriority_to_os_priority = 0; // Saved mapping
2936 
2937 
2938 // lwp_priocntl_init
2939 //
2940 // Try to determine the priority scale for our process.
2941 //
2942 // Return errno or 0 if OK.
2943 //
2944 static int lwp_priocntl_init() {
2945   int rslt;
2946   pcinfo_t ClassInfo;
2947   pcparms_t ParmInfo;
2948   int i;
2949 
2950   if (!UseThreadPriorities) return 0;
2951 
2952   // If ThreadPriorityPolicy is 1, switch tables
2953   if (ThreadPriorityPolicy == 1) {
2954     for (i = 0; i &lt; CriticalPriority+1; i++)
2955       os::java_to_os_priority[i] = prio_policy1[i];
2956   }
2957   if (UseCriticalJavaThreadPriority) {
2958     // MaxPriority always maps to the FX scheduling class and criticalPrio.
2959     // See set_native_priority() and set_lwp_class_and_priority().
2960     // Save original MaxPriority mapping in case attempt to
2961     // use critical priority fails.
2962     java_MaxPriority_to_os_priority = os::java_to_os_priority[MaxPriority];
2963     // Set negative to distinguish from other priorities
2964     os::java_to_os_priority[MaxPriority] = -criticalPrio;
2965   }
2966 
2967   // Get IDs for a set of well-known scheduling classes.
2968   // TODO-FIXME: GETCLINFO returns the current # of classes in the
2969   // the system.  We should have a loop that iterates over the
2970   // classID values, which are known to be &quot;small&quot; integers.
2971 
2972   strcpy(ClassInfo.pc_clname, &quot;TS&quot;);
2973   ClassInfo.pc_cid = -1;
2974   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2975   if (rslt &lt; 0) return errno;
2976   assert(ClassInfo.pc_cid != -1, &quot;cid for TS class is -1&quot;);
2977   tsLimits.schedPolicy = ClassInfo.pc_cid;
2978   tsLimits.maxPrio = ((tsinfo_t*)ClassInfo.pc_clinfo)-&gt;ts_maxupri;
2979   tsLimits.minPrio = -tsLimits.maxPrio;
2980 
2981   strcpy(ClassInfo.pc_clname, &quot;IA&quot;);
2982   ClassInfo.pc_cid = -1;
2983   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2984   if (rslt &lt; 0) return errno;
2985   assert(ClassInfo.pc_cid != -1, &quot;cid for IA class is -1&quot;);
2986   iaLimits.schedPolicy = ClassInfo.pc_cid;
2987   iaLimits.maxPrio = ((iainfo_t*)ClassInfo.pc_clinfo)-&gt;ia_maxupri;
2988   iaLimits.minPrio = -iaLimits.maxPrio;
2989 
2990   strcpy(ClassInfo.pc_clname, &quot;RT&quot;);
2991   ClassInfo.pc_cid = -1;
2992   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
2993   if (rslt &lt; 0) return errno;
2994   assert(ClassInfo.pc_cid != -1, &quot;cid for RT class is -1&quot;);
2995   rtLimits.schedPolicy = ClassInfo.pc_cid;
2996   rtLimits.maxPrio = ((rtinfo_t*)ClassInfo.pc_clinfo)-&gt;rt_maxpri;
2997   rtLimits.minPrio = 0;
2998 
2999   strcpy(ClassInfo.pc_clname, &quot;FX&quot;);
3000   ClassInfo.pc_cid = -1;
3001   rslt = priocntl(P_ALL, 0, PC_GETCID, (caddr_t)&amp;ClassInfo);
3002   if (rslt &lt; 0) return errno;
3003   assert(ClassInfo.pc_cid != -1, &quot;cid for FX class is -1&quot;);
3004   fxLimits.schedPolicy = ClassInfo.pc_cid;
3005   fxLimits.maxPrio = ((fxinfo_t*)ClassInfo.pc_clinfo)-&gt;fx_maxupri;
3006   fxLimits.minPrio = 0;
3007 
3008   // Query our &quot;current&quot; scheduling class.
3009   // This will normally be IA, TS or, rarely, FX or RT.
3010   memset(&amp;ParmInfo, 0, sizeof(ParmInfo));
3011   ParmInfo.pc_cid = PC_CLNULL;
3012   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
3013   if (rslt &lt; 0) return errno;
3014   myClass = ParmInfo.pc_cid;
3015 
3016   // We now know our scheduling classId, get specific information
3017   // about the class.
3018   ClassInfo.pc_cid = myClass;
3019   ClassInfo.pc_clname[0] = 0;
3020   rslt = priocntl((idtype)0, 0, PC_GETCLINFO, (caddr_t)&amp;ClassInfo);
3021   if (rslt &lt; 0) return errno;
3022 
3023   if (ThreadPriorityVerbose) {
3024     tty-&gt;print_cr(&quot;lwp_priocntl_init: Class=%d(%s)...&quot;, myClass, ClassInfo.pc_clname);
3025   }
3026 
3027   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
3028   ParmInfo.pc_cid = PC_CLNULL;
3029   rslt = priocntl(P_PID, P_MYID, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
3030   if (rslt &lt; 0) return errno;
3031 
3032   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
3033     myMin = rtLimits.minPrio;
3034     myMax = rtLimits.maxPrio;
3035   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
3036     iaparms_t *iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
3037     myMin = iaLimits.minPrio;
3038     myMax = iaLimits.maxPrio;
3039     myMax = MIN2(myMax, (int)iaInfo-&gt;ia_uprilim);       // clamp - restrict
3040   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
3041     tsparms_t *tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
3042     myMin = tsLimits.minPrio;
3043     myMax = tsLimits.maxPrio;
3044     myMax = MIN2(myMax, (int)tsInfo-&gt;ts_uprilim);       // clamp - restrict
3045   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
3046     fxparms_t *fxInfo = (fxparms_t*)ParmInfo.pc_clparms;
3047     myMin = fxLimits.minPrio;
3048     myMax = fxLimits.maxPrio;
3049     myMax = MIN2(myMax, (int)fxInfo-&gt;fx_uprilim);       // clamp - restrict
3050   } else {
3051     // No clue - punt
3052     if (ThreadPriorityVerbose) {
3053       tty-&gt;print_cr(&quot;Unknown scheduling class: %s ... \n&quot;,
3054                     ClassInfo.pc_clname);
3055     }
3056     return EINVAL;      // no clue, punt
3057   }
3058 
3059   if (ThreadPriorityVerbose) {
3060     tty-&gt;print_cr(&quot;Thread priority Range: [%d..%d]\n&quot;, myMin, myMax);
3061   }
3062 
3063   priocntl_enable = true;  // Enable changing priorities
3064   return 0;
3065 }
3066 
3067 #define IAPRI(x)        ((iaparms_t *)((x).pc_clparms))
3068 #define RTPRI(x)        ((rtparms_t *)((x).pc_clparms))
3069 #define TSPRI(x)        ((tsparms_t *)((x).pc_clparms))
3070 #define FXPRI(x)        ((fxparms_t *)((x).pc_clparms))
3071 
3072 
3073 // scale_to_lwp_priority
3074 //
3075 // Convert from the libthread &quot;thr_setprio&quot; scale to our current
3076 // lwp scheduling class scale.
3077 //
3078 static int scale_to_lwp_priority(int rMin, int rMax, int x) {
3079   int v;
3080 
3081   if (x == 127) return rMax;            // avoid round-down
3082   v = (((x*(rMax-rMin)))/128)+rMin;
3083   return v;
3084 }
3085 
3086 
3087 // set_lwp_class_and_priority
3088 int set_lwp_class_and_priority(int ThreadID, int lwpid,
3089                                int newPrio, int new_class, bool scale) {
3090   int rslt;
3091   int Actual, Expected, prv;
3092   pcparms_t ParmInfo;                   // for GET-SET
3093 #ifdef ASSERT
3094   pcparms_t ReadBack;                   // for readback
3095 #endif
3096 
3097   // Set priority via PC_GETPARMS, update, PC_SETPARMS
3098   // Query current values.
3099   // TODO: accelerate this by eliminating the PC_GETPARMS call.
3100   // Cache &quot;pcparms_t&quot; in global ParmCache.
3101   // TODO: elide set-to-same-value
3102 
3103   // If something went wrong on init, don&#39;t change priorities.
3104   if (!priocntl_enable) {
3105     if (ThreadPriorityVerbose) {
3106       tty-&gt;print_cr(&quot;Trying to set priority but init failed, ignoring&quot;);
3107     }
3108     return EINVAL;
3109   }
3110 
3111   // If lwp hasn&#39;t started yet, just return
3112   // the _start routine will call us again.
3113   if (lwpid &lt;= 0) {
3114     if (ThreadPriorityVerbose) {
3115       tty-&gt;print_cr(&quot;deferring the set_lwp_class_and_priority of thread &quot;
3116                     INTPTR_FORMAT &quot; to %d, lwpid not set&quot;,
3117                     ThreadID, newPrio);
3118     }
3119     return 0;
3120   }
3121 
3122   if (ThreadPriorityVerbose) {
3123     tty-&gt;print_cr (&quot;set_lwp_class_and_priority(&quot;
3124                    INTPTR_FORMAT &quot;@&quot; INTPTR_FORMAT &quot; %d) &quot;,
3125                    ThreadID, lwpid, newPrio);
3126   }
3127 
3128   memset(&amp;ParmInfo, 0, sizeof(pcparms_t));
3129   ParmInfo.pc_cid = PC_CLNULL;
3130   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ParmInfo);
3131   if (rslt &lt; 0) return errno;
3132 
3133   int cur_class = ParmInfo.pc_cid;
3134   ParmInfo.pc_cid = (id_t)new_class;
3135 
3136   if (new_class == rtLimits.schedPolicy) {
3137     rtparms_t *rtInfo  = (rtparms_t*)ParmInfo.pc_clparms;
3138     rtInfo-&gt;rt_pri     = scale ? scale_to_lwp_priority(rtLimits.minPrio,
3139                                                        rtLimits.maxPrio, newPrio)
3140                                : newPrio;
3141     rtInfo-&gt;rt_tqsecs  = RT_NOCHANGE;
3142     rtInfo-&gt;rt_tqnsecs = RT_NOCHANGE;
3143     if (ThreadPriorityVerbose) {
3144       tty-&gt;print_cr(&quot;RT: %d-&gt;%d\n&quot;, newPrio, rtInfo-&gt;rt_pri);
3145     }
3146   } else if (new_class == iaLimits.schedPolicy) {
3147     iaparms_t* iaInfo  = (iaparms_t*)ParmInfo.pc_clparms;
3148     int maxClamped     = MIN2(iaLimits.maxPrio,
3149                               cur_class == new_class
3150                               ? (int)iaInfo-&gt;ia_uprilim : iaLimits.maxPrio);
3151     iaInfo-&gt;ia_upri    = scale ? scale_to_lwp_priority(iaLimits.minPrio,
3152                                                        maxClamped, newPrio)
3153                                : newPrio;
3154     iaInfo-&gt;ia_uprilim = cur_class == new_class
3155                            ? IA_NOCHANGE : (pri_t)iaLimits.maxPrio;
3156     iaInfo-&gt;ia_mode    = IA_NOCHANGE;
3157     if (ThreadPriorityVerbose) {
3158       tty-&gt;print_cr(&quot;IA: [%d...%d] %d-&gt;%d\n&quot;,
3159                     iaLimits.minPrio, maxClamped, newPrio, iaInfo-&gt;ia_upri);
3160     }
3161   } else if (new_class == tsLimits.schedPolicy) {
3162     tsparms_t* tsInfo  = (tsparms_t*)ParmInfo.pc_clparms;
3163     int maxClamped     = MIN2(tsLimits.maxPrio,
3164                               cur_class == new_class
3165                               ? (int)tsInfo-&gt;ts_uprilim : tsLimits.maxPrio);
3166     tsInfo-&gt;ts_upri    = scale ? scale_to_lwp_priority(tsLimits.minPrio,
3167                                                        maxClamped, newPrio)
3168                                : newPrio;
3169     tsInfo-&gt;ts_uprilim = cur_class == new_class
3170                            ? TS_NOCHANGE : (pri_t)tsLimits.maxPrio;
3171     if (ThreadPriorityVerbose) {
3172       tty-&gt;print_cr(&quot;TS: [%d...%d] %d-&gt;%d\n&quot;,
3173                     tsLimits.minPrio, maxClamped, newPrio, tsInfo-&gt;ts_upri);
3174     }
3175   } else if (new_class == fxLimits.schedPolicy) {
3176     fxparms_t* fxInfo  = (fxparms_t*)ParmInfo.pc_clparms;
3177     int maxClamped     = MIN2(fxLimits.maxPrio,
3178                               cur_class == new_class
3179                               ? (int)fxInfo-&gt;fx_uprilim : fxLimits.maxPrio);
3180     fxInfo-&gt;fx_upri    = scale ? scale_to_lwp_priority(fxLimits.minPrio,
3181                                                        maxClamped, newPrio)
3182                                : newPrio;
3183     fxInfo-&gt;fx_uprilim = cur_class == new_class
3184                            ? FX_NOCHANGE : (pri_t)fxLimits.maxPrio;
3185     fxInfo-&gt;fx_tqsecs  = FX_NOCHANGE;
3186     fxInfo-&gt;fx_tqnsecs = FX_NOCHANGE;
3187     if (ThreadPriorityVerbose) {
3188       tty-&gt;print_cr(&quot;FX: [%d...%d] %d-&gt;%d\n&quot;,
3189                     fxLimits.minPrio, maxClamped, newPrio, fxInfo-&gt;fx_upri);
3190     }
3191   } else {
3192     if (ThreadPriorityVerbose) {
3193       tty-&gt;print_cr(&quot;Unknown new scheduling class %d\n&quot;, new_class);
3194     }
3195     return EINVAL;    // no clue, punt
3196   }
3197 
3198   rslt = priocntl(P_LWPID, lwpid, PC_SETPARMS, (caddr_t)&amp;ParmInfo);
3199   if (ThreadPriorityVerbose &amp;&amp; rslt) {
3200     tty-&gt;print_cr (&quot;PC_SETPARMS -&gt;%d %d\n&quot;, rslt, errno);
3201   }
3202   if (rslt &lt; 0) return errno;
3203 
3204 #ifdef ASSERT
3205   // Sanity check: read back what we just attempted to set.
3206   // In theory it could have changed in the interim ...
3207   //
3208   // The priocntl system call is tricky.
3209   // Sometimes it&#39;ll validate the priority value argument and
3210   // return EINVAL if unhappy.  At other times it fails silently.
3211   // Readbacks are prudent.
3212 
3213   if (!ReadBackValidate) return 0;
3214 
3215   memset(&amp;ReadBack, 0, sizeof(pcparms_t));
3216   ReadBack.pc_cid = PC_CLNULL;
3217   rslt = priocntl(P_LWPID, lwpid, PC_GETPARMS, (caddr_t)&amp;ReadBack);
3218   assert(rslt &gt;= 0, &quot;priocntl failed&quot;);
3219   Actual = Expected = 0xBAD;
3220   assert(ParmInfo.pc_cid == ReadBack.pc_cid, &quot;cid&#39;s don&#39;t match&quot;);
3221   if (ParmInfo.pc_cid == rtLimits.schedPolicy) {
3222     Actual   = RTPRI(ReadBack)-&gt;rt_pri;
3223     Expected = RTPRI(ParmInfo)-&gt;rt_pri;
3224   } else if (ParmInfo.pc_cid == iaLimits.schedPolicy) {
3225     Actual   = IAPRI(ReadBack)-&gt;ia_upri;
3226     Expected = IAPRI(ParmInfo)-&gt;ia_upri;
3227   } else if (ParmInfo.pc_cid == tsLimits.schedPolicy) {
3228     Actual   = TSPRI(ReadBack)-&gt;ts_upri;
3229     Expected = TSPRI(ParmInfo)-&gt;ts_upri;
3230   } else if (ParmInfo.pc_cid == fxLimits.schedPolicy) {
3231     Actual   = FXPRI(ReadBack)-&gt;fx_upri;
3232     Expected = FXPRI(ParmInfo)-&gt;fx_upri;
3233   } else {
3234     if (ThreadPriorityVerbose) {
3235       tty-&gt;print_cr(&quot;set_lwp_class_and_priority: unexpected class in readback: %d\n&quot;,
3236                     ParmInfo.pc_cid);
3237     }
3238   }
3239 
3240   if (Actual != Expected) {
3241     if (ThreadPriorityVerbose) {
3242       tty-&gt;print_cr (&quot;set_lwp_class_and_priority(%d %d) Class=%d: actual=%d vs expected=%d\n&quot;,
3243                      lwpid, newPrio, ReadBack.pc_cid, Actual, Expected);
3244     }
3245   }
3246 #endif
3247 
3248   return 0;
3249 }
3250 
3251 // Solaris only gives access to 128 real priorities at a time,
3252 // so we expand Java&#39;s ten to fill this range.  This would be better
3253 // if we dynamically adjusted relative priorities.
3254 //
3255 // The ThreadPriorityPolicy option allows us to select 2 different
3256 // priority scales.
3257 //
3258 // ThreadPriorityPolicy=0
3259 // Since the Solaris&#39; default priority is MaximumPriority, we do not
3260 // set a priority lower than Max unless a priority lower than
3261 // NormPriority is requested.
3262 //
3263 // ThreadPriorityPolicy=1
3264 // This mode causes the priority table to get filled with
3265 // linear values.  NormPriority get&#39;s mapped to 50% of the
3266 // Maximum priority an so on.  This will cause VM threads
3267 // to get unfair treatment against other Solaris processes
3268 // which do not explicitly alter their thread priorities.
3269 
3270 int os::java_to_os_priority[CriticalPriority + 1] = {
3271   -99999,         // 0 Entry should never be used
3272 
3273   0,              // 1 MinPriority
3274   32,             // 2
3275   64,             // 3
3276 
3277   96,             // 4
3278   127,            // 5 NormPriority
3279   127,            // 6
3280 
3281   127,            // 7
3282   127,            // 8
3283   127,            // 9 NearMaxPriority
3284 
3285   127,            // 10 MaxPriority
3286 
3287   -criticalPrio   // 11 CriticalPriority
3288 };
3289 
3290 OSReturn os::set_native_priority(Thread* thread, int newpri) {
3291   OSThread* osthread = thread-&gt;osthread();
3292 
3293   // Save requested priority in case the thread hasn&#39;t been started
3294   osthread-&gt;set_native_priority(newpri);
3295 
3296   // Check for critical priority request
3297   bool fxcritical = false;
3298   if (newpri == -criticalPrio) {
3299     fxcritical = true;
3300     newpri = criticalPrio;
3301   }
3302 
3303   assert(newpri &gt;= MinimumPriority &amp;&amp; newpri &lt;= MaximumPriority, &quot;bad priority mapping&quot;);
3304   if (!UseThreadPriorities) return OS_OK;
3305 
3306   int status = 0;
3307 
3308   if (!fxcritical) {
3309     // Use thr_setprio only if we have a priority that thr_setprio understands
3310     status = thr_setprio(thread-&gt;osthread()-&gt;thread_id(), newpri);
3311   }
3312 
3313   int lwp_status =
3314           set_lwp_class_and_priority(osthread-&gt;thread_id(),
3315                                      osthread-&gt;lwp_id(),
3316                                      newpri,
3317                                      fxcritical ? fxLimits.schedPolicy : myClass,
3318                                      !fxcritical);
3319   if (lwp_status != 0 &amp;&amp; fxcritical) {
3320     // Try again, this time without changing the scheduling class
3321     newpri = java_MaxPriority_to_os_priority;
3322     lwp_status = set_lwp_class_and_priority(osthread-&gt;thread_id(),
3323                                             osthread-&gt;lwp_id(),
3324                                             newpri, myClass, false);
3325   }
3326   status |= lwp_status;
3327   return (status == 0) ? OS_OK : OS_ERR;
3328 }
3329 
3330 
3331 OSReturn os::get_native_priority(const Thread* const thread,
3332                                  int *priority_ptr) {
3333   int p;
3334   if (!UseThreadPriorities) {
3335     *priority_ptr = NormalPriority;
3336     return OS_OK;
3337   }
3338   int status = thr_getprio(thread-&gt;osthread()-&gt;thread_id(), &amp;p);
3339   if (status != 0) {
3340     return OS_ERR;
3341   }
3342   *priority_ptr = p;
3343   return OS_OK;
3344 }
3345 
3346 ////////////////////////////////////////////////////////////////////////////////
3347 // suspend/resume support
3348 
3349 //  The low-level signal-based suspend/resume support is a remnant from the
3350 //  old VM-suspension that used to be for java-suspension, safepoints etc,
3351 //  within hotspot. Currently used by JFR&#39;s OSThreadSampler
3352 //
3353 //  The remaining code is greatly simplified from the more general suspension
3354 //  code that used to be used.
3355 //
3356 //  The protocol is quite simple:
3357 //  - suspend:
3358 //      - sends a signal to the target thread
3359 //      - polls the suspend state of the osthread using a yield loop
3360 //      - target thread signal handler (SR_handler) sets suspend state
3361 //        and blocks in sigsuspend until continued
3362 //  - resume:
3363 //      - sets target osthread state to continue
3364 //      - sends signal to end the sigsuspend loop in the SR_handler
3365 //
3366 //  Note that the SR_lock plays no role in this suspend/resume protocol,
3367 //  but is checked for NULL in SR_handler as a thread termination indicator.
3368 //  The SR_lock is, however, used by JavaThread::java_suspend()/java_resume() APIs.
3369 //
3370 //  Note that resume_clear_context() and suspend_save_context() are needed
3371 //  by SR_handler(), so that fetch_frame_from_ucontext() works,
3372 //  which in part is used by:
3373 //    - Forte Analyzer: AsyncGetCallTrace()
3374 //    - StackBanging: get_frame_at_stack_banging_point()
3375 //    - JFR: get_topframe()--&gt;....--&gt;get_valid_uc_in_signal_handler()
3376 
3377 static void resume_clear_context(OSThread *osthread) {
3378   osthread-&gt;set_ucontext(NULL);
3379 }
3380 
3381 static void suspend_save_context(OSThread *osthread, ucontext_t* context) {
3382   osthread-&gt;set_ucontext(context);
3383 }
3384 
3385 static PosixSemaphore sr_semaphore;
3386 
3387 void os::Solaris::SR_handler(Thread* thread, ucontext_t* context) {
3388   // Save and restore errno to avoid confusing native code with EINTR
3389   // after sigsuspend.
3390   int old_errno = errno;
3391 
3392   OSThread* osthread = thread-&gt;osthread();
3393   assert(thread-&gt;is_VM_thread() || thread-&gt;is_Java_thread(), &quot;Must be VMThread or JavaThread&quot;);
3394 
3395   os::SuspendResume::State current = osthread-&gt;sr.state();
3396   if (current == os::SuspendResume::SR_SUSPEND_REQUEST) {
3397     suspend_save_context(osthread, context);
3398 
3399     // attempt to switch the state, we assume we had a SUSPEND_REQUEST
3400     os::SuspendResume::State state = osthread-&gt;sr.suspended();
3401     if (state == os::SuspendResume::SR_SUSPENDED) {
3402       sigset_t suspend_set;  // signals for sigsuspend()
3403 
3404       // get current set of blocked signals and unblock resume signal
3405       pthread_sigmask(SIG_BLOCK, NULL, &amp;suspend_set);
3406       sigdelset(&amp;suspend_set, ASYNC_SIGNAL);
3407 
3408       sr_semaphore.signal();
3409       // wait here until we are resumed
3410       while (1) {
3411         sigsuspend(&amp;suspend_set);
3412 
3413         os::SuspendResume::State result = osthread-&gt;sr.running();
3414         if (result == os::SuspendResume::SR_RUNNING) {
3415           sr_semaphore.signal();
3416           break;
3417         }
3418       }
3419 
3420     } else if (state == os::SuspendResume::SR_RUNNING) {
3421       // request was cancelled, continue
3422     } else {
3423       ShouldNotReachHere();
3424     }
3425 
3426     resume_clear_context(osthread);
3427   } else if (current == os::SuspendResume::SR_RUNNING) {
3428     // request was cancelled, continue
3429   } else if (current == os::SuspendResume::SR_WAKEUP_REQUEST) {
3430     // ignore
3431   } else {
3432     // ignore
3433   }
3434 
3435   errno = old_errno;
3436 }
3437 
3438 void os::print_statistics() {
3439 }
3440 
3441 bool os::message_box(const char* title, const char* message) {
3442   int i;
3443   fdStream err(defaultStream::error_fd());
3444   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3445   err.cr();
3446   err.print_raw_cr(title);
3447   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;-&quot;);
3448   err.cr();
3449   err.print_raw_cr(message);
3450   for (i = 0; i &lt; 78; i++) err.print_raw(&quot;=&quot;);
3451   err.cr();
3452 
3453   char buf[16];
3454   // Prevent process from exiting upon &quot;read error&quot; without consuming all CPU
3455   while (::read(0, buf, sizeof(buf)) &lt;= 0) { ::sleep(100); }
3456 
3457   return buf[0] == &#39;y&#39; || buf[0] == &#39;Y&#39;;
3458 }
3459 
3460 static int sr_notify(OSThread* osthread) {
3461   int status = thr_kill(osthread-&gt;thread_id(), ASYNC_SIGNAL);
3462   assert_status(status == 0, status, &quot;thr_kill&quot;);
3463   return status;
3464 }
3465 
3466 // &quot;Randomly&quot; selected value for how long we want to spin
3467 // before bailing out on suspending a thread, also how often
3468 // we send a signal to a thread we want to resume
3469 static const int RANDOMLY_LARGE_INTEGER = 1000000;
3470 static const int RANDOMLY_LARGE_INTEGER2 = 100;
3471 
3472 static bool do_suspend(OSThread* osthread) {
3473   assert(osthread-&gt;sr.is_running(), &quot;thread should be running&quot;);
3474   assert(!sr_semaphore.trywait(), &quot;semaphore has invalid state&quot;);
3475 
3476   // mark as suspended and send signal
3477   if (osthread-&gt;sr.request_suspend() != os::SuspendResume::SR_SUSPEND_REQUEST) {
3478     // failed to switch, state wasn&#39;t running?
3479     ShouldNotReachHere();
3480     return false;
3481   }
3482 
3483   if (sr_notify(osthread) != 0) {
3484     ShouldNotReachHere();
3485   }
3486 
3487   // managed to send the signal and switch to SUSPEND_REQUEST, now wait for SUSPENDED
3488   while (true) {
3489     if (sr_semaphore.timedwait(2000)) {
3490       break;
3491     } else {
3492       // timeout
3493       os::SuspendResume::State cancelled = osthread-&gt;sr.cancel_suspend();
3494       if (cancelled == os::SuspendResume::SR_RUNNING) {
3495         return false;
3496       } else if (cancelled == os::SuspendResume::SR_SUSPENDED) {
3497         // make sure that we consume the signal on the semaphore as well
3498         sr_semaphore.wait();
3499         break;
3500       } else {
3501         ShouldNotReachHere();
3502         return false;
3503       }
3504     }
3505   }
3506 
3507   guarantee(osthread-&gt;sr.is_suspended(), &quot;Must be suspended&quot;);
3508   return true;
3509 }
3510 
3511 static void do_resume(OSThread* osthread) {
3512   assert(osthread-&gt;sr.is_suspended(), &quot;thread should be suspended&quot;);
3513   assert(!sr_semaphore.trywait(), &quot;invalid semaphore state&quot;);
3514 
3515   if (osthread-&gt;sr.request_wakeup() != os::SuspendResume::SR_WAKEUP_REQUEST) {
3516     // failed to switch to WAKEUP_REQUEST
3517     ShouldNotReachHere();
3518     return;
3519   }
3520 
3521   while (true) {
3522     if (sr_notify(osthread) == 0) {
3523       if (sr_semaphore.timedwait(2)) {
3524         if (osthread-&gt;sr.is_running()) {
3525           return;
3526         }
3527       }
3528     } else {
3529       ShouldNotReachHere();
3530     }
3531   }
3532 
3533   guarantee(osthread-&gt;sr.is_running(), &quot;Must be running!&quot;);
3534 }
3535 
3536 void os::SuspendedThreadTask::internal_do_task() {
3537   if (do_suspend(_thread-&gt;osthread())) {
3538     SuspendedThreadTaskContext context(_thread, _thread-&gt;osthread()-&gt;ucontext());
3539     do_task(context);
3540     do_resume(_thread-&gt;osthread());
3541   }
3542 }
3543 
3544 // This does not do anything on Solaris. This is basically a hook for being
3545 // able to use structured exception handling (thread-local exception filters) on, e.g., Win32.
3546 void os::os_exception_wrapper(java_call_t f, JavaValue* value,
3547                               const methodHandle&amp; method, JavaCallArguments* args,
3548                               Thread* thread) {
3549   f(value, method, args, thread);
3550 }
3551 
3552 // This routine may be used by user applications as a &quot;hook&quot; to catch signals.
3553 // The user-defined signal handler must pass unrecognized signals to this
3554 // routine, and if it returns true (non-zero), then the signal handler must
3555 // return immediately.  If the flag &quot;abort_if_unrecognized&quot; is true, then this
3556 // routine will never retun false (zero), but instead will execute a VM panic
3557 // routine kill the process.
3558 //
3559 // If this routine returns false, it is OK to call it again.  This allows
3560 // the user-defined signal handler to perform checks either before or after
3561 // the VM performs its own checks.  Naturally, the user code would be making
3562 // a serious error if it tried to handle an exception (such as a null check
3563 // or breakpoint) that the VM was generating for its own correct operation.
3564 //
3565 // This routine may recognize any of the following kinds of signals:
3566 // SIGBUS, SIGSEGV, SIGILL, SIGFPE, BREAK_SIGNAL, SIGPIPE, SIGXFSZ,
3567 // ASYNC_SIGNAL.
3568 // It should be consulted by handlers for any of those signals.
3569 //
3570 // The caller of this routine must pass in the three arguments supplied
3571 // to the function referred to in the &quot;sa_sigaction&quot; (not the &quot;sa_handler&quot;)
3572 // field of the structure passed to sigaction().  This routine assumes that
3573 // the sa_flags field passed to sigaction() includes SA_SIGINFO and SA_RESTART.
3574 //
3575 // Note that the VM will print warnings if it detects conflicting signal
3576 // handlers, unless invoked with the option &quot;-XX:+AllowUserSignalHandlers&quot;.
3577 //
3578 extern &quot;C&quot; JNIEXPORT int JVM_handle_solaris_signal(int signo,
3579                                                    siginfo_t* siginfo,
3580                                                    void* ucontext,
3581                                                    int abort_if_unrecognized);
3582 
3583 
3584 void signalHandler(int sig, siginfo_t* info, void* ucVoid) {
3585   int orig_errno = errno;  // Preserve errno value over signal handler.
3586   JVM_handle_solaris_signal(sig, info, ucVoid, true);
3587   errno = orig_errno;
3588 }
3589 
3590 // This boolean allows users to forward their own non-matching signals
3591 // to JVM_handle_solaris_signal, harmlessly.
3592 bool os::Solaris::signal_handlers_are_installed = false;
3593 
3594 // For signal-chaining
3595 bool os::Solaris::libjsig_is_loaded = false;
3596 typedef struct sigaction *(*get_signal_t)(int);
3597 get_signal_t os::Solaris::get_signal_action = NULL;
3598 
3599 struct sigaction* os::Solaris::get_chained_signal_action(int sig) {
3600   struct sigaction *actp = NULL;
3601 
3602   if ((libjsig_is_loaded)  &amp;&amp; (sig &lt;= Maxsignum)) {
3603     // Retrieve the old signal handler from libjsig
3604     actp = (*get_signal_action)(sig);
3605   }
3606   if (actp == NULL) {
3607     // Retrieve the preinstalled signal handler from jvm
3608     actp = get_preinstalled_handler(sig);
3609   }
3610 
3611   return actp;
3612 }
3613 
3614 static bool call_chained_handler(struct sigaction *actp, int sig,
3615                                  siginfo_t *siginfo, void *context) {
3616   // Call the old signal handler
3617   if (actp-&gt;sa_handler == SIG_DFL) {
3618     // It&#39;s more reasonable to let jvm treat it as an unexpected exception
3619     // instead of taking the default action.
3620     return false;
3621   } else if (actp-&gt;sa_handler != SIG_IGN) {
3622     if ((actp-&gt;sa_flags &amp; SA_NODEFER) == 0) {
3623       // automaticlly block the signal
3624       sigaddset(&amp;(actp-&gt;sa_mask), sig);
3625     }
3626 
3627     sa_handler_t hand;
3628     sa_sigaction_t sa;
3629     bool siginfo_flag_set = (actp-&gt;sa_flags &amp; SA_SIGINFO) != 0;
3630     // retrieve the chained handler
3631     if (siginfo_flag_set) {
3632       sa = actp-&gt;sa_sigaction;
3633     } else {
3634       hand = actp-&gt;sa_handler;
3635     }
3636 
3637     if ((actp-&gt;sa_flags &amp; SA_RESETHAND) != 0) {
3638       actp-&gt;sa_handler = SIG_DFL;
3639     }
3640 
3641     // try to honor the signal mask
3642     sigset_t oset;
3643     pthread_sigmask(SIG_SETMASK, &amp;(actp-&gt;sa_mask), &amp;oset);
3644 
3645     // call into the chained handler
3646     if (siginfo_flag_set) {
3647       (*sa)(sig, siginfo, context);
3648     } else {
3649       (*hand)(sig);
3650     }
3651 
3652     // restore the signal mask
3653     pthread_sigmask(SIG_SETMASK, &amp;oset, 0);
3654   }
3655   // Tell jvm&#39;s signal handler the signal is taken care of.
3656   return true;
3657 }
3658 
3659 bool os::Solaris::chained_handler(int sig, siginfo_t* siginfo, void* context) {
3660   bool chained = false;
3661   // signal-chaining
3662   if (UseSignalChaining) {
3663     struct sigaction *actp = get_chained_signal_action(sig);
3664     if (actp != NULL) {
3665       chained = call_chained_handler(actp, sig, siginfo, context);
3666     }
3667   }
3668   return chained;
3669 }
3670 
3671 struct sigaction* os::Solaris::get_preinstalled_handler(int sig) {
3672   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3673          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3674   if (preinstalled_sigs[sig] != 0) {
3675     return &amp;chainedsigactions[sig];
3676   }
3677   return NULL;
3678 }
3679 
3680 void os::Solaris::save_preinstalled_handler(int sig,
3681                                             struct sigaction&amp; oldAct) {
3682   assert(sig &gt; 0 &amp;&amp; sig &lt;= Maxsignum, &quot;vm signal out of expected range&quot;);
3683   assert((chainedsigactions != (struct sigaction *)NULL) &amp;&amp;
3684          (preinstalled_sigs != (int *)NULL), &quot;signals not yet initialized&quot;);
3685   chainedsigactions[sig] = oldAct;
3686   preinstalled_sigs[sig] = 1;
3687 }
3688 
3689 void os::Solaris::set_signal_handler(int sig, bool set_installed,
3690                                      bool oktochain) {
3691   // Check for overwrite.
3692   struct sigaction oldAct;
3693   sigaction(sig, (struct sigaction*)NULL, &amp;oldAct);
3694   void* oldhand =
3695       oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*,  oldAct.sa_sigaction)
3696                           : CAST_FROM_FN_PTR(void*,  oldAct.sa_handler);
3697   if (oldhand != CAST_FROM_FN_PTR(void*, SIG_DFL) &amp;&amp;
3698       oldhand != CAST_FROM_FN_PTR(void*, SIG_IGN) &amp;&amp;
3699       oldhand != CAST_FROM_FN_PTR(void*, signalHandler)) {
3700     if (AllowUserSignalHandlers || !set_installed) {
3701       // Do not overwrite; user takes responsibility to forward to us.
3702       return;
3703     } else if (UseSignalChaining) {
3704       if (oktochain) {
3705         // save the old handler in jvm
3706         save_preinstalled_handler(sig, oldAct);
3707       } else {
3708         vm_exit_during_initialization(&quot;Signal chaining not allowed for VM interrupt signal.&quot;);
3709       }
3710       // libjsig also interposes the sigaction() call below and saves the
3711       // old sigaction on it own.
3712     } else {
3713       fatal(&quot;Encountered unexpected pre-existing sigaction handler &quot;
3714             &quot;%#lx for signal %d.&quot;, (long)oldhand, sig);
3715     }
3716   }
3717 
3718   struct sigaction sigAct;
3719   sigfillset(&amp;(sigAct.sa_mask));
3720   sigAct.sa_handler = SIG_DFL;
3721 
3722   sigAct.sa_sigaction = signalHandler;
3723   // Handle SIGSEGV on alternate signal stack if
3724   // not using stack banging
3725   if (!UseStackBanging &amp;&amp; sig == SIGSEGV) {
3726     sigAct.sa_flags = SA_SIGINFO | SA_RESTART | SA_ONSTACK;
3727   } else {
3728     sigAct.sa_flags = SA_SIGINFO | SA_RESTART;
3729   }
3730   os::Solaris::set_our_sigflags(sig, sigAct.sa_flags);
3731 
3732   sigaction(sig, &amp;sigAct, &amp;oldAct);
3733 
3734   void* oldhand2 = oldAct.sa_sigaction ? CAST_FROM_FN_PTR(void*, oldAct.sa_sigaction)
3735                                        : CAST_FROM_FN_PTR(void*, oldAct.sa_handler);
3736   assert(oldhand2 == oldhand, &quot;no concurrent signal handler installation&quot;);
3737 }
3738 
3739 
3740 #define DO_SIGNAL_CHECK(sig)                      \
3741   do {                                            \
3742     if (!sigismember(&amp;check_signal_done, sig)) {  \
3743       os::Solaris::check_signal_handler(sig);     \
3744     }                                             \
3745   } while (0)
3746 
3747 // This method is a periodic task to check for misbehaving JNI applications
3748 // under CheckJNI, we can add any periodic checks here
3749 
3750 void os::run_periodic_checks() {
3751   // A big source of grief is hijacking virt. addr 0x0 on Solaris,
3752   // thereby preventing a NULL checks.
3753   if (!check_addr0_done) check_addr0_done = check_addr0(tty);
3754 
3755   if (check_signals == false) return;
3756 
3757   // SEGV and BUS if overridden could potentially prevent
3758   // generation of hs*.log in the event of a crash, debugging
3759   // such a case can be very challenging, so we absolutely
3760   // check for the following for a good measure:
3761   DO_SIGNAL_CHECK(SIGSEGV);
3762   DO_SIGNAL_CHECK(SIGILL);
3763   DO_SIGNAL_CHECK(SIGFPE);
3764   DO_SIGNAL_CHECK(SIGBUS);
3765   DO_SIGNAL_CHECK(SIGPIPE);
3766   DO_SIGNAL_CHECK(SIGXFSZ);
3767   DO_SIGNAL_CHECK(ASYNC_SIGNAL);
3768 
3769   // ReduceSignalUsage allows the user to override these handlers
3770   // see comments at the very top and jvm_solaris.h
3771   if (!ReduceSignalUsage) {
3772     DO_SIGNAL_CHECK(SHUTDOWN1_SIGNAL);
3773     DO_SIGNAL_CHECK(SHUTDOWN2_SIGNAL);
3774     DO_SIGNAL_CHECK(SHUTDOWN3_SIGNAL);
3775     DO_SIGNAL_CHECK(BREAK_SIGNAL);
3776   }
3777 }
3778 
3779 typedef int (*os_sigaction_t)(int, const struct sigaction *, struct sigaction *);
3780 
3781 static os_sigaction_t os_sigaction = NULL;
3782 
3783 void os::Solaris::check_signal_handler(int sig) {
3784   char buf[O_BUFLEN];
3785   address jvmHandler = NULL;
3786 
3787   struct sigaction act;
3788   if (os_sigaction == NULL) {
3789     // only trust the default sigaction, in case it has been interposed
3790     os_sigaction = (os_sigaction_t)dlsym(RTLD_DEFAULT, &quot;sigaction&quot;);
3791     if (os_sigaction == NULL) return;
3792   }
3793 
3794   os_sigaction(sig, (struct sigaction*)NULL, &amp;act);
3795 
3796   address thisHandler = (act.sa_flags &amp; SA_SIGINFO)
3797     ? CAST_FROM_FN_PTR(address, act.sa_sigaction)
3798     : CAST_FROM_FN_PTR(address, act.sa_handler);
3799 
3800 
3801   switch (sig) {
3802   case SIGSEGV:
3803   case SIGBUS:
3804   case SIGFPE:
3805   case SIGPIPE:
3806   case SIGXFSZ:
3807   case SIGILL:
3808   case ASYNC_SIGNAL:
3809     jvmHandler = CAST_FROM_FN_PTR(address, signalHandler);
3810     break;
3811 
3812   case SHUTDOWN1_SIGNAL:
3813   case SHUTDOWN2_SIGNAL:
3814   case SHUTDOWN3_SIGNAL:
3815   case BREAK_SIGNAL:
3816     jvmHandler = (address)user_handler();
3817     break;
3818 
3819   default:
3820       return;
3821   }
3822 
3823   if (thisHandler != jvmHandler) {
3824     tty-&gt;print(&quot;Warning: %s handler &quot;, exception_name(sig, buf, O_BUFLEN));
3825     tty-&gt;print(&quot;expected:%s&quot;, get_signal_handler_name(jvmHandler, buf, O_BUFLEN));
3826     tty-&gt;print_cr(&quot;  found:%s&quot;, get_signal_handler_name(thisHandler, buf, O_BUFLEN));
3827     // No need to check this sig any longer
3828     sigaddset(&amp;check_signal_done, sig);
3829     // Running under non-interactive shell, SHUTDOWN2_SIGNAL will be reassigned SIG_IGN
3830     if (sig == SHUTDOWN2_SIGNAL &amp;&amp; !isatty(fileno(stdin))) {
3831       tty-&gt;print_cr(&quot;Running in non-interactive shell, %s handler is replaced by shell&quot;,
3832                     exception_name(sig, buf, O_BUFLEN));
3833     }
3834   } else if(os::Solaris::get_our_sigflags(sig) != 0 &amp;&amp; act.sa_flags != os::Solaris::get_our_sigflags(sig)) {
3835     tty-&gt;print(&quot;Warning: %s handler flags &quot;, exception_name(sig, buf, O_BUFLEN));
3836     tty-&gt;print(&quot;expected:&quot;);
3837     os::Posix::print_sa_flags(tty, os::Solaris::get_our_sigflags(sig));
3838     tty-&gt;cr();
3839     tty-&gt;print(&quot;  found:&quot;);
3840     os::Posix::print_sa_flags(tty, act.sa_flags);
3841     tty-&gt;cr();
3842     // No need to check this sig any longer
3843     sigaddset(&amp;check_signal_done, sig);
3844   }
3845 
3846   // Print all the signal handler state
3847   if (sigismember(&amp;check_signal_done, sig)) {
3848     print_signal_handlers(tty, buf, O_BUFLEN);
3849   }
3850 
3851 }
3852 
3853 void os::Solaris::install_signal_handlers() {
3854   signal_handlers_are_installed = true;
3855 
3856   // signal-chaining
3857   typedef void (*signal_setting_t)();
3858   signal_setting_t begin_signal_setting = NULL;
3859   signal_setting_t end_signal_setting = NULL;
3860   begin_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3861                                         dlsym(RTLD_DEFAULT, &quot;JVM_begin_signal_setting&quot;));
3862   if (begin_signal_setting != NULL) {
3863     end_signal_setting = CAST_TO_FN_PTR(signal_setting_t,
3864                                         dlsym(RTLD_DEFAULT, &quot;JVM_end_signal_setting&quot;));
3865     get_signal_action = CAST_TO_FN_PTR(get_signal_t,
3866                                        dlsym(RTLD_DEFAULT, &quot;JVM_get_signal_action&quot;));
3867     libjsig_is_loaded = true;
3868     assert(UseSignalChaining, &quot;should enable signal-chaining&quot;);
3869   }
3870   if (libjsig_is_loaded) {
3871     // Tell libjsig jvm is setting signal handlers
3872     (*begin_signal_setting)();
3873   }
3874 
3875   set_signal_handler(SIGSEGV, true, true);
3876   set_signal_handler(SIGPIPE, true, true);
3877   set_signal_handler(SIGXFSZ, true, true);
3878   set_signal_handler(SIGBUS, true, true);
3879   set_signal_handler(SIGILL, true, true);
3880   set_signal_handler(SIGFPE, true, true);
3881   set_signal_handler(ASYNC_SIGNAL, true, true);
3882 
3883   if (libjsig_is_loaded) {
3884     // Tell libjsig jvm finishes setting signal handlers
3885     (*end_signal_setting)();
3886   }
3887 
3888   // We don&#39;t activate signal checker if libjsig is in place, we trust ourselves
3889   // and if UserSignalHandler is installed all bets are off.
3890   // Log that signal checking is off only if -verbose:jni is specified.
3891   if (CheckJNICalls) {
3892     if (libjsig_is_loaded) {
3893       if (PrintJNIResolving) {
3894         tty-&gt;print_cr(&quot;Info: libjsig is activated, all active signal checking is disabled&quot;);
3895       }
3896       check_signals = false;
3897     }
3898     if (AllowUserSignalHandlers) {
3899       if (PrintJNIResolving) {
3900         tty-&gt;print_cr(&quot;Info: AllowUserSignalHandlers is activated, all active signal checking is disabled&quot;);
3901       }
3902       check_signals = false;
3903     }
3904   }
3905 }
3906 
3907 
3908 void report_error(const char* file_name, int line_no, const char* title,
3909                   const char* format, ...);
3910 
3911 // (Static) wrappers for the liblgrp API
3912 os::Solaris::lgrp_home_func_t os::Solaris::_lgrp_home;
3913 os::Solaris::lgrp_init_func_t os::Solaris::_lgrp_init;
3914 os::Solaris::lgrp_fini_func_t os::Solaris::_lgrp_fini;
3915 os::Solaris::lgrp_root_func_t os::Solaris::_lgrp_root;
3916 os::Solaris::lgrp_children_func_t os::Solaris::_lgrp_children;
3917 os::Solaris::lgrp_resources_func_t os::Solaris::_lgrp_resources;
3918 os::Solaris::lgrp_nlgrps_func_t os::Solaris::_lgrp_nlgrps;
3919 os::Solaris::lgrp_cookie_stale_func_t os::Solaris::_lgrp_cookie_stale;
3920 os::Solaris::lgrp_cookie_t os::Solaris::_lgrp_cookie = 0;
3921 
3922 static address resolve_symbol_lazy(const char* name) {
3923   address addr = (address) dlsym(RTLD_DEFAULT, name);
3924   if (addr == NULL) {
3925     // RTLD_DEFAULT was not defined on some early versions of 2.5.1
3926     addr = (address) dlsym(RTLD_NEXT, name);
3927   }
3928   return addr;
3929 }
3930 
3931 static address resolve_symbol(const char* name) {
3932   address addr = resolve_symbol_lazy(name);
3933   if (addr == NULL) {
3934     fatal(dlerror());
3935   }
3936   return addr;
3937 }
3938 
3939 void os::Solaris::libthread_init() {
3940   address func = (address)dlsym(RTLD_DEFAULT, &quot;_thr_suspend_allmutators&quot;);
3941 
3942   lwp_priocntl_init();
3943 
3944   // RTLD_DEFAULT was not defined on some early versions of 5.5.1
3945   if (func == NULL) {
3946     func = (address) dlsym(RTLD_NEXT, &quot;_thr_suspend_allmutators&quot;);
3947     // Guarantee that this VM is running on an new enough OS (5.6 or
3948     // later) that it will have a new enough libthread.so.
3949     guarantee(func != NULL, &quot;libthread.so is too old.&quot;);
3950   }
3951 
3952   int size;
3953   void (*handler_info_func)(address *, int *);
3954   handler_info_func = CAST_TO_FN_PTR(void (*)(address *, int *), resolve_symbol(&quot;thr_sighndlrinfo&quot;));
3955   handler_info_func(&amp;handler_start, &amp;size);
3956   handler_end = handler_start + size;
3957 }
3958 
3959 
3960 int_fnP_mutex_tP os::Solaris::_mutex_lock;
3961 int_fnP_mutex_tP os::Solaris::_mutex_trylock;
3962 int_fnP_mutex_tP os::Solaris::_mutex_unlock;
3963 int_fnP_mutex_tP_i_vP os::Solaris::_mutex_init;
3964 int_fnP_mutex_tP os::Solaris::_mutex_destroy;
3965 int os::Solaris::_mutex_scope = USYNC_THREAD;
3966 
3967 int_fnP_cond_tP_mutex_tP_timestruc_tP os::Solaris::_cond_timedwait;
3968 int_fnP_cond_tP_mutex_tP os::Solaris::_cond_wait;
3969 int_fnP_cond_tP os::Solaris::_cond_signal;
3970 int_fnP_cond_tP os::Solaris::_cond_broadcast;
3971 int_fnP_cond_tP_i_vP os::Solaris::_cond_init;
3972 int_fnP_cond_tP os::Solaris::_cond_destroy;
3973 int os::Solaris::_cond_scope = USYNC_THREAD;
3974 bool os::Solaris::_synchronization_initialized;
3975 
3976 void os::Solaris::synchronization_init() {
3977   if (UseLWPSynchronization) {
3978     os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_lock&quot;)));
3979     os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_trylock&quot;)));
3980     os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;_lwp_mutex_unlock&quot;)));
3981     os::Solaris::set_mutex_init(lwp_mutex_init);
3982     os::Solaris::set_mutex_destroy(lwp_mutex_destroy);
3983     os::Solaris::set_mutex_scope(USYNC_THREAD);
3984 
3985     os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;_lwp_cond_timedwait&quot;)));
3986     os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;_lwp_cond_wait&quot;)));
3987     os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_signal&quot;)));
3988     os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;_lwp_cond_broadcast&quot;)));
3989     os::Solaris::set_cond_init(lwp_cond_init);
3990     os::Solaris::set_cond_destroy(lwp_cond_destroy);
3991     os::Solaris::set_cond_scope(USYNC_THREAD);
3992   } else {
3993     os::Solaris::set_mutex_scope(USYNC_THREAD);
3994     os::Solaris::set_cond_scope(USYNC_THREAD);
3995 
3996     if (UsePthreads) {
3997       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_lock&quot;)));
3998       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_trylock&quot;)));
3999       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_unlock&quot;)));
4000       os::Solaris::set_mutex_init(pthread_mutex_default_init);
4001       os::Solaris::set_mutex_destroy(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;pthread_mutex_destroy&quot;)));
4002 
4003       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;pthread_cond_timedwait&quot;)));
4004       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;pthread_cond_wait&quot;)));
4005       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_signal&quot;)));
4006       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_broadcast&quot;)));
4007       os::Solaris::set_cond_init(pthread_cond_default_init);
4008       os::Solaris::set_cond_destroy(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;pthread_cond_destroy&quot;)));
4009     } else {
4010       os::Solaris::set_mutex_lock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_lock&quot;)));
4011       os::Solaris::set_mutex_trylock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_trylock&quot;)));
4012       os::Solaris::set_mutex_unlock(CAST_TO_FN_PTR(int_fnP_mutex_tP, resolve_symbol(&quot;mutex_unlock&quot;)));
4013       os::Solaris::set_mutex_init(::mutex_init);
4014       os::Solaris::set_mutex_destroy(::mutex_destroy);
4015 
4016       os::Solaris::set_cond_timedwait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP_timestruc_tP, resolve_symbol(&quot;cond_timedwait&quot;)));
4017       os::Solaris::set_cond_wait(CAST_TO_FN_PTR(int_fnP_cond_tP_mutex_tP, resolve_symbol(&quot;cond_wait&quot;)));
4018       os::Solaris::set_cond_signal(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_signal&quot;)));
4019       os::Solaris::set_cond_broadcast(CAST_TO_FN_PTR(int_fnP_cond_tP, resolve_symbol(&quot;cond_broadcast&quot;)));
4020       os::Solaris::set_cond_init(::cond_init);
4021       os::Solaris::set_cond_destroy(::cond_destroy);
4022     }
4023   }
4024   _synchronization_initialized = true;
4025 }
4026 
4027 bool os::Solaris::liblgrp_init() {
4028   void *handle = dlopen(&quot;liblgrp.so.1&quot;, RTLD_LAZY);
4029   if (handle != NULL) {
4030     os::Solaris::set_lgrp_home(CAST_TO_FN_PTR(lgrp_home_func_t, dlsym(handle, &quot;lgrp_home&quot;)));
4031     os::Solaris::set_lgrp_init(CAST_TO_FN_PTR(lgrp_init_func_t, dlsym(handle, &quot;lgrp_init&quot;)));
4032     os::Solaris::set_lgrp_fini(CAST_TO_FN_PTR(lgrp_fini_func_t, dlsym(handle, &quot;lgrp_fini&quot;)));
4033     os::Solaris::set_lgrp_root(CAST_TO_FN_PTR(lgrp_root_func_t, dlsym(handle, &quot;lgrp_root&quot;)));
4034     os::Solaris::set_lgrp_children(CAST_TO_FN_PTR(lgrp_children_func_t, dlsym(handle, &quot;lgrp_children&quot;)));
4035     os::Solaris::set_lgrp_resources(CAST_TO_FN_PTR(lgrp_resources_func_t, dlsym(handle, &quot;lgrp_resources&quot;)));
4036     os::Solaris::set_lgrp_nlgrps(CAST_TO_FN_PTR(lgrp_nlgrps_func_t, dlsym(handle, &quot;lgrp_nlgrps&quot;)));
4037     os::Solaris::set_lgrp_cookie_stale(CAST_TO_FN_PTR(lgrp_cookie_stale_func_t,
4038                                                       dlsym(handle, &quot;lgrp_cookie_stale&quot;)));
4039 
4040     lgrp_cookie_t c = lgrp_init(LGRP_VIEW_CALLER);
4041     set_lgrp_cookie(c);
4042     return true;
4043   }
4044   return false;
4045 }
4046 
4047 // int pset_getloadavg(psetid_t pset, double loadavg[], int nelem);
4048 typedef long (*pset_getloadavg_type)(psetid_t pset, double loadavg[], int nelem);
4049 static pset_getloadavg_type pset_getloadavg_ptr = NULL;
4050 
4051 void init_pset_getloadavg_ptr(void) {
4052   pset_getloadavg_ptr =
4053     (pset_getloadavg_type)dlsym(RTLD_DEFAULT, &quot;pset_getloadavg&quot;);
4054   if (pset_getloadavg_ptr == NULL) {
4055     log_warning(os)(&quot;pset_getloadavg function not found&quot;);
4056   }
4057 }
4058 
4059 int os::Solaris::_dev_zero_fd = -1;
4060 
4061 // this is called _before_ the global arguments have been parsed
4062 void os::init(void) {
4063   _initial_pid = getpid();
4064 
4065   max_hrtime = first_hrtime = gethrtime();
4066 
4067   init_random(1234567);
4068 
4069   page_size = sysconf(_SC_PAGESIZE);
4070   if (page_size == -1) {
4071     fatal(&quot;os_solaris.cpp: os::init: sysconf failed (%s)&quot;, os::strerror(errno));
4072   }
4073   init_page_sizes((size_t) page_size);
4074 
4075   Solaris::initialize_system_info();
4076 
4077   int fd = ::open(&quot;/dev/zero&quot;, O_RDWR);
4078   if (fd &lt; 0) {
4079     fatal(&quot;os::init: cannot open /dev/zero (%s)&quot;, os::strerror(errno));
4080   } else {
4081     Solaris::set_dev_zero_fd(fd);
4082 
4083     // Close on exec, child won&#39;t inherit.
4084     fcntl(fd, F_SETFD, FD_CLOEXEC);
4085   }
4086 
4087   clock_tics_per_sec = CLK_TCK;
4088 
4089   // check if dladdr1() exists; dladdr1 can provide more information than
4090   // dladdr for os::dll_address_to_function_name. It comes with SunOS 5.9
4091   // and is available on linker patches for 5.7 and 5.8.
4092   // libdl.so must have been loaded, this call is just an entry lookup
4093   void * hdl = dlopen(&quot;libdl.so&quot;, RTLD_NOW);
4094   if (hdl) {
4095     dladdr1_func = CAST_TO_FN_PTR(dladdr1_func_type, dlsym(hdl, &quot;dladdr1&quot;));
4096   }
4097 
4098   // main_thread points to the thread that created/loaded the JVM.
4099   main_thread = thr_self();
4100 
4101   // dynamic lookup of functions that may not be available in our lowest
4102   // supported Solaris release
4103   void * handle = dlopen(&quot;libc.so.1&quot;, RTLD_LAZY);
4104   if (handle != NULL) {
4105     Solaris::_pthread_setname_np =  // from 11.3
4106         (Solaris::pthread_setname_np_func_t)dlsym(handle, &quot;pthread_setname_np&quot;);
4107   }
4108 
4109   // Shared Posix initialization
4110   os::Posix::init();
4111 }
4112 
4113 // To install functions for atexit system call
4114 extern &quot;C&quot; {
4115   static void perfMemory_exit_helper() {
4116     perfMemory_exit();
4117   }
4118 }
4119 
4120 // this is called _after_ the global arguments have been parsed
4121 jint os::init_2(void) {
4122   // try to enable extended file IO ASAP, see 6431278
4123   os::Solaris::try_enable_extended_io();
4124 
4125   // Check and sets minimum stack sizes against command line options
4126   if (Posix::set_minimum_stack_sizes() == JNI_ERR) {
4127     return JNI_ERR;
4128   }
4129 
4130   Solaris::libthread_init();
4131 
4132   if (UseNUMA) {
4133     if (!Solaris::liblgrp_init()) {
4134       UseNUMA = false;
4135     } else {
4136       size_t lgrp_limit = os::numa_get_groups_num();
4137       int *lgrp_ids = NEW_C_HEAP_ARRAY(int, lgrp_limit, mtInternal);
4138       size_t lgrp_num = os::numa_get_leaf_groups(lgrp_ids, lgrp_limit);
4139       FREE_C_HEAP_ARRAY(int, lgrp_ids);
4140       if (lgrp_num &lt; 2) {
4141         // There&#39;s only one locality group, disable NUMA.
4142         UseNUMA = false;
4143       }
4144     }
4145     if (!UseNUMA &amp;&amp; ForceNUMA) {
4146       UseNUMA = true;
4147     }
4148   }
4149 
4150   Solaris::signal_sets_init();
4151   Solaris::init_signal_mem();
4152   Solaris::install_signal_handlers();
4153   // Initialize data for jdk.internal.misc.Signal
4154   if (!ReduceSignalUsage) {
4155     jdk_misc_signal_init();
4156   }
4157 
4158   // initialize synchronization primitives to use either thread or
4159   // lwp synchronization (controlled by UseLWPSynchronization)
4160   Solaris::synchronization_init();
4161   DEBUG_ONLY(os::set_mutex_init_done();)
4162 
4163   if (MaxFDLimit) {
4164     // set the number of file descriptors to max. print out error
4165     // if getrlimit/setrlimit fails but continue regardless.
4166     struct rlimit nbr_files;
4167     int status = getrlimit(RLIMIT_NOFILE, &amp;nbr_files);
4168     if (status != 0) {
4169       log_info(os)(&quot;os::init_2 getrlimit failed: %s&quot;, os::strerror(errno));
4170     } else {
4171       nbr_files.rlim_cur = nbr_files.rlim_max;
4172       status = setrlimit(RLIMIT_NOFILE, &amp;nbr_files);
4173       if (status != 0) {
4174         log_info(os)(&quot;os::init_2 setrlimit failed: %s&quot;, os::strerror(errno));
4175       }
4176     }
4177   }
4178 
4179   // Calculate theoretical max. size of Threads to guard gainst
4180   // artifical out-of-memory situations, where all available address-
4181   // space has been reserved by thread stacks. Default stack size is 1Mb.
4182   size_t pre_thread_stack_size = (JavaThread::stack_size_at_create()) ?
4183     JavaThread::stack_size_at_create() : (1*K*K);
4184   assert(pre_thread_stack_size != 0, &quot;Must have a stack&quot;);
4185   // Solaris has a maximum of 4Gb of user programs. Calculate the thread limit when
4186   // we should start doing Virtual Memory banging. Currently when the threads will
4187   // have used all but 200Mb of space.
4188   size_t max_address_space = ((unsigned int)4 * K * K * K) - (200 * K * K);
4189   Solaris::_os_thread_limit = max_address_space / pre_thread_stack_size;
4190 
4191   // at-exit methods are called in the reverse order of their registration.
4192   // In Solaris 7 and earlier, atexit functions are called on return from
4193   // main or as a result of a call to exit(3C). There can be only 32 of
4194   // these functions registered and atexit() does not set errno. In Solaris
4195   // 8 and later, there is no limit to the number of functions registered
4196   // and atexit() sets errno. In addition, in Solaris 8 and later, atexit
4197   // functions are called upon dlclose(3DL) in addition to return from main
4198   // and exit(3C).
4199 
4200   if (PerfAllowAtExitRegistration) {
4201     // only register atexit functions if PerfAllowAtExitRegistration is set.
4202     // atexit functions can be delayed until process exit time, which
4203     // can be problematic for embedded VM situations. Embedded VMs should
4204     // call DestroyJavaVM() to assure that VM resources are released.
4205 
4206     // note: perfMemory_exit_helper atexit function may be removed in
4207     // the future if the appropriate cleanup code can be added to the
4208     // VM_Exit VMOperation&#39;s doit method.
4209     if (atexit(perfMemory_exit_helper) != 0) {
4210       warning(&quot;os::init2 atexit(perfMemory_exit_helper) failed&quot;);
4211     }
4212   }
4213 
4214   // Init pset_loadavg function pointer
4215   init_pset_getloadavg_ptr();
4216 
4217   // Shared Posix initialization
4218   os::Posix::init_2();
4219 
4220   return JNI_OK;
4221 }
4222 
4223 // Mark the polling page as unreadable
4224 void os::make_polling_page_unreadable(void) {
4225   if (mprotect((char *)_polling_page, page_size, PROT_NONE) != 0) {
4226     fatal(&quot;Could not disable polling page&quot;);
4227   }
4228 }
4229 
4230 // Mark the polling page as readable
4231 void os::make_polling_page_readable(void) {
4232   if (mprotect((char *)_polling_page, page_size, PROT_READ) != 0) {
4233     fatal(&quot;Could not enable polling page&quot;);
4234   }
4235 }
4236 
4237 // Is a (classpath) directory empty?
4238 bool os::dir_is_empty(const char* path) {
4239   DIR *dir = NULL;
4240   struct dirent *ptr;
4241 
4242   dir = opendir(path);
4243   if (dir == NULL) return true;
4244 
4245   // Scan the directory
4246   bool result = true;
4247   while (result &amp;&amp; (ptr = readdir(dir)) != NULL) {
4248     if (strcmp(ptr-&gt;d_name, &quot;.&quot;) != 0 &amp;&amp; strcmp(ptr-&gt;d_name, &quot;..&quot;) != 0) {
4249       result = false;
4250     }
4251   }
4252   closedir(dir);
4253   return result;
4254 }
4255 
4256 // This code originates from JDK&#39;s sysOpen and open64_w
4257 // from src/solaris/hpi/src/system_md.c
4258 
4259 int os::open(const char *path, int oflag, int mode) {
4260   if (strlen(path) &gt; MAX_PATH - 1) {
4261     errno = ENAMETOOLONG;
4262     return -1;
4263   }
4264   int fd;
4265 
4266   fd = ::open64(path, oflag, mode);
4267   if (fd == -1) return -1;
4268 
4269   // If the open succeeded, the file might still be a directory
4270   {
4271     struct stat64 buf64;
4272     int ret = ::fstat64(fd, &amp;buf64);
4273     int st_mode = buf64.st_mode;
4274 
4275     if (ret != -1) {
4276       if ((st_mode &amp; S_IFMT) == S_IFDIR) {
4277         errno = EISDIR;
4278         ::close(fd);
4279         return -1;
4280       }
4281     } else {
4282       ::close(fd);
4283       return -1;
4284     }
4285   }
4286 
4287   // 32-bit Solaris systems suffer from:
4288   //
4289   // - an historical default soft limit of 256 per-process file
4290   //   descriptors that is too low for many Java programs.
4291   //
4292   // - a design flaw where file descriptors created using stdio
4293   //   fopen must be less than 256, _even_ when the first limit above
4294   //   has been raised.  This can cause calls to fopen (but not calls to
4295   //   open, for example) to fail mysteriously, perhaps in 3rd party
4296   //   native code (although the JDK itself uses fopen).  One can hardly
4297   //   criticize them for using this most standard of all functions.
4298   //
4299   // We attempt to make everything work anyways by:
4300   //
4301   // - raising the soft limit on per-process file descriptors beyond
4302   //   256
4303   //
4304   // - As of Solaris 10u4, we can request that Solaris raise the 256
4305   //   stdio fopen limit by calling function enable_extended_FILE_stdio.
4306   //   This is done in init_2 and recorded in enabled_extended_FILE_stdio
4307   //
4308   // - If we are stuck on an old (pre 10u4) Solaris system, we can
4309   //   workaround the bug by remapping non-stdio file descriptors below
4310   //   256 to ones beyond 256, which is done below.
4311   //
4312   // See:
4313   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4314   // 6533291: Work around 32-bit Solaris stdio limit of 256 open files
4315   // 6431278: Netbeans crash on 32 bit Solaris: need to call
4316   //          enable_extended_FILE_stdio() in VM initialisation
4317   // Giri Mandalika&#39;s blog
4318   // http://technopark02.blogspot.com/2005_05_01_archive.html
4319   //
4320 #ifndef  _LP64
4321   if ((!enabled_extended_FILE_stdio) &amp;&amp; fd &lt; 256) {
4322     int newfd = ::fcntl(fd, F_DUPFD, 256);
4323     if (newfd != -1) {
4324       ::close(fd);
4325       fd = newfd;
4326     }
4327   }
4328 #endif // 32-bit Solaris
4329 
4330   // All file descriptors that are opened in the JVM and not
4331   // specifically destined for a subprocess should have the
4332   // close-on-exec flag set.  If we don&#39;t set it, then careless 3rd
4333   // party native code might fork and exec without closing all
4334   // appropriate file descriptors (e.g. as we do in closeDescriptors in
4335   // UNIXProcess.c), and this in turn might:
4336   //
4337   // - cause end-of-file to fail to be detected on some file
4338   //   descriptors, resulting in mysterious hangs, or
4339   //
4340   // - might cause an fopen in the subprocess to fail on a system
4341   //   suffering from bug 1085341.
4342   //
4343   // (Yes, the default setting of the close-on-exec flag is a Unix
4344   // design flaw)
4345   //
4346   // See:
4347   // 1085341: 32-bit stdio routines should support file descriptors &gt;255
4348   // 4843136: (process) pipe file descriptor from Runtime.exec not being closed
4349   // 6339493: (process) Runtime.exec does not close all file descriptors on Solaris 9
4350   //
4351 #ifdef FD_CLOEXEC
4352   {
4353     int flags = ::fcntl(fd, F_GETFD);
4354     if (flags != -1) {
4355       ::fcntl(fd, F_SETFD, flags | FD_CLOEXEC);
4356     }
4357   }
4358 #endif
4359 
4360   return fd;
4361 }
4362 
4363 // create binary file, rewriting existing file if required
4364 int os::create_binary_file(const char* path, bool rewrite_existing) {
4365   int oflags = O_WRONLY | O_CREAT;
4366   if (!rewrite_existing) {
4367     oflags |= O_EXCL;
4368   }
4369   return ::open64(path, oflags, S_IREAD | S_IWRITE);
4370 }
4371 
4372 // return current position of file pointer
4373 jlong os::current_file_offset(int fd) {
4374   return (jlong)::lseek64(fd, (off64_t)0, SEEK_CUR);
4375 }
4376 
4377 // move file pointer to the specified offset
4378 jlong os::seek_to_file_offset(int fd, jlong offset) {
4379   return (jlong)::lseek64(fd, (off64_t)offset, SEEK_SET);
4380 }
4381 
4382 jlong os::lseek(int fd, jlong offset, int whence) {
4383   return (jlong) ::lseek64(fd, offset, whence);
4384 }
4385 
4386 int os::ftruncate(int fd, jlong length) {
4387   return ::ftruncate64(fd, length);
4388 }
4389 
4390 int os::fsync(int fd)  {
4391   RESTARTABLE_RETURN_INT(::fsync(fd));
4392 }
4393 
4394 int os::available(int fd, jlong *bytes) {
4395   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
4396          &quot;Assumed _thread_in_native&quot;);
4397   jlong cur, end;
4398   int mode;
4399   struct stat64 buf64;
4400 
4401   if (::fstat64(fd, &amp;buf64) &gt;= 0) {
4402     mode = buf64.st_mode;
4403     if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {
4404       int n,ioctl_return;
4405 
4406       RESTARTABLE(::ioctl(fd, FIONREAD, &amp;n), ioctl_return);
4407       if (ioctl_return&gt;= 0) {
4408         *bytes = n;
4409         return 1;
4410       }
4411     }
4412   }
4413   if ((cur = ::lseek64(fd, 0L, SEEK_CUR)) == -1) {
4414     return 0;
4415   } else if ((end = ::lseek64(fd, 0L, SEEK_END)) == -1) {
4416     return 0;
4417   } else if (::lseek64(fd, cur, SEEK_SET) == -1) {
4418     return 0;
4419   }
4420   *bytes = end - cur;
4421   return 1;
4422 }
4423 
4424 // Map a block of memory.
4425 char* os::pd_map_memory(int fd, const char* file_name, size_t file_offset,
4426                         char *addr, size_t bytes, bool read_only,
4427                         bool allow_exec) {
4428   int prot;
4429   int flags;
4430 
4431   if (read_only) {
4432     prot = PROT_READ;
4433     flags = MAP_SHARED;
4434   } else {
4435     prot = PROT_READ | PROT_WRITE;
4436     flags = MAP_PRIVATE;
4437   }
4438 
4439   if (allow_exec) {
4440     prot |= PROT_EXEC;
4441   }
4442 
4443   if (addr != NULL) {
4444     flags |= MAP_FIXED;
4445   }
4446 
4447   char* mapped_address = (char*)mmap(addr, (size_t)bytes, prot, flags,
4448                                      fd, file_offset);
4449   if (mapped_address == MAP_FAILED) {
4450     return NULL;
4451   }
4452   return mapped_address;
4453 }
4454 
4455 
4456 // Remap a block of memory.
4457 char* os::pd_remap_memory(int fd, const char* file_name, size_t file_offset,
4458                           char *addr, size_t bytes, bool read_only,
4459                           bool allow_exec) {
4460   // same as map_memory() on this OS
4461   return os::map_memory(fd, file_name, file_offset, addr, bytes, read_only,
4462                         allow_exec);
4463 }
4464 
4465 
4466 // Unmap a block of memory.
4467 bool os::pd_unmap_memory(char* addr, size_t bytes) {
4468   return munmap(addr, bytes) == 0;
4469 }
4470 
4471 void os::pause() {
4472   char filename[MAX_PATH];
4473   if (PauseAtStartupFile &amp;&amp; PauseAtStartupFile[0]) {
4474     jio_snprintf(filename, MAX_PATH, PauseAtStartupFile);
4475   } else {
4476     jio_snprintf(filename, MAX_PATH, &quot;./vm.paused.%d&quot;, current_process_id());
4477   }
4478 
4479   int fd = ::open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);
4480   if (fd != -1) {
4481     struct stat buf;
4482     ::close(fd);
4483     while (::stat(filename, &amp;buf) == 0) {
4484       (void)::poll(NULL, 0, 100);
4485     }
4486   } else {
4487     jio_fprintf(stderr,
4488                 &quot;Could not open pause file &#39;%s&#39;, continuing immediately.\n&quot;, filename);
4489   }
4490 }
4491 
4492 #ifndef PRODUCT
4493 #ifdef INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4494 // Turn this on if you need to trace synch operations.
4495 // Set RECORD_SYNCH_LIMIT to a large-enough value,
4496 // and call record_synch_enable and record_synch_disable
4497 // around the computation of interest.
4498 
4499 void record_synch(char* name, bool returning);  // defined below
4500 
4501 class RecordSynch {
4502   char* _name;
4503  public:
4504   RecordSynch(char* name) :_name(name) { record_synch(_name, false); }
4505   ~RecordSynch()                       { record_synch(_name, true); }
4506 };
4507 
4508 #define CHECK_SYNCH_OP(ret, name, params, args, inner)          \
4509 extern &quot;C&quot; ret name params {                                    \
4510   typedef ret name##_t params;                                  \
4511   static name##_t* implem = NULL;                               \
4512   static int callcount = 0;                                     \
4513   if (implem == NULL) {                                         \
4514     implem = (name##_t*) dlsym(RTLD_NEXT, #name);               \
4515     if (implem == NULL)  fatal(dlerror());                      \
4516   }                                                             \
4517   ++callcount;                                                  \
4518   RecordSynch _rs(#name);                                       \
4519   inner;                                                        \
4520   return implem args;                                           \
4521 }
4522 // in dbx, examine callcounts this way:
4523 // for n in $(eval whereis callcount | awk &#39;{print $2}&#39;); do print $n; done
4524 
4525 #define CHECK_POINTER_OK(p) \
4526   (!Universe::is_fully_initialized() || !Universe::is_reserved_heap((oop)(p)))
4527 #define CHECK_MU \
4528   if (!CHECK_POINTER_OK(mu)) fatal(&quot;Mutex must be in C heap only.&quot;);
4529 #define CHECK_CV \
4530   if (!CHECK_POINTER_OK(cv)) fatal(&quot;Condvar must be in C heap only.&quot;);
4531 #define CHECK_P(p) \
4532   if (!CHECK_POINTER_OK(p))  fatal(false,  &quot;Pointer must be in C heap only.&quot;);
4533 
4534 #define CHECK_MUTEX(mutex_op) \
4535   CHECK_SYNCH_OP(int, mutex_op, (mutex_t *mu), (mu), CHECK_MU);
4536 
4537 CHECK_MUTEX(   mutex_lock)
4538 CHECK_MUTEX(  _mutex_lock)
4539 CHECK_MUTEX( mutex_unlock)
4540 CHECK_MUTEX(_mutex_unlock)
4541 CHECK_MUTEX( mutex_trylock)
4542 CHECK_MUTEX(_mutex_trylock)
4543 
4544 #define CHECK_COND(cond_op) \
4545   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu), (cv, mu), CHECK_MU; CHECK_CV);
4546 
4547 CHECK_COND( cond_wait);
4548 CHECK_COND(_cond_wait);
4549 CHECK_COND(_cond_wait_cancel);
4550 
4551 #define CHECK_COND2(cond_op) \
4552   CHECK_SYNCH_OP(int, cond_op, (cond_t *cv, mutex_t *mu, timestruc_t* ts), (cv, mu, ts), CHECK_MU; CHECK_CV);
4553 
4554 CHECK_COND2( cond_timedwait);
4555 CHECK_COND2(_cond_timedwait);
4556 CHECK_COND2(_cond_timedwait_cancel);
4557 
4558 // do the _lwp_* versions too
4559 #define mutex_t lwp_mutex_t
4560 #define cond_t  lwp_cond_t
4561 CHECK_MUTEX(  _lwp_mutex_lock)
4562 CHECK_MUTEX(  _lwp_mutex_unlock)
4563 CHECK_MUTEX(  _lwp_mutex_trylock)
4564 CHECK_MUTEX( __lwp_mutex_lock)
4565 CHECK_MUTEX( __lwp_mutex_unlock)
4566 CHECK_MUTEX( __lwp_mutex_trylock)
4567 CHECK_MUTEX(___lwp_mutex_lock)
4568 CHECK_MUTEX(___lwp_mutex_unlock)
4569 
4570 CHECK_COND(  _lwp_cond_wait);
4571 CHECK_COND( __lwp_cond_wait);
4572 CHECK_COND(___lwp_cond_wait);
4573 
4574 CHECK_COND2(  _lwp_cond_timedwait);
4575 CHECK_COND2( __lwp_cond_timedwait);
4576 #undef mutex_t
4577 #undef cond_t
4578 
4579 CHECK_SYNCH_OP(int, _lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4580 CHECK_SYNCH_OP(int,__lwp_suspend2,       (int lwp, int *n), (lwp, n), 0);
4581 CHECK_SYNCH_OP(int, _lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4582 CHECK_SYNCH_OP(int,__lwp_kill,           (int lwp, int n),  (lwp, n), 0);
4583 CHECK_SYNCH_OP(int, _lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4584 CHECK_SYNCH_OP(int,__lwp_sema_wait,      (lwp_sema_t* p),   (p),  CHECK_P(p));
4585 CHECK_SYNCH_OP(int, _lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4586 CHECK_SYNCH_OP(int,__lwp_cond_broadcast, (lwp_cond_t* cv),  (cv), CHECK_CV);
4587 
4588 
4589 // recording machinery:
4590 
4591 enum { RECORD_SYNCH_LIMIT = 200 };
4592 char* record_synch_name[RECORD_SYNCH_LIMIT];
4593 void* record_synch_arg0ptr[RECORD_SYNCH_LIMIT];
4594 bool record_synch_returning[RECORD_SYNCH_LIMIT];
4595 thread_t record_synch_thread[RECORD_SYNCH_LIMIT];
4596 int record_synch_count = 0;
4597 bool record_synch_enabled = false;
4598 
4599 // in dbx, examine recorded data this way:
4600 // for n in name arg0ptr returning thread; do print record_synch_$n[0..record_synch_count-1]; done
4601 
4602 void record_synch(char* name, bool returning) {
4603   if (record_synch_enabled) {
4604     if (record_synch_count &lt; RECORD_SYNCH_LIMIT) {
4605       record_synch_name[record_synch_count] = name;
4606       record_synch_returning[record_synch_count] = returning;
4607       record_synch_thread[record_synch_count] = thr_self();
4608       record_synch_arg0ptr[record_synch_count] = &amp;name;
4609       record_synch_count++;
4610     }
4611     // put more checking code here:
4612     // ...
4613   }
4614 }
4615 
4616 void record_synch_enable() {
4617   // start collecting trace data, if not already doing so
4618   if (!record_synch_enabled)  record_synch_count = 0;
4619   record_synch_enabled = true;
4620 }
4621 
4622 void record_synch_disable() {
4623   // stop collecting trace data
4624   record_synch_enabled = false;
4625 }
4626 
4627 #endif // INTERPOSE_ON_SYSTEM_SYNCH_FUNCTIONS
4628 #endif // PRODUCT
4629 
4630 const intptr_t thr_time_off  = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4631 const intptr_t thr_time_size = (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_ttime) -
4632                                (intptr_t)(&amp;((prusage_t *)(NULL))-&gt;pr_utime);
4633 
4634 
4635 // JVMTI &amp; JVM monitoring and management support
4636 // The thread_cpu_time() and current_thread_cpu_time() are only
4637 // supported if is_thread_cpu_time_supported() returns true.
4638 // They are not supported on Solaris T1.
4639 
4640 // current_thread_cpu_time(bool) and thread_cpu_time(Thread*, bool)
4641 // are used by JVM M&amp;M and JVMTI to get user+sys or user CPU time
4642 // of a thread.
4643 //
4644 // current_thread_cpu_time() and thread_cpu_time(Thread *)
4645 // returns the fast estimate available on the platform.
4646 
4647 // hrtime_t gethrvtime() return value includes
4648 // user time but does not include system time
4649 jlong os::current_thread_cpu_time() {
4650   return (jlong) gethrvtime();
4651 }
4652 
4653 jlong os::thread_cpu_time(Thread *thread) {
4654   // return user level CPU time only to be consistent with
4655   // what current_thread_cpu_time returns.
4656   // thread_cpu_time_info() must be changed if this changes
4657   return os::thread_cpu_time(thread, false /* user time only */);
4658 }
4659 
4660 jlong os::current_thread_cpu_time(bool user_sys_cpu_time) {
4661   if (user_sys_cpu_time) {
4662     return os::thread_cpu_time(Thread::current(), user_sys_cpu_time);
4663   } else {
4664     return os::current_thread_cpu_time();
4665   }
4666 }
4667 
4668 jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {
4669   char proc_name[64];
4670   int count;
4671   prusage_t prusage;
4672   jlong lwp_time;
4673   int fd;
4674 
4675   sprintf(proc_name, &quot;/proc/%d/lwp/%d/lwpusage&quot;,
4676           getpid(),
4677           thread-&gt;osthread()-&gt;lwp_id());
4678   fd = ::open(proc_name, O_RDONLY);
4679   if (fd == -1) return -1;
4680 
4681   do {
4682     count = ::pread(fd,
4683                     (void *)&amp;prusage.pr_utime,
4684                     thr_time_size,
4685                     thr_time_off);
4686   } while (count &lt; 0 &amp;&amp; errno == EINTR);
4687   ::close(fd);
4688   if (count &lt; 0) return -1;
4689 
4690   if (user_sys_cpu_time) {
4691     // user + system CPU time
4692     lwp_time = (((jlong)prusage.pr_stime.tv_sec +
4693                  (jlong)prusage.pr_utime.tv_sec) * (jlong)1000000000) +
4694                  (jlong)prusage.pr_stime.tv_nsec +
4695                  (jlong)prusage.pr_utime.tv_nsec;
4696   } else {
4697     // user level CPU time only
4698     lwp_time = ((jlong)prusage.pr_utime.tv_sec * (jlong)1000000000) +
4699                 (jlong)prusage.pr_utime.tv_nsec;
4700   }
4701 
4702   return (lwp_time);
4703 }
4704 
4705 void os::current_thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4706   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4707   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4708   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4709   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4710 }
4711 
4712 void os::thread_cpu_time_info(jvmtiTimerInfo *info_ptr) {
4713   info_ptr-&gt;max_value = ALL_64_BITS;      // will not wrap in less than 64 bits
4714   info_ptr-&gt;may_skip_backward = false;    // elapsed time not wall time
4715   info_ptr-&gt;may_skip_forward = false;     // elapsed time not wall time
4716   info_ptr-&gt;kind = JVMTI_TIMER_USER_CPU;  // only user time is returned
4717 }
4718 
4719 bool os::is_thread_cpu_time_supported() {
4720   return true;
4721 }
4722 
4723 // System loadavg support.  Returns -1 if load average cannot be obtained.
4724 // Return the load average for our processor set if the primitive exists
4725 // (Solaris 9 and later).  Otherwise just return system wide loadavg.
4726 int os::loadavg(double loadavg[], int nelem) {
4727   if (pset_getloadavg_ptr != NULL) {
4728     return (*pset_getloadavg_ptr)(PS_MYID, loadavg, nelem);
4729   } else {
4730     return ::getloadavg(loadavg, nelem);
4731   }
4732 }
4733 
4734 //---------------------------------------------------------------------------------
4735 
4736 bool os::find(address addr, outputStream* st) {
4737   Dl_info dlinfo;
4738   memset(&amp;dlinfo, 0, sizeof(dlinfo));
4739   if (dladdr(addr, &amp;dlinfo) != 0) {
4740     st-&gt;print(PTR_FORMAT &quot;: &quot;, addr);
4741     if (dlinfo.dli_sname != NULL &amp;&amp; dlinfo.dli_saddr != NULL) {
4742       st-&gt;print(&quot;%s+%#lx&quot;, dlinfo.dli_sname, addr-(intptr_t)dlinfo.dli_saddr);
4743     } else if (dlinfo.dli_fbase != NULL) {
4744       st-&gt;print(&quot;&lt;offset %#lx&gt;&quot;, addr-(intptr_t)dlinfo.dli_fbase);
4745     } else {
4746       st-&gt;print(&quot;&lt;absolute address&gt;&quot;);
4747     }
4748     if (dlinfo.dli_fname != NULL) {
4749       st-&gt;print(&quot; in %s&quot;, dlinfo.dli_fname);
4750     }
4751     if (dlinfo.dli_fbase != NULL) {
4752       st-&gt;print(&quot; at &quot; PTR_FORMAT, dlinfo.dli_fbase);
4753     }
4754     st-&gt;cr();
4755 
4756     if (Verbose) {
4757       // decode some bytes around the PC
4758       address begin = clamp_address_in_page(addr-40, addr, os::vm_page_size());
4759       address end   = clamp_address_in_page(addr+40, addr, os::vm_page_size());
4760       address       lowest = (address) dlinfo.dli_sname;
4761       if (!lowest)  lowest = (address) dlinfo.dli_fbase;
4762       if (begin &lt; lowest)  begin = lowest;
4763       Dl_info dlinfo2;
4764       if (dladdr(end, &amp;dlinfo2) != 0 &amp;&amp; dlinfo2.dli_saddr != dlinfo.dli_saddr
4765           &amp;&amp; end &gt; dlinfo2.dli_saddr &amp;&amp; dlinfo2.dli_saddr &gt; begin) {
4766         end = (address) dlinfo2.dli_saddr;
4767       }
4768       Disassembler::decode(begin, end, st);
4769     }
4770     return true;
4771   }
4772   return false;
4773 }
4774 
4775 // Following function has been added to support HotSparc&#39;s libjvm.so running
4776 // under Solaris production JDK 1.2.2 / 1.3.0.  These came from
4777 // src/solaris/hpi/native_threads in the EVM codebase.
4778 //
4779 // NOTE: This is no longer needed in the 1.3.1 and 1.4 production release
4780 // libraries and should thus be removed. We will leave it behind for a while
4781 // until we no longer want to able to run on top of 1.3.0 Solaris production
4782 // JDK. See 4341971.
4783 
4784 #define STACK_SLACK 0x800
4785 
4786 extern &quot;C&quot; {
4787   intptr_t sysThreadAvailableStackWithSlack() {
4788     stack_t st;
4789     intptr_t retval, stack_top;
4790     retval = thr_stksegment(&amp;st);
4791     assert(retval == 0, &quot;incorrect return value from thr_stksegment&quot;);
4792     assert((address)&amp;st &lt; (address)st.ss_sp, &quot;Invalid stack base returned&quot;);
4793     assert((address)&amp;st &gt; (address)st.ss_sp-st.ss_size, &quot;Invalid stack size returned&quot;);
4794     stack_top=(intptr_t)st.ss_sp-st.ss_size;
4795     return ((intptr_t)&amp;stack_top - stack_top - STACK_SLACK);
4796   }
4797 }
4798 
4799 // ObjectMonitor park-unpark infrastructure ...
4800 //
4801 // We implement Solaris and Linux PlatformEvents with the
4802 // obvious condvar-mutex-flag triple.
4803 // Another alternative that works quite well is pipes:
4804 // Each PlatformEvent consists of a pipe-pair.
4805 // The thread associated with the PlatformEvent
4806 // calls park(), which reads from the input end of the pipe.
4807 // Unpark() writes into the other end of the pipe.
4808 // The write-side of the pipe must be set NDELAY.
4809 // Unfortunately pipes consume a large # of handles.
4810 // Native solaris lwp_park() and lwp_unpark() work nicely, too.
4811 // Using pipes for the 1st few threads might be workable, however.
4812 //
4813 // park() is permitted to return spuriously.
4814 // Callers of park() should wrap the call to park() in
4815 // an appropriate loop.  A litmus test for the correct
4816 // usage of park is the following: if park() were modified
4817 // to immediately return 0 your code should still work,
4818 // albeit degenerating to a spin loop.
4819 //
4820 // In a sense, park()-unpark() just provides more polite spinning
4821 // and polling with the key difference over naive spinning being
4822 // that a parked thread needs to be explicitly unparked() in order
4823 // to wake up and to poll the underlying condition.
4824 //
4825 // Assumption:
4826 //    Only one parker can exist on an event, which is why we allocate
4827 //    them per-thread. Multiple unparkers can coexist.
4828 //
4829 // _Event transitions in park()
4830 //   -1 =&gt; -1 : illegal
4831 //    1 =&gt;  0 : pass - return immediately
4832 //    0 =&gt; -1 : block; then set _Event to 0 before returning
4833 //
4834 // _Event transitions in unpark()
4835 //    0 =&gt; 1 : just return
4836 //    1 =&gt; 1 : just return
4837 //   -1 =&gt; either 0 or 1; must signal target thread
4838 //         That is, we can safely transition _Event from -1 to either
4839 //         0 or 1.
4840 //
4841 // _Event serves as a restricted-range semaphore.
4842 //   -1 : thread is blocked, i.e. there is a waiter
4843 //    0 : neutral: thread is running or ready,
4844 //        could have been signaled after a wait started
4845 //    1 : signaled - thread is running or ready
4846 //
4847 // Another possible encoding of _Event would be with
4848 // explicit &quot;PARKED&quot; == 01b and &quot;SIGNALED&quot; == 10b bits.
4849 //
4850 // TODO-FIXME: add DTRACE probes for:
4851 // 1.   Tx parks
4852 // 2.   Ty unparks Tx
4853 // 3.   Tx resumes from park
4854 
4855 
4856 // value determined through experimentation
4857 #define ROUNDINGFIX 11
4858 
4859 // utility to compute the abstime argument to timedwait.
4860 // TODO-FIXME: switch from compute_abstime() to unpackTime().
4861 
4862 static timestruc_t* compute_abstime(timestruc_t* abstime, jlong millis) {
4863   // millis is the relative timeout time
4864   // abstime will be the absolute timeout time
4865   if (millis &lt; 0)  millis = 0;
4866   struct timeval now;
4867   int status = gettimeofday(&amp;now, NULL);
4868   assert(status == 0, &quot;gettimeofday&quot;);
4869   jlong seconds = millis / 1000;
4870   jlong max_wait_period;
4871 
4872   if (UseLWPSynchronization) {
4873     // forward port of fix for 4275818 (not sleeping long enough)
4874     // There was a bug in Solaris 6, 7 and pre-patch 5 of 8 where
4875     // _lwp_cond_timedwait() used a round_down algorithm rather
4876     // than a round_up. For millis less than our roundfactor
4877     // it rounded down to 0 which doesn&#39;t meet the spec.
4878     // For millis &gt; roundfactor we may return a bit sooner, but
4879     // since we can not accurately identify the patch level and
4880     // this has already been fixed in Solaris 9 and 8 we will
4881     // leave it alone rather than always rounding down.
4882 
4883     if (millis &gt; 0 &amp;&amp; millis &lt; ROUNDINGFIX) millis = ROUNDINGFIX;
4884     // It appears that when we go directly through Solaris _lwp_cond_timedwait()
4885     // the acceptable max time threshold is smaller than for libthread on 2.5.1 and 2.6
4886     max_wait_period = 21000000;
4887   } else {
4888     max_wait_period = 50000000;
4889   }
4890   millis %= 1000;
4891   if (seconds &gt; max_wait_period) {      // see man cond_timedwait(3T)
4892     seconds = max_wait_period;
4893   }
4894   abstime-&gt;tv_sec = now.tv_sec  + seconds;
4895   long       usec = now.tv_usec + millis * 1000;
4896   if (usec &gt;= 1000000) {
4897     abstime-&gt;tv_sec += 1;
4898     usec -= 1000000;
4899   }
4900   abstime-&gt;tv_nsec = usec * 1000;
4901   return abstime;
4902 }
4903 
4904 void os::PlatformEvent::park() {           // AKA: down()
4905   // Transitions for _Event:
4906   //   -1 =&gt; -1 : illegal
4907   //    1 =&gt;  0 : pass - return immediately
4908   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4909 
4910   // Invariant: Only the thread associated with the Event/PlatformEvent
4911   // may call park().
4912   assert(_nParked == 0, &quot;invariant&quot;);
4913 
4914   int v;
4915   for (;;) {
4916     v = _Event;
4917     if (Atomic::cmpxchg(v-1, &amp;_Event, v) == v) break;
4918   }
4919   guarantee(v &gt;= 0, &quot;invariant&quot;);
4920   if (v == 0) {
4921     // Do this the hard way by blocking ...
4922     // See http://monaco.sfbay/detail.jsf?cr=5094058.
4923     int status = os::Solaris::mutex_lock(_mutex);
4924     assert_status(status == 0, status, &quot;mutex_lock&quot;);
4925     guarantee(_nParked == 0, &quot;invariant&quot;);
4926     ++_nParked;
4927     while (_Event &lt; 0) {
4928       // for some reason, under 2.7 lwp_cond_wait() may return ETIME ...
4929       // Treat this the same as if the wait was interrupted
4930       // With usr/lib/lwp going to kernel, always handle ETIME
4931       status = os::Solaris::cond_wait(_cond, _mutex);
4932       if (status == ETIME) status = EINTR;
4933       assert_status(status == 0 || status == EINTR, status, &quot;cond_wait&quot;);
4934     }
4935     --_nParked;
4936     _Event = 0;
4937     status = os::Solaris::mutex_unlock(_mutex);
4938     assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4939     // Paranoia to ensure our locked and lock-free paths interact
4940     // correctly with each other.
4941     OrderAccess::fence();
4942   }
4943 }
4944 
4945 int os::PlatformEvent::park(jlong millis) {
4946   // Transitions for _Event:
4947   //   -1 =&gt; -1 : illegal
4948   //    1 =&gt;  0 : pass - return immediately
4949   //    0 =&gt; -1 : block; then set _Event to 0 before returning
4950 
4951   guarantee(_nParked == 0, &quot;invariant&quot;);
4952   int v;
4953   for (;;) {
4954     v = _Event;
4955     if (Atomic::cmpxchg(v-1, &amp;_Event, v) == v) break;
4956   }
4957   guarantee(v &gt;= 0, &quot;invariant&quot;);
4958   if (v != 0) return OS_OK;
4959 
4960   int ret = OS_TIMEOUT;
4961   timestruc_t abst;
4962   compute_abstime(&amp;abst, millis);
4963 
4964   // See http://monaco.sfbay/detail.jsf?cr=5094058.
4965   int status = os::Solaris::mutex_lock(_mutex);
4966   assert_status(status == 0, status, &quot;mutex_lock&quot;);
4967   guarantee(_nParked == 0, &quot;invariant&quot;);
4968   ++_nParked;
4969   while (_Event &lt; 0) {
4970     int status = os::Solaris::cond_timedwait(_cond, _mutex, &amp;abst);
4971     assert_status(status == 0 || status == EINTR ||
4972                   status == ETIME || status == ETIMEDOUT,
4973                   status, &quot;cond_timedwait&quot;);
4974     if (!FilterSpuriousWakeups) break;                // previous semantics
4975     if (status == ETIME || status == ETIMEDOUT) break;
4976     // We consume and ignore EINTR and spurious wakeups.
4977   }
4978   --_nParked;
4979   if (_Event &gt;= 0) ret = OS_OK;
4980   _Event = 0;
4981   status = os::Solaris::mutex_unlock(_mutex);
4982   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
4983   // Paranoia to ensure our locked and lock-free paths interact
4984   // correctly with each other.
4985   OrderAccess::fence();
4986   return ret;
4987 }
4988 
4989 void os::PlatformEvent::unpark() {
4990   // Transitions for _Event:
4991   //    0 =&gt; 1 : just return
4992   //    1 =&gt; 1 : just return
4993   //   -1 =&gt; either 0 or 1; must signal target thread
4994   //         That is, we can safely transition _Event from -1 to either
4995   //         0 or 1.
4996   // See also: &quot;Semaphores in Plan 9&quot; by Mullender &amp; Cox
4997   //
4998   // Note: Forcing a transition from &quot;-1&quot; to &quot;1&quot; on an unpark() means
4999   // that it will take two back-to-back park() calls for the owning
5000   // thread to block. This has the benefit of forcing a spurious return
5001   // from the first park() call after an unpark() call which will help
5002   // shake out uses of park() and unpark() without condition variables.
5003 
5004   if (Atomic::xchg(1, &amp;_Event) &gt;= 0) return;
5005 
5006   // If the thread associated with the event was parked, wake it.
5007   // Wait for the thread assoc with the PlatformEvent to vacate.
5008   int status = os::Solaris::mutex_lock(_mutex);
5009   assert_status(status == 0, status, &quot;mutex_lock&quot;);
5010   int AnyWaiters = _nParked;
5011   status = os::Solaris::mutex_unlock(_mutex);
5012   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
5013   guarantee(AnyWaiters == 0 || AnyWaiters == 1, &quot;invariant&quot;);
5014   if (AnyWaiters != 0) {
5015     // Note that we signal() *after* dropping the lock for &quot;immortal&quot; Events.
5016     // This is safe and avoids a common class of  futile wakeups.  In rare
5017     // circumstances this can cause a thread to return prematurely from
5018     // cond_{timed}wait() but the spurious wakeup is benign and the victim
5019     // will simply re-test the condition and re-park itself.
5020     // This provides particular benefit if the underlying platform does not
5021     // provide wait morphing.
5022     status = os::Solaris::cond_signal(_cond);
5023     assert_status(status == 0, status, &quot;cond_signal&quot;);
5024   }
5025 }
5026 
5027 // JSR166
5028 // -------------------------------------------------------
5029 
5030 // The solaris and linux implementations of park/unpark are fairly
5031 // conservative for now, but can be improved. They currently use a
5032 // mutex/condvar pair, plus _counter.
5033 // Park decrements _counter if &gt; 0, else does a condvar wait.  Unpark
5034 // sets count to 1 and signals condvar.  Only one thread ever waits
5035 // on the condvar. Contention seen when trying to park implies that someone
5036 // is unparking you, so don&#39;t wait. And spurious returns are fine, so there
5037 // is no need to track notifications.
5038 
5039 #define MAX_SECS 100000000
5040 
5041 // This code is common to linux and solaris and will be moved to a
5042 // common place in dolphin.
5043 //
5044 // The passed in time value is either a relative time in nanoseconds
5045 // or an absolute time in milliseconds. Either way it has to be unpacked
5046 // into suitable seconds and nanoseconds components and stored in the
5047 // given timespec structure.
5048 // Given time is a 64-bit value and the time_t used in the timespec is only
5049 // a signed-32-bit value (except on 64-bit Linux) we have to watch for
5050 // overflow if times way in the future are given. Further on Solaris versions
5051 // prior to 10 there is a restriction (see cond_timedwait) that the specified
5052 // number of seconds, in abstime, is less than current_time  + 100,000,000.
5053 // As it will be 28 years before &quot;now + 100000000&quot; will overflow we can
5054 // ignore overflow and just impose a hard-limit on seconds using the value
5055 // of &quot;now + 100,000,000&quot;. This places a limit on the timeout of about 3.17
5056 // years from &quot;now&quot;.
5057 //
5058 static void unpackTime(timespec* absTime, bool isAbsolute, jlong time) {
5059   assert(time &gt; 0, &quot;convertTime&quot;);
5060 
5061   struct timeval now;
5062   int status = gettimeofday(&amp;now, NULL);
5063   assert(status == 0, &quot;gettimeofday&quot;);
5064 
5065   time_t max_secs = now.tv_sec + MAX_SECS;
5066 
5067   if (isAbsolute) {
5068     jlong secs = time / 1000;
5069     if (secs &gt; max_secs) {
5070       absTime-&gt;tv_sec = max_secs;
5071     } else {
5072       absTime-&gt;tv_sec = secs;
5073     }
5074     absTime-&gt;tv_nsec = (time % 1000) * NANOSECS_PER_MILLISEC;
5075   } else {
5076     jlong secs = time / NANOSECS_PER_SEC;
5077     if (secs &gt;= MAX_SECS) {
5078       absTime-&gt;tv_sec = max_secs;
5079       absTime-&gt;tv_nsec = 0;
5080     } else {
5081       absTime-&gt;tv_sec = now.tv_sec + secs;
5082       absTime-&gt;tv_nsec = (time % NANOSECS_PER_SEC) + now.tv_usec*1000;
5083       if (absTime-&gt;tv_nsec &gt;= NANOSECS_PER_SEC) {
5084         absTime-&gt;tv_nsec -= NANOSECS_PER_SEC;
5085         ++absTime-&gt;tv_sec; // note: this must be &lt;= max_secs
5086       }
5087     }
5088   }
5089   assert(absTime-&gt;tv_sec &gt;= 0, &quot;tv_sec &lt; 0&quot;);
5090   assert(absTime-&gt;tv_sec &lt;= max_secs, &quot;tv_sec &gt; max_secs&quot;);
5091   assert(absTime-&gt;tv_nsec &gt;= 0, &quot;tv_nsec &lt; 0&quot;);
5092   assert(absTime-&gt;tv_nsec &lt; NANOSECS_PER_SEC, &quot;tv_nsec &gt;= nanos_per_sec&quot;);
5093 }
5094 
5095 void Parker::park(bool isAbsolute, jlong time) {
5096   // Ideally we&#39;d do something useful while spinning, such
5097   // as calling unpackTime().
5098 
5099   // Optional fast-path check:
5100   // Return immediately if a permit is available.
5101   // We depend on Atomic::xchg() having full barrier semantics
5102   // since we are doing a lock-free update to _counter.
5103   if (Atomic::xchg(0, &amp;_counter) &gt; 0) return;
5104 
5105   // Optional fast-exit: Check interrupt before trying to wait
5106   Thread* thread = Thread::current();
5107   assert(thread-&gt;is_Java_thread(), &quot;Must be JavaThread&quot;);
5108   JavaThread *jt = (JavaThread *)thread;
5109   if (Thread::is_interrupted(thread, false)) {
5110     return;
5111   }
5112 
5113   // First, demultiplex/decode time arguments
5114   timespec absTime;
5115   if (time &lt; 0 || (isAbsolute &amp;&amp; time == 0)) { // don&#39;t wait at all
5116     return;
5117   }
5118   if (time &gt; 0) {
5119     // Warning: this code might be exposed to the old Solaris time
5120     // round-down bugs.  Grep &quot;roundingFix&quot; for details.
5121     unpackTime(&amp;absTime, isAbsolute, time);
5122   }
5123 
5124   // Enter safepoint region
5125   // Beware of deadlocks such as 6317397.
5126   // The per-thread Parker:: _mutex is a classic leaf-lock.
5127   // In particular a thread must never block on the Threads_lock while
5128   // holding the Parker:: mutex.  If safepoints are pending both the
5129   // the ThreadBlockInVM() CTOR and DTOR may grab Threads_lock.
5130   ThreadBlockInVM tbivm(jt);
5131 
5132   // Don&#39;t wait if cannot get lock since interference arises from
5133   // unblocking.  Also. check interrupt before trying wait
5134   if (Thread::is_interrupted(thread, false) ||
5135       os::Solaris::mutex_trylock(_mutex) != 0) {
5136     return;
5137   }
5138 
5139   int status;
5140 
5141   if (_counter &gt; 0)  { // no wait needed
5142     _counter = 0;
5143     status = os::Solaris::mutex_unlock(_mutex);
5144     assert(status == 0, &quot;invariant&quot;);
5145     // Paranoia to ensure our locked and lock-free paths interact
5146     // correctly with each other and Java-level accesses.
5147     OrderAccess::fence();
5148     return;
5149   }
5150 
5151   OSThreadWaitState osts(thread-&gt;osthread(), false /* not Object.wait() */);
5152   jt-&gt;set_suspend_equivalent();
5153   // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
5154 
5155   // Do this the hard way by blocking ...
5156   // See http://monaco.sfbay/detail.jsf?cr=5094058.
5157   if (time == 0) {
5158     status = os::Solaris::cond_wait(_cond, _mutex);
5159   } else {
5160     status = os::Solaris::cond_timedwait (_cond, _mutex, &amp;absTime);
5161   }
5162   // Note that an untimed cond_wait() can sometimes return ETIME on older
5163   // versions of the Solaris.
5164   assert_status(status == 0 || status == EINTR ||
5165                 status == ETIME || status == ETIMEDOUT,
5166                 status, &quot;cond_timedwait&quot;);
5167 
5168   _counter = 0;
5169   status = os::Solaris::mutex_unlock(_mutex);
5170   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
5171   // Paranoia to ensure our locked and lock-free paths interact
5172   // correctly with each other and Java-level accesses.
5173   OrderAccess::fence();
5174 
5175   // If externally suspended while waiting, re-suspend
5176   if (jt-&gt;handle_special_suspend_equivalent_condition()) {
5177     jt-&gt;java_suspend_self();
5178   }
5179 }
5180 
5181 void Parker::unpark() {
5182   int status = os::Solaris::mutex_lock(_mutex);
5183   assert(status == 0, &quot;invariant&quot;);
5184   const int s = _counter;
5185   _counter = 1;
5186   status = os::Solaris::mutex_unlock(_mutex);
5187   assert(status == 0, &quot;invariant&quot;);
5188 
5189   if (s &lt; 1) {
5190     status = os::Solaris::cond_signal(_cond);
5191     assert(status == 0, &quot;invariant&quot;);
5192   }
5193 }
5194 
5195 // Platform Monitor implementation
5196 
5197 os::PlatformMonitor::PlatformMonitor() {
5198   int status = os::Solaris::cond_init(&amp;_cond);
5199   assert_status(status == 0, status, &quot;cond_init&quot;);
5200   status = os::Solaris::mutex_init(&amp;_mutex);
5201   assert_status(status == 0, status, &quot;mutex_init&quot;);
5202 }
5203 
5204 os::PlatformMonitor::~PlatformMonitor() {
5205   int status = os::Solaris::cond_destroy(&amp;_cond);
5206   assert_status(status == 0, status, &quot;cond_destroy&quot;);
5207   status = os::Solaris::mutex_destroy(&amp;_mutex);
5208   assert_status(status == 0, status, &quot;mutex_destroy&quot;);
5209 }
5210 
5211 void os::PlatformMonitor::lock() {
5212   int status = os::Solaris::mutex_lock(&amp;_mutex);
5213   assert_status(status == 0, status, &quot;mutex_lock&quot;);
5214 }
5215 
5216 void os::PlatformMonitor::unlock() {
5217   int status = os::Solaris::mutex_unlock(&amp;_mutex);
5218   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
5219 }
5220 
5221 bool os::PlatformMonitor::try_lock() {
5222   int status = os::Solaris::mutex_trylock(&amp;_mutex);
5223   assert_status(status == 0 || status == EBUSY, status, &quot;mutex_trylock&quot;);
5224   return status == 0;
5225 }
5226 
5227 // Must already be locked
5228 int os::PlatformMonitor::wait(jlong millis) {
5229   assert(millis &gt;= 0, &quot;negative timeout&quot;);
5230   if (millis &gt; 0) {
5231     timestruc_t abst;
5232     int ret = OS_TIMEOUT;
5233     compute_abstime(&amp;abst, millis);
5234     int status = os::Solaris::cond_timedwait(&amp;_cond, &amp;_mutex, &amp;abst);
5235     assert_status(status == 0 || status == EINTR ||
5236                   status == ETIME || status == ETIMEDOUT,
5237                   status, &quot;cond_timedwait&quot;);
5238     // EINTR acts as spurious wakeup - which is permitted anyway
5239     if (status == 0 || status == EINTR) {
5240       ret = OS_OK;
5241     }
5242     return ret;
5243   } else {
5244     int status = os::Solaris::cond_wait(&amp;_cond, &amp;_mutex);
5245     assert_status(status == 0 || status == EINTR,
5246                   status, &quot;cond_wait&quot;);
5247     return OS_OK;
5248   }
5249 }
5250 
5251 void os::PlatformMonitor::notify() {
5252   int status = os::Solaris::cond_signal(&amp;_cond);
5253   assert_status(status == 0, status, &quot;cond_signal&quot;);
5254 }
5255 
5256 void os::PlatformMonitor::notify_all() {
5257   int status = os::Solaris::cond_broadcast(&amp;_cond);
5258   assert_status(status == 0, status, &quot;cond_broadcast&quot;);
5259 }
5260 
5261 extern char** environ;
5262 
5263 // Run the specified command in a separate process. Return its exit value,
5264 // or -1 on failure (e.g. can&#39;t fork a new process).
5265 // Unlike system(), this function can be called from signal handler. It
5266 // doesn&#39;t block SIGINT et al.
5267 int os::fork_and_exec(char* cmd, bool use_vfork_if_available) {
5268   char * argv[4];
5269   argv[0] = (char *)&quot;sh&quot;;
5270   argv[1] = (char *)&quot;-c&quot;;
5271   argv[2] = cmd;
5272   argv[3] = NULL;
5273 
5274   // fork is async-safe, fork1 is not so can&#39;t use in signal handler
5275   pid_t pid;
5276   Thread* t = Thread::current_or_null_safe();
5277   if (t != NULL &amp;&amp; t-&gt;is_inside_signal_handler()) {
5278     pid = fork();
5279   } else {
5280     pid = fork1();
5281   }
5282 
5283   if (pid &lt; 0) {
5284     // fork failed
5285     warning(&quot;fork failed: %s&quot;, os::strerror(errno));
5286     return -1;
5287 
5288   } else if (pid == 0) {
5289     // child process
5290 
5291     // try to be consistent with system(), which uses &quot;/usr/bin/sh&quot; on Solaris
5292     execve(&quot;/usr/bin/sh&quot;, argv, environ);
5293 
5294     // execve failed
5295     _exit(-1);
5296 
5297   } else  {
5298     // copied from J2SE ..._waitForProcessExit() in UNIXProcess_md.c; we don&#39;t
5299     // care about the actual exit code, for now.
5300 
5301     int status;
5302 
5303     // Wait for the child process to exit.  This returns immediately if
5304     // the child has already exited. */
5305     while (waitpid(pid, &amp;status, 0) &lt; 0) {
5306       switch (errno) {
5307       case ECHILD: return 0;
5308       case EINTR: break;
5309       default: return -1;
5310       }
5311     }
5312 
5313     if (WIFEXITED(status)) {
5314       // The child exited normally; get its exit code.
5315       return WEXITSTATUS(status);
5316     } else if (WIFSIGNALED(status)) {
5317       // The child exited because of a signal
5318       // The best value to return is 0x80 + signal number,
5319       // because that is what all Unix shells do, and because
5320       // it allows callers to distinguish between process exit and
5321       // process death by signal.
5322       return 0x80 + WTERMSIG(status);
5323     } else {
5324       // Unknown exit code; pass it through
5325       return status;
5326     }
5327   }
5328 }
5329 
5330 size_t os::write(int fd, const void *buf, unsigned int nBytes) {
5331   size_t res;
5332   RESTARTABLE((size_t) ::write(fd, buf, (size_t) nBytes), res);
5333   return res;
5334 }
5335 
5336 int os::close(int fd) {
5337   return ::close(fd);
5338 }
5339 
5340 int os::socket_close(int fd) {
5341   return ::close(fd);
5342 }
5343 
5344 int os::recv(int fd, char* buf, size_t nBytes, uint flags) {
5345   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5346          &quot;Assumed _thread_in_native&quot;);
5347   RESTARTABLE_RETURN_INT((int)::recv(fd, buf, nBytes, flags));
5348 }
5349 
5350 int os::send(int fd, char* buf, size_t nBytes, uint flags) {
5351   assert(((JavaThread*)Thread::current())-&gt;thread_state() == _thread_in_native,
5352          &quot;Assumed _thread_in_native&quot;);
5353   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5354 }
5355 
5356 int os::raw_send(int fd, char* buf, size_t nBytes, uint flags) {
5357   RESTARTABLE_RETURN_INT((int)::send(fd, buf, nBytes, flags));
5358 }
5359 
5360 // As both poll and select can be interrupted by signals, we have to be
5361 // prepared to restart the system call after updating the timeout, unless
5362 // a poll() is done with timeout == -1, in which case we repeat with this
5363 // &quot;wait forever&quot; value.
5364 
5365 int os::connect(int fd, struct sockaddr *him, socklen_t len) {
5366   int _result;
5367   _result = ::connect(fd, him, len);
5368 
5369   // On Solaris, when a connect() call is interrupted, the connection
5370   // can be established asynchronously (see 6343810). Subsequent calls
5371   // to connect() must check the errno value which has the semantic
5372   // described below (copied from the connect() man page). Handling
5373   // of asynchronously established connections is required for both
5374   // blocking and non-blocking sockets.
5375   //     EINTR            The  connection  attempt  was   interrupted
5376   //                      before  any data arrived by the delivery of
5377   //                      a signal. The connection, however, will  be
5378   //                      established asynchronously.
5379   //
5380   //     EINPROGRESS      The socket is non-blocking, and the connec-
5381   //                      tion  cannot  be completed immediately.
5382   //
5383   //     EALREADY         The socket is non-blocking,  and a previous
5384   //                      connection  attempt  has  not yet been com-
5385   //                      pleted.
5386   //
5387   //     EISCONN          The socket is already connected.
5388   if (_result == OS_ERR &amp;&amp; errno == EINTR) {
5389     // restarting a connect() changes its errno semantics
5390     RESTARTABLE(::connect(fd, him, len), _result);
5391     // undo these changes
5392     if (_result == OS_ERR) {
5393       if (errno == EALREADY) {
5394         errno = EINPROGRESS; // fall through
5395       } else if (errno == EISCONN) {
5396         errno = 0;
5397         return OS_OK;
5398       }
5399     }
5400   }
5401   return _result;
5402 }
5403 
5404 // Get the default path to the core file
5405 // Returns the length of the string
5406 int os::get_core_path(char* buffer, size_t bufferSize) {
5407   const char* p = get_current_directory(buffer, bufferSize);
5408 
5409   if (p == NULL) {
5410     assert(p != NULL, &quot;failed to get current directory&quot;);
5411     return 0;
5412   }
5413 
5414   jio_snprintf(buffer, bufferSize, &quot;%s/core or core.%d&quot;,
5415                                               p, current_process_id());
5416 
5417   return strlen(buffer);
5418 }
5419 
5420 #ifndef PRODUCT
5421 void TestReserveMemorySpecial_test() {
5422   // No tests available for this platform
5423 }
5424 #endif
5425 
5426 bool os::start_debugging(char *buf, int buflen) {
5427   int len = (int)strlen(buf);
5428   char *p = &amp;buf[len];
5429 
5430   jio_snprintf(p, buflen-len,
5431                &quot;\n\n&quot;
5432                &quot;Do you want to debug the problem?\n\n&quot;
5433                &quot;To debug, run &#39;dbx - %d&#39;; then switch to thread &quot; INTX_FORMAT &quot;\n&quot;
5434                &quot;Enter &#39;yes&#39; to launch dbx automatically (PATH must include dbx)\n&quot;
5435                &quot;Otherwise, press RETURN to abort...&quot;,
5436                os::current_process_id(), os::current_thread_id());
5437 
5438   bool yes = os::message_box(&quot;Unexpected Error&quot;, buf);
5439 
5440   if (yes) {
5441     // yes, user asked VM to launch debugger
5442     jio_snprintf(buf, sizeof(buf), &quot;dbx - %d&quot;, os::current_process_id());
5443 
5444     os::fork_and_exec(buf);
5445     yes = false;
5446   }
5447   return yes;
5448 }
    </pre>
  </body>
</html>