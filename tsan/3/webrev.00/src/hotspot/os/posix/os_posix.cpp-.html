<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/os/posix/os_posix.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1999, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;jvm.h&quot;
  26 #include &quot;logging/log.hpp&quot;
  27 #include &quot;memory/allocation.inline.hpp&quot;
  28 #include &quot;os_posix.inline.hpp&quot;
  29 #include &quot;utilities/globalDefinitions.hpp&quot;
  30 #include &quot;runtime/frame.inline.hpp&quot;
  31 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  32 #include &quot;services/memTracker.hpp&quot;
  33 #include &quot;utilities/align.hpp&quot;
  34 #include &quot;utilities/events.hpp&quot;
  35 #include &quot;utilities/formatBuffer.hpp&quot;
  36 #include &quot;utilities/macros.hpp&quot;
  37 #include &quot;utilities/vmError.hpp&quot;
  38 
  39 #include &lt;dirent.h&gt;
  40 #include &lt;dlfcn.h&gt;
  41 #include &lt;grp.h&gt;
  42 #include &lt;pwd.h&gt;
  43 #include &lt;pthread.h&gt;
  44 #include &lt;signal.h&gt;
  45 #include &lt;sys/mman.h&gt;
  46 #include &lt;sys/resource.h&gt;
  47 #include &lt;sys/utsname.h&gt;
  48 #include &lt;time.h&gt;
  49 #include &lt;unistd.h&gt;
  50 
  51 // Todo: provide a os::get_max_process_id() or similar. Number of processes
  52 // may have been configured, can be read more accurately from proc fs etc.
  53 #ifndef MAX_PID
  54 #define MAX_PID INT_MAX
  55 #endif
  56 #define IS_VALID_PID(p) (p &gt; 0 &amp;&amp; p &lt; MAX_PID)
  57 
  58 #define ROOT_UID 0
  59 
  60 #ifndef MAP_ANONYMOUS
  61   #define MAP_ANONYMOUS MAP_ANON
  62 #endif
  63 
  64 #define check_with_errno(check_type, cond, msg)                             \
  65   do {                                                                      \
  66     int err = errno;                                                        \
  67     check_type(cond, &quot;%s; error=&#39;%s&#39; (errno=%s)&quot;, msg, os::strerror(err),   \
  68                os::errno_name(err));                                        \
  69 } while (false)
  70 
  71 #define assert_with_errno(cond, msg)    check_with_errno(assert, cond, msg)
  72 #define guarantee_with_errno(cond, msg) check_with_errno(guarantee, cond, msg)
  73 
  74 // Check core dump limit and report possible place where core can be found
  75 void os::check_dump_limit(char* buffer, size_t bufferSize) {
  76   if (!FLAG_IS_DEFAULT(CreateCoredumpOnCrash) &amp;&amp; !CreateCoredumpOnCrash) {
  77     jio_snprintf(buffer, bufferSize, &quot;CreateCoredumpOnCrash is disabled from command line&quot;);
  78     VMError::record_coredump_status(buffer, false);
  79     return;
  80   }
  81 
  82   int n;
  83   struct rlimit rlim;
  84   bool success;
  85 
  86   char core_path[PATH_MAX];
  87   n = get_core_path(core_path, PATH_MAX);
  88 
  89   if (n &lt;= 0) {
  90     jio_snprintf(buffer, bufferSize, &quot;core.%d (may not exist)&quot;, current_process_id());
  91     success = true;
  92 #ifdef LINUX
  93   } else if (core_path[0] == &#39;&quot;&#39;) { // redirect to user process
  94     jio_snprintf(buffer, bufferSize, &quot;Core dumps may be processed with %s&quot;, core_path);
  95     success = true;
  96 #endif
  97   } else if (getrlimit(RLIMIT_CORE, &amp;rlim) != 0) {
  98     jio_snprintf(buffer, bufferSize, &quot;%s (may not exist)&quot;, core_path);
  99     success = true;
 100   } else {
 101     switch(rlim.rlim_cur) {
 102       case RLIM_INFINITY:
 103         jio_snprintf(buffer, bufferSize, &quot;%s&quot;, core_path);
 104         success = true;
 105         break;
 106       case 0:
 107         jio_snprintf(buffer, bufferSize, &quot;Core dumps have been disabled. To enable core dumping, try \&quot;ulimit -c unlimited\&quot; before starting Java again&quot;);
 108         success = false;
 109         break;
 110       default:
 111         jio_snprintf(buffer, bufferSize, &quot;%s (max size &quot; UINT64_FORMAT &quot; kB). To ensure a full core dump, try \&quot;ulimit -c unlimited\&quot; before starting Java again&quot;, core_path, uint64_t(rlim.rlim_cur) / 1024);
 112         success = true;
 113         break;
 114     }
 115   }
 116 
 117   VMError::record_coredump_status(buffer, success);
 118 }
 119 
 120 int os::get_native_stack(address* stack, int frames, int toSkip) {
 121   int frame_idx = 0;
 122   int num_of_frames;  // number of frames captured
 123   frame fr = os::current_frame();
 124   while (fr.pc() &amp;&amp; frame_idx &lt; frames) {
 125     if (toSkip &gt; 0) {
 126       toSkip --;
 127     } else {
 128       stack[frame_idx ++] = fr.pc();
 129     }
 130     if (fr.fp() == NULL || fr.cb() != NULL ||
 131         fr.sender_pc() == NULL || os::is_first_C_frame(&amp;fr)) break;
 132 
 133     if (fr.sender_pc() &amp;&amp; !os::is_first_C_frame(&amp;fr)) {
 134       fr = os::get_sender_for_C_frame(&amp;fr);
 135     } else {
 136       break;
 137     }
 138   }
 139   num_of_frames = frame_idx;
 140   for (; frame_idx &lt; frames; frame_idx ++) {
 141     stack[frame_idx] = NULL;
 142   }
 143 
 144   return num_of_frames;
 145 }
 146 
 147 
 148 bool os::unsetenv(const char* name) {
 149   assert(name != NULL, &quot;Null pointer&quot;);
 150   return (::unsetenv(name) == 0);
 151 }
 152 
 153 int os::get_last_error() {
 154   return errno;
 155 }
 156 
 157 size_t os::lasterror(char *buf, size_t len) {
 158   if (errno == 0)  return 0;
 159 
 160   const char *s = os::strerror(errno);
 161   size_t n = ::strlen(s);
 162   if (n &gt;= len) {
 163     n = len - 1;
 164   }
 165   ::strncpy(buf, s, n);
 166   buf[n] = &#39;\0&#39;;
 167   return n;
 168 }
 169 
 170 bool os::is_debugger_attached() {
 171   // not implemented
 172   return false;
 173 }
 174 
 175 void os::wait_for_keypress_at_exit(void) {
 176   // don&#39;t do anything on posix platforms
 177   return;
 178 }
 179 
 180 int os::create_file_for_heap(const char* dir) {
 181 
 182   const char name_template[] = &quot;/jvmheap.XXXXXX&quot;;
 183 
 184   size_t fullname_len = strlen(dir) + strlen(name_template);
 185   char *fullname = (char*)os::malloc(fullname_len + 1, mtInternal);
 186   if (fullname == NULL) {
 187     vm_exit_during_initialization(err_msg(&quot;Malloc failed during creation of backing file for heap (%s)&quot;, os::strerror(errno)));
 188     return -1;
 189   }
 190   int n = snprintf(fullname, fullname_len + 1, &quot;%s%s&quot;, dir, name_template);
 191   assert((size_t)n == fullname_len, &quot;Unexpected number of characters in string&quot;);
 192 
 193   os::native_path(fullname);
 194 
 195   // set the file creation mask.
 196   mode_t file_mode = S_IRUSR | S_IWUSR;
 197 
 198   // create a new file.
 199   int fd = mkstemp(fullname);
 200 
 201   if (fd &lt; 0) {
 202     warning(&quot;Could not create file for heap with template %s&quot;, fullname);
 203     os::free(fullname);
 204     return -1;
 205   }
 206 
 207   // delete the name from the filesystem. When &#39;fd&#39; is closed, the file (and space) will be deleted.
 208   int ret = unlink(fullname);
 209   assert_with_errno(ret == 0, &quot;unlink returned error&quot;);
 210 
 211   os::free(fullname);
 212   return fd;
 213 }
 214 
 215 static char* reserve_mmapped_memory(size_t bytes, char* requested_addr) {
 216   char * addr;
 217   int flags = MAP_PRIVATE NOT_AIX( | MAP_NORESERVE ) | MAP_ANONYMOUS;
 218   if (requested_addr != NULL) {
 219     assert((uintptr_t)requested_addr % os::vm_page_size() == 0, &quot;Requested address should be aligned to OS page size&quot;);
 220     flags |= MAP_FIXED;
 221   }
 222 
 223   // Map reserved/uncommitted pages PROT_NONE so we fail early if we
 224   // touch an uncommitted page. Otherwise, the read/write might
 225   // succeed if we have enough swap space to back the physical page.
 226   addr = (char*)::mmap(requested_addr, bytes, PROT_NONE,
 227                        flags, -1, 0);
 228 
 229   if (addr != MAP_FAILED) {
 230     MemTracker::record_virtual_memory_reserve((address)addr, bytes, CALLER_PC);
 231     return addr;
 232   }
 233   return NULL;
 234 }
 235 
 236 static int util_posix_fallocate(int fd, off_t offset, off_t len) {
 237 #ifdef __APPLE__
 238   fstore_t store = { F_ALLOCATECONTIG, F_PEOFPOSMODE, 0, len };
 239   // First we try to get a continuous chunk of disk space
 240   int ret = fcntl(fd, F_PREALLOCATE, &amp;store);
 241   if (ret == -1) {
 242     // Maybe we are too fragmented, try to allocate non-continuous range
 243     store.fst_flags = F_ALLOCATEALL;
 244     ret = fcntl(fd, F_PREALLOCATE, &amp;store);
 245   }
 246   if(ret != -1) {
 247     return ftruncate(fd, len);
 248   }
 249   return -1;
 250 #else
 251   return posix_fallocate(fd, offset, len);
 252 #endif
 253 }
 254 
 255 // Map the given address range to the provided file descriptor.
 256 char* os::map_memory_to_file(char* base, size_t size, int fd) {
 257   assert(fd != -1, &quot;File descriptor is not valid&quot;);
 258 
 259   // allocate space for the file
 260   int ret = util_posix_fallocate(fd, 0, (off_t)size);
 261   if (ret != 0) {
 262     vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory. error(%d)&quot;, ret));
 263     return NULL;
 264   }
 265 
 266   int prot = PROT_READ | PROT_WRITE;
 267   int flags = MAP_SHARED;
 268   if (base != NULL) {
 269     flags |= MAP_FIXED;
 270   }
 271   char* addr = (char*)mmap(base, size, prot, flags, fd, 0);
 272 
 273   if (addr == MAP_FAILED) {
 274     warning(&quot;Failed mmap to file. (%s)&quot;, os::strerror(errno));
 275     return NULL;
 276   }
 277   if (base != NULL &amp;&amp; addr != base) {
 278     if (!os::release_memory(addr, size)) {
 279       warning(&quot;Could not release memory on unsuccessful file mapping&quot;);
 280     }
 281     return NULL;
 282   }
 283   return addr;
 284 }
 285 
 286 char* os::replace_existing_mapping_with_file_mapping(char* base, size_t size, int fd) {
 287   assert(fd != -1, &quot;File descriptor is not valid&quot;);
 288   assert(base != NULL, &quot;Base cannot be NULL&quot;);
 289 
 290   return map_memory_to_file(base, size, fd);
 291 }
 292 
 293 // Multiple threads can race in this code, and can remap over each other with MAP_FIXED,
 294 // so on posix, unmap the section at the start and at the end of the chunk that we mapped
 295 // rather than unmapping and remapping the whole chunk to get requested alignment.
 296 char* os::reserve_memory_aligned(size_t size, size_t alignment, int file_desc) {
 297   assert((alignment &amp; (os::vm_allocation_granularity() - 1)) == 0,
 298       &quot;Alignment must be a multiple of allocation granularity (page size)&quot;);
 299   assert((size &amp; (alignment -1)) == 0, &quot;size must be &#39;alignment&#39; aligned&quot;);
 300 
 301   size_t extra_size = size + alignment;
 302   assert(extra_size &gt;= size, &quot;overflow, size is too large to allow alignment&quot;);
 303 
 304   char* extra_base;
 305   if (file_desc != -1) {
 306     // For file mapping, we do not call os:reserve_memory(extra_size, NULL, alignment, file_desc) because
 307     // we need to deal with shrinking of the file space later when we release extra memory after alignment.
 308     // We also cannot called os:reserve_memory() with file_desc set to -1 because on aix we might get SHM memory.
 309     // So here to call a helper function while reserve memory for us. After we have a aligned base,
 310     // we will replace anonymous mapping with file mapping.
 311     extra_base = reserve_mmapped_memory(extra_size, NULL);
 312     if (extra_base != NULL) {
 313       MemTracker::record_virtual_memory_reserve((address)extra_base, extra_size, CALLER_PC);
 314     }
 315   } else {
 316     extra_base = os::reserve_memory(extra_size, NULL, alignment);
 317   }
 318 
 319   if (extra_base == NULL) {
 320     return NULL;
 321   }
 322 
 323   // Do manual alignment
 324   char* aligned_base = align_up(extra_base, alignment);
 325 
 326   // [  |                                       |  ]
 327   // ^ extra_base
 328   //    ^ extra_base + begin_offset == aligned_base
 329   //     extra_base + begin_offset + size       ^
 330   //                       extra_base + extra_size ^
 331   // |&lt;&gt;| == begin_offset
 332   //                              end_offset == |&lt;&gt;|
 333   size_t begin_offset = aligned_base - extra_base;
 334   size_t end_offset = (extra_base + extra_size) - (aligned_base + size);
 335 
 336   if (begin_offset &gt; 0) {
 337       os::release_memory(extra_base, begin_offset);
 338   }
 339 
 340   if (end_offset &gt; 0) {
 341       os::release_memory(extra_base + begin_offset + size, end_offset);
 342   }
 343 
 344   if (file_desc != -1) {
 345     // After we have an aligned address, we can replace anonymous mapping with file mapping
 346     if (replace_existing_mapping_with_file_mapping(aligned_base, size, file_desc) == NULL) {
 347       vm_exit_during_initialization(err_msg(&quot;Error in mapping Java heap at the given filesystem directory&quot;));
 348     }
 349     MemTracker::record_virtual_memory_commit((address)aligned_base, size, CALLER_PC);
 350   }
 351   return aligned_base;
 352 }
 353 
 354 int os::vsnprintf(char* buf, size_t len, const char* fmt, va_list args) {
 355   // All supported POSIX platforms provide C99 semantics.
 356   int result = ::vsnprintf(buf, len, fmt, args);
 357   // If an encoding error occurred (result &lt; 0) then it&#39;s not clear
 358   // whether the buffer is NUL terminated, so ensure it is.
 359   if ((result &lt; 0) &amp;&amp; (len &gt; 0)) {
 360     buf[len - 1] = &#39;\0&#39;;
 361   }
 362   return result;
 363 }
 364 
 365 int os::get_fileno(FILE* fp) {
 366   return NOT_AIX(::)fileno(fp);
 367 }
 368 
 369 struct tm* os::gmtime_pd(const time_t* clock, struct tm*  res) {
 370   return gmtime_r(clock, res);
 371 }
 372 
 373 void os::Posix::print_load_average(outputStream* st) {
 374   st-&gt;print(&quot;load average:&quot;);
 375   double loadavg[3];
 376   os::loadavg(loadavg, 3);
 377   st-&gt;print(&quot;%0.02f %0.02f %0.02f&quot;, loadavg[0], loadavg[1], loadavg[2]);
 378   st-&gt;cr();
 379 }
 380 
 381 void os::Posix::print_rlimit_info(outputStream* st) {
 382   st-&gt;print(&quot;rlimit:&quot;);
 383   struct rlimit rlim;
 384 
 385   st-&gt;print(&quot; STACK &quot;);
 386   getrlimit(RLIMIT_STACK, &amp;rlim);
 387   if (rlim.rlim_cur == RLIM_INFINITY) st-&gt;print(&quot;infinity&quot;);
 388   else st-&gt;print(UINT64_FORMAT &quot;k&quot;, uint64_t(rlim.rlim_cur) / 1024);
 389 
 390   st-&gt;print(&quot;, CORE &quot;);
 391   getrlimit(RLIMIT_CORE, &amp;rlim);
 392   if (rlim.rlim_cur == RLIM_INFINITY) st-&gt;print(&quot;infinity&quot;);
 393   else st-&gt;print(UINT64_FORMAT &quot;k&quot;, uint64_t(rlim.rlim_cur) / 1024);
 394 
 395   // Isn&#39;t there on solaris
 396 #if defined(AIX)
 397   st-&gt;print(&quot;, NPROC &quot;);
 398   st-&gt;print(&quot;%d&quot;, sysconf(_SC_CHILD_MAX));
 399 #elif !defined(SOLARIS)
 400   st-&gt;print(&quot;, NPROC &quot;);
 401   getrlimit(RLIMIT_NPROC, &amp;rlim);
 402   if (rlim.rlim_cur == RLIM_INFINITY) st-&gt;print(&quot;infinity&quot;);
 403   else st-&gt;print(UINT64_FORMAT, uint64_t(rlim.rlim_cur));
 404 #endif
 405 
 406   st-&gt;print(&quot;, NOFILE &quot;);
 407   getrlimit(RLIMIT_NOFILE, &amp;rlim);
 408   if (rlim.rlim_cur == RLIM_INFINITY) st-&gt;print(&quot;infinity&quot;);
 409   else st-&gt;print(UINT64_FORMAT, uint64_t(rlim.rlim_cur));
 410 
 411   st-&gt;print(&quot;, AS &quot;);
 412   getrlimit(RLIMIT_AS, &amp;rlim);
 413   if (rlim.rlim_cur == RLIM_INFINITY) st-&gt;print(&quot;infinity&quot;);
 414   else st-&gt;print(UINT64_FORMAT &quot;k&quot;, uint64_t(rlim.rlim_cur) / 1024);
 415 
 416   st-&gt;print(&quot;, DATA &quot;);
 417   getrlimit(RLIMIT_DATA, &amp;rlim);
 418   if (rlim.rlim_cur == RLIM_INFINITY) st-&gt;print(&quot;infinity&quot;);
 419   else st-&gt;print(UINT64_FORMAT &quot;k&quot;, uint64_t(rlim.rlim_cur) / 1024);
 420 
 421   st-&gt;print(&quot;, FSIZE &quot;);
 422   getrlimit(RLIMIT_FSIZE, &amp;rlim);
 423   if (rlim.rlim_cur == RLIM_INFINITY) st-&gt;print(&quot;infinity&quot;);
 424   else st-&gt;print(UINT64_FORMAT &quot;k&quot;, uint64_t(rlim.rlim_cur) / 1024);
 425 
 426   st-&gt;cr();
 427 }
 428 
 429 void os::Posix::print_uname_info(outputStream* st) {
 430   // kernel
 431   st-&gt;print(&quot;uname:&quot;);
 432   struct utsname name;
 433   uname(&amp;name);
 434   st-&gt;print(&quot;%s &quot;, name.sysname);
 435 #ifdef ASSERT
 436   st-&gt;print(&quot;%s &quot;, name.nodename);
 437 #endif
 438   st-&gt;print(&quot;%s &quot;, name.release);
 439   st-&gt;print(&quot;%s &quot;, name.version);
 440   st-&gt;print(&quot;%s&quot;, name.machine);
 441   st-&gt;cr();
 442 }
 443 
 444 void os::Posix::print_umask(outputStream* st, mode_t umsk) {
 445   st-&gt;print((umsk &amp; S_IRUSR) ? &quot;r&quot; : &quot;-&quot;);
 446   st-&gt;print((umsk &amp; S_IWUSR) ? &quot;w&quot; : &quot;-&quot;);
 447   st-&gt;print((umsk &amp; S_IXUSR) ? &quot;x&quot; : &quot;-&quot;);
 448   st-&gt;print((umsk &amp; S_IRGRP) ? &quot;r&quot; : &quot;-&quot;);
 449   st-&gt;print((umsk &amp; S_IWGRP) ? &quot;w&quot; : &quot;-&quot;);
 450   st-&gt;print((umsk &amp; S_IXGRP) ? &quot;x&quot; : &quot;-&quot;);
 451   st-&gt;print((umsk &amp; S_IROTH) ? &quot;r&quot; : &quot;-&quot;);
 452   st-&gt;print((umsk &amp; S_IWOTH) ? &quot;w&quot; : &quot;-&quot;);
 453   st-&gt;print((umsk &amp; S_IXOTH) ? &quot;x&quot; : &quot;-&quot;);
 454 }
 455 
 456 void os::Posix::print_user_info(outputStream* st) {
 457   unsigned id = (unsigned) ::getuid();
 458   st-&gt;print(&quot;uid  : %u &quot;, id);
 459   id = (unsigned) ::geteuid();
 460   st-&gt;print(&quot;euid : %u &quot;, id);
 461   id = (unsigned) ::getgid();
 462   st-&gt;print(&quot;gid  : %u &quot;, id);
 463   id = (unsigned) ::getegid();
 464   st-&gt;print_cr(&quot;egid : %u&quot;, id);
 465   st-&gt;cr();
 466 
 467   mode_t umsk = ::umask(0);
 468   ::umask(umsk);
 469   st-&gt;print(&quot;umask: %04o (&quot;, (unsigned) umsk);
 470   print_umask(st, umsk);
 471   st-&gt;print_cr(&quot;)&quot;);
 472   st-&gt;cr();
 473 }
 474 
 475 
 476 bool os::get_host_name(char* buf, size_t buflen) {
 477   struct utsname name;
 478   uname(&amp;name);
 479   jio_snprintf(buf, buflen, &quot;%s&quot;, name.nodename);
 480   return true;
 481 }
 482 
 483 bool os::has_allocatable_memory_limit(julong* limit) {
 484   struct rlimit rlim;
 485   int getrlimit_res = getrlimit(RLIMIT_AS, &amp;rlim);
 486   // if there was an error when calling getrlimit, assume that there is no limitation
 487   // on virtual memory.
 488   bool result;
 489   if ((getrlimit_res != 0) || (rlim.rlim_cur == RLIM_INFINITY)) {
 490     result = false;
 491   } else {
 492     *limit = (julong)rlim.rlim_cur;
 493     result = true;
 494   }
 495 #ifdef _LP64
 496   return result;
 497 #else
 498   // arbitrary virtual space limit for 32 bit Unices found by testing. If
 499   // getrlimit above returned a limit, bound it with this limit. Otherwise
 500   // directly use it.
 501   const julong max_virtual_limit = (julong)3800*M;
 502   if (result) {
 503     *limit = MIN2(*limit, max_virtual_limit);
 504   } else {
 505     *limit = max_virtual_limit;
 506   }
 507 
 508   // bound by actually allocatable memory. The algorithm uses two bounds, an
 509   // upper and a lower limit. The upper limit is the current highest amount of
 510   // memory that could not be allocated, the lower limit is the current highest
 511   // amount of memory that could be allocated.
 512   // The algorithm iteratively refines the result by halving the difference
 513   // between these limits, updating either the upper limit (if that value could
 514   // not be allocated) or the lower limit (if the that value could be allocated)
 515   // until the difference between these limits is &quot;small&quot;.
 516 
 517   // the minimum amount of memory we care about allocating.
 518   const julong min_allocation_size = M;
 519 
 520   julong upper_limit = *limit;
 521 
 522   // first check a few trivial cases
 523   if (is_allocatable(upper_limit) || (upper_limit &lt;= min_allocation_size)) {
 524     *limit = upper_limit;
 525   } else if (!is_allocatable(min_allocation_size)) {
 526     // we found that not even min_allocation_size is allocatable. Return it
 527     // anyway. There is no point to search for a better value any more.
 528     *limit = min_allocation_size;
 529   } else {
 530     // perform the binary search.
 531     julong lower_limit = min_allocation_size;
 532     while ((upper_limit - lower_limit) &gt; min_allocation_size) {
 533       julong temp_limit = ((upper_limit - lower_limit) / 2) + lower_limit;
 534       temp_limit = align_down(temp_limit, min_allocation_size);
 535       if (is_allocatable(temp_limit)) {
 536         lower_limit = temp_limit;
 537       } else {
 538         upper_limit = temp_limit;
 539       }
 540     }
 541     *limit = lower_limit;
 542   }
 543   return true;
 544 #endif
 545 }
 546 
 547 const char* os::get_current_directory(char *buf, size_t buflen) {
 548   return getcwd(buf, buflen);
 549 }
 550 
 551 FILE* os::open(int fd, const char* mode) {
 552   return ::fdopen(fd, mode);
 553 }
 554 
 555 ssize_t os::read_at(int fd, void *buf, unsigned int nBytes, jlong offset) {
 556   return ::pread(fd, buf, nBytes, offset);
 557 }
 558 
 559 void os::flockfile(FILE* fp) {
 560   ::flockfile(fp);
 561 }
 562 
 563 void os::funlockfile(FILE* fp) {
 564   ::funlockfile(fp);
 565 }
 566 
 567 DIR* os::opendir(const char* dirname) {
 568   assert(dirname != NULL, &quot;just checking&quot;);
 569   return ::opendir(dirname);
 570 }
 571 
 572 struct dirent* os::readdir(DIR* dirp) {
 573   assert(dirp != NULL, &quot;just checking&quot;);
 574   return ::readdir(dirp);
 575 }
 576 
 577 int os::closedir(DIR *dirp) {
 578   assert(dirp != NULL, &quot;just checking&quot;);
 579   return ::closedir(dirp);
 580 }
 581 
 582 // Builds a platform dependent Agent_OnLoad_&lt;lib_name&gt; function name
 583 // which is used to find statically linked in agents.
 584 // Parameters:
 585 //            sym_name: Symbol in library we are looking for
 586 //            lib_name: Name of library to look in, NULL for shared libs.
 587 //            is_absolute_path == true if lib_name is absolute path to agent
 588 //                                     such as &quot;/a/b/libL.so&quot;
 589 //            == false if only the base name of the library is passed in
 590 //               such as &quot;L&quot;
 591 char* os::build_agent_function_name(const char *sym_name, const char *lib_name,
 592                                     bool is_absolute_path) {
 593   char *agent_entry_name;
 594   size_t len;
 595   size_t name_len;
 596   size_t prefix_len = strlen(JNI_LIB_PREFIX);
 597   size_t suffix_len = strlen(JNI_LIB_SUFFIX);
 598   const char *start;
 599 
 600   if (lib_name != NULL) {
 601     name_len = strlen(lib_name);
 602     if (is_absolute_path) {
 603       // Need to strip path, prefix and suffix
 604       if ((start = strrchr(lib_name, *os::file_separator())) != NULL) {
 605         lib_name = ++start;
 606       }
 607       if (strlen(lib_name) &lt;= (prefix_len + suffix_len)) {
 608         return NULL;
 609       }
 610       lib_name += prefix_len;
 611       name_len = strlen(lib_name) - suffix_len;
 612     }
 613   }
 614   len = (lib_name != NULL ? name_len : 0) + strlen(sym_name) + 2;
 615   agent_entry_name = NEW_C_HEAP_ARRAY_RETURN_NULL(char, len, mtThread);
 616   if (agent_entry_name == NULL) {
 617     return NULL;
 618   }
 619   strcpy(agent_entry_name, sym_name);
 620   if (lib_name != NULL) {
 621     strcat(agent_entry_name, &quot;_&quot;);
 622     strncat(agent_entry_name, lib_name, name_len);
 623   }
 624   return agent_entry_name;
 625 }
 626 
 627 int os::sleep(Thread* thread, jlong millis, bool interruptible) {
 628   assert(thread == Thread::current(),  &quot;thread consistency check&quot;);
 629 
 630   ParkEvent * const slp = thread-&gt;_SleepEvent ;
 631   slp-&gt;reset() ;
 632   OrderAccess::fence() ;
 633 
 634   if (interruptible) {
 635     jlong prevtime = javaTimeNanos();
 636 
 637     for (;;) {
 638       if (os::is_interrupted(thread, true)) {
 639         return OS_INTRPT;
 640       }
 641 
 642       jlong newtime = javaTimeNanos();
 643 
 644       if (newtime - prevtime &lt; 0) {
 645         // time moving backwards, should only happen if no monotonic clock
 646         // not a guarantee() because JVM should not abort on kernel/glibc bugs
 647         assert(!os::supports_monotonic_clock(), &quot;unexpected time moving backwards detected in os::sleep(interruptible)&quot;);
 648       } else {
 649         millis -= (newtime - prevtime) / NANOSECS_PER_MILLISEC;
 650       }
 651 
 652       if (millis &lt;= 0) {
 653         return OS_OK;
 654       }
 655 
 656       prevtime = newtime;
 657 
 658       {
 659         assert(thread-&gt;is_Java_thread(), &quot;sanity check&quot;);
 660         JavaThread *jt = (JavaThread *) thread;
 661         ThreadBlockInVM tbivm(jt);
 662         OSThreadWaitState osts(jt-&gt;osthread(), false /* not Object.wait() */);
 663 
 664         jt-&gt;set_suspend_equivalent();
 665         // cleared by handle_special_suspend_equivalent_condition() or
 666         // java_suspend_self() via check_and_wait_while_suspended()
 667 
 668         slp-&gt;park(millis);
 669 
 670         // were we externally suspended while we were waiting?
 671         jt-&gt;check_and_wait_while_suspended();
 672       }
 673     }
 674   } else {
 675     OSThreadWaitState osts(thread-&gt;osthread(), false /* not Object.wait() */);
 676     jlong prevtime = javaTimeNanos();
 677 
 678     for (;;) {
 679       // It&#39;d be nice to avoid the back-to-back javaTimeNanos() calls on
 680       // the 1st iteration ...
 681       jlong newtime = javaTimeNanos();
 682 
 683       if (newtime - prevtime &lt; 0) {
 684         // time moving backwards, should only happen if no monotonic clock
 685         // not a guarantee() because JVM should not abort on kernel/glibc bugs
 686         assert(!os::supports_monotonic_clock(), &quot;unexpected time moving backwards detected on os::sleep(!interruptible)&quot;);
 687       } else {
 688         millis -= (newtime - prevtime) / NANOSECS_PER_MILLISEC;
 689       }
 690 
 691       if (millis &lt;= 0) break ;
 692 
 693       prevtime = newtime;
 694       slp-&gt;park(millis);
 695     }
 696     return OS_OK ;
 697   }
 698 }
 699 
 700 void os::naked_short_nanosleep(jlong ns) {
 701   struct timespec req;
 702   assert(ns &gt; -1 &amp;&amp; ns &lt; NANOUNITS, &quot;Un-interruptable sleep, short time use only&quot;);
 703   req.tv_sec = 0;
 704   req.tv_nsec = ns;
 705   ::nanosleep(&amp;req, NULL);
 706   return;
 707 }
 708 
 709 void os::naked_short_sleep(jlong ms) {
 710   assert(ms &lt; MILLIUNITS, &quot;Un-interruptable sleep, short time use only&quot;);
 711   os::naked_short_nanosleep(ms * (NANOUNITS / MILLIUNITS));
 712   return;
 713 }
 714 
 715 ////////////////////////////////////////////////////////////////////////////////
 716 // interrupt support
 717 
 718 void os::interrupt(Thread* thread) {
 719   debug_only(Thread::check_for_dangling_thread_pointer(thread);)
 720 
 721   OSThread* osthread = thread-&gt;osthread();
 722 
 723   if (!osthread-&gt;interrupted()) {
 724     osthread-&gt;set_interrupted(true);
 725     // More than one thread can get here with the same value of osthread,
 726     // resulting in multiple notifications.  We do, however, want the store
 727     // to interrupted() to be visible to other threads before we execute unpark().
 728     OrderAccess::fence();
 729     ParkEvent * const slp = thread-&gt;_SleepEvent ;
 730     if (slp != NULL) slp-&gt;unpark() ;
 731   }
 732 
 733   // For JSR166. Unpark even if interrupt status already was set
 734   if (thread-&gt;is_Java_thread())
 735     ((JavaThread*)thread)-&gt;parker()-&gt;unpark();
 736 
 737   ParkEvent * ev = thread-&gt;_ParkEvent ;
 738   if (ev != NULL) ev-&gt;unpark() ;
 739 }
 740 
 741 bool os::is_interrupted(Thread* thread, bool clear_interrupted) {
 742   debug_only(Thread::check_for_dangling_thread_pointer(thread);)
 743 
 744   OSThread* osthread = thread-&gt;osthread();
 745 
 746   bool interrupted = osthread-&gt;interrupted();
 747 
 748   // NOTE that since there is no &quot;lock&quot; around the interrupt and
 749   // is_interrupted operations, there is the possibility that the
 750   // interrupted flag (in osThread) will be &quot;false&quot; but that the
 751   // low-level events will be in the signaled state. This is
 752   // intentional. The effect of this is that Object.wait() and
 753   // LockSupport.park() will appear to have a spurious wakeup, which
 754   // is allowed and not harmful, and the possibility is so rare that
 755   // it is not worth the added complexity to add yet another lock.
 756   // For the sleep event an explicit reset is performed on entry
 757   // to os::sleep, so there is no early return. It has also been
 758   // recommended not to put the interrupted flag into the &quot;event&quot;
 759   // structure because it hides the issue.
 760   if (interrupted &amp;&amp; clear_interrupted) {
 761     osthread-&gt;set_interrupted(false);
 762     // consider thread-&gt;_SleepEvent-&gt;reset() ... optional optimization
 763   }
 764 
 765   return interrupted;
 766 }
 767 
 768 
 769 
 770 static const struct {
 771   int sig; const char* name;
 772 }
 773  g_signal_info[] =
 774   {
 775   {  SIGABRT,     &quot;SIGABRT&quot; },
 776 #ifdef SIGAIO
 777   {  SIGAIO,      &quot;SIGAIO&quot; },
 778 #endif
 779   {  SIGALRM,     &quot;SIGALRM&quot; },
 780 #ifdef SIGALRM1
 781   {  SIGALRM1,    &quot;SIGALRM1&quot; },
 782 #endif
 783   {  SIGBUS,      &quot;SIGBUS&quot; },
 784 #ifdef SIGCANCEL
 785   {  SIGCANCEL,   &quot;SIGCANCEL&quot; },
 786 #endif
 787   {  SIGCHLD,     &quot;SIGCHLD&quot; },
 788 #ifdef SIGCLD
 789   {  SIGCLD,      &quot;SIGCLD&quot; },
 790 #endif
 791   {  SIGCONT,     &quot;SIGCONT&quot; },
 792 #ifdef SIGCPUFAIL
 793   {  SIGCPUFAIL,  &quot;SIGCPUFAIL&quot; },
 794 #endif
 795 #ifdef SIGDANGER
 796   {  SIGDANGER,   &quot;SIGDANGER&quot; },
 797 #endif
 798 #ifdef SIGDIL
 799   {  SIGDIL,      &quot;SIGDIL&quot; },
 800 #endif
 801 #ifdef SIGEMT
 802   {  SIGEMT,      &quot;SIGEMT&quot; },
 803 #endif
 804   {  SIGFPE,      &quot;SIGFPE&quot; },
 805 #ifdef SIGFREEZE
 806   {  SIGFREEZE,   &quot;SIGFREEZE&quot; },
 807 #endif
 808 #ifdef SIGGFAULT
 809   {  SIGGFAULT,   &quot;SIGGFAULT&quot; },
 810 #endif
 811 #ifdef SIGGRANT
 812   {  SIGGRANT,    &quot;SIGGRANT&quot; },
 813 #endif
 814   {  SIGHUP,      &quot;SIGHUP&quot; },
 815   {  SIGILL,      &quot;SIGILL&quot; },
 816   {  SIGINT,      &quot;SIGINT&quot; },
 817 #ifdef SIGIO
 818   {  SIGIO,       &quot;SIGIO&quot; },
 819 #endif
 820 #ifdef SIGIOINT
 821   {  SIGIOINT,    &quot;SIGIOINT&quot; },
 822 #endif
 823 #ifdef SIGIOT
 824 // SIGIOT is there for BSD compatibility, but on most Unices just a
 825 // synonym for SIGABRT. The result should be &quot;SIGABRT&quot;, not
 826 // &quot;SIGIOT&quot;.
 827 #if (SIGIOT != SIGABRT )
 828   {  SIGIOT,      &quot;SIGIOT&quot; },
 829 #endif
 830 #endif
 831 #ifdef SIGKAP
 832   {  SIGKAP,      &quot;SIGKAP&quot; },
 833 #endif
 834   {  SIGKILL,     &quot;SIGKILL&quot; },
 835 #ifdef SIGLOST
 836   {  SIGLOST,     &quot;SIGLOST&quot; },
 837 #endif
 838 #ifdef SIGLWP
 839   {  SIGLWP,      &quot;SIGLWP&quot; },
 840 #endif
 841 #ifdef SIGLWPTIMER
 842   {  SIGLWPTIMER, &quot;SIGLWPTIMER&quot; },
 843 #endif
 844 #ifdef SIGMIGRATE
 845   {  SIGMIGRATE,  &quot;SIGMIGRATE&quot; },
 846 #endif
 847 #ifdef SIGMSG
 848   {  SIGMSG,      &quot;SIGMSG&quot; },
 849 #endif
 850   {  SIGPIPE,     &quot;SIGPIPE&quot; },
 851 #ifdef SIGPOLL
 852   {  SIGPOLL,     &quot;SIGPOLL&quot; },
 853 #endif
 854 #ifdef SIGPRE
 855   {  SIGPRE,      &quot;SIGPRE&quot; },
 856 #endif
 857   {  SIGPROF,     &quot;SIGPROF&quot; },
 858 #ifdef SIGPTY
 859   {  SIGPTY,      &quot;SIGPTY&quot; },
 860 #endif
 861 #ifdef SIGPWR
 862   {  SIGPWR,      &quot;SIGPWR&quot; },
 863 #endif
 864   {  SIGQUIT,     &quot;SIGQUIT&quot; },
 865 #ifdef SIGRECONFIG
 866   {  SIGRECONFIG, &quot;SIGRECONFIG&quot; },
 867 #endif
 868 #ifdef SIGRECOVERY
 869   {  SIGRECOVERY, &quot;SIGRECOVERY&quot; },
 870 #endif
 871 #ifdef SIGRESERVE
 872   {  SIGRESERVE,  &quot;SIGRESERVE&quot; },
 873 #endif
 874 #ifdef SIGRETRACT
 875   {  SIGRETRACT,  &quot;SIGRETRACT&quot; },
 876 #endif
 877 #ifdef SIGSAK
 878   {  SIGSAK,      &quot;SIGSAK&quot; },
 879 #endif
 880   {  SIGSEGV,     &quot;SIGSEGV&quot; },
 881 #ifdef SIGSOUND
 882   {  SIGSOUND,    &quot;SIGSOUND&quot; },
 883 #endif
 884 #ifdef SIGSTKFLT
 885   {  SIGSTKFLT,    &quot;SIGSTKFLT&quot; },
 886 #endif
 887   {  SIGSTOP,     &quot;SIGSTOP&quot; },
 888   {  SIGSYS,      &quot;SIGSYS&quot; },
 889 #ifdef SIGSYSERROR
 890   {  SIGSYSERROR, &quot;SIGSYSERROR&quot; },
 891 #endif
 892 #ifdef SIGTALRM
 893   {  SIGTALRM,    &quot;SIGTALRM&quot; },
 894 #endif
 895   {  SIGTERM,     &quot;SIGTERM&quot; },
 896 #ifdef SIGTHAW
 897   {  SIGTHAW,     &quot;SIGTHAW&quot; },
 898 #endif
 899   {  SIGTRAP,     &quot;SIGTRAP&quot; },
 900 #ifdef SIGTSTP
 901   {  SIGTSTP,     &quot;SIGTSTP&quot; },
 902 #endif
 903   {  SIGTTIN,     &quot;SIGTTIN&quot; },
 904   {  SIGTTOU,     &quot;SIGTTOU&quot; },
 905 #ifdef SIGURG
 906   {  SIGURG,      &quot;SIGURG&quot; },
 907 #endif
 908   {  SIGUSR1,     &quot;SIGUSR1&quot; },
 909   {  SIGUSR2,     &quot;SIGUSR2&quot; },
 910 #ifdef SIGVIRT
 911   {  SIGVIRT,     &quot;SIGVIRT&quot; },
 912 #endif
 913   {  SIGVTALRM,   &quot;SIGVTALRM&quot; },
 914 #ifdef SIGWAITING
 915   {  SIGWAITING,  &quot;SIGWAITING&quot; },
 916 #endif
 917 #ifdef SIGWINCH
 918   {  SIGWINCH,    &quot;SIGWINCH&quot; },
 919 #endif
 920 #ifdef SIGWINDOW
 921   {  SIGWINDOW,   &quot;SIGWINDOW&quot; },
 922 #endif
 923   {  SIGXCPU,     &quot;SIGXCPU&quot; },
 924   {  SIGXFSZ,     &quot;SIGXFSZ&quot; },
 925 #ifdef SIGXRES
 926   {  SIGXRES,     &quot;SIGXRES&quot; },
 927 #endif
 928   { -1, NULL }
 929 };
 930 
 931 // Returned string is a constant. For unknown signals &quot;UNKNOWN&quot; is returned.
 932 const char* os::Posix::get_signal_name(int sig, char* out, size_t outlen) {
 933 
 934   const char* ret = NULL;
 935 
 936 #ifdef SIGRTMIN
 937   if (sig &gt;= SIGRTMIN &amp;&amp; sig &lt;= SIGRTMAX) {
 938     if (sig == SIGRTMIN) {
 939       ret = &quot;SIGRTMIN&quot;;
 940     } else if (sig == SIGRTMAX) {
 941       ret = &quot;SIGRTMAX&quot;;
 942     } else {
 943       jio_snprintf(out, outlen, &quot;SIGRTMIN+%d&quot;, sig - SIGRTMIN);
 944       return out;
 945     }
 946   }
 947 #endif
 948 
 949   if (sig &gt; 0) {
 950     for (int idx = 0; g_signal_info[idx].sig != -1; idx ++) {
 951       if (g_signal_info[idx].sig == sig) {
 952         ret = g_signal_info[idx].name;
 953         break;
 954       }
 955     }
 956   }
 957 
 958   if (!ret) {
 959     if (!is_valid_signal(sig)) {
 960       ret = &quot;INVALID&quot;;
 961     } else {
 962       ret = &quot;UNKNOWN&quot;;
 963     }
 964   }
 965 
 966   if (out &amp;&amp; outlen &gt; 0) {
 967     strncpy(out, ret, outlen);
 968     out[outlen - 1] = &#39;\0&#39;;
 969   }
 970   return out;
 971 }
 972 
 973 int os::Posix::get_signal_number(const char* signal_name) {
 974   char tmp[30];
 975   const char* s = signal_name;
 976   if (s[0] != &#39;S&#39; || s[1] != &#39;I&#39; || s[2] != &#39;G&#39;) {
 977     jio_snprintf(tmp, sizeof(tmp), &quot;SIG%s&quot;, signal_name);
 978     s = tmp;
 979   }
 980   for (int idx = 0; g_signal_info[idx].sig != -1; idx ++) {
 981     if (strcmp(g_signal_info[idx].name, s) == 0) {
 982       return g_signal_info[idx].sig;
 983     }
 984   }
 985   return -1;
 986 }
 987 
 988 int os::get_signal_number(const char* signal_name) {
 989   return os::Posix::get_signal_number(signal_name);
 990 }
 991 
 992 // Returns true if signal number is valid.
 993 bool os::Posix::is_valid_signal(int sig) {
 994   // MacOS not really POSIX compliant: sigaddset does not return
 995   // an error for invalid signal numbers. However, MacOS does not
 996   // support real time signals and simply seems to have just 33
 997   // signals with no holes in the signal range.
 998 #ifdef __APPLE__
 999   return sig &gt;= 1 &amp;&amp; sig &lt; NSIG;
1000 #else
1001   // Use sigaddset to check for signal validity.
1002   sigset_t set;
1003   sigemptyset(&amp;set);
1004   if (sigaddset(&amp;set, sig) == -1 &amp;&amp; errno == EINVAL) {
1005     return false;
1006   }
1007   return true;
1008 #endif
1009 }
1010 
1011 bool os::Posix::is_sig_ignored(int sig) {
1012   struct sigaction oact;
1013   sigaction(sig, (struct sigaction*)NULL, &amp;oact);
1014   void* ohlr = oact.sa_sigaction ? CAST_FROM_FN_PTR(void*,  oact.sa_sigaction)
1015                                  : CAST_FROM_FN_PTR(void*,  oact.sa_handler);
1016   if (ohlr == CAST_FROM_FN_PTR(void*, SIG_IGN)) {
1017     return true;
1018   } else {
1019     return false;
1020   }
1021 }
1022 
1023 // Returns:
1024 // NULL for an invalid signal number
1025 // &quot;SIG&lt;num&gt;&quot; for a valid but unknown signal number
1026 // signal name otherwise.
1027 const char* os::exception_name(int sig, char* buf, size_t size) {
1028   if (!os::Posix::is_valid_signal(sig)) {
1029     return NULL;
1030   }
1031   const char* const name = os::Posix::get_signal_name(sig, buf, size);
1032   if (strcmp(name, &quot;UNKNOWN&quot;) == 0) {
1033     jio_snprintf(buf, size, &quot;SIG%d&quot;, sig);
1034   }
1035   return buf;
1036 }
1037 
1038 #define NUM_IMPORTANT_SIGS 32
1039 // Returns one-line short description of a signal set in a user provided buffer.
1040 const char* os::Posix::describe_signal_set_short(const sigset_t* set, char* buffer, size_t buf_size) {
1041   assert(buf_size == (NUM_IMPORTANT_SIGS + 1), &quot;wrong buffer size&quot;);
1042   // Note: for shortness, just print out the first 32. That should
1043   // cover most of the useful ones, apart from realtime signals.
1044   for (int sig = 1; sig &lt;= NUM_IMPORTANT_SIGS; sig++) {
1045     const int rc = sigismember(set, sig);
1046     if (rc == -1 &amp;&amp; errno == EINVAL) {
1047       buffer[sig-1] = &#39;?&#39;;
1048     } else {
1049       buffer[sig-1] = rc == 0 ? &#39;0&#39; : &#39;1&#39;;
1050     }
1051   }
1052   buffer[NUM_IMPORTANT_SIGS] = 0;
1053   return buffer;
1054 }
1055 
1056 // Prints one-line description of a signal set.
1057 void os::Posix::print_signal_set_short(outputStream* st, const sigset_t* set) {
1058   char buf[NUM_IMPORTANT_SIGS + 1];
1059   os::Posix::describe_signal_set_short(set, buf, sizeof(buf));
1060   st-&gt;print(&quot;%s&quot;, buf);
1061 }
1062 
1063 // Writes one-line description of a combination of sigaction.sa_flags into a user
1064 // provided buffer. Returns that buffer.
1065 const char* os::Posix::describe_sa_flags(int flags, char* buffer, size_t size) {
1066   char* p = buffer;
1067   size_t remaining = size;
1068   bool first = true;
1069   int idx = 0;
1070 
1071   assert(buffer, &quot;invalid argument&quot;);
1072 
1073   if (size == 0) {
1074     return buffer;
1075   }
1076 
1077   strncpy(buffer, &quot;none&quot;, size);
1078 
1079   const struct {
1080     // NB: i is an unsigned int here because SA_RESETHAND is on some
1081     // systems 0x80000000, which is implicitly unsigned.  Assignining
1082     // it to an int field would be an overflow in unsigned-to-signed
1083     // conversion.
1084     unsigned int i;
1085     const char* s;
1086   } flaginfo [] = {
1087     { SA_NOCLDSTOP, &quot;SA_NOCLDSTOP&quot; },
1088     { SA_ONSTACK,   &quot;SA_ONSTACK&quot;   },
1089     { SA_RESETHAND, &quot;SA_RESETHAND&quot; },
1090     { SA_RESTART,   &quot;SA_RESTART&quot;   },
1091     { SA_SIGINFO,   &quot;SA_SIGINFO&quot;   },
1092     { SA_NOCLDWAIT, &quot;SA_NOCLDWAIT&quot; },
1093     { SA_NODEFER,   &quot;SA_NODEFER&quot;   },
1094 #ifdef AIX
1095     { SA_ONSTACK,   &quot;SA_ONSTACK&quot;   },
1096     { SA_OLDSTYLE,  &quot;SA_OLDSTYLE&quot;  },
1097 #endif
1098     { 0, NULL }
1099   };
1100 
1101   for (idx = 0; flaginfo[idx].s &amp;&amp; remaining &gt; 1; idx++) {
1102     if (flags &amp; flaginfo[idx].i) {
1103       if (first) {
1104         jio_snprintf(p, remaining, &quot;%s&quot;, flaginfo[idx].s);
1105         first = false;
1106       } else {
1107         jio_snprintf(p, remaining, &quot;|%s&quot;, flaginfo[idx].s);
1108       }
1109       const size_t len = strlen(p);
1110       p += len;
1111       remaining -= len;
1112     }
1113   }
1114 
1115   buffer[size - 1] = &#39;\0&#39;;
1116 
1117   return buffer;
1118 }
1119 
1120 // Prints one-line description of a combination of sigaction.sa_flags.
1121 void os::Posix::print_sa_flags(outputStream* st, int flags) {
1122   char buffer[0x100];
1123   os::Posix::describe_sa_flags(flags, buffer, sizeof(buffer));
1124   st-&gt;print(&quot;%s&quot;, buffer);
1125 }
1126 
1127 // Helper function for os::Posix::print_siginfo_...():
1128 // return a textual description for signal code.
1129 struct enum_sigcode_desc_t {
1130   const char* s_name;
1131   const char* s_desc;
1132 };
1133 
1134 static bool get_signal_code_description(const siginfo_t* si, enum_sigcode_desc_t* out) {
1135 
1136   const struct {
1137     int sig; int code; const char* s_code; const char* s_desc;
1138   } t1 [] = {
1139     { SIGILL,  ILL_ILLOPC,   &quot;ILL_ILLOPC&quot;,   &quot;Illegal opcode.&quot; },
1140     { SIGILL,  ILL_ILLOPN,   &quot;ILL_ILLOPN&quot;,   &quot;Illegal operand.&quot; },
1141     { SIGILL,  ILL_ILLADR,   &quot;ILL_ILLADR&quot;,   &quot;Illegal addressing mode.&quot; },
1142     { SIGILL,  ILL_ILLTRP,   &quot;ILL_ILLTRP&quot;,   &quot;Illegal trap.&quot; },
1143     { SIGILL,  ILL_PRVOPC,   &quot;ILL_PRVOPC&quot;,   &quot;Privileged opcode.&quot; },
1144     { SIGILL,  ILL_PRVREG,   &quot;ILL_PRVREG&quot;,   &quot;Privileged register.&quot; },
1145     { SIGILL,  ILL_COPROC,   &quot;ILL_COPROC&quot;,   &quot;Coprocessor error.&quot; },
1146     { SIGILL,  ILL_BADSTK,   &quot;ILL_BADSTK&quot;,   &quot;Internal stack error.&quot; },
1147 #if defined(IA64) &amp;&amp; defined(LINUX)
1148     { SIGILL,  ILL_BADIADDR, &quot;ILL_BADIADDR&quot;, &quot;Unimplemented instruction address&quot; },
1149     { SIGILL,  ILL_BREAK,    &quot;ILL_BREAK&quot;,    &quot;Application Break instruction&quot; },
1150 #endif
1151     { SIGFPE,  FPE_INTDIV,   &quot;FPE_INTDIV&quot;,   &quot;Integer divide by zero.&quot; },
1152     { SIGFPE,  FPE_INTOVF,   &quot;FPE_INTOVF&quot;,   &quot;Integer overflow.&quot; },
1153     { SIGFPE,  FPE_FLTDIV,   &quot;FPE_FLTDIV&quot;,   &quot;Floating-point divide by zero.&quot; },
1154     { SIGFPE,  FPE_FLTOVF,   &quot;FPE_FLTOVF&quot;,   &quot;Floating-point overflow.&quot; },
1155     { SIGFPE,  FPE_FLTUND,   &quot;FPE_FLTUND&quot;,   &quot;Floating-point underflow.&quot; },
1156     { SIGFPE,  FPE_FLTRES,   &quot;FPE_FLTRES&quot;,   &quot;Floating-point inexact result.&quot; },
1157     { SIGFPE,  FPE_FLTINV,   &quot;FPE_FLTINV&quot;,   &quot;Invalid floating-point operation.&quot; },
1158     { SIGFPE,  FPE_FLTSUB,   &quot;FPE_FLTSUB&quot;,   &quot;Subscript out of range.&quot; },
1159     { SIGSEGV, SEGV_MAPERR,  &quot;SEGV_MAPERR&quot;,  &quot;Address not mapped to object.&quot; },
1160     { SIGSEGV, SEGV_ACCERR,  &quot;SEGV_ACCERR&quot;,  &quot;Invalid permissions for mapped object.&quot; },
1161 #ifdef AIX
1162     // no explanation found what keyerr would be
1163     { SIGSEGV, SEGV_KEYERR,  &quot;SEGV_KEYERR&quot;,  &quot;key error&quot; },
1164 #endif
1165 #if defined(IA64) &amp;&amp; !defined(AIX)
1166     { SIGSEGV, SEGV_PSTKOVF, &quot;SEGV_PSTKOVF&quot;, &quot;Paragraph stack overflow&quot; },
1167 #endif
1168 #if defined(__sparc) &amp;&amp; defined(SOLARIS)
1169 // define Solaris Sparc M7 ADI SEGV signals
1170 #if !defined(SEGV_ACCADI)
1171 #define SEGV_ACCADI 3
1172 #endif
1173     { SIGSEGV, SEGV_ACCADI,  &quot;SEGV_ACCADI&quot;,  &quot;ADI not enabled for mapped object.&quot; },
1174 #if !defined(SEGV_ACCDERR)
1175 #define SEGV_ACCDERR 4
1176 #endif
1177     { SIGSEGV, SEGV_ACCDERR, &quot;SEGV_ACCDERR&quot;, &quot;ADI disrupting exception.&quot; },
1178 #if !defined(SEGV_ACCPERR)
1179 #define SEGV_ACCPERR 5
1180 #endif
1181     { SIGSEGV, SEGV_ACCPERR, &quot;SEGV_ACCPERR&quot;, &quot;ADI precise exception.&quot; },
1182 #endif // defined(__sparc) &amp;&amp; defined(SOLARIS)
1183     { SIGBUS,  BUS_ADRALN,   &quot;BUS_ADRALN&quot;,   &quot;Invalid address alignment.&quot; },
1184     { SIGBUS,  BUS_ADRERR,   &quot;BUS_ADRERR&quot;,   &quot;Nonexistent physical address.&quot; },
1185     { SIGBUS,  BUS_OBJERR,   &quot;BUS_OBJERR&quot;,   &quot;Object-specific hardware error.&quot; },
1186     { SIGTRAP, TRAP_BRKPT,   &quot;TRAP_BRKPT&quot;,   &quot;Process breakpoint.&quot; },
1187     { SIGTRAP, TRAP_TRACE,   &quot;TRAP_TRACE&quot;,   &quot;Process trace trap.&quot; },
1188     { SIGCHLD, CLD_EXITED,   &quot;CLD_EXITED&quot;,   &quot;Child has exited.&quot; },
1189     { SIGCHLD, CLD_KILLED,   &quot;CLD_KILLED&quot;,   &quot;Child has terminated abnormally and did not create a core file.&quot; },
1190     { SIGCHLD, CLD_DUMPED,   &quot;CLD_DUMPED&quot;,   &quot;Child has terminated abnormally and created a core file.&quot; },
1191     { SIGCHLD, CLD_TRAPPED,  &quot;CLD_TRAPPED&quot;,  &quot;Traced child has trapped.&quot; },
1192     { SIGCHLD, CLD_STOPPED,  &quot;CLD_STOPPED&quot;,  &quot;Child has stopped.&quot; },
1193     { SIGCHLD, CLD_CONTINUED,&quot;CLD_CONTINUED&quot;,&quot;Stopped child has continued.&quot; },
1194 #ifdef SIGPOLL
1195     { SIGPOLL, POLL_OUT,     &quot;POLL_OUT&quot;,     &quot;Output buffers available.&quot; },
1196     { SIGPOLL, POLL_MSG,     &quot;POLL_MSG&quot;,     &quot;Input message available.&quot; },
1197     { SIGPOLL, POLL_ERR,     &quot;POLL_ERR&quot;,     &quot;I/O error.&quot; },
1198     { SIGPOLL, POLL_PRI,     &quot;POLL_PRI&quot;,     &quot;High priority input available.&quot; },
1199     { SIGPOLL, POLL_HUP,     &quot;POLL_HUP&quot;,     &quot;Device disconnected. [Option End]&quot; },
1200 #endif
1201     { -1, -1, NULL, NULL }
1202   };
1203 
1204   // Codes valid in any signal context.
1205   const struct {
1206     int code; const char* s_code; const char* s_desc;
1207   } t2 [] = {
1208     { SI_USER,      &quot;SI_USER&quot;,     &quot;Signal sent by kill().&quot; },
1209     { SI_QUEUE,     &quot;SI_QUEUE&quot;,    &quot;Signal sent by the sigqueue().&quot; },
1210     { SI_TIMER,     &quot;SI_TIMER&quot;,    &quot;Signal generated by expiration of a timer set by timer_settime().&quot; },
1211     { SI_ASYNCIO,   &quot;SI_ASYNCIO&quot;,  &quot;Signal generated by completion of an asynchronous I/O request.&quot; },
1212     { SI_MESGQ,     &quot;SI_MESGQ&quot;,    &quot;Signal generated by arrival of a message on an empty message queue.&quot; },
1213     // Linux specific
1214 #ifdef SI_TKILL
1215     { SI_TKILL,     &quot;SI_TKILL&quot;,    &quot;Signal sent by tkill (pthread_kill)&quot; },
1216 #endif
1217 #ifdef SI_DETHREAD
1218     { SI_DETHREAD,  &quot;SI_DETHREAD&quot;, &quot;Signal sent by execve() killing subsidiary threads&quot; },
1219 #endif
1220 #ifdef SI_KERNEL
1221     { SI_KERNEL,    &quot;SI_KERNEL&quot;,   &quot;Signal sent by kernel.&quot; },
1222 #endif
1223 #ifdef SI_SIGIO
1224     { SI_SIGIO,     &quot;SI_SIGIO&quot;,    &quot;Signal sent by queued SIGIO&quot; },
1225 #endif
1226 
1227 #ifdef AIX
1228     { SI_UNDEFINED, &quot;SI_UNDEFINED&quot;,&quot;siginfo contains partial information&quot; },
1229     { SI_EMPTY,     &quot;SI_EMPTY&quot;,    &quot;siginfo contains no useful information&quot; },
1230 #endif
1231 
1232 #ifdef __sun
1233     { SI_NOINFO,    &quot;SI_NOINFO&quot;,   &quot;No signal information&quot; },
1234     { SI_RCTL,      &quot;SI_RCTL&quot;,     &quot;kernel generated signal via rctl action&quot; },
1235     { SI_LWP,       &quot;SI_LWP&quot;,      &quot;Signal sent via lwp_kill&quot; },
1236 #endif
1237 
1238     { -1, NULL, NULL }
1239   };
1240 
1241   const char* s_code = NULL;
1242   const char* s_desc = NULL;
1243 
1244   for (int i = 0; t1[i].sig != -1; i ++) {
1245     if (t1[i].sig == si-&gt;si_signo &amp;&amp; t1[i].code == si-&gt;si_code) {
1246       s_code = t1[i].s_code;
1247       s_desc = t1[i].s_desc;
1248       break;
1249     }
1250   }
1251 
1252   if (s_code == NULL) {
1253     for (int i = 0; t2[i].s_code != NULL; i ++) {
1254       if (t2[i].code == si-&gt;si_code) {
1255         s_code = t2[i].s_code;
1256         s_desc = t2[i].s_desc;
1257       }
1258     }
1259   }
1260 
1261   if (s_code == NULL) {
1262     out-&gt;s_name = &quot;unknown&quot;;
1263     out-&gt;s_desc = &quot;unknown&quot;;
1264     return false;
1265   }
1266 
1267   out-&gt;s_name = s_code;
1268   out-&gt;s_desc = s_desc;
1269 
1270   return true;
1271 }
1272 
1273 bool os::signal_sent_by_kill(const void* siginfo) {
1274   const siginfo_t* const si = (const siginfo_t*)siginfo;
1275   return si-&gt;si_code == SI_USER || si-&gt;si_code == SI_QUEUE
1276 #ifdef SI_TKILL
1277          || si-&gt;si_code == SI_TKILL
1278 #endif
1279   ;
1280 }
1281 
1282 void os::print_siginfo(outputStream* os, const void* si0) {
1283 
1284   const siginfo_t* const si = (const siginfo_t*) si0;
1285 
1286   char buf[20];
1287   os-&gt;print(&quot;siginfo:&quot;);
1288 
1289   if (!si) {
1290     os-&gt;print(&quot; &lt;null&gt;&quot;);
1291     return;
1292   }
1293 
1294   const int sig = si-&gt;si_signo;
1295 
1296   os-&gt;print(&quot; si_signo: %d (%s)&quot;, sig, os::Posix::get_signal_name(sig, buf, sizeof(buf)));
1297 
1298   enum_sigcode_desc_t ed;
1299   get_signal_code_description(si, &amp;ed);
1300   os-&gt;print(&quot;, si_code: %d (%s)&quot;, si-&gt;si_code, ed.s_name);
1301 
1302   if (si-&gt;si_errno) {
1303     os-&gt;print(&quot;, si_errno: %d&quot;, si-&gt;si_errno);
1304   }
1305 
1306   // Output additional information depending on the signal code.
1307 
1308   // Note: Many implementations lump si_addr, si_pid, si_uid etc. together as unions,
1309   // so it depends on the context which member to use. For synchronous error signals,
1310   // we print si_addr, unless the signal was sent by another process or thread, in
1311   // which case we print out pid or tid of the sender.
1312   if (signal_sent_by_kill(si)) {
1313     const pid_t pid = si-&gt;si_pid;
1314     os-&gt;print(&quot;, si_pid: %ld&quot;, (long) pid);
1315     if (IS_VALID_PID(pid)) {
1316       const pid_t me = getpid();
1317       if (me == pid) {
1318         os-&gt;print(&quot; (current process)&quot;);
1319       }
1320     } else {
1321       os-&gt;print(&quot; (invalid)&quot;);
1322     }
1323     os-&gt;print(&quot;, si_uid: %ld&quot;, (long) si-&gt;si_uid);
1324     if (sig == SIGCHLD) {
1325       os-&gt;print(&quot;, si_status: %d&quot;, si-&gt;si_status);
1326     }
1327   } else if (sig == SIGSEGV || sig == SIGBUS || sig == SIGILL ||
1328              sig == SIGTRAP || sig == SIGFPE) {
1329     os-&gt;print(&quot;, si_addr: &quot; PTR_FORMAT, p2i(si-&gt;si_addr));
1330 #ifdef SIGPOLL
1331   } else if (sig == SIGPOLL) {
1332     os-&gt;print(&quot;, si_band: %ld&quot;, si-&gt;si_band);
1333 #endif
1334   }
1335 
1336 }
1337 
1338 bool os::signal_thread(Thread* thread, int sig, const char* reason) {
1339   OSThread* osthread = thread-&gt;osthread();
1340   if (osthread) {
1341 #if defined (SOLARIS)
1342     // Note: we cannot use pthread_kill on Solaris - not because
1343     // its missing, but because we do not have the pthread_t id.
1344     int status = thr_kill(osthread-&gt;thread_id(), sig);
1345 #else
1346     int status = pthread_kill(osthread-&gt;pthread_id(), sig);
1347 #endif
1348     if (status == 0) {
1349       Events::log(Thread::current(), &quot;sent signal %d to Thread &quot; INTPTR_FORMAT &quot; because %s.&quot;,
1350                   sig, p2i(thread), reason);
1351       return true;
1352     }
1353   }
1354   return false;
1355 }
1356 
1357 int os::Posix::unblock_thread_signal_mask(const sigset_t *set) {
1358   return pthread_sigmask(SIG_UNBLOCK, set, NULL);
1359 }
1360 
1361 address os::Posix::ucontext_get_pc(const ucontext_t* ctx) {
1362 #if defined(AIX)
1363    return Aix::ucontext_get_pc(ctx);
1364 #elif defined(BSD)
1365    return Bsd::ucontext_get_pc(ctx);
1366 #elif defined(LINUX)
1367    return Linux::ucontext_get_pc(ctx);
1368 #elif defined(SOLARIS)
1369    return Solaris::ucontext_get_pc(ctx);
1370 #else
1371    VMError::report_and_die(&quot;unimplemented ucontext_get_pc&quot;);
1372 #endif
1373 }
1374 
1375 void os::Posix::ucontext_set_pc(ucontext_t* ctx, address pc) {
1376 #if defined(AIX)
1377    Aix::ucontext_set_pc(ctx, pc);
1378 #elif defined(BSD)
1379    Bsd::ucontext_set_pc(ctx, pc);
1380 #elif defined(LINUX)
1381    Linux::ucontext_set_pc(ctx, pc);
1382 #elif defined(SOLARIS)
1383    Solaris::ucontext_set_pc(ctx, pc);
1384 #else
1385    VMError::report_and_die(&quot;unimplemented ucontext_get_pc&quot;);
1386 #endif
1387 }
1388 
1389 char* os::Posix::describe_pthread_attr(char* buf, size_t buflen, const pthread_attr_t* attr) {
1390   size_t stack_size = 0;
1391   size_t guard_size = 0;
1392   int detachstate = 0;
1393   pthread_attr_getstacksize(attr, &amp;stack_size);
1394   pthread_attr_getguardsize(attr, &amp;guard_size);
1395   // Work around linux NPTL implementation error, see also os::create_thread() in os_linux.cpp.
1396   LINUX_ONLY(stack_size -= guard_size);
1397   pthread_attr_getdetachstate(attr, &amp;detachstate);
1398   jio_snprintf(buf, buflen, &quot;stacksize: &quot; SIZE_FORMAT &quot;k, guardsize: &quot; SIZE_FORMAT &quot;k, %s&quot;,
1399     stack_size / 1024, guard_size / 1024,
1400     (detachstate == PTHREAD_CREATE_DETACHED ? &quot;detached&quot; : &quot;joinable&quot;));
1401   return buf;
1402 }
1403 
1404 char* os::Posix::realpath(const char* filename, char* outbuf, size_t outbuflen) {
1405 
1406   if (filename == NULL || outbuf == NULL || outbuflen &lt; 1) {
1407     assert(false, &quot;os::Posix::realpath: invalid arguments.&quot;);
1408     errno = EINVAL;
1409     return NULL;
1410   }
1411 
1412   char* result = NULL;
1413 
1414   // This assumes platform realpath() is implemented according to POSIX.1-2008.
1415   // POSIX.1-2008 allows to specify NULL for the output buffer, in which case
1416   // output buffer is dynamically allocated and must be ::free()&#39;d by the caller.
1417   char* p = ::realpath(filename, NULL);
1418   if (p != NULL) {
1419     if (strlen(p) &lt; outbuflen) {
1420       strcpy(outbuf, p);
1421       result = outbuf;
1422     } else {
1423       errno = ENAMETOOLONG;
1424     }
1425     ::free(p); // *not* os::free
1426   } else {
1427     // Fallback for platforms struggling with modern Posix standards (AIX 5.3, 6.1). If realpath
1428     // returns EINVAL, this may indicate that realpath is not POSIX.1-2008 compatible and
1429     // that it complains about the NULL we handed down as user buffer.
1430     // In this case, use the user provided buffer but at least check whether realpath caused
1431     // a memory overwrite.
1432     if (errno == EINVAL) {
1433       outbuf[outbuflen - 1] = &#39;\0&#39;;
1434       p = ::realpath(filename, outbuf);
1435       if (p != NULL) {
1436         guarantee(outbuf[outbuflen - 1] == &#39;\0&#39;, &quot;realpath buffer overwrite detected.&quot;);
1437         result = p;
1438       }
1439     }
1440   }
1441   return result;
1442 
1443 }
1444 
1445 int os::stat(const char *path, struct stat *sbuf) {
1446   return ::stat(path, sbuf);
1447 }
1448 
1449 char * os::native_path(char *path) {
1450   return path;
1451 }
1452 
1453 // Check minimum allowable stack sizes for thread creation and to initialize
1454 // the java system classes, including StackOverflowError - depends on page
1455 // size.
1456 // The space needed for frames during startup is platform dependent. It
1457 // depends on word size, platform calling conventions, C frame layout and
1458 // interpreter/C1/C2 design decisions. Therefore this is given in a
1459 // platform (os/cpu) dependent constant.
1460 // To this, space for guard mechanisms is added, which depends on the
1461 // page size which again depends on the concrete system the VM is running
1462 // on. Space for libc guard pages is not included in this size.
1463 jint os::Posix::set_minimum_stack_sizes() {
1464   size_t os_min_stack_allowed = SOLARIS_ONLY(thr_min_stack()) NOT_SOLARIS(PTHREAD_STACK_MIN);
1465 
1466   _java_thread_min_stack_allowed = _java_thread_min_stack_allowed +
1467                                    JavaThread::stack_guard_zone_size() +
1468                                    JavaThread::stack_shadow_zone_size();
1469 
1470   _java_thread_min_stack_allowed = align_up(_java_thread_min_stack_allowed, vm_page_size());
1471   _java_thread_min_stack_allowed = MAX2(_java_thread_min_stack_allowed, os_min_stack_allowed);
1472 
1473   size_t stack_size_in_bytes = ThreadStackSize * K;
1474   if (stack_size_in_bytes != 0 &amp;&amp;
1475       stack_size_in_bytes &lt; _java_thread_min_stack_allowed) {
1476     // The &#39;-Xss&#39; and &#39;-XX:ThreadStackSize=N&#39; options both set
1477     // ThreadStackSize so we go with &quot;Java thread stack size&quot; instead
1478     // of &quot;ThreadStackSize&quot; to be more friendly.
1479     tty-&gt;print_cr(&quot;\nThe Java thread stack size specified is too small. &quot;
1480                   &quot;Specify at least &quot; SIZE_FORMAT &quot;k&quot;,
1481                   _java_thread_min_stack_allowed / K);
1482     return JNI_ERR;
1483   }
1484 
1485   // Make the stack size a multiple of the page size so that
1486   // the yellow/red zones can be guarded.
1487   JavaThread::set_stack_size_at_create(align_up(stack_size_in_bytes, vm_page_size()));
1488 
1489   // Reminder: a compiler thread is a Java thread.
1490   _compiler_thread_min_stack_allowed = _compiler_thread_min_stack_allowed +
1491                                        JavaThread::stack_guard_zone_size() +
1492                                        JavaThread::stack_shadow_zone_size();
1493 
1494   _compiler_thread_min_stack_allowed = align_up(_compiler_thread_min_stack_allowed, vm_page_size());
1495   _compiler_thread_min_stack_allowed = MAX2(_compiler_thread_min_stack_allowed, os_min_stack_allowed);
1496 
1497   stack_size_in_bytes = CompilerThreadStackSize * K;
1498   if (stack_size_in_bytes != 0 &amp;&amp;
1499       stack_size_in_bytes &lt; _compiler_thread_min_stack_allowed) {
1500     tty-&gt;print_cr(&quot;\nThe CompilerThreadStackSize specified is too small. &quot;
1501                   &quot;Specify at least &quot; SIZE_FORMAT &quot;k&quot;,
1502                   _compiler_thread_min_stack_allowed / K);
1503     return JNI_ERR;
1504   }
1505 
1506   _vm_internal_thread_min_stack_allowed = align_up(_vm_internal_thread_min_stack_allowed, vm_page_size());
1507   _vm_internal_thread_min_stack_allowed = MAX2(_vm_internal_thread_min_stack_allowed, os_min_stack_allowed);
1508 
1509   stack_size_in_bytes = VMThreadStackSize * K;
1510   if (stack_size_in_bytes != 0 &amp;&amp;
1511       stack_size_in_bytes &lt; _vm_internal_thread_min_stack_allowed) {
1512     tty-&gt;print_cr(&quot;\nThe VMThreadStackSize specified is too small. &quot;
1513                   &quot;Specify at least &quot; SIZE_FORMAT &quot;k&quot;,
1514                   _vm_internal_thread_min_stack_allowed / K);
1515     return JNI_ERR;
1516   }
1517   return JNI_OK;
1518 }
1519 
1520 // Called when creating the thread.  The minimum stack sizes have already been calculated
1521 size_t os::Posix::get_initial_stack_size(ThreadType thr_type, size_t req_stack_size) {
1522   size_t stack_size;
1523   if (req_stack_size == 0) {
1524     stack_size = default_stack_size(thr_type);
1525   } else {
1526     stack_size = req_stack_size;
1527   }
1528 
1529   switch (thr_type) {
1530   case os::java_thread:
1531     // Java threads use ThreadStackSize which default value can be
1532     // changed with the flag -Xss
1533     if (req_stack_size == 0 &amp;&amp; JavaThread::stack_size_at_create() &gt; 0) {
1534       // no requested size and we have a more specific default value
1535       stack_size = JavaThread::stack_size_at_create();
1536     }
1537     stack_size = MAX2(stack_size,
1538                       _java_thread_min_stack_allowed);
1539     break;
1540   case os::compiler_thread:
1541     if (req_stack_size == 0 &amp;&amp; CompilerThreadStackSize &gt; 0) {
1542       // no requested size and we have a more specific default value
1543       stack_size = (size_t)(CompilerThreadStackSize * K);
1544     }
1545     stack_size = MAX2(stack_size,
1546                       _compiler_thread_min_stack_allowed);
1547     break;
1548   case os::vm_thread:
1549   case os::pgc_thread:
1550   case os::cgc_thread:
1551   case os::watcher_thread:
1552   default:  // presume the unknown thr_type is a VM internal
1553     if (req_stack_size == 0 &amp;&amp; VMThreadStackSize &gt; 0) {
1554       // no requested size and we have a more specific default value
1555       stack_size = (size_t)(VMThreadStackSize * K);
1556     }
1557 
1558     stack_size = MAX2(stack_size,
1559                       _vm_internal_thread_min_stack_allowed);
1560     break;
1561   }
1562 
1563   // pthread_attr_setstacksize() may require that the size be rounded up to the OS page size.
1564   // Be careful not to round up to 0. Align down in that case.
1565   if (stack_size &lt;= SIZE_MAX - vm_page_size()) {
1566     stack_size = align_up(stack_size, vm_page_size());
1567   } else {
1568     stack_size = align_down(stack_size, vm_page_size());
1569   }
1570 
1571   return stack_size;
1572 }
1573 
1574 bool os::Posix::is_root(uid_t uid){
1575     return ROOT_UID == uid;
1576 }
1577 
1578 bool os::Posix::matches_effective_uid_or_root(uid_t uid) {
1579     return is_root(uid) || geteuid() == uid;
1580 }
1581 
1582 bool os::Posix::matches_effective_uid_and_gid_or_root(uid_t uid, gid_t gid) {
1583     return is_root(uid) || (geteuid() == uid &amp;&amp; getegid() == gid);
1584 }
1585 
1586 Thread* os::ThreadCrashProtection::_protected_thread = NULL;
1587 os::ThreadCrashProtection* os::ThreadCrashProtection::_crash_protection = NULL;
1588 volatile intptr_t os::ThreadCrashProtection::_crash_mux = 0;
1589 
1590 os::ThreadCrashProtection::ThreadCrashProtection() {
1591 }
1592 
1593 /*
1594  * See the caveats for this class in os_posix.hpp
1595  * Protects the callback call so that SIGSEGV / SIGBUS jumps back into this
1596  * method and returns false. If none of the signals are raised, returns true.
1597  * The callback is supposed to provide the method that should be protected.
1598  */
1599 bool os::ThreadCrashProtection::call(os::CrashProtectionCallback&amp; cb) {
1600   sigset_t saved_sig_mask;
1601 
1602   Thread::muxAcquire(&amp;_crash_mux, &quot;CrashProtection&quot;);
1603 
1604   _protected_thread = Thread::current_or_null();
1605   assert(_protected_thread != NULL, &quot;Cannot crash protect a NULL thread&quot;);
1606 
1607   // we cannot rely on sigsetjmp/siglongjmp to save/restore the signal mask
1608   // since on at least some systems (OS X) siglongjmp will restore the mask
1609   // for the process, not the thread
1610   pthread_sigmask(0, NULL, &amp;saved_sig_mask);
1611   if (sigsetjmp(_jmpbuf, 0) == 0) {
1612     // make sure we can see in the signal handler that we have crash protection
1613     // installed
1614     _crash_protection = this;
1615     cb.call();
1616     // and clear the crash protection
1617     _crash_protection = NULL;
1618     _protected_thread = NULL;
1619     Thread::muxRelease(&amp;_crash_mux);
1620     return true;
1621   }
1622   // this happens when we siglongjmp() back
1623   pthread_sigmask(SIG_SETMASK, &amp;saved_sig_mask, NULL);
1624   _crash_protection = NULL;
1625   _protected_thread = NULL;
1626   Thread::muxRelease(&amp;_crash_mux);
1627   return false;
1628 }
1629 
1630 void os::ThreadCrashProtection::restore() {
1631   assert(_crash_protection != NULL, &quot;must have crash protection&quot;);
1632   siglongjmp(_jmpbuf, 1);
1633 }
1634 
1635 void os::ThreadCrashProtection::check_crash_protection(int sig,
1636     Thread* thread) {
1637 
1638   if (thread != NULL &amp;&amp;
1639       thread == _protected_thread &amp;&amp;
1640       _crash_protection != NULL) {
1641 
1642     if (sig == SIGSEGV || sig == SIGBUS) {
1643       _crash_protection-&gt;restore();
1644     }
1645   }
1646 }
1647 
1648 // Shared clock/time and other supporting routines for pthread_mutex/cond
1649 // initialization. This is enabled on Solaris but only some of the clock/time
1650 // functionality is actually used there.
1651 
1652 // Shared condattr object for use with relative timed-waits. Will be associated
1653 // with CLOCK_MONOTONIC if available to avoid issues with time-of-day changes,
1654 // but otherwise whatever default is used by the platform - generally the
1655 // time-of-day clock.
1656 static pthread_condattr_t _condAttr[1];
1657 
1658 // Shared mutexattr to explicitly set the type to PTHREAD_MUTEX_NORMAL as not
1659 // all systems (e.g. FreeBSD) map the default to &quot;normal&quot;.
1660 static pthread_mutexattr_t _mutexAttr[1];
1661 
1662 // common basic initialization that is always supported
1663 static void pthread_init_common(void) {
1664   int status;
1665   if ((status = pthread_condattr_init(_condAttr)) != 0) {
1666     fatal(&quot;pthread_condattr_init: %s&quot;, os::strerror(status));
1667   }
1668   if ((status = pthread_mutexattr_init(_mutexAttr)) != 0) {
1669     fatal(&quot;pthread_mutexattr_init: %s&quot;, os::strerror(status));
1670   }
1671   if ((status = pthread_mutexattr_settype(_mutexAttr, PTHREAD_MUTEX_NORMAL)) != 0) {
1672     fatal(&quot;pthread_mutexattr_settype: %s&quot;, os::strerror(status));
1673   }
1674 }
1675 
1676 #ifndef SOLARIS
1677 sigset_t sigs;
1678 struct sigaction sigact[NSIG];
1679 
1680 struct sigaction* os::Posix::get_preinstalled_handler(int sig) {
1681   if (sigismember(&amp;sigs, sig)) {
1682     return &amp;sigact[sig];
1683   }
1684   return NULL;
1685 }
1686 
1687 void os::Posix::save_preinstalled_handler(int sig, struct sigaction&amp; oldAct) {
1688   assert(sig &gt; 0 &amp;&amp; sig &lt; NSIG, &quot;vm signal out of expected range&quot;);
1689   sigact[sig] = oldAct;
1690   sigaddset(&amp;sigs, sig);
1691 }
1692 #endif
1693 
1694 // Not all POSIX types and API&#39;s are available on all notionally &quot;posix&quot;
1695 // platforms. If we have build-time support then we will check for actual
1696 // runtime support via dlopen/dlsym lookup. This allows for running on an
1697 // older OS version compared to the build platform. But if there is no
1698 // build time support then there cannot be any runtime support as we do not
1699 // know what the runtime types would be (for example clockid_t might be an
1700 // int or int64_t).
1701 //
1702 #ifdef SUPPORTS_CLOCK_MONOTONIC
1703 
1704 // This means we have clockid_t, clock_gettime et al and CLOCK_MONOTONIC
1705 
1706 int (*os::Posix::_clock_gettime)(clockid_t, struct timespec *) = NULL;
1707 int (*os::Posix::_clock_getres)(clockid_t, struct timespec *) = NULL;
1708 
1709 static int (*_pthread_condattr_setclock)(pthread_condattr_t *, clockid_t) = NULL;
1710 
1711 static bool _use_clock_monotonic_condattr = false;
1712 
1713 // Determine what POSIX API&#39;s are present and do appropriate
1714 // configuration.
1715 void os::Posix::init(void) {
1716 
1717   // NOTE: no logging available when this is called. Put logging
1718   // statements in init_2().
1719 
1720   // 1. Check for CLOCK_MONOTONIC support.
1721 
1722   void* handle = NULL;
1723 
1724   // For linux we need librt, for other OS we can find
1725   // this function in regular libc.
1726 #ifdef NEEDS_LIBRT
1727   // We do dlopen&#39;s in this particular order due to bug in linux
1728   // dynamic loader (see 6348968) leading to crash on exit.
1729   handle = dlopen(&quot;librt.so.1&quot;, RTLD_LAZY);
1730   if (handle == NULL) {
1731     handle = dlopen(&quot;librt.so&quot;, RTLD_LAZY);
1732   }
1733 #endif
1734 
1735   if (handle == NULL) {
1736     handle = RTLD_DEFAULT;
1737   }
1738 
1739   int (*clock_getres_func)(clockid_t, struct timespec*) =
1740     (int(*)(clockid_t, struct timespec*))dlsym(handle, &quot;clock_getres&quot;);
1741   int (*clock_gettime_func)(clockid_t, struct timespec*) =
1742     (int(*)(clockid_t, struct timespec*))dlsym(handle, &quot;clock_gettime&quot;);
1743   if (clock_getres_func != NULL &amp;&amp; clock_gettime_func != NULL) {
1744     // We assume that if both clock_gettime and clock_getres support
1745     // CLOCK_MONOTONIC then the OS provides true high-res monotonic clock.
1746     struct timespec res;
1747     struct timespec tp;
1748     if (clock_getres_func(CLOCK_MONOTONIC, &amp;res) == 0 &amp;&amp;
1749         clock_gettime_func(CLOCK_MONOTONIC, &amp;tp) == 0) {
1750       // Yes, monotonic clock is supported.
1751       _clock_gettime = clock_gettime_func;
1752       _clock_getres = clock_getres_func;
1753     } else {
1754 #ifdef NEEDS_LIBRT
1755       // Close librt if there is no monotonic clock.
1756       if (handle != RTLD_DEFAULT) {
1757         dlclose(handle);
1758       }
1759 #endif
1760     }
1761   }
1762 
1763   // 2. Check for pthread_condattr_setclock support.
1764 
1765   // libpthread is already loaded.
1766   int (*condattr_setclock_func)(pthread_condattr_t*, clockid_t) =
1767     (int (*)(pthread_condattr_t*, clockid_t))dlsym(RTLD_DEFAULT,
1768                                                    &quot;pthread_condattr_setclock&quot;);
1769   if (condattr_setclock_func != NULL) {
1770     _pthread_condattr_setclock = condattr_setclock_func;
1771   }
1772 
1773   // Now do general initialization.
1774 
1775   pthread_init_common();
1776 
1777 #ifndef SOLARIS
1778   int status;
1779   if (_pthread_condattr_setclock != NULL &amp;&amp; _clock_gettime != NULL) {
1780     if ((status = _pthread_condattr_setclock(_condAttr, CLOCK_MONOTONIC)) != 0) {
1781       if (status == EINVAL) {
1782         _use_clock_monotonic_condattr = false;
1783         warning(&quot;Unable to use monotonic clock with relative timed-waits&quot; \
1784                 &quot; - changes to the time-of-day clock may have adverse affects&quot;);
1785       } else {
1786         fatal(&quot;pthread_condattr_setclock: %s&quot;, os::strerror(status));
1787       }
1788     } else {
1789       _use_clock_monotonic_condattr = true;
1790     }
1791   }
1792 #endif // !SOLARIS
1793 
1794 }
1795 
1796 void os::Posix::init_2(void) {
1797 #ifndef SOLARIS
1798   log_info(os)(&quot;Use of CLOCK_MONOTONIC is%s supported&quot;,
1799                (_clock_gettime != NULL ? &quot;&quot; : &quot; not&quot;));
1800   log_info(os)(&quot;Use of pthread_condattr_setclock is%s supported&quot;,
1801                (_pthread_condattr_setclock != NULL ? &quot;&quot; : &quot; not&quot;));
1802   log_info(os)(&quot;Relative timed-wait using pthread_cond_timedwait is associated with %s&quot;,
1803                _use_clock_monotonic_condattr ? &quot;CLOCK_MONOTONIC&quot; : &quot;the default clock&quot;);
1804   sigemptyset(&amp;sigs);
1805 #endif // !SOLARIS
1806 }
1807 
1808 #else // !SUPPORTS_CLOCK_MONOTONIC
1809 
1810 void os::Posix::init(void) {
1811   pthread_init_common();
1812 }
1813 
1814 void os::Posix::init_2(void) {
1815 #ifndef SOLARIS
1816   log_info(os)(&quot;Use of CLOCK_MONOTONIC is not supported&quot;);
1817   log_info(os)(&quot;Use of pthread_condattr_setclock is not supported&quot;);
1818   log_info(os)(&quot;Relative timed-wait using pthread_cond_timedwait is associated with the default clock&quot;);
1819   sigemptyset(&amp;sigs);
1820 #endif // !SOLARIS
1821 }
1822 
1823 #endif // SUPPORTS_CLOCK_MONOTONIC
1824 
1825 // Utility to convert the given timeout to an absolute timespec
1826 // (based on the appropriate clock) to use with pthread_cond_timewait,
1827 // and sem_timedwait().
1828 // The clock queried here must be the clock used to manage the
1829 // timeout of the condition variable or semaphore.
1830 //
1831 // The passed in timeout value is either a relative time in nanoseconds
1832 // or an absolute time in milliseconds. A relative timeout will be
1833 // associated with CLOCK_MONOTONIC if available, unless the real-time clock
1834 // is explicitly requested; otherwise, or if absolute,
1835 // the default time-of-day clock will be used.
1836 
1837 // Given time is a 64-bit value and the time_t used in the timespec is
1838 // sometimes a signed-32-bit value we have to watch for overflow if times
1839 // way in the future are given. Further on Solaris versions
1840 // prior to 10 there is a restriction (see cond_timedwait) that the specified
1841 // number of seconds, in abstime, is less than current_time + 100000000.
1842 // As it will be over 20 years before &quot;now + 100000000&quot; will overflow we can
1843 // ignore overflow and just impose a hard-limit on seconds using the value
1844 // of &quot;now + 100000000&quot;. This places a limit on the timeout of about 3.17
1845 // years from &quot;now&quot;.
1846 //
1847 #define MAX_SECS 100000000
1848 
1849 // Calculate a new absolute time that is &quot;timeout&quot; nanoseconds from &quot;now&quot;.
1850 // &quot;unit&quot; indicates the unit of &quot;now_part_sec&quot; (may be nanos or micros depending
1851 // on which clock API is being used).
1852 static void calc_rel_time(timespec* abstime, jlong timeout, jlong now_sec,
1853                           jlong now_part_sec, jlong unit) {
1854   time_t max_secs = now_sec + MAX_SECS;
1855 
1856   jlong seconds = timeout / NANOUNITS;
1857   timeout %= NANOUNITS; // remaining nanos
1858 
1859   if (seconds &gt;= MAX_SECS) {
1860     // More seconds than we can add, so pin to max_secs.
1861     abstime-&gt;tv_sec = max_secs;
1862     abstime-&gt;tv_nsec = 0;
1863   } else {
1864     abstime-&gt;tv_sec = now_sec  + seconds;
1865     long nanos = (now_part_sec * (NANOUNITS / unit)) + timeout;
1866     if (nanos &gt;= NANOUNITS) { // overflow
1867       abstime-&gt;tv_sec += 1;
1868       nanos -= NANOUNITS;
1869     }
1870     abstime-&gt;tv_nsec = nanos;
1871   }
1872 }
1873 
1874 // Unpack the given deadline in milliseconds since the epoch, into the given timespec.
1875 // The current time in seconds is also passed in to enforce an upper bound as discussed above.
1876 // This is only used with gettimeofday, when clock_gettime is not available.
1877 static void unpack_abs_time(timespec* abstime, jlong deadline, jlong now_sec) {
1878   time_t max_secs = now_sec + MAX_SECS;
1879 
1880   jlong seconds = deadline / MILLIUNITS;
1881   jlong millis = deadline % MILLIUNITS;
1882 
1883   if (seconds &gt;= max_secs) {
1884     // Absolute seconds exceeds allowed max, so pin to max_secs.
1885     abstime-&gt;tv_sec = max_secs;
1886     abstime-&gt;tv_nsec = 0;
1887   } else {
1888     abstime-&gt;tv_sec = seconds;
1889     abstime-&gt;tv_nsec = millis * (NANOUNITS / MILLIUNITS);
1890   }
1891 }
1892 
1893 static jlong millis_to_nanos(jlong millis) {
1894   // We have to watch for overflow when converting millis to nanos,
1895   // but if millis is that large then we will end up limiting to
1896   // MAX_SECS anyway, so just do that here.
1897   if (millis / MILLIUNITS &gt; MAX_SECS) {
1898     millis = jlong(MAX_SECS) * MILLIUNITS;
1899   }
1900   return millis * (NANOUNITS / MILLIUNITS);
1901 }
1902 
1903 static void to_abstime(timespec* abstime, jlong timeout,
1904                        bool isAbsolute, bool isRealtime) {
1905   DEBUG_ONLY(int max_secs = MAX_SECS;)
1906 
1907   if (timeout &lt; 0) {
1908     timeout = 0;
1909   }
1910 
1911 #ifdef SUPPORTS_CLOCK_MONOTONIC
1912 
1913   clockid_t clock = CLOCK_MONOTONIC;
1914   // need to ensure we have a runtime check for clock_gettime support
1915   if (!isAbsolute &amp;&amp; os::Posix::supports_monotonic_clock()) {
1916     if (!_use_clock_monotonic_condattr || isRealtime) {
1917       clock = CLOCK_REALTIME;
1918     }
1919     struct timespec now;
1920     int status = os::Posix::clock_gettime(clock, &amp;now);
1921     assert_status(status == 0, status, &quot;clock_gettime&quot;);
1922     calc_rel_time(abstime, timeout, now.tv_sec, now.tv_nsec, NANOUNITS);
1923     DEBUG_ONLY(max_secs += now.tv_sec;)
1924   } else {
1925 
1926 #else
1927 
1928   { // Match the block scope.
1929 
1930 #endif // SUPPORTS_CLOCK_MONOTONIC
1931 
1932     // Time-of-day clock is all we can reliably use.
1933     struct timeval now;
1934     int status = gettimeofday(&amp;now, NULL);
1935     assert_status(status == 0, errno, &quot;gettimeofday&quot;);
1936     if (isAbsolute) {
1937       unpack_abs_time(abstime, timeout, now.tv_sec);
1938     } else {
1939       calc_rel_time(abstime, timeout, now.tv_sec, now.tv_usec, MICROUNITS);
1940     }
1941     DEBUG_ONLY(max_secs += now.tv_sec;)
1942   }
1943 
1944   assert(abstime-&gt;tv_sec &gt;= 0, &quot;tv_sec &lt; 0&quot;);
1945   assert(abstime-&gt;tv_sec &lt;= max_secs, &quot;tv_sec &gt; max_secs&quot;);
1946   assert(abstime-&gt;tv_nsec &gt;= 0, &quot;tv_nsec &lt; 0&quot;);
1947   assert(abstime-&gt;tv_nsec &lt; NANOUNITS, &quot;tv_nsec &gt;= NANOUNITS&quot;);
1948 }
1949 
1950 // Create an absolute time &#39;millis&#39; milliseconds in the future, using the
1951 // real-time (time-of-day) clock. Used by PosixSemaphore.
1952 void os::Posix::to_RTC_abstime(timespec* abstime, int64_t millis) {
1953   to_abstime(abstime, millis_to_nanos(millis),
1954              false /* not absolute */,
1955              true  /* use real-time clock */);
1956 }
1957 
1958 // Shared pthread_mutex/cond based PlatformEvent implementation.
1959 // Not currently usable by Solaris.
1960 
1961 #ifndef SOLARIS
1962 
1963 // PlatformEvent
1964 //
1965 // Assumption:
1966 //    Only one parker can exist on an event, which is why we allocate
1967 //    them per-thread. Multiple unparkers can coexist.
1968 //
1969 // _event serves as a restricted-range semaphore.
1970 //   -1 : thread is blocked, i.e. there is a waiter
1971 //    0 : neutral: thread is running or ready,
1972 //        could have been signaled after a wait started
1973 //    1 : signaled - thread is running or ready
1974 //
1975 //    Having three states allows for some detection of bad usage - see
1976 //    comments on unpark().
1977 
1978 os::PlatformEvent::PlatformEvent() {
1979   int status = pthread_cond_init(_cond, _condAttr);
1980   assert_status(status == 0, status, &quot;cond_init&quot;);
1981   status = pthread_mutex_init(_mutex, _mutexAttr);
1982   assert_status(status == 0, status, &quot;mutex_init&quot;);
1983   _event   = 0;
1984   _nParked = 0;
1985 }
1986 
1987 void os::PlatformEvent::park() {       // AKA &quot;down()&quot;
1988   // Transitions for _event:
1989   //   -1 =&gt; -1 : illegal
1990   //    1 =&gt;  0 : pass - return immediately
1991   //    0 =&gt; -1 : block; then set _event to 0 before returning
1992 
1993   // Invariant: Only the thread associated with the PlatformEvent
1994   // may call park().
1995   assert(_nParked == 0, &quot;invariant&quot;);
1996 
1997   int v;
1998 
1999   // atomically decrement _event
2000   for (;;) {
2001     v = _event;
2002     if (Atomic::cmpxchg(v - 1, &amp;_event, v) == v) break;
2003   }
2004   guarantee(v &gt;= 0, &quot;invariant&quot;);
2005 
2006   if (v == 0) { // Do this the hard way by blocking ...
2007     int status = pthread_mutex_lock(_mutex);
2008     assert_status(status == 0, status, &quot;mutex_lock&quot;);
2009     guarantee(_nParked == 0, &quot;invariant&quot;);
2010     ++_nParked;
2011     while (_event &lt; 0) {
2012       // OS-level &quot;spurious wakeups&quot; are ignored
2013       status = pthread_cond_wait(_cond, _mutex);
2014       assert_status(status == 0, status, &quot;cond_wait&quot;);
2015     }
2016     --_nParked;
2017 
2018     _event = 0;
2019     status = pthread_mutex_unlock(_mutex);
2020     assert_status(status == 0, status, &quot;mutex_unlock&quot;);
2021     // Paranoia to ensure our locked and lock-free paths interact
2022     // correctly with each other.
2023     OrderAccess::fence();
2024   }
2025   guarantee(_event &gt;= 0, &quot;invariant&quot;);
2026 }
2027 
2028 int os::PlatformEvent::park(jlong millis) {
2029   // Transitions for _event:
2030   //   -1 =&gt; -1 : illegal
2031   //    1 =&gt;  0 : pass - return immediately
2032   //    0 =&gt; -1 : block; then set _event to 0 before returning
2033 
2034   // Invariant: Only the thread associated with the Event/PlatformEvent
2035   // may call park().
2036   assert(_nParked == 0, &quot;invariant&quot;);
2037 
2038   int v;
2039   // atomically decrement _event
2040   for (;;) {
2041     v = _event;
2042     if (Atomic::cmpxchg(v - 1, &amp;_event, v) == v) break;
2043   }
2044   guarantee(v &gt;= 0, &quot;invariant&quot;);
2045 
2046   if (v == 0) { // Do this the hard way by blocking ...
2047     struct timespec abst;
2048     to_abstime(&amp;abst, millis_to_nanos(millis), false, false);
2049 
2050     int ret = OS_TIMEOUT;
2051     int status = pthread_mutex_lock(_mutex);
2052     assert_status(status == 0, status, &quot;mutex_lock&quot;);
2053     guarantee(_nParked == 0, &quot;invariant&quot;);
2054     ++_nParked;
2055 
2056     while (_event &lt; 0) {
2057       status = pthread_cond_timedwait(_cond, _mutex, &amp;abst);
2058       assert_status(status == 0 || status == ETIMEDOUT,
2059                     status, &quot;cond_timedwait&quot;);
2060       // OS-level &quot;spurious wakeups&quot; are ignored unless the archaic
2061       // FilterSpuriousWakeups is set false. That flag should be obsoleted.
2062       if (!FilterSpuriousWakeups) break;
2063       if (status == ETIMEDOUT) break;
2064     }
2065     --_nParked;
2066 
2067     if (_event &gt;= 0) {
2068       ret = OS_OK;
2069     }
2070 
2071     _event = 0;
2072     status = pthread_mutex_unlock(_mutex);
2073     assert_status(status == 0, status, &quot;mutex_unlock&quot;);
2074     // Paranoia to ensure our locked and lock-free paths interact
2075     // correctly with each other.
2076     OrderAccess::fence();
2077     return ret;
2078   }
2079   return OS_OK;
2080 }
2081 
2082 void os::PlatformEvent::unpark() {
2083   // Transitions for _event:
2084   //    0 =&gt; 1 : just return
2085   //    1 =&gt; 1 : just return
2086   //   -1 =&gt; either 0 or 1; must signal target thread
2087   //         That is, we can safely transition _event from -1 to either
2088   //         0 or 1.
2089   // See also: &quot;Semaphores in Plan 9&quot; by Mullender &amp; Cox
2090   //
2091   // Note: Forcing a transition from &quot;-1&quot; to &quot;1&quot; on an unpark() means
2092   // that it will take two back-to-back park() calls for the owning
2093   // thread to block. This has the benefit of forcing a spurious return
2094   // from the first park() call after an unpark() call which will help
2095   // shake out uses of park() and unpark() without checking state conditions
2096   // properly. This spurious return doesn&#39;t manifest itself in any user code
2097   // but only in the correctly written condition checking loops of ObjectMonitor,
2098   // Mutex/Monitor, Thread::muxAcquire and os::sleep
2099 
2100   if (Atomic::xchg(1, &amp;_event) &gt;= 0) return;
2101 
2102   int status = pthread_mutex_lock(_mutex);
2103   assert_status(status == 0, status, &quot;mutex_lock&quot;);
2104   int anyWaiters = _nParked;
2105   assert(anyWaiters == 0 || anyWaiters == 1, &quot;invariant&quot;);
2106   status = pthread_mutex_unlock(_mutex);
2107   assert_status(status == 0, status, &quot;mutex_unlock&quot;);
2108 
2109   // Note that we signal() *after* dropping the lock for &quot;immortal&quot; Events.
2110   // This is safe and avoids a common class of futile wakeups.  In rare
2111   // circumstances this can cause a thread to return prematurely from
2112   // cond_{timed}wait() but the spurious wakeup is benign and the victim
2113   // will simply re-test the condition and re-park itself.
2114   // This provides particular benefit if the underlying platform does not
2115   // provide wait morphing.
2116 
2117   if (anyWaiters != 0) {
2118     status = pthread_cond_signal(_cond);
2119     assert_status(status == 0, status, &quot;cond_signal&quot;);
2120   }
2121 }
2122 
2123 // JSR166 support
2124 
2125  os::PlatformParker::PlatformParker() {
2126   int status;
2127   status = pthread_cond_init(&amp;_cond[REL_INDEX], _condAttr);
2128   assert_status(status == 0, status, &quot;cond_init rel&quot;);
2129   status = pthread_cond_init(&amp;_cond[ABS_INDEX], NULL);
2130   assert_status(status == 0, status, &quot;cond_init abs&quot;);
2131   status = pthread_mutex_init(_mutex, _mutexAttr);
2132   assert_status(status == 0, status, &quot;mutex_init&quot;);
2133   _cur_index = -1; // mark as unused
2134 }
2135 
2136 // Parker::park decrements count if &gt; 0, else does a condvar wait.  Unpark
2137 // sets count to 1 and signals condvar.  Only one thread ever waits
2138 // on the condvar. Contention seen when trying to park implies that someone
2139 // is unparking you, so don&#39;t wait. And spurious returns are fine, so there
2140 // is no need to track notifications.
2141 
2142 void Parker::park(bool isAbsolute, jlong time) {
2143 
2144   // Optional fast-path check:
2145   // Return immediately if a permit is available.
2146   // We depend on Atomic::xchg() having full barrier semantics
2147   // since we are doing a lock-free update to _counter.
2148   if (Atomic::xchg(0, &amp;_counter) &gt; 0) return;
2149 
2150   Thread* thread = Thread::current();
2151   assert(thread-&gt;is_Java_thread(), &quot;Must be JavaThread&quot;);
2152   JavaThread *jt = (JavaThread *)thread;
2153 
2154   // Optional optimization -- avoid state transitions if there&#39;s
2155   // an interrupt pending.
2156   if (Thread::is_interrupted(thread, false)) {
2157     return;
2158   }
2159 
2160   // Next, demultiplex/decode time arguments
2161   struct timespec absTime;
2162   if (time &lt; 0 || (isAbsolute &amp;&amp; time == 0)) { // don&#39;t wait at all
2163     return;
2164   }
2165   if (time &gt; 0) {
2166     to_abstime(&amp;absTime, time, isAbsolute, false);
2167   }
2168 
2169   // Enter safepoint region
2170   // Beware of deadlocks such as 6317397.
2171   // The per-thread Parker:: mutex is a classic leaf-lock.
2172   // In particular a thread must never block on the Threads_lock while
2173   // holding the Parker:: mutex.  If safepoints are pending both the
2174   // the ThreadBlockInVM() CTOR and DTOR may grab Threads_lock.
2175   ThreadBlockInVM tbivm(jt);
2176 
2177   // Don&#39;t wait if cannot get lock since interference arises from
2178   // unparking. Also re-check interrupt before trying wait.
2179   if (Thread::is_interrupted(thread, false) ||
2180       pthread_mutex_trylock(_mutex) != 0) {
2181     return;
2182   }
2183 
2184   int status;
2185   if (_counter &gt; 0)  { // no wait needed
2186     _counter = 0;
2187     status = pthread_mutex_unlock(_mutex);
2188     assert_status(status == 0, status, &quot;invariant&quot;);
2189     // Paranoia to ensure our locked and lock-free paths interact
2190     // correctly with each other and Java-level accesses.
2191     OrderAccess::fence();
2192     return;
2193   }
2194 
2195   OSThreadWaitState osts(thread-&gt;osthread(), false /* not Object.wait() */);
2196   jt-&gt;set_suspend_equivalent();
2197   // cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
2198 
2199   assert(_cur_index == -1, &quot;invariant&quot;);
2200   if (time == 0) {
2201     _cur_index = REL_INDEX; // arbitrary choice when not timed
2202     status = pthread_cond_wait(&amp;_cond[_cur_index], _mutex);
2203     assert_status(status == 0, status, &quot;cond_timedwait&quot;);
2204   }
2205   else {
2206     _cur_index = isAbsolute ? ABS_INDEX : REL_INDEX;
2207     status = pthread_cond_timedwait(&amp;_cond[_cur_index], _mutex, &amp;absTime);
2208     assert_status(status == 0 || status == ETIMEDOUT,
2209                   status, &quot;cond_timedwait&quot;);
2210   }
2211   _cur_index = -1;
2212 
2213   _counter = 0;
2214   status = pthread_mutex_unlock(_mutex);
2215   assert_status(status == 0, status, &quot;invariant&quot;);
2216   // Paranoia to ensure our locked and lock-free paths interact
2217   // correctly with each other and Java-level accesses.
2218   OrderAccess::fence();
2219 
2220   // If externally suspended while waiting, re-suspend
2221   if (jt-&gt;handle_special_suspend_equivalent_condition()) {
2222     jt-&gt;java_suspend_self();
2223   }
2224 }
2225 
2226 void Parker::unpark() {
2227   int status = pthread_mutex_lock(_mutex);
2228   assert_status(status == 0, status, &quot;invariant&quot;);
2229   const int s = _counter;
2230   _counter = 1;
2231   // must capture correct index before unlocking
2232   int index = _cur_index;
2233   status = pthread_mutex_unlock(_mutex);
2234   assert_status(status == 0, status, &quot;invariant&quot;);
2235 
2236   // Note that we signal() *after* dropping the lock for &quot;immortal&quot; Events.
2237   // This is safe and avoids a common class of futile wakeups.  In rare
2238   // circumstances this can cause a thread to return prematurely from
2239   // cond_{timed}wait() but the spurious wakeup is benign and the victim
2240   // will simply re-test the condition and re-park itself.
2241   // This provides particular benefit if the underlying platform does not
2242   // provide wait morphing.
2243 
2244   if (s &lt; 1 &amp;&amp; index != -1) {
2245     // thread is definitely parked
2246     status = pthread_cond_signal(&amp;_cond[index]);
2247     assert_status(status == 0, status, &quot;invariant&quot;);
2248   }
2249 }
2250 
2251 // Platform Monitor implementation
2252 
2253 os::PlatformMonitor::PlatformMonitor() {
2254   int status = pthread_cond_init(&amp;_cond, _condAttr);
2255   assert_status(status == 0, status, &quot;cond_init&quot;);
2256   status = pthread_mutex_init(&amp;_mutex, _mutexAttr);
2257   assert_status(status == 0, status, &quot;mutex_init&quot;);
2258 }
2259 
2260 os::PlatformMonitor::~PlatformMonitor() {
2261   int status = pthread_cond_destroy(&amp;_cond);
2262   assert_status(status == 0, status, &quot;cond_destroy&quot;);
2263   status = pthread_mutex_destroy(&amp;_mutex);
2264   assert_status(status == 0, status, &quot;mutex_destroy&quot;);
2265 }
2266 
2267 // Must already be locked
2268 int os::PlatformMonitor::wait(jlong millis) {
2269   assert(millis &gt;= 0, &quot;negative timeout&quot;);
2270   if (millis &gt; 0) {
2271     struct timespec abst;
2272     // We have to watch for overflow when converting millis to nanos,
2273     // but if millis is that large then we will end up limiting to
2274     // MAX_SECS anyway, so just do that here.
2275     if (millis / MILLIUNITS &gt; MAX_SECS) {
2276       millis = jlong(MAX_SECS) * MILLIUNITS;
2277     }
2278     to_abstime(&amp;abst, millis * (NANOUNITS / MILLIUNITS), false, false);
2279 
2280     int ret = OS_TIMEOUT;
2281     int status = pthread_cond_timedwait(&amp;_cond, &amp;_mutex, &amp;abst);
2282     assert_status(status == 0 || status == ETIMEDOUT,
2283                   status, &quot;cond_timedwait&quot;);
2284     if (status == 0) {
2285       ret = OS_OK;
2286     }
2287     return ret;
2288   } else {
2289     int status = pthread_cond_wait(&amp;_cond, &amp;_mutex);
2290     assert_status(status == 0, status, &quot;cond_wait&quot;);
2291     return OS_OK;
2292   }
2293 }
2294 
2295 #endif // !SOLARIS
    </pre>
  </body>
</html>