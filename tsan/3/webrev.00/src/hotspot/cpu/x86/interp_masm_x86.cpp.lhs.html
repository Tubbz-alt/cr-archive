<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/x86/interp_masm_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;interp_masm_x86.hpp&quot;
  27 #include &quot;interpreter/interpreter.hpp&quot;
  28 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  29 #include &quot;logging/log.hpp&quot;
  30 #include &quot;oops/arrayOop.hpp&quot;
<a name="1" id="anc1"></a><span class="line-modified">  31 #include &quot;oops/markOop.hpp&quot;</span>
  32 #include &quot;oops/methodData.hpp&quot;
  33 #include &quot;oops/method.hpp&quot;
  34 #include &quot;prims/jvmtiExport.hpp&quot;
  35 #include &quot;prims/jvmtiThreadState.hpp&quot;
  36 #include &quot;runtime/basicLock.hpp&quot;
  37 #include &quot;runtime/biasedLocking.hpp&quot;
  38 #include &quot;runtime/frame.inline.hpp&quot;
  39 #include &quot;runtime/safepointMechanism.hpp&quot;
  40 #include &quot;runtime/sharedRuntime.hpp&quot;
  41 #include &quot;runtime/thread.inline.hpp&quot;
<a name="2" id="anc2"></a>
  42 
  43 // Implementation of InterpreterMacroAssembler
  44 
  45 void InterpreterMacroAssembler::jump_to_entry(address entry) {
  46   assert(entry, &quot;Entry must have been generated by now&quot;);
  47   jump(RuntimeAddress(entry));
  48 }
  49 
  50 void InterpreterMacroAssembler::profile_obj_type(Register obj, const Address&amp; mdo_addr) {
  51   Label update, next, none;
  52 
  53   verify_oop(obj);
  54 
  55   testptr(obj, obj);
  56   jccb(Assembler::notZero, update);
  57   orptr(mdo_addr, TypeEntries::null_seen);
  58   jmpb(next);
  59 
  60   bind(update);
  61   load_klass(obj, obj);
  62 
  63   xorptr(obj, mdo_addr);
  64   testptr(obj, TypeEntries::type_klass_mask);
  65   jccb(Assembler::zero, next); // klass seen before, nothing to
  66                                // do. The unknown bit may have been
  67                                // set already but no need to check.
  68 
  69   testptr(obj, TypeEntries::type_unknown);
  70   jccb(Assembler::notZero, next); // already unknown. Nothing to do anymore.
  71 
  72   cmpptr(mdo_addr, 0);
  73   jccb(Assembler::equal, none);
  74   cmpptr(mdo_addr, TypeEntries::null_seen);
  75   jccb(Assembler::equal, none);
  76   // There is a chance that the checks above (re-reading profiling
  77   // data from memory) fail if another thread has just set the
  78   // profiling to this obj&#39;s klass
  79   xorptr(obj, mdo_addr);
  80   testptr(obj, TypeEntries::type_klass_mask);
  81   jccb(Assembler::zero, next);
  82 
  83   // different than before. Cannot keep accurate profile.
  84   orptr(mdo_addr, TypeEntries::type_unknown);
  85   jmpb(next);
  86 
  87   bind(none);
  88   // first time here. Set profile type.
  89   movptr(mdo_addr, obj);
  90 
  91   bind(next);
  92 }
  93 
  94 void InterpreterMacroAssembler::profile_arguments_type(Register mdp, Register callee, Register tmp, bool is_virtual) {
  95   if (!ProfileInterpreter) {
  96     return;
  97   }
  98 
  99   if (MethodData::profile_arguments() || MethodData::profile_return()) {
 100     Label profile_continue;
 101 
 102     test_method_data_pointer(mdp, profile_continue);
 103 
 104     int off_to_start = is_virtual ? in_bytes(VirtualCallData::virtual_call_data_size()) : in_bytes(CounterData::counter_data_size());
 105 
 106     cmpb(Address(mdp, in_bytes(DataLayout::tag_offset()) - off_to_start), is_virtual ? DataLayout::virtual_call_type_data_tag : DataLayout::call_type_data_tag);
 107     jcc(Assembler::notEqual, profile_continue);
 108 
 109     if (MethodData::profile_arguments()) {
 110       Label done;
 111       int off_to_args = in_bytes(TypeEntriesAtCall::args_data_offset());
 112       addptr(mdp, off_to_args);
 113 
 114       for (int i = 0; i &lt; TypeProfileArgsLimit; i++) {
 115         if (i &gt; 0 || MethodData::profile_return()) {
 116           // If return value type is profiled we may have no argument to profile
 117           movptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args));
 118           subl(tmp, i*TypeStackSlotEntries::per_arg_count());
 119           cmpl(tmp, TypeStackSlotEntries::per_arg_count());
 120           jcc(Assembler::less, done);
 121         }
 122         movptr(tmp, Address(callee, Method::const_offset()));
 123         load_unsigned_short(tmp, Address(tmp, ConstMethod::size_of_parameters_offset()));
 124         // stack offset o (zero based) from the start of the argument
 125         // list, for n arguments translates into offset n - o - 1 from
 126         // the end of the argument list
 127         subptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::stack_slot_offset(i))-off_to_args));
 128         subl(tmp, 1);
 129         Address arg_addr = argument_address(tmp);
 130         movptr(tmp, arg_addr);
 131 
 132         Address mdo_arg_addr(mdp, in_bytes(TypeEntriesAtCall::argument_type_offset(i))-off_to_args);
 133         profile_obj_type(tmp, mdo_arg_addr);
 134 
 135         int to_add = in_bytes(TypeStackSlotEntries::per_arg_size());
 136         addptr(mdp, to_add);
 137         off_to_args += to_add;
 138       }
 139 
 140       if (MethodData::profile_return()) {
 141         movptr(tmp, Address(mdp, in_bytes(TypeEntriesAtCall::cell_count_offset())-off_to_args));
 142         subl(tmp, TypeProfileArgsLimit*TypeStackSlotEntries::per_arg_count());
 143       }
 144 
 145       bind(done);
 146 
 147       if (MethodData::profile_return()) {
 148         // We&#39;re right after the type profile for the last
 149         // argument. tmp is the number of cells left in the
 150         // CallTypeData/VirtualCallTypeData to reach its end. Non null
 151         // if there&#39;s a return to profile.
 152         assert(ReturnTypeEntry::static_cell_count() &lt; TypeStackSlotEntries::per_arg_count(), &quot;can&#39;t move past ret type&quot;);
 153         shll(tmp, exact_log2(DataLayout::cell_size));
 154         addptr(mdp, tmp);
 155       }
 156       movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp);
 157     } else {
 158       assert(MethodData::profile_return(), &quot;either profile call args or call ret&quot;);
 159       update_mdp_by_constant(mdp, in_bytes(TypeEntriesAtCall::return_only_size()));
 160     }
 161 
 162     // mdp points right after the end of the
 163     // CallTypeData/VirtualCallTypeData, right after the cells for the
 164     // return value type if there&#39;s one
 165 
 166     bind(profile_continue);
 167   }
 168 }
 169 
 170 void InterpreterMacroAssembler::profile_return_type(Register mdp, Register ret, Register tmp) {
 171   assert_different_registers(mdp, ret, tmp, _bcp_register);
 172   if (ProfileInterpreter &amp;&amp; MethodData::profile_return()) {
 173     Label profile_continue;
 174 
 175     test_method_data_pointer(mdp, profile_continue);
 176 
 177     if (MethodData::profile_return_jsr292_only()) {
 178       assert(Method::intrinsic_id_size_in_bytes() == 2, &quot;assuming Method::_intrinsic_id is u2&quot;);
 179 
 180       // If we don&#39;t profile all invoke bytecodes we must make sure
 181       // it&#39;s a bytecode we indeed profile. We can&#39;t go back to the
 182       // begining of the ProfileData we intend to update to check its
 183       // type because we&#39;re right after it and we don&#39;t known its
 184       // length
 185       Label do_profile;
 186       cmpb(Address(_bcp_register, 0), Bytecodes::_invokedynamic);
 187       jcc(Assembler::equal, do_profile);
 188       cmpb(Address(_bcp_register, 0), Bytecodes::_invokehandle);
 189       jcc(Assembler::equal, do_profile);
 190       get_method(tmp);
 191       cmpw(Address(tmp, Method::intrinsic_id_offset_in_bytes()), vmIntrinsics::_compiledLambdaForm);
 192       jcc(Assembler::notEqual, profile_continue);
 193 
 194       bind(do_profile);
 195     }
 196 
 197     Address mdo_ret_addr(mdp, -in_bytes(ReturnTypeEntry::size()));
 198     mov(tmp, ret);
 199     profile_obj_type(tmp, mdo_ret_addr);
 200 
 201     bind(profile_continue);
 202   }
 203 }
 204 
 205 void InterpreterMacroAssembler::profile_parameters_type(Register mdp, Register tmp1, Register tmp2) {
 206   if (ProfileInterpreter &amp;&amp; MethodData::profile_parameters()) {
 207     Label profile_continue;
 208 
 209     test_method_data_pointer(mdp, profile_continue);
 210 
 211     // Load the offset of the area within the MDO used for
 212     // parameters. If it&#39;s negative we&#39;re not profiling any parameters
 213     movl(tmp1, Address(mdp, in_bytes(MethodData::parameters_type_data_di_offset()) - in_bytes(MethodData::data_offset())));
 214     testl(tmp1, tmp1);
 215     jcc(Assembler::negative, profile_continue);
 216 
 217     // Compute a pointer to the area for parameters from the offset
 218     // and move the pointer to the slot for the last
 219     // parameters. Collect profiling from last parameter down.
 220     // mdo start + parameters offset + array length - 1
 221     addptr(mdp, tmp1);
 222     movptr(tmp1, Address(mdp, ArrayData::array_len_offset()));
 223     decrement(tmp1, TypeStackSlotEntries::per_arg_count());
 224 
 225     Label loop;
 226     bind(loop);
 227 
 228     int off_base = in_bytes(ParametersTypeData::stack_slot_offset(0));
 229     int type_base = in_bytes(ParametersTypeData::type_offset(0));
 230     Address::ScaleFactor per_arg_scale = Address::times(DataLayout::cell_size);
 231     Address arg_off(mdp, tmp1, per_arg_scale, off_base);
 232     Address arg_type(mdp, tmp1, per_arg_scale, type_base);
 233 
 234     // load offset on the stack from the slot for this parameter
 235     movptr(tmp2, arg_off);
 236     negptr(tmp2);
 237     // read the parameter from the local area
 238     movptr(tmp2, Address(_locals_register, tmp2, Interpreter::stackElementScale()));
 239 
 240     // profile the parameter
 241     profile_obj_type(tmp2, arg_type);
 242 
 243     // go to next parameter
 244     decrement(tmp1, TypeStackSlotEntries::per_arg_count());
 245     jcc(Assembler::positive, loop);
 246 
 247     bind(profile_continue);
 248   }
 249 }
 250 
 251 void InterpreterMacroAssembler::call_VM_leaf_base(address entry_point,
 252                                                   int number_of_arguments) {
 253   // interpreter specific
 254   //
 255   // Note: No need to save/restore bcp &amp; locals registers
 256   //       since these are callee saved registers and no blocking/
 257   //       GC can happen in leaf calls.
 258   // Further Note: DO NOT save/restore bcp/locals. If a caller has
 259   // already saved them so that it can use rsi/rdi as temporaries
 260   // then a save/restore here will DESTROY the copy the caller
 261   // saved! There used to be a save_bcp() that only happened in
 262   // the ASSERT path (no restore_bcp). Which caused bizarre failures
 263   // when jvm built with ASSERTs.
 264 #ifdef ASSERT
 265   {
 266     Label L;
 267     cmpptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 268     jcc(Assembler::equal, L);
 269     stop(&quot;InterpreterMacroAssembler::call_VM_leaf_base:&quot;
 270          &quot; last_sp != NULL&quot;);
 271     bind(L);
 272   }
 273 #endif
 274   // super call
 275   MacroAssembler::call_VM_leaf_base(entry_point, number_of_arguments);
 276   // interpreter specific
 277   // LP64: Used to ASSERT that r13/r14 were equal to frame&#39;s bcp/locals
 278   // but since they may not have been saved (and we don&#39;t want to
 279   // save them here (see note above) the assert is invalid.
 280 }
 281 
 282 void InterpreterMacroAssembler::call_VM_base(Register oop_result,
 283                                              Register java_thread,
 284                                              Register last_java_sp,
 285                                              address  entry_point,
 286                                              int      number_of_arguments,
 287                                              bool     check_exceptions) {
 288   // interpreter specific
 289   //
 290   // Note: Could avoid restoring locals ptr (callee saved) - however doesn&#39;t
 291   //       really make a difference for these runtime calls, since they are
 292   //       slow anyway. Btw., bcp must be saved/restored since it may change
 293   //       due to GC.
 294   NOT_LP64(assert(java_thread == noreg , &quot;not expecting a precomputed java thread&quot;);)
 295   save_bcp();
 296 #ifdef ASSERT
 297   {
 298     Label L;
 299     cmpptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), (int32_t)NULL_WORD);
 300     jcc(Assembler::equal, L);
 301     stop(&quot;InterpreterMacroAssembler::call_VM_base:&quot;
 302          &quot; last_sp != NULL&quot;);
 303     bind(L);
 304   }
 305 #endif /* ASSERT */
 306   // super call
 307   MacroAssembler::call_VM_base(oop_result, noreg, last_java_sp,
 308                                entry_point, number_of_arguments,
 309                                check_exceptions);
 310   // interpreter specific
 311   restore_bcp();
 312   restore_locals();
 313 }
 314 
 315 void InterpreterMacroAssembler::check_and_handle_popframe(Register java_thread) {
 316   if (JvmtiExport::can_pop_frame()) {
 317     Label L;
 318     // Initiate popframe handling only if it is not already being
 319     // processed.  If the flag has the popframe_processing bit set, it
 320     // means that this code is called *during* popframe handling - we
 321     // don&#39;t want to reenter.
 322     // This method is only called just after the call into the vm in
 323     // call_VM_base, so the arg registers are available.
 324     Register pop_cond = NOT_LP64(java_thread) // Not clear if any other register is available on 32 bit
 325                         LP64_ONLY(c_rarg0);
 326     movl(pop_cond, Address(java_thread, JavaThread::popframe_condition_offset()));
 327     testl(pop_cond, JavaThread::popframe_pending_bit);
 328     jcc(Assembler::zero, L);
 329     testl(pop_cond, JavaThread::popframe_processing_bit);
 330     jcc(Assembler::notZero, L);
 331     // Call Interpreter::remove_activation_preserving_args_entry() to get the
 332     // address of the same-named entrypoint in the generated interpreter code.
 333     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_preserving_args_entry));
 334     jmp(rax);
 335     bind(L);
 336     NOT_LP64(get_thread(java_thread);)
 337   }
 338 }
 339 
 340 void InterpreterMacroAssembler::load_earlyret_value(TosState state) {
 341   Register thread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
 342   NOT_LP64(get_thread(thread);)
 343   movptr(rcx, Address(thread, JavaThread::jvmti_thread_state_offset()));
 344   const Address tos_addr(rcx, JvmtiThreadState::earlyret_tos_offset());
 345   const Address oop_addr(rcx, JvmtiThreadState::earlyret_oop_offset());
 346   const Address val_addr(rcx, JvmtiThreadState::earlyret_value_offset());
 347 #ifdef _LP64
 348   switch (state) {
 349     case atos: movptr(rax, oop_addr);
 350                movptr(oop_addr, (int32_t)NULL_WORD);
 351                verify_oop(rax, state);              break;
 352     case ltos: movptr(rax, val_addr);                 break;
 353     case btos:                                   // fall through
 354     case ztos:                                   // fall through
 355     case ctos:                                   // fall through
 356     case stos:                                   // fall through
 357     case itos: movl(rax, val_addr);                 break;
 358     case ftos: load_float(val_addr);                break;
 359     case dtos: load_double(val_addr);               break;
 360     case vtos: /* nothing to do */                  break;
 361     default  : ShouldNotReachHere();
 362   }
 363   // Clean up tos value in the thread object
 364   movl(tos_addr,  (int) ilgl);
 365   movl(val_addr,  (int32_t) NULL_WORD);
 366 #else
 367   const Address val_addr1(rcx, JvmtiThreadState::earlyret_value_offset()
 368                              + in_ByteSize(wordSize));
 369   switch (state) {
 370     case atos: movptr(rax, oop_addr);
 371                movptr(oop_addr, NULL_WORD);
 372                verify_oop(rax, state);                break;
 373     case ltos:
 374                movl(rdx, val_addr1);               // fall through
 375     case btos:                                     // fall through
 376     case ztos:                                     // fall through
 377     case ctos:                                     // fall through
 378     case stos:                                     // fall through
 379     case itos: movl(rax, val_addr);                   break;
 380     case ftos: load_float(val_addr);                  break;
 381     case dtos: load_double(val_addr);                 break;
 382     case vtos: /* nothing to do */                    break;
 383     default  : ShouldNotReachHere();
 384   }
 385 #endif // _LP64
 386   // Clean up tos value in the thread object
 387   movl(tos_addr,  (int32_t) ilgl);
 388   movptr(val_addr,  NULL_WORD);
 389   NOT_LP64(movptr(val_addr1, NULL_WORD);)
 390 }
 391 
 392 
 393 void InterpreterMacroAssembler::check_and_handle_earlyret(Register java_thread) {
 394   if (JvmtiExport::can_force_early_return()) {
 395     Label L;
 396     Register tmp = LP64_ONLY(c_rarg0) NOT_LP64(java_thread);
 397     Register rthread = LP64_ONLY(r15_thread) NOT_LP64(java_thread);
 398 
 399     movptr(tmp, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 400     testptr(tmp, tmp);
 401     jcc(Assembler::zero, L); // if (thread-&gt;jvmti_thread_state() == NULL) exit;
 402 
 403     // Initiate earlyret handling only if it is not already being processed.
 404     // If the flag has the earlyret_processing bit set, it means that this code
 405     // is called *during* earlyret handling - we don&#39;t want to reenter.
 406     movl(tmp, Address(tmp, JvmtiThreadState::earlyret_state_offset()));
 407     cmpl(tmp, JvmtiThreadState::earlyret_pending);
 408     jcc(Assembler::notEqual, L);
 409 
 410     // Call Interpreter::remove_activation_early_entry() to get the address of the
 411     // same-named entrypoint in the generated interpreter code.
 412     NOT_LP64(get_thread(java_thread);)
 413     movptr(tmp, Address(rthread, JavaThread::jvmti_thread_state_offset()));
 414 #ifdef _LP64
 415     movl(tmp, Address(tmp, JvmtiThreadState::earlyret_tos_offset()));
 416     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), tmp);
 417 #else
 418     pushl(Address(tmp, JvmtiThreadState::earlyret_tos_offset()));
 419     call_VM_leaf(CAST_FROM_FN_PTR(address, Interpreter::remove_activation_early_entry), 1);
 420 #endif // _LP64
 421     jmp(rax);
 422     bind(L);
 423     NOT_LP64(get_thread(java_thread);)
 424   }
 425 }
 426 
 427 void InterpreterMacroAssembler::get_unsigned_2_byte_index_at_bcp(Register reg, int bcp_offset) {
 428   assert(bcp_offset &gt;= 0, &quot;bcp is still pointing to start of bytecode&quot;);
 429   load_unsigned_short(reg, Address(_bcp_register, bcp_offset));
 430   bswapl(reg);
 431   shrl(reg, 16);
 432 }
 433 
 434 void InterpreterMacroAssembler::get_cache_index_at_bcp(Register index,
 435                                                        int bcp_offset,
 436                                                        size_t index_size) {
 437   assert(bcp_offset &gt; 0, &quot;bcp is still pointing to start of bytecode&quot;);
 438   if (index_size == sizeof(u2)) {
 439     load_unsigned_short(index, Address(_bcp_register, bcp_offset));
 440   } else if (index_size == sizeof(u4)) {
 441     movl(index, Address(_bcp_register, bcp_offset));
 442     // Check if the secondary index definition is still ~x, otherwise
 443     // we have to change the following assembler code to calculate the
 444     // plain index.
 445     assert(ConstantPool::decode_invokedynamic_index(~123) == 123, &quot;else change next line&quot;);
 446     notl(index);  // convert to plain index
 447   } else if (index_size == sizeof(u1)) {
 448     load_unsigned_byte(index, Address(_bcp_register, bcp_offset));
 449   } else {
 450     ShouldNotReachHere();
 451   }
 452 }
 453 
 454 void InterpreterMacroAssembler::get_cache_and_index_at_bcp(Register cache,
 455                                                            Register index,
 456                                                            int bcp_offset,
 457                                                            size_t index_size) {
 458   assert_different_registers(cache, index);
 459   get_cache_index_at_bcp(index, bcp_offset, index_size);
 460   movptr(cache, Address(rbp, frame::interpreter_frame_cache_offset * wordSize));
 461   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 462   // convert from field index to ConstantPoolCacheEntry index
 463   assert(exact_log2(in_words(ConstantPoolCacheEntry::size())) == 2, &quot;else change next line&quot;);
 464   shll(index, 2);
 465 }
 466 
 467 void InterpreterMacroAssembler::get_cache_and_index_and_bytecode_at_bcp(Register cache,
 468                                                                         Register index,
 469                                                                         Register bytecode,
 470                                                                         int byte_no,
 471                                                                         int bcp_offset,
 472                                                                         size_t index_size) {
 473   get_cache_and_index_at_bcp(cache, index, bcp_offset, index_size);
 474   // We use a 32-bit load here since the layout of 64-bit words on
 475   // little-endian machines allow us that.
 476   movl(bytecode, Address(cache, index, Address::times_ptr, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::indices_offset()));
 477   const int shift_count = (1 + byte_no) * BitsPerByte;
 478   assert((byte_no == TemplateTable::f1_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_1_shift) ||
 479          (byte_no == TemplateTable::f2_byte &amp;&amp; shift_count == ConstantPoolCacheEntry::bytecode_2_shift),
 480          &quot;correct shift count&quot;);
 481   shrl(bytecode, shift_count);
 482   assert(ConstantPoolCacheEntry::bytecode_1_mask == ConstantPoolCacheEntry::bytecode_2_mask, &quot;common mask&quot;);
 483   andl(bytecode, ConstantPoolCacheEntry::bytecode_1_mask);
 484 }
 485 
 486 void InterpreterMacroAssembler::get_cache_entry_pointer_at_bcp(Register cache,
 487                                                                Register tmp,
 488                                                                int bcp_offset,
 489                                                                size_t index_size) {
<a name="3" id="anc3"></a><span class="line-modified"> 490   assert(cache != tmp, &quot;must use different register&quot;);</span>

 491   get_cache_index_at_bcp(tmp, bcp_offset, index_size);
 492   assert(sizeof(ConstantPoolCacheEntry) == 4 * wordSize, &quot;adjust code below&quot;);
 493   // convert from field index to ConstantPoolCacheEntry index
 494   // and from word offset to byte offset
 495   assert(exact_log2(in_bytes(ConstantPoolCacheEntry::size_in_bytes())) == 2 + LogBytesPerWord, &quot;else change next line&quot;);
 496   shll(tmp, 2 + LogBytesPerWord);
 497   movptr(cache, Address(rbp, frame::interpreter_frame_cache_offset * wordSize));
 498   // skip past the header
 499   addptr(cache, in_bytes(ConstantPoolCache::base_offset()));
 500   addptr(cache, tmp);  // construct pointer to cache entry
 501 }
 502 
 503 // Load object from cpool-&gt;resolved_references(index)
<a name="4" id="anc4"></a><span class="line-modified"> 504 void InterpreterMacroAssembler::load_resolved_reference_at_index(</span>
<span class="line-modified"> 505                                            Register result, Register index, Register tmp) {</span>

 506   assert_different_registers(result, index);
 507 
 508   get_constant_pool(result);
 509   // load pointer for resolved_references[] objArray
 510   movptr(result, Address(result, ConstantPool::cache_offset_in_bytes()));
 511   movptr(result, Address(result, ConstantPoolCache::resolved_references_offset_in_bytes()));
 512   resolve_oop_handle(result, tmp);
 513   load_heap_oop(result, Address(result, index,
 514                                 UseCompressedOops ? Address::times_4 : Address::times_ptr,
 515                                 arrayOopDesc::base_offset_in_bytes(T_OBJECT)), tmp);
 516 }
 517 
 518 // load cpool-&gt;resolved_klass_at(index)
<a name="5" id="anc5"></a><span class="line-modified"> 519 void InterpreterMacroAssembler::load_resolved_klass_at_index(Register cpool,</span>
<span class="line-modified"> 520                                            Register index, Register klass) {</span>



 521   movw(index, Address(cpool, index, Address::times_ptr, sizeof(ConstantPool)));
 522   Register resolved_klasses = cpool;
 523   movptr(resolved_klasses, Address(cpool, ConstantPool::resolved_klasses_offset_in_bytes()));
 524   movptr(klass, Address(resolved_klasses, index, Address::times_ptr, Array&lt;Klass*&gt;::base_offset_in_bytes()));
 525 }
 526 
<a name="6" id="anc6"></a>














 527 // Generate a subtype check: branch to ok_is_subtype if sub_klass is a
 528 // subtype of super_klass.
 529 //
 530 // Args:
 531 //      rax: superklass
 532 //      Rsub_klass: subklass
 533 //
 534 // Kills:
 535 //      rcx, rdi
 536 void InterpreterMacroAssembler::gen_subtype_check(Register Rsub_klass,
 537                                                   Label&amp; ok_is_subtype) {
 538   assert(Rsub_klass != rax, &quot;rax holds superklass&quot;);
 539   LP64_ONLY(assert(Rsub_klass != r14, &quot;r14 holds locals&quot;);)
 540   LP64_ONLY(assert(Rsub_klass != r13, &quot;r13 holds bcp&quot;);)
 541   assert(Rsub_klass != rcx, &quot;rcx holds 2ndary super array length&quot;);
 542   assert(Rsub_klass != rdi, &quot;rdi holds 2ndary super array scan ptr&quot;);
 543 
 544   // Profile the not-null value&#39;s klass.
 545   profile_typecheck(rcx, Rsub_klass, rdi); // blows rcx, reloads rdi
 546 
 547   // Do the check.
 548   check_klass_subtype(Rsub_klass, rax, rcx, ok_is_subtype); // blows rcx
 549 
 550   // Profile the failure of the check.
 551   profile_typecheck_failed(rcx); // blows rcx
 552 }
 553 
 554 
 555 #ifndef _LP64
 556 void InterpreterMacroAssembler::f2ieee() {
 557   if (IEEEPrecision) {
 558     fstp_s(Address(rsp, 0));
 559     fld_s(Address(rsp, 0));
 560   }
 561 }
 562 
 563 
 564 void InterpreterMacroAssembler::d2ieee() {
 565   if (IEEEPrecision) {
 566     fstp_d(Address(rsp, 0));
 567     fld_d(Address(rsp, 0));
 568   }
 569 }
 570 #endif // _LP64
 571 
 572 // Java Expression Stack
 573 
 574 void InterpreterMacroAssembler::pop_ptr(Register r) {
 575   pop(r);
 576 }
 577 
 578 void InterpreterMacroAssembler::push_ptr(Register r) {
 579   push(r);
 580 }
 581 
 582 void InterpreterMacroAssembler::push_i(Register r) {
 583   push(r);
 584 }
 585 
 586 void InterpreterMacroAssembler::push_f(XMMRegister r) {
 587   subptr(rsp, wordSize);
 588   movflt(Address(rsp, 0), r);
 589 }
 590 
 591 void InterpreterMacroAssembler::pop_f(XMMRegister r) {
 592   movflt(r, Address(rsp, 0));
 593   addptr(rsp, wordSize);
 594 }
 595 
 596 void InterpreterMacroAssembler::push_d(XMMRegister r) {
 597   subptr(rsp, 2 * wordSize);
 598   movdbl(Address(rsp, 0), r);
 599 }
 600 
 601 void InterpreterMacroAssembler::pop_d(XMMRegister r) {
 602   movdbl(r, Address(rsp, 0));
 603   addptr(rsp, 2 * Interpreter::stackElementSize);
 604 }
 605 
 606 #ifdef _LP64
 607 void InterpreterMacroAssembler::pop_i(Register r) {
 608   // XXX can&#39;t use pop currently, upper half non clean
 609   movl(r, Address(rsp, 0));
 610   addptr(rsp, wordSize);
 611 }
 612 
 613 void InterpreterMacroAssembler::pop_l(Register r) {
 614   movq(r, Address(rsp, 0));
 615   addptr(rsp, 2 * Interpreter::stackElementSize);
 616 }
 617 
 618 void InterpreterMacroAssembler::push_l(Register r) {
 619   subptr(rsp, 2 * wordSize);
 620   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(0)), r         );
 621   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(1)), NULL_WORD );
 622 }
 623 
 624 void InterpreterMacroAssembler::pop(TosState state) {
 625   switch (state) {
 626   case atos: pop_ptr();                 break;
 627   case btos:
 628   case ztos:
 629   case ctos:
 630   case stos:
 631   case itos: pop_i();                   break;
 632   case ltos: pop_l();                   break;
 633   case ftos: pop_f(xmm0);               break;
 634   case dtos: pop_d(xmm0);               break;
 635   case vtos: /* nothing to do */        break;
 636   default:   ShouldNotReachHere();
 637   }
 638   verify_oop(rax, state);
 639 }
 640 
 641 void InterpreterMacroAssembler::push(TosState state) {
 642   verify_oop(rax, state);
 643   switch (state) {
 644   case atos: push_ptr();                break;
 645   case btos:
 646   case ztos:
 647   case ctos:
 648   case stos:
 649   case itos: push_i();                  break;
 650   case ltos: push_l();                  break;
 651   case ftos: push_f(xmm0);              break;
 652   case dtos: push_d(xmm0);              break;
 653   case vtos: /* nothing to do */        break;
 654   default  : ShouldNotReachHere();
 655   }
 656 }
 657 #else
 658 void InterpreterMacroAssembler::pop_i(Register r) {
 659   pop(r);
 660 }
 661 
 662 void InterpreterMacroAssembler::pop_l(Register lo, Register hi) {
 663   pop(lo);
 664   pop(hi);
 665 }
 666 
 667 void InterpreterMacroAssembler::pop_f() {
 668   fld_s(Address(rsp, 0));
 669   addptr(rsp, 1 * wordSize);
 670 }
 671 
 672 void InterpreterMacroAssembler::pop_d() {
 673   fld_d(Address(rsp, 0));
 674   addptr(rsp, 2 * wordSize);
 675 }
 676 
 677 
 678 void InterpreterMacroAssembler::pop(TosState state) {
 679   switch (state) {
 680     case atos: pop_ptr(rax);                                 break;
 681     case btos:                                               // fall through
 682     case ztos:                                               // fall through
 683     case ctos:                                               // fall through
 684     case stos:                                               // fall through
 685     case itos: pop_i(rax);                                   break;
 686     case ltos: pop_l(rax, rdx);                              break;
 687     case ftos:
 688       if (UseSSE &gt;= 1) {
 689         pop_f(xmm0);
 690       } else {
 691         pop_f();
 692       }
 693       break;
 694     case dtos:
 695       if (UseSSE &gt;= 2) {
 696         pop_d(xmm0);
 697       } else {
 698         pop_d();
 699       }
 700       break;
 701     case vtos: /* nothing to do */                           break;
 702     default  : ShouldNotReachHere();
 703   }
 704   verify_oop(rax, state);
 705 }
 706 
 707 
 708 void InterpreterMacroAssembler::push_l(Register lo, Register hi) {
 709   push(hi);
 710   push(lo);
 711 }
 712 
 713 void InterpreterMacroAssembler::push_f() {
 714   // Do not schedule for no AGI! Never write beyond rsp!
 715   subptr(rsp, 1 * wordSize);
 716   fstp_s(Address(rsp, 0));
 717 }
 718 
 719 void InterpreterMacroAssembler::push_d() {
 720   // Do not schedule for no AGI! Never write beyond rsp!
 721   subptr(rsp, 2 * wordSize);
 722   fstp_d(Address(rsp, 0));
 723 }
 724 
 725 
 726 void InterpreterMacroAssembler::push(TosState state) {
 727   verify_oop(rax, state);
 728   switch (state) {
 729     case atos: push_ptr(rax); break;
 730     case btos:                                               // fall through
 731     case ztos:                                               // fall through
 732     case ctos:                                               // fall through
 733     case stos:                                               // fall through
 734     case itos: push_i(rax);                                    break;
 735     case ltos: push_l(rax, rdx);                               break;
 736     case ftos:
 737       if (UseSSE &gt;= 1) {
 738         push_f(xmm0);
 739       } else {
 740         push_f();
 741       }
 742       break;
 743     case dtos:
 744       if (UseSSE &gt;= 2) {
 745         push_d(xmm0);
 746       } else {
 747         push_d();
 748       }
 749       break;
 750     case vtos: /* nothing to do */                             break;
 751     default  : ShouldNotReachHere();
 752   }
 753 }
 754 #endif // _LP64
 755 
 756 
 757 // Helpers for swap and dup
 758 void InterpreterMacroAssembler::load_ptr(int n, Register val) {
 759   movptr(val, Address(rsp, Interpreter::expr_offset_in_bytes(n)));
 760 }
 761 
 762 void InterpreterMacroAssembler::store_ptr(int n, Register val) {
 763   movptr(Address(rsp, Interpreter::expr_offset_in_bytes(n)), val);
 764 }
 765 
 766 
 767 void InterpreterMacroAssembler::prepare_to_jump_from_interpreted() {
 768   // set sender sp
 769   lea(_bcp_register, Address(rsp, wordSize));
 770   // record last_sp
 771   movptr(Address(rbp, frame::interpreter_frame_last_sp_offset * wordSize), _bcp_register);
 772 }
 773 
 774 
 775 // Jump to from_interpreted entry of a call unless single stepping is possible
 776 // in this thread in which case we must call the i2i entry
 777 void InterpreterMacroAssembler::jump_from_interpreted(Register method, Register temp) {
 778   prepare_to_jump_from_interpreted();
 779 
 780   if (JvmtiExport::can_post_interpreter_events()) {
 781     Label run_compiled_code;
 782     // JVMTI events, such as single-stepping, are implemented partly by avoiding running
 783     // compiled code in threads for which the event is enabled.  Check here for
 784     // interp_only_mode if these events CAN be enabled.
 785     // interp_only is an int, on little endian it is sufficient to test the byte only
 786     // Is a cmpl faster?
 787     LP64_ONLY(temp = r15_thread;)
 788     NOT_LP64(get_thread(temp);)
 789     cmpb(Address(temp, JavaThread::interp_only_mode_offset()), 0);
 790     jccb(Assembler::zero, run_compiled_code);
 791     jmp(Address(method, Method::interpreter_entry_offset()));
 792     bind(run_compiled_code);
 793   }
 794 
 795   jmp(Address(method, Method::from_interpreted_offset()));
 796 }
 797 
 798 // The following two routines provide a hook so that an implementation
 799 // can schedule the dispatch in two parts.  x86 does not do this.
 800 void InterpreterMacroAssembler::dispatch_prolog(TosState state, int step) {
 801   // Nothing x86 specific to be done here
 802 }
 803 
 804 void InterpreterMacroAssembler::dispatch_epilog(TosState state, int step) {
 805   dispatch_next(state, step);
 806 }
 807 
 808 void InterpreterMacroAssembler::dispatch_base(TosState state,
 809                                               address* table,
 810                                               bool verifyoop,
 811                                               bool generate_poll) {
 812   verify_FPU(1, state);
 813   if (VerifyActivationFrameSize) {
 814     Label L;
 815     mov(rcx, rbp);
 816     subptr(rcx, rsp);
 817     int32_t min_frame_size =
 818       (frame::link_offset - frame::interpreter_frame_initial_sp_offset) *
 819       wordSize;
 820     cmpptr(rcx, (int32_t)min_frame_size);
 821     jcc(Assembler::greaterEqual, L);
 822     stop(&quot;broken stack frame&quot;);
 823     bind(L);
 824   }
 825   if (verifyoop) {
 826     verify_oop(rax, state);
 827   }
 828 
 829   address* const safepoint_table = Interpreter::safept_table(state);
 830 #ifdef _LP64
 831   Label no_safepoint, dispatch;
 832   if (SafepointMechanism::uses_thread_local_poll() &amp;&amp; table != safepoint_table &amp;&amp; generate_poll) {
 833     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 834     testb(Address(r15_thread, Thread::polling_page_offset()), SafepointMechanism::poll_bit());
 835 
 836     jccb(Assembler::zero, no_safepoint);
 837     lea(rscratch1, ExternalAddress((address)safepoint_table));
 838     jmpb(dispatch);
 839   }
 840 
 841   bind(no_safepoint);
 842   lea(rscratch1, ExternalAddress((address)table));
 843   bind(dispatch);
 844   jmp(Address(rscratch1, rbx, Address::times_8));
 845 
 846 #else
 847   Address index(noreg, rbx, Address::times_ptr);
 848   if (SafepointMechanism::uses_thread_local_poll() &amp;&amp; table != safepoint_table &amp;&amp; generate_poll) {
 849     NOT_PRODUCT(block_comment(&quot;Thread-local Safepoint poll&quot;));
 850     Label no_safepoint;
 851     const Register thread = rcx;
 852     get_thread(thread);
 853     testb(Address(thread, Thread::polling_page_offset()), SafepointMechanism::poll_bit());
 854 
 855     jccb(Assembler::zero, no_safepoint);
 856     ArrayAddress dispatch_addr(ExternalAddress((address)safepoint_table), index);
 857     jump(dispatch_addr);
 858     bind(no_safepoint);
 859   }
 860 
 861   {
 862     ArrayAddress dispatch_addr(ExternalAddress((address)table), index);
 863     jump(dispatch_addr);
 864   }
 865 #endif // _LP64
 866 }
 867 
 868 void InterpreterMacroAssembler::dispatch_only(TosState state, bool generate_poll) {
 869   dispatch_base(state, Interpreter::dispatch_table(state), true, generate_poll);
 870 }
 871 
 872 void InterpreterMacroAssembler::dispatch_only_normal(TosState state) {
 873   dispatch_base(state, Interpreter::normal_table(state));
 874 }
 875 
 876 void InterpreterMacroAssembler::dispatch_only_noverify(TosState state) {
 877   dispatch_base(state, Interpreter::normal_table(state), false);
 878 }
 879 
 880 
 881 void InterpreterMacroAssembler::dispatch_next(TosState state, int step, bool generate_poll) {
 882   // load next bytecode (load before advancing _bcp_register to prevent AGI)
 883   load_unsigned_byte(rbx, Address(_bcp_register, step));
 884   // advance _bcp_register
 885   increment(_bcp_register, step);
 886   dispatch_base(state, Interpreter::dispatch_table(state), true, generate_poll);
 887 }
 888 
 889 void InterpreterMacroAssembler::dispatch_via(TosState state, address* table) {
 890   // load current bytecode
 891   load_unsigned_byte(rbx, Address(_bcp_register, 0));
 892   dispatch_base(state, table);
 893 }
 894 
 895 void InterpreterMacroAssembler::narrow(Register result) {
 896 
 897   // Get method-&gt;_constMethod-&gt;_result_type
 898   movptr(rcx, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
 899   movptr(rcx, Address(rcx, Method::const_offset()));
 900   load_unsigned_byte(rcx, Address(rcx, ConstMethod::result_type_offset()));
 901 
 902   Label done, notBool, notByte, notChar;
 903 
 904   // common case first
 905   cmpl(rcx, T_INT);
 906   jcc(Assembler::equal, done);
 907 
 908   // mask integer result to narrower return type.
 909   cmpl(rcx, T_BOOLEAN);
 910   jcc(Assembler::notEqual, notBool);
 911   andl(result, 0x1);
 912   jmp(done);
 913 
 914   bind(notBool);
 915   cmpl(rcx, T_BYTE);
 916   jcc(Assembler::notEqual, notByte);
 917   LP64_ONLY(movsbl(result, result);)
 918   NOT_LP64(shll(result, 24);)      // truncate upper 24 bits
 919   NOT_LP64(sarl(result, 24);)      // and sign-extend byte
 920   jmp(done);
 921 
 922   bind(notByte);
 923   cmpl(rcx, T_CHAR);
 924   jcc(Assembler::notEqual, notChar);
 925   LP64_ONLY(movzwl(result, result);)
 926   NOT_LP64(andl(result, 0xFFFF);)  // truncate upper 16 bits
 927   jmp(done);
 928 
 929   bind(notChar);
 930   // cmpl(rcx, T_SHORT);  // all that&#39;s left
 931   // jcc(Assembler::notEqual, done);
 932   LP64_ONLY(movswl(result, result);)
 933   NOT_LP64(shll(result, 16);)      // truncate upper 16 bits
 934   NOT_LP64(sarl(result, 16);)      // and sign-extend short
 935 
 936   // Nothing to do for T_INT
 937   bind(done);
 938 }
 939 
 940 // remove activation
 941 //
 942 // Unlock the receiver if this is a synchronized method.
 943 // Unlock any Java monitors from syncronized blocks.
 944 // Remove the activation from the stack.
 945 //
 946 // If there are locked Java monitors
 947 //    If throw_monitor_exception
 948 //       throws IllegalMonitorStateException
 949 //    Else if install_monitor_exception
 950 //       installs IllegalMonitorStateException
 951 //    Else
 952 //       no error processing
 953 void InterpreterMacroAssembler::remove_activation(
 954         TosState state,
 955         Register ret_addr,
 956         bool throw_monitor_exception,
 957         bool install_monitor_exception,
 958         bool notify_jvmdi) {
 959   // Note: Registers rdx xmm0 may be in use for the
 960   // result check if synchronized method
 961   Label unlocked, unlock, no_unlock;
 962 
 963   const Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
 964   const Register robj    = LP64_ONLY(c_rarg1) NOT_LP64(rdx);
 965   const Register rmon    = LP64_ONLY(c_rarg1) NOT_LP64(rcx);
 966                               // monitor pointers need different register
 967                               // because rdx may have the result in it
 968   NOT_LP64(get_thread(rcx);)
 969 
 970   // get the value of _do_not_unlock_if_synchronized into rdx
 971   const Address do_not_unlock_if_synchronized(rthread,
 972     in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
 973   movbool(rbx, do_not_unlock_if_synchronized);
 974   movbool(do_not_unlock_if_synchronized, false); // reset the flag
 975 
 976  // get method access flags
 977   movptr(rcx, Address(rbp, frame::interpreter_frame_method_offset * wordSize));
 978   movl(rcx, Address(rcx, Method::access_flags_offset()));
 979   testl(rcx, JVM_ACC_SYNCHRONIZED);
 980   jcc(Assembler::zero, unlocked);
 981 
 982   // Don&#39;t unlock anything if the _do_not_unlock_if_synchronized flag
 983   // is set.
 984   testbool(rbx);
 985   jcc(Assembler::notZero, no_unlock);
 986 
 987   // unlock monitor
 988   push(state); // save result
 989 
 990   // BasicObjectLock will be first in list, since this is a
 991   // synchronized method. However, need to check that the object has
 992   // not been unlocked by an explicit monitorexit bytecode.
 993   const Address monitor(rbp, frame::interpreter_frame_initial_sp_offset *
 994                         wordSize - (int) sizeof(BasicObjectLock));
 995   // We use c_rarg1/rdx so that if we go slow path it will be the correct
 996   // register for unlock_object to pass to VM directly
 997   lea(robj, monitor); // address of first monitor
 998 
 999   movptr(rax, Address(robj, BasicObjectLock::obj_offset_in_bytes()));
1000   testptr(rax, rax);
1001   jcc(Assembler::notZero, unlock);
1002 
1003   pop(state);
1004   if (throw_monitor_exception) {
1005     // Entry already unlocked, need to throw exception
1006     NOT_LP64(empty_FPU_stack();)  // remove possible return value from FPU-stack, otherwise stack could overflow
1007     call_VM(noreg, CAST_FROM_FN_PTR(address,
1008                    InterpreterRuntime::throw_illegal_monitor_state_exception));
1009     should_not_reach_here();
1010   } else {
1011     // Monitor already unlocked during a stack unroll. If requested,
1012     // install an illegal_monitor_state_exception.  Continue with
1013     // stack unrolling.
1014     if (install_monitor_exception) {
1015       NOT_LP64(empty_FPU_stack();)
1016       call_VM(noreg, CAST_FROM_FN_PTR(address,
1017                      InterpreterRuntime::new_illegal_monitor_state_exception));
1018     }
1019     jmp(unlocked);
1020   }
1021 
1022   bind(unlock);
1023   unlock_object(robj);
1024   pop(state);
1025 
1026   // Check that for block-structured locking (i.e., that all locked
1027   // objects has been unlocked)
1028   bind(unlocked);
1029 
1030   // rax, rdx: Might contain return value
1031 
1032   // Check that all monitors are unlocked
1033   {
1034     Label loop, exception, entry, restart;
1035     const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
1036     const Address monitor_block_top(
1037         rbp, frame::interpreter_frame_monitor_block_top_offset * wordSize);
1038     const Address monitor_block_bot(
1039         rbp, frame::interpreter_frame_initial_sp_offset * wordSize);
1040 
1041     bind(restart);
1042     // We use c_rarg1 so that if we go slow path it will be the correct
1043     // register for unlock_object to pass to VM directly
1044     movptr(rmon, monitor_block_top); // points to current entry, starting
1045                                   // with top-most entry
1046     lea(rbx, monitor_block_bot);  // points to word before bottom of
1047                                   // monitor block
1048     jmp(entry);
1049 
1050     // Entry already locked, need to throw exception
1051     bind(exception);
1052 
1053     if (throw_monitor_exception) {
1054       // Throw exception
1055       NOT_LP64(empty_FPU_stack();)
1056       MacroAssembler::call_VM(noreg,
1057                               CAST_FROM_FN_PTR(address, InterpreterRuntime::
1058                                    throw_illegal_monitor_state_exception));
1059       should_not_reach_here();
1060     } else {
1061       // Stack unrolling. Unlock object and install illegal_monitor_exception.
1062       // Unlock does not block, so don&#39;t have to worry about the frame.
1063       // We don&#39;t have to preserve c_rarg1 since we are going to throw an exception.
1064 
1065       push(state);
1066       mov(robj, rmon);   // nop if robj and rmon are the same
1067       unlock_object(robj);
1068       pop(state);
1069 
1070       if (install_monitor_exception) {
1071         NOT_LP64(empty_FPU_stack();)
1072         call_VM(noreg, CAST_FROM_FN_PTR(address,
1073                                         InterpreterRuntime::
1074                                         new_illegal_monitor_state_exception));
1075       }
1076 
1077       jmp(restart);
1078     }
1079 
1080     bind(loop);
1081     // check if current entry is used
1082     cmpptr(Address(rmon, BasicObjectLock::obj_offset_in_bytes()), (int32_t) NULL);
1083     jcc(Assembler::notEqual, exception);
1084 
1085     addptr(rmon, entry_size); // otherwise advance to next entry
1086     bind(entry);
1087     cmpptr(rmon, rbx); // check if bottom reached
1088     jcc(Assembler::notEqual, loop); // if not at bottom then check this entry
1089   }
1090 
1091   bind(no_unlock);
1092 
1093   // jvmti support
1094   if (notify_jvmdi) {
1095     notify_method_exit(state, NotifyJVMTI);    // preserve TOSCA
1096   } else {
1097     notify_method_exit(state, SkipNotifyJVMTI); // preserve TOSCA
1098   }
1099 
1100   // remove activation
1101   // get sender sp
1102   movptr(rbx,
1103          Address(rbp, frame::interpreter_frame_sender_sp_offset * wordSize));
1104   if (StackReservedPages &gt; 0) {
1105     // testing if reserved zone needs to be re-enabled
1106     Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
1107     Label no_reserved_zone_enabling;
1108 
1109     NOT_LP64(get_thread(rthread);)
1110 
1111     cmpl(Address(rthread, JavaThread::stack_guard_state_offset()), JavaThread::stack_guard_enabled);
1112     jcc(Assembler::equal, no_reserved_zone_enabling);
1113 
1114     cmpptr(rbx, Address(rthread, JavaThread::reserved_stack_activation_offset()));
1115     jcc(Assembler::lessEqual, no_reserved_zone_enabling);
1116 
1117     call_VM_leaf(
1118       CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone), rthread);
1119     call_VM(noreg, CAST_FROM_FN_PTR(address,
1120                    InterpreterRuntime::throw_delayed_StackOverflowError));
1121     should_not_reach_here();
1122 
1123     bind(no_reserved_zone_enabling);
1124   }
1125   leave();                           // remove frame anchor
1126   pop(ret_addr);                     // get return address
1127   mov(rsp, rbx);                     // set sp to sender sp
1128 }
1129 
1130 void InterpreterMacroAssembler::get_method_counters(Register method,
1131                                                     Register mcs, Label&amp; skip) {
1132   Label has_counters;
1133   movptr(mcs, Address(method, Method::method_counters_offset()));
1134   testptr(mcs, mcs);
1135   jcc(Assembler::notZero, has_counters);
1136   call_VM(noreg, CAST_FROM_FN_PTR(address,
1137           InterpreterRuntime::build_method_counters), method);
1138   movptr(mcs, Address(method,Method::method_counters_offset()));
1139   testptr(mcs, mcs);
1140   jcc(Assembler::zero, skip); // No MethodCounters allocated, OutOfMemory
1141   bind(has_counters);
1142 }
1143 
1144 
1145 // Lock object
1146 //
1147 // Args:
1148 //      rdx, c_rarg1: BasicObjectLock to be used for locking
1149 //
1150 // Kills:
1151 //      rax, rbx
1152 void InterpreterMacroAssembler::lock_object(Register lock_reg) {
1153   assert(lock_reg == LP64_ONLY(c_rarg1) NOT_LP64(rdx),
1154          &quot;The argument is only for looks. It must be c_rarg1&quot;);
1155 
1156   TSAN_RUNTIME_ONLY(push_ptr(lock_reg));
1157   if (UseHeavyMonitors) {
1158     call_VM(noreg,
1159             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1160             lock_reg);
1161   } else {
1162     Label done;
1163 
1164     const Register swap_reg = rax; // Must use rax for cmpxchg instruction
1165     const Register tmp_reg = rbx; // Will be passed to biased_locking_enter to avoid a
1166                                   // problematic case where tmp_reg = no_reg.
1167     const Register obj_reg = LP64_ONLY(c_rarg3) NOT_LP64(rcx); // Will contain the oop
1168 
1169     const int obj_offset = BasicObjectLock::obj_offset_in_bytes();
1170     const int lock_offset = BasicObjectLock::lock_offset_in_bytes ();
1171     const int mark_offset = lock_offset +
1172                             BasicLock::displaced_header_offset_in_bytes();
1173 
1174     Label slow_case;
1175 
1176     // Load object pointer into obj_reg
1177     movptr(obj_reg, Address(lock_reg, obj_offset));
1178 
1179     if (UseBiasedLocking) {
1180       biased_locking_enter(lock_reg, obj_reg, swap_reg, tmp_reg, false, done, &amp;slow_case);
1181     }
1182 
1183     // Load immediate 1 into swap_reg %rax
1184     movl(swap_reg, (int32_t)1);
1185 
1186     // Load (object-&gt;mark() | 1) into swap_reg %rax
1187     orptr(swap_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1188 
1189     // Save (object-&gt;mark() | 1) into BasicLock&#39;s displaced header
1190     movptr(Address(lock_reg, mark_offset), swap_reg);
1191 
1192     assert(lock_offset == 0,
1193            &quot;displaced header must be first word in BasicObjectLock&quot;);
1194 
1195     lock();
1196     cmpxchgptr(lock_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1197     if (PrintBiasedLockingStatistics) {
1198       cond_inc32(Assembler::zero,
1199                  ExternalAddress((address) BiasedLocking::fast_path_entry_count_addr()));
1200     }
1201     jcc(Assembler::zero, done);
1202 
1203     const int zero_bits = LP64_ONLY(7) NOT_LP64(3);
1204 
1205     // Test if the oopMark is an obvious stack pointer, i.e.,
1206     //  1) (mark &amp; zero_bits) == 0, and
1207     //  2) rsp &lt;= mark &lt; mark + os::pagesize()
1208     //
1209     // These 3 tests can be done by evaluating the following
1210     // expression: ((mark - rsp) &amp; (zero_bits - os::vm_page_size())),
1211     // assuming both stack pointer and pagesize have their
1212     // least significant bits clear.
1213     // NOTE: the oopMark is in swap_reg %rax as the result of cmpxchg
1214     subptr(swap_reg, rsp);
1215     andptr(swap_reg, zero_bits - os::vm_page_size());
1216 
1217     // Save the test result, for recursive case, the result is zero
1218     movptr(Address(lock_reg, mark_offset), swap_reg);
1219 
1220     if (PrintBiasedLockingStatistics) {
1221       cond_inc32(Assembler::zero,
1222                  ExternalAddress((address) BiasedLocking::fast_path_entry_count_addr()));
1223     }
1224     jcc(Assembler::zero, done);
1225 
1226     bind(slow_case);
1227 
1228     // Call the runtime routine for slow case
1229     call_VM(noreg,
1230             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorenter),
1231             lock_reg);
1232 
1233     bind(done);
1234   }
1235 
1236   TSAN_RUNTIME_ONLY(
1237     pop_ptr(lock_reg);
1238     pusha();
1239     call_VM(noreg,
1240             CAST_FROM_FN_PTR(address, SharedRuntime::tsan_interp_lock),
1241             lock_reg);
1242     popa();
1243   );
1244 }
1245 
1246 
1247 // Unlocks an object. Used in monitorexit bytecode and
1248 // remove_activation.  Throws an IllegalMonitorException if object is
1249 // not locked by current thread.
1250 //
1251 // Args:
1252 //      rdx, c_rarg1: BasicObjectLock for lock
1253 //
1254 // Kills:
1255 //      rax
1256 //      c_rarg0, c_rarg1, c_rarg2, c_rarg3, ... (param regs)
1257 //      rscratch1 (scratch reg)
1258 // rax, rbx, rcx, rdx
1259 void InterpreterMacroAssembler::unlock_object(Register lock_reg) {
1260   assert(lock_reg == LP64_ONLY(c_rarg1) NOT_LP64(rdx),
1261          &quot;The argument is only for looks. It must be c_rarg1&quot;);
1262 
1263   TSAN_RUNTIME_ONLY(
1264     pusha();
1265     call_VM(noreg,
1266             CAST_FROM_FN_PTR(address, SharedRuntime::tsan_interp_unlock),
1267             lock_reg);
1268     popa();
1269   );
1270 
1271   if (UseHeavyMonitors) {
1272     call_VM(noreg,
1273             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
1274             lock_reg);
1275   } else {
1276     Label done;
1277 
1278     const Register swap_reg   = rax;  // Must use rax for cmpxchg instruction
1279     const Register header_reg = LP64_ONLY(c_rarg2) NOT_LP64(rbx);  // Will contain the old oopMark
1280     const Register obj_reg    = LP64_ONLY(c_rarg3) NOT_LP64(rcx);  // Will contain the oop
1281 
1282     save_bcp(); // Save in case of exception
1283 
1284     // Convert from BasicObjectLock structure to object and BasicLock
1285     // structure Store the BasicLock address into %rax
1286     lea(swap_reg, Address(lock_reg, BasicObjectLock::lock_offset_in_bytes()));
1287 
1288     // Load oop into obj_reg(%c_rarg3)
1289     movptr(obj_reg, Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()));
1290 
1291     // Free entry
1292     movptr(Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()), (int32_t)NULL_WORD);
1293 
1294     if (UseBiasedLocking) {
1295       biased_locking_exit(obj_reg, header_reg, done);
1296     }
1297 
1298     // Load the old header from BasicLock structure
1299     movptr(header_reg, Address(swap_reg,
1300                                BasicLock::displaced_header_offset_in_bytes()));
1301 
1302     // Test for recursion
1303     testptr(header_reg, header_reg);
1304 
1305     // zero for recursive case
1306     jcc(Assembler::zero, done);
1307 
1308     // Atomic swap back the old header
1309     lock();
1310     cmpxchgptr(header_reg, Address(obj_reg, oopDesc::mark_offset_in_bytes()));
1311 
1312     // zero for simple unlock of a stack-lock case
1313     jcc(Assembler::zero, done);
1314 
1315     // Call the runtime routine for slow case.
1316     movptr(Address(lock_reg, BasicObjectLock::obj_offset_in_bytes()),
1317          obj_reg); // restore obj
1318     call_VM(noreg,
1319             CAST_FROM_FN_PTR(address, InterpreterRuntime::monitorexit),
1320             lock_reg);
1321 
1322     bind(done);
1323 
1324     restore_bcp();
1325   }
1326 }
1327 
1328 void InterpreterMacroAssembler::test_method_data_pointer(Register mdp,
1329                                                          Label&amp; zero_continue) {
1330   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1331   movptr(mdp, Address(rbp, frame::interpreter_frame_mdp_offset * wordSize));
1332   testptr(mdp, mdp);
1333   jcc(Assembler::zero, zero_continue);
1334 }
1335 
1336 
1337 // Set the method data pointer for the current bcp.
1338 void InterpreterMacroAssembler::set_method_data_pointer_for_bcp() {
1339   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1340   Label set_mdp;
1341   push(rax);
1342   push(rbx);
1343 
1344   get_method(rbx);
1345   // Test MDO to avoid the call if it is NULL.
1346   movptr(rax, Address(rbx, in_bytes(Method::method_data_offset())));
1347   testptr(rax, rax);
1348   jcc(Assembler::zero, set_mdp);
1349   // rbx: method
1350   // _bcp_register: bcp
1351   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::bcp_to_di), rbx, _bcp_register);
1352   // rax: mdi
1353   // mdo is guaranteed to be non-zero here, we checked for it before the call.
1354   movptr(rbx, Address(rbx, in_bytes(Method::method_data_offset())));
1355   addptr(rbx, in_bytes(MethodData::data_offset()));
1356   addptr(rax, rbx);
1357   bind(set_mdp);
1358   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), rax);
1359   pop(rbx);
1360   pop(rax);
1361 }
1362 
1363 void InterpreterMacroAssembler::verify_method_data_pointer() {
1364   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1365 #ifdef ASSERT
1366   Label verify_continue;
1367   push(rax);
1368   push(rbx);
1369   Register arg3_reg = LP64_ONLY(c_rarg3) NOT_LP64(rcx);
1370   Register arg2_reg = LP64_ONLY(c_rarg2) NOT_LP64(rdx);
1371   push(arg3_reg);
1372   push(arg2_reg);
1373   test_method_data_pointer(arg3_reg, verify_continue); // If mdp is zero, continue
1374   get_method(rbx);
1375 
1376   // If the mdp is valid, it will point to a DataLayout header which is
1377   // consistent with the bcp.  The converse is highly probable also.
1378   load_unsigned_short(arg2_reg,
1379                       Address(arg3_reg, in_bytes(DataLayout::bci_offset())));
1380   addptr(arg2_reg, Address(rbx, Method::const_offset()));
1381   lea(arg2_reg, Address(arg2_reg, ConstMethod::codes_offset()));
1382   cmpptr(arg2_reg, _bcp_register);
1383   jcc(Assembler::equal, verify_continue);
1384   // rbx: method
1385   // _bcp_register: bcp
1386   // c_rarg3: mdp
1387   call_VM_leaf(CAST_FROM_FN_PTR(address, InterpreterRuntime::verify_mdp),
1388                rbx, _bcp_register, arg3_reg);
1389   bind(verify_continue);
1390   pop(arg2_reg);
1391   pop(arg3_reg);
1392   pop(rbx);
1393   pop(rax);
1394 #endif // ASSERT
1395 }
1396 
1397 
1398 void InterpreterMacroAssembler::set_mdp_data_at(Register mdp_in,
1399                                                 int constant,
1400                                                 Register value) {
1401   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1402   Address data(mdp_in, constant);
1403   movptr(data, value);
1404 }
1405 
1406 
1407 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1408                                                       int constant,
1409                                                       bool decrement) {
1410   // Counter address
1411   Address data(mdp_in, constant);
1412 
1413   increment_mdp_data_at(data, decrement);
1414 }
1415 
1416 void InterpreterMacroAssembler::increment_mdp_data_at(Address data,
1417                                                       bool decrement) {
1418   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1419   // %%% this does 64bit counters at best it is wasting space
1420   // at worst it is a rare bug when counters overflow
1421 
1422   if (decrement) {
1423     // Decrement the register.  Set condition codes.
1424     addptr(data, (int32_t) -DataLayout::counter_increment);
1425     // If the decrement causes the counter to overflow, stay negative
1426     Label L;
1427     jcc(Assembler::negative, L);
1428     addptr(data, (int32_t) DataLayout::counter_increment);
1429     bind(L);
1430   } else {
1431     assert(DataLayout::counter_increment == 1,
1432            &quot;flow-free idiom only works with 1&quot;);
1433     // Increment the register.  Set carry flag.
1434     addptr(data, DataLayout::counter_increment);
1435     // If the increment causes the counter to overflow, pull back by 1.
1436     sbbptr(data, (int32_t)0);
1437   }
1438 }
1439 
1440 
1441 void InterpreterMacroAssembler::increment_mdp_data_at(Register mdp_in,
1442                                                       Register reg,
1443                                                       int constant,
1444                                                       bool decrement) {
1445   Address data(mdp_in, reg, Address::times_1, constant);
1446 
1447   increment_mdp_data_at(data, decrement);
1448 }
1449 
1450 void InterpreterMacroAssembler::set_mdp_flag_at(Register mdp_in,
1451                                                 int flag_byte_constant) {
1452   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1453   int header_offset = in_bytes(DataLayout::flags_offset());
1454   int header_bits = flag_byte_constant;
1455   // Set the flag
1456   orb(Address(mdp_in, header_offset), header_bits);
1457 }
1458 
1459 
1460 
1461 void InterpreterMacroAssembler::test_mdp_data_at(Register mdp_in,
1462                                                  int offset,
1463                                                  Register value,
1464                                                  Register test_value_out,
1465                                                  Label&amp; not_equal_continue) {
1466   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1467   if (test_value_out == noreg) {
1468     cmpptr(value, Address(mdp_in, offset));
1469   } else {
1470     // Put the test value into a register, so caller can use it:
1471     movptr(test_value_out, Address(mdp_in, offset));
1472     cmpptr(test_value_out, value);
1473   }
1474   jcc(Assembler::notEqual, not_equal_continue);
1475 }
1476 
1477 
1478 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1479                                                      int offset_of_disp) {
1480   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1481   Address disp_address(mdp_in, offset_of_disp);
1482   addptr(mdp_in, disp_address);
1483   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1484 }
1485 
1486 
1487 void InterpreterMacroAssembler::update_mdp_by_offset(Register mdp_in,
1488                                                      Register reg,
1489                                                      int offset_of_disp) {
1490   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1491   Address disp_address(mdp_in, reg, Address::times_1, offset_of_disp);
1492   addptr(mdp_in, disp_address);
1493   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1494 }
1495 
1496 
1497 void InterpreterMacroAssembler::update_mdp_by_constant(Register mdp_in,
1498                                                        int constant) {
1499   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1500   addptr(mdp_in, constant);
1501   movptr(Address(rbp, frame::interpreter_frame_mdp_offset * wordSize), mdp_in);
1502 }
1503 
1504 
1505 void InterpreterMacroAssembler::update_mdp_for_ret(Register return_bci) {
1506   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1507   push(return_bci); // save/restore across call_VM
1508   call_VM(noreg,
1509           CAST_FROM_FN_PTR(address, InterpreterRuntime::update_mdp_for_ret),
1510           return_bci);
1511   pop(return_bci);
1512 }
1513 
1514 
1515 void InterpreterMacroAssembler::profile_taken_branch(Register mdp,
1516                                                      Register bumped_count) {
1517   if (ProfileInterpreter) {
1518     Label profile_continue;
1519 
1520     // If no method data exists, go to profile_continue.
1521     // Otherwise, assign to mdp
1522     test_method_data_pointer(mdp, profile_continue);
1523 
1524     // We are taking a branch.  Increment the taken count.
1525     // We inline increment_mdp_data_at to return bumped_count in a register
1526     //increment_mdp_data_at(mdp, in_bytes(JumpData::taken_offset()));
1527     Address data(mdp, in_bytes(JumpData::taken_offset()));
1528     movptr(bumped_count, data);
1529     assert(DataLayout::counter_increment == 1,
1530             &quot;flow-free idiom only works with 1&quot;);
1531     addptr(bumped_count, DataLayout::counter_increment);
1532     sbbptr(bumped_count, 0);
1533     movptr(data, bumped_count); // Store back out
1534 
1535     // The method data pointer needs to be updated to reflect the new target.
1536     update_mdp_by_offset(mdp, in_bytes(JumpData::displacement_offset()));
1537     bind(profile_continue);
1538   }
1539 }
1540 
1541 
1542 void InterpreterMacroAssembler::profile_not_taken_branch(Register mdp) {
1543   if (ProfileInterpreter) {
1544     Label profile_continue;
1545 
1546     // If no method data exists, go to profile_continue.
1547     test_method_data_pointer(mdp, profile_continue);
1548 
1549     // We are taking a branch.  Increment the not taken count.
1550     increment_mdp_data_at(mdp, in_bytes(BranchData::not_taken_offset()));
1551 
1552     // The method data pointer needs to be updated to correspond to
1553     // the next bytecode
1554     update_mdp_by_constant(mdp, in_bytes(BranchData::branch_data_size()));
1555     bind(profile_continue);
1556   }
1557 }
1558 
1559 void InterpreterMacroAssembler::profile_call(Register mdp) {
1560   if (ProfileInterpreter) {
1561     Label profile_continue;
1562 
1563     // If no method data exists, go to profile_continue.
1564     test_method_data_pointer(mdp, profile_continue);
1565 
1566     // We are making a call.  Increment the count.
1567     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1568 
1569     // The method data pointer needs to be updated to reflect the new target.
1570     update_mdp_by_constant(mdp, in_bytes(CounterData::counter_data_size()));
1571     bind(profile_continue);
1572   }
1573 }
1574 
1575 
1576 void InterpreterMacroAssembler::profile_final_call(Register mdp) {
1577   if (ProfileInterpreter) {
1578     Label profile_continue;
1579 
1580     // If no method data exists, go to profile_continue.
1581     test_method_data_pointer(mdp, profile_continue);
1582 
1583     // We are making a call.  Increment the count.
1584     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1585 
1586     // The method data pointer needs to be updated to reflect the new target.
1587     update_mdp_by_constant(mdp,
1588                            in_bytes(VirtualCallData::
1589                                     virtual_call_data_size()));
1590     bind(profile_continue);
1591   }
1592 }
1593 
1594 
1595 void InterpreterMacroAssembler::profile_virtual_call(Register receiver,
1596                                                      Register mdp,
1597                                                      Register reg2,
1598                                                      bool receiver_can_be_null) {
1599   if (ProfileInterpreter) {
1600     Label profile_continue;
1601 
1602     // If no method data exists, go to profile_continue.
1603     test_method_data_pointer(mdp, profile_continue);
1604 
1605     Label skip_receiver_profile;
1606     if (receiver_can_be_null) {
1607       Label not_null;
1608       testptr(receiver, receiver);
1609       jccb(Assembler::notZero, not_null);
1610       // We are making a call.  Increment the count for null receiver.
1611       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1612       jmp(skip_receiver_profile);
1613       bind(not_null);
1614     }
1615 
1616     // Record the receiver type.
1617     record_klass_in_profile(receiver, mdp, reg2, true);
1618     bind(skip_receiver_profile);
1619 
1620     // The method data pointer needs to be updated to reflect the new target.
1621 #if INCLUDE_JVMCI
1622     if (MethodProfileWidth == 0) {
1623       update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1624     }
1625 #else // INCLUDE_JVMCI
1626     update_mdp_by_constant(mdp,
1627                            in_bytes(VirtualCallData::
1628                                     virtual_call_data_size()));
1629 #endif // INCLUDE_JVMCI
1630     bind(profile_continue);
1631   }
1632 }
1633 
1634 #if INCLUDE_JVMCI
1635 void InterpreterMacroAssembler::profile_called_method(Register method, Register mdp, Register reg2) {
1636   assert_different_registers(method, mdp, reg2);
1637   if (ProfileInterpreter &amp;&amp; MethodProfileWidth &gt; 0) {
1638     Label profile_continue;
1639 
1640     // If no method data exists, go to profile_continue.
1641     test_method_data_pointer(mdp, profile_continue);
1642 
1643     Label done;
1644     record_item_in_profile_helper(method, mdp, reg2, 0, done, MethodProfileWidth,
1645       &amp;VirtualCallData::method_offset, &amp;VirtualCallData::method_count_offset, in_bytes(VirtualCallData::nonprofiled_receiver_count_offset()));
1646     bind(done);
1647 
1648     update_mdp_by_constant(mdp, in_bytes(VirtualCallData::virtual_call_data_size()));
1649     bind(profile_continue);
1650   }
1651 }
1652 #endif // INCLUDE_JVMCI
1653 
1654 // This routine creates a state machine for updating the multi-row
1655 // type profile at a virtual call site (or other type-sensitive bytecode).
1656 // The machine visits each row (of receiver/count) until the receiver type
1657 // is found, or until it runs out of rows.  At the same time, it remembers
1658 // the location of the first empty row.  (An empty row records null for its
1659 // receiver, and can be allocated for a newly-observed receiver type.)
1660 // Because there are two degrees of freedom in the state, a simple linear
1661 // search will not work; it must be a decision tree.  Hence this helper
1662 // function is recursive, to generate the required tree structured code.
1663 // It&#39;s the interpreter, so we are trading off code space for speed.
1664 // See below for example code.
1665 void InterpreterMacroAssembler::record_klass_in_profile_helper(
1666                                         Register receiver, Register mdp,
1667                                         Register reg2, int start_row,
1668                                         Label&amp; done, bool is_virtual_call) {
1669   if (TypeProfileWidth == 0) {
1670     if (is_virtual_call) {
1671       increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1672     }
1673 #if INCLUDE_JVMCI
1674     else if (EnableJVMCI) {
1675       increment_mdp_data_at(mdp, in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset()));
1676     }
1677 #endif // INCLUDE_JVMCI
1678   } else {
1679     int non_profiled_offset = -1;
1680     if (is_virtual_call) {
1681       non_profiled_offset = in_bytes(CounterData::count_offset());
1682     }
1683 #if INCLUDE_JVMCI
1684     else if (EnableJVMCI) {
1685       non_profiled_offset = in_bytes(ReceiverTypeData::nonprofiled_receiver_count_offset());
1686     }
1687 #endif // INCLUDE_JVMCI
1688 
1689     record_item_in_profile_helper(receiver, mdp, reg2, 0, done, TypeProfileWidth,
1690         &amp;VirtualCallData::receiver_offset, &amp;VirtualCallData::receiver_count_offset, non_profiled_offset);
1691   }
1692 }
1693 
1694 void InterpreterMacroAssembler::record_item_in_profile_helper(Register item, Register mdp,
1695                                         Register reg2, int start_row, Label&amp; done, int total_rows,
1696                                         OffsetFunction item_offset_fn, OffsetFunction item_count_offset_fn,
1697                                         int non_profiled_offset) {
1698   int last_row = total_rows - 1;
1699   assert(start_row &lt;= last_row, &quot;must be work left to do&quot;);
1700   // Test this row for both the item and for null.
1701   // Take any of three different outcomes:
1702   //   1. found item =&gt; increment count and goto done
1703   //   2. found null =&gt; keep looking for case 1, maybe allocate this cell
1704   //   3. found something else =&gt; keep looking for cases 1 and 2
1705   // Case 3 is handled by a recursive call.
1706   for (int row = start_row; row &lt;= last_row; row++) {
1707     Label next_test;
1708     bool test_for_null_also = (row == start_row);
1709 
1710     // See if the item is item[n].
1711     int item_offset = in_bytes(item_offset_fn(row));
1712     test_mdp_data_at(mdp, item_offset, item,
1713                      (test_for_null_also ? reg2 : noreg),
1714                      next_test);
1715     // (Reg2 now contains the item from the CallData.)
1716 
1717     // The item is item[n].  Increment count[n].
1718     int count_offset = in_bytes(item_count_offset_fn(row));
1719     increment_mdp_data_at(mdp, count_offset);
1720     jmp(done);
1721     bind(next_test);
1722 
1723     if (test_for_null_also) {
1724       // Failed the equality check on item[n]...  Test for null.
1725       testptr(reg2, reg2);
1726       if (start_row == last_row) {
1727         // The only thing left to do is handle the null case.
1728         if (non_profiled_offset &gt;= 0) {
1729           Label found_null;
1730           jccb(Assembler::zero, found_null);
1731           // Item did not match any saved item and there is no empty row for it.
1732           // Increment total counter to indicate polymorphic case.
1733           increment_mdp_data_at(mdp, non_profiled_offset);
1734           jmp(done);
1735           bind(found_null);
1736         } else {
1737           jcc(Assembler::notZero, done);
1738         }
1739         break;
1740       }
1741       Label found_null;
1742       // Since null is rare, make it be the branch-taken case.
1743       jcc(Assembler::zero, found_null);
1744 
1745       // Put all the &quot;Case 3&quot; tests here.
1746       record_item_in_profile_helper(item, mdp, reg2, start_row + 1, done, total_rows,
1747         item_offset_fn, item_count_offset_fn, non_profiled_offset);
1748 
1749       // Found a null.  Keep searching for a matching item,
1750       // but remember that this is an empty (unused) slot.
1751       bind(found_null);
1752     }
1753   }
1754 
1755   // In the fall-through case, we found no matching item, but we
1756   // observed the item[start_row] is NULL.
1757 
1758   // Fill in the item field and increment the count.
1759   int item_offset = in_bytes(item_offset_fn(start_row));
1760   set_mdp_data_at(mdp, item_offset, item);
1761   int count_offset = in_bytes(item_count_offset_fn(start_row));
1762   movl(reg2, DataLayout::counter_increment);
1763   set_mdp_data_at(mdp, count_offset, reg2);
1764   if (start_row &gt; 0) {
1765     jmp(done);
1766   }
1767 }
1768 
1769 // Example state machine code for three profile rows:
1770 //   // main copy of decision tree, rooted at row[1]
1771 //   if (row[0].rec == rec) { row[0].incr(); goto done; }
1772 //   if (row[0].rec != NULL) {
1773 //     // inner copy of decision tree, rooted at row[1]
1774 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1775 //     if (row[1].rec != NULL) {
1776 //       // degenerate decision tree, rooted at row[2]
1777 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1778 //       if (row[2].rec != NULL) { count.incr(); goto done; } // overflow
1779 //       row[2].init(rec); goto done;
1780 //     } else {
1781 //       // remember row[1] is empty
1782 //       if (row[2].rec == rec) { row[2].incr(); goto done; }
1783 //       row[1].init(rec); goto done;
1784 //     }
1785 //   } else {
1786 //     // remember row[0] is empty
1787 //     if (row[1].rec == rec) { row[1].incr(); goto done; }
1788 //     if (row[2].rec == rec) { row[2].incr(); goto done; }
1789 //     row[0].init(rec); goto done;
1790 //   }
1791 //   done:
1792 
1793 void InterpreterMacroAssembler::record_klass_in_profile(Register receiver,
1794                                                         Register mdp, Register reg2,
1795                                                         bool is_virtual_call) {
1796   assert(ProfileInterpreter, &quot;must be profiling&quot;);
1797   Label done;
1798 
1799   record_klass_in_profile_helper(receiver, mdp, reg2, 0, done, is_virtual_call);
1800 
1801   bind (done);
1802 }
1803 
1804 void InterpreterMacroAssembler::profile_ret(Register return_bci,
1805                                             Register mdp) {
1806   if (ProfileInterpreter) {
1807     Label profile_continue;
1808     uint row;
1809 
1810     // If no method data exists, go to profile_continue.
1811     test_method_data_pointer(mdp, profile_continue);
1812 
1813     // Update the total ret count.
1814     increment_mdp_data_at(mdp, in_bytes(CounterData::count_offset()));
1815 
1816     for (row = 0; row &lt; RetData::row_limit(); row++) {
1817       Label next_test;
1818 
1819       // See if return_bci is equal to bci[n]:
1820       test_mdp_data_at(mdp,
1821                        in_bytes(RetData::bci_offset(row)),
1822                        return_bci, noreg,
1823                        next_test);
1824 
1825       // return_bci is equal to bci[n].  Increment the count.
1826       increment_mdp_data_at(mdp, in_bytes(RetData::bci_count_offset(row)));
1827 
1828       // The method data pointer needs to be updated to reflect the new target.
1829       update_mdp_by_offset(mdp,
1830                            in_bytes(RetData::bci_displacement_offset(row)));
1831       jmp(profile_continue);
1832       bind(next_test);
1833     }
1834 
1835     update_mdp_for_ret(return_bci);
1836 
1837     bind(profile_continue);
1838   }
1839 }
1840 
1841 
1842 void InterpreterMacroAssembler::profile_null_seen(Register mdp) {
1843   if (ProfileInterpreter) {
1844     Label profile_continue;
1845 
1846     // If no method data exists, go to profile_continue.
1847     test_method_data_pointer(mdp, profile_continue);
1848 
1849     set_mdp_flag_at(mdp, BitData::null_seen_byte_constant());
1850 
1851     // The method data pointer needs to be updated.
1852     int mdp_delta = in_bytes(BitData::bit_data_size());
1853     if (TypeProfileCasts) {
1854       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1855     }
1856     update_mdp_by_constant(mdp, mdp_delta);
1857 
1858     bind(profile_continue);
1859   }
1860 }
1861 
1862 
1863 void InterpreterMacroAssembler::profile_typecheck_failed(Register mdp) {
1864   if (ProfileInterpreter &amp;&amp; TypeProfileCasts) {
1865     Label profile_continue;
1866 
1867     // If no method data exists, go to profile_continue.
1868     test_method_data_pointer(mdp, profile_continue);
1869 
1870     int count_offset = in_bytes(CounterData::count_offset());
1871     // Back up the address, since we have already bumped the mdp.
1872     count_offset -= in_bytes(VirtualCallData::virtual_call_data_size());
1873 
1874     // *Decrement* the counter.  We expect to see zero or small negatives.
1875     increment_mdp_data_at(mdp, count_offset, true);
1876 
1877     bind (profile_continue);
1878   }
1879 }
1880 
1881 
1882 void InterpreterMacroAssembler::profile_typecheck(Register mdp, Register klass, Register reg2) {
1883   if (ProfileInterpreter) {
1884     Label profile_continue;
1885 
1886     // If no method data exists, go to profile_continue.
1887     test_method_data_pointer(mdp, profile_continue);
1888 
1889     // The method data pointer needs to be updated.
1890     int mdp_delta = in_bytes(BitData::bit_data_size());
1891     if (TypeProfileCasts) {
1892       mdp_delta = in_bytes(VirtualCallData::virtual_call_data_size());
1893 
1894       // Record the object type.
1895       record_klass_in_profile(klass, mdp, reg2, false);
1896       NOT_LP64(assert(reg2 == rdi, &quot;we know how to fix this blown reg&quot;);)
1897       NOT_LP64(restore_locals();)         // Restore EDI
1898     }
1899     update_mdp_by_constant(mdp, mdp_delta);
1900 
1901     bind(profile_continue);
1902   }
1903 }
1904 
1905 
1906 void InterpreterMacroAssembler::profile_switch_default(Register mdp) {
1907   if (ProfileInterpreter) {
1908     Label profile_continue;
1909 
1910     // If no method data exists, go to profile_continue.
1911     test_method_data_pointer(mdp, profile_continue);
1912 
1913     // Update the default case count
1914     increment_mdp_data_at(mdp,
1915                           in_bytes(MultiBranchData::default_count_offset()));
1916 
1917     // The method data pointer needs to be updated.
1918     update_mdp_by_offset(mdp,
1919                          in_bytes(MultiBranchData::
1920                                   default_displacement_offset()));
1921 
1922     bind(profile_continue);
1923   }
1924 }
1925 
1926 
1927 void InterpreterMacroAssembler::profile_switch_case(Register index,
1928                                                     Register mdp,
1929                                                     Register reg2) {
1930   if (ProfileInterpreter) {
1931     Label profile_continue;
1932 
1933     // If no method data exists, go to profile_continue.
1934     test_method_data_pointer(mdp, profile_continue);
1935 
1936     // Build the base (index * per_case_size_in_bytes()) +
1937     // case_array_offset_in_bytes()
1938     movl(reg2, in_bytes(MultiBranchData::per_case_size()));
1939     imulptr(index, reg2); // XXX l ?
1940     addptr(index, in_bytes(MultiBranchData::case_array_offset())); // XXX l ?
1941 
1942     // Update the case count
1943     increment_mdp_data_at(mdp,
1944                           index,
1945                           in_bytes(MultiBranchData::relative_count_offset()));
1946 
1947     // The method data pointer needs to be updated.
1948     update_mdp_by_offset(mdp,
1949                          index,
1950                          in_bytes(MultiBranchData::
1951                                   relative_displacement_offset()));
1952 
1953     bind(profile_continue);
1954   }
1955 }
1956 
1957 
1958 
1959 void InterpreterMacroAssembler::verify_oop(Register reg, TosState state) {
1960   if (state == atos) {
1961     MacroAssembler::verify_oop(reg);
1962   }
1963 }
1964 
1965 void InterpreterMacroAssembler::verify_FPU(int stack_depth, TosState state) {
1966 #ifndef _LP64
1967   if ((state == ftos &amp;&amp; UseSSE &lt; 1) ||
1968       (state == dtos &amp;&amp; UseSSE &lt; 2)) {
1969     MacroAssembler::verify_FPU(stack_depth);
1970   }
1971 #endif
1972 }
1973 
1974 // Jump if ((*counter_addr += increment) &amp; mask) satisfies the condition.
1975 void InterpreterMacroAssembler::increment_mask_and_jump(Address counter_addr,
1976                                                         int increment, Address mask,
1977                                                         Register scratch, bool preloaded,
1978                                                         Condition cond, Label* where) {
1979   if (!preloaded) {
1980     movl(scratch, counter_addr);
1981   }
1982   incrementl(scratch, increment);
1983   movl(counter_addr, scratch);
1984   andl(scratch, mask);
1985   if (where != NULL) {
1986     jcc(cond, *where);
1987   }
1988 }
1989 
1990 void InterpreterMacroAssembler::notify_method_entry() {
1991   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
1992   // track stack depth.  If it is possible to enter interp_only_mode we add
1993   // the code to check if the event should be sent.
1994   Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
1995   Register rarg = LP64_ONLY(c_rarg1) NOT_LP64(rbx);
1996   if (JvmtiExport::can_post_interpreter_events()) {
1997     Label L;
1998     NOT_LP64(get_thread(rthread);)
1999     movl(rdx, Address(rthread, JavaThread::interp_only_mode_offset()));
2000     testl(rdx, rdx);
2001     jcc(Assembler::zero, L);
2002     call_VM(noreg, CAST_FROM_FN_PTR(address,
2003                                     InterpreterRuntime::post_method_entry));
2004     bind(L);
2005   }
2006 
2007   {
2008     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2009     NOT_LP64(get_thread(rthread);)
2010     get_method(rarg);
2011     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_entry),
2012                  rthread, rarg);
2013   }
2014 
2015   TSAN_RUNTIME_ONLY(call_VM(noreg,
2016                             CAST_FROM_FN_PTR(address,
2017                                              SharedRuntime::tsan_interp_method_entry)));
2018 
2019   // RedefineClasses() tracing support for obsolete method entry
2020   if (log_is_enabled(Trace, redefine, class, obsolete)) {
2021     NOT_LP64(get_thread(rthread);)
2022     get_method(rarg);
2023     call_VM_leaf(
2024       CAST_FROM_FN_PTR(address, SharedRuntime::rc_trace_method_entry),
2025       rthread, rarg);
2026   }
2027 }
2028 
2029 
2030 void InterpreterMacroAssembler::notify_method_exit(
2031     TosState state, NotifyMethodExitMode mode) {
2032   // Whenever JVMTI is interp_only_mode, method entry/exit events are sent to
2033   // track stack depth.  If it is possible to enter interp_only_mode we add
2034   // the code to check if the event should be sent.
2035   Register rthread = LP64_ONLY(r15_thread) NOT_LP64(rcx);
2036   Register rarg = LP64_ONLY(c_rarg1) NOT_LP64(rbx);
2037   if (mode == NotifyJVMTI &amp;&amp; JvmtiExport::can_post_interpreter_events()) {
2038     Label L;
2039     // Note: frame::interpreter_frame_result has a dependency on how the
2040     // method result is saved across the call to post_method_exit. If this
2041     // is changed then the interpreter_frame_result implementation will
2042     // need to be updated too.
2043 
2044     // template interpreter will leave the result on the top of the stack.
2045     push(state);
2046     NOT_LP64(get_thread(rthread);)
2047     movl(rdx, Address(rthread, JavaThread::interp_only_mode_offset()));
2048     testl(rdx, rdx);
2049     jcc(Assembler::zero, L);
2050     call_VM(noreg,
2051             CAST_FROM_FN_PTR(address, InterpreterRuntime::post_method_exit));
2052     bind(L);
2053     pop(state);
2054   }
2055 
2056   TSAN_RUNTIME_ONLY(
2057     push(state);
2058     call_VM_leaf(CAST_FROM_FN_PTR(address,
2059                                   SharedRuntime::tsan_interp_method_exit));
2060     pop(state);
2061   );
2062 
2063   {
2064     SkipIfEqual skip(this, &amp;DTraceMethodProbes, false);
2065     push(state);
2066     NOT_LP64(get_thread(rthread);)
2067     get_method(rarg);
2068     call_VM_leaf(CAST_FROM_FN_PTR(address, SharedRuntime::dtrace_method_exit),
2069                  rthread, rarg);
2070     pop(state);
2071   }
2072 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>