<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/x86/frame_x86.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 1997, 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  *
 23  */
 24 
 25 #include &quot;precompiled.hpp&quot;
 26 #include &quot;interpreter/interpreter.hpp&quot;
 27 #include &quot;memory/resourceArea.hpp&quot;
<a name="2" id="anc2"></a><span class="line-modified"> 28 #include &quot;oops/markOop.hpp&quot;</span>

 29 #include &quot;oops/method.hpp&quot;
 30 #include &quot;oops/oop.inline.hpp&quot;
 31 #include &quot;prims/methodHandles.hpp&quot;
 32 #include &quot;runtime/frame.inline.hpp&quot;
 33 #include &quot;runtime/handles.inline.hpp&quot;
 34 #include &quot;runtime/javaCalls.hpp&quot;
 35 #include &quot;runtime/monitorChunk.hpp&quot;
 36 #include &quot;runtime/os.inline.hpp&quot;
 37 #include &quot;runtime/signature.hpp&quot;
 38 #include &quot;runtime/stubCodeGenerator.hpp&quot;
 39 #include &quot;runtime/stubRoutines.hpp&quot;
 40 #include &quot;vmreg_x86.inline.hpp&quot;
 41 #ifdef COMPILER1
 42 #include &quot;c1/c1_Runtime1.hpp&quot;
 43 #include &quot;runtime/vframeArray.hpp&quot;
 44 #endif
 45 
 46 #ifdef ASSERT
 47 void RegisterMap::check_location_valid() {
 48 }
 49 #endif
 50 
 51 // Profiling/safepoint support
 52 
 53 bool frame::safe_for_sender(JavaThread *thread) {
 54   address   sp = (address)_sp;
 55   address   fp = (address)_fp;
 56   address   unextended_sp = (address)_unextended_sp;
 57 
 58   // consider stack guards when trying to determine &quot;safe&quot; stack pointers
<a name="3" id="anc3"></a><span class="line-removed"> 59   static size_t stack_guard_size = os::uses_stack_guard_pages() ?</span>
<span class="line-removed"> 60     JavaThread::stack_red_zone_size() + JavaThread::stack_yellow_zone_size() : 0;</span>
<span class="line-removed"> 61   size_t usable_stack_size = thread-&gt;stack_size() - stack_guard_size;</span>
<span class="line-removed"> 62 </span>
 63   // sp must be within the usable part of the stack (not in guards)
<a name="4" id="anc4"></a><span class="line-modified"> 64   bool sp_safe = (sp &lt; thread-&gt;stack_base()) &amp;&amp;</span>
<span class="line-removed"> 65                  (sp &gt;= thread-&gt;stack_base() - usable_stack_size);</span>
<span class="line-removed"> 66 </span>
<span class="line-removed"> 67 </span>
<span class="line-removed"> 68   if (!sp_safe) {</span>
 69     return false;
 70   }
 71 
 72   // unextended sp must be within the stack and above or equal sp
 73   bool unextended_sp_safe = (unextended_sp &lt; thread-&gt;stack_base()) &amp;&amp;
 74                             (unextended_sp &gt;= sp);
 75 
 76   if (!unextended_sp_safe) {
 77     return false;
 78   }
 79 
 80   // an fp must be within the stack and above (but not equal) sp
 81   // second evaluation on fp+ is added to handle situation where fp is -1
 82   bool fp_safe = (fp &lt; thread-&gt;stack_base() &amp;&amp; (fp &gt; sp) &amp;&amp; (((fp + (return_addr_offset * sizeof(void*))) &lt; thread-&gt;stack_base())));
 83 
 84   // We know sp/unextended_sp are safe only fp is questionable here
 85 
 86   // If the current frame is known to the code cache then we can attempt to
 87   // to construct the sender and do some validation of it. This goes a long way
 88   // toward eliminating issues when we get in frame construction code
 89 
 90   if (_cb != NULL ) {
 91 
 92     // First check if frame is complete and tester is reliable
 93     // Unfortunately we can only check frame complete for runtime stubs and nmethod
 94     // other generic buffer blobs are more problematic so we just assume they are
 95     // ok. adapter blobs never have a frame complete and are never ok.
 96 
 97     if (!_cb-&gt;is_frame_complete_at(_pc)) {
 98       if (_cb-&gt;is_compiled() || _cb-&gt;is_adapter_blob() || _cb-&gt;is_runtime_stub()) {
 99         return false;
100       }
101     }
102 
103     // Could just be some random pointer within the codeBlob
104     if (!_cb-&gt;code_contains(_pc)) {
105       return false;
106     }
107 
108     // Entry frame checks
109     if (is_entry_frame()) {
110       // an entry frame must have a valid fp.
111       return fp_safe &amp;&amp; is_entry_frame_valid(thread);
112     }
113 
114     intptr_t* sender_sp = NULL;
115     intptr_t* sender_unextended_sp = NULL;
116     address   sender_pc = NULL;
117     intptr_t* saved_fp =  NULL;
118 
119     if (is_interpreted_frame()) {
120       // fp must be safe
121       if (!fp_safe) {
122         return false;
123       }
124 
125       sender_pc = (address) this-&gt;fp()[return_addr_offset];
126       // for interpreted frames, the value below is the sender &quot;raw&quot; sp,
127       // which can be different from the sender unextended sp (the sp seen
128       // by the sender) because of current frame local variables
129       sender_sp = (intptr_t*) addr_at(sender_sp_offset);
130       sender_unextended_sp = (intptr_t*) this-&gt;fp()[interpreter_frame_sender_sp_offset];
131       saved_fp = (intptr_t*) this-&gt;fp()[link_offset];
132 
133     } else {
134       // must be some sort of compiled/runtime frame
135       // fp does not have to be safe (although it could be check for c1?)
136 
137       // check for a valid frame_size, otherwise we are unlikely to get a valid sender_pc
138       if (_cb-&gt;frame_size() &lt;= 0) {
139         return false;
140       }
141 
142       sender_sp = _unextended_sp + _cb-&gt;frame_size();
143       // Is sender_sp safe?
144       if ((address)sender_sp &gt;= thread-&gt;stack_base()) {
145         return false;
146       }
147       sender_unextended_sp = sender_sp;
148       // On Intel the return_address is always the word on the stack
149       sender_pc = (address) *(sender_sp-1);
150       // Note: frame::sender_sp_offset is only valid for compiled frame
151       saved_fp = (intptr_t*) *(sender_sp - frame::sender_sp_offset);
152     }
153 
154 
155     // If the potential sender is the interpreter then we can do some more checking
156     if (Interpreter::contains(sender_pc)) {
157 
158       // ebp is always saved in a recognizable place in any code we generate. However
159       // only if the sender is interpreted/call_stub (c1 too?) are we certain that the saved ebp
160       // is really a frame pointer.
161 
162       bool saved_fp_safe = ((address)saved_fp &lt; thread-&gt;stack_base()) &amp;&amp; (saved_fp &gt; sender_sp);
163 
164       if (!saved_fp_safe) {
165         return false;
166       }
167 
168       // construct the potential sender
169 
170       frame sender(sender_sp, sender_unextended_sp, saved_fp, sender_pc);
171 
172       return sender.is_interpreted_frame_valid(thread);
173 
174     }
175 
176     // We must always be able to find a recognizable pc
177     CodeBlob* sender_blob = CodeCache::find_blob_unsafe(sender_pc);
178     if (sender_pc == NULL ||  sender_blob == NULL) {
179       return false;
180     }
181 
182     // Could be a zombie method
183     if (sender_blob-&gt;is_zombie() || sender_blob-&gt;is_unloaded()) {
184       return false;
185     }
186 
187     // Could just be some random pointer within the codeBlob
188     if (!sender_blob-&gt;code_contains(sender_pc)) {
189       return false;
190     }
191 
192     // We should never be able to see an adapter if the current frame is something from code cache
193     if (sender_blob-&gt;is_adapter_blob()) {
194       return false;
195     }
196 
197     // Could be the call_stub
198     if (StubRoutines::returns_to_call_stub(sender_pc)) {
199       bool saved_fp_safe = ((address)saved_fp &lt; thread-&gt;stack_base()) &amp;&amp; (saved_fp &gt; sender_sp);
200 
201       if (!saved_fp_safe) {
202         return false;
203       }
204 
205       // construct the potential sender
206 
207       frame sender(sender_sp, sender_unextended_sp, saved_fp, sender_pc);
208 
209       // Validate the JavaCallWrapper an entry frame must have
210       address jcw = (address)sender.entry_frame_call_wrapper();
211 
212       bool jcw_safe = (jcw &lt; thread-&gt;stack_base()) &amp;&amp; (jcw &gt; (address)sender.fp());
213 
214       return jcw_safe;
215     }
216 
217     CompiledMethod* nm = sender_blob-&gt;as_compiled_method_or_null();
218     if (nm != NULL) {
219         if (nm-&gt;is_deopt_mh_entry(sender_pc) || nm-&gt;is_deopt_entry(sender_pc) ||
220             nm-&gt;method()-&gt;is_method_handle_intrinsic()) {
221             return false;
222         }
223     }
224 
225     // If the frame size is 0 something (or less) is bad because every nmethod has a non-zero frame size
226     // because the return address counts against the callee&#39;s frame.
227 
228     if (sender_blob-&gt;frame_size() &lt;= 0) {
229       assert(!sender_blob-&gt;is_compiled(), &quot;should count return address at least&quot;);
230       return false;
231     }
232 
233     // We should never be able to see anything here except an nmethod. If something in the
234     // code cache (current frame) is called by an entity within the code cache that entity
235     // should not be anything but the call stub (already covered), the interpreter (already covered)
236     // or an nmethod.
237 
238     if (!sender_blob-&gt;is_compiled()) {
239         return false;
240     }
241 
242     // Could put some more validation for the potential non-interpreted sender
243     // frame we&#39;d create by calling sender if I could think of any. Wait for next crash in forte...
244 
245     // One idea is seeing if the sender_pc we have is one that we&#39;d expect to call to current cb
246 
247     // We&#39;ve validated the potential sender that would be created
248     return true;
249   }
250 
251   // Must be native-compiled frame. Since sender will try and use fp to find
252   // linkages it must be safe
253 
254   if (!fp_safe) {
255     return false;
256   }
257 
258   // Will the pc we fetch be non-zero (which we&#39;ll find at the oldest frame)
259 
260   if ( (address) this-&gt;fp()[return_addr_offset] == NULL) return false;
261 
262 
263   // could try and do some more potential verification of native frame if we could think of some...
264 
265   return true;
266 
267 }
268 
269 
270 void frame::patch_pc(Thread* thread, address pc) {
271   address* pc_addr = &amp;(((address*) sp())[-1]);
272   if (TracePcPatching) {
273     tty-&gt;print_cr(&quot;patch_pc at address &quot; INTPTR_FORMAT &quot; [&quot; INTPTR_FORMAT &quot; -&gt; &quot; INTPTR_FORMAT &quot;]&quot;,
274                   p2i(pc_addr), p2i(*pc_addr), p2i(pc));
275   }
276   // Either the return address is the original one or we are going to
277   // patch in the same address that&#39;s already there.
278   assert(_pc == *pc_addr || pc == *pc_addr, &quot;must be&quot;);
279   *pc_addr = pc;
280   _cb = CodeCache::find_blob(pc);
281   address original_pc = CompiledMethod::get_deopt_original_pc(this);
282   if (original_pc != NULL) {
283     assert(original_pc == _pc, &quot;expected original PC to be stored before patching&quot;);
284     _deopt_state = is_deoptimized;
285     // leave _pc as is
286   } else {
287     _deopt_state = not_deoptimized;
288     _pc = pc;
289   }
290 }
291 
292 bool frame::is_interpreted_frame() const  {
293   return Interpreter::contains(pc());
294 }
295 
296 int frame::frame_size(RegisterMap* map) const {
297   frame sender = this-&gt;sender(map);
298   return sender.sp() - sp();
299 }
300 
301 intptr_t* frame::entry_frame_argument_at(int offset) const {
302   // convert offset to index to deal with tsi
303   int index = (Interpreter::expr_offset_in_bytes(offset)/wordSize);
304   // Entry frame&#39;s arguments are always in relation to unextended_sp()
305   return &amp;unextended_sp()[index];
306 }
307 
308 // sender_sp
309 
310 intptr_t* frame::interpreter_frame_sender_sp() const {
311   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
312   return (intptr_t*) at(interpreter_frame_sender_sp_offset);
313 }
314 
315 void frame::set_interpreter_frame_sender_sp(intptr_t* sender_sp) {
316   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
317   ptr_at_put(interpreter_frame_sender_sp_offset, (intptr_t) sender_sp);
318 }
319 
320 
321 // monitor elements
322 
323 BasicObjectLock* frame::interpreter_frame_monitor_begin() const {
324   return (BasicObjectLock*) addr_at(interpreter_frame_monitor_block_bottom_offset);
325 }
326 
327 BasicObjectLock* frame::interpreter_frame_monitor_end() const {
328   BasicObjectLock* result = (BasicObjectLock*) *addr_at(interpreter_frame_monitor_block_top_offset);
329   // make sure the pointer points inside the frame
330   assert(sp() &lt;= (intptr_t*) result, &quot;monitor end should be above the stack pointer&quot;);
331   assert((intptr_t*) result &lt; fp(),  &quot;monitor end should be strictly below the frame pointer&quot;);
332   return result;
333 }
334 
335 void frame::interpreter_frame_set_monitor_end(BasicObjectLock* value) {
336   *((BasicObjectLock**)addr_at(interpreter_frame_monitor_block_top_offset)) = value;
337 }
338 
339 // Used by template based interpreter deoptimization
340 void frame::interpreter_frame_set_last_sp(intptr_t* sp) {
341     *((intptr_t**)addr_at(interpreter_frame_last_sp_offset)) = sp;
342 }
343 
344 frame frame::sender_for_entry_frame(RegisterMap* map) const {
345   assert(map != NULL, &quot;map must be set&quot;);
346   // Java frame called from C; skip all C frames and return top C
347   // frame of that chunk as the sender
348   JavaFrameAnchor* jfa = entry_frame_call_wrapper()-&gt;anchor();
349   assert(!entry_frame_is_first(), &quot;next Java fp must be non zero&quot;);
350   assert(jfa-&gt;last_Java_sp() &gt; sp(), &quot;must be above this frame on stack&quot;);
351   // Since we are walking the stack now this nested anchor is obviously walkable
352   // even if it wasn&#39;t when it was stacked.
353   if (!jfa-&gt;walkable()) {
354     // Capture _last_Java_pc (if needed) and mark anchor walkable.
355     jfa-&gt;capture_last_Java_pc();
356   }
357   map-&gt;clear();
358   assert(map-&gt;include_argument_oops(), &quot;should be set by clear&quot;);
359   vmassert(jfa-&gt;last_Java_pc() != NULL, &quot;not walkable&quot;);
360   frame fr(jfa-&gt;last_Java_sp(), jfa-&gt;last_Java_fp(), jfa-&gt;last_Java_pc());
361   return fr;
362 }
363 
364 //------------------------------------------------------------------------------
365 // frame::verify_deopt_original_pc
366 //
367 // Verifies the calculated original PC of a deoptimization PC for the
368 // given unextended SP.
369 #ifdef ASSERT
370 void frame::verify_deopt_original_pc(CompiledMethod* nm, intptr_t* unextended_sp) {
371   frame fr;
372 
373   // This is ugly but it&#39;s better than to change {get,set}_original_pc
374   // to take an SP value as argument.  And it&#39;s only a debugging
375   // method anyway.
376   fr._unextended_sp = unextended_sp;
377 
378   address original_pc = nm-&gt;get_original_pc(&amp;fr);
379   assert(nm-&gt;insts_contains_inclusive(original_pc),
380          &quot;original PC must be in the main code section of the the compiled method (or must be immediately following it)&quot;);
381 }
382 #endif
383 
384 //------------------------------------------------------------------------------
385 // frame::adjust_unextended_sp
386 #ifdef ASSERT
387 void frame::adjust_unextended_sp() {
388   // On x86, sites calling method handle intrinsics and lambda forms are treated
389   // as any other call site. Therefore, no special action is needed when we are
390   // returning to any of these call sites.
391 
392   if (_cb != NULL) {
393     CompiledMethod* sender_cm = _cb-&gt;as_compiled_method_or_null();
394     if (sender_cm != NULL) {
395       // If the sender PC is a deoptimization point, get the original PC.
396       if (sender_cm-&gt;is_deopt_entry(_pc) ||
397           sender_cm-&gt;is_deopt_mh_entry(_pc)) {
398         verify_deopt_original_pc(sender_cm, _unextended_sp);
399       }
400     }
401   }
402 }
403 #endif
404 
405 //------------------------------------------------------------------------------
406 // frame::update_map_with_saved_link
407 void frame::update_map_with_saved_link(RegisterMap* map, intptr_t** link_addr) {
408   // The interpreter and compiler(s) always save EBP/RBP in a known
409   // location on entry. We must record where that location is
410   // so this if EBP/RBP was live on callout from c2 we can find
411   // the saved copy no matter what it called.
412 
413   // Since the interpreter always saves EBP/RBP if we record where it is then
414   // we don&#39;t have to always save EBP/RBP on entry and exit to c2 compiled
415   // code, on entry will be enough.
416   map-&gt;set_location(rbp-&gt;as_VMReg(), (address) link_addr);
417 #ifdef AMD64
418   // this is weird &quot;H&quot; ought to be at a higher address however the
419   // oopMaps seems to have the &quot;H&quot; regs at the same address and the
420   // vanilla register.
421   // XXXX make this go away
422   if (true) {
423     map-&gt;set_location(rbp-&gt;as_VMReg()-&gt;next(), (address) link_addr);
424   }
425 #endif // AMD64
426 }
427 
428 
429 //------------------------------------------------------------------------------
430 // frame::sender_for_interpreter_frame
431 frame frame::sender_for_interpreter_frame(RegisterMap* map) const {
432   // SP is the raw SP from the sender after adapter or interpreter
433   // extension.
434   intptr_t* sender_sp = this-&gt;sender_sp();
435 
436   // This is the sp before any possible extension (adapter/locals).
437   intptr_t* unextended_sp = interpreter_frame_sender_sp();
438 
439 #if COMPILER2_OR_JVMCI
440   if (map-&gt;update_map()) {
441     update_map_with_saved_link(map, (intptr_t**) addr_at(link_offset));
442   }
443 #endif // COMPILER2_OR_JVMCI
444 
445   return frame(sender_sp, unextended_sp, link(), sender_pc());
446 }
447 
448 
449 //------------------------------------------------------------------------------
450 // frame::sender_for_compiled_frame
451 frame frame::sender_for_compiled_frame(RegisterMap* map) const {
452   assert(map != NULL, &quot;map must be set&quot;);
453 
454   // frame owned by optimizing compiler
455   assert(_cb-&gt;frame_size() &gt;= 0, &quot;must have non-zero frame size&quot;);
456   intptr_t* sender_sp = unextended_sp() + _cb-&gt;frame_size();
457   intptr_t* unextended_sp = sender_sp;
458 
459   // On Intel the return_address is always the word on the stack
460   address sender_pc = (address) *(sender_sp-1);
461 
462   // This is the saved value of EBP which may or may not really be an FP.
463   // It is only an FP if the sender is an interpreter frame (or C1?).
464   intptr_t** saved_fp_addr = (intptr_t**) (sender_sp - frame::sender_sp_offset);
465 
466   if (map-&gt;update_map()) {
467     // Tell GC to use argument oopmaps for some runtime stubs that need it.
468     // For C1, the runtime stub might not have oop maps, so set this flag
469     // outside of update_register_map.
470     map-&gt;set_include_argument_oops(_cb-&gt;caller_must_gc_arguments(map-&gt;thread()));
471     if (_cb-&gt;oop_maps() != NULL) {
472       OopMapSet::update_register_map(this, map);
473     }
474 
475     // Since the prolog does the save and restore of EBP there is no oopmap
476     // for it so we must fill in its location as if there was an oopmap entry
477     // since if our caller was compiled code there could be live jvm state in it.
478     update_map_with_saved_link(map, saved_fp_addr);
479   }
480 
481   assert(sender_sp != sp(), &quot;must have changed&quot;);
482   return frame(sender_sp, unextended_sp, *saved_fp_addr, sender_pc);
483 }
484 
485 
486 //------------------------------------------------------------------------------
487 // frame::sender
488 frame frame::sender(RegisterMap* map) const {
489   // Default is we done have to follow them. The sender_for_xxx will
490   // update it accordingly
491   map-&gt;set_include_argument_oops(false);
492 
493   if (is_entry_frame())       return sender_for_entry_frame(map);
494   if (is_interpreted_frame()) return sender_for_interpreter_frame(map);
495   assert(_cb == CodeCache::find_blob(pc()),&quot;Must be the same&quot;);
496 
497   if (_cb != NULL) {
498     return sender_for_compiled_frame(map);
499   }
500   // Must be native-compiled frame, i.e. the marshaling code for native
501   // methods that exists in the core system.
502   return frame(sender_sp(), link(), sender_pc());
503 }
504 
505 bool frame::is_interpreted_frame_valid(JavaThread* thread) const {
506   assert(is_interpreted_frame(), &quot;Not an interpreted frame&quot;);
507   // These are reasonable sanity checks
508   if (fp() == 0 || (intptr_t(fp()) &amp; (wordSize-1)) != 0) {
509     return false;
510   }
511   if (sp() == 0 || (intptr_t(sp()) &amp; (wordSize-1)) != 0) {
512     return false;
513   }
514   if (fp() + interpreter_frame_initial_sp_offset &lt; sp()) {
515     return false;
516   }
517   // These are hacks to keep us out of trouble.
518   // The problem with these is that they mask other problems
519   if (fp() &lt;= sp()) {        // this attempts to deal with unsigned comparison above
520     return false;
521   }
522 
523   // do some validation of frame elements
524   // first the method
525 
526   Method* m = *interpreter_frame_method_addr();
527 
528   // validate the method we&#39;d find in this potential sender
529   if (!Method::is_valid_method(m)) return false;
530 
531   // stack frames shouldn&#39;t be much larger than max_stack elements
532   // this test requires the use the unextended_sp which is the sp as seen by
533   // the current frame, and not sp which is the &quot;raw&quot; pc which could point
534   // further because of local variables of the callee method inserted after
535   // method arguments
536   if (fp() - unextended_sp() &gt; 1024 + m-&gt;max_stack()*Interpreter::stackElementSize) {
537     return false;
538   }
539 
540   // validate bci/bcp
541 
542   address bcp = interpreter_frame_bcp();
543   if (m-&gt;validate_bci_from_bcp(bcp) &lt; 0) {
544     return false;
545   }
546 
547   // validate ConstantPoolCache*
548   ConstantPoolCache* cp = *interpreter_frame_cache_addr();
<a name="5" id="anc5"></a><span class="line-modified">549   if (cp == NULL || !cp-&gt;is_metaspace_object()) return false;</span>
550 
551   // validate locals
552 
553   address locals =  (address) *interpreter_frame_locals_addr();
554 
<a name="6" id="anc6"></a><span class="line-modified">555   if (locals &gt; thread-&gt;stack_base() || locals &lt; (address) fp()) return false;</span>
556 
557   // We&#39;d have to be pretty unlucky to be mislead at this point
558   return true;
559 }
560 
561 BasicType frame::interpreter_frame_result(oop* oop_result, jvalue* value_result) {
562   assert(is_interpreted_frame(), &quot;interpreted frame expected&quot;);
563   Method* method = interpreter_frame_method();
564   BasicType type = method-&gt;result_type();
565 
566   intptr_t* tos_addr;
567   if (method-&gt;is_native()) {
568     // Prior to calling into the runtime to report the method_exit the possible
569     // return value is pushed to the native stack. If the result is a jfloat/jdouble
570     // then ST0 is saved before EAX/EDX. See the note in generate_native_result
571     tos_addr = (intptr_t*)sp();
572     if (type == T_FLOAT || type == T_DOUBLE) {
573     // QQQ seems like this code is equivalent on the two platforms
574 #ifdef AMD64
575       // This is times two because we do a push(ltos) after pushing XMM0
576       // and that takes two interpreter stack slots.
577       tos_addr += 2 * Interpreter::stackElementWords;
578 #else
579       tos_addr += 2;
580 #endif // AMD64
581     }
582   } else {
583     tos_addr = (intptr_t*)interpreter_frame_tos_address();
584   }
585 
586   switch (type) {
587     case T_OBJECT  :
588     case T_ARRAY   : {
589       oop obj;
590       if (method-&gt;is_native()) {
591         obj = cast_to_oop(at(interpreter_frame_oop_temp_offset));
592       } else {
593         oop* obj_p = (oop*)tos_addr;
594         obj = (obj_p == NULL) ? (oop)NULL : *obj_p;
595       }
596       assert(obj == NULL || Universe::heap()-&gt;is_in(obj), &quot;sanity check&quot;);
597       *oop_result = obj;
598       break;
599     }
600     case T_BOOLEAN : value_result-&gt;z = *(jboolean*)tos_addr; break;
601     case T_BYTE    : value_result-&gt;b = *(jbyte*)tos_addr; break;
602     case T_CHAR    : value_result-&gt;c = *(jchar*)tos_addr; break;
603     case T_SHORT   : value_result-&gt;s = *(jshort*)tos_addr; break;
604     case T_INT     : value_result-&gt;i = *(jint*)tos_addr; break;
605     case T_LONG    : value_result-&gt;j = *(jlong*)tos_addr; break;
606     case T_FLOAT   : {
607 #ifdef AMD64
608         value_result-&gt;f = *(jfloat*)tos_addr;
609 #else
610       if (method-&gt;is_native()) {
611         jdouble d = *(jdouble*)tos_addr;  // Result was in ST0 so need to convert to jfloat
612         value_result-&gt;f = (jfloat)d;
613       } else {
614         value_result-&gt;f = *(jfloat*)tos_addr;
615       }
616 #endif // AMD64
617       break;
618     }
619     case T_DOUBLE  : value_result-&gt;d = *(jdouble*)tos_addr; break;
620     case T_VOID    : /* Nothing to do */ break;
621     default        : ShouldNotReachHere();
622   }
623 
624   return type;
625 }
626 
627 
628 intptr_t* frame::interpreter_frame_tos_at(jint offset) const {
629   int index = (Interpreter::expr_offset_in_bytes(offset)/wordSize);
630   return &amp;interpreter_frame_tos_address()[index];
631 }
632 
633 #ifndef PRODUCT
634 
635 #define DESCRIBE_FP_OFFSET(name) \
636   values.describe(frame_no, fp() + frame::name##_offset, #name)
637 
638 void frame::describe_pd(FrameValues&amp; values, int frame_no) {
639   if (is_interpreted_frame()) {
640     DESCRIBE_FP_OFFSET(interpreter_frame_sender_sp);
641     DESCRIBE_FP_OFFSET(interpreter_frame_last_sp);
642     DESCRIBE_FP_OFFSET(interpreter_frame_method);
643     DESCRIBE_FP_OFFSET(interpreter_frame_mirror);
644     DESCRIBE_FP_OFFSET(interpreter_frame_mdp);
645     DESCRIBE_FP_OFFSET(interpreter_frame_cache);
646     DESCRIBE_FP_OFFSET(interpreter_frame_locals);
647     DESCRIBE_FP_OFFSET(interpreter_frame_bcp);
648     DESCRIBE_FP_OFFSET(interpreter_frame_initial_sp);
649 #ifdef AMD64
650   } else if (is_entry_frame()) {
651     // This could be more descriptive if we use the enum in
652     // stubGenerator to map to real names but it&#39;s most important to
653     // claim these frame slots so the error checking works.
654     for (int i = 0; i &lt; entry_frame_after_call_words; i++) {
655       values.describe(frame_no, fp() - i, err_msg(&quot;call_stub word fp - %d&quot;, i));
656     }
657 #endif // AMD64
658   }
659 }
660 #endif // !PRODUCT
661 
662 intptr_t *frame::initial_deoptimization_info() {
663   // used to reset the saved FP
664   return fp();
665 }
666 
667 intptr_t* frame::real_fp() const {
668   if (_cb != NULL) {
669     // use the frame size if valid
670     int size = _cb-&gt;frame_size();
671     if (size &gt; 0) {
672       return unextended_sp() + size;
673     }
674   }
675   // else rely on fp()
676   assert(! is_compiled_frame(), &quot;unknown compiled frame size&quot;);
677   return fp();
678 }
679 
680 #ifndef PRODUCT
681 // This is a generic constructor which is only used by pns() in debug.cpp.
682 frame::frame(void* sp, void* fp, void* pc) {
683   init((intptr_t*)sp, (intptr_t*)fp, (address)pc);
684 }
685 
686 void frame::pd_ps() {}
687 #endif
688 
689 void JavaFrameAnchor::make_walkable(JavaThread* thread) {
690   // last frame set?
691   if (last_Java_sp() == NULL) return;
692   // already walkable?
693   if (walkable()) return;
694   vmassert(Thread::current() == (Thread*)thread, &quot;not current thread&quot;);
695   vmassert(last_Java_sp() != NULL, &quot;not called from Java code?&quot;);
696   vmassert(last_Java_pc() == NULL, &quot;already walkable&quot;);
697   capture_last_Java_pc();
698   vmassert(walkable(), &quot;something went wrong&quot;);
699 }
700 
701 void JavaFrameAnchor::capture_last_Java_pc() {
702   vmassert(_last_Java_sp != NULL, &quot;no last frame set&quot;);
703   vmassert(_last_Java_pc == NULL, &quot;already walkable&quot;);
704   _last_Java_pc = (address)_last_Java_sp[-1];
705 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>