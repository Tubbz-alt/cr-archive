<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/cpu/zero/cppInterpreter_zero.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * Copyright 2007, 2008, 2009, 2010, 2011 Red Hat, Inc.
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * This code is free software; you can redistribute it and/or modify it
  7  * under the terms of the GNU General Public License version 2 only, as
  8  * published by the Free Software Foundation.
  9  *
 10  * This code is distributed in the hope that it will be useful, but WITHOUT
 11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 13  * version 2 for more details (a copy is included in the LICENSE file that
 14  * accompanied this code).
 15  *
 16  * You should have received a copy of the GNU General Public License version
 17  * 2 along with this work; if not, write to the Free Software Foundation,
 18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 19  *
 20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 21  * or visit www.oracle.com if you need additional information or have any
 22  * questions.
 23  *
 24  */
 25 
 26 #include &quot;precompiled.hpp&quot;
 27 #include &quot;asm/assembler.hpp&quot;
 28 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
 29 #include &quot;interpreter/cppInterpreter.hpp&quot;
 30 #include &quot;interpreter/cppInterpreterGenerator.hpp&quot;
 31 #include &quot;interpreter/interpreter.hpp&quot;
 32 #include &quot;interpreter/interpreterRuntime.hpp&quot;
 33 #include &quot;oops/arrayOop.hpp&quot;
 34 #include &quot;oops/cpCache.inline.hpp&quot;
 35 #include &quot;oops/methodData.hpp&quot;
 36 #include &quot;oops/method.hpp&quot;
 37 #include &quot;oops/oop.inline.hpp&quot;
 38 #include &quot;prims/jvmtiExport.hpp&quot;
 39 #include &quot;prims/jvmtiThreadState.hpp&quot;
 40 #include &quot;runtime/arguments.hpp&quot;
<a name="1" id="anc1"></a><span class="line-removed"> 41 #include &quot;runtime/atomic.hpp&quot;</span>
 42 #include &quot;runtime/deoptimization.hpp&quot;
 43 #include &quot;runtime/frame.inline.hpp&quot;
 44 #include &quot;runtime/handles.inline.hpp&quot;
 45 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
 46 #include &quot;runtime/jniHandles.inline.hpp&quot;
<a name="2" id="anc2"></a><span class="line-removed"> 47 #include &quot;runtime/orderAccess.hpp&quot;</span>
 48 #include &quot;runtime/sharedRuntime.hpp&quot;
 49 #include &quot;runtime/stubRoutines.hpp&quot;
 50 #include &quot;runtime/synchronizer.hpp&quot;
 51 #include &quot;runtime/timer.hpp&quot;
 52 #include &quot;runtime/vframeArray.hpp&quot;
 53 #include &quot;stack_zero.inline.hpp&quot;
 54 #include &quot;utilities/debug.hpp&quot;
 55 #include &quot;utilities/macros.hpp&quot;
 56 
 57 #ifdef CC_INTERP
 58 
 59 #define fixup_after_potential_safepoint()       \
 60   method = istate-&gt;method()
 61 
 62 #define CALL_VM_NOCHECK_NOFIX(func)             \
 63   thread-&gt;set_last_Java_frame();                \
 64   func;                                         \
 65   thread-&gt;reset_last_Java_frame();
 66 
 67 #define CALL_VM_NOCHECK(func)                   \
 68   CALL_VM_NOCHECK_NOFIX(func)                   \
 69   fixup_after_potential_safepoint()
 70 
 71 int CppInterpreter::normal_entry(Method* method, intptr_t UNUSED, TRAPS) {
 72   JavaThread *thread = (JavaThread *) THREAD;
 73 
 74   // Allocate and initialize our frame.
 75   InterpreterFrame *frame = InterpreterFrame::build(method, CHECK_0);
 76   thread-&gt;push_zero_frame(frame);
 77 
 78   // Execute those bytecodes!
 79   main_loop(0, THREAD);
 80 
 81   // No deoptimized frames on the stack
 82   return 0;
 83 }
 84 
 85 intptr_t narrow(BasicType type, intptr_t result) {
 86   // mask integer result to narrower return type.
 87   switch (type) {
 88     case T_BOOLEAN:
 89       return result&amp;1;
 90     case T_BYTE:
 91       return (intptr_t)(jbyte)result;
 92     case T_CHAR:
 93       return (intptr_t)(uintptr_t)(jchar)result;
 94     case T_SHORT:
 95       return (intptr_t)(jshort)result;
 96     case T_OBJECT:  // nothing to do fall through
 97     case T_ARRAY:
 98     case T_LONG:
 99     case T_INT:
100     case T_FLOAT:
101     case T_DOUBLE:
102     case T_VOID:
103       return result;
104     default  : ShouldNotReachHere();
105   }
106 }
107 
108 
109 void CppInterpreter::main_loop(int recurse, TRAPS) {
110   JavaThread *thread = (JavaThread *) THREAD;
111   ZeroStack *stack = thread-&gt;zero_stack();
112 
113   // If we are entering from a deopt we may need to call
114   // ourself a few times in order to get to our frame.
115   if (recurse)
116     main_loop(recurse - 1, THREAD);
117 
118   InterpreterFrame *frame = thread-&gt;top_zero_frame()-&gt;as_interpreter_frame();
119   interpreterState istate = frame-&gt;interpreter_state();
120   Method* method = istate-&gt;method();
121 
122   intptr_t *result = NULL;
123   int result_slots = 0;
124 
125   while (true) {
126     // We can set up the frame anchor with everything we want at
127     // this point as we are thread_in_Java and no safepoints can
128     // occur until we go to vm mode.  We do have to clear flags
129     // on return from vm but that is it.
130     thread-&gt;set_last_Java_frame();
131 
132     // Call the interpreter
133     if (JvmtiExport::can_post_interpreter_events())
134       BytecodeInterpreter::runWithChecks(istate);
135     else
136       BytecodeInterpreter::run(istate);
137     fixup_after_potential_safepoint();
138 
139     // Clear the frame anchor
140     thread-&gt;reset_last_Java_frame();
141 
142     // Examine the message from the interpreter to decide what to do
143     if (istate-&gt;msg() == BytecodeInterpreter::call_method) {
144       Method* callee = istate-&gt;callee();
145 
146       // Trim back the stack to put the parameters at the top
147       stack-&gt;set_sp(istate-&gt;stack() + 1);
148 
149       // Make the call
150       Interpreter::invoke_method(callee, istate-&gt;callee_entry_point(), THREAD);
151       fixup_after_potential_safepoint();
152 
153       // Convert the result
154       istate-&gt;set_stack(stack-&gt;sp() - 1);
155 
156       // Restore the stack
157       stack-&gt;set_sp(istate-&gt;stack_limit() + 1);
158 
159       // Resume the interpreter
160       istate-&gt;set_msg(BytecodeInterpreter::method_resume);
161     }
162     else if (istate-&gt;msg() == BytecodeInterpreter::more_monitors) {
163       int monitor_words = frame::interpreter_frame_monitor_size();
164 
165       // Allocate the space
166       stack-&gt;overflow_check(monitor_words, THREAD);
167       if (HAS_PENDING_EXCEPTION)
168         break;
169       stack-&gt;alloc(monitor_words * wordSize);
170 
171       // Move the expression stack contents
172       for (intptr_t *p = istate-&gt;stack() + 1; p &lt; istate-&gt;stack_base(); p++)
173         *(p - monitor_words) = *p;
174 
175       // Move the expression stack pointers
176       istate-&gt;set_stack_limit(istate-&gt;stack_limit() - monitor_words);
177       istate-&gt;set_stack(istate-&gt;stack() - monitor_words);
178       istate-&gt;set_stack_base(istate-&gt;stack_base() - monitor_words);
179 
180       // Zero the new monitor so the interpreter can find it.
181       ((BasicObjectLock *) istate-&gt;stack_base())-&gt;set_obj(NULL);
182 
183       // Resume the interpreter
184       istate-&gt;set_msg(BytecodeInterpreter::got_monitors);
185     }
186     else if (istate-&gt;msg() == BytecodeInterpreter::return_from_method) {
187       // Copy the result into the caller&#39;s frame
188       result_slots = type2size[method-&gt;result_type()];
189       assert(result_slots &gt;= 0 &amp;&amp; result_slots &lt;= 2, &quot;what?&quot;);
190       result = istate-&gt;stack() + result_slots;
191       break;
192     }
193     else if (istate-&gt;msg() == BytecodeInterpreter::throwing_exception) {
194       assert(HAS_PENDING_EXCEPTION, &quot;should do&quot;);
195       break;
196     }
197     else if (istate-&gt;msg() == BytecodeInterpreter::do_osr) {
198       // Unwind the current frame
199       thread-&gt;pop_zero_frame();
200 
201       // Remove any extension of the previous frame
202       int extra_locals = method-&gt;max_locals() - method-&gt;size_of_parameters();
203       stack-&gt;set_sp(stack-&gt;sp() + extra_locals);
204 
205       // Jump into the OSR method
206       Interpreter::invoke_osr(
207         method, istate-&gt;osr_entry(), istate-&gt;osr_buf(), THREAD);
208       return;
209     }
210     else {
211       ShouldNotReachHere();
212     }
213   }
214 
215   // Unwind the current frame
216   thread-&gt;pop_zero_frame();
217 
218   // Pop our local variables
219   stack-&gt;set_sp(stack-&gt;sp() + method-&gt;max_locals());
220 
221   // Push our result
222   for (int i = 0; i &lt; result_slots; i++) {
223     // Adjust result to smaller
224     union {
225       intptr_t res;
226       jint res_jint;
227     };
228     res = result[-i];
229     if (result_slots == 1) {
230       BasicType t = method-&gt;result_type();
231       if (is_subword_type(t)) {
232         res_jint = (jint)narrow(t, res_jint);
233       }
234     }
235     stack-&gt;push(res);
236   }
237 }
238 
239 int CppInterpreter::native_entry(Method* method, intptr_t UNUSED, TRAPS) {
240   // Make sure method is native and not abstract
241   assert(method-&gt;is_native() &amp;&amp; !method-&gt;is_abstract(), &quot;should be&quot;);
242 
243   JavaThread *thread = (JavaThread *) THREAD;
244   ZeroStack *stack = thread-&gt;zero_stack();
245 
246   // Allocate and initialize our frame
247   InterpreterFrame *frame = InterpreterFrame::build(method, CHECK_0);
248   thread-&gt;push_zero_frame(frame);
249   interpreterState istate = frame-&gt;interpreter_state();
250   intptr_t *locals = istate-&gt;locals();
251 
252   // Update the invocation counter
253   if ((UseCompiler || CountCompiledCalls) &amp;&amp; !method-&gt;is_synchronized()) {
254     MethodCounters* mcs = method-&gt;method_counters();
255     if (mcs == NULL) {
256       CALL_VM_NOCHECK(mcs = InterpreterRuntime::build_method_counters(thread, method));
257       if (HAS_PENDING_EXCEPTION)
258         goto unwind_and_return;
259     }
260     InvocationCounter *counter = mcs-&gt;invocation_counter();
261     counter-&gt;increment();
262     if (counter-&gt;reached_InvocationLimit(mcs-&gt;backedge_counter())) {
263       CALL_VM_NOCHECK(
264         InterpreterRuntime::frequency_counter_overflow(thread, NULL));
265       if (HAS_PENDING_EXCEPTION)
266         goto unwind_and_return;
267     }
268   }
269 
270   // Lock if necessary
271   BasicObjectLock *monitor;
272   monitor = NULL;
273   if (method-&gt;is_synchronized()) {
274     monitor = (BasicObjectLock*) istate-&gt;stack_base();
275     oop lockee = monitor-&gt;obj();
<a name="3" id="anc3"></a><span class="line-modified">276     markOop disp = lockee-&gt;mark()-&gt;set_unlocked();</span>
277 
278     monitor-&gt;lock()-&gt;set_displaced_header(disp);
<a name="4" id="anc4"></a><span class="line-modified">279     if (lockee-&gt;cas_set_mark((markOop)monitor, disp) != disp) {</span>
<span class="line-modified">280       if (thread-&gt;is_lock_owned((address) disp-&gt;clear_lock_bits())) {</span>
<span class="line-modified">281         monitor-&gt;lock()-&gt;set_displaced_header(NULL);</span>
282       }
283       else {
284         CALL_VM_NOCHECK(InterpreterRuntime::monitorenter(thread, monitor));
285         if (HAS_PENDING_EXCEPTION)
286           goto unwind_and_return;
287       }
288     }
289   }
290 
291   // Get the signature handler
292   InterpreterRuntime::SignatureHandler *handler; {
293     address handlerAddr = method-&gt;signature_handler();
294     if (handlerAddr == NULL) {
295       CALL_VM_NOCHECK(InterpreterRuntime::prepare_native_call(thread, method));
296       if (HAS_PENDING_EXCEPTION)
297         goto unlock_unwind_and_return;
298 
299       handlerAddr = method-&gt;signature_handler();
300       assert(handlerAddr != NULL, &quot;eh?&quot;);
301     }
302     if (handlerAddr == (address) InterpreterRuntime::slow_signature_handler) {
303       CALL_VM_NOCHECK(handlerAddr =
304         InterpreterRuntime::slow_signature_handler(thread, method, NULL,NULL));
305       if (HAS_PENDING_EXCEPTION)
306         goto unlock_unwind_and_return;
307     }
308     handler = \
309       InterpreterRuntime::SignatureHandler::from_handlerAddr(handlerAddr);
310   }
311 
312   // Get the native function entry point
313   address function;
314   function = method-&gt;native_function();
315   assert(function != NULL, &quot;should be set if signature handler is&quot;);
316 
317   // Build the argument list
318   stack-&gt;overflow_check(handler-&gt;argument_count() * 2, THREAD);
319   if (HAS_PENDING_EXCEPTION)
320     goto unlock_unwind_and_return;
321 
322   void **arguments;
323   void *mirror; {
324     arguments =
325       (void **) stack-&gt;alloc(handler-&gt;argument_count() * sizeof(void **));
326     void **dst = arguments;
327 
328     void *env = thread-&gt;jni_environment();
329     *(dst++) = &amp;env;
330 
331     if (method-&gt;is_static()) {
332       istate-&gt;set_oop_temp(
333         method-&gt;constants()-&gt;pool_holder()-&gt;java_mirror());
334       mirror = istate-&gt;oop_temp_addr();
335       *(dst++) = &amp;mirror;
336     }
337 
338     intptr_t *src = locals;
339     for (int i = dst - arguments; i &lt; handler-&gt;argument_count(); i++) {
340       ffi_type *type = handler-&gt;argument_type(i);
341       if (type == &amp;ffi_type_pointer) {
342         if (*src) {
343           stack-&gt;push((intptr_t) src);
344           *(dst++) = stack-&gt;sp();
345         }
346         else {
347           *(dst++) = src;
348         }
349         src--;
350       }
351       else if (type-&gt;size == 4) {
352         *(dst++) = src--;
353       }
354       else if (type-&gt;size == 8) {
355         src--;
356         *(dst++) = src--;
357       }
358       else {
359         ShouldNotReachHere();
360       }
361     }
362   }
363 
364   // Set up the Java frame anchor
365   thread-&gt;set_last_Java_frame();
366 
367   // Change the thread state to _thread_in_native
368   ThreadStateTransition::transition_from_java(thread, _thread_in_native);
369 
370   // Make the call
371   intptr_t result[4 - LogBytesPerWord];
372   ffi_call(handler-&gt;cif(), (void (*)()) function, result, arguments);
373 
<a name="5" id="anc5"></a><span class="line-modified">374   // Change the thread state back to _thread_in_Java.</span>

375   // ThreadStateTransition::transition_from_native() cannot be used
376   // here because it does not check for asynchronous exceptions.
377   // We have to manage the transition ourself.
<a name="6" id="anc6"></a><span class="line-modified">378   thread-&gt;set_thread_state(_thread_in_native_trans);</span>
<span class="line-removed">379 </span>
<span class="line-removed">380   // Make sure new state is visible in the GC thread</span>
<span class="line-removed">381   InterfaceSupport::serialize_thread_state(thread);</span>
382 
383   // Handle safepoint operations, pending suspend requests,
384   // and pending asynchronous exceptions.
385   if (SafepointMechanism::should_block(thread) ||
386       thread-&gt;has_special_condition_for_native_trans()) {
387     JavaThread::check_special_condition_for_native_trans(thread);
388     CHECK_UNHANDLED_OOPS_ONLY(thread-&gt;clear_unhandled_oops());
389   }
390 
391   // Finally we can change the thread state to _thread_in_Java.
392   thread-&gt;set_thread_state(_thread_in_Java);
393   fixup_after_potential_safepoint();
394 
395   // Clear the frame anchor
396   thread-&gt;reset_last_Java_frame();
397 
398   // If the result was an oop then unbox it and store it in
399   // oop_temp where the garbage collector can see it before
400   // we release the handle it might be protected by.
401   if (handler-&gt;result_type() == &amp;ffi_type_pointer) {
402     if (result[0] == 0) {
403       istate-&gt;set_oop_temp(NULL);
404     } else {
405       jobject handle = reinterpret_cast&lt;jobject&gt;(result[0]);
406       istate-&gt;set_oop_temp(JNIHandles::resolve(handle));
407     }
408   }
409 
410   // Reset handle block
411   thread-&gt;active_handles()-&gt;clear();
412 
413  unlock_unwind_and_return:
414 
415   // Unlock if necessary
416   if (monitor) {
417     BasicLock *lock = monitor-&gt;lock();
<a name="7" id="anc7"></a><span class="line-modified">418     markOop header = lock-&gt;displaced_header();</span>
419     oop rcvr = monitor-&gt;obj();
420     monitor-&gt;set_obj(NULL);
421 
<a name="8" id="anc8"></a><span class="line-modified">422     if (header != NULL) {</span>
<span class="line-modified">423       markOop old_header = markOopDesc::encode(lock);</span>
424       if (rcvr-&gt;cas_set_mark(header, old_header) != old_header) {
425         monitor-&gt;set_obj(rcvr); {
426           HandleMark hm(thread);
427           CALL_VM_NOCHECK(InterpreterRuntime::monitorexit(thread, monitor));
428         }
429       }
430     }
431   }
432 
433  unwind_and_return:
434 
435   // Unwind the current activation
436   thread-&gt;pop_zero_frame();
437 
438   // Pop our parameters
439   stack-&gt;set_sp(stack-&gt;sp() + method-&gt;size_of_parameters());
440 
441   // Push our result
442   if (!HAS_PENDING_EXCEPTION) {
443     BasicType type = method-&gt;result_type();
444     stack-&gt;set_sp(stack-&gt;sp() - type2size[type]);
445 
446     switch (type) {
447     case T_VOID:
448       break;
449 
450     case T_BOOLEAN:
451 #ifndef VM_LITTLE_ENDIAN
452       result[0] &lt;&lt;= (BitsPerWord - BitsPerByte);
453 #endif
454       SET_LOCALS_INT(*(jboolean *) result != 0, 0);
455       break;
456 
457     case T_CHAR:
458 #ifndef VM_LITTLE_ENDIAN
459       result[0] &lt;&lt;= (BitsPerWord - BitsPerShort);
460 #endif
461       SET_LOCALS_INT(*(jchar *) result, 0);
462       break;
463 
464     case T_BYTE:
465 #ifndef VM_LITTLE_ENDIAN
466       result[0] &lt;&lt;= (BitsPerWord - BitsPerByte);
467 #endif
468       SET_LOCALS_INT(*(jbyte *) result, 0);
469       break;
470 
471     case T_SHORT:
472 #ifndef VM_LITTLE_ENDIAN
473       result[0] &lt;&lt;= (BitsPerWord - BitsPerShort);
474 #endif
475       SET_LOCALS_INT(*(jshort *) result, 0);
476       break;
477 
478     case T_INT:
479 #ifndef VM_LITTLE_ENDIAN
480       result[0] &lt;&lt;= (BitsPerWord - BitsPerInt);
481 #endif
482       SET_LOCALS_INT(*(jint *) result, 0);
483       break;
484 
485     case T_LONG:
486       SET_LOCALS_LONG(*(jlong *) result, 0);
487       break;
488 
489     case T_FLOAT:
490       SET_LOCALS_FLOAT(*(jfloat *) result, 0);
491       break;
492 
493     case T_DOUBLE:
494       SET_LOCALS_DOUBLE(*(jdouble *) result, 0);
495       break;
496 
497     case T_OBJECT:
498     case T_ARRAY:
499       SET_LOCALS_OBJECT(istate-&gt;oop_temp(), 0);
500       break;
501 
502     default:
503       ShouldNotReachHere();
504     }
505   }
506 
507   // No deoptimized frames on the stack
508   return 0;
509 }
510 
511 int CppInterpreter::accessor_entry(Method* method, intptr_t UNUSED, TRAPS) {
512   JavaThread *thread = (JavaThread *) THREAD;
513   ZeroStack *stack = thread-&gt;zero_stack();
514   intptr_t *locals = stack-&gt;sp();
515 
516   // Drop into the slow path if we need a safepoint check
517   if (SafepointMechanism::should_block(THREAD)) {
518     return normal_entry(method, 0, THREAD);
519   }
520 
521   // Load the object pointer and drop into the slow path
522   // if we have a NullPointerException
523   oop object = LOCALS_OBJECT(0);
524   if (object == NULL) {
525     return normal_entry(method, 0, THREAD);
526   }
527 
528   // Read the field index from the bytecode, which looks like this:
529   //  0:  aload_0
530   //  1:  getfield
531   //  2:    index
532   //  3:    index
533   //  4:  ireturn/areturn/freturn/lreturn/dreturn
534   // NB this is not raw bytecode: index is in machine order
535   u1 *code = method-&gt;code_base();
536   assert(code[0] == Bytecodes::_aload_0 &amp;&amp;
537          code[1] == Bytecodes::_getfield &amp;&amp;
538          (code[4] == Bytecodes::_ireturn ||
539           code[4] == Bytecodes::_freturn ||
540           code[4] == Bytecodes::_lreturn ||
541           code[4] == Bytecodes::_dreturn ||
542           code[4] == Bytecodes::_areturn), &quot;should do&quot;);
543   u2 index = Bytes::get_native_u2(&amp;code[2]);
544 
545   // Get the entry from the constant pool cache, and drop into
546   // the slow path if it has not been resolved
547   ConstantPoolCache* cache = method-&gt;constants()-&gt;cache();
548   ConstantPoolCacheEntry* entry = cache-&gt;entry_at(index);
549   if (!entry-&gt;is_resolved(Bytecodes::_getfield)) {
550     return normal_entry(method, 0, THREAD);
551   }
552 
553   // Get the result and push it onto the stack
554   switch (entry-&gt;flag_state()) {
555   case ltos:
556   case dtos:
557     stack-&gt;overflow_check(1, CHECK_0);
558     stack-&gt;alloc(wordSize);
559     break;
560   }
561   if (entry-&gt;is_volatile()) {
562     switch (entry-&gt;flag_state()) {
563     case ctos:
564       SET_LOCALS_INT(object-&gt;char_field_acquire(entry-&gt;f2_as_index()), 0);
565       break;
566 
567     case btos:
568     case ztos:
569       SET_LOCALS_INT(object-&gt;byte_field_acquire(entry-&gt;f2_as_index()), 0);
570       break;
571 
572     case stos:
573       SET_LOCALS_INT(object-&gt;short_field_acquire(entry-&gt;f2_as_index()), 0);
574       break;
575 
576     case itos:
577       SET_LOCALS_INT(object-&gt;int_field_acquire(entry-&gt;f2_as_index()), 0);
578       break;
579 
580     case ltos:
581       SET_LOCALS_LONG(object-&gt;long_field_acquire(entry-&gt;f2_as_index()), 0);
582       break;
583 
584     case ftos:
585       SET_LOCALS_FLOAT(object-&gt;float_field_acquire(entry-&gt;f2_as_index()), 0);
586       break;
587 
588     case dtos:
589       SET_LOCALS_DOUBLE(object-&gt;double_field_acquire(entry-&gt;f2_as_index()), 0);
590       break;
591 
592     case atos:
593       SET_LOCALS_OBJECT(object-&gt;obj_field_acquire(entry-&gt;f2_as_index()), 0);
594       break;
595 
596     default:
597       ShouldNotReachHere();
598     }
599   }
600   else {
601     switch (entry-&gt;flag_state()) {
602     case ctos:
603       SET_LOCALS_INT(object-&gt;char_field(entry-&gt;f2_as_index()), 0);
604       break;
605 
606     case btos:
607     case ztos:
608       SET_LOCALS_INT(object-&gt;byte_field(entry-&gt;f2_as_index()), 0);
609       break;
610 
611     case stos:
612       SET_LOCALS_INT(object-&gt;short_field(entry-&gt;f2_as_index()), 0);
613       break;
614 
615     case itos:
616       SET_LOCALS_INT(object-&gt;int_field(entry-&gt;f2_as_index()), 0);
617       break;
618 
619     case ltos:
620       SET_LOCALS_LONG(object-&gt;long_field(entry-&gt;f2_as_index()), 0);
621       break;
622 
623     case ftos:
624       SET_LOCALS_FLOAT(object-&gt;float_field(entry-&gt;f2_as_index()), 0);
625       break;
626 
627     case dtos:
628       SET_LOCALS_DOUBLE(object-&gt;double_field(entry-&gt;f2_as_index()), 0);
629       break;
630 
631     case atos:
632       SET_LOCALS_OBJECT(object-&gt;obj_field(entry-&gt;f2_as_index()), 0);
633       break;
634 
635     default:
636       ShouldNotReachHere();
637     }
638   }
639 
640   // No deoptimized frames on the stack
641   return 0;
642 }
643 
644 int CppInterpreter::empty_entry(Method* method, intptr_t UNUSED, TRAPS) {
645   JavaThread *thread = (JavaThread *) THREAD;
646   ZeroStack *stack = thread-&gt;zero_stack();
647 
648   // Drop into the slow path if we need a safepoint check
649   if (SafepointMechanism::should_block(THREAD)) {
650     return normal_entry(method, 0, THREAD);
651   }
652 
653   // Pop our parameters
654   stack-&gt;set_sp(stack-&gt;sp() + method-&gt;size_of_parameters());
655 
656   // No deoptimized frames on the stack
657   return 0;
658 }
659 
660 // The new slots will be inserted before slot insert_before.
661 // Slots &lt; insert_before will have the same slot number after the insert.
662 // Slots &gt;= insert_before will become old_slot + num_slots.
663 void CppInterpreter::insert_vmslots(int insert_before, int num_slots, TRAPS) {
664   JavaThread *thread = (JavaThread *) THREAD;
665   ZeroStack *stack = thread-&gt;zero_stack();
666 
667   // Allocate the space
668   stack-&gt;overflow_check(num_slots, CHECK);
669   stack-&gt;alloc(num_slots * wordSize);
670   intptr_t *vmslots = stack-&gt;sp();
671 
672   // Shuffle everything up
673   for (int i = 0; i &lt; insert_before; i++)
674     SET_VMSLOTS_SLOT(VMSLOTS_SLOT(i + num_slots), i);
675 }
676 
677 void CppInterpreter::remove_vmslots(int first_slot, int num_slots, TRAPS) {
678   JavaThread *thread = (JavaThread *) THREAD;
679   ZeroStack *stack = thread-&gt;zero_stack();
680   intptr_t *vmslots = stack-&gt;sp();
681 
682   // Move everything down
683   for (int i = first_slot - 1; i &gt;= 0; i--)
684     SET_VMSLOTS_SLOT(VMSLOTS_SLOT(i), i + num_slots);
685 
686   // Deallocate the space
687   stack-&gt;set_sp(stack-&gt;sp() + num_slots);
688 }
689 
690 BasicType CppInterpreter::result_type_of_handle(oop method_handle) {
691   oop method_type = java_lang_invoke_MethodHandle::type(method_handle);
692   oop return_type = java_lang_invoke_MethodType::rtype(method_type);
693   return java_lang_Class::as_BasicType(return_type, (Klass* *) NULL);
694 }
695 
696 intptr_t* CppInterpreter::calculate_unwind_sp(ZeroStack* stack,
697                                               oop method_handle) {
698   oop method_type = java_lang_invoke_MethodHandle::type(method_handle);
699   int argument_slots = java_lang_invoke_MethodType::ptype_slot_count(method_type);
700 
701   return stack-&gt;sp() + argument_slots;
702 }
703 
<a name="9" id="anc9"></a><span class="line-modified">704 IRT_ENTRY(void, CppInterpreter::throw_exception(JavaThread* thread,</span>
705                                                 Symbol*     name,
706                                                 char*       message))
707   THROW_MSG(name, message);
<a name="10" id="anc10"></a><span class="line-modified">708 IRT_END</span>
709 
710 InterpreterFrame *InterpreterFrame::build(Method* const method, TRAPS) {
711   JavaThread *thread = (JavaThread *) THREAD;
712   ZeroStack *stack = thread-&gt;zero_stack();
713 
714   // Calculate the size of the frame we&#39;ll build, including
715   // any adjustments to the caller&#39;s frame that we&#39;ll make.
716   int extra_locals  = 0;
717   int monitor_words = 0;
718   int stack_words   = 0;
719 
720   if (!method-&gt;is_native()) {
721     extra_locals = method-&gt;max_locals() - method-&gt;size_of_parameters();
722     stack_words  = method-&gt;max_stack();
723   }
724   if (method-&gt;is_synchronized()) {
725     monitor_words = frame::interpreter_frame_monitor_size();
726   }
727   stack-&gt;overflow_check(
728     extra_locals + header_words + monitor_words + stack_words, CHECK_NULL);
729 
730   // Adjust the caller&#39;s stack frame to accomodate any additional
731   // local variables we have contiguously with our parameters.
732   for (int i = 0; i &lt; extra_locals; i++)
733     stack-&gt;push(0);
734 
735   intptr_t *locals;
736   if (method-&gt;is_native())
737     locals = stack-&gt;sp() + (method-&gt;size_of_parameters() - 1);
738   else
739     locals = stack-&gt;sp() + (method-&gt;max_locals() - 1);
740 
741   stack-&gt;push(0); // next_frame, filled in later
742   intptr_t *fp = stack-&gt;sp();
743   assert(fp - stack-&gt;sp() == next_frame_off, &quot;should be&quot;);
744 
745   stack-&gt;push(INTERPRETER_FRAME);
746   assert(fp - stack-&gt;sp() == frame_type_off, &quot;should be&quot;);
747 
748   interpreterState istate =
749     (interpreterState) stack-&gt;alloc(sizeof(BytecodeInterpreter));
750   assert(fp - stack-&gt;sp() == istate_off, &quot;should be&quot;);
751 
752   istate-&gt;set_locals(locals);
753   istate-&gt;set_method(method);
754   istate-&gt;set_mirror(method-&gt;method_holder()-&gt;java_mirror());
755   istate-&gt;set_self_link(istate);
756   istate-&gt;set_prev_link(NULL);
757   istate-&gt;set_thread(thread);
758   istate-&gt;set_bcp(method-&gt;is_native() ? NULL : method-&gt;code_base());
759   istate-&gt;set_constants(method-&gt;constants()-&gt;cache());
760   istate-&gt;set_msg(BytecodeInterpreter::method_entry);
761   istate-&gt;set_oop_temp(NULL);
762   istate-&gt;set_mdx(NULL);
763   istate-&gt;set_callee(NULL);
764 
765   istate-&gt;set_monitor_base((BasicObjectLock *) stack-&gt;sp());
766   if (method-&gt;is_synchronized()) {
767     BasicObjectLock *monitor =
768       (BasicObjectLock *) stack-&gt;alloc(monitor_words * wordSize);
769     oop object;
770     if (method-&gt;is_static())
771       object = method-&gt;constants()-&gt;pool_holder()-&gt;java_mirror();
772     else
773       object = (oop) (void*)locals[0];
774     monitor-&gt;set_obj(object);
775   }
776 
777   istate-&gt;set_stack_base(stack-&gt;sp());
778   istate-&gt;set_stack(stack-&gt;sp() - 1);
779   if (stack_words)
780     stack-&gt;alloc(stack_words * wordSize);
781   istate-&gt;set_stack_limit(stack-&gt;sp() - 1);
782 
783   return (InterpreterFrame *) fp;
784 }
785 
786 InterpreterFrame *InterpreterFrame::build(int size, TRAPS) {
787   ZeroStack *stack = ((JavaThread *) THREAD)-&gt;zero_stack();
788 
789   int size_in_words = size &gt;&gt; LogBytesPerWord;
790   assert(size_in_words * wordSize == size, &quot;unaligned&quot;);
791   assert(size_in_words &gt;= header_words, &quot;too small&quot;);
792   stack-&gt;overflow_check(size_in_words, CHECK_NULL);
793 
794   stack-&gt;push(0); // next_frame, filled in later
795   intptr_t *fp = stack-&gt;sp();
796   assert(fp - stack-&gt;sp() == next_frame_off, &quot;should be&quot;);
797 
798   stack-&gt;push(INTERPRETER_FRAME);
799   assert(fp - stack-&gt;sp() == frame_type_off, &quot;should be&quot;);
800 
801   interpreterState istate =
802     (interpreterState) stack-&gt;alloc(sizeof(BytecodeInterpreter));
803   assert(fp - stack-&gt;sp() == istate_off, &quot;should be&quot;);
804   istate-&gt;set_self_link(NULL); // mark invalid
805 
806   stack-&gt;alloc((size_in_words - header_words) * wordSize);
807 
808   return (InterpreterFrame *) fp;
809 }
810 
811 address CppInterpreter::return_entry(TosState state, int length, Bytecodes::Code code) {
812   ShouldNotCallThis();
813   return NULL;
814 }
815 
816 address CppInterpreter::deopt_entry(TosState state, int length) {
817   return NULL;
818 }
819 
820 // Helper for figuring out if frames are interpreter frames
821 
822 bool CppInterpreter::contains(address pc) {
823   return false; // make frame::print_value_on work
824 }
825 #endif // CC_INTERP
<a name="11" id="anc11"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="11" type="hidden" />
</body>
</html>