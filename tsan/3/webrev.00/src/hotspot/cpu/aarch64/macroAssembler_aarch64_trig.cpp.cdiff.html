<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/hotspot/cpu/aarch64/macroAssembler_aarch64_trig.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="macroAssembler_aarch64_log.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="nativeInst_aarch64.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/aarch64/macroAssembler_aarch64_trig.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 379,15 ***</span>
          movw(jx, 2); // calculate jx as nx - 1, which is initially 2. Not a part of unrolled loop
          fsubd(v26, v26, v7);
        }
  
        block_comment(&quot;nx calculation with unrolled while(tx[nx-1]==zeroA) nx--;&quot;); {
<span class="line-modified">!         fcmpd(v26, 0.0d);                          // if NE then jx == 2. else it&#39;s 1 or 0</span>
          add(iqBase, sp, 480);                      // base of iq[]
          fmuld(v3, v26, v10);
          br(NE, NX_SET);
<span class="line-modified">!         fcmpd(v7, 0.0d);                           // v7 == 0 =&gt; jx = 0. Else jx = 1</span>
          csetw(jx, NE);
        }
      bind(NX_SET);
        generate__kernel_rem_pio2(two_over_pi, pio2);
        // now we have y[0] = v4, y[1] = v5 and n = r2
<span class="line-new-header">--- 379,15 ---</span>
          movw(jx, 2); // calculate jx as nx - 1, which is initially 2. Not a part of unrolled loop
          fsubd(v26, v26, v7);
        }
  
        block_comment(&quot;nx calculation with unrolled while(tx[nx-1]==zeroA) nx--;&quot;); {
<span class="line-modified">!         fcmpd(v26, 0.0);                           // if NE then jx == 2. else it&#39;s 1 or 0</span>
          add(iqBase, sp, 480);                      // base of iq[]
          fmuld(v3, v26, v10);
          br(NE, NX_SET);
<span class="line-modified">!         fcmpd(v7, 0.0);                            // v7 == 0 =&gt; jx = 0. Else jx = 1</span>
          csetw(jx, NE);
        }
      bind(NX_SET);
        generate__kernel_rem_pio2(two_over_pi, pio2);
        // now we have y[0] = v4, y[1] = v5 and n = r2
</pre>
<hr />
<pre>
<span class="line-old-header">*** 694,11 ***</span>
      // jx = nx - 1
      lea(twoOverPiBase, ExternalAddress(two_over_pi));
      cmpw(jv, zr);
      addw(tmp4, jx, 4); // tmp4 = m = jx + jk = jx + 4. jx is in {0,1,2} so m is in [4,5,6]
      cselw(jv, jv, zr, GE);
<span class="line-modified">!     fmovd(v26, 0.0d);</span>
      addw(tmp5, jv, 1);                    // jv+1
      subsw(j, jv, jx);
      add(qBase, sp, 320);                  // base of q[]
      msubw(rscratch1, i, tmp5, rscratch1); // q0 =  e0-24*(jv+1)
      // use double f[20], fq[20], q[20], iq[20] on stack, which is
<span class="line-new-header">--- 694,11 ---</span>
      // jx = nx - 1
      lea(twoOverPiBase, ExternalAddress(two_over_pi));
      cmpw(jv, zr);
      addw(tmp4, jx, 4); // tmp4 = m = jx + jk = jx + 4. jx is in {0,1,2} so m is in [4,5,6]
      cselw(jv, jv, zr, GE);
<span class="line-modified">!     fmovd(v26, 0.0);</span>
      addw(tmp5, jv, 1);                    // jv+1
      subsw(j, jv, jx);
      add(qBase, sp, 320);                  // base of q[]
      msubw(rscratch1, i, tmp5, rscratch1); // q0 =  e0-24*(jv+1)
      // use double f[20], fq[20], q[20], iq[20] on stack, which is
</pre>
<hr />
<pre>
<span class="line-old-header">*** 817,12 ***</span>
    }
    movz(i, 0x3E70, 48);
    movw(jz, 4);
    fmovd(v17, i);                               // v17 = twon24
    fmovd(v30, tmp5);                            // 2^q0
<span class="line-modified">!   fmovd(v21, 0.125d);</span>
<span class="line-modified">!   fmovd(v20, 8.0d);</span>
    fmovd(v22, tmp4);                            // 2^-q0
  
    block_comment(&quot;recompute loop&quot;); {
      bind(RECOMPUTE);
        //  for(i=0,j=jz,z=q[jz];j&gt;0;i++,j--) {
<span class="line-new-header">--- 817,12 ---</span>
    }
    movz(i, 0x3E70, 48);
    movw(jz, 4);
    fmovd(v17, i);                               // v17 = twon24
    fmovd(v30, tmp5);                            // 2^q0
<span class="line-modified">!   fmovd(v21, 0.125);</span>
<span class="line-modified">!   fmovd(v20, 8.0);</span>
    fmovd(v22, tmp4);                            // 2^-q0
  
    block_comment(&quot;recompute loop&quot;); {
      bind(RECOMPUTE);
        //  for(i=0,j=jz,z=q[jz];j&gt;0;i++,j--) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 875,11 ***</span>
            b(Q0_ZERO_CMP_DONE);
          bind(Q0_ZERO_CMP_EQ);
            lsr(ih, tmp2, 23);                               // ih = iq[z-1] &gt;&gt; 23
            b(Q0_ZERO_CMP_DONE);
          bind(Q0_ZERO_CMP_LT);
<span class="line-modified">!           fmovd(v4, 0.5d);</span>
            fcmpd(v18, v4);
            cselw(ih, zr, ih, LT);                           // if (z&lt;0.5) ih = 0
        }
      bind(Q0_ZERO_CMP_DONE);
        cmpw(ih, zr);
<span class="line-new-header">--- 875,11 ---</span>
            b(Q0_ZERO_CMP_DONE);
          bind(Q0_ZERO_CMP_EQ);
            lsr(ih, tmp2, 23);                               // ih = iq[z-1] &gt;&gt; 23
            b(Q0_ZERO_CMP_DONE);
          bind(Q0_ZERO_CMP_LT);
<span class="line-modified">!           fmovd(v4, 0.5);</span>
            fcmpd(v18, v4);
            cselw(ih, zr, ih, LT);                           // if (z&lt;0.5) ih = 0
        }
      bind(Q0_ZERO_CMP_DONE);
        cmpw(ih, zr);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 922,19 ***</span>
        bind(IH_AFTER_SWITCH);
          cmpw(ih, 2);
          br(NE, IH_HANDLED);
  
          block_comment(&quot;if(ih==2) {&quot;); {
<span class="line-modified">!           fmovd(v25, 1.0d);</span>
            fsubd(v18, v25, v18);                            // z = one - z;
            cbzw(rscratch2, IH_HANDLED);
            fsubd(v18, v18, v30);                            // z -= scalbnA(one,q0);
          }
      }
      bind(IH_HANDLED);
        // check if recomputation is needed
<span class="line-modified">!       fcmpd(v18, 0.0d);</span>
        br(NE, RECOMP_CHECK_DONE_NOT_ZERO);
  
        block_comment(&quot;if(z==zeroB) {&quot;); {
  
          block_comment(&quot;for (i=jz-1;i&gt;=jk;i--) j |= iq[i];&quot;); {
<span class="line-new-header">--- 922,19 ---</span>
        bind(IH_AFTER_SWITCH);
          cmpw(ih, 2);
          br(NE, IH_HANDLED);
  
          block_comment(&quot;if(ih==2) {&quot;); {
<span class="line-modified">!           fmovd(v25, 1.0);</span>
            fsubd(v18, v25, v18);                            // z = one - z;
            cbzw(rscratch2, IH_HANDLED);
            fsubd(v18, v18, v30);                            // z -= scalbnA(one,q0);
          }
      }
      bind(IH_HANDLED);
        // check if recomputation is needed
<span class="line-modified">!       fcmpd(v18, 0.0);</span>
        br(NE, RECOMP_CHECK_DONE_NOT_ZERO);
  
        block_comment(&quot;if(z==zeroB) {&quot;); {
  
          block_comment(&quot;for (i=jz-1;i&gt;=jk;i--) j |= iq[i];&quot;); {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 992,11 ***</span>
          }
        }
      }
      bind(RECOMP_CHECK_DONE);
        // chop off zero terms
<span class="line-modified">!       fcmpd(v18, 0.0d);</span>
        br(EQ, Z_IS_ZERO);
  
        block_comment(&quot;else block of if(z==0.0) {&quot;); {
          bind(RECOMP_CHECK_DONE_NOT_ZERO);
            fmuld(v18, v18, v22);
<span class="line-new-header">--- 992,11 ---</span>
          }
        }
      }
      bind(RECOMP_CHECK_DONE);
        // chop off zero terms
<span class="line-modified">!       fcmpd(v18, 0.0);</span>
        br(EQ, Z_IS_ZERO);
  
        block_comment(&quot;else block of if(z==0.0) {&quot;); {
          bind(RECOMP_CHECK_DONE_NOT_ZERO);
            fmuld(v18, v18, v22);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1051,11 ***</span>
        block_comment(&quot;compute PIo2[0,...,jp]*q[jz,...,0]. for(i=jz;i&gt;=0;i--) {...}&quot;); {
            movw(i, jz);
            movw(tmp2, zr); // tmp2 will keep jz - i == 0 at start
          bind(COMP_FOR);
            // for(fw=0.0,k=0;k&lt;=jp&amp;&amp;k&lt;=jz-i;k++) fw += PIo2[k]*q[i+k];
<span class="line-modified">!           fmovd(v30, 0.0d);</span>
            add(tmp5, qBase, i, LSL, 3); // address of q[i+k] for k==0
            movw(tmp3, 4);
            movw(tmp4, zr);              // used as k
            cmpw(tmp2, 4);
            add(tmp1, qBase, i, LSL, 3); // used as q[i] address
<span class="line-new-header">--- 1051,11 ---</span>
        block_comment(&quot;compute PIo2[0,...,jp]*q[jz,...,0]. for(i=jz;i&gt;=0;i--) {...}&quot;); {
            movw(i, jz);
            movw(tmp2, zr); // tmp2 will keep jz - i == 0 at start
          bind(COMP_FOR);
            // for(fw=0.0,k=0;k&lt;=jp&amp;&amp;k&lt;=jz-i;k++) fw += PIo2[k]*q[i+k];
<span class="line-modified">!           fmovd(v30, 0.0);</span>
            add(tmp5, qBase, i, LSL, 3); // address of q[i+k] for k==0
            movw(tmp3, 4);
            movw(tmp4, zr);              // used as k
            cmpw(tmp2, 4);
            add(tmp1, qBase, i, LSL, 3); // used as q[i] address
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1079,11 ***</span>
        block_comment(&quot;switch(prec) {...}. case 2:&quot;); {
          // compress fq into y[]
          // remember prec == 2
  
          block_comment(&quot;for (i=jz;i&gt;=0;i--) fw += fq[i];&quot;); {
<span class="line-modified">!             fmovd(v4, 0.0d);</span>
              mov(i, jz);
            bind(FW_FOR1);
              ldrd(v1, Address(rscratch2, i, Address::lsl(3)));
              subsw(i, i, 1);
              faddd(v4, v4, v1);
<span class="line-new-header">--- 1079,11 ---</span>
        block_comment(&quot;switch(prec) {...}. case 2:&quot;); {
          // compress fq into y[]
          // remember prec == 2
  
          block_comment(&quot;for (i=jz;i&gt;=0;i--) fw += fq[i];&quot;); {
<span class="line-modified">!             fmovd(v4, 0.0);</span>
              mov(i, jz);
            bind(FW_FOR1);
              ldrd(v1, Address(rscratch2, i, Address::lsl(3)));
              subsw(i, i, 1);
              faddd(v4, v4, v1);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1317,21 ***</span>
      ldpd(C5, C6, Address(rscratch2, 32));         // load C5, C6
      fmuld(z, x, x);                               // z=x^2
      ld1(C1, C2, C3, C4, T1D, Address(rscratch2)); // load C1..C3\4
      block_comment(&quot;calculate r = z*(C1+z*(C2+z*(C3+z*(C4+z*(C5+z*C6)))))&quot;); {
        fmaddd(r, z, C6, C5);
<span class="line-modified">!       fmovd(half, 0.5d);</span>
        fmaddd(r, z, r, C4);
        fmuld(y, x, y);
        fmaddd(r, z, r, C3);
        mov(rscratch1, 0x3FD33333);
        fmaddd(r, z, r, C2);
        fmuld(x, z, z);                             // x = z^2
        fmaddd(r, z, r, C1);                        // r = C1+z(C2+z(C4+z(C5+z*C6)))
      }
      // need to multiply r by z to have &quot;final&quot; r value
<span class="line-modified">!     fmovd(one, 1.0d);</span>
      cmp(ix, rscratch1);
      br(GT, IX_IS_LARGE);
      block_comment(&quot;if(ix &lt; 0x3FD33333) return one - (0.5*z - (z*r - x*y))&quot;); {
        // return 1.0 - (0.5*z - (z*r - x*y)) = 1.0 - (0.5*z + (x*y - z*r))
        fmsubd(v0, x, r, y);
<span class="line-new-header">--- 1317,21 ---</span>
      ldpd(C5, C6, Address(rscratch2, 32));         // load C5, C6
      fmuld(z, x, x);                               // z=x^2
      ld1(C1, C2, C3, C4, T1D, Address(rscratch2)); // load C1..C3\4
      block_comment(&quot;calculate r = z*(C1+z*(C2+z*(C3+z*(C4+z*(C5+z*C6)))))&quot;); {
        fmaddd(r, z, C6, C5);
<span class="line-modified">!       fmovd(half, 0.5);</span>
        fmaddd(r, z, r, C4);
        fmuld(y, x, y);
        fmaddd(r, z, r, C3);
        mov(rscratch1, 0x3FD33333);
        fmaddd(r, z, r, C2);
        fmuld(x, z, z);                             // x = z^2
        fmaddd(r, z, r, C1);                        // r = C1+z(C2+z(C4+z(C5+z*C6)))
      }
      // need to multiply r by z to have &quot;final&quot; r value
<span class="line-modified">!     fmovd(one, 1.0);</span>
      cmp(ix, rscratch1);
      br(GT, IX_IS_LARGE);
      block_comment(&quot;if(ix &lt; 0x3FD33333) return one - (0.5*z - (z*r - x*y))&quot;); {
        // return 1.0 - (0.5*z - (z*r - x*y)) = 1.0 - (0.5*z + (x*y - z*r))
        fmsubd(v0, x, r, y);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1350,11 ***</span>
          fmovd(qx, rscratch2);
        }
        b(QX_SET);
      bind(SET_QX_CONST);
        block_comment(&quot;if(ix &gt; 0x3fe90000) qx = 0.28125;&quot;); {
<span class="line-modified">!         fmovd(qx, 0.28125d);</span>
        }
      bind(QX_SET);
        fnmsub(C6, x, r, y);    // z*r - xy
        fnmsub(h, half, z, qx); // h = 0.5*z - qx
        fsubd(a, one, qx);      // a = 1-qx
<span class="line-new-header">--- 1350,11 ---</span>
          fmovd(qx, rscratch2);
        }
        b(QX_SET);
      bind(SET_QX_CONST);
        block_comment(&quot;if(ix &gt; 0x3fe90000) qx = 0.28125;&quot;); {
<span class="line-modified">!         fmovd(qx, 0.28125);</span>
        }
      bind(QX_SET);
        fnmsub(C6, x, r, y);    // z*r - xy
        fnmsub(h, half, z, qx); // h = 0.5*z - qx
        fsubd(a, one, qx);      // a = 1-qx
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1441,11 ***</span>
        ret(lr);
      }
    block_comment(&quot;kernel_sin/kernel_cos: if(ix&lt;0x3e400000) {&lt;fast return&gt;}&quot;); {
      bind(TINY_X);
        if (isCos) {
<span class="line-modified">!         fmovd(v0, 1.0d);</span>
        }
        ret(lr);
    }
    bind(ARG_REDUCTION); /* argument reduction needed */
      block_comment(&quot;n = __ieee754_rem_pio2(x,y);&quot;); {
<span class="line-new-header">--- 1441,11 ---</span>
        ret(lr);
      }
    block_comment(&quot;kernel_sin/kernel_cos: if(ix&lt;0x3e400000) {&lt;fast return&gt;}&quot;); {
      bind(TINY_X);
        if (isCos) {
<span class="line-modified">!         fmovd(v0, 1.0);</span>
        }
        ret(lr);
    }
    bind(ARG_REDUCTION); /* argument reduction needed */
      block_comment(&quot;n = __ieee754_rem_pio2(x,y);&quot;); {
</pre>
<center><a href="macroAssembler_aarch64_log.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="nativeInst_aarch64.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>