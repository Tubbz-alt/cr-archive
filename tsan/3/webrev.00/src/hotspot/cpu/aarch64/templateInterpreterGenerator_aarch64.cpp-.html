<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/cpu/aarch64/templateInterpreterGenerator_aarch64.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2003, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * Copyright (c) 2014, 2019, Red Hat Inc. All rights reserved.
   4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   5  *
   6  * This code is free software; you can redistribute it and/or modify it
   7  * under the terms of the GNU General Public License version 2 only, as
   8  * published by the Free Software Foundation.
   9  *
  10  * This code is distributed in the hope that it will be useful, but WITHOUT
  11  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  12  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  13  * version 2 for more details (a copy is included in the LICENSE file that
  14  * accompanied this code).
  15  *
  16  * You should have received a copy of the GNU General Public License version
  17  * 2 along with this work; if not, write to the Free Software Foundation,
  18  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  19  *
  20  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  21  * or visit www.oracle.com if you need additional information or have any
  22  * questions.
  23  *
  24  */
  25 
  26 #include &quot;precompiled.hpp&quot;
  27 #include &quot;asm/macroAssembler.inline.hpp&quot;
  28 #include &quot;gc/shared/barrierSetAssembler.hpp&quot;
  29 #include &quot;interpreter/bytecodeHistogram.hpp&quot;
  30 #include &quot;interpreter/interpreter.hpp&quot;
  31 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  32 #include &quot;interpreter/interp_masm.hpp&quot;
  33 #include &quot;interpreter/templateInterpreterGenerator.hpp&quot;
  34 #include &quot;interpreter/templateTable.hpp&quot;
  35 #include &quot;interpreter/bytecodeTracer.hpp&quot;
  36 #include &quot;memory/resourceArea.hpp&quot;
  37 #include &quot;oops/arrayOop.hpp&quot;
  38 #include &quot;oops/methodData.hpp&quot;
  39 #include &quot;oops/method.hpp&quot;
  40 #include &quot;oops/oop.inline.hpp&quot;
  41 #include &quot;prims/jvmtiExport.hpp&quot;
  42 #include &quot;prims/jvmtiThreadState.hpp&quot;
  43 #include &quot;runtime/arguments.hpp&quot;
  44 #include &quot;runtime/deoptimization.hpp&quot;
  45 #include &quot;runtime/frame.inline.hpp&quot;
  46 #include &quot;runtime/sharedRuntime.hpp&quot;
  47 #include &quot;runtime/stubRoutines.hpp&quot;
  48 #include &quot;runtime/synchronizer.hpp&quot;
  49 #include &quot;runtime/timer.hpp&quot;
  50 #include &quot;runtime/vframeArray.hpp&quot;
  51 #include &quot;utilities/debug.hpp&quot;
  52 #include &lt;sys/types.h&gt;
  53 
  54 #ifndef PRODUCT
  55 #include &quot;oops/method.hpp&quot;
  56 #endif // !PRODUCT
  57 
  58 #ifdef BUILTIN_SIM
  59 #include &quot;../../../../../../simulator/simulator.hpp&quot;
  60 #endif
  61 
  62 // Size of interpreter code.  Increase if too small.  Interpreter will
  63 // fail with a guarantee (&quot;not enough space for interpreter generation&quot;);
  64 // if too small.
  65 // Run with +PrintInterpreter to get the VM to print out the size.
  66 // Max size with JVMTI
  67 int TemplateInterpreter::InterpreterCodeSize = 200 * 1024;
  68 
  69 #define __ _masm-&gt;
  70 
  71 //-----------------------------------------------------------------------------
  72 
  73 extern &quot;C&quot; void entry(CodeBuffer*);
  74 
  75 //-----------------------------------------------------------------------------
  76 
  77 address TemplateInterpreterGenerator::generate_slow_signature_handler() {
  78   address entry = __ pc();
  79 
  80   __ andr(esp, esp, -16);
  81   __ mov(c_rarg3, esp);
  82   // rmethod
  83   // rlocals
  84   // c_rarg3: first stack arg - wordSize
  85 
  86   // adjust sp
  87   __ sub(sp, c_rarg3, 18 * wordSize);
  88   __ str(lr, Address(__ pre(sp, -2 * wordSize)));
  89   __ call_VM(noreg,
  90              CAST_FROM_FN_PTR(address,
  91                               InterpreterRuntime::slow_signature_handler),
  92              rmethod, rlocals, c_rarg3);
  93 
  94   // r0: result handler
  95 
  96   // Stack layout:
  97   // rsp: return address           &lt;- sp
  98   //      1 garbage
  99   //      8 integer args (if static first is unused)
 100   //      1 float/double identifiers
 101   //      8 double args
 102   //        stack args              &lt;- esp
 103   //        garbage
 104   //        expression stack bottom
 105   //        bcp (NULL)
 106   //        ...
 107 
 108   // Restore LR
 109   __ ldr(lr, Address(__ post(sp, 2 * wordSize)));
 110 
 111   // Do FP first so we can use c_rarg3 as temp
 112   __ ldrw(c_rarg3, Address(sp, 9 * wordSize)); // float/double identifiers
 113 
 114   for (int i = 0; i &lt; Argument::n_float_register_parameters_c; i++) {
 115     const FloatRegister r = as_FloatRegister(i);
 116 
 117     Label d, done;
 118 
 119     __ tbnz(c_rarg3, i, d);
 120     __ ldrs(r, Address(sp, (10 + i) * wordSize));
 121     __ b(done);
 122     __ bind(d);
 123     __ ldrd(r, Address(sp, (10 + i) * wordSize));
 124     __ bind(done);
 125   }
 126 
 127   // c_rarg0 contains the result from the call of
 128   // InterpreterRuntime::slow_signature_handler so we don&#39;t touch it
 129   // here.  It will be loaded with the JNIEnv* later.
 130   __ ldr(c_rarg1, Address(sp, 1 * wordSize));
 131   for (int i = c_rarg2-&gt;encoding(); i &lt;= c_rarg7-&gt;encoding(); i += 2) {
 132     Register rm = as_Register(i), rn = as_Register(i+1);
 133     __ ldp(rm, rn, Address(sp, i * wordSize));
 134   }
 135 
 136   __ add(sp, sp, 18 * wordSize);
 137   __ ret(lr);
 138 
 139   return entry;
 140 }
 141 
 142 
 143 //
 144 // Various method entries
 145 //
 146 
 147 address TemplateInterpreterGenerator::generate_math_entry(AbstractInterpreter::MethodKind kind) {
 148   // rmethod: Method*
 149   // r13: sender sp
 150   // esp: args
 151 
 152   if (!InlineIntrinsics) return NULL; // Generate a vanilla entry
 153 
 154   // These don&#39;t need a safepoint check because they aren&#39;t virtually
 155   // callable. We won&#39;t enter these intrinsics from compiled code.
 156   // If in the future we added an intrinsic which was virtually callable
 157   // we&#39;d have to worry about how to safepoint so that this code is used.
 158 
 159   // mathematical functions inlined by compiler
 160   // (interpreter must provide identical implementation
 161   // in order to avoid monotonicity bugs when switching
 162   // from interpreter to compiler in the middle of some
 163   // computation)
 164   //
 165   // stack:
 166   //        [ arg ] &lt;-- esp
 167   //        [ arg ]
 168   // retaddr in lr
 169 
 170   address entry_point = NULL;
 171   Register continuation = lr;
 172   switch (kind) {
 173   case Interpreter::java_lang_math_abs:
 174     entry_point = __ pc();
 175     __ ldrd(v0, Address(esp));
 176     __ fabsd(v0, v0);
 177     __ mov(sp, r13); // Restore caller&#39;s SP
 178     break;
 179   case Interpreter::java_lang_math_sqrt:
 180     entry_point = __ pc();
 181     __ ldrd(v0, Address(esp));
 182     __ fsqrtd(v0, v0);
 183     __ mov(sp, r13);
 184     break;
 185   case Interpreter::java_lang_math_sin :
 186   case Interpreter::java_lang_math_cos :
 187   case Interpreter::java_lang_math_tan :
 188   case Interpreter::java_lang_math_log :
 189   case Interpreter::java_lang_math_log10 :
 190   case Interpreter::java_lang_math_exp :
 191     entry_point = __ pc();
 192     __ ldrd(v0, Address(esp));
 193     __ mov(sp, r13);
 194     __ mov(r19, lr);
 195     continuation = r19;  // The first callee-saved register
 196     generate_transcendental_entry(kind, 1);
 197     break;
 198   case Interpreter::java_lang_math_pow :
 199     entry_point = __ pc();
 200     __ mov(r19, lr);
 201     continuation = r19;
 202     __ ldrd(v0, Address(esp, 2 * Interpreter::stackElementSize));
 203     __ ldrd(v1, Address(esp));
 204     __ mov(sp, r13);
 205     generate_transcendental_entry(kind, 2);
 206     break;
 207   case Interpreter::java_lang_math_fmaD :
 208     if (UseFMA) {
 209       entry_point = __ pc();
 210       __ ldrd(v0, Address(esp, 4 * Interpreter::stackElementSize));
 211       __ ldrd(v1, Address(esp, 2 * Interpreter::stackElementSize));
 212       __ ldrd(v2, Address(esp));
 213       __ fmaddd(v0, v0, v1, v2);
 214       __ mov(sp, r13); // Restore caller&#39;s SP
 215     }
 216     break;
 217   case Interpreter::java_lang_math_fmaF :
 218     if (UseFMA) {
 219       entry_point = __ pc();
 220       __ ldrs(v0, Address(esp, 2 * Interpreter::stackElementSize));
 221       __ ldrs(v1, Address(esp, Interpreter::stackElementSize));
 222       __ ldrs(v2, Address(esp));
 223       __ fmadds(v0, v0, v1, v2);
 224       __ mov(sp, r13); // Restore caller&#39;s SP
 225     }
 226     break;
 227   default:
 228     ;
 229   }
 230   if (entry_point) {
 231     __ br(continuation);
 232   }
 233 
 234   return entry_point;
 235 }
 236 
 237   // double trigonometrics and transcendentals
 238   // static jdouble dsin(jdouble x);
 239   // static jdouble dcos(jdouble x);
 240   // static jdouble dtan(jdouble x);
 241   // static jdouble dlog(jdouble x);
 242   // static jdouble dlog10(jdouble x);
 243   // static jdouble dexp(jdouble x);
 244   // static jdouble dpow(jdouble x, jdouble y);
 245 
 246 void TemplateInterpreterGenerator::generate_transcendental_entry(AbstractInterpreter::MethodKind kind, int fpargs) {
 247   address fn;
 248   switch (kind) {
 249   case Interpreter::java_lang_math_sin :
 250     if (StubRoutines::dsin() == NULL) {
 251       fn = CAST_FROM_FN_PTR(address, SharedRuntime::dsin);
 252     } else {
 253       fn = CAST_FROM_FN_PTR(address, StubRoutines::dsin());
 254     }
 255     break;
 256   case Interpreter::java_lang_math_cos :
 257     if (StubRoutines::dcos() == NULL) {
 258       fn = CAST_FROM_FN_PTR(address, SharedRuntime::dcos);
 259     } else {
 260       fn = CAST_FROM_FN_PTR(address, StubRoutines::dcos());
 261     }
 262     break;
 263   case Interpreter::java_lang_math_tan :
 264     if (StubRoutines::dtan() == NULL) {
 265       fn = CAST_FROM_FN_PTR(address, SharedRuntime::dtan);
 266     } else {
 267       fn = CAST_FROM_FN_PTR(address, StubRoutines::dtan());
 268     }
 269     break;
 270   case Interpreter::java_lang_math_log :
 271     if (StubRoutines::dlog() == NULL) {
 272       fn = CAST_FROM_FN_PTR(address, SharedRuntime::dlog);
 273     } else {
 274       fn = CAST_FROM_FN_PTR(address, StubRoutines::dlog());
 275     }
 276     break;
 277   case Interpreter::java_lang_math_log10 :
 278     if (StubRoutines::dlog10() == NULL) {
 279       fn = CAST_FROM_FN_PTR(address, SharedRuntime::dlog10);
 280     } else {
 281       fn = CAST_FROM_FN_PTR(address, StubRoutines::dlog10());
 282     }
 283     break;
 284   case Interpreter::java_lang_math_exp :
 285     if (StubRoutines::dexp() == NULL) {
 286       fn = CAST_FROM_FN_PTR(address, SharedRuntime::dexp);
 287     } else {
 288       fn = CAST_FROM_FN_PTR(address, StubRoutines::dexp());
 289     }
 290     break;
 291   case Interpreter::java_lang_math_pow :
 292     fpargs = 2;
 293     if (StubRoutines::dpow() == NULL) {
 294       fn = CAST_FROM_FN_PTR(address, SharedRuntime::dpow);
 295     } else {
 296       fn = CAST_FROM_FN_PTR(address, StubRoutines::dpow());
 297     }
 298     break;
 299   default:
 300     ShouldNotReachHere();
 301     fn = NULL;  // unreachable
 302   }
 303   const int gpargs = 0, rtype = 3;
 304   __ mov(rscratch1, fn);
 305   __ blrt(rscratch1, gpargs, fpargs, rtype);
 306 }
 307 
 308 // Abstract method entry
 309 // Attempt to execute abstract method. Throw exception
 310 address TemplateInterpreterGenerator::generate_abstract_entry(void) {
 311   // rmethod: Method*
 312   // r13: sender SP
 313 
 314   address entry_point = __ pc();
 315 
 316   // abstract method entry
 317 
 318   //  pop return address, reset last_sp to NULL
 319   __ empty_expression_stack();
 320   __ restore_bcp();      // bcp must be correct for exception handler   (was destroyed)
 321   __ restore_locals();   // make sure locals pointer is correct as well (was destroyed)
 322 
 323   // throw exception
 324   __ call_VM(noreg, CAST_FROM_FN_PTR(address,
 325                                      InterpreterRuntime::throw_AbstractMethodErrorWithMethod),
 326                                      rmethod);
 327   // the call_VM checks for exception, so we should never return here.
 328   __ should_not_reach_here();
 329 
 330   return entry_point;
 331 }
 332 
 333 address TemplateInterpreterGenerator::generate_StackOverflowError_handler() {
 334   address entry = __ pc();
 335 
 336 #ifdef ASSERT
 337   {
 338     Label L;
 339     __ ldr(rscratch1, Address(rfp,
 340                        frame::interpreter_frame_monitor_block_top_offset *
 341                        wordSize));
 342     __ mov(rscratch2, sp);
 343     __ cmp(rscratch1, rscratch2); // maximal rsp for current rfp (stack
 344                            // grows negative)
 345     __ br(Assembler::HS, L); // check if frame is complete
 346     __ stop (&quot;interpreter frame not set up&quot;);
 347     __ bind(L);
 348   }
 349 #endif // ASSERT
 350   // Restore bcp under the assumption that the current frame is still
 351   // interpreted
 352   __ restore_bcp();
 353 
 354   // expression stack must be empty before entering the VM if an
 355   // exception happened
 356   __ empty_expression_stack();
 357   // throw exception
 358   __ call_VM(noreg,
 359              CAST_FROM_FN_PTR(address,
 360                               InterpreterRuntime::throw_StackOverflowError));
 361   return entry;
 362 }
 363 
 364 address TemplateInterpreterGenerator::generate_ArrayIndexOutOfBounds_handler() {
 365   address entry = __ pc();
 366   // expression stack must be empty before entering the VM if an
 367   // exception happened
 368   __ empty_expression_stack();
 369   // setup parameters
 370 
 371   // ??? convention: expect aberrant index in register r1
 372   __ movw(c_rarg2, r1);
 373   // ??? convention: expect array in register r3
 374   __ mov(c_rarg1, r3);
 375   __ call_VM(noreg,
 376              CAST_FROM_FN_PTR(address,
 377                               InterpreterRuntime::
 378                               throw_ArrayIndexOutOfBoundsException),
 379              c_rarg1, c_rarg2);
 380   return entry;
 381 }
 382 
 383 address TemplateInterpreterGenerator::generate_ClassCastException_handler() {
 384   address entry = __ pc();
 385 
 386   // object is at TOS
 387   __ pop(c_rarg1);
 388 
 389   // expression stack must be empty before entering the VM if an
 390   // exception happened
 391   __ empty_expression_stack();
 392 
 393   __ call_VM(noreg,
 394              CAST_FROM_FN_PTR(address,
 395                               InterpreterRuntime::
 396                               throw_ClassCastException),
 397              c_rarg1);
 398   return entry;
 399 }
 400 
 401 address TemplateInterpreterGenerator::generate_exception_handler_common(
 402         const char* name, const char* message, bool pass_oop) {
 403   assert(!pass_oop || message == NULL, &quot;either oop or message but not both&quot;);
 404   address entry = __ pc();
 405   if (pass_oop) {
 406     // object is at TOS
 407     __ pop(c_rarg2);
 408   }
 409   // expression stack must be empty before entering the VM if an
 410   // exception happened
 411   __ empty_expression_stack();
 412   // setup parameters
 413   __ lea(c_rarg1, Address((address)name));
 414   if (pass_oop) {
 415     __ call_VM(r0, CAST_FROM_FN_PTR(address,
 416                                     InterpreterRuntime::
 417                                     create_klass_exception),
 418                c_rarg1, c_rarg2);
 419   } else {
 420     // kind of lame ExternalAddress can&#39;t take NULL because
 421     // external_word_Relocation will assert.
 422     if (message != NULL) {
 423       __ lea(c_rarg2, Address((address)message));
 424     } else {
 425       __ mov(c_rarg2, NULL_WORD);
 426     }
 427     __ call_VM(r0,
 428                CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception),
 429                c_rarg1, c_rarg2);
 430   }
 431   // throw exception
 432   __ b(address(Interpreter::throw_exception_entry()));
 433   return entry;
 434 }
 435 
 436 address TemplateInterpreterGenerator::generate_return_entry_for(TosState state, int step, size_t index_size) {
 437   address entry = __ pc();
 438 
 439   // Restore stack bottom in case i2c adjusted stack
 440   __ ldr(esp, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
 441   // and NULL it as marker that esp is now tos until next java call
 442   __ str(zr, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
 443   __ restore_bcp();
 444   __ restore_locals();
 445   __ restore_constant_pool_cache();
 446   __ get_method(rmethod);
 447 
 448   if (state == atos) {
 449     Register obj = r0;
 450     Register mdp = r1;
 451     Register tmp = r2;
 452     __ ldr(mdp, Address(rmethod, Method::method_data_offset()));
 453     __ profile_return_type(mdp, obj, tmp);
 454   }
 455 
 456   // Pop N words from the stack
 457   __ get_cache_and_index_at_bcp(r1, r2, 1, index_size);
 458   __ ldr(r1, Address(r1, ConstantPoolCache::base_offset() + ConstantPoolCacheEntry::flags_offset()));
 459   __ andr(r1, r1, ConstantPoolCacheEntry::parameter_size_mask);
 460 
 461   __ add(esp, esp, r1, Assembler::LSL, 3);
 462 
 463   // Restore machine SP
 464   __ ldr(rscratch1, Address(rmethod, Method::const_offset()));
 465   __ ldrh(rscratch1, Address(rscratch1, ConstMethod::max_stack_offset()));
 466   __ add(rscratch1, rscratch1, frame::interpreter_frame_monitor_size() + 2);
 467   __ ldr(rscratch2,
 468          Address(rfp, frame::interpreter_frame_initial_sp_offset * wordSize));
 469   __ sub(rscratch1, rscratch2, rscratch1, ext::uxtw, 3);
 470   __ andr(sp, rscratch1, -16);
 471 
 472 #ifndef PRODUCT
 473   // tell the simulator that the method has been reentered
 474   if (NotifySimulator) {
 475     __ notify(Assembler::method_reentry);
 476   }
 477 #endif
 478 
 479  __ check_and_handle_popframe(rthread);
 480  __ check_and_handle_earlyret(rthread);
 481 
 482   __ get_dispatch();
 483   __ dispatch_next(state, step);
 484 
 485   return entry;
 486 }
 487 
 488 address TemplateInterpreterGenerator::generate_deopt_entry_for(TosState state,
 489                                                                int step,
 490                                                                address continuation) {
 491   address entry = __ pc();
 492   __ restore_bcp();
 493   __ restore_locals();
 494   __ restore_constant_pool_cache();
 495   __ get_method(rmethod);
 496   __ get_dispatch();
 497 
 498   // Calculate stack limit
 499   __ ldr(rscratch1, Address(rmethod, Method::const_offset()));
 500   __ ldrh(rscratch1, Address(rscratch1, ConstMethod::max_stack_offset()));
 501   __ add(rscratch1, rscratch1, frame::interpreter_frame_monitor_size() + 2);
 502   __ ldr(rscratch2,
 503          Address(rfp, frame::interpreter_frame_initial_sp_offset * wordSize));
 504   __ sub(rscratch1, rscratch2, rscratch1, ext::uxtx, 3);
 505   __ andr(sp, rscratch1, -16);
 506 
 507   // Restore expression stack pointer
 508   __ ldr(esp, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
 509   // NULL last_sp until next java call
 510   __ str(zr, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
 511 
 512 #if INCLUDE_JVMCI
 513   // Check if we need to take lock at entry of synchronized method.  This can
 514   // only occur on method entry so emit it only for vtos with step 0.
 515   if ((EnableJVMCI || UseAOT) &amp;&amp; state == vtos &amp;&amp; step == 0) {
 516     Label L;
 517     __ ldr(rscratch1, Address(rthread, Thread::pending_exception_offset()));
 518     __ cbz(rscratch1, L);
 519     // Clear flag.
 520     __ strb(zr, Address(rthread, JavaThread::pending_monitorenter_offset()));
 521     // Take lock.
 522     lock_method();
 523     __ bind(L);
 524   } else {
 525 #ifdef ASSERT
 526     if (EnableJVMCI) {
 527       Label L;
 528       __ ldr(rscratch1, Address(rthread, Thread::pending_exception_offset()));
 529       __ cbz(rscratch1, L);
 530       __ stop(&quot;unexpected pending monitor in deopt entry&quot;);
 531       __ bind(L);
 532     }
 533 #endif
 534   }
 535 #endif
 536   // handle exceptions
 537   {
 538     Label L;
 539     __ ldr(rscratch1, Address(rthread, Thread::pending_exception_offset()));
 540     __ cbz(rscratch1, L);
 541     __ call_VM(noreg,
 542                CAST_FROM_FN_PTR(address,
 543                                 InterpreterRuntime::throw_pending_exception));
 544     __ should_not_reach_here();
 545     __ bind(L);
 546   }
 547 
 548   if (continuation == NULL) {
 549     __ dispatch_next(state, step);
 550   } else {
 551     __ jump_to_entry(continuation);
 552   }
 553   return entry;
 554 }
 555 
 556 address TemplateInterpreterGenerator::generate_result_handler_for(
 557         BasicType type) {
 558     address entry = __ pc();
 559   switch (type) {
 560   case T_BOOLEAN: __ c2bool(r0);         break;
 561   case T_CHAR   : __ uxth(r0, r0);       break;
 562   case T_BYTE   : __ sxtb(r0, r0);        break;
 563   case T_SHORT  : __ sxth(r0, r0);        break;
 564   case T_INT    : __ uxtw(r0, r0);        break;  // FIXME: We almost certainly don&#39;t need this
 565   case T_LONG   : /* nothing to do */        break;
 566   case T_VOID   : /* nothing to do */        break;
 567   case T_FLOAT  : /* nothing to do */        break;
 568   case T_DOUBLE : /* nothing to do */        break;
 569   case T_OBJECT :
 570     // retrieve result from frame
 571     __ ldr(r0, Address(rfp, frame::interpreter_frame_oop_temp_offset*wordSize));
 572     // and verify it
 573     __ verify_oop(r0);
 574     break;
 575   default       : ShouldNotReachHere();
 576   }
 577   __ ret(lr);                                  // return from result handler
 578   return entry;
 579 }
 580 
 581 address TemplateInterpreterGenerator::generate_safept_entry_for(
 582         TosState state,
 583         address runtime_entry) {
 584   address entry = __ pc();
 585   __ push(state);
 586   __ call_VM(noreg, runtime_entry);
 587   __ membar(Assembler::AnyAny);
 588   __ dispatch_via(vtos, Interpreter::_normal_table.table_for(vtos));
 589   return entry;
 590 }
 591 
 592 // Helpers for commoning out cases in the various type of method entries.
 593 //
 594 
 595 
 596 // increment invocation count &amp; check for overflow
 597 //
 598 // Note: checking for negative value instead of overflow
 599 //       so we have a &#39;sticky&#39; overflow test
 600 //
 601 // rmethod: method
 602 //
 603 void TemplateInterpreterGenerator::generate_counter_incr(
 604         Label* overflow,
 605         Label* profile_method,
 606         Label* profile_method_continue) {
 607   Label done;
 608   // Note: In tiered we increment either counters in Method* or in MDO depending if we&#39;re profiling or not.
 609   if (TieredCompilation) {
 610     int increment = InvocationCounter::count_increment;
 611     Label no_mdo;
 612     if (ProfileInterpreter) {
 613       // Are we profiling?
 614       __ ldr(r0, Address(rmethod, Method::method_data_offset()));
 615       __ cbz(r0, no_mdo);
 616       // Increment counter in the MDO
 617       const Address mdo_invocation_counter(r0, in_bytes(MethodData::invocation_counter_offset()) +
 618                                                 in_bytes(InvocationCounter::counter_offset()));
 619       const Address mask(r0, in_bytes(MethodData::invoke_mask_offset()));
 620       __ increment_mask_and_jump(mdo_invocation_counter, increment, mask, rscratch1, rscratch2, false, Assembler::EQ, overflow);
 621       __ b(done);
 622     }
 623     __ bind(no_mdo);
 624     // Increment counter in MethodCounters
 625     const Address invocation_counter(rscratch2,
 626                   MethodCounters::invocation_counter_offset() +
 627                   InvocationCounter::counter_offset());
 628     __ get_method_counters(rmethod, rscratch2, done);
 629     const Address mask(rscratch2, in_bytes(MethodCounters::invoke_mask_offset()));
 630     __ increment_mask_and_jump(invocation_counter, increment, mask, rscratch1, r1, false, Assembler::EQ, overflow);
 631     __ bind(done);
 632   } else { // not TieredCompilation
 633     const Address backedge_counter(rscratch2,
 634                   MethodCounters::backedge_counter_offset() +
 635                   InvocationCounter::counter_offset());
 636     const Address invocation_counter(rscratch2,
 637                   MethodCounters::invocation_counter_offset() +
 638                   InvocationCounter::counter_offset());
 639 
 640     __ get_method_counters(rmethod, rscratch2, done);
 641 
 642     if (ProfileInterpreter) { // %%% Merge this into MethodData*
 643       __ ldrw(r1, Address(rscratch2, MethodCounters::interpreter_invocation_counter_offset()));
 644       __ addw(r1, r1, 1);
 645       __ strw(r1, Address(rscratch2, MethodCounters::interpreter_invocation_counter_offset()));
 646     }
 647     // Update standard invocation counters
 648     __ ldrw(r1, invocation_counter);
 649     __ ldrw(r0, backedge_counter);
 650 
 651     __ addw(r1, r1, InvocationCounter::count_increment);
 652     __ andw(r0, r0, InvocationCounter::count_mask_value);
 653 
 654     __ strw(r1, invocation_counter);
 655     __ addw(r0, r0, r1);                // add both counters
 656 
 657     // profile_method is non-null only for interpreted method so
 658     // profile_method != NULL == !native_call
 659 
 660     if (ProfileInterpreter &amp;&amp; profile_method != NULL) {
 661       // Test to see if we should create a method data oop
 662       __ ldr(rscratch2, Address(rmethod, Method::method_counters_offset()));
 663       __ ldrw(rscratch2, Address(rscratch2, in_bytes(MethodCounters::interpreter_profile_limit_offset())));
 664       __ cmpw(r0, rscratch2);
 665       __ br(Assembler::LT, *profile_method_continue);
 666 
 667       // if no method data exists, go to profile_method
 668       __ test_method_data_pointer(rscratch2, *profile_method);
 669     }
 670 
 671     {
 672       __ ldr(rscratch2, Address(rmethod, Method::method_counters_offset()));
 673       __ ldrw(rscratch2, Address(rscratch2, in_bytes(MethodCounters::interpreter_invocation_limit_offset())));
 674       __ cmpw(r0, rscratch2);
 675       __ br(Assembler::HS, *overflow);
 676     }
 677     __ bind(done);
 678   }
 679 }
 680 
 681 void TemplateInterpreterGenerator::generate_counter_overflow(Label&amp; do_continue) {
 682 
 683   // Asm interpreter on entry
 684   // On return (i.e. jump to entry_point) [ back to invocation of interpreter ]
 685   // Everything as it was on entry
 686 
 687   // InterpreterRuntime::frequency_counter_overflow takes two
 688   // arguments, the first (thread) is passed by call_VM, the second
 689   // indicates if the counter overflow occurs at a backwards branch
 690   // (NULL bcp).  We pass zero for it.  The call returns the address
 691   // of the verified entry point for the method or NULL if the
 692   // compilation did not complete (either went background or bailed
 693   // out).
 694   __ mov(c_rarg1, 0);
 695   __ call_VM(noreg,
 696              CAST_FROM_FN_PTR(address,
 697                               InterpreterRuntime::frequency_counter_overflow),
 698              c_rarg1);
 699 
 700   __ b(do_continue);
 701 }
 702 
 703 // See if we&#39;ve got enough room on the stack for locals plus overhead
 704 // below JavaThread::stack_overflow_limit(). If not, throw a StackOverflowError
 705 // without going through the signal handler, i.e., reserved and yellow zones
 706 // will not be made usable. The shadow zone must suffice to handle the
 707 // overflow.
 708 // The expression stack grows down incrementally, so the normal guard
 709 // page mechanism will work for that.
 710 //
 711 // NOTE: Since the additional locals are also always pushed (wasn&#39;t
 712 // obvious in generate_method_entry) so the guard should work for them
 713 // too.
 714 //
 715 // Args:
 716 //      r3: number of additional locals this frame needs (what we must check)
 717 //      rmethod: Method*
 718 //
 719 // Kills:
 720 //      r0
 721 void TemplateInterpreterGenerator::generate_stack_overflow_check(void) {
 722 
 723   // monitor entry size: see picture of stack set
 724   // (generate_method_entry) and frame_amd64.hpp
 725   const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 726 
 727   // total overhead size: entry_size + (saved rbp through expr stack
 728   // bottom).  be sure to change this if you add/subtract anything
 729   // to/from the overhead area
 730   const int overhead_size =
 731     -(frame::interpreter_frame_initial_sp_offset * wordSize) + entry_size;
 732 
 733   const int page_size = os::vm_page_size();
 734 
 735   Label after_frame_check;
 736 
 737   // see if the frame is greater than one page in size. If so,
 738   // then we need to verify there is enough stack space remaining
 739   // for the additional locals.
 740   //
 741   // Note that we use SUBS rather than CMP here because the immediate
 742   // field of this instruction may overflow.  SUBS can cope with this
 743   // because it is a macro that will expand to some number of MOV
 744   // instructions and a register operation.
 745   __ subs(rscratch1, r3, (page_size - overhead_size) / Interpreter::stackElementSize);
 746   __ br(Assembler::LS, after_frame_check);
 747 
 748   // compute rsp as if this were going to be the last frame on
 749   // the stack before the red zone
 750 
 751   // locals + overhead, in bytes
 752   __ mov(r0, overhead_size);
 753   __ add(r0, r0, r3, Assembler::LSL, Interpreter::logStackElementSize);  // 2 slots per parameter.
 754 
 755   const Address stack_limit(rthread, JavaThread::stack_overflow_limit_offset());
 756   __ ldr(rscratch1, stack_limit);
 757 
 758 #ifdef ASSERT
 759   Label limit_okay;
 760   // Verify that thread stack limit is non-zero.
 761   __ cbnz(rscratch1, limit_okay);
 762   __ stop(&quot;stack overflow limit is zero&quot;);
 763   __ bind(limit_okay);
 764 #endif
 765 
 766   // Add stack limit to locals.
 767   __ add(r0, r0, rscratch1);
 768 
 769   // Check against the current stack bottom.
 770   __ cmp(sp, r0);
 771   __ br(Assembler::HI, after_frame_check);
 772 
 773   // Remove the incoming args, peeling the machine SP back to where it
 774   // was in the caller.  This is not strictly necessary, but unless we
 775   // do so the stack frame may have a garbage FP; this ensures a
 776   // correct call stack that we can always unwind.  The ANDR should be
 777   // unnecessary because the sender SP in r13 is always aligned, but
 778   // it doesn&#39;t hurt.
 779   __ andr(sp, r13, -16);
 780 
 781   // Note: the restored frame is not necessarily interpreted.
 782   // Use the shared runtime version of the StackOverflowError.
 783   assert(StubRoutines::throw_StackOverflowError_entry() != NULL, &quot;stub not yet generated&quot;);
 784   __ far_jump(RuntimeAddress(StubRoutines::throw_StackOverflowError_entry()));
 785 
 786   // all done with frame size check
 787   __ bind(after_frame_check);
 788 }
 789 
 790 // Allocate monitor and lock method (asm interpreter)
 791 //
 792 // Args:
 793 //      rmethod: Method*
 794 //      rlocals: locals
 795 //
 796 // Kills:
 797 //      r0
 798 //      c_rarg0, c_rarg1, c_rarg2, c_rarg3, ...(param regs)
 799 //      rscratch1, rscratch2 (scratch regs)
 800 void TemplateInterpreterGenerator::lock_method() {
 801   // synchronize method
 802   const Address access_flags(rmethod, Method::access_flags_offset());
 803   const Address monitor_block_top(
 804         rfp,
 805         frame::interpreter_frame_monitor_block_top_offset * wordSize);
 806   const int entry_size = frame::interpreter_frame_monitor_size() * wordSize;
 807 
 808 #ifdef ASSERT
 809   {
 810     Label L;
 811     __ ldrw(r0, access_flags);
 812     __ tst(r0, JVM_ACC_SYNCHRONIZED);
 813     __ br(Assembler::NE, L);
 814     __ stop(&quot;method doesn&#39;t need synchronization&quot;);
 815     __ bind(L);
 816   }
 817 #endif // ASSERT
 818 
 819   // get synchronization object
 820   {
 821     Label done;
 822     __ ldrw(r0, access_flags);
 823     __ tst(r0, JVM_ACC_STATIC);
 824     // get receiver (assume this is frequent case)
 825     __ ldr(r0, Address(rlocals, Interpreter::local_offset_in_bytes(0)));
 826     __ br(Assembler::EQ, done);
 827     __ load_mirror(r0, rmethod);
 828 
 829 #ifdef ASSERT
 830     {
 831       Label L;
 832       __ cbnz(r0, L);
 833       __ stop(&quot;synchronization object is NULL&quot;);
 834       __ bind(L);
 835     }
 836 #endif // ASSERT
 837 
 838     __ bind(done);
 839     __ resolve(IS_NOT_NULL, r0);
 840   }
 841 
 842   // add space for monitor &amp; lock
 843   __ sub(sp, sp, entry_size); // add space for a monitor entry
 844   __ sub(esp, esp, entry_size);
 845   __ mov(rscratch1, esp);
 846   __ str(rscratch1, monitor_block_top);  // set new monitor block top
 847   // store object
 848   __ str(r0, Address(esp, BasicObjectLock::obj_offset_in_bytes()));
 849   __ mov(c_rarg1, esp); // object address
 850   __ lock_object(c_rarg1);
 851 }
 852 
 853 // Generate a fixed interpreter frame. This is identical setup for
 854 // interpreted methods and for native methods hence the shared code.
 855 //
 856 // Args:
 857 //      lr: return address
 858 //      rmethod: Method*
 859 //      rlocals: pointer to locals
 860 //      rcpool: cp cache
 861 //      stack_pointer: previous sp
 862 void TemplateInterpreterGenerator::generate_fixed_frame(bool native_call) {
 863   // initialize fixed part of activation frame
 864   if (native_call) {
 865     __ sub(esp, sp, 14 *  wordSize);
 866     __ mov(rbcp, zr);
 867     __ stp(esp, zr, Address(__ pre(sp, -14 * wordSize)));
 868     // add 2 zero-initialized slots for native calls
 869     __ stp(zr, zr, Address(sp, 12 * wordSize));
 870   } else {
 871     __ sub(esp, sp, 12 *  wordSize);
 872     __ ldr(rscratch1, Address(rmethod, Method::const_offset()));      // get ConstMethod
 873     __ add(rbcp, rscratch1, in_bytes(ConstMethod::codes_offset())); // get codebase
 874     __ stp(esp, rbcp, Address(__ pre(sp, -12 * wordSize)));
 875   }
 876 
 877   if (ProfileInterpreter) {
 878     Label method_data_continue;
 879     __ ldr(rscratch1, Address(rmethod, Method::method_data_offset()));
 880     __ cbz(rscratch1, method_data_continue);
 881     __ lea(rscratch1, Address(rscratch1, in_bytes(MethodData::data_offset())));
 882     __ bind(method_data_continue);
 883     __ stp(rscratch1, rmethod, Address(sp, 6 * wordSize));  // save Method* and mdp (method data pointer)
 884   } else {
 885     __ stp(zr, rmethod, Address(sp, 6 * wordSize));        // save Method* (no mdp)
 886   }
 887 
 888   // Get mirror and store it in the frame as GC root for this Method*
 889   __ load_mirror(rscratch1, rmethod);
 890   __ stp(rscratch1, zr, Address(sp, 4 * wordSize));
 891 
 892   __ ldr(rcpool, Address(rmethod, Method::const_offset()));
 893   __ ldr(rcpool, Address(rcpool, ConstMethod::constants_offset()));
 894   __ ldr(rcpool, Address(rcpool, ConstantPool::cache_offset_in_bytes()));
 895   __ stp(rlocals, rcpool, Address(sp, 2 * wordSize));
 896 
 897   __ stp(rfp, lr, Address(sp, 10 * wordSize));
 898   __ lea(rfp, Address(sp, 10 * wordSize));
 899 
 900   // set sender sp
 901   // leave last_sp as null
 902   __ stp(zr, r13, Address(sp, 8 * wordSize));
 903 
 904   // Move SP out of the way
 905   if (! native_call) {
 906     __ ldr(rscratch1, Address(rmethod, Method::const_offset()));
 907     __ ldrh(rscratch1, Address(rscratch1, ConstMethod::max_stack_offset()));
 908     __ add(rscratch1, rscratch1, frame::interpreter_frame_monitor_size() + 2);
 909     __ sub(rscratch1, sp, rscratch1, ext::uxtw, 3);
 910     __ andr(sp, rscratch1, -16);
 911   }
 912 }
 913 
 914 // End of helpers
 915 
 916 // Various method entries
 917 //------------------------------------------------------------------------------------------------------------------------
 918 //
 919 //
 920 
 921 // Method entry for java.lang.ref.Reference.get.
 922 address TemplateInterpreterGenerator::generate_Reference_get_entry(void) {
 923   // Code: _aload_0, _getfield, _areturn
 924   // parameter size = 1
 925   //
 926   // The code that gets generated by this routine is split into 2 parts:
 927   //    1. The &quot;intrinsified&quot; code for G1 (or any SATB based GC),
 928   //    2. The slow path - which is an expansion of the regular method entry.
 929   //
 930   // Notes:-
 931   // * In the G1 code we do not check whether we need to block for
 932   //   a safepoint. If G1 is enabled then we must execute the specialized
 933   //   code for Reference.get (except when the Reference object is null)
 934   //   so that we can log the value in the referent field with an SATB
 935   //   update buffer.
 936   //   If the code for the getfield template is modified so that the
 937   //   G1 pre-barrier code is executed when the current method is
 938   //   Reference.get() then going through the normal method entry
 939   //   will be fine.
 940   // * The G1 code can, however, check the receiver object (the instance
 941   //   of java.lang.Reference) and jump to the slow path if null. If the
 942   //   Reference object is null then we obviously cannot fetch the referent
 943   //   and so we don&#39;t need to call the G1 pre-barrier. Thus we can use the
 944   //   regular method entry code to generate the NPE.
 945   //
 946   // This code is based on generate_accessor_entry.
 947   //
 948   // rmethod: Method*
 949   // r13: senderSP must preserve for slow path, set SP to it on fast path
 950 
 951   // LR is live.  It must be saved around calls.
 952 
 953   address entry = __ pc();
 954 
 955   const int referent_offset = java_lang_ref_Reference::referent_offset;
 956   guarantee(referent_offset &gt; 0, &quot;referent offset not initialized&quot;);
 957 
 958   Label slow_path;
 959   const Register local_0 = c_rarg0;
 960   // Check if local 0 != NULL
 961   // If the receiver is null then it is OK to jump to the slow path.
 962   __ ldr(local_0, Address(esp, 0));
 963   __ cbz(local_0, slow_path);
 964 
 965   __ mov(r19, r13);   // Move senderSP to a callee-saved register
 966 
 967   // Load the value of the referent field.
 968   const Address field_address(local_0, referent_offset);
 969   BarrierSetAssembler *bs = BarrierSet::barrier_set()-&gt;barrier_set_assembler();
 970   bs-&gt;load_at(_masm, IN_HEAP | ON_WEAK_OOP_REF, T_OBJECT, local_0, field_address, /*tmp1*/ rscratch2, /*tmp2*/ rscratch1);
 971 
 972   // areturn
 973   __ andr(sp, r19, -16);  // done with stack
 974   __ ret(lr);
 975 
 976   // generate a vanilla interpreter entry as the slow path
 977   __ bind(slow_path);
 978   __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::zerolocals));
 979   return entry;
 980 
 981 }
 982 
 983 /**
 984  * Method entry for static native methods:
 985  *   int java.util.zip.CRC32.update(int crc, int b)
 986  */
 987 address TemplateInterpreterGenerator::generate_CRC32_update_entry() {
 988   if (UseCRC32Intrinsics) {
 989     address entry = __ pc();
 990 
 991     // rmethod: Method*
 992     // r13: senderSP must preserved for slow path
 993     // esp: args
 994 
 995     Label slow_path;
 996     // If we need a safepoint check, generate full interpreter entry.
 997     __ safepoint_poll(slow_path);
 998 
 999     // We don&#39;t generate local frame and don&#39;t align stack because
1000     // we call stub code and there is no safepoint on this path.
1001 
1002     // Load parameters
1003     const Register crc = c_rarg0;  // crc
1004     const Register val = c_rarg1;  // source java byte value
1005     const Register tbl = c_rarg2;  // scratch
1006 
1007     // Arguments are reversed on java expression stack
1008     __ ldrw(val, Address(esp, 0));              // byte value
1009     __ ldrw(crc, Address(esp, wordSize));       // Initial CRC
1010 
1011     unsigned long offset;
1012     __ adrp(tbl, ExternalAddress(StubRoutines::crc_table_addr()), offset);
1013     __ add(tbl, tbl, offset);
1014 
1015     __ mvnw(crc, crc); // ~crc
1016     __ update_byte_crc32(crc, val, tbl);
1017     __ mvnw(crc, crc); // ~crc
1018 
1019     // result in c_rarg0
1020 
1021     __ andr(sp, r13, -16);
1022     __ ret(lr);
1023 
1024     // generate a vanilla native entry as the slow path
1025     __ bind(slow_path);
1026     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native));
1027     return entry;
1028   }
1029   return NULL;
1030 }
1031 
1032 /**
1033  * Method entry for static native methods:
1034  *   int java.util.zip.CRC32.updateBytes(int crc, byte[] b, int off, int len)
1035  *   int java.util.zip.CRC32.updateByteBuffer(int crc, long buf, int off, int len)
1036  */
1037 address TemplateInterpreterGenerator::generate_CRC32_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1038   if (UseCRC32Intrinsics) {
1039     address entry = __ pc();
1040 
1041     // rmethod,: Method*
1042     // r13: senderSP must preserved for slow path
1043 
1044     Label slow_path;
1045     // If we need a safepoint check, generate full interpreter entry.
1046     __ safepoint_poll(slow_path);
1047 
1048     // We don&#39;t generate local frame and don&#39;t align stack because
1049     // we call stub code and there is no safepoint on this path.
1050 
1051     // Load parameters
1052     const Register crc = c_rarg0;  // crc
1053     const Register buf = c_rarg1;  // source java byte array address
1054     const Register len = c_rarg2;  // length
1055     const Register off = len;      // offset (never overlaps with &#39;len&#39;)
1056 
1057     // Arguments are reversed on java expression stack
1058     // Calculate address of start element
1059     if (kind == Interpreter::java_util_zip_CRC32_updateByteBuffer) {
1060       __ ldr(buf, Address(esp, 2*wordSize)); // long buf
1061       __ ldrw(off, Address(esp, wordSize)); // offset
1062       __ add(buf, buf, off); // + offset
1063       __ ldrw(crc,   Address(esp, 4*wordSize)); // Initial CRC
1064     } else {
1065       __ ldr(buf, Address(esp, 2*wordSize)); // byte[] array
1066       __ resolve(IS_NOT_NULL | ACCESS_READ, buf);
1067       __ add(buf, buf, arrayOopDesc::base_offset_in_bytes(T_BYTE)); // + header size
1068       __ ldrw(off, Address(esp, wordSize)); // offset
1069       __ add(buf, buf, off); // + offset
1070       __ ldrw(crc,   Address(esp, 3*wordSize)); // Initial CRC
1071     }
1072     // Can now load &#39;len&#39; since we&#39;re finished with &#39;off&#39;
1073     __ ldrw(len, Address(esp, 0x0)); // Length
1074 
1075     __ andr(sp, r13, -16); // Restore the caller&#39;s SP
1076 
1077     // We are frameless so we can just jump to the stub.
1078     __ b(CAST_FROM_FN_PTR(address, StubRoutines::updateBytesCRC32()));
1079 
1080     // generate a vanilla native entry as the slow path
1081     __ bind(slow_path);
1082     __ jump_to_entry(Interpreter::entry_for_kind(Interpreter::native));
1083     return entry;
1084   }
1085   return NULL;
1086 }
1087 
1088 /**
1089  * Method entry for intrinsic-candidate (non-native) methods:
1090  *   int java.util.zip.CRC32C.updateBytes(int crc, byte[] b, int off, int end)
1091  *   int java.util.zip.CRC32C.updateDirectByteBuffer(int crc, long buf, int off, int end)
1092  * Unlike CRC32, CRC32C does not have any methods marked as native
1093  * CRC32C also uses an &quot;end&quot; variable instead of the length variable CRC32 uses
1094  */
1095 address TemplateInterpreterGenerator::generate_CRC32C_updateBytes_entry(AbstractInterpreter::MethodKind kind) {
1096   if (UseCRC32CIntrinsics) {
1097     address entry = __ pc();
1098 
1099     // Prepare jump to stub using parameters from the stack
1100     const Register crc = c_rarg0; // initial crc
1101     const Register buf = c_rarg1; // source java byte array address
1102     const Register len = c_rarg2; // len argument to the kernel
1103 
1104     const Register end = len; // index of last element to process
1105     const Register off = crc; // offset
1106 
1107     __ ldrw(end, Address(esp)); // int end
1108     __ ldrw(off, Address(esp, wordSize)); // int offset
1109     __ sub(len, end, off);
1110     __ ldr(buf, Address(esp, 2*wordSize)); // byte[] buf | long buf
1111     if (kind == Interpreter::java_util_zip_CRC32C_updateBytes) {
1112       __ resolve(IS_NOT_NULL | ACCESS_READ, buf);
1113     }
1114     __ add(buf, buf, off); // + offset
1115     if (kind == Interpreter::java_util_zip_CRC32C_updateDirectByteBuffer) {
1116       __ ldrw(crc, Address(esp, 4*wordSize)); // long crc
1117     } else {
1118       __ add(buf, buf, arrayOopDesc::base_offset_in_bytes(T_BYTE)); // + header size
1119       __ ldrw(crc, Address(esp, 3*wordSize)); // long crc
1120     }
1121 
1122     __ andr(sp, r13, -16); // Restore the caller&#39;s SP
1123 
1124     // Jump to the stub.
1125     __ b(CAST_FROM_FN_PTR(address, StubRoutines::updateBytesCRC32C()));
1126 
1127     return entry;
1128   }
1129   return NULL;
1130 }
1131 
1132 void TemplateInterpreterGenerator::bang_stack_shadow_pages(bool native_call) {
1133   // Bang each page in the shadow zone. We can&#39;t assume it&#39;s been done for
1134   // an interpreter frame with greater than a page of locals, so each page
1135   // needs to be checked.  Only true for non-native.
1136   if (UseStackBanging) {
1137     const int n_shadow_pages = JavaThread::stack_shadow_zone_size() / os::vm_page_size();
1138     const int start_page = native_call ? n_shadow_pages : 1;
1139     const int page_size = os::vm_page_size();
1140     for (int pages = start_page; pages &lt;= n_shadow_pages ; pages++) {
1141       __ sub(rscratch2, sp, pages*page_size);
1142       __ str(zr, Address(rscratch2));
1143     }
1144   }
1145 }
1146 
1147 
1148 // Interpreter stub for calling a native method. (asm interpreter)
1149 // This sets up a somewhat different looking stack for calling the
1150 // native method than the typical interpreter frame setup.
1151 address TemplateInterpreterGenerator::generate_native_entry(bool synchronized) {
1152   // determine code generation flags
1153   bool inc_counter  = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1154 
1155   // r1: Method*
1156   // rscratch1: sender sp
1157 
1158   address entry_point = __ pc();
1159 
1160   const Address constMethod       (rmethod, Method::const_offset());
1161   const Address access_flags      (rmethod, Method::access_flags_offset());
1162   const Address size_of_parameters(r2, ConstMethod::
1163                                        size_of_parameters_offset());
1164 
1165   // get parameter size (always needed)
1166   __ ldr(r2, constMethod);
1167   __ load_unsigned_short(r2, size_of_parameters);
1168 
1169   // Native calls don&#39;t need the stack size check since they have no
1170   // expression stack and the arguments are already on the stack and
1171   // we only add a handful of words to the stack.
1172 
1173   // rmethod: Method*
1174   // r2: size of parameters
1175   // rscratch1: sender sp
1176 
1177   // for natives the size of locals is zero
1178 
1179   // compute beginning of parameters (rlocals)
1180   __ add(rlocals, esp, r2, ext::uxtx, 3);
1181   __ add(rlocals, rlocals, -wordSize);
1182 
1183   // Pull SP back to minimum size: this avoids holes in the stack
1184   __ andr(sp, esp, -16);
1185 
1186   // initialize fixed part of activation frame
1187   generate_fixed_frame(true);
1188 #ifndef PRODUCT
1189   // tell the simulator that a method has been entered
1190   if (NotifySimulator) {
1191     __ notify(Assembler::method_entry);
1192   }
1193 #endif
1194 
1195   // make sure method is native &amp; not abstract
1196 #ifdef ASSERT
1197   __ ldrw(r0, access_flags);
1198   {
1199     Label L;
1200     __ tst(r0, JVM_ACC_NATIVE);
1201     __ br(Assembler::NE, L);
1202     __ stop(&quot;tried to execute non-native method as native&quot;);
1203     __ bind(L);
1204   }
1205   {
1206     Label L;
1207     __ tst(r0, JVM_ACC_ABSTRACT);
1208     __ br(Assembler::EQ, L);
1209     __ stop(&quot;tried to execute abstract method in interpreter&quot;);
1210     __ bind(L);
1211   }
1212 #endif
1213 
1214   // Since at this point in the method invocation the exception
1215   // handler would try to exit the monitor of synchronized methods
1216   // which hasn&#39;t been entered yet, we set the thread local variable
1217   // _do_not_unlock_if_synchronized to true. The remove_activation
1218   // will check this flag.
1219 
1220    const Address do_not_unlock_if_synchronized(rthread,
1221         in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
1222   __ mov(rscratch2, true);
1223   __ strb(rscratch2, do_not_unlock_if_synchronized);
1224 
1225   // increment invocation count &amp; check for overflow
1226   Label invocation_counter_overflow;
1227   if (inc_counter) {
1228     generate_counter_incr(&amp;invocation_counter_overflow, NULL, NULL);
1229   }
1230 
1231   Label continue_after_compile;
1232   __ bind(continue_after_compile);
1233 
1234   bang_stack_shadow_pages(true);
1235 
1236   // reset the _do_not_unlock_if_synchronized flag
1237   __ strb(zr, do_not_unlock_if_synchronized);
1238 
1239   // check for synchronized methods
1240   // Must happen AFTER invocation_counter check and stack overflow check,
1241   // so method is not locked if overflows.
1242   if (synchronized) {
1243     lock_method();
1244   } else {
1245     // no synchronization necessary
1246 #ifdef ASSERT
1247     {
1248       Label L;
1249       __ ldrw(r0, access_flags);
1250       __ tst(r0, JVM_ACC_SYNCHRONIZED);
1251       __ br(Assembler::EQ, L);
1252       __ stop(&quot;method needs synchronization&quot;);
1253       __ bind(L);
1254     }
1255 #endif
1256   }
1257 
1258   // start execution
1259 #ifdef ASSERT
1260   {
1261     Label L;
1262     const Address monitor_block_top(rfp,
1263                  frame::interpreter_frame_monitor_block_top_offset * wordSize);
1264     __ ldr(rscratch1, monitor_block_top);
1265     __ cmp(esp, rscratch1);
1266     __ br(Assembler::EQ, L);
1267     __ stop(&quot;broken stack frame setup in interpreter&quot;);
1268     __ bind(L);
1269   }
1270 #endif
1271 
1272   // jvmti support
1273   __ notify_method_entry();
1274 
1275   // work registers
1276   const Register t = r17;
1277   const Register result_handler = r19;
1278 
1279   // allocate space for parameters
1280   __ ldr(t, Address(rmethod, Method::const_offset()));
1281   __ load_unsigned_short(t, Address(t, ConstMethod::size_of_parameters_offset()));
1282 
1283   __ sub(rscratch1, esp, t, ext::uxtx, Interpreter::logStackElementSize);
1284   __ andr(sp, rscratch1, -16);
1285   __ mov(esp, rscratch1);
1286 
1287   // get signature handler
1288   {
1289     Label L;
1290     __ ldr(t, Address(rmethod, Method::signature_handler_offset()));
1291     __ cbnz(t, L);
1292     __ call_VM(noreg,
1293                CAST_FROM_FN_PTR(address,
1294                                 InterpreterRuntime::prepare_native_call),
1295                rmethod);
1296     __ ldr(t, Address(rmethod, Method::signature_handler_offset()));
1297     __ bind(L);
1298   }
1299 
1300   // call signature handler
1301   assert(InterpreterRuntime::SignatureHandlerGenerator::from() == rlocals,
1302          &quot;adjust this code&quot;);
1303   assert(InterpreterRuntime::SignatureHandlerGenerator::to() == sp,
1304          &quot;adjust this code&quot;);
1305   assert(InterpreterRuntime::SignatureHandlerGenerator::temp() == rscratch1,
1306           &quot;adjust this code&quot;);
1307 
1308   // The generated handlers do not touch rmethod (the method).
1309   // However, large signatures cannot be cached and are generated
1310   // each time here.  The slow-path generator can do a GC on return,
1311   // so we must reload it after the call.
1312   __ blr(t);
1313   __ get_method(rmethod);        // slow path can do a GC, reload rmethod
1314 
1315 
1316   // result handler is in r0
1317   // set result handler
1318   __ mov(result_handler, r0);
1319   // pass mirror handle if static call
1320   {
1321     Label L;
1322     __ ldrw(t, Address(rmethod, Method::access_flags_offset()));
1323     __ tbz(t, exact_log2(JVM_ACC_STATIC), L);
1324     // get mirror
1325     __ load_mirror(t, rmethod);
1326     // copy mirror into activation frame
1327     __ str(t, Address(rfp, frame::interpreter_frame_oop_temp_offset * wordSize));
1328     // pass handle to mirror
1329     __ add(c_rarg1, rfp, frame::interpreter_frame_oop_temp_offset * wordSize);
1330     __ bind(L);
1331   }
1332 
1333   // get native function entry point in r10
1334   {
1335     Label L;
1336     __ ldr(r10, Address(rmethod, Method::native_function_offset()));
1337     address unsatisfied = (SharedRuntime::native_method_throw_unsatisfied_link_error_entry());
1338     __ mov(rscratch2, unsatisfied);
1339     __ ldr(rscratch2, rscratch2);
1340     __ cmp(r10, rscratch2);
1341     __ br(Assembler::NE, L);
1342     __ call_VM(noreg,
1343                CAST_FROM_FN_PTR(address,
1344                                 InterpreterRuntime::prepare_native_call),
1345                rmethod);
1346     __ get_method(rmethod);
1347     __ ldr(r10, Address(rmethod, Method::native_function_offset()));
1348     __ bind(L);
1349   }
1350 
1351   // pass JNIEnv
1352   __ add(c_rarg0, rthread, in_bytes(JavaThread::jni_environment_offset()));
1353 
1354   // Set the last Java PC in the frame anchor to be the return address from
1355   // the call to the native method: this will allow the debugger to
1356   // generate an accurate stack trace.
1357   Label native_return;
1358   __ set_last_Java_frame(esp, rfp, native_return, rscratch1);
1359 
1360   // change thread state
1361 #ifdef ASSERT
1362   {
1363     Label L;
1364     __ ldrw(t, Address(rthread, JavaThread::thread_state_offset()));
1365     __ cmp(t, (u1)_thread_in_Java);
1366     __ br(Assembler::EQ, L);
1367     __ stop(&quot;Wrong thread state in native stub&quot;);
1368     __ bind(L);
1369   }
1370 #endif
1371 
1372   // Change state to native
1373   __ mov(rscratch1, _thread_in_native);
1374   __ lea(rscratch2, Address(rthread, JavaThread::thread_state_offset()));
1375   __ stlrw(rscratch1, rscratch2);
1376 
1377   // Call the native method.
1378   __ blrt(r10, rscratch1);
1379   __ bind(native_return);
1380   __ maybe_isb();
1381   __ get_method(rmethod);
1382   // result potentially in r0 or v0
1383 
1384   // make room for the pushes we&#39;re about to do
1385   __ sub(rscratch1, esp, 4 * wordSize);
1386   __ andr(sp, rscratch1, -16);
1387 
1388   // NOTE: The order of these pushes is known to frame::interpreter_frame_result
1389   // in order to extract the result of a method call. If the order of these
1390   // pushes change or anything else is added to the stack then the code in
1391   // interpreter_frame_result must also change.
1392   __ push(dtos);
1393   __ push(ltos);
1394 
1395   // change thread state
1396   __ mov(rscratch1, _thread_in_native_trans);
1397   __ lea(rscratch2, Address(rthread, JavaThread::thread_state_offset()));
1398   __ stlrw(rscratch1, rscratch2);
1399 
1400   // Force this write out before the read below
1401   __ dmb(Assembler::ISH);
1402 
1403   // check for safepoint operation in progress and/or pending suspend requests
1404   {
1405     Label L, Continue;
1406     __ safepoint_poll_acquire(L);
1407     __ ldrw(rscratch2, Address(rthread, JavaThread::suspend_flags_offset()));
1408     __ cbz(rscratch2, Continue);
1409     __ bind(L);
1410 
1411     // Don&#39;t use call_VM as it will see a possible pending exception
1412     // and forward it and never return here preventing us from
1413     // clearing _last_native_pc down below. So we do a runtime call by
1414     // hand.
1415     //
1416     __ mov(c_rarg0, rthread);
1417     __ mov(rscratch2, CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans));
1418     __ blrt(rscratch2, 1, 0, 0);
1419     __ maybe_isb();
1420     __ get_method(rmethod);
1421     __ reinit_heapbase();
1422     __ bind(Continue);
1423   }
1424 
1425   // change thread state
1426   __ mov(rscratch1, _thread_in_Java);
1427   __ lea(rscratch2, Address(rthread, JavaThread::thread_state_offset()));
1428   __ stlrw(rscratch1, rscratch2);
1429 
1430   // reset_last_Java_frame
1431   __ reset_last_Java_frame(true);
1432 
1433   if (CheckJNICalls) {
1434     // clear_pending_jni_exception_check
1435     __ str(zr, Address(rthread, JavaThread::pending_jni_exception_check_fn_offset()));
1436   }
1437 
1438   // reset handle block
1439   __ ldr(t, Address(rthread, JavaThread::active_handles_offset()));
1440   __ str(zr, Address(t, JNIHandleBlock::top_offset_in_bytes()));
1441 
1442   // If result is an oop unbox and store it in frame where gc will see it
1443   // and result handler will pick it up
1444 
1445   {
1446     Label no_oop;
1447     __ adr(t, ExternalAddress(AbstractInterpreter::result_handler(T_OBJECT)));
1448     __ cmp(t, result_handler);
1449     __ br(Assembler::NE, no_oop);
1450     // Unbox oop result, e.g. JNIHandles::resolve result.
1451     __ pop(ltos);
1452     __ resolve_jobject(r0, rthread, t);
1453     __ str(r0, Address(rfp, frame::interpreter_frame_oop_temp_offset*wordSize));
1454     // keep stack depth as expected by pushing oop which will eventually be discarded
1455     __ push(ltos);
1456     __ bind(no_oop);
1457   }
1458 
1459   {
1460     Label no_reguard;
1461     __ lea(rscratch1, Address(rthread, in_bytes(JavaThread::stack_guard_state_offset())));
1462     __ ldrw(rscratch1, Address(rscratch1));
1463     __ cmp(rscratch1, (u1)JavaThread::stack_guard_yellow_reserved_disabled);
1464     __ br(Assembler::NE, no_reguard);
1465 
1466     __ pusha(); // XXX only save smashed registers
1467     __ mov(c_rarg0, rthread);
1468     __ mov(rscratch2, CAST_FROM_FN_PTR(address, SharedRuntime::reguard_yellow_pages));
1469     __ blrt(rscratch2, 0, 0, 0);
1470     __ popa(); // XXX only restore smashed registers
1471     __ bind(no_reguard);
1472   }
1473 
1474   // The method register is junk from after the thread_in_native transition
1475   // until here.  Also can&#39;t call_VM until the bcp has been
1476   // restored.  Need bcp for throwing exception below so get it now.
1477   __ get_method(rmethod);
1478 
1479   // restore bcp to have legal interpreter frame, i.e., bci == 0 &lt;=&gt;
1480   // rbcp == code_base()
1481   __ ldr(rbcp, Address(rmethod, Method::const_offset()));   // get ConstMethod*
1482   __ add(rbcp, rbcp, in_bytes(ConstMethod::codes_offset()));          // get codebase
1483   // handle exceptions (exception handling will handle unlocking!)
1484   {
1485     Label L;
1486     __ ldr(rscratch1, Address(rthread, Thread::pending_exception_offset()));
1487     __ cbz(rscratch1, L);
1488     // Note: At some point we may want to unify this with the code
1489     // used in call_VM_base(); i.e., we should use the
1490     // StubRoutines::forward_exception code. For now this doesn&#39;t work
1491     // here because the rsp is not correctly set at this point.
1492     __ MacroAssembler::call_VM(noreg,
1493                                CAST_FROM_FN_PTR(address,
1494                                InterpreterRuntime::throw_pending_exception));
1495     __ should_not_reach_here();
1496     __ bind(L);
1497   }
1498 
1499   // do unlocking if necessary
1500   {
1501     Label L;
1502     __ ldrw(t, Address(rmethod, Method::access_flags_offset()));
1503     __ tbz(t, exact_log2(JVM_ACC_SYNCHRONIZED), L);
1504     // the code below should be shared with interpreter macro
1505     // assembler implementation
1506     {
1507       Label unlock;
1508       // BasicObjectLock will be first in list, since this is a
1509       // synchronized method. However, need to check that the object
1510       // has not been unlocked by an explicit monitorexit bytecode.
1511 
1512       // monitor expect in c_rarg1 for slow unlock path
1513       __ lea (c_rarg1, Address(rfp,   // address of first monitor
1514                                (intptr_t)(frame::interpreter_frame_initial_sp_offset *
1515                                           wordSize - sizeof(BasicObjectLock))));
1516 
1517       __ ldr(t, Address(c_rarg1, BasicObjectLock::obj_offset_in_bytes()));
1518       __ cbnz(t, unlock);
1519 
1520       // Entry already unlocked, need to throw exception
1521       __ MacroAssembler::call_VM(noreg,
1522                                  CAST_FROM_FN_PTR(address,
1523                    InterpreterRuntime::throw_illegal_monitor_state_exception));
1524       __ should_not_reach_here();
1525 
1526       __ bind(unlock);
1527       __ unlock_object(c_rarg1);
1528     }
1529     __ bind(L);
1530   }
1531 
1532   // jvmti support
1533   // Note: This must happen _after_ handling/throwing any exceptions since
1534   //       the exception handler code notifies the runtime of method exits
1535   //       too. If this happens before, method entry/exit notifications are
1536   //       not properly paired (was bug - gri 11/22/99).
1537   __ notify_method_exit(vtos, InterpreterMacroAssembler::NotifyJVMTI);
1538 
1539   // restore potential result in r0:d0, call result handler to
1540   // restore potential result in ST0 &amp; handle result
1541 
1542   __ pop(ltos);
1543   __ pop(dtos);
1544 
1545   __ blr(result_handler);
1546 
1547   // remove activation
1548   __ ldr(esp, Address(rfp,
1549                     frame::interpreter_frame_sender_sp_offset *
1550                     wordSize)); // get sender sp
1551   // remove frame anchor
1552   __ leave();
1553 
1554   // resture sender sp
1555   __ mov(sp, esp);
1556 
1557   __ ret(lr);
1558 
1559   if (inc_counter) {
1560     // Handle overflow of counter and compile method
1561     __ bind(invocation_counter_overflow);
1562     generate_counter_overflow(continue_after_compile);
1563   }
1564 
1565   return entry_point;
1566 }
1567 
1568 //
1569 // Generic interpreted method entry to (asm) interpreter
1570 //
1571 address TemplateInterpreterGenerator::generate_normal_entry(bool synchronized) {
1572   // determine code generation flags
1573   bool inc_counter  = UseCompiler || CountCompiledCalls || LogTouchedMethods;
1574 
1575   // rscratch1: sender sp
1576   address entry_point = __ pc();
1577 
1578   const Address constMethod(rmethod, Method::const_offset());
1579   const Address access_flags(rmethod, Method::access_flags_offset());
1580   const Address size_of_parameters(r3,
1581                                    ConstMethod::size_of_parameters_offset());
1582   const Address size_of_locals(r3, ConstMethod::size_of_locals_offset());
1583 
1584   // get parameter size (always needed)
1585   // need to load the const method first
1586   __ ldr(r3, constMethod);
1587   __ load_unsigned_short(r2, size_of_parameters);
1588 
1589   // r2: size of parameters
1590 
1591   __ load_unsigned_short(r3, size_of_locals); // get size of locals in words
1592   __ sub(r3, r3, r2); // r3 = no. of additional locals
1593 
1594   // see if we&#39;ve got enough room on the stack for locals plus overhead.
1595   generate_stack_overflow_check();
1596 
1597   // compute beginning of parameters (rlocals)
1598   __ add(rlocals, esp, r2, ext::uxtx, 3);
1599   __ sub(rlocals, rlocals, wordSize);
1600 
1601   // Make room for locals
1602   __ sub(rscratch1, esp, r3, ext::uxtx, 3);
1603   __ andr(sp, rscratch1, -16);
1604 
1605   // r3 - # of additional locals
1606   // allocate space for locals
1607   // explicitly initialize locals
1608   {
1609     Label exit, loop;
1610     __ ands(zr, r3, r3);
1611     __ br(Assembler::LE, exit); // do nothing if r3 &lt;= 0
1612     __ bind(loop);
1613     __ str(zr, Address(__ post(rscratch1, wordSize)));
1614     __ sub(r3, r3, 1); // until everything initialized
1615     __ cbnz(r3, loop);
1616     __ bind(exit);
1617   }
1618 
1619   // And the base dispatch table
1620   __ get_dispatch();
1621 
1622   // initialize fixed part of activation frame
1623   generate_fixed_frame(false);
1624 #ifndef PRODUCT
1625   // tell the simulator that a method has been entered
1626   if (NotifySimulator) {
1627     __ notify(Assembler::method_entry);
1628   }
1629 #endif
1630   // make sure method is not native &amp; not abstract
1631 #ifdef ASSERT
1632   __ ldrw(r0, access_flags);
1633   {
1634     Label L;
1635     __ tst(r0, JVM_ACC_NATIVE);
1636     __ br(Assembler::EQ, L);
1637     __ stop(&quot;tried to execute native method as non-native&quot;);
1638     __ bind(L);
1639   }
1640  {
1641     Label L;
1642     __ tst(r0, JVM_ACC_ABSTRACT);
1643     __ br(Assembler::EQ, L);
1644     __ stop(&quot;tried to execute abstract method in interpreter&quot;);
1645     __ bind(L);
1646   }
1647 #endif
1648 
1649   // Since at this point in the method invocation the exception
1650   // handler would try to exit the monitor of synchronized methods
1651   // which hasn&#39;t been entered yet, we set the thread local variable
1652   // _do_not_unlock_if_synchronized to true. The remove_activation
1653   // will check this flag.
1654 
1655    const Address do_not_unlock_if_synchronized(rthread,
1656         in_bytes(JavaThread::do_not_unlock_if_synchronized_offset()));
1657   __ mov(rscratch2, true);
1658   __ strb(rscratch2, do_not_unlock_if_synchronized);
1659 
1660   Label no_mdp;
1661   Register mdp = r3;
1662   __ ldr(mdp, Address(rmethod, Method::method_data_offset()));
1663   __ cbz(mdp, no_mdp);
1664   __ add(mdp, mdp, in_bytes(MethodData::data_offset()));
1665   __ profile_parameters_type(mdp, r1, r2);
1666   __ bind(no_mdp);
1667 
1668   // increment invocation count &amp; check for overflow
1669   Label invocation_counter_overflow;
1670   Label profile_method;
1671   Label profile_method_continue;
1672   if (inc_counter) {
1673     generate_counter_incr(&amp;invocation_counter_overflow,
1674                           &amp;profile_method,
1675                           &amp;profile_method_continue);
1676     if (ProfileInterpreter) {
1677       __ bind(profile_method_continue);
1678     }
1679   }
1680 
1681   Label continue_after_compile;
1682   __ bind(continue_after_compile);
1683 
1684   bang_stack_shadow_pages(false);
1685 
1686   // reset the _do_not_unlock_if_synchronized flag
1687   __ strb(zr, do_not_unlock_if_synchronized);
1688 
1689   // check for synchronized methods
1690   // Must happen AFTER invocation_counter check and stack overflow check,
1691   // so method is not locked if overflows.
1692   if (synchronized) {
1693     // Allocate monitor and lock method
1694     lock_method();
1695   } else {
1696     // no synchronization necessary
1697 #ifdef ASSERT
1698     {
1699       Label L;
1700       __ ldrw(r0, access_flags);
1701       __ tst(r0, JVM_ACC_SYNCHRONIZED);
1702       __ br(Assembler::EQ, L);
1703       __ stop(&quot;method needs synchronization&quot;);
1704       __ bind(L);
1705     }
1706 #endif
1707   }
1708 
1709   // start execution
1710 #ifdef ASSERT
1711   {
1712     Label L;
1713      const Address monitor_block_top (rfp,
1714                  frame::interpreter_frame_monitor_block_top_offset * wordSize);
1715     __ ldr(rscratch1, monitor_block_top);
1716     __ cmp(esp, rscratch1);
1717     __ br(Assembler::EQ, L);
1718     __ stop(&quot;broken stack frame setup in interpreter&quot;);
1719     __ bind(L);
1720   }
1721 #endif
1722 
1723   // jvmti support
1724   __ notify_method_entry();
1725 
1726   __ dispatch_next(vtos);
1727 
1728   // invocation counter overflow
1729   if (inc_counter) {
1730     if (ProfileInterpreter) {
1731       // We have decided to profile this method in the interpreter
1732       __ bind(profile_method);
1733       __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::profile_method));
1734       __ set_method_data_pointer_for_bcp();
1735       // don&#39;t think we need this
1736       __ get_method(r1);
1737       __ b(profile_method_continue);
1738     }
1739     // Handle overflow of counter and compile method
1740     __ bind(invocation_counter_overflow);
1741     generate_counter_overflow(continue_after_compile);
1742   }
1743 
1744   return entry_point;
1745 }
1746 
1747 //-----------------------------------------------------------------------------
1748 // Exceptions
1749 
1750 void TemplateInterpreterGenerator::generate_throw_exception() {
1751   // Entry point in previous activation (i.e., if the caller was
1752   // interpreted)
1753   Interpreter::_rethrow_exception_entry = __ pc();
1754   // Restore sp to interpreter_frame_last_sp even though we are going
1755   // to empty the expression stack for the exception processing.
1756   __ str(zr, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
1757   // r0: exception
1758   // r3: return address/pc that threw exception
1759   __ restore_bcp();    // rbcp points to call/send
1760   __ restore_locals();
1761   __ restore_constant_pool_cache();
1762   __ reinit_heapbase();  // restore rheapbase as heapbase.
1763   __ get_dispatch();
1764 
1765 #ifndef PRODUCT
1766   // tell the simulator that the caller method has been reentered
1767   if (NotifySimulator) {
1768     __ get_method(rmethod);
1769     __ notify(Assembler::method_reentry);
1770   }
1771 #endif
1772   // Entry point for exceptions thrown within interpreter code
1773   Interpreter::_throw_exception_entry = __ pc();
1774   // If we came here via a NullPointerException on the receiver of a
1775   // method, rmethod may be corrupt.
1776   __ get_method(rmethod);
1777   // expression stack is undefined here
1778   // r0: exception
1779   // rbcp: exception bcp
1780   __ verify_oop(r0);
1781   __ mov(c_rarg1, r0);
1782 
1783   // expression stack must be empty before entering the VM in case of
1784   // an exception
1785   __ empty_expression_stack();
1786   // find exception handler address and preserve exception oop
1787   __ call_VM(r3,
1788              CAST_FROM_FN_PTR(address,
1789                           InterpreterRuntime::exception_handler_for_exception),
1790              c_rarg1);
1791 
1792   // Calculate stack limit
1793   __ ldr(rscratch1, Address(rmethod, Method::const_offset()));
1794   __ ldrh(rscratch1, Address(rscratch1, ConstMethod::max_stack_offset()));
1795   __ add(rscratch1, rscratch1, frame::interpreter_frame_monitor_size() + 4);
1796   __ ldr(rscratch2,
1797          Address(rfp, frame::interpreter_frame_initial_sp_offset * wordSize));
1798   __ sub(rscratch1, rscratch2, rscratch1, ext::uxtx, 3);
1799   __ andr(sp, rscratch1, -16);
1800 
1801   // r0: exception handler entry point
1802   // r3: preserved exception oop
1803   // rbcp: bcp for exception handler
1804   __ push_ptr(r3); // push exception which is now the only value on the stack
1805   __ br(r0); // jump to exception handler (may be _remove_activation_entry!)
1806 
1807   // If the exception is not handled in the current frame the frame is
1808   // removed and the exception is rethrown (i.e. exception
1809   // continuation is _rethrow_exception).
1810   //
1811   // Note: At this point the bci is still the bxi for the instruction
1812   // which caused the exception and the expression stack is
1813   // empty. Thus, for any VM calls at this point, GC will find a legal
1814   // oop map (with empty expression stack).
1815 
1816   //
1817   // JVMTI PopFrame support
1818   //
1819 
1820   Interpreter::_remove_activation_preserving_args_entry = __ pc();
1821   __ empty_expression_stack();
1822   // Set the popframe_processing bit in pending_popframe_condition
1823   // indicating that we are currently handling popframe, so that
1824   // call_VMs that may happen later do not trigger new popframe
1825   // handling cycles.
1826   __ ldrw(r3, Address(rthread, JavaThread::popframe_condition_offset()));
1827   __ orr(r3, r3, JavaThread::popframe_processing_bit);
1828   __ strw(r3, Address(rthread, JavaThread::popframe_condition_offset()));
1829 
1830   {
1831     // Check to see whether we are returning to a deoptimized frame.
1832     // (The PopFrame call ensures that the caller of the popped frame is
1833     // either interpreted or compiled and deoptimizes it if compiled.)
1834     // In this case, we can&#39;t call dispatch_next() after the frame is
1835     // popped, but instead must save the incoming arguments and restore
1836     // them after deoptimization has occurred.
1837     //
1838     // Note that we don&#39;t compare the return PC against the
1839     // deoptimization blob&#39;s unpack entry because of the presence of
1840     // adapter frames in C2.
1841     Label caller_not_deoptimized;
1842     __ ldr(c_rarg1, Address(rfp, frame::return_addr_offset * wordSize));
1843     __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
1844                                InterpreterRuntime::interpreter_contains), c_rarg1);
1845     __ cbnz(r0, caller_not_deoptimized);
1846 
1847     // Compute size of arguments for saving when returning to
1848     // deoptimized caller
1849     __ get_method(r0);
1850     __ ldr(r0, Address(r0, Method::const_offset()));
1851     __ load_unsigned_short(r0, Address(r0, in_bytes(ConstMethod::
1852                                                     size_of_parameters_offset())));
1853     __ lsl(r0, r0, Interpreter::logStackElementSize);
1854     __ restore_locals(); // XXX do we need this?
1855     __ sub(rlocals, rlocals, r0);
1856     __ add(rlocals, rlocals, wordSize);
1857     // Save these arguments
1858     __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
1859                                            Deoptimization::
1860                                            popframe_preserve_args),
1861                           rthread, r0, rlocals);
1862 
1863     __ remove_activation(vtos,
1864                          /* throw_monitor_exception */ false,
1865                          /* install_monitor_exception */ false,
1866                          /* notify_jvmdi */ false);
1867 
1868     // Inform deoptimization that it is responsible for restoring
1869     // these arguments
1870     __ mov(rscratch1, JavaThread::popframe_force_deopt_reexecution_bit);
1871     __ strw(rscratch1, Address(rthread, JavaThread::popframe_condition_offset()));
1872 
1873     // Continue in deoptimization handler
1874     __ ret(lr);
1875 
1876     __ bind(caller_not_deoptimized);
1877   }
1878 
1879   __ remove_activation(vtos,
1880                        /* throw_monitor_exception */ false,
1881                        /* install_monitor_exception */ false,
1882                        /* notify_jvmdi */ false);
1883 
1884   // Restore the last_sp and null it out
1885   __ ldr(esp, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
1886   __ str(zr, Address(rfp, frame::interpreter_frame_last_sp_offset * wordSize));
1887 
1888   __ restore_bcp();
1889   __ restore_locals();
1890   __ restore_constant_pool_cache();
1891   __ get_method(rmethod);
1892   __ get_dispatch();
1893 
1894   // The method data pointer was incremented already during
1895   // call profiling. We have to restore the mdp for the current bcp.
1896   if (ProfileInterpreter) {
1897     __ set_method_data_pointer_for_bcp();
1898   }
1899 
1900   // Clear the popframe condition flag
1901   __ strw(zr, Address(rthread, JavaThread::popframe_condition_offset()));
1902   assert(JavaThread::popframe_inactive == 0, &quot;fix popframe_inactive&quot;);
1903 
1904 #if INCLUDE_JVMTI
1905   {
1906     Label L_done;
1907 
1908     __ ldrb(rscratch1, Address(rbcp, 0));
1909     __ cmpw(rscratch1, Bytecodes::_invokestatic);
1910     __ br(Assembler::NE, L_done);
1911 
1912     // The member name argument must be restored if _invokestatic is re-executed after a PopFrame call.
1913     // Detect such a case in the InterpreterRuntime function and return the member name argument, or NULL.
1914 
1915     __ ldr(c_rarg0, Address(rlocals, 0));
1916     __ call_VM(r0, CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null), c_rarg0, rmethod, rbcp);
1917 
1918     __ cbz(r0, L_done);
1919 
1920     __ str(r0, Address(esp, 0));
1921     __ bind(L_done);
1922   }
1923 #endif // INCLUDE_JVMTI
1924 
1925   // Restore machine SP
1926   __ ldr(rscratch1, Address(rmethod, Method::const_offset()));
1927   __ ldrh(rscratch1, Address(rscratch1, ConstMethod::max_stack_offset()));
1928   __ add(rscratch1, rscratch1, frame::interpreter_frame_monitor_size() + 4);
1929   __ ldr(rscratch2,
1930          Address(rfp, frame::interpreter_frame_initial_sp_offset * wordSize));
1931   __ sub(rscratch1, rscratch2, rscratch1, ext::uxtw, 3);
1932   __ andr(sp, rscratch1, -16);
1933 
1934   __ dispatch_next(vtos);
1935   // end of PopFrame support
1936 
1937   Interpreter::_remove_activation_entry = __ pc();
1938 
1939   // preserve exception over this code sequence
1940   __ pop_ptr(r0);
1941   __ str(r0, Address(rthread, JavaThread::vm_result_offset()));
1942   // remove the activation (without doing throws on illegalMonitorExceptions)
1943   __ remove_activation(vtos, false, true, false);
1944   // restore exception
1945   __ get_vm_result(r0, rthread);
1946 
1947   // In between activations - previous activation type unknown yet
1948   // compute continuation point - the continuation point expects the
1949   // following registers set up:
1950   //
1951   // r0: exception
1952   // lr: return address/pc that threw exception
1953   // esp: expression stack of caller
1954   // rfp: fp of caller
1955   __ stp(r0, lr, Address(__ pre(sp, -2 * wordSize)));  // save exception &amp; return address
1956   __ super_call_VM_leaf(CAST_FROM_FN_PTR(address,
1957                           SharedRuntime::exception_handler_for_return_address),
1958                         rthread, lr);
1959   __ mov(r1, r0);                               // save exception handler
1960   __ ldp(r0, lr, Address(__ post(sp, 2 * wordSize)));  // restore exception &amp; return address
1961   // We might be returning to a deopt handler that expects r3 to
1962   // contain the exception pc
1963   __ mov(r3, lr);
1964   // Note that an &quot;issuing PC&quot; is actually the next PC after the call
1965   __ br(r1);                                    // jump to exception
1966                                                 // handler of caller
1967 }
1968 
1969 
1970 //
1971 // JVMTI ForceEarlyReturn support
1972 //
1973 address TemplateInterpreterGenerator::generate_earlyret_entry_for(TosState state) {
1974   address entry = __ pc();
1975 
1976   __ restore_bcp();
1977   __ restore_locals();
1978   __ empty_expression_stack();
1979   __ load_earlyret_value(state);
1980 
1981   __ ldr(rscratch1, Address(rthread, JavaThread::jvmti_thread_state_offset()));
1982   Address cond_addr(rscratch1, JvmtiThreadState::earlyret_state_offset());
1983 
1984   // Clear the earlyret state
1985   assert(JvmtiThreadState::earlyret_inactive == 0, &quot;should be&quot;);
1986   __ str(zr, cond_addr);
1987 
1988   __ remove_activation(state,
1989                        false, /* throw_monitor_exception */
1990                        false, /* install_monitor_exception */
1991                        true); /* notify_jvmdi */
1992   __ ret(lr);
1993 
1994   return entry;
1995 } // end of ForceEarlyReturn support
1996 
1997 
1998 
1999 //-----------------------------------------------------------------------------
2000 // Helper for vtos entry point generation
2001 
2002 void TemplateInterpreterGenerator::set_vtos_entry_points(Template* t,
2003                                                          address&amp; bep,
2004                                                          address&amp; cep,
2005                                                          address&amp; sep,
2006                                                          address&amp; aep,
2007                                                          address&amp; iep,
2008                                                          address&amp; lep,
2009                                                          address&amp; fep,
2010                                                          address&amp; dep,
2011                                                          address&amp; vep) {
2012   assert(t-&gt;is_valid() &amp;&amp; t-&gt;tos_in() == vtos, &quot;illegal template&quot;);
2013   Label L;
2014   aep = __ pc();  __ push_ptr();  __ b(L);
2015   fep = __ pc();  __ push_f();    __ b(L);
2016   dep = __ pc();  __ push_d();    __ b(L);
2017   lep = __ pc();  __ push_l();    __ b(L);
2018   bep = cep = sep =
2019   iep = __ pc();  __ push_i();
2020   vep = __ pc();
2021   __ bind(L);
2022   generate_and_dispatch(t);
2023 }
2024 
2025 //-----------------------------------------------------------------------------
2026 
2027 // Non-product code
2028 #ifndef PRODUCT
2029 address TemplateInterpreterGenerator::generate_trace_code(TosState state) {
2030   address entry = __ pc();
2031 
2032   __ push(lr);
2033   __ push(state);
2034   __ push(RegSet::range(r0, r15), sp);
2035   __ mov(c_rarg2, r0);  // Pass itos
2036   __ call_VM(noreg,
2037              CAST_FROM_FN_PTR(address, InterpreterRuntime::trace_bytecode),
2038              c_rarg1, c_rarg2, c_rarg3);
2039   __ pop(RegSet::range(r0, r15), sp);
2040   __ pop(state);
2041   __ pop(lr);
2042   __ ret(lr);                                   // return from result handler
2043 
2044   return entry;
2045 }
2046 
2047 void TemplateInterpreterGenerator::count_bytecode() {
2048   Register rscratch3 = r0;
2049   __ push(rscratch1);
2050   __ push(rscratch2);
2051   __ push(rscratch3);
2052   __ mov(rscratch3, (address) &amp;BytecodeCounter::_counter_value);
2053   __ atomic_add(noreg, 1, rscratch3);
2054   __ pop(rscratch3);
2055   __ pop(rscratch2);
2056   __ pop(rscratch1);
2057 }
2058 
2059 void TemplateInterpreterGenerator::histogram_bytecode(Template* t) { ; }
2060 
2061 void TemplateInterpreterGenerator::histogram_bytecode_pair(Template* t) { ; }
2062 
2063 
2064 void TemplateInterpreterGenerator::trace_bytecode(Template* t) {
2065   // Call a little run-time stub to avoid blow-up for each bytecode.
2066   // The run-time runtime saves the right registers, depending on
2067   // the tosca in-state for the given template.
2068 
2069   assert(Interpreter::trace_code(t-&gt;tos_in()) != NULL,
2070          &quot;entry must have been generated&quot;);
2071   __ bl(Interpreter::trace_code(t-&gt;tos_in()));
2072   __ reinit_heapbase();
2073 }
2074 
2075 
2076 void TemplateInterpreterGenerator::stop_interpreter_at() {
2077   Label L;
2078   __ push(rscratch1);
2079   __ mov(rscratch1, (address) &amp;BytecodeCounter::_counter_value);
2080   __ ldr(rscratch1, Address(rscratch1));
2081   __ mov(rscratch2, StopInterpreterAt);
2082   __ cmpw(rscratch1, rscratch2);
2083   __ br(Assembler::NE, L);
2084   __ brk(0);
2085   __ bind(L);
2086   __ pop(rscratch1);
2087 }
2088 
2089 #ifdef BUILTIN_SIM
2090 
2091 #include &lt;sys/mman.h&gt;
2092 #include &lt;unistd.h&gt;
2093 
2094 extern &quot;C&quot; {
2095   static int PAGESIZE = getpagesize();
2096   int is_mapped_address(u_int64_t address)
2097   {
2098     address = (address &amp; ~((u_int64_t)PAGESIZE - 1));
2099     if (msync((void *)address, PAGESIZE, MS_ASYNC) == 0) {
2100       return true;
2101     }
2102     if (errno != ENOMEM) {
2103       return true;
2104     }
2105     return false;
2106   }
2107 
2108   void bccheck1(u_int64_t pc, u_int64_t fp, char *method, int *bcidx, int *framesize, char *decode)
2109   {
2110     if (method != 0) {
2111       method[0] = &#39;\0&#39;;
2112     }
2113     if (bcidx != 0) {
2114       *bcidx = -2;
2115     }
2116     if (decode != 0) {
2117       decode[0] = 0;
2118     }
2119 
2120     if (framesize != 0) {
2121       *framesize = -1;
2122     }
2123 
2124     if (Interpreter::contains((address)pc)) {
2125       AArch64Simulator *sim = AArch64Simulator::get_current(UseSimulatorCache, DisableBCCheck);
2126       Method* meth;
2127       address bcp;
2128       if (fp) {
2129 #define FRAME_SLOT_METHOD 3
2130 #define FRAME_SLOT_BCP 7
2131         meth = (Method*)sim-&gt;getMemory()-&gt;loadU64(fp - (FRAME_SLOT_METHOD &lt;&lt; 3));
2132         bcp = (address)sim-&gt;getMemory()-&gt;loadU64(fp - (FRAME_SLOT_BCP &lt;&lt; 3));
2133 #undef FRAME_SLOT_METHOD
2134 #undef FRAME_SLOT_BCP
2135       } else {
2136         meth = (Method*)sim-&gt;getCPUState().xreg(RMETHOD, 0);
2137         bcp = (address)sim-&gt;getCPUState().xreg(RBCP, 0);
2138       }
2139       if (meth-&gt;is_native()) {
2140         return;
2141       }
2142       if(method &amp;&amp; meth-&gt;is_method()) {
2143         ResourceMark rm;
2144         method[0] = &#39;I&#39;;
2145         method[1] = &#39; &#39;;
2146         meth-&gt;name_and_sig_as_C_string(method + 2, 398);
2147       }
2148       if (bcidx) {
2149         if (meth-&gt;contains(bcp)) {
2150           *bcidx = meth-&gt;bci_from(bcp);
2151         } else {
2152           *bcidx = -2;
2153         }
2154       }
2155       if (decode) {
2156         if (!BytecodeTracer::closure()) {
2157           BytecodeTracer::set_closure(BytecodeTracer::std_closure());
2158         }
2159         stringStream str(decode, 400);
2160         BytecodeTracer::trace(meth, bcp, &amp;str);
2161       }
2162     } else {
2163       if (method) {
2164         CodeBlob *cb = CodeCache::find_blob((address)pc);
2165         if (cb != NULL) {
2166           if (cb-&gt;is_nmethod()) {
2167             ResourceMark rm;
2168             nmethod* nm = (nmethod*)cb;
2169             method[0] = &#39;C&#39;;
2170             method[1] = &#39; &#39;;
2171             nm-&gt;method()-&gt;name_and_sig_as_C_string(method + 2, 398);
2172           } else if (cb-&gt;is_adapter_blob()) {
2173             strcpy(method, &quot;B adapter blob&quot;);
2174           } else if (cb-&gt;is_runtime_stub()) {
2175             strcpy(method, &quot;B runtime stub&quot;);
2176           } else if (cb-&gt;is_exception_stub()) {
2177             strcpy(method, &quot;B exception stub&quot;);
2178           } else if (cb-&gt;is_deoptimization_stub()) {
2179             strcpy(method, &quot;B deoptimization stub&quot;);
2180           } else if (cb-&gt;is_safepoint_stub()) {
2181             strcpy(method, &quot;B safepoint stub&quot;);
2182           } else if (cb-&gt;is_uncommon_trap_stub()) {
2183             strcpy(method, &quot;B uncommon trap stub&quot;);
2184           } else if (cb-&gt;contains((address)StubRoutines::call_stub())) {
2185             strcpy(method, &quot;B call stub&quot;);
2186           } else {
2187             strcpy(method, &quot;B unknown blob : &quot;);
2188             strcat(method, cb-&gt;name());
2189           }
2190           if (framesize != NULL) {
2191             *framesize = cb-&gt;frame_size();
2192           }
2193         }
2194       }
2195     }
2196   }
2197 
2198 
2199   JNIEXPORT void bccheck(u_int64_t pc, u_int64_t fp, char *method, int *bcidx, int *framesize, char *decode)
2200   {
2201     bccheck1(pc, fp, method, bcidx, framesize, decode);
2202   }
2203 }
2204 
2205 #endif // BUILTIN_SIM
2206 #endif // !PRODUCT
    </pre>
  </body>
</html>