<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/hotspot/cpu/ppc/templateInterpreterGenerator_ppc.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center><a href="stubGenerator_ppc.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="templateTable_ppc_64.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/hotspot/cpu/ppc/templateInterpreterGenerator_ppc.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 575   // Thread will be loaded to R3_ARG1.
 576   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ClassCastException), R17_tos);
 577 #ifdef ASSERT
 578   // Above call must not return here since exception pending.
 579   __ should_not_reach_here();
 580 #endif
 581   return entry;
 582 }
 583 
 584 address TemplateInterpreterGenerator::generate_exception_handler_common(const char* name, const char* message, bool pass_oop) {
 585   address entry = __ pc();
 586   //__ untested(&quot;generate_exception_handler_common&quot;);
 587   Register Rexception = R17_tos;
 588 
 589   // Expression stack must be empty before entering the VM if an exception happened.
 590   __ empty_expression_stack();
 591 
 592   __ load_const_optimized(R4_ARG2, (address) name, R11_scratch1);
 593   if (pass_oop) {
 594     __ mr(R5_ARG3, Rexception);
<span class="line-modified"> 595     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::create_klass_exception), false);</span>
 596   } else {
 597     __ load_const_optimized(R5_ARG3, (address) message, R11_scratch1);
<span class="line-modified"> 598     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception), false);</span>
 599   }
 600 
 601   // Throw exception.
 602   __ mr(R3_ARG1, Rexception);
 603   __ load_const_optimized(R11_scratch1, Interpreter::throw_exception_entry(), R12_scratch2);
 604   __ mtctr(R11_scratch1);
 605   __ bctr();
 606 
 607   return entry;
 608 }
 609 
 610 // This entry is returned to when a call returns to the interpreter.
 611 // When we arrive here, we expect that the callee stack frame is already popped.
 612 address TemplateInterpreterGenerator::generate_return_entry_for(TosState state, int step, size_t index_size) {
 613   address entry = __ pc();
 614 
 615   // Move the value out of the return register back to the TOS cache of current frame.
 616   switch (state) {
 617     case ltos:
 618     case btos:
</pre>
<hr />
<pre>
1033     __ beq(CCR0, zero_continue);
1034     __ addi(R28_mdx, R28_mdx, in_bytes(MethodData::data_offset()));
1035     __ bind(zero_continue);
1036   }
1037 
1038   if (native_call) {
1039     __ li(R14_bcp, 0); // Must initialize.
1040   } else {
1041     __ add(R14_bcp, in_bytes(ConstMethod::codes_offset()), Rconst_method);
1042   }
1043 
1044   // Resize parent frame.
1045   __ mflr(R12_scratch2);
1046   __ neg(parent_frame_resize, parent_frame_resize);
1047   __ resize_frame(parent_frame_resize, R11_scratch1);
1048   __ std(R12_scratch2, _abi(lr), R1_SP);
1049 
1050   // Get mirror and store it in the frame as GC root for this Method*.
1051   __ load_mirror_from_const_method(R12_scratch2, Rconst_method);
1052 
<span class="line-modified">1053   __ addi(R26_monitor, R1_SP, - frame::ijava_state_size);</span>
<span class="line-modified">1054   __ addi(R15_esp, R26_monitor, - Interpreter::stackElementSize);</span>
1055 
1056   // Store values.
<span class="line-removed">1057   // R15_esp, R14_bcp, R26_monitor, R28_mdx are saved at java calls</span>
<span class="line-removed">1058   // in InterpreterMacroAssembler::call_from_interpreter.</span>
1059   __ std(R19_method, _ijava_state_neg(method), R1_SP);
1060   __ std(R12_scratch2, _ijava_state_neg(mirror), R1_SP);
<span class="line-removed">1061   __ std(R21_sender_SP, _ijava_state_neg(sender_sp), R1_SP);</span>
<span class="line-removed">1062   __ std(R27_constPoolCache, _ijava_state_neg(cpoolCache), R1_SP);</span>
1063   __ std(R18_locals, _ijava_state_neg(locals), R1_SP);

1064 
1065   // Note: esp, bcp, monitor, mdx live in registers. Hence, the correct version can only
1066   // be found in the frame after save_interpreter_state is done. This is always true
1067   // for non-top frames. But when a signal occurs, dumping the top frame can go wrong,
1068   // because e.g. frame::interpreter_frame_bcp() will not access the correct value
1069   // (Enhanced Stack Trace).
1070   // The signal handler does not save the interpreter state into the frame.




1071   __ li(R0, 0);
<span class="line-modified">1072 #ifdef ASSERT</span>
<span class="line-modified">1073   // Fill remaining slots with constants.</span>
<span class="line-modified">1074   __ load_const_optimized(R11_scratch1, 0x5afe);</span>
<span class="line-modified">1075   __ load_const_optimized(R12_scratch2, 0xdead);</span>
<span class="line-modified">1076 #endif</span>
<span class="line-modified">1077   // We have to initialize some frame slots for native calls (accessed by GC).</span>
<span class="line-modified">1078   if (native_call) {</span>
<span class="line-removed">1079     __ std(R26_monitor, _ijava_state_neg(monitors), R1_SP);</span>
<span class="line-removed">1080     __ std(R14_bcp, _ijava_state_neg(bcp), R1_SP);</span>
<span class="line-removed">1081     if (ProfileInterpreter) { __ std(R28_mdx, _ijava_state_neg(mdx), R1_SP); }</span>
<span class="line-removed">1082   }</span>
<span class="line-removed">1083 #ifdef ASSERT</span>
<span class="line-removed">1084   else {</span>
<span class="line-removed">1085     __ std(R12_scratch2, _ijava_state_neg(monitors), R1_SP);</span>
<span class="line-removed">1086     __ std(R12_scratch2, _ijava_state_neg(bcp), R1_SP);</span>
<span class="line-removed">1087     __ std(R12_scratch2, _ijava_state_neg(mdx), R1_SP);</span>
<span class="line-removed">1088   }</span>
<span class="line-removed">1089   __ std(R11_scratch1, _ijava_state_neg(ijava_reserved), R1_SP);</span>
<span class="line-removed">1090   __ std(R12_scratch2, _ijava_state_neg(esp), R1_SP);</span>
<span class="line-removed">1091   __ std(R12_scratch2, _ijava_state_neg(lresult), R1_SP);</span>
<span class="line-removed">1092   __ std(R12_scratch2, _ijava_state_neg(fresult), R1_SP);</span>
<span class="line-removed">1093 #endif</span>
1094   __ subf(R12_scratch2, top_frame_size, R1_SP);
<span class="line-modified">1095   __ std(R0, _ijava_state_neg(oop_tmp), R1_SP);</span>
1096   __ std(R12_scratch2, _ijava_state_neg(top_frame_sp), R1_SP);
1097 
1098   // Push top frame.
1099   __ push_frame(top_frame_size, R11_scratch1);
1100 }
1101 
1102 // End of helpers
1103 
1104 address TemplateInterpreterGenerator::generate_math_entry(AbstractInterpreter::MethodKind kind) {
1105 
1106   // Decide what to do: Use same platform specific instructions and runtime calls as compilers.
1107   bool use_instruction = false;
1108   address runtime_entry = NULL;
1109   int num_args = 1;
1110   bool double_precision = true;
1111 
1112   // PPC64 specific:
1113   switch (kind) {
1114     case Interpreter::java_lang_math_sqrt: use_instruction = VM_Version::has_fsqrt(); break;
1115     case Interpreter::java_lang_math_abs:  use_instruction = true; break;
</pre>
<hr />
<pre>
2102     // Get out of the current method and re-execute the call that called us.
2103     __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ noreg, R11_scratch1, R12_scratch2);
2104     __ restore_interpreter_state(R11_scratch1);
2105     __ ld(R12_scratch2, _ijava_state_neg(top_frame_sp), R11_scratch1);
2106     __ resize_frame_absolute(R12_scratch2, R11_scratch1, R0);
2107     if (ProfileInterpreter) {
2108       __ set_method_data_pointer_for_bcp();
2109       __ ld(R11_scratch1, 0, R1_SP);
2110       __ std(R28_mdx, _ijava_state_neg(mdx), R11_scratch1);
2111     }
2112 #if INCLUDE_JVMTI
2113     Label L_done;
2114 
2115     __ lbz(R11_scratch1, 0, R14_bcp);
2116     __ cmpwi(CCR0, R11_scratch1, Bytecodes::_invokestatic);
2117     __ bne(CCR0, L_done);
2118 
2119     // The member name argument must be restored if _invokestatic is re-executed after a PopFrame call.
2120     // Detect such a case in the InterpreterRuntime function and return the member name argument, or NULL.
2121     __ ld(R4_ARG2, 0, R18_locals);
<span class="line-modified">2122     __ MacroAssembler::call_VM(R4_ARG2, CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null), R4_ARG2, R19_method, R14_bcp, false);</span>
2123     __ restore_interpreter_state(R11_scratch1, /*bcp_and_mdx_only*/ true);
2124     __ cmpdi(CCR0, R4_ARG2, 0);
2125     __ beq(CCR0, L_done);
2126     __ std(R4_ARG2, wordSize, R15_esp);
2127     __ bind(L_done);
2128 #endif // INCLUDE_JVMTI
2129     __ dispatch_next(vtos);
2130   }
2131   // end of JVMTI PopFrame support
2132 
2133   // --------------------------------------------------------------------------
2134   // Remove activation exception entry.
2135   // This is jumped to if an interpreted method can&#39;t handle an exception itself
2136   // (we come from the throw/rethrow exception entry above). We&#39;re going to call
2137   // into the VM to find the exception handler in the caller, pop the current
2138   // frame and return the handler we calculated.
2139   Interpreter::_remove_activation_entry = __ pc();
2140   {
2141     __ pop_ptr(Rexception);
2142     __ verify_thread();
</pre>
</td>
<td>
<hr />
<pre>
 575   // Thread will be loaded to R3_ARG1.
 576   __ call_VM(noreg, CAST_FROM_FN_PTR(address, InterpreterRuntime::throw_ClassCastException), R17_tos);
 577 #ifdef ASSERT
 578   // Above call must not return here since exception pending.
 579   __ should_not_reach_here();
 580 #endif
 581   return entry;
 582 }
 583 
 584 address TemplateInterpreterGenerator::generate_exception_handler_common(const char* name, const char* message, bool pass_oop) {
 585   address entry = __ pc();
 586   //__ untested(&quot;generate_exception_handler_common&quot;);
 587   Register Rexception = R17_tos;
 588 
 589   // Expression stack must be empty before entering the VM if an exception happened.
 590   __ empty_expression_stack();
 591 
 592   __ load_const_optimized(R4_ARG2, (address) name, R11_scratch1);
 593   if (pass_oop) {
 594     __ mr(R5_ARG3, Rexception);
<span class="line-modified"> 595     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::create_klass_exception));</span>
 596   } else {
 597     __ load_const_optimized(R5_ARG3, (address) message, R11_scratch1);
<span class="line-modified"> 598     __ call_VM(Rexception, CAST_FROM_FN_PTR(address, InterpreterRuntime::create_exception));</span>
 599   }
 600 
 601   // Throw exception.
 602   __ mr(R3_ARG1, Rexception);
 603   __ load_const_optimized(R11_scratch1, Interpreter::throw_exception_entry(), R12_scratch2);
 604   __ mtctr(R11_scratch1);
 605   __ bctr();
 606 
 607   return entry;
 608 }
 609 
 610 // This entry is returned to when a call returns to the interpreter.
 611 // When we arrive here, we expect that the callee stack frame is already popped.
 612 address TemplateInterpreterGenerator::generate_return_entry_for(TosState state, int step, size_t index_size) {
 613   address entry = __ pc();
 614 
 615   // Move the value out of the return register back to the TOS cache of current frame.
 616   switch (state) {
 617     case ltos:
 618     case btos:
</pre>
<hr />
<pre>
1033     __ beq(CCR0, zero_continue);
1034     __ addi(R28_mdx, R28_mdx, in_bytes(MethodData::data_offset()));
1035     __ bind(zero_continue);
1036   }
1037 
1038   if (native_call) {
1039     __ li(R14_bcp, 0); // Must initialize.
1040   } else {
1041     __ add(R14_bcp, in_bytes(ConstMethod::codes_offset()), Rconst_method);
1042   }
1043 
1044   // Resize parent frame.
1045   __ mflr(R12_scratch2);
1046   __ neg(parent_frame_resize, parent_frame_resize);
1047   __ resize_frame(parent_frame_resize, R11_scratch1);
1048   __ std(R12_scratch2, _abi(lr), R1_SP);
1049 
1050   // Get mirror and store it in the frame as GC root for this Method*.
1051   __ load_mirror_from_const_method(R12_scratch2, Rconst_method);
1052 
<span class="line-modified">1053   __ addi(R26_monitor, R1_SP, -frame::ijava_state_size);</span>
<span class="line-modified">1054   __ addi(R15_esp, R26_monitor, -Interpreter::stackElementSize);</span>
1055 
1056   // Store values.


1057   __ std(R19_method, _ijava_state_neg(method), R1_SP);
1058   __ std(R12_scratch2, _ijava_state_neg(mirror), R1_SP);


1059   __ std(R18_locals, _ijava_state_neg(locals), R1_SP);
<span class="line-added">1060   __ std(R27_constPoolCache, _ijava_state_neg(cpoolCache), R1_SP);</span>
1061 
1062   // Note: esp, bcp, monitor, mdx live in registers. Hence, the correct version can only
1063   // be found in the frame after save_interpreter_state is done. This is always true
1064   // for non-top frames. But when a signal occurs, dumping the top frame can go wrong,
1065   // because e.g. frame::interpreter_frame_bcp() will not access the correct value
1066   // (Enhanced Stack Trace).
1067   // The signal handler does not save the interpreter state into the frame.
<span class="line-added">1068 </span>
<span class="line-added">1069   // We have to initialize some of these frame slots for native calls (accessed by GC).</span>
<span class="line-added">1070   // Also initialize them for non-native calls for better tool support (even though</span>
<span class="line-added">1071   // you may not get the most recent version as described above).</span>
1072   __ li(R0, 0);
<span class="line-modified">1073   __ std(R26_monitor, _ijava_state_neg(monitors), R1_SP);</span>
<span class="line-modified">1074   __ std(R14_bcp, _ijava_state_neg(bcp), R1_SP);</span>
<span class="line-modified">1075   if (ProfileInterpreter) { __ std(R28_mdx, _ijava_state_neg(mdx), R1_SP); }</span>
<span class="line-modified">1076   __ std(R15_esp, _ijava_state_neg(esp), R1_SP);</span>
<span class="line-modified">1077   __ std(R0, _ijava_state_neg(oop_tmp), R1_SP); // only used for native_call</span>
<span class="line-modified">1078 </span>
<span class="line-modified">1079   // Store sender&#39;s SP and this frame&#39;s top SP.</span>















1080   __ subf(R12_scratch2, top_frame_size, R1_SP);
<span class="line-modified">1081   __ std(R21_sender_SP, _ijava_state_neg(sender_sp), R1_SP);</span>
1082   __ std(R12_scratch2, _ijava_state_neg(top_frame_sp), R1_SP);
1083 
1084   // Push top frame.
1085   __ push_frame(top_frame_size, R11_scratch1);
1086 }
1087 
1088 // End of helpers
1089 
1090 address TemplateInterpreterGenerator::generate_math_entry(AbstractInterpreter::MethodKind kind) {
1091 
1092   // Decide what to do: Use same platform specific instructions and runtime calls as compilers.
1093   bool use_instruction = false;
1094   address runtime_entry = NULL;
1095   int num_args = 1;
1096   bool double_precision = true;
1097 
1098   // PPC64 specific:
1099   switch (kind) {
1100     case Interpreter::java_lang_math_sqrt: use_instruction = VM_Version::has_fsqrt(); break;
1101     case Interpreter::java_lang_math_abs:  use_instruction = true; break;
</pre>
<hr />
<pre>
2088     // Get out of the current method and re-execute the call that called us.
2089     __ merge_frames(/*top_frame_sp*/ R21_sender_SP, /*return_pc*/ noreg, R11_scratch1, R12_scratch2);
2090     __ restore_interpreter_state(R11_scratch1);
2091     __ ld(R12_scratch2, _ijava_state_neg(top_frame_sp), R11_scratch1);
2092     __ resize_frame_absolute(R12_scratch2, R11_scratch1, R0);
2093     if (ProfileInterpreter) {
2094       __ set_method_data_pointer_for_bcp();
2095       __ ld(R11_scratch1, 0, R1_SP);
2096       __ std(R28_mdx, _ijava_state_neg(mdx), R11_scratch1);
2097     }
2098 #if INCLUDE_JVMTI
2099     Label L_done;
2100 
2101     __ lbz(R11_scratch1, 0, R14_bcp);
2102     __ cmpwi(CCR0, R11_scratch1, Bytecodes::_invokestatic);
2103     __ bne(CCR0, L_done);
2104 
2105     // The member name argument must be restored if _invokestatic is re-executed after a PopFrame call.
2106     // Detect such a case in the InterpreterRuntime function and return the member name argument, or NULL.
2107     __ ld(R4_ARG2, 0, R18_locals);
<span class="line-modified">2108     __ call_VM(R4_ARG2, CAST_FROM_FN_PTR(address, InterpreterRuntime::member_name_arg_or_null), R4_ARG2, R19_method, R14_bcp);</span>
2109     __ restore_interpreter_state(R11_scratch1, /*bcp_and_mdx_only*/ true);
2110     __ cmpdi(CCR0, R4_ARG2, 0);
2111     __ beq(CCR0, L_done);
2112     __ std(R4_ARG2, wordSize, R15_esp);
2113     __ bind(L_done);
2114 #endif // INCLUDE_JVMTI
2115     __ dispatch_next(vtos);
2116   }
2117   // end of JVMTI PopFrame support
2118 
2119   // --------------------------------------------------------------------------
2120   // Remove activation exception entry.
2121   // This is jumped to if an interpreted method can&#39;t handle an exception itself
2122   // (we come from the throw/rethrow exception entry above). We&#39;re going to call
2123   // into the VM to find the exception handler in the caller, pop the current
2124   // frame and return the handler we calculated.
2125   Interpreter::_remove_activation_entry = __ pc();
2126   {
2127     __ pop_ptr(Rexception);
2128     __ verify_thread();
</pre>
</td>
</tr>
</table>
<center><a href="stubGenerator_ppc.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../index.html" target="_top">index</a> <a href="templateTable_ppc_64.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>